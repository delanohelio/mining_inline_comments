{"pr_number": 3040, "pr_title": "[RW-4277][risk=low] Users can set workspace billing account back to free tier", "pr_createdAt": "2020-01-24T19:35:38Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3040", "timeline": [{"oid": "4e778c7da7349d6860de912375d47333daa86f31", "url": "https://github.com/all-of-us/workbench/commit/4e778c7da7349d6860de912375d47333daa86f31", "message": "WIP: can make billing list call", "committedDate": "2020-01-13T19:53:33Z", "type": "commit"}, {"oid": "0fdf233bc4475e01fed6b79fd7c30ff05408631f", "url": "https://github.com/all-of-us/workbench/commit/0fdf233bc4475e01fed6b79fd7c30ff05408631f", "message": "WIP: add dropdown and text", "committedDate": "2020-01-14T21:34:12Z", "type": "commit"}, {"oid": "39660aec7e8e7c37dd9ebbffecb4761f867938ff", "url": "https://github.com/all-of-us/workbench/commit/39660aec7e8e7c37dd9ebbffecb4761f867938ff", "message": "WIP - dynamically load billing accounts in dropdown", "committedDate": "2020-01-14T22:27:09Z", "type": "commit"}, {"oid": "56a37d1dd3201a86e9a87b8837cae1bbb9d025b9", "url": "https://github.com/all-of-us/workbench/commit/56a37d1dd3201a86e9a87b8837cae1bbb9d025b9", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-3175", "committedDate": "2020-01-15T17:18:22Z", "type": "commit"}, {"oid": "6a8217338f17dce46a36d3b6f5caa7b986613a5f", "url": "https://github.com/all-of-us/workbench/commit/6a8217338f17dce46a36d3b6f5caa7b986613a5f", "message": "fix compilation", "committedDate": "2020-01-15T20:10:04Z", "type": "commit"}, {"oid": "653bed1a58bdfb713c6dedaf16967b8f45622f1a", "url": "https://github.com/all-of-us/workbench/commit/653bed1a58bdfb713c6dedaf16967b8f45622f1a", "message": "make list billing accounts call from backend", "committedDate": "2020-01-16T19:37:14Z", "type": "commit"}, {"oid": "b9e5ba9448bb7cef069fee6ff375b2a514c686d6", "url": "https://github.com/all-of-us/workbench/commit/b9e5ba9448bb7cef069fee6ff375b2a514c686d6", "message": "add billingAccount to WS api", "committedDate": "2020-01-16T19:44:46Z", "type": "commit"}, {"oid": "7e7bf93bf11313ba7b5277b02b0997d1e365ea3c", "url": "https://github.com/all-of-us/workbench/commit/7e7bf93bf11313ba7b5277b02b0997d1e365ea3c", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-3175", "committedDate": "2020-01-16T19:51:05Z", "type": "commit"}, {"oid": "a563de70458e0b3ccd7ddfa01a0fb46b439307c1", "url": "https://github.com/all-of-us/workbench/commit/a563de70458e0b3ccd7ddfa01a0fb46b439307c1", "message": "add field for billing account name to workspace. drop billing account type in favor of account name comparison", "committedDate": "2020-01-16T23:23:09Z", "type": "commit"}, {"oid": "43362f362a5fc89b75a77045ed3ec3dd8eda25bc", "url": "https://github.com/all-of-us/workbench/commit/43362f362a5fc89b75a77045ed3ec3dd8eda25bc", "message": "send billing account to front end and pick correct one in dropdown", "committedDate": "2020-01-16T23:44:21Z", "type": "commit"}, {"oid": "ee2bc4ea34d11959af6f4dfdc60a914c6efec366", "url": "https://github.com/all-of-us/workbench/commit/ee2bc4ea34d11959af6f4dfdc60a914c6efec366", "message": "can select billing account in UI", "committedDate": "2020-01-17T17:56:16Z", "type": "commit"}, {"oid": "3444331744ffe2c9a7866c09ff2ec8350ccf2085", "url": "https://github.com/all-of-us/workbench/commit/3444331744ffe2c9a7866c09ff2ec8350ccf2085", "message": "add front end validation for billing account", "committedDate": "2020-01-17T18:17:06Z", "type": "commit"}, {"oid": "0575c9194b2749e09b58c76d4cda8a05ed7d8e36", "url": "https://github.com/all-of-us/workbench/commit/0575c9194b2749e09b58c76d4cda8a05ed7d8e36", "message": "grant ownership to user on billing project", "committedDate": "2020-01-17T23:01:13Z", "type": "commit"}, {"oid": "7d96a92106467bf59305b4e36507e7f13cb2ccba", "url": "https://github.com/all-of-us/workbench/commit/7d96a92106467bf59305b4e36507e7f13cb2ccba", "message": "merging - WIP", "committedDate": "2020-01-22T18:21:21Z", "type": "commit"}, {"oid": "b715a2263985280c7539b71b2b14f5c376a29f15", "url": "https://github.com/all-of-us/workbench/commit/b715a2263985280c7539b71b2b14f5c376a29f15", "message": "WIP", "committedDate": "2020-01-23T01:11:28Z", "type": "commit"}, {"oid": "eab84bb8334be6d7700344e7fb7d579eba8c3001", "url": "https://github.com/all-of-us/workbench/commit/eab84bb8334be6d7700344e7fb7d579eba8c3001", "message": "fix tests", "committedDate": "2020-01-23T05:14:35Z", "type": "commit"}, {"oid": "c2587e5ad3f3b78740c7ea870af9c3b2b316c63b", "url": "https://github.com/all-of-us/workbench/commit/c2587e5ad3f3b78740c7ea870af9c3b2b316c63b", "message": "super cool spy test", "committedDate": "2020-01-23T06:19:15Z", "type": "commit"}, {"oid": "c332e05615c7fd771c120d1fbfc05a6c9cfac3cb", "url": "https://github.com/all-of-us/workbench/commit/c332e05615c7fd771c120d1fbfc05a6c9cfac3cb", "message": "add remaining tests", "committedDate": "2020-01-23T06:53:18Z", "type": "commit"}, {"oid": "3910cfdb967f889bbbfd82667abe5f4ccdc8630a", "url": "https://github.com/all-of-us/workbench/commit/3910cfdb967f889bbbfd82667abe5f4ccdc8630a", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-3175", "committedDate": "2020-01-23T15:55:46Z", "type": "commit"}, {"oid": "5e80365d8ce3d1098adbf61342e5a15a0378470c", "url": "https://github.com/all-of-us/workbench/commit/5e80365d8ce3d1098adbf61342e5a15a0378470c", "message": "restore billing account name code", "committedDate": "2020-01-23T16:11:42Z", "type": "commit"}, {"oid": "b391b9b7c8345dce04463f275a498f439d34c574", "url": "https://github.com/all-of-us/workbench/commit/b391b9b7c8345dce04463f275a498f439d34c574", "message": "actually execute update call. works manually", "committedDate": "2020-01-23T16:36:48Z", "type": "commit"}, {"oid": "6dfdf81829745ba862240220b01a4620c0f539b6", "url": "https://github.com/all-of-us/workbench/commit/6dfdf81829745ba862240220b01a4620c0f539b6", "message": "grab billing info on workspace edit", "committedDate": "2020-01-23T18:54:52Z", "type": "commit"}, {"oid": "70c0c086df427750ec753025f57dd1791af12552", "url": "https://github.com/all-of-us/workbench/commit/70c0c086df427750ec753025f57dd1791af12552", "message": "fix changelog", "committedDate": "2020-01-23T18:58:49Z", "type": "commit"}, {"oid": "ec1e0379fe0302f83ec370fbda5cd21a81501d1a", "url": "https://github.com/all-of-us/workbench/commit/ec1e0379fe0302f83ec370fbda5cd21a81501d1a", "message": "fix tests", "committedDate": "2020-01-23T20:06:05Z", "type": "commit"}, {"oid": "c1b20fd06b9f92cf76b44d4b39a1f9910c3dd505", "url": "https://github.com/all-of-us/workbench/commit/c1b20fd06b9f92cf76b44d4b39a1f9910c3dd505", "message": "fix UI tests", "committedDate": "2020-01-23T20:48:30Z", "type": "commit"}, {"oid": "8843dfe70d7eba04ef7f8c6914f2803c01ef81d8", "url": "https://github.com/all-of-us/workbench/commit/8843dfe70d7eba04ef7f8c6914f2803c01ef81d8", "message": "add feature flag gating", "committedDate": "2020-01-23T22:10:15Z", "type": "commit"}, {"oid": "fbd0076675d2bf7537d19ddf07fb61b587237622", "url": "https://github.com/all-of-us/workbench/commit/fbd0076675d2bf7537d19ddf07fb61b587237622", "message": "spotless", "committedDate": "2020-01-23T22:12:18Z", "type": "commit"}, {"oid": "ba8bdcbd48aaf4ef94a3d1c3c51bce34ce6e0076", "url": "https://github.com/all-of-us/workbench/commit/ba8bdcbd48aaf4ef94a3d1c3c51bce34ce6e0076", "message": "ui lint", "committedDate": "2020-01-23T22:15:04Z", "type": "commit"}, {"oid": "da5eef924a76605fe19c8e6164e0b79107a73849", "url": "https://github.com/all-of-us/workbench/commit/da5eef924a76605fe19c8e6164e0b79107a73849", "message": "fix cloud api bug", "committedDate": "2020-01-23T22:42:01Z", "type": "commit"}, {"oid": "f2fea88084d43f33c7cd8e2259b0819985d91f58", "url": "https://github.com/all-of-us/workbench/commit/f2fea88084d43f33c7cd8e2259b0819985d91f58", "message": "prefix free tier back fill with billingAccounts/", "committedDate": "2020-01-23T22:42:20Z", "type": "commit"}, {"oid": "837ed2b37dacebfcdbaa6f38b67bd9df07d2db8b", "url": "https://github.com/all-of-us/workbench/commit/837ed2b37dacebfcdbaa6f38b67bd9df07d2db8b", "message": "fix prefix bug", "committedDate": "2020-01-23T23:30:44Z", "type": "commit"}, {"oid": "33d3adfbe6b096f1fce685a61708bc84f193c648", "url": "https://github.com/all-of-us/workbench/commit/33d3adfbe6b096f1fce685a61708bc84f193c648", "message": "fix api tests", "committedDate": "2020-01-23T23:42:19Z", "type": "commit"}, {"oid": "5cb2af41abfed0cac03ce02e03ad780548f3c40d", "url": "https://github.com/all-of-us/workbench/commit/5cb2af41abfed0cac03ce02e03ad780548f3c40d", "message": "fix UI tests", "committedDate": "2020-01-23T23:59:13Z", "type": "commit"}, {"oid": "2f5017fb481a7d45ccebf79f5098b4cc4648ce1f", "url": "https://github.com/all-of-us/workbench/commit/2f5017fb481a7d45ccebf79f5098b4cc4648ce1f", "message": "add retryer", "committedDate": "2020-01-24T00:20:58Z", "type": "commit"}, {"oid": "2fa89be9613c68f122e39e246458262a46ee9eff", "url": "https://github.com/all-of-us/workbench/commit/2fa89be9613c68f122e39e246458262a46ee9eff", "message": "comment", "committedDate": "2020-01-24T00:25:09Z", "type": "commit"}, {"oid": "1c9b03b3234059dcbbeace44d1ee59ba561c312b", "url": "https://github.com/all-of-us/workbench/commit/1c9b03b3234059dcbbeace44d1ee59ba561c312b", "message": "spotless", "committedDate": "2020-01-24T00:25:41Z", "type": "commit"}, {"oid": "22bf17fde17485df992c4066f2028a3ac9850db7", "url": "https://github.com/all-of-us/workbench/commit/22bf17fde17485df992c4066f2028a3ac9850db7", "message": "ui touch ups", "committedDate": "2020-01-24T05:06:12Z", "type": "commit"}, {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878", "url": "https://github.com/all-of-us/workbench/commit/bcb09156164e0a8fa4adc098e4f3e07a4249c878", "message": "reset config local", "committedDate": "2020-01-24T05:37:03Z", "type": "commit"}, {"oid": "8059fbf57a79d320c427d672971477bee8b96c50", "url": "https://github.com/all-of-us/workbench/commit/8059fbf57a79d320c427d672971477bee8b96c50", "message": "WIP", "committedDate": "2020-01-24T19:34:39Z", "type": "commit"}, {"oid": "0d58f0c8ae959c787bc1d3d8f5f933b51a4a279d", "url": "https://github.com/all-of-us/workbench/commit/0d58f0c8ae959c787bc1d3d8f5f933b51a4a279d", "message": "add tests", "committedDate": "2020-01-24T22:46:10Z", "type": "commit"}, {"oid": "f6a5ad9558fd6dc971fe773e220edb40a553e315", "url": "https://github.com/all-of-us/workbench/commit/f6a5ad9558fd6dc971fe773e220edb40a553e315", "message": "fix some bugs", "committedDate": "2020-01-24T23:01:10Z", "type": "commit"}, {"oid": "5b576105ad1211d549261ade0a089ff04b1d839a", "url": "https://github.com/all-of-us/workbench/commit/5b576105ad1211d549261ade0a089ff04b1d839a", "message": "add utility for prefixing free tier account id", "committedDate": "2020-01-24T23:28:44Z", "type": "commit"}, {"oid": "65d1a8ed2831881ac513bc3c863d1bdb6e26eb1e", "url": "https://github.com/all-of-us/workbench/commit/65d1a8ed2831881ac513bc3c863d1bdb6e26eb1e", "message": "spotless", "committedDate": "2020-01-24T23:29:11Z", "type": "commit"}, {"oid": "3b06b147d731543fed526895dbadd7aa7761b2d3", "url": "https://github.com/all-of-us/workbench/commit/3b06b147d731543fed526895dbadd7aa7761b2d3", "message": "spotless", "committedDate": "2020-01-24T23:45:36Z", "type": "commit"}, {"oid": "eb829a719287a2c539add9d3e2b7e0bce655617c", "url": "https://github.com/all-of-us/workbench/commit/eb829a719287a2c539add9d3e2b7e0bce655617c", "message": "comments", "committedDate": "2020-01-25T00:06:46Z", "type": "commit"}, {"oid": "6a6019cdc4a1accd019299b73df2ca900fb6b0b5", "url": "https://github.com/all-of-us/workbench/commit/6a6019cdc4a1accd019299b73df2ca900fb6b0b5", "message": "refactor google api config", "committedDate": "2020-01-25T00:19:45Z", "type": "commit"}, {"oid": "1fd898f0f7e346441d97ce15d27f2b0bda45790b", "url": "https://github.com/all-of-us/workbench/commit/1fd898f0f7e346441d97ce15d27f2b0bda45790b", "message": "no null", "committedDate": "2020-01-25T00:22:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1OTk3Mw==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r371459973", "bodyText": "Why the PROXY language here? Elsewhere we have END_USER_FOO as a token which seems accurate to me. Is there a semantic difference?", "author": "calbach", "createdAt": "2020-01-27T20:16:17Z", "path": "api/src/main/java/org/pmiops/workbench/api/UserController.java", "diffHunk": "@@ -57,7 +60,7 @@ public UserController(\n       Provider<WorkbenchConfig> configProvider,\n       FireCloudService fireCloudService,\n       UserService userService,\n-      Provider<Cloudbilling> cloudBillingProvider) {\n+      @Qualifier(USER_PROXY_CLOUD_BILLING) Provider<Cloudbilling> cloudBillingProvider) {", "originalCommit": "1fd898f0f7e346441d97ce15d27f2b0bda45790b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2MDgxMQ==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r371460811", "bodyText": "nit: existing, but why DEFAULT here? Why not just leave blank?", "author": "calbach", "createdAt": "2020-01-27T20:18:08Z", "path": "api/src/main/java/org/pmiops/workbench/billing/GoogleApisConfig.java", "diffHunk": "@@ -18,22 +19,42 @@\n @Configuration\n public class GoogleApisConfig {\n \n-  @Bean\n+  public static final String USER_PROXY_CLOUD_BILLING = \"USER_PROXY_CLOUD_BILLING\";\n+  public static final String SERVICE_ACCOUNT_CLOUD_BILLING = \"SERVICE_ACCOUNT_CLOUD_BILLING\";\n+\n+  @Bean(USER_PROXY_CLOUD_BILLING)\n   @RequestScope(proxyMode = ScopedProxyMode.DEFAULT)\n-  public Cloudbilling googleCloudBillingApi(\n+  public Cloudbilling userProxyGoogleCloudbillingApi(\n       UserAuthentication userAuthentication,\n       JsonFactory jsonFactory,\n       Provider<WorkbenchConfig> workbenchConfigProvider) {\n-    GoogleCredential credential =\n-        new GoogleCredential()\n-            .setAccessToken(userAuthentication.getCredentials())\n-            .createScoped(\n-                Collections.singletonList(\"https://www.googleapis.com/auth/cloud-platform\"));\n+    return createCloudbillingClient(\n+        userAuthentication.getCredentials(), jsonFactory, workbenchConfigProvider.get());\n+  }\n+\n+  @Bean(SERVICE_ACCOUNT_CLOUD_BILLING)\n+  @RequestScope(proxyMode = ScopedProxyMode.DEFAULT)", "originalCommit": "1fd898f0f7e346441d97ce15d27f2b0bda45790b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2MDk4MA==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r371460980", "bodyText": "nit: Per other  PR comments, would just let the exception propagate", "author": "calbach", "createdAt": "2020-01-27T20:18:30Z", "path": "api/src/main/java/org/pmiops/workbench/billing/GoogleApisConfig.java", "diffHunk": "@@ -18,22 +19,42 @@\n @Configuration\n public class GoogleApisConfig {\n \n-  @Bean\n+  public static final String USER_PROXY_CLOUD_BILLING = \"USER_PROXY_CLOUD_BILLING\";\n+  public static final String SERVICE_ACCOUNT_CLOUD_BILLING = \"SERVICE_ACCOUNT_CLOUD_BILLING\";\n+\n+  @Bean(USER_PROXY_CLOUD_BILLING)\n   @RequestScope(proxyMode = ScopedProxyMode.DEFAULT)\n-  public Cloudbilling googleCloudBillingApi(\n+  public Cloudbilling userProxyGoogleCloudbillingApi(\n       UserAuthentication userAuthentication,\n       JsonFactory jsonFactory,\n       Provider<WorkbenchConfig> workbenchConfigProvider) {\n-    GoogleCredential credential =\n-        new GoogleCredential()\n-            .setAccessToken(userAuthentication.getCredentials())\n-            .createScoped(\n-                Collections.singletonList(\"https://www.googleapis.com/auth/cloud-platform\"));\n+    return createCloudbillingClient(\n+        userAuthentication.getCredentials(), jsonFactory, workbenchConfigProvider.get());\n+  }\n+\n+  @Bean(SERVICE_ACCOUNT_CLOUD_BILLING)\n+  @RequestScope(proxyMode = ScopedProxyMode.DEFAULT)\n+  public Cloudbilling serviceAccountGoogleCloudbillingApi(\n+      JsonFactory jsonFactory, Provider<WorkbenchConfig> workbenchConfigProvider) {\n+    String accessToken;\n+    try {\n+      accessToken =\n+          ServiceAccounts.getScopedServiceAccessToken(\n+              Collections.singletonList(\"https://www.googleapis.com/auth/cloud-platform\"));\n+    } catch (IOException e) {\n+      throw new RuntimeException(\"Could not create service account access token for cloud billing\");", "originalCommit": "1fd898f0f7e346441d97ce15d27f2b0bda45790b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a356b996bd3f74c6947a526ec93ec7b48cf0be8f", "url": "https://github.com/all-of-us/workbench/commit/a356b996bd3f74c6947a526ec93ec7b48cf0be8f", "message": "merge master (many conflicts)", "committedDate": "2020-01-28T18:00:18Z", "type": "commit"}, {"oid": "2134ba29b79991778f17a3b5cf55324849295742", "url": "https://github.com/all-of-us/workbench/commit/2134ba29b79991778f17a3b5cf55324849295742", "message": "spotless", "committedDate": "2020-01-28T18:01:20Z", "type": "commit"}, {"oid": "f573ef20aaac8636b4d7c626ed258c01553691ac", "url": "https://github.com/all-of-us/workbench/commit/f573ef20aaac8636b4d7c626ed258c01553691ac", "message": "lint", "committedDate": "2020-01-28T18:03:32Z", "type": "commit"}, {"oid": "a731f94faf59522ada0f9bddcb6e8ccacbd08545", "url": "https://github.com/all-of-us/workbench/commit/a731f94faf59522ada0f9bddcb6e8ccacbd08545", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-4277", "committedDate": "2020-01-28T18:05:32Z", "type": "commit"}, {"oid": "00245e03361b8d6532b4cfae4edb7431971a0045", "url": "https://github.com/all-of-us/workbench/commit/00245e03361b8d6532b4cfae4edb7431971a0045", "message": "stuff missed in the merge", "committedDate": "2020-01-28T18:15:41Z", "type": "commit"}, {"oid": "43b5a48c4cbdad743549bd661723093be593c2de", "url": "https://github.com/all-of-us/workbench/commit/43b5a48c4cbdad743549bd661723093be593c2de", "message": "userProxy -> endUser", "committedDate": "2020-01-28T18:26:23Z", "type": "commit"}, {"oid": "664cfcc6e517c0d426ad2c4c6ac1be1c51992aa3", "url": "https://github.com/all-of-us/workbench/commit/664cfcc6e517c0d426ad2c4c6ac1be1c51992aa3", "message": "spotless", "committedDate": "2020-01-28T18:27:04Z", "type": "commit"}, {"oid": "8f8f45c701f0e6acf3c2eb47cec94a039ccab7ac", "url": "https://github.com/all-of-us/workbench/commit/8f8f45c701f0e6acf3c2eb47cec94a039ccab7ac", "message": "small rename", "committedDate": "2020-01-28T18:52:16Z", "type": "commit"}, {"oid": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "url": "https://github.com/all-of-us/workbench/commit/46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "message": "add request scope", "committedDate": "2020-01-28T18:54:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzNjg0Mw==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372136843", "bodyText": "What's the reason for this change? If it was necessary, it deserves  a comment here.", "author": "calbach", "createdAt": "2020-01-29T00:42:17Z", "path": "api/src/main/java/org/pmiops/workbench/auth/ServiceAccounts.java", "diffHunk": "@@ -39,33 +39,36 @@\n    * @return\n    * @throws IOException\n    */\n-  private static GoogleCredentials getScopedServiceCredentials(List<String> scopes)\n+  public static GoogleCredentials getScopedServiceCredentials(List<String> scopes)\n       throws IOException {\n \n+    GoogleCredentials credentials;\n     if (SystemProperty.environment.value().equals(SystemProperty.Environment.Value.Development)) {\n       // When running in a local dev environment, we simply get the application default credentials.\n       //\n       // TODO(gjuggler): it may be possible to remove this branch point altogether, and use the\n       // AppIdentityService approach even when running a local app engine server. I tested this\n       // out locally and it *seemed* to work, but it needs a bit more careful vetting.\n-      return GoogleCredentials.getApplicationDefault().createScoped(scopes);\n+      credentials = GoogleCredentials.getApplicationDefault().createScoped(scopes);\n     } else {\n       AppIdentityService appIdentityService = AppIdentityServiceFactory.getAppIdentityService();\n-      return AppEngineCredentials.newBuilder()\n-          .setScopes(scopes)\n-          .setAppIdentityService(appIdentityService)\n-          .build();\n+      credentials =\n+          AppEngineCredentials.newBuilder()\n+              .setScopes(scopes)\n+              .setAppIdentityService(appIdentityService)\n+              .build();\n     }\n+\n+    credentials.refreshIfExpired();", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3NjgxMA==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372676810", "bodyText": "It was to preserve existing behavior when I exposed this function publicly.\nBefore this was only called as part of getScopedServiceAccessToken below, which called refreshIfExpired. Now that I exposed a way to call it directly, I decided to add the call into this function to maintain the behavior of always calling refreshIfExpired for credentials returned from this class.\nTBH, I haven't tested its behavior without the call but figured it would be best to keep it the way it is.", "author": "ericsong", "createdAt": "2020-01-29T22:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzNjg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzNjk1OA==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372136958", "bodyText": "nit: cloud-billing is a tighter scope and should probably be preferred here", "author": "calbach", "createdAt": "2020-01-29T00:42:50Z", "path": "api/src/main/java/org/pmiops/workbench/billing/GoogleApisConfig.java", "diffHunk": "@@ -36,4 +40,21 @@ public Cloudbilling googleCloudBillingApi(\n         .setApplicationName(workbenchConfigProvider.get().server.projectId)\n         .build();\n   }\n+\n+  @Bean(SERVICE_ACCOUNT_CLOUD_BILLING)\n+  @RequestScope\n+  public Cloudbilling serviceAccountGoogleCloudbilling(\n+      JsonFactory jsonFactory, Provider<WorkbenchConfig> workbenchConfigProvider)\n+      throws IOException, GeneralSecurityException {\n+    GoogleCredentials credentials =\n+        ServiceAccounts.getScopedServiceCredentials(\n+            Collections.singletonList(\"https://www.googleapis.com/auth/cloud-platform\"));", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzNzc2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372137765", "bodyText": "Why would we want to retry a 403? I think I see the reason below, but would add a comment here for clarity", "author": "calbach", "createdAt": "2020-01-29T00:46:05Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java", "diffHunk": "@@ -645,6 +668,61 @@ public boolean maybeDeleteRecentWorkspace(long workspaceId) {\n     }\n   }\n \n+  private Retryer<ProjectBillingInfo> cloudBillingRetryer =\n+      RetryerBuilder.<ProjectBillingInfo>newBuilder()\n+          .retryIfException(\n+              e ->\n+                  e instanceof GoogleJsonResponseException\n+                      && ((GoogleJsonResponseException) e).getStatusCode() == 403)", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MDYxMw==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372160613", "bodyText": "nit: I'd prefer ServerException to a RuntimeException, here and below", "author": "calbach", "createdAt": "2020-01-29T02:24:14Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java", "diffHunk": "@@ -645,6 +668,61 @@ public boolean maybeDeleteRecentWorkspace(long workspaceId) {\n     }\n   }\n \n+  private Retryer<ProjectBillingInfo> cloudBillingRetryer =\n+      RetryerBuilder.<ProjectBillingInfo>newBuilder()\n+          .retryIfException(\n+              e ->\n+                  e instanceof GoogleJsonResponseException\n+                      && ((GoogleJsonResponseException) e).getStatusCode() == 403)\n+          .withWaitStrategy(WaitStrategies.exponentialWait())\n+          .withStopStrategy(StopStrategies.stopAfterDelay(60, TimeUnit.SECONDS))\n+          .build();\n+\n+  @Override\n+  public void updateWorkspaceBillingAccount(DbWorkspace workspace, String newBillingAccountName) {\n+    if (!workbenchConfigProvider.get().featureFlags.enableBillingLockout\n+        || newBillingAccountName.equals(workspace.getBillingAccountName())) {\n+      return;\n+    }\n+\n+    Cloudbilling cloudbilling;\n+    if (newBillingAccountName.equals(\n+        workbenchConfigProvider.get().billing.freeTierBillingAccountName())) {\n+      cloudbilling = serviceAccountCloudbillingProvider.get();\n+    } else {\n+      cloudbilling = endUserCloudbillingProvider.get();\n+    }\n+\n+    UpdateBillingInfo request;\n+    try {\n+      request =\n+          cloudbilling\n+              .projects()\n+              .updateBillingInfo(\n+                  \"projects/\" + workspace.getWorkspaceNamespace(),\n+                  new ProjectBillingInfo().setBillingAccountName(newBillingAccountName));\n+    } catch (IOException e) {\n+      throw new RuntimeException(\"Could not create Google Cloud updateBillingInfo request\", e);", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3OTgyNA==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372679824", "bodyText": "All the calls are wrapped in a try/catch which rethrows as a ServerException.\nThis was in the interest of layered architecture where API related stuff is kept in the controllers but my stance on that is wavering a bit... Will have to spend some time to try doing a larger refactor and see how it looks.", "author": "ericsong", "createdAt": "2020-01-29T23:03:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MDYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MDk2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372160961", "bodyText": "Ah... unfortunate.", "author": "calbach", "createdAt": "2020-01-29T02:25:51Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java", "diffHunk": "@@ -645,6 +668,61 @@ public boolean maybeDeleteRecentWorkspace(long workspaceId) {\n     }\n   }\n \n+  private Retryer<ProjectBillingInfo> cloudBillingRetryer =\n+      RetryerBuilder.<ProjectBillingInfo>newBuilder()\n+          .retryIfException(\n+              e ->\n+                  e instanceof GoogleJsonResponseException\n+                      && ((GoogleJsonResponseException) e).getStatusCode() == 403)\n+          .withWaitStrategy(WaitStrategies.exponentialWait())\n+          .withStopStrategy(StopStrategies.stopAfterDelay(60, TimeUnit.SECONDS))\n+          .build();\n+\n+  @Override\n+  public void updateWorkspaceBillingAccount(DbWorkspace workspace, String newBillingAccountName) {\n+    if (!workbenchConfigProvider.get().featureFlags.enableBillingLockout\n+        || newBillingAccountName.equals(workspace.getBillingAccountName())) {\n+      return;\n+    }\n+\n+    Cloudbilling cloudbilling;\n+    if (newBillingAccountName.equals(\n+        workbenchConfigProvider.get().billing.freeTierBillingAccountName())) {\n+      cloudbilling = serviceAccountCloudbillingProvider.get();\n+    } else {\n+      cloudbilling = endUserCloudbillingProvider.get();\n+    }\n+\n+    UpdateBillingInfo request;\n+    try {\n+      request =\n+          cloudbilling\n+              .projects()\n+              .updateBillingInfo(\n+                  \"projects/\" + workspace.getWorkspaceNamespace(),\n+                  new ProjectBillingInfo().setBillingAccountName(newBillingAccountName));\n+    } catch (IOException e) {\n+      throw new RuntimeException(\"Could not create Google Cloud updateBillingInfo request\", e);\n+    }\n+\n+    ProjectBillingInfo response;\n+    try {\n+      // this is necessary because the grant ownership call in create/clone", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MTI2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372161265", "bodyText": "Makes sense to me", "author": "calbach", "createdAt": "2020-01-29T02:27:09Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -233,6 +229,11 @@ private FirecloudWorkspace attemptFirecloudWorkspaceCreation(FirecloudWorkspaceI\n \n     Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n     DbWorkspace dbWorkspace = new DbWorkspace();\n+    // A little unintuitive but setting this here reflects the current state of the workspace", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MTYxMw==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372161613", "bodyText": "It would probably be ideal here if the value were carried through on the billing project buffer table, rather than pulled from the config, since the billing account could change while projects are still in the buffer.\nI think that's probably fine to just note this distinction and account for it when we're doing the free tier backfill. I'll make a note there.", "author": "calbach", "createdAt": "2020-01-29T02:29:07Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -233,6 +229,11 @@ private FirecloudWorkspace attemptFirecloudWorkspaceCreation(FirecloudWorkspaceI\n \n     Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n     DbWorkspace dbWorkspace = new DbWorkspace();\n+    // A little unintuitive but setting this here reflects the current state of the workspace", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAyNDk4OA==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r373024988", "bodyText": "tracking here, https://precisionmedicineinitiative.atlassian.net/browse/RW-4355", "author": "ericsong", "createdAt": "2020-01-30T15:40:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MTYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MjI4Mw==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372162283", "bodyText": "Yeah we should definitely have some cron cleanup for orphans here. Do you mind filing a ticket for later?\nFor example, if this request times out (but actually succeeds on the backend), we wind up with a defunct project attached to the user's billing account.", "author": "calbach", "createdAt": "2020-01-29T02:32:48Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -252,7 +253,13 @@ private FirecloudWorkspace attemptFirecloudWorkspaceCreation(FirecloudWorkspaceI\n \n     dbWorkspace.setBillingMigrationStatusEnum(BillingMigrationStatus.NEW);\n \n-    updateWorkspaceBillingAccount(dbWorkspace, workspace.getBillingAccountName());\n+    try {\n+      workspaceService.updateWorkspaceBillingAccount(", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAzMDU0NA==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r373030544", "bodyText": "https://precisionmedicineinitiative.atlassian.net/browse/RW-4356", "author": "ericsong", "createdAt": "2020-01-30T15:49:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MjI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MjU5NA==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372162594", "bodyText": "The PATCH API is only supposed to include fields that have actually been modified. See all the other conditional checks above. This should mirror that behvaior", "author": "calbach", "createdAt": "2020-01-29T02:34:14Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -425,15 +379,22 @@ private void setDbWorkspaceFields(\n       dbWorkspace.setReviewRequested(researchPurpose.getReviewRequested());\n     }\n \n-    updateWorkspaceBillingAccount(dbWorkspace, request.getWorkspace().getBillingAccountName());\n+    try {\n+      workspaceService.updateWorkspaceBillingAccount(", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MzAwOA==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372163008", "bodyText": "Eventually we'll also want some validation here that the creator still has free tier credit available. Do you know whether this is tracked?", "author": "calbach", "createdAt": "2020-01-29T02:36:07Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -545,14 +510,20 @@ private void setDbWorkspaceFields(\n \n     dbWorkspace.setBillingMigrationStatusEnum(BillingMigrationStatus.NEW);\n \n-    updateWorkspaceBillingAccount(dbWorkspace, body.getWorkspace().getBillingAccountName());\n+    try {\n+      workspaceService.updateWorkspaceBillingAccount(", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA0NjQyMg==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r373046422", "bodyText": "I thought we were going to allow users to continue creating workspaces in the free tier so I left it as is. I can ask Karthik if we want some UI treatment around how we handle the expired free tier case.", "author": "ericsong", "createdAt": "2020-01-30T16:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2MzAwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ4NDkwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3040#discussion_r372484905", "bodyText": "nice", "author": "jmthibault79", "createdAt": "2020-01-29T16:20:27Z", "path": "api/src/main/java/org/pmiops/workbench/api/UserController.java", "diffHunk": "@@ -136,7 +139,7 @@ private BillingAccount freeTierBillingAccount() {\n     return new BillingAccount()\n         .isFreeTier(true)\n         .displayName(\"Use All of Us free credits\")\n-        .name(\"billingAccounts/\" + configProvider.get().billing.accountId)\n+        .name(configProvider.get().billing.freeTierBillingAccountName())", "originalCommit": "46a9cf3a34b5db8bb8acec5552d3b2a99528a15e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fb7800b6464872f887abc3d132d4e953d0b5d9fa", "url": "https://github.com/all-of-us/workbench/commit/fb7800b6464872f887abc3d132d4e953d0b5d9fa", "message": "code review feedback", "committedDate": "2020-01-30T16:16:14Z", "type": "commit"}, {"oid": "7ba90c390ee314413217784802c90f1fc8215892", "url": "https://github.com/all-of-us/workbench/commit/7ba90c390ee314413217784802c90f1fc8215892", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-4277", "committedDate": "2020-01-30T17:05:11Z", "type": "commit"}, {"oid": "d4eb55e7433172fcf93a207e24cd7ecec9c5cc15", "url": "https://github.com/all-of-us/workbench/commit/d4eb55e7433172fcf93a207e24cd7ecec9c5cc15", "message": "turn on feature flag", "committedDate": "2020-01-30T17:05:37Z", "type": "commit"}]}