{"pr_number": 4030, "pr_title": "[RW-4884] Expose the GCS bucket name to the workspace admin page and fetch-workspace-details tool", "pr_createdAt": "2020-09-21T13:07:54Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4030", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEzODI1MA==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492138250", "bodyText": "It's almost  worth making an AbstractApplicationRunListener with empty overrides for everything and extending that so you only have methods that actually do things in this class.", "author": "jaycarlton", "createdAt": "2020-09-21T15:16:29Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ApplicationRunListener.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.tools;\n+\n+import org.springframework.boot.SpringApplication;\n+import org.springframework.boot.SpringApplicationRunListener;\n+import org.springframework.context.ConfigurableApplicationContext;\n+import org.springframework.context.support.SimpleThreadScope;\n+import org.springframework.core.env.ConfigurableEnvironment;\n+import org.springframework.web.context.WebApplicationContext;\n+\n+/**\n+ * A custom application listener to allow us to mutate the application context before any\n+ * command-line tools are run.\n+ *\n+ * <p>This class currently serves a single purpose, which is to create a fake \"request\" bean scope\n+ * to allow command-line tools to load RW beans that are request-scoped for use in the main webapp.\n+ *\n+ * <p>See https://stackoverflow.com/a/28275111 which is the pattern we roughly followed here. This\n+ * class is referenced from resources/META-INF/spring.factories, which causes this class to be\n+ * loaded before the Spring context is initialized.\n+ */\n+public class ApplicationRunListener implements SpringApplicationRunListener {\n+\n+  public ApplicationRunListener(SpringApplication application, String[] args) {}\n+\n+  /**", "originalCommit": "8c1bd95d6cb499b91ce50a6bd2fc54812cfa12a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzMzU5Mw==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492433593", "bodyText": "Not worth creating two class files for one line of code, IMO", "author": "gjuggler", "createdAt": "2020-09-22T01:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEzODI1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0MjM3Nw==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492142377", "bodyText": "It would be great to have a comment specific to this implementation of the method giving the why/how, etc. Could this break any existing code (ours or anyone else's) that depends on this scope, or is the idea that it will be clobbered later on in the application startup and be associated with the usual scope and properties, etc.", "author": "jaycarlton", "createdAt": "2020-09-21T15:20:09Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ApplicationRunListener.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.tools;\n+\n+import org.springframework.boot.SpringApplication;\n+import org.springframework.boot.SpringApplicationRunListener;\n+import org.springframework.context.ConfigurableApplicationContext;\n+import org.springframework.context.support.SimpleThreadScope;\n+import org.springframework.core.env.ConfigurableEnvironment;\n+import org.springframework.web.context.WebApplicationContext;\n+\n+/**\n+ * A custom application listener to allow us to mutate the application context before any\n+ * command-line tools are run.\n+ *\n+ * <p>This class currently serves a single purpose, which is to create a fake \"request\" bean scope\n+ * to allow command-line tools to load RW beans that are request-scoped for use in the main webapp.\n+ *\n+ * <p>See https://stackoverflow.com/a/28275111 which is the pattern we roughly followed here. This\n+ * class is referenced from resources/META-INF/spring.factories, which causes this class to be\n+ * loaded before the Spring context is initialized.\n+ */\n+public class ApplicationRunListener implements SpringApplicationRunListener {\n+\n+  public ApplicationRunListener(SpringApplication application, String[] args) {}\n+\n+  /**\n+   * Called immediately when the run method has first started. Can be used for very early\n+   * initialization.\n+   */\n+  @Override\n+  public void starting() {}\n+\n+  /**\n+   * Called once the environment has been prepared, but before the {@link ApplicationContext} has\n+   * been created.\n+   *\n+   * @param environment the environment\n+   */\n+  @Override\n+  public void environmentPrepared(ConfigurableEnvironment environment) {}\n+\n+  /**\n+   * Called once the {@link ApplicationContext} has been created and prepared, but before sources\n+   * have been loaded.\n+   *\n+   * @param context the application context\n+   */\n+  @Override", "originalCommit": "8c1bd95d6cb499b91ce50a6bd2fc54812cfa12a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzMzUzMA==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492433530", "bodyText": "I removed most of the boilerplate Javadoc. The class-level comment is meant to capture what's going on here, I don't think there's much else to add at this level.", "author": "gjuggler", "createdAt": "2020-09-22T01:37:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0MjM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0MjkxNg==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492142916", "bodyText": "I'd log something here as a breadcrumb to indicate that you're tweaking the default behavior of scope requests.", "author": "jaycarlton", "createdAt": "2020-09-21T15:20:45Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ApplicationRunListener.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.tools;\n+\n+import org.springframework.boot.SpringApplication;\n+import org.springframework.boot.SpringApplicationRunListener;\n+import org.springframework.context.ConfigurableApplicationContext;\n+import org.springframework.context.support.SimpleThreadScope;\n+import org.springframework.core.env.ConfigurableEnvironment;\n+import org.springframework.web.context.WebApplicationContext;\n+\n+/**\n+ * A custom application listener to allow us to mutate the application context before any\n+ * command-line tools are run.\n+ *\n+ * <p>This class currently serves a single purpose, which is to create a fake \"request\" bean scope\n+ * to allow command-line tools to load RW beans that are request-scoped for use in the main webapp.\n+ *\n+ * <p>See https://stackoverflow.com/a/28275111 which is the pattern we roughly followed here. This\n+ * class is referenced from resources/META-INF/spring.factories, which causes this class to be\n+ * loaded before the Spring context is initialized.\n+ */\n+public class ApplicationRunListener implements SpringApplicationRunListener {\n+\n+  public ApplicationRunListener(SpringApplication application, String[] args) {}\n+\n+  /**\n+   * Called immediately when the run method has first started. Can be used for very early\n+   * initialization.\n+   */\n+  @Override\n+  public void starting() {}\n+\n+  /**\n+   * Called once the environment has been prepared, but before the {@link ApplicationContext} has\n+   * been created.\n+   *\n+   * @param environment the environment\n+   */\n+  @Override\n+  public void environmentPrepared(ConfigurableEnvironment environment) {}\n+\n+  /**\n+   * Called once the {@link ApplicationContext} has been created and prepared, but before sources\n+   * have been loaded.\n+   *\n+   * @param context the application context\n+   */\n+  @Override\n+  public void contextPrepared(ConfigurableApplicationContext context) {\n+    context\n+        .getBeanFactory()\n+        .registerScope(WebApplicationContext.SCOPE_REQUEST, new SimpleThreadScope());\n+  }", "originalCommit": "8c1bd95d6cb499b91ce50a6bd2fc54812cfa12a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzNDcwNw==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492434707", "bodyText": "Is anyone ever really paying attention to Spring's startup text parade? I'm skeptical, but adding something b/c it's easy.", "author": "gjuggler", "createdAt": "2020-09-22T01:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0MjkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0NjgzNA==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492146834", "bodyText": "Also, I'd consider extending SimpleThreadScope with something like AoUPreConfigRequestScopePlaceholder or otherwise suspicious and using that so it shows up in stack traces or config graphs, which would increase the likelihood of a maintainer finding this.", "author": "jaycarlton", "createdAt": "2020-09-21T15:24:00Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ApplicationRunListener.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.tools;\n+\n+import org.springframework.boot.SpringApplication;\n+import org.springframework.boot.SpringApplicationRunListener;\n+import org.springframework.context.ConfigurableApplicationContext;\n+import org.springframework.context.support.SimpleThreadScope;\n+import org.springframework.core.env.ConfigurableEnvironment;\n+import org.springframework.web.context.WebApplicationContext;\n+\n+/**\n+ * A custom application listener to allow us to mutate the application context before any\n+ * command-line tools are run.\n+ *\n+ * <p>This class currently serves a single purpose, which is to create a fake \"request\" bean scope\n+ * to allow command-line tools to load RW beans that are request-scoped for use in the main webapp.\n+ *\n+ * <p>See https://stackoverflow.com/a/28275111 which is the pattern we roughly followed here. This\n+ * class is referenced from resources/META-INF/spring.factories, which causes this class to be\n+ * loaded before the Spring context is initialized.\n+ */\n+public class ApplicationRunListener implements SpringApplicationRunListener {\n+\n+  public ApplicationRunListener(SpringApplication application, String[] args) {}\n+\n+  /**\n+   * Called immediately when the run method has first started. Can be used for very early\n+   * initialization.\n+   */\n+  @Override\n+  public void starting() {}\n+\n+  /**\n+   * Called once the environment has been prepared, but before the {@link ApplicationContext} has\n+   * been created.\n+   *\n+   * @param environment the environment\n+   */\n+  @Override\n+  public void environmentPrepared(ConfigurableEnvironment environment) {}\n+\n+  /**\n+   * Called once the {@link ApplicationContext} has been created and prepared, but before sources\n+   * have been loaded.\n+   *\n+   * @param context the application context\n+   */\n+  @Override\n+  public void contextPrepared(ConfigurableApplicationContext context) {\n+    context\n+        .getBeanFactory()\n+        .registerScope(WebApplicationContext.SCOPE_REQUEST, new SimpleThreadScope());", "originalCommit": "8c1bd95d6cb499b91ce50a6bd2fc54812cfa12a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzNDE5OA==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492434198", "bodyText": "Could be nice, but sounds pretty hypothetical. I'd rather not end up with more files floating around here.", "author": "gjuggler", "createdAt": "2020-09-22T01:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0NjgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0OTI5MQ==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492149291", "bodyText": "nit/tangent: I didn't know about this class (haven't worked with the tools much), but a couple of our other configs are named with a SpringConfiguration suffix (to distinguish from other config classes). I navigate randomly so much that I forget to look at package names, though I'm getting better.", "author": "jaycarlton", "createdAt": "2020-09-21T15:26:03Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/FetchWorkspaceDetails.java", "diffHunk": "@@ -9,20 +9,23 @@\n import org.apache.commons.cli.Options;\n import org.pmiops.workbench.db.dao.WorkspaceDao;\n import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.pmiops.workbench.firecloud.FireCloudConfig;\n+import org.pmiops.workbench.firecloud.FireCloudService;\n+import org.pmiops.workbench.firecloud.FireCloudServiceImpl;\n import org.pmiops.workbench.firecloud.FirecloudTransforms;\n import org.pmiops.workbench.firecloud.api.WorkspacesApi;\n import org.pmiops.workbench.firecloud.model.FirecloudWorkspaceAccessEntry;\n import org.springframework.boot.CommandLineRunner;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Import;\n \n /**\n  * A tool that takes a Workspace namespace / Firecloud Project ID and returns details for any\n  * workspaces found.\n- *\n- * <p>Details currently include... - Name - Creator Email - Collaborator Emails and Access Levels\n  */\n @Configuration\n+@Import({FireCloudServiceImpl.class, FireCloudConfig.class})\n public class FetchWorkspaceDetails {", "originalCommit": "8c1bd95d6cb499b91ce50a6bd2fc54812cfa12a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzNTg1Nw==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492435857", "bodyText": "Was this meant to be attached to the CommandLineToolConfig file?\nI also got annoyed at that naming degeneracy at some point. We have many, many more Spring configs than other configs, so I'd probably bend towards adding a suffix to non-Spring config files if we did need to add clarity. (Something like \"AppConfig\" or \"ConfigModel\" might be clear.)\nBut I've mostly just accepted that there's probably no great solution here.", "author": "gjuggler", "createdAt": "2020-09-22T01:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0OTI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMTAyOA==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492701028", "bodyText": "I was confused mainly on why FileWorkspaceDetails seems to have @Configuration in it. But maybe all the tools work that way.", "author": "jaycarlton", "createdAt": "2020-09-22T12:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0OTI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxMDY0NA==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492710644", "bodyText": "Ah \u2013 yes, all the tools work this way. Technically, it's just a configuration that provides a @CommandLineRunner bean. Spring docs for that annotation:\nInterface used to indicate that a bean should <em>run</em> when it is contained within a {@link SpringApplication}.\n\nIt's a bit roundabout, but it's definitely the most reliable setup we've had for CLI tools yet.", "author": "gjuggler", "createdAt": "2020-09-22T12:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0OTI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE1MzAyNw==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492153027", "bodyText": "Is it possible to pull in the WorkspaceAdminService (or other high-level service) instead? Some of this information is already being compiled for the admin page. There are a ton of transient dependencies though, so I can understand why you wouldn't.", "author": "jaycarlton", "createdAt": "2020-09-21T15:29:08Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/FetchWorkspaceDetails.java", "diffHunk": "@@ -9,20 +9,23 @@\n import org.apache.commons.cli.Options;\n import org.pmiops.workbench.db.dao.WorkspaceDao;\n import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.pmiops.workbench.firecloud.FireCloudConfig;\n+import org.pmiops.workbench.firecloud.FireCloudService;\n+import org.pmiops.workbench.firecloud.FireCloudServiceImpl;\n import org.pmiops.workbench.firecloud.FirecloudTransforms;\n import org.pmiops.workbench.firecloud.api.WorkspacesApi;\n import org.pmiops.workbench.firecloud.model.FirecloudWorkspaceAccessEntry;\n import org.springframework.boot.CommandLineRunner;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Import;\n \n /**\n  * A tool that takes a Workspace namespace / Firecloud Project ID and returns details for any\n  * workspaces found.\n- *\n- * <p>Details currently include... - Name - Creator Email - Collaborator Emails and Access Levels\n  */\n @Configuration\n+@Import({FireCloudServiceImpl.class, FireCloudConfig.class})", "originalCommit": "8c1bd95d6cb499b91ce50a6bd2fc54812cfa12a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzNDk2NA==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492434964", "bodyText": "Maybe it's possible, but I don't think it would be preferable. I'm pulling in the smallest service that has the methods needed for this PR, which I think is the right thing to do, dependency-wise.", "author": "gjuggler", "createdAt": "2020-09-22T01:44:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE1MzAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE1MzYwOQ==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492153609", "bodyText": "nit: maybe name this ToolApplicationRunListener so it's more obvious when it gets pulled in.", "author": "jaycarlton", "createdAt": "2020-09-21T15:29:54Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ApplicationRunListener.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.tools;\n+\n+import org.springframework.boot.SpringApplication;\n+import org.springframework.boot.SpringApplicationRunListener;\n+import org.springframework.context.ConfigurableApplicationContext;\n+import org.springframework.context.support.SimpleThreadScope;\n+import org.springframework.core.env.ConfigurableEnvironment;\n+import org.springframework.web.context.WebApplicationContext;\n+\n+/**\n+ * A custom application listener to allow us to mutate the application context before any\n+ * command-line tools are run.\n+ *\n+ * <p>This class currently serves a single purpose, which is to create a fake \"request\" bean scope\n+ * to allow command-line tools to load RW beans that are request-scoped for use in the main webapp.\n+ *\n+ * <p>See https://stackoverflow.com/a/28275111 which is the pattern we roughly followed here. This\n+ * class is referenced from resources/META-INF/spring.factories, which causes this class to be\n+ * loaded before the Spring context is initialized.\n+ */\n+public class ApplicationRunListener implements SpringApplicationRunListener {", "originalCommit": "8c1bd95d6cb499b91ce50a6bd2fc54812cfa12a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzMzgzMQ==", "url": "https://github.com/all-of-us/workbench/pull/4030#discussion_r492433831", "bodyText": "Good idea \u2013\u00a0I renamed to CommandLineToolApplicationRunListener for (1) consistency with CommandLineToolConfig and (2) ApproachingPeakJavaCamelCase", "author": "gjuggler", "createdAt": "2020-09-22T01:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE1MzYwOQ=="}], "type": "inlineReview"}, {"oid": "fb35071617d803b07c0d30d6015c8e70b4d690df", "url": "https://github.com/all-of-us/workbench/commit/fb35071617d803b07c0d30d6015c8e70b4d690df", "message": "Add GCS bucket path to the workpace admin UI and CLI.", "committedDate": "2020-09-22T01:30:15Z", "type": "commit"}, {"oid": "7b07e48e1a34aff3200a50cc703264eb3e4f819c", "url": "https://github.com/all-of-us/workbench/commit/7b07e48e1a34aff3200a50cc703264eb3e4f819c", "message": "Spotless format", "committedDate": "2020-09-22T01:30:25Z", "type": "commit"}, {"oid": "0f561c7e735c961f39755bbf613e2212a08ce9a7", "url": "https://github.com/all-of-us/workbench/commit/0f561c7e735c961f39755bbf613e2212a08ce9a7", "message": "Add some comments and use a typed reference to the Request scope magic string.", "committedDate": "2020-09-22T01:30:45Z", "type": "commit"}, {"oid": "13c3ffd798c51d84fe61117fe3707743c7ca044f", "url": "https://github.com/all-of-us/workbench/commit/13c3ffd798c51d84fe61117fe3707743c7ca044f", "message": "PR feedback", "committedDate": "2020-09-22T01:51:52Z", "type": "commit"}, {"oid": "13c3ffd798c51d84fe61117fe3707743c7ca044f", "url": "https://github.com/all-of-us/workbench/commit/13c3ffd798c51d84fe61117fe3707743c7ca044f", "message": "PR feedback", "committedDate": "2020-09-22T01:51:52Z", "type": "forcePushed"}, {"oid": "fed9d9145557fe34221393c5a912c8aedb20f72c", "url": "https://github.com/all-of-us/workbench/commit/fed9d9145557fe34221393c5a912c8aedb20f72c", "message": "Fix unit test", "committedDate": "2020-09-22T13:11:50Z", "type": "commit"}]}