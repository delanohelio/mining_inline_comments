{"pr_number": 3627, "pr_title": "[RW-4521][risk=low] Create API for updating verified institution", "pr_createdAt": "2020-05-29T21:12:47Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3627", "timeline": [{"oid": "d2a45a2285a501f216773de3f5faf080df918030", "url": "https://github.com/all-of-us/workbench/commit/d2a45a2285a501f216773de3f5faf080df918030", "message": "first pass, shelving for pairing", "committedDate": "2020-05-28T17:16:34Z", "type": "commit"}, {"oid": "3819ffda201293a8631851b0ea0822ada0b28e65", "url": "https://github.com/all-of-us/workbench/commit/3819ffda201293a8631851b0ea0822ada0b28e65", "message": "Pairing on ProfileService for validate institution", "committedDate": "2020-05-28T18:26:54Z", "type": "commit"}, {"oid": "4a40f06efa821b342c5ddd45d3ad7b2ec0369bff", "url": "https://github.com/all-of-us/workbench/commit/4a40f06efa821b342c5ddd45d3ad7b2ec0369bff", "message": "think this ought to work.", "committedDate": "2020-05-29T21:07:17Z", "type": "commit"}, {"oid": "f11382f6ae91b85365fd92ed975204e3411cd6e7", "url": "https://github.com/all-of-us/workbench/commit/f11382f6ae91b85365fd92ed975204e3411cd6e7", "message": "spotless", "committedDate": "2020-05-29T21:19:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczODYwNg==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r432738606", "bodyText": "pushed this down into the Service layer. Ideally more things would be there but that would take a LOT of time for a relatively time sensitive PR.", "author": "als364", "createdAt": "2020-05-29T21:14:30Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -567,28 +558,6 @@ private void verifyCaptcha(String captchaToken) {\n     }\n   }\n \n-  private void verifyInstitutionalAffiliation(Profile profile) {", "originalCommit": "4a40f06efa821b342c5ddd45d3ad7b2ec0369bff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczODkxMw==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r432738913", "bodyText": "note to self: this is probably redundant", "author": "als364", "createdAt": "2020-05-29T21:15:15Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -723,6 +695,20 @@ private boolean userHasEverLoggedIn(\n     return ResponseEntity.status(HttpStatus.NO_CONTENT).build();\n   }\n \n+  @AuthorityRequired(Authority.ACCESS_CONTROL_ADMIN)\n+  @Override\n+  public ResponseEntity<EmptyResponse> updateVerifiedInstitutionalAffiliation(\n+      Long userId, VerifiedInstitutionalAffiliation verifiedInstitution) {\n+    DbUser dbUser = userDao.findUserByUserId(userId);\n+    Profile profile = profileService.getProfile(dbUser);\n+\n+    profile.setVerifiedInstitutionalAffiliation(verifiedInstitution);\n+    profileService.verifyInstitutionalAffiliation(profile);", "originalCommit": "4a40f06efa821b342c5ddd45d3ad7b2ec0369bff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczOTYyNg==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r432739626", "bodyText": "I think ideally I'd run all updates like this directly through updateProfile or something like adminUpdateProfile rather than something specific to verified institution. I'll address that in RW-4980 where we'll take a holistic look at what we want the API structure to look like for the user admin", "author": "als364", "createdAt": "2020-05-29T21:17:06Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -723,6 +695,20 @@ private boolean userHasEverLoggedIn(\n     return ResponseEntity.status(HttpStatus.NO_CONTENT).build();\n   }\n \n+  @AuthorityRequired(Authority.ACCESS_CONTROL_ADMIN)\n+  @Override\n+  public ResponseEntity<EmptyResponse> updateVerifiedInstitutionalAffiliation(", "originalCommit": "4a40f06efa821b342c5ddd45d3ad7b2ec0369bff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4OTM5NQ==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433889395", "bodyText": "Makes total sense \u2013 I'd love to brainstorm ideas here. As I'm going through this PR I'm starting to build some mental model of how profile vs. user APIs and models might be cleaned up for the future.", "author": "gjuggler", "createdAt": "2020-06-02T13:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczOTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NDM2OA==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r434064368", "bodyText": "Yes, let's talk about that later.", "author": "als364", "createdAt": "2020-06-02T17:54:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczOTYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczOTcxNw==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r432739717", "bodyText": "note to self: unnecessary", "author": "als364", "createdAt": "2020-05-29T21:17:23Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileMapper.java", "diffHunk": "@@ -19,7 +20,8 @@\n       CommonMappers.class,\n       DemographicSurveyMapper.class,\n       InstitutionalAffiliationMapper.class,\n-      PageVisitMapper.class\n+      PageVisitMapper.class,\n+      VerifiedInstitutionalAffiliationMapper.class", "originalCommit": "4a40f06efa821b342c5ddd45d3ad7b2ec0369bff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0MDAwMA==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r432740000", "bodyText": "note to self: revert", "author": "als364", "createdAt": "2020-05-29T21:18:12Z", "path": "api/src/test/java/org/pmiops/workbench/profile/ProfileServiceTest.java", "diffHunk": "@@ -36,7 +43,12 @@\n   @Autowired VerifiedInstitutionalAffiliationMapper verifiedInstitutionalAffiliationMapper;\n \n   @TestConfiguration\n-  @MockBean({FreeTierBillingService.class})\n+  @MockBean({", "originalCommit": "4a40f06efa821b342c5ddd45d3ad7b2ec0369bff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0MDI3NA==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r432740274", "bodyText": "I think I want to move the tests for verifyInstitutionalAffiliation into this test class since that function is now in the Service layer", "author": "als364", "createdAt": "2020-05-29T21:18:58Z", "path": "api/src/test/java/org/pmiops/workbench/profile/ProfileServiceTest.java", "diffHunk": "@@ -36,7 +43,12 @@\n   @Autowired VerifiedInstitutionalAffiliationMapper verifiedInstitutionalAffiliationMapper;\n \n   @TestConfiguration\n-  @MockBean({FreeTierBillingService.class})\n+  @MockBean({\n+      FreeTierBillingService.class,\n+      InstitutionDao.class,\n+      InstitutionService.class,\n+      UserService.class,\n+  })", "originalCommit": "4a40f06efa821b342c5ddd45d3ad7b2ec0369bff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c28c42438c641a7a992cc7a03a2bf39bfac418cf", "url": "https://github.com/all-of-us/workbench/commit/c28c42438c641a7a992cc7a03a2bf39bfac418cf", "message": "most of the changes I wanted to make", "committedDate": "2020-06-01T18:09:19Z", "type": "commit"}, {"oid": "00ce1e0cecc4be512d7af0bf9bdfd9ce9b31db5a", "url": "https://github.com/all-of-us/workbench/commit/00ce1e0cecc4be512d7af0bf9bdfd9ce9b31db5a", "message": "unit tests for validateInstitutionalAffiliation", "committedDate": "2020-06-01T20:24:32Z", "type": "commit"}, {"oid": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "url": "https://github.com/all-of-us/workbench/commit/7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "message": "spotless", "committedDate": "2020-06-01T20:43:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1MDE2Nw==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433850167", "bodyText": "For other admin-specific APIs, we've lately been splitting them into their own controller for clarity (e.g. AdminWorkspaceController). Maybe not for this PR, but I would consider aiming for a similar setup in the long run for profile-admin APIs.", "author": "gjuggler", "createdAt": "2020-06-02T12:51:35Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -723,6 +699,19 @@ private boolean userHasEverLoggedIn(\n     return ResponseEntity.status(HttpStatus.NO_CONTENT).build();\n   }\n \n+  @AuthorityRequired(Authority.ACCESS_CONTROL_ADMIN)", "originalCommit": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NDA1OQ==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r434064059", "bodyText": "yep, planning on doing that as part of the holistic api design work that will happen in RW-4980", "author": "als364", "createdAt": "2020-06-02T17:53:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1MDE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1MTg3NA==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433851874", "bodyText": "naming nit: dropping \"affiliation\" can be misleading here. In other files we seem to use \"verifiedAffiliation\" as the preferred term.", "author": "gjuggler", "createdAt": "2020-06-02T12:54:19Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -723,6 +699,19 @@ private boolean userHasEverLoggedIn(\n     return ResponseEntity.status(HttpStatus.NO_CONTENT).build();\n   }\n \n+  @AuthorityRequired(Authority.ACCESS_CONTROL_ADMIN)\n+  @Override\n+  public ResponseEntity<EmptyResponse> updateVerifiedInstitutionalAffiliation(\n+      Long userId, VerifiedInstitutionalAffiliation verifiedInstitution) {", "originalCommit": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NDQxMw==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r434064413", "bodyText": "good call.", "author": "als364", "createdAt": "2020-06-02T17:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1MTg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1NDY1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433854656", "bodyText": "Why does this validate() method return a model object? It muddies the method contract. IMO a validateFoo method should generally throw an error when something is incorrect, otherwise return void.\nReading through the method below, the returned VerifiedInstitutionalAffiliation object is the same as what's stored in the profile, except with potentially a modified institution display name. If the profile controller needs to fetch the institution to return a display name, I'd make that a separate call rather than happening through this method.", "author": "gjuggler", "createdAt": "2020-06-02T12:58:50Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -70,4 +88,62 @@ public Profile getProfile(DbUser user) {\n \n     return profile;\n   }\n+\n+  public VerifiedInstitutionalAffiliation validateInstitutionalAffiliation(Profile profile) {", "originalCommit": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1NTE5NA==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433855194", "bodyText": "I'm not clear on why this logic needs to exist. Neither the validation logic nor the method caller should really care about the display name, since the only input that matters is (1) the institution short name and (2) the user's email address. Was there something else that motivated this conditional logic?", "author": "gjuggler", "createdAt": "2020-06-02T12:59:42Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -70,4 +88,62 @@ public Profile getProfile(DbUser user) {\n \n     return profile;\n   }\n+\n+  public VerifiedInstitutionalAffiliation validateInstitutionalAffiliation(Profile profile) {\n+    VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation =\n+        profile.getVerifiedInstitutionalAffiliation();\n+\n+    if (verifiedInstitutionalAffiliation == null) {\n+      throw new BadRequestException(\"Institutional affiliation cannot be empty\");\n+    }\n+\n+    Optional<DbInstitution> institution =\n+        institutionDao.findOneByShortName(\n+            verifiedInstitutionalAffiliation.getInstitutionShortName());\n+    if (!institution.isPresent()) {\n+      throw new NotFoundException(\n+          String.format(\n+              \"Could not find institution %s in database\",\n+              verifiedInstitutionalAffiliation.getInstitutionShortName()));\n+    }\n+    if (!institution", "originalCommit": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NTEzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r434065139", "bodyText": "I probably wrote this when I was still sorting out the differences between the db model and the api model.", "author": "als364", "createdAt": "2020-06-02T17:55:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1NTE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1OTUwMQ==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433859501", "bodyText": "Why is InstitutionService included as a MockBean here and also above? I think you can remove one or the other, no?", "author": "gjuggler", "createdAt": "2020-06-02T13:06:39Z", "path": "api/src/test/java/org/pmiops/workbench/profile/ProfileServiceTest.java", "diffHunk": "@@ -29,14 +40,18 @@\n @DataJpaTest\n public class ProfileServiceTest {\n \n+  @MockBean private InstitutionDao mockInstitutionDao;\n+  @MockBean private InstitutionService mockInstitutionService;\n   @MockBean private UserTermsOfServiceDao mockUserTermsOfServiceDao;\n \n+  @MockBean\n+  private VerifiedInstitutionalAffiliationMapper mockVerifiedInstitutionalAffiliationMapper;\n+\n   @Autowired ProfileService profileService;\n   @Autowired UserDao userDao;\n-  @Autowired VerifiedInstitutionalAffiliationMapper verifiedInstitutionalAffiliationMapper;\n \n   @TestConfiguration\n-  @MockBean({FreeTierBillingService.class})\n+  @MockBean({FreeTierBillingService.class, InstitutionService.class, UserService.class})", "originalCommit": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg2NjkwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433866905", "bodyText": "[opt] I feel like there could be some meaningful argument capture here, to ensure that this method is called with the correct institutional affiliation shortName. This would require building a non-empty DbVerifiedInstitutionalAffiliation at L122, which feels like a good idea anyway (since in the real world, we'll expect that Db model object to be non-empty).\nThis connection, between the mapper return value and the institutionService call, is IMO the main piece of logic that's being tested in this positive case \u2013\u00a0so it seems potentially useful to explicitly check.", "author": "gjuggler", "createdAt": "2020-06-02T13:17:59Z", "path": "api/src/test/java/org/pmiops/workbench/profile/ProfileServiceTest.java", "diffHunk": "@@ -77,4 +92,203 @@ public void testReturnsLastAcknowledgedTermsOfService() {\n     assertThat(profile.getLatestTermsOfServiceVersion()).isEqualTo(1);\n     assertThat(profile.getLatestTermsOfServiceTime()).isEqualTo(1);\n   }\n+\n+  @Test\n+  public void validateInstitutionalAffiliation() {\n+    VerifiedInstitutionalAffiliation affiliation =\n+        new VerifiedInstitutionalAffiliation()\n+            .institutionShortName(\"Broad\")\n+            .institutionDisplayName(\"The Broad Institute\")\n+            .institutionalRoleEnum(InstitutionalRole.OTHER)\n+            .institutionalRoleOtherText(\"Kibitzing\");\n+\n+    Profile profile =\n+        new Profile()\n+            .verifiedInstitutionalAffiliation(affiliation)\n+            .contactEmail(\"kibitz@broadinstitute.org\");\n+\n+    DbInstitution dbInstitution = new DbInstitution();\n+    dbInstitution.setShortName(\"Broad\");\n+    dbInstitution.setDisplayName(\"The Broad Institute\");\n+\n+    when(mockInstitutionDao.findOneByShortName(\"Broad\")).thenReturn(Optional.of(dbInstitution));\n+\n+    when(mockInstitutionService.validateAffiliation(\n+            any(DbVerifiedInstitutionalAffiliation.class), anyString()))", "originalCommit": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE1ODQ2NA==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r434158464", "bodyText": "Something like:\ncreate mock DbVerifiedInstitutionalAffiliation with appropriate values\ntell mapper to return mock when called\ntell institution service to return true when called with mock (or when called with anything?)\nspy on institutionService validate call to make sure the DbVerifiedInstitutionalAffiliation has the right shortname\n\nWouldn't that be redundant? Did you maybe mean the profileService call?", "author": "als364", "createdAt": "2020-06-02T20:32:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg2NjkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3NzAyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433877025", "bodyText": "We're not changing the fact that non-admin profile updates aren't allowed to change affiliation, right? Removing this line breaks that enforcement.\nI think I know why you removed this, because we're using a unified code path for non-admin and admin profile updates. But we need to account for the fact that self-profile updates have different business logic than admin-driven profile updates.\nA couple options:\n\nBump this logic into a checkUserProfileUpdate method, whose job is basically to reject any requests where a user is trying to update things that they shouldn't be allowed to. This fits nicely with a higher-level goal of pushing more of the core upsert logic into a service, but keeping the top-level \"can I do this\" logic in the controller itself.\nPass down some additional call context to methods like this, e.g. \"boolean isAdmin\" (Seems clunky)", "author": "gjuggler", "createdAt": "2020-06-02T13:32:24Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -318,13 +316,6 @@ private void validateUpdatedProfile(Profile updatedProfile, Profile prevProfile)\n       // See RW-1488.\n       throw new BadRequestException(\"Changing username is not supported\");\n     }\n-    final VerifiedInstitutionalAffiliation updatedAffil =", "originalCommit": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1NzIzNw==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r434057237", "bodyText": "We can't control the signature of the public controller methods without changing the API and that seems like overkill for something like this. so I'll do the first one.", "author": "als364", "createdAt": "2020-06-02T17:41:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3NzAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2Mzc5NQ==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r434163795", "bodyText": "hm. I don't think we have a pattern of checking authority on the backend outside of @AuthorityRequired annotations and I don't want to introduce one. \ud83d\ude41 maybe I'll fork the controller now and factor out as much stuff from updateProfile as I can.", "author": "als364", "createdAt": "2020-06-02T20:42:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3NzAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0NDM4Mg==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r434544382", "bodyText": "I don't think forking the controller should be needed. The crux of this issue (similar to the one further down about userProvider.get()) is that we're attempting to use the same top-level controller method for two different purposes now.\nInstead, one could create a private updateProfileImpl method which is called by the two top-level controller methods. With that change in place, to resolve this issue you could create a checkUserProfileUpdate method which is only called by the updateProfile top-level controller.\ne.g. something like the following would be very clear\npublic ResponseEntity<Void> updateProfile(Profile updatedProfile) {\n  validateUserProfileUpdate(updatedProfile);\n  updateProfileImpl(updatedProfile, userProvider.get());\n}\n\npublic ResponseEntity<Void> updateVerifiedInstitutionalAffiliation(long userId, VerifiedInstitutionalAffiliation verifiedInstitution) {\n  [...]\n  updateProfileImpl(updatedProfile, userDao.findUserByUserId(userId));\n}\n\nand eventually updateProfileImpl should be factored into ProfileService.", "author": "gjuggler", "createdAt": "2020-06-03T12:55:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3NzAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwNzMwOA==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r437007308", "bodyText": "moved into updateProfile.", "author": "als364", "createdAt": "2020-06-08T21:18:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3NzAyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4MzI0OA==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433883248", "bodyText": "I don't think this call will work to update any user that isn't the currently-authenticated user. See the first line of updateProfile: DbUser user = userProvider.get();.\nI think you'll need to extract a new method, updateProfileForUser(DbUser user), in order to make the correct call here.", "author": "gjuggler", "createdAt": "2020-06-02T13:40:46Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -723,6 +699,19 @@ private boolean userHasEverLoggedIn(\n     return ResponseEntity.status(HttpStatus.NO_CONTENT).build();\n   }\n \n+  @AuthorityRequired(Authority.ACCESS_CONTROL_ADMIN)\n+  @Override\n+  public ResponseEntity<EmptyResponse> updateVerifiedInstitutionalAffiliation(\n+      Long userId, VerifiedInstitutionalAffiliation verifiedInstitution) {\n+    DbUser dbUser = userDao.findUserByUserId(userId);\n+    Profile profile = profileService.getProfile(dbUser);\n+\n+    profile.setVerifiedInstitutionalAffiliation(verifiedInstitution);\n+    this.updateProfile(profile);", "originalCommit": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4ODUyOQ==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433888529", "bodyText": "AFAICT, calling setVerifiedInstitutionalAffiliation on the updatedProfile object has no effect, since this object is not persisted or returned in the HTTP response. Is it necessary?", "author": "gjuggler", "createdAt": "2020-06-02T13:48:02Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -714,6 +686,10 @@ private boolean userHasEverLoggedIn(\n     user.setLastModifiedTime(now);\n \n     updateInstitutionalAffiliations(updatedProfile, user);\n+    if (workbenchConfigProvider.get().featureFlags.requireInstitutionalVerification) {\n+      updatedProfile.setVerifiedInstitutionalAffiliation(", "originalCommit": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2Mzc2OQ==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r434063769", "bodyText": "yep, i totally read this wrong before. argh", "author": "als364", "createdAt": "2020-06-02T17:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4ODUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NDM4NQ==", "url": "https://github.com/all-of-us/workbench/pull/3627#discussion_r433894385", "bodyText": "I'm usually accepting of a fair amount of repetition in test code, but I think these 4 lines to create a mock Broad institution are used in every single test case. That's my threshold of \"bump it into the setup and kill a few dozen lines\" in unit tests.", "author": "gjuggler", "createdAt": "2020-06-02T13:55:39Z", "path": "api/src/test/java/org/pmiops/workbench/profile/ProfileServiceTest.java", "diffHunk": "@@ -77,4 +92,203 @@ public void testReturnsLastAcknowledgedTermsOfService() {\n     assertThat(profile.getLatestTermsOfServiceVersion()).isEqualTo(1);\n     assertThat(profile.getLatestTermsOfServiceTime()).isEqualTo(1);\n   }\n+\n+  @Test\n+  public void validateInstitutionalAffiliation() {\n+    VerifiedInstitutionalAffiliation affiliation =\n+        new VerifiedInstitutionalAffiliation()\n+            .institutionShortName(\"Broad\")\n+            .institutionDisplayName(\"The Broad Institute\")\n+            .institutionalRoleEnum(InstitutionalRole.OTHER)\n+            .institutionalRoleOtherText(\"Kibitzing\");\n+\n+    Profile profile =\n+        new Profile()\n+            .verifiedInstitutionalAffiliation(affiliation)\n+            .contactEmail(\"kibitz@broadinstitute.org\");\n+\n+    DbInstitution dbInstitution = new DbInstitution();", "originalCommit": "7323752f03bcd0bdaf76aed9812dfd1bdb6df7d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6bf982420df11f3404c5e830d8204c582e17da84", "url": "https://github.com/all-of-us/workbench/commit/6bf982420df11f3404c5e830d8204c582e17da84", "message": "test", "committedDate": "2020-06-02T20:43:51Z", "type": "commit"}, {"oid": "d1d6298a917a524da3c2d4ecc90be027b09f6961", "url": "https://github.com/all-of-us/workbench/commit/d1d6298a917a524da3c2d4ecc90be027b09f6961", "message": "review feedback", "committedDate": "2020-06-08T21:16:40Z", "type": "commit"}, {"oid": "3d8ba06e1ed6e4a83f1ca4f42c557eb1a649186c", "url": "https://github.com/all-of-us/workbench/commit/3d8ba06e1ed6e4a83f1ca4f42c557eb1a649186c", "message": "spotless", "committedDate": "2020-06-08T21:24:12Z", "type": "commit"}, {"oid": "8eb48a672b1611c477f5840dc2b51d56a8be0f5a", "url": "https://github.com/all-of-us/workbench/commit/8eb48a672b1611c477f5840dc2b51d56a8be0f5a", "message": "update API description", "committedDate": "2020-06-09T17:42:33Z", "type": "commit"}, {"oid": "fa149092836362a42004ea870f0734976482c43f", "url": "https://github.com/all-of-us/workbench/commit/fa149092836362a42004ea870f0734976482c43f", "message": "null check", "committedDate": "2020-06-09T18:10:30Z", "type": "commit"}]}