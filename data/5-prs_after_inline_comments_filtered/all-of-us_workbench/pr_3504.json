{"pr_number": 3504, "pr_title": "[risk=no][RW-4801]New PopulateOpsUserAffiliations tool", "pr_createdAt": "2020-04-29T18:34:13Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3504", "timeline": [{"oid": "9d5a2cfed51d9f39ab474b47942d515195b31079", "url": "https://github.com/all-of-us/workbench/commit/9d5a2cfed51d9f39ab474b47942d515195b31079", "message": "PopulateOpsUserAffiliations", "committedDate": "2020-04-29T18:22:41Z", "type": "commit"}, {"oid": "12e16f4aab7aa1ed3761feb89e739a7701f623ae", "url": "https://github.com/all-of-us/workbench/commit/12e16f4aab7aa1ed3761feb89e739a7701f623ae", "message": "move ops inside run()", "committedDate": "2020-04-29T18:39:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2NTQyMw==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r418065423", "bodyText": "I could move this to a separate file.  Hierarchy suggestions?", "author": "jmthibault79", "createdAt": "2020-04-30T14:45:34Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/PopulateOpsUserAffiliations.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package org.pmiops.workbench.tools;\n+\n+import com.opencsv.CSVReader;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.UserDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliationDao;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.pmiops.workbench.model.InstitutionalRole;\n+import org.springframework.boot.CommandLineRunner;\n+import org.springframework.context.annotation.Bean;\n+\n+/**\n+ * Populate the verified_institutional_affiliation table for Ops users from a CSV input file.\n+ *\n+ * <p>NOTE: input file must be located in the current directory or a subdirectory.\n+ *\n+ * <p>Example execution:\n+ *\n+ * <pre>\n+ * ./project.rb populate-ops-user-affiliations \\\n+ * --import-filename users.csv \\\n+ * --dry-run \\\n+ * --project all-of-us-workbench-test\n+ * </pre>\n+ */\n+public class PopulateOpsUserAffiliations {\n+\n+  private static final Logger log = Logger.getLogger(PopulateOpsUserAffiliations.class.getName());\n+\n+  private List<DbVerifiedInstitutionalAffiliation> prepareAffiliations(\n+      final String filename,\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao)\n+      throws IOException {\n+\n+    final DbInstitution aouOps =\n+        institutionDao\n+            .findOneByShortName(\"AouOps\")\n+            .orElseThrow(\n+                () -> new RuntimeException(\"Could not find 'AouOps' Institution in the DB\"));\n+\n+    return OpsUser.parseInput(filename).stream()\n+        .map(\n+            opsUser -> {\n+              if (!opsUser.action.equals(\"To Remain\")) {\n+                throw new RuntimeException(\n+                    String.format(\n+                        \"User %s not marked as 'To Remain' in the input CSV\", opsUser.userName));\n+              }\n+\n+              final DbUser dbUser = opsUser.dbCheck(userDao, affiliationDao);\n+\n+              return new DbVerifiedInstitutionalAffiliation()\n+                  .setInstitution(aouOps)\n+                  .setUser(dbUser)\n+                  .setInstitutionalRoleEnum(InstitutionalRole.OTHER)\n+                  .setInstitutionalRoleOtherText(opsUser.operationalRole);\n+            })\n+        .collect(Collectors.toList());\n+  }\n+\n+  @Bean\n+  public CommandLineRunner run(\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao) {\n+\n+    final Option importFilename =\n+        Option.builder()\n+            .longOpt(\"import-filename\")\n+            .desc(\"File containing CSV of ops users\")\n+            .required()\n+            .hasArg()\n+            .build();\n+    final Option dryRunOpt =\n+        Option.builder()\n+            .longOpt(\"dry-run\")\n+            .desc(\"If specified, the tool runs in dry run mode; no modifications are made\")\n+            .build();\n+    final Options options = new Options().addOption(importFilename).addOption(dryRunOpt);\n+\n+    return (args) -> {\n+      CommandLine opts = new DefaultParser().parse(options, args);\n+      boolean dryRun = opts.hasOption(dryRunOpt.getLongOpt());\n+\n+      // process whole file before taking any action\n+      final List<DbVerifiedInstitutionalAffiliation> affiliations =\n+          prepareAffiliations(\n+              opts.getOptionValue(importFilename.getLongOpt()),\n+              userDao,\n+              institutionDao,\n+              affiliationDao);\n+\n+      affiliations.forEach(\n+          affiliation -> {\n+            if (!dryRun) {\n+              affiliationDao.save(affiliation);\n+            }\n+\n+            dryLog(\n+                dryRun,\n+                String.format(\n+                    \"Saved AouOps Institutional Affiliation for %s\",\n+                    affiliation.getUser().getUsername()));\n+          });\n+    };\n+  }\n+\n+  private static void dryLog(boolean dryRun, String msg) {\n+    String prefix = \"\";\n+    if (dryRun) {\n+      prefix = \"[DRY RUN] Would have... \";\n+    }\n+    log.info(prefix + msg);\n+  }\n+\n+  public static void main(String[] args) {\n+    CommandLineToolConfig.runCommandLine(PopulateOpsUserAffiliations.class, args);\n+  }\n+}\n+\n+/**\n+ * Structure the incoming ops user data according to the format of the source CSV:\n+ *\n+ * <p>First Name,Last Name,Email,\"Workbench Email\",Institution,Role,Action\n+ */\n+class OpsUser {", "originalCommit": "12e16f4aab7aa1ed3761feb89e739a7701f623ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2NjQ1Mw==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r418066453", "bodyText": "Only a warning because these are usually benign like \"Steve\" / \"Steven\"", "author": "jmthibault79", "createdAt": "2020-04-30T14:46:49Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/PopulateOpsUserAffiliations.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package org.pmiops.workbench.tools;\n+\n+import com.opencsv.CSVReader;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.UserDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliationDao;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.pmiops.workbench.model.InstitutionalRole;\n+import org.springframework.boot.CommandLineRunner;\n+import org.springframework.context.annotation.Bean;\n+\n+/**\n+ * Populate the verified_institutional_affiliation table for Ops users from a CSV input file.\n+ *\n+ * <p>NOTE: input file must be located in the current directory or a subdirectory.\n+ *\n+ * <p>Example execution:\n+ *\n+ * <pre>\n+ * ./project.rb populate-ops-user-affiliations \\\n+ * --import-filename users.csv \\\n+ * --dry-run \\\n+ * --project all-of-us-workbench-test\n+ * </pre>\n+ */\n+public class PopulateOpsUserAffiliations {\n+\n+  private static final Logger log = Logger.getLogger(PopulateOpsUserAffiliations.class.getName());\n+\n+  private List<DbVerifiedInstitutionalAffiliation> prepareAffiliations(\n+      final String filename,\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao)\n+      throws IOException {\n+\n+    final DbInstitution aouOps =\n+        institutionDao\n+            .findOneByShortName(\"AouOps\")\n+            .orElseThrow(\n+                () -> new RuntimeException(\"Could not find 'AouOps' Institution in the DB\"));\n+\n+    return OpsUser.parseInput(filename).stream()\n+        .map(\n+            opsUser -> {\n+              if (!opsUser.action.equals(\"To Remain\")) {\n+                throw new RuntimeException(\n+                    String.format(\n+                        \"User %s not marked as 'To Remain' in the input CSV\", opsUser.userName));\n+              }\n+\n+              final DbUser dbUser = opsUser.dbCheck(userDao, affiliationDao);\n+\n+              return new DbVerifiedInstitutionalAffiliation()\n+                  .setInstitution(aouOps)\n+                  .setUser(dbUser)\n+                  .setInstitutionalRoleEnum(InstitutionalRole.OTHER)\n+                  .setInstitutionalRoleOtherText(opsUser.operationalRole);\n+            })\n+        .collect(Collectors.toList());\n+  }\n+\n+  @Bean\n+  public CommandLineRunner run(\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao) {\n+\n+    final Option importFilename =\n+        Option.builder()\n+            .longOpt(\"import-filename\")\n+            .desc(\"File containing CSV of ops users\")\n+            .required()\n+            .hasArg()\n+            .build();\n+    final Option dryRunOpt =\n+        Option.builder()\n+            .longOpt(\"dry-run\")\n+            .desc(\"If specified, the tool runs in dry run mode; no modifications are made\")\n+            .build();\n+    final Options options = new Options().addOption(importFilename).addOption(dryRunOpt);\n+\n+    return (args) -> {\n+      CommandLine opts = new DefaultParser().parse(options, args);\n+      boolean dryRun = opts.hasOption(dryRunOpt.getLongOpt());\n+\n+      // process whole file before taking any action\n+      final List<DbVerifiedInstitutionalAffiliation> affiliations =\n+          prepareAffiliations(\n+              opts.getOptionValue(importFilename.getLongOpt()),\n+              userDao,\n+              institutionDao,\n+              affiliationDao);\n+\n+      affiliations.forEach(\n+          affiliation -> {\n+            if (!dryRun) {\n+              affiliationDao.save(affiliation);\n+            }\n+\n+            dryLog(\n+                dryRun,\n+                String.format(\n+                    \"Saved AouOps Institutional Affiliation for %s\",\n+                    affiliation.getUser().getUsername()));\n+          });\n+    };\n+  }\n+\n+  private static void dryLog(boolean dryRun, String msg) {\n+    String prefix = \"\";\n+    if (dryRun) {\n+      prefix = \"[DRY RUN] Would have... \";\n+    }\n+    log.info(prefix + msg);\n+  }\n+\n+  public static void main(String[] args) {\n+    CommandLineToolConfig.runCommandLine(PopulateOpsUserAffiliations.class, args);\n+  }\n+}\n+\n+/**\n+ * Structure the incoming ops user data according to the format of the source CSV:\n+ *\n+ * <p>First Name,Last Name,Email,\"Workbench Email\",Institution,Role,Action\n+ */\n+class OpsUser {\n+  final String firstName;\n+  final String lastName;\n+  final String contactEmail; // \"Email\" to DRC admin staff\n+  final String userName; // \"Workbench Email\" to DRC admin staff\n+  final String operationalRole;\n+  final String action;\n+\n+  static final int COLUMNS = 6;\n+\n+  private static final Logger log = Logger.getLogger(OpsUser.class.getName());\n+\n+  private OpsUser(final String[] userLine) {\n+    this.firstName = userLine[0].trim();\n+    this.lastName = userLine[1].trim();\n+    this.contactEmail = userLine[2].trim();\n+    this.userName = userLine[3].trim();\n+    this.operationalRole = userLine[4].trim();\n+    this.action = userLine[5].trim();\n+  }\n+\n+  static List<OpsUser> parseInput(final String filename) throws IOException {\n+    try (final CSVReader reader = new CSVReader(new FileReader(filename))) {\n+      // consume and sanity-check header line\n+      final String[] headerLine = reader.readNext();\n+      if (headerLine.length != COLUMNS) {\n+        throw new RuntimeException(\n+            String.format(\n+                \"Expected %d columns in input file. Was: %d\", COLUMNS, headerLine.length));\n+      }\n+\n+      return StreamSupport.stream(reader.spliterator(), false)\n+          .map(OpsUser::new)\n+          .collect(Collectors.toList());\n+    }\n+  }\n+\n+  private void checkField(String dbValue, String csvValue, String fieldName) {\n+    if (!dbValue.equals(csvValue)) {\n+      log.warning(", "originalCommit": "12e16f4aab7aa1ed3761feb89e739a7701f623ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExNzIwNA==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r418117204", "bodyText": "Please put some sample input in the description of the PR. I'm still not clear on exactly what's happening.", "author": "jaycarlton", "createdAt": "2020-04-30T15:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2NjQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExNzk5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r418117991", "bodyText": "OK. I think it might be safer to get the user's database ID into your CSV file so you don't have to guess. You can run reports and diff in Excel before doing the migration.", "author": "jaycarlton", "createdAt": "2020-04-30T15:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2NjQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQwNzUxOA==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r420407518", "bodyText": "The source of this CSV is DRC staff.  They don't have access to the DB.", "author": "jmthibault79", "createdAt": "2020-05-05T21:08:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2NjQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2NzQ4Mw==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r418067483", "bodyText": "It's not a big file, and this is safer", "author": "jmthibault79", "createdAt": "2020-04-30T14:48:14Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/PopulateOpsUserAffiliations.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package org.pmiops.workbench.tools;\n+\n+import com.opencsv.CSVReader;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.UserDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliationDao;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.pmiops.workbench.model.InstitutionalRole;\n+import org.springframework.boot.CommandLineRunner;\n+import org.springframework.context.annotation.Bean;\n+\n+/**\n+ * Populate the verified_institutional_affiliation table for Ops users from a CSV input file.\n+ *\n+ * <p>NOTE: input file must be located in the current directory or a subdirectory.\n+ *\n+ * <p>Example execution:\n+ *\n+ * <pre>\n+ * ./project.rb populate-ops-user-affiliations \\\n+ * --import-filename users.csv \\\n+ * --dry-run \\\n+ * --project all-of-us-workbench-test\n+ * </pre>\n+ */\n+public class PopulateOpsUserAffiliations {\n+\n+  private static final Logger log = Logger.getLogger(PopulateOpsUserAffiliations.class.getName());\n+\n+  private List<DbVerifiedInstitutionalAffiliation> prepareAffiliations(\n+      final String filename,\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao)\n+      throws IOException {\n+\n+    final DbInstitution aouOps =\n+        institutionDao\n+            .findOneByShortName(\"AouOps\")\n+            .orElseThrow(\n+                () -> new RuntimeException(\"Could not find 'AouOps' Institution in the DB\"));\n+\n+    return OpsUser.parseInput(filename).stream()\n+        .map(\n+            opsUser -> {\n+              if (!opsUser.action.equals(\"To Remain\")) {\n+                throw new RuntimeException(\n+                    String.format(\n+                        \"User %s not marked as 'To Remain' in the input CSV\", opsUser.userName));\n+              }\n+\n+              final DbUser dbUser = opsUser.dbCheck(userDao, affiliationDao);\n+\n+              return new DbVerifiedInstitutionalAffiliation()\n+                  .setInstitution(aouOps)\n+                  .setUser(dbUser)\n+                  .setInstitutionalRoleEnum(InstitutionalRole.OTHER)\n+                  .setInstitutionalRoleOtherText(opsUser.operationalRole);\n+            })\n+        .collect(Collectors.toList());\n+  }\n+\n+  @Bean\n+  public CommandLineRunner run(\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao) {\n+\n+    final Option importFilename =\n+        Option.builder()\n+            .longOpt(\"import-filename\")\n+            .desc(\"File containing CSV of ops users\")\n+            .required()\n+            .hasArg()\n+            .build();\n+    final Option dryRunOpt =\n+        Option.builder()\n+            .longOpt(\"dry-run\")\n+            .desc(\"If specified, the tool runs in dry run mode; no modifications are made\")\n+            .build();\n+    final Options options = new Options().addOption(importFilename).addOption(dryRunOpt);\n+\n+    return (args) -> {\n+      CommandLine opts = new DefaultParser().parse(options, args);\n+      boolean dryRun = opts.hasOption(dryRunOpt.getLongOpt());\n+\n+      // process whole file before taking any action", "originalCommit": "12e16f4aab7aa1ed3761feb89e739a7701f623ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExMTYwNw==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r418111607", "bodyText": "This java file shouldn't know anything about a ruby program that happens to call it.", "author": "jaycarlton", "createdAt": "2020-04-30T15:50:15Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/PopulateOpsUserAffiliations.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package org.pmiops.workbench.tools;\n+\n+import com.opencsv.CSVReader;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.UserDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliationDao;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.pmiops.workbench.model.InstitutionalRole;\n+import org.springframework.boot.CommandLineRunner;\n+import org.springframework.context.annotation.Bean;\n+\n+/**\n+ * Populate the verified_institutional_affiliation table for Ops users from a CSV input file.\n+ *\n+ * <p>NOTE: input file must be located in the current directory or a subdirectory.\n+ *\n+ * <p>Example execution:\n+ *\n+ * <pre>\n+ * ./project.rb populate-ops-user-affiliations \\", "originalCommit": "12e16f4aab7aa1ed3761feb89e739a7701f623ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQwOTk2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r420409965", "bodyText": "Our ops stack requires us to use Ruby to run Java tools, and errors are often missing or incorrect, so I spend far too much time hunting down correct command lines.  This will be a major help, if only to myself!", "author": "jmthibault79", "createdAt": "2020-05-05T21:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExMTYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExNDY4MQ==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r418114681", "bodyText": "please make this a constant (preferably attached to an enum).", "author": "jaycarlton", "createdAt": "2020-04-30T15:54:35Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/PopulateOpsUserAffiliations.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package org.pmiops.workbench.tools;\n+\n+import com.opencsv.CSVReader;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.UserDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliationDao;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.pmiops.workbench.model.InstitutionalRole;\n+import org.springframework.boot.CommandLineRunner;\n+import org.springframework.context.annotation.Bean;\n+\n+/**\n+ * Populate the verified_institutional_affiliation table for Ops users from a CSV input file.\n+ *\n+ * <p>NOTE: input file must be located in the current directory or a subdirectory.\n+ *\n+ * <p>Example execution:\n+ *\n+ * <pre>\n+ * ./project.rb populate-ops-user-affiliations \\\n+ * --import-filename users.csv \\\n+ * --dry-run \\\n+ * --project all-of-us-workbench-test\n+ * </pre>\n+ */\n+public class PopulateOpsUserAffiliations {\n+\n+  private static final Logger log = Logger.getLogger(PopulateOpsUserAffiliations.class.getName());\n+\n+  private List<DbVerifiedInstitutionalAffiliation> prepareAffiliations(\n+      final String filename,\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao)\n+      throws IOException {\n+\n+    final DbInstitution aouOps =\n+        institutionDao\n+            .findOneByShortName(\"AouOps\")", "originalCommit": "12e16f4aab7aa1ed3761feb89e739a7701f623ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxOTkxOQ==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r420419919", "bodyText": "OK.  Enum doesn't fit here because this is our special snowflake not-really-institution that is making us both think we need to resign the concept of institutions.  Whee!", "author": "jmthibault79", "createdAt": "2020-05-05T21:33:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExNDY4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExNjExMA==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r418116110", "bodyText": "Please list all the fields that would change.", "author": "jaycarlton", "createdAt": "2020-04-30T15:56:39Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/PopulateOpsUserAffiliations.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package org.pmiops.workbench.tools;\n+\n+import com.opencsv.CSVReader;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.UserDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliationDao;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.pmiops.workbench.model.InstitutionalRole;\n+import org.springframework.boot.CommandLineRunner;\n+import org.springframework.context.annotation.Bean;\n+\n+/**\n+ * Populate the verified_institutional_affiliation table for Ops users from a CSV input file.\n+ *\n+ * <p>NOTE: input file must be located in the current directory or a subdirectory.\n+ *\n+ * <p>Example execution:\n+ *\n+ * <pre>\n+ * ./project.rb populate-ops-user-affiliations \\\n+ * --import-filename users.csv \\\n+ * --dry-run \\\n+ * --project all-of-us-workbench-test\n+ * </pre>\n+ */\n+public class PopulateOpsUserAffiliations {\n+\n+  private static final Logger log = Logger.getLogger(PopulateOpsUserAffiliations.class.getName());\n+\n+  private List<DbVerifiedInstitutionalAffiliation> prepareAffiliations(\n+      final String filename,\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao)\n+      throws IOException {\n+\n+    final DbInstitution aouOps =\n+        institutionDao\n+            .findOneByShortName(\"AouOps\")\n+            .orElseThrow(\n+                () -> new RuntimeException(\"Could not find 'AouOps' Institution in the DB\"));\n+\n+    return OpsUser.parseInput(filename).stream()\n+        .map(\n+            opsUser -> {\n+              if (!opsUser.action.equals(\"To Remain\")) {\n+                throw new RuntimeException(\n+                    String.format(\n+                        \"User %s not marked as 'To Remain' in the input CSV\", opsUser.userName));\n+              }\n+\n+              final DbUser dbUser = opsUser.dbCheck(userDao, affiliationDao);\n+\n+              return new DbVerifiedInstitutionalAffiliation()\n+                  .setInstitution(aouOps)\n+                  .setUser(dbUser)\n+                  .setInstitutionalRoleEnum(InstitutionalRole.OTHER)\n+                  .setInstitutionalRoleOtherText(opsUser.operationalRole);\n+            })\n+        .collect(Collectors.toList());\n+  }\n+\n+  @Bean\n+  public CommandLineRunner run(\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao) {\n+\n+    final Option importFilename =\n+        Option.builder()\n+            .longOpt(\"import-filename\")\n+            .desc(\"File containing CSV of ops users\")\n+            .required()\n+            .hasArg()\n+            .build();\n+    final Option dryRunOpt =\n+        Option.builder()\n+            .longOpt(\"dry-run\")\n+            .desc(\"If specified, the tool runs in dry run mode; no modifications are made\")\n+            .build();\n+    final Options options = new Options().addOption(importFilename).addOption(dryRunOpt);\n+\n+    return (args) -> {\n+      CommandLine opts = new DefaultParser().parse(options, args);\n+      boolean dryRun = opts.hasOption(dryRunOpt.getLongOpt());\n+\n+      // process whole file before taking any action\n+      final List<DbVerifiedInstitutionalAffiliation> affiliations =\n+          prepareAffiliations(\n+              opts.getOptionValue(importFilename.getLongOpt()),\n+              userDao,\n+              institutionDao,\n+              affiliationDao);\n+\n+      affiliations.forEach(\n+          affiliation -> {\n+            if (!dryRun) {\n+              affiliationDao.save(affiliation);\n+            }\n+\n+            dryLog(\n+                dryRun,\n+                String.format(\n+                    \"Saved AouOps Institutional Affiliation for %s\",", "originalCommit": "12e16f4aab7aa1ed3761feb89e739a7701f623ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExNjU4OQ==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r418116589", "bodyText": "FYI There are batch stream operators so you don't have to make one SQL call per row. https://stackoverflow.com/a/31642381/12345554", "author": "jaycarlton", "createdAt": "2020-04-30T15:57:21Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/PopulateOpsUserAffiliations.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package org.pmiops.workbench.tools;\n+\n+import com.opencsv.CSVReader;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.UserDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliationDao;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.pmiops.workbench.model.InstitutionalRole;\n+import org.springframework.boot.CommandLineRunner;\n+import org.springframework.context.annotation.Bean;\n+\n+/**\n+ * Populate the verified_institutional_affiliation table for Ops users from a CSV input file.\n+ *\n+ * <p>NOTE: input file must be located in the current directory or a subdirectory.\n+ *\n+ * <p>Example execution:\n+ *\n+ * <pre>\n+ * ./project.rb populate-ops-user-affiliations \\\n+ * --import-filename users.csv \\\n+ * --dry-run \\\n+ * --project all-of-us-workbench-test\n+ * </pre>\n+ */\n+public class PopulateOpsUserAffiliations {\n+\n+  private static final Logger log = Logger.getLogger(PopulateOpsUserAffiliations.class.getName());\n+\n+  private List<DbVerifiedInstitutionalAffiliation> prepareAffiliations(\n+      final String filename,\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao)\n+      throws IOException {\n+\n+    final DbInstitution aouOps =\n+        institutionDao\n+            .findOneByShortName(\"AouOps\")\n+            .orElseThrow(\n+                () -> new RuntimeException(\"Could not find 'AouOps' Institution in the DB\"));\n+\n+    return OpsUser.parseInput(filename).stream()\n+        .map(\n+            opsUser -> {\n+              if (!opsUser.action.equals(\"To Remain\")) {\n+                throw new RuntimeException(\n+                    String.format(\n+                        \"User %s not marked as 'To Remain' in the input CSV\", opsUser.userName));\n+              }\n+\n+              final DbUser dbUser = opsUser.dbCheck(userDao, affiliationDao);\n+\n+              return new DbVerifiedInstitutionalAffiliation()\n+                  .setInstitution(aouOps)\n+                  .setUser(dbUser)\n+                  .setInstitutionalRoleEnum(InstitutionalRole.OTHER)\n+                  .setInstitutionalRoleOtherText(opsUser.operationalRole);\n+            })\n+        .collect(Collectors.toList());\n+  }\n+\n+  @Bean\n+  public CommandLineRunner run(\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao) {\n+\n+    final Option importFilename =\n+        Option.builder()\n+            .longOpt(\"import-filename\")\n+            .desc(\"File containing CSV of ops users\")\n+            .required()\n+            .hasArg()\n+            .build();\n+    final Option dryRunOpt =\n+        Option.builder()\n+            .longOpt(\"dry-run\")\n+            .desc(\"If specified, the tool runs in dry run mode; no modifications are made\")\n+            .build();\n+    final Options options = new Options().addOption(importFilename).addOption(dryRunOpt);\n+\n+    return (args) -> {\n+      CommandLine opts = new DefaultParser().parse(options, args);\n+      boolean dryRun = opts.hasOption(dryRunOpt.getLongOpt());\n+\n+      // process whole file before taking any action\n+      final List<DbVerifiedInstitutionalAffiliation> affiliations =\n+          prepareAffiliations(\n+              opts.getOptionValue(importFilename.getLongOpt()),\n+              userDao,\n+              institutionDao,\n+              affiliationDao);\n+\n+      affiliations.forEach(", "originalCommit": "12e16f4aab7aa1ed3761feb89e739a7701f623ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyNjk0Nw==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r420426947", "bodyText": "I don't see how that link is relevant to this situation ?", "author": "jmthibault79", "createdAt": "2020-05-05T21:48:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExNjU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExODg4OQ==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r418118889", "bodyText": "I recommend you don't throw for one invalid input item in a batch job. Log an error and/or write a structured results file to another CSV file (or for complex migrations, to a temporary migration job staging table).", "author": "jaycarlton", "createdAt": "2020-04-30T16:00:51Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/PopulateOpsUserAffiliations.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package org.pmiops.workbench.tools;\n+\n+import com.opencsv.CSVReader;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.UserDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliationDao;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.pmiops.workbench.model.InstitutionalRole;\n+import org.springframework.boot.CommandLineRunner;\n+import org.springframework.context.annotation.Bean;\n+\n+/**\n+ * Populate the verified_institutional_affiliation table for Ops users from a CSV input file.\n+ *\n+ * <p>NOTE: input file must be located in the current directory or a subdirectory.\n+ *\n+ * <p>Example execution:\n+ *\n+ * <pre>\n+ * ./project.rb populate-ops-user-affiliations \\\n+ * --import-filename users.csv \\\n+ * --dry-run \\\n+ * --project all-of-us-workbench-test\n+ * </pre>\n+ */\n+public class PopulateOpsUserAffiliations {\n+\n+  private static final Logger log = Logger.getLogger(PopulateOpsUserAffiliations.class.getName());\n+\n+  private List<DbVerifiedInstitutionalAffiliation> prepareAffiliations(\n+      final String filename,\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao)\n+      throws IOException {\n+\n+    final DbInstitution aouOps =\n+        institutionDao\n+            .findOneByShortName(\"AouOps\")\n+            .orElseThrow(\n+                () -> new RuntimeException(\"Could not find 'AouOps' Institution in the DB\"));\n+\n+    return OpsUser.parseInput(filename).stream()\n+        .map(\n+            opsUser -> {\n+              if (!opsUser.action.equals(\"To Remain\")) {\n+                throw new RuntimeException(\n+                    String.format(\n+                        \"User %s not marked as 'To Remain' in the input CSV\", opsUser.userName));\n+              }\n+\n+              final DbUser dbUser = opsUser.dbCheck(userDao, affiliationDao);\n+\n+              return new DbVerifiedInstitutionalAffiliation()\n+                  .setInstitution(aouOps)\n+                  .setUser(dbUser)\n+                  .setInstitutionalRoleEnum(InstitutionalRole.OTHER)\n+                  .setInstitutionalRoleOtherText(opsUser.operationalRole);\n+            })\n+        .collect(Collectors.toList());\n+  }\n+\n+  @Bean\n+  public CommandLineRunner run(\n+      UserDao userDao,\n+      InstitutionDao institutionDao,\n+      VerifiedInstitutionalAffiliationDao affiliationDao) {\n+\n+    final Option importFilename =\n+        Option.builder()\n+            .longOpt(\"import-filename\")\n+            .desc(\"File containing CSV of ops users\")\n+            .required()\n+            .hasArg()\n+            .build();\n+    final Option dryRunOpt =\n+        Option.builder()\n+            .longOpt(\"dry-run\")\n+            .desc(\"If specified, the tool runs in dry run mode; no modifications are made\")\n+            .build();\n+    final Options options = new Options().addOption(importFilename).addOption(dryRunOpt);\n+\n+    return (args) -> {\n+      CommandLine opts = new DefaultParser().parse(options, args);\n+      boolean dryRun = opts.hasOption(dryRunOpt.getLongOpt());\n+\n+      // process whole file before taking any action\n+      final List<DbVerifiedInstitutionalAffiliation> affiliations =\n+          prepareAffiliations(\n+              opts.getOptionValue(importFilename.getLongOpt()),\n+              userDao,\n+              institutionDao,\n+              affiliationDao);\n+\n+      affiliations.forEach(\n+          affiliation -> {\n+            if (!dryRun) {\n+              affiliationDao.save(affiliation);\n+            }\n+\n+            dryLog(\n+                dryRun,\n+                String.format(\n+                    \"Saved AouOps Institutional Affiliation for %s\",\n+                    affiliation.getUser().getUsername()));\n+          });\n+    };\n+  }\n+\n+  private static void dryLog(boolean dryRun, String msg) {\n+    String prefix = \"\";\n+    if (dryRun) {\n+      prefix = \"[DRY RUN] Would have... \";\n+    }\n+    log.info(prefix + msg);\n+  }\n+\n+  public static void main(String[] args) {\n+    CommandLineToolConfig.runCommandLine(PopulateOpsUserAffiliations.class, args);\n+  }\n+}\n+\n+/**\n+ * Structure the incoming ops user data according to the format of the source CSV:\n+ *\n+ * <p>First Name,Last Name,Email,\"Workbench Email\",Institution,Role,Action\n+ */\n+class OpsUser {\n+  final String firstName;\n+  final String lastName;\n+  final String contactEmail; // \"Email\" to DRC admin staff\n+  final String userName; // \"Workbench Email\" to DRC admin staff\n+  final String operationalRole;\n+  final String action;\n+\n+  static final int COLUMNS = 6;\n+\n+  private static final Logger log = Logger.getLogger(OpsUser.class.getName());\n+\n+  private OpsUser(final String[] userLine) {\n+    this.firstName = userLine[0].trim();\n+    this.lastName = userLine[1].trim();\n+    this.contactEmail = userLine[2].trim();\n+    this.userName = userLine[3].trim();\n+    this.operationalRole = userLine[4].trim();\n+    this.action = userLine[5].trim();\n+  }\n+\n+  static List<OpsUser> parseInput(final String filename) throws IOException {\n+    try (final CSVReader reader = new CSVReader(new FileReader(filename))) {\n+      // consume and sanity-check header line\n+      final String[] headerLine = reader.readNext();\n+      if (headerLine.length != COLUMNS) {\n+        throw new RuntimeException(\n+            String.format(\n+                \"Expected %d columns in input file. Was: %d\", COLUMNS, headerLine.length));\n+      }\n+\n+      return StreamSupport.stream(reader.spliterator(), false)\n+          .map(OpsUser::new)\n+          .collect(Collectors.toList());\n+    }\n+  }\n+\n+  private void checkField(String dbValue, String csvValue, String fieldName) {\n+    if (!dbValue.equals(csvValue)) {\n+      log.warning(\n+          String.format(\n+              \"CSV and DB values do not match for user '%s', field '%s'. CSV = %s, DB = %s\",\n+              userName, fieldName, csvValue, dbValue));\n+    }\n+  }\n+\n+  public DbUser dbCheck(UserDao userDao, VerifiedInstitutionalAffiliationDao affiliationDao) {\n+    final DbUser dbUser = userDao.findUserByUsername(userName);\n+\n+    if (dbUser == null) {\n+      throw new RuntimeException(String.format(\"User %s was not found in the DB\", userName));\n+    }\n+\n+    checkField(dbUser.getGivenName(), firstName, \"First Name\");\n+    checkField(dbUser.getFamilyName(), lastName, \"Last Name\");\n+    checkField(dbUser.getContactEmail(), contactEmail, \"Contact Email\");\n+\n+    affiliationDao\n+        .findFirstByUser(dbUser)\n+        .ifPresent(\n+            affiliation -> {\n+              throw new RuntimeException(", "originalCommit": "12e16f4aab7aa1ed3761feb89e739a7701f623ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyMjg2NA==", "url": "https://github.com/all-of-us/workbench/pull/3504#discussion_r420422864", "bodyText": "It would be very strange for this to be true.  I want us to fail hard in that case.  I can add a comment.", "author": "jmthibault79", "createdAt": "2020-05-05T21:39:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExODg4OQ=="}], "type": "inlineReview"}, {"oid": "7f1d7f0ef18d1c85ad136aa3d458dc43162891e7", "url": "https://github.com/all-of-us/workbench/commit/7f1d7f0ef18d1c85ad136aa3d458dc43162891e7", "message": "string constants", "committedDate": "2020-05-05T21:39:54Z", "type": "commit"}, {"oid": "8128ccca5d2362362b874a38899b306fdc6f2533", "url": "https://github.com/all-of-us/workbench/commit/8128ccca5d2362362b874a38899b306fdc6f2533", "message": "Clarify fatal errors vs warnings", "committedDate": "2020-05-05T21:41:49Z", "type": "commit"}, {"oid": "1bb930d4865f0cb68fd1d3bcdd950117d945eaaf", "url": "https://github.com/all-of-us/workbench/commit/1bb930d4865f0cb68fd1d3bcdd950117d945eaaf", "message": "lint", "committedDate": "2020-05-05T21:50:43Z", "type": "commit"}]}