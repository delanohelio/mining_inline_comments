{"pr_number": 4282, "pr_title": "Add sample for Cloud SQL for SQL Server", "pr_createdAt": "2020-11-19T18:33:00Z", "pr_url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4282", "timeline": [{"oid": "0d3d344054c5a5cab360bf8cae71dcc85419d509", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/0d3d344054c5a5cab360bf8cae71dcc85419d509", "message": "add sqlserver jdbc sample", "committedDate": "2020-07-21T18:19:29Z", "type": "commit"}, {"oid": "ec4da1d1caae7e67a4cefd88fc74051ed7688bf8", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ec4da1d1caae7e67a4cefd88fc74051ed7688bf8", "message": "update versions for driver and socket factory", "committedDate": "2020-10-22T22:00:04Z", "type": "commit"}, {"oid": "b602fff56bf83d0a7765a19f0f9065526a48f5f6", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/b602fff56bf83d0a7765a19f0f9065526a48f5f6", "message": "update version of JDBC socket factory", "committedDate": "2020-11-19T08:10:25Z", "type": "commit"}, {"oid": "a2dd753a1181f7822b2a58e0b4d7e214f3e8963f", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a2dd753a1181f7822b2a58e0b4d7e214f3e8963f", "message": "update readme", "committedDate": "2020-11-19T18:16:28Z", "type": "commit"}, {"oid": "1ecf3d152874f6c1f2d46cdcf9af9216f9075415", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/1ecf3d152874f6c1f2d46cdcf9af9216f9075415", "message": "update copyright headers", "committedDate": "2020-11-19T18:35:17Z", "type": "commit"}, {"oid": "d2abcf3263e6f4ef9151c3c4c0bf250e2f5e44de", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/d2abcf3263e6f4ef9151c3c4c0bf250e2f5e44de", "message": "update artifact ID", "committedDate": "2020-11-19T18:45:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk5NTUyMg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4282#discussion_r528995522", "bodyText": "feel free to take or leave this suggestion - I would refactor new Vote(... out as a variable.", "author": "kolea2", "createdAt": "2020-11-23T21:06:30Z", "path": "cloud-sql/sqlserver/servlet/src/main/java/com/example/cloudsql/IndexServlet.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.cloudsql;\n+\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Timestamp;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import javax.servlet.ServletException;\n+import javax.servlet.annotation.WebServlet;\n+import javax.servlet.http.HttpServlet;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.sql.DataSource;\n+\n+@WebServlet(name = \"Index\", value = \"\")\n+public class IndexServlet extends HttpServlet {\n+\n+  private static final Logger LOGGER = Logger.getLogger(IndexServlet.class.getName());\n+\n+  @Override\n+  public void doGet(HttpServletRequest req, HttpServletResponse resp)\n+      throws IOException, ServletException {\n+    // Extract the pool from the Servlet Context, reusing the one that was created\n+    // in the ContextListener when the application was started\n+    DataSource pool = (DataSource) req.getServletContext().getAttribute(\"my-pool\");\n+\n+    int tabCount;\n+    int spaceCount;\n+    List<Vote> recentVotes = new ArrayList<>();\n+    try (Connection conn = pool.getConnection()) {\n+      // PreparedStatements are compiled by the database immediately and executed at a later date.\n+      // Most databases cache previously compiled queries, which improves efficiency.\n+      PreparedStatement voteStmt =  conn.prepareStatement(\n+          \"SELECT TOP(5) candidate, time_cast FROM votes ORDER BY time_cast DESC\");\n+      // Execute the statement\n+      ResultSet voteResults = voteStmt.executeQuery();\n+      // Convert a ResultSet into Vote objects\n+      while (voteResults.next()) {\n+        String candidate = voteResults.getString(1);\n+        Timestamp timeCast = voteResults.getTimestamp(2);\n+        recentVotes.add(new Vote(candidate.trim(), timeCast));", "originalCommit": "d2abcf3263e6f4ef9151c3c4c0bf250e2f5e44de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk5NjA3Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4282#discussion_r528996073", "bodyText": "warning or error here?", "author": "kolea2", "createdAt": "2020-11-23T21:07:41Z", "path": "cloud-sql/sqlserver/servlet/src/main/java/com/example/cloudsql/IndexServlet.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.cloudsql;\n+\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Timestamp;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import javax.servlet.ServletException;\n+import javax.servlet.annotation.WebServlet;\n+import javax.servlet.http.HttpServlet;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.sql.DataSource;\n+\n+@WebServlet(name = \"Index\", value = \"\")\n+public class IndexServlet extends HttpServlet {\n+\n+  private static final Logger LOGGER = Logger.getLogger(IndexServlet.class.getName());\n+\n+  @Override\n+  public void doGet(HttpServletRequest req, HttpServletResponse resp)\n+      throws IOException, ServletException {\n+    // Extract the pool from the Servlet Context, reusing the one that was created\n+    // in the ContextListener when the application was started\n+    DataSource pool = (DataSource) req.getServletContext().getAttribute(\"my-pool\");\n+\n+    int tabCount;\n+    int spaceCount;\n+    List<Vote> recentVotes = new ArrayList<>();\n+    try (Connection conn = pool.getConnection()) {\n+      // PreparedStatements are compiled by the database immediately and executed at a later date.\n+      // Most databases cache previously compiled queries, which improves efficiency.\n+      PreparedStatement voteStmt =  conn.prepareStatement(\n+          \"SELECT TOP(5) candidate, time_cast FROM votes ORDER BY time_cast DESC\");\n+      // Execute the statement\n+      ResultSet voteResults = voteStmt.executeQuery();\n+      // Convert a ResultSet into Vote objects\n+      while (voteResults.next()) {\n+        String candidate = voteResults.getString(1);\n+        Timestamp timeCast = voteResults.getTimestamp(2);\n+        recentVotes.add(new Vote(candidate.trim(), timeCast));\n+      }\n+\n+      // PreparedStatements can also be executed multiple times with different arguments. This can\n+      // improve efficiency, and project a query from being vulnerable to an SQL injection.\n+      PreparedStatement voteCountStmt = conn.prepareStatement(\n+          \"SELECT COUNT(vote_id) FROM votes WHERE candidate=?\");\n+\n+      voteCountStmt.setString(1, \"TABS\");\n+      ResultSet tabResult = voteCountStmt.executeQuery();\n+      tabResult.next(); // Move to the first result\n+      tabCount = tabResult.getInt(1);\n+\n+      voteCountStmt.setString(1, \"SPACES\");\n+      ResultSet spaceResult = voteCountStmt.executeQuery();\n+      spaceResult.next(); // Move to the first result\n+      spaceCount = spaceResult.getInt(1);\n+\n+    } catch (SQLException ex) {\n+      // If something goes wrong, the application needs to react appropriately. This might mean\n+      // getting a new connection and executing the query again, or it might mean redirecting the\n+      // user to a different page to let them know something went wrong.\n+      throw new ServletException(\"Unable to successfully connect to the database. Please check the \"\n+          + \"steps in the README and try again.\", ex);\n+    }\n+\n+    // Add variables and render the page\n+    req.setAttribute(\"tabCount\", tabCount);\n+    req.setAttribute(\"spaceCount\", spaceCount);\n+    req.setAttribute(\"recentVotes\", recentVotes);\n+    req.getRequestDispatcher(\"/index.jsp\").forward(req, resp);\n+  }\n+\n+  @Override\n+  public void doPost(HttpServletRequest req, HttpServletResponse resp)\n+      throws IOException {\n+    // Get the team from the request and record the time of the vote.\n+    String team = req.getParameter(\"team\");\n+    if (team != null) {\n+      team = team.toUpperCase();\n+    }\n+    Timestamp now = new Timestamp(new Date().getTime());\n+    if (team == null || (!team.equals(\"TABS\") && !team.equals(\"SPACES\"))) {\n+      resp.setStatus(400);\n+      resp.getWriter().append(\"Invalid team specified.\");\n+      return;\n+    }\n+\n+    // Reuse the pool that was created in the ContextListener when the Servlet started.\n+    DataSource pool = (DataSource) req.getServletContext().getAttribute(\"my-pool\");\n+    // [START cloud_sql_postgres_servlet_connection]\n+    // Using a try-with-resources statement ensures that the connection is always released back\n+    // into the pool at the end of the statement (even if an error occurs)\n+    try (Connection conn = pool.getConnection()) {\n+\n+      // PreparedStatements can be more efficient and project against injections.\n+      PreparedStatement voteStmt = conn.prepareStatement(\n+          \"INSERT INTO votes (time_cast, candidate) VALUES (?, ?);\");\n+      voteStmt.setTimestamp(1, now);\n+      voteStmt.setString(2, team);\n+\n+      // Finally, execute the statement. If it fails, an error will be thrown.\n+      voteStmt.execute();\n+\n+    } catch (SQLException ex) {\n+      // If something goes wrong, handle the error in this section. This might involve retrying or\n+      // adjusting parameters depending on the situation.\n+      // [START_EXCLUDE]\n+      LOGGER.log(Level.WARNING, \"Error while attempting to submit vote.\", ex);", "originalCommit": "d2abcf3263e6f4ef9151c3c4c0bf250e2f5e44de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE2NDY4MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4282#discussion_r529164681", "bodyText": "Should be warning, that's what it is in the other samples. The next option above \"WARNING\" is \"SEVERE\" and idk if that's right here.", "author": "shubha-rajan", "createdAt": "2020-11-24T02:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk5NjA3Mw=="}], "type": "inlineReview"}, {"oid": "5f0607f97121b360fd08452792d92d9ecbdd7379", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/5f0607f97121b360fd08452792d92d9ecbdd7379", "message": "change project id to placeholder value", "committedDate": "2020-11-24T00:12:29Z", "type": "commit"}, {"oid": "6f87d8987fd7e2efafb8dcb19b5a7c1bd90ead20", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/6f87d8987fd7e2efafb8dcb19b5a7c1bd90ead20", "message": "fixes to IndexServlet.java", "committedDate": "2020-11-24T00:33:39Z", "type": "commit"}, {"oid": "832899c029e60a8084cf8cb3077910193e227335", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/832899c029e60a8084cf8cb3077910193e227335", "message": "add sample overview and cleanup instructions to README", "committedDate": "2020-11-24T00:37:18Z", "type": "commit"}, {"oid": "cd30ab611d8d063ebba91a7138c0148d7e563250", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/cd30ab611d8d063ebba91a7138c0148d7e563250", "message": "missing semicolon \ud83d\ude2c", "committedDate": "2020-11-24T00:44:22Z", "type": "commit"}, {"oid": "caf6ad187237781abb5d8a6ecd3100c4fcfb3142", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/caf6ad187237781abb5d8a6ecd3100c4fcfb3142", "message": "change logging level back to warning", "committedDate": "2020-11-24T01:17:59Z", "type": "commit"}, {"oid": "88df1f0a899313be5afbad35596c9f0ced85b253", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/88df1f0a899313be5afbad35596c9f0ced85b253", "message": "update app engine configuration", "committedDate": "2020-11-25T07:54:43Z", "type": "commit"}, {"oid": "699063e5a29eb3c2d735ce427dc1216b465742e3", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/699063e5a29eb3c2d735ce427dc1216b465742e3", "message": "add note about supported Java versions for GAE dev server", "committedDate": "2020-11-25T08:10:35Z", "type": "commit"}, {"oid": "0d05926942af405b4477e5f1b98699f52bcd3035", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/0d05926942af405b4477e5f1b98699f52bcd3035", "message": "Fix typos in README.md", "committedDate": "2020-12-01T22:52:02Z", "type": "commit"}]}