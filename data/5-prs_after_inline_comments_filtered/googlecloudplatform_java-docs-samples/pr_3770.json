{"pr_number": 3770, "pr_title": "Determine pubsub event timestamp correctly in retry-timeout.", "pr_createdAt": "2020-09-21T23:49:51Z", "pr_url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770", "timeline": [{"oid": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e", "message": "Determine pubsub event timestamp correctly in retry-timeout.\n\nIn the retry-timeout sample for GCF java11, we should determine\nthe event timestamp from the Context parameter, not from properties\nof the passed-in PubSub object.\n\nFixes #3734.", "committedDate": "2020-09-21T23:47:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNjA2Nw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492416067", "bodyText": "Shouldn't there be some kind of comment discussing these two and why they are different and when you want to use one and not the other?", "author": "lesv", "createdAt": "2020-09-22T00:21:02Z", "path": "functions/concepts/retry-timeout/src/main/java/functions/RetryTimeout.java", "diffHunk": "@@ -42,25 +41,19 @@\n   @Override\n   public void accept(PubSubMessage message, Context context) {\n     ZonedDateTime utcNow = ZonedDateTime.now(ZoneOffset.UTC);\n-    ZonedDateTime timestamp = utcNow;\n+    ZonedDateTime timestamp = ZonedDateTime.parse(context.timestamp());", "originalCommit": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNzU2Mg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492417562", "bodyText": "@lesv I suspect @eamonnmcmanus meant to delete the utcNow declaration?", "author": "ace-n", "createdAt": "2020-09-22T00:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxODYxNA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492418614", "bodyText": "Still, there are two sources of truth, and we got it wrong the first time, so that deserves an explanation, since other users are likely to make the same error unless they are told why.", "author": "lesv", "createdAt": "2020-09-22T00:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMDc1NA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492420754", "bodyText": "Ah - I misread, he's comparing utcNow to the parsed timestamp. (utcNow was previously the default timestamp value in case one wasn't included in the Pub/Sub message - but if we use the one in context that's guaranteed to be included, this default becomes unnecessary.)\nThis file LGTM. \u2705", "author": "ace-n", "createdAt": "2020-09-22T00:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgyMzM4NQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492823385", "bodyText": "I think the situation is pretty confusing here. I don't know under what circumstances, if any, the messageId and publishTime properties of the payload are set. I just deployed a pub/sub function and sent a message to it, and both these fields were null. We may have a much bigger cleanup to do to get this straight, though hopefully the migration to CloudEvents should make things more consistent.\nAnyway, let's get this fix in for now, and try to improve things further afterwards.", "author": "eamonnmcmanus", "createdAt": "2020-09-22T15:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg4MzMwOQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492883309", "bodyText": "k - I'd still rather you commented about it in the source, but it's up to you.", "author": "lesv", "createdAt": "2020-09-22T16:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNjA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNzY3Ng==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492417676", "bodyText": "@eamonnmcmanus did you mean to delete this?", "author": "ace-n", "createdAt": "2020-09-22T00:27:53Z", "path": "functions/concepts/retry-timeout/src/main/java/functions/RetryTimeout.java", "diffHunk": "@@ -42,25 +41,19 @@\n   @Override\n   public void accept(PubSubMessage message, Context context) {\n     ZonedDateTime utcNow = ZonedDateTime.now(ZoneOffset.UTC);", "originalCommit": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxOTU1Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492419553", "bodyText": "Edit: nvm, I see you used it below.", "author": "ace-n", "createdAt": "2020-09-22T00:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNzY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNzkxMg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492417912", "bodyText": "Should this test contain an assertion? (I don't think it does right now.)", "author": "ace-n", "createdAt": "2020-09-22T00:28:59Z", "path": "functions/concepts/retry-timeout/src/test/java/functions/RetryTimeoutTest.java", "diffHunk": "@@ -65,41 +64,29 @@ public void afterTest() {\n \n   @Test\n   public void retryTimeout_handlesRetryMsg() {\n-    String timestampData = gson.toJson(Map.of(\n-        \"timestamp\", ZonedDateTime.now(ZoneOffset.UTC).toString()));\n+    ZonedDateTime timestamp = ZonedDateTime.now(ZoneOffset.UTC);\n+    Context mockContext = mock(Context.class);\n+    when(mockContext.timestamp()).thenReturn(timestamp.toString());\n \n     PubSubMessage pubsubMessage = new PubSubMessage();\n-    pubsubMessage.setData(timestampData);\n \n-    new RetryTimeout().accept(pubsubMessage, null);\n+    new RetryTimeout().accept(pubsubMessage, mockContext);\n \n     String logMessage = LOG_HANDLER.getStoredLogRecords().get(0).getMessage();\n-    assertThat(String.format(\"Processing event %s.\", timestampData)).isEqualTo(logMessage);\n+    assertThat(logMessage).contains(\"Processing event with timestamp \" + timestamp);\n   }\n \n   @Test\n   public void retryTimeout_handlesStopMsg() {", "originalCommit": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgyNDUwNg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492824506", "bodyText": "If you're looking at the diffs it can be confusing, since I deleted the empty-payload test. The two remaining test methods are basically identical apart from the timestamp, and the assertion is on the last line of each.", "author": "eamonnmcmanus", "createdAt": "2020-09-22T15:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNzkxMg=="}], "type": "inlineReview"}]}