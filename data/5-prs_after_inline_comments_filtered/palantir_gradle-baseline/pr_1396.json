{"pr_number": 1396, "pr_title": "Add errorprone check for immutables style collisions", "pr_createdAt": "2020-06-08T18:48:35Z", "pr_url": "https://github.com/palantir/gradle-baseline/pull/1396", "timeline": [{"oid": "2ebe8d0373af5e13c64bb77e2f7fe805baf9acd2", "url": "https://github.com/palantir/gradle-baseline/commit/2ebe8d0373af5e13c64bb77e2f7fe805baf9acd2", "message": "Save", "committedDate": "2020-06-08T18:30:20Z", "type": "commit"}, {"oid": "3b3c97c461fac522e0c91deea8bf16b5c4b852cb", "url": "https://github.com/palantir/gradle-baseline/commit/3b3c97c461fac522e0c91deea8bf16b5c4b852cb", "message": "Add inline/meta-annotation style collision errorprone", "committedDate": "2020-06-08T19:18:54Z", "type": "commit"}, {"oid": "3b3c97c461fac522e0c91deea8bf16b5c4b852cb", "url": "https://github.com/palantir/gradle-baseline/commit/3b3c97c461fac522e0c91deea8bf16b5c4b852cb", "message": "Add inline/meta-annotation style collision errorprone", "committedDate": "2020-06-08T19:18:54Z", "type": "forcePushed"}, {"oid": "90398e5fec87d13ca5cc05fab45c9c4eb6a936a8", "url": "https://github.com/palantir/gradle-baseline/commit/90398e5fec87d13ca5cc05fab45c9c4eb6a936a8", "message": "small cleanup", "committedDate": "2020-06-08T19:23:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0ODEzNw==", "url": "https://github.com/palantir/gradle-baseline/pull/1396#discussion_r436948137", "bodyText": "I think we can use describeMatch instead which inherits the summary message from the class-level BugPattern annotation.", "author": "carterkozak", "createdAt": "2020-06-08T19:25:28Z", "path": "baseline-error-prone/src/main/java/com/palantir/baseline/errorprone/ImmutablesStyleCollision.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.palantir.baseline.errorprone;\n+\n+import com.google.auto.service.AutoService;\n+import com.google.errorprone.BugPattern;\n+import com.google.errorprone.BugPattern.LinkType;\n+import com.google.errorprone.VisitorState;\n+import com.google.errorprone.bugpatterns.BugChecker;\n+import com.google.errorprone.matchers.ChildMultiMatcher;\n+import com.google.errorprone.matchers.Description;\n+import com.google.errorprone.matchers.Matcher;\n+import com.google.errorprone.matchers.Matchers;\n+import com.sun.source.tree.ClassTree;\n+import org.immutables.value.Value;\n+\n+@AutoService(BugChecker.class)\n+@BugPattern(\n+        name = \"ImmutablesStyleCollision\",\n+        linkType = LinkType.CUSTOM,\n+        link = \"https://github.com/palantir/gradle-baseline#baseline-error-prone-checks\",\n+        severity = BugPattern.SeverityLevel.ERROR,\n+        summary = \"Immutables @Value.Style inline annotation should not be present alongside a Style \"\n+                + \"meta-annotation, as there is no Style merging. You should either modify the \"\n+                + \"meta-annotation, or add the meta-annotation's fields to your inline @Value.Style \"\n+                + \"declaration.\")\n+public final class ImmutablesStyleCollision extends BugChecker implements BugChecker.ClassTreeMatcher {\n+    private static final Matcher<ClassTree> INLINE_STYLE_ANNOTATION = Matchers.hasAnnotation(Value.Style.class);\n+    private static final Matcher<ClassTree> STYLE_META_ANNOTATION =\n+            Matchers.annotations(ChildMultiMatcher.MatchType.AT_LEAST_ONE, Matchers.hasAnnotation(Value.Style.class));\n+    private static final Matcher<ClassTree> MATCHER = Matchers.allOf(INLINE_STYLE_ANNOTATION, STYLE_META_ANNOTATION);\n+\n+    @Override\n+    public Description matchClass(ClassTree tree, VisitorState state) {\n+        if (MATCHER.matches(tree, state)) {\n+            return buildDescription(tree)\n+                    .setMessage(\"Immutable type cannot have both inline @Value.Style and meta-annotation applied\")\n+                    .build();", "originalCommit": "90398e5fec87d13ca5cc05fab45c9c4eb6a936a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0ODYyMw==", "url": "https://github.com/palantir/gradle-baseline/pull/1396#discussion_r436948623", "bodyText": "Please document this alongside the other baseline error-prone checks in the readme!", "author": "carterkozak", "createdAt": "2020-06-08T19:26:21Z", "path": "baseline-error-prone/src/main/java/com/palantir/baseline/errorprone/ImmutablesStyleCollision.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.palantir.baseline.errorprone;\n+\n+import com.google.auto.service.AutoService;\n+import com.google.errorprone.BugPattern;\n+import com.google.errorprone.BugPattern.LinkType;\n+import com.google.errorprone.VisitorState;\n+import com.google.errorprone.bugpatterns.BugChecker;\n+import com.google.errorprone.matchers.ChildMultiMatcher;\n+import com.google.errorprone.matchers.Description;\n+import com.google.errorprone.matchers.Matcher;\n+import com.google.errorprone.matchers.Matchers;\n+import com.sun.source.tree.ClassTree;\n+import org.immutables.value.Value;\n+\n+@AutoService(BugChecker.class)\n+@BugPattern(\n+        name = \"ImmutablesStyleCollision\",", "originalCommit": "90398e5fec87d13ca5cc05fab45c9c4eb6a936a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0OTc1Mg==", "url": "https://github.com/palantir/gradle-baseline/pull/1396#discussion_r436949752", "bodyText": "You'll also need to add it to the list of errorprone rules we always apply", "author": "ferozco", "createdAt": "2020-06-08T19:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0ODYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk1MDE3NQ==", "url": "https://github.com/palantir/gradle-baseline/pull/1396#discussion_r436950175", "bodyText": "I added it to the readme but where is the list @ferozco ?", "author": "a10y", "createdAt": "2020-06-08T19:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0ODYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk1MDI3OQ==", "url": "https://github.com/palantir/gradle-baseline/pull/1396#discussion_r436950279", "bodyText": "I think that's just for automatic refactors, but this can't be auto-fixed. severity = BugPattern.SeverityLevel.ERROR, should be sufficient.", "author": "carterkozak", "createdAt": "2020-06-08T19:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0ODYyMw=="}], "type": "inlineReview"}, {"oid": "4fa5fa938f52299f359d349d869f1d5aee60e73c", "url": "https://github.com/palantir/gradle-baseline/commit/4fa5fa938f52299f359d349d869f1d5aee60e73c", "message": "describeMatch", "committedDate": "2020-06-08T19:27:27Z", "type": "commit"}, {"oid": "f19da6288e8335531a7620b89b9247bfc3c2c1b6", "url": "https://github.com/palantir/gradle-baseline/commit/f19da6288e8335531a7620b89b9247bfc3c2c1b6", "message": "Add README section for check", "committedDate": "2020-06-08T19:28:43Z", "type": "commit"}, {"oid": "c175387ab53ff06488547c35227cb5432758dbae", "url": "https://github.com/palantir/gradle-baseline/commit/c175387ab53ff06488547c35227cb5432758dbae", "message": "Add generated changelog entries", "committedDate": "2020-06-08T19:28:43Z", "type": "commit"}, {"oid": "d1d811fe7d009563387fc16d563b2e2e2d14c242", "url": "https://github.com/palantir/gradle-baseline/commit/d1d811fe7d009563387fc16d563b2e2e2d14c242", "message": "fix match text", "committedDate": "2020-06-08T19:31:17Z", "type": "commit"}, {"oid": "d3a6b4e316ded3df60ee29b73979c1113dc1de04", "url": "https://github.com/palantir/gradle-baseline/commit/d3a6b4e316ded3df60ee29b73979c1113dc1de04", "message": "compile", "committedDate": "2020-06-08T19:39:18Z", "type": "commit"}]}