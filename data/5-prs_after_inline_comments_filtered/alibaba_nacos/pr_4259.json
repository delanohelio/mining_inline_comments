{"pr_number": 4259, "pr_title": "[ISSUE-#4258]  Fix wrong path when -Dspring.config.location not set", "pr_createdAt": "2020-11-18T11:04:47Z", "pr_url": "https://github.com/alibaba/nacos/pull/4259", "timeline": [{"oid": "7b0ca19b48148578f2a3c1d13904885ee66132ce", "url": "https://github.com/alibaba/nacos/commit/7b0ca19b48148578f2a3c1d13904885ee66132ce", "message": "fix spring.config.location is nullapplication.properties when -Dspring.config.location is not set in env", "committedDate": "2020-11-18T10:36:08Z", "type": "commit"}, {"oid": "e366e3391c436c1660d9ce53c1a8707b015fec51", "url": "https://github.com/alibaba/nacos/commit/e366e3391c436c1660d9ce53c1a8707b015fec51", "message": "fix wrong path when -Dspring.config.location not set", "committedDate": "2020-11-18T10:58:30Z", "type": "commit"}, {"oid": "0ecfba190a44552a304323e40ebe07508076ea70", "url": "https://github.com/alibaba/nacos/commit/0ecfba190a44552a304323e40ebe07508076ea70", "message": "modify default file resource method name", "committedDate": "2020-11-18T11:10:35Z", "type": "commit"}, {"oid": "8c0937e4920665ffcbcc0820e153aab1071eaa84", "url": "https://github.com/alibaba/nacos/commit/8c0937e4920665ffcbcc0820e153aab1071eaa84", "message": "fix \"/\" magic value", "committedDate": "2020-11-18T11:49:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAwMzUyMg==", "url": "https://github.com/alibaba/nacos/pull/4259#discussion_r526003522", "bodyText": "new File(path + \"application.properties\") => Paths.get().toFile()", "author": "chuntaojun", "createdAt": "2020-11-18T11:10:47Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/env/EnvUtil.java", "diffHunk": "@@ -361,19 +361,35 @@ public static String getMemberList() {\n     private static final String FILE_PREFIX = \"file:\";\n     \n     public static Resource getApplicationConfFileResource() {\n+        Resource customResource = getCustomFileResource();\n+        if (customResource == null) {\n+            return getDefaultResource();\n+        }\n+        return customResource;\n+    }\n+    \n+    private static Resource getCustomFileResource() {\n         String path = getProperty(\"spring.config.location\");\n-        InputStream inputStream = null;\n+        if (path == null) {\n+            return null;\n+        }\n         if (StringUtils.isNotBlank(path) && path.contains(FILE_PREFIX)) {\n             String[] paths = path.split(\",\");\n             path = paths[paths.length - 1].substring(FILE_PREFIX.length());\n         }\n+        if (!path.endsWith(\"/\")) {\n+            path += \"/\";\n+        }\n         try {\n-            inputStream = new FileInputStream(new File(path + \"application.properties\"));\n+            InputStream inputStream = new FileInputStream(new File(path + \"application.properties\"));", "originalCommit": "e366e3391c436c1660d9ce53c1a8707b015fec51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzNjI2Nw==", "url": "https://github.com/alibaba/nacos/pull/4259#discussion_r526036267", "bodyText": "ok", "author": "horizonzy", "createdAt": "2020-11-18T12:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAwMzUyMg=="}], "type": "inlineReview"}, {"oid": "f046dcc220fcc65b05cfebd17ca63299b318cfd4", "url": "https://github.com/alibaba/nacos/commit/f046dcc220fcc65b05cfebd17ca63299b318cfd4", "message": "change the way of get file", "committedDate": "2020-11-18T11:56:17Z", "type": "commit"}, {"oid": "088ea237a3cb2a1f1217fbae70affb66364f3f4a", "url": "https://github.com/alibaba/nacos/commit/088ea237a3cb2a1f1217fbae70affb66364f3f4a", "message": "not judge pathSplit by self, use Paths.get(a, b);", "committedDate": "2020-11-18T12:06:16Z", "type": "commit"}, {"oid": "5a734f20396cda39d4697bc1a93987947c7d428d", "url": "https://github.com/alibaba/nacos/commit/5a734f20396cda39d4697bc1a93987947c7d428d", "message": "when spring.config.location is not set, use {nacos.home}/conf/application.properties to cover it.", "committedDate": "2020-11-19T02:36:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2OTU0Nw==", "url": "https://github.com/alibaba/nacos/pull/4259#discussion_r526569547", "bodyText": "use Paths.get(...)", "author": "chuntaojun", "createdAt": "2020-11-19T03:23:56Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/env/EnvUtil.java", "diffHunk": "@@ -363,15 +363,15 @@ public static String getMemberList() {\n     public static Resource getApplicationConfFileResource() {\n         Resource customResource = getCustomFileResource();\n         if (customResource == null) {\n-            return getDefaultFileResource();\n+            return getDefaultResource();\n         }\n         return customResource;\n     }\n     \n     private static Resource getCustomFileResource() {\n         String path = getProperty(\"spring.config.location\");\n         if (path == null) {\n-            return null;\n+            path = EnvUtil.getNacosHome() + \"/conf\";", "originalCommit": "5a734f20396cda39d4697bc1a93987947c7d428d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d578a44a2178c660acbcbe31a82661ce509ebe28", "url": "https://github.com/alibaba/nacos/commit/d578a44a2178c660acbcbe31a82661ce509ebe28", "message": "refactor code", "committedDate": "2020-11-19T07:38:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY4NDkyNQ==", "url": "https://github.com/alibaba/nacos/pull/4259#discussion_r526684925", "bodyText": "\u8fd9\u4e2aif (customPath == null)\u53ef\u4ee5\u53bb\u6389\uff0c\u56e0\u4e3a\u65b9\u6cd5\u7ed3\u675f\u4f1areturn getRelativePathResource(Paths.get(EnvUtil.getNacosHome(), \"conf\"));", "author": "Maijh97", "createdAt": "2020-11-19T08:44:46Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/env/EnvUtil.java", "diffHunk": "@@ -361,19 +362,38 @@ public static String getMemberList() {\n     private static final String FILE_PREFIX = \"file:\";\n     \n     public static Resource getApplicationConfFileResource() {\n-        String path = getProperty(\"spring.config.location\");\n-        InputStream inputStream = null;\n-        if (StringUtils.isNotBlank(path) && path.contains(FILE_PREFIX)) {\n-            String[] paths = path.split(\",\");\n-            path = paths[paths.length - 1].substring(FILE_PREFIX.length());\n+        Resource customResource = getCustomFileResource();\n+        if (customResource == null) {\n+            return getDefaultResource();\n         }\n+        return customResource;\n+    }\n+    \n+    private static Resource getCustomFileResource() {\n+        String customPath = getProperty(\"spring.config.location\");\n+        if (customPath == null) {\n+            return getRelativePathResource(Paths.get(EnvUtil.getNacosHome(), \"conf\"));", "originalCommit": "d578a44a2178c660acbcbe31a82661ce509ebe28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "820b2202a38c576b68aa7842804ec1eee5c6d4f8", "url": "https://github.com/alibaba/nacos/commit/820b2202a38c576b68aa7842804ec1eee5c6d4f8", "message": "code quality enhance", "committedDate": "2020-11-19T09:33:54Z", "type": "commit"}, {"oid": "c61bdc5b65d320d2ee0b8ff18325eaf37e1d293b", "url": "https://github.com/alibaba/nacos/commit/c61bdc5b65d320d2ee0b8ff18325eaf37e1d293b", "message": "just use two level to load conf. {spring.config.location}/application.properties -> classpath:/application.properties", "committedDate": "2020-11-20T02:38:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2NTMxOA==", "url": "https://github.com/alibaba/nacos/pull/4259#discussion_r527365318", "bodyText": "StringUtils.contains() \u6709\u8fd9\u79cd\u65b9\u6cd5\u5417\uff1f", "author": "chuntaojun", "createdAt": "2020-11-20T03:09:08Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/env/EnvUtil.java", "diffHunk": "@@ -370,21 +369,18 @@ public static Resource getApplicationConfFileResource() {\n     }\n     \n     private static Resource getCustomFileResource() {\n-        String customPath = getProperty(\"spring.config.location\");\n-        \n-        if (StringUtils.isNotBlank(customPath) && customPath.contains(FILE_PREFIX)) {\n-            String[] paths = customPath.split(\",\");\n-            customPath = paths[paths.length - 1].substring(FILE_PREFIX.length());\n-            Path parentPath = Paths.get(customPath);\n-            return getRelativePathResource(parentPath);\n+        String path = getProperty(\"spring.config.location\");\n+        if (StringUtils.isNotBlank(path) && path.contains(FILE_PREFIX)) {", "originalCommit": "c61bdc5b65d320d2ee0b8ff18325eaf37e1d293b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM5ODIwOQ==", "url": "https://github.com/alibaba/nacos/pull/4259#discussion_r527398209", "bodyText": "\u73b0\u5728\u6709\u4e2acontainsIgnoreCase. \u53ef\u4ee5\u7528\u8fd9\u4e2a\u66ff\u6362", "author": "horizonzy", "createdAt": "2020-11-20T04:59:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2NTMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQwODUwMg==", "url": "https://github.com/alibaba/nacos/pull/4259#discussion_r527408502", "bodyText": "\u8def\u5f84\u4e0d\u80fdIgnoreCase", "author": "chuntaojun", "createdAt": "2020-11-20T05:26:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2NTMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQzMDU1Mg==", "url": "https://github.com/alibaba/nacos/pull/4259#discussion_r527430552", "bodyText": "\u8fd9\u4e2a\u53ea\u662f\u5224\u65adfile:, \u8fd9\u4e2a\u5927\u5c0f\u5199\u5ffd\u7565ok\u7684", "author": "horizonzy", "createdAt": "2020-11-20T05:50:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2NTMxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MTk5NQ==", "url": "https://github.com/alibaba/nacos/pull/4259#discussion_r528441995", "bodyText": "Simply to null == customResource ? return getDefaultResource() : customResource", "author": "KomachiSion", "createdAt": "2020-11-23T02:01:01Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/env/EnvUtil.java", "diffHunk": "@@ -361,19 +361,34 @@ public static String getMemberList() {\n     private static final String FILE_PREFIX = \"file:\";\n     \n     public static Resource getApplicationConfFileResource() {\n+        Resource customResource = getCustomFileResource();\n+        if (customResource == null) {", "originalCommit": "c61bdc5b65d320d2ee0b8ff18325eaf37e1d293b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "613217b6d1c8722ef05fb0d92f108424f4ee74a3", "url": "https://github.com/alibaba/nacos/commit/613217b6d1c8722ef05fb0d92f108424f4ee74a3", "message": "code clean", "committedDate": "2020-11-23T02:34:06Z", "type": "commit"}]}