{"pr_number": 3805, "pr_title": "feature issue #3804", "pr_createdAt": "2020-09-11T07:03:25Z", "pr_url": "https://github.com/alibaba/nacos/pull/3805", "timeline": [{"oid": "9585d55adccffde50385ed9af89d385ebfcd53c6", "url": "https://github.com/alibaba/nacos/commit/9585d55adccffde50385ed9af89d385ebfcd53c6", "message": "improvement: merge upstream/develop", "committedDate": "2020-06-17T07:20:06Z", "type": "commit"}, {"oid": "29df82f694c9ed80ae7e28bd7acb507386972ec7", "url": "https://github.com/alibaba/nacos/commit/29df82f694c9ed80ae7e28bd7acb507386972ec7", "message": "refactor: merge upstream develop", "committedDate": "2020-06-18T15:15:01Z", "type": "commit"}, {"oid": "78167ab1e72c3db2d2a1fa0da68caed994db6c19", "url": "https://github.com/alibaba/nacos/commit/78167ab1e72c3db2d2a1fa0da68caed994db6c19", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop", "committedDate": "2020-06-19T03:39:46Z", "type": "commit"}, {"oid": "7915e4fc647f9861636df7b049cdcaaef930968d", "url": "https://github.com/alibaba/nacos/commit/7915e4fc647f9861636df7b049cdcaaef930968d", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop", "committedDate": "2020-06-19T13:40:16Z", "type": "commit"}, {"oid": "9e7cf3055421c48942092ca57bc66458ab9a0313", "url": "https://github.com/alibaba/nacos/commit/9e7cf3055421c48942092ca57bc66458ab9a0313", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop", "committedDate": "2020-06-24T02:43:54Z", "type": "commit"}, {"oid": "3d8b55cca0738f8fa0dbedcff89c1e001b87322a", "url": "https://github.com/alibaba/nacos/commit/3d8b55cca0738f8fa0dbedcff89c1e001b87322a", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop", "committedDate": "2020-06-24T07:52:09Z", "type": "commit"}, {"oid": "a07f84efa557cb122af23b7312d006270d8d0198", "url": "https://github.com/alibaba/nacos/commit/a07f84efa557cb122af23b7312d006270d8d0198", "message": "feat: merge upstream develop", "committedDate": "2020-06-24T10:21:37Z", "type": "commit"}, {"oid": "f1811027f98595a96110de97ff1c4ef39cee9887", "url": "https://github.com/alibaba/nacos/commit/f1811027f98595a96110de97ff1c4ef39cee9887", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop", "committedDate": "2020-06-29T08:22:27Z", "type": "commit"}, {"oid": "abee9c4dcf7af484e433340c827b13d1d1d23360", "url": "https://github.com/alibaba/nacos/commit/abee9c4dcf7af484e433340c827b13d1d1d23360", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop", "committedDate": "2020-07-16T16:06:39Z", "type": "commit"}, {"oid": "63ac93b95eba7c641cffecdb1e9684d0621fcfed", "url": "https://github.com/alibaba/nacos/commit/63ac93b95eba7c641cffecdb1e9684d0621fcfed", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop", "committedDate": "2020-08-21T05:27:16Z", "type": "commit"}, {"oid": "b39970a0e107371db0250992031dee9f1d040265", "url": "https://github.com/alibaba/nacos/commit/b39970a0e107371db0250992031dee9f1d040265", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop", "committedDate": "2020-09-11T05:33:03Z", "type": "commit"}, {"oid": "cd596e9cdc9fef270f6ced9b680711eff8cae877", "url": "https://github.com/alibaba/nacos/commit/cd596e9cdc9fef270f6ced9b680711eff8cae877", "message": "feat: manage the loading of configuration files uniformly", "committedDate": "2020-09-11T07:04:00Z", "type": "commit"}, {"oid": "7bde78ff5dcd572f0de98463d67853be2bb964eb", "url": "https://github.com/alibaba/nacos/commit/7bde78ff5dcd572f0de98463d67853be2bb964eb", "message": "fix: fix copyright style", "committedDate": "2020-09-11T07:41:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgyNDU4OA==", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486824588", "bodyText": "What's the reason create this class?", "author": "KomachiSion", "createdAt": "2020-09-11T07:24:20Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/Main.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ *  Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.sys;\n+\n+/**\n+ * @author <a href=\"mailto:liaochuntao@live.com\">liaochuntao</a>\n+ */\n+public class Main {", "originalCommit": "cd596e9cdc9fef270f6ced9b680711eff8cae877", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzNTA0NA==", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486835044", "bodyText": "already remove, wait next comit", "author": "chuntaojun", "createdAt": "2020-09-11T07:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgyNDU4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgyNTgwOQ==", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486825809", "bodyText": "Why change the indentation of lecense?", "author": "KomachiSion", "createdAt": "2020-09-11T07:26:49Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/env/NacosDefaultPropertySourceEnvironmentPostProcessor.java", "diffHunk": "@@ -1,20 +1,20 @@\n /*\n- * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *  Copyright 1999-2018 Alibaba Group Holding Ltd.", "originalCommit": "cd596e9cdc9fef270f6ced9b680711eff8cae877", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzNTEwOA==", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486835108", "bodyText": "already fix", "author": "chuntaojun", "createdAt": "2020-09-11T07:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgyNTgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzMzE5OQ==", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486833199", "bodyText": "I found this inner class only used in current class line 97. And each time create a new one. Can this inner class refactor to some private method.\nIf there are other same package class need this class. Whether extract as an single class will be better?", "author": "KomachiSion", "createdAt": "2020-09-11T07:42:05Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/env/NacosAutoRefreshPropertySourceLoader.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ *  Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.sys.env;\n+\n+import com.alibaba.nacos.api.exception.NacosException;\n+import com.alibaba.nacos.common.JustForTest;\n+import com.alibaba.nacos.sys.file.FileChangeEvent;\n+import com.alibaba.nacos.sys.file.FileWatcher;\n+import com.alibaba.nacos.sys.file.WatchFileCenter;\n+import com.alibaba.nacos.sys.utils.ApplicationUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.boot.env.OriginTrackedMapPropertySource;\n+import org.springframework.boot.env.PropertySourceLoader;\n+import org.springframework.boot.origin.Origin;\n+import org.springframework.boot.origin.OriginTrackedValue;\n+import org.springframework.boot.origin.TextResourceOrigin;\n+import org.springframework.core.env.PropertySource;\n+import org.springframework.core.io.Resource;\n+import org.springframework.util.Assert;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.LineNumberReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Support for configuring automatic refresh and loading into the Environment.\n+ *\n+ * @author <a href=\"mailto:liaochuntao@live.com\">liaochuntao</a>\n+ */\n+public class NacosAutoRefreshPropertySourceLoader implements PropertySourceLoader {\n+    \n+    private final Map<String, Object> properties = new ConcurrentHashMap<>(16);\n+    \n+    private Resource holder = null;\n+    \n+    @Override\n+    public String[] getFileExtensions() {\n+        return new String[] {\"properties\"};\n+    }\n+    \n+    @Override\n+    public List<PropertySource<?>> load(String name, Resource resource) throws IOException {\n+        holder = resource;\n+        Map<String, ?> tmp = loadProperties(resource);\n+        properties.putAll(tmp);\n+    \n+        try {\n+            WatchFileCenter.registerWatcher(ApplicationUtils.getConfFilePath(), new FileWatcher() {\n+                @Override\n+                public void onChange(FileChangeEvent event) {\n+                    try {\n+                        Map<String, ?> tmp1 = loadProperties(holder);\n+                        properties.putAll(tmp1);\n+                    } catch (IOException ignore) {\n+                    \n+                    }\n+                }\n+            \n+                @Override\n+                public boolean interest(String context) {\n+                    return StringUtils.contains(context, \"application.properties\");\n+                }\n+            });\n+        } catch (NacosException ignore) {\n+        \n+        }\n+    \n+        if (properties.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+        return Collections\n+                .singletonList(new OriginTrackedMapPropertySource(\"nacos_application_conf\", properties));\n+    }\n+    \n+    private Map<String, ?> loadProperties(Resource resource) throws IOException {\n+        return new OriginTrackedPropertiesLoader(resource).load();\n+    }\n+    \n+    @JustForTest\n+    protected Map<String, Object> getProperties() {\n+        return properties;\n+    }\n+    \n+    static class OriginTrackedPropertiesLoader {", "originalCommit": "cd596e9cdc9fef270f6ced9b680711eff8cae877", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzMzgwNw==", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486833807", "bodyText": "This file has been deleted?", "author": "KomachiSion", "createdAt": "2020-09-11T07:43:17Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/env/NacosDefaultPropertySourceEnvironmentPostProcessor.java", "diffHunk": "@@ -56,7 +57,7 @@\n      * @see ResourcePatternResolver#CLASSPATH_ALL_URL_PREFIX\n      */\n     public static final String RESOURCE_LOCATION_PATTERN =\n-            CLASSPATH_ALL_URL_PREFIX + \"META-INF/nacos-default.properties\";\n+            ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX + \"META-INF/nacos-default.properties\";", "originalCommit": "7bde78ff5dcd572f0de98463d67853be2bb964eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f98f1f3a77519b6ace45cd3cc89bffed9f0df070", "url": "https://github.com/alibaba/nacos/commit/f98f1f3a77519b6ace45cd3cc89bffed9f0df070", "message": "style: fix code style", "committedDate": "2020-09-16T02:12:24Z", "type": "commit"}, {"oid": "aa187b1ed403df18334fba9a780845db396066d3", "url": "https://github.com/alibaba/nacos/commit/aa187b1ed403df18334fba9a780845db396066d3", "message": "feat: merge upstream develop", "committedDate": "2020-09-16T02:34:59Z", "type": "commit"}, {"oid": "ba7488453b3c131b1a55f9d26b8345bc46e09f3e", "url": "https://github.com/alibaba/nacos/commit/ba7488453b3c131b1a55f9d26b8345bc46e09f3e", "message": "fix: fix code style", "committedDate": "2020-09-16T06:02:59Z", "type": "commit"}, {"oid": "f8d4e4a0c949718d1f1333b9b367efadb67a6d36", "url": "https://github.com/alibaba/nacos/commit/f8d4e4a0c949718d1f1333b9b367efadb67a6d36", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into feat_config_env", "committedDate": "2020-09-17T14:33:08Z", "type": "commit"}]}