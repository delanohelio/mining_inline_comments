{"pr_number": 3212, "pr_title": "[ISSUE #3210] Enhanced nacos resttemplate response handler", "pr_createdAt": "2020-06-30T08:38:23Z", "pr_url": "https://github.com/alibaba/nacos/pull/3212", "timeline": [{"oid": "4a8f1781659a0a6a71a804a5587f46ecf6a35c6c", "url": "https://github.com/alibaba/nacos/commit/4a8f1781659a0a6a71a804a5587f46ecf6a35c6c", "message": "Enhanced nacos resttemplate response handler", "committedDate": "2020-06-30T08:31:13Z", "type": "commit"}, {"oid": "b55d9216eed66ca60b43dd6fb147701c732c5365", "url": "https://github.com/alibaba/nacos/commit/b55d9216eed66ca60b43dd6fb147701c732c5365", "message": "Enhanced nacos resttemplate response handler", "committedDate": "2020-06-30T13:57:56Z", "type": "commit"}, {"oid": "7565459b9e2cfec3815ab3ac0ae856c570ad7037", "url": "https://github.com/alibaba/nacos/commit/7565459b9e2cfec3815ab3ac0ae856c570ad7037", "message": "Add license", "committedDate": "2020-06-30T14:04:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUyMjI0Mg==", "url": "https://github.com/alibaba/nacos/pull/3212#discussion_r447522242", "bodyText": "Can we use JacksonUtil directly? I think we will replace and remove com.alibaba.nacos.common.http.handler.ResponseHandler Gradually", "author": "KomachiSion", "createdAt": "2020-06-30T08:52:58Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/client/BeanResponseConverter.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http.client;\n+\n+import com.alibaba.nacos.common.http.HttpRestResult;\n+import com.alibaba.nacos.common.http.param.Header;\n+import com.alibaba.nacos.common.http.param.MediaType;\n+import com.alibaba.nacos.common.model.RestResult;\n+import com.alibaba.nacos.common.utils.JacksonUtils;\n+\n+import java.io.InputStream;\n+import java.lang.reflect.Type;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * RestResult response converter\n+ * Mainly converter response type as bean type, Contain responseType as {@link RestResult}.\n+ *\n+ * @author mai.jh\n+ */\n+public class BeanResponseConverter<T> implements ResponseConverter<T> {\n+    \n+    private static final Set<Class<?>> NON_BEAN_CLASSES = Collections\n+            .unmodifiableSet(new HashSet<Class<?>>(Arrays.asList(Object.class, Class.class)));\n+    \n+    @Override\n+    public boolean canConverter(Type responseType, String contentType) {\n+        return contentType != null\n+                && contentType.startsWith(MediaType.APPLICATION_JSON)\n+                && isBindableBean(JacksonUtils.constructJavaType(responseType).getRawClass());\n+    }\n+    \n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public HttpRestResult<T> converter(HttpClientResponse response, Type responseType) throws Exception {\n+        final Header headers = response.getHeaders();\n+        InputStream body = response.getBody();\n+        T extractBody = com.alibaba.nacos.common.http.handler.ResponseHandler.convert(body, responseType);", "originalCommit": "4a8f1781659a0a6a71a804a5587f46ecf6a35c6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNTQwOQ==", "url": "https://github.com/alibaba/nacos/pull/3212#discussion_r448315409", "bodyText": "AbstractResponseHandler is enough, I think.", "author": "KomachiSion", "createdAt": "2020-07-01T12:03:02Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/client/AbstractResponseConverterHandler.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http.client;\n+\n+import com.alibaba.nacos.common.http.HttpRestResult;\n+import com.alibaba.nacos.common.http.param.Header;\n+import com.alibaba.nacos.common.utils.IoUtils;\n+import org.apache.http.HttpStatus;\n+\n+import java.lang.reflect.Type;\n+\n+/**\n+ * Abstract response converter handler\n+ *\n+ * @author mai.jh\n+ */\n+public abstract class AbstractResponseConverterHandler<T> implements ResponseHandler<T> {", "originalCommit": "7565459b9e2cfec3815ab3ac0ae856c570ad7037", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNTY0Nw==", "url": "https://github.com/alibaba/nacos/pull/3212#discussion_r448315647", "bodyText": "BeanResponseHandler, I think", "author": "KomachiSion", "createdAt": "2020-07-01T12:03:29Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/client/BeanResponseConverter.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http.client;\n+\n+import com.alibaba.nacos.common.http.HttpRestResult;\n+import com.alibaba.nacos.common.http.param.Header;\n+\n+import java.io.InputStream;\n+import java.lang.reflect.Type;\n+\n+/**\n+ * bean response converter\n+ * Mainly converter response type as bean type\n+ *\n+ * @author mai.jh\n+ */\n+public class BeanResponseConverter<T> extends AbstractResponseConverterHandler<T> {", "originalCommit": "7565459b9e2cfec3815ab3ac0ae856c570ad7037", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNjAwMQ==", "url": "https://github.com/alibaba/nacos/pull/3212#discussion_r448316001", "bodyText": "abstract class AbstractNacosRestTemplate?", "author": "KomachiSion", "createdAt": "2020-07-01T12:04:09Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/client/HttpConverter.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http.client;\n+\n+import com.alibaba.nacos.common.constant.ResponseHandlerType;\n+import com.alibaba.nacos.common.utils.JacksonUtils;\n+import com.fasterxml.jackson.databind.JavaType;\n+\n+import java.lang.reflect.Type;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * http converter\n+ * For NacosRestTemplate and NacosAsyncRestTemplate,\n+ * provide initialization and register of response converter\n+ *\n+ * @author mai.jh\n+ */\n+public class HttpConverter {", "originalCommit": "7565459b9e2cfec3815ab3ac0ae856c570ad7037", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNjY2Nw==", "url": "https://github.com/alibaba/nacos/pull/3212#discussion_r448316667", "bodyText": "comment need an end '.', please  check all you comment.", "author": "KomachiSion", "createdAt": "2020-07-01T12:05:32Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/client/HttpConverter.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http.client;\n+\n+import com.alibaba.nacos.common.constant.ResponseHandlerType;\n+import com.alibaba.nacos.common.utils.JacksonUtils;\n+import com.fasterxml.jackson.databind.JavaType;\n+\n+import java.lang.reflect.Type;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * http converter\n+ * For NacosRestTemplate and NacosAsyncRestTemplate,\n+ * provide initialization and register of response converter\n+ *\n+ * @author mai.jh\n+ */\n+public class HttpConverter {\n+    \n+    private final Map<String, ResponseHandler> responseConverterMap = new HashMap<String, ResponseHandler>();\n+    \n+    public HttpConverter() {\n+        // init response converter\n+        responseConverterMap.put(ResponseHandlerType.STRING_TYPE, new StringResponseConverter());\n+        responseConverterMap.put(ResponseHandlerType.RESTRESULT_TYPE, new RestResultResponseConverter());\n+        responseConverterMap.put(ResponseHandlerType.DEFAULT_BEAN_TYPE, new BeanResponseConverter());\n+    }\n+    \n+    /**\n+     * register customization Response Handler\n+     * @param responseHandler {@link ResponseHandler}\n+     */\n+    public void registerResponseHandler(String responseHandlerType, ResponseHandler responseHandler) {\n+        responseConverterMap.put(responseHandlerType, responseHandler);\n+    }\n+    \n+    /**\n+     * Select a response handler by responseType", "originalCommit": "7565459b9e2cfec3815ab3ac0ae856c570ad7037", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNjg3Mw==", "url": "https://github.com/alibaba/nacos/pull/3212#discussion_r448316873", "bodyText": "RestResultResponseHandler.", "author": "KomachiSion", "createdAt": "2020-07-01T12:05:55Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/client/RestResultResponseConverter.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http.client;\n+\n+import com.alibaba.nacos.common.http.HttpRestResult;\n+import com.alibaba.nacos.common.http.param.Header;\n+import com.alibaba.nacos.common.model.RestResult;\n+\n+import java.io.InputStream;\n+import java.lang.reflect.Type;\n+\n+/**\n+ * RestResult response converter\n+ * Mainly converter response type as {@link RestResult} type.\n+ *\n+ * @author mai.jh\n+ */\n+public class RestResultResponseConverter<T> extends AbstractResponseConverterHandler<T> {", "originalCommit": "7565459b9e2cfec3815ab3ac0ae856c570ad7037", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNjk0NA==", "url": "https://github.com/alibaba/nacos/pull/3212#discussion_r448316944", "bodyText": "StringResponseHandler", "author": "KomachiSion", "createdAt": "2020-07-01T12:06:07Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/client/StringResponseConverter.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http.client;\n+\n+import com.alibaba.nacos.common.http.HttpRestResult;\n+import com.alibaba.nacos.common.http.param.Header;\n+import com.alibaba.nacos.common.utils.IoUtils;\n+\n+import java.lang.reflect.Type;\n+\n+/**\n+ * string response handler,\n+ * Mainly converter response type as string type.\n+ *\n+ * @author mai.jh\n+ */\n+public class StringResponseConverter extends AbstractResponseConverterHandler<String> {", "originalCommit": "7565459b9e2cfec3815ab3ac0ae856c570ad7037", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4b9a23fa3174339dd4efda3f4aa95bc5a4231fdd", "url": "https://github.com/alibaba/nacos/commit/4b9a23fa3174339dd4efda3f4aa95bc5a4231fdd", "message": "[#3212] Modify some class name and comment", "committedDate": "2020-07-02T00:43:02Z", "type": "commit"}, {"oid": "d757ae4af9478ab28a6a572ee03a247940bf8659", "url": "https://github.com/alibaba/nacos/commit/d757ae4af9478ab28a6a572ee03a247940bf8659", "message": "[#3212] Modify some class name and comment", "committedDate": "2020-07-02T00:45:33Z", "type": "commit"}, {"oid": "4d6fb38c5639304c75b59bff2416fe8c5df5c6a9", "url": "https://github.com/alibaba/nacos/commit/4d6fb38c5639304c75b59bff2416fe8c5df5c6a9", "message": "[#3212] Modify some class name and comment", "committedDate": "2020-07-02T00:47:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5ODg2NQ==", "url": "https://github.com/alibaba/nacos/pull/3212#discussion_r448698865", "bodyText": "We need change the name, because We rename the class.", "author": "KomachiSion", "createdAt": "2020-07-02T01:30:03Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/client/AbstractNacosRestTemplate.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http.client;\n+\n+import com.alibaba.nacos.common.constant.ResponseHandlerType;\n+import com.alibaba.nacos.common.utils.JacksonUtils;\n+import com.fasterxml.jackson.databind.JavaType;\n+\n+import java.lang.reflect.Type;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * For NacosRestTemplate and NacosAsyncRestTemplate,\n+ * provide initialization and register of response converter.\n+ *\n+ * @author mai.jh\n+ */\n+public abstract class AbstractNacosRestTemplate {\n+    \n+    private final Map<String, ResponseHandler> responseConverterMap = new HashMap<String, ResponseHandler>();", "originalCommit": "4d6fb38c5639304c75b59bff2416fe8c5df5c6a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4078f944145bdee605f11b7e1218d92d1894e44f", "url": "https://github.com/alibaba/nacos/commit/4078f944145bdee605f11b7e1218d92d1894e44f", "message": "[#3212] change the name of property", "committedDate": "2020-07-02T01:44:09Z", "type": "commit"}, {"oid": "30bea4b0cbb9afeb3f67bdbd3cc7351b02e0d411", "url": "https://github.com/alibaba/nacos/commit/30bea4b0cbb9afeb3f67bdbd3cc7351b02e0d411", "message": "Merge branch 'develop-upstrem' into nacos_resttemplate_enhance_response_handler\n\n# Conflicts:\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/handler/ResponseHandler.java", "committedDate": "2020-07-13T02:16:31Z", "type": "commit"}, {"oid": "f70acb09b4ada5954d8f6da7065156a2737885ae", "url": "https://github.com/alibaba/nacos/commit/f70acb09b4ada5954d8f6da7065156a2737885ae", "message": "Fix code style issue", "committedDate": "2020-07-13T02:19:28Z", "type": "commit"}]}