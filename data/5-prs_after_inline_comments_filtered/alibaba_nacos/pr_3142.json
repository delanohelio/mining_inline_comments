{"pr_number": 3142, "pr_title": "[ISSUE #3140]nacos-client module replace http client", "pr_createdAt": "2020-06-22T03:07:58Z", "pr_url": "https://github.com/alibaba/nacos/pull/3142", "timeline": [{"oid": "122f8dd213307a8075c005660ecd6fa4608e9434", "url": "https://github.com/alibaba/nacos/commit/122f8dd213307a8075c005660ecd6fa4608e9434", "message": "nacos-client http client replace", "committedDate": "2020-06-22T01:48:16Z", "type": "commit"}, {"oid": "5c9c1facf8d2088cb27d5fed40bb8ad51be25aa9", "url": "https://github.com/alibaba/nacos/commit/5c9c1facf8d2088cb27d5fed40bb8ad51be25aa9", "message": "Merge branch 'develop-upstrem' into refactor_http_client\n\n# Conflicts:\n#\tclient/src/main/java/com/alibaba/nacos/client/naming/net/NamingProxy.java\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/BaseHttpMethod.java\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/HttpClientBeanHolder.java\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/client/NacosRestTemplate.java\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/handler/ResponseHandler.java", "committedDate": "2020-06-22T02:58:27Z", "type": "commit"}, {"oid": "7e0347471722904387edd0f073e0ea19a38b9a28", "url": "https://github.com/alibaba/nacos/commit/7e0347471722904387edd0f073e0ea19a38b9a28", "message": "Remove some explain", "committedDate": "2020-06-22T03:37:34Z", "type": "commit"}, {"oid": "c5eeff0cdaa04f1c86d80190987f05944214b103", "url": "https://github.com/alibaba/nacos/commit/c5eeff0cdaa04f1c86d80190987f05944214b103", "message": "Remove some explain", "committedDate": "2020-06-22T03:39:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM3NjM2MQ==", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443376361", "bodyText": "Do not change the indent.", "author": "KomachiSion", "createdAt": "2020-06-22T07:50:56Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/BaseHttpMethod.java", "diffHunk": "@@ -49,7 +49,7 @@\n  * @author <a href=\"mailto:liaochuntao@live.com\">liaochuntao</a>\n  */\n public enum BaseHttpMethod {\n-    \n+", "originalCommit": "c5eeff0cdaa04f1c86d80190987f05944214b103", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM3Njc0Ng==", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443376746", "bodyText": "do not change indent please", "author": "KomachiSion", "createdAt": "2020-06-22T07:51:40Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/HttpClientBeanHolder.java", "diffHunk": "@@ -34,21 +34,15 @@\n  * @author mai.jh\n  */\n public final class HttpClientBeanHolder {\n-    \n+", "originalCommit": "c5eeff0cdaa04f1c86d80190987f05944214b103", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM4MTk1Mw==", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443381953", "bodyText": "If the tmp variable is only used once, I suggest do not change.", "author": "KomachiSion", "createdAt": "2020-06-22T08:01:32Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/handler/ResponseHandler.java", "diffHunk": "@@ -78,14 +78,22 @@\n         String contentType = headers.getValue(HttpHeaderConsts.CONTENT_TYPE);\n         InputStream body = response.getBody();\n         T extractBody = null;\n+        boolean typeToStr = String.class.toString().equals(type.toString());", "originalCommit": "c5eeff0cdaa04f1c86d80190987f05944214b103", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM4MTk5Nw==", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443381997", "bodyText": "If the tmp variable is only used once, I suggest do not change.", "author": "KomachiSion", "createdAt": "2020-06-22T08:01:37Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/handler/ResponseHandler.java", "diffHunk": "@@ -78,14 +78,22 @@\n         String contentType = headers.getValue(HttpHeaderConsts.CONTENT_TYPE);\n         InputStream body = response.getBody();\n         T extractBody = null;\n+        boolean typeToStr = String.class.toString().equals(type.toString());\n         if (contentType != null && contentType.startsWith(MediaType.APPLICATION_JSON) && HttpStatus.SC_OK == response\n-                .getStatusCode()) {\n-            extractBody = convert(body, type);\n+            .getStatusCode()) {\n+            // When the type is string type and the response contentType is [application/json],\n+            // then it should be serialized as string\n+            if (typeToStr) {\n+                extractBody = (T) IoUtils.toString(body, headers.getCharset());\n+            } else {\n+                extractBody = convert(body, type);\n+            }\n         }\n         if (extractBody == null) {\n-            if (!String.class.toString().equals(type.toString())) {\n+            if (!typeToStr) {", "originalCommit": "c5eeff0cdaa04f1c86d80190987f05944214b103", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM4MzA0OA==", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443383048", "bodyText": "What's the mean of From I read the method think it should be exchangeForm, is it?", "author": "KomachiSion", "createdAt": "2020-06-22T08:03:44Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/client/NacosRestTemplate.java", "diffHunk": "@@ -298,7 +297,29 @@ public NacosRestTemplate(HttpClientRequest requestClient) {\n                 Query.newInstance().initParams(paramValues), bodyValues);\n         return execute(url, HttpMethod.POST, requestHttpEntity, responseType);\n     }\n-    \n+\n+    /**\n+     * Execute the HTTP method to the given URI template, writing the given request entity to the request, and\n+     * returns the response as {@link HttpRestResult}.\n+     *\n+     * @param url          url\n+     * @param header       http header param\n+     * @param paramValues  http query param\n+     * @param bodyValues   http body param\n+     * @param httpMethod   http method\n+     * @param responseType return type\n+     * @return {@link HttpRestResult}\n+     * @throws Exception ex\n+     */\n+    public <T> HttpRestResult<T> exchangeFrom(String url, Header header,", "originalCommit": "c5eeff0cdaa04f1c86d80190987f05944214b103", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM4MzM2Ng==", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443383366", "bodyText": "What's the mean of From I read the method think it should be putFrom, is it?", "author": "KomachiSion", "createdAt": "2020-06-22T08:04:17Z", "path": "test/src/test/java/com/alibaba/nacos/test/naming/NamingBase.java", "diffHunk": "@@ -166,39 +170,32 @@ public static boolean verifyInstanceList(List<Instance> instanceList1, List<Inst\n         return true;\n     }\n \n-    public static void prepareServer(int localPort) {\n+    public static void prepareServer(int localPort) throws Exception{\n         prepareServer(localPort, \"UP\");\n     }\n \n-    public static void prepareServer(int localPort, String status) {\n+    public static void prepareServer(int localPort, String status) throws Exception {\n         String url = \"http://127.0.0.1:\" + localPort + \"/nacos/v1/ns/operator/switches?entry=overriddenServerStatus&value=\" + status;\n-        List<String> headers = new ArrayList<String>();\n-        headers.add(HttpHeaderConsts.USER_AGENT_HEADER);\n-        headers.add(\"Nacos-Server\");\n-        HttpClient.HttpResult result =\n-            HttpClient.request(url, headers, new HashMap<String, String>(), StringUtils.EMPTY, \"UTF-8\", \"PUT\");\n+        Header header = Header.newInstance();\n+        header.addParam(HttpHeaderConsts.USER_AGENT_HEADER, \"Nacos-Server\");\n+        HttpRestResult<String> result = nacosRestTemplate.putFrom(url, header, Query.EMPTY, new HashMap<>(), String.class);\n         System.out.println(result);\n-        Assert.assertEquals(HttpStatus.SC_OK, result.code);\n-\n+        Assert.assertEquals(HttpStatus.SC_OK, result.getCode());\n \n         url = \"http://127.0.0.1:\" + localPort + \"/nacos/v1/ns/operator/switches?entry=autoChangeHealthCheckEnabled&value=\" + false;\n-        headers = new ArrayList<String>();\n-        headers.add(HttpHeaderConsts.USER_AGENT_HEADER);\n-        headers.add(\"Nacos-Server\");\n-        result =\n-            HttpClient.request(url, headers, new HashMap<String, String>(), StringUtils.EMPTY, \"UTF-8\", \"PUT\");\n+\n+        result = nacosRestTemplate.putFrom(url, header, Query.EMPTY, new HashMap<>(), String.class);\n         System.out.println(result);\n-        Assert.assertEquals(HttpStatus.SC_OK, result.code);\n+        Assert.assertEquals(HttpStatus.SC_OK, result.getCode());\n     }\n \n-    public static void destoryServer(int localPort) {\n+    public static void destoryServer(int localPort) throws Exception{\n         String url = \"http://127.0.0.1:\" + localPort + \"/nacos/v1/ns/operator/switches?entry=autoChangeHealthCheckEnabled&value=\" + true;\n-        List<String> headers = new ArrayList<String>();\n-        headers.add(HttpHeaderConsts.USER_AGENT_HEADER);\n-        headers.add(\"Nacos-Server\");\n-        HttpClient.HttpResult result =\n-            HttpClient.request(url, headers, new HashMap<String, String>(), StringUtils.EMPTY, \"UTF-8\", \"PUT\");\n+        Header header = Header.newInstance();\n+        header.addParam(HttpHeaderConsts.USER_AGENT_HEADER, \"Nacos-Server\");\n+\n+        HttpRestResult<String> result = nacosRestTemplate.putFrom(url, header, Query.EMPTY, new HashMap<>(), String.class);", "originalCommit": "c5eeff0cdaa04f1c86d80190987f05944214b103", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0ae37587f1067b1c94553b9ac270451761b461bd", "url": "https://github.com/alibaba/nacos/commit/0ae37587f1067b1c94553b9ac270451761b461bd", "message": "Adjust some code styles and fix some misspelled method names", "committedDate": "2020-06-22T09:54:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ3OTA2OA==", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443479068", "bodyText": "Do not change intend", "author": "KomachiSion", "createdAt": "2020-06-22T10:59:12Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/BaseHttpMethod.java", "diffHunk": "@@ -59,14 +59,14 @@ protected HttpRequestBase createRequest(String url) {\n             return new HttpGet(url);\n         }\n     },\n-    \n+", "originalCommit": "0ae37587f1067b1c94553b9ac270451761b461bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ3OTI2NQ==", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443479265", "bodyText": "Do not change indent", "author": "KomachiSion", "createdAt": "2020-06-22T10:59:31Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/HttpClientBeanHolder.java", "diffHunk": "@@ -36,19 +36,13 @@\n public final class HttpClientBeanHolder {\n     \n     private static final Logger LOGGER = LoggerFactory.getLogger(HttpClientManager.class);\n-    \n-    private static final int TIMEOUT = Integer.getInteger(\"nacos.http.timeout\", 5000);\n-    \n-    private static final HttpClientConfig HTTP_CLIENT_CONFIG = HttpClientConfig.builder().setConTimeOutMillis(TIMEOUT)\n-            .setReadTimeOutMillis(TIMEOUT >> 1).build();\n-    \n+\n     private static final Map<String, NacosRestTemplate> SINGLETON_REST = new HashMap<String, NacosRestTemplate>(10);\n-    \n-    private static final Map<String, NacosAsyncRestTemplate> SINGLETON_ASYNC_REST = new HashMap<String, NacosAsyncRestTemplate>(\n-            10);\n-    \n+\n+    private static final Map<String, NacosAsyncRestTemplate> SINGLETON_ASYNC_REST = new HashMap<String, NacosAsyncRestTemplate>(10);\n+\n     private static final AtomicBoolean ALREADY_SHUTDOWN = new AtomicBoolean(false);\n-    \n+", "originalCommit": "0ae37587f1067b1c94553b9ac270451761b461bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ3OTM4NQ==", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443479385", "bodyText": "Do not change indent", "author": "KomachiSion", "createdAt": "2020-06-22T10:59:44Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/client/HttpClientResponse.java", "diffHunk": "@@ -26,39 +26,38 @@\n  * Represents a client-side HTTP response.\n  *\n  * @author mai.jh\n- * @date 2020/5/23\n  */\n public interface HttpClientResponse extends Closeable {\n-    \n+", "originalCommit": "0ae37587f1067b1c94553b9ac270451761b461bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "662f697b1181cc579615cbee77f1058bf1b5389b", "url": "https://github.com/alibaba/nacos/commit/662f697b1181cc579615cbee77f1058bf1b5389b", "message": "Fix code style issues", "committedDate": "2020-06-22T11:44:06Z", "type": "commit"}, {"oid": "7eb245e15505673261ef72403cd7232a2e7d0473", "url": "https://github.com/alibaba/nacos/commit/7eb245e15505673261ef72403cd7232a2e7d0473", "message": "fix some misspelled method names", "committedDate": "2020-06-22T11:57:26Z", "type": "commit"}, {"oid": "0ef0ca3fca9885dca94be6ebd2c4a59991a396b9", "url": "https://github.com/alibaba/nacos/commit/0ef0ca3fca9885dca94be6ebd2c4a59991a396b9", "message": "Fix code style issues", "committedDate": "2020-06-22T12:16:58Z", "type": "commit"}]}