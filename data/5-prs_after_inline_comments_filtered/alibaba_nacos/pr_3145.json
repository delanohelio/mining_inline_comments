{"pr_number": 3145, "pr_title": "[#3141]Move the related notify test cases code to common module, fix NPE and improve peformance.", "pr_createdAt": "2020-06-22T05:49:32Z", "pr_url": "https://github.com/alibaba/nacos/pull/3145", "timeline": [{"oid": "5e530808ad3c28ca3b1dfc36dea12472c1ec2752", "url": "https://github.com/alibaba/nacos/commit/5e530808ad3c28ca3b1dfc36dea12472c1ec2752", "message": "[#3141]fix typo and move unit test cases codes from core to common module.", "committedDate": "2020-06-22T05:47:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0MjU4Nw==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r443342587", "bodyText": "\u8fd9\u4e2a\u7684\u5b58\u5728\u662f\u56e0\u4e3asharePublisher\uff0c\u5efa\u8baesharePublisher\u91cd\u5199DefaultPublisher\u7684receiveEvent\u65b9\u6cd5\uff0c\u6bd4\u5bf9\u4e8b\u4ef6\u7684\u7b7e\u540d\u4fe1\u606f\uff0c\u907f\u514d\u51fa\u73b0ClassCastException", "author": "chuntaojun", "createdAt": "2020-06-22T06:33:21Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/DefaultPublisher.java", "diffHunk": "@@ -175,10 +175,16 @@ void receiveEvent(Event event) {\n                 continue;\n             }\n             \n-            final String targetName = ClassUtils.getName(subscriber.subscribeType());\n-            if (!Objects.equals(sourceName, targetName)) {\n-                continue;\n+            // Because unifying smartSubscriber and subscriber, so here need to think of compatibility.\n+            // To smartSubscriber, the subscribeType() method returns null by default.\n+            if (subscriber.subscribeType() != null) {\n+                \n+                final String targetName = ClassUtils.getName(subscriber.subscribeType());\n+                if (!Objects.equals(sourceName, targetName)) {", "originalCommit": "5e530808ad3c28ca3b1dfc36dea12472c1ec2752", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aced465e8c8cf87793d4c54147fe67016cde8ddb", "url": "https://github.com/alibaba/nacos/commit/aced465e8c8cf87793d4c54147fe67016cde8ddb", "message": "[#3141]implement DefaultSharePublisher to separate sharePublish from default publisher and fix typo.", "committedDate": "2020-06-22T08:02:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MTYyNg==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r443491626", "bodyText": "Why change it to protected? It seems that there are no subClass.", "author": "KomachiSion", "createdAt": "2020-06-22T11:25:55Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/DefaultPublisher.java", "diffHunk": "@@ -42,21 +40,21 @@\n  */\n public class DefaultPublisher extends Thread implements EventPublisher {\n     \n-    private static final Logger LOGGER = LoggerFactory.getLogger(NotifyCenter.class);\n+    protected static final Logger LOGGER = LoggerFactory.getLogger(NotifyCenter.class);", "originalCommit": "aced465e8c8cf87793d4c54147fe67016cde8ddb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5Mzk1Ng==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r443493956", "bodyText": "I implement DefaultSharePublisher which is a subclass of DefaultPublisher  to separate sharePublish from defaultPublisher.", "author": "zongtanghu", "createdAt": "2020-06-22T11:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MTYyNg=="}], "type": "inlineReview"}, {"oid": "96ade10e2989e82b947834422f7aab21f39f20fc", "url": "https://github.com/alibaba/nacos/commit/96ade10e2989e82b947834422f7aab21f39f20fc", "message": "[#3141]fix typo and NPE issue.", "committedDate": "2020-06-23T06:50:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NzE3MQ==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r443597171", "bodyText": "SmartSubscriber\u4ecd\u7136\u4f1a\u6709\u95ee\u9898", "author": "chuntaojun", "createdAt": "2020-06-22T14:25:18Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/DefaultSharePublisher.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.notify;\n+\n+import com.alibaba.nacos.common.notify.listener.Subscriber;\n+import com.alibaba.nacos.common.utils.ClassUtils;\n+import com.alibaba.nacos.common.utils.Objects;\n+\n+/**\n+ * The default share event publisher implementation for slow event.\n+ *\n+ * @author zongtanghu\n+ */\n+public class DefaultSharePublisher extends DefaultPublisher {\n+    \n+    @Override\n+    public void receiveEvent(Event event) {\n+        final long currentEventSequence = event.sequence();\n+        final String sourceName = ClassUtils.getName(event);\n+        \n+        // Notification single event listener\n+        for (Subscriber subscriber : subscribers) {\n+            // Whether to ignore expiration events\n+            if (subscriber.ignoreExpireEvent() && lastEventSequence > currentEventSequence) {\n+                LOGGER.debug(\"[NotifyCenter] the {} is unacceptable to this subscriber, because had expire\",\n+                        event.getClass());\n+                continue;\n+            }\n+            \n+            final String targetName = ClassUtils.getName(subscriber.subscribeType());", "originalCommit": "aced465e8c8cf87793d4c54147fe67016cde8ddb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAxNDA3Mw==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444014073", "bodyText": "The code has already adjusted by previous commit.", "author": "zongtanghu", "createdAt": "2020-06-23T07:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NzE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAxMjAxNg==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444012016", "bodyText": "\u6216\u8bb8\u8fd9\u91cc\u53ef\u4ee5\u5728\u52a0\u901f\u4e0b\u6027\u80fd\uff0cMap<Class<? extends SlowEvent>, Set>, \u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u6bcf\u4e2a\u90fd\u53bbequals", "author": "chuntaojun", "createdAt": "2020-06-23T07:18:24Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/DefaultSharePublisher.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.notify;\n+\n+import com.alibaba.nacos.common.notify.listener.SmartSubscriber;\n+import com.alibaba.nacos.common.notify.listener.Subscriber;\n+import com.alibaba.nacos.common.utils.ClassUtils;\n+import com.alibaba.nacos.common.utils.Objects;\n+\n+/**\n+ * The default share event publisher implementation for slow event.\n+ *\n+ * @author zongtanghu\n+ */\n+public class DefaultSharePublisher extends DefaultPublisher {", "originalCommit": "96ade10e2989e82b947834422f7aab21f39f20fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0NjQ0MQ==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444146441", "bodyText": "The part codes of improving peformance has already been committed.", "author": "zongtanghu", "createdAt": "2020-06-23T11:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAxMjAxNg=="}], "type": "inlineReview"}, {"oid": "f7901269fa3b5ddc181c62798aa817b0e588ec2d", "url": "https://github.com/alibaba/nacos/commit/f7901269fa3b5ddc181c62798aa817b0e588ec2d", "message": "[#3141]improve performance and fix typo.", "committedDate": "2020-06-23T11:09:50Z", "type": "commit"}, {"oid": "9c337a86b0a4b357f4cb785dc62a2c1432e4112b", "url": "https://github.com/alibaba/nacos/commit/9c337a86b0a4b357f4cb785dc62a2c1432e4112b", "message": "[#3141]add removeSubscriber logical codes.", "committedDate": "2020-06-23T12:00:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI1OTcxMw==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444259713", "bodyText": "ut test method also use Camel Naming", "author": "KomachiSion", "createdAt": "2020-06-23T14:17:55Z", "path": "common/src/test/java/com/alibaba/nacos/common/notify/NotifyCenterTest.java", "diffHunk": "@@ -0,0 +1,538 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.notify;\n+\n+import com.alibaba.nacos.common.notify.listener.SmartSubscriber;\n+import com.alibaba.nacos.common.notify.listener.Subscriber;\n+import com.alibaba.nacos.common.utils.ThreadUtils;\n+import org.junit.Assert;\n+import org.junit.FixMethodOrder;\n+import org.junit.Test;\n+import org.junit.runners.MethodSorters;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+/**\n+ * @author <a href=\"mailto:liaochuntao@live.com\">liaochuntao</a>\n+ * @author zongtanghu\n+ */\n+@FixMethodOrder(value = MethodSorters.NAME_ASCENDING)\n+public class NotifyCenterTest {\n+    \n+    private static class TestSlowEvent extends SlowEvent {\n+    }\n+    \n+    private static class TestEvent extends Event {\n+        \n+        @Override\n+        public long sequence() {\n+            return System.currentTimeMillis();\n+        }\n+    }\n+    \n+    static {\n+        System.setProperty(\"nacos.core.notify.share-buffer-size\", \"8\");\n+    }\n+    \n+    @Test\n+    public void test_a_event_can_listen() throws Exception {", "originalCommit": "9c337a86b0a4b357f4cb785dc62a2c1432e4112b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5Mjg0MA==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444592840", "bodyText": "Yeah, I have already renamed these ut test method name in next commit, please review again, thanks.", "author": "zongtanghu", "createdAt": "2020-06-24T01:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI1OTcxMw=="}], "type": "inlineReview"}, {"oid": "82d5e11b8fb7de71715e15b5a27ccd32a37feef7", "url": "https://github.com/alibaba/nacos/commit/82d5e11b8fb7de71715e15b5a27ccd32a37feef7", "message": "[#3141]rename the unit test method's names.", "committedDate": "2020-06-24T01:15:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYwNTQ4Ng==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444605486", "bodyText": "\u8fd9\u5e94\u8be5\u662fDefaultSharePublisher\u7279\u6709\u7684\u65b9\u6cd5\u624d\u662f", "author": "chuntaojun", "createdAt": "2020-06-24T02:13:12Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/DefaultPublisher.java", "diffHunk": "@@ -125,12 +127,12 @@ private boolean hasSubscriber() {\n     }\n     \n     @Override\n-    public void addSubscriber(Subscriber subscriber) {\n+    public void addSubscriber(Subscriber subscriber, Class<? extends Event> subscribeType) {", "originalCommit": "82d5e11b8fb7de71715e15b5a27ccd32a37feef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxMjI3OQ==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444612279", "bodyText": "Okay, I will adjust this codes.", "author": "zongtanghu", "createdAt": "2020-06-24T02:39:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYwNTQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYwNTY4MQ==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444605681", "bodyText": "\u8fd9\u91cc\u4e3a\u4ec0\u4e48\u8981\u8c03\u6574\u4e3apublic\u4fee\u9970\uff1f", "author": "chuntaojun", "createdAt": "2020-06-24T02:13:56Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/DefaultPublisher.java", "diffHunk": "@@ -162,9 +164,13 @@ public boolean isInitialized() {\n         return initialized;\n     }\n     \n-    void receiveEvent(Event event) {\n+    /**\n+     * Receive and notifySubscriber to process the event.\n+     *\n+     * @param event {@link Event}.\n+     */\n+    public void receiveEvent(Event event) {", "originalCommit": "82d5e11b8fb7de71715e15b5a27ccd32a37feef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxMjM0NA==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444612344", "bodyText": "I will revert this part.", "author": "zongtanghu", "createdAt": "2020-06-24T02:39:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYwNTY4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYwNjEyMg==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444606122", "bodyText": "\u8fd9\u91cc\u5e76\u975e\u539f\u5b50\u64cd\u4f5c\uff0c\u9700\u8981\u6ce8\u610f", "author": "chuntaojun", "createdAt": "2020-06-24T02:15:35Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/DefaultSharePublisher.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.notify;\n+\n+import com.alibaba.nacos.common.notify.listener.Subscriber;\n+import com.alibaba.nacos.common.utils.ConcurrentHashSet;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * The default share event publisher implementation for slow event.\n+ *\n+ * @author zongtanghu\n+ */\n+public class DefaultSharePublisher extends DefaultPublisher {\n+    \n+    private final Map<Class<? extends SlowEvent>, Set<Subscriber>> subMappings = new ConcurrentHashMap<Class<? extends SlowEvent>, Set<Subscriber>>();\n+    \n+    @Override\n+    public void addSubscriber(Subscriber subscriber, Class<? extends Event> subscribeType) {\n+        // Actually, do a classification based on the slowEvent type.\n+        Class<? extends SlowEvent> subSlowEventType = (Class<? extends SlowEvent>) subscribeType;\n+        // For adding to parent class attributes synchronization.\n+        subscribers.add(subscriber);\n+        Set<Subscriber> sets = subMappings.get(subSlowEventType);\n+        \n+        if (sets == null) {\n+            Set<Subscriber> newSet = new ConcurrentHashSet<Subscriber>();\n+            newSet.add(subscriber);\n+            subMappings.put(subSlowEventType, newSet);\n+            return;\n+        }\n+        \n+        sets.add(subscriber);\n+    }\n+    \n+    @Override\n+    public void removeSubscriber(Subscriber subscriber, Class<? extends Event> subscribeType) {\n+        // Actually, do a classification based on the slowEvent type.\n+        Class<? extends SlowEvent> subSlowEventType = (Class<? extends SlowEvent>) subscribeType;\n+        // For removing to parent class attributes synchronization.\n+        subscribers.remove(subscriber);\n+    \n+        Set<Subscriber> sets = subMappings.get(subSlowEventType);\n+    \n+        if (sets != null && sets.contains(subscriber)) {\n+            sets.remove(subscriber);\n+            if (sets.isEmpty()) {", "originalCommit": "82d5e11b8fb7de71715e15b5a27ccd32a37feef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODgyNg==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444638826", "bodyText": "I revert this codes and fix the other same issue.", "author": "zongtanghu", "createdAt": "2020-06-24T04:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYwNjEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYwNjM1Mg==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444606352", "bodyText": "\u540c\u4e0a\uff0c\u8fd9\u4e2a\u63a5\u53e3\u672c\u4e0d\u662f\u4e00\u4e2a\u516c\u5171\u63a5\u53e3\uff0c\u4ed6\u53ea\u662f\u9002\u7528\u4e8eSharePublisher", "author": "chuntaojun", "createdAt": "2020-06-24T02:16:22Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/EventPublisher.java", "diffHunk": "@@ -46,15 +46,17 @@\n      * Add listener.\n      *\n      * @param subscriber {@link Subscriber}\n+     * @param subscribeType type of subscribe\n      */\n-    void addSubscriber(Subscriber subscriber);\n+    void addSubscriber(Subscriber subscriber, Class<? extends Event> subscribeType);", "originalCommit": "82d5e11b8fb7de71715e15b5a27ccd32a37feef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxMjI5MQ==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444612291", "bodyText": "Okay, I will adjust this codes.", "author": "zongtanghu", "createdAt": "2020-06-24T02:39:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYwNjM1Mg=="}], "type": "inlineReview"}, {"oid": "f21146470ac7429dfdcaf56000ee4b7698a85c50", "url": "https://github.com/alibaba/nacos/commit/f21146470ac7429dfdcaf56000ee4b7698a85c50", "message": "[#3141]fix typo.", "committedDate": "2020-06-24T02:58:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDQ5MQ==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444634491", "bodyText": "\u8fd9\u91cc\u53ef\u80fd\u8fd8\u662f\u4f1a\u6709\u539f\u5b50\u6027\u7684\u95ee\u9898\uff0c\u53ef\u80fd\u5b58\u5728\u4e24\u4e2a\u7ebf\u7a0b\u540c\u65f6\u53bbaddSubscriber\uff0cget\u540e\u7684\u7ed3\u679c\u540c\u65f6\u4e3anull", "author": "chuntaojun", "createdAt": "2020-06-24T04:14:08Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/DefaultSharePublisher.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.notify;\n+\n+import com.alibaba.nacos.common.notify.listener.Subscriber;\n+import com.alibaba.nacos.common.utils.ConcurrentHashSet;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * The default share event publisher implementation for slow event.\n+ *\n+ * @author zongtanghu\n+ */\n+public class DefaultSharePublisher extends DefaultPublisher {\n+    \n+    private final Map<Class<? extends SlowEvent>, Set<Subscriber>> subMappings = new ConcurrentHashMap<Class<? extends SlowEvent>, Set<Subscriber>>();\n+    \n+    /**\n+     * Add listener for default share publisher.\n+     *\n+     * @param subscriber {@link Subscriber}\n+     * @param subscribeType subscribe event type, such as slow event or general event.\n+     */\n+    public void addSubscriber(Subscriber subscriber, Class<? extends Event> subscribeType) {\n+        // Actually, do a classification based on the slowEvent type.\n+        Class<? extends SlowEvent> subSlowEventType = (Class<? extends SlowEvent>) subscribeType;\n+        // For adding to parent class attributes synchronization.\n+        subscribers.add(subscriber);\n+        Set<Subscriber> sets = subMappings.get(subSlowEventType);", "originalCommit": "f21146470ac7429dfdcaf56000ee4b7698a85c50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzOTAwNw==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444639007", "bodyText": "I will fix and resolve the same other issue.", "author": "zongtanghu", "createdAt": "2020-06-24T04:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDY4OA==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444634688", "bodyText": "\u8fd9\u91cc\u5e94\u8be5\u4e0d\u518d\u9700\u8981\u8c03\u7528 subscribers.add(subscriber)", "author": "chuntaojun", "createdAt": "2020-06-24T04:14:54Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/DefaultSharePublisher.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.notify;\n+\n+import com.alibaba.nacos.common.notify.listener.Subscriber;\n+import com.alibaba.nacos.common.utils.ConcurrentHashSet;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * The default share event publisher implementation for slow event.\n+ *\n+ * @author zongtanghu\n+ */\n+public class DefaultSharePublisher extends DefaultPublisher {\n+    \n+    private final Map<Class<? extends SlowEvent>, Set<Subscriber>> subMappings = new ConcurrentHashMap<Class<? extends SlowEvent>, Set<Subscriber>>();\n+    \n+    /**\n+     * Add listener for default share publisher.\n+     *\n+     * @param subscriber {@link Subscriber}\n+     * @param subscribeType subscribe event type, such as slow event or general event.\n+     */\n+    public void addSubscriber(Subscriber subscriber, Class<? extends Event> subscribeType) {\n+        // Actually, do a classification based on the slowEvent type.\n+        Class<? extends SlowEvent> subSlowEventType = (Class<? extends SlowEvent>) subscribeType;\n+        // For adding to parent class attributes synchronization.\n+        subscribers.add(subscriber);", "originalCommit": "f21146470ac7429dfdcaf56000ee4b7698a85c50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODYyMg==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444638622", "bodyText": "I suggest to retain.", "author": "zongtanghu", "createdAt": "2020-06-24T04:33:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDc4Ng==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444634786", "bodyText": "\u540c\u7406\uff0c\u8fd9\u4e2a\u4e5f\u4e0d\u518d\u9700\u8981\u8c03\u7528\u4e86", "author": "chuntaojun", "createdAt": "2020-06-24T04:15:16Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/DefaultSharePublisher.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.notify;\n+\n+import com.alibaba.nacos.common.notify.listener.Subscriber;\n+import com.alibaba.nacos.common.utils.ConcurrentHashSet;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * The default share event publisher implementation for slow event.\n+ *\n+ * @author zongtanghu\n+ */\n+public class DefaultSharePublisher extends DefaultPublisher {\n+    \n+    private final Map<Class<? extends SlowEvent>, Set<Subscriber>> subMappings = new ConcurrentHashMap<Class<? extends SlowEvent>, Set<Subscriber>>();\n+    \n+    /**\n+     * Add listener for default share publisher.\n+     *\n+     * @param subscriber {@link Subscriber}\n+     * @param subscribeType subscribe event type, such as slow event or general event.\n+     */\n+    public void addSubscriber(Subscriber subscriber, Class<? extends Event> subscribeType) {\n+        // Actually, do a classification based on the slowEvent type.\n+        Class<? extends SlowEvent> subSlowEventType = (Class<? extends SlowEvent>) subscribeType;\n+        // For adding to parent class attributes synchronization.\n+        subscribers.add(subscriber);\n+        Set<Subscriber> sets = subMappings.get(subSlowEventType);\n+        \n+        if (sets == null) {\n+            Set<Subscriber> newSet = new ConcurrentHashSet<Subscriber>();\n+            newSet.add(subscriber);\n+            subMappings.put(subSlowEventType, newSet);\n+            return;\n+        }\n+        \n+        sets.add(subscriber);\n+    }\n+    \n+    /**\n+     * Remove listener for default share publisher.\n+     *\n+     * @param subscriber {@link Subscriber}\n+     * @param subscribeType subscribe event type, such as slow event or general event.\n+     */\n+    public void removeSubscriber(Subscriber subscriber, Class<? extends Event> subscribeType) {\n+        // Actually, do a classification based on the slowEvent type.\n+        Class<? extends SlowEvent> subSlowEventType = (Class<? extends SlowEvent>) subscribeType;\n+        // For removing to parent class attributes synchronization.\n+        subscribers.remove(subscriber);", "originalCommit": "f21146470ac7429dfdcaf56000ee4b7698a85c50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODYzMw==", "url": "https://github.com/alibaba/nacos/pull/3145#discussion_r444638633", "bodyText": "I suggest to retain.", "author": "zongtanghu", "createdAt": "2020-06-24T04:33:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDc4Ng=="}], "type": "inlineReview"}, {"oid": "494d7218ff3fc250908cc682d0dc7435dd12d61e", "url": "https://github.com/alibaba/nacos/commit/494d7218ff3fc250908cc682d0dc7435dd12d61e", "message": "[#3141]fix thread unsafe and atomic issue.", "committedDate": "2020-06-24T07:51:00Z", "type": "commit"}]}