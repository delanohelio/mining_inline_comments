{"pr_number": 3348, "pr_title": "[ISSUE #3224]nacos-client module http client replace", "pr_createdAt": "2020-07-16T02:08:13Z", "pr_url": "https://github.com/alibaba/nacos/pull/3348", "timeline": [{"oid": "7144c74c65a09cf1cee19969e915b3729ba006e2", "url": "https://github.com/alibaba/nacos/commit/7144c74c65a09cf1cee19969e915b3729ba006e2", "message": "nacos-client module http client replace", "committedDate": "2020-07-16T01:49:20Z", "type": "commit"}, {"oid": "c3557a705f944cdae33fdb628098f2fb68369358", "url": "https://github.com/alibaba/nacos/commit/c3557a705f944cdae33fdb628098f2fb68369358", "message": "fix code style problem", "committedDate": "2020-07-16T02:16:44Z", "type": "commit"}, {"oid": "2e60fd0105c676a10eb28035515bc0315d19c008", "url": "https://github.com/alibaba/nacos/commit/2e60fd0105c676a10eb28035515bc0315d19c008", "message": "Merge remote-tracking branch 'origin/refactor_config_http_client' into refactor_config_http_client", "committedDate": "2020-07-16T02:16:51Z", "type": "commit"}, {"oid": "45c19b10daaa6869728d91b07e12ba517b0d55e1", "url": "https://github.com/alibaba/nacos/commit/45c19b10daaa6869728d91b07e12ba517b0d55e1", "message": "add HashMap initialCapacity", "committedDate": "2020-07-16T04:01:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NjU3NQ==", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455656575", "bodyText": "do not change intend please", "author": "KomachiSion", "createdAt": "2020-07-16T09:36:12Z", "path": "client/src/main/java/com/alibaba/nacos/client/config/NacosConfigService.java", "diffHunk": "@@ -226,54 +222,46 @@ private boolean publishConfigInner(String tenant, String dataId, String group, S\n         cr.setContent(content);\n         configFilterChainManager.doFilter(cr, null);\n         content = cr.getContent();\n-        \n+", "originalCommit": "45c19b10daaa6869728d91b07e12ba517b0d55e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NjkwMA==", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455656900", "bodyText": "do not change intend please", "author": "KomachiSion", "createdAt": "2020-07-16T09:36:42Z", "path": "client/src/main/java/com/alibaba/nacos/client/config/NacosConfigService.java", "diffHunk": "@@ -226,54 +222,46 @@ private boolean publishConfigInner(String tenant, String dataId, String group, S\n         cr.setContent(content);\n         configFilterChainManager.doFilter(cr, null);\n         content = cr.getContent();\n-        \n+\n         String url = Constants.CONFIG_CONTROLLER_PATH;\n-        List<String> params = new ArrayList<String>();\n-        params.add(\"dataId\");\n-        params.add(dataId);\n-        params.add(\"group\");\n-        params.add(group);\n-        params.add(\"content\");\n-        params.add(content);\n+        Map<String, String> params = new HashMap<String, String>(6);\n+        params.put(\"dataId\", dataId);\n+        params.put(\"group\", group);\n+        params.put(\"content\", content);\n         if (StringUtils.isNotEmpty(tenant)) {\n-            params.add(\"tenant\");\n-            params.add(tenant);\n+            params.put(\"tenant\", tenant);\n         }\n         if (StringUtils.isNotEmpty(appName)) {\n-            params.add(\"appName\");\n-            params.add(appName);\n+            params.put(\"appName\", appName);\n         }\n         if (StringUtils.isNotEmpty(tag)) {\n-            params.add(\"tag\");\n-            params.add(tag);\n+            params.put(\"tag\", tag);\n         }\n-        \n-        List<String> headers = new ArrayList<String>();\n+        Map<String, String> headers = new HashMap<String, String>(1);\n         if (StringUtils.isNotEmpty(betaIps)) {\n-            headers.add(\"betaIps\");\n-            headers.add(betaIps);\n+            headers.put(\"betaIps\", betaIps);\n         }\n-        \n-        HttpResult result = null;\n+", "originalCommit": "45c19b10daaa6869728d91b07e12ba517b0d55e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NjkzOQ==", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455656939", "bodyText": "do not change intend please", "author": "KomachiSion", "createdAt": "2020-07-16T09:36:46Z", "path": "client/src/main/java/com/alibaba/nacos/client/config/NacosConfigService.java", "diffHunk": "@@ -226,54 +222,46 @@ private boolean publishConfigInner(String tenant, String dataId, String group, S\n         cr.setContent(content);\n         configFilterChainManager.doFilter(cr, null);\n         content = cr.getContent();\n-        \n+\n         String url = Constants.CONFIG_CONTROLLER_PATH;\n-        List<String> params = new ArrayList<String>();\n-        params.add(\"dataId\");\n-        params.add(dataId);\n-        params.add(\"group\");\n-        params.add(group);\n-        params.add(\"content\");\n-        params.add(content);\n+        Map<String, String> params = new HashMap<String, String>(6);\n+        params.put(\"dataId\", dataId);\n+        params.put(\"group\", group);\n+        params.put(\"content\", content);\n         if (StringUtils.isNotEmpty(tenant)) {\n-            params.add(\"tenant\");\n-            params.add(tenant);\n+            params.put(\"tenant\", tenant);\n         }\n         if (StringUtils.isNotEmpty(appName)) {\n-            params.add(\"appName\");\n-            params.add(appName);\n+            params.put(\"appName\", appName);\n         }\n         if (StringUtils.isNotEmpty(tag)) {\n-            params.add(\"tag\");\n-            params.add(tag);\n+            params.put(\"tag\", tag);\n         }\n-        \n-        List<String> headers = new ArrayList<String>();\n+        Map<String, String> headers = new HashMap<String, String>(1);\n         if (StringUtils.isNotEmpty(betaIps)) {\n-            headers.add(\"betaIps\");\n-            headers.add(betaIps);\n+            headers.put(\"betaIps\", betaIps);\n         }\n-        \n-        HttpResult result = null;\n+\n+        HttpRestResult<String> result = null;\n         try {\n             result = agent.httpPost(url, headers, params, encode, POST_TIMEOUT);\n-        } catch (IOException ioe) {\n-            LOGGER.warn(\"[{}] [publish-single] exception, dataId={}, group={}, msg={}\", agent.getName(), dataId, group,\n-                    ioe.toString());\n+        } catch (Exception ex) {\n+            LOGGER.warn(\"[{}] [publish-single] exception, dataId={}, group={}, msg={}\", agent.getName(), dataId,\n+                group, ex.toString());\n             return false;\n         }\n-        \n-        if (HttpURLConnection.HTTP_OK == result.code) {\n+", "originalCommit": "45c19b10daaa6869728d91b07e12ba517b0d55e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1OTk1MQ==", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455659951", "bodyText": "Where are these logic from?", "author": "KomachiSion", "createdAt": "2020-07-16T09:41:49Z", "path": "client/src/main/java/com/alibaba/nacos/client/config/http/ServerHttpAgent.java", "diffHunk": "@@ -358,29 +354,37 @@ public void start() throws NacosException {\n         serverListMgr.start();\n     }\n     \n-    private List<String> getSpasHeaders(List<String> paramValues) throws IOException {\n-        List<String> newHeaders = new ArrayList<String>();\n+    private Header getSpasHeaders(Map<String, String> paramValues, String encode) throws Exception {\n+        Header header = Header.newInstance();\n         // STS \u4e34\u65f6\u51ed\u8bc1\u9274\u6743\u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e AK/SK \u9274\u6743\n         if (StsConfig.getInstance().isStsOn()) {\n             StsCredential stsCredential = getStsCredential();\n             accessKey = stsCredential.accessKeyId;\n             secretKey = stsCredential.accessKeySecret;\n-            newHeaders.add(\"Spas-SecurityToken\");\n-            newHeaders.add(stsCredential.securityToken);\n+            header.addParam(\"Spas-SecurityToken\", stsCredential.securityToken);\n         }\n         \n         if (StringUtils.isNotEmpty(accessKey) && StringUtils.isNotEmpty(secretKey)) {\n-            newHeaders.add(\"Spas-AccessKey\");\n-            newHeaders.add(accessKey);\n-            List<String> signHeaders = SpasAdapter.getSignHeaders(paramValues, secretKey);\n+            header.addParam(\"Spas-AccessKey\", accessKey);\n+            Map<String, String> signHeaders = SpasAdapter.getSignHeaders(paramValues, secretKey);\n             if (signHeaders != null) {\n-                newHeaders.addAll(signHeaders);\n+                header.addAll(signHeaders);\n             }\n         }\n-        return newHeaders;\n+        String ts = String.valueOf(System.currentTimeMillis());\n+        String token = MD5Utils.md5Hex(ts + ParamUtil.getAppKey(), Constants.ENCODE);\n+        \n+        header.addParam(Constants.CLIENT_APPNAME_HEADER, ParamUtil.getAppName());", "originalCommit": "45c19b10daaa6869728d91b07e12ba517b0d55e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4Mjg0Mg==", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455682842", "bodyText": "This logic comes from the old HttpSimpleClient#setHeaders method.", "author": "Maijh97", "createdAt": "2020-07-16T10:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1OTk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY3MzgxNQ==", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455673815", "bodyText": "Is these method refactor correctly? I see the input is come from httpclient.", "author": "KomachiSion", "createdAt": "2020-07-16T10:04:57Z", "path": "client/src/main/java/com/alibaba/nacos/client/utils/EnvUtil.java", "diffHunk": "@@ -30,45 +28,42 @@\n     \n     public static final Logger LOGGER = LogUtils.logger(EnvUtil.class);\n     \n-    public static void setSelfEnv(Map<String, List<String>> headers) {\n+    public static void setSelfEnv(Header headers) {", "originalCommit": "45c19b10daaa6869728d91b07e12ba517b0d55e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY5MTI3NQ==", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455691275", "bodyText": "Correct, the original input is also from the http client, this method is called by the ServerListManager#getApacheServerList method.", "author": "Maijh97", "createdAt": "2020-07-16T10:37:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY3MzgxNQ=="}], "type": "inlineReview"}, {"oid": "08e675468e00d59255f371a83224572d6a8b1ef1", "url": "https://github.com/alibaba/nacos/commit/08e675468e00d59255f371a83224572d6a8b1ef1", "message": "fix code style problem", "committedDate": "2020-07-16T10:37:57Z", "type": "commit"}, {"oid": "f1f2af01408796cc40028c361fd5902523099b40", "url": "https://github.com/alibaba/nacos/commit/f1f2af01408796cc40028c361fd5902523099b40", "message": "Modify the header object, keep the original response header to avoid modifying the original logic code", "committedDate": "2020-07-16T13:57:59Z", "type": "commit"}, {"oid": "bed8561f2156513f2d3bc60e2ccabd39089d57b0", "url": "https://github.com/alibaba/nacos/commit/bed8561f2156513f2d3bc60e2ccabd39089d57b0", "message": "fix code style problem", "committedDate": "2020-07-16T14:04:12Z", "type": "commit"}, {"oid": "2c841f6d905198dcb384af6f5fd05a6fd2b87b52", "url": "https://github.com/alibaba/nacos/commit/2c841f6d905198dcb384af6f5fd05a6fd2b87b52", "message": "naming http client request exception messages output change", "committedDate": "2020-07-17T15:20:37Z", "type": "commit"}, {"oid": "7907b98e5f4ecdf10622e04792d9dbbfcac2be22", "url": "https://github.com/alibaba/nacos/commit/7907b98e5f4ecdf10622e04792d9dbbfcac2be22", "message": "Merge branch 'develop-upstrem' into refactor_config_http_client\n\n# Conflicts:\n#\tclient/src/main/java/com/alibaba/nacos/client/config/impl/ServerListManager.java", "committedDate": "2020-07-17T15:27:55Z", "type": "commit"}, {"oid": "7efc8001be3c3dc12733f5b0185379fbba184815", "url": "https://github.com/alibaba/nacos/commit/7efc8001be3c3dc12733f5b0185379fbba184815", "message": "Merge code", "committedDate": "2020-07-17T15:28:37Z", "type": "commit"}]}