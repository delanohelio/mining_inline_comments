{"pr_number": 4536, "pr_title": "[ISSUE #3406] fix change self's password fail", "pr_createdAt": "2020-12-21T14:30:10Z", "pr_url": "https://github.com/alibaba/nacos/pull/4536", "timeline": [{"oid": "719b69a653da9415e0642269d5c0d901c95b8caf", "url": "https://github.com/alibaba/nacos/commit/719b69a653da9415e0642269d5c0d901c95b8caf", "message": "fix change self's password fail", "committedDate": "2020-12-21T14:22:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNzU1Mw==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r547917553", "bodyText": "use com.alibaba.nacos.common.utils.StringUtil#isBlank  will be better, I think", "author": "KomachiSion", "createdAt": "2020-12-23T11:42:28Z", "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {", "originalCommit": "719b69a653da9415e0642269d5c0d901c95b8caf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk0NzE2NA==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r547947164", "bodyText": "use util is better , but it is an object.  I will use com.alibaba.nacos.common.utils.Objects#isNull", "author": "haoyann", "createdAt": "2020-12-23T12:59:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNzU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUxNDM3OQ==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r548514379", "bodyText": "If nacos_user_key is \"\", whether it return false directly?", "author": "KomachiSion", "createdAt": "2020-12-24T12:21:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNzU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r547919040", "bodyText": "I think this implementation will cause security problem. If you get admin from user input, users can mock or inject this value so that they can change others' password.", "author": "KomachiSion", "createdAt": "2020-12-23T11:46:21Z", "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {\n+            return false;\n+        }\n+\n+        NacosUser user = (NacosUser) request.getAttribute(RequestUtil.NACOS_USER_KEY);\n+        // admin\n+        if (user.isGlobalAdmin()) {\n+            return true;\n+        }", "originalCommit": "719b69a653da9415e0642269d5c0d901c95b8caf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk0NzE4Mg==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r547947182", "bodyText": "The current version also has this problem, because admin can modify the password of other users.I just kept this feature.", "author": "haoyann", "createdAt": "2020-12-23T12:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUxNDA5NA==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r548514094", "bodyText": "But current judge admin has auth to change other password is used the role queried by datasource.\nYour implementation is used the request input. If I'm not admin, but I call this API with myself input. I will change other's password.\nI am not saying that there is a problem with this function, I just describe that your implementation allows other non-admin users to modify the passwords of other users.", "author": "KomachiSion", "createdAt": "2020-12-24T12:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0MTEzMw==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r548541133", "bodyText": "\u62b1\u6b49\uff0c\u6211\u4e0d\u662f\u5f88\u660e\u767d\u60a8\u201cI call this API with myself input. I will change other's password\u201d\u8fd9\u91cc\u8868\u8fbe\u7684\u610f\u601d\uff0c\u56e0\u4e3a\u6211\u770b\u4ee3\u7801\u5728com.alibaba.nacos.core.auth.AuthFilter#doFilter\u8fd9\u91cc\u4f1a\u8c03\u7528\u65b9\u6cd5com.alibaba.nacos.console.senicurity.nacos.NacosAuthManager#login,\u8fd9\u91cc\u5b83\u5c06\u8bbe\u7f6eNACOS_USER_KEY\n        List<RoleInfo> roleInfoList = roleService.getRoles(username);\n        if (roleInfoList != null) {\n            for (RoleInfo roleInfo : roleInfoList) {\n                if (roleInfo.getRole().equals(NacosRoleServiceImpl.GLOBAL_ADMIN_ROLE)) {\n                    user.setGlobalAdmin(true);\n                    break;\n                }\n            }\n        }\n        req.setAttribute(RequestUtil.NACOS_USER_KEY, user);\n\n\u5728\u6211\u7684\u7406\u89e3\u91cc\uff0c\u6211\u5728\u540e\u7eed\u4ecerequest\u4e2d\u53d6\u51fa\u7684NACOS_USER_KEY\u662f\u5df2\u7ecf\u8ba4\u8bc1\u8fc7\u540e\u7684\u7528\u6237\u4fe1\u606f\u3002\u6216\u8bb8\u6709\u54ea\u4e9b\u5730\u65b9\u6211\u6ca1\u6709\u8003\u8651\u5230\u7684\uff0c\u4f1a\u9020\u6210\u60a8\u6240\u8bf4\u7684\u5b89\u5168\u95ee\u9898\u3002\n\u5982\u662f\u786e\u5b9e\u5b58\u5728\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u5728\u8fd9\u91cc\u8ba4\u8bc1\u7684\u65f6\u5019\u8c03\u7528com.alibaba.nacos.console.senicurity.nacos.NacosAuthManager#login\u8fd9\u4e2a\u65b9\u6cd5\u83b7\u53d6\u7528\u6237\u4fe1\u606f\uff0c\u8fd9\u6837\u5e94\u8be5\u4fdd\u9669\u7684\u3002", "author": "haoyann", "createdAt": "2020-12-24T14:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk1NjUwMw==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r548956503", "bodyText": "\u5982\u679c\u662f\u4eceAuthFilter\u4e2d\u8986\u76d6\u7684\u5e94\u8be5\u4e5f\u53ef\u4ee5\u3002", "author": "KomachiSion", "createdAt": "2020-12-26T07:54:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MDU5MA==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r548960590", "bodyText": "\u90a3\u73b0\u5728\u6211\u9700\u8981\u505a\u4ec0\u4e48\u5462 : )", "author": "haoyann", "createdAt": "2020-12-26T08:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA2NDk3Ng==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r549064976", "bodyText": "\u4e0a\u9762\u90a3\u4e2a\u95ee\u9898\uff0c \u9700\u4e0d\u9700\u8981\u6362\u6210\u5de5\u5177\u7c7b\u5224\u65ad\uff1f", "author": "KomachiSion", "createdAt": "2020-12-27T04:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA2NTgzOQ==", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r549065839", "bodyText": "done", "author": "haoyann", "createdAt": "2020-12-27T05:02:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}], "type": "inlineReview"}, {"oid": "775715ad649ad6a720d4e21e1a1a41a1e4dbe7f4", "url": "https://github.com/alibaba/nacos/commit/775715ad649ad6a720d4e21e1a1a41a1e4dbe7f4", "message": "refactor use util Objects", "committedDate": "2020-12-27T04:56:55Z", "type": "commit"}]}