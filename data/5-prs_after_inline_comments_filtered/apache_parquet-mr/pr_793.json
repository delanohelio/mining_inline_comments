{"pr_number": 793, "pr_title": "PARQUET-1866: Replace Hadoop ZSTD with JNI-ZSTD", "pr_createdAt": "2020-05-21T21:11:34Z", "pr_url": "https://github.com/apache/parquet-mr/pull/793", "timeline": [{"oid": "c8169fe3886ed5365e598a80d34ed20518d8baed", "url": "https://github.com/apache/parquet-mr/commit/c8169fe3886ed5365e598a80d34ed20518d8baed", "message": "PARQUET-1866: Replace Hadoop ZSTD with JNI-ZSTD", "committedDate": "2020-05-21T21:57:34Z", "type": "forcePushed"}, {"oid": "a99c7200d508f38326e58504da1279623f757d1c", "url": "https://github.com/apache/parquet-mr/commit/a99c7200d508f38326e58504da1279623f757d1c", "message": "PARQUET-1866: Replace Hadoop ZSTD with JNI-ZSTD", "committedDate": "2020-05-21T23:26:21Z", "type": "forcePushed"}, {"oid": "4c264fc063fbd17f8e068060d8c1713083bcf3d2", "url": "https://github.com/apache/parquet-mr/commit/4c264fc063fbd17f8e068060d8c1713083bcf3d2", "message": "PARQUET-1866: Replace Hadoop ZSTD with JNI-ZSTD", "committedDate": "2020-05-22T02:07:44Z", "type": "forcePushed"}, {"oid": "c16585f6bcb747e661b6e077a9fe92fde57612d2", "url": "https://github.com/apache/parquet-mr/commit/c16585f6bcb747e661b6e077a9fe92fde57612d2", "message": "PARQUET-1866: Replace Hadoop ZSTD with JNI-ZSTD", "committedDate": "2020-05-22T03:48:35Z", "type": "commit"}, {"oid": "c16585f6bcb747e661b6e077a9fe92fde57612d2", "url": "https://github.com/apache/parquet-mr/commit/c16585f6bcb747e661b6e077a9fe92fde57612d2", "message": "PARQUET-1866: Replace Hadoop ZSTD with JNI-ZSTD", "committedDate": "2020-05-22T03:48:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExMjAyOA==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r429112028", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * one because it requires 1) to set up hadoop on local develop machine;\n          \n          \n            \n             * one because it requires 1) to set up hadoop on local development machine;", "author": "gszadovszky", "createdAt": "2020-05-22T08:25:35Z", "path": "parquet-hadoop/src/main/java/org/apache/parquet/hadoop/codec/ZstdCodec.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/* \n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.hadoop.codec;\n+\n+import org.apache.hadoop.conf.Configurable;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.io.compress.CompressionCodec;\n+import org.apache.hadoop.io.compress.CompressionInputStream;\n+import org.apache.hadoop.io.compress.CompressionOutputStream;\n+import org.apache.hadoop.io.compress.Compressor;\n+import org.apache.hadoop.io.compress.Decompressor;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+/**\n+ * ZSTD compression codec for Parquet.  We do not use the default hadoop\n+ * one because it requires 1) to set up hadoop on local develop machine;", "originalCommit": "c16585f6bcb747e661b6e077a9fe92fde57612d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExMzA0MQ==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r429113041", "bodyText": "Please, also update the documentation in the README.", "author": "gszadovszky", "createdAt": "2020-05-22T08:27:44Z", "path": "parquet-hadoop/src/main/java/org/apache/parquet/hadoop/codec/ZstdCodec.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/* \n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.hadoop.codec;\n+\n+import org.apache.hadoop.conf.Configurable;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.io.compress.CompressionCodec;\n+import org.apache.hadoop.io.compress.CompressionInputStream;\n+import org.apache.hadoop.io.compress.CompressionOutputStream;\n+import org.apache.hadoop.io.compress.Compressor;\n+import org.apache.hadoop.io.compress.Decompressor;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+/**\n+ * ZSTD compression codec for Parquet.  We do not use the default hadoop\n+ * one because it requires 1) to set up hadoop on local develop machine;\n+ * 2) to upgrade hadoop to the newer version to have ZSTD support which is\n+ * more cumbersome than upgrading parquet version.\n+ *\n+ * This implementation relies on ZSTD JNI(https://github.com/luben/zstd-jni)\n+ * which is already a dependency for Parquet. ZSTD JNI ZstdOutputStream and\n+ * ZstdInputStream use Zstd internally. So no need to create compressor and\n+ * decompressor in ZstdCodec.\n+ */\n+public class ZstdCodec implements Configurable, CompressionCodec {\n+\n+  public final static String PARQUET_COMPRESS_ZSTD_LEVEL = \"parquet.compression.codec.zstd.level\";\n+  public final static int DEFAULT_PARQUET_COMPRESS_ZSTD_LEVEL = 3;\n+  public final static String PARQUET_COMPRESS_ZSTD_WORKERS = \"parquet.compression.codec.zstd.workers\";\n+  public final static int DEFAULTPARQUET_COMPRESS_ZSTD_WORKERS = 0;", "originalCommit": "c16585f6bcb747e661b6e077a9fe92fde57612d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU2MDc2Nw==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r429560767", "bodyText": "Sure", "author": "shangxinli", "createdAt": "2020-05-23T16:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExMzA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1NDc2NA==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r429154764", "bodyText": "I tried to find the code part where we set the hadoop conf to the codec but could not find it. Please, write a high level test where you set compression level and workers in the hadoop conf and executes a file write via e.g. an MR job.", "author": "gszadovszky", "createdAt": "2020-05-22T09:56:17Z", "path": "parquet-hadoop/src/test/java/org/apache/parquet/hadoop/TestZstdCodec.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/* \n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.hadoop;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.io.compress.CompressionOutputStream;\n+import org.apache.parquet.bytes.BytesInput;\n+import org.apache.parquet.hadoop.codec.ZstdCodec;\n+import org.junit.Assert;\n+import org.junit.Test;  \n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.Random;\n+\n+public class TestZstdCodec {", "originalCommit": "c16585f6bcb747e661b6e077a9fe92fde57612d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU2MDc4Mw==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r429560783", "bodyText": "Added test for conf setting with MR", "author": "shangxinli", "createdAt": "2020-05-23T16:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1NDc2NA=="}], "type": "inlineReview"}, {"oid": "bae6b85eaaa2d9b847d29e579af2c2c602970d28", "url": "https://github.com/apache/parquet-mr/commit/bae6b85eaaa2d9b847d29e579af2c2c602970d28", "message": "Update parquet-hadoop/src/main/java/org/apache/parquet/hadoop/codec/ZstdCodec.java\n\nCo-authored-by: Gabor Szadovszky <gabor@apache.org>", "committedDate": "2020-05-22T16:00:52Z", "type": "commit"}, {"oid": "dc6460fdc295831619cf7896eb160ae00a3903a5", "url": "https://github.com/apache/parquet-mr/commit/dc6460fdc295831619cf7896eb160ae00a3903a5", "message": "Address feedback: add conf into README.md, add mr job for conf testing, and fix the codec name", "committedDate": "2020-05-23T00:22:10Z", "type": "commit"}, {"oid": "689b3489ec8177082c5248ecbf869d03eee62bf0", "url": "https://github.com/apache/parquet-mr/commit/689b3489ec8177082c5248ecbf869d03eee62bf0", "message": "Fix class name", "committedDate": "2020-05-23T00:28:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTczMTgxNg==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r431731816", "bodyText": "Thanks for creating an MR test. What I wanted to test with it is if the ZSTD related configuration takes place if set via the configuration. This is not tested currently. I wanted to test it because I am not sure if we have the code in place to pass configuration properties to the codecs.", "author": "gszadovszky", "createdAt": "2020-05-28T10:19:49Z", "path": "parquet-hadoop/src/test/java/org/apache/parquet/hadoop/TestZstandardCodec.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/* \n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.hadoop;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.LongWritable;\n+import org.apache.hadoop.io.Text;\n+import org.apache.hadoop.io.compress.CompressionOutputStream;\n+import org.apache.hadoop.mapred.JobClient;\n+import org.apache.hadoop.mapred.JobConf;\n+import org.apache.hadoop.mapred.OutputCollector;\n+import org.apache.hadoop.mapred.Reporter;\n+import org.apache.hadoop.mapred.RunningJob;\n+import org.apache.hadoop.mapred.TextInputFormat;\n+import org.apache.parquet.bytes.BytesInput;\n+import org.apache.parquet.example.data.Group;\n+import org.apache.parquet.example.data.simple.SimpleGroupFactory;\n+import org.apache.parquet.hadoop.codec.ZstandardCodec;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.hadoop.mapred.DeprecatedParquetOutputFormat;\n+import org.apache.parquet.hadoop.metadata.CompressionCodecName;\n+import org.apache.parquet.schema.MessageTypeParser;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.util.Random;\n+\n+public class TestZstandardCodec {\n+\n+  private final Path inputPath = new Path(\"src/test/java/org/apache/parquet/hadoop/example/TestInputOutputFormat.java\");\n+\n+  @Test\n+  public void testZstdCodec() throws IOException {\n+    ZstandardCodec codec = new ZstandardCodec();\n+    Configuration conf = new Configuration();\n+    int[] levels = {1, 4, 7, 10, 13, 16, 19, 22};\n+    int[] dataSizes = {0, 1, 10, 1024, 1024 * 1024};\n+\n+    for (int i = 0; i < levels.length; i++) {\n+      conf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_LEVEL, levels[i]);\n+      codec.setConf(conf);\n+      for (int j = 0; j < dataSizes.length; j++) {\n+        testZstd(codec, dataSizes[j]);\n+      }\n+    }\n+  }\n+\n+  private void testZstd(ZstandardCodec codec, int dataSize) throws IOException {\n+    byte[] data = new byte[dataSize];\n+    (new Random()).nextBytes(data);\n+    BytesInput compressedData = compress(codec,  BytesInput.from(data));\n+    BytesInput decompressedData = decompress(codec, compressedData, data.length);\n+    Assert.assertArrayEquals(data, decompressedData.toByteArray());\n+  }\n+\n+  private BytesInput compress(ZstandardCodec codec, BytesInput bytes) throws IOException {\n+    ByteArrayOutputStream compressedOutBuffer = new ByteArrayOutputStream((int)bytes.size());\n+    CompressionOutputStream cos = codec.createOutputStream(compressedOutBuffer, null);\n+    bytes.writeAllTo(cos);\n+    cos.close();\n+    return BytesInput.from(compressedOutBuffer);\n+  }\n+\n+  private BytesInput decompress(ZstandardCodec codec, BytesInput bytes, int uncompressedSize) throws IOException {\n+    BytesInput decompressed;\n+    InputStream is = codec.createInputStream(bytes.toInputStream(), null);\n+    decompressed = BytesInput.from(is, uncompressedSize);\n+    is.close();\n+    return decompressed;\n+  }\n+\n+  @Test\n+  public void testZstdConfWithMr() throws Exception {\n+    JobConf jobConf = new JobConf();\n+    Configuration conf = new Configuration();\n+    jobConf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_LEVEL, 18);\n+    jobConf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_LEVEL, 4);\n+    RunningJob mapRedJob = runMapReduceJob(CompressionCodecName.ZSTD, jobConf, conf);\n+    assert(mapRedJob.isSuccessful());\n+  }\n+\n+  private RunningJob runMapReduceJob(CompressionCodecName codec, JobConf jobConf, Configuration conf) throws IOException, ClassNotFoundException, InterruptedException {", "originalCommit": "689b3489ec8177082c5248ecbf869d03eee62bf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0MjQ3NA==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r432142474", "bodyText": "I set breakpoint and checked it. But I don't know how to get back the level/workers at the MR job. Any ideal how to do that? I also verified it in the standalone Spark application. Do you think that is sufficient?", "author": "shangxinli", "createdAt": "2020-05-28T21:46:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTczMTgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM4MTcyOA==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r432381728", "bodyText": "Maybe, if we create two parquet files with different levels (e.g. 1 and 22) but with the exact same data we can expect that the larger level will generate smaller file?\nI just want to ensure that the properties really arrive to the codec. If you think the related test requires too much effort or even not feasible I am fine if you can point me to the code path where the properties are passed through to the codecs.", "author": "gszadovszky", "createdAt": "2020-05-29T09:57:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTczMTgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwOTI1OA==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r432709258", "bodyText": "I like the idea to compare the two files with different compression levels. Only thing is that it is not 100% guarantee the higher level always gets higher compression ratio although the chance of that is very low. In our test data, it seems it is OK though. So I will just go ahead to add the file size comparison.", "author": "shangxinli", "createdAt": "2020-05-29T20:04:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTczMTgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY3NTI1Mg==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r433675252", "bodyText": "Yes, I know, there is no 100% guarantee in normal circumstances. But if you write the test in a deterministic way (as it should be by e.g. using a fix seed for random generation) then without changing the data and the compression codec it shall be fine. I worth a comment, though about it is not the nicest way of testing the work of the properties but currently that's seems to be the only one.", "author": "gszadovszky", "createdAt": "2020-06-02T07:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTczMTgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNzE2Mg==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r434007162", "bodyText": "Thanks.", "author": "shangxinli", "createdAt": "2020-06-02T16:19:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTczMTgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTczMjM2NQ==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r431732365", "bodyText": "You are setting the level twice (and the workers are missing).", "author": "gszadovszky", "createdAt": "2020-05-28T10:20:49Z", "path": "parquet-hadoop/src/test/java/org/apache/parquet/hadoop/TestZstandardCodec.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/* \n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.hadoop;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.LongWritable;\n+import org.apache.hadoop.io.Text;\n+import org.apache.hadoop.io.compress.CompressionOutputStream;\n+import org.apache.hadoop.mapred.JobClient;\n+import org.apache.hadoop.mapred.JobConf;\n+import org.apache.hadoop.mapred.OutputCollector;\n+import org.apache.hadoop.mapred.Reporter;\n+import org.apache.hadoop.mapred.RunningJob;\n+import org.apache.hadoop.mapred.TextInputFormat;\n+import org.apache.parquet.bytes.BytesInput;\n+import org.apache.parquet.example.data.Group;\n+import org.apache.parquet.example.data.simple.SimpleGroupFactory;\n+import org.apache.parquet.hadoop.codec.ZstandardCodec;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.hadoop.mapred.DeprecatedParquetOutputFormat;\n+import org.apache.parquet.hadoop.metadata.CompressionCodecName;\n+import org.apache.parquet.schema.MessageTypeParser;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.util.Random;\n+\n+public class TestZstandardCodec {\n+\n+  private final Path inputPath = new Path(\"src/test/java/org/apache/parquet/hadoop/example/TestInputOutputFormat.java\");\n+\n+  @Test\n+  public void testZstdCodec() throws IOException {\n+    ZstandardCodec codec = new ZstandardCodec();\n+    Configuration conf = new Configuration();\n+    int[] levels = {1, 4, 7, 10, 13, 16, 19, 22};\n+    int[] dataSizes = {0, 1, 10, 1024, 1024 * 1024};\n+\n+    for (int i = 0; i < levels.length; i++) {\n+      conf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_LEVEL, levels[i]);\n+      codec.setConf(conf);\n+      for (int j = 0; j < dataSizes.length; j++) {\n+        testZstd(codec, dataSizes[j]);\n+      }\n+    }\n+  }\n+\n+  private void testZstd(ZstandardCodec codec, int dataSize) throws IOException {\n+    byte[] data = new byte[dataSize];\n+    (new Random()).nextBytes(data);\n+    BytesInput compressedData = compress(codec,  BytesInput.from(data));\n+    BytesInput decompressedData = decompress(codec, compressedData, data.length);\n+    Assert.assertArrayEquals(data, decompressedData.toByteArray());\n+  }\n+\n+  private BytesInput compress(ZstandardCodec codec, BytesInput bytes) throws IOException {\n+    ByteArrayOutputStream compressedOutBuffer = new ByteArrayOutputStream((int)bytes.size());\n+    CompressionOutputStream cos = codec.createOutputStream(compressedOutBuffer, null);\n+    bytes.writeAllTo(cos);\n+    cos.close();\n+    return BytesInput.from(compressedOutBuffer);\n+  }\n+\n+  private BytesInput decompress(ZstandardCodec codec, BytesInput bytes, int uncompressedSize) throws IOException {\n+    BytesInput decompressed;\n+    InputStream is = codec.createInputStream(bytes.toInputStream(), null);\n+    decompressed = BytesInput.from(is, uncompressedSize);\n+    is.close();\n+    return decompressed;\n+  }\n+\n+  @Test\n+  public void testZstdConfWithMr() throws Exception {\n+    JobConf jobConf = new JobConf();\n+    Configuration conf = new Configuration();\n+    jobConf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_LEVEL, 18);\n+    jobConf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_LEVEL, 4);", "originalCommit": "689b3489ec8177082c5248ecbf869d03eee62bf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExODY3Mw==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r432118673", "bodyText": "Good catch", "author": "shangxinli", "createdAt": "2020-05-28T20:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTczMjM2NQ=="}], "type": "inlineReview"}, {"oid": "debb236d674c3ccc2d3fdc2dc6c8f8ded1c5134d", "url": "https://github.com/apache/parquet-mr/commit/debb236d674c3ccc2d3fdc2dc6c8f8ded1c5134d", "message": "Fix test typo", "committedDate": "2020-05-28T21:47:32Z", "type": "commit"}, {"oid": "7204a18dc8db359cf5412ece717eaa3fcbc9f990", "url": "https://github.com/apache/parquet-mr/commit/7204a18dc8db359cf5412ece717eaa3fcbc9f990", "message": "Address feedback", "committedDate": "2020-05-29T20:00:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcyMzc4Mw==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r433723783", "bodyText": "Please use the JUnit framework assert functions instead of the assert keyword. The assert keyword is not for unit testing and it is not 100% guaranteed that the assertions are enabled during testing.", "author": "gszadovszky", "createdAt": "2020-06-02T08:56:00Z", "path": "parquet-hadoop/src/test/java/org/apache/parquet/hadoop/TestZstandardCodec.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/* \n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.hadoop;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.LongWritable;\n+import org.apache.hadoop.io.Text;\n+import org.apache.hadoop.io.compress.CompressionOutputStream;\n+import org.apache.hadoop.mapred.JobClient;\n+import org.apache.hadoop.mapred.JobConf;\n+import org.apache.hadoop.mapred.OutputCollector;\n+import org.apache.hadoop.mapred.Reporter;\n+import org.apache.hadoop.mapred.RunningJob;\n+import org.apache.hadoop.mapred.TextInputFormat;\n+import org.apache.parquet.bytes.BytesInput;\n+import org.apache.parquet.example.data.Group;\n+import org.apache.parquet.example.data.simple.SimpleGroupFactory;\n+import org.apache.parquet.hadoop.codec.ZstandardCodec;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.hadoop.mapred.DeprecatedParquetOutputFormat;\n+import org.apache.parquet.hadoop.metadata.CompressionCodecName;\n+import org.apache.parquet.schema.MessageTypeParser;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.util.Random;\n+\n+public class TestZstandardCodec {\n+\n+  private final Path inputPath = new Path(\"src/test/java/org/apache/parquet/hadoop/example/TestInputOutputFormat.java\");\n+\n+  @Test\n+  public void testZstdCodec() throws IOException {\n+    ZstandardCodec codec = new ZstandardCodec();\n+    Configuration conf = new Configuration();\n+    int[] levels = {1, 4, 7, 10, 13, 16, 19, 22};\n+    int[] dataSizes = {0, 1, 10, 1024, 1024 * 1024};\n+\n+    for (int i = 0; i < levels.length; i++) {\n+      conf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_LEVEL, levels[i]);\n+      codec.setConf(conf);\n+      for (int j = 0; j < dataSizes.length; j++) {\n+        testZstd(codec, dataSizes[j]);\n+      }\n+    }\n+  }\n+\n+  private void testZstd(ZstandardCodec codec, int dataSize) throws IOException {\n+    byte[] data = new byte[dataSize];\n+    (new Random()).nextBytes(data);\n+    BytesInput compressedData = compress(codec,  BytesInput.from(data));\n+    BytesInput decompressedData = decompress(codec, compressedData, data.length);\n+    Assert.assertArrayEquals(data, decompressedData.toByteArray());\n+  }\n+\n+  private BytesInput compress(ZstandardCodec codec, BytesInput bytes) throws IOException {\n+    ByteArrayOutputStream compressedOutBuffer = new ByteArrayOutputStream((int)bytes.size());\n+    CompressionOutputStream cos = codec.createOutputStream(compressedOutBuffer, null);\n+    bytes.writeAllTo(cos);\n+    cos.close();\n+    return BytesInput.from(compressedOutBuffer);\n+  }\n+\n+  private BytesInput decompress(ZstandardCodec codec, BytesInput bytes, int uncompressedSize) throws IOException {\n+    BytesInput decompressed;\n+    InputStream is = codec.createInputStream(bytes.toInputStream(), null);\n+    decompressed = BytesInput.from(is, uncompressedSize);\n+    is.close();\n+    return decompressed;\n+  }\n+\n+  @Test\n+  public void testZstdConfWithMr() throws Exception {\n+    long fileSizeLowLevel = runMrWithConf(1);\n+    // Clear the cache so that a new codec can be created with new configuration\n+    CodecFactory.CODEC_BY_NAME.clear();\n+    long fileSizeHighLevel = runMrWithConf(22);\n+    assert (fileSizeLowLevel > fileSizeHighLevel);", "originalCommit": "7204a18dc8db359cf5412ece717eaa3fcbc9f990", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTAzMQ==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r434001031", "bodyText": "Sounds good!", "author": "shangxinli", "createdAt": "2020-06-02T16:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcyMzc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcyMzg5Nw==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r433723897", "bodyText": "Same as above", "author": "gszadovszky", "createdAt": "2020-06-02T08:56:09Z", "path": "parquet-hadoop/src/test/java/org/apache/parquet/hadoop/TestZstandardCodec.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/* \n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.hadoop;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.LongWritable;\n+import org.apache.hadoop.io.Text;\n+import org.apache.hadoop.io.compress.CompressionOutputStream;\n+import org.apache.hadoop.mapred.JobClient;\n+import org.apache.hadoop.mapred.JobConf;\n+import org.apache.hadoop.mapred.OutputCollector;\n+import org.apache.hadoop.mapred.Reporter;\n+import org.apache.hadoop.mapred.RunningJob;\n+import org.apache.hadoop.mapred.TextInputFormat;\n+import org.apache.parquet.bytes.BytesInput;\n+import org.apache.parquet.example.data.Group;\n+import org.apache.parquet.example.data.simple.SimpleGroupFactory;\n+import org.apache.parquet.hadoop.codec.ZstandardCodec;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.hadoop.mapred.DeprecatedParquetOutputFormat;\n+import org.apache.parquet.hadoop.metadata.CompressionCodecName;\n+import org.apache.parquet.schema.MessageTypeParser;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.util.Random;\n+\n+public class TestZstandardCodec {\n+\n+  private final Path inputPath = new Path(\"src/test/java/org/apache/parquet/hadoop/example/TestInputOutputFormat.java\");\n+\n+  @Test\n+  public void testZstdCodec() throws IOException {\n+    ZstandardCodec codec = new ZstandardCodec();\n+    Configuration conf = new Configuration();\n+    int[] levels = {1, 4, 7, 10, 13, 16, 19, 22};\n+    int[] dataSizes = {0, 1, 10, 1024, 1024 * 1024};\n+\n+    for (int i = 0; i < levels.length; i++) {\n+      conf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_LEVEL, levels[i]);\n+      codec.setConf(conf);\n+      for (int j = 0; j < dataSizes.length; j++) {\n+        testZstd(codec, dataSizes[j]);\n+      }\n+    }\n+  }\n+\n+  private void testZstd(ZstandardCodec codec, int dataSize) throws IOException {\n+    byte[] data = new byte[dataSize];\n+    (new Random()).nextBytes(data);\n+    BytesInput compressedData = compress(codec,  BytesInput.from(data));\n+    BytesInput decompressedData = decompress(codec, compressedData, data.length);\n+    Assert.assertArrayEquals(data, decompressedData.toByteArray());\n+  }\n+\n+  private BytesInput compress(ZstandardCodec codec, BytesInput bytes) throws IOException {\n+    ByteArrayOutputStream compressedOutBuffer = new ByteArrayOutputStream((int)bytes.size());\n+    CompressionOutputStream cos = codec.createOutputStream(compressedOutBuffer, null);\n+    bytes.writeAllTo(cos);\n+    cos.close();\n+    return BytesInput.from(compressedOutBuffer);\n+  }\n+\n+  private BytesInput decompress(ZstandardCodec codec, BytesInput bytes, int uncompressedSize) throws IOException {\n+    BytesInput decompressed;\n+    InputStream is = codec.createInputStream(bytes.toInputStream(), null);\n+    decompressed = BytesInput.from(is, uncompressedSize);\n+    is.close();\n+    return decompressed;\n+  }\n+\n+  @Test\n+  public void testZstdConfWithMr() throws Exception {\n+    long fileSizeLowLevel = runMrWithConf(1);\n+    // Clear the cache so that a new codec can be created with new configuration\n+    CodecFactory.CODEC_BY_NAME.clear();\n+    long fileSizeHighLevel = runMrWithConf(22);\n+    assert (fileSizeLowLevel > fileSizeHighLevel);\n+  }\n+\n+  private long runMrWithConf(int level) throws Exception {\n+    JobConf jobConf = new JobConf();\n+    Configuration conf = new Configuration();\n+    jobConf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_LEVEL, level);\n+    jobConf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_WORKERS, 4);\n+    Path path = new Path(Files.createTempDirectory(\"zstd\" + level).toAbsolutePath().toString());\n+    RunningJob mapRedJob = runMapReduceJob(CompressionCodecName.ZSTD, jobConf, conf, path);\n+    assert(mapRedJob.isSuccessful());", "originalCommit": "7204a18dc8db359cf5412ece717eaa3fcbc9f990", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTE0OA==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r434001148", "bodyText": "fixed", "author": "shangxinli", "createdAt": "2020-06-02T16:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcyMzg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcyNTU0NQ==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r433725545", "bodyText": "Please, add some comments that the intent of this test is to verify that the properties are passed through from the config to the codec.", "author": "gszadovszky", "createdAt": "2020-06-02T08:58:53Z", "path": "parquet-hadoop/src/test/java/org/apache/parquet/hadoop/TestZstandardCodec.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/* \n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.hadoop;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.LongWritable;\n+import org.apache.hadoop.io.Text;\n+import org.apache.hadoop.io.compress.CompressionOutputStream;\n+import org.apache.hadoop.mapred.JobClient;\n+import org.apache.hadoop.mapred.JobConf;\n+import org.apache.hadoop.mapred.OutputCollector;\n+import org.apache.hadoop.mapred.Reporter;\n+import org.apache.hadoop.mapred.RunningJob;\n+import org.apache.hadoop.mapred.TextInputFormat;\n+import org.apache.parquet.bytes.BytesInput;\n+import org.apache.parquet.example.data.Group;\n+import org.apache.parquet.example.data.simple.SimpleGroupFactory;\n+import org.apache.parquet.hadoop.codec.ZstandardCodec;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.hadoop.mapred.DeprecatedParquetOutputFormat;\n+import org.apache.parquet.hadoop.metadata.CompressionCodecName;\n+import org.apache.parquet.schema.MessageTypeParser;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.util.Random;\n+\n+public class TestZstandardCodec {\n+\n+  private final Path inputPath = new Path(\"src/test/java/org/apache/parquet/hadoop/example/TestInputOutputFormat.java\");\n+\n+  @Test\n+  public void testZstdCodec() throws IOException {\n+    ZstandardCodec codec = new ZstandardCodec();\n+    Configuration conf = new Configuration();\n+    int[] levels = {1, 4, 7, 10, 13, 16, 19, 22};\n+    int[] dataSizes = {0, 1, 10, 1024, 1024 * 1024};\n+\n+    for (int i = 0; i < levels.length; i++) {\n+      conf.setInt(ZstandardCodec.PARQUET_COMPRESS_ZSTD_LEVEL, levels[i]);\n+      codec.setConf(conf);\n+      for (int j = 0; j < dataSizes.length; j++) {\n+        testZstd(codec, dataSizes[j]);\n+      }\n+    }\n+  }\n+\n+  private void testZstd(ZstandardCodec codec, int dataSize) throws IOException {\n+    byte[] data = new byte[dataSize];\n+    (new Random()).nextBytes(data);\n+    BytesInput compressedData = compress(codec,  BytesInput.from(data));\n+    BytesInput decompressedData = decompress(codec, compressedData, data.length);\n+    Assert.assertArrayEquals(data, decompressedData.toByteArray());\n+  }\n+\n+  private BytesInput compress(ZstandardCodec codec, BytesInput bytes) throws IOException {\n+    ByteArrayOutputStream compressedOutBuffer = new ByteArrayOutputStream((int)bytes.size());\n+    CompressionOutputStream cos = codec.createOutputStream(compressedOutBuffer, null);\n+    bytes.writeAllTo(cos);\n+    cos.close();\n+    return BytesInput.from(compressedOutBuffer);\n+  }\n+\n+  private BytesInput decompress(ZstandardCodec codec, BytesInput bytes, int uncompressedSize) throws IOException {\n+    BytesInput decompressed;\n+    InputStream is = codec.createInputStream(bytes.toInputStream(), null);\n+    decompressed = BytesInput.from(is, uncompressedSize);\n+    is.close();\n+    return decompressed;\n+  }\n+\n+  @Test\n+  public void testZstdConfWithMr() throws Exception {", "originalCommit": "7204a18dc8db359cf5412ece717eaa3fcbc9f990", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMjc5Mw==", "url": "https://github.com/apache/parquet-mr/pull/793#discussion_r434002793", "bodyText": "Added. Thanks.", "author": "shangxinli", "createdAt": "2020-06-02T16:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcyNTU0NQ=="}], "type": "inlineReview"}, {"oid": "e0b60960f36d722b779c002a61ea268d6d14354c", "url": "https://github.com/apache/parquet-mr/commit/e0b60960f36d722b779c002a61ea268d6d14354c", "message": "Fix assert and add comment for test", "committedDate": "2020-06-02T16:15:18Z", "type": "commit"}]}