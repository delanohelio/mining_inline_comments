{"pr_number": 491, "pr_title": "Release 2.2.1", "pr_createdAt": "2020-01-17T07:09:23Z", "pr_url": "https://github.com/FISCO-BCOS/web3sdk/pull/491", "timeline": [{"oid": "02f25ef63f442f78cb77959d031cb7f1f74fafea", "url": "https://github.com/FISCO-BCOS/web3sdk/commit/02f25ef63f442f78cb77959d031cb7f1f74fafea", "message": "remove trimLeadingZeroes when encode publicKey of guomi (#485)", "committedDate": "2020-01-02T12:16:09Z", "type": "commit"}, {"oid": "e6c909df006e3935246d98238c9d386c1315400e", "url": "https://github.com/FISCO-BCOS/web3sdk/commit/e6c909df006e3935246d98238c9d386c1315400e", "message": "fix the bug of sm2 verify && add the test case (#486)\n\n* fix the bug of sm2 verify && add the test case", "committedDate": "2020-01-03T06:29:41Z", "type": "commit"}, {"oid": "9109744537485d0f74e2174279e91801635786d2", "url": "https://github.com/FISCO-BCOS/web3sdk/commit/9109744537485d0f74e2174279e91801635786d2", "message": "add exception handling for network module. (#483)\n\n* add socket connection to map when handshake success.\r\n\r\n* add check for connectStr.\r\n\r\n* add exception handling for network module.\r\n\r\n* add print pem object info.\r\n\r\n* add log print when load p12 or pem file.\r\n\r\n* update handshake failed error message.", "committedDate": "2020-01-06T15:33:11Z", "type": "commit"}, {"oid": "3818d083dad8ba8f1886b6643e97589b58a82b0c", "url": "https://github.com/FISCO-BCOS/web3sdk/commit/3818d083dad8ba8f1886b6643e97589b58a82b0c", "message": "delete the blank space (#489)\n\n* delete the blank space\r\n\r\n* modify error message", "committedDate": "2020-01-13T12:14:38Z", "type": "commit"}, {"oid": "8143417c7b21bb69367af4376f648dc86c6d5ca0", "url": "https://github.com/FISCO-BCOS/web3sdk/commit/8143417c7b21bb69367af4376f648dc86c6d5ca0", "message": "update TransactionReceipt Log (#490)", "committedDate": "2020-01-15T06:06:39Z", "type": "commit"}, {"oid": "62dbeb88ad47bf639d2fb3f3fb32cb175a6de8f9", "url": "https://github.com/FISCO-BCOS/web3sdk/commit/62dbeb88ad47bf639d2fb3f3fb32cb175a6de8f9", "message": "update release.txt ChangeLog.md (#492)", "committedDate": "2020-01-17T07:50:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgwNTk2OQ==", "url": "https://github.com/FISCO-BCOS/web3sdk/pull/491#discussion_r367805969", "bodyText": "Issue found: Avoid unused private fields such as 'logger'.", "author": "bxq2011hust", "createdAt": "2020-01-17T07:52:42Z", "path": "src/main/java/org/fisco/bcos/channel/client/P12Manager.java", "diffHunk": "@@ -23,11 +23,16 @@\n import org.bouncycastle.jcajce.provider.keystore.pkcs12.PKCS12KeyStoreSpi;\n import org.bouncycastle.jce.provider.BouncyCastleProvider;\n import org.fisco.bcos.web3j.crypto.ECKeyPair;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.core.io.Resource;\n import org.springframework.core.io.support.PathMatchingResourcePatternResolver;\n import org.springframework.core.io.support.ResourcePatternResolver;\n \n public class P12Manager {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(P12Manager.class);", "originalCommit": "62dbeb88ad47bf639d2fb3f3fb32cb175a6de8f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgwNTk3Ng==", "url": "https://github.com/FISCO-BCOS/web3sdk/pull/491#discussion_r367805976", "bodyText": "Issue found: Fields should be declared at the top of the class, before any method declarations, constructors, initializers or inner classes.", "author": "bxq2011hust", "createdAt": "2020-01-17T07:52:44Z", "path": "src/main/java/org/fisco/bcos/channel/handler/ConnectionInfo.java", "diffHunk": "@@ -44,10 +48,16 @@ public void setTopics(List<String> topics) {\n         this.topics = topics;\n     }\n \n-    private String nodeID = \"\";\n+    @Deprecated private String nodeID = \"\";\n+    @Deprecated private Boolean config = false;", "originalCommit": "62dbeb88ad47bf639d2fb3f3fb32cb175a6de8f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgwNTk3Nw==", "url": "https://github.com/FISCO-BCOS/web3sdk/pull/491#discussion_r367805977", "bodyText": "Issue found: Avoid throwing raw exception types.", "author": "bxq2011hust", "createdAt": "2020-01-17T07:52:45Z", "path": "src/main/java/org/fisco/bcos/channel/handler/ChannelConnections.java", "diffHunk": "@@ -206,22 +216,15 @@ public ChannelHandlerContext randomNetworkConnection(\n             ConcurrentHashMap<String, BigInteger> nodeToBlockNumberMap) throws Exception {\n         List<ChannelHandlerContext> activeConnections = new ArrayList<ChannelHandlerContext>();\n \n-        getReadWriteLock().readLock().lock();\n-        try {\n-            for (String key : networkConnections.keySet()) {\n-                if (networkConnections.get(key) != null\n-                        && ChannelHandlerContextHelper.isChannelAvailable(\n-                                networkConnections.get(key))) {\n-                    activeConnections.add(networkConnections.get(key));\n-                }\n+        for (ChannelHandlerContext ctx : networkConnections.values()) {\n+            if (Objects.nonNull(ctx) && ChannelHandlerContextHelper.isChannelAvailable(ctx)) {\n+                activeConnections.add(ctx);\n             }\n-        } finally {\n-            getReadWriteLock().readLock().unlock();\n         }\n \n         if (activeConnections.isEmpty()) {\n-            logger.error(\"activeConnections isEmpty\");\n-            throw new Exception(\"activeConnections isEmpty\");\n+            logger.error(\" no active connection is available, maybe network connection exception\");\n+            throw new Exception(\" no active connection available network exception\");", "originalCommit": "62dbeb88ad47bf639d2fb3f3fb32cb175a6de8f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgwNTk4MQ==", "url": "https://github.com/FISCO-BCOS/web3sdk/pull/491#discussion_r367805981", "bodyText": "Issue found: Avoid unused private fields such as 'logger'.", "author": "bxq2011hust", "createdAt": "2020-01-17T07:52:46Z", "path": "src/main/java/org/fisco/bcos/channel/client/PEMManager.java", "diffHunk": "@@ -25,11 +25,16 @@\n import org.bouncycastle.util.io.pem.PemObject;\r\n import org.bouncycastle.util.io.pem.PemReader;\r\n import org.fisco.bcos.web3j.crypto.ECKeyPair;\r\n+import org.slf4j.Logger;\r\n+import org.slf4j.LoggerFactory;\r\n import org.springframework.core.io.Resource;\r\n import org.springframework.core.io.support.PathMatchingResourcePatternResolver;\r\n import org.springframework.core.io.support.ResourcePatternResolver;\r\n \r\n public class PEMManager {\r\n+\r\n+    private static final Logger logger = LoggerFactory.getLogger(PEMManager.class);\r", "originalCommit": "62dbeb88ad47bf639d2fb3f3fb32cb175a6de8f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgwNTk4OA==", "url": "https://github.com/FISCO-BCOS/web3sdk/pull/491#discussion_r367805988", "bodyText": "Issue found: Avoid throwing raw exception types.", "author": "bxq2011hust", "createdAt": "2020-01-17T07:52:47Z", "path": "src/main/java/org/fisco/bcos/channel/handler/ChannelConnections.java", "diffHunk": "@@ -446,29 +503,81 @@ public void initChannel(SocketChannel ch) throws Exception {\n                     }\n                 });\n \n+        List<Tuple3<String, Integer, ChannelFuture>> tuple3List = new ArrayList<>();\n+        // try to connect to all nodes\n+        for (ConnectionInfo connectionInfo : connections) {\n+            String IP = connectionInfo.getHost();\n+            Integer port = connectionInfo.getPort();\n+\n+            ChannelFuture channelFuture = bootstrap.connect(IP, port);\n+            tuple3List.add(new Tuple3<>(IP, port, channelFuture));\n+        }\n+\n+        boolean atLeastOneConnectSuccess = false;\n+        List<String> errorMessageList = new ArrayList<>();\n+        // Wait for all connection operations to complete\n+        for (Tuple3<String, Integer, ChannelFuture> tuple3 : tuple3List) {\n+            ChannelFuture connectFuture = tuple3.getValue3().awaitUninterruptibly();\n+            if (!connectFuture.isSuccess()) {\n+                logger.error(\n+                        \" connect to {}:{}, error: {}\",\n+                        tuple3.getValue1(),\n+                        tuple3.getValue2(),\n+                        connectFuture.cause().getMessage());\n+\n+                String connectFailedMessage =\n+                        Objects.isNull(connectFuture.cause())\n+                                ? \"connect to \"\n+                                        + tuple3.getValue1()\n+                                        + \":\"\n+                                        + tuple3.getValue2()\n+                                        + \" failed\"\n+                                : connectFuture.cause().getMessage();\n+                errorMessageList.add(connectFailedMessage);\n+            } else {\n+                // tcp connect success and waiting for SSL handshake\n+                logger.trace(\" connect to {}:{} success\", tuple3.getValue1(), tuple3.getValue2());\n+\n+                SslHandler sslhandler = connectFuture.channel().pipeline().get(SslHandler.class);\n+                Future<Channel> sshHandshakeFuture =\n+                        sslhandler.handshakeFuture().awaitUninterruptibly();\n+                if (sshHandshakeFuture.isSuccess()) {\n+                    atLeastOneConnectSuccess = true;\n+                    logger.trace(\n+                            \" ssl handshake success {}:{}\", tuple3.getValue1(), tuple3.getValue2());\n+                } else {\n+\n+                    String sslHandshakeFailedMessage =\n+                            \" ssl handshake failed:/\"\n+                                    + tuple3.getValue1()\n+                                    + \":\"\n+                                    + tuple3.getValue2();\n+\n+                    errorMessageList.add(sslHandshakeFailedMessage);\n+                }\n+            }\n+        }\n+\n+        // All connections failed\n+        if (!atLeastOneConnectSuccess) {\n+            logger.error(\" all connections have failed, \" + errorMessageList.toString());\n+            throw new RuntimeException(", "originalCommit": "62dbeb88ad47bf639d2fb3f3fb32cb175a6de8f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgwNTk5Mg==", "url": "https://github.com/FISCO-BCOS/web3sdk/pull/491#discussion_r367805992", "bodyText": "Issue found: Fields should be declared at the top of the class, before any method declarations, constructors, initializers or inner classes.", "author": "bxq2011hust", "createdAt": "2020-01-17T07:52:48Z", "path": "src/main/java/org/fisco/bcos/channel/handler/ConnectionInfo.java", "diffHunk": "@@ -44,10 +48,16 @@ public void setTopics(List<String> topics) {\n         this.topics = topics;\n     }\n \n-    private String nodeID = \"\";\n+    @Deprecated private String nodeID = \"\";", "originalCommit": "62dbeb88ad47bf639d2fb3f3fb32cb175a6de8f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}