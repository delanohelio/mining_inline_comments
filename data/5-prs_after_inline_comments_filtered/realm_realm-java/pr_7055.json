{"pr_number": 7055, "pr_title": "Add test for realm version clean-up on close", "pr_createdAt": "2020-08-24T11:01:00Z", "pr_url": "https://github.com/realm/realm-java/pull/7055", "timeline": [{"oid": "27a0e39d3f073cf5b99bf7f8da811c3a4a8afe63", "url": "https://github.com/realm/realm-java/commit/27a0e39d3f073cf5b99bf7f8da811c3a4a8afe63", "message": "Add test for realm version clean-up on close", "committedDate": "2020-08-24T10:33:10Z", "type": "commit"}, {"oid": "d1d051ea63c0e8fdec97dc75e0594add056f1c5e", "url": "https://github.com/realm/realm-java/commit/d1d051ea63c0e8fdec97dc75e0594add056f1c5e", "message": "Expose OS get_number_of_versions on internal OsSharedRealm", "committedDate": "2020-08-26T08:48:10Z", "type": "commit"}, {"oid": "4ddf7297f5def1b07ed02d7e86e0adee97f4b969", "url": "https://github.com/realm/realm-java/commit/4ddf7297f5def1b07ed02d7e86e0adee97f4b969", "message": "Test wrap up", "committedDate": "2020-08-26T08:48:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMjk2Ng==", "url": "https://github.com/realm/realm-java/pull/7055#discussion_r477412966", "bodyText": "Replacing this with long objectCount = realm.where(AllJavaTypes.class).count(); works. This could indicate that it is the TableView created by findAll() that somehow isn't being updated correctly thus leaking the version and causing the test to crash.\nI'll try to move this to ObjectStore and see if I can replicate the behavior there.", "author": "cmelchior", "createdAt": "2020-08-26T16:00:04Z", "path": "realm/realm-library/src/androidTest/java/io/realm/RealmTests.java", "diffHunk": "@@ -4560,6 +4560,58 @@ public void hittingMaxNumberOfVersionsThrows() {\n         }\n     }\n \n+    @Test\n+    @RunTestInLooperThread\n+    // FIXME Maybe a bit convoluted, consider deleting it again.\n+    public void numberOfVersionsDecreasedOnClose() {\n+        int count = 50;\n+        final CountDownLatch bgThreadDoneLatch = new CountDownLatch(count);\n+\n+        RealmConfiguration config = configFactory.createConfigurationBuilder()\n+                // The multiple embedded threads seems to cause trouble with factory's directory setting\n+                .directory(context.getFilesDir())\n+                .name(\"versions-test.realm\")\n+                .maxNumberOfActiveVersions(5)\n+                .build();\n+\n+        // Read only instance\n+        looperThread.postRunnable(() -> {\n+            Realm realm = Realm.getInstance(config);\n+            realm.addChangeListener(realm1 -> {\n+                // FIXME Seems like versions are not deprecated if we do queries here\n+                //int objectCount = realm.where(AllJavaTypes.class).findAll().size();", "originalCommit": "4ddf7297f5def1b07ed02d7e86e0adee97f4b969", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8f12fac6e6f6814bde5faea266608d080773dd67", "url": "https://github.com/realm/realm-java/commit/8f12fac6e6f6814bde5faea266608d080773dd67", "message": "Fix versions not being cleaned up in change listeners.", "committedDate": "2020-08-31T08:59:08Z", "type": "commit"}, {"oid": "04c09bba195e8e2320e9e0d69f0168c25994d1f0", "url": "https://github.com/realm/realm-java/commit/04c09bba195e8e2320e9e0d69f0168c25994d1f0", "message": "Remove TODO items.", "committedDate": "2020-08-31T09:58:19Z", "type": "commit"}, {"oid": "1d8d6ea3dc9b18aafea1a51a923ac561f353d4d9", "url": "https://github.com/realm/realm-java/commit/1d8d6ea3dc9b18aafea1a51a923ac561f353d4d9", "message": "Update CHANGELOG.md\n\nCo-authored-by: Claus R\u00f8rbech <claus.rorbech@gmail.com>", "committedDate": "2020-08-31T10:13:43Z", "type": "commit"}, {"oid": "2e3316a5c8941decbb4afe6812b704a76214a725", "url": "https://github.com/realm/realm-java/commit/2e3316a5c8941decbb4afe6812b704a76214a725", "message": "Cleanup Realm files", "committedDate": "2020-08-31T13:46:19Z", "type": "commit"}, {"oid": "3cbd5e8bcc2aa2b978b3776a55e1648d44584d6a", "url": "https://github.com/realm/realm-java/commit/3cbd5e8bcc2aa2b978b3776a55e1648d44584d6a", "message": "Don't delay creating Realm instance and changelistener.", "committedDate": "2020-08-31T15:19:21Z", "type": "commit"}]}