{"pr_number": 6874, "pr_title": "Add custom decoder variant of callFunctions", "pr_createdAt": "2020-05-25T06:47:57Z", "pr_url": "https://github.com/realm/realm-java/pull/6874", "timeline": [{"oid": "285f6969bd517f54fffd44bc34e036ae49484f34", "url": "https://github.com/realm/realm-java/commit/285f6969bd517f54fffd44bc34e036ae49484f34", "message": "Add custom decoder variant of callFunctions", "committedDate": "2020-05-24T10:45:18Z", "type": "commit"}, {"oid": "139693cf404056757360757403508bff94512248", "url": "https://github.com/realm/realm-java/commit/139693cf404056757360757403508bff94512248", "message": "Extract reusable custom string decoder", "committedDate": "2020-05-25T09:37:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg1MTE3OA==", "url": "https://github.com/realm/realm-java/pull/6874#discussion_r429851178", "bodyText": "Is there a reason you are not calling invoke directly from the public callFunction methods?", "author": "cmelchior", "createdAt": "2020-05-25T10:04:36Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/functions/Functions.java", "diffHunk": "@@ -96,7 +97,34 @@ protected Functions(RealmUser user, CodecRegistry codecRegistry) {\n      * @see RealmAppConfiguration#getDefaultCodecRegistry()\n      */\n     public <T> T callFunction(String name, List<?> args, Class<T> resultClass) {\n-        return callFunction(name, args, resultClass, defaultCodecRegistry);\n+        return callFunction(name, args, defaultCodecRegistry, defaultCodecRegistry.get(resultClass));\n+    }\n+\n+    /**\n+     * Call a MongoDB Realm function synchronously with custom result decoder.\n+     * <p>\n+     * The arguments will be encoded with the default codec registry encoding.\n+     *\n+     * @param name Name of the Stitch function to call.\n+     * @param args Arguments to the Stitch function.\n+     * @param resultDecoder The decoder used to decode the result.\n+     * @param <T> The type that the response will be decoded as using the {@code resultDecoder}\n+     * @return Result of the Stitch function.\n+     *\n+     * @throws ObjectServerError if the request failed in some way.\n+     * @throws org.bson.codecs.configuration.CodecConfigurationException if the {@code codecRegistry}\n+     * does not provide codecs for the argument or {@code resultClass}.\n+     * @throws org.bson.BSONException is an error occurred during BSON processing.\n+     *\n+     * @see #callFunction(String, List, Class, CodecRegistry)\n+     * @see RealmAppConfiguration#getDefaultCodecRegistry()\n+     */\n+    public <T> T callFunction(String name, List<?> args, Decoder<T> resultDecoder) {\n+        return callFunction(name, args, defaultCodecRegistry, resultDecoder);\n+    }\n+\n+    <T> T callFunction(String name, List<?> args, CodecRegistry codecRegistry, Decoder<T> resultDecoder) {\n+        return invoke(name, args, codecRegistry, resultDecoder);", "originalCommit": "285f6969bd517f54fffd44bc34e036ae49484f34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg3NTY4OA==", "url": "https://github.com/realm/realm-java/pull/6874#discussion_r429875688", "bodyText": "No, did not streamline the various versions in the first go and did not catch that it ended up being a passthrough method in the end. \ud83d\udc4d", "author": "rorbech", "createdAt": "2020-05-25T11:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg1MTE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg1MjU1OA==", "url": "https://github.com/realm/realm-java/pull/6874#discussion_r429852558", "bodyText": "The Callback will always return ObjectServerError in case of an error, but it might just wrap the underlying exception. But this description is not entirely accurate.", "author": "cmelchior", "createdAt": "2020-05-25T10:07:40Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/functions/Functions.java", "diffHunk": "@@ -159,7 +181,44 @@ public T run() throws ObjectServerError {\n      * @see RealmAppConfiguration#getDefaultCodecRegistry()\n      */\n     public <T> RealmAsyncTask callFunctionAsync(String name, List<?> args, Class<T> resultClass, RealmApp.Callback<T> callback) {\n-        return callFunctionAsync(name, args, resultClass, defaultCodecRegistry, callback);\n+        return callFunctionAsync(name, args, defaultCodecRegistry, defaultCodecRegistry.get(resultClass), callback);\n+    }\n+\n+    /**\n+     * Call a MongoDB Realm function asynchronously with custom result decoder.\n+     * <p>\n+     * This is the asynchronous equivalent of {@link #callFunction(String, List, Decoder)}.\n+     *\n+     * @param name Name of the Stitch function to call.\n+     * @param args Arguments to the Stitch function.\n+     * @param resultDecoder The decoder used to decode the result.\n+     * @param callback The callback that will receive the result of the request. If the request", "originalCommit": "285f6969bd517f54fffd44bc34e036ae49484f34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg3NDI4Mg==", "url": "https://github.com/realm/realm-java/pull/6874#discussion_r429874282", "bodyText": "I see. Should we then introduce a specific client side encoding/decoding related error code and also encapsulate it as ObjectServerErrors in the synchronous case?\nAs I see it the most appropriate existing error code is INVALID_PARAMETER, but it sort of sounds like it would overlap with actual object server errors, whereas the encoding/decoding error is a client side error potentially caused by users misconfiguration of the codec registry etc.", "author": "rorbech", "createdAt": "2020-05-25T11:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg1MjU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg3NzI4MA==", "url": "https://github.com/realm/realm-java/pull/6874#discussion_r429877280", "bodyText": "That probably makes a lot of sense. The ErrorCode.java has a section for binding specific error codes, that are already wrapping other Java exceptions: https://github.com/realm/realm-java/blob/v10/realm/realm-library/src/objectServer/java/io/realm/ErrorCode.java#L41", "author": "cmelchior", "createdAt": "2020-05-25T11:10:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg1MjU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg5MDc5Nw==", "url": "https://github.com/realm/realm-java/pull/6874#discussion_r429890797", "bodyText": "There is also an already existing Type.JSON (https://github.com/realm/realm-java/blob/v10/realm/realm-library/src/objectServer/java/io/realm/ErrorCode.java#L326)  Would it make sense to use that for extended JSON too, or is it again object server internal (can't really find any use of it)?\nAnd can I just pick the actual error codes freely as long as it does not overlap any others with the same type (whether it ends up being Java or JSON)? Or are there other locations to investigate for overlap?", "author": "rorbech", "createdAt": "2020-05-25T11:44:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg1MjU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkzMDU1MA==", "url": "https://github.com/realm/realm-java/pull/6874#discussion_r429930550", "bodyText": "The JSON error type is an error category exposed by App in C++. I don't think we should use it for our own purpose.\nThe only requirement for error codes is that they should be unique within each section, so for Type.JAVA, 1000-1002 (I think) is already taken.", "author": "cmelchior", "createdAt": "2020-05-25T13:18:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg1MjU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzNzYwNw==", "url": "https://github.com/realm/realm-java/pull/6874#discussion_r430237607", "bodyText": "Added a couple of BSON related Type.JAVA error codes and now throws ObjectServerErrrors with the specific error codes on encoding, decoding and codec configuration errors", "author": "rorbech", "createdAt": "2020-05-26T08:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg1MjU1OA=="}], "type": "inlineReview"}, {"oid": "ae9e17947ca810d233d6110b8c67003d6b66a22d", "url": "https://github.com/realm/realm-java/commit/ae9e17947ca810d233d6110b8c67003d6b66a22d", "message": "Merge branch 'v10' into cr/functions", "committedDate": "2020-05-25T20:04:17Z", "type": "commit"}, {"oid": "b0a898a53822c37880f910e3e48ef0206dc05066", "url": "https://github.com/realm/realm-java/commit/b0a898a53822c37880f910e3e48ef0206dc05066", "message": "Introduced separate BSON coding error codes", "committedDate": "2020-05-26T07:41:13Z", "type": "commit"}, {"oid": "7f31dfde70ece76756e0cad65bac268eb57e96b9", "url": "https://github.com/realm/realm-java/commit/7f31dfde70ece76756e0cad65bac268eb57e96b9", "message": "Merge branch 'v10' into cr/functions", "committedDate": "2020-05-30T22:21:40Z", "type": "commit"}, {"oid": "5292f37a31d035d76318975afd42d2f9df41e99a", "url": "https://github.com/realm/realm-java/commit/5292f37a31d035d76318975afd42d2f9df41e99a", "message": "Included previously failing test cases along with C++ BSON parser fix from OS", "committedDate": "2020-05-30T22:38:06Z", "type": "commit"}]}