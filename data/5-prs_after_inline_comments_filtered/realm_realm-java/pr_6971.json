{"pr_number": 6971, "pr_title": "Implement a typed version of RealmAsyncTask", "pr_createdAt": "2020-06-26T13:57:53Z", "pr_url": "https://github.com/realm/realm-java/pull/6971", "timeline": [{"oid": "e9ab485b16a5d1e9e27ebedf522f9a217efdae34", "url": "https://github.com/realm/realm-java/commit/e9ab485b16a5d1e9e27ebedf522f9a217efdae34", "message": "Added RealmAsyncResultTask and implementation and tests for the latter. This class exposes the blockingGet and get methods, that allow users to retrieve results from a task", "committedDate": "2020-06-26T13:41:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4MzQwNg==", "url": "https://github.com/realm/realm-java/pull/6971#discussion_r446783406", "bodyText": "Given that we normally use the pattern <method>Async I would suggest we do the same here instead of reversing it.", "author": "cmelchior", "createdAt": "2020-06-29T05:40:38Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/RealmAsyncResultTask.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb;\n+\n+import io.realm.RealmAsyncTask;\n+\n+/**\n+ * FIXME\n+ */\n+public interface RealmAsyncResultTask<T> extends RealmAsyncTask {\n+\n+    /**\n+     * FIXME\n+     *\n+     * @return\n+     */\n+    T blockingGet();", "originalCommit": "e9ab485b16a5d1e9e27ebedf522f9a217efdae34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4NDQyMA==", "url": "https://github.com/realm/realm-java/pull/6971#discussion_r446784420", "bodyText": "It would have been ideal if this could have been more generic, but if we don't want to use this class for anything in the \"base\" API. This is fine. It also makes the callback a bit more clear as we can use the App.Callback` instead of coming up with yet another callback interface.", "author": "cmelchior", "createdAt": "2020-06-29T05:44:06Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/RealmAsyncResultTask.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb;", "originalCommit": "e9ab485b16a5d1e9e27ebedf522f9a217efdae34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg5OTM1Nw==", "url": "https://github.com/realm/realm-java/pull/6971#discussion_r446899357", "bodyText": "I had the exact same thought. I reached the same conclusion as you regarding the callback, as it seems it's very app-oriented, so I opted to leave it like this. I thought of creating a Callback interface and have App.Callback implement it, which would have allowed having other types of callbacks as well, but this would have entailed having different callback-handling mechanisms too. I'm not entirely sure I have the knowledge to determine which is the best option though...", "author": "edualonso", "createdAt": "2020-06-29T11:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4NDQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4NjQyMw==", "url": "https://github.com/realm/realm-java/pull/6971#discussion_r446786423", "bodyText": "I don't have a strong opinion. RealmAsyncResultTask is a bit long and RealmResultTask does feel a bit more readable, but up to you.", "author": "cmelchior", "createdAt": "2020-06-29T05:50:55Z", "path": "realm/realm-library/src/objectServer/java/io/realm/internal/async/RealmAsyncResultTaskImpl.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.internal.async;\n+\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ThreadPoolExecutor;\n+\n+import io.realm.internal.RealmNotifier;\n+import io.realm.internal.android.AndroidCapabilities;\n+import io.realm.internal.android.AndroidRealmNotifier;\n+import io.realm.log.RealmLog;\n+import io.realm.mongodb.App;\n+import io.realm.mongodb.AppException;\n+import io.realm.mongodb.ErrorCode;\n+import io.realm.mongodb.RealmAsyncResultTask;\n+\n+/**\n+ * FIXME - would RealmResultTask be a more suitable name given that it offers both blocking and async result-retrieval?", "originalCommit": "e9ab485b16a5d1e9e27ebedf522f9a217efdae34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4NzQ5Ng==", "url": "https://github.com/realm/realm-java/pull/6971#discussion_r446787496", "bodyText": "There isn't anything checking if you call this on a thread without a Looper. Not exactly sure what happens, but it probably blows up with some weird exception. There also seem to tests lacking around this.\nIdeally, we should throw an exception when you call task.get(callback) if the caller thread doesn't have a Looper.", "author": "cmelchior", "createdAt": "2020-06-29T05:54:32Z", "path": "realm/realm-library/src/objectServer/java/io/realm/internal/async/RealmAsyncResultTaskImpl.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.internal.async;\n+\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ThreadPoolExecutor;\n+\n+import io.realm.internal.RealmNotifier;\n+import io.realm.internal.android.AndroidCapabilities;\n+import io.realm.internal.android.AndroidRealmNotifier;\n+import io.realm.log.RealmLog;\n+import io.realm.mongodb.App;\n+import io.realm.mongodb.AppException;\n+import io.realm.mongodb.ErrorCode;\n+import io.realm.mongodb.RealmAsyncResultTask;\n+\n+/**\n+ * FIXME - would RealmResultTask be a more suitable name given that it offers both blocking and async result-retrieval?\n+ *\n+ * @param <T>\n+ */\n+public class RealmAsyncResultTaskImpl<T> implements RealmAsyncResultTask<T> {\n+\n+    private Future<?> pendingTask;\n+    private volatile boolean isCancelled = false;\n+    private final ThreadPoolExecutor service;\n+    private RealmNotifier handler = new AndroidRealmNotifier(null, new AndroidCapabilities());\n+    private Executor<T> executor;\n+\n+    /**\n+     * FIXME\n+     *\n+     * @param service\n+     * @param executor\n+     */\n+    public RealmAsyncResultTaskImpl(ThreadPoolExecutor service, Executor<T> executor) {\n+        this.service = service;\n+        this.executor = executor;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void cancel() {\n+        if (pendingTask != null) {\n+            pendingTask.cancel(true);\n+            isCancelled = true;\n+\n+            // From \"Java Threads\": By Scott Oaks & Henry Wong\n+            // cancelled tasks are never executed, but may\n+            // accumulate in work queues, which may causes a memory leak\n+            // if the task hold references (to an enclosing class for example)\n+            // we can use purge() but one caveat applies: if a second thread attempts to add\n+            // something to the pool (using the execute() method) at the same time the\n+            // first thread is attempting to purge the queue the attempt to purge\n+            // the queue fails and the cancelled object remain in the queue.\n+            // A better way to cancel objects with thread pools is to use the remove()\n+            service.getQueue().remove(pendingTask);\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean isCancelled() {\n+        return isCancelled;\n+    }\n+\n+    @Override\n+    public T blockingGet() {\n+        return executor.run();\n+    }\n+\n+    @Override\n+    public void get(App.Callback<T> callback) {\n+        pendingTask = service.submit(new Runnable() {\n+            @Override\n+            public void run() {\n+                try {\n+                    postSuccess(executor.run(), callback);\n+                } catch (AppException e) {\n+                    postError(e, callback);\n+                } catch (Throwable e) {\n+                    postError(new AppException(ErrorCode.UNKNOWN, \"Unexpected error\", e), callback);\n+                }\n+            }\n+        });\n+    }\n+\n+    private void postError(final AppException error, App.Callback<T> callback) {\n+        boolean errorHandled = false;\n+        if (callback != null) {\n+            Runnable action = new Runnable() {\n+                @Override\n+                public void run() {\n+                    callback.onResult(App.Result.withError(error));\n+                }\n+            };\n+            errorHandled = handler.post(action);\n+        }\n+\n+        if (!errorHandled) {\n+            RealmLog.error(error, \"An error was thrown, but could not be posted: \\n\" + error.toString());\n+        }\n+    }\n+\n+    private void postSuccess(final T result, App.Callback<T> callback) {\n+        if (callback != null) {\n+            handler.post(new Runnable() {", "originalCommit": "e9ab485b16a5d1e9e27ebedf522f9a217efdae34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNTQ1Mg==", "url": "https://github.com/realm/realm-java/pull/6971#discussion_r446905452", "bodyText": "I wasn't totally on the right page in regards to this, but it doesn't seem to be crashing. The AndroidRealmNotifier.post method does this check: handler != null && handler.post(runnable), and we only have a handler if we have a looper, i.e.:\nif (capabilities.canDeliverNotification()) {\n            handler = new Handler(Looper.myLooper());\n        } else {\n            handler = null;\n        }\n\nIt looks like post will simply return false if the thread doesn't have a looper - I don't know if this is expected behaviour though?\nI will add a call to Util.checkLooperThread from the task class nonetheless.", "author": "edualonso", "createdAt": "2020-06-29T11:42:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4NzQ5Ng=="}], "type": "inlineReview"}, {"oid": "cc2331de6e7522c00982996ac830db09efb0a537", "url": "https://github.com/realm/realm-java/commit/cc2331de6e7522c00982996ac830db09efb0a537", "message": "Changed method names, added checks for illegal arguments and looper thread, plus added documentation", "committedDate": "2020-06-29T12:28:48Z", "type": "commit"}, {"oid": "74e1e3518e63afbeac3af6df3e38af3e822c11f5", "url": "https://github.com/realm/realm-java/commit/74e1e3518e63afbeac3af6df3e38af3e822c11f5", "message": "Merge branch 'v10' into el/async-task", "committedDate": "2020-06-29T12:36:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0ODIyMA==", "url": "https://github.com/realm/realm-java/pull/6971#discussion_r447948220", "bodyText": "This description doesn't really say anything you cannot tell from just reading the class name. Perhaps something like Implementation of RealmResultTask used internally by MongoDB Realm API's. Implementation is separate from the interface so we can hide the constructor from end users.", "author": "cmelchior", "createdAt": "2020-06-30T20:06:59Z", "path": "realm/realm-library/src/objectServer/java/io/realm/internal/async/RealmResultTaskImpl.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.internal.async;\n+\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ThreadPoolExecutor;\n+\n+import io.realm.internal.RealmNotifier;\n+import io.realm.internal.Util;\n+import io.realm.internal.android.AndroidCapabilities;\n+import io.realm.internal.android.AndroidRealmNotifier;\n+import io.realm.log.RealmLog;\n+import io.realm.mongodb.App;\n+import io.realm.mongodb.AppException;\n+import io.realm.mongodb.ErrorCode;\n+import io.realm.mongodb.RealmResultTask;\n+\n+/**\n+ * Specific implementation of {@link RealmResultTask}.", "originalCommit": "74e1e3518e63afbeac3af6df3e38af3e822c11f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0ODg0Nw==", "url": "https://github.com/realm/realm-java/pull/6971#discussion_r447948847", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * mechanism to work with asynchronous operations carried out against the Object Server.\n          \n          \n            \n             * mechanism to work with asynchronous operations carried out against MongoDB Realm.", "author": "cmelchior", "createdAt": "2020-06-30T20:08:07Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/RealmResultTask.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb;\n+\n+import io.realm.RealmAsyncTask;\n+\n+/**\n+ * The RealmResultTask is a specific version of the {@link RealmAsyncTask} that provides a\n+ * mechanism to work with asynchronous operations carried out against the Object Server.", "originalCommit": "74e1e3518e63afbeac3af6df3e38af3e822c11f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0OTYxMQ==", "url": "https://github.com/realm/realm-java/pull/6971#discussion_r447949611", "bodyText": "Missing @throws message about what happens if you call this from a non-looper Thread.", "author": "cmelchior", "createdAt": "2020-06-30T20:09:33Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/RealmResultTask.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb;\n+\n+import io.realm.RealmAsyncTask;\n+\n+/**\n+ * The RealmResultTask is a specific version of the {@link RealmAsyncTask} that provides a\n+ * mechanism to work with asynchronous operations carried out against the Object Server.\n+ * <p>\n+ * This class offers both blocking ({@code get}) and non-blocking ({@code getAsync}) method calls.\n+ *\n+ * @param <T> the result type delivered by this task.\n+ */\n+public interface RealmResultTask<T> extends RealmAsyncTask {\n+\n+    /**\n+     * Blocks the thread on which the call is made until the result of the operation arrives.\n+     *\n+     * @return the result of the operation executed by this task.\n+     */\n+    T get();\n+\n+    /**\n+     * Provides a way to subscribe to asynchronous operations via a callback, which handles both\n+     * results and errors.\n+     *\n+     * @param callback the {@link App.Callback} designed to receive results.", "originalCommit": "74e1e3518e63afbeac3af6df3e38af3e822c11f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a893409325fef562d054086232bede16d4804162", "url": "https://github.com/realm/realm-java/commit/a893409325fef562d054086232bede16d4804162", "message": "Added nonnullbydefault and modified tests accordingly, updated docs.", "committedDate": "2020-06-30T21:55:48Z", "type": "commit"}, {"oid": "9fe52946e908f398df16c7edc4a055cc0083af67", "url": "https://github.com/realm/realm-java/commit/9fe52946e908f398df16c7edc4a055cc0083af67", "message": "Changed wrong names in test functions, added test for cancelling tasks", "committedDate": "2020-07-01T08:29:27Z", "type": "commit"}, {"oid": "7ce68d2b00b4fbadf03dfdd4a8606795307627e5", "url": "https://github.com/realm/realm-java/commit/7ce68d2b00b4fbadf03dfdd4a8606795307627e5", "message": "Added guard to avoid callback if task has been marked as cancelled", "committedDate": "2020-07-01T10:42:24Z", "type": "commit"}]}