{"pr_number": 5562, "pr_title": "fix(TBD-11616): parameterize dataset API utilization", "pr_createdAt": "2020-11-25T16:48:57Z", "pr_url": "https://github.com/Talend/tdi-studio-se/pull/5562", "timeline": [{"oid": "3fb3003a46e671379ee6d52c0bf3a42d0dcb0d1c", "url": "https://github.com/Talend/tdi-studio-se/commit/3fb3003a46e671379ee6d52c0bf3a42d0dcb0d1c", "message": "fix(TBD-11616): parameterize dataset API utilization", "committedDate": "2020-11-25T16:42:24Z", "type": "commit"}, {"oid": "9b6aaf944fa819f0a7a68d5aed941f06547a94d5", "url": "https://github.com/Talend/tdi-studio-se/commit/9b6aaf944fa819f0a7a68d5aed941f06547a94d5", "message": "apply migration to only 7.3 and 7.4 studios", "committedDate": "2020-11-26T14:38:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyOTc2OA==", "url": "https://github.com/Talend/tdi-studio-se/pull/5562#discussion_r531629768", "bodyText": "Can't we have something like talendStudioVersion.compareTo(\"7.3.1\") < 0 so that this is compatible with future versions also ?", "author": "lbourgeois", "createdAt": "2020-11-27T14:22:46Z", "path": "main/plugins/org.talend.repository/src/main/java/org/talend/repository/model/migration/spark/SetDatasetCheckBoxGlobalOption.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ============================================================================\n+//\n+// Copyright (C) 2006-2019 Talend Inc. - www.talend.com\n+//\n+// This source code is available under agreement available at\n+// %InstallDIR%\\features\\org.talend.rcp.branding.%PRODUCTNAME%\\%PRODUCTNAME%license.txt\n+//\n+// You should have received a copy of the agreement\n+// along with this program; if not, write to Talend SA\n+// 9 rue Pages 92150 Suresnes, France\n+//\n+// ============================================================================\n+package org.talend.repository.model.migration.spark;\n+\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.GregorianCalendar;\n+import java.util.List;\n+\n+import org.talend.commons.exception.ExceptionHandler;\n+import org.talend.commons.exception.PersistenceException;\n+import org.talend.core.model.migration.AbstractJobMigrationTask;\n+import org.talend.core.model.properties.Item;\n+import org.talend.core.model.properties.impl.AdditionalInfoMapImpl;\n+import org.talend.core.model.repository.ERepositoryObjectType;\n+import org.talend.core.repository.model.ProxyRepositoryFactory;\n+import org.talend.designer.core.model.utils.emf.talendfile.ElementParameterType;\n+import org.talend.designer.core.model.utils.emf.talendfile.ProcessType;\n+import org.talend.designer.core.model.utils.emf.talendfile.TalendFileFactory;\n+import org.talend.designer.core.model.utils.emf.talendfile.impl.ElementParameterTypeImpl;\n+\n+/**\n+ *\n+ * @author ametivier\n+ *\n+ * to keep retro compatibility with some components that used specific RDD implementation that don't behave the same with\n+ * dataset API in spark, migrated job from previous versions will by default use RDD implementation instead of dataset\n+ * according to spark version value.\n+ *\n+ */\n+public class SetDatasetCheckBoxGlobalOption extends AbstractJobMigrationTask {\n+    \n+    private String CHECKBOX_DATASET = \"USE_DATASET_API\"; //$NON-NLS-1$\n+    \n+    @Override\n+    public Date getOrder() {\n+        GregorianCalendar gc = new GregorianCalendar(2020, 11, 25, 10, 0, 0);\n+        return gc.getTime();\n+    }\n+    \n+    @Override\n+    public List<ERepositoryObjectType> getTypes() {\n+        return Arrays.asList(ERepositoryObjectType.PROCESS_MR);\n+    }\n+\n+    @Override\n+    public ExecutionResult execute(Item item) {\n+        ProcessType processType = getProcessType(item);\n+        if (processType == null) {\n+            return ExecutionResult.NOTHING_TO_DO;\n+        }\n+        List<AdditionalInfoMapImpl> properties = item.getProperty().getAdditionalProperties();\n+        String talendVersionUsedToCreateJob = null;\n+        for (AdditionalInfoMapImpl property : properties) {\n+        \tif (\"created_product_version\".equals(property.getKey().toString())) {\n+        \t\ttalendVersionUsedToCreateJob = property.getValue().toString();\n+        \t}\n+        }\n+        try {\n+    \t\tsetGlobalOption(processType, item, talendVersionUsedToCreateJob);\n+            return ExecutionResult.SUCCESS_NO_ALERT;\n+        } catch (Exception e) {\n+            ExceptionHandler.process(e);\n+            return ExecutionResult.FAILURE;\n+        }\n+    }\n+    \n+    private void setGlobalOption(ProcessType processType, Item item, String talendStudioVersion) throws PersistenceException {\n+    \tElementParameterType property = TalendFileFactory.eINSTANCE.createElementParameterType();\n+        property.setName(CHECKBOX_DATASET); //$NON-NLS-1$\n+        property.setField(\"CHECK\"); //$NON-NLS-1$\n+        property.setValue(\"false\"); //$NON-NLS-1$\n+        boolean isParameterAlreadyAdded = processType.getParameters().getElementParameter().stream().anyMatch(x -> \"USE_DATASET_API\".equals(((ElementParameterTypeImpl) x).getName()));\n+        if (!isParameterAlreadyAdded && !talendStudioVersion.startsWith(\"7.3.1\") && !talendStudioVersion.startsWith(\"7.4.1\")) {", "originalCommit": "9b6aaf944fa819f0a7a68d5aed941f06547a94d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYzNzg0Ng==", "url": "https://github.com/Talend/tdi-studio-se/pull/5562#discussion_r531637846", "bodyText": "I actually was wondering if someone would say that, I don't think that condition will either be true for 7.5.1 for example, but I'm ready to take the bet with you :D", "author": "AlixMetivier", "createdAt": "2020-11-27T14:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyOTc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYzNzkxOQ==", "url": "https://github.com/Talend/tdi-studio-se/pull/5562#discussion_r531637919", "bodyText": "(ill change it, that said ;))", "author": "AlixMetivier", "createdAt": "2020-11-27T14:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyOTc2OA=="}], "type": "inlineReview"}, {"oid": "031fa0f5b3de20085187ef8acb15f0c863b0df86", "url": "https://github.com/Talend/tdi-studio-se/commit/031fa0f5b3de20085187ef8acb15f0c863b0df86", "message": "Merge branch 'maintenance/7.3' into fix/TBD-11616", "committedDate": "2020-11-27T14:39:42Z", "type": "commit"}, {"oid": "45b40856928dcf629891a7720f96ce43b84b0fb4", "url": "https://github.com/Talend/tdi-studio-se/commit/45b40856928dcf629891a7720f96ce43b84b0fb4", "message": "fix for future studio versions", "committedDate": "2020-11-27T14:41:43Z", "type": "commit"}, {"oid": "10e329d45655c144b3f65da60a660a9084ab2df5", "url": "https://github.com/Talend/tdi-studio-se/commit/10e329d45655c144b3f65da60a660a9084ab2df5", "message": "Merge branch 'maintenance/7.3' of https://github.com/Talend/tdi-studio-se into fix/TBD-11616", "committedDate": "2020-12-02T09:25:26Z", "type": "commit"}, {"oid": "650d46dc9197880fd7d563a2454774b0071ebbab", "url": "https://github.com/Talend/tdi-studio-se/commit/650d46dc9197880fd7d563a2454774b0071ebbab", "message": "fix bad merge", "committedDate": "2020-12-02T11:32:33Z", "type": "commit"}, {"oid": "bcb6b0e88a03299dfb66d116d3f731dc56e17756", "url": "https://github.com/Talend/tdi-studio-se/commit/bcb6b0e88a03299dfb66d116d3f731dc56e17756", "message": "Merge branch 'maintenance/7.3' of https://github.com/Talend/tdi-studio-se into fix/TBD-11616", "committedDate": "2020-12-07T09:39:15Z", "type": "commit"}, {"oid": "99e9283f7c5e02371fa1409aff8ce2435c895113", "url": "https://github.com/Talend/tdi-studio-se/commit/99e9283f7c5e02371fa1409aff8ce2435c895113", "message": "Merge branch 'maintenance/7.3' of https://github.com/Talend/tdi-studio-se into fix/TBD-11616", "committedDate": "2020-12-10T08:03:31Z", "type": "commit"}]}