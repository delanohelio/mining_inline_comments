{"pr_number": 150, "pr_title": "#149 - Exception logging in LoggingSlice", "pr_createdAt": "2020-05-18T14:57:52Z", "pr_url": "https://github.com/artipie/http/pull/150", "timeline": [{"oid": "b42da09d0a76f6a36ea2fb83c127402e8b485dcb", "url": "https://github.com/artipie/http/commit/b42da09d0a76f6a36ea2fb83c127402e8b485dcb", "message": "#149 - Exception logging in LoggingSlice", "committedDate": "2020-05-18T14:58:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2NzExNw==", "url": "https://github.com/artipie/http/pull/150#discussion_r427467117", "bodyText": "@olegmoz Wouldn't we be loggin the exception twice in this case (one in line 96 and another in 103)?", "author": "paulodamaso", "createdAt": "2020-05-19T17:16:18Z", "path": "src/main/java/com/artipie/http/slice/LoggingSlice.java", "diffHunk": "@@ -81,8 +87,33 @@ public Response response(\n         final StringBuilder msg = new StringBuilder(\">> \").append(line);\n         LoggingSlice.append(msg, headers);\n         Logger.log(this.level, this.slice, msg.toString());\n-        return connection -> this.slice.response(line, headers, body)\n-            .send(new LoggingConnection(connection));\n+        return connection -> {", "originalCommit": "b42da09d0a76f6a36ea2fb83c127402e8b485dcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA3NDM0MQ==", "url": "https://github.com/artipie/http/pull/150#discussion_r428074341", "bodyText": "@paulodamaso no, that won't happen. These two cases for different cases of errors: thrown in sync code or returned normally as completion stage", "author": "olegmoz", "createdAt": "2020-05-20T14:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2NzExNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2ODk0NA==", "url": "https://github.com/artipie/http/pull/150#discussion_r427468944", "bodyText": "@olegmoz How about creating a new class, Logged? We could reuse it in all other slices, and it would be easier to unit test it", "author": "paulodamaso", "createdAt": "2020-05-19T17:19:23Z", "path": "src/main/java/com/artipie/http/slice/LoggingSlice.java", "diffHunk": "@@ -81,8 +87,33 @@ public Response response(\n         final StringBuilder msg = new StringBuilder(\">> \").append(line);\n         LoggingSlice.append(msg, headers);\n         Logger.log(this.level, this.slice, msg.toString());\n-        return connection -> this.slice.response(line, headers, body)\n-            .send(new LoggingConnection(connection));\n+        return connection -> {\n+            try {\n+                return this.slice.response(line, headers, body)\n+                    .send(new LoggingConnection(connection))\n+                    .exceptionally(\n+                        throwable -> {\n+                            this.log(throwable);\n+                            Throwables.throwIfUnchecked(throwable);\n+                            throw new CompletionException(throwable);\n+                        }\n+                    );\n+            } catch (final Exception ex) {\n+                this.log(ex);\n+                throw ex;\n+            }\n+        };\n+    }\n+\n+    /**\n+     * Writes throwable to logger.\n+     *\n+     * @param throwable Throwable to be logged.\n+     */\n+    private void log(final Throwable throwable) {", "originalCommit": "b42da09d0a76f6a36ea2fb83c127402e8b485dcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA4MjUwOQ==", "url": "https://github.com/artipie/http/pull/150#discussion_r428082509", "bodyText": "@paulodamaso sorry, I do not like the idea. Logged does not make much sense to me and looks like artificial way to provide log method implementation", "author": "olegmoz", "createdAt": "2020-05-20T14:59:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2ODk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3MjQ3Mw==", "url": "https://github.com/artipie/http/pull/150#discussion_r427472473", "bodyText": "@olegmoz I don't see the utility of these tests; we are not assuring that the exception was logged. How about:\n\nextract the private log method to a new class (see above)\nmake this class receive a writer\nexecute the LoggingSlicewith error and check if the error log was appended to the writer", "author": "paulodamaso", "createdAt": "2020-05-19T17:24:52Z", "path": "src/test/java/com/artipie/http/slice/LoggingSliceTest.java", "diffHunk": "@@ -61,4 +67,63 @@ void shouldLogRequestAndResponse() {\n             (status, headers, body) -> CompletableFuture.allOf()\n         ).toCompletableFuture().join();\n     }\n+\n+    @Test\n+    void shouldLogAndPreserveExceptionInSlice() {", "originalCommit": "b42da09d0a76f6a36ea2fb83c127402e8b485dcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA4MTc1NQ==", "url": "https://github.com/artipie/http/pull/150#discussion_r428081755", "bodyText": "@paulodamaso I do not agree that these tests are useless, it is important that errors are not getting consumed by this slice. Though that's true, that main functionality of this class is not tested. There was discussion about it when this class was first created, and we agreed that testing it does not worth the effort of mocking logging system.\nAlso providing the logging method in constructor will make usage of this class harder. That is why logging is done by static methods everywhere.", "author": "olegmoz", "createdAt": "2020-05-20T14:58:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3MjQ3Mw=="}], "type": "inlineReview"}, {"oid": "ea41dadac6cced430ae7643fda00386e91cab835", "url": "https://github.com/artipie/http/commit/ea41dadac6cced430ae7643fda00386e91cab835", "message": "Merge branch 'master' into 149-logging-slice-errors", "committedDate": "2020-05-20T08:32:33Z", "type": "commit"}, {"oid": "551295139363c7c6cd61e1f1aa1d51a45de16121", "url": "https://github.com/artipie/http/commit/551295139363c7c6cd61e1f1aa1d51a45de16121", "message": "Merge branch 'master' into 149-logging-slice-errors", "committedDate": "2020-05-21T08:21:50Z", "type": "commit"}, {"oid": "733e9781a7cbe6127d48e484856d7cdb60717184", "url": "https://github.com/artipie/http/commit/733e9781a7cbe6127d48e484856d7cdb60717184", "message": "Merge branch 'master' into 149-logging-slice-errors", "committedDate": "2020-05-21T14:44:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE4OTAyNA==", "url": "https://github.com/artipie/http/pull/150#discussion_r429189024", "bodyText": "@olegmoz why CompletionException here? According to the javadoc, it can be\n\nthrown when an error or other exception is encountered in the course of completing a result or task\n\nBut this throwable can be propagated from underlying slice error.", "author": "g4s8", "createdAt": "2020-05-22T11:18:43Z", "path": "src/main/java/com/artipie/http/slice/LoggingSlice.java", "diffHunk": "@@ -81,8 +87,33 @@ public Response response(\n         final StringBuilder msg = new StringBuilder(\">> \").append(line);\n         LoggingSlice.append(msg, headers);\n         Logger.log(this.level, this.slice, msg.toString());\n-        return connection -> this.slice.response(line, headers, body)\n-            .send(new LoggingConnection(connection));\n+        return connection -> {\n+            try {\n+                return this.slice.response(line, headers, body)\n+                    .send(new LoggingConnection(connection))\n+                    .exceptionally(\n+                        throwable -> {\n+                            this.log(throwable);\n+                            Throwables.throwIfUnchecked(throwable);\n+                            throw new CompletionException(throwable);", "originalCommit": "733e9781a7cbe6127d48e484856d7cdb60717184", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5OTE0Nw==", "url": "https://github.com/artipie/http/pull/150#discussion_r429199147", "bodyText": "@g4s8 didn't think of way to propagate the throwable as is. Found a solution now", "author": "olegmoz", "createdAt": "2020-05-22T11:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE4OTAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5MDEyOQ==", "url": "https://github.com/artipie/http/pull/150#discussion_r429190129", "bodyText": "@olegmoz these 3 lines can be simplified to:\nLogger.log(this.level, this.slice, \"Failure: %[exception]s\", throwable);", "author": "g4s8", "createdAt": "2020-05-22T11:21:34Z", "path": "src/main/java/com/artipie/http/slice/LoggingSlice.java", "diffHunk": "@@ -81,8 +87,33 @@ public Response response(\n         final StringBuilder msg = new StringBuilder(\">> \").append(line);\n         LoggingSlice.append(msg, headers);\n         Logger.log(this.level, this.slice, msg.toString());\n-        return connection -> this.slice.response(line, headers, body)\n-            .send(new LoggingConnection(connection));\n+        return connection -> {\n+            try {\n+                return this.slice.response(line, headers, body)\n+                    .send(new LoggingConnection(connection))\n+                    .exceptionally(\n+                        throwable -> {\n+                            this.log(throwable);\n+                            Throwables.throwIfUnchecked(throwable);\n+                            throw new CompletionException(throwable);\n+                        }\n+                    );\n+            } catch (final Exception ex) {\n+                this.log(ex);\n+                throw ex;\n+            }\n+        };\n+    }\n+\n+    /**\n+     * Writes throwable to logger.\n+     *\n+     * @param throwable Throwable to be logged.\n+     */\n+    private void log(final Throwable throwable) {\n+        final StringWriter writer = new StringWriter();\n+        throwable.printStackTrace(new PrintWriter(writer));\n+        Logger.log(this.level, this.slice, \"Failure: %s\", writer.toString());", "originalCommit": "733e9781a7cbe6127d48e484856d7cdb60717184", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5OTIyMQ==", "url": "https://github.com/artipie/http/pull/150#discussion_r429199221", "bodyText": "@g4s8 simplified it, thanks!", "author": "olegmoz", "createdAt": "2020-05-22T11:44:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5MDEyOQ=="}], "type": "inlineReview"}, {"oid": "18ea672325ea538a185b0bc96f91544d6195eb49", "url": "https://github.com/artipie/http/commit/18ea672325ea538a185b0bc96f91544d6195eb49", "message": "#149 - Changes by review", "committedDate": "2020-05-22T11:47:27Z", "type": "commit"}]}