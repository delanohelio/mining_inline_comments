{"pr_number": 1945, "pr_title": "Use read partition for finding update candidate on upsert", "pr_createdAt": "2020-06-26T15:52:18Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1945", "timeline": [{"oid": "f3a7170375fc76a9a785f303ad67b151427a5fde", "url": "https://github.com/hapifhir/hapi-fhir/commit/f3a7170375fc76a9a785f303ad67b151427a5fde", "message": "Use read partition for finding update candidate on upsert", "committedDate": "2020-06-26T15:51:34Z", "type": "commit"}, {"oid": "49b85541e200313300590947805c52afe47f5805", "url": "https://github.com/hapifhir/hapi-fhir/commit/49b85541e200313300590947805c52afe47f5805", "message": "Add changelog", "committedDate": "2020-06-26T15:54:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4NjM1MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1945#discussion_r446686350", "bodyText": "This is the opposite scenario of what FMC requires.  They are trying to do a PUT with a non-null partition in the request when the pre-existing resource had a null partition.\nI tried adding the following test, but it failed with an error:\n\t@Test\n\tpublic void testUpdate_ResourcePreExistsInNullPartition() {\n\t\tIIdType patientId = createPatient(withPutPartition(1), withId(\"ONE\"), withBirthdate(\"2020-01-01\"));\n\t\taddReadDefaultPartition();\n\t\taddCreateDefaultPartition();\n\n\t\tPatient p = new Patient();\n\t\tp.setId(patientId.toUnqualifiedVersionless());\n\t\tp.setGender(Enumerations.AdministrativeGender.MALE);\n\t\tmyPatientDao.update(p);\n\t}", "author": "fil512", "createdAt": "2020-06-28T19:06:27Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/PartitioningR4Test.java", "diffHunk": "@@ -2073,12 +2082,24 @@ public void testSearch_RefParam_TargetForcedId_SearchDefaultPartition() {\n \n \t}\n \n+\t@Test\n+\tpublic void testUpdate_ResourcePreExistsInWrongPartition() {\n+\t\tIIdType patientId = createPatient(withPutPartition(null), withId(\"ONE\"), withBirthdate(\"2020-01-01\"));", "originalCommit": "49b85541e200313300590947805c52afe47f5805", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzMDkwOQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1945#discussion_r447130909", "bodyText": "I think the existing test is the scenario you describe and the test you added is the opposite actually...\nPrecondition: A resource exists, and it's in the\nIIdType patientId = createPatient(withPutPartition(null), withId(\"ONE\"), withBirthdate(\"2020-01-01\"));\nTest:  Have a resource come in with a PUT where the ID already exists. User has read-all-partitions permission, but no write permission at all (since none is needed- nothing will be written).\naddReadAllPartitions();\n\nPatient p = new Patient();\np.setId(patientId.toUnqualifiedVersionless());\np.setGender(Enumerations.AdministrativeGender.MALE);\nmyPatientDao.update(p);", "author": "jamesagnew", "createdAt": "2020-06-29T17:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4NjM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0NjcxNQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1945#discussion_r447246715", "bodyText": "Ah ok.  Looks like I read the test backwards.  Sounds like it's all good.", "author": "fil512", "createdAt": "2020-06-29T20:52:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4NjM1MA=="}], "type": "inlineReview"}, {"oid": "cf72be76a10b05b44dd596e8d99adf7cf1535898", "url": "https://github.com/hapifhir/hapi-fhir/commit/cf72be76a10b05b44dd596e8d99adf7cf1535898", "message": "Merge branch 'master' into ja_20200626_use_read_partition_on_partitioned_client_assigned_id", "committedDate": "2020-06-29T21:10:54Z", "type": "commit"}]}