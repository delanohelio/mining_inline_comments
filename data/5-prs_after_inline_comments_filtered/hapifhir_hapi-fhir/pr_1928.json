{"pr_number": 1928, "pr_title": "Im 20200615 mysql migration syntax", "pr_createdAt": "2020-06-16T21:25:22Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1928", "timeline": [{"oid": "0bd8084b5e4250b996d36defa995b06fe54debfb", "url": "https://github.com/hapifhir/hapi-fhir/commit/0bd8084b5e4250b996d36defa995b06fe54debfb", "message": "Additional fixes to migration tasks for MySQL.", "committedDate": "2020-06-16T20:05:10Z", "type": "commit"}, {"oid": "2d857f484c4a3bfbc04c7ed3d4a792d72b8705c9", "url": "https://github.com/hapifhir/hapi-fhir/commit/2d857f484c4a3bfbc04c7ed3d4a792d72b8705c9", "message": "Fix broken JUnit.", "committedDate": "2020-06-16T21:13:00Z", "type": "commit"}, {"oid": "cc7ed1b036061b8c04e58b57bbe73ae2ea5d2a67", "url": "https://github.com/hapifhir/hapi-fhir/commit/cc7ed1b036061b8c04e58b57bbe73ae2ea5d2a67", "message": "Cleanup JUnit test.", "committedDate": "2020-06-16T21:21:17Z", "type": "commit"}, {"oid": "eb990e9a68a855da05a7cfb1d268f12ad208f92d", "url": "https://github.com/hapifhir/hapi-fhir/commit/eb990e9a68a855da05a7cfb1d268f12ad208f92d", "message": "Enhance added JUnit test.", "committedDate": "2020-06-17T13:05:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUzNjQyNA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1928#discussion_r441536424", "bodyText": "In the rename scenario, don't we need to add those constraints back in after the rename?", "author": "fil512", "createdAt": "2020-06-17T13:17:07Z", "path": "hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/taskdef/RenameColumnTask.java", "diffHunk": "@@ -82,6 +84,20 @@ public void doExecute() throws SQLException {\n \t\t\t\t\tthrow new SQLException(\"Can not rename \" + getTableName() + \".\" + myOldName + \" to \" + myNewName + \" because both columns exist and data exists in \" + myNewName);\n \t\t\t\t}\n \n+\t\t\t\tif (getDriverType().equals(DriverTypeEnum.MYSQL_5_7)) {\n+\t\t\t\t\t// Some DBs such as MYSQL require that foreign keys depending on the column be dropped before the column itself is dropped.", "originalCommit": "eb990e9a68a855da05a7cfb1d268f12ad208f92d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1MzI2NQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1928#discussion_r441653265", "bodyText": "Good question. In this case, no I do not think there is a need to add the constraint back after rename. The constraint being dropped in this case depends on a column that is also being dropped (an existing column being replaced by renaming another existing column). As the renamed column would potentially have different data values, there is no guarantee that the old constraint will still be relevant.\nFor non-MySQL databases, it appears that these types of constraints are dropped automatically when the column is dropped. This does not happen for MySQL and so the change ensures that the constraint is similarly dropped in the case of MySQL.", "author": "IanMMarshall", "createdAt": "2020-06-17T15:55:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUzNjQyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUzNzYxMA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1928#discussion_r441537610", "bodyText": "I recommend adding a test for the rename column scenario to validate we don't lose the fk constraints on rename", "author": "fil512", "createdAt": "2020-06-17T13:18:50Z", "path": "hapi-fhir-jpaserver-migrate/src/test/java/ca/uhn/fhir/jpa/migrate/taskdef/DropColumnTest.java", "diffHunk": "@@ -34,4 +36,39 @@ public void testDropColumn() throws SQLException {\n \n \t}\n \n+\t@Test\n+\tpublic void testDropForeignKeyColumn() throws SQLException {", "originalCommit": "eb990e9a68a855da05a7cfb1d268f12ad208f92d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NzUwMw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1928#discussion_r441657503", "bodyText": "Good call. I have added tests for various scenarios involving renaming of columns that are used in foreign key constraints to confirm the existing behaviour and to ensure that the behaviour for MySQL use cases effectively matches that for non-MySQL DBs.", "author": "IanMMarshall", "createdAt": "2020-06-17T16:01:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUzNzYxMA=="}], "type": "inlineReview"}, {"oid": "5d22af45bf60ea904b6071ca75d2ac138ab4a0c6", "url": "https://github.com/hapifhir/hapi-fhir/commit/5d22af45bf60ea904b6071ca75d2ac138ab4a0c6", "message": "Added tests for cases where a renamed column is used in a Foreign Key constraint.", "committedDate": "2020-06-17T15:56:20Z", "type": "commit"}, {"oid": "5b120ee71e752d97098b2b6377199c502f79d948", "url": "https://github.com/hapifhir/hapi-fhir/commit/5b120ee71e752d97098b2b6377199c502f79d948", "message": "Removed unused code and import statement.", "committedDate": "2020-06-17T15:57:37Z", "type": "commit"}]}