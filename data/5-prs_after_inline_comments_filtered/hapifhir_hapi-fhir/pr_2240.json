{"pr_number": 2240, "pr_title": "Add support for composite sorting", "pr_createdAt": "2020-12-12T04:11:51Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/2240", "timeline": [{"oid": "dcbdc83d8eb8a22c7d23b1a73cf54c927039bca5", "url": "https://github.com/hapifhir/hapi-fhir/commit/dcbdc83d8eb8a22c7d23b1a73cf54c927039bca5", "message": "Supported composite sort", "committedDate": "2020-12-12T02:50:32Z", "type": "commit"}, {"oid": "0411967e26add7dd1c6a2feae4f03b6742e9abfc", "url": "https://github.com/hapifhir/hapi-fhir/commit/0411967e26add7dd1c6a2feae4f03b6742e9abfc", "message": "Added composite sort test case for R5", "committedDate": "2020-12-12T03:25:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0NzA0Ng==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544547046", "bodyText": "Should avoid prefixing the name of the composite list variable with the. We usually reserve this prefix for parameters that were passed to the method (not for local variables). Maybe just change the name of this variable to compositeList?", "author": "IanMMarshall", "createdAt": "2020-12-16T18:59:39Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/builder/SearchBuilder.java", "diffHunk": "@@ -528,9 +528,25 @@ private void createSort(QueryStack theQueryStack, SortSpec theSort) {\n \t\t\t\t\tbreak;\n \t\t\t\tcase QUANTITY:\n \t\t\t\t\ttheQueryStack.addSortOnQuantity(myResourceName, theSort.getParamName(), ascending);\n+\t\t\t\t\tbreak;\t\n+\t\t\t\tcase COMPOSITE:\n+\t\t\t\t\tList<RuntimeSearchParam> theCompositList = param.getCompositeOf();", "originalCommit": "0411967e26add7dd1c6a2feae4f03b6742e9abfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYwOTA2Mg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544609062", "bodyText": "will rename to compositeList", "author": "frankjtao", "createdAt": "2020-12-16T20:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0NzA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU1ODI1MQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544558251", "bodyText": "I am wondering if it's appropriate to support sorting on composites with reference,  number and uri param types given that the search functionality does not appear to support searching on composites that include these param types.\nIf we are going to support these types, then I think we should include tests for these types.", "author": "IanMMarshall", "createdAt": "2020-12-16T19:18:08Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/builder/SearchBuilder.java", "diffHunk": "@@ -542,6 +558,37 @@ private void createSort(QueryStack theQueryStack, SortSpec theSort) {\n \t\tcreateSort(theQueryStack, theSort.getChain());\n \n \t}\n+\t\n+\tprivate void createCompositeSort(QueryStack theQueryStack, String theResourceName, RestSearchParameterTypeEnum theParamType, String theParamName, boolean theAscending) {\n+\n+\t\tswitch (theParamType) {\n+\t\tcase STRING:\n+\t\t\ttheQueryStack.addSortOnString(myResourceName, theParamName, theAscending);\n+\t\t\tbreak;\n+\t\tcase DATE:\n+\t\t\ttheQueryStack.addSortOnDate(myResourceName, theParamName, theAscending);\n+\t\t\tbreak;\n+\t\tcase REFERENCE:", "originalCommit": "0411967e26add7dd1c6a2feae4f03b6742e9abfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYxMDYxNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544610617", "bodyText": "Will remove the other reference, number and uri option of the part of the composite, same as\n\n  \n    \n      hapi-fhir/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/builder/QueryStack.java\n    \n    \n         Line 299\n      in\n      d99b678\n    \n    \n    \n    \n\n        \n          \n           private Condition createPredicateCompositePart(@Nullable DbColumn theSourceJoinColumn, String theResourceName, RuntimeSearchParam theParam, IQueryParameterType theParamValue, RequestPartitionId theRequestPartitionId) {", "author": "frankjtao", "createdAt": "2020-12-16T20:45:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU1ODI1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0NTMyNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544645327", "bodyText": "Looks good.", "author": "IanMMarshall", "createdAt": "2020-12-16T21:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU1ODI1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU2MzMwMg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544563302", "bodyText": "One way you could test these edge cases (assuming you keep these) is to create resources with number, reference and/or uri values and then create a custom SearchParameter. The FhirResourceDaoR4SearchCustomSearchParamTest test class in ca.uhn.fhir.jpa.dao.r4 includes several examples of tests that use custom SearchParameter definitions that you might be able to adapt (although I admit that I am having troubles finding examples that include uri parameters other than maybe cases that involve resources with extensions).", "author": "IanMMarshall", "createdAt": "2020-12-16T19:26:22Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/builder/SearchBuilder.java", "diffHunk": "@@ -542,6 +558,37 @@ private void createSort(QueryStack theQueryStack, SortSpec theSort) {\n \t\tcreateSort(theQueryStack, theSort.getChain());\n \n \t}\n+\t\n+\tprivate void createCompositeSort(QueryStack theQueryStack, String theResourceName, RestSearchParameterTypeEnum theParamType, String theParamName, boolean theAscending) {\n+\n+\t\tswitch (theParamType) {\n+\t\tcase STRING:\n+\t\t\ttheQueryStack.addSortOnString(myResourceName, theParamName, theAscending);\n+\t\t\tbreak;\n+\t\tcase DATE:\n+\t\t\ttheQueryStack.addSortOnDate(myResourceName, theParamName, theAscending);\n+\t\t\tbreak;\n+\t\tcase REFERENCE:\n+\t\t\ttheQueryStack.addSortOnResourceLink(myResourceName, theParamName, theAscending);\n+\t\t\tbreak;", "originalCommit": "0411967e26add7dd1c6a2feae4f03b6742e9abfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYxMDc2Mg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544610762", "bodyText": "Same as above", "author": "frankjtao", "createdAt": "2020-12-16T20:45:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU2MzMwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0NjA3Ng==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544646076", "bodyText": "Fair enough.", "author": "IanMMarshall", "createdAt": "2020-12-16T21:46:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU2MzMwMg=="}], "type": "inlineReview"}, {"oid": "de845300c2910d3bc577744b084fd6d97b171c9f", "url": "https://github.com/hapifhir/hapi-fhir/commit/de845300c2910d3bc577744b084fd6d97b171c9f", "message": "Updated based on the review comments", "committedDate": "2020-12-16T20:48:10Z", "type": "commit"}]}