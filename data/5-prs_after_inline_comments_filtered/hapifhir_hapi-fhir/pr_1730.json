{"pr_number": 1730, "pr_title": "Add integer date fields to ResourceIndexedSearchParamDate", "pr_createdAt": "2020-02-25T22:22:35Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1730", "timeline": [{"oid": "614585cc1f82bf7550aaf524ba6f078b5485116c", "url": "https://github.com/hapifhir/hapi-fhir/commit/614585cc1f82bf7550aaf524ba6f078b5485116c", "message": "added failing test", "committedDate": "2019-09-21T11:42:04Z", "type": "commit"}, {"oid": "18d859281ede8147554f30885210c059d28df790", "url": "https://github.com/hapifhir/hapi-fhir/commit/18d859281ede8147554f30885210c059d28df790", "message": "Merge remote-tracking branch 'remotes/origin/master' into date-match-bug", "committedDate": "2020-02-24T16:47:43Z", "type": "commit"}, {"oid": "7f5b3394e001aa115e30cf5857cef7d4203c2280", "url": "https://github.com/hapifhir/hapi-fhir/commit/7f5b3394e001aa115e30cf5857cef7d4203c2280", "message": "Hacky first-pass of adding ordinal date field to ResourceIndexedSearchParamDate and using it for search", "committedDate": "2020-02-25T00:34:16Z", "type": "commit"}, {"oid": "34d5925393f2fae9b0edee790a24563422acbfae", "url": "https://github.com/hapifhir/hapi-fhir/commit/34d5925393f2fae9b0edee790a24563422acbfae", "message": "Move common work to DateUtils. Rename function for clarity.", "committedDate": "2020-02-25T14:37:57Z", "type": "commit"}, {"oid": "3b41b5b9601a69b4febbd4152f412abc435bc107", "url": "https://github.com/hapifhir/hapi-fhir/commit/3b41b5b9601a69b4febbd4152f412abc435bc107", "message": "Type migration to boxed integer to avoid int defaulting to 0", "committedDate": "2020-02-25T16:18:39Z", "type": "commit"}, {"oid": "13cc8b69aaaa3c825e1a2931a8b895bb4eb9dadb", "url": "https://github.com/hapifhir/hapi-fhir/commit/13cc8b69aaaa3c825e1a2931a8b895bb4eb9dadb", "message": "Add schema migration", "committedDate": "2020-02-25T16:27:08Z", "type": "commit"}, {"oid": "3ec772b527f89dc40ff7d632cdb906e72a0d28c8", "url": "https://github.com/hapifhir/hapi-fhir/commit/3ec772b527f89dc40ff7d632cdb906e72a0d28c8", "message": "rework ResourceIndexedSearchParamDate constructor to support incoming string values", "committedDate": "2020-02-25T19:06:36Z", "type": "commit"}, {"oid": "da7224ff89ef6c5218399a96ef5944a1efe124da", "url": "https://github.com/hapifhir/hapi-fhir/commit/da7224ff89ef6c5218399a96ef5944a1efe124da", "message": "update broken test to reflect new reality of business logic of ordinal date comparison", "committedDate": "2020-02-25T19:07:03Z", "type": "commit"}, {"oid": "512af5b87d21fd9f7dfd1ad1ea8c53b2725ca527", "url": "https://github.com/hapifhir/hapi-fhir/commit/512af5b87d21fd9f7dfd1ad1ea8c53b2725ca527", "message": "Add changelog entry", "committedDate": "2020-02-25T19:09:51Z", "type": "commit"}, {"oid": "97c98254d0db82b0b34140e99e9ef85262ca931a", "url": "https://github.com/hapifhir/hapi-fhir/commit/97c98254d0db82b0b34140e99e9ef85262ca931a", "message": " Extract Common functionality out of CalculateHashesTask, build CalculateOrdinalDatesTask based on it", "committedDate": "2020-02-25T21:09:08Z", "type": "commit"}, {"oid": "f56e38148b6b48f18059dbd9c0b307be051b3174", "url": "https://github.com/hapifhir/hapi-fhir/commit/f56e38148b6b48f18059dbd9c0b307be051b3174", "message": "Add flag to DaoConfig controlling behaviour", "committedDate": "2020-02-25T21:43:17Z", "type": "commit"}, {"oid": "a1b6e37395746b006594ef144e2b33fab754feaf", "url": "https://github.com/hapifhir/hapi-fhir/commit/a1b6e37395746b006594ef144e2b33fab754feaf", "message": "Fix bug with Period bounds not counting as first value", "committedDate": "2020-02-25T22:03:50Z", "type": "commit"}, {"oid": "1e833af5f046c464414821011f66921ceb5460cf", "url": "https://github.com/hapifhir/hapi-fhir/commit/1e833af5f046c464414821011f66921ceb5460cf", "message": "Variable reuse", "committedDate": "2020-02-25T22:06:38Z", "type": "commit"}, {"oid": "2204fbeabd84a75ffd9171daa6c3a7251bd3ee11", "url": "https://github.com/hapifhir/hapi-fhir/commit/2204fbeabd84a75ffd9171daa6c3a7251bd3ee11", "message": "Adding some comments", "committedDate": "2020-02-25T22:08:11Z", "type": "commit"}, {"oid": "df9e86ec66386e00b2e25779e80cfbab83fe3218", "url": "https://github.com/hapifhir/hapi-fhir/commit/df9e86ec66386e00b2e25779e80cfbab83fe3218", "message": "Merge branch 'master' into date-match-bug", "committedDate": "2020-02-25T22:26:53Z", "type": "commit"}, {"oid": "165f5fd808a4d6cf5907bf5d8d915629e7e11224", "url": "https://github.com/hapifhir/hapi-fhir/commit/165f5fd808a4d6cf5907bf5d8d915629e7e11224", "message": "fix bugs in calculating ordinal date", "committedDate": "2020-02-26T14:32:20Z", "type": "commit"}, {"oid": "a97443b1ed075845b501a7f42354a1a941ec1e35", "url": "https://github.com/hapifhir/hapi-fhir/commit/a97443b1ed075845b501a7f42354a1a941ec1e35", "message": "Fix test failures. One caused by invalid test. One caused by granularity need LT not LTE", "committedDate": "2020-02-26T16:12:27Z", "type": "commit"}, {"oid": "077f9df814640d37be47af9acfa5b9afbd846ccc", "url": "https://github.com/hapifhir/hapi-fhir/commit/077f9df814640d37be47af9acfa5b9afbd846ccc", "message": "I keep finding more tests", "committedDate": "2020-02-26T17:04:33Z", "type": "commit"}, {"oid": "2dc94de6bb13962c715e626f0b95c8ac41805b59", "url": "https://github.com/hapifhir/hapi-fhir/commit/2dc94de6bb13962c715e626f0b95c8ac41805b59", "message": "roll back change to inmemory matcher test", "committedDate": "2020-02-26T19:31:35Z", "type": "commit"}, {"oid": "f86a4c9fa1cad9b1c3e2dd39ac400812ef3568f6", "url": "https://github.com/hapifhir/hapi-fhir/commit/f86a4c9fa1cad9b1c3e2dd39ac400812ef3568f6", "message": "Add date ordinals to subscription matching checker", "committedDate": "2020-02-26T22:05:23Z", "type": "commit"}, {"oid": "b1d7072c42d20e15d319675a923c51961b30e6c3", "url": "https://github.com/hapifhir/hapi-fhir/commit/b1d7072c42d20e15d319675a923c51961b30e6c3", "message": "Add precision checker for ordinal date returning on DateRangeParam", "committedDate": "2020-02-27T03:22:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg5MTY1Nw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1730#discussion_r385891657", "bodyText": "I feel like instead of having a whole bunch of if (isOrdinalComparison) for each of these, you could have one at the top where you say\nif (isOrdinalComparison) {\n   lowFieldName = \"myValueLowDateOrdinal\";\n} else {\n   lowFieldName = \"myValueLow\";\n... and avoid most of the duplication below.", "author": "jamesagnew", "createdAt": "2020-02-28T19:52:20Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/PredicateBuilderDate.java", "diffHunk": "@@ -150,67 +152,111 @@ private Predicate createPredicateDate(IQueryParameterType theParam,\n \t\treturn p;\n \t}\n \n+\tprivate boolean isNullOrDayPrecision(DateParam theDateParam) {\n+\t\treturn theDateParam == null || theDateParam.getPrecision().ordinal() == TemporalPrecisionEnum.DAY.ordinal();\n+\t}\n \tprivate Predicate createPredicateDateFromRange(CriteriaBuilder theBuilder,\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  From<?, ResourceIndexedSearchParamDate> theFrom,\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  DateRangeParam theRange,\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  SearchFilterParser.CompareOperation operation) {\n-\t\tDate lowerBound = theRange.getLowerBoundAsInstant();\n-\t\tDate upperBound = theRange.getUpperBoundAsInstant();\n+\t\tDate lowerBoundInstant = theRange.getLowerBoundAsInstant();\n+\t\tDate upperBoundInstant = theRange.getUpperBoundAsInstant();\n+\n+\t\tDateParam lowerBound = theRange.getLowerBound();\n+\t\tDateParam upperBound = theRange.getUpperBound();\n+\t\tInteger lowerBoundAsOrdinal = theRange.getLowerBoundAsDateInteger();\n+\t\tInteger upperBoundAsOrdinal = theRange.getUpperBoundAsDateInteger();\n+\n+\t\t/**\n+\t\t * If all present search parameters are of DAY precision, and {@link DaoConfig#getUseOrdinalDatesForDayPrecisionSearches()} is true,\n+\t\t * then we attempt to use the ordinal field for date comparisons instead of the date field.\n+\t\t */\n+\t\tboolean isOrdinalComparison = isNullOrDayPrecision(lowerBound) && isNullOrDayPrecision(upperBound) && myDaoConfig.getModelConfig().getUseOrdinalDatesForDayPrecisionSearches();\n+\n \t\tPredicate lt = null;\n \t\tPredicate gt = null;\n \t\tPredicate lb = null;\n \t\tPredicate ub = null;\n \n \t\tif (operation == SearchFilterParser.CompareOperation.lt) {\n-\t\t\tif (lowerBound == null) {\n+\t\t\tif (lowerBoundInstant == null) {\n \t\t\t\tthrow new InvalidRequestException(\"lowerBound value not correctly specified for compare operation\");\n \t\t\t}\n-\t\t\tlb = theBuilder.lessThan(theFrom.get(\"myValueLow\"), lowerBound);\n+\t\t\t//im like 80% sure this should be ub and not lb, as it is an UPPER bound.\n+\t\t\tif (isOrdinalComparison) {", "originalCommit": "b1d7072c42d20e15d319675a923c51961b30e6c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMDE5Nw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1730#discussion_r387320197", "bodyText": "Addressed in 6123e4b", "author": "tadgh", "createdAt": "2020-03-03T22:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg5MTY1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg5MjUyMg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1730#discussion_r385892522", "bodyText": "this should probably be an else", "author": "jamesagnew", "createdAt": "2020-02-28T19:53:27Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/PredicateBuilderDate.java", "diffHunk": "@@ -221,8 +267,10 @@ private Predicate createPredicateDateFromRange(CriteriaBuilder theBuilder,\n \t\t\tthrow new InvalidRequestException(String.format(\"Unsupported operator specified, operator=%s\",\n \t\t\t\toperation.name()));\n \t\t}\n-\n-\t\tourLog.trace(\"Date range is {} - {}\", lowerBound, upperBound);\n+\t\tif (isOrdinalComparison) {\n+\t\t\tourLog.trace(\"Ordinal date range is {} - {} \", lowerBoundAsOrdinal, upperBoundAsOrdinal);\n+\t\t}", "originalCommit": "b1d7072c42d20e15d319675a923c51961b30e6c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMTIzMw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1730#discussion_r387321233", "bodyText": "Addressed in a510543", "author": "tadgh", "createdAt": "2020-03-03T22:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg5MjUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg5NDUwMg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1730#discussion_r385894502", "bodyText": "I'm actually not sure this will work for the dates.. The reason is that it's possible for one of the dates (either SP_VALUE_HIGH or SP_VALUE_LOW to be saved as null even if the other isn't. For example if we were indexing a Period with a start date but no finish date...\nIt's probably gonna require something like SELECT FROM HFJ_SPIDX_DATE WHERE SP_VALUE_LOW IS NOT NULL AND SP_VALUE_LOW_ORDINAL IS NULL", "author": "jamesagnew", "createdAt": "2020-02-28T19:57:11Z", "path": "hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/taskdef/BaseColumnCalculatorTask.java", "diffHunk": "@@ -0,0 +1,271 @@\n+package ca.uhn.fhir.jpa.migrate.taskdef;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR JPA Server - Migration\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.jpa.migrate.JdbcUtils;\n+import ca.uhn.fhir.util.StopWatch;\n+import ca.uhn.fhir.util.VersionEnum;\n+import com.google.common.collect.ForwardingMap;\n+import org.apache.commons.lang3.Validate;\n+import org.apache.commons.lang3.concurrent.BasicThreadFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.jdbc.core.ColumnMapRowMapper;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.jdbc.core.RowCallbackHandler;\n+\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.*;\n+import java.util.concurrent.*;\n+import java.util.function.Function;\n+\n+public abstract class BaseColumnCalculatorTask extends BaseTableColumnTask<BaseColumnCalculatorTask> {\n+\n+\tprotected static final Logger ourLog = LoggerFactory.getLogger(BaseColumnCalculatorTask.class);\n+\tprivate int myBatchSize = 10000;\n+\tprivate Map<String, Function<MandatoryKeyMap<String, Object>, Object>> myCalculators = new HashMap<>();\n+\tprivate ThreadPoolExecutor myExecutor;\n+\n+\tpublic void setBatchSize(int theBatchSize) {\n+\t\tmyBatchSize = theBatchSize;\n+\t}\n+\n+\t/**\n+\t * Constructor\n+\t */\n+\tpublic BaseColumnCalculatorTask(VersionEnum theRelease, String theVersion) {\n+\t\tsuper(theRelease.toString(), theVersion);\n+\t}\n+\n+\t/**\n+\t * Allows concrete implementations to decide if they should be skipped.\n+\t * @return a boolean indicating whether or not to skip execution of the task.\n+\t */\n+\tprotected abstract boolean shouldSkipTask();\n+\n+\t@Override\n+\tpublic synchronized void doExecute() throws SQLException {\n+\t\tif (isDryRun() || shouldSkipTask()) {\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tinitializeExecutor();\n+\n+\t\ttry {\n+\n+\t\t\twhile(true) {\n+\t\t\t\tMyRowCallbackHandler rch = new MyRowCallbackHandler();\n+\t\t\t\tgetTxTemplate().execute(t -> {\n+\t\t\t\t\tJdbcTemplate jdbcTemplate = newJdbcTemplate();\n+\t\t\t\t\tjdbcTemplate.setMaxRows(100000);\n+\t\t\t\t\tString sql = \"SELECT * FROM \" + getTableName() + \" WHERE \" + getColumnName() + \" IS NULL\";", "originalCommit": "b1d7072c42d20e15d319675a923c51961b30e6c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MjgyMg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1730#discussion_r387372822", "bodyText": "Attempted to address this in 8b223a1, but this issue probably merits a minor refactor to more easily allow calculators, or table tasks, to determine their WHERE clauses. This is a hacky solution but it'll do until we can figure out a minor rework.", "author": "tadgh", "createdAt": "2020-03-04T00:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg5NDUwMg=="}], "type": "inlineReview"}, {"oid": "6123e4b189e450952043cf29c705ccda0ad1a12e", "url": "https://github.com/hapifhir/hapi-fhir/commit/6123e4b189e450952043cf29c705ccda0ad1a12e", "message": "rework based on PR comments", "committedDate": "2020-02-28T21:31:16Z", "type": "commit"}, {"oid": "df7a9916c39d66422eb8a67f7d3fa4ebf4accaf3", "url": "https://github.com/hapifhir/hapi-fhir/commit/df7a9916c39d66422eb8a67f7d3fa4ebf4accaf3", "message": "Swap from trace to info logging", "committedDate": "2020-03-03T22:01:12Z", "type": "commit"}, {"oid": "a5105439339d6cb94ed22308c97822932d20ad0e", "url": "https://github.com/hapifhir/hapi-fhir/commit/a5105439339d6cb94ed22308c97822932d20ad0e", "message": "Fix log conditional", "committedDate": "2020-03-03T22:03:55Z", "type": "commit"}, {"oid": "8b223a1fd9d7a34f22fdb688472ae59db524e93e", "url": "https://github.com/hapifhir/hapi-fhir/commit/8b223a1fd9d7a34f22fdb688472ae59db524e93e", "message": "Rework selection generation of calculator. Add null check for empty dates", "committedDate": "2020-03-04T00:07:25Z", "type": "commit"}, {"oid": "14f671ec0bfc158a4dd3b5909983733dd15b744c", "url": "https://github.com/hapifhir/hapi-fhir/commit/14f671ec0bfc158a4dd3b5909983733dd15b744c", "message": "Fix SQL Typo", "committedDate": "2020-03-04T06:31:37Z", "type": "commit"}, {"oid": "598bf56e871604eec1cdcf841de19990e4706c1e", "url": "https://github.com/hapifhir/hapi-fhir/commit/598bf56e871604eec1cdcf841de19990e4706c1e", "message": "Broken SQL Statement", "committedDate": "2020-03-04T16:56:03Z", "type": "commit"}, {"oid": "828ddd51854164d18b0f276af45cff0ac78330aa", "url": "https://github.com/hapifhir/hapi-fhir/commit/828ddd51854164d18b0f276af45cff0ac78330aa", "message": "Update docs", "committedDate": "2020-03-04T20:14:55Z", "type": "commit"}, {"oid": "8f8a8a3dc29713ea4fff94bac2447634ca36328c", "url": "https://github.com/hapifhir/hapi-fhir/commit/8f8a8a3dc29713ea4fff94bac2447634ca36328c", "message": "Merge branch 'master' into date-match-bug", "committedDate": "2020-04-29T23:17:50Z", "type": "commit"}, {"oid": "a5e1b3d159b545f5806913cca21ba69a1784afa7", "url": "https://github.com/hapifhir/hapi-fhir/commit/a5e1b3d159b545f5806913cca21ba69a1784afa7", "message": "Minor changes for merge conflicts", "committedDate": "2020-04-29T23:18:02Z", "type": "commit"}]}