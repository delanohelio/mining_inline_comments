{"pr_number": 1760, "pr_title": "Bugfix/1752 support chained parameters inside reverse chained parameter", "pr_createdAt": "2020-03-14T02:14:51Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1760", "timeline": [{"oid": "0acfc51082b4d1c9e1f814785a9e5e7efe6a72ec", "url": "https://github.com/hapifhir/hapi-fhir/commit/0acfc51082b4d1c9e1f814785a9e5e7efe6a72ec", "message": "Split test into two tests, one of which passes, one of which fails, showing the missing functionality", "committedDate": "2020-03-06T00:38:42Z", "type": "commit"}, {"oid": "b299d0b63f759e5231227d946d6f383c6e502122", "url": "https://github.com/hapifhir/hapi-fhir/commit/b299d0b63f759e5231227d946d6f383c6e502122", "message": "Fix Typos, reduce code duplication\n\n* Change Two streams into one.\n* Fix typos.\n* Begin Writing docstrings\n* Rename variables for clarity", "committedDate": "2020-03-06T19:39:39Z", "type": "commit"}, {"oid": "aca4bcfaad5e827ecc127de512599accf777e5c5", "url": "https://github.com/hapifhir/hapi-fhir/commit/aca4bcfaad5e827ecc127de512599accf777e5c5", "message": "Minor refactoring for readability", "committedDate": "2020-03-06T22:22:31Z", "type": "commit"}, {"oid": "59d16035973376dbe60bb88b2e21ab6871f89541", "url": "https://github.com/hapifhir/hapi-fhir/commit/59d16035973376dbe60bb88b2e21ab6871f89541", "message": "Some variable renaming. Adds some questions.", "committedDate": "2020-03-09T20:51:47Z", "type": "commit"}, {"oid": "12412a7be9f0e70045debb93f056296cd09290c3", "url": "https://github.com/hapifhir/hapi-fhir/commit/12412a7be9f0e70045debb93f056296cd09290c3", "message": "Add query capturing to query", "committedDate": "2020-03-09T20:58:59Z", "type": "commit"}, {"oid": "e38ec3e3ddb30c33c979b6bcdb26e50ea35e7fbc", "url": "https://github.com/hapifhir/hapi-fhir/commit/e38ec3e3ddb30c33c979b6bcdb26e50ea35e7fbc", "message": "Fix typo", "committedDate": "2020-03-09T21:57:53Z", "type": "commit"}, {"oid": "c3ceffbd7298770e7d92519eec935aebd055f773", "url": "https://github.com/hapifhir/hapi-fhir/commit/c3ceffbd7298770e7d92519eec935aebd055f773", "message": "wip", "committedDate": "2020-03-09T23:05:41Z", "type": "commit"}, {"oid": "74fd2c1519fa2f461b006845259f3d464d9d6696", "url": "https://github.com/hapifhir/hapi-fhir/commit/74fd2c1519fa2f461b006845259f3d464d9d6696", "message": "wip", "committedDate": "2020-03-13T18:28:44Z", "type": "commit"}, {"oid": "03567c5831a1984b92dd11ea05de8d8e4b533108", "url": "https://github.com/hapifhir/hapi-fhir/commit/03567c5831a1984b92dd11ea05de8d8e4b533108", "message": "Add perftrace. Remove regex", "committedDate": "2020-03-13T22:29:48Z", "type": "commit"}, {"oid": "d91cb7524c866bdb4b49ae0ecef677c62232e2a6", "url": "https://github.com/hapifhir/hapi-fhir/commit/d91cb7524c866bdb4b49ae0ecef677c62232e2a6", "message": "Fix up whitespace", "committedDate": "2020-03-13T22:30:49Z", "type": "commit"}, {"oid": "b80e71773d47c77997b1b883affc1877ba0c4aa7", "url": "https://github.com/hapifhir/hapi-fhir/commit/b80e71773d47c77997b1b883affc1877ba0c4aa7", "message": "Tidy, fix up tests", "committedDate": "2020-03-14T01:36:43Z", "type": "commit"}, {"oid": "4777d75e6b293c0dd985a49b744281418a83c7b8", "url": "https://github.com/hapifhir/hapi-fhir/commit/4777d75e6b293c0dd985a49b744281418a83c7b8", "message": "Merge branch 'master' into bugfix/1752-support-chained-parameters-inside-reverse-chained-parameter", "committedDate": "2020-03-14T01:40:11Z", "type": "commit"}, {"oid": "a39ac886af361c1573ea8dffbcee4337784fd160", "url": "https://github.com/hapifhir/hapi-fhir/commit/a39ac886af361c1573ea8dffbcee4337784fd160", "message": "Fix error while resolving rebase", "committedDate": "2020-03-14T01:43:43Z", "type": "commit"}, {"oid": "6f872ffb5153311045f6042727ed1199a5ced0de", "url": "https://github.com/hapifhir/hapi-fhir/commit/6f872ffb5153311045f6042727ed1199a5ced0de", "message": "Minor refactor", "committedDate": "2020-03-14T02:15:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc2ODUyNQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1760#discussion_r393768525", "bodyText": "Nice, great message.", "author": "jamesagnew", "createdAt": "2020-03-17T15:33:59Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/PredicateBuilderReference.java", "diffHunk": "@@ -317,24 +332,46 @@ private Predicate addPredicateReferenceWithChain(String theResourceName, String\n \t\t\t\torValues.add(chainValue);\n \t\t\t}\n \n+\n \t\t\tSubquery<Long> subQ = createLinkSubquery(foundChainMatch, chain, subResourceName, orValues, theRequest);\n \n \t\t\tPredicate pathPredicate = createResourceLinkPathPredicate(theResourceName, theParamName, theJoin);\n \t\t\tPredicate pidPredicate = theJoin.get(\"myTargetResourcePid\").in(subQ);\n-\t\t\tPredicate andPredicate = myBuilder.and(pathPredicate, pidPredicate);\n+\t\t\tPredicate andPredicate = myCriteriaBuilder.and(pathPredicate, pidPredicate);\n \t\t\ttheCodePredicates.add(andPredicate);\n-\n+\t\t\tcandidateTargetTypes.add(nextType);\n \t\t}\n \n \t\tif (!foundChainMatch) {\n-\t\t\tthrow new InvalidRequestException(myContext.getLocalizer().getMessage(BaseHapiFhirResourceDao.class, \"invalidParameterChain\", theParamName + '.' + theRef.getChain()));\n+\t\t\tthrow new InvalidRequestException(myContext.getLocalizer().getMessage(BaseHapiFhirResourceDao.class, \"invalidParameterChain\", theParamName + '.' + theReferenceParam.getChain()));\n+\t\t}\n+\n+\t\tif (candidateTargetTypes.size() > 1) {\n+\t\t\twarnAboutPerformanceOnUnqualifiedResources(theParamName, theRequest, candidateTargetTypes);\n \t\t}\n \n-\t\tPredicate predicate = myBuilder.or(toArray(theCodePredicates));\n+\t\tPredicate predicate = myCriteriaBuilder.or(toArray(theCodePredicates));\n \t\tmyQueryRoot.addPredicate(predicate);\n \t\treturn predicate;\n \t}\n \n+\tprivate void warnAboutPerformanceOnUnqualifiedResources(String theParamName, RequestDetails theRequest, List<Class<? extends IBaseResource>> theCandidateTargetTypes) {\n+\t\tString message = new StringBuilder()\n+\t\t\t.append(\"This search uses an unqualified resource(a parameter in a chain without a resource type). \")\n+\t\t\t.append(\"This is less efficient than using a qualified type. \")\n+\t\t\t.append(\"[\" + theParamName + \"] resolves to [\"+ theCandidateTargetTypes.stream().map(Class::getSimpleName).collect(Collectors.joining(\",\")) +\"].\")\n+\t\t\t.append(\"If you know what you're looking for, try qualifying it like this: \")\n+\t\t\t.append(theCandidateTargetTypes.stream().map(cls -> \"[\" +cls.getSimpleName() +\":\"+theParamName+\"]\").collect(Collectors.joining(\" or \")))\n+\t\t\t.toString();", "originalCommit": "6f872ffb5153311045f6042727ed1199a5ced0de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc2OTMxNA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1760#discussion_r393769314", "bodyText": "One meta comment I'll drop here: This needs a changelog", "author": "jamesagnew", "createdAt": "2020-03-17T15:35:02Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/MatchResourceUrlService.java", "diffHunk": "@@ -81,7 +81,6 @@\n \t\t\t\t.add(StorageProcessingMessage.class, message);\n \t\t\tJpaInterceptorBroadcaster.doCallHooks(myInterceptorBroadcaster, theRequest, Pointcut.JPA_PERFTRACE_INFO, params);", "originalCommit": "6f872ffb5153311045f6042727ed1199a5ced0de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "77733b59fa6e9b6efcc5271104b899d7be45c5b4", "url": "https://github.com/hapifhir/hapi-fhir/commit/77733b59fa6e9b6efcc5271104b899d7be45c5b4", "message": "Add changelog", "committedDate": "2020-03-17T16:33:58Z", "type": "commit"}, {"oid": "3eb09b15f094a7750661c87e1a9387ee20ee66c6", "url": "https://github.com/hapifhir/hapi-fhir/commit/3eb09b15f094a7750661c87e1a9387ee20ee66c6", "message": "Merge branch 'master' into bugfix/1752-support-chained-parameters-inside-reverse-chained-parameter", "committedDate": "2020-03-17T17:32:43Z", "type": "commit"}]}