{"pr_number": 7317, "pr_title": "[1.16.3] Extended ITeleporter Interface", "pr_createdAt": "2020-09-10T08:06:40Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317", "timeline": [{"oid": "513e96ad4b977cb490f0cf77c9dfbb9e9a258003", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/513e96ad4b977cb490f0cf77c9dfbb9e9a258003", "message": "Extended ITeleporter interface", "committedDate": "2020-09-10T07:38:34Z", "type": "commit"}, {"oid": "87228bebdbd5b2fa9eb240ffc406fae1777f68fb", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/87228bebdbd5b2fa9eb240ffc406fae1777f68fb", "message": "Updated forge.exc with mappings", "committedDate": "2020-09-10T19:23:34Z", "type": "commit"}, {"oid": "87e8a615dc2f4952385706df716a6ce1340b981d", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/87e8a615dc2f4952385706df716a6ce1340b981d", "message": "Mapped func_241829_a(ServerWorld, ITeleporter) in Entity and ServerPlayerEntity to getPortalInfo(ServerWorld, ITeleporter)", "committedDate": "2020-09-10T19:27:40Z", "type": "commit"}, {"oid": "85b6d228bbe0944a244b23c725824f43d93974c7", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/85b6d228bbe0944a244b23c725824f43d93974c7", "message": "Merge remote-tracking branch 'upstream/1.16.x' into testiteleporterchanges\n\n# Conflicts:\n#\tsrc/test/resources/META-INF/mods.toml", "committedDate": "2020-09-21T11:58:42Z", "type": "commit"}, {"oid": "9f938a645fb3083a09b7743e54a11cdd0ae2d40c", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/9f938a645fb3083a09b7743e54a11cdd0ae2d40c", "message": "fixed modded teleporters not being able to control their own teleports depending on the dimensions being teleported to and from\n\ne.g. modded teleporters could not control their own teleports from the overworld to the end", "committedDate": "2020-09-21T13:07:35Z", "type": "commit"}, {"oid": "26bb9bc10e5f6a27a29928628e3f021794bd3c7b", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/26bb9bc10e5f6a27a29928628e3f021794bd3c7b", "message": "actually/finish fixing teleports involving vanilla dimensions", "committedDate": "2020-09-21T13:36:17Z", "type": "commit"}, {"oid": "1e325f0c160089641b148800c5dbb8fd4d102673", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/1e325f0c160089641b148800c5dbb8fd4d102673", "message": "Merge pull request #1 from mrp-v2/testiteleporterchanges\n\nMerge from upstream and fix teleporters not being able to control some teleports from/to vanilla dimensions.", "committedDate": "2020-09-22T00:24:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUwMTE2OQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497501169", "bodyText": "Copying vanilla code should always be avoided if possible. Please check if you can't replace this with a call to the original method if it is a clean copy or patch and call the original method if the change is small enough.", "author": "ichttt", "createdAt": "2020-09-30T13:17:40Z", "path": "src/main/java/net/minecraftforge/common/util/ITeleporter.java", "diffHunk": "@@ -58,10 +75,68 @@\n     default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity) {\n        return repositionEntity.apply(true);\n     }\n-    \n-    //used internally to handle vanilla hardcoding\n+\n+    // States if this teleporter is the vanilla instance\n     default boolean isVanilla()\n     {\n         return getClass() == Teleporter.class;\n     }\n+\n+    // Replicated from the vanilla code for interface implementation. Return an empty optional if no portal was found.\n+    default Optional<TeleportationRepositioner.Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+    {\n+        PointOfInterestManager pointofinterestmanager = toWorld.getPointOfInterestManager();", "originalCommit": "1e325f0c160089641b148800c5dbb8fd4d102673", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNzQyOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497537429", "bodyText": "fixed in https://github.com/SilverDavidMC/MinecraftForge/pull/3", "author": "mrp-v2", "createdAt": "2020-09-30T14:05:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUwMTE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUwMTYzNA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497501634", "bodyText": "Same here, looks like vanilla copied code, can we remove this copy somehow?", "author": "ichttt", "createdAt": "2020-09-30T13:18:23Z", "path": "src/main/java/net/minecraftforge/common/util/ITeleporter.java", "diffHunk": "@@ -58,10 +75,68 @@\n     default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity) {\n        return repositionEntity.apply(true);\n     }\n-    \n-    //used internally to handle vanilla hardcoding\n+\n+    // States if this teleporter is the vanilla instance\n     default boolean isVanilla()\n     {\n         return getClass() == Teleporter.class;\n     }\n+\n+    // Replicated from the vanilla code for interface implementation. Return an empty optional if no portal was found.\n+    default Optional<TeleportationRepositioner.Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+    {\n+        PointOfInterestManager pointofinterestmanager = toWorld.getPointOfInterestManager();\n+        int dist = Math.max((int) DimensionType.func_242715_a(fromWorld.func_230315_m_(), toWorld.func_230315_m_()) * 16, 16);\n+        BlockPos pos = this.getScaledPos(fromWorld, toWorld, new BlockPos(entity.getPositionVec()));\n+        pointofinterestmanager.ensureLoadedAndValid(toWorld, pos, dist);\n+        \n+        Optional<PointOfInterest> optional = pointofinterestmanager.getInSquare((poi) -> \n+        {\n+           return poi == this.getPortalPOI();\n+        }, pos, dist, PointOfInterestManager.Status.ANY).sorted(Comparator.<PointOfInterest>comparingDouble((poi) -> \n+        {\n+           return poi.getPos().distanceSq(pos);\n+        }).thenComparingInt((poi) -> \n+        {\n+           return poi.getPos().getY();\n+        })).findFirst();\n+        \n+        return optional.map((poi) -> \n+        {\n+           BlockPos blockpos = poi.getPos();\n+           toWorld.getChunkProvider().registerTicket(TicketType.PORTAL, new ChunkPos(blockpos), 3, blockpos);\n+           BlockState blockstate = toWorld.getBlockState(blockpos);\n+           return TeleportationRepositioner.func_243676_a(blockpos, entity.getHorizontalFacing().getAxis(), 21, Direction.Axis.Y, 21, (p) -> toWorld.getBlockState(p) == blockstate);\n+        });\n+    }\n+\n+    // Creates a portal if one doesn't exist and returns the result. Default does nothing so you'll need to implement it for your portal.\n+    default Optional<TeleportationRepositioner.Result> createAndGetPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+    {\n+        return Optional.empty();\n+    }\n+\n+    // Returns the portal info for the result. Default returns the tpResult position and zero values for everything else.\n+    default PortalInfo getPortalInfo(TeleportationRepositioner.Result tpResult)\n+    {\n+        return new PortalInfo(new Vector3d(tpResult.field_243679_a.getX(), tpResult.field_243679_a.getY(), tpResult.field_243679_a.getZ()), Vector3d.ZERO, 0, 0);\n+    }\n+    \n+    // Scales the given blockpos based on the worlds passed in.\n+    default BlockPos getScaledPos(World fromWorld, World toWorld, BlockPos originalPos)\n+    {\n+    \tWorldBorder worldborder = toWorld.getWorldBorder();", "originalCommit": "1e325f0c160089641b148800c5dbb8fd4d102673", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNDI3MQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497534271", "bodyText": "Looks like we can't, it is embedded in another method. See Entity#getPortalInfo(ServerWorld, ITeleporter)", "author": "mrp-v2", "createdAt": "2020-09-30T14:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUwMTYzNA=="}], "type": "inlineReview"}, {"oid": "cc3429b0694d545cbc1885e908cdcc11913feb0c", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/cc3429b0694d545cbc1885e908cdcc11913feb0c", "message": "fixes ichttt's request to not copy vanilla code", "committedDate": "2020-09-30T14:02:31Z", "type": "commit"}, {"oid": "fad15cd0ea3611ce532545ad45b128edba0c70a4", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/fad15cd0ea3611ce532545ad45b128edba0c70a4", "message": "Merge pull request #3 from mrp-v2/7317\n\nfixes ichttt's request to not copy vanilla code", "committedDate": "2020-09-30T14:38:03Z", "type": "commit"}, {"oid": "25dcd05214d3ddfa715b38fb3fd6ee87c960e68f", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/25dcd05214d3ddfa715b38fb3fd6ee87c960e68f", "message": "refactored ITeleporter", "committedDate": "2020-09-30T15:55:28Z", "type": "commit"}, {"oid": "3908a906fa120365cda8e59cf9fbfcca0e5ee117", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/3908a906fa120365cda8e59cf9fbfcca0e5ee117", "message": "more refactoring now that i know super can be used", "committedDate": "2020-09-30T16:20:22Z", "type": "commit"}, {"oid": "f43a804bf79a143d60774da928e65a48cccc2519", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/f43a804bf79a143d60774da928e65a48cccc2519", "message": "formatting and fix accidental javadoc deletion", "committedDate": "2020-09-30T16:24:14Z", "type": "commit"}, {"oid": "e0797a2b006151ecb531f698a9875014a4edfd78", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/e0797a2b006151ecb531f698a9875014a4edfd78", "message": "decreased patch size", "committedDate": "2020-09-30T21:02:16Z", "type": "commit"}, {"oid": "7d5f06b7847ea6d30a3b69a47049081db62e250e", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/7d5f06b7847ea6d30a3b69a47049081db62e250e", "message": "Merge pull request #4 from mrp-v2/testiteleporterchanges\n\nPull uneccesary methods out of ITeleporter", "committedDate": "2020-09-30T22:11:46Z", "type": "commit"}, {"oid": "1e8321b02c1c6f08141cb96f75035e4c1be80d9d", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/1e8321b02c1c6f08141cb96f75035e4c1be80d9d", "message": "Updated test mod", "committedDate": "2020-09-30T22:17:44Z", "type": "commit"}, {"oid": "7298eee9033ba97e47c89491330821ceab9196c2", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/7298eee9033ba97e47c89491330821ceab9196c2", "message": "Fixed POITeleporter not taking dimension scaling into account", "committedDate": "2020-09-30T22:20:42Z", "type": "commit"}, {"oid": "ebe87cc5be8e342d5a11acaef6ea81e493eb2088", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/ebe87cc5be8e342d5a11acaef6ea81e493eb2088", "message": "General cleanup", "committedDate": "2020-09-30T22:33:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzOTgxOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497839819", "bodyText": "This is a breaking change as any mods currently using ITeleporter will not have this method implemented if it is not defaulted.", "author": "pupnewfster", "createdAt": "2020-09-30T22:38:33Z", "path": "src/main/java/net/minecraftforge/common/util/ITeleporter.java", "diffHunk": "@@ -19,49 +19,80 @@\n \n package net.minecraftforge.common.util;\n \n-import java.util.function.Function;\n-\n+import net.minecraft.block.PortalInfo;\n import net.minecraft.entity.Entity;\n import net.minecraft.entity.player.PlayerEntity;\n import net.minecraft.entity.player.ServerPlayerEntity;\n-import net.minecraft.world.Teleporter;\n+import net.minecraft.util.TeleportationRepositioner;\n+import net.minecraft.util.math.vector.Vector3d;\n import net.minecraft.world.server.ServerWorld;\n \n+import java.util.Optional;\n+import java.util.function.Function;\n+\n /**\n  * Interface for handling the placement of entities during dimension change.\n- *\n+ * <p>\n  * An implementation of this interface can be used to place the entity\n  * in a safe location, or generate a return portal, for instance.\n- *\n+ * <p>\n  * See the {@link net.minecraft.world.Teleporter} class, which has\n  * been patched to implement this interface, for a vanilla example.\n  */\n-public interface ITeleporter {\n-\n+public interface ITeleporter\n+{\n     /**\n      * Called to handle placing the entity in the new world.\n-     *\n+     * <p>\n      * The initial position of the entity will be its\n      * position in the origin world, multiplied horizontally\n      * by the computed cross-dimensional movement factor.\n-     *\n+     * <p>\n      * Note that the supplied entity has not yet been spawned\n      * in the destination world at the time.\n      *\n-     * @param entity           the entity to be placed\n-     * @param currentWorld     the entity's origin\n-     * @param destWorld        the entity's destination\n-     * @param yaw              the suggested yaw value to apply\n+     * @param entity the entity to be placed\n+     * @param currentWorld the entity's origin\n+     * @param destWorld the entity's destination\n+     * @param yaw the suggested yaw value to apply\n      * @param repositionEntity a function to reposition the entity, which returns the new entity in the new dimension. This is the vanilla implementation of the dimension travel logic. If the supplied boolean is true, it is attempted to spawn a new portal.\n+     *\n      * @return the entity in the new World. Vanilla creates for most {@link Entity}s a new instance and copy the data. But <b>you are not allowed</b> to create a new instance for {@link PlayerEntity}s! Move the player and update its state, see {@link ServerPlayerEntity#changeDimension(net.minecraft.world.server.ServerWorld, ITeleporter)}\n      */\n-    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity) {\n-       return repositionEntity.apply(true);\n+    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw,\n+            Function<Boolean, Entity> repositionEntity)\n+    {\n+        return repositionEntity.apply(true);\n     }\n-    \n-    //used internally to handle vanilla hardcoding\n+\n+    /**\n+     * Is this teleporter the vanilla instance.\n+     */\n     default boolean isVanilla()\n     {\n-        return getClass() == Teleporter.class;\n+        return false;\n+    }\n+\n+    /**\n+     * Finds a portal to teleport to and creates a {@link TeleportationRepositioner.Result} for it.\n+     * Return an empty {@link Optional} if no portal was found.\n+     */\n+    Optional<TeleportationRepositioner.Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity);", "originalCommit": "7d5f06b7847ea6d30a3b69a47049081db62e250e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MjY0MA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497842640", "bodyText": "Optional.empty() for both of these?", "author": "mrp-v2", "createdAt": "2020-09-30T22:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzOTgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MzQxNQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497843415", "bodyText": "Yes and then all the changes to the CommandSetDimension command should be able to be removed", "author": "pupnewfster", "createdAt": "2020-09-30T22:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzOTgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0NDQ1OQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497844459", "bodyText": "And the 2 lines at the end of the vanilla Teleporter", "author": "mrp-v2", "createdAt": "2020-09-30T22:52:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzOTgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzOTg0Mg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497839842", "bodyText": "This is a breaking change as any mods currently using ITeleporter will not have this method implemented if it is not defaulted.", "author": "pupnewfster", "createdAt": "2020-09-30T22:38:36Z", "path": "src/main/java/net/minecraftforge/common/util/ITeleporter.java", "diffHunk": "@@ -19,49 +19,80 @@\n \n package net.minecraftforge.common.util;\n \n-import java.util.function.Function;\n-\n+import net.minecraft.block.PortalInfo;\n import net.minecraft.entity.Entity;\n import net.minecraft.entity.player.PlayerEntity;\n import net.minecraft.entity.player.ServerPlayerEntity;\n-import net.minecraft.world.Teleporter;\n+import net.minecraft.util.TeleportationRepositioner;\n+import net.minecraft.util.math.vector.Vector3d;\n import net.minecraft.world.server.ServerWorld;\n \n+import java.util.Optional;\n+import java.util.function.Function;\n+\n /**\n  * Interface for handling the placement of entities during dimension change.\n- *\n+ * <p>\n  * An implementation of this interface can be used to place the entity\n  * in a safe location, or generate a return portal, for instance.\n- *\n+ * <p>\n  * See the {@link net.minecraft.world.Teleporter} class, which has\n  * been patched to implement this interface, for a vanilla example.\n  */\n-public interface ITeleporter {\n-\n+public interface ITeleporter\n+{\n     /**\n      * Called to handle placing the entity in the new world.\n-     *\n+     * <p>\n      * The initial position of the entity will be its\n      * position in the origin world, multiplied horizontally\n      * by the computed cross-dimensional movement factor.\n-     *\n+     * <p>\n      * Note that the supplied entity has not yet been spawned\n      * in the destination world at the time.\n      *\n-     * @param entity           the entity to be placed\n-     * @param currentWorld     the entity's origin\n-     * @param destWorld        the entity's destination\n-     * @param yaw              the suggested yaw value to apply\n+     * @param entity the entity to be placed\n+     * @param currentWorld the entity's origin\n+     * @param destWorld the entity's destination\n+     * @param yaw the suggested yaw value to apply\n      * @param repositionEntity a function to reposition the entity, which returns the new entity in the new dimension. This is the vanilla implementation of the dimension travel logic. If the supplied boolean is true, it is attempted to spawn a new portal.\n+     *\n      * @return the entity in the new World. Vanilla creates for most {@link Entity}s a new instance and copy the data. But <b>you are not allowed</b> to create a new instance for {@link PlayerEntity}s! Move the player and update its state, see {@link ServerPlayerEntity#changeDimension(net.minecraft.world.server.ServerWorld, ITeleporter)}\n      */\n-    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity) {\n-       return repositionEntity.apply(true);\n+    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw,\n+            Function<Boolean, Entity> repositionEntity)\n+    {\n+        return repositionEntity.apply(true);\n     }\n-    \n-    //used internally to handle vanilla hardcoding\n+\n+    /**\n+     * Is this teleporter the vanilla instance.\n+     */\n     default boolean isVanilla()\n     {\n-        return getClass() == Teleporter.class;\n+        return false;\n+    }\n+\n+    /**\n+     * Finds a portal to teleport to and creates a {@link TeleportationRepositioner.Result} for it.\n+     * Return an empty {@link Optional} if no portal was found.\n+     */\n+    Optional<TeleportationRepositioner.Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity);\n+\n+    /**\n+     * Creates a portal if one doesn't exist and returns the {@link TeleportationRepositioner.Result Result}.\n+     */\n+    Optional<TeleportationRepositioner.Result> createAndGetPortal(ServerWorld fromWorld, ServerWorld toWorld,", "originalCommit": "7d5f06b7847ea6d30a3b69a47049081db62e250e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4f7e15c648ac1574d71671b1b5a804a4fe7157dd", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/4f7e15c648ac1574d71671b1b5a804a4fe7157dd", "message": "Added test teleporter items", "committedDate": "2020-09-30T22:40:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MzkxNQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497843915", "bodyText": "Why was this changed as it adds an extra line in the patch to Teleporter.java", "author": "pupnewfster", "createdAt": "2020-09-30T22:50:28Z", "path": "src/main/java/net/minecraftforge/common/util/ITeleporter.java", "diffHunk": "@@ -19,49 +19,80 @@\n \n package net.minecraftforge.common.util;\n \n-import java.util.function.Function;\n-\n+import net.minecraft.block.PortalInfo;\n import net.minecraft.entity.Entity;\n import net.minecraft.entity.player.PlayerEntity;\n import net.minecraft.entity.player.ServerPlayerEntity;\n-import net.minecraft.world.Teleporter;\n+import net.minecraft.util.TeleportationRepositioner;\n+import net.minecraft.util.math.vector.Vector3d;\n import net.minecraft.world.server.ServerWorld;\n \n+import java.util.Optional;\n+import java.util.function.Function;\n+\n /**\n  * Interface for handling the placement of entities during dimension change.\n- *\n+ * <p>\n  * An implementation of this interface can be used to place the entity\n  * in a safe location, or generate a return portal, for instance.\n- *\n+ * <p>\n  * See the {@link net.minecraft.world.Teleporter} class, which has\n  * been patched to implement this interface, for a vanilla example.\n  */\n-public interface ITeleporter {\n-\n+public interface ITeleporter\n+{\n     /**\n      * Called to handle placing the entity in the new world.\n-     *\n+     * <p>\n      * The initial position of the entity will be its\n      * position in the origin world, multiplied horizontally\n      * by the computed cross-dimensional movement factor.\n-     *\n+     * <p>\n      * Note that the supplied entity has not yet been spawned\n      * in the destination world at the time.\n      *\n-     * @param entity           the entity to be placed\n-     * @param currentWorld     the entity's origin\n-     * @param destWorld        the entity's destination\n-     * @param yaw              the suggested yaw value to apply\n+     * @param entity the entity to be placed\n+     * @param currentWorld the entity's origin\n+     * @param destWorld the entity's destination\n+     * @param yaw the suggested yaw value to apply\n      * @param repositionEntity a function to reposition the entity, which returns the new entity in the new dimension. This is the vanilla implementation of the dimension travel logic. If the supplied boolean is true, it is attempted to spawn a new portal.\n+     *\n      * @return the entity in the new World. Vanilla creates for most {@link Entity}s a new instance and copy the data. But <b>you are not allowed</b> to create a new instance for {@link PlayerEntity}s! Move the player and update its state, see {@link ServerPlayerEntity#changeDimension(net.minecraft.world.server.ServerWorld, ITeleporter)}\n      */\n-    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity) {\n-       return repositionEntity.apply(true);\n+    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw,\n+            Function<Boolean, Entity> repositionEntity)\n+    {\n+        return repositionEntity.apply(true);\n     }\n-    \n-    //used internally to handle vanilla hardcoding\n+\n+    /**\n+     * Is this teleporter the vanilla instance.\n+     */\n     default boolean isVanilla()\n     {\n-        return getClass() == Teleporter.class;", "originalCommit": "7d5f06b7847ea6d30a3b69a47049081db62e250e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0NDMxNw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497844317", "bodyText": "I figured returning true/false was more performant than checking for class equality.", "author": "mrp-v2", "createdAt": "2020-09-30T22:51:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0NDc1OA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497844758", "bodyText": "But I don't know java well enough to know if it makes a difference.", "author": "mrp-v2", "createdAt": "2020-09-30T22:53:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzkxNDE0Nw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497914147", "bodyText": "Fixed", "author": "SilverDavidMC", "createdAt": "2020-10-01T01:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MzkxNQ=="}], "type": "inlineReview"}, {"oid": "4c8e866991b9f7d38efe0298dc408586af355726", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/4c8e866991b9f7d38efe0298dc408586af355726", "message": "Fixed some dimension scaling and added comments to TeleporterHelper.getPortalSearchRadius", "committedDate": "2020-09-30T23:01:44Z", "type": "commit"}, {"oid": "8db8e2d91f12e4aceb5462876c80c18864c54016", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/8db8e2d91f12e4aceb5462876c80c18864c54016", "message": "Updated forge.exc", "committedDate": "2020-09-30T23:25:06Z", "type": "commit"}, {"oid": "5bc2386fb0d11ef135f43167e5d9ed13b951ab20", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/5bc2386fb0d11ef135f43167e5d9ed13b951ab20", "message": "Generated patches", "committedDate": "2020-09-30T23:41:48Z", "type": "commit"}, {"oid": "3fcd1e2a48ace500341619bd9edd17b05a987a8c", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/3fcd1e2a48ace500341619bd9edd17b05a987a8c", "message": "ITeleporter.findPortal and createAndGetPortal default to calling vanilla methods", "committedDate": "2020-10-01T00:04:01Z", "type": "commit"}, {"oid": "1dbdae0dddbf50f097780bf2f3c6b040d4b0f62c", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/1dbdae0dddbf50f097780bf2f3c6b040d4b0f62c", "message": "Removed getPortalInfo from TeleporterHelper as it's unneeded", "committedDate": "2020-10-01T00:36:07Z", "type": "commit"}, {"oid": "bb964f3b5d857c4da4c1a3e8a9651e0f8a8e6244", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/bb964f3b5d857c4da4c1a3e8a9651e0f8a8e6244", "message": "Fixed breaking changes with ITeleporter and adjusted getPortalInfo", "committedDate": "2020-10-01T00:36:29Z", "type": "commit"}, {"oid": "b73ae39a58f2e0176b1eb597c137d98a5aff1637", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/b73ae39a58f2e0176b1eb597c137d98a5aff1637", "message": "Removed IPOITeleporter as it's unneeded.", "committedDate": "2020-10-01T00:36:50Z", "type": "commit"}, {"oid": "ee930a93a854dfea53afea0b281964396868e350", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/ee930a93a854dfea53afea0b281964396868e350", "message": "Updated forge.exc", "committedDate": "2020-10-01T00:36:59Z", "type": "commit"}, {"oid": "5af856baf99024fb5a48d02541c12139f3548f64", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/5af856baf99024fb5a48d02541c12139f3548f64", "message": "Added more args to ITeleporter.getPortalInfo", "committedDate": "2020-10-01T00:40:33Z", "type": "commit"}, {"oid": "876a4e733bc4a374568617319940794fc717d07f", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/876a4e733bc4a374568617319940794fc717d07f", "message": "Adjusted getScaledPos in TeleporterHelper", "committedDate": "2020-10-01T00:44:28Z", "type": "commit"}, {"oid": "1d879ebe3ffeccd0ab0a1cf2520e9f40d260d8cd", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/1d879ebe3ffeccd0ab0a1cf2520e9f40d260d8cd", "message": "Made ITeleporter methods default to using the world.getDefaultTeleporter or the instance itself if it extends Teleporter. Should help with compatibility.", "committedDate": "2020-10-01T01:12:05Z", "type": "commit"}, {"oid": "049c76c7fdc6c2b55d2742c019bd48d9420800b4", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/049c76c7fdc6c2b55d2742c019bd48d9420800b4", "message": "Gen patches", "committedDate": "2020-10-01T01:24:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk1MTQzMA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497951430", "bodyText": "Spacing is screwed up.", "author": "pupnewfster", "createdAt": "2020-10-01T02:34:14Z", "path": "src/main/java/net/minecraftforge/common/util/ITeleporter.java", "diffHunk": "@@ -19,49 +19,89 @@\n \n package net.minecraftforge.common.util;\n \n+import java.util.Optional;\n import java.util.function.Function;\n \n+import net.minecraft.block.PortalInfo;\n import net.minecraft.entity.Entity;\n import net.minecraft.entity.player.PlayerEntity;\n import net.minecraft.entity.player.ServerPlayerEntity;\n+import net.minecraft.util.TeleportationRepositioner;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.math.vector.Vector3d;\n import net.minecraft.world.Teleporter;\n+import net.minecraft.world.World;\n import net.minecraft.world.server.ServerWorld;\n \n /**\n  * Interface for handling the placement of entities during dimension change.\n- *\n+ * <p>\n  * An implementation of this interface can be used to place the entity\n  * in a safe location, or generate a return portal, for instance.\n- *\n+ * <p>\n  * See the {@link net.minecraft.world.Teleporter} class, which has\n  * been patched to implement this interface, for a vanilla example.\n  */\n-public interface ITeleporter {\n-\n+public interface ITeleporter\n+{\n     /**\n      * Called to handle placing the entity in the new world.\n-     *\n+     * <p>\n      * The initial position of the entity will be its\n      * position in the origin world, multiplied horizontally\n      * by the computed cross-dimensional movement factor.\n-     *\n+     * <p>\n      * Note that the supplied entity has not yet been spawned\n      * in the destination world at the time.\n      *\n-     * @param entity           the entity to be placed\n-     * @param currentWorld     the entity's origin\n-     * @param destWorld        the entity's destination\n-     * @param yaw              the suggested yaw value to apply\n+     * @param entity the entity to be placed\n+     * @param currentWorld the entity's origin\n+     * @param destWorld the entity's destination\n+     * @param yaw the suggested yaw value to apply\n      * @param repositionEntity a function to reposition the entity, which returns the new entity in the new dimension. This is the vanilla implementation of the dimension travel logic. If the supplied boolean is true, it is attempted to spawn a new portal.\n+     *\n      * @return the entity in the new World. Vanilla creates for most {@link Entity}s a new instance and copy the data. But <b>you are not allowed</b> to create a new instance for {@link PlayerEntity}s! Move the player and update its state, see {@link ServerPlayerEntity#changeDimension(net.minecraft.world.server.ServerWorld, ITeleporter)}\n      */\n-    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity) {\n-       return repositionEntity.apply(true);\n+    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity)\n+    {\n+        return repositionEntity.apply(true);\n     }\n-    \n-    //used internally to handle vanilla hardcoding\n+\n+    /**\n+     * Is this teleporter the vanilla instance.\n+     */\n     default boolean isVanilla()\n     {\n-        return getClass() == Teleporter.class;\n+        return this.getClass() == Teleporter.class;\n+    }\n+\n+    /**\n+     * Finds a portal to teleport to and creates a {@link TeleportationRepositioner.Result} for it. Defaults to calling vanilla Teleporter methods.\n+     */\n+    default Optional<TeleportationRepositioner.Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+    {\n+    \tTeleporter teleporter = toWorld.getDefaultTeleporter();", "originalCommit": "049c76c7fdc6c2b55d2742c019bd48d9420800b4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk1MTQ0OQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r497951449", "bodyText": "Spacing is screwed up. Also is this changing the default of ITeleporter to spawning a portal instead of having a custom ITeleporter not have a portal? If so that is a breaking change from the logical standpoint even if not binary", "author": "pupnewfster", "createdAt": "2020-10-01T02:34:19Z", "path": "src/main/java/net/minecraftforge/common/util/ITeleporter.java", "diffHunk": "@@ -19,49 +19,89 @@\n \n package net.minecraftforge.common.util;\n \n+import java.util.Optional;\n import java.util.function.Function;\n \n+import net.minecraft.block.PortalInfo;\n import net.minecraft.entity.Entity;\n import net.minecraft.entity.player.PlayerEntity;\n import net.minecraft.entity.player.ServerPlayerEntity;\n+import net.minecraft.util.TeleportationRepositioner;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.math.vector.Vector3d;\n import net.minecraft.world.Teleporter;\n+import net.minecraft.world.World;\n import net.minecraft.world.server.ServerWorld;\n \n /**\n  * Interface for handling the placement of entities during dimension change.\n- *\n+ * <p>\n  * An implementation of this interface can be used to place the entity\n  * in a safe location, or generate a return portal, for instance.\n- *\n+ * <p>\n  * See the {@link net.minecraft.world.Teleporter} class, which has\n  * been patched to implement this interface, for a vanilla example.\n  */\n-public interface ITeleporter {\n-\n+public interface ITeleporter\n+{\n     /**\n      * Called to handle placing the entity in the new world.\n-     *\n+     * <p>\n      * The initial position of the entity will be its\n      * position in the origin world, multiplied horizontally\n      * by the computed cross-dimensional movement factor.\n-     *\n+     * <p>\n      * Note that the supplied entity has not yet been spawned\n      * in the destination world at the time.\n      *\n-     * @param entity           the entity to be placed\n-     * @param currentWorld     the entity's origin\n-     * @param destWorld        the entity's destination\n-     * @param yaw              the suggested yaw value to apply\n+     * @param entity the entity to be placed\n+     * @param currentWorld the entity's origin\n+     * @param destWorld the entity's destination\n+     * @param yaw the suggested yaw value to apply\n      * @param repositionEntity a function to reposition the entity, which returns the new entity in the new dimension. This is the vanilla implementation of the dimension travel logic. If the supplied boolean is true, it is attempted to spawn a new portal.\n+     *\n      * @return the entity in the new World. Vanilla creates for most {@link Entity}s a new instance and copy the data. But <b>you are not allowed</b> to create a new instance for {@link PlayerEntity}s! Move the player and update its state, see {@link ServerPlayerEntity#changeDimension(net.minecraft.world.server.ServerWorld, ITeleporter)}\n      */\n-    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity) {\n-       return repositionEntity.apply(true);\n+    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity)\n+    {\n+        return repositionEntity.apply(true);\n     }\n-    \n-    //used internally to handle vanilla hardcoding\n+\n+    /**\n+     * Is this teleporter the vanilla instance.\n+     */\n     default boolean isVanilla()\n     {\n-        return getClass() == Teleporter.class;\n+        return this.getClass() == Teleporter.class;\n+    }\n+\n+    /**\n+     * Finds a portal to teleport to and creates a {@link TeleportationRepositioner.Result} for it. Defaults to calling vanilla Teleporter methods.\n+     */\n+    default Optional<TeleportationRepositioner.Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+    {\n+    \tTeleporter teleporter = toWorld.getDefaultTeleporter();\n+        if (this instanceof Teleporter)\n+            teleporter = (Teleporter) this;\n+        return teleporter.func_242957_a(TeleporterHelper.getScaledPos(fromWorld, toWorld, new BlockPos(entity.getPositionVec())), toWorld.func_234923_W_() == World.field_234919_h_);\n+    }\n+\n+    /**\n+     * Creates a portal if one doesn't exist and returns the {@link TeleportationRepositioner.Result Result}. Defaults to calling vanilla Teleporter methods.\n+     */\n+    default Optional<TeleportationRepositioner.Result> createAndGetPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+    {\n+    \tTeleporter teleporter = toWorld.getDefaultTeleporter();", "originalCommit": "049c76c7fdc6c2b55d2742c019bd48d9420800b4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3450f8ebd7ff6d5ceb0a4e8e5225175e23d3dfd6", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/3450f8ebd7ff6d5ceb0a4e8e5225175e23d3dfd6", "message": "Fixed spacing", "committedDate": "2020-10-01T02:45:27Z", "type": "commit"}, {"oid": "39e60390f1a87a9b4712d4ed33aab1fcb38dabcf", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/39e60390f1a87a9b4712d4ed33aab1fcb38dabcf", "message": "Adjusted ITeleporter logic. If the ITeleporter is an instance of Teleporter, it tries to use that method (for teleporters extending from vanilla). If it isn't, it returns the scaled position of the player as it's location.", "committedDate": "2020-10-01T03:01:59Z", "type": "commit"}, {"oid": "c44e54e0f6d7a68312e1b3faf0f49e9d106c2338", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/c44e54e0f6d7a68312e1b3faf0f49e9d106c2338", "message": "Decreased patch size", "committedDate": "2020-10-01T03:29:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyNDYwMQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r501324601", "bodyText": "This can just be Optional.of( and I believe you can use entity.func_233580_cy_() instead of new BlockPos(entity.getPositionVec());", "author": "pupnewfster", "createdAt": "2020-10-07T21:37:18Z", "path": "src/main/java/net/minecraftforge/common/util/ITeleporter.java", "diffHunk": "@@ -19,49 +19,93 @@\n \n package net.minecraftforge.common.util;\n \n+import java.util.Optional;\n import java.util.function.Function;\n \n+import net.minecraft.block.PortalInfo;\n import net.minecraft.entity.Entity;\n import net.minecraft.entity.player.PlayerEntity;\n import net.minecraft.entity.player.ServerPlayerEntity;\n+import net.minecraft.util.TeleportationRepositioner;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.math.vector.Vector3d;\n import net.minecraft.world.Teleporter;\n+import net.minecraft.world.World;\n import net.minecraft.world.server.ServerWorld;\n \n /**\n  * Interface for handling the placement of entities during dimension change.\n- *\n+ * <p>\n  * An implementation of this interface can be used to place the entity\n  * in a safe location, or generate a return portal, for instance.\n- *\n+ * <p>\n  * See the {@link net.minecraft.world.Teleporter} class, which has\n  * been patched to implement this interface, for a vanilla example.\n  */\n-public interface ITeleporter {\n-\n+public interface ITeleporter\n+{\n     /**\n      * Called to handle placing the entity in the new world.\n-     *\n+     * <p>\n      * The initial position of the entity will be its\n      * position in the origin world, multiplied horizontally\n      * by the computed cross-dimensional movement factor.\n-     *\n+     * <p>\n      * Note that the supplied entity has not yet been spawned\n      * in the destination world at the time.\n      *\n-     * @param entity           the entity to be placed\n-     * @param currentWorld     the entity's origin\n-     * @param destWorld        the entity's destination\n-     * @param yaw              the suggested yaw value to apply\n+     * @param entity the entity to be placed\n+     * @param currentWorld the entity's origin\n+     * @param destWorld the entity's destination\n+     * @param yaw the suggested yaw value to apply\n      * @param repositionEntity a function to reposition the entity, which returns the new entity in the new dimension. This is the vanilla implementation of the dimension travel logic. If the supplied boolean is true, it is attempted to spawn a new portal.\n+     *\n      * @return the entity in the new World. Vanilla creates for most {@link Entity}s a new instance and copy the data. But <b>you are not allowed</b> to create a new instance for {@link PlayerEntity}s! Move the player and update its state, see {@link ServerPlayerEntity#changeDimension(net.minecraft.world.server.ServerWorld, ITeleporter)}\n      */\n-    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity) {\n-       return repositionEntity.apply(true);\n+    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity)\n+    {\n+        return repositionEntity.apply(true);\n     }\n-    \n-    //used internally to handle vanilla hardcoding\n+\n+    /**\n+     * Is this teleporter the vanilla instance.\n+     */\n     default boolean isVanilla()\n     {\n-        return getClass() == Teleporter.class;\n+        return this.getClass() == Teleporter.class;\n+    }\n+\n+    /**\n+     * Finds a portal to teleport to and creates a {@link TeleportationRepositioner.Result} for it.\n+     * Calls {@link Teleporter} methods if this is an instance of Teleporter.\n+     * Defaults to the scaled entity's position.\n+     */\n+    default Optional<TeleportationRepositioner.Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+    {\n+        if (this instanceof Teleporter)\n+            return ((Teleporter) this).func_242957_a(TeleporterHelper.getScaledPos(fromWorld, toWorld, new BlockPos(entity.getPositionVec())), toWorld.func_234923_W_() == World.field_234919_h_);\n+        else\n+            return Optional.ofNullable(new TeleportationRepositioner.Result(TeleporterHelper.getScaledPos(fromWorld, toWorld, new BlockPos(entity.getPositionVec())), 0, 0));", "originalCommit": "c44e54e0f6d7a68312e1b3faf0f49e9d106c2338", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyNDY1Nw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r501324657", "bodyText": "This can just be Optional.of( and I believe you can use entity.func_233580_cy_() instead of new BlockPos(entity.getPositionVec());", "author": "pupnewfster", "createdAt": "2020-10-07T21:37:24Z", "path": "src/main/java/net/minecraftforge/common/util/ITeleporter.java", "diffHunk": "@@ -19,49 +19,93 @@\n \n package net.minecraftforge.common.util;\n \n+import java.util.Optional;\n import java.util.function.Function;\n \n+import net.minecraft.block.PortalInfo;\n import net.minecraft.entity.Entity;\n import net.minecraft.entity.player.PlayerEntity;\n import net.minecraft.entity.player.ServerPlayerEntity;\n+import net.minecraft.util.TeleportationRepositioner;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.math.vector.Vector3d;\n import net.minecraft.world.Teleporter;\n+import net.minecraft.world.World;\n import net.minecraft.world.server.ServerWorld;\n \n /**\n  * Interface for handling the placement of entities during dimension change.\n- *\n+ * <p>\n  * An implementation of this interface can be used to place the entity\n  * in a safe location, or generate a return portal, for instance.\n- *\n+ * <p>\n  * See the {@link net.minecraft.world.Teleporter} class, which has\n  * been patched to implement this interface, for a vanilla example.\n  */\n-public interface ITeleporter {\n-\n+public interface ITeleporter\n+{\n     /**\n      * Called to handle placing the entity in the new world.\n-     *\n+     * <p>\n      * The initial position of the entity will be its\n      * position in the origin world, multiplied horizontally\n      * by the computed cross-dimensional movement factor.\n-     *\n+     * <p>\n      * Note that the supplied entity has not yet been spawned\n      * in the destination world at the time.\n      *\n-     * @param entity           the entity to be placed\n-     * @param currentWorld     the entity's origin\n-     * @param destWorld        the entity's destination\n-     * @param yaw              the suggested yaw value to apply\n+     * @param entity the entity to be placed\n+     * @param currentWorld the entity's origin\n+     * @param destWorld the entity's destination\n+     * @param yaw the suggested yaw value to apply\n      * @param repositionEntity a function to reposition the entity, which returns the new entity in the new dimension. This is the vanilla implementation of the dimension travel logic. If the supplied boolean is true, it is attempted to spawn a new portal.\n+     *\n      * @return the entity in the new World. Vanilla creates for most {@link Entity}s a new instance and copy the data. But <b>you are not allowed</b> to create a new instance for {@link PlayerEntity}s! Move the player and update its state, see {@link ServerPlayerEntity#changeDimension(net.minecraft.world.server.ServerWorld, ITeleporter)}\n      */\n-    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity) {\n-       return repositionEntity.apply(true);\n+    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity)\n+    {\n+        return repositionEntity.apply(true);\n     }\n-    \n-    //used internally to handle vanilla hardcoding\n+\n+    /**\n+     * Is this teleporter the vanilla instance.\n+     */\n     default boolean isVanilla()\n     {\n-        return getClass() == Teleporter.class;\n+        return this.getClass() == Teleporter.class;\n+    }\n+\n+    /**\n+     * Finds a portal to teleport to and creates a {@link TeleportationRepositioner.Result} for it.\n+     * Calls {@link Teleporter} methods if this is an instance of Teleporter.\n+     * Defaults to the scaled entity's position.\n+     */\n+    default Optional<TeleportationRepositioner.Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+    {\n+        if (this instanceof Teleporter)\n+            return ((Teleporter) this).func_242957_a(TeleporterHelper.getScaledPos(fromWorld, toWorld, new BlockPos(entity.getPositionVec())), toWorld.func_234923_W_() == World.field_234919_h_);\n+        else\n+            return Optional.ofNullable(new TeleportationRepositioner.Result(TeleporterHelper.getScaledPos(fromWorld, toWorld, new BlockPos(entity.getPositionVec())), 0, 0));\n+    }\n+\n+    /**\n+     * Creates a portal if one doesn't exist and returns the {@link TeleportationRepositioner.Result Result}.\n+     * Calls {@link Teleporter} methods if this is an instance of Teleporter.\n+     * Defaults to the scaled entity's position.\n+     */\n+    default Optional<TeleportationRepositioner.Result> createAndGetPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+    {\n+        if (this instanceof Teleporter)\n+            return ((Teleporter) this).func_242956_a(TeleporterHelper.getScaledPos(fromWorld, toWorld, new BlockPos(entity.getPositionVec())), entity.getHorizontalFacing().getAxis());\n+        else\n+            return Optional.ofNullable(new TeleportationRepositioner.Result(TeleporterHelper.getScaledPos(fromWorld, toWorld, new BlockPos(entity.getPositionVec())), 0, 0));", "originalCommit": "c44e54e0f6d7a68312e1b3faf0f49e9d106c2338", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyODM3OQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r501328379", "bodyText": "I believe this isn't necessary because the methods are defaulted in ITeleporter and because of not allowing breaking changes the functionality should be how it is currently anyways. Unless you would rather be overriding one/both of these methods to return the result for the correct destination position and remove the setPositionAndUpdate call from the placeEntity method above.", "author": "pupnewfster", "createdAt": "2020-10-07T21:46:16Z", "path": "src/main/java/net/minecraftforge/server/command/CommandSetDimension.java", "diffHunk": "@@ -75,6 +76,20 @@ public Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld d\n                 repositionedEntity.setPositionAndUpdate(pos.getX(), pos.getY(), pos.getZ());\n                 return repositionedEntity;\n             }\n+\n+            @Override\n+            public Optional<TeleportationRepositioner.Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld,\n+                    Entity entity)\n+            {\n+                return Optional.empty();\n+            }\n+\n+            @Override\n+            public Optional<TeleportationRepositioner.Result> createAndGetPortal(ServerWorld fromWorld,\n+                    ServerWorld toWorld, Entity entity)\n+            {\n+                return Optional.empty();\n+            }", "originalCommit": "c44e54e0f6d7a68312e1b3faf0f49e9d106c2338", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMzNTMyNw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r501335327", "bodyText": "There is no reason to be using extended lambdas (with the braces) here it can just be poiType -> poiType == this.poi for example. Also instead of using sorted and findFirst() you can just use min where the current sorted call is and remove the findFirst() call", "author": "pupnewfster", "createdAt": "2020-10-07T22:02:25Z", "path": "src/test/java/net/minecraftforge/debug/world/TeleporterTest.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * Minecraft Forge\n+ * Copyright (c) 2016-2020.\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.debug.world;\n+\n+import java.util.Comparator;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import net.minecraft.block.Block;\n+import net.minecraft.block.BlockState;\n+import net.minecraft.block.Blocks;\n+import net.minecraft.block.PortalInfo;\n+import net.minecraft.block.material.Material;\n+import net.minecraft.entity.Entity;\n+import net.minecraft.item.BlockItem;\n+import net.minecraft.item.Item;\n+import net.minecraft.item.ItemGroup;\n+import net.minecraft.util.Direction;\n+import net.minecraft.util.RegistryKey;\n+import net.minecraft.util.ResourceLocation;\n+import net.minecraft.util.TeleportationRepositioner;\n+import net.minecraft.util.TeleportationRepositioner.Result;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.math.ChunkPos;\n+import net.minecraft.util.math.vector.Vector3d;\n+import net.minecraft.util.registry.Registry;\n+import net.minecraft.village.PointOfInterest;\n+import net.minecraft.village.PointOfInterestManager;\n+import net.minecraft.village.PointOfInterestType;\n+import net.minecraft.world.World;\n+import net.minecraft.world.server.ServerWorld;\n+import net.minecraft.world.server.TicketType;\n+import net.minecraftforge.common.util.ITeleporter;\n+import net.minecraftforge.common.util.TeleporterHelper;\n+import net.minecraftforge.event.RegistryEvent;\n+import net.minecraftforge.fml.common.Mod;\n+import net.minecraftforge.fml.common.ObfuscationReflectionHelper;\n+import net.minecraftforge.fml.javafmlmod.FMLJavaModLoadingContext;\n+import net.minecraftforge.registries.IForgeRegistry;\n+import net.minecraftforge.registries.IForgeRegistryEntry;\n+\n+// Test mod for ITeleporter changes 9/30/2020\n+@Mod(TeleporterTest.MODID)\n+public class TeleporterTest\n+{\n+    protected static final String MODID = \"teleporter_test\";\n+    private static RegistryKey<World> RED_WORLD = RegistryKey.func_240903_a_(Registry.field_239699_ae_, new ResourceLocation(MODID, \"red_world\"));;\n+    private static RegistryKey<World> BLUE_WORLD = RegistryKey.func_240903_a_(Registry.field_239699_ae_, new ResourceLocation(MODID, \"blue_world\"));\n+    // Triggered by standing on top. Red is scaled the same as the nether while blue is 1 to 1.\n+    private static TeleporterBlock RED_TELEPORTER, BLUE_TELEPORTER;\n+    private static PointOfInterestType RED_POI, BLUE_POI;\n+    \n+    public TeleporterTest()\n+    {\n+        FMLJavaModLoadingContext.get().getModEventBus().addGenericListener(Item.class, this::registerItems);\n+        FMLJavaModLoadingContext.get().getModEventBus().addGenericListener(Block.class, this::registerBlocks);\n+        FMLJavaModLoadingContext.get().getModEventBus().addGenericListener(PointOfInterestType.class, this::registerPOIs);\n+    }\n+    \n+    protected void registerBlocks(final RegistryEvent.Register<Block> event)\n+    {\n+        RED_TELEPORTER = register(event.getRegistry(), \"red_teleporter\", new TeleporterBlock(() -> RED_POI, RED_WORLD));\n+        BLUE_TELEPORTER = register(event.getRegistry(), \"blue_teleporter\", new TeleporterBlock(() -> BLUE_POI, BLUE_WORLD));\n+    }\n+    \n+    protected void registerItems(final RegistryEvent.Register<Item> event)\n+    {\n+        register(event.getRegistry(), \"red_teleporter\", new BlockItem(RED_TELEPORTER, new Item.Properties().group(ItemGroup.TRANSPORTATION)));\n+        register(event.getRegistry(), \"blue_teleporter\", new BlockItem(BLUE_TELEPORTER, new Item.Properties().group(ItemGroup.TRANSPORTATION)));\n+    }\n+    \n+    private <T extends IForgeRegistryEntry<T>, V extends T> V register(IForgeRegistry<T> registry, String name, V obj)\n+    {\n+        obj.setRegistryName(new ResourceLocation(MODID, name));\n+        registry.register(obj);\n+        return obj;\n+    }\n+    \n+    protected void registerPOIs(final RegistryEvent.Register<PointOfInterestType> event)\n+    {\n+        RED_POI = registerPOI(event.getRegistry(), new PointOfInterestType(new ResourceLocation(MODID, \"red_poi\").toString(), PointOfInterestType.getAllStates(RED_TELEPORTER), 0, 1));\n+        BLUE_POI = registerPOI(event.getRegistry(), new PointOfInterestType(new ResourceLocation(MODID, \"blue_poi\").toString(), PointOfInterestType.getAllStates(BLUE_TELEPORTER), 0, 1));\n+    }\n+    \n+    private PointOfInterestType registerPOI(IForgeRegistry<PointOfInterestType> registry, PointOfInterestType poi)\n+    {\n+        poi.setRegistryName(new ResourceLocation(poi.toString()));\n+        registry.register(poi);\n+        try\n+        {\n+            ObfuscationReflectionHelper.findMethod(PointOfInterestType.class, \"func_221052_a\", PointOfInterestType.class).invoke(null, poi);\n+        }\n+        catch (Exception e)\n+        {\n+            e.printStackTrace();\n+        }\n+        return poi;\n+    }\n+    \n+    private static class TeleporterBlock extends Block\n+    {\n+        final Supplier<PointOfInterestType> poi;\n+        final RegistryKey<World> destWorldKey;\n+        \n+        private TeleporterBlock(Supplier<PointOfInterestType> poi, RegistryKey<World> destWorldKey)\n+        {\n+            super(Properties.from(Blocks.STONE));\n+            this.poi = poi;\n+            this.destWorldKey = destWorldKey;\n+        }\n+        \n+        @Override\n+        public void onFallenUpon(World worldIn, BlockPos pos, Entity entityIn, float fallDistance)\n+        {\n+            if (!worldIn.isRemote)\n+                entityIn.changeDimension(((ServerWorld) worldIn).getServer().getWorld(worldIn.func_234923_W_() == this.destWorldKey ? World.field_234918_g_ : this.destWorldKey), new TestTeleporter(this.poi.get(), this));\n+        }\n+    }\n+    \n+    private static class TestTeleporter implements ITeleporter\n+    {\n+        final PointOfInterestType poi;\n+        final Block teleporterBlock;\n+        \n+        private TestTeleporter(PointOfInterestType poi, Block teleporterBlock)\n+        {\n+            this.poi = poi;\n+            this.teleporterBlock = teleporterBlock;\n+        }\n+        \n+        @Override\n+        public Optional<Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+        {\n+            PointOfInterestManager poiManager = toWorld.getPointOfInterestManager();\n+            int scale = TeleporterHelper.getPortalSearchRadius(fromWorld, toWorld);\n+            BlockPos scaledPos = TeleporterHelper.getScaledPos(fromWorld, toWorld, new BlockPos(entity.getPositionVec()));\n+            poiManager.ensureLoadedAndValid(toWorld, scaledPos, scale);\n+            Optional<PointOfInterest> optional = poiManager.getInSquare((poiType) -> {\n+               return poiType == this.poi;\n+            }, scaledPos, scale, PointOfInterestManager.Status.ANY).sorted(Comparator.<PointOfInterest>comparingDouble((poi) -> {\n+               return poi.getPos().distanceSq(scaledPos);\n+            }).thenComparingInt((poi) -> {\n+               return poi.getPos().getY();\n+            })).findFirst();", "originalCommit": "c44e54e0f6d7a68312e1b3faf0f49e9d106c2338", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM1MzEzOA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r501353138", "bodyText": "Didn't realize min was a thing. Nifty!", "author": "SilverDavidMC", "createdAt": "2020-10-07T22:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMzNTMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMzNTYyNQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r501335625", "bodyText": "No need for the extended lambda here either", "author": "pupnewfster", "createdAt": "2020-10-07T22:03:10Z", "path": "src/test/java/net/minecraftforge/debug/world/TeleporterTest.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * Minecraft Forge\n+ * Copyright (c) 2016-2020.\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.debug.world;\n+\n+import java.util.Comparator;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import net.minecraft.block.Block;\n+import net.minecraft.block.BlockState;\n+import net.minecraft.block.Blocks;\n+import net.minecraft.block.PortalInfo;\n+import net.minecraft.block.material.Material;\n+import net.minecraft.entity.Entity;\n+import net.minecraft.item.BlockItem;\n+import net.minecraft.item.Item;\n+import net.minecraft.item.ItemGroup;\n+import net.minecraft.util.Direction;\n+import net.minecraft.util.RegistryKey;\n+import net.minecraft.util.ResourceLocation;\n+import net.minecraft.util.TeleportationRepositioner;\n+import net.minecraft.util.TeleportationRepositioner.Result;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.math.ChunkPos;\n+import net.minecraft.util.math.vector.Vector3d;\n+import net.minecraft.util.registry.Registry;\n+import net.minecraft.village.PointOfInterest;\n+import net.minecraft.village.PointOfInterestManager;\n+import net.minecraft.village.PointOfInterestType;\n+import net.minecraft.world.World;\n+import net.minecraft.world.server.ServerWorld;\n+import net.minecraft.world.server.TicketType;\n+import net.minecraftforge.common.util.ITeleporter;\n+import net.minecraftforge.common.util.TeleporterHelper;\n+import net.minecraftforge.event.RegistryEvent;\n+import net.minecraftforge.fml.common.Mod;\n+import net.minecraftforge.fml.common.ObfuscationReflectionHelper;\n+import net.minecraftforge.fml.javafmlmod.FMLJavaModLoadingContext;\n+import net.minecraftforge.registries.IForgeRegistry;\n+import net.minecraftforge.registries.IForgeRegistryEntry;\n+\n+// Test mod for ITeleporter changes 9/30/2020\n+@Mod(TeleporterTest.MODID)\n+public class TeleporterTest\n+{\n+    protected static final String MODID = \"teleporter_test\";\n+    private static RegistryKey<World> RED_WORLD = RegistryKey.func_240903_a_(Registry.field_239699_ae_, new ResourceLocation(MODID, \"red_world\"));;\n+    private static RegistryKey<World> BLUE_WORLD = RegistryKey.func_240903_a_(Registry.field_239699_ae_, new ResourceLocation(MODID, \"blue_world\"));\n+    // Triggered by standing on top. Red is scaled the same as the nether while blue is 1 to 1.\n+    private static TeleporterBlock RED_TELEPORTER, BLUE_TELEPORTER;\n+    private static PointOfInterestType RED_POI, BLUE_POI;\n+    \n+    public TeleporterTest()\n+    {\n+        FMLJavaModLoadingContext.get().getModEventBus().addGenericListener(Item.class, this::registerItems);\n+        FMLJavaModLoadingContext.get().getModEventBus().addGenericListener(Block.class, this::registerBlocks);\n+        FMLJavaModLoadingContext.get().getModEventBus().addGenericListener(PointOfInterestType.class, this::registerPOIs);\n+    }\n+    \n+    protected void registerBlocks(final RegistryEvent.Register<Block> event)\n+    {\n+        RED_TELEPORTER = register(event.getRegistry(), \"red_teleporter\", new TeleporterBlock(() -> RED_POI, RED_WORLD));\n+        BLUE_TELEPORTER = register(event.getRegistry(), \"blue_teleporter\", new TeleporterBlock(() -> BLUE_POI, BLUE_WORLD));\n+    }\n+    \n+    protected void registerItems(final RegistryEvent.Register<Item> event)\n+    {\n+        register(event.getRegistry(), \"red_teleporter\", new BlockItem(RED_TELEPORTER, new Item.Properties().group(ItemGroup.TRANSPORTATION)));\n+        register(event.getRegistry(), \"blue_teleporter\", new BlockItem(BLUE_TELEPORTER, new Item.Properties().group(ItemGroup.TRANSPORTATION)));\n+    }\n+    \n+    private <T extends IForgeRegistryEntry<T>, V extends T> V register(IForgeRegistry<T> registry, String name, V obj)\n+    {\n+        obj.setRegistryName(new ResourceLocation(MODID, name));\n+        registry.register(obj);\n+        return obj;\n+    }\n+    \n+    protected void registerPOIs(final RegistryEvent.Register<PointOfInterestType> event)\n+    {\n+        RED_POI = registerPOI(event.getRegistry(), new PointOfInterestType(new ResourceLocation(MODID, \"red_poi\").toString(), PointOfInterestType.getAllStates(RED_TELEPORTER), 0, 1));\n+        BLUE_POI = registerPOI(event.getRegistry(), new PointOfInterestType(new ResourceLocation(MODID, \"blue_poi\").toString(), PointOfInterestType.getAllStates(BLUE_TELEPORTER), 0, 1));\n+    }\n+    \n+    private PointOfInterestType registerPOI(IForgeRegistry<PointOfInterestType> registry, PointOfInterestType poi)\n+    {\n+        poi.setRegistryName(new ResourceLocation(poi.toString()));\n+        registry.register(poi);\n+        try\n+        {\n+            ObfuscationReflectionHelper.findMethod(PointOfInterestType.class, \"func_221052_a\", PointOfInterestType.class).invoke(null, poi);\n+        }\n+        catch (Exception e)\n+        {\n+            e.printStackTrace();\n+        }\n+        return poi;\n+    }\n+    \n+    private static class TeleporterBlock extends Block\n+    {\n+        final Supplier<PointOfInterestType> poi;\n+        final RegistryKey<World> destWorldKey;\n+        \n+        private TeleporterBlock(Supplier<PointOfInterestType> poi, RegistryKey<World> destWorldKey)\n+        {\n+            super(Properties.from(Blocks.STONE));\n+            this.poi = poi;\n+            this.destWorldKey = destWorldKey;\n+        }\n+        \n+        @Override\n+        public void onFallenUpon(World worldIn, BlockPos pos, Entity entityIn, float fallDistance)\n+        {\n+            if (!worldIn.isRemote)\n+                entityIn.changeDimension(((ServerWorld) worldIn).getServer().getWorld(worldIn.func_234923_W_() == this.destWorldKey ? World.field_234918_g_ : this.destWorldKey), new TestTeleporter(this.poi.get(), this));\n+        }\n+    }\n+    \n+    private static class TestTeleporter implements ITeleporter\n+    {\n+        final PointOfInterestType poi;\n+        final Block teleporterBlock;\n+        \n+        private TestTeleporter(PointOfInterestType poi, Block teleporterBlock)\n+        {\n+            this.poi = poi;\n+            this.teleporterBlock = teleporterBlock;\n+        }\n+        \n+        @Override\n+        public Optional<Result> findPortal(ServerWorld fromWorld, ServerWorld toWorld, Entity entity)\n+        {\n+            PointOfInterestManager poiManager = toWorld.getPointOfInterestManager();\n+            int scale = TeleporterHelper.getPortalSearchRadius(fromWorld, toWorld);\n+            BlockPos scaledPos = TeleporterHelper.getScaledPos(fromWorld, toWorld, new BlockPos(entity.getPositionVec()));\n+            poiManager.ensureLoadedAndValid(toWorld, scaledPos, scale);\n+            Optional<PointOfInterest> optional = poiManager.getInSquare((poiType) -> {\n+               return poiType == this.poi;\n+            }, scaledPos, scale, PointOfInterestManager.Status.ANY).sorted(Comparator.<PointOfInterest>comparingDouble((poi) -> {\n+               return poi.getPos().distanceSq(scaledPos);\n+            }).thenComparingInt((poi) -> {\n+               return poi.getPos().getY();\n+            })).findFirst();\n+            \n+            return optional.map((poi) -> {\n+               BlockPos poiPos = poi.getPos();\n+               toWorld.getChunkProvider().registerTicket(TicketType.PORTAL, new ChunkPos(poiPos), 3, poiPos);\n+               BlockState blockstate = toWorld.getBlockState(poiPos);\n+               return TeleportationRepositioner.func_243676_a(poiPos, entity.getHorizontalFacing().getAxis(), 21, Direction.Axis.Y, 21, (pos) -> {\n+                  return toWorld.getBlockState(pos) == blockstate;\n+               });", "originalCommit": "c44e54e0f6d7a68312e1b3faf0f49e9d106c2338", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7c84f445f8539448043c101ba692896d9392d25d", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/7c84f445f8539448043c101ba692896d9392d25d", "message": "Cleaned up code based on feedback", "committedDate": "2020-10-07T22:50:44Z", "type": "commit"}, {"oid": "2a164abf99c5f8bff5f57d3720965ac31890e11f", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/2a164abf99c5f8bff5f57d3720965ac31890e11f", "message": "Generated patches", "committedDate": "2020-10-07T22:58:50Z", "type": "commit"}, {"oid": "ea194f872c642f4d0ee95e080e2d7703c13c63b1", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/ea194f872c642f4d0ee95e080e2d7703c13c63b1", "message": "Fixed merge conflict", "committedDate": "2020-10-07T23:41:51Z", "type": "commit"}, {"oid": "944c7fb9b70309ce986ce42f98ac67f48e04e6be", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/944c7fb9b70309ce986ce42f98ac67f48e04e6be", "message": "Fixed merge conflict", "committedDate": "2020-10-07T23:44:26Z", "type": "commit"}, {"oid": "5967a19de6277237717b7179b138d758ef8a26c8", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/5967a19de6277237717b7179b138d758ef8a26c8", "message": "Merge branch '1.16.x' into 1.16.x", "committedDate": "2020-10-07T23:52:04Z", "type": "commit"}, {"oid": "72bfb818838ab38ae1d66e5f4c31f254e057b4c0", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/72bfb818838ab38ae1d66e5f4c31f254e057b4c0", "message": "Removed != null check from Entity.getPortalInfo", "committedDate": "2020-10-08T00:28:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQwMTgzMg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r501401832", "bodyText": "These import changes aren't needed", "author": "pupnewfster", "createdAt": "2020-10-08T01:42:11Z", "path": "src/main/java/net/minecraftforge/server/command/CommandSetDimension.java", "diffHunk": "@@ -25,17 +25,18 @@\n import net.minecraft.command.arguments.DimensionArgument;\n import net.minecraft.command.arguments.EntityArgument;\n import net.minecraft.entity.Entity;\n+import net.minecraft.util.TeleportationRepositioner;\n import net.minecraft.util.math.BlockPos;\n import net.minecraft.util.text.TranslationTextComponent;\n import net.minecraft.world.server.ServerWorld;\n import net.minecraftforge.common.util.ITeleporter;\n-\n import com.mojang.brigadier.builder.ArgumentBuilder;\n import com.mojang.brigadier.exceptions.CommandSyntaxException;\n import com.mojang.brigadier.exceptions.DynamicCommandExceptionType;\n import com.mojang.brigadier.exceptions.SimpleCommandExceptionType;\n \n import java.util.Collection;\n+import java.util.Optional;", "originalCommit": "72bfb818838ab38ae1d66e5f4c31f254e057b4c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de6e8fcb73291e25018a429be72db4ddf4fdd346", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/de6e8fcb73291e25018a429be72db4ddf4fdd346", "message": "Removed unused imports", "committedDate": "2020-10-08T05:25:13Z", "type": "commit"}, {"oid": "cd42e14a8efef54155c6c5337bacaf1a1796c821", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/cd42e14a8efef54155c6c5337bacaf1a1796c821", "message": "Removed some isVanilla checks from ServerPlayerEntity", "committedDate": "2020-10-13T00:14:31Z", "type": "commit"}, {"oid": "abcb517a2452385ebebd0dd6850255d6ee3053e0", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/abcb517a2452385ebebd0dd6850255d6ee3053e0", "message": "Removed createAndGetPortal and findPortal as they are unused. Devs are better off handling it themselves. PortalInfo is now obtained from getPortalInfo.", "committedDate": "2020-10-15T22:49:05Z", "type": "commit"}, {"oid": "2c77b89c4ca04d2e1661d686942c07be55578646", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/2c77b89c4ca04d2e1661d686942c07be55578646", "message": "Removed getPortalInfo method overload as well as changed how teleporting gets the portal info based on Lex's suggestion", "committedDate": "2020-10-15T23:12:41Z", "type": "commit"}, {"oid": "4cd8bd14fb5074a21c90e4cc47ad2b06af122535", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/4cd8bd14fb5074a21c90e4cc47ad2b06af122535", "message": "Updated test mod", "committedDate": "2020-10-15T23:12:50Z", "type": "commit"}, {"oid": "7204532f9d7d5d14060ea6824cab8f740b2734e6", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/7204532f9d7d5d14060ea6824cab8f740b2734e6", "message": "Merge branch '1.16.x' into 1.16.x", "committedDate": "2020-10-15T23:23:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkyMTg5MQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r505921891", "bodyText": "There is no reason for this stuff to exist anymore, at least not as public forge API, just put the methods in your test mod if they are still needed by it.", "author": "pupnewfster", "createdAt": "2020-10-15T23:33:28Z", "path": "src/main/java/net/minecraftforge/common/util/TeleporterHelper.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package net.minecraftforge.common.util;\n+\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.math.MathHelper;\n+import net.minecraft.world.DimensionType;\n+import net.minecraft.world.World;\n+import net.minecraft.world.border.WorldBorder;\n+\n+public class TeleporterHelper", "originalCommit": "7204532f9d7d5d14060ea6824cab8f740b2734e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2MDMyMA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r505960320", "bodyText": "Fair enough. I wasn't sure if I should've kept it or not", "author": "SilverDavidMC", "createdAt": "2020-10-16T01:20:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkyMTg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2MTY2OA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r505961668", "bodyText": "Ya remove it, it serves no purpose", "author": "pupnewfster", "createdAt": "2020-10-16T01:22:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkyMTg5MQ=="}], "type": "inlineReview"}, {"oid": "fe15a4c912ebdf7b8853918ce9efea227e10c0b4", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/fe15a4c912ebdf7b8853918ce9efea227e10c0b4", "message": "Re-added the isVanilla check for end credits", "committedDate": "2020-10-16T01:18:25Z", "type": "commit"}, {"oid": "0e34e8178c149995dec0533a8c97330f873b4a8c", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/0e34e8178c149995dec0533a8c97330f873b4a8c", "message": "Fixed set_dimension command", "committedDate": "2020-10-16T01:33:19Z", "type": "commit"}, {"oid": "313965a02a428e5de2e6db932be75eb1a762dada", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/313965a02a428e5de2e6db932be75eb1a762dada", "message": "Removed TeleporterHelper", "committedDate": "2020-10-16T01:33:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk3MzA5Ng==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r505973096", "bodyText": "I am guessing this is required to make it work properly and otherwise it just doesn't teleport (instead of how it currently just silently null pointers)?", "author": "pupnewfster", "createdAt": "2020-10-16T01:45:16Z", "path": "src/main/java/net/minecraftforge/server/command/CommandSetDimension.java", "diffHunk": "@@ -75,6 +73,12 @@ public Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld d\n                 repositionedEntity.setPositionAndUpdate(pos.getX(), pos.getY(), pos.getZ());\n                 return repositionedEntity;\n             }\n+            \n+            @Override\n+            public PortalInfo getPortalInfo(Entity entity, ServerWorld destWorld, Function<ServerWorld, PortalInfo> defaultPortalInfo)\n+            {\n+                return new PortalInfo(entity.getPositionVec(), Vector3d.ZERO, entity.rotationYaw, entity.rotationPitch);\n+            }", "originalCommit": "313965a02a428e5de2e6db932be75eb1a762dada", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk3NzM1Ng==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r505977356", "bodyText": "It doesn't throw a crash, but the game will lock up since the vanilla method would be used here by default. I'm not exactly sure where it locks up, but it does, so I needed to add this. If your teleporter was doing everything in the ITeleporter.placeEntity method, it could get around this, but that's a rather unwieldy way of doing things.", "author": "SilverDavidMC", "createdAt": "2020-10-16T01:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk3MzA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk3ODk3Nw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r505978977", "bodyText": "I figured this was the case I just wanted to confirm there wasn't being added due to some breaking change being introduced.", "author": "pupnewfster", "createdAt": "2020-10-16T01:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk3MzA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY1ODE4NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r506658184", "bodyText": "Discussed this with lex some and this should instead return:\nreturn isVanilla() ? defaultPortalInfo.apply(destWorld) : new PortalInfo(entity.getPositionVec(), Vector3d.ZERO, entity.rotationYaw, entity.rotationPitch);\nso that current mods implementing ITeleporter using work arounds continue to work and don't get broken by this change.", "author": "pupnewfster", "createdAt": "2020-10-16T18:40:07Z", "path": "src/main/java/net/minecraftforge/common/util/ITeleporter.java", "diffHunk": "@@ -29,39 +32,62 @@\n \n /**\n  * Interface for handling the placement of entities during dimension change.\n- *\n+ * <p>\n  * An implementation of this interface can be used to place the entity\n  * in a safe location, or generate a return portal, for instance.\n- *\n+ * <p>\n  * See the {@link net.minecraft.world.Teleporter} class, which has\n  * been patched to implement this interface, for a vanilla example.\n  */\n-public interface ITeleporter {\n-\n+public interface ITeleporter\n+{\n     /**\n      * Called to handle placing the entity in the new world.\n-     *\n+     * <p>\n      * The initial position of the entity will be its\n      * position in the origin world, multiplied horizontally\n      * by the computed cross-dimensional movement factor.\n-     *\n+     * <p>\n      * Note that the supplied entity has not yet been spawned\n      * in the destination world at the time.\n      *\n-     * @param entity           the entity to be placed\n-     * @param currentWorld     the entity's origin\n-     * @param destWorld        the entity's destination\n-     * @param yaw              the suggested yaw value to apply\n+     * @param entity the entity to be placed\n+     * @param currentWorld the entity's origin\n+     * @param destWorld the entity's destination\n+     * @param yaw the suggested yaw value to apply\n      * @param repositionEntity a function to reposition the entity, which returns the new entity in the new dimension. This is the vanilla implementation of the dimension travel logic. If the supplied boolean is true, it is attempted to spawn a new portal.\n+     *\n      * @return the entity in the new World. Vanilla creates for most {@link Entity}s a new instance and copy the data. But <b>you are not allowed</b> to create a new instance for {@link PlayerEntity}s! Move the player and update its state, see {@link ServerPlayerEntity#changeDimension(net.minecraft.world.server.ServerWorld, ITeleporter)}\n      */\n-    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity) {\n-       return repositionEntity.apply(true);\n+    default Entity placeEntity(Entity entity, ServerWorld currentWorld, ServerWorld destWorld, float yaw, Function<Boolean, Entity> repositionEntity)\n+    {\n+        return repositionEntity.apply(true);\n+    }\n+\n+    /**\n+     * Gets the PortalInfo. defaultPortalInfo references the \n+     * vanilla code and should not be used for your purposes. \n+     * Override this method to handle your own logic. \n+     * <p>\n+     * Return {@code null} to prevent teleporting.\n+     * \n+     * @param entity The entity teleporting before the teleport\n+     * @param destWorld The world the entity is teleporting to\n+     * @param defaultPortalInfo A reference to the vanilla method for getting portal info. You should implement your own logic instead of using this\n+     * \n+     * @return The location, rotation, and motion of the entity in the destWorld after the teleport\n+     */\n+    @Nullable\n+    default PortalInfo getPortalInfo(Entity entity, ServerWorld destWorld, Function<ServerWorld, PortalInfo> defaultPortalInfo)\n+    {\n+        return defaultPortalInfo.apply(destWorld);", "originalCommit": "313965a02a428e5de2e6db932be75eb1a762dada", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY1ODc5Nw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7317#discussion_r506658797", "bodyText": "Don't remove this, it is here to remember to reimplement it at some point. (Also with the requested change to the default implementation of getPortalInfo you should be able to revert all changes being made to this class.)", "author": "pupnewfster", "createdAt": "2020-10-16T18:41:23Z", "path": "src/main/java/net/minecraftforge/server/command/CommandSetDimension.java", "diffHunk": "@@ -41,7 +42,7 @@\n public class CommandSetDimension\n {\n     private static final SimpleCommandExceptionType NO_ENTITIES = new SimpleCommandExceptionType(new TranslationTextComponent(\"commands.forge.setdim.invalid.entity\"));\n-    private static final DynamicCommandExceptionType INVALID_DIMENSION = new DynamicCommandExceptionType(dim -> new TranslationTextComponent(\"commands.forge.setdim.invalid.dim\", dim));", "originalCommit": "313965a02a428e5de2e6db932be75eb1a762dada", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e0e49d18e83d14f21b1a6036dba5c758f15af07", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/9e0e49d18e83d14f21b1a6036dba5c758f15af07", "message": "Reverted changes to CommandSetDimension", "committedDate": "2020-10-16T18:55:23Z", "type": "commit"}, {"oid": "d81ac7e76eb7100760f5ad8b9f19730fdbd0a1aa", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/d81ac7e76eb7100760f5ad8b9f19730fdbd0a1aa", "message": "Updated ITeleporter logic", "committedDate": "2020-10-16T18:55:44Z", "type": "commit"}, {"oid": "16214949f87f2de9d90f65d7497ff303345484e2", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/16214949f87f2de9d90f65d7497ff303345484e2", "message": "Removed test mod", "committedDate": "2020-10-16T18:57:44Z", "type": "commit"}, {"oid": "ee8a6825cb75ea546e1b608753bd10bcc0044046", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/ee8a6825cb75ea546e1b608753bd10bcc0044046", "message": "Missed a space", "committedDate": "2020-10-16T18:58:20Z", "type": "commit"}]}