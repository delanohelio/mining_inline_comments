{"pr_number": 7256, "pr_title": "Improve startup time by caching the manifest data for mod jars", "pr_createdAt": "2020-08-16T09:42:43Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256", "timeline": [{"oid": "c88eeed524752ba6dc978a3db3b96920918ec2de", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/c88eeed524752ba6dc978a3db3b96920918ec2de", "message": "Improve startup time by caching the manifest data for mod jars\nFixes cpw/modlauncher#55", "committedDate": "2020-08-16T08:34:29Z", "type": "commit"}, {"oid": "c71b96cad3946f60da9a6c6222d7c58aba2d5be8", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/c71b96cad3946f60da9a6c6222d7c58aba2d5be8", "message": "Use volatile instead of AtomicReference and get rid of Optional<Optional<>>", "committedDate": "2020-08-16T11:27:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTEwMTY5Ng==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#discussion_r471101696", "bodyText": "Braces on new lines (might want to fix the one on the method signature as well while you're at it).", "author": "diesieben07", "createdAt": "2020-08-16T11:34:24Z", "path": "src/fmllauncher/java/net/minecraftforge/fml/loading/moddiscovery/ModFileInfo.java", "diffHunk": "@@ -115,12 +118,12 @@ public VersionRange getModLoaderVersion()\n     }\n \n     public Optional<Manifest> getManifest() {\n-        Optional<Optional<Manifest>> manifest = this.manifest.get();\n-        if (!manifest.isPresent()) {\n-            manifest = Optional.of(modFile.getLocator().findManifest(modFile.getFilePath()));\n-            this.manifest.set(manifest);\n+        Optional<Manifest> result = manifest;\n+        if (result == null) {", "originalCommit": "c71b96cad3946f60da9a6c6222d7c58aba2d5be8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "651fe7637567a10394897c63f103ecc0eaea563a", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/651fe7637567a10394897c63f103ecc0eaea563a", "message": "Fix formatting", "committedDate": "2020-08-16T11:53:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA5NTQxNA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#discussion_r472095414", "bodyText": "If it doesn't matter that two threads hold different instances of the manifest (with the same content), this does not need to be volatile", "author": "ichttt", "createdAt": "2020-08-18T11:04:32Z", "path": "src/fmllauncher/java/net/minecraftforge/fml/loading/moddiscovery/ModFileInfo.java", "diffHunk": "@@ -54,6 +55,10 @@\n     private final List<IModInfo> mods;\n     private final Map<String,Object> properties;\n     private final String license;\n+    // Caches the manifest of the mod jar as parsing the manifest can be expensive for\n+    // signed jars. The manifest needs to be an Optional<Manifest>, so a nullable Optional\n+    // is probably the best option.\n+    private volatile Optional<Manifest> manifest = null;", "originalCommit": "651fe7637567a10394897c63f103ecc0eaea563a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE3OTQ1Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#discussion_r472179453", "bodyText": "Yes it does. As soon as more than one thread can access a variable you must use volatile (or synchronization). If you just use a normal field, it would be perfectly okay for other threads than the writing thread to never see this new value.", "author": "diesieben07", "createdAt": "2020-08-18T13:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA5NTQxNA=="}], "type": "inlineReview"}, {"oid": "33d1c9084d0b546f9e8ddf00feb85b2da5932cc0", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/33d1c9084d0b546f9e8ddf00feb85b2da5932cc0", "message": "Parse the manifest on mod construction to avoid threading issues", "committedDate": "2020-08-19T14:47:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY4MjM1MA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#discussion_r473682350", "bodyText": "Pointless import, other than this looks good now.", "author": "diesieben07", "createdAt": "2020-08-20T07:15:44Z", "path": "src/fmllauncher/java/net/minecraftforge/fml/loading/moddiscovery/ModFileInfo.java", "diffHunk": "@@ -37,6 +37,7 @@\n import java.util.Map;\n import java.util.Objects;\n import java.util.Optional;\n+import java.util.concurrent.atomic.AtomicReference;", "originalCommit": "33d1c9084d0b546f9e8ddf00feb85b2da5932cc0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7146204a14d8aeccf01423e83661f59dc8e012af", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/7146204a14d8aeccf01423e83661f59dc8e012af", "message": "Remove useless import", "committedDate": "2020-08-20T07:33:47Z", "type": "commit"}]}