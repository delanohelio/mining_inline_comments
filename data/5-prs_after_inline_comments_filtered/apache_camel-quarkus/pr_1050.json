{"pr_number": 1050, "pr_title": "InfluxDB native support #1036", "pr_createdAt": "2020-04-07T12:34:56Z", "pr_url": "https://github.com/apache/camel-quarkus/pull/1050", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkzNzk4NQ==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r404937985", "bodyText": "I think extensionSslNativeSupport.produce(new ExtensionSslNativeSupportBuildItem(FEATURE)); deserves a separate @BuildStep method. The code would be easier to follow that way.\n@lburgazzoli would even say that all *Native*BuildItem s should be produced in a separate InfluxdbNativeProcessor class. I do not find it necessary as long as there is a just a few methods here.", "author": "ppalaga", "createdAt": "2020-04-07T16:17:11Z", "path": "extensions/influxdb/deployment/src/main/java/org/apache/camel/quarkus/component/influxdb/deployment/InfluxdbProcessor.java", "diffHunk": "@@ -16,32 +16,27 @@\n  */\n package org.apache.camel.quarkus.component.influxdb.deployment;\n \n+import io.quarkus.deployment.annotations.BuildProducer;\n import io.quarkus.deployment.annotations.BuildStep;\n-import io.quarkus.deployment.annotations.ExecutionTime;\n-import io.quarkus.deployment.annotations.Record;\n+import io.quarkus.deployment.builditem.ExtensionSslNativeSupportBuildItem;\n import io.quarkus.deployment.builditem.FeatureBuildItem;\n-import io.quarkus.deployment.pkg.steps.NativeBuild;\n-import org.apache.camel.quarkus.core.JvmOnlyRecorder;\n-import org.jboss.logging.Logger;\n+import io.quarkus.deployment.builditem.nativeimage.NativeImageProxyDefinitionBuildItem;\n \n class InfluxdbProcessor {\n-    private static final Logger LOG = Logger.getLogger(InfluxdbProcessor.class);\n \n     private static final String FEATURE = \"camel-influxdb\";\n \n     @BuildStep\n-    FeatureBuildItem feature() {\n+    FeatureBuildItem feature(BuildProducer<ExtensionSslNativeSupportBuildItem> extensionSslNativeSupport) {\n+\n+        // Indicates that this extension would like the SSL support to be enabled\n+        extensionSslNativeSupport.produce(new ExtensionSslNativeSupportBuildItem(FEATURE));\n+", "originalCommit": "1f27181cc0e811e93a4c6a313b99443b9cba571a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1OTg2NQ==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r404959865", "bodyText": "I'm not so strict, you have some freedom :)", "author": "lburgazzoli", "createdAt": "2020-04-07T16:48:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkzNzk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1MDI0NQ==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r404950245", "bodyText": "I think we do not need a new connection for each request. It could be done in an CDI event listener, something like\nvoid onStart(@Observes org.apache.camel.quarkus.core.CamelMainEvents.BeforeConfigure ev) {\n        InfluxDB influxDB = InfluxDBFactory.connect(context.getPropertiesComponent().parseUri(INFLUXDB_CONNECTION));\n        context.getRegistry().bind(INFLUXDB_CONNECTION_NAME, influxDB);\n    }\n\nWe might perhaps disconnect on BeforeStop", "author": "ppalaga", "createdAt": "2020-04-07T16:34:09Z", "path": "integration-tests/influxdb/src/main/java/org/apache/camel/quarkus/component/influxdb/it/InfluxdbResource.java", "diffHunk": "@@ -33,19 +36,28 @@\n \n     private static final Logger LOG = Logger.getLogger(InfluxdbResource.class);\n \n-    private static final String COMPONENT_INFLUXDB = \"influxdb\";\n+    public static final String INFLUXDB_CONNECTION_PROPERTY = \"quarkus.influxdb.connection.url\";\n+    public static final String INFLUXDB_VERSION = \"1.7.10\";\n+\n+    private static final String INFLUXDB_CONNECTION = \"http://{{\" + INFLUXDB_CONNECTION_PROPERTY + \"}}/\";\n+    private static final String INFLUXDB_CONNECTION_NAME = \"influxDb_connection\";\n+    private static final String INFLUXDB_ENDPOINT_URL = \"influxdb:\" + INFLUXDB_CONNECTION_NAME;\n+\n+    @Inject\n+    ProducerTemplate producerTemplate;\n+\n     @Inject\n     CamelContext context;\n \n-    @Path(\"/load/component/influxdb\")\n+    @Path(\"/ping\")\n     @GET\n     @Produces(MediaType.TEXT_PLAIN)\n-    public Response loadComponentInfluxdb() throws Exception {\n-        /* This is an autogenerated test */\n-        if (context.getComponent(COMPONENT_INFLUXDB) != null) {\n-            return Response.ok().build();\n-        }\n-        LOG.warnf(\"Could not load [%s] from the Camel context\", COMPONENT_INFLUXDB);\n-        return Response.status(500, COMPONENT_INFLUXDB + \" could not be loaded from the Camel context\").build();\n+    public String pingVersion() throws Exception {\n+        InfluxDB influxDB = InfluxDBFactory.connect(context.getPropertiesComponent().parseUri(INFLUXDB_CONNECTION));\n+        context.getRegistry().bind(INFLUXDB_CONNECTION_NAME, influxDB);", "originalCommit": "1f27181cc0e811e93a4c6a313b99443b9cba571a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fb2d781e1b4e851769a85bd3052d558fc8cbfd55", "url": "https://github.com/apache/camel-quarkus/commit/fb2d781e1b4e851769a85bd3052d558fc8cbfd55", "message": "InfluxDB native support #1036", "committedDate": "2020-04-08T14:52:29Z", "type": "forcePushed"}, {"oid": "ab399690f89b3567dee073fe42e70d92fd072a27", "url": "https://github.com/apache/camel-quarkus/commit/ab399690f89b3567dee073fe42e70d92fd072a27", "message": "InfluxDB native support #1036", "committedDate": "2020-04-08T15:02:40Z", "type": "forcePushed"}, {"oid": "05c7ecae63602db80cade50e8ffae6ff47d2a4b2", "url": "https://github.com/apache/camel-quarkus/commit/05c7ecae63602db80cade50e8ffae6ff47d2a4b2", "message": "InfluxDB native support #1036", "committedDate": "2020-04-08T15:05:30Z", "type": "forcePushed"}, {"oid": "03817c7edda046a305f3e6c39a3039d8f78da31a", "url": "https://github.com/apache/camel-quarkus/commit/03817c7edda046a305f3e6c39a3039d8f78da31a", "message": "InfluxDB native support #1036", "committedDate": "2020-04-09T14:46:10Z", "type": "forcePushed"}, {"oid": "017a7bd8597aeeed833f69fb09eefda2df880871", "url": "https://github.com/apache/camel-quarkus/commit/017a7bd8597aeeed833f69fb09eefda2df880871", "message": "InfluxDB native support #1036", "committedDate": "2020-04-09T16:07:13Z", "type": "forcePushed"}, {"oid": "e3ba53764029b80d0ee854dacf3d7763871bd6d8", "url": "https://github.com/apache/camel-quarkus/commit/e3ba53764029b80d0ee854dacf3d7763871bd6d8", "message": "InfluxDB native support #1036", "committedDate": "2020-04-09T16:08:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxODYwMQ==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r406318601", "bodyText": "@ppalaga , @lburgazzoli\nIf I understand your previous comments, this should be the desired solution - do not name classes by one, but use the whole package name.\nUnfortunately this is not working in native mode.\nIn JVM mode I can see that search on the index is correct and returns:\n\n[org.influxdb.dto.BatchPoints, org.influxdb.dto.BoundParameterQuery, org.influxdb.dto.Point, org.influxdb.dto.Pong, org.influxdb.dto.Query, org.influxdb.dto.QueryResult]\n\nIs it possible that index is not updated by the new build item from previous step (in native), because the desired classes are added in previous step into index?", "author": "JiriOndrusek", "createdAt": "2020-04-09T16:14:49Z", "path": "extensions/influxdb/deployment/src/main/java/org/apache/camel/quarkus/component/influxdb/deployment/InfluxdbProcessor.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.camel.quarkus.component.influxdb.deployment;\n+\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.ExtensionSslNativeSupportBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.IndexDependencyBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.NativeImageProxyDefinitionBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import org.influxdb.dto.QueryResult;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.IndexView;\n+\n+class InfluxdbProcessor {\n+\n+    private static DotName INFLUXDB_DTO_PACKAGE = DotName.createSimple(\"org.influxdb.dto\");\n+\n+    private static final String FEATURE = \"camel-influxdb\";\n+\n+    @BuildStep\n+    FeatureBuildItem feature() {\n+\n+        return new FeatureBuildItem(FEATURE);\n+    }\n+\n+    @BuildStep\n+    void sslSupport(BuildProducer<ExtensionSslNativeSupportBuildItem> extensionSslNativeSupport) {\n+\n+        // Indicates that this extension would like the SSL support to be enabled\n+        extensionSslNativeSupport.produce(new ExtensionSslNativeSupportBuildItem(FEATURE));\n+    }\n+\n+    @BuildStep\n+    void clientProxies(BuildProducer<NativeImageProxyDefinitionBuildItem> proxies) {\n+        proxies.produce(new NativeImageProxyDefinitionBuildItem(\"org.influxdb.impl.InfluxDBService\"));\n+    }\n+\n+\n+    @BuildStep\n+    IndexDependencyBuildItem registerDependencyForIndex() {\n+        return new IndexDependencyBuildItem(\"org.influxdb\", \"influxdb-java\");\n+    }\n+\n+    @BuildStep\n+    ReflectiveClassBuildItem registerForReflection(CombinedIndexBuildItem combinedIndex) {\n+//        IndexView index = combinedIndex.getIndex();\n+//\n+//        String[] dtos = index.getKnownClasses().stream()\n+//                .filter(ci -> ci.name().prefix().equals(INFLUXDB_DTO_PACKAGE))\n+//                .map(ci -> ci.name().toString())\n+//                .sorted()\n+//                .toArray(String[]::new);\n+//\n+//        return new ReflectiveClassBuildItem(true, true, dtos);", "originalCommit": "e3ba53764029b80d0ee854dacf3d7763871bd6d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMzc3Nw==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r406323777", "bodyText": "Strange. You may want to add .peek(System.out::println) before .filter() to see whether the inner classes are in the index. If they appear in the log, that probably means that ci.name().prefix() returns something else than you expect.", "author": "ppalaga", "createdAt": "2020-04-09T16:23:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxODYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyNTk5NQ==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r406325995", "bodyText": "btw the search should not appear neither in jvm nor in native mode as it happens during augmentation", "author": "lburgazzoli", "createdAt": "2020-04-09T16:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxODYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyODY4Mg==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r406328682", "bodyText": "I've tried peek, as suggested - but in console there are noin influxdb classes present.\nI was able to debug this method in JVM mode -> to be sure, that filter works correctly and it is.\nIf I disable step with influxdb adition in jvm mode, it behaves in the same way as native (no ivfluxdb classes found) -> IMO index is not updated by added dependency of influxdb. (which could be caused, that I haven't defined any kind of dependency between these 2 steps )", "author": "JiriOndrusek", "createdAt": "2020-04-09T16:31:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxODYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNjIwNg==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r406336206", "bodyText": "you have a dependency as you require CombinedIndexBuildItem which of course need to collect all the IndexDependencyBuildItem.", "author": "lburgazzoli", "createdAt": "2020-04-09T16:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxODYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2MTc3MQ==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r406361771", "bodyText": "Problem was caused by the fact, that same required classes are definned as inner classes therefore they have different prefix (e.g. org.influxdb.dto.QueryResult$Series). It works with modification of filter to use 'startsWith' instead of 'equals'.", "author": "JiriOndrusek", "createdAt": "2020-04-09T17:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxODYwMQ=="}], "type": "inlineReview"}, {"oid": "657014b9552e2fe3fbc6a088eef3142e5e430178", "url": "https://github.com/apache/camel-quarkus/commit/657014b9552e2fe3fbc6a088eef3142e5e430178", "message": "InfluxDB native support #1036", "committedDate": "2020-04-09T17:26:56Z", "type": "forcePushed"}, {"oid": "6fe2f4314289b0ed9c21e9c64d58f510e1c58c55", "url": "https://github.com/apache/camel-quarkus/commit/6fe2f4314289b0ed9c21e9c64d58f510e1c58c55", "message": "InfluxDB native support #1036", "committedDate": "2020-04-09T17:30:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQxNTAxMQ==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r406415011", "bodyText": "false, true is typically enough. Could you please check, unless you did already?", "author": "ppalaga", "createdAt": "2020-04-09T19:02:45Z", "path": "extensions/influxdb/deployment/src/main/java/org/apache/camel/quarkus/component/influxdb/deployment/InfluxdbProcessor.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.camel.quarkus.component.influxdb.deployment;\n+\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.ExtensionSslNativeSupportBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.IndexDependencyBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.NativeImageProxyDefinitionBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import org.jboss.jandex.IndexView;\n+\n+class InfluxdbProcessor {\n+\n+    private static String INFLUXDB_DTO_PACKAGE = \"org.influxdb.dto\";\n+\n+    private static final String FEATURE = \"camel-influxdb\";\n+\n+    @BuildStep\n+    FeatureBuildItem feature() {\n+\n+        return new FeatureBuildItem(FEATURE);\n+    }\n+\n+    @BuildStep\n+    void sslSupport(BuildProducer<ExtensionSslNativeSupportBuildItem> extensionSslNativeSupport) {\n+\n+        // Indicates that this extension would like the SSL support to be enabled\n+        extensionSslNativeSupport.produce(new ExtensionSslNativeSupportBuildItem(FEATURE));\n+    }\n+\n+    @BuildStep\n+    void clientProxies(BuildProducer<NativeImageProxyDefinitionBuildItem> proxies) {\n+        proxies.produce(new NativeImageProxyDefinitionBuildItem(\"org.influxdb.impl.InfluxDBService\"));\n+    }\n+\n+    @BuildStep\n+    ReflectiveClassBuildItem registerForReflection(CombinedIndexBuildItem combinedIndex) {\n+        IndexView index = combinedIndex.getIndex();\n+\n+        String[] dtos = index.getKnownClasses().stream()\n+                .map(ci -> ci.name().toString())\n+                .filter(n -> n.startsWith(INFLUXDB_DTO_PACKAGE))\n+                .sorted()\n+                .toArray(String[]::new);\n+\n+        return new ReflectiveClassBuildItem(true, true, dtos);", "originalCommit": "6fe2f4314289b0ed9c21e9c64d58f510e1c58c55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk3OTA0Mw==", "url": "https://github.com/apache/camel-quarkus/pull/1050#discussion_r407979043", "bodyText": "@ppalaga  you are right, 'false, true' is enough. I've fixed PR", "author": "JiriOndrusek", "createdAt": "2020-04-14T09:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQxNTAxMQ=="}], "type": "inlineReview"}, {"oid": "eeccc3c5d75b3a81523378dfefaecd61376cb879", "url": "https://github.com/apache/camel-quarkus/commit/eeccc3c5d75b3a81523378dfefaecd61376cb879", "message": "InfluxDB native support #1036", "committedDate": "2020-04-14T09:00:51Z", "type": "forcePushed"}, {"oid": "ce30acf47c3f7f6e49aa8fbc82495f63a8d77a9e", "url": "https://github.com/apache/camel-quarkus/commit/ce30acf47c3f7f6e49aa8fbc82495f63a8d77a9e", "message": "InfluxDB native support #1036", "committedDate": "2020-04-14T10:05:50Z", "type": "forcePushed"}, {"oid": "de96e372b271f1d11d761c5d17b37efe953b081c", "url": "https://github.com/apache/camel-quarkus/commit/de96e372b271f1d11d761c5d17b37efe953b081c", "message": "InfluxDB native support #1036", "committedDate": "2020-04-14T12:01:29Z", "type": "forcePushed"}, {"oid": "5b4496a9518afa977a77af440828083d86bf0506", "url": "https://github.com/apache/camel-quarkus/commit/5b4496a9518afa977a77af440828083d86bf0506", "message": "InfluxDB native support #1036", "committedDate": "2020-04-15T07:04:06Z", "type": "forcePushed"}, {"oid": "9afde1300c1a055a7d87c9954747a13164c3a194", "url": "https://github.com/apache/camel-quarkus/commit/9afde1300c1a055a7d87c9954747a13164c3a194", "message": "InfluxDB native support #1036", "committedDate": "2020-04-15T07:57:31Z", "type": "commit"}, {"oid": "9afde1300c1a055a7d87c9954747a13164c3a194", "url": "https://github.com/apache/camel-quarkus/commit/9afde1300c1a055a7d87c9954747a13164c3a194", "message": "InfluxDB native support #1036", "committedDate": "2020-04-15T07:57:31Z", "type": "forcePushed"}]}