{"pr_number": 2453, "pr_title": "Add Supranational BLS implementation", "pr_createdAt": "2020-07-27T16:59:57Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2453", "timeline": [{"oid": "5dca0433aee2f410d8ea79bad1935fbb93ba8102", "url": "https://github.com/ConsenSys/teku/commit/5dca0433aee2f410d8ea79bad1935fbb93ba8102", "message": "Make a distinction of BLSSignature from/toSSZBytes() and from/toBytesCompressed() though they are equivalent with the current SSZ implementation", "committedDate": "2020-07-30T15:34:21Z", "type": "commit"}, {"oid": "913e484ad9bf80718de5007a74e0fc789df903f4", "url": "https://github.com/ConsenSys/teku/commit/913e484ad9bf80718de5007a74e0fc789df903f4", "message": "Add try/catch/finally to explicitly delete native structures", "committedDate": "2020-07-30T16:05:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyMzM2OA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463123368", "bodyText": "Should we have an assert here, if only to be explicit about what we are testing for?", "author": "benjaminion", "createdAt": "2020-07-30T16:31:27Z", "path": "bls/src/test/java/tech/pegasys/teku/bls/BLSPublicKeyTest.java", "diffHunk": "@@ -29,16 +31,18 @@\n           \"0xc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\");\n \n   @Test\n-  void isValidReturnsTrueForValidKey() {\n-    BLSPublicKey publicKey = BLSPublicKey.random(1);\n-    assertTrue(publicKey.isValid());\n+  void fromBytesCompressedValidate_okWhenValidBytes() {\n+    BLSPublicKey.fromBytesCompressedValidate(BLSPublicKey.random(1).toBytesCompressed());", "originalCommit": "913e484ad9bf80718de5007a74e0fc789df903f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMTU3Mw==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463131573", "bodyText": "Should probably assert something here - ideally that the signature is a member of G2. Or that we can sign and verify something with it. Not sure really.", "author": "benjaminion", "createdAt": "2020-07-30T16:45:06Z", "path": "bls/src/test/java/tech/pegasys/teku/bls/BLSSignatureTest.java", "diffHunk": "@@ -84,14 +85,34 @@ void succeedsWhenEqualsReturnsFalseForDifferentSignatures() {\n   @Test\n   void succeedsWhenRoundtripSSZReturnsTheSameSignature() {\n     BLSSignature signature1 = BLSSignature.random(65);\n-    BLSSignature signature2 = BLSSignature.fromBytes(signature1.toBytes());\n+    BLSSignature signature2 = BLSSignature.fromSSZBytes(signature1.toSSZBytes());\n     assertEquals(signature1, signature2);\n   }\n \n   @Test\n   void succeedsWhenRoundtripSSZReturnsTheEmptySignature() {\n     BLSSignature signature1 = BLSSignature.empty();\n-    BLSSignature signature2 = BLSSignature.fromBytes(signature1.toBytes());\n+    BLSSignature signature2 = BLSSignature.fromSSZBytes(signature1.toSSZBytes());\n     assertEquals(signature1, signature2);\n   }\n+\n+  @Test\n+  void succeedsWhenEqualsReturnsTrueForEmptySignatures() {\n+    assertEquals(BLSSignature.empty(), BLSSignature.empty());\n+    assertEquals(BLSSignature.empty().hashCode(), BLSSignature.empty().hashCode());\n+  }\n+\n+  @Test\n+  void roundtripEncodeDecodeCompressed() {\n+    BLSSignature signature = BLSSignature.random(513);\n+    final BLSSignature result = BLSSignature.fromBytesCompressed(signature.toBytesCompressed());\n+    assertEquals(signature, result);\n+    assertEquals(signature.hashCode(), result.hashCode());\n+  }\n+\n+  @Test\n+  void testRandomFromSeed() {\n+    BLSSignature randomSig = BLSSignature.random(92892840);\n+    System.out.println(randomSig);", "originalCommit": "913e484ad9bf80718de5007a74e0fc789df903f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1MTAxNg==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463151016", "bodyText": "Oh that were just experiments when I was sorting out that problem with incompatible random signatures.\nWould remove this case as there are a lot of other random() cases and this one has nothing special.", "author": "Nashatyrev", "createdAt": "2020-07-30T17:18:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMTU3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzNDAwNg==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463134006", "bodyText": "Nit - comment looks like a left-over.", "author": "benjaminion", "createdAt": "2020-07-30T16:48:59Z", "path": "bls/src/test/java/tech/pegasys/teku/bls/impl/blst/BlstTest.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.bls.impl.blst;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.util.List;\n+import java.util.Random;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.bls.BatchSemiAggregate;\n+\n+public class BlstTest {\n+  private static final Random random = new Random(1);\n+\n+  private static BlstBLS12381 BLS;\n+\n+  @BeforeAll\n+  static void setup() {\n+    BLS = BlstBLS12381.INSTANCE.orElseThrow();\n+  }\n+\n+  @Test\n+  void testBatchVerifySingleSig() {\n+    Bytes msg = Bytes32.ZERO; // .fromHexString(\"123456\");", "originalCommit": "913e484ad9bf80718de5007a74e0fc789df903f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0MDEwNQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463140105", "bodyText": "Ugh. Why did this change? Is dataStructureUtil.randomSignature(); using a different seed value? That whole thing looks a bit fragile to me. (Not your problem!)", "author": "benjaminion", "createdAt": "2020-07-30T16:59:04Z", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/signer/SignerTest.java", "diffHunk": "@@ -53,11 +53,11 @@ public void shouldCreateRandaoReveal() {\n   }\n \n   @Test\n-  public void shouldSignBlock() {\n+  public void shouldSignBlock1() {\n     final BeaconBlock block = dataStructureUtil.randomBeaconBlock(10);\n     final BLSSignature signature = dataStructureUtil.randomSignature();\n     final Bytes expectedSigningRoot =\n-        Bytes.fromHexString(\"0xc0e4ed8375c98504b262f610f217d31ebf109f0f73c164362090c6ad7d4770c1\");\n+        Bytes.fromHexString(\"0xfa8b3cfed0268ed15e354e84db5558eb76ad30737a86d6d057615e331ff30d44\");", "originalCommit": "913e484ad9bf80718de5007a74e0fc789df903f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NzgyNQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463147825", "bodyText": "All the BLS random items are generated using random secret key. The random key was generated with Mikuli RAND and blst uses key material to derive secret key from. It doesn't matter for normal use, but for tests the secret key generated from the same seed differed between Mikuli and Blst. So I did implementation independent secret key generation from seed for testing purposes and update this hash to actual value.\nYep it looks fragile but seems to work fine: the same seed should always yields the same random structure. With the exception may be of this change  :)", "author": "Nashatyrev", "createdAt": "2020-07-30T17:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0MDEwNQ=="}], "type": "inlineReview"}, {"oid": "7ade0ab8882745d14b60b903de90ea617b0e4a64", "url": "https://github.com/ConsenSys/teku/commit/7ade0ab8882745d14b60b903de90ea617b0e4a64", "message": "Minor BLS tests cleanups", "committedDate": "2020-07-30T17:21:06Z", "type": "commit"}, {"oid": "b60a0461bd941c71c1bf6b31f8679533098d00dc", "url": "https://github.com/ConsenSys/teku/commit/b60a0461bd941c71c1bf6b31f8679533098d00dc", "message": "Move BLS.aggregatePublicKeys() -> BLSPublicKey.aggregate(), rename BLS.aggregateSignatures() -> BLS.aggregate()", "committedDate": "2020-07-30T17:49:25Z", "type": "commit"}, {"oid": "377eaf116e5ab22011874c0e442d45b123f2c3b6", "url": "https://github.com/ConsenSys/teku/commit/377eaf116e5ab22011874c0e442d45b123f2c3b6", "message": "Merge branch 'master' into feature-blst", "committedDate": "2020-07-30T23:03:52Z", "type": "commit"}, {"oid": "d7559ca3e81b40bc4c48a6c73171535262929b1b", "url": "https://github.com/ConsenSys/teku/commit/d7559ca3e81b40bc4c48a6c73171535262929b1b", "message": "Merge branch 'master' into feature-blst", "committedDate": "2020-07-31T09:18:26Z", "type": "commit"}, {"oid": "fc11c9f816ebf4c0e1d4b4e7474e36aa177b6ee5", "url": "https://github.com/ConsenSys/teku/commit/fc11c9f816ebf4c0e1d4b4e7474e36aa177b6ee5", "message": "Draft initial experiments", "committedDate": "2020-06-25T11:36:52Z", "type": "commit"}, {"oid": "1532577877735027a196df225571347cdf0c3f4c", "url": "https://github.com/ConsenSys/teku/commit/1532577877735027a196df225571347cdf0c3f4c", "message": "Merge remote-tracking branch 'pegasys/master' into experimental-supra", "committedDate": "2020-07-03T11:28:31Z", "type": "commit"}, {"oid": "745ca3adf35b17310ec432c772069b485d40f1af", "url": "https://github.com/ConsenSys/teku/commit/745ca3adf35b17310ec432c772069b485d40f1af", "message": "Add JNA library draft", "committedDate": "2020-07-07T09:56:19Z", "type": "commit"}, {"oid": "f442a696a28820d69b8c3a43530ec89a983c3c78", "url": "https://github.com/ConsenSys/teku/commit/f442a696a28820d69b8c3a43530ec89a983c3c78", "message": "Move SWIG wrappers to a separate package", "committedDate": "2020-07-07T09:57:35Z", "type": "commit"}, {"oid": "986c4a8882b28a9bbfe689daf7b71cd8b4706b35", "url": "https://github.com/ConsenSys/teku/commit/986c4a8882b28a9bbfe689daf7b71cd8b4706b35", "message": "Updated SWIG wrappers", "committedDate": "2020-07-09T09:39:48Z", "type": "commit"}, {"oid": "3eff96d075e98d3b985808d49b19a650a34aae3a", "url": "https://github.com/ConsenSys/teku/commit/3eff96d075e98d3b985808d49b19a650a34aae3a", "message": "Initial BLS Blst classes. Tests updated", "committedDate": "2020-07-09T09:40:52Z", "type": "commit"}, {"oid": "7413682b695272b224bf0e0bd142a120bae8aa28", "url": "https://github.com/ConsenSys/teku/commit/7413682b695272b224bf0e0bd142a120bae8aa28", "message": "Merge remote-tracking branch 'pegasys/master' into experimental-supra", "committedDate": "2020-07-10T15:33:23Z", "type": "commit"}, {"oid": "5cb89b4083413957d9d41236dab2c3e08fea3ac1", "url": "https://github.com/ConsenSys/teku/commit/5cb89b4083413957d9d41236dab2c3e08fea3ac1", "message": "Update the draft", "committedDate": "2020-07-10T17:37:44Z", "type": "commit"}, {"oid": "54f7a01191054ce14ba03296572a8836e5d8a2a2", "url": "https://github.com/ConsenSys/teku/commit/54f7a01191054ce14ba03296572a8836e5d8a2a2", "message": "Merge remote-tracking branch 'pegasys/master' into experimental-supra", "committedDate": "2020-07-15T15:47:11Z", "type": "commit"}, {"oid": "9256c9380888296119dc599a7e837e80ee9fe8a1", "url": "https://github.com/ConsenSys/teku/commit/9256c9380888296119dc599a7e837e80ee9fe8a1", "message": "temp commit", "committedDate": "2020-07-15T17:51:13Z", "type": "commit"}, {"oid": "67b1a9dd9c81cf43320384ffda9186e5f157e2ce", "url": "https://github.com/ConsenSys/teku/commit/67b1a9dd9c81cf43320384ffda9186e5f157e2ce", "message": "Upgrade blst classes", "committedDate": "2020-07-16T14:56:35Z", "type": "commit"}, {"oid": "f8da728c5c00c36930b2774dd1317798b94bb1a0", "url": "https://github.com/ConsenSys/teku/commit/f8da728c5c00c36930b2774dd1317798b94bb1a0", "message": "Update tests", "committedDate": "2020-07-16T15:09:18Z", "type": "commit"}, {"oid": "a7439d5035a31ced82f0d9d4ebb5d9a62008c447", "url": "https://github.com/ConsenSys/teku/commit/a7439d5035a31ced82f0d9d4ebb5d9a62008c447", "message": "Update dll", "committedDate": "2020-07-16T15:10:34Z", "type": "commit"}, {"oid": "939e3016fcbb8e20688ee0445b654b41ec13d83c", "url": "https://github.com/ConsenSys/teku/commit/939e3016fcbb8e20688ee0445b654b41ec13d83c", "message": "Temp disable json-simple lib", "committedDate": "2020-07-16T15:11:26Z", "type": "commit"}, {"oid": "7fd531bb735616406bdab6f72bfccdf8ecaf621d", "url": "https://github.com/ConsenSys/teku/commit/7fd531bb735616406bdab6f72bfccdf8ecaf621d", "message": "Initial draft for BLS interfaces", "committedDate": "2020-07-16T18:02:55Z", "type": "commit"}, {"oid": "69300d6d746f78fa517e2f43c8da168adf84b450", "url": "https://github.com/ConsenSys/teku/commit/69300d6d746f78fa517e2f43c8da168adf84b450", "message": "exclude outdated junit transitive dependency from json-simple module", "committedDate": "2020-07-16T19:02:44Z", "type": "commit"}, {"oid": "8724e7f1e9d3bbff924de56ee13f0e83e47521ef", "url": "https://github.com/ConsenSys/teku/commit/8724e7f1e9d3bbff924de56ee13f0e83e47521ef", "message": "Rename test file to Win compatible", "committedDate": "2020-07-16T20:06:23Z", "type": "commit"}, {"oid": "84691cd609aed1ee0aa357b8c33dad7b152aa45b", "url": "https://github.com/ConsenSys/teku/commit/84691cd609aed1ee0aa357b8c33dad7b152aa45b", "message": "Merge branch 'fix-bls-tests-1' into feature-bls-interfaces", "committedDate": "2020-07-16T20:23:20Z", "type": "commit"}, {"oid": "a8bafde8097d10593540eb8c0270bae987d62107", "url": "https://github.com/ConsenSys/teku/commit/a8bafde8097d10593540eb8c0270bae987d62107", "message": "Another portion of draft changes", "committedDate": "2020-07-17T10:49:19Z", "type": "commit"}, {"oid": "b5762f4aee4b16a48a31b7ac859eabdf527eba07", "url": "https://github.com/ConsenSys/teku/commit/b5762f4aee4b16a48a31b7ac859eabdf527eba07", "message": "Adjust bls tests by separating them to abstract and implementation specific", "committedDate": "2020-07-17T13:01:37Z", "type": "commit"}, {"oid": "27aace71b79d77d6391efb4e797039e8be085abd", "url": "https://github.com/ConsenSys/teku/commit/27aace71b79d77d6391efb4e797039e8be085abd", "message": "Add NoopBLS12381 implementation", "committedDate": "2020-07-17T13:18:31Z", "type": "commit"}, {"oid": "5f93ac4be839856ed8ce4982d1c608ef08d70929", "url": "https://github.com/ConsenSys/teku/commit/5f93ac4be839856ed8ce4982d1c608ef08d70929", "message": "Fix warnings", "committedDate": "2020-07-17T13:24:24Z", "type": "commit"}, {"oid": "7c4faf635ea6915804b85790653e329101568426", "url": "https://github.com/ConsenSys/teku/commit/7c4faf635ea6915804b85790653e329101568426", "message": "Fix more warns", "committedDate": "2020-07-17T13:33:17Z", "type": "commit"}, {"oid": "c221980d33528bc0e081a9445d2ba7af6df2c3fe", "url": "https://github.com/ConsenSys/teku/commit/c221980d33528bc0e081a9445d2ba7af6df2c3fe", "message": "Merge remote-tracking branch 'pegasys/master' into feature-bls-interfaces\n\n# Conflicts:\n#\tbls/src/main/java/tech/pegasys/teku/bls/BLS.java\n#\tbls/src/main/java/tech/pegasys/teku/bls/BLSPublicKey.java\n#\tbls/src/test/java/tech/pegasys/teku/bls/BLSPublicKeyTest.java\n#\tdata/provider/src/main/java/tech/pegasys/teku/api/schema/BLSPubKey.java", "committedDate": "2020-07-17T13:37:37Z", "type": "commit"}, {"oid": "8c41c8d8a21a6be79118bac9892cdbca6f02ab9b", "url": "https://github.com/ConsenSys/teku/commit/8c41c8d8a21a6be79118bac9892cdbca6f02ab9b", "message": "Resolve merge conflicts", "committedDate": "2020-07-17T13:55:44Z", "type": "commit"}, {"oid": "aab091f6a18e7a86df5b45d5a6f2cddeb9244205", "url": "https://github.com/ConsenSys/teku/commit/aab091f6a18e7a86df5b45d5a6f2cddeb9244205", "message": "Fix the test", "committedDate": "2020-07-17T14:39:45Z", "type": "commit"}, {"oid": "2040313237e184415e6ec626704ca5946ab045c3", "url": "https://github.com/ConsenSys/teku/commit/2040313237e184415e6ec626704ca5946ab045c3", "message": "Fix the test", "committedDate": "2020-07-20T10:54:35Z", "type": "commit"}, {"oid": "69313d7198d78bec898b98c1d3d932c72bedf9bd", "url": "https://github.com/ConsenSys/teku/commit/69313d7198d78bec898b98c1d3d932c72bedf9bd", "message": "Merge remote-tracking branch 'pegasys/master' into feature-bls-interfaces", "committedDate": "2020-07-20T11:10:26Z", "type": "commit"}, {"oid": "59e59c129430b1f2f9d1375ad8d3531251af5dc6", "url": "https://github.com/ConsenSys/teku/commit/59e59c129430b1f2f9d1375ad8d3531251af5dc6", "message": "Merge branch 'feature-bls-interfaces' into experimental-supra\n\n# Conflicts:\n#\tbls/build.gradle\n#\tbls/src/test/java/tech/pegasys/teku/bls/impl/mikuli/hash2g2/ReferenceTests.java", "committedDate": "2020-07-20T16:30:38Z", "type": "commit"}, {"oid": "5b48be7b31b51fcd274143240f482ef2db02fafd", "url": "https://github.com/ConsenSys/teku/commit/5b48be7b31b51fcd274143240f482ef2db02fafd", "message": "Remove JNA binding", "committedDate": "2020-07-20T16:36:16Z", "type": "commit"}, {"oid": "6c4314b57c06f0b95065fde3f4d3c86f4b78a9c8", "url": "https://github.com/ConsenSys/teku/commit/6c4314b57c06f0b95065fde3f4d3c86f4b78a9c8", "message": "Move Blst code to the appropriate package, rename classes", "committedDate": "2020-07-20T16:43:00Z", "type": "commit"}, {"oid": "3c653a5d041cc864eea2d5c78bcb70cf73b793cd", "url": "https://github.com/ConsenSys/teku/commit/3c653a5d041cc864eea2d5c78bcb70cf73b793cd", "message": "Derive Blst classes from common impl interfaces", "committedDate": "2020-07-20T17:31:10Z", "type": "commit"}, {"oid": "edf288a4f1f89bf0e13d4d97d60f7749d7f63e46", "url": "https://github.com/ConsenSys/teku/commit/edf288a4f1f89bf0e13d4d97d60f7749d7f63e46", "message": "Merge remote-tracking branch 'pegasys/master' into feature-blst\n\n# Conflicts:\n#\tbls/src/main/java/tech/pegasys/teku/bls/BLS.java\n#\tbls/src/main/java/tech/pegasys/teku/bls/impl/Signature.java\n#\tbls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/MikuliBLS12381.java\n#\tbls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/MikuliPublicKey.java\n#\tbls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/MikuliSignature.java\n#\tbls/src/main/java/tech/pegasys/teku/bls/impl/noop/NoopBLS12381.java\n#\tbls/src/main/java/tech/pegasys/teku/bls/impl/noop/NoopSignature.java", "committedDate": "2020-07-21T11:56:39Z", "type": "commit"}, {"oid": "a6aafa1a7bbee8ec5284fd6725ef06517a376fce", "url": "https://github.com/ConsenSys/teku/commit/a6aafa1a7bbee8ec5284fd6725ef06517a376fce", "message": "Load native library from resources", "committedDate": "2020-07-21T12:02:53Z", "type": "commit"}, {"oid": "763bddeae0e8124a3b384c2522376bf8a9a89093", "url": "https://github.com/ConsenSys/teku/commit/763bddeae0e8124a3b384c2522376bf8a9a89093", "message": "BlstSecretKey should be created from 48 bytes and return 48 bytes from toBytes() according to interface", "committedDate": "2020-07-21T13:13:40Z", "type": "commit"}, {"oid": "950622b3a5e349beaa260a8bf4528ba585df52dc", "url": "https://github.com/ConsenSys/teku/commit/950622b3a5e349beaa260a8bf4528ba585df52dc", "message": "Make Mikuli specific test relying on the mikuli implementation", "committedDate": "2020-07-21T13:24:39Z", "type": "commit"}, {"oid": "c20d6cbec9607577b946fd37be7be6dc1b8df781", "url": "https://github.com/ConsenSys/teku/commit/c20d6cbec9607577b946fd37be7be6dc1b8df781", "message": "Merge remote-tracking branch 'pegasys/master' into feature-blst", "committedDate": "2020-07-21T16:32:48Z", "type": "commit"}, {"oid": "d32eed884e52b90e1d0b9cc5407e887417700922", "url": "https://github.com/ConsenSys/teku/commit/d32eed884e52b90e1d0b9cc5407e887417700922", "message": "Add latest Blst DLL", "committedDate": "2020-07-21T16:34:52Z", "type": "commit"}, {"oid": "28f099ac888ed45c6632dc2ebf4f85c8cd7fd6a2", "url": "https://github.com/ConsenSys/teku/commit/28f099ac888ed45c6632dc2ebf4f85c8cd7fd6a2", "message": "Merge remote-tracking branch 'pegasys/master' into feature-blst", "committedDate": "2020-07-22T12:22:20Z", "type": "commit"}, {"oid": "cc7f83b178654bb76d86cc5bd4222a764b21a6ba", "url": "https://github.com/ConsenSys/teku/commit/cc7f83b178654bb76d86cc5bd4222a764b21a6ba", "message": "BlstSecretKey is created from Bytes32", "committedDate": "2020-07-22T12:24:45Z", "type": "commit"}, {"oid": "27f8cb35897616aac384aa9b2434f2bc501eb32a", "url": "https://github.com/ConsenSys/teku/commit/27f8cb35897616aac384aa9b2434f2bc501eb32a", "message": "Fix Mikuli specific test to use Mikuli implementation", "committedDate": "2020-07-22T13:02:37Z", "type": "commit"}, {"oid": "f06b765a9500f0ac94ad05ef07c82347c16fdccb", "url": "https://github.com/ConsenSys/teku/commit/f06b765a9500f0ac94ad05ef07c82347c16fdccb", "message": "Implement BlstPublicKey validation", "committedDate": "2020-07-22T13:34:39Z", "type": "commit"}, {"oid": "922254fda8f6ab2489ee9ba9ffea3ab8aaa9644c", "url": "https://github.com/ConsenSys/teku/commit/922254fda8f6ab2489ee9ba9ffea3ab8aaa9644c", "message": "Replace BLSPublicKey.isValid() with fromBytesCompressedValidate() method", "committedDate": "2020-07-22T13:35:37Z", "type": "commit"}, {"oid": "dd744d1627e55ca3b6ec91e4e462e0f046e9a395", "url": "https://github.com/ConsenSys/teku/commit/dd744d1627e55ca3b6ec91e4e462e0f046e9a395", "message": "Make BLSPublicKey fromBytesCompressed/toBytesCompressed operating with Bytes48 type. SecretKey.toBytes() returns Bytes32", "committedDate": "2020-07-22T14:07:36Z", "type": "commit"}, {"oid": "dcef1b32c2db314cdff5752cd893a5cc1b55de4f", "url": "https://github.com/ConsenSys/teku/commit/dcef1b32c2db314cdff5752cd893a5cc1b55de4f", "message": "Rename BLSPublicKey/BLSSignature.from/toBytes() methods to from/toSSZBytes() to be more explicit", "committedDate": "2020-07-22T14:38:54Z", "type": "commit"}, {"oid": "a8ae35bdc6eddc2dbf247328fdec6c8e7c98da08", "url": "https://github.com/ConsenSys/teku/commit/a8ae35bdc6eddc2dbf247328fdec6c8e7c98da08", "message": "Hide constructors. Make PublicKey and Signature implementations to be lazily evaluated inside corresponding BLS wrappers", "committedDate": "2020-07-22T16:21:11Z", "type": "commit"}, {"oid": "3e13b6e4dd1356ed122bdb6f322d0599cb97e844", "url": "https://github.com/ConsenSys/teku/commit/3e13b6e4dd1356ed122bdb6f322d0599cb97e844", "message": "Fix DLL binary attribute", "committedDate": "2020-07-22T16:21:33Z", "type": "commit"}, {"oid": "2f4d590af28fc17afde806e2ffa5656cc7c3f399", "url": "https://github.com/ConsenSys/teku/commit/2f4d590af28fc17afde806e2ffa5656cc7c3f399", "message": "Again add DLL", "committedDate": "2020-07-22T16:22:07Z", "type": "commit"}, {"oid": "706f888ca7c9b32c720fe8237ba230bb1b30c55d", "url": "https://github.com/ConsenSys/teku/commit/706f888ca7c9b32c720fe8237ba230bb1b30c55d", "message": "Validate BlstSignature when creating from bytes", "committedDate": "2020-07-22T16:35:06Z", "type": "commit"}, {"oid": "66a854c4caa0d14cbdcf1f14f3b91a58ae387fe5", "url": "https://github.com/ConsenSys/teku/commit/66a854c4caa0d14cbdcf1f14f3b91a58ae387fe5", "message": "Add comments", "committedDate": "2020-07-22T16:35:23Z", "type": "commit"}, {"oid": "4db7dc45482d71c2de28f2dec42829061f4a7cad", "url": "https://github.com/ConsenSys/teku/commit/4db7dc45482d71c2de28f2dec42829061f4a7cad", "message": "Fix BlstPublicKey validation", "committedDate": "2020-07-22T16:54:03Z", "type": "commit"}, {"oid": "14e7f972ded2ed15775729362c960304d3f62dda", "url": "https://github.com/ConsenSys/teku/commit/14e7f972ded2ed15775729362c960304d3f62dda", "message": "Fix accidentally committed wrong ETH2_DST", "committedDate": "2020-07-23T10:37:29Z", "type": "commit"}, {"oid": "1b2f04ba4e04bf13da9f5b9bab778aeb4be21a56", "url": "https://github.com/ConsenSys/teku/commit/1b2f04ba4e04bf13da9f5b9bab778aeb4be21a56", "message": "Add a BLS test", "committedDate": "2020-07-23T10:38:28Z", "type": "commit"}, {"oid": "54c6d4ec3ba5383f5388f41c56c632b7df6e54df", "url": "https://github.com/ConsenSys/teku/commit/54c6d4ec3ba5383f5388f41c56c632b7df6e54df", "message": "Add mikuli and blst specific infinity signature tests", "committedDate": "2020-07-23T10:39:09Z", "type": "commit"}, {"oid": "d65ec8644e185aa1d441212afaa4415e03522bc9", "url": "https://github.com/ConsenSys/teku/commit/d65ec8644e185aa1d441212afaa4415e03522bc9", "message": "Add BlstPublicKey.fromBytesUncompressed for testing", "committedDate": "2020-07-23T10:40:16Z", "type": "commit"}, {"oid": "87d4cd5bced64b48775e8319aaa82c0470f8dc2d", "url": "https://github.com/ConsenSys/teku/commit/87d4cd5bced64b48775e8319aaa82c0470f8dc2d", "message": "Convert pre-generated keypairs dump to 32-byte secretKeys and compressed pubkeys", "committedDate": "2020-07-23T10:55:45Z", "type": "commit"}, {"oid": "d4e5ca890651c35b8a8f1327847ef59275192105", "url": "https://github.com/ConsenSys/teku/commit/d4e5ca890651c35b8a8f1327847ef59275192105", "message": "For BLSPublicKey/BLSSignature use bytes representation for hashCode() and equals() since we need ability to compare valid (from SSZ standpoint) 'empty' instances, but shouldn't decode them to real instances", "committedDate": "2020-07-23T12:57:06Z", "type": "commit"}, {"oid": "5b308dd0ed9c05ef4152074099f4abd2971fe0a0", "url": "https://github.com/ConsenSys/teku/commit/5b308dd0ed9c05ef4152074099f4abd2971fe0a0", "message": "Move the test case to BLSSignatureTest since empty() case is not handled by the implementation", "committedDate": "2020-07-23T12:59:07Z", "type": "commit"}, {"oid": "1af5520357cb4d660c9b64ad08e2b34b2de869b5", "url": "https://github.com/ConsenSys/teku/commit/1af5520357cb4d660c9b64ad08e2b34b2de869b5", "message": "Apply spotless. Remove obsolete file", "committedDate": "2020-07-23T13:02:28Z", "type": "commit"}, {"oid": "e87006dfcea4a1402c2828226b98b3515819c550", "url": "https://github.com/ConsenSys/teku/commit/e87006dfcea4a1402c2828226b98b3515819c550", "message": "In case of fail fast when deserializing invalid signature bytes, just mark the signature invalid. This is to deal with empty signatures (valid from SSZ perspective)", "committedDate": "2020-07-23T13:46:54Z", "type": "commit"}, {"oid": "902ec5661b3e1dc21b8c683c9f73b2406ccac34a", "url": "https://github.com/ConsenSys/teku/commit/902ec5661b3e1dc21b8c683c9f73b2406ccac34a", "message": "Fix reference tests running on Windows", "committedDate": "2020-07-23T13:47:21Z", "type": "commit"}, {"oid": "47ca1c63a1c333d7077a2c2348b24e6bc39b7927", "url": "https://github.com/ConsenSys/teku/commit/47ca1c63a1c333d7077a2c2348b24e6bc39b7927", "message": "Merge remote-tracking branch 'pegasys/master' into feature-blst\n\n# Conflicts:\n#\tdata/provider/src/test/java/tech/pegasys/teku/api/ValidatorDataProviderTest.java", "committedDate": "2020-07-23T16:23:18Z", "type": "commit"}, {"oid": "b204b522cd06ad7cffc1149918bd248fadfd2b87", "url": "https://github.com/ConsenSys/teku/commit/b204b522cd06ad7cffc1149918bd248fadfd2b87", "message": "Add Mikuli fallback when couldn't load Blst", "committedDate": "2020-07-24T11:20:08Z", "type": "commit"}, {"oid": "569e742305281cbcbd710558c19a394f4febcf87", "url": "https://github.com/ConsenSys/teku/commit/569e742305281cbcbd710558c19a394f4febcf87", "message": "Apply spotless", "committedDate": "2020-07-24T13:12:49Z", "type": "commit"}, {"oid": "e6836672814adaa5a746a6e6f03fc93b6074499f", "url": "https://github.com/ConsenSys/teku/commit/e6836672814adaa5a746a6e6f03fc93b6074499f", "message": "Move SWIG wrapper to a separate project", "committedDate": "2020-07-24T15:10:20Z", "type": "commit"}, {"oid": "41e647a36e55bfd4bb30f71ae459be59ccfd86e3", "url": "https://github.com/ConsenSys/teku/commit/41e647a36e55bfd4bb30f71ae459be59ccfd86e3", "message": "Fix errorprone warns", "committedDate": "2020-07-24T15:21:37Z", "type": "commit"}, {"oid": "e08b756b416dfcb10e4c6696ca2c289b9b36641d", "url": "https://github.com/ConsenSys/teku/commit/e08b756b416dfcb10e4c6696ca2c289b9b36641d", "message": "Update license for jblst", "committedDate": "2020-07-24T15:41:02Z", "type": "commit"}, {"oid": "65f0f50a00cd7f1eedfeeb4a76c615d3579c2125", "url": "https://github.com/ConsenSys/teku/commit/65f0f50a00cd7f1eedfeeb4a76c615d3579c2125", "message": "Put the blst artifact version to versions.gradle", "committedDate": "2020-07-24T17:30:11Z", "type": "commit"}, {"oid": "acebccaa13bda6abebcd7e46a5d13b751db5475f", "url": "https://github.com/ConsenSys/teku/commit/acebccaa13bda6abebcd7e46a5d13b751db5475f", "message": "Implement BlstSecretKey.destroy()", "committedDate": "2020-07-27T11:05:43Z", "type": "commit"}, {"oid": "db88ac0d5287d9e1695fe0aa9288bdd300cda7ff", "url": "https://github.com/ConsenSys/teku/commit/db88ac0d5287d9e1695fe0aa9288bdd300cda7ff", "message": "Temporary handling infinite pubkey/signature as a special case until https://github.com/supranational/blst/issues/11 is resolved", "committedDate": "2020-07-27T16:42:11Z", "type": "commit"}, {"oid": "604766371e8ce45fe7e7550b6c2aed351454830e", "url": "https://github.com/ConsenSys/teku/commit/604766371e8ce45fe7e7550b6c2aed351454830e", "message": "Apply spotless", "committedDate": "2020-07-27T16:43:47Z", "type": "commit"}, {"oid": "831854839a5b2c13b9d0b22680a5645eb573100b", "url": "https://github.com/ConsenSys/teku/commit/831854839a5b2c13b9d0b22680a5645eb573100b", "message": "Resolve warnings", "committedDate": "2020-07-27T16:58:29Z", "type": "commit"}, {"oid": "1f9f68869f9b6795d1bb24b2c2ce1b8f7631e767", "url": "https://github.com/ConsenSys/teku/commit/1f9f68869f9b6795d1bb24b2c2ce1b8f7631e767", "message": "Merge remote-tracking branch 'pegasys/master' into feature-blst", "committedDate": "2020-07-27T17:11:52Z", "type": "commit"}, {"oid": "aae5ea078cf23afa6a3964a15d38877b9b267a63", "url": "https://github.com/ConsenSys/teku/commit/aae5ea078cf23afa6a3964a15d38877b9b267a63", "message": "Generate KeyPair from seed in an implementation independent way. Throw exception when instantiating SecretKey from non-valid BLS12381 scalar value", "committedDate": "2020-07-28T16:26:53Z", "type": "commit"}, {"oid": "193c8f512b3527b9f5618f202145fc360d08b94d", "url": "https://github.com/ConsenSys/teku/commit/193c8f512b3527b9f5618f202145fc360d08b94d", "message": "Fix tests", "committedDate": "2020-07-28T16:29:12Z", "type": "commit"}, {"oid": "90a35da5c5b2f789ded9e9aa37c4cc2ee30386f2", "url": "https://github.com/ConsenSys/teku/commit/90a35da5c5b2f789ded9e9aa37c4cc2ee30386f2", "message": "Apply spotless", "committedDate": "2020-07-28T16:30:32Z", "type": "commit"}, {"oid": "ce26e6aa3fd97997be658b9575c380aa37d7024c", "url": "https://github.com/ConsenSys/teku/commit/ce26e6aa3fd97997be658b9575c380aa37d7024c", "message": "Rename method to a more specific: aggregateSignatures()", "committedDate": "2020-07-28T16:32:56Z", "type": "commit"}, {"oid": "6c02825ee51aaaf3c81ca08ac835fc489c4680d0", "url": "https://github.com/ConsenSys/teku/commit/6c02825ee51aaaf3c81ca08ac835fc489c4680d0", "message": "Fix test compilation error", "committedDate": "2020-07-28T16:34:22Z", "type": "commit"}, {"oid": "8a2069c9b60ea7ebbab5adc0799ee4bfd26ac11f", "url": "https://github.com/ConsenSys/teku/commit/8a2069c9b60ea7ebbab5adc0799ee4bfd26ac11f", "message": "Apply spotless", "committedDate": "2020-07-28T16:35:59Z", "type": "commit"}, {"oid": "d82db16ea019fd63dbddb0a02927c0b3308a7a43", "url": "https://github.com/ConsenSys/teku/commit/d82db16ea019fd63dbddb0a02927c0b3308a7a43", "message": "Make BLSPublicKey.getPublicKey() package private", "committedDate": "2020-07-28T16:43:13Z", "type": "commit"}, {"oid": "1de2060ae0940d5ea71c08888943b094760ccdfb", "url": "https://github.com/ConsenSys/teku/commit/1de2060ae0940d5ea71c08888943b094760ccdfb", "message": "Allow empty list signatures aggregation", "committedDate": "2020-07-28T17:06:22Z", "type": "commit"}, {"oid": "16593568c8f8c98b122bdd9c97fe1a35f9c2339d", "url": "https://github.com/ConsenSys/teku/commit/16593568c8f8c98b122bdd9c97fe1a35f9c2339d", "message": "Disallow empty list signatures aggregation (revert prev commit)", "committedDate": "2020-07-28T17:19:48Z", "type": "commit"}, {"oid": "d0b27d478fb2eb9ea31313600529ca384f60784e", "url": "https://github.com/ConsenSys/teku/commit/d0b27d478fb2eb9ea31313600529ca384f60784e", "message": "Fix verify aggregated signature against multiple pubKey:message", "committedDate": "2020-07-28T19:20:57Z", "type": "commit"}, {"oid": "4978c2bdfd4b7a17f2de369cca137beca9550523", "url": "https://github.com/ConsenSys/teku/commit/4978c2bdfd4b7a17f2de369cca137beca9550523", "message": "Fix blst equal pubkeys aggregation", "committedDate": "2020-07-29T10:29:10Z", "type": "commit"}, {"oid": "ef1fa1c1624b3df9f8a28a847077b64eac297c64", "url": "https://github.com/ConsenSys/teku/commit/ef1fa1c1624b3df9f8a28a847077b64eac297c64", "message": "Make BLSSignature.getSignature() package private", "committedDate": "2020-07-29T10:41:28Z", "type": "commit"}, {"oid": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "url": "https://github.com/ConsenSys/teku/commit/fa8ec9862ed4dcda26ef467d981198c71be8c84d", "message": "Merge remote-tracking branch 'pegasys/master' into feature-blst", "committedDate": "2020-07-29T10:52:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3NjEyNw==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462676127", "bodyText": "Is there any risk that two keys with different bytes could wind up being the same G1 point when parsed (ie that two different byte representations could actually be the same key)?", "author": "ajsutton", "createdAt": "2020-07-30T01:11:31Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/BLSPublicKey.java", "diffHunk": "@@ -155,11 +167,11 @@ public boolean equals(Object obj) {\n     }\n \n     BLSPublicKey other = (BLSPublicKey) obj;\n-    return Objects.equals(this.getPublicKey(), other.getPublicKey());\n+    return Objects.equals(this.toBytesCompressed(), other.toBytesCompressed());", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NjIyMg==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462966222", "bodyText": "No, the compressed representation is unambiguous.", "author": "benjaminion", "createdAt": "2020-07-30T12:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3NjEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxMDQ4Ng==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463010486", "bodyText": "Thanks @benjaminion ! Was not 100% sure about this", "author": "Nashatyrev", "createdAt": "2020-07-30T13:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3NjEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3OTg1OA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462679858", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static BLS12381 BlsImpl;\n          \n          \n            \n              private static final BLS12381 blsImpl;\n          \n      \n    \n    \n  \n\nAlso see comment on MikuliBLS12381.INSTANCE.", "author": "ajsutton", "createdAt": "2020-07-30T01:25:48Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/BLS.java", "diffHunk": "@@ -43,7 +44,17 @@\n \n   private static final Logger LOG = LogManager.getLogger();\n \n-  private static BLS12381 BlsImpl = MikuliBLS12381.INSTANCE;\n+  private static BLS12381 BlsImpl;", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA1MTkxOA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463051918", "bodyText": "Good, made it final. Though I was going to make the implementation pluggable at runtime, but this would be another PR\n\nAlso see comment on MikuliBLS12381.INSTANCE\n\nDid you mean BlstBLS12381.INSTANCE ?", "author": "Nashatyrev", "createdAt": "2020-07-30T14:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3OTg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI4MTg0MA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463281840", "bodyText": "Yes I did sorry.  About being careful with loading the native lib as part of class initialisation.", "author": "ajsutton", "createdAt": "2020-07-30T21:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3OTg1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY4MDg2NQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462680865", "bodyText": "This depends on class loading and initialisation behaviour which has been very unpredictable in the past (maybe the JVM spec has improved to make it more predictable now - not sure).  It may be worth making INSTANCE be an Optional that only has a value if the library was loaded successfully:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static BlstBLS12381 INSTANCE = new BlstBLS12381();\n          \n          \n            \n            \n          \n          \n            \n              private static final int BATCH_RANDOM_BYTES = 8;\n          \n          \n            \n            \n          \n          \n            \n              static {\n          \n          \n            \n                try {\n          \n          \n            \n                  NativeUtils.loadLibraryFromJar(\"/\" + System.mapLibraryName(\"jblst\"));\n          \n          \n            \n                } catch (IOException e) {\n          \n          \n            \n                  throw new RuntimeException(e);\n          \n          \n            \n                }\n          \n          \n            \n              }\n          \n          \n            \n              private static final Logger LOG = LogManager.getLogger();\n          \n          \n            \n              \n          \n          \n            \n              public static final Optional<BlstBLS12381> INSTANCE;\n          \n          \n            \n            \n          \n          \n            \n              private static final int BATCH_RANDOM_BYTES = 8;\n          \n          \n            \n            \n          \n          \n            \n              static {\n          \n          \n            \n                boolean libraryLoaded;\n          \n          \n            \n                try {\n          \n          \n            \n                  NativeUtils.loadLibraryFromJar(\"/\" + System.mapLibraryName(\"jblst\"));\n          \n          \n            \n                  libraryLoaded = true;\n          \n          \n            \n                  LOG.info(\"Successfully loaded native BLS library\");\n          \n          \n            \n                } catch (IOException e) {\n          \n          \n            \n                  LOG.warn(\"Couldn't load native BLS library: \" + e);\n          \n          \n            \n                  libraryLoaded = false;\n          \n          \n            \n                }\n          \n          \n            \n                INSTANCE = libraryLoaded ? Optional.of(new BlstBLS12381()) : Optional.empty();\n          \n          \n            \n              }", "author": "ajsutton", "createdAt": "2020-07-30T01:29:35Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/impl/blst/BlstBLS12381.java", "diffHunk": "@@ -0,0 +1,256 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.bls.impl.blst;\n+\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ThreadLocalRandom;\n+import java.util.stream.Collectors;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.bytes.Bytes48;\n+import tech.pegasys.teku.bls.BatchSemiAggregate;\n+import tech.pegasys.teku.bls.impl.BLS12381;\n+import tech.pegasys.teku.bls.impl.KeyPair;\n+import tech.pegasys.teku.bls.impl.PublicKey;\n+import tech.pegasys.teku.bls.impl.Signature;\n+import tech.pegasys.teku.bls.impl.blst.swig.BLST_ERROR;\n+import tech.pegasys.teku.bls.impl.blst.swig.blst;\n+import tech.pegasys.teku.bls.impl.blst.swig.p2;\n+import tech.pegasys.teku.bls.impl.blst.swig.p2_affine;\n+import tech.pegasys.teku.bls.impl.blst.swig.pairing;\n+\n+public class BlstBLS12381 implements BLS12381 {\n+\n+  public static BlstBLS12381 INSTANCE = new BlstBLS12381();\n+\n+  private static final int BATCH_RANDOM_BYTES = 8;\n+\n+  static {\n+    try {\n+      NativeUtils.loadLibraryFromJar(\"/\" + System.mapLibraryName(\"jblst\"));\n+    } catch (IOException e) {\n+      throw new RuntimeException(e);\n+    }\n+  }", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA1NDA5MQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463054091", "bodyText": "Yeah, you are right, probably throwing exception from static initializer is not the best choice. Initially I was assuming that this is a critical error, but now I think that it's pretty normal situation (e.g. on Raspberry PI or other platforms not supported by blst).\nSee d17224f fix", "author": "Nashatyrev", "createdAt": "2020-07-30T14:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY4MDg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY4Mzg2MA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462683860", "bodyText": "If it's at all possible to have the SWIG bindings make these classes Autocloseable that would be awesome.  In any case we should ensure they are deleted regardless of any potential exceptions or errors that occur so would have to use try/finally blocks.  It will get really ugly without Autocloseable.\nWe're also winding up with a native memory leak because the wrapped BlstSignature returned has a reference to p2SignatureAffine but no way to close it and delete that native object.  The finalize method isn't guaranteed to be called in any kind of timely manner so we can't really depend on it.\nIf we have to depend on automatic cleanup (which may well be the case for things like public keys and signatures that are used outside of the Blst specific code and currently expect to be fully on-heap), we should use java.lang.ref.Cleaner to do it which is the recommended instead of finalize.\nMaybe use AutoCloseable if possible for the local variables we need to release and then use Cleaner for the things that are actually returned from this class.", "author": "ajsutton", "createdAt": "2020-07-30T01:38:33Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/impl/blst/BlstBLS12381.java", "diffHunk": "@@ -0,0 +1,256 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.bls.impl.blst;\n+\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ThreadLocalRandom;\n+import java.util.stream.Collectors;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.bytes.Bytes48;\n+import tech.pegasys.teku.bls.BatchSemiAggregate;\n+import tech.pegasys.teku.bls.impl.BLS12381;\n+import tech.pegasys.teku.bls.impl.KeyPair;\n+import tech.pegasys.teku.bls.impl.PublicKey;\n+import tech.pegasys.teku.bls.impl.Signature;\n+import tech.pegasys.teku.bls.impl.blst.swig.BLST_ERROR;\n+import tech.pegasys.teku.bls.impl.blst.swig.blst;\n+import tech.pegasys.teku.bls.impl.blst.swig.p2;\n+import tech.pegasys.teku.bls.impl.blst.swig.p2_affine;\n+import tech.pegasys.teku.bls.impl.blst.swig.pairing;\n+\n+public class BlstBLS12381 implements BLS12381 {\n+\n+  public static BlstBLS12381 INSTANCE = new BlstBLS12381();\n+\n+  private static final int BATCH_RANDOM_BYTES = 8;\n+\n+  static {\n+    try {\n+      NativeUtils.loadLibraryFromJar(\"/\" + System.mapLibraryName(\"jblst\"));\n+    } catch (IOException e) {\n+      throw new RuntimeException(e);\n+    }\n+  }\n+\n+  private static Random getRND() {\n+    // Milagro RAND has some issues with generating 'small' random numbers\n+    // and is not thread safe\n+    // Using non-secure random due to the JDK Linux secure random issue:\n+    // https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6521844\n+    // A potential attack here has a very limited application and is not feasible\n+    // Thus using non-secure random doesn't significantly mitigate the security\n+    return ThreadLocalRandom.current();\n+  }\n+\n+  public static BlstSignature sign(BlstSecretKey secretKey, Bytes message) {\n+    p2 p2Signature = new p2();\n+    p2 hash = HashToCurve.hashToG2(message);\n+    blst.sign_pk_in_g1(p2Signature, hash, secretKey.getScalarVal());\n+    p2_affine p2SignatureAffine = new p2_affine();\n+    blst.p2_to_affine(p2SignatureAffine, p2Signature);\n+    p2Signature.delete();\n+    hash.delete();", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEwODY5OA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463108698", "bodyText": "I didn't find Autocloseable feature in SWIG unfortunately. Indeed that would look better.\nRevised places with temporary native wrapper instances and add try/catch/finally where appropriate: 913e484\nI'll add a general comment later on my thoughts regarding finalize and cleaning native structs", "author": "Nashatyrev", "createdAt": "2020-07-30T16:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY4Mzg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNjUyNQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462706525", "bodyText": "This comment is a little scary. Does it still apply?", "author": "ajsutton", "createdAt": "2020-07-30T03:03:51Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/impl/blst/BlstBLS12381.java", "diffHunk": "@@ -0,0 +1,256 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.bls.impl.blst;\n+\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ThreadLocalRandom;\n+import java.util.stream.Collectors;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.bytes.Bytes48;\n+import tech.pegasys.teku.bls.BatchSemiAggregate;\n+import tech.pegasys.teku.bls.impl.BLS12381;\n+import tech.pegasys.teku.bls.impl.KeyPair;\n+import tech.pegasys.teku.bls.impl.PublicKey;\n+import tech.pegasys.teku.bls.impl.Signature;\n+import tech.pegasys.teku.bls.impl.blst.swig.BLST_ERROR;\n+import tech.pegasys.teku.bls.impl.blst.swig.blst;\n+import tech.pegasys.teku.bls.impl.blst.swig.p2;\n+import tech.pegasys.teku.bls.impl.blst.swig.p2_affine;\n+import tech.pegasys.teku.bls.impl.blst.swig.pairing;\n+\n+public class BlstBLS12381 implements BLS12381 {\n+\n+  public static BlstBLS12381 INSTANCE = new BlstBLS12381();\n+\n+  private static final int BATCH_RANDOM_BYTES = 8;\n+\n+  static {\n+    try {\n+      NativeUtils.loadLibraryFromJar(\"/\" + System.mapLibraryName(\"jblst\"));\n+    } catch (IOException e) {\n+      throw new RuntimeException(e);\n+    }\n+  }\n+\n+  private static Random getRND() {\n+    // Milagro RAND has some issues with generating 'small' random numbers\n+    // and is not thread safe\n+    // Using non-secure random due to the JDK Linux secure random issue:\n+    // https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6521844\n+    // A potential attack here has a very limited application and is not feasible\n+    // Thus using non-secure random doesn't significantly mitigate the security\n+    return ThreadLocalRandom.current();\n+  }\n+\n+  public static BlstSignature sign(BlstSecretKey secretKey, Bytes message) {\n+    p2 p2Signature = new p2();\n+    p2 hash = HashToCurve.hashToG2(message);\n+    blst.sign_pk_in_g1(p2Signature, hash, secretKey.getScalarVal());\n+    p2_affine p2SignatureAffine = new p2_affine();\n+    blst.p2_to_affine(p2SignatureAffine, p2Signature);\n+    p2Signature.delete();\n+    hash.delete();\n+    return new BlstSignature(p2SignatureAffine, true);\n+  }\n+\n+  public static boolean verify(BlstPublicKey publicKey, Bytes message, BlstSignature signature) {\n+    if (publicKey.isInfinity() || signature.isInfinity()) {\n+      return publicKey.isInfinity() && signature.isInfinity();\n+    }\n+    BLST_ERROR res =\n+        blst.core_verify_pk_in_g1(\n+            publicKey.ecPoint,\n+            signature.ec2Point,\n+            1,\n+            message.toArrayUnsafe(),\n+            HashToCurve.ETH2_DST.toArrayUnsafe(),\n+            new byte[0]);\n+    return res == BLST_ERROR.BLST_SUCCESS;\n+  }\n+\n+  @Override\n+  public KeyPair generateKeyPair(Random random) {\n+    BlstSecretKey secretKey = BlstSecretKey.generateNew(random);\n+    return new KeyPair(secretKey);\n+  }\n+\n+  @Override\n+  public BlstPublicKey publicKeyFromCompressed(Bytes48 compressedPublicKeyBytes) {\n+    return BlstPublicKey.fromBytes(compressedPublicKeyBytes);\n+  }\n+\n+  @Override\n+  public BlstSignature signatureFromCompressed(Bytes compressedSignatureBytes) {\n+    return BlstSignature.fromBytes(compressedSignatureBytes);\n+  }\n+\n+  @Override\n+  public BlstSecretKey secretKeyFromBytes(Bytes32 secretKeyBytes) {\n+    return BlstSecretKey.fromBytes(secretKeyBytes);\n+  }\n+\n+  @Override\n+  public BlstPublicKey aggregatePublicKeys(List<? extends PublicKey> publicKeys) {\n+    return BlstPublicKey.aggregate(\n+        publicKeys.stream().map(k -> (BlstPublicKey) k).collect(Collectors.toList()));\n+  }\n+\n+  @Override\n+  public BlstSignature aggregateSignatures(List<? extends Signature> signatures) {\n+    return BlstSignature.aggregate(\n+        signatures.stream().map(s -> (BlstSignature) s).collect(Collectors.toList()));\n+  }\n+\n+  pairing blstPrepareVerifyAggregated(\n+      BlstPublicKey pubKey, Bytes message, pairing ctx, BlstSignature blstSignature) {\n+\n+    p2 g2Hash = HashToCurve.hashToG2(message);\n+    p2_affine p2Affine = new p2_affine();\n+    blst.p2_to_affine(p2Affine, g2Hash);\n+\n+    if (ctx == null) {\n+      ctx = new pairing();\n+      blst.pairing_init(ctx);\n+    }\n+\n+    try {\n+      BLST_ERROR ret =\n+          blst.pairing_aggregate_pk_in_g1(\n+              ctx,\n+              pubKey.ecPoint,\n+              blstSignature == null ? null : blstSignature.ec2Point,\n+              1,\n+              message.toArrayUnsafe(),\n+              HashToCurve.ETH2_DST.toArrayUnsafe(),\n+              null);\n+      if (ret != BLST_ERROR.BLST_SUCCESS) throw new IllegalArgumentException(\"Error: \" + ret);\n+    } catch (Exception e) {\n+      ctx.delete();\n+      throw e;\n+    } finally {\n+      g2Hash.delete();\n+      p2Affine.delete(); // not sure if its copied inside pairing_mul_n_aggregate_pk_in_g1", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5OTQxOA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462999418", "bodyText": "Right, removed it. Blst dev assured me that arguments are not referenced in pairing_context", "author": "Nashatyrev", "createdAt": "2020-07-30T13:34:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNjUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNzA0OQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462707049", "bodyText": "This is only called from within BlstSignature could it be moved to a private method there? Releasing a parameter is a little scary so would be nice if it could be inlined.", "author": "ajsutton", "createdAt": "2020-07-30T03:05:58Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/impl/blst/BlstBLS12381.java", "diffHunk": "@@ -0,0 +1,256 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.bls.impl.blst;\n+\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ThreadLocalRandom;\n+import java.util.stream.Collectors;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.bytes.Bytes48;\n+import tech.pegasys.teku.bls.BatchSemiAggregate;\n+import tech.pegasys.teku.bls.impl.BLS12381;\n+import tech.pegasys.teku.bls.impl.KeyPair;\n+import tech.pegasys.teku.bls.impl.PublicKey;\n+import tech.pegasys.teku.bls.impl.Signature;\n+import tech.pegasys.teku.bls.impl.blst.swig.BLST_ERROR;\n+import tech.pegasys.teku.bls.impl.blst.swig.blst;\n+import tech.pegasys.teku.bls.impl.blst.swig.p2;\n+import tech.pegasys.teku.bls.impl.blst.swig.p2_affine;\n+import tech.pegasys.teku.bls.impl.blst.swig.pairing;\n+\n+public class BlstBLS12381 implements BLS12381 {\n+\n+  public static BlstBLS12381 INSTANCE = new BlstBLS12381();\n+\n+  private static final int BATCH_RANDOM_BYTES = 8;\n+\n+  static {\n+    try {\n+      NativeUtils.loadLibraryFromJar(\"/\" + System.mapLibraryName(\"jblst\"));\n+    } catch (IOException e) {\n+      throw new RuntimeException(e);\n+    }\n+  }\n+\n+  private static Random getRND() {\n+    // Milagro RAND has some issues with generating 'small' random numbers\n+    // and is not thread safe\n+    // Using non-secure random due to the JDK Linux secure random issue:\n+    // https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6521844\n+    // A potential attack here has a very limited application and is not feasible\n+    // Thus using non-secure random doesn't significantly mitigate the security\n+    return ThreadLocalRandom.current();\n+  }\n+\n+  public static BlstSignature sign(BlstSecretKey secretKey, Bytes message) {\n+    p2 p2Signature = new p2();\n+    p2 hash = HashToCurve.hashToG2(message);\n+    blst.sign_pk_in_g1(p2Signature, hash, secretKey.getScalarVal());\n+    p2_affine p2SignatureAffine = new p2_affine();\n+    blst.p2_to_affine(p2SignatureAffine, p2Signature);\n+    p2Signature.delete();\n+    hash.delete();\n+    return new BlstSignature(p2SignatureAffine, true);\n+  }\n+\n+  public static boolean verify(BlstPublicKey publicKey, Bytes message, BlstSignature signature) {\n+    if (publicKey.isInfinity() || signature.isInfinity()) {\n+      return publicKey.isInfinity() && signature.isInfinity();\n+    }\n+    BLST_ERROR res =\n+        blst.core_verify_pk_in_g1(\n+            publicKey.ecPoint,\n+            signature.ec2Point,\n+            1,\n+            message.toArrayUnsafe(),\n+            HashToCurve.ETH2_DST.toArrayUnsafe(),\n+            new byte[0]);\n+    return res == BLST_ERROR.BLST_SUCCESS;\n+  }\n+\n+  @Override\n+  public KeyPair generateKeyPair(Random random) {\n+    BlstSecretKey secretKey = BlstSecretKey.generateNew(random);\n+    return new KeyPair(secretKey);\n+  }\n+\n+  @Override\n+  public BlstPublicKey publicKeyFromCompressed(Bytes48 compressedPublicKeyBytes) {\n+    return BlstPublicKey.fromBytes(compressedPublicKeyBytes);\n+  }\n+\n+  @Override\n+  public BlstSignature signatureFromCompressed(Bytes compressedSignatureBytes) {\n+    return BlstSignature.fromBytes(compressedSignatureBytes);\n+  }\n+\n+  @Override\n+  public BlstSecretKey secretKeyFromBytes(Bytes32 secretKeyBytes) {\n+    return BlstSecretKey.fromBytes(secretKeyBytes);\n+  }\n+\n+  @Override\n+  public BlstPublicKey aggregatePublicKeys(List<? extends PublicKey> publicKeys) {\n+    return BlstPublicKey.aggregate(\n+        publicKeys.stream().map(k -> (BlstPublicKey) k).collect(Collectors.toList()));\n+  }\n+\n+  @Override\n+  public BlstSignature aggregateSignatures(List<? extends Signature> signatures) {\n+    return BlstSignature.aggregate(\n+        signatures.stream().map(s -> (BlstSignature) s).collect(Collectors.toList()));\n+  }\n+\n+  pairing blstPrepareVerifyAggregated(\n+      BlstPublicKey pubKey, Bytes message, pairing ctx, BlstSignature blstSignature) {\n+\n+    p2 g2Hash = HashToCurve.hashToG2(message);\n+    p2_affine p2Affine = new p2_affine();\n+    blst.p2_to_affine(p2Affine, g2Hash);\n+\n+    if (ctx == null) {\n+      ctx = new pairing();\n+      blst.pairing_init(ctx);\n+    }\n+\n+    try {\n+      BLST_ERROR ret =\n+          blst.pairing_aggregate_pk_in_g1(\n+              ctx,\n+              pubKey.ecPoint,\n+              blstSignature == null ? null : blstSignature.ec2Point,\n+              1,\n+              message.toArrayUnsafe(),\n+              HashToCurve.ETH2_DST.toArrayUnsafe(),\n+              null);\n+      if (ret != BLST_ERROR.BLST_SUCCESS) throw new IllegalArgumentException(\"Error: \" + ret);\n+    } catch (Exception e) {\n+      ctx.delete();\n+      throw e;\n+    } finally {\n+      g2Hash.delete();\n+      p2Affine.delete(); // not sure if its copied inside pairing_mul_n_aggregate_pk_in_g1\n+    }\n+\n+    return ctx;\n+  }\n+\n+  boolean blstCompleteVerifyAggregated(pairing ctx) {\n+    try {\n+      blst.pairing_commit(ctx);\n+      return blst.pairing_finalverify(ctx, null) > 0;\n+    } finally {\n+      ctx.delete();\n+    }\n+  }", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwMTU0MA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463001540", "bodyText": "Right, makes sense \ud83d\udc4d", "author": "Nashatyrev", "createdAt": "2020-07-30T13:37:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNzA0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwOTI4MQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462709281", "bodyText": "Shouldn't this return anyInvalidDummy?  ie if we have an invalid BlstInfiniteSemiAggregate and a BlstFiniteSemiAggregate we'd return false so why return true if we don't have a finite aggregate?", "author": "ajsutton", "createdAt": "2020-07-30T03:14:39Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/impl/blst/BlstBLS12381.java", "diffHunk": "@@ -0,0 +1,256 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.bls.impl.blst;\n+\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ThreadLocalRandom;\n+import java.util.stream.Collectors;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.bytes.Bytes48;\n+import tech.pegasys.teku.bls.BatchSemiAggregate;\n+import tech.pegasys.teku.bls.impl.BLS12381;\n+import tech.pegasys.teku.bls.impl.KeyPair;\n+import tech.pegasys.teku.bls.impl.PublicKey;\n+import tech.pegasys.teku.bls.impl.Signature;\n+import tech.pegasys.teku.bls.impl.blst.swig.BLST_ERROR;\n+import tech.pegasys.teku.bls.impl.blst.swig.blst;\n+import tech.pegasys.teku.bls.impl.blst.swig.p2;\n+import tech.pegasys.teku.bls.impl.blst.swig.p2_affine;\n+import tech.pegasys.teku.bls.impl.blst.swig.pairing;\n+\n+public class BlstBLS12381 implements BLS12381 {\n+\n+  public static BlstBLS12381 INSTANCE = new BlstBLS12381();\n+\n+  private static final int BATCH_RANDOM_BYTES = 8;\n+\n+  static {\n+    try {\n+      NativeUtils.loadLibraryFromJar(\"/\" + System.mapLibraryName(\"jblst\"));\n+    } catch (IOException e) {\n+      throw new RuntimeException(e);\n+    }\n+  }\n+\n+  private static Random getRND() {\n+    // Milagro RAND has some issues with generating 'small' random numbers\n+    // and is not thread safe\n+    // Using non-secure random due to the JDK Linux secure random issue:\n+    // https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6521844\n+    // A potential attack here has a very limited application and is not feasible\n+    // Thus using non-secure random doesn't significantly mitigate the security\n+    return ThreadLocalRandom.current();\n+  }\n+\n+  public static BlstSignature sign(BlstSecretKey secretKey, Bytes message) {\n+    p2 p2Signature = new p2();\n+    p2 hash = HashToCurve.hashToG2(message);\n+    blst.sign_pk_in_g1(p2Signature, hash, secretKey.getScalarVal());\n+    p2_affine p2SignatureAffine = new p2_affine();\n+    blst.p2_to_affine(p2SignatureAffine, p2Signature);\n+    p2Signature.delete();\n+    hash.delete();\n+    return new BlstSignature(p2SignatureAffine, true);\n+  }\n+\n+  public static boolean verify(BlstPublicKey publicKey, Bytes message, BlstSignature signature) {\n+    if (publicKey.isInfinity() || signature.isInfinity()) {\n+      return publicKey.isInfinity() && signature.isInfinity();\n+    }\n+    BLST_ERROR res =\n+        blst.core_verify_pk_in_g1(\n+            publicKey.ecPoint,\n+            signature.ec2Point,\n+            1,\n+            message.toArrayUnsafe(),\n+            HashToCurve.ETH2_DST.toArrayUnsafe(),\n+            new byte[0]);\n+    return res == BLST_ERROR.BLST_SUCCESS;\n+  }\n+\n+  @Override\n+  public KeyPair generateKeyPair(Random random) {\n+    BlstSecretKey secretKey = BlstSecretKey.generateNew(random);\n+    return new KeyPair(secretKey);\n+  }\n+\n+  @Override\n+  public BlstPublicKey publicKeyFromCompressed(Bytes48 compressedPublicKeyBytes) {\n+    return BlstPublicKey.fromBytes(compressedPublicKeyBytes);\n+  }\n+\n+  @Override\n+  public BlstSignature signatureFromCompressed(Bytes compressedSignatureBytes) {\n+    return BlstSignature.fromBytes(compressedSignatureBytes);\n+  }\n+\n+  @Override\n+  public BlstSecretKey secretKeyFromBytes(Bytes32 secretKeyBytes) {\n+    return BlstSecretKey.fromBytes(secretKeyBytes);\n+  }\n+\n+  @Override\n+  public BlstPublicKey aggregatePublicKeys(List<? extends PublicKey> publicKeys) {\n+    return BlstPublicKey.aggregate(\n+        publicKeys.stream().map(k -> (BlstPublicKey) k).collect(Collectors.toList()));\n+  }\n+\n+  @Override\n+  public BlstSignature aggregateSignatures(List<? extends Signature> signatures) {\n+    return BlstSignature.aggregate(\n+        signatures.stream().map(s -> (BlstSignature) s).collect(Collectors.toList()));\n+  }\n+\n+  pairing blstPrepareVerifyAggregated(\n+      BlstPublicKey pubKey, Bytes message, pairing ctx, BlstSignature blstSignature) {\n+\n+    p2 g2Hash = HashToCurve.hashToG2(message);\n+    p2_affine p2Affine = new p2_affine();\n+    blst.p2_to_affine(p2Affine, g2Hash);\n+\n+    if (ctx == null) {\n+      ctx = new pairing();\n+      blst.pairing_init(ctx);\n+    }\n+\n+    try {\n+      BLST_ERROR ret =\n+          blst.pairing_aggregate_pk_in_g1(\n+              ctx,\n+              pubKey.ecPoint,\n+              blstSignature == null ? null : blstSignature.ec2Point,\n+              1,\n+              message.toArrayUnsafe(),\n+              HashToCurve.ETH2_DST.toArrayUnsafe(),\n+              null);\n+      if (ret != BLST_ERROR.BLST_SUCCESS) throw new IllegalArgumentException(\"Error: \" + ret);\n+    } catch (Exception e) {\n+      ctx.delete();\n+      throw e;\n+    } finally {\n+      g2Hash.delete();\n+      p2Affine.delete(); // not sure if its copied inside pairing_mul_n_aggregate_pk_in_g1\n+    }\n+\n+    return ctx;\n+  }\n+\n+  boolean blstCompleteVerifyAggregated(pairing ctx) {\n+    try {\n+      blst.pairing_commit(ctx);\n+      return blst.pairing_finalverify(ctx, null) > 0;\n+    } finally {\n+      ctx.delete();\n+    }\n+  }\n+\n+  @Override\n+  public BatchSemiAggregate prepareBatchVerify(\n+      int index, List<? extends PublicKey> publicKeys, Bytes message, Signature signature) {\n+\n+    BlstPublicKey aggrPubKey = aggregatePublicKeys(publicKeys);\n+    BlstSignature blstSignature = (BlstSignature) signature;\n+    if (aggrPubKey.isInfinity() || blstSignature.isInfinity()) {\n+      return new BlstInfiniteSemiAggregate(aggrPubKey.isInfinity() && blstSignature.isInfinity());\n+    }\n+    return blstPrepareBatchVerify(aggrPubKey, message, blstSignature);\n+  }\n+\n+  BatchSemiAggregate blstPrepareBatchVerify(\n+      BlstPublicKey pubKey, Bytes message, BlstSignature blstSignature) {\n+\n+    p2 g2Hash = HashToCurve.hashToG2(message);\n+    p2_affine p2Affine = new p2_affine();\n+    blst.p2_to_affine(p2Affine, g2Hash);\n+\n+    pairing ctx = new pairing();\n+    try {\n+      blst.pairing_init(ctx);\n+      BLST_ERROR ret =\n+          blst.pairing_mul_n_aggregate_pk_in_g1(\n+              ctx,\n+              pubKey.ecPoint,\n+              blstSignature.ec2Point,\n+              p2Affine,\n+              nextBatchRandomMultiplier(),\n+              BATCH_RANDOM_BYTES * 8);\n+      if (ret != BLST_ERROR.BLST_SUCCESS) throw new IllegalArgumentException(\"Error: \" + ret);\n+    } catch (Exception e) {\n+      ctx.delete();\n+      throw e;\n+    } finally {\n+      g2Hash.delete();\n+      p2Affine.delete(); // not sure if its copied inside pairing_mul_n_aggregate_pk_in_g1\n+    }\n+    blst.pairing_commit(ctx);\n+\n+    return new BlstFiniteSemiAggregate(ctx);\n+  }\n+\n+  @Override\n+  public BatchSemiAggregate prepareBatchVerify2(\n+      int index,\n+      List<? extends PublicKey> publicKeys1,\n+      Bytes message1,\n+      Signature signature1,\n+      List<? extends PublicKey> publicKeys2,\n+      Bytes message2,\n+      Signature signature2) {\n+    BatchSemiAggregate aggregate1 = prepareBatchVerify(index, publicKeys1, message1, signature1);\n+    BatchSemiAggregate aggregate2 =\n+        prepareBatchVerify(index + 1, publicKeys2, message2, signature2);\n+\n+    return BlstFiniteSemiAggregate.merge(aggregate1, aggregate2);\n+  }\n+\n+  @Override\n+  public boolean completeBatchVerify(List<? extends BatchSemiAggregate> preparedList) {\n+    boolean anyInvalidDummy =\n+        preparedList.stream()\n+            .filter(a -> a instanceof BlstInfiniteSemiAggregate)\n+            .map(a -> (BlstInfiniteSemiAggregate) a)\n+            .anyMatch(a -> !a.isValid());\n+\n+    List<BlstFiniteSemiAggregate> blstList =\n+        preparedList.stream()\n+            .filter(a -> a instanceof BlstFiniteSemiAggregate)\n+            .map(b -> (BlstFiniteSemiAggregate) b)\n+            .collect(Collectors.toList());\n+\n+    if (blstList.isEmpty()) {\n+      return true;", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwODgwOQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463008809", "bodyText": "Thanks good catch! Fixed that way: 7447b6f", "author": "Nashatyrev", "createdAt": "2020-07-30T13:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwOTI4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxMDc0MQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462710741", "bodyText": "Slightly surprised that if you aggregate a mix of finite and infinite keys you get a finite key back and the infinite keys are essentially just ignored.", "author": "ajsutton", "createdAt": "2020-07-30T03:20:29Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/impl/blst/BlstPublicKey.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.bls.impl.blst;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes48;\n+import tech.pegasys.teku.bls.impl.PublicKey;\n+import tech.pegasys.teku.bls.impl.blst.swig.BLST_ERROR;\n+import tech.pegasys.teku.bls.impl.blst.swig.blst;\n+import tech.pegasys.teku.bls.impl.blst.swig.p1;\n+import tech.pegasys.teku.bls.impl.blst.swig.p1_affine;\n+\n+public class BlstPublicKey implements PublicKey {\n+  private static final int COMPRESSED_PK_SIZE = 48;\n+  private static final int UNCOMPRESSED_PK_LENGTH = 96;\n+\n+  static final Bytes48 INFINITY_COMPRESSED_BYTES =\n+      Bytes48.fromHexString(\n+          \"0x\"\n+              + \"c0000000000000000000000000000000\"\n+              + \"00000000000000000000000000000000\"\n+              + \"00000000000000000000000000000000\");\n+\n+  static final BlstPublicKey INFINITY =\n+      new BlstPublicKey(null) {\n+        @Override\n+        public void forceValidation() {}\n+\n+        @Override\n+        public Bytes48 toBytesCompressed() {\n+          return INFINITY_COMPRESSED_BYTES;\n+        }\n+\n+        @Override\n+        public Bytes toBytesUncompressed() {\n+          throw new UnsupportedOperationException();\n+        }\n+      };\n+\n+  public static BlstPublicKey fromBytesUncompressed(Bytes uncompressed) {\n+    checkArgument(uncompressed.size() == UNCOMPRESSED_PK_LENGTH);\n+    p1_affine ecPoint = new p1_affine();\n+    if (blst.p1_deserialize(ecPoint, uncompressed.toArrayUnsafe()) == BLST_ERROR.BLST_SUCCESS) {\n+      return new BlstPublicKey(ecPoint);\n+    } else {\n+      ecPoint.delete();\n+      throw new IllegalArgumentException(\"Invalid PublicKey bytes: \" + uncompressed);\n+    }\n+  }\n+\n+  public static BlstPublicKey fromBytes(Bytes48 compressed) {\n+    if (compressed.equals(INFINITY_COMPRESSED_BYTES)) {\n+      return INFINITY;\n+    }\n+    p1_affine ecPoint = new p1_affine();\n+    if (blst.p1_uncompress(ecPoint, compressed.toArrayUnsafe()) == BLST_ERROR.BLST_SUCCESS) {\n+      return new BlstPublicKey(ecPoint);\n+    } else {\n+      ecPoint.delete();\n+      throw new IllegalArgumentException(\"Invalid PublicKey bytes: \" + compressed);\n+    }\n+  }\n+\n+  public static BlstPublicKey aggregate(List<BlstPublicKey> publicKeys) {\n+    checkArgument(publicKeys.size() > 0);\n+\n+    List<BlstPublicKey> finitePublicKeys =\n+        publicKeys.stream().filter(pk -> !pk.isInfinity()).collect(Collectors.toList());\n+    if (finitePublicKeys.isEmpty()) {\n+      return BlstPublicKey.INFINITY;\n+    }\n+\n+    p1 sum = new p1();\n+    blst.p1_from_affine(sum, finitePublicKeys.get(0).ecPoint);\n+    for (int i = 1; i < finitePublicKeys.size(); i++) {\n+      blst.p1_add_or_double_affine(sum, sum, finitePublicKeys.get(i).ecPoint);\n+    }\n+    p1_affine res = new p1_affine();\n+    blst.p1_to_affine(res, sum);\n+    sum.delete();\n+\n+    return new BlstPublicKey(res);\n+  }", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjczODMyOQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462738329", "bodyText": "In elliptic curve arithmetic, the \"point at infinity\" is the identity. It's weird terminology, but adding the point at infinity is like adding zero to a number, or multiplying by one, so you can safely skip it.", "author": "benjaminion", "createdAt": "2020-07-30T05:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxMDc0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNTk3MA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462715970", "bodyText": "We seem to have lost tests that confirm we can load a BLSPublicKey with an invalid point and safely compare them.  We need to ensure that deposits with invalid public keys can still be processed correctly when included in blocks (which depends on creating BLSPublicKey instances for invalid points and calling equals and hashCode.", "author": "ajsutton", "createdAt": "2020-07-30T03:41:14Z", "path": "bls/src/test/java/tech/pegasys/teku/bls/BLSPublicKeyTest.java", "diffHunk": "@@ -50,44 +54,29 @@ void succeedsWhenEqualsReturnsTrueForTheSameEmptyPublicKey() {\n   @Test\n   void succeedsWhenTwoInfinityPublicKeysAreEqual() {\n     // Infinity keys are valid G1 points, so pass the equality test\n-    BLSPublicKey publicKey1 = BLSPublicKey.fromBytes(InfinityPublicKey);\n-    BLSPublicKey publicKey2 = BLSPublicKey.fromBytes(InfinityPublicKey);\n+    BLSPublicKey publicKey1 = BLSPublicKey.fromSSZBytes(InfinityPublicKey);\n+    BLSPublicKey publicKey2 = BLSPublicKey.fromSSZBytes(InfinityPublicKey);\n     assertEquals(publicKey1, publicKey2);\n   }\n \n   @Test\n-  void succeedsWhenInvalidPublicKeyIsInvalid() {\n-    BLSPublicKey invalidPublicKey =\n-        BLSPublicKey.fromBytesCompressed(\n-            Bytes.fromHexString(\n-                \"0x9378a6e3984e96d2cd50450c76ca14732f1300efa04aecdb805b22e6d6926a85ef409e8f3acf494a1481090bf32ce3bd\"));\n-    assertFalse(invalidPublicKey.isValid());\n-  }\n-\n-  @Test\n-  void succeedsWhenComparingInvalidAndValidPublicKeyFails() {", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxNjU3OA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463016578", "bodyText": "Right, thanks for catching this \ud83d\udc4d\nReviewed a couple of times for lost tests but still missed this one", "author": "Nashatyrev", "createdAt": "2020-07-30T13:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNTk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyMDc0NQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462720745", "bodyText": "Why disabled?", "author": "ajsutton", "createdAt": "2020-07-30T04:01:11Z", "path": "bls/src/test/java/tech/pegasys/teku/bls/impl/blst/BlstPublicKeyTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.bls.impl.blst;\n+\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes48;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Test;\n+\n+public class BlstPublicKeyTest {\n+\n+  @BeforeAll\n+  static void setup() {\n+    BlstBLS12381.INSTANCE.hashCode();\n+  }\n+\n+  @Disabled", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxODcwMw==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463018703", "bodyText": "Left comment there:\n  // Blst library doesn't handle infinity pubkeys at the moment.\n  // Could enable the test when the issue https://github.com/supranational/blst/issues/11 is\n  // addressed", "author": "Nashatyrev", "createdAt": "2020-07-30T14:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyMDc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyMTA1NQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462721055", "bodyText": "Probably shouldn't have a System.out.println here and should assert something instead?", "author": "ajsutton", "createdAt": "2020-07-30T04:02:21Z", "path": "bls/src/test/java/tech/pegasys/teku/bls/impl/mikuli/MikuliPublicKeyTest.java", "diffHunk": "@@ -47,22 +47,36 @@ void succeedsWhenTwoInfinityPublicKeysAreEqual() {\n \n   @Test\n   void succeedsIfDeserializationOfInfinityPublicKeyIsCorrect() {\n-    BLSPublicKey infinityPublicKey = new BLSPublicKey(new MikuliPublicKey(new G1Point()));\n+    MikuliPublicKey infinityPublicKey = new MikuliPublicKey(new G1Point());\n     byte[] pointBytes = new byte[48];\n     pointBytes[0] = (byte) 0xc0;\n     Bytes infinityBytesSsz =\n         SSZ.encode(\n             writer -> {\n               writer.writeFixedBytes(Bytes.wrap(pointBytes));\n             });\n-    BLSPublicKey deserializedPublicKey = BLSPublicKey.fromBytes(infinityBytesSsz);\n+    MikuliPublicKey deserializedPublicKey = MikuliPublicKey.fromBytesCompressed(infinityBytesSsz);\n     assertEquals(infinityPublicKey, deserializedPublicKey);\n   }\n \n   @Test\n   void succeedsWhenRoundtripSSZReturnsTheInfinityPublicKey() {\n-    BLSPublicKey publicKey1 = new BLSPublicKey(new MikuliPublicKey(new G1Point()));\n-    BLSPublicKey publicKey2 = BLSPublicKey.fromBytes(publicKey1.toBytes());\n+    MikuliPublicKey publicKey1 = new MikuliPublicKey(new G1Point());\n+    MikuliPublicKey publicKey2 =\n+        MikuliPublicKey.fromBytesCompressed(publicKey1.toBytesCompressed());\n     assertEquals(publicKey1, publicKey2);\n   }\n+\n+  @Test\n+  void infinityPublicKeyIsValid() {\n+    MikuliPublicKey infinityG1 =\n+        MikuliPublicKey.fromBytesCompressed(\n+            Bytes48.fromHexString(\n+                \"0x\"\n+                    + \"c0000000000000000000000000000000\"\n+                    + \"00000000000000000000000000000000\"\n+                    + \"00000000000000000000000000000000\"));\n+    infinityG1.forceValidation();\n+    System.out.println(infinityG1.g1Point());", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2MjI5MA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462962290", "bodyText": "As per the code comment higher up the file, my intention was that this BLS class follows the standard as closely as possible. There is no function similar to aggregatePublicKeys in the standard, and it seems only to be used in testing, so suggest moving it to a test class.", "author": "benjaminion", "createdAt": "2020-07-30T12:32:42Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/BLS.java", "diffHunk": "@@ -80,6 +91,13 @@ public static boolean verify(BLSPublicKey publicKey, Bytes message, BLSSignature\n     return signature.getSignature().verify(publicKey.getPublicKey(), message);\n   }\n \n+  public static BLSPublicKey aggregatePublicKeys(List<BLSPublicKey> publicKeys) {\n+    return new BLSPublicKey(\n+        getBlsImpl()\n+            .aggregatePublicKeys(\n+                publicKeys.stream().map(BLSPublicKey::getPublicKey).collect(Collectors.toList())));\n+  }\n+", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA1NzcwMA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463057700", "bodyText": "Honestly speaking I would love to leave aggregatePublicKeys public assuming that our bls module can potentially be used by other projects. What do think of making this method static PublicKey.aggregate() and then I could rollback aggregateSignatures name", "author": "Nashatyrev", "createdAt": "2020-07-30T14:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2MjI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEwODY2OQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463108669", "bodyText": "Well... imo other projects should be encouraged to follow the BLS standard, in which case they don't need aggregatePublicKeys (except maybe for testing).  Your proposal is fine, though.", "author": "benjaminion", "createdAt": "2020-07-30T16:08:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2MjI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1ODkzOA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463158938", "bodyText": "Just though of one possible use case: if a hypothetical 'BLSCoin' has public keys == addresses there could be multisig addresses created by signers addresses aggregation :)", "author": "Nashatyrev", "createdAt": "2020-07-30T17:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2MjI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE2ODY0NQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463168645", "bodyText": "Done: b60a046", "author": "Nashatyrev", "createdAt": "2020-07-30T17:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2MjI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2MzIwOQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462963209", "bodyText": "As per my comment on aggregatePublicKeys - if that is moved elsewhere, then this can be reverted to the same name it has in the standard (i.e. aggregate() - modulo a captial letter).", "author": "benjaminion", "createdAt": "2020-07-30T12:34:27Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/BLS.java", "diffHunk": "@@ -91,8 +109,10 @@ public static boolean verify(BLSPublicKey publicKey, Bytes message, BLSSignature\n    *\n    * @param signatures the list of signatures to be aggregated\n    * @return the aggregated signature\n+   * @throws IllegalArgumentException if any of supplied signatures is invalid\n    */\n-  public static BLSSignature aggregate(List<BLSSignature> signatures) {\n+  public static BLSSignature aggregateSignatures(List<BLSSignature> signatures)", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA1ODAwMA==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463058000", "bodyText": "Commented on aggregatePublicKeys", "author": "Nashatyrev", "createdAt": "2020-07-30T14:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2MzIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2OTcwOQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462969709", "bodyText": "We should probably have a constants class that contains things like this, and BLS_PUBKEY_SIZE, BLS_SIGNATURE_SIZE and other magic numbers. Mikuli extracts them from a Milagro constants class.\nThe point is that the mechanics of BLS signing are actually somewhat independent of the underlying curve, and it would be cleaner not to let details of the curve leak up to this level. But not a big deal.", "author": "benjaminion", "createdAt": "2020-07-30T12:46:10Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/BLSSecretKey.java", "diffHunk": "@@ -13,15 +13,46 @@\n \n package tech.pegasys.teku.bls;\n \n+import java.math.BigInteger;\n+import java.nio.ByteOrder;\n import java.util.Objects;\n import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.bytes.Bytes32;\n import tech.pegasys.teku.bls.impl.SecretKey;\n \n public final class BLSSecretKey {\n \n-  public static BLSSecretKey fromBytes(Bytes32 bytes) {\n-    return new BLSSecretKey(BLS.getBlsImpl().secretKeyFromBytes(bytes));\n+  private static final Bytes32 CURVE_ORDER =\n+      Bytes32.fromHexString(\"0x73eda753299d7d483339d80809a1d80553bda402fffe5bfeffffffff00000001\");", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4ODIxOQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463088219", "bodyText": "I moved BLS constants to the BLSConstants class, though left SSZ related constants in their corresponding classes.\nI also made a clear distinction between SSZ and Compressed bytes for BLSPublicKey & BLSSignature through they are equivalent with the current SSZ implementation\nCommits: 25fb802 and 5dca043\nDoes this make sense?", "author": "Nashatyrev", "createdAt": "2020-07-30T15:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2OTcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExMTU4MQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463111581", "bodyText": "\ud83d\udc4d", "author": "benjaminion", "createdAt": "2020-07-30T16:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2OTcwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3MTI3NQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r462971275", "bodyText": "Oops, magic number. My fault. See comment about having a Constants class.", "author": "benjaminion", "createdAt": "2020-07-30T12:48:52Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/BLSSecretKey.java", "diffHunk": "@@ -35,10 +66,14 @@ public BLSSecretKey(SecretKey secretKey) {\n     this.secretKey = secretKey;\n   }\n \n-  public SecretKey getSecretKey() {\n+  SecretKey getSecretKey() {\n     return secretKey;\n   }\n \n+  public BLSPublicKey toPublicKey() {\n+    return new BLSPublicKey(getSecretKey().derivePublicKey());\n+  }\n+\n   public Bytes toBytes() {\n     final Bytes bytes = secretKey.toBytes();\n     if (bytes.size() == 48) {", "originalCommit": "fa8ec9862ed4dcda26ef467d981198c71be8c84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4ODU5MQ==", "url": "https://github.com/ConsenSys/teku/pull/2453#discussion_r463088591", "bodyText": "Not relevant now", "author": "Nashatyrev", "createdAt": "2020-07-30T15:38:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3MTI3NQ=="}], "type": "inlineReview"}, {"oid": "f9577a005b334f9ab06960c92399a501a176c31c", "url": "https://github.com/ConsenSys/teku/commit/f9577a005b334f9ab06960c92399a501a176c31c", "message": "Remove obsolete comment", "committedDate": "2020-07-30T13:33:04Z", "type": "commit"}, {"oid": "0c248d95a202846329b92d251d9b3a0fc16632bb", "url": "https://github.com/ConsenSys/teku/commit/0c248d95a202846329b92d251d9b3a0fc16632bb", "message": "Moved BlstSignature specific methods from BlstBLS12381 to BlstSignature and make them private", "committedDate": "2020-07-30T13:37:01Z", "type": "commit"}, {"oid": "7447b6f1ca5a8e7787cf3d902b5f216e71fd25f8", "url": "https://github.com/ConsenSys/teku/commit/7447b6f1ca5a8e7787cf3d902b5f216e71fd25f8", "message": "Fix batch verify case with invalid infinity signature", "committedDate": "2020-07-30T13:45:42Z", "type": "commit"}, {"oid": "fd219cca3d0492c16482680f63bb42308eb1e46f", "url": "https://github.com/ConsenSys/teku/commit/fd219cca3d0492c16482680f63bb42308eb1e46f", "message": "Add lost test case", "committedDate": "2020-07-30T13:57:29Z", "type": "commit"}, {"oid": "654e2fa78b9bd4427921e9a31322123acafa5c8f", "url": "https://github.com/ConsenSys/teku/commit/654e2fa78b9bd4427921e9a31322123acafa5c8f", "message": "Left comment for disabled test", "committedDate": "2020-07-30T14:01:08Z", "type": "commit"}, {"oid": "ea927969e7ce5ec216f56f61dc46f5aa0f313b6d", "url": "https://github.com/ConsenSys/teku/commit/ea927969e7ce5ec216f56f61dc46f5aa0f313b6d", "message": "Add explicit assertion to the test", "committedDate": "2020-07-30T14:03:32Z", "type": "commit"}, {"oid": "d903419b01966e5aa2150f974fd3a6ffff9c8527", "url": "https://github.com/ConsenSys/teku/commit/d903419b01966e5aa2150f974fd3a6ffff9c8527", "message": "Apply spotless", "committedDate": "2020-07-30T14:07:37Z", "type": "commit"}, {"oid": "d17224f236916a9d20a0e98d19308cfbf97fd9f2", "url": "https://github.com/ConsenSys/teku/commit/d17224f236916a9d20a0e98d19308cfbf97fd9f2", "message": "Make BlstBLS12381.INSTANCE initialization more reliable and make it as Optional", "committedDate": "2020-07-30T14:44:55Z", "type": "commit"}, {"oid": "25fb8026d8ef4c3d5fe134d2405cd98f577934c5", "url": "https://github.com/ConsenSys/teku/commit/25fb8026d8ef4c3d5fe134d2405cd98f577934c5", "message": "Move BLS constants to BLSConstants class. Make a clear separation of BLSPublicKey fromSSZBytes() and fromBytesCompressed() though they are equivalent with current SSZ implementation", "committedDate": "2020-07-30T15:22:41Z", "type": "commit"}]}