{"pr_number": 2427, "pr_title": "Remote validator service", "pr_createdAt": "2020-07-23T05:01:40Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2427", "timeline": [{"oid": "01922a438c3261777a4b256752d0d50d31abad7f", "url": "https://github.com/ConsenSys/teku/commit/01922a438c3261777a4b256752d0d50d31abad7f", "message": "Adding Remote Validator API CLI options\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-23T04:53:19Z", "type": "commit"}, {"oid": "545311e3cb307651944db4909cd55ab597929acd", "url": "https://github.com/ConsenSys/teku/commit/545311e3cb307651944db4909cd55ab597929acd", "message": "Created Remote Validator service\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-23T04:53:19Z", "type": "commit"}, {"oid": "277708399101b423810d3b3bfbb0e5bd902b41c5", "url": "https://github.com/ConsenSys/teku/commit/277708399101b423810d3b3bfbb0e5bd902b41c5", "message": "Hiding CLI options not in use\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-23T05:07:47Z", "type": "commit"}, {"oid": "c8d696820a49948f27df49b70866510400ffa80b", "url": "https://github.com/ConsenSys/teku/commit/c8d696820a49948f27df49b70866510400ffa80b", "message": "Fix max connected validators\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-23T09:00:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1OTIwMA==", "url": "https://github.com/ConsenSys/teku/pull/2427#discussion_r459759200", "bodyText": "We have a JsonProvider class that would be good to use here instead of creating a new Gson every time.", "author": "ajsutton", "createdAt": "2020-07-23T22:17:58Z", "path": "services/remote-validator/src/main/java/tech/pegasys/teku/services/remotevalidator/BeaconChainEvent.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.services.remotevalidator;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import com.google.gson.Gson;\n+\n+public class BeaconChainEvent {\n+\n+  public static final String ATTESTATION = \"BroadcastAttestationEvent\";\n+  public static final String AGGREGATION = \"BroadcastAggregatesEvent\";\n+  public static final String IMPORTED_BLOCK = \"ImportedBlockEvent\";\n+  public static final String ON_SLOT = \"OnSlotEvent\";\n+  public static final String REORG_OCCURRED = \"ReorgOccurredEvent\";\n+\n+  private String name;\n+  private UnsignedLong data;\n+\n+  public BeaconChainEvent(final String name, final UnsignedLong data) {\n+    this.name = name;\n+    this.data = data;\n+  }\n+\n+  public BeaconChainEvent() {}\n+\n+  public String getName() {\n+    return name;\n+  }\n+\n+  public void setName(final String name) {\n+    this.name = name;\n+  }\n+\n+  public UnsignedLong getData() {\n+    return data;\n+  }\n+\n+  public void setData(final UnsignedLong data) {\n+    this.data = data;\n+  }\n+\n+  public String toJson() {\n+    return new Gson().toJson(this);", "originalCommit": "c8d696820a49948f27df49b70866510400ffa80b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MTUyNQ==", "url": "https://github.com/ConsenSys/teku/pull/2427#discussion_r459771525", "bodyText": "ah, so this is why we'll wind up merging this into the beacon chain instead of being its own service.  It should be using the same port as the rest of the REST API.  But we may as well delay that until we have a clear direction on what to use for delivering these events.", "author": "ajsutton", "createdAt": "2020-07-23T22:53:11Z", "path": "services/remote-validator/src/main/java/tech/pegasys/teku/services/remotevalidator/RemoteValidatorApi.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.services.remotevalidator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import io.javalin.Javalin;\n+import io.javalin.websocket.WsConnectContext;\n+import io.javalin.websocket.WsContext;\n+import java.io.IOException;\n+import java.util.Objects;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.TekuConfiguration;\n+\n+public class RemoteValidatorApi {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final RemoteValidatorSubscriptions subscriptionManager;\n+  private final Javalin app;\n+\n+  public RemoteValidatorApi(\n+      final TekuConfiguration configuration,\n+      final RemoteValidatorSubscriptions subscriptionManager) {\n+    checkNotNull(configuration, \"TekuConfiguration can't be null\");\n+    checkNotNull(subscriptionManager, \"RemoteValidatorSubscriptions can't be null\");\n+\n+    this.subscriptionManager = subscriptionManager;\n+\n+    this.app =\n+        Javalin.create(\n+            config -> {\n+              config.defaultContentType = \"application/json\";\n+              config.logIfServerNotStarted = false;\n+              config.showJavalinBanner = false;\n+            });", "originalCommit": "c8d696820a49948f27df49b70866510400ffa80b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MjE4Ng==", "url": "https://github.com/ConsenSys/teku/pull/2427#discussion_r459772186", "bodyText": "Tough love, I like it.", "author": "ajsutton", "createdAt": "2020-07-23T22:55:09Z", "path": "services/remote-validator/src/main/java/tech/pegasys/teku/services/remotevalidator/RemoteValidatorApi.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.services.remotevalidator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import io.javalin.Javalin;\n+import io.javalin.websocket.WsConnectContext;\n+import io.javalin.websocket.WsContext;\n+import java.io.IOException;\n+import java.util.Objects;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.TekuConfiguration;\n+\n+public class RemoteValidatorApi {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final RemoteValidatorSubscriptions subscriptionManager;\n+  private final Javalin app;\n+\n+  public RemoteValidatorApi(\n+      final TekuConfiguration configuration,\n+      final RemoteValidatorSubscriptions subscriptionManager) {\n+    checkNotNull(configuration, \"TekuConfiguration can't be null\");\n+    checkNotNull(subscriptionManager, \"RemoteValidatorSubscriptions can't be null\");\n+\n+    this.subscriptionManager = subscriptionManager;\n+\n+    this.app =\n+        Javalin.create(\n+            config -> {\n+              config.defaultContentType = \"application/json\";\n+              config.logIfServerNotStarted = false;\n+              config.showJavalinBanner = false;\n+            });\n+\n+    configureServer(configuration);\n+  }\n+\n+  private void configureServer(final TekuConfiguration configuration) {\n+    Objects.requireNonNull(this.app.server())\n+        .setServerHost(configuration.getRemoteValidatorApiInterface());\n+    Objects.requireNonNull(this.app.server())\n+        .setServerPort(configuration.getRemoteValidatorApiPort());\n+\n+    app.ws(\n+        \"/\",\n+        (ws) -> {\n+          ws.onConnect(this::subscribeValidator);\n+\n+          ws.onClose(this::unsubscribeValidator);\n+\n+          /*\n+           The server should not receive any messages from the remote validators\n+          */\n+          ws.onMessage(this::unsubscribeValidator);", "originalCommit": "c8d696820a49948f27df49b70866510400ffa80b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MzQ2Ng==", "url": "https://github.com/ConsenSys/teku/pull/2427#discussion_r459773466", "bodyText": "Yeah ultimately it would have to wind up being a command line option.", "author": "ajsutton", "createdAt": "2020-07-23T22:59:08Z", "path": "services/remote-validator/src/main/java/tech/pegasys/teku/services/remotevalidator/RemoteValidatorSubscriptions.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.services.remotevalidator;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.function.Consumer;\n+\n+public class RemoteValidatorSubscriptions implements BeaconChainEventsListener {\n+\n+  // TODO should we parametrize maxSubscribers?\n+  private final int maxSubscribers = 1_000;", "originalCommit": "c8d696820a49948f27df49b70866510400ffa80b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NDA3Mg==", "url": "https://github.com/ConsenSys/teku/pull/2427#discussion_r459774072", "bodyText": "If you prefix these with --X they'll turn up when you run teku -X so they're easier to find.", "author": "ajsutton", "createdAt": "2020-07-23T23:00:59Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/RemoteValidatorApiOptions.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.cli.options;\n+\n+import picocli.CommandLine.Option;\n+\n+public class RemoteValidatorApiOptions {\n+\n+  @Option(\n+      names = {\"--remote-validator-api-enabled\"},", "originalCommit": "c8d696820a49948f27df49b70866510400ffa80b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "36da64652863be541f9592167e55bd6f931e6b2e", "url": "https://github.com/ConsenSys/teku/commit/36da64652863be541f9592167e55bd6f931e6b2e", "message": "Added experimental --X flag to remote validator options\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-26T23:06:47Z", "type": "commit"}, {"oid": "6ddf38f70d0275f8e545314220151f6adacfe500", "url": "https://github.com/ConsenSys/teku/commit/6ddf38f70d0275f8e545314220151f6adacfe500", "message": "Using JsonProvider for serialization\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-26T23:50:48Z", "type": "commit"}, {"oid": "f498744c550270dfc0ba7105c9afe96941d8bbfd", "url": "https://github.com/ConsenSys/teku/commit/f498744c550270dfc0ba7105c9afe96941d8bbfd", "message": "Max subscribers property\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-26T23:51:29Z", "type": "commit"}, {"oid": "efafdd7f1824e70ca750358708ff7e908470a989", "url": "https://github.com/ConsenSys/teku/commit/efafdd7f1824e70ca750358708ff7e908470a989", "message": "Better close connection handling\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-27T00:07:47Z", "type": "commit"}, {"oid": "7e1fd3c1adcb897a80f2e7b961859167bf912a6b", "url": "https://github.com/ConsenSys/teku/commit/7e1fd3c1adcb897a80f2e7b961859167bf912a6b", "message": "Unit test for RemoteValidatorBeaconChainEventsAdapter\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-27T02:28:49Z", "type": "commit"}, {"oid": "d42e3c2ddb5c3ae91caf617349861343ef0fd238", "url": "https://github.com/ConsenSys/teku/commit/d42e3c2ddb5c3ae91caf617349861343ef0fd238", "message": "Unit test for RemoteValidatorSubscriptions\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-27T02:57:37Z", "type": "commit"}, {"oid": "3a3a7d03c29e6d380abbfe437d8e47d76ff45e26", "url": "https://github.com/ConsenSys/teku/commit/3a3a7d03c29e6d380abbfe437d8e47d76ff45e26", "message": "Unit test for RemoteValidatorApi\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-27T04:20:02Z", "type": "commit"}, {"oid": "ed672104b0819d63ef27ef82101d2abaa1aaaf61", "url": "https://github.com/ConsenSys/teku/commit/ed672104b0819d63ef27ef82101d2abaa1aaaf61", "message": "Merge branch 'master' into split-validator\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-27T04:21:54Z", "type": "commit"}, {"oid": "598c4aaea2239ba2c049141e5c511131029f27d6", "url": "https://github.com/ConsenSys/teku/commit/598c4aaea2239ba2c049141e5c511131029f27d6", "message": "Fix test param\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-27T04:40:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY0NDY1Mg==", "url": "https://github.com/ConsenSys/teku/pull/2427#discussion_r460644652", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Mock private TekuConfiguration configuration;\n          \n          \n            \n              private TekuConfiguration configuration = mock(TekuConfiguration.class);\n          \n      \n    \n    \n  \n\nand so on. for the other fields. :)", "author": "ajsutton", "createdAt": "2020-07-27T04:48:23Z", "path": "services/remote-validator/src/test/java/tech/pegasys/teku/services/remotevalidator/RemoteValidatorApiTest.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.services.remotevalidator;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import io.javalin.http.Context;\n+import io.javalin.websocket.WsConnectContext;\n+import java.io.IOException;\n+import java.util.UUID;\n+import java.util.function.Consumer;\n+import javax.servlet.http.HttpServletRequest;\n+import org.eclipse.jetty.websocket.api.RemoteEndpoint;\n+import org.eclipse.jetty.websocket.api.Session;\n+import org.eclipse.jetty.websocket.api.StatusCode;\n+import org.eclipse.jetty.websocket.servlet.ServletUpgradeRequest;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import tech.pegasys.teku.services.remotevalidator.RemoteValidatorSubscriptions.SubscriptionStatus;\n+import tech.pegasys.teku.util.config.TekuConfiguration;\n+\n+@ExtendWith(MockitoExtension.class)\n+class RemoteValidatorApiTest {\n+\n+  @Mock private TekuConfiguration configuration;", "originalCommit": "598c4aaea2239ba2c049141e5c511131029f27d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY0NDkzOQ==", "url": "https://github.com/ConsenSys/teku/pull/2427#discussion_r460644939", "bodyText": "And the nice thing about not using @Mock annotations is the values are immediately available so you can just declare these values inline rather than needing a beforeEach method.", "author": "ajsutton", "createdAt": "2020-07-27T04:49:39Z", "path": "services/remote-validator/src/test/java/tech/pegasys/teku/services/remotevalidator/RemoteValidatorApiTest.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.services.remotevalidator;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import io.javalin.http.Context;\n+import io.javalin.websocket.WsConnectContext;\n+import java.io.IOException;\n+import java.util.UUID;\n+import java.util.function.Consumer;\n+import javax.servlet.http.HttpServletRequest;\n+import org.eclipse.jetty.websocket.api.RemoteEndpoint;\n+import org.eclipse.jetty.websocket.api.Session;\n+import org.eclipse.jetty.websocket.api.StatusCode;\n+import org.eclipse.jetty.websocket.servlet.ServletUpgradeRequest;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import tech.pegasys.teku.services.remotevalidator.RemoteValidatorSubscriptions.SubscriptionStatus;\n+import tech.pegasys.teku.util.config.TekuConfiguration;\n+\n+@ExtendWith(MockitoExtension.class)\n+class RemoteValidatorApiTest {\n+\n+  @Mock private TekuConfiguration configuration;\n+\n+  @Mock private RemoteValidatorSubscriptions subscriptionManager;\n+\n+  @Mock private Session wsSession;\n+\n+  @Captor private ArgumentCaptor<Consumer<BeaconChainEvent>> subscriberCallbackArgCaptor;\n+\n+  private WsConnectContext wsContext;\n+\n+  private RemoteValidatorApi remoteValidatorApi;\n+\n+  @BeforeEach\n+  public void beforeEach() {\n+    wsContext = createWsContextStub();\n+    remoteValidatorApi = new RemoteValidatorApi(configuration, subscriptionManager);\n+  }", "originalCommit": "598c4aaea2239ba2c049141e5c511131029f27d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d28fa1611c3ba0ebd2faad0dbe91992a03fbb07a", "url": "https://github.com/ConsenSys/teku/commit/d28fa1611c3ba0ebd2faad0dbe91992a03fbb07a", "message": "PR comments\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-07-27T05:22:34Z", "type": "commit"}]}