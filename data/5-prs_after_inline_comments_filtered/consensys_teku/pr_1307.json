{"pr_number": 1307, "pr_title": "Disconnect cleanly", "pr_createdAt": "2020-03-06T04:01:25Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1307", "timeline": [{"oid": "8f8f40e9f3142c1a07274e33ec9c13e3fdcae993", "url": "https://github.com/ConsenSys/teku/commit/8f8f40e9f3142c1a07274e33ec9c13e3fdcae993", "message": "Send GOODBYE message politely when disconnecting excess peers.", "committedDate": "2020-03-06T03:08:05Z", "type": "commit"}, {"oid": "d7f10da5411bd796b821f1e915d468f4d7f8a8ab", "url": "https://github.com/ConsenSys/teku/commit/d7f10da5411bd796b821f1e915d468f4d7f8a8ab", "message": "Consistently use disconnectCleanly so that we guarantee disconnection even if the other side misbehaves.", "committedDate": "2020-03-06T03:54:39Z", "type": "commit"}, {"oid": "634866ab2aede026311c074ebd55869e5b717a1c", "url": "https://github.com/ConsenSys/teku/commit/634866ab2aede026311c074ebd55869e5b717a1c", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into clean-disconnect", "committedDate": "2020-03-06T04:01:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2NTM2Nw==", "url": "https://github.com/ConsenSys/teku/pull/1307#discussion_r388965367", "bodyText": "It seems like we're calling connected.set(false) twice. Is there a specific reason we do that?", "author": "cemozerr", "createdAt": "2020-03-06T15:22:25Z", "path": "networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/LibP2PPeer.java", "diffHunk": "@@ -58,11 +65,29 @@ public boolean isConnected() {\n \n   @Override\n   @SuppressWarnings(\"FutureReturnValueIgnored\")\n-  public void disconnect() {\n+  public void disconnectImmediately() {\n     connected.set(false);\n     connection.close();\n   }\n \n+  @Override\n+  public void disconnectCleanly(final DisconnectRequestHandler.DisconnectReason reason) {\n+    connected.set(false);", "originalCommit": "634866ab2aede026311c074ebd55869e5b717a1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxNTMxMw==", "url": "https://github.com/ConsenSys/teku/pull/1307#discussion_r389215313", "bodyText": "We want to mark the peer as disconnected as soon as we start the clean disconnect process, but also want to do so when we disconnect immediately.  It doesn't make a lot of difference but just avoids us sending a request for blocks to a peer that we've started disconnecting.", "author": "ajsutton", "createdAt": "2020-03-07T01:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2NTM2Nw=="}], "type": "inlineReview"}, {"oid": "7b756c5c8132bf81f540c0e573ec8bf4986f483a", "url": "https://github.com/ConsenSys/teku/commit/7b756c5c8132bf81f540c0e573ec8bf4986f483a", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into clean-disconnect", "committedDate": "2020-03-07T01:46:31Z", "type": "commit"}]}