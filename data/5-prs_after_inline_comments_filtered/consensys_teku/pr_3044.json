{"pr_number": 3044, "pr_title": "Fix non-canonical chain info retrieval for beacon state APIs", "pr_createdAt": "2020-10-21T18:34:20Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3044", "timeline": [{"oid": "e202f264e87af0824e1690fa5eb2432b752f5c00", "url": "https://github.com/ConsenSys/teku/commit/e202f264e87af0824e1690fa5eb2432b752f5c00", "message": "Fix non canonical chain info retrieval for beacon state APIs", "committedDate": "2020-10-21T18:33:36Z", "type": "commit"}, {"oid": "d48580d017c06426377f7b1f1c16343459845264", "url": "https://github.com/ConsenSys/teku/commit/d48580d017c06426377f7b1f1c16343459845264", "message": "Merge branch 'master' into fixNonCanonicalBlockAndStateRetrieval", "committedDate": "2020-10-21T18:34:26Z", "type": "commit"}, {"oid": "414c119ebf1f8fd36f36879654daecc949216050", "url": "https://github.com/ConsenSys/teku/commit/414c119ebf1f8fd36f36879654daecc949216050", "message": "Remove unused varible", "committedDate": "2020-10-21T18:53:31Z", "type": "commit"}, {"oid": "ea1c99f0924014841b8e866cb26e9816e447d735", "url": "https://github.com/ConsenSys/teku/commit/ea1c99f0924014841b8e866cb26e9816e447d735", "message": "Fix tests and add improve API handling", "committedDate": "2020-10-21T19:13:36Z", "type": "commit"}, {"oid": "179415cb2262d79b13052d2efe93eea4d454d726", "url": "https://github.com/ConsenSys/teku/commit/179415cb2262d79b13052d2efe93eea4d454d726", "message": "Refactor to remove duplicated code", "committedDate": "2020-10-21T19:39:55Z", "type": "commit"}, {"oid": "2359fea9ae51e9333abb15c7aeca4fff364e64f7", "url": "https://github.com/ConsenSys/teku/commit/2359fea9ae51e9333abb15c7aeca4fff364e64f7", "message": "Run spotless", "committedDate": "2020-10-21T19:40:05Z", "type": "commit"}, {"oid": "71cf67609d77387a2ffcc00b1b5a458edc313246", "url": "https://github.com/ConsenSys/teku/commit/71cf67609d77387a2ffcc00b1b5a458edc313246", "message": "Refactor duplicated error handling", "committedDate": "2020-10-21T19:55:06Z", "type": "commit"}, {"oid": "45383fb0c45ca4be81d299fe086e7e0ba4fba158", "url": "https://github.com/ConsenSys/teku/commit/45383fb0c45ca4be81d299fe086e7e0ba4fba158", "message": "Add skipped bits", "committedDate": "2020-10-21T19:59:09Z", "type": "commit"}, {"oid": "dbce1e81d86b5c8f789b4065841852f37e6029b3", "url": "https://github.com/ConsenSys/teku/commit/dbce1e81d86b5c8f789b4065841852f37e6029b3", "message": "Remove redundant LOG variables", "committedDate": "2020-10-21T20:03:49Z", "type": "commit"}, {"oid": "1b3e5c7891c24b7adae1c2144fea62133df6b1b2", "url": "https://github.com/ConsenSys/teku/commit/1b3e5c7891c24b7adae1c2144fea62133df6b1b2", "message": "Add tests for the abstract handler process state endpoint method", "committedDate": "2020-10-21T20:43:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY4ODQ1NQ==", "url": "https://github.com/ConsenSys/teku/pull/3044#discussion_r509688455", "bodyText": "should probably ticket this...", "author": "rolfyone", "createdAt": "2020-10-21T20:53:45Z", "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -237,6 +274,7 @@ public UInt64 getCurrentEpoch() {\n         .thenApply(stateInternal -> stateInternal.map(BeaconState::new));\n   }\n \n+  // TODO: remove once old API's are removed", "originalCommit": "1b3e5c7891c24b7adae1c2144fea62133df6b1b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0520c433a6842ae05eb4b752bdc581c86107e145", "url": "https://github.com/ConsenSys/teku/commit/0520c433a6842ae05eb4b752bdc581c86107e145", "message": "Add more tests", "committedDate": "2020-10-21T20:55:23Z", "type": "commit"}, {"oid": "cd15ebc61199e58433701c39b5b91d8e8e4e4b78", "url": "https://github.com/ConsenSys/teku/commit/cd15ebc61199e58433701c39b5b91d8e8e4e4b78", "message": "Merge branch 'master' into fixNonCanonicalBlockAndStateRetrieval", "committedDate": "2020-10-21T20:55:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5MTAyNw==", "url": "https://github.com/ConsenSys/teku/pull/3044#discussion_r509691027", "bodyText": "this was wrapped because the tests in the API were attempting to use the api level objects (the api.schema.BeaconState)\nis there a reason we need the internal object?", "author": "rolfyone", "createdAt": "2020-10-21T20:58:22Z", "path": "data/beaconrestapi/src/test/java/tech/pegasys/teku/beaconrestapi/handlers/v1/beacon/GetStateFinalityCheckpointsTest.java", "diffHunk": "@@ -22,20 +22,22 @@\n import java.util.Optional;\n import org.junit.jupiter.api.Test;\n import tech.pegasys.teku.api.response.v1.beacon.GetStateFinalityCheckpointsResponse;\n-import tech.pegasys.teku.api.schema.BeaconState;\n+import tech.pegasys.teku.api.schema.Checkpoint;\n import tech.pegasys.teku.beaconrestapi.AbstractBeaconHandlerTest;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n import tech.pegasys.teku.datastructures.util.DataStructureUtil;\n import tech.pegasys.teku.infrastructure.async.SafeFuture;\n import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n \n public class GetStateFinalityCheckpointsTest extends AbstractBeaconHandlerTest {\n   final DataStructureUtil dataStructureUtil = new DataStructureUtil();\n-  final BeaconState state = new BeaconState(dataStructureUtil.randomBeaconState());\n+  final BeaconState state = dataStructureUtil.randomBeaconState();", "originalCommit": "cd15ebc61199e58433701c39b5b91d8e8e4e4b78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5MjUwMw==", "url": "https://github.com/ConsenSys/teku/pull/3044#discussion_r509692503", "bodyText": "we were unnecessarily serializing the whole beacon state object to only get the checkpoint information. seemed like wasted CPU cycles.", "author": "cemozerr", "createdAt": "2020-10-21T21:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5MTAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5NDk5NQ==", "url": "https://github.com/ConsenSys/teku/pull/3044#discussion_r509694995", "bodyText": "its more that the api level then may have dependencies on internal structures, to be honest i'd far prefer its only using api level objects unless explicitly needing the internal ones for a test...", "author": "rolfyone", "createdAt": "2020-10-21T21:04:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5MTAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5NzUzNg==", "url": "https://github.com/ConsenSys/teku/pull/3044#discussion_r509697536", "bodyText": "But we still get the internal beacon state object in ChainDataProvider. So are we trying to keep the internal only there?", "author": "cemozerr", "createdAt": "2020-10-21T21:07:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5MTAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyNzMwNw==", "url": "https://github.com/ConsenSys/teku/pull/3044#discussion_r509727307", "bodyText": "I switched to making the FinalityCheckpointsResponse object in ChainDataProvider so that the rest API handler does not touch the internal object.", "author": "cemozerr", "createdAt": "2020-10-21T21:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5MTAyNw=="}], "type": "inlineReview"}, {"oid": "8af5d265e9ef263dc3e769ad53a46141c094d581", "url": "https://github.com/ConsenSys/teku/commit/8af5d265e9ef263dc3e769ad53a46141c094d581", "message": "Do not use internal beacon state object", "committedDate": "2020-10-21T21:45:21Z", "type": "commit"}]}