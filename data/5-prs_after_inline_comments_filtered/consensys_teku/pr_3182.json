{"pr_number": 3182, "pr_title": "Limit size of range used when requesting deposit logs", "pr_createdAt": "2020-11-09T03:52:31Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3182", "timeline": [{"oid": "13a7574c720cb7d3e4f50934f23b2f1d20a30670", "url": "https://github.com/ConsenSys/teku/commit/13a7574c720cb7d3e4f50934f23b2f1d20a30670", "message": "Limit number of blocks deposit logs are requested for.\nReduce request size if logs are not returned because the result set is too large (Infura) or times out.", "committedDate": "2020-11-09T03:46:46Z", "type": "commit"}, {"oid": "2ad56fafcebec88354348448fc097cf1e9cab436", "url": "https://github.com/ConsenSys/teku/commit/2ad56fafcebec88354348448fc097cf1e9cab436", "message": "Ensure batch size will always grow again.", "committedDate": "2020-11-09T03:47:45Z", "type": "commit"}, {"oid": "5e98772a625d6a42099555a856173b2ca508b523", "url": "https://github.com/ConsenSys/teku/commit/5e98772a625d6a42099555a856173b2ca508b523", "message": "Add comment.", "committedDate": "2020-11-09T03:50:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1NzQ0Mg==", "url": "https://github.com/ConsenSys/teku/pull/3182#discussion_r519557442", "bodyText": "'FROM' eth1 node?", "author": "rolfyone", "createdAt": "2020-11-09T05:16:34Z", "path": "pow/src/main/java/tech/pegasys/teku/pow/contract/DepositContract.java", "diffHunk": "@@ -138,11 +138,19 @@ protected DepositContract(\n             .ethGetLogs(filter)\n             .sendAsync()\n             .thenApply(\n-                logs ->\n-                    logs.getLogs().stream()\n-                        .map(log -> (Log) log.get())\n-                        .map(this::convertLogToDepositEventEventResponse)\n-                        .collect(Collectors.toList())));\n+                logs -> {\n+                  if (logs.getLogs() == null) {\n+                    // We got a response from the node but it didn't include even an empty list\n+                    // of logs.  This happens with Infura when more than 10,000 log entries match\n+                    // so treat as an explicit rejection of the request to allow the requested block\n+                    // range to be reduced.\n+                    throw new RejectedRequestException(\"No logs returned by ETH1 node\");", "originalCommit": "5e98772a625d6a42099555a856173b2ca508b523", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1Nzg1Mw==", "url": "https://github.com/ConsenSys/teku/pull/3182#discussion_r519557853", "bodyText": "Grammatically I'd have said by - ie it was the ETH1 node that produced the empty response.  It really doesn't matter though because we catch the exception and handle it anyway.", "author": "ajsutton", "createdAt": "2020-11-09T05:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1NzQ0Mg=="}], "type": "inlineReview"}]}