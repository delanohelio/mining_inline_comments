{"pr_number": 1547, "pr_title": "Perform aggregation duties in validator client service", "pr_createdAt": "2020-04-07T05:11:52Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1547", "timeline": [{"oid": "45522c8ac04587a729c79e178903f9dda8a3c384", "url": "https://github.com/ConsenSys/teku/commit/45522c8ac04587a729c79e178903f9dda8a3c384", "message": "Create aggregate for all validators edition.", "committedDate": "2020-04-07T04:50:02Z", "type": "commit"}, {"oid": "ea947ab2abaaa846e837be653f880a147a5fa998", "url": "https://github.com/ConsenSys/teku/commit/ea947ab2abaaa846e837be653f880a147a5fa998", "message": "Only produce one aggregate per committee even when multiple of our validators are assigned as aggregators for it.", "committedDate": "2020-04-07T04:57:41Z", "type": "commit"}, {"oid": "412beac6d42214e3848390068d204c14b5c01f48", "url": "https://github.com/ConsenSys/teku/commit/412beac6d42214e3848390068d204c14b5c01f48", "message": "Rename for clarity.", "committedDate": "2020-04-07T05:04:00Z", "type": "commit"}, {"oid": "e3169a3137fd623572c1b8858d96d294a516c196", "url": "https://github.com/ConsenSys/teku/commit/e3169a3137fd623572c1b8858d96d294a516c196", "message": "Log errors properly.", "committedDate": "2020-04-07T05:08:36Z", "type": "commit"}, {"oid": "56db1862d36277ed4ebe1fa798890a8207f0c309", "url": "https://github.com/ConsenSys/teku/commit/56db1862d36277ed4ebe1fa798890a8207f0c309", "message": "Remove comment.", "committedDate": "2020-04-07T05:09:40Z", "type": "commit"}, {"oid": "0b67381339c08a626a50ff66d61bc3a6fd8e36f8", "url": "https://github.com/ConsenSys/teku/commit/0b67381339c08a626a50ff66d61bc3a6fd8e36f8", "message": "Only need synchronized on the committee.", "committedDate": "2020-04-07T05:10:59Z", "type": "commit"}, {"oid": "497b85d1de93330de575140fd24a24397080755a", "url": "https://github.com/ConsenSys/teku/commit/497b85d1de93330de575140fd24a24397080755a", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into validator-aggregate", "committedDate": "2020-04-07T05:12:04Z", "type": "commit"}, {"oid": "8d2d4535770c71b1faa6cde92ed3834a9fbb053d", "url": "https://github.com/ConsenSys/teku/commit/8d2d4535770c71b1faa6cde92ed3834a9fbb053d", "message": "Make errorprone happy.", "committedDate": "2020-04-07T05:21:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4NjIzMA==", "url": "https://github.com/ConsenSys/teku/pull/1547#discussion_r404886230", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public SafeFuture<Void> aggregateCommittee(final CommitteeAggregator aggregators) {\n          \n          \n            \n              public SafeFuture<Void> aggregateCommittee(final CommitteeAggregator aggregator) {", "author": "mbaxter", "createdAt": "2020-04-07T15:09:38Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/AggregationDuty.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client.duties;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Optional;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import tech.pegasys.artemis.datastructures.operations.AggregateAndProof;\n+import tech.pegasys.artemis.datastructures.operations.Attestation;\n+import tech.pegasys.artemis.datastructures.operations.AttestationData;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+import tech.pegasys.artemis.validator.api.ValidatorApiChannel;\n+\n+public class AggregationDuty implements Duty {\n+  private final ConcurrentMap<Integer, CommitteeAggregator> aggregatorsByCommitteeIndex =\n+      new ConcurrentHashMap<>();\n+  private final UnsignedLong slot;\n+  private final ValidatorApiChannel validatorApiChannel;\n+\n+  public AggregationDuty(final UnsignedLong slot, final ValidatorApiChannel validatorApiChannel) {\n+    this.slot = slot;\n+    this.validatorApiChannel = validatorApiChannel;\n+  }\n+\n+  public void addValidator(\n+      final int validatorIndex,\n+      final BLSSignature proof,\n+      final int attestationCommitteeIndex,\n+      final SafeFuture<Optional<Attestation>> unsignedAttestationFuture) {\n+    aggregatorsByCommitteeIndex.computeIfAbsent(\n+        attestationCommitteeIndex,\n+        __ ->\n+            new CommitteeAggregator(\n+                UnsignedLong.valueOf(validatorIndex), proof, unsignedAttestationFuture));\n+  }\n+\n+  @Override\n+  public SafeFuture<?> performDuty() {\n+    return SafeFuture.allOf(\n+        aggregatorsByCommitteeIndex.values().stream()\n+            .map(this::aggregateCommittee)\n+            .toArray(SafeFuture[]::new));\n+  }\n+\n+  public SafeFuture<Void> aggregateCommittee(final CommitteeAggregator aggregators) {", "originalCommit": "8d2d4535770c71b1faa6cde92ed3834a9fbb053d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2MTY1Ng==", "url": "https://github.com/ConsenSys/teku/pull/1547#discussion_r405061656", "bodyText": "Done.", "author": "ajsutton", "createdAt": "2020-04-07T19:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4NjIzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4ODA4NA==", "url": "https://github.com/ConsenSys/teku/pull/1547#discussion_r404888084", "bodyText": "Might be worth adding a comment here explaining that we will produce at most 1 aggregation per committee", "author": "mbaxter", "createdAt": "2020-04-07T15:11:59Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/AggregationDuty.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client.duties;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Optional;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import tech.pegasys.artemis.datastructures.operations.AggregateAndProof;\n+import tech.pegasys.artemis.datastructures.operations.Attestation;\n+import tech.pegasys.artemis.datastructures.operations.AttestationData;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+import tech.pegasys.artemis.validator.api.ValidatorApiChannel;\n+\n+public class AggregationDuty implements Duty {\n+  private final ConcurrentMap<Integer, CommitteeAggregator> aggregatorsByCommitteeIndex =\n+      new ConcurrentHashMap<>();\n+  private final UnsignedLong slot;\n+  private final ValidatorApiChannel validatorApiChannel;\n+\n+  public AggregationDuty(final UnsignedLong slot, final ValidatorApiChannel validatorApiChannel) {\n+    this.slot = slot;\n+    this.validatorApiChannel = validatorApiChannel;\n+  }\n+\n+  public void addValidator(\n+      final int validatorIndex,\n+      final BLSSignature proof,\n+      final int attestationCommitteeIndex,\n+      final SafeFuture<Optional<Attestation>> unsignedAttestationFuture) {\n+    aggregatorsByCommitteeIndex.computeIfAbsent(", "originalCommit": "8d2d4535770c71b1faa6cde92ed3834a9fbb053d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2MTYwOQ==", "url": "https://github.com/ConsenSys/teku/pull/1547#discussion_r405061609", "bodyText": "Done.", "author": "ajsutton", "createdAt": "2020-04-07T19:33:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4ODA4NA=="}], "type": "inlineReview"}, {"oid": "50df9df1b33aa3693c8e25ed1c0e9fb1a158ea0b", "url": "https://github.com/ConsenSys/teku/commit/50df9df1b33aa3693c8e25ed1c0e9fb1a158ea0b", "message": "Review feedback.", "committedDate": "2020-04-07T19:17:57Z", "type": "commit"}, {"oid": "f45f8253d0841e28fe233b914367be978966b571", "url": "https://github.com/ConsenSys/teku/commit/f45f8253d0841e28fe233b914367be978966b571", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into validator-aggregate", "committedDate": "2020-04-07T19:18:04Z", "type": "commit"}]}