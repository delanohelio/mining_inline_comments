{"pr_number": 2379, "pr_title": "[Issue 2291] Validate gossip async", "pr_createdAt": "2020-07-17T21:48:13Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2379", "timeline": [{"oid": "17dcb6f27b394afa895162e2f726183de62d78e8", "url": "https://github.com/ConsenSys/teku/commit/17dcb6f27b394afa895162e2f726183de62d78e8", "message": "Rework gossip topic handlers to return a validation future", "committedDate": "2020-07-17T21:40:52Z", "type": "commit"}, {"oid": "02c61470d3551222068d08876065038fb7ba8a58", "url": "https://github.com/ConsenSys/teku/commit/02c61470d3551222068d08876065038fb7ba8a58", "message": "Update gossip validators to use new async retrieveBlockState method", "committedDate": "2020-07-17T21:40:52Z", "type": "commit"}, {"oid": "bf6434163fdfa9fb05dc646b7d612f3679df24d5", "url": "https://github.com/ConsenSys/teku/commit/bf6434163fdfa9fb05dc646b7d612f3679df24d5", "message": "Run spotless", "committedDate": "2020-07-17T21:59:10Z", "type": "commit"}, {"oid": "eb2e7fb52235844fe034d2589997f385aebf45ce", "url": "https://github.com/ConsenSys/teku/commit/eb2e7fb52235844fe034d2589997f385aebf45ce", "message": "Update BlockValidator", "committedDate": "2020-07-17T22:12:26Z", "type": "commit"}, {"oid": "9dc6097016b6772769b0c4de18799fa557c566f5", "url": "https://github.com/ConsenSys/teku/commit/9dc6097016b6772769b0c4de18799fa557c566f5", "message": "Merge branch 'master' into issue-2291/validate-gossip-async", "committedDate": "2020-07-17T22:54:32Z", "type": "commit"}, {"oid": "f12a78ffd11b501a818589b718095445da501e99", "url": "https://github.com/ConsenSys/teku/commit/f12a78ffd11b501a818589b718095445da501e99", "message": "Incorporate changes from master", "committedDate": "2020-07-17T23:08:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3Mjg1NA==", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r456972854", "bodyText": "Probably outside the scope of this PR but does this wind up doing the validation on the netty thread or have we already jumped off of it?\nBecause if we've got SafeFuture involved anyway it would be good to delegate validation to a worker pool and not block the netty threads.", "author": "ajsutton", "createdAt": "2020-07-20T00:03:41Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/AttesterSlashingTopicHandler.java", "diffHunk": "@@ -92,7 +81,9 @@ public Bytes4 getForkDigest() {\n     return forkDigest;\n   }\n \n-  protected InternalValidationResult validateData(final AttesterSlashing attesterSlashing) {\n-    return validator.validate(attesterSlashing);\n+  @Override\n+  protected SafeFuture<InternalValidationResult> validateData(\n+      final AttesterSlashing attesterSlashing) {\n+    return SafeFuture.completedFuture(validator.validate(attesterSlashing));", "originalCommit": "f12a78ffd11b501a818589b718095445da501e99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3MDk3OA==", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r457570978", "bodyText": "We're still on the netty thread.  Definitely makes sense to move this to a worker thread though \ud83d\udc4d  We've got a ticket for that here: #1947.  Should be made easier by this PR.", "author": "mbaxter", "createdAt": "2020-07-20T17:21:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3Mjg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDMzMg==", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r456974332", "bodyText": "Shouldn't Store automatically take care of caching for us?  We're also only loading one state and creating a new cache each time so I don't think this can wind up ever being useful.", "author": "ajsutton", "createdAt": "2020-07-20T00:16:39Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java", "diffHunk": "@@ -211,6 +229,23 @@ private UnsignedLong maximumBroadcastTimeMillis(final UnsignedLong attestationSl\n     return secondsToMillis(lastAllowedTime).plus(MAXIMUM_GOSSIP_CLOCK_DISPARITY);\n   }\n \n+  StateProvider createStateProvider() {\n+    return createStateProvider(recentChainData);\n+  }\n+\n+  @VisibleForTesting\n+  static StateProvider createStateProvider(final RecentChainData recentChainData) {\n+    LoadingCache<Bytes32, SafeFuture<Optional<BeaconState>>> cache =\n+        CacheBuilder.newBuilder().build(CacheLoader.from(recentChainData::retrieveBlockState));", "originalCommit": "f12a78ffd11b501a818589b718095445da501e99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDg0Mw==", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r456974843", "bodyText": "Oh I see we do reuse it in SignedAggregateAndProofValidator.  I suspect leaving the caching to the Store is likely to be the right answer still.", "author": "ajsutton", "createdAt": "2020-07-20T00:20:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4MzI0MQ==", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r457583241", "bodyText": "Simplified this. It felt weird to me to potentially regenerate the same state twice, but in reality the Store should still have it cached.", "author": "mbaxter", "createdAt": "2020-07-20T17:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDMzMg=="}], "type": "inlineReview"}, {"oid": "b65e37bed9d143c44947d59d7ae473b46901f026", "url": "https://github.com/ConsenSys/teku/commit/b65e37bed9d143c44947d59d7ae473b46901f026", "message": "Simplify state retrieval - rely on Store cache", "committedDate": "2020-07-20T17:35:21Z", "type": "commit"}, {"oid": "8c61f2faeb87e3e2320c7469610d00274c04fbc3", "url": "https://github.com/ConsenSys/teku/commit/8c61f2faeb87e3e2320c7469610d00274c04fbc3", "message": "Merge branch 'master' into issue-2291/validate-gossip-async", "committedDate": "2020-07-20T17:43:37Z", "type": "commit"}]}