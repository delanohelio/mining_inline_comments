{"pr_number": 1390, "pr_title": "get unsigned validator block", "pr_createdAt": "2020-03-17T06:11:46Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1390", "timeline": [{"oid": "b541f076b999d2bf175c8d93c5870e933288139b", "url": "https://github.com/ConsenSys/teku/commit/b541f076b999d2bf175c8d93c5870e933288139b", "message": "add /validator/block GET endpoint to retrieve an unsigned block.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-03-17T06:10:10Z", "type": "commit"}, {"oid": "794e7effef5fcddc9180dcf89ee65ea51afe8133", "url": "https://github.com/ConsenSys/teku/commit/794e7effef5fcddc9180dcf89ee65ea51afe8133", "message": "Merge remote-tracking branch 'upstream/master' into 1355-get-validator-block", "committedDate": "2020-03-17T06:10:37Z", "type": "commit"}, {"oid": "b4ae026f55f5b5369a228f2b8a454827d0d43bd8", "url": "https://github.com/ConsenSys/teku/commit/b4ae026f55f5b5369a228f2b8a454827d0d43bd8", "message": "fix build after merge\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-03-17T06:15:29Z", "type": "commit"}, {"oid": "60784b5d3cf8751879d9b4cfdf5b67e15b90746e", "url": "https://github.com/ConsenSys/teku/commit/60784b5d3cf8751879d9b4cfdf5b67e15b90746e", "message": "fix build after merge\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-03-17T06:21:52Z", "type": "commit"}, {"oid": "c9a336f1be6bebe5fdd501e2b4734d64c80347ab", "url": "https://github.com/ConsenSys/teku/commit/c9a336f1be6bebe5fdd501e2b4734d64c80347ab", "message": "Merge remote-tracking branch 'upstream/master' into 1355-get-validator-block", "committedDate": "2020-03-18T20:24:13Z", "type": "commit"}, {"oid": "0888b4548ad4aca3e74eaaf5714c05bc2a7f14d4", "url": "https://github.com/ConsenSys/teku/commit/0888b4548ad4aca3e74eaaf5714c05bc2a7f14d4", "message": "Merge remote-tracking branch 'upstream/master' into 1355-get-validator-block", "committedDate": "2020-03-18T20:33:40Z", "type": "commit"}, {"oid": "13451ba6e6d3b6cbcaa8b2c8baba1de849ba78cd", "url": "https://github.com/ConsenSys/teku/commit/13451ba6e6d3b6cbcaa8b2c8baba1de849ba78cd", "message": "fix build after merge\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-03-18T20:45:16Z", "type": "commit"}, {"oid": "ce5ba39820cbb094d2259871a37ae5a4b4a646eb", "url": "https://github.com/ConsenSys/teku/commit/ce5ba39820cbb094d2259871a37ae5a4b4a646eb", "message": "Merge remote-tracking branch 'upstream/master' into 1355-get-validator-block", "committedDate": "2020-03-18T21:43:31Z", "type": "commit"}, {"oid": "69b67c1e50f6a3af88c4c96b67a8339ac449e655", "url": "https://github.com/ConsenSys/teku/commit/69b67c1e50f6a3af88c4c96b67a8339ac449e655", "message": "Merge remote-tracking branch 'upstream/master' into 1355-get-validator-block", "committedDate": "2020-03-18T22:15:07Z", "type": "commit"}, {"oid": "15361ccc729ffd696632f01e2ab1bf51d5e4073d", "url": "https://github.com/ConsenSys/teku/commit/15361ccc729ffd696632f01e2ab1bf51d5e4073d", "message": "Merge remote-tracking branch 'upstream/master' into 1355-get-validator-block", "committedDate": "2020-03-18T22:22:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4NzUyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394687521", "bodyText": "We shouldn't be swallowing this exception.  Needs to log it somewhere or rethrow. I suspect it's probably a fairly important error and not something we'd expect.", "author": "ajsutton", "createdAt": "2020-03-18T23:01:39Z", "path": "data/provider/src/main/java/tech/pegasys/artemis/api/ValidatorDataProvider.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.api;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Optional;\n+import tech.pegasys.artemis.api.schema.BLSSignature;\n+import tech.pegasys.artemis.api.schema.BeaconBlock;\n+import tech.pegasys.artemis.validator.coordinator.ValidatorCoordinator;\n+\n+public class ValidatorDataProvider {\n+  private volatile ValidatorCoordinator validatorCoordinator;\n+\n+  public ValidatorDataProvider(ValidatorCoordinator validatorCoordinator) {\n+    this.validatorCoordinator = validatorCoordinator;\n+  }\n+\n+  public Optional<BeaconBlock> getUnsignedBeaconBlockAtSlot(\n+      UnsignedLong slot, BLSSignature randao) {\n+    if (slot == null) {\n+      throw new IllegalArgumentException(\"no slot provided.\");\n+    }\n+    if (randao == null) {\n+      throw new IllegalArgumentException(\"no randao_reveal provided.\");\n+    }\n+\n+    try {\n+      Optional<tech.pegasys.artemis.datastructures.blocks.BeaconBlock> newBlock =\n+          validatorCoordinator.createUnsignedBlock(\n+              slot, tech.pegasys.artemis.util.bls.BLSSignature.fromBytes(randao.getBytes()));\n+      if (newBlock.isPresent()) {\n+        return Optional.of(new BeaconBlock(newBlock.get()));\n+      }\n+    } catch (Exception ex) {\n+      return Optional.empty();", "originalCommit": "15361ccc729ffd696632f01e2ab1bf51d5e4073d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcxMzU2NA==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394713564", "bodyText": "this should be imported?", "author": "macfarla", "createdAt": "2020-03-19T00:17:04Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApi.java", "diffHunk": "@@ -163,6 +163,10 @@ private void addValidatorHandlers(DataProvider dataProvider) {\n     ChainDataProvider provider = dataProvider.getChainDataProvider();\n     app.get(GetAttestation.ROUTE, new GetAttestation(provider, jsonProvider));\n     app.get(GetValidators.ROUTE, new GetValidators(provider, jsonProvider));\n+    app.get(\n+        tech.pegasys.artemis.beaconrestapi.handlers.validator.GetBlock.ROUTE,", "originalCommit": "15361ccc729ffd696632f01e2ab1bf51d5e4073d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcxNjUwMA==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394716500", "bodyText": "oh it's a name collision", "author": "macfarla", "createdAt": "2020-03-19T00:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcxMzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyMzU5MA==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394723590", "bodyText": "yeh i'd have to rename it... could possibly call it GetNewBlock to avoid the name collision...", "author": "rolfyone", "createdAt": "2020-03-19T00:37:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcxMzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyNzg3Nw==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394727877", "bodyText": "do we want them named the same or is it confusing", "author": "macfarla", "createdAt": "2020-03-19T00:54:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcxMzU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcxNTM2Nw==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394715367", "bodyText": "nit: can bytes32 come first", "author": "macfarla", "createdAt": "2020-03-19T00:19:12Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/SingleQueryParameterUtils.java", "diffHunk": "@@ -18,9 +18,12 @@\n import java.util.Map;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.artemis.api.schema.BLSSignature;\n \n public class SingleQueryParameterUtils {\n \n+  public static final String INVALID_BYTES96_DATA =", "originalCommit": "15361ccc729ffd696632f01e2ab1bf51d5e4073d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcxNTcxNA==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394715714", "bodyText": "should this be bytes96? is that why you added it?", "author": "macfarla", "createdAt": "2020-03-19T00:19:39Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/SingleQueryParameterUtils.java", "diffHunk": "@@ -92,4 +95,15 @@ public static Bytes32 getParameterValueAsBytes32(\n       throw new IllegalArgumentException(INVALID_BYTES32_DATA);\n     }\n   }\n+\n+  public static BLSSignature getParameterValueAsBLSSignature(\n+      final Map<String, List<String>> parameterMap, final String key)\n+      throws IllegalArgumentException {\n+    String stringValue = validateQueryParameter(parameterMap, key);\n+    try {\n+      return BLSSignature.fromHexString(stringValue);\n+    } catch (IllegalArgumentException ex) {\n+      throw new IllegalArgumentException(INVALID_BYTES32_DATA);", "originalCommit": "15361ccc729ffd696632f01e2ab1bf51d5e4073d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyMjMwMg==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394722302", "bodyText": "96", "author": "macfarla", "createdAt": "2020-03-19T00:33:08Z", "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/SingleQueryParameterUtilsTest.java", "diffHunk": "@@ -116,4 +119,18 @@ public void getParameterAsBytes32_shouldParseHex32String() {\n     Bytes32 result = getParameterValueAsBytes32(data, KEY);\n     assertEquals(bytes32, result);\n   }\n+\n+  @Test\n+  public void getParameterAsBLSSignature_shouldThrowIfCannotParse() {\n+    assertThrows(\n+        IllegalArgumentException.class, () -> getParameterValueAsBytes32(INVALID_DATA, KEY));", "originalCommit": "15361ccc729ffd696632f01e2ab1bf51d5e4073d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyODIyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394728221", "bodyText": "this naming stuff is getting messy", "author": "macfarla", "createdAt": "2020-03-19T00:56:27Z", "path": "data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java", "diffHunk": "@@ -73,7 +72,9 @@ public ChainDataProvider(\n \n     Optional<Bytes32> headBlockRoot = chainStorageClient.getBestBlockRoot();\n     Optional<Bytes32> headStateRoot =\n-        headBlockRoot.flatMap(chainStorageClient::getBlockByRoot).map(BeaconBlock::getState_root);\n+        headBlockRoot\n+            .flatMap(chainStorageClient::getBlockByRoot)\n+            .map(tech.pegasys.artemis.datastructures.blocks.BeaconBlock::getState_root);", "originalCommit": "15361ccc729ffd696632f01e2ab1bf51d5e4073d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDczNjY3Mg==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394736672", "bodyText": "any ideas?", "author": "rolfyone", "createdAt": "2020-03-19T01:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyODIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc1NjEyMw==", "url": "https://github.com/ConsenSys/teku/pull/1390#discussion_r394756123", "bodyText": "not right now", "author": "macfarla", "createdAt": "2020-03-19T02:27:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyODIyMQ=="}], "type": "inlineReview"}, {"oid": "aaf20bdeb9a8482022f5f0bda56e9c56df1d5099", "url": "https://github.com/ConsenSys/teku/commit/aaf20bdeb9a8482022f5f0bda56e9c56df1d5099", "message": "changes from review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-03-19T02:14:40Z", "type": "commit"}, {"oid": "7d64c861058e3b71d586ad7aaeef2ea9333bc619", "url": "https://github.com/ConsenSys/teku/commit/7d64c861058e3b71d586ad7aaeef2ea9333bc619", "message": "Merge remote-tracking branch 'upstream/master' into 1355-get-validator-block", "committedDate": "2020-03-19T02:23:15Z", "type": "commit"}]}