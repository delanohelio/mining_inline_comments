{"pr_number": 1618, "pr_title": "cli/deposit: significantly simplify validator keystore path", "pr_createdAt": "2020-04-19T19:13:43Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1618", "timeline": [{"oid": "11a8d692ecb33dfb45608e2be033a2120294250f", "url": "https://github.com/ConsenSys/teku/commit/11a8d692ecb33dfb45608e2be033a2120294250f", "message": "cli/deposit: significantly simplify validator keystore path", "committedDate": "2020-04-19T19:00:52Z", "type": "commit"}, {"oid": "d1f1e207ea6b9021615351872c6c11c098b850a7", "url": "https://github.com/ConsenSys/teku/commit/d1f1e207ea6b9021615351872c6c11c098b850a7", "message": "cli/deposit: mind the 0x prefix", "committedDate": "2020-04-19T19:09:47Z", "type": "commit"}, {"oid": "03b32062fc046834dd39d3b229c98dc06d0f76f1", "url": "https://github.com/ConsenSys/teku/commit/03b32062fc046834dd39d3b229c98dc06d0f76f1", "message": "cli/deposit: remove the 0x prefix by offset", "committedDate": "2020-04-19T19:13:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAzMDI2NQ==", "url": "https://github.com/ConsenSys/teku/pull/1618#discussion_r411030265", "bodyText": "Given that not using the full public key opens up the possibility of overwriting an existing key with a different value, we should add a check in saveKeyStore so that it fails if the file already exists.  The chance of such a conflict is extremely low but given it results in a loss of funds we want to completely eliminate any risk of it.\nGiven how rare the overlap is, just aborting before we send the deposit would be fine.", "author": "ajsutton", "createdAt": "2020-04-20T00:46:10Z", "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/EncryptedKeystoreWriter.java", "diffHunk": "@@ -56,18 +56,13 @@ public void writeKeys(final BLSKeyPair validatorKey, final BLSKeyPair withdrawal\n     final KeyStoreData withdrawalKeyStoreData =\n         generateKeystoreData(withdrawalKey, withdrawalKeyPassword);\n \n-    saveKeyStore(\n-        keystoreDirectory.resolve(\"validator_\" + validatorKey.getPublicKey().toString() + \".json\"),\n-        validatorKeyStoreData);\n-    saveKeyStore(\n-        keystoreDirectory.resolve(\n-            \"withdrawal_\" + withdrawalKey.getPublicKey().toString() + \".json\"),\n-        withdrawalKeyStoreData);\n+    saveKeyStore(keystoreDirectory.resolve(\"validator.json\"), validatorKeyStoreData);\n+    saveKeyStore(keystoreDirectory.resolve(\"withdrawal.json\"), withdrawalKeyStoreData);", "originalCommit": "03b32062fc046834dd39d3b229c98dc06d0f76f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAzODc0MQ==", "url": "https://github.com/ConsenSys/teku/pull/1618#discussion_r411038741", "bodyText": "instead of directly using substring, may I suggest to introduce a method something on the lines of :\nString trimPublicKey(final String publicKey) {\n  if (publicKey.toLowerCase().startsWith(\"0x\")) {\n    return publicKey.substring(2,9); \n  } \n  return publicKey.substring(0, 7);\n}\n\nas the public key technically can start without \"0x\"", "author": "usmansaleem", "createdAt": "2020-04-20T01:26:03Z", "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/EncryptedKeystoreWriter.java", "diffHunk": "@@ -56,18 +56,13 @@ public void writeKeys(final BLSKeyPair validatorKey, final BLSKeyPair withdrawal\n     final KeyStoreData withdrawalKeyStoreData =\n         generateKeystoreData(withdrawalKey, withdrawalKeyPassword);\n \n-    saveKeyStore(\n-        keystoreDirectory.resolve(\"validator_\" + validatorKey.getPublicKey().toString() + \".json\"),\n-        validatorKeyStoreData);\n-    saveKeyStore(\n-        keystoreDirectory.resolve(\n-            \"withdrawal_\" + withdrawalKey.getPublicKey().toString() + \".json\"),\n-        withdrawalKeyStoreData);\n+    saveKeyStore(keystoreDirectory.resolve(\"validator.json\"), validatorKeyStoreData);\n+    saveKeyStore(keystoreDirectory.resolve(\"withdrawal.json\"), withdrawalKeyStoreData);\n   }\n \n   private Path createKeystoreDirectory(final BLSKeyPair validatorKey) {\n     final Path keystoreDirectory =\n-        outputPath.resolve(\"validator_\" + validatorKey.getPublicKey().toString());\n+        outputPath.resolve(\"validator_\" + validatorKey.getPublicKey().toString().substring(2, 9));", "originalCommit": "03b32062fc046834dd39d3b229c98dc06d0f76f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f813c2957bcff405d0b10293070156bc4e741ff3", "url": "https://github.com/ConsenSys/teku/commit/f813c2957bcff405d0b10293070156bc4e741ff3", "message": "cli/deposit: use trimmed pubkey in filename", "committedDate": "2020-04-22T11:27:22Z", "type": "commit"}, {"oid": "9061ed04a42ec371cc6d56e44bc7bdf8f15d10d8", "url": "https://github.com/ConsenSys/teku/commit/9061ed04a42ec371cc6d56e44bc7bdf8f15d10d8", "message": "Merge branch 'master' into q9-valid-path", "committedDate": "2020-04-22T11:28:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQxODA1NQ==", "url": "https://github.com/ConsenSys/teku/pull/1618#discussion_r413418055", "bodyText": "Why did these change to using abbreviations instead of the full validator and withdrawal prefix?", "author": "ajsutton", "createdAt": "2020-04-23T00:13:31Z", "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/EncryptedKeystoreWriter.java", "diffHunk": "@@ -56,18 +56,18 @@ public void writeKeys(final BLSKeyPair validatorKey, final BLSKeyPair withdrawal\n     final KeyStoreData withdrawalKeyStoreData =\n         generateKeystoreData(withdrawalKey, withdrawalKeyPassword);\n \n-    saveKeyStore(\n-        keystoreDirectory.resolve(\"validator_\" + validatorKey.getPublicKey().toString() + \".json\"),\n-        validatorKeyStoreData);\n-    saveKeyStore(\n-        keystoreDirectory.resolve(\n-            \"withdrawal_\" + withdrawalKey.getPublicKey().toString() + \".json\"),\n-        withdrawalKeyStoreData);\n+    final String validatorFileName =\n+        \"val_\" + trimPublicKey(validatorKey.getPublicKey().toString()) + \".json\";\n+    final String withdrawalFileName =\n+        \"wdr_\" + trimPublicKey(withdrawalKey.getPublicKey().toString()) + \".json\";", "originalCommit": "9061ed04a42ec371cc6d56e44bc7bdf8f15d10d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzOTI3NQ==", "url": "https://github.com/ConsenSys/teku/pull/1618#discussion_r414439275", "bodyText": "I tried to keep it short, shall I restore the full prefix?", "author": "q9f", "createdAt": "2020-04-24T09:39:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQxODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1NDk0OA==", "url": "https://github.com/ConsenSys/teku/pull/1618#discussion_r415154948", "bodyText": "Yeah unless there's some technical advantage to it being short I'd stick with the full prefix so it's easier for users to understand.", "author": "ajsutton", "createdAt": "2020-04-25T22:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQxODA1NQ=="}], "type": "inlineReview"}, {"oid": "8c20c02a14f71762907148ccc677aa04eb3530de", "url": "https://github.com/ConsenSys/teku/commit/8c20c02a14f71762907148ccc677aa04eb3530de", "message": "cli/deposit: restore full destination in filename", "committedDate": "2020-04-26T08:31:59Z", "type": "commit"}, {"oid": "61d0ea21433cb0bd772fa6c7713f632b74c6d334", "url": "https://github.com/ConsenSys/teku/commit/61d0ea21433cb0bd772fa6c7713f632b74c6d334", "message": "Merge branch 'master' into q9-valid-path", "committedDate": "2020-04-26T08:32:32Z", "type": "commit"}]}