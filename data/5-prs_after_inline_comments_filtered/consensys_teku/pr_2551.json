{"pr_number": 2551, "pr_title": "Restrict size of epoch parameter so that it can be converted to slot without overflow", "pr_createdAt": "2020-08-11T04:46:33Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2551", "timeline": [{"oid": "59f1b7b17d7056bc7ff6a78bfd3fd69a9d06d8e7", "url": "https://github.com/ConsenSys/teku/commit/59f1b7b17d7056bc7ff6a78bfd3fd69a9d06d8e7", "message": "Restrict size of epoch parameter so that it can be converted to slot without overflowing a uint64.", "committedDate": "2020-08-11T04:41:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyNzYyMg==", "url": "https://github.com/ConsenSys/teku/pull/2551#discussion_r468327622", "bodyText": "can we just store UInt64.MAX_VALUE.dividedBy(Constants.SLOTS_PER_EPOCH)) as a const? it's going to potentially happen a lot...", "author": "rolfyone", "createdAt": "2020-08-11T05:02:02Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/SingleQueryParameterUtils.java", "diffHunk": "@@ -74,12 +75,23 @@ public static UInt64 getParameterValueAsUInt64(\n     }\n   }\n \n+  public static UInt64 getParameterValueAsEpoch(\n+      final Map<String, List<String>> parameterMap, final String key)\n+      throws IllegalArgumentException {\n+    final UInt64 value = getParameterValueAsUInt64(parameterMap, key);\n+    // Restrict valid epoch values to ones that can be converted to slot without overflowing\n+    if (value.isGreaterThan(UInt64.MAX_VALUE.dividedBy(Constants.SLOTS_PER_EPOCH))) {", "originalCommit": "59f1b7b17d7056bc7ff6a78bfd3fd69a9d06d8e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMzNjExMg==", "url": "https://github.com/ConsenSys/teku/pull/2551#discussion_r468336112", "bodyText": "It will happen at most once per RPC request and it equates to dividing a long, so we don't need to worry about the performance.\nI tend to avoid putting Constants values into constants because ironically, they aren't actually constant - they're defined by the network definition. Constants get set very early on in the startup sequence so generally they have the right values before static initialisers run but there's nothing that guarantees that and it always makes me worry that they'll get initialised in the wrong order and cause trouble.", "author": "ajsutton", "createdAt": "2020-08-11T05:34:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyNzYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyODU4Mw==", "url": "https://github.com/ConsenSys/teku/pull/2551#discussion_r468328583", "bodyText": "the endpoint creating this request should probably be calling the above query util to get the epoch argument? then this check is probably not required as its already validated...", "author": "rolfyone", "createdAt": "2020-08-11T05:05:51Z", "path": "data/serializer/src/main/java/tech/pegasys/teku/api/schema/ValidatorsRequest.java", "diffHunk": "@@ -36,5 +37,10 @@ public ValidatorsRequest(\n       @JsonProperty(value = \"pubkeys\", required = true) final List<BLSPubKey> pubkeys) {\n     this.epoch = epoch;\n     this.pubkeys = pubkeys;\n+    // Restrict valid epoch values to ones that can be converted to slot without overflowing\n+    if (epoch != null\n+        && epoch.isGreaterThan(UInt64.MAX_VALUE.dividedBy(Constants.SLOTS_PER_EPOCH))) {\n+      throw new IllegalArgumentException(\"Epoch is too large.\");\n+    }", "originalCommit": "59f1b7b17d7056bc7ff6a78bfd3fd69a9d06d8e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyODc5OQ==", "url": "https://github.com/ConsenSys/teku/pull/2551#discussion_r468328799", "bodyText": "actually, it must be json parsing input, never mind, we'll need to do this here.", "author": "rolfyone", "createdAt": "2020-08-11T05:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyODU4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMzMzkwMw==", "url": "https://github.com/ConsenSys/teku/pull/2551#discussion_r468333903", "bodyText": "Yep, and I couldn't even reuse the code because it was in different modules. :(", "author": "ajsutton", "createdAt": "2020-08-11T05:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyODU4Mw=="}], "type": "inlineReview"}]}