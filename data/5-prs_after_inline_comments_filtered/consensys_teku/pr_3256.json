{"pr_number": 3256, "pr_title": "implement remote validator acceptance test", "pr_createdAt": "2020-11-19T00:11:03Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3256", "timeline": [{"oid": "e8f906d9afd09650aa5e11aaef495365ff85b055", "url": "https://github.com/ConsenSys/teku/commit/e8f906d9afd09650aa5e11aaef495365ff85b055", "message": "implement remote validator acceptance test\n\n - Shows attestation, aggregation, block production occurring from a remote validator node, and the beacon node not having ownership of any validators.\n\nfixes #3247\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T00:09:25Z", "type": "commit"}, {"oid": "34df73621594a9685a7d9dea9c05760be818c8d2", "url": "https://github.com/ConsenSys/teku/commit/34df73621594a9685a7d9dea9c05760be818c8d2", "message": "Merge remote-tracking branch 'upstream/master' into 3247", "committedDate": "2020-11-19T00:09:48Z", "type": "commit"}, {"oid": "6b8069edf4b1e38080460b9425ae54701cedc9d7", "url": "https://github.com/ConsenSys/teku/commit/6b8069edf4b1e38080460b9425ae54701cedc9d7", "message": "Merge remote-tracking branch 'upstream/master' into 3247", "committedDate": "2020-11-19T00:18:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxODQyOQ==", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r526518429", "bodyText": "nit: Either need to make the name camel case or make this static constant at the top of the file.", "author": "ajsutton", "createdAt": "2020-11-19T00:46:44Z", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.test.acceptance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.test.acceptance.dsl.AcceptanceTestBase;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuNode;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuValidatorNode;\n+\n+public class RemoteValidatorAcceptanceTest extends AcceptanceTestBase {\n+  @Test\n+  void shouldCreateAttestationsWithRemoteValidator() throws Exception {\n+    final int VALIDATOR_COUNT = 8;", "originalCommit": "6b8069edf4b1e38080460b9425ae54701cedc9d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxODk1Mg==", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r526518952", "bodyText": "nit: I'd probably call this beaconNode and validatorNode1  validatorClient since that's the typical terms we'd use for this kind of setup.", "author": "ajsutton", "createdAt": "2020-11-19T00:48:18Z", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.test.acceptance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.test.acceptance.dsl.AcceptanceTestBase;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuNode;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuValidatorNode;\n+\n+public class RemoteValidatorAcceptanceTest extends AcceptanceTestBase {\n+  @Test\n+  void shouldCreateAttestationsWithRemoteValidator() throws Exception {\n+    final int VALIDATOR_COUNT = 8;\n+    final TekuNode node1 =", "originalCommit": "6b8069edf4b1e38080460b9425ae54701cedc9d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMDM0Mw==", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r526520343", "bodyText": "Rather than waiting for 3 slots then checking logs, we should just have a waiter that looks for these logs and retries for some period of time.  It's possible the beacon node can startup faster than the validator node and process 3 slots before the validator even gets started and if we find the log messages earlier we can bail out.\nI'd also just look for one of them - if we can successfully publish we're ok.", "author": "ajsutton", "createdAt": "2020-11-19T00:52:27Z", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.test.acceptance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.test.acceptance.dsl.AcceptanceTestBase;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuNode;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuValidatorNode;\n+\n+public class RemoteValidatorAcceptanceTest extends AcceptanceTestBase {\n+  @Test\n+  void shouldCreateAttestationsWithRemoteValidator() throws Exception {\n+    final int VALIDATOR_COUNT = 8;\n+    final TekuNode node1 =\n+        createTekuNode(\n+            config ->\n+                config\n+                    .withNetwork(\"minimal\")\n+                    .withInteropNumberOfValidators(VALIDATOR_COUNT)\n+                    .withInteropValidators(0, 0)\n+                    .withRestHostsAllowed(\"*\"));\n+\n+    final TekuValidatorNode validatorNode1 =\n+        createValidatorNode(\n+            config ->\n+                config\n+                    .withNetwork(\"minimal\")\n+                    .withInteropValidators(0, VALIDATOR_COUNT)\n+                    .withBeaconNodeEndpoint(node1.getBeaconRestApiUrl()));\n+\n+    node1.start();\n+    validatorNode1.start();\n+    node1.waitForSlot(3);\n+\n+    assertThat(validatorNode1.getLoggedErrors()).isEmpty();\n+    assertThat(validatorNode1.getFilteredOutput(\"Published aggregate\").size())\n+        .isGreaterThanOrEqualTo(2);\n+    assertThat(validatorNode1.getFilteredOutput(\"Published attestation\").size())\n+        .isGreaterThanOrEqualTo(2);\n+    assertThat(validatorNode1.getFilteredOutput(\"Published block\").size())\n+        .isGreaterThanOrEqualTo(2);", "originalCommit": "6b8069edf4b1e38080460b9425ae54701cedc9d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8819dbd651893290e8138feb0fbee0eb8c18cb4f", "url": "https://github.com/ConsenSys/teku/commit/8819dbd651893290e8138feb0fbee0eb8c18cb4f", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T01:04:56Z", "type": "commit"}, {"oid": "21fa4c6c48bfd08033632585a8efdca8350519ee", "url": "https://github.com/ConsenSys/teku/commit/21fa4c6c48bfd08033632585a8efdca8350519ee", "message": "add test case for validators available before beacon node is up.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T01:43:17Z", "type": "commit"}, {"oid": "41e5d7f0954e6e004245276169f82e8c117ddf4a", "url": "https://github.com/ConsenSys/teku/commit/41e5d7f0954e6e004245276169f82e8c117ddf4a", "message": "Merge remote-tracking branch 'upstream/master' into 3247", "committedDate": "2020-11-19T01:49:05Z", "type": "commit"}, {"oid": "7d1a12742593c69420067a32b788580ef75101c3", "url": "https://github.com/ConsenSys/teku/commit/7d1a12742593c69420067a32b788580ef75101c3", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T02:16:49Z", "type": "commit"}, {"oid": "99136e1bfc68a287ddf11212bf5e48b1f13c0567", "url": "https://github.com/ConsenSys/teku/commit/99136e1bfc68a287ddf11212bf5e48b1f13c0567", "message": "set the connection retry maximum duration to be the seconds-per-slot time.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T05:37:09Z", "type": "commit"}, {"oid": "138657ad9bab9c853f3e477873449257877ec5fd", "url": "https://github.com/ConsenSys/teku/commit/138657ad9bab9c853f3e477873449257877ec5fd", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T05:42:10Z", "type": "commit"}, {"oid": "de53c2059e83950a525bcba02ef02b5719e7adc7", "url": "https://github.com/ConsenSys/teku/commit/de53c2059e83950a525bcba02ef02b5719e7adc7", "message": "initial fix for remote validator starting first, and the trouble that can occur.\n\nbefore the fix there are no attestations in the `shouldCreateAttestationsWithRemoteValidatorStartingFirst` test, and after, attestations are created from slot 1.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T08:08:29Z", "type": "commit"}, {"oid": "5159beed58a19bb1ca8a9ed8b7b73a1a4886b2cf", "url": "https://github.com/ConsenSys/teku/commit/5159beed58a19bb1ca8a9ed8b7b73a1a4886b2cf", "message": "Merge branch 'master' into 3247", "committedDate": "2020-11-19T19:54:04Z", "type": "commit"}, {"oid": "e5265afcf6e8ad8a9615e0897628db0b3d46c94b", "url": "https://github.com/ConsenSys/teku/commit/e5265afcf6e8ad8a9615e0897628db0b3d46c94b", "message": "now that the remote validator starting first is working, I can remove the extra message search and extended wait for messages.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T20:21:16Z", "type": "commit"}, {"oid": "1da4948427989dd8ff1b761d300b44c67b22ede7", "url": "https://github.com/ConsenSys/teku/commit/1da4948427989dd8ff1b761d300b44c67b22ede7", "message": "cleanup\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T20:29:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2Nzc1MQ==", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r526567751", "bodyText": "We probably should query the API for this rather than looking for log messages.  Log messages are basically a last resort when we can't find the info by another means (or if we're really specifically after a log message).\nI don't think this method is being used anymore anyway.", "author": "ajsutton", "createdAt": "2020-11-19T03:18:18Z", "path": "acceptance-tests/src/testFixtures/java/tech/pegasys/teku/test/acceptance/dsl/TekuNode.java", "diffHunk": "@@ -158,6 +145,10 @@ public void waitForNewBlock() {\n     waitFor(() -> assertThat(fetchBeaconHead().get()).isNotEqualTo(startingBlockRoot));\n   }\n \n+  public void waitForSlot(final long slot) {\n+    waitFor(() -> assertThat(getFilteredOutput(\"Slot: \" + slot + \",\")).isNotEmpty(), 1, MINUTES);\n+  }", "originalCommit": "7d1a12742593c69420067a32b788580ef75101c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2ODg5NA==", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r526568894", "bodyText": "I suspect we should just default this to * in ATs so we don't have to worry about it.", "author": "ajsutton", "createdAt": "2020-11-19T03:21:52Z", "path": "acceptance-tests/src/testFixtures/java/tech/pegasys/teku/test/acceptance/dsl/TekuNode.java", "diffHunk": "@@ -417,8 +414,9 @@ public Config withDepositsFrom(final BesuNode eth1Node) {\n       return this;\n     }\n \n-    public Config withValidatorKeys(final String validatorKeys) {\n-      this.validatorKeys = Optional.of(validatorKeys);\n+    public Config withRestHostsAllowed(final String allowList) {\n+      LOG.debug(\"rest-api-host-allowlist:\" + allowList);\n+      configMap.put(\"rest-api-host-allowlist\", allowList);\n       return this;\n     }", "originalCommit": "7d1a12742593c69420067a32b788580ef75101c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI0NTMwMA==", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r527245300", "bodyText": "Probably better to do this in a @BeforeEach method and make beaconNode and validatorClient fields.", "author": "ajsutton", "createdAt": "2020-11-19T22:25:46Z", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.test.acceptance;\n+\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.test.acceptance.dsl.AcceptanceTestBase;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuNode;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuValidatorNode;\n+\n+public class RemoteValidatorAcceptanceTest extends AcceptanceTestBase {\n+  static final int VALIDATOR_COUNT = 8;\n+\n+  @Test\n+  void shouldCreateAttestationsWithRemoteValidator() throws Exception {\n+    final TekuNode beaconNode = getBeaconNode();\n+    final TekuValidatorNode validatorClient = getValidatorClient(beaconNode.getBeaconRestApiUrl());\n+\n+    beaconNode.start();\n+    validatorClient.start();\n+\n+    validatorClient.waitForLogMessageContaining(\"Published block\");\n+    validatorClient.waitForLogMessageContaining(\"Published attestation\");\n+    validatorClient.waitForLogMessageContaining(\"Published aggregate\");\n+  }\n+\n+  @Test\n+  void shouldCreateAttestationsWithRemoteValidatorStartingFirst() throws Exception {\n+\n+    final TekuNode beaconNode = getBeaconNode();\n+    final TekuValidatorNode validatorClient = getValidatorClient(beaconNode.getBeaconRestApiUrl());\n+\n+    validatorClient.start();\n+    validatorClient.waitForLogMessageContaining(\n+        \"Error while connecting to beacon node event stream\");\n+\n+    beaconNode.start();\n+\n+    validatorClient.waitForLogMessageContaining(\"Connected to EventSource stream\");\n+    validatorClient.waitForLogMessageContaining(\"Published block\");\n+    validatorClient.waitForLogMessageContaining(\"Published attestation\");\n+    validatorClient.waitForLogMessageContaining(\"Published aggregate\");\n+  }\n+\n+  private TekuNode getBeaconNode() {\n+    return createTekuNode(\n+        config ->\n+            config\n+                .withNetwork(\"minimal\")\n+                .withInteropNumberOfValidators(VALIDATOR_COUNT)\n+                .withInteropValidators(0, 0)\n+                .withRestHostsAllowed(\"*\"));\n+  }\n+\n+  private TekuValidatorNode getValidatorClient(final String beaconRestUrl) {\n+    return createValidatorNode(\n+        config ->\n+            config\n+                .withNetwork(\"minimal\")\n+                .withInteropValidators(0, VALIDATOR_COUNT)\n+                .withBeaconNodeEndpoint(beaconRestUrl));\n+  }", "originalCommit": "1da4948427989dd8ff1b761d300b44c67b22ede7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "243eeb2c26d7258482d071fe5af8ab97cf0ef2c6", "url": "https://github.com/ConsenSys/teku/commit/243eeb2c26d7258482d071fe5af8ab97cf0ef2c6", "message": "Revert \"initial fix for remote validator starting first, and the trouble that can occur.\"\n\nThis reverts commit de53c205\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T22:56:51Z", "type": "commit"}, {"oid": "7cd35d2d48203ae193c5a47ef8249397193a6f21", "url": "https://github.com/ConsenSys/teku/commit/7cd35d2d48203ae193c5a47ef8249397193a6f21", "message": "review comments.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T22:57:40Z", "type": "commit"}, {"oid": "8c5344d76d089c3802e6a070bde3a90602ef3d3d", "url": "https://github.com/ConsenSys/teku/commit/8c5344d76d089c3802e6a070bde3a90602ef3d3d", "message": "Merge remote-tracking branch 'upstream/master' into 3247", "committedDate": "2020-11-19T23:15:38Z", "type": "commit"}, {"oid": "32bb757c4ba900d8124e953e4c38ea8b477d0d8b", "url": "https://github.com/ConsenSys/teku/commit/32bb757c4ba900d8124e953e4c38ea8b477d0d8b", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T23:18:36Z", "type": "commit"}, {"oid": "5128753c1c75422789366b9e7486e02d9ee7c1e7", "url": "https://github.com/ConsenSys/teku/commit/5128753c1c75422789366b9e7486e02d9ee7c1e7", "message": "increase timeout as CI seems to be running slower than local pc.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-19T23:45:04Z", "type": "commit"}, {"oid": "61c7caba33b179d83ab9c278000c2780aefede4a", "url": "https://github.com/ConsenSys/teku/commit/61c7caba33b179d83ab9c278000c2780aefede4a", "message": "Merge branch 'master' into 3247", "committedDate": "2020-11-20T00:32:09Z", "type": "commit"}]}