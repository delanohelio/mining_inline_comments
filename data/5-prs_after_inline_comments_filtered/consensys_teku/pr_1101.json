{"pr_number": 1101, "pr_title": "[BC-220] Don't drop unattached blocks", "pr_createdAt": "2020-01-21T20:29:56Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1101", "timeline": [{"oid": "f01736004726880efe9b91292a6e82c0a793638b", "url": "https://github.com/ConsenSys/teku/commit/f01736004726880efe9b91292a6e82c0a793638b", "message": "Post block events for blocks with unknown prestate", "committedDate": "2020-01-21T19:39:48Z", "type": "commit"}, {"oid": "6cd0f53f2024818b75ccc084f15ab80e1fcb3503", "url": "https://github.com/ConsenSys/teku/commit/6cd0f53f2024818b75ccc084f15ab80e1fcb3503", "message": "Don't gossip future blocks", "committedDate": "2020-01-21T20:11:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzNDk2OA==", "url": "https://github.com/ConsenSys/teku/pull/1101#discussion_r369234968", "bodyText": "It feels very weird to say the data is invalid but process it anyway.  Kind of have to with the way gossip works but still awkward. Just something to ponder in the back of our minds about how it could be done better.", "author": "ajsutton", "createdAt": "2020-01-21T20:48:19Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/BlockTopicHandler.java", "diffHunk": "@@ -62,14 +66,23 @@ protected SignedBeaconBlock deserialize(final Bytes bytes) throws SSZException {\n \n   @Override\n   protected boolean validateData(final SignedBeaconBlock block) {\n+    if (chainStorageClient.isPreGenesis()) {\n+      // We can't process blocks pre-genesis\n+      return false;\n+    }\n+\n     final BeaconState preState =\n         chainStorageClient.getStore().getBlockState(block.getMessage().getParent_root());\n     if (preState == null) {\n-      // TODO - handle future and unattached blocks\n-      LOG.warn(\n-          \"Dropping block message at slot {} with unknown parent state {}\",\n-          block.getMessage().getSlot(),\n-          block.getMessage().getParent_root());\n+      // Post event even if we don't have the prestate\n+      eventBus.post(createEvent(block));\n+      return false;\n+    }\n+\n+    final UnsignedLong currentSlot = get_current_slot(chainStorageClient.getStore());\n+    if (block.getSlot().compareTo(currentSlot) > 0) {\n+      // Don't gossip future blocks\n+      eventBus.post(createEvent(block));", "originalCommit": "6cd0f53f2024818b75ccc084f15ab80e1fcb3503", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI3MDIxNw==", "url": "https://github.com/ConsenSys/teku/pull/1101#discussion_r369270217", "bodyText": "yeah - it's not great.  i was thinking of reworking the API to surface some kind of GossipMessage object with some API methods like doNotRegossip, regossip or something but I felt like it wasn't worth digging into right now.", "author": "mbaxter", "createdAt": "2020-01-21T22:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzNDk2OA=="}], "type": "inlineReview"}, {"oid": "f86ec1903e948b0eb8894cd9d1aad2a8ad9a40e0", "url": "https://github.com/ConsenSys/teku/commit/f86ec1903e948b0eb8894cd9d1aad2a8ad9a40e0", "message": "Fix ordering of block validation checks", "committedDate": "2020-01-21T21:59:42Z", "type": "commit"}, {"oid": "25bf937aad19e322f0fbf53db7f765ccc4e645eb", "url": "https://github.com/ConsenSys/teku/commit/25bf937aad19e322f0fbf53db7f765ccc4e645eb", "message": "Update integration tests to support block slot validation", "committedDate": "2020-01-21T22:00:16Z", "type": "commit"}, {"oid": "8e405f06bac81a1c502b02cf738bd29e206ad846", "url": "https://github.com/ConsenSys/teku/commit/8e405f06bac81a1c502b02cf738bd29e206ad846", "message": "Merge branch 'master' into bc-220/dont-drop-unattached-blocks", "committedDate": "2020-01-21T22:10:22Z", "type": "commit"}]}