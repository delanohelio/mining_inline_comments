{"pr_number": 2074, "pr_title": "implement v1 rest api for version and identity.", "pr_createdAt": "2020-06-08T01:47:06Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2074", "timeline": [{"oid": "e35c353c6f50fe69763b4f74b401817aa718599e", "url": "https://github.com/ConsenSys/teku/commit/e35c353c6f50fe69763b4f74b401817aa718599e", "message": "implement v1 rest api for version and identity.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-06-08T01:45:39Z", "type": "commit"}, {"oid": "d467bb4705fad9d1e4c4f9670ec7c87109ce7cfa", "url": "https://github.com/ConsenSys/teku/commit/d467bb4705fad9d1e4c4f9670ec7c87109ce7cfa", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-06-08T01:51:34Z", "type": "commit"}, {"oid": "943e097f789b8d198f6cea525386a029d8115d53", "url": "https://github.com/ConsenSys/teku/commit/943e097f789b8d198f6cea525386a029d8115d53", "message": "Merge remote-tracking branch 'upstream/master' into v1-rest", "committedDate": "2020-06-08T01:51:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyODA1MA==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436428050", "bodyText": "I just noticed these methods start with a capital", "author": "macfarla", "createdAt": "2020-06-08T02:05:01Z", "path": "data/beaconrestapi/src/test/java/tech/pegasys/teku/beaconrestapi/BeaconRestApiTest.java", "diffHunk": "@@ -124,6 +125,16 @@ public void RestApiShouldHaveBeaconValidatorsEndpoint() {\n     verify(app).get(eq(GetValidators.ROUTE), any(GetValidators.class));\n   }\n \n+  @Test\n+  public void ShouldHaveV1VersionEndpoint() {", "originalCommit": "e35c353c6f50fe69763b4f74b401817aa718599e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyODcwMg==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436428702", "bodyText": "ah oops.", "author": "rolfyone", "createdAt": "2020-06-08T02:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyODA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyOTM0Nw==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436429347", "bodyText": "the whole file was like that, but i fixed it.", "author": "rolfyone", "createdAt": "2020-06-08T02:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyODA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyODE1MQ==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436428151", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        description = \"An object network identity of the node.\"),\n          \n          \n            \n                        description = \"Network identity of the node.\"),", "author": "macfarla", "createdAt": "2020-06-08T02:05:49Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/v1/node/GetIdentity.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.v1.node;\n+\n+import static tech.pegasys.teku.beaconrestapi.CacheControlUtils.CACHE_NONE;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.NO_CONTENT_PRE_GENESIS;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_NO_CONTENT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.TAG_V1_NODE;\n+\n+import io.javalin.core.util.Header;\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.teku.api.DataProvider;\n+import tech.pegasys.teku.api.NetworkDataProvider;\n+import tech.pegasys.teku.api.response.v1.node.Identity;\n+import tech.pegasys.teku.api.response.v1.node.IdentityResponse;\n+import tech.pegasys.teku.provider.JsonProvider;\n+\n+public class GetIdentity implements Handler {\n+  public static final String ROUTE = \"/v1/node/identity\";\n+  private final JsonProvider jsonProvider;\n+  private final NetworkDataProvider network;\n+\n+  public GetIdentity(final DataProvider provider, final JsonProvider jsonProvider) {\n+    this.jsonProvider = jsonProvider;\n+    this.network = provider.getNetworkDataProvider();\n+  }\n+\n+  GetIdentity(final NetworkDataProvider provider, final JsonProvider jsonProvider) {\n+    this.jsonProvider = jsonProvider;\n+    this.network = provider;\n+  }\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Retrieves data about the node's network presence.\",\n+      tags = {TAG_V1_NODE},\n+      responses = {\n+        @OpenApiResponse(\n+            status = RES_OK,\n+            content = @OpenApiContent(from = IdentityResponse.class),\n+            description = \"An object network identity of the node.\"),", "originalCommit": "e35c353c6f50fe69763b4f74b401817aa718599e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2510896dfe61690eff8084d6ac93db54d5a47eb2", "url": "https://github.com/ConsenSys/teku/commit/2510896dfe61690eff8084d6ac93db54d5a47eb2", "message": " - added new endpoints to changelog\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-06-08T02:09:05Z", "type": "commit"}, {"oid": "a7fc79eb0e2cbbdae01f1338ca687416880475ec", "url": "https://github.com/ConsenSys/teku/commit/a7fc79eb0e2cbbdae01f1338ca687416880475ec", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-06-08T02:13:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQzMzk3MQ==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436433971", "bodyText": "You can't create a new instance of this as it won't actually pick up the right values.  Need to add a getMetaData() to Eth2Network (and the implementation will actually wind up having to delegate to Eth2PeerManager).  NetworkDataProvider can be given an Eth2Network instead of a P2PNetwork so it has access to these kinds of Eth2 concepts without having to add them to the libp2p layer.", "author": "ajsutton", "createdAt": "2020-06-08T02:43:30Z", "path": "data/provider/src/main/java/tech/pegasys/teku/api/NetworkDataProvider.java", "diffHunk": "@@ -16,12 +16,15 @@\n import java.util.List;\n import java.util.Optional;\n import java.util.stream.Collectors;\n+import tech.pegasys.teku.api.schema.Metadata;\n+import tech.pegasys.teku.networking.eth2.rpc.beaconchain.methods.MetadataMessagesFactory;\n import tech.pegasys.teku.networking.p2p.network.P2PNetwork;\n import tech.pegasys.teku.networking.p2p.peer.NodeId;\n import tech.pegasys.teku.networking.p2p.peer.Peer;\n \n public class NetworkDataProvider {\n   private final P2PNetwork<?> p2pNetwork;\n+  private final MetadataMessagesFactory metadataMessageFactory = new MetadataMessagesFactory();", "originalCommit": "a7fc79eb0e2cbbdae01f1338ca687416880475ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0NjYwMQ==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436446601", "bodyText": "yep didnt think this bit was right, that's what i was stuck on - perfect.", "author": "rolfyone", "createdAt": "2020-06-08T04:00:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQzMzk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQzNTAwMg==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436435002", "bodyText": "The discovery advertised address is not fixed at startup - it can be updated based on discv5 messages we receive (e.g. if we move to a different network out external IP might change).  It should always be retrieved from the local node record and not stored.\nAlso MultiaddrUtil is currently designed just for TCP (hard codes /tcp/ in the address) but discovery is UDP.", "author": "ajsutton", "createdAt": "2020-06-08T02:50:04Z", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/discovery/discv5/DiscV5Service.java", "diffHunk": "@@ -25,24 +28,29 @@\n import org.ethereum.beacon.discovery.schema.NodeStatus;\n import tech.pegasys.teku.networking.p2p.discovery.DiscoveryPeer;\n import tech.pegasys.teku.networking.p2p.discovery.DiscoveryService;\n+import tech.pegasys.teku.networking.p2p.libp2p.MultiaddrUtil;\n+import tech.pegasys.teku.networking.p2p.network.NetworkConfig;\n import tech.pegasys.teku.service.serviceutils.Service;\n import tech.pegasys.teku.util.async.SafeFuture;\n \n public class DiscV5Service extends Service implements DiscoveryService {\n \n   private final DiscoverySystem discoverySystem;\n+  private final Multiaddr advertisedAddr;\n \n-  public DiscV5Service(final DiscoverySystem discoverySystem) {\n+  private DiscV5Service(final DiscoverySystem discoverySystem, NetworkConfig config) {\n     this.discoverySystem = discoverySystem;\n+    final byte[] nodeId = discoverySystem.getLocalNodeRecord().getNodeId().toArray();\n+    this.advertisedAddr = getAdvertisedAddr(config, nodeId);", "originalCommit": "a7fc79eb0e2cbbdae01f1338ca687416880475ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQzOTUwMQ==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436439501", "bodyText": "It's really unclear what the result of this is actually meant to be. I've never seen anything that defines how to encode a discovery ENR as a multiaddr correctly which is what this is trying to do.  Best I can see is that we use:\nfinal NodeRecord nodeRecord = discoverySystem.getLocalNodeRecord();\nif (nodeRecord.getUdpAddress().isEmpty() {\n  return Optional.empty();\n}\nfinal DiscoveryPeer discoveryPeer = new DiscoveryPeer(((Bytes) nodeRecord.get(EnrField.PKEY_SECP256K1), nodeRecord.getUdpAddress().get(), Optional.empty());\n\nreturn MultiaddrUtil.fromDiscoveryPeer(discoveryPeer); // But this needs to be a new variant that uses /udp/ not /tcp/", "author": "ajsutton", "createdAt": "2020-06-08T03:17:55Z", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/discovery/discv5/DiscV5Service.java", "diffHunk": "@@ -83,6 +91,21 @@ public static DiscoveryService create(\n     return Optional.of(discoverySystem.getLocalNodeRecord().asEnr());\n   }\n \n+  @Override\n+  public Optional<String> getDiscoveryAddress() {\n+    return Optional.of(advertisedAddr.toString());", "originalCommit": "a7fc79eb0e2cbbdae01f1338ca687416880475ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQzOTg3Ng==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436439876", "bodyText": "You just can't use the resulting multiaddr for anything useful because you don't have the public key of the node record and this will actually wind up including a hash of the public key.", "author": "ajsutton", "createdAt": "2020-06-08T03:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQzOTUwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0MTQ1Ng==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436441456", "bodyText": "I'm not convinced this code belongs in MultiaddrUtil - it doesn't actually have anything to do with Multiaddres (just our config and InetSocketAddress).  It wouldn't need to move if we're getting the discv5 address from the local node record.", "author": "ajsutton", "createdAt": "2020-06-08T03:30:06Z", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/LibP2PNetwork.java", "diffHunk": "@@ -224,15 +223,7 @@ private Gossip createGossip() {\n \n   private Multiaddr getAdvertisedAddr(NetworkConfig config, final NodeId nodeId) {\n     try {\n-      final InetSocketAddress advertisedAddress =\n-          new InetSocketAddress(config.getAdvertisedIp(), config.getAdvertisedPort());\n-      final InetSocketAddress resolvedAddress;\n-      if (advertisedAddress.getAddress().isAnyLocalAddress()) {\n-        resolvedAddress =\n-            new InetSocketAddress(InetAddress.getLocalHost(), advertisedAddress.getPort());\n-      } else {\n-        resolvedAddress = advertisedAddress;\n-      }\n+      final InetSocketAddress resolvedAddress = MultiaddrUtil.getResolvedInetSocketAddress(config);", "originalCommit": "a7fc79eb0e2cbbdae01f1338ca687416880475ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0MTgwNQ==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r436441805", "bodyText": "We should avoid using byte[] for nodeId - it makes it very unclear what type of node ID it actually is (discv5 and libp2p have very different node IDs).  NodeId is an interface for that purpose but at the moment I have no idea what the spec actually wants for the discovery node ID.", "author": "ajsutton", "createdAt": "2020-06-08T03:31:57Z", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/MultiaddrUtil.java", "diffHunk": "@@ -45,10 +48,33 @@ public static Multiaddr fromInetSocketAddress(\n     return addPeerId(fromInetSocketAddress(address), nodeId);\n   }\n \n+  public static InetSocketAddress getResolvedInetSocketAddress(NetworkConfig config)\n+      throws UnknownHostException {\n+    final InetSocketAddress advertisedAddress =\n+        new InetSocketAddress(config.getAdvertisedIp(), config.getAdvertisedPort());\n+    final InetSocketAddress resolvedAddress;\n+    if (advertisedAddress.getAddress().isAnyLocalAddress()) {\n+      resolvedAddress =\n+          new InetSocketAddress(InetAddress.getLocalHost(), advertisedAddress.getPort());\n+    } else {\n+      resolvedAddress = advertisedAddress;\n+    }\n+    return resolvedAddress;\n+  }\n+\n+  public static Multiaddr fromInetSocketAddress(\n+      final InetSocketAddress address, final byte[] nodeId) {", "originalCommit": "a7fc79eb0e2cbbdae01f1338ca687416880475ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2d078ae97033ce800c4b5dec7dcd6c5d7382d3b2", "url": "https://github.com/ConsenSys/teku/commit/2d078ae97033ce800c4b5dec7dcd6c5d7382d3b2", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-06-08T04:59:24Z", "type": "commit"}, {"oid": "5c011e135dfbf8c76657a777976016518f2a61df", "url": "https://github.com/ConsenSys/teku/commit/5c011e135dfbf8c76657a777976016518f2a61df", "message": "Merge remote-tracking branch 'upstream/master' into v1-rest", "committedDate": "2020-06-08T21:13:48Z", "type": "commit"}, {"oid": "b0fd0c57ff2fe409e284ebc477569abf48d3bfe8", "url": "https://github.com/ConsenSys/teku/commit/b0fd0c57ff2fe409e284ebc477569abf48d3bfe8", "message": "Merge remote-tracking branch 'upstream/master' into v1-rest", "committedDate": "2020-06-08T21:50:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyOTc1Nw==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r437029757", "bodyText": "We should probably make this return Optional or this is going to create a lot of surprises when p2p is disabled.", "author": "ajsutton", "createdAt": "2020-06-08T22:11:26Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/mock/NoOpEth2Network.java", "diffHunk": "@@ -27,4 +28,9 @@ public void unsubscribeFromAttestationSubnetId(final int subnetId) {}\n \n   @Override\n   public void setLongTermAttestationSubnetSubscriptions(final Iterable<Integer> subnetIndices) {}\n+\n+  @Override\n+  public MetadataMessage getMetadata() {\n+    return null;", "originalCommit": "b0fd0c57ff2fe409e284ebc477569abf48d3bfe8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyOTk0Nw==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r437029947", "bodyText": "Alternatively this can probably just return sequence 1 and all zeros for the subscribed subnets which is probably better.", "author": "ajsutton", "createdAt": "2020-06-08T22:12:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyOTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA0MTY5MA==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r437041690", "bodyText": "ok, there's a MetadataMessage.createDefault() which creates sequence 0 and all 0's for subscribed, so i've called that here. hopefully sequence 0 is fine...", "author": "rolfyone", "createdAt": "2020-06-08T22:44:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyOTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA0Mjk1Mw==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r437042953", "bodyText": "Yep, using that is a better idea. :)", "author": "ajsutton", "createdAt": "2020-06-08T22:48:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyOTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAzMDM2Nw==", "url": "https://github.com/ConsenSys/teku/pull/2074#discussion_r437030367", "bodyText": "nit: I'm be tempted to make this private and just have the two fromDiscoveryPeer methods use it internally.", "author": "ajsutton", "createdAt": "2020-06-08T22:13:09Z", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/MultiaddrUtil.java", "diffHunk": "@@ -30,19 +30,29 @@ public static Multiaddr fromDiscoveryPeer(final DiscoveryPeer peer) {\n     return fromInetSocketAddress(peer.getNodeAddress(), getNodeId(peer));\n   }\n \n+  public static Multiaddr fromDiscoveryPeerAsUdp(final DiscoveryPeer peer) {\n+    return addPeerId(fromInetSocketAddress(peer.getNodeAddress(), \"udp\"), getNodeId(peer));\n+  }\n+\n   public static Multiaddr fromInetSocketAddress(final InetSocketAddress address) {\n+    return fromInetSocketAddress(address, \"tcp\");\n+  }\n+\n+  public static Multiaddr fromInetSocketAddress(", "originalCommit": "b0fd0c57ff2fe409e284ebc477569abf48d3bfe8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "90f10d4e865ccaf3e806c1ff1f05b7dd07907ba1", "url": "https://github.com/ConsenSys/teku/commit/90f10d4e865ccaf3e806c1ff1f05b7dd07907ba1", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-06-08T22:26:33Z", "type": "commit"}, {"oid": "46f45984cac4e3483a84baf8098cda873b876069", "url": "https://github.com/ConsenSys/teku/commit/46f45984cac4e3483a84baf8098cda873b876069", "message": "Merge remote-tracking branch 'upstream/master' into v1-rest", "committedDate": "2020-06-08T22:44:49Z", "type": "commit"}]}