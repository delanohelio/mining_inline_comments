{"pr_number": 3370, "pr_title": "External signer upcheck", "pr_createdAt": "2020-12-07T06:31:22Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3370", "timeline": [{"oid": "4be29c569f4db1fc22aa641db7575a9184648858", "url": "https://github.com/ConsenSys/teku/commit/4be29c569f4db1fc22aa641db7575a9184648858", "message": "TLS configuration for external signer\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-18T03:20:12Z", "type": "commit"}, {"oid": "7af3e0d70367506a85dd0656d7a3bb464eebc09d", "url": "https://github.com/ConsenSys/teku/commit/7af3e0d70367506a85dd0656d7a3bb464eebc09d", "message": "Use SecureRandomProvider\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-18T03:29:26Z", "type": "commit"}, {"oid": "45c27e4a4fbde7cf48f5fbf22108d85e348b2e5c", "url": "https://github.com/ConsenSys/teku/commit/45c27e4a4fbde7cf48f5fbf22108d85e348b2e5c", "message": "modified validation condition and added unit test cases\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-19T01:25:55Z", "type": "commit"}, {"oid": "db8817bcf2d57a202989ff540da2e0abb41f4a06", "url": "https://github.com/ConsenSys/teku/commit/db8817bcf2d57a202989ff540da2e0abb41f4a06", "message": "more unit tests\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-19T01:38:18Z", "type": "commit"}, {"oid": "dcc96d80e75d779003f6ca33391b2d8be8ee780b", "url": "https://github.com/ConsenSys/teku/commit/dcc96d80e75d779003f6ca33391b2d8be8ee780b", "message": "refactor external signer httpclient factory to initialize validators\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-19T04:12:07Z", "type": "commit"}, {"oid": "e8ee76ce89c3b8b96cf32c00d357b2ce00cc74b0", "url": "https://github.com/ConsenSys/teku/commit/e8ee76ce89c3b8b96cf32c00d357b2ce00cc74b0", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-19T23:33:10Z", "type": "commit"}, {"oid": "50b442ab29bb1642799f24fe829c49aa950161e2", "url": "https://github.com/ConsenSys/teku/commit/50b442ab29bb1642799f24fe829c49aa950161e2", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-23T05:11:28Z", "type": "commit"}, {"oid": "fcfa97c8e90f8c19c1b3abe92c60f6c0626dde24", "url": "https://github.com/ConsenSys/teku/commit/fcfa97c8e90f8c19c1b3abe92c60f6c0626dde24", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-24T23:24:40Z", "type": "commit"}, {"oid": "ed5cc7e5dcff9d9995e9e529546ff868c54d9145", "url": "https://github.com/ConsenSys/teku/commit/ed5cc7e5dcff9d9995e9e529546ff868c54d9145", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-25T10:49:42Z", "type": "commit"}, {"oid": "e2a30ae131b80e812acc29078da8751e49216f69", "url": "https://github.com/ConsenSys/teku/commit/e2a30ae131b80e812acc29078da8751e49216f69", "message": "Add external signer upcheck at start up\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-25T12:20:55Z", "type": "commit"}, {"oid": "3a887ad8c7d10031f1a185c1f909a533b1204e63", "url": "https://github.com/ConsenSys/teku/commit/3a887ad8c7d10031f1a185c1f909a533b1204e63", "message": "fixing validator unit test case\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-25T12:59:29Z", "type": "commit"}, {"oid": "9cb79d029f5d38e4143c3ae58d70d5b3c18c680d", "url": "https://github.com/ConsenSys/teku/commit/9cb79d029f5d38e4143c3ae58d70d5b3c18c680d", "message": "simplifying comparison\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-25T20:49:54Z", "type": "commit"}, {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea", "url": "https://github.com/ConsenSys/teku/commit/326b72dcb311346fc18da0edf4a732297ea0fcea", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-30T00:18:07Z", "type": "commit"}, {"oid": "f3be45779314a75bbf94278ba40bd17e25e3fc5e", "url": "https://github.com/ConsenSys/teku/commit/f3be45779314a75bbf94278ba40bd17e25e3fc5e", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-12-06T23:39:16Z", "type": "commit"}, {"oid": "4b99d0f75ddd1ebc7c77cf749013b7f701d2bee2", "url": "https://github.com/ConsenSys/teku/commit/4b99d0f75ddd1ebc7c77cf749013b7f701d2bee2", "message": "reverting tls, keeping upcheck changes\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-12-07T04:49:11Z", "type": "commit"}, {"oid": "d68ca800e24ebe30a1fac545b00dc57936de46e9", "url": "https://github.com/ConsenSys/teku/commit/d68ca800e24ebe30a1fac545b00dc57936de46e9", "message": "External signer status logger\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-12-07T06:23:05Z", "type": "commit"}, {"oid": "6c5f98019c10b27b846c4ce5c904c46847100970", "url": "https://github.com/ConsenSys/teku/commit/6c5f98019c10b27b846c4ce5c904c46847100970", "message": "unit test\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-12-07T08:38:02Z", "type": "commit"}, {"oid": "39d1b8fd0332a0143d7940986ad6e1c3a90e218c", "url": "https://github.com/ConsenSys/teku/commit/39d1b8fd0332a0143d7940986ad6e1c3a90e218c", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_upcheck\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-12-07T08:40:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwNDA1Mw==", "url": "https://github.com/ConsenSys/teku/pull/3370#discussion_r537804053", "bodyText": "this is happening every 30 seconds, I can understand logging when it wasn't available and now it is back, but if it's been available I'd prefer this is a debug level... Most of the time this will equate to log noise...", "author": "rolfyone", "createdAt": "2020-12-07T20:19:20Z", "path": "infrastructure/logging/src/main/java/tech/pegasys/teku/infrastructure/logging/StatusLogger.java", "diffHunk": "@@ -236,6 +237,17 @@ public void eth1DepositChainIdMismatch(int expectedChainId, int eth1ChainId) {\n         eth1ChainId);\n   }\n \n+  public void externalSignerStatus(final URL externalSignerUrl, boolean isReachable) {\n+    if (isReachable) {\n+      log.info(\"External signer is reachable at {}\", externalSignerUrl);", "originalCommit": "39d1b8fd0332a0143d7940986ad6e1c3a90e218c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwNjQyNQ==", "url": "https://github.com/ConsenSys/teku/pull/3370#discussion_r537806425", "bodyText": "actually, it does look like this isn't every 30 seconds but on each change... if that's the case I'm happy \ud83d\udc4d", "author": "rolfyone", "createdAt": "2020-12-07T20:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwNDA1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMjcyMA==", "url": "https://github.com/ConsenSys/teku/pull/3370#discussion_r537902720", "bodyText": "yes, log all failures, once after every success.", "author": "usmansaleem", "createdAt": "2020-12-07T23:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwNDA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNjY0Ng==", "url": "https://github.com/ConsenSys/teku/pull/3370#discussion_r537836646", "bodyText": "Can we log the exception at debug level so we have a better idea why its failing if needed?", "author": "ajsutton", "createdAt": "2020-12-07T21:13:02Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/signer/ExternalSignerUpcheck.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.signer;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.net.http.HttpClient;\n+import java.net.http.HttpRequest;\n+import java.net.http.HttpResponse;\n+import java.time.Duration;\n+\n+public class ExternalSignerUpcheck {\n+  private final URL signingServiceUrl;\n+  private final Duration timeout;\n+  private final HttpClient httpClient;\n+\n+  public static final String UPCHECK_ENDPOINT = \"/upcheck\";\n+\n+  public ExternalSignerUpcheck(\n+      final HttpClient httpClient, final URL signingServiceUrl, final Duration timeout) {\n+    this.httpClient = httpClient;\n+    this.signingServiceUrl = signingServiceUrl;\n+    this.timeout = timeout;\n+  }\n+\n+  public boolean upcheck() {\n+    try {\n+      final HttpRequest request =\n+          HttpRequest.newBuilder()\n+              .uri(signingServiceUrl.toURI().resolve(UPCHECK_ENDPOINT))\n+              .timeout(timeout)\n+              .GET()\n+              .build();\n+      final HttpResponse<Void> response =\n+          httpClient.send(request, HttpResponse.BodyHandlers.discarding());\n+      return response.statusCode() == 200;\n+    } catch (final URISyntaxException | IOException | InterruptedException e) {\n+      return false;", "originalCommit": "39d1b8fd0332a0143d7940986ad6e1c3a90e218c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMjA3MA==", "url": "https://github.com/ConsenSys/teku/pull/3370#discussion_r537902070", "bodyText": "\ud83d\udc4d , separated the catch block to handle URISyntax and IO/Interrupted. Added the debug log.", "author": "usmansaleem", "createdAt": "2020-12-07T23:08:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNjY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkxMDA1Mw==", "url": "https://github.com/ConsenSys/teku/pull/3370#discussion_r537910053", "bodyText": "I don't think they need to be separated.  Just to be clear, we shouldn't ever silently swallow an exception.  So if it fails for any reason, we want a debug log showing that.", "author": "ajsutton", "createdAt": "2020-12-07T23:23:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNjY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkxMzgzMg==", "url": "https://github.com/ConsenSys/teku/pull/3370#discussion_r537913832", "bodyText": "Ah right, now I see the new code that makes sense.", "author": "ajsutton", "createdAt": "2020-12-07T23:28:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNjY0Ng=="}], "type": "inlineReview"}, {"oid": "9b1bd2b0aad20df130787f2282d9c956aabefb50", "url": "https://github.com/ConsenSys/teku/commit/9b1bd2b0aad20df130787f2282d9c956aabefb50", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_upcheck\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-12-07T23:01:01Z", "type": "commit"}, {"oid": "1462cdcb5eed2aa71f27e7839c0989d863e1a945", "url": "https://github.com/ConsenSys/teku/commit/1462cdcb5eed2aa71f27e7839c0989d863e1a945", "message": "review suggestion - debug log in upcheck exception handler\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-12-07T23:07:33Z", "type": "commit"}]}