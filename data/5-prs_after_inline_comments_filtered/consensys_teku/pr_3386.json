{"pr_number": 3386, "pr_title": "Use cached pre-states when importing blocks", "pr_createdAt": "2020-12-10T04:59:43Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3386", "timeline": [{"oid": "f3735020e2119b392437cd27ec7744440b1e82e2", "url": "https://github.com/ConsenSys/teku/commit/f3735020e2119b392437cd27ec7744440b1e82e2", "message": "Use cached pre-states when importing blocks.", "committedDate": "2020-12-10T04:54:47Z", "type": "commit"}, {"oid": "d8681a633cf215c3d14fb9e2a99ce14a35a80d98", "url": "https://github.com/ConsenSys/teku/commit/d8681a633cf215c3d14fb9e2a99ce14a35a80d98", "message": "Remove redundant check.", "committedDate": "2020-12-10T05:03:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0ODM0Nw==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r539848347", "bodyText": "Because the state has now already had slots processed up to the new block slot, the ancestry check is more complex.  We still need to ensure that block.getSlot() > getBlock(block.getParentRoot()).getSlot() but we don't have the actual parent block to get its slot.\nSo we check that:\n\nthe state we have is at the block slot (not ahead which indicates the block is invalid and not behind which suggests the caller didn't process empty slots\nthe block root at the slot before the block is the block's parent root. This ensures the block doesn't have the same slot as its parent.", "author": "ajsutton", "createdAt": "2020-12-10T05:06:26Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/ForkChoiceUtil.java", "diffHunk": "@@ -301,14 +292,20 @@ private static boolean isFinalizedAncestorOfJustified(\n \n   private static Optional<BlockImportResult> checkOnBlockConditions(\n       final BeaconBlock block,\n-      final BeaconState preState,\n+      final BeaconState blockSlotState,\n       final ReadOnlyStore store,\n       final ForkChoiceStrategy forkChoiceStrategy) {\n     final UInt64 blockSlot = block.getSlot();\n-    if (preState == null) {\n+    if (blockSlotState == null) {\n       return Optional.of(BlockImportResult.FAILED_UNKNOWN_PARENT);\n     }\n-    if (preState.getSlot().compareTo(blockSlot) >= 0) {\n+    if (!blockSlotState.getSlot().equals(blockSlot)) {\n+      return Optional.of(BlockImportResult.FAILED_INVALID_ANCESTRY);\n+    }\n+    if (blockSlot.isGreaterThan(UInt64.valueOf(GENESIS_SLOT))\n+        && !get_block_root_at_slot(blockSlotState, blockSlot.minus(1))\n+            .equals(block.getParentRoot())) {\n+      // Block is at same slot as its parent or the parent root doesn't match the state", "originalCommit": "d8681a633cf215c3d14fb9e2a99ce14a35a80d98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1ODMwNQ==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r539858305", "bodyText": "dont want this at error level? seems bad...", "author": "rolfyone", "createdAt": "2020-12-10T05:36:38Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/StateTransition.java", "diffHunk": "@@ -77,52 +76,52 @@ public BeaconState initiate(\n         preState,\n         signed_block,\n         validateStateRootAndSignatures,\n-        interimState -> {},\n         IndexedAttestationProvider.DIRECT_PROVIDER);\n   }\n \n   public BeaconState initiate(\n       BeaconState preState,\n-      SignedBeaconBlock signed_block,\n+      SignedBeaconBlock signedBlock,\n       boolean validateStateRootAndSignatures,\n-      final Consumer<BeaconState> beaconStateConsumer,\n       final IndexedAttestationProvider indexedAttestationProvider)\n       throws StateTransitionException {\n     try {\n-      BlockValidator blockValidator =\n-          validateStateRootAndSignatures ? this.blockValidator : BlockValidator.NOOP;\n-      final BeaconBlock block = signed_block.getMessage();\n-\n       // * Process slots (including those with no blocks) since block\n       // * beaconStateConsumer only consumes the missing slots here,\n       //   the new block will be processed when adding to the store.\n-      BeaconState postSlotState =\n-          process_slots(\n-              preState,\n-              block.getSlot(),\n-              state -> {\n-                if (!state.getSlot().equals(block.getSlot())) {\n-                  beaconStateConsumer.accept(state);\n-                }\n-              });\n+      BeaconState postSlotState = process_slots(preState, signedBlock.getMessage().getSlot());\n+\n+      return processAndValidateBlock(\n+          signedBlock, indexedAttestationProvider, postSlotState, validateStateRootAndSignatures);\n+    } catch (SlotProcessingException | EpochProcessingException | IllegalArgumentException e) {\n+      LOG.warn(\"State Transition error\", e);", "originalCommit": "d8681a633cf215c3d14fb9e2a99ce14a35a80d98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg4NDY4OQ==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r539884689", "bodyText": "It was always warn level.  I'm sceptical of logging and error and throwing it but figured trying to change that was outside the scope of this PR.", "author": "ajsutton", "createdAt": "2020-12-10T06:22:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1ODMwNQ=="}], "type": "inlineReview"}, {"oid": "c3345676d82979ad9ee5c936c7e6203888e1daff", "url": "https://github.com/ConsenSys/teku/commit/c3345676d82979ad9ee5c936c7e6203888e1daff", "message": "Remove unused variable.", "committedDate": "2020-12-10T06:25:15Z", "type": "commit"}, {"oid": "0510fc7bc4d7e86e388ca9320d006cb8afd65c8c", "url": "https://github.com/ConsenSys/teku/commit/0510fc7bc4d7e86e388ca9320d006cb8afd65c8c", "message": "Merge branch 'master' of github.com:ConsenSys/teku into use-cached-pre-state-for-block-import", "committedDate": "2020-12-10T06:25:43Z", "type": "commit"}, {"oid": "bd115f2fd75f353c08e1c828de3964337e8a64d5", "url": "https://github.com/ConsenSys/teku/commit/bd115f2fd75f353c08e1c828de3964337e8a64d5", "message": "Fix unit tests.\nPrune checkpoint states.", "committedDate": "2020-12-10T06:54:21Z", "type": "commit"}, {"oid": "ba0144c826ec936675d788e67b7077e842b1ddfb", "url": "https://github.com/ConsenSys/teku/commit/ba0144c826ec936675d788e67b7077e842b1ddfb", "message": "Fix ForkChoiseTestExecutor.", "committedDate": "2020-12-10T06:56:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMyMjM1NQ==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540322355", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                UInt64 slot = newBlockSlot.minus(1);\n          \n          \n            \n                UInt64 slot = newBlockSlot. minusMinZero(1);", "author": "mbaxter", "createdAt": "2020-12-10T16:40:28Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/StateRootCollector.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.statetransition.forkchoice;\n+\n+import static tech.pegasys.teku.util.config.Constants.SLOTS_PER_HISTORICAL_ROOT;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.datastructures.blocks.SlotAndBlockRoot;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZVector;\n+import tech.pegasys.teku.storage.store.UpdatableStore.StoreTransaction;\n+\n+public class StateRootCollector {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  public static void addParentStateRoots(\n+      final BeaconState blockSlotState, final StoreTransaction transaction) {\n+    final UInt64 newBlockSlot = blockSlotState.getSlot();\n+    final SSZVector<Bytes32> blockRoots = blockSlotState.getBlock_roots();\n+    final SSZVector<Bytes32> stateRoots = blockSlotState.getState_roots();\n+    final UInt64 minimumSlot = newBlockSlot.minusMinZero(SLOTS_PER_HISTORICAL_ROOT);\n+    // Get the parent block root from the state as the genesis block root is recorded as 0\n+    final Bytes32 parentBlockRoot =\n+        blockRoots.get(newBlockSlot.minusMinZero(1).mod(SLOTS_PER_HISTORICAL_ROOT).intValue());\n+    UInt64 slot = newBlockSlot.minus(1);", "originalCommit": "ba0144c826ec936675d788e67b7077e842b1ddfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ5MDYzMQ==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540490631", "bodyText": "This was originally designed to work just for block we're importing so the state could never be the genesis state because you can't import the genesis block (also why there's no test for it).  But I think it's probably worth just supporting any state in case this winds up being used somewhere else in the future - especially since it should be as simple as this change.", "author": "ajsutton", "createdAt": "2020-12-10T20:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMyMjM1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMzMTU0Mw==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540331543", "bodyText": "(optional) We could also prune these by slot (maybe less error-prone) in the finalizedChainData.ifPresent(...) block above.", "author": "mbaxter", "createdAt": "2020-12-10T16:51:55Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/store/StoreTransactionUpdates.java", "diffHunk": "@@ -98,6 +98,8 @@ public void applyToStore(final Store store) {\n         (root) -> {\n           store.blocks.remove(root);\n           store.states.remove(root);\n+          store.checkpointStates.removeIf(", "originalCommit": "ba0144c826ec936675d788e67b7077e842b1ddfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ5MjMwMg==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540492302", "bodyText": "Hmm, removing by slot would leave around states that are based on a block which didn't wind up in the finalized chain but then we processed empty slots into the current epoch.  Current version potentially removes states which are based off the latest finalized block.  So I think we ultimately want to prune by root but ensure we keep states with the latest finalized root.", "author": "ajsutton", "createdAt": "2020-12-10T20:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMzMTU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU2NTcwOA==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540565708", "bodyText": "Confirmed that we never prune the finalized block root (which makes sense since we need it around for a lot of things). So I think this works out exactly how we want it to.", "author": "ajsutton", "createdAt": "2020-12-10T23:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMzMTU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMzNTkxMQ==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540335911", "bodyText": "(optional) I think if we just make process_slots tolerant of states at the target slot, we could still run everything through initiate.", "author": "mbaxter", "createdAt": "2020-12-10T16:57:30Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/StateTransition.java", "diffHunk": "@@ -77,52 +76,52 @@ public BeaconState initiate(\n         preState,\n         signed_block,\n         validateStateRootAndSignatures,\n-        interimState -> {},\n         IndexedAttestationProvider.DIRECT_PROVIDER);\n   }\n \n   public BeaconState initiate(\n       BeaconState preState,\n-      SignedBeaconBlock signed_block,\n+      SignedBeaconBlock signedBlock,\n       boolean validateStateRootAndSignatures,\n-      final Consumer<BeaconState> beaconStateConsumer,\n       final IndexedAttestationProvider indexedAttestationProvider)\n       throws StateTransitionException {\n     try {\n-      BlockValidator blockValidator =\n-          validateStateRootAndSignatures ? this.blockValidator : BlockValidator.NOOP;\n-      final BeaconBlock block = signed_block.getMessage();\n-\n       // * Process slots (including those with no blocks) since block\n       // * beaconStateConsumer only consumes the missing slots here,\n       //   the new block will be processed when adding to the store.\n-      BeaconState postSlotState =\n-          process_slots(\n-              preState,\n-              block.getSlot(),\n-              state -> {\n-                if (!state.getSlot().equals(block.getSlot())) {\n-                  beaconStateConsumer.accept(state);\n-                }\n-              });\n+      BeaconState postSlotState = process_slots(preState, signedBlock.getMessage().getSlot());", "originalCommit": "ba0144c826ec936675d788e67b7077e842b1ddfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ5NDI0Nw==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540494247", "bodyText": "Yeah that was the way I went initially and it does work but makes me very nervous that it would accept a block with the same slot as its parent.  Having an explicit method felt safer as it made it clear this was actually only a part of the state transition in the spec.\nThat said, I'm really not liking the way StateTransition class is panning out - just not sure exactly what to do with it.", "author": "ajsutton", "createdAt": "2020-12-10T21:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMzNTkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM0MDYwNw==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540340607", "bodyText": "Maybe worth a test that processes the genesis state", "author": "mbaxter", "createdAt": "2020-12-10T17:03:32Z", "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/forkchoice/StateRootCollectorTest.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.statetransition.forkchoice;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.verifyNoInteractions;\n+import static org.mockito.Mockito.verifyNoMoreInteractions;\n+import static tech.pegasys.teku.util.config.Constants.SLOTS_PER_HISTORICAL_ROOT;\n+\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.core.StateTransition;\n+import tech.pegasys.teku.datastructures.blocks.BeaconBlockSummary;\n+import tech.pegasys.teku.datastructures.blocks.SignedBlockAndState;\n+import tech.pegasys.teku.datastructures.blocks.SlotAndBlockRoot;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.storage.storageSystem.InMemoryStorageSystemBuilder;\n+import tech.pegasys.teku.storage.storageSystem.StorageSystem;\n+import tech.pegasys.teku.storage.store.UpdatableStore.StoreTransaction;\n+\n+class StateRootCollectorTest {\n+  private final StorageSystem storageSystem = InMemoryStorageSystemBuilder.buildDefault();\n+  private final StoreTransaction transaction = mock(StoreTransaction.class);\n+  private SignedBlockAndState genesis;\n+\n+  @BeforeEach\n+  void setUp() {\n+    genesis = storageSystem.chainUpdater().initializeGenesis();\n+  }\n+\n+  @Test\n+  void shouldNotCaptureAnyStateRootsForBlockInSlot1() {", "originalCommit": "ba0144c826ec936675d788e67b7077e842b1ddfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ5NDMyOA==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540494328", "bodyText": "Added.", "author": "ajsutton", "createdAt": "2020-12-10T21:02:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM0MDYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM0MjA0Mw==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540342043", "bodyText": "Probably worth some comments on what we're expecting for this state param", "author": "mbaxter", "createdAt": "2020-12-10T17:05:31Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/ForkChoiceUtil.java", "diffHunk": "@@ -209,43 +209,31 @@ public static void on_tick(MutableStore store, UInt64 time) {\n     }\n   }\n \n-  /**\n-   * @param store\n-   * @param signed_block\n-   * @param maybePreState\n-   * @param st\n-   * @param forkChoiceStrategy\n-   * @param beaconStateConsumer\n-   * @see\n-   *     <a>https://github.com/ethereum/eth2.0-specs/blob/v0.8.1/specs/core/0_fork-choice.md#on_block</a>\n-   */\n   @CheckReturnValue\n   public static BlockImportResult on_block(\n       final MutableStore store,\n       final SignedBeaconBlock signed_block,\n-      Optional<BeaconState> maybePreState,\n+      BeaconState blockSlotState,", "originalCommit": "ba0144c826ec936675d788e67b7077e842b1ddfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1MzM2MQ==", "url": "https://github.com/ConsenSys/teku/pull/3386#discussion_r540553361", "bodyText": "Added.", "author": "ajsutton", "createdAt": "2020-12-10T22:46:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM0MjA0Mw=="}], "type": "inlineReview"}, {"oid": "8cdfd2a7a41f192e6571ff8c74905400dff1f587", "url": "https://github.com/ConsenSys/teku/commit/8cdfd2a7a41f192e6571ff8c74905400dff1f587", "message": "Update tests, add checkArgument to ensure the state has empty slots processed.", "committedDate": "2020-12-10T20:55:57Z", "type": "commit"}, {"oid": "389c11a1908fa36d2016713192455cf5bc003409", "url": "https://github.com/ConsenSys/teku/commit/389c11a1908fa36d2016713192455cf5bc003409", "message": "Errorprone.", "committedDate": "2020-12-10T21:04:04Z", "type": "commit"}, {"oid": "5b8b5821a54a30108f65bb041bb52218ef30c59e", "url": "https://github.com/ConsenSys/teku/commit/5b8b5821a54a30108f65bb041bb52218ef30c59e", "message": "Add docs.", "committedDate": "2020-12-10T21:13:24Z", "type": "commit"}, {"oid": "458fecff8a56990c52ba4ccb71bd38f1066b085d", "url": "https://github.com/ConsenSys/teku/commit/458fecff8a56990c52ba4ccb71bd38f1066b085d", "message": "Errorprone.", "committedDate": "2020-12-10T21:16:05Z", "type": "commit"}, {"oid": "f5796499db42e20c154773bc4dfdc11ea33f82cc", "url": "https://github.com/ConsenSys/teku/commit/f5796499db42e20c154773bc4dfdc11ea33f82cc", "message": "Merge branch 'master' of github.com:ConsenSys/teku into use-cached-pre-state-for-block-import", "committedDate": "2020-12-10T21:16:10Z", "type": "commit"}]}