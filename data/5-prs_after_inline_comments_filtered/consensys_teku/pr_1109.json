{"pr_number": 1109, "pr_title": "Optimize: get_attestation_deltas: flatten nested loops", "pr_createdAt": "2020-01-22T15:36:18Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1109", "timeline": [{"oid": "fce9bb6d470580aba2986d7e208ee39d31270852", "url": "https://github.com/ConsenSys/teku/commit/fce9bb6d470580aba2986d7e208ee39d31270852", "message": "Optimize: get_attestation_deltas: flatten nested loops", "committedDate": "2020-01-22T15:32:25Z", "type": "commit"}, {"oid": "e61ac7b84fb81964b7da154022a9a7b5250ac344", "url": "https://github.com/ConsenSys/teku/commit/e61ac7b84fb81964b7da154022a9a7b5250ac344", "message": "Merge branch 'master' into optimize-get-attestation-deltas-main", "committedDate": "2020-01-22T15:58:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY0ODMwMw==", "url": "https://github.com/ConsenSys/teku/pull/1109#discussion_r369648303", "bodyText": "(nit): might be a good idea to remove the empty line", "author": "cemozerr", "createdAt": "2020-01-22T16:00:09Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/EpochProcessorUtil.java", "diffHunk": "@@ -347,30 +349,41 @@ private static UnsignedLong get_base_reward(BeaconState state, int index) {\n     }\n \n     // Proposer and inclusion delay micro-rewards\n-    for (Integer index : get_unslashed_attesting_indices(state, matching_source_attestations)) {\n-      matching_source_attestations.stream()\n-          .filter(\n-              a ->\n-                  get_attesting_indices(state, a.getData(), a.getAggregation_bits())\n-                      .contains(index))\n-          .min(Comparator.comparing(PendingAttestation::getInclusion_delay))\n-          .ifPresent(\n-              attestation -> {\n-                UnsignedLong proposer_reward =\n-                    get_base_reward(state, index)\n-                        .dividedBy(UnsignedLong.valueOf(PROPOSER_REWARD_QUOTIENT));\n-                rewards.set(\n-                    attestation.getProposer_index().intValue(),\n-                    rewards.get(attestation.getProposer_index().intValue()).plus(proposer_reward));\n-                UnsignedLong max_attester_reward =\n-                    get_base_reward(state, index).minus(proposer_reward);\n-                rewards.set(\n-                    index,\n-                    rewards\n-                        .get(index)\n-                        .plus(max_attester_reward.dividedBy(attestation.getInclusion_delay())));\n-              });\n-    }\n+", "originalCommit": "e61ac7b84fb81964b7da154022a9a7b5250ac344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY1MjIzOA==", "url": "https://github.com/ConsenSys/teku/pull/1109#discussion_r369652238", "bodyText": "Done!", "author": "Nashatyrev", "createdAt": "2020-01-22T16:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY0ODMwMw=="}], "type": "inlineReview"}, {"oid": "f634f4b4c4025a22d40e9b9ba3a566e605aac23d", "url": "https://github.com/ConsenSys/teku/commit/f634f4b4c4025a22d40e9b9ba3a566e605aac23d", "message": "Remove empty line", "committedDate": "2020-01-22T16:05:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY1MzA3OQ==", "url": "https://github.com/ConsenSys/teku/pull/1109#discussion_r369653079", "bodyText": "Do you mind explaining why you call the get_unslashed_attesting_indices here with single attestations instead of all of them together? I'm worried that this might be straying from the spec definition?", "author": "cemozerr", "createdAt": "2020-01-22T16:08:02Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/EpochProcessorUtil.java", "diffHunk": "@@ -347,30 +349,41 @@ private static UnsignedLong get_base_reward(BeaconState state, int index) {\n     }\n \n     // Proposer and inclusion delay micro-rewards\n-    for (Integer index : get_unslashed_attesting_indices(state, matching_source_attestations)) {\n-      matching_source_attestations.stream()\n-          .filter(\n-              a ->\n-                  get_attesting_indices(state, a.getData(), a.getAggregation_bits())\n-                      .contains(index))\n-          .min(Comparator.comparing(PendingAttestation::getInclusion_delay))\n-          .ifPresent(\n-              attestation -> {\n-                UnsignedLong proposer_reward =\n-                    get_base_reward(state, index)\n-                        .dividedBy(UnsignedLong.valueOf(PROPOSER_REWARD_QUOTIENT));\n-                rewards.set(\n-                    attestation.getProposer_index().intValue(),\n-                    rewards.get(attestation.getProposer_index().intValue()).plus(proposer_reward));\n-                UnsignedLong max_attester_reward =\n-                    get_base_reward(state, index).minus(proposer_reward);\n-                rewards.set(\n-                    index,\n-                    rewards\n-                        .get(index)\n-                        .plus(max_attester_reward.dividedBy(attestation.getInclusion_delay())));\n-              });\n-    }\n+\n+    // map (unslashed attester index) -> (list of source attestations)\n+    Map<Integer, List<PendingAttestation>> validator_source_attestations =\n+        matching_source_attestations.stream()\n+            .flatMap(\n+                a ->\n+                    get_unslashed_attesting_indices(state, Collections.singletonList(a)).stream()", "originalCommit": "e61ac7b84fb81964b7da154022a9a7b5250ac344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY3NDE5OQ==", "url": "https://github.com/ConsenSys/teku/pull/1109#discussion_r369674199", "bodyText": "The original spec definition lacks performance in favor of simplicity, so the heavier optimizations we would like to apply the greater changes we would need to do in the straightforward spec implementation.\n\nwhy you call the get_unslashed_attesting_indices here with single attestations instead of all of them together?\n\nI'm building a map (validator) -> (his attestations) instead of doing it via 3 nested loops as in original spec. I bet this change keeps the implementation compatible with the spec, however regression may always occur.\nYou may check the initial fix I did: Nashatyrev#4 It is a bit slower than this one but is much closer to original spec.", "author": "Nashatyrev", "createdAt": "2020-01-22T16:43:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY1MzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0Nzc5NA==", "url": "https://github.com/ConsenSys/teku/pull/1109#discussion_r369847794", "bodyText": "It takes a bit of time to get your head around what both versions are actually doing but they are equivalent.\nThe spec version finds all the validators (by index) included in any of the matching_source_attestations, then for each validator finds the list of attestations they were included in.\nThe new version builds a map of validator to attestations they were included in by iterating each attestation from matching_source_attestations and converting to a pair of (validator, attestation) then grouping them by validator (lines 359 to 361).\nThe majority of the method is unchanged except for indenting, for each validator find the attestation with minimum inclusion delay and apply rewards based on that (lines 355-372 in the old and 363-385 in the new).", "author": "ajsutton", "createdAt": "2020-01-22T22:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY1MzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk1MzU5NQ==", "url": "https://github.com/ConsenSys/teku/pull/1109#discussion_r369953595", "bodyText": "@ajsutton yes, exactly. Thanks for detailed description!", "author": "Nashatyrev", "createdAt": "2020-01-23T06:47:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY1MzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY2Njk4Mg==", "url": "https://github.com/ConsenSys/teku/pull/1109#discussion_r373666982", "bodyText": "Thanks guys!", "author": "cemozerr", "createdAt": "2020-01-31T20:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY1MzA3OQ=="}], "type": "inlineReview"}, {"oid": "90f3515aa877d53d30d65132dac0c9daab3c0ad1", "url": "https://github.com/ConsenSys/teku/commit/90f3515aa877d53d30d65132dac0c9daab3c0ad1", "message": "Merge branch 'master' into optimize-get-attestation-deltas-main", "committedDate": "2020-01-22T16:44:02Z", "type": "commit"}, {"oid": "a028f8c7befc33c96bd5fb3216f3ff4944109a25", "url": "https://github.com/ConsenSys/teku/commit/a028f8c7befc33c96bd5fb3216f3ff4944109a25", "message": "Merge branch 'master' into optimize-get-attestation-deltas-main", "committedDate": "2020-01-22T16:54:35Z", "type": "commit"}, {"oid": "806312aca10b228375571674603ef88fac376514", "url": "https://github.com/ConsenSys/teku/commit/806312aca10b228375571674603ef88fac376514", "message": "Merge branch 'master' into optimize-get-attestation-deltas-main", "committedDate": "2020-01-23T06:48:41Z", "type": "commit"}]}