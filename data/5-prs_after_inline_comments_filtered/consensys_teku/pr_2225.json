{"pr_number": 2225, "pr_title": "Limit RocksDB write buffer", "pr_createdAt": "2020-06-25T17:59:15Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2225", "timeline": [{"oid": "f06c54b0f5ecee8577cdb25862aeac542be94974", "url": "https://github.com/ConsenSys/teku/commit/f06c54b0f5ecee8577cdb25862aeac542be94974", "message": "Limit RocksDB write buffer", "committedDate": "2020-06-25T17:51:42Z", "type": "commit"}, {"oid": "7212db90d12242461edb2ee9b5b10e2c8eed0fe5", "url": "https://github.com/ConsenSys/teku/commit/7212db90d12242461edb2ee9b5b10e2c8eed0fe5", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-mem-limit-rocksdb-write\n\n# Conflicts:\n#\tstorage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/core/RocksDbInstanceFactory.java", "committedDate": "2020-06-25T17:53:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMzY4Nw==", "url": "https://github.com/ConsenSys/teku/pull/2225#discussion_r445903687", "bodyText": "I did some playing just to see what happens if we make it higher. I think around 256MB has a good mix of the disk being used, might be a better starting point than 8MB...\nI tried with 128MB and there were constant disk flushes happening, 256MB means the WAL buffers fit inside the db write buffer size, and its happier by the looks.\nI could definitely see this being a configurable option for tweaking, i think sync will be when you'd potentially want more buffers so the sync can progress faster...\ngive .setDbWriteBufferSize(268435456L) a go...", "author": "rolfyone", "createdAt": "2020-06-26T00:10:53Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/core/RocksDbInstanceFactory.java", "diffHunk": "@@ -112,6 +112,7 @@ private static DBOptions createDBOptions(final RocksDbConfiguration configuratio\n         .setBytesPerSync(1048576L)\n         .setWalBytesPerSync(1048576L)\n         .setMaxBackgroundFlushes(2)\n+        .setDbWriteBufferSize(configuration.getCacheCapacity())", "originalCommit": "7212db90d12242461edb2ee9b5b10e2c8eed0fe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA2MTc0NQ==", "url": "https://github.com/ConsenSys/teku/pull/2225#discussion_r446061745", "bodyText": "@rolfyone thanks for this investigation! Did it 256M by default", "author": "Nashatyrev", "createdAt": "2020-06-26T09:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMzY4Nw=="}], "type": "inlineReview"}, {"oid": "d7224ecc6c397e2a100ac03e1340bf15b79a6bea", "url": "https://github.com/ConsenSys/teku/commit/d7224ecc6c397e2a100ac03e1340bf15b79a6bea", "message": "Separate writeBufferCapacity DB option. Set it to 256M by default", "committedDate": "2020-06-26T09:03:18Z", "type": "commit"}, {"oid": "753b76556d04203a67dbda424b023460fde01271", "url": "https://github.com/ConsenSys/teku/commit/753b76556d04203a67dbda424b023460fde01271", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-mem-limit-rocksdb-write", "committedDate": "2020-06-26T09:03:28Z", "type": "commit"}, {"oid": "807e8b0404ecc7f87c281926a8e020fd7dac5471", "url": "https://github.com/ConsenSys/teku/commit/807e8b0404ecc7f87c281926a8e020fd7dac5471", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into optimize-mem-limit-rocksdb-write", "committedDate": "2020-06-26T21:40:51Z", "type": "commit"}, {"oid": "88a93e2d3e23d18ba01e03a474be2220ee0d8324", "url": "https://github.com/ConsenSys/teku/commit/88a93e2d3e23d18ba01e03a474be2220ee0d8324", "message": "Merge branch 'master' into optimize-mem-limit-rocksdb-write", "committedDate": "2020-06-26T22:02:01Z", "type": "commit"}]}