{"pr_number": 2483, "pr_title": "change store metrics to settableGauge", "pr_createdAt": "2020-07-30T02:04:02Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2483", "timeline": [{"oid": "b6b71b5227a97ad040016cd3d47407942a3870bb", "url": "https://github.com/ConsenSys/teku/commit/b6b71b5227a97ad040016cd3d47407942a3870bb", "message": "change store metrics to settableGauge\n\n - filtered out the gauges from being compared as part of equality.\n\n removes the need for read locks when checking sizes of maps.\n\n # partially addresses #2444\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-07-30T02:03:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyNTM0OQ==", "url": "https://github.com/ConsenSys/teku/pull/2483#discussion_r462725349", "bodyText": "The counter fields aren't volatile so we should take a writeLock while creating these. Otherwise when we come to update them we may wind up getting a partially initialised object because there's no guarantee of visibility across threads.\nAll the places we'd update it would also have the write lock already so that works out nicer than making the fields volatile.", "author": "ajsutton", "createdAt": "2020-07-30T04:20:07Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/store/Store.java", "diffHunk": "@@ -191,21 +195,27 @@\n    */\n   @Override\n   public void startMetrics() {\n-    metricsSystem.createIntegerGauge(\n-        TekuMetricCategory.STORAGE,\n-        \"memory_state_count\",\n-        \"Number of beacon states held in the in-memory store\",\n-        this::countStates);\n-    metricsSystem.createIntegerGauge(\n-        TekuMetricCategory.STORAGE,\n-        \"memory_block_count\",\n-        \"Number of beacon blocks held in the in-memory store\",\n-        this::countBlocks);\n-    metricsSystem.createIntegerGauge(\n-        TekuMetricCategory.STORAGE,\n-        \"memory_checkpoint_state_count\",\n-        \"Number of checkpoint states held in the in-memory store\",\n-        this::countCheckpointStates);\n+    stateCountGauge =\n+        Optional.of(\n+            SettableGauge.create(\n+                metricsSystem,\n+                TekuMetricCategory.STORAGE,\n+                \"memory_state_count\",\n+                \"Number of beacon states held in the in-memory store\"));\n+    blockCountGauge =\n+        Optional.of(\n+            SettableGauge.create(\n+                metricsSystem,\n+                TekuMetricCategory.STORAGE,\n+                \"memory_block_count\",\n+                \"Number of beacon blocks held in the in-memory store\"));\n+    checkpointCountGauge =\n+        Optional.of(\n+            SettableGauge.create(\n+                metricsSystem,\n+                TekuMetricCategory.STORAGE,\n+                \"memory_checkpoint_state_count\",\n+                \"Number of checkpoint states held in the in-memory store\"));", "originalCommit": "b6b71b5227a97ad040016cd3d47407942a3870bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0e71ec8f88573c0d578f9f8ae2e356f1d8d1106a", "url": "https://github.com/ConsenSys/teku/commit/0e71ec8f88573c0d578f9f8ae2e356f1d8d1106a", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-07-30T06:17:40Z", "type": "commit"}]}