{"pr_number": 1700, "pr_title": "[BC-383] Add GetMetadata RPC method", "pr_createdAt": "2020-04-30T17:19:07Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1700", "timeline": [{"oid": "14d31635b1b93e5f2e36956f87dd3100c066c0cf", "url": "https://github.com/ConsenSys/teku/commit/14d31635b1b93e5f2e36956f87dd3100c066c0cf", "message": "Add GetMetadata RPC method", "committedDate": "2020-04-30T17:13:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2OTE1MA==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r418169150", "bodyText": "Each new subscriber receives the latest data. This method is not thread-safe but it's ok for now since we are subscribing on initialization step only. If no one minds I would add a reactive-streams dependency (I think Reactor it the best fit) and make this subscription stuff based on Publisher to not reinvent the wheel.", "author": "Nashatyrev", "createdAt": "2020-04-30T17:23:01Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/AttestationSubnetService.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.networking.eth2;\n+\n+import java.util.Collections;\n+import java.util.function.Consumer;\n+import tech.pegasys.artemis.util.events.Subscribers;\n+\n+/**\n+ * Service tracks long term attestation subnet subscriptions and notifies subscribers on their\n+ * changes\n+ */\n+public class AttestationSubnetService {\n+  private final Subscribers<Consumer<Iterable<Integer>>> subscribers = Subscribers.create(true);\n+  private volatile Iterable<Integer> currentSubscriptions = Collections.emptyList();\n+\n+  public void updateSubscriptions(final Iterable<Integer> subnetIndices) {\n+    subscribers.deliver(Consumer::accept, subnetIndices);\n+    currentSubscriptions = subnetIndices;\n+  }\n+\n+  public Iterable<Integer> getCurrentAttestatoinSubnetSubscriptions() {\n+    return currentSubscriptions;\n+  }\n+\n+  public long subscribeToUpdates(Consumer<Iterable<Integer>> observer) {\n+    observer.accept(getCurrentAttestatoinSubnetSubscriptions());", "originalCommit": "14d31635b1b93e5f2e36956f87dd3100c066c0cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4NjI2NA==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r418286264", "bodyText": "I'm not sure I see the threading issue here.  The Subscribers class is specifically intended for this kind of subscriber pattern and is thread safe.  current subscriptions is volatile so the only risk is if updateSubscriptions is passed something that's also modified externally (which is a problem even ignoring threads).\nI guess it's also possible that multiple threads make simultaneous calls to updateSubscriptions but there's no way to replace the whole list concurrently and not wind up losing one of the changes so it will have to be the upstream caller that handles that.", "author": "ajsutton", "createdAt": "2020-04-30T21:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2OTE1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ5MDI1MQ==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r418490251", "bodyText": "@ajsutton\nYep the Subscribers is thread-safe, but the AttestationSubnetService is not.\nWhat I'd like to have is the guarantee that:\n\nany subscriber added at any moment from any thread would receive the latest item.\nitems are delivered in the right order\nno duplicate items\n\nThe current implementation may violate all of the above restrictions. You just need to invoke subscribeToUpdates and updateSubscriptions from different threads. (while updateSubscriptions may always be called from a single thread)\nI tried to implement it (that Publisher class) but it appeared a bit tricky as I don't want the listener callbacks to be invoked under the lock since it is deadlock-prone.  So just doing both methods synchronized is not the case.\nThat's why I though that using Reactive library might be handy even for these primitive cases just to not reinvent a wheel.", "author": "Nashatyrev", "createdAt": "2020-05-01T10:19:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2OTE1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc2Mzk0Mg==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r419763942", "bodyText": "Ah I see. The only reason we need that construct is because the list of subscriptions and the sequence number is being maintained in two separate places.  Given that the PING response needs to be able to provide the same sequence number, wouldn't it make more sense to maintain the sequence number in AttestationSubnetService? Then the listeners aren't required at all - both metadata and ping response handlers can just request the latest value and use it.", "author": "ajsutton", "createdAt": "2020-05-04T22:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2OTE1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkyMTU0NA==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r420921544", "bodyText": "The reason I wanted to separate AttestationSubnetService is that other services might be interested in the value updates. E.g. at the moment the discoveryNetwork also needs to be notified on updates. The seq_number relates only to Eth2 RPC, so I thought it makes sense to manage it in a more RPC specific class (MetadataMessageFactory).\nFor serving the PING request I was going to use the same MetadataMessageFactory (though may be rename it appropriately)\nAnyways I've made AttestationSubnetService thread-safe so we may safely stick to any option", "author": "Nashatyrev", "createdAt": "2020-05-06T16:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2OTE1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU5NDExNg==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r421594116", "bodyText": "Finally came up with a thread safe ObservableValue class without a dedicated thread.\nThe only drawback of ObservableValue is that upon subscribe it calls the update callback under the lock. But this should be safe enough.\nOn updates subscribers callbacks are invoked without locking.", "author": "Nashatyrev", "createdAt": "2020-05-07T15:27:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2OTE1MA=="}], "type": "inlineReview"}, {"oid": "e3949706cd7f0ea48e7eb13f4ed7091c6633bc28", "url": "https://github.com/ConsenSys/teku/commit/e3949706cd7f0ea48e7eb13f4ed7091c6633bc28", "message": "Remove unnecessary parentheses", "committedDate": "2020-04-30T17:24:30Z", "type": "commit"}, {"oid": "719851b827f749199bf3ee8f9f0715596c76a3cc", "url": "https://github.com/ConsenSys/teku/commit/719851b827f749199bf3ee8f9f0715596c76a3cc", "message": "Fix the warning", "committedDate": "2020-04-30T17:32:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4MTIxOA==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r418281218", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThat(md3.getSeqNumber()).isNotEqualTo(md2.getSeqNumber());\n          \n          \n            \n                assertThat(md3.getSeqNumber()).isGreaterThan(md2.getSeqNumber());", "author": "ajsutton", "createdAt": "2020-04-30T20:50:49Z", "path": "networking/eth2/src/integration-test/java/tech/pegasys/artemis/networking/eth2/GetMetadataIntegrationTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2019 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.networking.eth2;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.IntStream;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.datastructures.networking.libp2p.rpc.MetadataMessage;\n+import tech.pegasys.artemis.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.artemis.util.config.Constants;\n+\n+public class GetMetadataIntegrationTest {\n+  private final Eth2NetworkFactory networkFactory = new Eth2NetworkFactory();\n+  private Eth2Network network1;\n+  private Eth2Network network2;\n+  private Eth2Peer peer1;\n+\n+  @BeforeEach\n+  public void setUp() throws Exception {\n+    network1 = networkFactory.builder().startNetwork();\n+    network2 = networkFactory.builder().peer(network1).startNetwork();\n+    peer1 = network2.getPeer(network1.getNodeId()).orElseThrow();\n+  }\n+\n+  @AfterEach\n+  public void tearDown() {\n+    networkFactory.stopAll();\n+  }\n+\n+  @Test\n+  public void testCorrectMetadataSent() throws Exception {\n+    MetadataMessage md1 = peer1.requestMetadata().get(10, TimeUnit.SECONDS);\n+    MetadataMessage md2 = peer1.requestMetadata().get(10, TimeUnit.SECONDS);\n+\n+    assertThat(md1.getSeqNumber()).isEqualTo(md2.getSeqNumber());\n+    assertThat(md1.getAttnets().getSize()).isEqualTo(Constants.ATTESTATION_SUBNET_COUNT);\n+    assertThat(\n+            IntStream.range(0, Constants.ATTESTATION_SUBNET_COUNT)\n+                .map(i -> md1.getAttnets().getBit(i) ? 1 : 0)\n+                .sum())\n+        .isEqualTo(0);\n+    network1.setLongTermAttestationSubnetSubscriptions(List.of(0, 1, 8));\n+\n+    MetadataMessage md3 = peer1.requestMetadata().get(10, TimeUnit.SECONDS);\n+    assertThat(md3.getSeqNumber()).isNotEqualTo(md2.getSeqNumber());", "originalCommit": "719851b827f749199bf3ee8f9f0715596c76a3cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4NTA5Ng==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r418285096", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public Iterable<Integer> getCurrentAttestatoinSubnetSubscriptions() {\n          \n          \n            \n              public Iterable<Integer> getCurrentAttestationSubnetSubscriptions() {", "author": "ajsutton", "createdAt": "2020-04-30T20:58:32Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/AttestationSubnetService.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.networking.eth2;\n+\n+import java.util.Collections;\n+import java.util.function.Consumer;\n+import tech.pegasys.artemis.util.events.Subscribers;\n+\n+/**\n+ * Service tracks long term attestation subnet subscriptions and notifies subscribers on their\n+ * changes\n+ */\n+public class AttestationSubnetService {\n+  private final Subscribers<Consumer<Iterable<Integer>>> subscribers = Subscribers.create(true);\n+  private volatile Iterable<Integer> currentSubscriptions = Collections.emptyList();\n+\n+  public void updateSubscriptions(final Iterable<Integer> subnetIndices) {\n+    subscribers.deliver(Consumer::accept, subnetIndices);\n+    currentSubscriptions = subnetIndices;\n+  }\n+\n+  public Iterable<Integer> getCurrentAttestatoinSubnetSubscriptions() {", "originalCommit": "719851b827f749199bf3ee8f9f0715596c76a3cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4NTQyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r418285421", "bodyText": "Although actually we don't currently need this method if subscribeToUpdates just read currentSubscriptions directly.", "author": "ajsutton", "createdAt": "2020-04-30T20:59:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4NTA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4ODU0Nw==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r418288547", "bodyText": "nit: Field can be final.", "author": "ajsutton", "createdAt": "2020-04-30T21:05:05Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/rpc/beaconchain/methods/MetadataMessageFactory.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2019 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.networking.eth2.rpc.beaconchain.methods;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.function.Consumer;\n+import tech.pegasys.artemis.datastructures.networking.libp2p.rpc.MetadataMessage;\n+import tech.pegasys.artemis.ssz.SSZTypes.Bitvector;\n+import tech.pegasys.artemis.util.config.Constants;\n+\n+public class MetadataMessageFactory implements Consumer<Iterable<Integer>> {\n+\n+  private AtomicLong seqNumberGenerator = new AtomicLong();", "originalCommit": "719851b827f749199bf3ee8f9f0715596c76a3cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4OTI1Mg==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r418289252", "bodyText": "This doesn't seem to be used.", "author": "ajsutton", "createdAt": "2020-04-30T21:06:36Z", "path": "util/src/main/java/tech/pegasys/artemis/util/events/Publisher.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.events;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.function.Consumer;\n+\n+public class Publisher<C> implements Consumer<C> {", "originalCommit": "719851b827f749199bf3ee8f9f0715596c76a3cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NTE4NA==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r418485184", "bodyText": "Ops, accidentally committed", "author": "Nashatyrev", "createdAt": "2020-05-01T09:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4OTI1Mg=="}], "type": "inlineReview"}, {"oid": "4039b3cecfc95c1e1c12c02cfd902268bed978a7", "url": "https://github.com/ConsenSys/teku/commit/4039b3cecfc95c1e1c12c02cfd902268bed978a7", "message": "Strengthen condition: metadata seq_number should increase", "committedDate": "2020-05-01T09:53:38Z", "type": "commit"}, {"oid": "362cb23f53d9b46361a27acac2df5bc4de5bccde", "url": "https://github.com/ConsenSys/teku/commit/362cb23f53d9b46361a27acac2df5bc4de5bccde", "message": "Remove obsolete method", "committedDate": "2020-05-01T09:54:43Z", "type": "commit"}, {"oid": "7f6bd20f83122f07f0bb3a05e95fecd13785b25b", "url": "https://github.com/ConsenSys/teku/commit/7f6bd20f83122f07f0bb3a05e95fecd13785b25b", "message": "Make field final", "committedDate": "2020-05-01T09:55:44Z", "type": "commit"}, {"oid": "5ac075a6a36a49543076ebb0ca200a2d1bf5ca2b", "url": "https://github.com/ConsenSys/teku/commit/5ac075a6a36a49543076ebb0ca200a2d1bf5ca2b", "message": "Remove accidentally committed class", "committedDate": "2020-05-01T09:58:52Z", "type": "commit"}, {"oid": "5c02fdc8a9b2205c8785a2a40a4503f07f591cba", "url": "https://github.com/ConsenSys/teku/commit/5c02fdc8a9b2205c8785a2a40a4503f07f591cba", "message": "Merge remote-tracking branch 'pegasys/master' into feature-rpc-get-metadata\n\n# Conflicts:\n#\tnetworking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/Eth2NetworkBuilder.java\n#\tnetworking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/peers/Eth2PeerManager.java\n#\tnetworking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/rpc/beaconchain/BeaconChainMethods.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/peers/Eth2PeerManagerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/rpc/beaconchain/methods/BeaconChainMethodsTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/rpc/core/Eth2IncomingRequestHandlerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/rpc/core/Eth2OutgoingRequestHandlerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/rpc/core/RpcDecoderTestBase.java\n#\tnetworking/eth2/src/testFixtures/java/tech/pegasys/artemis/networking/eth2/Eth2NetworkFactory.java", "committedDate": "2020-05-01T10:54:15Z", "type": "commit"}, {"oid": "bc36adeab34738bc7a1a78470405f28d754c834d", "url": "https://github.com/ConsenSys/teku/commit/bc36adeab34738bc7a1a78470405f28d754c834d", "message": "Resolve merge conflicts", "committedDate": "2020-05-01T11:59:05Z", "type": "commit"}, {"oid": "6158b7965b55e57f49fce1f143858adae049bf44", "url": "https://github.com/ConsenSys/teku/commit/6158b7965b55e57f49fce1f143858adae049bf44", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into feature-rpc-get-metadata", "committedDate": "2020-05-04T23:44:44Z", "type": "commit"}, {"oid": "00637dbcfac0f1e8bbb637db78c771048cf7ae33", "url": "https://github.com/ConsenSys/teku/commit/00637dbcfac0f1e8bbb637db78c771048cf7ae33", "message": "Make AttestationSubnetService thread safe", "committedDate": "2020-05-06T16:08:11Z", "type": "commit"}, {"oid": "609579653753fb637bacf30b629939747a1e894d", "url": "https://github.com/ConsenSys/teku/commit/609579653753fb637bacf30b629939747a1e894d", "message": "Merge remote-tracking branch 'origin/feature-rpc-get-metadata' into feature-rpc-get-metadata", "committedDate": "2020-05-06T16:08:29Z", "type": "commit"}, {"oid": "542d804f226eec0452089bb0c476c3b6907fc82e", "url": "https://github.com/ConsenSys/teku/commit/542d804f226eec0452089bb0c476c3b6907fc82e", "message": "Apply spotless", "committedDate": "2020-05-06T16:12:17Z", "type": "commit"}, {"oid": "6e3383c3c7334adf5988ff5e136bfc825aa48c80", "url": "https://github.com/ConsenSys/teku/commit/6e3383c3c7334adf5988ff5e136bfc825aa48c80", "message": "Get rid of a dedicated thread for AttestationSubnetService in favor of ObservableValue class", "committedDate": "2020-05-07T15:27:32Z", "type": "commit"}, {"oid": "213904b6f3d40930c5cf179a3f88b60cb5895ae2", "url": "https://github.com/ConsenSys/teku/commit/213904b6f3d40930c5cf179a3f88b60cb5895ae2", "message": "Fix the warn about Vector", "committedDate": "2020-05-07T15:33:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1NjA2OA==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r421856068", "bodyText": "It's probably worth creating a specific interface rather than using the generic Consumer here.  Makes it easier to understand where values are coming from in the classes that implement it.  Something like ValueObserver with an onValueChanged method.", "author": "ajsutton", "createdAt": "2020-05-07T23:44:29Z", "path": "util/src/main/java/tech/pegasys/teku/util/events/ObservableValue.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.events;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.function.Consumer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.jetbrains.annotations.NotNull;\n+\n+/**\n+ * A value holder class which notifies subscribers on value updates\n+ *\n+ * <p>The key feature of this class is that upon subscription a new subscriber is always notified on\n+ * the current value (if the value exist) and this is performed in a thread-safe manner such that\n+ * {@link #set(Object)} and {@link #subscribe(Consumer)} methods can be safely called from different\n+ * threads\n+ *\n+ * <p>All subscribers are guaranteed:\n+ *\n+ * <ul>\n+ *   <li>to be always notified on the latest value\n+ *   <li>to be notified on each value just once\n+ *   <li>to be notified in the right order if the {@link #set(Object)} is invoked on the same thread\n+ * </ul>\n+ *\n+ * Initially the holder has no value so added subscribers are not notified upon subscription\n+ *\n+ * @param <C> Value type\n+ */\n+public class ObservableValue<C> {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private static final class Subscription<C> {\n+    private final Consumer<C> subscriber;\n+    private final long subscriptionId;\n+\n+    public Subscription(Consumer<C> subscriber, long subscriptionId) {\n+      this.subscriber = subscriber;\n+      this.subscriptionId = subscriptionId;\n+    }\n+\n+    public Consumer<C> getSubscriber() {\n+      return subscriber;\n+    }\n+\n+    public long getSubscriptionId() {\n+      return subscriptionId;\n+    }\n+  }\n+\n+  private long idCounter = 0;\n+  private final List<Subscription<C>> subscriptions = new CopyOnWriteArrayList<>();\n+  private C curValue;\n+  private final boolean suppressCallbackExceptions;\n+\n+  /**\n+   * Creates instance\n+   *\n+   * @param suppressCallbackExceptions if true then any exceptions thrown from a subscriber update\n+   *     callback are just printed to the log\n+   */\n+  public ObservableValue(boolean suppressCallbackExceptions) {\n+    this.suppressCallbackExceptions = suppressCallbackExceptions;\n+  }\n+\n+  /**\n+   * Subscribe to value update notification\n+   *\n+   * <p>New subscriber is notified on the latest value if the value exist\n+   *\n+   * @return subscription ID to be used for {@link #unsubscribe(long)}\n+   */\n+  public synchronized long subscribe(Consumer<C> subscriber) {", "originalCommit": "213904b6f3d40930c5cf179a3f88b60cb5895ae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MTY0OQ==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r422041649", "bodyText": "Yes, sounds good \ud83d\udc4d", "author": "Nashatyrev", "createdAt": "2020-05-08T09:24:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1NjA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1NjU4OQ==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r421856589", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * <p>The key feature of this class is that upon subscription a new subscriber is always notified on\n          \n          \n            \n             * the current value (if the value exist) and this is performed in a thread-safe manner such that\n          \n          \n            \n             * <p>The key feature of this class is that upon subscription a new subscriber is always notified of\n          \n          \n            \n             * the current value (if the value exists) and this is performed in a thread-safe manner such that", "author": "ajsutton", "createdAt": "2020-05-07T23:46:00Z", "path": "util/src/main/java/tech/pegasys/teku/util/events/ObservableValue.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.events;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.function.Consumer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.jetbrains.annotations.NotNull;\n+\n+/**\n+ * A value holder class which notifies subscribers on value updates\n+ *\n+ * <p>The key feature of this class is that upon subscription a new subscriber is always notified on\n+ * the current value (if the value exist) and this is performed in a thread-safe manner such that", "originalCommit": "213904b6f3d40930c5cf179a3f88b60cb5895ae2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1NzA0Nw==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r421857047", "bodyText": "Stray println.", "author": "ajsutton", "createdAt": "2020-05-07T23:47:37Z", "path": "util/src/test/java/tech/pegasys/teku/util/events/ObservableValueTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.events;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.junit.jupiter.api.Test;\n+\n+public class ObservableValueTest {\n+\n+  @Test\n+  public void testConcurrentSubscribersNotifications() throws InterruptedException {\n+    ObservableValue<Integer> observableValue = new ObservableValue<>(false);\n+    class Listener implements Consumer<Integer> {\n+      int val;\n+\n+      @Override\n+      public void accept(Integer integer) {\n+        if (val == -2 || integer <= val) {\n+          throw new RuntimeException();\n+        }\n+        val = integer;\n+      }\n+    }\n+\n+    List<Listener> listeners = Collections.synchronizedList(new ArrayList<>());\n+    int threadCnt = 64;\n+    CountDownLatch startLatch = new CountDownLatch(threadCnt);\n+    CountDownLatch stopLatch = new CountDownLatch(threadCnt);\n+\n+    Runnable runnable =\n+        () -> {\n+          while (!Thread.interrupted()) {\n+            Listener listener = new Listener();\n+            observableValue.subscribe(listener);\n+            listeners.add(listener);\n+            startLatch.countDown();\n+          }\n+          stopLatch.countDown();\n+        };\n+\n+    List<Thread> threads =\n+        Stream.generate(() -> runnable)\n+            .map(Thread::new)\n+            .peek(Thread::start)\n+            .limit(threadCnt)\n+            .collect(Collectors.toList());\n+\n+    startLatch.await(5, TimeUnit.SECONDS);\n+    observableValue.set(777);\n+    threads.forEach(Thread::interrupt);\n+    stopLatch.await(5, TimeUnit.SECONDS);\n+\n+    System.out.println(\"Listeners: \" + listeners.size());", "originalCommit": "213904b6f3d40930c5cf179a3f88b60cb5895ae2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1NzU3Ng==", "url": "https://github.com/ConsenSys/teku/pull/1700#discussion_r421857576", "bodyText": "Maybe use Assertions.fail here and provide a message.", "author": "ajsutton", "createdAt": "2020-05-07T23:49:21Z", "path": "util/src/test/java/tech/pegasys/teku/util/events/ObservableValueTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.events;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.junit.jupiter.api.Test;\n+\n+public class ObservableValueTest {\n+\n+  @Test\n+  public void testConcurrentSubscribersNotifications() throws InterruptedException {\n+    ObservableValue<Integer> observableValue = new ObservableValue<>(false);\n+    class Listener implements Consumer<Integer> {\n+      int val;\n+\n+      @Override\n+      public void accept(Integer integer) {\n+        if (val == -2 || integer <= val) {\n+          throw new RuntimeException();", "originalCommit": "213904b6f3d40930c5cf179a3f88b60cb5895ae2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dac38a67293221bb77a54677a9ae7de576106099", "url": "https://github.com/ConsenSys/teku/commit/dac38a67293221bb77a54677a9ae7de576106099", "message": "Merge remote-tracking branch 'pegasys/master' into feature-rpc-get-metadata\n\n# Conflicts:\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java\n#\tnetworking/eth2/src/testFixtures/java/tech/pegasys/teku/networking/eth2/Eth2NetworkFactory.java", "committedDate": "2020-05-08T08:44:11Z", "type": "commit"}, {"oid": "15103cb077c2b6cc29cb34aca462a1f3293e8d07", "url": "https://github.com/ConsenSys/teku/commit/15103cb077c2b6cc29cb34aca462a1f3293e8d07", "message": "Resolve merge conflicts", "committedDate": "2020-05-08T09:12:16Z", "type": "commit"}, {"oid": "354cb7abf410c1ed80677e5b2864dd0e9363c5a3", "url": "https://github.com/ConsenSys/teku/commit/354cb7abf410c1ed80677e5b2864dd0e9363c5a3", "message": "Add ValueObserver interface instead of generic Consumer. Other minor updates", "committedDate": "2020-05-08T09:36:20Z", "type": "commit"}, {"oid": "ed1396a31375f3b20c64a297c511469abb7f985a", "url": "https://github.com/ConsenSys/teku/commit/ed1396a31375f3b20c64a297c511469abb7f985a", "message": "Revert accidentally committed change", "committedDate": "2020-05-08T09:57:11Z", "type": "commit"}]}