{"pr_number": 1688, "pr_title": "[BC-373] Align Gossip message ID according to the spec", "pr_createdAt": "2020-04-28T17:22:38Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1688", "timeline": [{"oid": "8085d77f0616c240dc46b99f99b152d19a52a416", "url": "https://github.com/ConsenSys/teku/commit/8085d77f0616c240dc46b99f99b152d19a52a416", "message": "Add Gossip options to the NetworkConfig", "committedDate": "2020-04-27T18:17:14Z", "type": "commit"}, {"oid": "967fa4c6d1d09bb4e0fbee97378ce92b95fc1caf", "url": "https://github.com/ConsenSys/teku/commit/967fa4c6d1d09bb4e0fbee97378ce92b95fc1caf", "message": "Make wire logging options configurable", "committedDate": "2020-04-27T18:17:58Z", "type": "commit"}, {"oid": "951c81a55c213b32111d8464016358bef20cb144", "url": "https://github.com/ConsenSys/teku/commit/951c81a55c213b32111d8464016358bef20cb144", "message": "Inline option names and default values. Make wire log options hidden", "committedDate": "2020-04-28T09:41:25Z", "type": "commit"}, {"oid": "cfb16a9657aa4980e8b7b38dc751a552b96e443e", "url": "https://github.com/ConsenSys/teku/commit/cfb16a9657aa4980e8b7b38dc751a552b96e443e", "message": "Merge remote-tracking branch 'pegasys/master' into feature-gossip-options", "committedDate": "2020-04-28T09:41:34Z", "type": "commit"}, {"oid": "f2c92947a4d47982e6e3ce9fe828b1ee6554cf9f", "url": "https://github.com/ConsenSys/teku/commit/f2c92947a4d47982e6e3ce9fe828b1ee6554cf9f", "message": "Move Gossip and WireLogs configs to a separate classes with default instances. Make all the classes back immutable", "committedDate": "2020-04-28T10:39:31Z", "type": "commit"}, {"oid": "8d7da373f833e5f9911c72146289bfa883e16b89", "url": "https://github.com/ConsenSys/teku/commit/8d7da373f833e5f9911c72146289bfa883e16b89", "message": "Revert accidentally committed change", "committedDate": "2020-04-28T10:42:57Z", "type": "commit"}, {"oid": "1ec01900560e220f21c5f75c6dab30ffe72607c6", "url": "https://github.com/ConsenSys/teku/commit/1ec01900560e220f21c5f75c6dab30ffe72607c6", "message": "Bump libp2p version to 0.3.4", "committedDate": "2020-04-28T11:09:05Z", "type": "commit"}, {"oid": "c29f44602821a68696ac1934b0a69d2b28a34a15", "url": "https://github.com/ConsenSys/teku/commit/c29f44602821a68696ac1934b0a69d2b28a34a15", "message": "Override gossip messageId accroding to the spec", "committedDate": "2020-04-28T11:09:35Z", "type": "commit"}, {"oid": "9076a9280a0c3b07bc7ea0fe57bf55a385801acb", "url": "https://github.com/ConsenSys/teku/commit/9076a9280a0c3b07bc7ea0fe57bf55a385801acb", "message": "Move custom Gossip router to a separate class", "committedDate": "2020-04-28T17:18:29Z", "type": "commit"}, {"oid": "a9225dd6d9fc2769b80f56927212e7f74e40bb7f", "url": "https://github.com/ConsenSys/teku/commit/a9225dd6d9fc2769b80f56927212e7f74e40bb7f", "message": "Apply spotless", "committedDate": "2020-04-28T17:37:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyNjI1OQ==", "url": "https://github.com/ConsenSys/teku/pull/1688#discussion_r416926259", "bodyText": "I think this is the wrong base64.  It should be the URL safe variant without padding.  To do that in discv5 I had to use: https://github.com/PegaSysEng/discovery/blob/247107e61cd53ed4c05ea2401985094ae1c3668d/src/main/java/org/ethereum/beacon/discovery/schema/NodeRecord.java#L84", "author": "ajsutton", "createdAt": "2020-04-28T21:12:59Z", "path": "networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/Eth2GossipRouter.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.networking.p2p.libp2p;\n+\n+import io.libp2p.pubsub.gossip.GossipRouter;\n+import org.apache.tuweni.crypto.Hash;\n+import org.apache.tuweni.io.Base64;\n+import org.jetbrains.annotations.NotNull;\n+import pubsub.pb.Rpc.Message;\n+\n+/** Customization of a standard Libp2p Gossip router for Eth2 spec */\n+public class Eth2GossipRouter extends GossipRouter {\n+\n+  @NotNull\n+  @Override\n+  protected String getMessageId(@NotNull Message msg) {\n+    return Base64.encodeBytes(Hash.sha2_256(msg.getData().toByteArray()));", "originalCommit": "a9225dd6d9fc2769b80f56927212e7f74e40bb7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0Njc4Mw==", "url": "https://github.com/ConsenSys/teku/pull/1688#discussion_r417146783", "bodyText": "Oh, thanks! Absolutely my bad, should read the spec more carefully.\nDidn't even think there might be 'wrong' base64 :)", "author": "Nashatyrev", "createdAt": "2020-04-29T08:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyNjI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0Nzc2MQ==", "url": "https://github.com/ConsenSys/teku/pull/1688#discussion_r417147761", "bodyText": "BTW, wouldn't this work?\njava.util.Base64.getUrlEncoder().withoutPadding()\nUPD: just checked - these are equivalent", "author": "Nashatyrev", "createdAt": "2020-04-29T08:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyNjI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcyNzY5MQ==", "url": "https://github.com/ConsenSys/teku/pull/1688#discussion_r417727691", "bodyText": "I did not know that method existed.... ConsenSys/discovery#43 will switch discovery to use it.", "author": "ajsutton", "createdAt": "2020-04-30T03:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyNjI1OQ=="}], "type": "inlineReview"}, {"oid": "5b68c657ac089fbd8db694487750314155160f21", "url": "https://github.com/ConsenSys/teku/commit/5b68c657ac089fbd8db694487750314155160f21", "message": "Fix the wrong Base64", "committedDate": "2020-04-29T08:55:58Z", "type": "commit"}, {"oid": "79a84503e11917e85395d68756332929f22ba402", "url": "https://github.com/ConsenSys/teku/commit/79a84503e11917e85395d68756332929f22ba402", "message": "Merge remote-tracking branch 'pegasys/master' into feature-eth2-gossip-message-id\n\n# Conflicts:\n#\tartemis/src/test/resources/loggingOptions_config.yaml\n#\tnetworking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/LibP2PNetwork.java", "committedDate": "2020-04-29T09:54:40Z", "type": "commit"}, {"oid": "648489f9f580701d12455b1672149b4756f98207", "url": "https://github.com/ConsenSys/teku/commit/648489f9f580701d12455b1672149b4756f98207", "message": "Merge branch 'master' into feature-eth2-gossip-message-id", "committedDate": "2020-04-29T10:53:44Z", "type": "commit"}, {"oid": "7308ff4f626fb75d59cb1723a44f7279bcd3efcd", "url": "https://github.com/ConsenSys/teku/commit/7308ff4f626fb75d59cb1723a44f7279bcd3efcd", "message": "Merge branch 'master' into feature-eth2-gossip-message-id", "committedDate": "2020-04-30T10:22:11Z", "type": "commit"}]}