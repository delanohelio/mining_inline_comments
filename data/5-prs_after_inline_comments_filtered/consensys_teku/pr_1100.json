{"pr_number": 1100, "pr_title": "V0.10.1", "pr_createdAt": "2020-01-21T15:16:01Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1100", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxOTEwNw==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r369319107", "bodyText": "It's generally better to avoid getters having to create the object they're returning.  Was there a reason we're now deferring the creation of these BLSPublicKey and BLSSecretKey objects?\nAdmittedly I normally don't like constructors creating new objects but given these are just wrappers the benefit of caching them seems to outweigh the slight unpleasantness of constructors doing \"work\".", "author": "ajsutton", "createdAt": "2020-01-22T00:40:26Z", "path": "util/src/main/java/tech/pegasys/artemis/util/bls/BLSKeyPair.java", "diffHunk": "@@ -28,20 +27,15 @@ public static BLSKeyPair random(int entropy) {\n     return new BLSKeyPair(KeyPair.random(entropy));\n   }\n \n-  public BLSKeyPair(BLSPublicKey publicKey, BLSSecretKey secretKey) {\n-    this.publicKey = publicKey;\n-    this.secretKey = secretKey;\n-  }\n-\n   public BLSKeyPair(KeyPair keyPair) {\n-    this(new BLSPublicKey(keyPair.publicKey()), new BLSSecretKey(keyPair.secretKey()));\n+    this.keyPair = keyPair;\n   }\n \n   public BLSPublicKey getPublicKey() {\n-    return publicKey;\n+    return new BLSPublicKey(keyPair.publicKey());\n   }\n \n   public BLSSecretKey getSecretKey() {\n-    return secretKey;\n+    return new BLSSecretKey(keyPair.secretKey());\n   }", "originalCommit": "30f12a83d44975d14b1f5262f0858b810a00e7b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUxMjgzNw==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r369512837", "bodyText": "Yeah, I've reverted and improved this now. Not sure what I was thinking.", "author": "benjaminion", "createdAt": "2020-01-22T11:43:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxOTEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxOTk2MA==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r369319960", "bodyText": "Yay! Sanity!", "author": "ajsutton", "createdAt": "2020-01-22T00:43:48Z", "path": "util/src/main/java/tech/pegasys/artemis/util/config/Constants.java", "diffHunk": "@@ -210,21 +211,21 @@ public static void setConstants(String Constants) {\n       EFFECTIVE_BALANCE_INCREMENT = 1000000000L;\n \n       // Initial values\n-      GENESIS_SLOT = 0;\n-      GENESIS_EPOCH = 0;\n+      GENESIS_FORK_VERSION = new Bytes4(Bytes.fromHexString(\"0x00000001\"));\n       BLS_WITHDRAWAL_PREFIX = Bytes.wrap(new byte[1]);\n \n       // Time parameters\n+      MIN_GENESIS_DELAY = 300;", "originalCommit": "30f12a83d44975d14b1f5262f0858b810a00e7b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1150bb078a54f4dab702a7be615db6039b0ed2be", "url": "https://github.com/ConsenSys/teku/commit/1150bb078a54f4dab702a7be615db6039b0ed2be", "message": "Tidy up\n\nIn particular, be more assertive about encapsulating the Mikuli library.", "committedDate": "2020-01-22T11:54:46Z", "type": "forcePushed"}, {"oid": "26f1fe0129d68fdd9d7b081874ef0c0877c3d4d3", "url": "https://github.com/ConsenSys/teku/commit/26f1fe0129d68fdd9d7b081874ef0c0877c3d4d3", "message": "Spotless", "committedDate": "2020-01-26T22:01:14Z", "type": "forcePushed"}, {"oid": "e2051788d8d745edcdb304d53f0140e198c8f817", "url": "https://github.com/ConsenSys/teku/commit/e2051788d8d745edcdb304d53f0140e198c8f817", "message": "Remove G2Point from reference test code", "committedDate": "2020-01-28T09:50:40Z", "type": "forcePushed"}, {"oid": "db46f80a0e2b3702b1bfcb121adcb027c41af9cf", "url": "https://github.com/ConsenSys/teku/commit/db46f80a0e2b3702b1bfcb121adcb027c41af9cf", "message": "Big BLS refactor\n\nIn preparation for spec 0.10.0.\nWIP - temporarily breaks many things.", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "e431e2f8d5470d709d538443d4f881f202c07355", "url": "https://github.com/ConsenSys/teku/commit/e431e2f8d5470d709d538443d4f881f202c07355", "message": "Continued refactoring", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "c42904b3519124eb15bb1c241dc3a866e0cee950", "url": "https://github.com/ConsenSys/teku/commit/c42904b3519124eb15bb1c241dc3a866e0cee950", "message": "Move aggregation over to the new BLS", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "b88755e449f5fc9c009594c0e6fd8df6eca909ac", "url": "https://github.com/ConsenSys/teku/commit/b88755e449f5fc9c009594c0e6fd8df6eca909ac", "message": "Implements (and passes) v0.10.0 BLS reference tests", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "11575a7a5862d432e82379d38c45e1235cf3a5db", "url": "https://github.com/ConsenSys/teku/commit/11575a7a5862d432e82379d38c45e1235cf3a5db", "message": "Up to v0.10.0 except for some tests", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "25600a67bbcfe613f6a5db13455755c7dbf4bf5e", "url": "https://github.com/ConsenSys/teku/commit/25600a67bbcfe613f6a5db13455755c7dbf4bf5e", "message": "Passing Artemis unit tests", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "b1986b6cf5bfb10fdd60924bf4f8e7a983bc0f9c", "url": "https://github.com/ConsenSys/teku/commit/b1986b6cf5bfb10fdd60924bf4f8e7a983bc0f9c", "message": "Tidy up\n\nIn particular, be more assertive about encapsulating the Mikuli library.", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "9fafc38a6c38ffa95e9d9a2e902134463382ebd5", "url": "https://github.com/ConsenSys/teku/commit/9fafc38a6c38ffa95e9d9a2e902134463382ebd5", "message": "Add toString methods to keep benchmarks happy", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "859553739d9745a3908e32a25229c12c9d239489", "url": "https://github.com/ConsenSys/teku/commit/859553739d9745a3908e32a25229c12c9d239489", "message": "Update BLS tests to v0.10.1\n\nUnfortunately, there remains a bug in the fastAggregateVerify reference test data,\nso those will fail until the test suite is fixed.", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "557c29bd150c4d2c9b39838a37fd5d93fedbaf57", "url": "https://github.com/ConsenSys/teku/commit/557c29bd150c4d2c9b39838a37fd5d93fedbaf57", "message": "Spotless", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "5753d9484ef0746a8aef885d6e66082a03d41bfc", "url": "https://github.com/ConsenSys/teku/commit/5753d9484ef0746a8aef885d6e66082a03d41bfc", "message": "Remove G2Point from reference test code", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "5b0b63bca452069fb4fb5e7ff9d05a9510060855", "url": "https://github.com/ConsenSys/teku/commit/5b0b63bca452069fb4fb5e7ff9d05a9510060855", "message": "Modify build.gradle to get CircleCI to update reftest cache", "committedDate": "2020-01-29T09:07:34Z", "type": "commit"}, {"oid": "5b0b63bca452069fb4fb5e7ff9d05a9510060855", "url": "https://github.com/ConsenSys/teku/commit/5b0b63bca452069fb4fb5e7ff9d05a9510060855", "message": "Modify build.gradle to get CircleCI to update reftest cache", "committedDate": "2020-01-29T09:07:34Z", "type": "forcePushed"}, {"oid": "e696e7c1f22c8a602c5780b8372bba0dc392e809", "url": "https://github.com/ConsenSys/teku/commit/e696e7c1f22c8a602c5780b8372bba0dc392e809", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into v0.10.0\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/BeaconStateUtil.java", "committedDate": "2020-02-02T21:09:32Z", "type": "commit"}, {"oid": "14e5a3bda391f0735d3da3fb582e93cc73c581b6", "url": "https://github.com/ConsenSys/teku/commit/14e5a3bda391f0735d3da3fb582e93cc73c581b6", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into v0.10.0", "committedDate": "2020-02-03T21:02:22Z", "type": "commit"}, {"oid": "3d29739884389af79e84ddeff2477a5f2d7ec550", "url": "https://github.com/ConsenSys/teku/commit/3d29739884389af79e84ddeff2477a5f2d7ec550", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into v0.10.0\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/BeaconStateUtil.java\n#\tethereum/statetransition/src/test-support/java/tech/pegasys/artemis/statetransition/BeaconChainUtil.java\n#\tvalidator/client/src/main/java/tech/pegasys/artemis/validator/client/ValidatorClient.java", "committedDate": "2020-02-19T23:42:11Z", "type": "commit"}, {"oid": "cf8f09e3c8e9cfb65269f8351333382c928d8305", "url": "https://github.com/ConsenSys/teku/commit/cf8f09e3c8e9cfb65269f8351333382c928d8305", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into v0.10.0\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/blocks/BeaconBlockHeader.java\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/Fork.java", "committedDate": "2020-02-25T04:39:40Z", "type": "commit"}, {"oid": "ce1d281b035c6c216c293e633dc220457a42f4b9", "url": "https://github.com/ConsenSys/teku/commit/ce1d281b035c6c216c293e633dc220457a42f4b9", "message": "Spotless.", "committedDate": "2020-02-25T05:13:20Z", "type": "commit"}, {"oid": "bee4bf765cef89c11fde52b796fa0f766cae3602", "url": "https://github.com/ConsenSys/teku/commit/bee4bf765cef89c11fde52b796fa0f766cae3602", "message": "Adjust random seeds to ensure we actually get different blocks.", "committedDate": "2020-02-25T05:37:50Z", "type": "commit"}, {"oid": "b30aedf3bc8f18bfa7c12061ed1bce05b81ed92f", "url": "https://github.com/ConsenSys/teku/commit/b30aedf3bc8f18bfa7c12061ed1bce05b81ed92f", "message": "Merge branch 'master' into v0.10.0", "committedDate": "2020-02-27T23:23:32Z", "type": "commit"}, {"oid": "2a3a11d4fe1456aafde07186fa016bd22f491fa6", "url": "https://github.com/ConsenSys/teku/commit/2a3a11d4fe1456aafde07186fa016bd22f491fa6", "message": "Use new constant name.", "committedDate": "2020-02-27T23:43:32Z", "type": "commit"}, {"oid": "a5f39a63ce89c63307ccbc00056f6fb1debd6433", "url": "https://github.com/ConsenSys/teku/commit/a5f39a63ce89c63307ccbc00056f6fb1debd6433", "message": "Fix one more reference.", "committedDate": "2020-02-27T23:46:24Z", "type": "commit"}, {"oid": "dc9a0eb8bdcd82cbf6c59714839ff449ca63d0ef", "url": "https://github.com/ConsenSys/teku/commit/dc9a0eb8bdcd82cbf6c59714839ff449ca63d0ef", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into v0.10.0", "committedDate": "2020-03-08T22:24:38Z", "type": "commit"}, {"oid": "f3a0b0d728439876790867dd33c33b06abee2a06", "url": "https://github.com/ConsenSys/teku/commit/f3a0b0d728439876790867dd33c33b06abee2a06", "message": "Merge branch 'master' into v0.10.0", "committedDate": "2020-03-11T13:47:16Z", "type": "commit"}, {"oid": "b8f54d20f74edc8470c936056d3efb3c14c6348e", "url": "https://github.com/ConsenSys/teku/commit/b8f54d20f74edc8470c936056d3efb3c14c6348e", "message": "Run spotless", "committedDate": "2020-03-11T14:00:03Z", "type": "commit"}, {"oid": "5603110be382a62305456b70bc1563e02f8c535c", "url": "https://github.com/ConsenSys/teku/commit/5603110be382a62305456b70bc1563e02f8c535c", "message": "Upgrade to fork choice spec v0.10.1", "committedDate": "2020-03-11T15:05:16Z", "type": "commit"}, {"oid": "c9a1375d75e4e21185d53d4b7ecf1d2859707f29", "url": "https://github.com/ConsenSys/teku/commit/c9a1375d75e4e21185d53d4b7ecf1d2859707f29", "message": "Run spotless", "committedDate": "2020-03-11T15:07:23Z", "type": "commit"}, {"oid": "6e19fea34fd65a87de7d672108663001bb63d53e", "url": "https://github.com/ConsenSys/teku/commit/6e19fea34fd65a87de7d672108663001bb63d53e", "message": "Fix block condition checking order", "committedDate": "2020-03-11T16:10:50Z", "type": "commit"}, {"oid": "3d862e7c870c8c6bdeb584eb0a62c252e8e09ecd", "url": "https://github.com/ConsenSys/teku/commit/3d862e7c870c8c6bdeb584eb0a62c252e8e09ecd", "message": "Run spotless", "committedDate": "2020-03-11T16:31:17Z", "type": "commit"}, {"oid": "d6d0f838baed4f2ea5863d3f804b64e10f314892", "url": "https://github.com/ConsenSys/teku/commit/d6d0f838baed4f2ea5863d3f804b64e10f314892", "message": "compute_signing_root changes for Validator spec", "committedDate": "2020-03-11T17:17:19Z", "type": "commit"}, {"oid": "a01dd352ad1bbb022cc406ed2fe7c1ea89e7edc8", "url": "https://github.com/ConsenSys/teku/commit/a01dd352ad1bbb022cc406ed2fe7c1ea89e7edc8", "message": "Fix signer", "committedDate": "2020-03-11T17:46:09Z", "type": "commit"}, {"oid": "0ec1a58e1ffc28de14962b0dafabcb4a8608b054", "url": "https://github.com/ConsenSys/teku/commit/0ec1a58e1ffc28de14962b0dafabcb4a8608b054", "message": "Run spotless", "committedDate": "2020-03-11T18:04:37Z", "type": "commit"}, {"oid": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "url": "https://github.com/ConsenSys/teku/commit/d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "message": "BroadcastAttestation event when correct block arrives", "committedDate": "2020-03-11T18:09:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMDQ0Ng==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391320446", "bodyText": "The aim of these checks is to bail out before any processing is done if we don't have the block ancestor or other prerequisites.  We don't commit the transaction so any changes made to the store are discarded if we fail either of these checks.  So we should just combine them into one again.", "author": "ajsutton", "createdAt": "2020-03-11T23:08:24Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/ForkChoiceUtil.java", "diffHunk": "@@ -290,15 +285,21 @@ public static BlockImportResult on_block(\n     final BeaconState preState = store.getBlockState(block.getParent_root());\n \n     // Return early if precondition checks fail;\n-    final Optional<BlockImportResult> maybeFailure =\n-        checkOnBlockPreconditions(block, preState, store);\n-    if (maybeFailure.isPresent()) {\n-      return maybeFailure.get();\n+    final Optional<BlockImportResult> maybeFailureOnPreStorageConditions =\n+        checkOnBlockPreStorageConditions(block, preState, store);\n+    if (maybeFailureOnPreStorageConditions.isPresent()) {\n+      return maybeFailureOnPreStorageConditions.get();\n     }\n \n     // Add new block to the store\n     store.putBlock(block.hash_tree_root(), signed_block);\n \n+    final Optional<BlockImportResult> maybeFailureOnPostStorageConditions =\n+        checkOnBlockPostStorageConditions(block, store);\n+    if (maybeFailureOnPostStorageConditions.isPresent()) {\n+      return maybeFailureOnPostStorageConditions.get();\n+    }", "originalCommit": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwMTU4OQ==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391701589", "bodyText": "get_ancestor throws a NullPointerException if we combine these condition checks.", "author": "cemozerr", "createdAt": "2020-03-12T15:28:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMDQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwMjU3NA==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391702574", "bodyText": "Spec explicitly adds the block to the store before doing the 'postStorageConditionCheck' as I call here.", "author": "cemozerr", "createdAt": "2020-03-12T15:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMDQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwNDk3NA==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391704974", "bodyText": "Unless we add the block that is being processed here to the store, get_ancestor does not have access to this block and thus throws the NPE. In order to combine these checks and still not get the NPE, we'd need to change get_ancestor, which doesn't seem to be worth the trade-off especially since most of the fork choice is going to be modified during the protoArray change.", "author": "cemozerr", "createdAt": "2020-03-12T15:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMDQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0OTEyMg==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391949122", "bodyText": "Yeah, the spec has always added before doing all the checks and we deliberately moved away from that. :)\nWe already know that we have the block's parent on the chain, so we can just call get_ancestor(store, block.getParent_root(), finalizedSlot);.  Which is what we used to have.  This check hasn't actually changed, the spec just checks the slot first then the get_ancestor call whereas previously it did it the other way around.", "author": "ajsutton", "createdAt": "2020-03-12T22:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMDQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIyNTc3NA==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r392225774", "bodyText": "Alright reverting. That makes sense.", "author": "cemozerr", "createdAt": "2020-03-13T13:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMDQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyNjQ4Mw==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391326483", "bodyText": "We expect that any justified checkpoint has a checkpoint state stored for it. Otherwise we'll throw NullPointerException when later processing attestations in get_latest_attesting_balance:\nBeaconState state = store.getCheckpointState(store.getJustifiedCheckpoint());\nThe fork choice spec actually does this store because it says to run on_attestation on every received attestation whether by gossip included in a block.  Apart from the validation checks for attestations, that ensures that the target state is in store.checkpoint_states and that store.latest_messages gets updates based on the attestation.\nSo storing these checkpoint states is part of the on_attestation processing.  The other half is updating latest messages which a ticket is open for (but unclear on how important it is to do when we're syncing such old blocks).\nTechnically, we're storing fewer checkpoint states that the spec implementation.  on_attestation would store the checkpoint state for the target of any attestation, we only store it when there are enough attestations to make it the best justified or justified state.", "author": "ajsutton", "createdAt": "2020-03-11T23:28:02Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/ForkChoiceUtil.java", "diffHunk": "@@ -318,11 +319,13 @@ public static BlockImportResult on_block(\n       try {\n         if (justifiedCheckpoint.getEpoch().compareTo(store.getBestJustifiedCheckpoint().getEpoch())\n             > 0) {\n+          // TODO: Fork Choice Spec does not necessarily ask us to store this checkpoint state\n           storeCheckpointState(\n               store, st, justifiedCheckpoint, store.getBlockState(justifiedCheckpoint.getRoot()));\n           store.setBestJustifiedCheckpoint(justifiedCheckpoint);\n         }\n         if (should_update_justified_checkpoint(store, justifiedCheckpoint)) {\n+          // TODO: Fork Choice Spec does not necessarily ask us to store this checkpoint state", "originalCommit": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcxMTgxMw==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391711813", "bodyText": "Makes sense.", "author": "cemozerr", "createdAt": "2020-03-12T15:44:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyNjQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyNzA4NQ==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391327085", "bodyText": "The only case where this actually fails is if we're asking process_slots to go backwards (ie get to a slot prior to the starting state slot) - since we're definitely not doing that, the exception handling is just annoying boilerplate.\nPer the spec we should be applying all of on_attestation to all attestations in the block which would trigger this same processing anyway.", "author": "ajsutton", "createdAt": "2020-03-11T23:30:03Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/ForkChoiceUtil.java", "diffHunk": "@@ -335,27 +338,46 @@ public static BlockImportResult on_block(\n     // Update finalized checkpoint\n     final Checkpoint finalizedCheckpoint = state.getFinalized_checkpoint();\n     if (finalizedCheckpoint.getEpoch().compareTo(store.getFinalizedCheckpoint().getEpoch()) > 0) {\n+      // TODO: Fork Choice Spec does not necessarily ask us to store this checkpoint state, so if we\n+      // do error here and exit, we will possibly have acted differently than other nodes.", "originalCommit": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcxMjAyOA==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391712028", "bodyText": "I see.", "author": "cemozerr", "createdAt": "2020-03-12T15:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyNzA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyNzMzMA==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391327330", "bodyText": "We need to ensure the checkpoint state for this new justified checkpoint is stored.", "author": "ajsutton", "createdAt": "2020-03-11T23:30:56Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/ForkChoiceUtil.java", "diffHunk": "@@ -335,27 +338,46 @@ public static BlockImportResult on_block(\n     // Update finalized checkpoint\n     final Checkpoint finalizedCheckpoint = state.getFinalized_checkpoint();\n     if (finalizedCheckpoint.getEpoch().compareTo(store.getFinalizedCheckpoint().getEpoch()) > 0) {\n+      // TODO: Fork Choice Spec does not necessarily ask us to store this checkpoint state, so if we\n+      // do error here and exit, we will possibly have acted differently than other nodes.\n       try {\n         storeCheckpointState(\n             store, st, finalizedCheckpoint, store.getBlockState(finalizedCheckpoint.getRoot()));\n       } catch (SlotProcessingException | EpochProcessingException e) {\n         return BlockImportResult.failedStateTransition(e);\n       }\n       store.setFinalizedCheckpoint(finalizedCheckpoint);\n+      UnsignedLong finalized_slot = store.getFinalizedCheckpoint().getEpochStartSlot();\n+      // Update justified if new justified is later than store justified\n+      // or if store justified is not in chain with finalized checkpoint\n+      if (state\n+                  .getCurrent_justified_checkpoint()\n+                  .getEpoch()\n+                  .compareTo(store.getJustifiedCheckpoint().getEpoch())\n+              > 0\n+          || !get_ancestor(store, store.getJustifiedCheckpoint().getRoot(), finalized_slot)\n+              .equals(store.getFinalizedCheckpoint().getRoot())) {\n+        store.setJustifiedCheckpoint(state.getCurrent_justified_checkpoint());", "originalCommit": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcxMjEyNw==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391712127", "bodyText": "Done.", "author": "cemozerr", "createdAt": "2020-03-12T15:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyNzMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyODQ0MA==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391328440", "bodyText": "This seems wrong.  We might import two blocks for the same slot and then this would cause us to produce two conflicting attestations and get slashed. We may also do that because this event is fired both here and in process_slot - if the process_slot fired first and then this block was imported we'd potentially wind up with two different targets for the produced attestations.\nedit: I can see this is aiming to meet the first paragraph under https://github.com/ethereum/eth2.0-specs/blob/v0.10.1/specs/phase0/validator.md#attesting  which says we can publish attestations \"early\" if we already have the block for that slot.  I suspect we should have nice centralised logic for doing that coordination and not split it across multiple classes to be really sure we have it right.  Strongly suspect we should do it as a separate PR (and since it's not a consensus affecting change it can go straight to master).", "author": "ajsutton", "createdAt": "2020-03-11T23:35:00Z", "path": "services/beaconchain/src/main/java/tech/pegasys/artemis/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -381,6 +382,14 @@ public void setNodeSlotAccordingToDBStore(Store store) {\n     LOG.info(\"Node being started from database.\");\n   }\n \n+  @Subscribe\n+  public void onImportedBlock(ImportedBlockEvent event) {\n+    if (event.getBlock().getSlot().equals(nodeSlot)) {\n+      Bytes32 headBlockRoot = this.stateProcessor.processHead();\n+      this.eventBus.post(new BroadcastAttestationEvent(headBlockRoot, nodeSlot));\n+    }\n+  }", "originalCommit": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIyODM0MA==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r392228340", "bodyText": "https://pegasys1.atlassian.net/browse/BC-309?atlOrigin=eyJpIjoiZDNmNGY0ZDk3ZmYzNDI2OWE0Yzk5NWRkMDdhNzY0MDMiLCJwIjoiaiJ9", "author": "cemozerr", "createdAt": "2020-03-13T13:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyODQ0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIzNzE3OA==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r392237178", "bodyText": "Reverted these changes in this PR.", "author": "cemozerr", "createdAt": "2020-03-13T13:47:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyODQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyOTAwNg==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391329006", "bodyText": "I guess that resolves my concerns about getting slashed above, but this still feels very weird to me.", "author": "ajsutton", "createdAt": "2020-03-11T23:36:34Z", "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/ValidatorCoordinator.java", "diffHunk": "@@ -182,10 +185,15 @@ public void onBlockImported(ImportedBlockEvent event) {\n   @Subscribe\n   public void onAttestationEvent(BroadcastAttestationEvent event) throws IllegalArgumentException {\n     try {\n+\n+      UnsignedLong slot = event.getNodeSlot();\n+      if (slot.compareTo(latestBroadcastAttestationEventSlot) <= 0) {\n+        return;\n+      }", "originalCommit": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyOTYwMA==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391329600", "bodyText": "I suspect we should do this in the opposite order.  Otherwise we risk publishing attestations and then failing unexpectedly before we update the latestBroadcastAttestationEventSlot which opens us to being slashed.\nAs mentioned above (sorry for scattering this across multiple comments) - let's pull this out of this PR and do it separately.", "author": "ajsutton", "createdAt": "2020-03-11T23:38:45Z", "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/ValidatorCoordinator.java", "diffHunk": "@@ -212,6 +220,7 @@ public void onAttestationEvent(BroadcastAttestationEvent event) throws IllegalAr\n       asyncProduceAttestations(\n           attesterInformations, headState, getGenericAttestationData(headState, headBlock));\n \n+      latestBroadcastAttestationEventSlot = slot;", "originalCommit": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcxMzIyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391713221", "bodyText": "I'd say let's keep this in this PR to be fully done with the v0.10.1 change and if we want to make it more robust we can make a ticket and come back to it later on.", "author": "cemozerr", "createdAt": "2020-03-12T15:46:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyOTYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcxMzg1OQ==", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391713859", "bodyText": "Unless this seems like it will definitely fail in production, after I put these lines in the opposite order, I see no problem merging this in for now.", "author": "cemozerr", "createdAt": "2020-03-12T15:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyOTYwMA=="}], "type": "inlineReview"}, {"oid": "d6ed6fa1329d5630c074adbde0f33fb09e2b17c0", "url": "https://github.com/ConsenSys/teku/commit/d6ed6fa1329d5630c074adbde0f33fb09e2b17c0", "message": "Resolve comments", "committedDate": "2020-03-12T15:50:58Z", "type": "commit"}, {"oid": "e71cad79e8a256fddc8e89aa748689857f600426", "url": "https://github.com/ConsenSys/teku/commit/e71cad79e8a256fddc8e89aa748689857f600426", "message": "Merge remote-tracking branch 'remotes/origin/master' into benjaminion-v0.10.0\n\n# Conflicts:\n#\tartemis/src/main/java/tech/pegasys/artemis/DepositCommand.java\n#\tdata/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconChainHeadHandler.java\n#\tdata/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconChainHeadHandlerTest.java", "committedDate": "2020-03-12T15:54:44Z", "type": "commit"}, {"oid": "d911bffc8642702b219bbaaa0c68b690d63f2d62", "url": "https://github.com/ConsenSys/teku/commit/d911bffc8642702b219bbaaa0c68b690d63f2d62", "message": "Fix issues relating to merge", "committedDate": "2020-03-12T16:00:10Z", "type": "commit"}, {"oid": "aeda537fb7d4d6930f06915334c9f95791fd3cc2", "url": "https://github.com/ConsenSys/teku/commit/aeda537fb7d4d6930f06915334c9f95791fd3cc2", "message": "Fix tests", "committedDate": "2020-03-12T19:10:07Z", "type": "commit"}, {"oid": "76c570c5bb3f60c54bc77b59bb55090414339319", "url": "https://github.com/ConsenSys/teku/commit/76c570c5bb3f60c54bc77b59bb55090414339319", "message": "Merge remote-tracking branch 'remotes/origin/master' into benjaminion-v0.10.0\n\n# Conflicts:\n#\tservices/beaconchain/src/main/java/tech/pegasys/artemis/services/beaconchain/BeaconChainController.java", "committedDate": "2020-03-12T19:48:06Z", "type": "commit"}, {"oid": "4e37badd800d700a4cdff0b77fa96590c6f4327c", "url": "https://github.com/ConsenSys/teku/commit/4e37badd800d700a4cdff0b77fa96590c6f4327c", "message": "Fix merge", "committedDate": "2020-03-12T19:57:35Z", "type": "commit"}, {"oid": "89cd93a5236f75d05d960c18bd6ffd5ea589fbe4", "url": "https://github.com/ConsenSys/teku/commit/89cd93a5236f75d05d960c18bd6ffd5ea589fbe4", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into v0.10.0", "committedDate": "2020-03-12T23:05:10Z", "type": "commit"}, {"oid": "f2ae27891476addc7067cdaa8f8571d22e4f5a13", "url": "https://github.com/ConsenSys/teku/commit/f2ae27891476addc7067cdaa8f8571d22e4f5a13", "message": "Revert block check changes", "committedDate": "2020-03-13T13:42:51Z", "type": "commit"}, {"oid": "62fe7770d2ebc384a63965a582062aae7f6cf06e", "url": "https://github.com/ConsenSys/teku/commit/62fe7770d2ebc384a63965a582062aae7f6cf06e", "message": "Revert changes on broadcasting attestations", "committedDate": "2020-03-13T13:47:04Z", "type": "commit"}, {"oid": "569d4c1e0e6381eb9d9294c954fd375b120c0c00", "url": "https://github.com/ConsenSys/teku/commit/569d4c1e0e6381eb9d9294c954fd375b120c0c00", "message": "Merge branch 'master' into v0.10.0", "committedDate": "2020-03-13T13:47:47Z", "type": "commit"}, {"oid": "55041fd2cfaa0f4d56e62af41f1190e43535ae7f", "url": "https://github.com/ConsenSys/teku/commit/55041fd2cfaa0f4d56e62af41f1190e43535ae7f", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into v0.10.0", "committedDate": "2020-03-16T03:59:16Z", "type": "commit"}, {"oid": "b83ee290748ef43069ce234dad9f2d0ae9aaffcb", "url": "https://github.com/ConsenSys/teku/commit/b83ee290748ef43069ce234dad9f2d0ae9aaffcb", "message": "Remove unnecessary comment", "committedDate": "2020-03-16T12:49:11Z", "type": "commit"}]}