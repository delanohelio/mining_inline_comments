{"pr_number": 1719, "pr_title": "Handle requests from peers which have disconnected prior to processing", "pr_createdAt": "2020-05-05T05:42:58Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1719", "timeline": [{"oid": "81e69b9d1e6a3f45eceb22242c287db61ce21a97", "url": "https://github.com/ConsenSys/teku/commit/81e69b9d1e6a3f45eceb22242c287db61ce21a97", "message": "Handle requests from peers which disconnect before we get to processing the request.", "committedDate": "2020-05-05T05:40:35Z", "type": "commit"}, {"oid": "56032389699463847b05c12fa4e46c2a60885ae7", "url": "https://github.com/ConsenSys/teku/commit/56032389699463847b05c12fa4e46c2a60885ae7", "message": "Improve log message.", "committedDate": "2020-05-05T05:42:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3NzgwNg==", "url": "https://github.com/ConsenSys/teku/pull/1719#discussion_r420177806", "bodyText": "This isn't really a server error - what about completing with a PeerDisconnectedException?  And then we could update completeWithError to only attempt writing the message to our peer if it gets an RcpException.", "author": "mbaxter", "createdAt": "2020-05-05T15:00:04Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/PeerRequiredLocalMessageHandler.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.networking.eth2.rpc.core;\n+\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+\n+public abstract class PeerRequiredLocalMessageHandler<I, O> implements LocalMessageHandler<I, O> {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  @Override\n+  public void onIncomingMessage(\n+      final Optional<Eth2Peer> maybePeer, final I message, final ResponseCallback<O> callback) {\n+    maybePeer.ifPresentOrElse(\n+        peer -> onIncomingMessage(peer, message, callback),\n+        () -> {\n+          LOG.trace(\n+              \"Ignoring message of type {} because peer has disconnected\", message.getClass());\n+          callback.completeWithError(\n+              new RpcException(RpcResponseStatus.SERVER_ERROR_CODE, \"Peer disconnected\"));", "originalCommit": "56032389699463847b05c12fa4e46c2a60885ae7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxMjk1Mg==", "url": "https://github.com/ConsenSys/teku/pull/1719#discussion_r420412952", "bodyText": "I like the separation of RPC error responses from unexpected errors.  We do need to send unexpected responses back as a SERVER_ERROR response but can skip doing so for PeerDisconnectedException and it would generally be nicer to push that handling into RpcResponseCallback instead of randomly reporting server errors from the handling code.\nSo I've now got two methods in ResponseCallback completeWithErrorResponse(RpcException) and completeWithUnexpectedError(Throwable).", "author": "ajsutton", "createdAt": "2020-05-05T21:19:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3NzgwNg=="}], "type": "inlineReview"}, {"oid": "f0f5d53070010171c852e33e7ad3f4d96abd6757", "url": "https://github.com/ConsenSys/teku/commit/f0f5d53070010171c852e33e7ad3f4d96abd6757", "message": "Separate rpc error responses from unexpected errors.", "committedDate": "2020-05-05T21:20:39Z", "type": "commit"}, {"oid": "47ca6883d45aeea2387c373dddcf7215fd672a94", "url": "https://github.com/ConsenSys/teku/commit/47ca6883d45aeea2387c373dddcf7215fd672a94", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into handle-requests-from-disconnected-peers", "committedDate": "2020-05-05T21:22:19Z", "type": "commit"}]}