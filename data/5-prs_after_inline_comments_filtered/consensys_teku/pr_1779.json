{"pr_number": 1779, "pr_title": "[BC-428] Disconnect a peer which doesn't respond to N PINGs in a row", "pr_createdAt": "2020-05-13T11:37:55Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1779", "timeline": [{"oid": "6260b2495cdb129790773fda4ca231cb7f5884be", "url": "https://github.com/ConsenSys/teku/commit/6260b2495cdb129790773fda4ca231cb7f5884be", "message": "Disconnect a peer which doesn't respond to N PINGs in a row", "committedDate": "2020-05-13T11:33:49Z", "type": "commit"}, {"oid": "c44c4f879e65c14748c59c31af021323c97ca194", "url": "https://github.com/ConsenSys/teku/commit/c44c4f879e65c14748c59c31af021323c97ca194", "message": "Fix test compilation error", "committedDate": "2020-05-13T11:40:57Z", "type": "commit"}, {"oid": "10f75d4a590020a2cb037c5d4251d139354cf7c6", "url": "https://github.com/ConsenSys/teku/commit/10f75d4a590020a2cb037c5d4251d139354cf7c6", "message": "Merge remote-tracking branch 'pegasys/master' into feature-ping-timeout", "committedDate": "2020-05-13T11:42:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyMDY5Mw==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424520693", "bodyText": "I'd probably move this logic into Eth2PeerManager - the other peer validation / management logic is in the manager.", "author": "mbaxter", "createdAt": "2020-05-13T15:17:23Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java", "diffHunk": "@@ -171,9 +180,16 @@ void markChainValidated() {\n   }\n \n   public SafeFuture<UnsignedLong> sendPing() {\n-    return requestSingleItem(rpcMethods.ping(), metadataMessagesFactory.createPingMessage())\n-        .thenApply(PingMessage::getSeqNumber)\n-        .thenPeek(this::updateMetadataSeqNumber);\n+    if (outstandingPings.getAndIncrement() >= outstandingPingsThreshold) {", "originalCommit": "10f75d4a590020a2cb037c5d4251d139354cf7c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxNTQ1Mg==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424615452", "bodyText": "Yep, that makes sense \ud83d\udc4d", "author": "Nashatyrev", "createdAt": "2020-05-13T17:38:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyMDY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyMTMzOA==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424521338", "bodyText": "Even though the peer is probably gone, I don't think it would hurt to send a goodBye message just in case.", "author": "mbaxter", "createdAt": "2020-05-13T15:18:15Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java", "diffHunk": "@@ -171,9 +180,16 @@ void markChainValidated() {\n   }\n \n   public SafeFuture<UnsignedLong> sendPing() {\n-    return requestSingleItem(rpcMethods.ping(), metadataMessagesFactory.createPingMessage())\n-        .thenApply(PingMessage::getSeqNumber)\n-        .thenPeek(this::updateMetadataSeqNumber);\n+    if (outstandingPings.getAndIncrement() >= outstandingPingsThreshold) {\n+      LOG.debug(\"Disconnecting the peer {} due to PING timeout.\", getId());\n+      disconnectImmediately();", "originalCommit": "10f75d4a590020a2cb037c5d4251d139354cf7c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyMzM0NA==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424523344", "bodyText": "I think this is too fast - looks like we're sometimes disconnecting the peer before the network notices we're connected.", "author": "mbaxter", "createdAt": "2020-05-13T15:20:59Z", "path": "networking/eth2/src/integration-test/java/tech/pegasys/teku/networking/eth2/PingIntegrationTest.java", "diffHunk": "@@ -114,4 +116,64 @@ public void testPingPeriodically() throws Exception {\n     // detecting that ping was automatically sent via updated att subnets of the remote peer\n     waitFor(() -> assertThat(peer1.getRemoteAttestationSubnets()).contains(expectedBitvector1));\n   }\n+\n+  @Test\n+  public void testManualPingTimeout() throws Exception {\n+    // sending PING manually to check eth2RpcOutstandingPingThreshold works correctly\n+    Duration pingPeriod = Duration.ofDays(1);\n+    network1 =\n+        networkFactory\n+            .builder()\n+            .eth2RpcPingInterval(pingPeriod)\n+            .eth2RpcOutstandingPingThreshold(2)\n+            // remove PING method\n+            .rpcMethodsModifier(m -> Stream.of(m).filter(t -> !t.getId().contains(\"/ping\")))\n+            .startNetwork();\n+    network2 =\n+        networkFactory\n+            .builder()\n+            .eth2RpcPingInterval(pingPeriod)\n+            .eth2RpcOutstandingPingThreshold(2)\n+            .peer(network1)\n+            .startNetwork();\n+\n+    peer1 = network2.getPeer(network1.getNodeId()).orElseThrow();\n+    peer2 = network1.getPeer(network2.getNodeId()).orElseThrow();\n+\n+    assertThatThrownBy(() -> peer1.sendPing().get(5, TimeUnit.SECONDS)).isNotNull();\n+    assertThat(peer1.isConnected()).isTrue();\n+    assertThatThrownBy(() -> peer1.sendPing().get(5, TimeUnit.SECONDS)).isNotNull();\n+    assertThat(peer1.isConnected()).isTrue();\n+    // the 3rd ping attempt should disconnect the peer since there are 2 unanswered PING requests\n+    assertThatThrownBy(() -> peer1.sendPing().get(5, TimeUnit.SECONDS)).isNotNull();\n+    waitFor(() -> assertThat(peer1.isConnected()).isFalse());\n+  }\n+\n+  @Test\n+  public void testAutomaticPingTimeout() throws Exception {\n+    // PING is send automatically each 100ms.\n+    // The peer should be finally disconnected as it doesn't answer\n+    Duration pingPeriod = Duration.ofMillis(100);", "originalCommit": "10f75d4a590020a2cb037c5d4251d139354cf7c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5MjkzMw==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424592933", "bodyText": "Yeah, tried to fix this in a 'right' way with overriding BeaconChainMethods in Eth2PeerManager but came up with a pretty long chain of changes which are subject for a separate PR.\nI can change this to 1000ms but it still can fail potentially.\nOr I can remove this test at all since it nearly duplicates the previous test", "author": "Nashatyrev", "createdAt": "2020-05-13T17:01:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyMzM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5OTI1Nw==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424599257", "bodyText": "yeah - I think the manual one is pretty good.  maybe we should just cut this one ...", "author": "mbaxter", "createdAt": "2020-05-13T17:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyMzM0NA=="}], "type": "inlineReview"}, {"oid": "408b5ce82b8fb07f516efc293f3218c1344860d5", "url": "https://github.com/ConsenSys/teku/commit/408b5ce82b8fb07f516efc293f3218c1344860d5", "message": "Move ping timeout disconnect logic to the PeerManager", "committedDate": "2020-05-13T17:37:02Z", "type": "commit"}, {"oid": "51a18153ea2e726507a48c0932dc117a53e26282", "url": "https://github.com/ConsenSys/teku/commit/51a18153ea2e726507a48c0932dc117a53e26282", "message": "Adjust the ping test", "committedDate": "2020-05-13T17:37:43Z", "type": "commit"}, {"oid": "4d4e89cd39e7cb9da978008421784e9b73ec461f", "url": "https://github.com/ConsenSys/teku/commit/4d4e89cd39e7cb9da978008421784e9b73ec461f", "message": "Apply spotless", "committedDate": "2020-05-13T17:39:06Z", "type": "commit"}, {"oid": "648c427ceddcadc57a620d43a16358a1d39ed7cd", "url": "https://github.com/ConsenSys/teku/commit/648c427ceddcadc57a620d43a16358a1d39ed7cd", "message": "Remove unused field", "committedDate": "2020-05-13T17:43:40Z", "type": "commit"}, {"oid": "caf4357aa778ecc14fa24f6cd216e4304e47ff91", "url": "https://github.com/ConsenSys/teku/commit/caf4357aa778ecc14fa24f6cd216e4304e47ff91", "message": "Fix test compilation error", "committedDate": "2020-05-13T17:49:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1MDgyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424750821", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              void sendPeriodicPing(Eth2Peer peer) {\n          \n          \n            \n              @VisibleForTesting\n          \n          \n            \n              void sendPeriodicPing(Eth2Peer peer) {", "author": "mbaxter", "createdAt": "2020-05-13T21:48:38Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -148,13 +153,25 @@ public void onConnect(final Peer peer) {\n     @SuppressWarnings(\"FutureReturnValueIgnored\")\n     SafeFuture<Void> pingTask =\n         asyncRunner.runWithFixedDelay(\n-            eth2Peer::sendPing,\n+            () -> sendPeriodicPing(eth2Peer),\n             eth2RpcPingInterval.toMillis(),\n             TimeUnit.MILLISECONDS,\n             t -> LOG.debug(\"Exception executing ping\", t));\n     peer.subscribeDisconnect(() -> pingTask.cancel(false));\n   }\n \n+  void sendPeriodicPing(Eth2Peer peer) {", "originalCommit": "caf4357aa778ecc14fa24f6cd216e4304e47ff91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NDMzNA==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424754334", "bodyText": "Not sure we need the logging on successfully sending the ping - seems noisey.", "author": "mbaxter", "createdAt": "2020-05-13T21:56:58Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -148,13 +153,25 @@ public void onConnect(final Peer peer) {\n     @SuppressWarnings(\"FutureReturnValueIgnored\")\n     SafeFuture<Void> pingTask =\n         asyncRunner.runWithFixedDelay(\n-            eth2Peer::sendPing,\n+            () -> sendPeriodicPing(eth2Peer),\n             eth2RpcPingInterval.toMillis(),\n             TimeUnit.MILLISECONDS,\n             t -> LOG.debug(\"Exception executing ping\", t));\n     peer.subscribeDisconnect(() -> pingTask.cancel(false));\n   }\n \n+  void sendPeriodicPing(Eth2Peer peer) {\n+    if (peer.getOutstandingPings() >= eth2RpcOutstandingPingThreshold) {\n+      LOG.debug(\"Disconnecting the peer {} due to PING timeout.\", peer.getId());\n+      peer.disconnectCleanly(DisconnectReason.REMOTE_FAULT);\n+    } else {\n+      peer.sendPing()\n+          .finish(\n+              i -> LOG.trace(\"Periodic ping returned {} from {}\", i, peer.getId()),", "originalCommit": "caf4357aa778ecc14fa24f6cd216e4304e47ff91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDczMw==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424984733", "bodyText": "IMHO doesn't look too noisy for trace level: one log in 10 sec per one peer. That also carries some helpful info: the ping executed successfully and it's return value is logged.\nThat may even deserve debug level \ud83d\ude04", "author": "Nashatyrev", "createdAt": "2020-05-14T09:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NDMzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1ODUzMw==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424758533", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              Eth2PeerManager getPeerManager() {\n          \n          \n            \n              @VisibleForTesting\n          \n          \n            \n              Eth2PeerManager getPeerManager() {", "author": "mbaxter", "createdAt": "2020-05-13T22:07:01Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -169,4 +169,8 @@ public void unsubscribeFromAttestationSubnetId(final int subnetId) {\n   public void setLongTermAttestationSubnetSubscriptions(final Iterable<Integer> subnetIndices) {\n     attestationSubnetService.updateSubscriptions(subnetIndices);\n   }\n+\n+  Eth2PeerManager getPeerManager() {", "originalCommit": "caf4357aa778ecc14fa24f6cd216e4304e47ff91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MTM5OA==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424761398", "bodyText": "(optional) Another option for structuring this would be to have the Eth2NetworkFactory return a special subclass of Eth2Network that exposes extra test utilities (MockEth2Network.sendPeriodicPing())", "author": "mbaxter", "createdAt": "2020-05-13T22:13:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1ODUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk5MTgwMg==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424991802", "bodyText": "Yep, good idea \ud83d\udc4d\nDo you mean that MockEth2Network interface should be a part of testFixtures module?\nThough in this case we would need another Eth2Network wrapper which is extra boilerplate\nAnother option is add this interface to the main src module and implement it by Eth2Network implementations but not expose via 'public API'. Like this interface in libp2p", "author": "Nashatyrev", "createdAt": "2020-05-14T09:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1ODUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIzOTkxOQ==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r425239919", "bodyText": "Do you mean that MockEth2Network interface should be a part of testFixtures module?\n\nRight.\n\nThough in this case we would need another Eth2Network wrapper which is extra boilerplate\n\nYeah, there's usually a bit of boilerplate involved in test utilities.  Even though it can get a bit verbose, I tend to take this approach because it helps us avoid adding testing-specific logic to production classes.", "author": "mbaxter", "createdAt": "2020-05-14T15:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1ODUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MTY4OQ==", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424761689", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public Eth2NetworkBuilder eth2RpcOutstandingPingThreshold(int eth2RpcOutstandingPingThreshold) {\n          \n          \n            \n              public Eth2NetworkBuilder eth2RpcOutstandingPingThreshold(final int eth2RpcOutstandingPingThreshold) {", "author": "mbaxter", "createdAt": "2020-05-13T22:14:37Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java", "diffHunk": "@@ -178,4 +182,10 @@ public Eth2NetworkBuilder eth2RpcPingInterval(Duration eth2RpcPingInterval) {\n     this.eth2RpcPingInterval = eth2RpcPingInterval;\n     return this;\n   }\n+\n+  public Eth2NetworkBuilder eth2RpcOutstandingPingThreshold(int eth2RpcOutstandingPingThreshold) {", "originalCommit": "caf4357aa778ecc14fa24f6cd216e4304e47ff91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "99fb091d1d4106e7caa4ad328f1cf5bae49af60b", "url": "https://github.com/ConsenSys/teku/commit/99fb091d1d4106e7caa4ad328f1cf5bae49af60b", "message": "Add @VisibleForTesting annotations", "committedDate": "2020-05-14T09:19:12Z", "type": "commit"}, {"oid": "a07525e3d99c9402a472042bf0937e60f5194bc7", "url": "https://github.com/ConsenSys/teku/commit/a07525e3d99c9402a472042bf0937e60f5194bc7", "message": "Add final modifiers", "committedDate": "2020-05-14T09:19:46Z", "type": "commit"}, {"oid": "53467875260a0e54c3479e154deb1e10663aebad", "url": "https://github.com/ConsenSys/teku/commit/53467875260a0e54c3479e154deb1e10663aebad", "message": "Merge remote-tracking branch 'pegasys/master' into feature-ping-timeout", "committedDate": "2020-05-14T09:20:20Z", "type": "commit"}, {"oid": "4e0ddb4f9c33475003ab4d84191db8418f8e6fa7", "url": "https://github.com/ConsenSys/teku/commit/4e0ddb4f9c33475003ab4d84191db8418f8e6fa7", "message": "Apply spotless", "committedDate": "2020-05-14T09:37:06Z", "type": "commit"}]}