{"pr_number": 1238, "pr_title": "Added /node/syncing endpoint", "pr_createdAt": "2020-02-27T04:04:25Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1238", "timeline": [{"oid": "3179c239b172e1434a624dfdbf5957b838585009", "url": "https://github.com/ConsenSys/teku/commit/3179c239b172e1434a624dfdbf5957b838585009", "message": "1162 add openapi documentation for /beacon/state\n\nfixes\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>\n#1162", "committedDate": "2020-02-20T21:22:35Z", "type": "commit"}, {"oid": "dcbafd86535ef2922773129d374f7daafd240ad6", "url": "https://github.com/ConsenSys/teku/commit/dcbafd86535ef2922773129d374f7daafd240ad6", "message": "Merge remote-tracking branch 'upstream/master' into 1162-beacon-state-endpoint", "committedDate": "2020-02-20T21:38:46Z", "type": "commit"}, {"oid": "78fe18117d2273bd80839da0d4790b4e6a35ded2", "url": "https://github.com/ConsenSys/teku/commit/78fe18117d2273bd80839da0d4790b4e6a35ded2", "message": "Update data/provider/src/test/java/tech/pegasys/artemis/provider/JsonProviderTest.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-20T23:18:56Z", "type": "commit"}, {"oid": "7c9993c89dfaf51817257d39d826f0df7921e026", "url": "https://github.com/ConsenSys/teku/commit/7c9993c89dfaf51817257d39d826f0df7921e026", "message": "Update data/provider/src/test/java/tech/pegasys/artemis/provider/JsonProviderTest.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-20T23:19:09Z", "type": "commit"}, {"oid": "6976a4cb586ae3a63fbb7f12d6bc7150fd159bd4", "url": "https://github.com/ConsenSys/teku/commit/6976a4cb586ae3a63fbb7f12d6bc7150fd159bd4", "message": "Update data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconStateHandler.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-21T00:04:40Z", "type": "commit"}, {"oid": "3ff1866ccb2fc804217dfc74b75fe91bb83bfe67", "url": "https://github.com/ConsenSys/teku/commit/3ff1866ccb2fc804217dfc74b75fe91bb83bfe67", "message": "changes per review comments.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-02-21T00:58:18Z", "type": "commit"}, {"oid": "14a63c721cdd76f135a55160dcf70293d4194c98", "url": "https://github.com/ConsenSys/teku/commit/14a63c721cdd76f135a55160dcf70293d4194c98", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis", "committedDate": "2020-02-21T04:00:15Z", "type": "commit"}, {"oid": "8d94ce8c5afc48963b965f552ae86e3751565e8d", "url": "https://github.com/ConsenSys/teku/commit/8d94ce8c5afc48963b965f552ae86e3751565e8d", "message": "Merge branch 'master' of github.com:macfarla/artemis", "committedDate": "2020-02-21T04:00:36Z", "type": "commit"}, {"oid": "9d44076869eb8ca6ca31603ba27687451cc4d53b", "url": "https://github.com/ConsenSys/teku/commit/9d44076869eb8ca6ca31603ba27687451cc4d53b", "message": "merge\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-23T22:54:56Z", "type": "commit"}, {"oid": "55ae0421ef0932152a8b29ee3c67c90192945f06", "url": "https://github.com/ConsenSys/teku/commit/55ae0421ef0932152a8b29ee3c67c90192945f06", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis", "committedDate": "2020-02-26T08:17:13Z", "type": "commit"}, {"oid": "8bea67681aefe6a1c0f33ffb566d9cf2221e83c6", "url": "https://github.com/ConsenSys/teku/commit/8bea67681aefe6a1c0f33ffb566d9cf2221e83c6", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis", "committedDate": "2020-02-26T21:57:43Z", "type": "commit"}, {"oid": "16cd4b08b5230c3485acd90b0923b724f97af985", "url": "https://github.com/ConsenSys/teku/commit/16cd4b08b5230c3485acd90b0923b724f97af985", "message": "Merge branch 'master' of github.com:PegaSysEng/teku", "committedDate": "2020-02-26T22:34:19Z", "type": "commit"}, {"oid": "b1f0ca5691347bde9f9365d5ddba4067a60e071f", "url": "https://github.com/ConsenSys/teku/commit/b1f0ca5691347bde9f9365d5ddba4067a60e071f", "message": "wiring of sync status through restAPI\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-27T01:44:34Z", "type": "commit"}, {"oid": "77bde85717cc013ceaf3494e087d740396e14555", "url": "https://github.com/ConsenSys/teku/commit/77bde85717cc013ceaf3494e087d740396e14555", "message": "use syncStatus structure\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-27T02:31:30Z", "type": "commit"}, {"oid": "abf41fb2494330bbe6d68a5dbf5978a3e6e94173", "url": "https://github.com/ConsenSys/teku/commit/abf41fb2494330bbe6d68a5dbf5978a3e6e94173", "message": "changed return type\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-27T03:34:23Z", "type": "commit"}, {"oid": "9a9ef7da8b8d325df6020252312c5da3f8d64f10", "url": "https://github.com/ConsenSys/teku/commit/9a9ef7da8b8d325df6020252312c5da3f8d64f10", "message": "only get syncing slots if syncing is active\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-27T03:58:33Z", "type": "commit"}, {"oid": "44333fc29388d7b850ab8788289ca221ae0465ba", "url": "https://github.com/ConsenSys/teku/commit/44333fc29388d7b850ab8788289ca221ae0465ba", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into 1180-api", "committedDate": "2020-02-27T04:01:19Z", "type": "commit"}, {"oid": "35ea9a2db978999d598462bda7b1d7911a119185", "url": "https://github.com/ConsenSys/teku/commit/35ea9a2db978999d598462bda7b1d7911a119185", "message": "nested json response\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-27T04:35:25Z", "type": "commit"}, {"oid": "13e7a342b117755d94e0467fe14823e92aa0941b", "url": "https://github.com/ConsenSys/teku/commit/13e7a342b117755d94e0467fe14823e92aa0941b", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into 1180-api", "committedDate": "2020-02-27T04:37:23Z", "type": "commit"}, {"oid": "3ce7a274b80319ecef2c552dc1d65328936d5527", "url": "https://github.com/ConsenSys/teku/commit/3ce7a274b80319ecef2c552dc1d65328936d5527", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into 1180-api", "committedDate": "2020-02-27T05:05:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMzNzY4Mg==", "url": "https://github.com/ConsenSys/teku/pull/1238#discussion_r385337682", "bodyText": "avoid  using @NotNull annotation", "author": "rolfyone", "createdAt": "2020-02-27T19:55:01Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/NodeSyncingHandler.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.beaconrestapi.beaconhandlers;\n+\n+import static tech.pegasys.artemis.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.artemis.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.artemis.beaconrestapi.RestApiConstants.TAG_NODE;\n+\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.artemis.beaconrestapi.schema.SyncingResponse;\n+import tech.pegasys.artemis.provider.JsonProvider;\n+import tech.pegasys.artemis.sync.SyncService;\n+\n+public class NodeSyncingHandler implements Handler {\n+\n+  private final SyncService syncService;\n+\n+  public NodeSyncingHandler(SyncService syncService, JsonProvider jsonProvider) {\n+    this.syncService = syncService;\n+    this.jsonProvider = jsonProvider;\n+  }\n+\n+  public static final String ROUTE = \"/node/syncing\";\n+  private final JsonProvider jsonProvider;\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Get syncing info from the running beacon node.\",\n+      tags = {TAG_NODE},\n+      description = \"Requests that the beacon node gives information about its syncing state\",\n+      responses = {\n+        @OpenApiResponse(status = RES_OK, content = @OpenApiContent(from = SyncingResponse.class)),\n+        @OpenApiResponse(status = RES_INTERNAL_ERROR)\n+      })\n+  @Override\n+  public void handle(@NotNull Context ctx) throws Exception {", "originalCommit": "3ce7a274b80319ecef2c552dc1d65328936d5527", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM0MzMwMg==", "url": "https://github.com/ConsenSys/teku/pull/1238#discussion_r385343302", "bodyText": "really not a fan of isIs_syncing..\nMaybe if the flag is called 'syncing' and then the is function could be isSyncing...", "author": "rolfyone", "createdAt": "2020-02-27T20:06:19Z", "path": "sync/src/main/java/tech/pegasys/artemis/sync/SyncingStatus.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.sync;\n+\n+public class SyncingStatus {\n+  private final boolean is_syncing;\n+  private final SyncStatus syncStatus;\n+\n+  public SyncingStatus(final boolean is_syncing, final SyncStatus syncStatus) {\n+    this.is_syncing = is_syncing;\n+    this.syncStatus = syncStatus;\n+  }\n+\n+  public SyncStatus getSync_status() {\n+    return syncStatus;\n+  }\n+\n+  public boolean isIs_syncing() {\n+    return is_syncing;\n+  }", "originalCommit": "3ce7a274b80319ecef2c552dc1d65328936d5527", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzMzU4Nw==", "url": "https://github.com/ConsenSys/teku/pull/1238#discussion_r385433587", "bodyText": "made public final with the proper names", "author": "macfarla", "createdAt": "2020-02-27T23:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM0MzMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM0NDIzMg==", "url": "https://github.com/ConsenSys/teku/pull/1238#discussion_r385344232", "bodyText": "nit: if we're using this a lot, could static import UnsignedLong.ZERO...", "author": "rolfyone", "createdAt": "2020-02-27T20:08:12Z", "path": "sync/src/main/java/tech/pegasys/artemis/sync/util/NoopSyncService.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.sync.util;\n+\n+import com.google.common.eventbus.EventBus;\n+import com.google.common.primitives.UnsignedLong;\n+import tech.pegasys.artemis.networking.eth2.Eth2Network;\n+import tech.pegasys.artemis.statetransition.blockimport.BlockImporter;\n+import tech.pegasys.artemis.storage.ChainStorageClient;\n+import tech.pegasys.artemis.sync.SyncService;\n+import tech.pegasys.artemis.sync.SyncStatus;\n+import tech.pegasys.artemis.sync.SyncingStatus;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+\n+public class NoopSyncService extends SyncService {\n+\n+  public NoopSyncService(\n+      final EventBus eventBus,\n+      final Eth2Network network,\n+      final ChainStorageClient storageClient,\n+      final BlockImporter blockImporter) {\n+    super(eventBus, network, storageClient, blockImporter);\n+  }\n+\n+  @Override\n+  protected SafeFuture<?> doStart() {\n+    return SafeFuture.completedFuture(null);\n+  }\n+\n+  @Override\n+  protected SafeFuture<?> doStop() {\n+    return SafeFuture.completedFuture(null);\n+  }\n+\n+  @Override\n+  public SyncingStatus getSyncStatus() {\n+    return new SyncingStatus(\n+        false, new SyncStatus(UnsignedLong.ZERO, UnsignedLong.ZERO, UnsignedLong.ZERO));", "originalCommit": "3ce7a274b80319ecef2c552dc1d65328936d5527", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQxNDU0Mg==", "url": "https://github.com/ConsenSys/teku/pull/1238#discussion_r385414542", "bodyText": "done", "author": "macfarla", "createdAt": "2020-02-27T22:43:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM0NDIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM0Nzg2NQ==", "url": "https://github.com/ConsenSys/teku/pull/1238#discussion_r385347865", "bodyText": "theres a lot of setup in this unit test. i'd probably at least suggest moving the 'when' down next to the handle, and putting in a line break - then the 3 lines down the bottom are the test, the rest above is the setup.\nThe restApi SyncingStatus object looks very much like artemis.sync.SyncStatus - should we be just using that object? Currently the two syncingStatus objects are a> confusing, and b> pretty different.\nWe could potentially do away with the SyncingResponse altogether and just return the serialized schema.SyncingStatus?", "author": "rolfyone", "createdAt": "2020-02-27T20:15:34Z", "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/NodeSyncingHandlerTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.beaconrestapi.beaconhandlers;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import io.javalin.http.Context;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.beaconrestapi.schema.SyncingResponse;\n+import tech.pegasys.artemis.provider.JsonProvider;\n+import tech.pegasys.artemis.sync.SyncService;\n+import tech.pegasys.artemis.sync.SyncStatus;\n+import tech.pegasys.artemis.sync.SyncingStatus;\n+\n+public class NodeSyncingHandlerTest {\n+  private Context context = mock(Context.class);\n+  private final JsonProvider jsonProvider = new JsonProvider();\n+  private final SyncService syncService = mock(SyncService.class);\n+\n+  @Test\n+  public void shouldReturnTrueWhenSyncing() throws Exception {\n+    final boolean isSyncing = true;\n+    final UnsignedLong startSlot = UnsignedLong.ONE;\n+    final UnsignedLong currentSlot = UnsignedLong.valueOf(5);\n+    final UnsignedLong highestSlot = UnsignedLong.valueOf(10);\n+    SyncingStatus syncingStatus =\n+        new SyncingStatus(isSyncing, new SyncStatus(startSlot, currentSlot, highestSlot));\n+    tech.pegasys.artemis.beaconrestapi.schema.SyncingStatus syncStatus =\n+        new tech.pegasys.artemis.beaconrestapi.schema.SyncingStatus(\n+            startSlot, currentSlot, highestSlot);\n+    SyncingResponse syncingResponse = new SyncingResponse(isSyncing, syncStatus);\n+    when(syncService.getSyncStatus()).thenReturn(syncingStatus);\n+    NodeSyncingHandler handler = new NodeSyncingHandler(syncService, jsonProvider);\n+    handler.handle(context);\n+    verify(context).result(jsonProvider.objectToJSON(syncingResponse));\n+  }\n+\n+  @Test\n+  public void shouldReturnFalseWhenNotSyncing() throws Exception {\n+    final boolean isSyncing = true;\n+    final UnsignedLong startSlot = UnsignedLong.ZERO;\n+    final UnsignedLong currentSlot = UnsignedLong.ZERO;\n+    final UnsignedLong highestSlot = UnsignedLong.ZERO;\n+    SyncingStatus syncingStatus =\n+        new SyncingStatus(isSyncing, new SyncStatus(startSlot, currentSlot, highestSlot));\n+    tech.pegasys.artemis.beaconrestapi.schema.SyncingStatus syncStatus =\n+        new tech.pegasys.artemis.beaconrestapi.schema.SyncingStatus(\n+            startSlot, currentSlot, highestSlot);\n+    SyncingResponse syncingResponse = new SyncingResponse(isSyncing, syncStatus);\n+    when(syncService.getSyncStatus()).thenReturn(syncingStatus);\n+    NodeSyncingHandler handler = new NodeSyncingHandler(syncService, jsonProvider);\n+    handler.handle(context);\n+    verify(context).result(jsonProvider.objectToJSON(syncingResponse));", "originalCommit": "3ce7a274b80319ecef2c552dc1d65328936d5527", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzMzY1Ng==", "url": "https://github.com/ConsenSys/teku/pull/1238#discussion_r385433656", "bodyText": "simplified", "author": "macfarla", "createdAt": "2020-02-27T23:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM0Nzg2NQ=="}], "type": "inlineReview"}, {"oid": "ea555c399e3b10a51b8c1e43d69ffa81ea541629", "url": "https://github.com/ConsenSys/teku/commit/ea555c399e3b10a51b8c1e43d69ffa81ea541629", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into 1180-api", "committedDate": "2020-02-27T22:06:32Z", "type": "commit"}, {"oid": "66bbfa65db22a529519a8bb8b50870b2520dd884", "url": "https://github.com/ConsenSys/teku/commit/66bbfa65db22a529519a8bb8b50870b2520dd884", "message": "PR review\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-27T23:00:53Z", "type": "commit"}, {"oid": "5b2a7f56cb3cc9e14f8089fa955d380071fb330a", "url": "https://github.com/ConsenSys/teku/commit/5b2a7f56cb3cc9e14f8089fa955d380071fb330a", "message": "public final fields on response object\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-27T23:09:24Z", "type": "commit"}, {"oid": "ea50381a7a61378ecbd8a7c4dfb74cacfefc92a3", "url": "https://github.com/ConsenSys/teku/commit/ea50381a7a61378ecbd8a7c4dfb74cacfefc92a3", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into 1180-api", "committedDate": "2020-02-27T23:41:46Z", "type": "commit"}, {"oid": "f05d68fa72f8f711e3980e725a4b6b5221c2ad8f", "url": "https://github.com/ConsenSys/teku/commit/f05d68fa72f8f711e3980e725a4b6b5221c2ad8f", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into 1180-api", "committedDate": "2020-02-27T23:46:20Z", "type": "commit"}]}