{"pr_number": 2258, "pr_title": "[#1980] - validator subcommands status output", "pr_createdAt": "2020-06-29T23:20:22Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2258", "timeline": [{"oid": "c570b38b094b44f5978eabd087b5e9587c9b69bc", "url": "https://github.com/ConsenSys/teku/commit/c570b38b094b44f5978eabd087b5e9587c9b69bc", "message": "Deposit Generate Output\n\n -- Log encrypted file status\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-06-29T23:17:07Z", "type": "commit"}, {"oid": "7df56e1d9f147114896f8fafd3263c61551b34c7", "url": "https://github.com/ConsenSys/teku/commit/7df56e1d9f147114896f8fafd3263c61551b34c7", "message": "Merge remote-tracking branch 'upstream/master' into deposit_generation_output\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-06-29T23:18:29Z", "type": "commit"}, {"oid": "94c651d3061f94209d1b9413756f5912cf0a967d", "url": "https://github.com/ConsenSys/teku/commit/94c651d3061f94209d1b9413756f5912cf0a967d", "message": "spotless fix\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-06-29T23:23:00Z", "type": "commit"}, {"oid": "48ebd11493b2f202a7b66278e556b5a980b70f49", "url": "https://github.com/ConsenSys/teku/commit/48ebd11493b2f202a7b66278e556b5a980b70f49", "message": "Update display confirmation with contract address and network\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-06-29T23:53:13Z", "type": "commit"}, {"oid": "e713456147fcdb7e39aca37af5629677b5d37485", "url": "https://github.com/ConsenSys/teku/commit/e713456147fcdb7e39aca37af5629677b5d37485", "message": "Display status messages for register deposit\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-06-30T02:13:35Z", "type": "commit"}, {"oid": "0e6cb4f0a0bd21795030fee3021ef0c4c3ce15b4", "url": "https://github.com/ConsenSys/teku/commit/0e6cb4f0a0bd21795030fee3021ef0c4c3ce15b4", "message": "Adding status log in DepositRegisterCommand\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-07-01T00:16:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NTAwNQ==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r448075005", "bodyText": "Does there need to be a noOp for error messages as well? Instead of noop method on the SubCommandLogger thinking that NoOp SubCommandLogger that doesn't output would be nicer.", "author": "jframe", "createdAt": "2020-07-01T02:04:38Z", "path": "logging/src/main/java/tech/pegasys/teku/logging/SubCommandLogger.java", "diffHunk": "@@ -30,6 +30,10 @@ public void display(final String message) {\n     System.out.println(message);\n   }\n \n+  public void noOp(final String message) {", "originalCommit": "0e6cb4f0a0bd21795030fee3021ef0c4c3ce15b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5MTU0MQ==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r448691541", "bodyText": "removed the method.", "author": "usmansaleem", "createdAt": "2020-07-02T01:00:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NTAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NTg2NQ==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r448075865", "bodyText": "This I think could be part of the sendDeposit so it could be reused between both commands", "author": "jframe", "createdAt": "2020-07-01T02:07:56Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/deposit/DepositGenerateAndRegisterCommand.java", "diffHunk": "@@ -96,8 +97,34 @@ public void run() {\n   @NotNull\n   private Function<ValidatorKeys, SafeFuture<TransactionReceipt>> registerValidator(\n       final RegisterAction registerAction) {\n-    return validatorKey ->\n-        registerAction.sendDeposit(\n-            validatorKey.getValidatorKey(), validatorKey.getWithdrawalKey().getPublicKey());\n+    return validatorKey -> {\n+      final BLSKeyPair validatorKeyPair = validatorKey.getValidatorKey();\n+      final BLSKeyPair withdrawalKeyPair = validatorKey.getWithdrawalKey();\n+      if (displayConfirmation) {\n+        SUB_COMMAND_LOG.display(\n+            String.format(\n+                \"%nSending deposit for Validator Key [%s].%n\",\n+                validatorKeyPair.getPublicKey().toString()));\n+      }\n+\n+      final SafeFuture<TransactionReceipt> transactionReceiptSafeFuture =\n+          registerAction.sendDeposit(validatorKeyPair, withdrawalKeyPair.getPublicKey());\n+\n+      if (displayConfirmation) {\n+        transactionReceiptSafeFuture.finish(\n+            transactionReceipt ->\n+                SUB_COMMAND_LOG.display(\n+                    String.format(\n+                        \"Transaction for Validator Key [%s] Completed. Transaction Hash: [%s]%n\",\n+                        validatorKeyPair.getPublicKey().toString(),\n+                        transactionReceipt.getTransactionHash())),\n+            exception ->\n+                SUB_COMMAND_LOG.error(\n+                    String.format(\n+                        \"Transaction for Validator Key [%s] Failed: Message: [%s]%n\",\n+                        validatorKeyPair.getPublicKey().toString(), exception.getMessage())));\n+      }\n+      return transactionReceiptSafeFuture;", "originalCommit": "0e6cb4f0a0bd21795030fee3021ef0c4c3ce15b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5MTYxOQ==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r448691619", "bodyText": "refactored down the stack.", "author": "usmansaleem", "createdAt": "2020-07-02T01:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NTg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NjIxMg==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r448076212", "bodyText": "Should be a different flag I think, the displayConfirmation flag seems like different setting to suppressing the output", "author": "jframe", "createdAt": "2020-07-01T02:09:23Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/deposit/DepositGenerateAndRegisterCommand.java", "diffHunk": "@@ -96,8 +97,34 @@ public void run() {\n   @NotNull\n   private Function<ValidatorKeys, SafeFuture<TransactionReceipt>> registerValidator(\n       final RegisterAction registerAction) {\n-    return validatorKey ->\n-        registerAction.sendDeposit(\n-            validatorKey.getValidatorKey(), validatorKey.getWithdrawalKey().getPublicKey());\n+    return validatorKey -> {\n+      final BLSKeyPair validatorKeyPair = validatorKey.getValidatorKey();\n+      final BLSKeyPair withdrawalKeyPair = validatorKey.getWithdrawalKey();\n+      if (displayConfirmation) {", "originalCommit": "0e6cb4f0a0bd21795030fee3021ef0c4c3ce15b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5MTY3MA==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r448691670", "bodyText": "flag updated.", "author": "usmansaleem", "createdAt": "2020-07-02T01:01:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NjIxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NjU5Mg==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r448076592", "bodyText": "commandOuput instead of log? This has different purpose to the main logger", "author": "jframe", "createdAt": "2020-07-01T02:10:51Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/deposit/EncryptedKeystoreWriter.java", "diffHunk": "@@ -39,16 +40,19 @@\n   private final String validatorKeyPassword;\n   private final String withdrawalKeyPassword;\n   private final Path outputPath;\n+  private final Consumer<String> log;\n \n   public EncryptedKeystoreWriter(\n       final SecureRandom secureRandom,\n       final String validatorKeyPassword,\n       final String withdrawalKeyPassword,\n-      final Path outputPath) {\n+      final Path outputPath,\n+      final Consumer<String> log) {", "originalCommit": "0e6cb4f0a0bd21795030fee3021ef0c4c3ce15b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5MTc5NQ==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r448691795", "bodyText": "updated variable.", "author": "usmansaleem", "createdAt": "2020-07-02T01:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NjU5Mg=="}], "type": "inlineReview"}, {"oid": "e72b4608fdf5bf75cd56df06d494c866de0c9828", "url": "https://github.com/ConsenSys/teku/commit/e72b4608fdf5bf75cd56df06d494c866de0c9828", "message": "Refactoring dev cli option displayConfirmation to quiet\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-07-02T00:52:24Z", "type": "commit"}, {"oid": "7728d3586c27b16c9754da806a369e349e3abebc", "url": "https://github.com/ConsenSys/teku/commit/7728d3586c27b16c9754da806a369e349e3abebc", "message": "Merge remote-tracking branch 'upstream/master' into deposit_generation_output\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-07-02T00:52:37Z", "type": "commit"}, {"oid": "5d8542855e3c2133e84d1bfb07b63eef99fd5095", "url": "https://github.com/ConsenSys/teku/commit/5d8542855e3c2133e84d1bfb07b63eef99fd5095", "message": "Merge remote-tracking branch 'upstream/master' into deposit_generation_output\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-07-03T00:01:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM3ODY5NQ==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r449378695", "bodyText": "nit: Not sure if this should be a hidden option. Seems like a sensible option to have?", "author": "jframe", "createdAt": "2020-07-03T05:12:34Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/deposit/DepositGenerateAndRegisterCommand.java", "diffHunk": "@@ -50,11 +50,9 @@\n   @Mixin private GenerateParams generateParams;\n \n   @Option(\n-      names = {\"--Xconfirm-enabled\"},\n-      arity = \"1\",\n-      defaultValue = \"true\",\n+      names = {\"--Xquiet\"},\n       hidden = true)", "originalCommit": "5d8542855e3c2133e84d1bfb07b63eef99fd5095", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM3OTkyNw==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r449379927", "bodyText": "Why did we rename it to not be compliant with our CLI style guide?  --confirm-enabled would have been what I expected it to be (and I agree it shouldn't be hidden).", "author": "ajsutton", "createdAt": "2020-07-03T05:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM3ODY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM4NTI4MA==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r449385280", "bodyText": "@ajsutton It was previously hidden hence I renamed it without following -enabled suffix. The flag was renamed to make the intent more clear as previously it was to only suppress the \"confirmation\" dialog, now it is also suppressing the additional verbose status log as well.\nIf we want it to be a non-dev (i.e. non-hidden) option,  we would need a more generic option name with -enabled prefix.\nWe may also change to have two options, one to enable/disable confirmation message, the other one to enable/disable verbose status message.", "author": "usmansaleem", "createdAt": "2020-07-03T05:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM3ODY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMzUyMg==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r449413522", "bodyText": "I think keeping it simple and just the single option for this would be sufficient in my mind. All you want to do is make it optional provide a detailed output of exactly whats going on at each stage. What about --verbose-output-enabled with default to True?", "author": "arash009", "createdAt": "2020-07-03T07:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM3ODY5NQ=="}], "type": "inlineReview"}, {"oid": "516e18120a4bad782ad8599938f90583f48aea07", "url": "https://github.com/ConsenSys/teku/commit/516e18120a4bad782ad8599938f90583f48aea07", "message": "Merge remote-tracking branch 'upstream/master' into deposit_generation_output\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-07-03T05:43:12Z", "type": "commit"}, {"oid": "808452da029d5acd85e6841873168f4f14c1103b", "url": "https://github.com/ConsenSys/teku/commit/808452da029d5acd85e6841873168f4f14c1103b", "message": "Merge remote-tracking branch 'upstream/master' into deposit_generation_output\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-07-06T00:59:17Z", "type": "commit"}, {"oid": "aec7f47989debd55a0a24dc2f13cb810abe74834", "url": "https://github.com/ConsenSys/teku/commit/aec7f47989debd55a0a24dc2f13cb810abe74834", "message": "Renaming -Xconfirm-enabled to --verbose-output-enabled\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-07-06T02:08:56Z", "type": "commit"}, {"oid": "5d7497b61e6ba4b698c414a86b83bc48b111449c", "url": "https://github.com/ConsenSys/teku/commit/5d7497b61e6ba4b698c414a86b83bc48b111449c", "message": "Assigining explicit default value to variable\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-07-06T02:13:48Z", "type": "commit"}, {"oid": "fb5c7d885a1b465f89bc7abdd2556fcdf88b1493", "url": "https://github.com/ConsenSys/teku/commit/fb5c7d885a1b465f89bc7abdd2556fcdf88b1493", "message": "reverting changes in test method names\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-07-06T02:16:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk2NTM0Ng==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r449965346", "bodyText": "This is misleading.  The transfer is happening on the ETH1 network but this statement is reporting the ETH2 network.  What network the transfer happens on is controlled by what chain the ETH1 endpoint is sync'd to and nothing this tool can do will change that.", "author": "ajsutton", "createdAt": "2020-07-06T03:22:52Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/deposit/RegisterAction.java", "diffHunk": "@@ -100,8 +110,10 @@ public void displayConfirmation(final int totalNumberOfDeposits) {\n         consoleAdapter.readLine(\n             \"You are about to submit \"\n                 + transactionPart\n-                + \" of %s Eth. This is irreversible, please make sure you understand the consequences. Are you sure you want to continue? [y/n]\",\n-            eth);\n+                + \" of %s Eth to contract address [%s] on network [%s].\\nThis is irreversible, please make sure you understand the consequences. Are you sure you want to continue? [y/n]\",", "originalCommit": "fb5c7d885a1b465f89bc7abdd2556fcdf88b1493", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3MDA2NQ==", "url": "https://github.com/ConsenSys/teku/pull/2258#discussion_r449970065", "bodyText": "Maybe it could say something like \"The deposit signature will be valid for the Ethereum 2 network %s\"?  Although the other catch is that the ETH2 network may be a URL to a YAML file with the network config, it's not necessarily a nice human friendly name.", "author": "ajsutton", "createdAt": "2020-07-06T03:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk2NTM0Ng=="}], "type": "inlineReview"}, {"oid": "c52c1374d968cdfdadb27a016a76dd3c4b6702d0", "url": "https://github.com/ConsenSys/teku/commit/c52c1374d968cdfdadb27a016a76dd3c4b6702d0", "message": "review suggestion - taking network out from confirmation message for registration\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-07-06T04:27:36Z", "type": "commit"}]}