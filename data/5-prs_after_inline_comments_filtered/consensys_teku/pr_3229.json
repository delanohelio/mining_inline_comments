{"pr_number": 3229, "pr_title": "Handle external signer refusal to sign due to violation of slashing conditions", "pr_createdAt": "2020-11-16T01:32:48Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3229", "timeline": [{"oid": "b6e56df0a800ebb7dbd928ec3bf9d5fe4dc4d5ed", "url": "https://github.com/ConsenSys/teku/commit/b6e56df0a800ebb7dbd928ec3bf9d5fe4dc4d5ed", "message": "[#3109] Handle external signer slashing protection error\n\nHandle external signer slashing protection error by handling response status code 412 and construct appropriate error message to indicate that external signer refuses to sign due to slashing condition may be violated.\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-16T01:29:38Z", "type": "commit"}, {"oid": "0b1479dc64c09c4d4b5b661b3d163deab664e49e", "url": "https://github.com/ConsenSys/teku/commit/0b1479dc64c09c4d4b5b661b3d163deab664e49e", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_handle_412\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-16T02:09:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4OTE0OQ==", "url": "https://github.com/ConsenSys/teku/pull/3229#discussion_r523889149", "bodyText": "Can we add this as a constant in HttpStatusCodes and use that constant rather than hard coding the 412 number?", "author": "ajsutton", "createdAt": "2020-11-16T04:05:44Z", "path": "validator/client/src/integration-test/java/tech/pegasys/teku/validator/client/signer/ExternalSignerIntegrationTest.java", "diffHunk": "@@ -119,6 +118,36 @@ void failsSigningWhenSigningServiceReturnsInvalidSignatureResponse() {\n             \"External signer returned an invalid signature: Illegal character 'I' found at index 0 in hex binary representation\");\n   }\n \n+  @Test\n+  void failsSigningBlockWhenSigningServiceRefusesToSignDueToSlashingCondition() {\n+    final BeaconBlock block = dataStructureUtil.randomBeaconBlock(10);\n+    client.when(request()).respond(response().withStatusCode(412));", "originalCommit": "0b1479dc64c09c4d4b5b661b3d163deab664e49e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg5NTczNw==", "url": "https://github.com/ConsenSys/teku/pull/3229#discussion_r523895737", "bodyText": "\ud83d\udc4d", "author": "usmansaleem", "createdAt": "2020-11-16T04:38:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4OTE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg5NzQ0MQ==", "url": "https://github.com/ConsenSys/teku/pull/3229#discussion_r523897441", "bodyText": "done ... both in the test and external signer.", "author": "usmansaleem", "createdAt": "2020-11-16T04:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4OTE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4OTM2Ng==", "url": "https://github.com/ConsenSys/teku/pull/3229#discussion_r523889366", "bodyText": "Would be good to sue a constant here (and actually switch the 200 below to a HttpStatusCodes constant too.", "author": "ajsutton", "createdAt": "2020-11-16T04:06:49Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/signer/ExternalSigner.java", "diffHunk": "@@ -175,12 +187,18 @@ private String createSigningRequestBody(\n   }\n \n   private BLSSignature getBlsSignature(\n-      final HttpResponse<String> response, final Throwable throwable) {\n+      final HttpResponse<String> response,\n+      final Throwable throwable,\n+      final Supplier<String> slashableMessage) {\n     if (throwable != null) {\n       throw new ExternalSignerException(\n           \"External signer failed to sign due to \" + throwable.getMessage(), throwable);\n     }\n \n+    if (response.statusCode() == 412) {", "originalCommit": "0b1479dc64c09c4d4b5b661b3d163deab664e49e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "97f49f714165a8b4acfd6a3d8dc49a3d474aa6cd", "url": "https://github.com/ConsenSys/teku/commit/97f49f714165a8b4acfd6a3d8dc49a3d474aa6cd", "message": "Review suggestion - use HttpStatusCodes class\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-16T04:44:35Z", "type": "commit"}, {"oid": "bf77580eb40654af829d450ae4267231cd1da01c", "url": "https://github.com/ConsenSys/teku/commit/bf77580eb40654af829d450ae4267231cd1da01c", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_handle_412\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-16T04:45:01Z", "type": "commit"}, {"oid": "8776bd43c8e4884643a27ebd84ae8443aab30229", "url": "https://github.com/ConsenSys/teku/commit/8776bd43c8e4884643a27ebd84ae8443aab30229", "message": "Review suggestion - use HttpStatusCodes class\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-11-16T04:47:28Z", "type": "commit"}]}