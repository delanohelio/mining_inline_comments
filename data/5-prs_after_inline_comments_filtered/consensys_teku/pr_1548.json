{"pr_number": 1548, "pr_title": "Using yaml as config file instead of toml", "pr_createdAt": "2020-04-07T08:09:31Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1548", "timeline": [{"oid": "bd44d8bb0d88be73cd2ff37bd5a76505bca4d489", "url": "https://github.com/ConsenSys/teku/commit/bd44d8bb0d88be73cd2ff37bd5a76505bca4d489", "message": "Using yaml as config file instead of toml\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-07T08:08:21Z", "type": "commit"}, {"oid": "f1253bf013d9777a6c87b3532e27a68faba7c187", "url": "https://github.com/ConsenSys/teku/commit/f1253bf013d9777a6c87b3532e27a68faba7c187", "message": "Merge remote-tracking branch 'upstream/master' into config_yaml\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-07T08:09:55Z", "type": "commit"}, {"oid": "a60040b0117a882d4fa6dd921699165b0c7356fb", "url": "https://github.com/ConsenSys/teku/commit/a60040b0117a882d4fa6dd921699165b0c7356fb", "message": "unchecked warning supress\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-07T10:06:15Z", "type": "commit"}, {"oid": "a84407c0afbf696cd3d6a1191a1c81f46740edee", "url": "https://github.com/ConsenSys/teku/commit/a84407c0afbf696cd3d6a1191a1c81f46740edee", "message": "Update run scripts to use yaml config (untested)\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-07T10:54:27Z", "type": "commit"}, {"oid": "f65e254a155f26e9d12cfdc0b8d5e667d5fd1972", "url": "https://github.com/ConsenSys/teku/commit/f65e254a155f26e9d12cfdc0b8d5e667d5fd1972", "message": "single line yaml array in complete_config.yaml\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-07T10:59:05Z", "type": "commit"}, {"oid": "405279c73396d7ff57cce226b6fd671ea4a8f12c", "url": "https://github.com/ConsenSys/teku/commit/405279c73396d7ff57cce226b6fd671ea4a8f12c", "message": "2-pass approach to obtain config file\nif cli config is not specified, fall back to env variable TEKU_CONFIG_FILE\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-07T11:54:15Z", "type": "commit"}, {"oid": "2dbfbdea5cbbbb919a4936bcf163c487ff063960", "url": "https://github.com/ConsenSys/teku/commit/2dbfbdea5cbbbb919a4936bcf163c487ff063960", "message": "Updating exception msg\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-07T12:11:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEyODc5MQ==", "url": "https://github.com/ConsenSys/teku/pull/1548#discussion_r405128791", "bodyText": "nit: It would be better to inline these - they're only used once and the number of %s placeholders needs to match up with the number of parameters so maintaining locality is really useful.", "author": "ajsutton", "createdAt": "2020-04-07T21:38:05Z", "path": "artemis/src/main/java/tech/pegasys/artemis/cli/util/YamlConfigFileDefaultProvider.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.util;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+import org.yaml.snakeyaml.Yaml;\n+import org.yaml.snakeyaml.scanner.ScannerException;\n+import picocli.CommandLine;\n+import picocli.CommandLine.IDefaultValueProvider;\n+import picocli.CommandLine.Model.ArgSpec;\n+import picocli.CommandLine.Model.CommandSpec;\n+import picocli.CommandLine.Model.OptionSpec;\n+import picocli.CommandLine.ParameterException;\n+\n+public class YamlConfigFileDefaultProvider implements IDefaultValueProvider {\n+\n+  private static final String FILE_NOT_FOUND_ERROR_MSG =\n+      \"Unable to read yaml configuration. File not found: \";\n+  private static final String IO_ERROR_MSG_FMT =\n+      \"Unexpected IO error while reading yaml configuration file [%s]: %s\";\n+  private static final String INVALID_YAML_MSG_FMT =\n+      \"Unable to read yaml configuration. Invalid yaml file [%s]: %s\";\n+  private static final String UNKNOWN_OPTIONS_YAML_FMT =\n+      \"Unknown %s in yaml configuration file: %s\";", "originalCommit": "2dbfbdea5cbbbb919a4936bcf163c487ff063960", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI1MTY5Mw==", "url": "https://github.com/ConsenSys/teku/pull/1548#discussion_r405251693", "bodyText": "\ud83d\udc4d Inlining.", "author": "usmansaleem", "createdAt": "2020-04-08T04:30:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEyODc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzNDc4Nw==", "url": "https://github.com/ConsenSys/teku/pull/1548#discussion_r405134787", "bodyText": "nit: All of these can just use method references\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .isThrownBy(() -> commandLine.parseArgs())\n          \n          \n            \n                    .isThrownBy(commandLine::parseArgs)", "author": "ajsutton", "createdAt": "2020-04-07T21:50:50Z", "path": "artemis/src/test/java/tech/pegasys/artemis/cli/util/YamlConfigFileDefaultProviderTest.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.util;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.yaml.snakeyaml.Yaml;\n+import picocli.CommandLine;\n+\n+class YamlConfigFileDefaultProviderTest {\n+\n+  @Test\n+  void parsingValidYamlFilePopulatesCommandObject(@TempDir final Path tempDir) throws IOException {\n+    final Path configFile = writeToYamlConfigFile(defaultOptions(), tempDir);\n+    final CommandLine commandLine = new CommandLine(TestCommand.class);\n+    commandLine.setDefaultValueProvider(\n+        new YamlConfigFileDefaultProvider(commandLine, configFile.toFile()));\n+    commandLine.parseArgs();\n+    final TestCommand testCommand = commandLine.getCommand();\n+\n+    Assertions.assertThat(testCommand.getCount()).isEqualTo(10);\n+    Assertions.assertThat(testCommand.getNames()).containsExactlyInAnyOrder(\"a\", \"b\");\n+    Assertions.assertThat(testCommand.isTestEnabled()).isTrue();\n+  }\n+\n+  @Test\n+  void parsingEmptyConfigFileThrowsException(@TempDir final Path tempDir) throws IOException {\n+    final Path configFile = writeToYamlConfigFile(Collections.emptyMap(), tempDir);\n+    final CommandLine commandLine = new CommandLine(TestCommand.class);\n+    commandLine.setDefaultValueProvider(\n+        new YamlConfigFileDefaultProvider(commandLine, configFile.toFile()));\n+\n+    Assertions.assertThatExceptionOfType(CommandLine.ParameterException.class)\n+        .isThrownBy(() -> commandLine.parseArgs())", "originalCommit": "2dbfbdea5cbbbb919a4936bcf163c487ff063960", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI1MTc0OQ==", "url": "https://github.com/ConsenSys/teku/pull/1548#discussion_r405251749", "bodyText": "\ud83d\udc4d using method references.", "author": "usmansaleem", "createdAt": "2020-04-08T04:30:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzNDc4Nw=="}], "type": "inlineReview"}, {"oid": "60b0f16377f39c9b945ed1b22cab4a22677c8e32", "url": "https://github.com/ConsenSys/teku/commit/60b0f16377f39c9b945ed1b22cab4a22677c8e32", "message": "Use Jackson YAMLFactory to read yaml documents.\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-08T04:31:03Z", "type": "commit"}, {"oid": "8decaedf2477e8d1f3f9107f1c82fd04f3a6c7d7", "url": "https://github.com/ConsenSys/teku/commit/8decaedf2477e8d1f3f9107f1c82fd04f3a6c7d7", "message": "Updating README and fixing run_utils.sh\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-08T05:02:12Z", "type": "commit"}, {"oid": "955f54af2433ea2200e37da9e4d26bb36f98f0e6", "url": "https://github.com/ConsenSys/teku/commit/955f54af2433ea2200e37da9e4d26bb36f98f0e6", "message": "Merge remote-tracking branch 'upstream/master' into config_yaml\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-08T05:03:29Z", "type": "commit"}, {"oid": "82d27a93961b180a564cc5c8c501dcc61b036292", "url": "https://github.com/ConsenSys/teku/commit/82d27a93961b180a564cc5c8c501dcc61b036292", "message": "Merge remote-tracking branch 'upstream/master' into config_yaml\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-08T09:46:17Z", "type": "commit"}]}