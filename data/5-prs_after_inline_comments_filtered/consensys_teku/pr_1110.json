{"pr_number": 1110, "pr_title": "Ensure deposits are correctly ordered when creating the genesis state", "pr_createdAt": "2020-01-23T06:23:31Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1110", "timeline": [{"oid": "55e78b1d40c7307ebb284865fa76806f266b856f", "url": "https://github.com/ConsenSys/teku/commit/55e78b1d40c7307ebb284865fa76806f266b856f", "message": "Ensure deposits are correctly ordered when creating the genesis state.", "committedDate": "2020-01-23T06:19:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE3NTcyNQ==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370175725", "bodyText": "It's probably clearer to just work with the deposit object:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  genesisEth1BlockHash = Bytes32.fromHexString(event.getResponse().log.getBlockHash());\n          \n          \n            \n                  genesisEth1BlockHash = Bytes32.fromHexString(depositWithIndex.getLog().getBlockHash());", "author": "mbaxter", "createdAt": "2020-01-23T15:11:57Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/StateProcessor.java", "diffHunk": "@@ -86,13 +89,20 @@ public Bytes32 processHead() {\n   @Subscribe\n   public void onDeposit(tech.pegasys.artemis.pow.event.Deposit event) {\n     STDOUT.log(Level.DEBUG, \"New deposit received\");\n-    deposits.add(DepositUtil.convertDepositEventToOperationDeposit(event));\n+    final DepositWithIndex depositWithIndex =\n+        DepositUtil.convertDepositEventToOperationDeposit(event);\n+    deposits.add(depositWithIndex);\n+    // Eth1 hash has to be from the block containing the last required deposit but we may be\n+    // receiving deposits out of order.\n+    if (deposits.last().equals(depositWithIndex)) {\n+      genesisEth1BlockHash = Bytes32.fromHexString(event.getResponse().log.getBlockHash());", "originalCommit": "55e78b1d40c7307ebb284865fa76806f266b856f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NDkzMg==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370184932", "bodyText": "So, this test passes deterministically because we're sending exactly the right number of deposits to trigger genesis?", "author": "mbaxter", "createdAt": "2020-01-23T15:26:06Z", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/artemis/test/acceptance/GenesisStateAcceptanceTest.java", "diffHunk": "@@ -13,13 +13,11 @@\n \n package tech.pegasys.artemis.test.acceptance;\n \n-import org.junit.jupiter.api.Disabled;\n import org.junit.jupiter.api.Test;\n import tech.pegasys.artemis.test.acceptance.dsl.AcceptanceTestBase;\n import tech.pegasys.artemis.test.acceptance.dsl.ArtemisNode;\n import tech.pegasys.artemis.test.acceptance.dsl.BesuNode;\n \n-@Disabled(\"Genesis generation does not yet match\")", "originalCommit": "55e78b1d40c7307ebb284865fa76806f266b856f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyMzQzNA==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370423434", "bodyText": "Yes.  The new, improved version now can handle more than the required deposits as long as they're in different blocks (ie it doesn't include all transactions from a block if only some are required to trigger genesis).", "author": "ajsutton", "createdAt": "2020-01-24T00:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NDkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NTg4Mg==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370185882", "bodyText": "Doesn't look like we need the transaction objects:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    web3.ethGetBlockByHash(blockHash.toHexString(), true).send().getBlock().getTimestamp());\n          \n          \n            \n                    web3.ethGetBlockByHash(blockHash.toHexString(), false).send().getBlock().getTimestamp());", "author": "mbaxter", "createdAt": "2020-01-23T15:27:29Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/DepositUtil.java", "diffHunk": "@@ -198,13 +196,10 @@ public static DepositWithIndex convertDepositEventToOperationDeposit(\n     return new tech.pegasys.artemis.pow.event.Deposit(response);\n   }\n \n-  public static UnsignedLong getEpochBlockTimeByDepositBlockNumber(\n-      BigInteger blockNumber, String provider) throws IOException {\n+  public static UnsignedLong getEpochBlockTimeByDepositBlockHash(Bytes32 blockHash, String provider)\n+      throws IOException {\n     Web3j web3 = Web3j.build(new HttpService(provider));\n     return UnsignedLong.valueOf(\n-        web3.ethGetBlockByNumber(new DefaultBlockParameterNumber(blockNumber), true)\n-            .send()\n-            .getBlock()\n-            .getTimestamp());\n+        web3.ethGetBlockByHash(blockHash.toHexString(), true).send().getBlock().getTimestamp());", "originalCommit": "55e78b1d40c7307ebb284865fa76806f266b856f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyMzg5MA==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370423890", "bodyText": "Good spot, we don't.", "author": "ajsutton", "createdAt": "2020-01-24T00:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NTg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4OTk3Ng==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370189976", "bodyText": "Should this be volatile?", "author": "mbaxter", "createdAt": "2020-01-23T15:34:07Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/StateProcessor.java", "diffHunk": "@@ -53,7 +55,8 @@\n   private final BlockImporter blockImporter;\n   private final ChainStorageClient chainStorageClient;\n   private final ArtemisConfiguration config;\n-  private final List<DepositWithIndex> deposits = new ArrayList<>();\n+  private final NavigableSet<DepositWithIndex> deposits = new TreeSet<>();\n+  private Bytes32 genesisEth1BlockHash;", "originalCommit": "55e78b1d40c7307ebb284865fa76806f266b856f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE5MTA1Nw==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370191057", "bodyText": "Alternatively, could we just make this a local variable within onDeposit and always set it to the last deposit's blockHash?", "author": "mbaxter", "createdAt": "2020-01-23T15:35:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4OTk3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyNDY0OQ==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370424649", "bodyText": "Doesn't matter now, but each @Subscribe method is called inside a synchronized block (specific to the method, not the class) so as long as the variables are only used as a result of a single event method, we can treat it as single threaded.", "author": "ajsutton", "createdAt": "2020-01-24T00:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4OTk3Ng=="}], "type": "inlineReview"}, {"oid": "168fb6b557e30e2e7bd85b0db13342b39bbcfac1", "url": "https://github.com/ConsenSys/teku/commit/168fb6b557e30e2e7bd85b0db13342b39bbcfac1", "message": "Switch to queuing deposits so they are processed in order not just ordered correctly in the genesis state.", "committedDate": "2020-01-23T20:14:31Z", "type": "commit"}, {"oid": "7e839c28a13077c6b46445c0d97f2d7a9e6eb536", "url": "https://github.com/ConsenSys/teku/commit/7e839c28a13077c6b46445c0d97f2d7a9e6eb536", "message": "Split genesis creation into a separate class.", "committedDate": "2020-01-23T20:33:23Z", "type": "commit"}, {"oid": "bcdba2c8dd1bff9ee86332507bb9a92e89ceec5c", "url": "https://github.com/ConsenSys/teku/commit/bcdba2c8dd1bff9ee86332507bb9a92e89ceec5c", "message": "Extract queuing and reordering logic for deposits to a separate class so it can be tested in isolation.", "committedDate": "2020-01-24T00:21:34Z", "type": "commit"}, {"oid": "f3d0e0cc38495004bbfeddff1341b5e40efa837b", "url": "https://github.com/ConsenSys/teku/commit/f3d0e0cc38495004bbfeddff1341b5e40efa837b", "message": "We don't need the full transaction objects.", "committedDate": "2020-01-24T00:25:31Z", "type": "commit"}, {"oid": "6d142d17325a8e48e38957ae6b338159e6d372c0", "url": "https://github.com/ConsenSys/teku/commit/6d142d17325a8e48e38957ae6b338159e6d372c0", "message": "Remove genesisReady from StateProcessor as we can check directly with ChainStorageClient.", "committedDate": "2020-01-24T00:26:37Z", "type": "commit"}, {"oid": "1c1596aba9727949ec6b179c3c7511714d36e265", "url": "https://github.com/ConsenSys/teku/commit/1c1596aba9727949ec6b179c3c7511714d36e265", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into deposit-order", "committedDate": "2020-01-24T00:29:14Z", "type": "commit"}, {"oid": "ba89b216c70f95db6402353cc7d2cec513143f95", "url": "https://github.com/ConsenSys/teku/commit/ba89b216c70f95db6402353cc7d2cec513143f95", "message": "More useful logging.", "committedDate": "2020-01-24T03:08:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY5MDMyNA==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370690324", "bodyText": "nice \ud83c\udf89", "author": "mbaxter", "createdAt": "2020-01-24T15:24:07Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/DepositQueue.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.statetransition;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Iterator;\n+import java.util.NavigableSet;\n+import java.util.TreeSet;\n+import java.util.function.Consumer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.artemis.datastructures.operations.DepositWithIndex;\n+\n+public class DepositQueue {", "originalCommit": "ba89b216c70f95db6402353cc7d2cec513143f95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyMDI5Mg==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370720292", "bodyText": "First time seeing you use iterators. Why did you choose an iterator here?", "author": "cemozerr", "createdAt": "2020-01-24T16:21:45Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/DepositQueue.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.statetransition;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Iterator;\n+import java.util.NavigableSet;\n+import java.util.TreeSet;\n+import java.util.function.Consumer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.artemis.datastructures.operations.DepositWithIndex;\n+\n+public class DepositQueue {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final NavigableSet<DepositWithIndex> pendingDeposits = new TreeSet<>();\n+  private final Consumer<DepositWithIndex> depositConsumer;\n+  private UnsignedLong expectedDepositIndex = UnsignedLong.ZERO;\n+\n+  public DepositQueue(final Consumer<DepositWithIndex> depositConsumer) {\n+    this.depositConsumer = depositConsumer;\n+  }\n+\n+  public void onDeposit(DepositWithIndex deposit) {\n+    LOG.trace(\"New deposit received with index {}\", deposit.getIndex());\n+    pendingDeposits.add(deposit);\n+    processPendingDeposits();\n+  }\n+\n+  private void processPendingDeposits() {\n+    for (Iterator<DepositWithIndex> i = pendingDeposits.iterator(); i.hasNext(); ) {", "originalCommit": "ba89b216c70f95db6402353cc7d2cec513143f95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1ODYxMw==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370858613", "bodyText": "I needed to be able to remove items as I iterated. You can't just call pendingDeposits.remove because you'll get a ConcurrentAccessException so you have to use Iterator.remove (usually more efficient too because the iterator knows where it's up to).", "author": "ajsutton", "createdAt": "2020-01-24T21:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyMDI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk5MTU2Mw==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r371991563", "bodyText": "Makes sense. Thank you.", "author": "cemozerr", "createdAt": "2020-01-28T18:52:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyMDI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyODIwNQ==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370728205", "bodyText": "One thing I noticed in this PR, unrelated to this PR is that process slot gets called only when storeTime is greater than nextSlotStartTime. Since, at least with the current constants, onTick() gets called twice every second, in the worst-case scenario we're losing 500 ms processing time for each slot. I think we should fix this. Here's the ticket: https://pegasys1.atlassian.net/secure/RapidBoard.jspa?rapidView=67&modal=detail&selectedIssue=BC-244\nOne idea is to have a SlotScheduler class that has its own timer which gets kicked off exactly at genesis. This class could post SlotEvents, BroadcastAttestationEvents and BroadcastAggregateEvents just like the processSlot method here, however, it would post those events way more precisely.", "author": "cemozerr", "createdAt": "2020-01-24T16:37:30Z", "path": "services/beaconchain/src/main/java/tech/pegasys/artemis/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -281,21 +281,19 @@ private void onStoreInitializedEvent(final StoreInitializedEvent event) {\n   @Subscribe\n   @SuppressWarnings(\"unused\")\n   private void onTick(Date date) {\n-    if (!testMode && !stateProcessor.isGenesisReady()) {\n+    if (chainStorageClient.isPreGenesis()) {\n       return;\n     }\n     final UnsignedLong currentTime = UnsignedLong.valueOf(date.getTime() / 1000);\n-    if (chainStorageClient.getStore() != null) {\n-      final Store.Transaction transaction = chainStorageClient.startStoreTransaction();\n-      on_tick(transaction, currentTime);\n-      transaction.commit().join();\n-      final UnsignedLong nextSlotStartTime =\n-          chainStorageClient\n-              .getGenesisTime()\n-              .plus(nodeSlot.times(UnsignedLong.valueOf(SECONDS_PER_SLOT)));\n-      if (chainStorageClient.getStore().getTime().compareTo(nextSlotStartTime) >= 0) {\n-        processSlot();\n-      }\n+    final Store.Transaction transaction = chainStorageClient.startStoreTransaction();\n+    on_tick(transaction, currentTime);\n+    transaction.commit().join();\n+    final UnsignedLong nextSlotStartTime =\n+        chainStorageClient\n+            .getGenesisTime()\n+            .plus(nodeSlot.times(UnsignedLong.valueOf(SECONDS_PER_SLOT)));\n+    if (chainStorageClient.getStore().getTime().compareTo(nextSlotStartTime) >= 0) {\n+      processSlot();", "originalCommit": "ba89b216c70f95db6402353cc7d2cec513143f95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MDY0NQ==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r370860645", "bodyText": "Yep, definitely some improvements to be made around here.  I've been thinking of having a separate TimeService that fires time, slot and epoch events in.  Would need to do more thinking and playing to know if that will really work, but it's appealing in terms of being able to start doing time travel in tests because it's a single source of where time is up to.", "author": "ajsutton", "createdAt": "2020-01-24T21:57:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyODIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk5MjEyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1110#discussion_r371992121", "bodyText": "Agreed. A separate TimeService is a good direction.", "author": "cemozerr", "createdAt": "2020-01-28T18:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyODIwNQ=="}], "type": "inlineReview"}, {"oid": "172927e266917c0e6c8afce2d605e27a89210670", "url": "https://github.com/ConsenSys/teku/commit/172927e266917c0e6c8afce2d605e27a89210670", "message": "Merge branch 'master' into deposit-order", "committedDate": "2020-01-24T21:50:39Z", "type": "commit"}]}