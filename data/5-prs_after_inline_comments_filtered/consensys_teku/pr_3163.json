{"pr_number": 3163, "pr_title": "[Issue 3063] Sync from state alone", "pr_createdAt": "2020-11-05T20:21:12Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3163", "timeline": [{"oid": "6dca375e6c2bffbc833482df3abe90ec673478fd", "url": "https://github.com/ConsenSys/teku/commit/6dca375e6c2bffbc833482df3abe90ec673478fd", "message": "Start up from state alone without a supplied block", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "8fa43acb463ee6b9b78294baa2c23ea8e8a4dc5b", "url": "https://github.com/ConsenSys/teku/commit/8fa43acb463ee6b9b78294baa2c23ea8e8a4dc5b", "message": "Update PeerChainValidator to avoid looking up finalized block", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "3950de2a74884062777bf674c7b1e85f45359b37", "url": "https://github.com/ConsenSys/teku/commit/3950de2a74884062777bf674c7b1e85f45359b37", "message": "Don't require latest finalized block to create Store from database", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "a28fe85173b26160ed54b5c9eb510614abd89d79", "url": "https://github.com/ConsenSys/teku/commit/a28fe85173b26160ed54b5c9eb510614abd89d79", "message": "Don't require full blocks when initializing ProtoArray", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "4d71f0e7157871692bf2e28d4ae38a553efa808a", "url": "https://github.com/ConsenSys/teku/commit/4d71f0e7157871692bf2e28d4ae38a553efa808a", "message": "Run spotless", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "c1a456f9b1b3df8d0591c6f42b8128e9ad602d35", "url": "https://github.com/ConsenSys/teku/commit/c1a456f9b1b3df8d0591c6f42b8128e9ad602d35", "message": "Don't require original anchor block when storing finalized chain data", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "3b445c72a88c7ada465df10c75548bf22a850253", "url": "https://github.com/ConsenSys/teku/commit/3b445c72a88c7ada465df10c75548bf22a850253", "message": "Validate supplied anchor state against stored state, not block", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "fe17721c0303c18b32268772ac07eff10c4b8e0c", "url": "https://github.com/ConsenSys/teku/commit/fe17721c0303c18b32268772ac07eff10c4b8e0c", "message": "Validate supplied anchor against state only if block unavailable", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "84c3166d41adfcbcbc1d4fde47150bf0cb7cebff", "url": "https://github.com/ConsenSys/teku/commit/84c3166d41adfcbcbc1d4fde47150bf0cb7cebff", "message": "Always store anchor state so we can validate supplied anchor on restart", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "159d730499fa59c1a782075ccefba97be185fe32", "url": "https://github.com/ConsenSys/teku/commit/159d730499fa59c1a782075ccefba97be185fe32", "message": "Update tests to account for storage of the initial state", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "129576793f06296c0f3bddbabc09f8484c96f63b", "url": "https://github.com/ConsenSys/teku/commit/129576793f06296c0f3bddbabc09f8484c96f63b", "message": "Add additional database tests", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "91505cbbffcb610a4296b97caa26da733c4c2a47", "url": "https://github.com/ConsenSys/teku/commit/91505cbbffcb610a4296b97caa26da733c4c2a47", "message": "Include anchor block metadata when creating Store", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "62ebc910c26c8bf3b380a17df229ff5654135ece", "url": "https://github.com/ConsenSys/teku/commit/62ebc910c26c8bf3b380a17df229ff5654135ece", "message": "Update BaseSelector to return result from Store even if block is unavailable", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "4a9abe187f548bb07d6e7139574bebbd673afbc1", "url": "https://github.com/ConsenSys/teku/commit/4a9abe187f548bb07d6e7139574bebbd673afbc1", "message": "Don't require --Xws-initial-state argument", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "bf737a47cdcb63780b5fcd31c3a89b09759007fd", "url": "https://github.com/ConsenSys/teku/commit/bf737a47cdcb63780b5fcd31c3a89b09759007fd", "message": "Remove stale comment", "committedDate": "2020-11-05T21:27:03Z", "type": "commit"}, {"oid": "2323def85e5429707364603949058c1d93846e98", "url": "https://github.com/ConsenSys/teku/commit/2323def85e5429707364603949058c1d93846e98", "message": "Update PeerChainValidatorTest", "committedDate": "2020-11-05T23:13:31Z", "type": "commit"}, {"oid": "8543d03c79f71f1087bf889b7f828d06fc4dc3f1", "url": "https://github.com/ConsenSys/teku/commit/8543d03c79f71f1087bf889b7f828d06fc4dc3f1", "message": "Revert \"Update tests to account for storage of the initial state\"\n\nThis reverts commit 159d730499fa59c1a782075ccefba97be185fe32.", "committedDate": "2020-11-05T23:13:31Z", "type": "commit"}, {"oid": "0a80346352b645e54f3d793c0be8cf16b40d5a7a", "url": "https://github.com/ConsenSys/teku/commit/0a80346352b645e54f3d793c0be8cf16b40d5a7a", "message": "Revert \"Always store anchor state so we can validate supplied anchor on restart\"\n\nThis reverts commit 84c3166d41adfcbcbc1d4fde47150bf0cb7cebff.", "committedDate": "2020-11-05T23:13:31Z", "type": "commit"}, {"oid": "bc6dee2ef3914180bdb868305f1917a347ff2cc6", "url": "https://github.com/ConsenSys/teku/commit/bc6dee2ef3914180bdb868305f1917a347ff2cc6", "message": "Skip validation of initial state if data is unavailable", "committedDate": "2020-11-05T23:13:31Z", "type": "commit"}, {"oid": "80d3a8a83e3da63dfbc66569397f54cc03881d83", "url": "https://github.com/ConsenSys/teku/commit/80d3a8a83e3da63dfbc66569397f54cc03881d83", "message": "Set anchor block information using latest finalized state", "committedDate": "2020-11-05T23:13:31Z", "type": "commit"}, {"oid": "80d3a8a83e3da63dfbc66569397f54cc03881d83", "url": "https://github.com/ConsenSys/teku/commit/80d3a8a83e3da63dfbc66569397f54cc03881d83", "message": "Set anchor block information using latest finalized state", "committedDate": "2020-11-05T23:13:31Z", "type": "forcePushed"}, {"oid": "33ff6032c2c5daa2eec7d5746c9a6da00c6b4caa", "url": "https://github.com/ConsenSys/teku/commit/33ff6032c2c5daa2eec7d5746c9a6da00c6b4caa", "message": "Fix DataStructureUtil - don't allow publicly supplied states", "committedDate": "2020-11-06T21:52:22Z", "type": "commit"}, {"oid": "8a1395efae0d80d36dc63d437d87cb7117ec4ddb", "url": "https://github.com/ConsenSys/teku/commit/8a1395efae0d80d36dc63d437d87cb7117ec4ddb", "message": "Use safer casting approach", "committedDate": "2020-11-06T22:07:28Z", "type": "commit"}, {"oid": "198f97b4ad14ae117741d3fa729b623042cffaad", "url": "https://github.com/ConsenSys/teku/commit/198f97b4ad14ae117741d3fa729b623042cffaad", "message": "Merge branch 'master' into issue-3063/sync-from-state-alone", "committedDate": "2020-11-06T22:07:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NDE3OQ==", "url": "https://github.com/ConsenSys/teku/pull/3163#discussion_r519474179", "bodyText": "If we don't actually need the block, would it be better to always create the summary purely off of the state and avoid looking up via blockProvider entirely?  I worry that if the block is sometimes available and sometimes not, it creates more corner cases that could be hard to test.  Whereas if it's never present we know the downstream code has to be able to handle it.", "author": "ajsutton", "createdAt": "2020-11-08T20:38:49Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/stategenerator/StateRegenerationBaseSelector.java", "diffHunk": "@@ -121,13 +121,20 @@ private boolean isBetterThanCurrentRebasedStartingPoint(\n             .isGreaterThan(closestAvailableFromStore.getSlot())) {\n       return SafeFuture.completedFuture(rebasedStartingPoint);\n     }\n+\n     return blockProvider\n         .getBlock(closestAvailableFromStore.getBlockRoot())\n         .thenApply(\n-            maybeBlock ->\n-                maybeBlock.map(\n+            maybeBlock -> {\n+              if (maybeBlock.isPresent()) {\n+                return maybeBlock.map(\n                     block ->\n-                        StateAndBlockSummary.create(block, closestAvailableFromStore.getState())));\n+                        StateAndBlockSummary.create(block, closestAvailableFromStore.getState()));\n+              } else {\n+                return Optional.of(\n+                    StateAndBlockSummary.create(closestAvailableFromStore.getState()));\n+              }\n+            });", "originalCommit": "198f97b4ad14ae117741d3fa729b623042cffaad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg4NTg5NQ==", "url": "https://github.com/ConsenSys/teku/pull/3163#discussion_r519885895", "bodyText": "Good point - I'll follow up on this suggestion in another PR.  I wanted to avoid changing the current production behavior in this PR, but it does make sense to simplify where we can.", "author": "mbaxter", "createdAt": "2020-11-09T15:11:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NDE3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkwODg5OA==", "url": "https://github.com/ConsenSys/teku/pull/3163#discussion_r519908898", "bodyText": "Added a follow-up ticket here to make sure I don't forget: #3184", "author": "mbaxter", "createdAt": "2020-11-09T15:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NDE3OQ=="}], "type": "inlineReview"}, {"oid": "9ff4e328add8186df63e1c28b5e01bb75d80fbac", "url": "https://github.com/ConsenSys/teku/commit/9ff4e328add8186df63e1c28b5e01bb75d80fbac", "message": "Merge branch 'master' into issue-3063/sync-from-state-alone", "committedDate": "2020-11-09T15:06:56Z", "type": "commit"}]}