{"pr_number": 2508, "pr_title": "Implement Validator API GetAggregate method", "pr_createdAt": "2020-08-05T05:48:25Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2508", "timeline": [{"oid": "2679818c6e161318988aa348f4ddb2712bddbb7b", "url": "https://github.com/ConsenSys/teku/commit/2679818c6e161318988aa348f4ddb2712bddbb7b", "message": "Implement Validator API GetAggregate method\n\nhttps://ethereum.github.io/eth2.0-APIs/#/Validator/getAggregatedAttestation\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-08-05T05:45:46Z", "type": "commit"}, {"oid": "7a265a34be9bf7fbd847c1126f22b6a5a12b9627", "url": "https://github.com/ConsenSys/teku/commit/7a265a34be9bf7fbd847c1126f22b6a5a12b9627", "message": "Update typo\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-08-05T05:51:19Z", "type": "commit"}, {"oid": "d696a1d68d64b47179e544328315dfcb5352bf49", "url": "https://github.com/ConsenSys/teku/commit/d696a1d68d64b47179e544328315dfcb5352bf49", "message": "Adding test for method route\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-08-05T06:01:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4OTM1NA==", "url": "https://github.com/ConsenSys/teku/pull/2508#discussion_r465489354", "bodyText": "Ooo, that's a terrible abuse of the 403 response code. Good luck to anyone wanting to implement authenticated REST APIs and trying to distinguish between needing to authenticate and not being subscribed to the topic. On the plus side we're not actually performing the check so won't affect us.", "author": "ajsutton", "createdAt": "2020-08-05T05:53:33Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/validator/GetAggregate.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.validator;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;\n+import static javax.servlet.http.HttpServletResponse.SC_INTERNAL_SERVER_ERROR;\n+import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;\n+import static javax.servlet.http.HttpServletResponse.SC_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.ATTESTATION_DATA_ROOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_FORBIDDEN;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.SLOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.TAG_VALIDATOR;\n+import static tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils.getParameterValueAsBytes32;\n+import static tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils.getParameterValueAsUnsignedLong;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.primitives.UnsignedLong;\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiParam;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.concurrent.CompletionStage;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.api.ValidatorDataProvider;\n+import tech.pegasys.teku.api.schema.Attestation;\n+import tech.pegasys.teku.beaconrestapi.schema.BadRequest;\n+import tech.pegasys.teku.beaconrestapi.schema.ErrorResponse;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.provider.JsonProvider;\n+\n+public class GetAggregate implements Handler {\n+\n+  public static final String ROUTE = \"/validator/aggregate_attestation\";\n+\n+  private final ValidatorDataProvider provider;\n+  private final JsonProvider jsonProvider;\n+\n+  public GetAggregate(final ValidatorDataProvider provider, final JsonProvider jsonProvider) {\n+    this.jsonProvider = jsonProvider;\n+    this.provider = provider;\n+  }\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Aggregates all attestations matching given attestation data root and slot.\",\n+      tags = {TAG_VALIDATOR},\n+      queryParams = {\n+        @OpenApiParam(\n+            name = ATTESTATION_DATA_ROOT,\n+            description =\n+                \"`String` HashTreeRoot of AttestationData that validator want's aggregated.\",\n+            required = true),\n+        @OpenApiParam(\n+            name = SLOT,\n+            description = \"`UnsignedLong` Non-finalized slot for which to create the aggregation.\",\n+            required = true)\n+      },\n+      description = \"Aggregates all attestations matching given attestation data root and slot.\",\n+      responses = {\n+        @OpenApiResponse(\n+            status = RES_OK,\n+            content = @OpenApiContent(from = Attestation.class, isArray = true),\n+            description =\n+                \"Returns aggregated `Attestation` object with same `AttestationData` root.\"),\n+        @OpenApiResponse(status = RES_BAD_REQUEST, description = \"Invalid parameter supplied\"),\n+        @OpenApiResponse(\n+            status = RES_FORBIDDEN,\n+            description = \"Beacon node was not assigned to aggregate on that subnet\"),", "originalCommit": "2679818c6e161318988aa348f4ddb2712bddbb7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ5OTI2Ng==", "url": "https://github.com/ConsenSys/teku/pull/2508#discussion_r465499266", "bodyText": "Yeah, it might be worth raising it on the spec repo. But you are right, atm we aren't enforcing it so it should be fine.\nThis is likely to change as the spec evolves, so we don't have to worry too much about it.", "author": "lucassaldanha", "createdAt": "2020-08-05T06:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4OTM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4OTczOQ==", "url": "https://github.com/ConsenSys/teku/pull/2508#discussion_r465489739", "bodyText": "Would it be better to just not assign to a variable?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  @SuppressWarnings(\"unused\")\n          \n          \n            \n                  UnsignedLong slot = getParameterValueAsUnsignedLong(parameters, SLOT);\n          \n          \n            \n                  // Validate the slot parameter, even though we don't actually use it.\n          \n          \n            \n                  getParameterValueAsUnsignedLong(parameters, SLOT);", "author": "ajsutton", "createdAt": "2020-08-05T05:54:46Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/validator/GetAggregate.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.validator;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;\n+import static javax.servlet.http.HttpServletResponse.SC_INTERNAL_SERVER_ERROR;\n+import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;\n+import static javax.servlet.http.HttpServletResponse.SC_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.ATTESTATION_DATA_ROOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_FORBIDDEN;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.SLOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.TAG_VALIDATOR;\n+import static tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils.getParameterValueAsBytes32;\n+import static tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils.getParameterValueAsUnsignedLong;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.primitives.UnsignedLong;\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiParam;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.concurrent.CompletionStage;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.api.ValidatorDataProvider;\n+import tech.pegasys.teku.api.schema.Attestation;\n+import tech.pegasys.teku.beaconrestapi.schema.BadRequest;\n+import tech.pegasys.teku.beaconrestapi.schema.ErrorResponse;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.provider.JsonProvider;\n+\n+public class GetAggregate implements Handler {\n+\n+  public static final String ROUTE = \"/validator/aggregate_attestation\";\n+\n+  private final ValidatorDataProvider provider;\n+  private final JsonProvider jsonProvider;\n+\n+  public GetAggregate(final ValidatorDataProvider provider, final JsonProvider jsonProvider) {\n+    this.jsonProvider = jsonProvider;\n+    this.provider = provider;\n+  }\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Aggregates all attestations matching given attestation data root and slot.\",\n+      tags = {TAG_VALIDATOR},\n+      queryParams = {\n+        @OpenApiParam(\n+            name = ATTESTATION_DATA_ROOT,\n+            description =\n+                \"`String` HashTreeRoot of AttestationData that validator want's aggregated.\",\n+            required = true),\n+        @OpenApiParam(\n+            name = SLOT,\n+            description = \"`UnsignedLong` Non-finalized slot for which to create the aggregation.\",\n+            required = true)\n+      },\n+      description = \"Aggregates all attestations matching given attestation data root and slot.\",\n+      responses = {\n+        @OpenApiResponse(\n+            status = RES_OK,\n+            content = @OpenApiContent(from = Attestation.class, isArray = true),\n+            description =\n+                \"Returns aggregated `Attestation` object with same `AttestationData` root.\"),\n+        @OpenApiResponse(status = RES_BAD_REQUEST, description = \"Invalid parameter supplied\"),\n+        @OpenApiResponse(\n+            status = RES_FORBIDDEN,\n+            description = \"Beacon node was not assigned to aggregate on that subnet\"),\n+        @OpenApiResponse(status = RES_INTERNAL_ERROR, description = \"Beacon node internal error.\")\n+      })\n+  @Override\n+  public void handle(Context ctx) throws Exception {\n+\n+    try {\n+      final Map<String, List<String>> parameters = ctx.queryParamMap();\n+      if (parameters.size() < 2) {\n+        throw new IllegalArgumentException(\n+            String.format(\"Please specify both %s and %s\", ATTESTATION_DATA_ROOT, SLOT));\n+      }\n+      Bytes32 beacon_block_root = getParameterValueAsBytes32(parameters, ATTESTATION_DATA_ROOT);\n+      @SuppressWarnings(\"unused\")\n+      UnsignedLong slot = getParameterValueAsUnsignedLong(parameters, SLOT);", "originalCommit": "2679818c6e161318988aa348f4ddb2712bddbb7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ5MDE4Nw==", "url": "https://github.com/ConsenSys/teku/pull/2508#discussion_r465490187", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               At the moment we aren't handling the error:\n          \n          \n            \n               At the moment we aren't enforcing:\n          \n      \n    \n    \n  \n\nJust so it doesn't sound like we might get an error and fail to handle it.", "author": "ajsutton", "createdAt": "2020-08-05T05:56:01Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/validator/GetAggregate.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.validator;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;\n+import static javax.servlet.http.HttpServletResponse.SC_INTERNAL_SERVER_ERROR;\n+import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;\n+import static javax.servlet.http.HttpServletResponse.SC_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.ATTESTATION_DATA_ROOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_FORBIDDEN;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.SLOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.TAG_VALIDATOR;\n+import static tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils.getParameterValueAsBytes32;\n+import static tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils.getParameterValueAsUnsignedLong;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.primitives.UnsignedLong;\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiParam;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.concurrent.CompletionStage;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.api.ValidatorDataProvider;\n+import tech.pegasys.teku.api.schema.Attestation;\n+import tech.pegasys.teku.beaconrestapi.schema.BadRequest;\n+import tech.pegasys.teku.beaconrestapi.schema.ErrorResponse;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.provider.JsonProvider;\n+\n+public class GetAggregate implements Handler {\n+\n+  public static final String ROUTE = \"/validator/aggregate_attestation\";\n+\n+  private final ValidatorDataProvider provider;\n+  private final JsonProvider jsonProvider;\n+\n+  public GetAggregate(final ValidatorDataProvider provider, final JsonProvider jsonProvider) {\n+    this.jsonProvider = jsonProvider;\n+    this.provider = provider;\n+  }\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Aggregates all attestations matching given attestation data root and slot.\",\n+      tags = {TAG_VALIDATOR},\n+      queryParams = {\n+        @OpenApiParam(\n+            name = ATTESTATION_DATA_ROOT,\n+            description =\n+                \"`String` HashTreeRoot of AttestationData that validator want's aggregated.\",\n+            required = true),\n+        @OpenApiParam(\n+            name = SLOT,\n+            description = \"`UnsignedLong` Non-finalized slot for which to create the aggregation.\",\n+            required = true)\n+      },\n+      description = \"Aggregates all attestations matching given attestation data root and slot.\",\n+      responses = {\n+        @OpenApiResponse(\n+            status = RES_OK,\n+            content = @OpenApiContent(from = Attestation.class, isArray = true),\n+            description =\n+                \"Returns aggregated `Attestation` object with same `AttestationData` root.\"),\n+        @OpenApiResponse(status = RES_BAD_REQUEST, description = \"Invalid parameter supplied\"),\n+        @OpenApiResponse(\n+            status = RES_FORBIDDEN,\n+            description = \"Beacon node was not assigned to aggregate on that subnet\"),\n+        @OpenApiResponse(status = RES_INTERNAL_ERROR, description = \"Beacon node internal error.\")\n+      })\n+  @Override\n+  public void handle(Context ctx) throws Exception {\n+\n+    try {\n+      final Map<String, List<String>> parameters = ctx.queryParamMap();\n+      if (parameters.size() < 2) {\n+        throw new IllegalArgumentException(\n+            String.format(\"Please specify both %s and %s\", ATTESTATION_DATA_ROOT, SLOT));\n+      }\n+      Bytes32 beacon_block_root = getParameterValueAsBytes32(parameters, ATTESTATION_DATA_ROOT);\n+      @SuppressWarnings(\"unused\")\n+      UnsignedLong slot = getParameterValueAsUnsignedLong(parameters, SLOT);\n+\n+      ctx.result(\n+          provider\n+              .createAggregate(beacon_block_root)\n+              .thenApplyChecked(optionalAttestation -> serializeResult(ctx, optionalAttestation))\n+              .exceptionallyCompose(error -> handleError(ctx, error)));\n+    } catch (final IllegalArgumentException e) {\n+      ctx.result(jsonProvider.objectToJSON(new BadRequest(e.getMessage())));\n+      ctx.status(SC_BAD_REQUEST);\n+    }\n+  }\n+\n+  private String serializeResult(final Context ctx, final Optional<Attestation> optionalAttestation)\n+      throws com.fasterxml.jackson.core.JsonProcessingException {\n+    if (optionalAttestation.isPresent()) {\n+      ctx.status(SC_OK);\n+      String json = jsonProvider.objectToJSON(optionalAttestation.get());\n+      return json;\n+    } else {\n+      ctx.status(SC_NOT_FOUND);\n+      return \"\";\n+    }\n+  }\n+\n+  /*\n+   At the moment we aren't handling the error:", "originalCommit": "2679818c6e161318988aa348f4ddb2712bddbb7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "997ac90e0fa62ca68ea269dd3b819bd22441f663", "url": "https://github.com/ConsenSys/teku/commit/997ac90e0fa62ca68ea269dd3b819bd22441f663", "message": "PR comments\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-08-05T06:20:36Z", "type": "commit"}]}