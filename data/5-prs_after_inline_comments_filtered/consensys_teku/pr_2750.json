{"pr_number": 2750, "pr_title": "Start new sync by tracking available chains", "pr_createdAt": "2020-09-08T05:16:03Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2750", "timeline": [{"oid": "d040778dbf701c5081e169f89f3f22e98bef7ef0", "url": "https://github.com/ConsenSys/teku/commit/d040778dbf701c5081e169f89f3f22e98bef7ef0", "message": "Add classes to track available chains.", "committedDate": "2020-09-07T04:41:39Z", "type": "commit"}, {"oid": "eef0ecc44a5511b523c2f570012f0f5ea7696429", "url": "https://github.com/ConsenSys/teku/commit/eef0ecc44a5511b523c2f570012f0f5ea7696429", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into new-finalized-sync", "committedDate": "2020-09-07T20:26:31Z", "type": "commit"}, {"oid": "d21846317ac3ac30cb482c79bb8714e4f9f5e68a", "url": "https://github.com/ConsenSys/teku/commit/d21846317ac3ac30cb482c79bb8714e4f9f5e68a", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into new-finalized-sync", "committedDate": "2020-09-07T20:26:44Z", "type": "commit"}, {"oid": "1640dfbd838fcedaae9ba17074c838973e7b9aac", "url": "https://github.com/ConsenSys/teku/commit/1640dfbd838fcedaae9ba17074c838973e7b9aac", "message": "Introduce SyncSource to narrow the required interface for Eth2Peer to just what sync actually needs.\nMakes testing easier.", "committedDate": "2020-09-07T23:43:19Z", "type": "commit"}, {"oid": "7f9e44a0fe703e6ff6d8b8862dbd51c256b99481", "url": "https://github.com/ConsenSys/teku/commit/7f9e44a0fe703e6ff6d8b8862dbd51c256b99481", "message": "Add PeerTracker and wiring to keep track of target chains.", "committedDate": "2020-09-08T04:54:07Z", "type": "commit"}, {"oid": "1bed064a189fabc5ed975d5f2bc32eea071ab260", "url": "https://github.com/ConsenSys/teku/commit/1bed064a189fabc5ed975d5f2bc32eea071ab260", "message": "Add test for subscribing to peer updates and comment to explain SyncSource.", "committedDate": "2020-09-08T04:59:04Z", "type": "commit"}, {"oid": "23aff84df0d7ddf610f868599a0121949122c1d8", "url": "https://github.com/ConsenSys/teku/commit/23aff84df0d7ddf610f868599a0121949122c1d8", "message": "Add a test for ExecutorEventThread.", "committedDate": "2020-09-08T05:09:50Z", "type": "commit"}, {"oid": "f1daa1545092f488d18b21b844c53d5ac8983e80", "url": "https://github.com/ConsenSys/teku/commit/f1daa1545092f488d18b21b844c53d5ac8983e80", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into track-chains", "committedDate": "2020-09-08T05:16:25Z", "type": "commit"}, {"oid": "ddf720450942314f2b432470634e60228d094a43", "url": "https://github.com/ConsenSys/teku/commit/ddf720450942314f2b432470634e60228d094a43", "message": "Don't use getters for equals.", "committedDate": "2020-09-08T06:04:29Z", "type": "commit"}, {"oid": "209e9b3dcce97e1bc77cc1fa1088668ac31d04c9", "url": "https://github.com/ConsenSys/teku/commit/209e9b3dcce97e1bc77cc1fa1088668ac31d04c9", "message": "Remove annoying IntelliJ annotation.", "committedDate": "2020-09-08T06:34:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA1NjkwNg==", "url": "https://github.com/ConsenSys/teku/pull/2750#discussion_r485056906", "bodyText": "Don't we want to stick here to AsyncRunner interface as our primary scheduler?\nThat can be useful when/if we would like to implement 'time machine'", "author": "Nashatyrev", "createdAt": "2020-09-08T16:41:20Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/eventthread/ExecutorEventThread.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync.multipeer.eventthread;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+public class ExecutorEventThread implements EventThread {\n+  private final AtomicBoolean started = new AtomicBoolean(false);\n+  private final String name;\n+  private ExecutorService thread;\n+\n+  /** The ID of the event thread. The first task executed by the executor sets this ID. */\n+  private volatile long eventThreadId = -1;\n+\n+  public ExecutorEventThread(final String name) {\n+    this.name = name;\n+  }\n+\n+  @Override\n+  public void checkOnEventThread() {\n+    checkState(isEventThread(), \"Attempting to access \" + name + \" resource from non-event thread\");\n+  }\n+\n+  private boolean isEventThread() {\n+    return Thread.currentThread().getId() == eventThreadId;\n+  }\n+\n+  @Override\n+  public synchronized void start() {\n+    if (started.get()) {\n+      return;\n+    }\n+    thread =\n+        Executors.newSingleThreadExecutor(\n+            new ThreadFactoryBuilder().setNameFormat(name).setDaemon(true).build());", "originalCommit": "209e9b3dcce97e1bc77cc1fa1088668ac31d04c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MTI5OQ==", "url": "https://github.com/ConsenSys/teku/pull/2750#discussion_r485281299", "bodyText": "Probably won't affect the time machine but still worth using the same infrastructure - it gives us metrics on the length of the queue as well which is useful.", "author": "ajsutton", "createdAt": "2020-09-09T01:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA1NjkwNg=="}], "type": "inlineReview"}, {"oid": "1cdad498fb347f9e005c45dc7539ca3876ddf825", "url": "https://github.com/ConsenSys/teku/commit/1cdad498fb347f9e005c45dc7539ca3876ddf825", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into track-chains", "committedDate": "2020-09-09T00:31:52Z", "type": "commit"}, {"oid": "5b3f4cd2cc3c6434458e8873fca5a16a2641cc89", "url": "https://github.com/ConsenSys/teku/commit/5b3f4cd2cc3c6434458e8873fca5a16a2641cc89", "message": "Move EventThread to infrastructure:async module and convert it to use an AsyncRunner.", "committedDate": "2020-09-09T00:48:28Z", "type": "commit"}, {"oid": "e938e855f3b41dd244e7a647a5407c2b2c050ca4", "url": "https://github.com/ConsenSys/teku/commit/e938e855f3b41dd244e7a647a5407c2b2c050ca4", "message": "Merge branch 'master' into track-chains", "committedDate": "2020-09-09T01:21:08Z", "type": "commit"}, {"oid": "1b1ed051109f121018436c334cb2ce87e6038d35", "url": "https://github.com/ConsenSys/teku/commit/1b1ed051109f121018436c334cb2ce87e6038d35", "message": "Merge branch 'master' into track-chains", "committedDate": "2020-09-10T05:26:53Z", "type": "commit"}]}