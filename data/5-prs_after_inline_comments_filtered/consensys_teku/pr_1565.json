{"pr_number": 1565, "pr_title": "Get the latest available state prior to the requested slot when calculating duties", "pr_createdAt": "2020-04-09T01:02:00Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1565", "timeline": [{"oid": "e062006a9448b1ffc63747e8041dde7aac82a3c0", "url": "https://github.com/ConsenSys/teku/commit/e062006a9448b1ffc63747e8041dde7aac82a3c0", "message": "Get the latest available state prior to the requested slot when calculating duties and process slots until the required slot.\nAvoids issue where duties could not be calculated when the slot was empty.", "committedDate": "2020-04-09T00:59:03Z", "type": "commit"}, {"oid": "657849ac7ffd32de781c80bec062a6088abe412d", "url": "https://github.com/ConsenSys/teku/commit/657849ac7ffd32de781c80bec062a6088abe412d", "message": "Merge branch 'master' into duties-and-skipped-slots", "committedDate": "2020-04-09T18:05:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQxODMyMA==", "url": "https://github.com/ConsenSys/teku/pull/1565#discussion_r406418320", "bodyText": "It's unclear to me what's the difference between the two tests here and specifically what they are testing. I've removed both of their bestState and newState lines, kept only a random beacon state generation instead, and that resulted in both tests passing as well.", "author": "cemozerr", "createdAt": "2020-04-09T19:09:22Z", "path": "storage/src/test/java/tech/pegasys/artemis/storage/client/RecentChainDataTest.java", "diffHunk": "@@ -189,7 +189,33 @@ public void getStateBySlot_returnGenesisBlockWhenItIsTheBestState() {\n     when(store.getBlockState(GENESIS_BLOCK_ROOT)).thenReturn(newState);\n     when(store.getBlock(GENESIS_BLOCK_ROOT)).thenReturn(GENESIS_BLOCK);\n \n-    assertThat(storageClient.getBlockBySlot(UnsignedLong.ZERO)).contains(GENESIS_BLOCK);\n+    assertThat(storageClient.getStateInEffectAtSlot(UnsignedLong.ZERO)).contains(newState);\n+  }\n+\n+  @Test\n+  public void getStateInEffectAtSlot_returnStateFromLastBlockWhenSlotsAreEmpty() {", "originalCommit": "657849ac7ffd32de781c80bec062a6088abe412d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1MTc2OQ==", "url": "https://github.com/ConsenSys/teku/pull/1565#discussion_r406451769", "bodyText": "It might make more sense to move slot processing into combinedChainDataClient.", "author": "mbaxter", "createdAt": "2020-04-09T20:14:56Z", "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/ValidatorApiHandler.java", "diffHunk": "@@ -101,7 +107,20 @@ public ValidatorApiHandler(\n         .getStateAtSlot(slot)\n         .thenApply(\n             optionalState ->\n-                optionalState.map(state -> getValidatorDutiesFromState(state, epoch, publicKeys)));\n+                optionalState\n+                    .map(state -> processSlots(state, slot))", "originalCommit": "657849ac7ffd32de781c80bec062a6088abe412d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a558c9c9b684769d7b154a766f5e0f3c165bb555", "url": "https://github.com/ConsenSys/teku/commit/a558c9c9b684769d7b154a766f5e0f3c165bb555", "message": "Merge branch 'master' into duties-and-skipped-slots", "committedDate": "2020-04-10T19:57:11Z", "type": "commit"}]}