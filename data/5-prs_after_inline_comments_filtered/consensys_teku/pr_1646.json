{"pr_number": 1646, "pr_title": "Update log-destination to use the enumeration for LoggingDestination.", "pr_createdAt": "2020-04-22T03:09:07Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1646", "timeline": [{"oid": "51d5d87fb8a40c6372383785137d0b80f6005de9", "url": "https://github.com/ConsenSys/teku/commit/51d5d87fb8a40c6372383785137d0b80f6005de9", "message": "Update log-destination to use the enumeration for LoggingDestination.\n\nAddresses #1641\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-04-22T03:08:26Z", "type": "commit"}, {"oid": "cfdb93ff37398da408aa8a41a0603c6fc9b03a71", "url": "https://github.com/ConsenSys/teku/commit/cfdb93ff37398da408aa8a41a0603c6fc9b03a71", "message": "Merge remote-tracking branch 'upstream/master' into 1641-log-destination\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-04-22T03:16:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYzOTA0OQ==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r412639049", "bodyText": "Wouldn't it make more sense to just use:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private LoggingDestination logDestination = LoggingDestination.get(DEFAULT_LOG_DESTINATION);\n          \n          \n            \n              private LoggingDestination logDestination = LoggingDestination.DEFAULT_BOTH;", "author": "ajsutton", "createdAt": "2020-04-22T03:19:50Z", "path": "artemis/src/main/java/tech/pegasys/artemis/cli/options/LoggingOptions.java", "diffHunk": "@@ -54,9 +55,10 @@\n   @CommandLine.Option(\n       names = {LOG_DESTINATION_OPTION_NAME},\n       paramLabel = \"<LOG_DESTINATION>\",\n-      description = \"Whether a logger is added for the console, the log file, or both\",\n+      description =\n+          \"Whether a logger is added for the console, the log file, or both (Valid values: ${COMPLETION-CANDIDATES})\",\n       arity = \"1\")\n-  private String logDestination = DEFAULT_LOG_DESTINATION;\n+  private LoggingDestination logDestination = LoggingDestination.get(DEFAULT_LOG_DESTINATION);", "originalCommit": "cfdb93ff37398da408aa8a41a0603c6fc9b03a71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY5Njg3NA==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r412696874", "bodyText": "just means its not set off the default - i can if you prefer...", "author": "rolfyone", "createdAt": "2020-04-22T06:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYzOTA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcwNjU2Mg==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r412706562", "bodyText": "The DEFAULT_LOG_DESTINATION constant could also be of type LoggingDestination.  Although I really don't know why we've extracted all this stuff as constants and will likely do a pass through to inline them all when I get a chance.  It's so much easier to read in besu where the strings are used directly in the @Option annotations.", "author": "ajsutton", "createdAt": "2020-04-22T06:32:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYzOTA0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY0MDExMw==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r412640113", "bodyText": "The code that uses this value expects the key not the enum name().  Currently key is internal only so a getter would be needed. I think it happens to work out at the moment but we should actually refer to the same value.  I suspect the key value is no longer relevant and we should just use .valueOf to look up the matching value.  Or just pass LoggingDestination enum through instead of going to String and back if the class path will let us do that.", "author": "ajsutton", "createdAt": "2020-04-22T03:23:21Z", "path": "artemis/src/main/java/tech/pegasys/artemis/cli/options/LoggingOptions.java", "diffHunk": "@@ -81,7 +83,7 @@ public boolean isLogIncludeEventsEnabled() {\n   }\n \n   public String getLogDestination() {\n-    return logDestination;\n+    return logDestination.name();", "originalCommit": "cfdb93ff37398da408aa8a41a0603c6fc9b03a71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcwMzAzMw==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r412703033", "bodyText": "the project dependencies are pretty ugly. i'll have another go.", "author": "rolfyone", "createdAt": "2020-04-22T06:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY0MDExMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcwNjEwOA==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r412706108", "bodyText": "I wouldn't try adjusting dependencies to make it happen.  Just make sure we consistently use either name or key to go to string and back.", "author": "ajsutton", "createdAt": "2020-04-22T06:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY0MDExMw=="}], "type": "inlineReview"}, {"oid": "2ad796be7bbedb7cb2d98cdccbe76f7d8cf35c3d", "url": "https://github.com/ConsenSys/teku/commit/2ad796be7bbedb7cb2d98cdccbe76f7d8cf35c3d", "message": "Added new tests for LoggingOptions, splitting them out from the old BeaconNodeCommandTest suite.\n\n - new abstract class for commandline tests\n\n - config file test specific to loggingOptions\n\n - addressed review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-04-22T21:39:48Z", "type": "commit"}, {"oid": "ccdf1d8ccf44200ed52531a8c702f7328e1cb5b4", "url": "https://github.com/ConsenSys/teku/commit/ccdf1d8ccf44200ed52531a8c702f7328e1cb5b4", "message": "Merge remote-tracking branch 'upstream/master' into 1641-log-destination", "committedDate": "2020-04-22T22:03:23Z", "type": "commit"}, {"oid": "a0462bf889e3ccf38d9738b0ef5760002d72548d", "url": "https://github.com/ConsenSys/teku/commit/a0462bf889e3ccf38d9738b0ef5760002d72548d", "message": "Merge remote-tracking branch 'upstream/master' into 1641-log-destination\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-04-22T22:57:30Z", "type": "commit"}, {"oid": "0857c7e716ad95357d016a828067066a1b9f7184", "url": "https://github.com/ConsenSys/teku/commit/0857c7e716ad95357d016a828067066a1b9f7184", "message": "Merge remote-tracking branch 'upstream/master' into 1641-log-destination", "committedDate": "2020-04-22T23:14:38Z", "type": "commit"}, {"oid": "df27b96d71f2ac9a1c640112cd614b720860fe53", "url": "https://github.com/ConsenSys/teku/commit/df27b96d71f2ac9a1c640112cd614b720860fe53", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-04-23T00:25:30Z", "type": "commit"}, {"oid": "34e38b819d0d15f3d0a10d0947b7c47d20b6b4e1", "url": "https://github.com/ConsenSys/teku/commit/34e38b819d0d15f3d0a10d0947b7c47d20b6b4e1", "message": "Merge remote-tracking branch 'upstream/master' into 1641-log-destination", "committedDate": "2020-04-23T00:25:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyNjQ5OA==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r413826498", "bodyText": "Should this actually be abstract? :D\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class AbstractBeaconNodeCommandTest {\n          \n          \n            \n            public abstract class AbstractBeaconNodeCommandTest {", "author": "mbaxter", "createdAt": "2020-04-23T14:08:17Z", "path": "artemis/src/test/java/tech/pegasys/artemis/cli/AbstractBeaconNodeCommandTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static tech.pegasys.artemis.cli.BeaconNodeCommand.CONFIG_FILE_OPTION_NAME;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.nio.file.Path;\n+import java.util.Collections;\n+import java.util.function.Consumer;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.mockito.ArgumentCaptor;\n+import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n+\n+public class AbstractBeaconNodeCommandTest {", "originalCommit": "34e38b819d0d15f3d0a10d0947b7c47d20b6b4e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMjg3OA==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r414102878", "bodyText": "yes :) it should!", "author": "rolfyone", "createdAt": "2020-04-23T20:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyNjQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyNzE5Mg==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r413827192", "bodyText": "Nice call splitting this out \ud83c\udf89", "author": "mbaxter", "createdAt": "2020-04-23T14:09:03Z", "path": "artemis/src/test/java/tech/pegasys/artemis/cli/options/LoggingOptionsTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.options;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static tech.pegasys.artemis.cli.options.LoggingOptions.LOG_DESTINATION_OPTION_NAME;\n+import static tech.pegasys.artemis.util.config.LoggingDestination.DEFAULT_BOTH;\n+\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.cli.AbstractBeaconNodeCommandTest;\n+import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n+import tech.pegasys.artemis.util.config.LoggingDestination;\n+\n+public class LoggingOptionsTest extends AbstractBeaconNodeCommandTest {", "originalCommit": "34e38b819d0d15f3d0a10d0947b7c47d20b6b4e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyNzk1OA==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r413827958", "bodyText": "(nit) I think we usually capitalize like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void logDestination_ShouldAcceptFileAsDestination() {\n          \n          \n            \n              public void logDestination_shouldAcceptFileAsDestination() {", "author": "mbaxter", "createdAt": "2020-04-23T14:09:56Z", "path": "artemis/src/test/java/tech/pegasys/artemis/cli/options/LoggingOptionsTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.options;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static tech.pegasys.artemis.cli.options.LoggingOptions.LOG_DESTINATION_OPTION_NAME;\n+import static tech.pegasys.artemis.util.config.LoggingDestination.DEFAULT_BOTH;\n+\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.cli.AbstractBeaconNodeCommandTest;\n+import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n+import tech.pegasys.artemis.util.config.LoggingDestination;\n+\n+public class LoggingOptionsTest extends AbstractBeaconNodeCommandTest {\n+\n+  @Test\n+  public void loggingOptions_shouldReadFromConfigurationFile() {\n+    final ArtemisConfiguration config =\n+        getArtemisConfigurationFromFile(\"loggingOptions_config.yaml\");\n+\n+    assertThat(config.getLogDestination()).isEqualTo(LoggingDestination.FILE);\n+    assertThat(config.isLogColorEnabled()).isFalse();\n+    assertThat(config.isLogIncludeEventsEnabled()).isFalse();\n+    assertThat(config.getLogFile()).isEqualTo(\"a.log\");\n+    assertThat(config.getLogFileNamePattern()).isEqualTo(\"a%d.log\");\n+  }\n+\n+  @Test\n+  public void logDestination_shouldHaveSensibleDefaultValue() {\n+    // This is important!\n+    // If it defaults to \"both\" or some other value custom log4j configs get overwritten\n+    beaconNodeCommand.parse(new String[0]);\n+\n+    final ArtemisConfiguration artemisConfiguration = getResultingArtemisConfiguration();\n+    assertThat(artemisConfiguration.getLogDestination()).isEqualTo(DEFAULT_BOTH);\n+  }\n+\n+  @Test\n+  public void logDestination_ShouldAcceptFileAsDestination() {", "originalCommit": "34e38b819d0d15f3d0a10d0947b7c47d20b6b4e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMzc0NQ==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r414103745", "bodyText": "gah, i knew that and i still stuffed it up", "author": "rolfyone", "createdAt": "2020-04-23T20:32:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyNzk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgzNjQyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r413836421", "bodyText": "Ultimately,util is the wrong place for logging-specific constants.  But fixing this issue will require a larger refactor.  Will discuss offline when / how to prioritize refactoring.", "author": "mbaxter", "createdAt": "2020-04-23T14:19:32Z", "path": "util/src/main/java/tech/pegasys/artemis/util/config/LoggingDestination.java", "diffHunk": "@@ -11,7 +11,7 @@\n  * specific language governing permissions and limitations under the License.\n  */\n \n-package tech.pegasys.teku.logging;\n+package tech.pegasys.artemis.util.config;", "originalCommit": "34e38b819d0d15f3d0a10d0947b7c47d20b6b4e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMzkxNg==", "url": "https://github.com/ConsenSys/teku/pull/1646#discussion_r414103916", "bodyText": "sounds good!", "author": "rolfyone", "createdAt": "2020-04-23T20:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgzNjQyMQ=="}], "type": "inlineReview"}, {"oid": "e1c687509590c76a595b90b803ac3c941087612f", "url": "https://github.com/ConsenSys/teku/commit/e1c687509590c76a595b90b803ac3c941087612f", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-04-23T20:34:04Z", "type": "commit"}, {"oid": "0e007a518e8e1b8e15f6767e89988540022700e1", "url": "https://github.com/ConsenSys/teku/commit/0e007a518e8e1b8e15f6767e89988540022700e1", "message": "Merge remote-tracking branch 'upstream/master' into 1641-log-destination", "committedDate": "2020-04-23T20:35:06Z", "type": "commit"}]}