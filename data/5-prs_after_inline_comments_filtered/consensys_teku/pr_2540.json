{"pr_number": 2540, "pr_title": "Switch from UnsignedLong to UInt64", "pr_createdAt": "2020-08-09T23:08:49Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2540", "timeline": [{"oid": "d47d2e37ef9d79f02cbc4aed35bd5879d7cf80e4", "url": "https://github.com/ConsenSys/teku/commit/d47d2e37ef9d79f02cbc4aed35bd5879d7cf80e4", "message": "Add unsigned dependency by default.", "committedDate": "2020-08-09T22:56:06Z", "type": "commit"}, {"oid": "0553dc71ad637b33e01d08b2c30906425b79c4cd", "url": "https://github.com/ConsenSys/teku/commit/0553dc71ad637b33e01d08b2c30906425b79c4cd", "message": "Switch UnsignedLong to UInt64.", "committedDate": "2020-08-09T23:00:08Z", "type": "commit"}, {"oid": "44f183f2dd697cfb10eec3e6457c238e4e1c6630", "url": "https://github.com/ConsenSys/teku/commit/44f183f2dd697cfb10eec3e6457c238e4e1c6630", "message": "Use built-in min and max instead of static utilities.", "committedDate": "2020-08-09T23:00:12Z", "type": "commit"}, {"oid": "c58bfa273ba1a1c2e311633422789501dedd88f8", "url": "https://github.com/ConsenSys/teku/commit/c58bfa273ba1a1c2e311633422789501dedd88f8", "message": "One more rename.", "committedDate": "2020-08-09T23:07:42Z", "type": "commit"}, {"oid": "589d79dd2b2d3a71e598bc7f4cf07ca9f97241bc", "url": "https://github.com/ConsenSys/teku/commit/589d79dd2b2d3a71e598bc7f4cf07ca9f97241bc", "message": "Use lowercase uint64 consistently in OpenAPI docs.\nAdd UInt64.SIZE instead of having separate constants to define it.", "committedDate": "2020-08-09T23:38:52Z", "type": "commit"}, {"oid": "0d3b236b4e78750bc8e4bfdb143f7a6fc3c71a4d", "url": "https://github.com/ConsenSys/teku/commit/0d3b236b4e78750bc8e4bfdb143f7a6fc3c71a4d", "message": "Rename a few unsigned_long to uint64.", "committedDate": "2020-08-09T23:44:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY0MDM2Ng==", "url": "https://github.com/ConsenSys/teku/pull/2540#discussion_r467640366", "bodyText": "@rolfyone Do we want this to still say UnsignedLong?  I've changed all the places that openapi referred to UnsignedLong to uint64 so its consistent with the @Schema annotations we have.", "author": "ajsutton", "createdAt": "2020-08-09T23:12:57Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/RestApiConstants.java", "diffHunk": "@@ -48,9 +48,9 @@\n       \"No content may be returned if the genesis block has not been set, meaning that there is no head to query.\";\n   public static final String INVALID_BODY_SUPPLIED = \"Invalid body supplied.\";\n \n-  public static final String EPOCH_QUERY_DESCRIPTION = \"`UnsignedLong` Epoch number to query.\";\n+  public static final String EPOCH_QUERY_DESCRIPTION = \"`UInt64` Epoch number to query.\";\n   public static final String SLOT_QUERY_DESCRIPTION =\n-      \"`UnsignedLong` Slot to query in the canonical chain.\";\n+      \"`UInt64` Slot to query in the canonical chain.\";", "originalCommit": "c58bfa273ba1a1c2e311633422789501dedd88f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY0MTAwNg==", "url": "https://github.com/ConsenSys/teku/pull/2540#discussion_r467641006", "bodyText": "We should review this to make sure it can never overflow. But that's not for this PR.", "author": "ajsutton", "createdAt": "2020-08-09T23:19:06Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/epoch/EpochProcessorUtil.java", "diffHunk": "@@ -318,28 +314,26 @@ public static void process_registry_updates(MutableBeaconState state)\n    *     <a>https://github.com/ethereum/eth2.0-specs/blob/v0.8.0/specs/core/0_beacon-chain.md#slashings</a>\n    */\n   public static void process_slashings(MutableBeaconState state) {\n-    UnsignedLong epoch = get_current_epoch(state);\n-    UnsignedLong total_balance = get_total_active_balance(state);\n+    UInt64 epoch = get_current_epoch(state);\n+    UInt64 total_balance = get_total_active_balance(state);\n \n     SSZList<Validator> validators = state.getValidators();\n     for (int index = 0; index < validators.size(); index++) {\n       Validator validator = validators.get(index);\n       if (validator.isSlashed()\n           && epoch\n-              .plus(UnsignedLong.valueOf(EPOCHS_PER_SLASHINGS_VECTOR / 2))\n+              .plus(UInt64.valueOf(EPOCHS_PER_SLASHINGS_VECTOR / 2))\n               .equals(validator.getWithdrawable_epoch())) {\n-        UnsignedLong increment = EFFECTIVE_BALANCE_INCREMENT;\n-        UnsignedLong penalty_numerator =\n+        UInt64 increment = EFFECTIVE_BALANCE_INCREMENT;\n+        UInt64 penalty_numerator =\n             validator\n                 .getEffective_balance()\n                 .dividedBy(increment)\n                 .times(\n-                    min(\n-                        UnsignedLong.valueOf(\n-                            state.getSlashings().stream().mapToLong(UnsignedLong::longValue).sum()\n-                                * 3),\n-                        total_balance));\n-        UnsignedLong penalty = penalty_numerator.dividedBy(total_balance).times(increment);\n+                    UInt64.valueOf(\n+                            state.getSlashings().stream().mapToLong(UInt64::longValue).sum() * 3)", "originalCommit": "c58bfa273ba1a1c2e311633422789501dedd88f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NjIzOQ==", "url": "https://github.com/ConsenSys/teku/pull/2540#discussion_r467756239", "bodyText": "This was dealt with in the spec in ethereum/consensus-specs#1286 and the implementation here looks to match the spec. So I believe we are good.", "author": "benjaminion", "createdAt": "2020-08-10T08:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY0MTAwNg=="}], "type": "inlineReview"}, {"oid": "c2bf7a577eafa717a64e6f99cf7bb3f0508f4d61", "url": "https://github.com/ConsenSys/teku/commit/c2bf7a577eafa717a64e6f99cf7bb3f0508f4d61", "message": "Ahem, UInt64 is 64 bits which is only 8 bytes....", "committedDate": "2020-08-09T23:51:17Z", "type": "commit"}, {"oid": "edd6c4bb0b7a405ddfad3306ec1c56d494716d01", "url": "https://github.com/ConsenSys/teku/commit/edd6c4bb0b7a405ddfad3306ec1c56d494716d01", "message": "Reapply fix for GetValidatorsTest that was lost in the merge.", "committedDate": "2020-08-10T00:01:19Z", "type": "commit"}]}