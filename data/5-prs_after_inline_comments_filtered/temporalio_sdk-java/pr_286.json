{"pr_number": 286, "pr_title": "Avoid activity task prefetching when handlers are busy", "pr_createdAt": "2020-12-22T03:39:23Z", "pr_url": "https://github.com/temporalio/sdk-java/pull/286", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA2MjQwMw==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547062403", "bodyText": "Let's change from \"public class\" to \"final class\"", "author": "mfateev", "createdAt": "2020-12-22T04:33:20Z", "path": "temporal-sdk/src/main/java/io/temporal/internal/worker/ActivityTask.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.internal.worker;\n+\n+import io.temporal.api.workflowservice.v1.PollActivityTaskQueueResponse;\n+import io.temporal.workflow.Functions;\n+\n+public class ActivityTask {", "originalCommit": "927d1c389479bb84be99348ec8abad4dc9ff8d6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA3MzQ2MQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547073461", "bodyText": "done", "author": "vitarb", "createdAt": "2020-12-22T05:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA2MjQwMw=="}], "type": "inlineReview"}, {"oid": "a0fa84b74d74aa5a95e894572b380af1f886ec36", "url": "https://github.com/temporalio/sdk-java/commit/a0fa84b74d74aa5a95e894572b380af1f886ec36", "message": "Fix for poll prefetch", "committedDate": "2020-12-22T05:22:44Z", "type": "commit"}, {"oid": "3c37b94345075a14d640f875bbca1d42126bd658", "url": "https://github.com/temporalio/sdk-java/commit/3c37b94345075a14d640f875bbca1d42126bd658", "message": "Acquire semaphore before making a call to the service", "committedDate": "2020-12-22T05:22:44Z", "type": "commit"}, {"oid": "715ded2938acdc73e243964b4b0c47f756104ef4", "url": "https://github.com/temporalio/sdk-java/commit/715ded2938acdc73e243964b4b0c47f756104ef4", "message": "Add worker rule and a test to verify no agreessive polling behavior", "committedDate": "2020-12-22T05:22:44Z", "type": "commit"}, {"oid": "e73ec447c0605708295bf68510aff76f28472288", "url": "https://github.com/temporalio/sdk-java/commit/e73ec447c0605708295bf68510aff76f28472288", "message": "Simplify test rule implementation", "committedDate": "2020-12-22T05:22:44Z", "type": "commit"}, {"oid": "8540bfbcd812a292609193fde637831b1c0b13b4", "url": "https://github.com/temporalio/sdk-java/commit/8540bfbcd812a292609193fde637831b1c0b13b4", "message": "Make activity task final and not public", "committedDate": "2020-12-22T05:22:44Z", "type": "commit"}, {"oid": "8540bfbcd812a292609193fde637831b1c0b13b4", "url": "https://github.com/temporalio/sdk-java/commit/8540bfbcd812a292609193fde637831b1c0b13b4", "message": "Make activity task final and not public", "committedDate": "2020-12-22T05:22:44Z", "type": "forcePushed"}, {"oid": "1604ecd0dd950f51a8c9eb4e914bd6c0d7f61896", "url": "https://github.com/temporalio/sdk-java/commit/1604ecd0dd950f51a8c9eb4e914bd6c0d7f61896", "message": "Use properties instead of env variables", "committedDate": "2020-12-22T06:02:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxMDYzNw==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547410637", "bodyText": "Might be worth adding a docstring indicating that owners are expected to call this when the task is complete", "author": "Sushisource", "createdAt": "2020-12-22T17:40:09Z", "path": "temporal-sdk/src/main/java/io/temporal/internal/worker/ActivityTask.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.internal.worker;\n+\n+import io.temporal.api.workflowservice.v1.PollActivityTaskQueueResponse;\n+import io.temporal.workflow.Functions;\n+\n+final class ActivityTask {\n+  private final PollActivityTaskQueueResponse response;\n+  private final Functions.Proc completionHandle;\n+\n+  public ActivityTask(PollActivityTaskQueueResponse response, Functions.Proc completionHandle) {\n+    this.response = response;\n+    this.completionHandle = completionHandle;\n+  }\n+\n+  public PollActivityTaskQueueResponse getResponse() {\n+    return response;\n+  }\n+\n+  public Functions.Proc getCompletionHandle() {", "originalCommit": "1604ecd0dd950f51a8c9eb4e914bd6c0d7f61896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ4NzQxOA==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547487418", "bodyText": "Done.", "author": "vitarb", "createdAt": "2020-12-22T20:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxMDYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxMTI5OQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547411299", "bodyText": "Docstring for what this means would be useful as well", "author": "Sushisource", "createdAt": "2020-12-22T17:41:36Z", "path": "temporal-sdk/src/main/java/io/temporal/testing/TestEnvironmentOptions.java", "diffHunk": "@@ -114,6 +143,14 @@ public Scope getMetricsScope() {\n     return metricsScope;\n   }\n \n+  public boolean isUseExternalService() {", "originalCommit": "1604ecd0dd950f51a8c9eb4e914bd6c0d7f61896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ4NzQ4Mw==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547487483", "bodyText": "Done", "author": "vitarb", "createdAt": "2020-12-22T20:15:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxMTI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxNzIyMw==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547417223", "bodyText": "Are there other existing tests that could be shortened by using this?", "author": "Sushisource", "createdAt": "2020-12-22T17:53:48Z", "path": "temporal-sdk/src/test/java/io/temporal/workflow/WorkerRule.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.workflow;\n+\n+import io.temporal.client.WorkflowClient;\n+import io.temporal.client.WorkflowClientOptions;\n+import io.temporal.testing.TestEnvironmentOptions;\n+import io.temporal.testing.TestWorkflowEnvironment;\n+import io.temporal.worker.Worker;\n+import io.temporal.worker.WorkerFactoryOptions;\n+import io.temporal.worker.WorkerOptions;\n+import java.util.UUID;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class WorkerRule implements TestRule {", "originalCommit": "1604ecd0dd950f51a8c9eb4e914bd6c0d7f61896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQzODkwNw==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547438907", "bodyText": "All of them.", "author": "vitarb", "createdAt": "2020-12-22T18:33:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxNzIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1NjUyNg==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547356526", "bodyText": "We already use  target for service address. The term comes from gRPC.", "author": "mfateev", "createdAt": "2020-12-22T15:55:22Z", "path": "temporal-sdk/src/main/java/io/temporal/testing/TestEnvironmentOptions.java", "diffHunk": "@@ -54,11 +54,17 @@ public static TestEnvironmentOptions getDefaultInstance() {\n \n     private Scope metricsScope;\n \n+    private boolean useExternalService;\n+\n+    private String serviceAddress;", "originalCommit": "1604ecd0dd950f51a8c9eb4e914bd6c0d7f61896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ4OTEzNQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547489135", "bodyText": "Done", "author": "vitarb", "createdAt": "2020-12-22T20:19:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1NjUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQyMjk4NQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547422985", "bodyText": "Let's follow the same pattern as all other options. It should be WorkerRule.newBuilder().", "author": "mfateev", "createdAt": "2020-12-22T18:06:19Z", "path": "temporal-sdk/src/test/java/io/temporal/workflow/ActivityPollerPrefetchingTest.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.workflow;\n+\n+import io.temporal.activity.Activity;\n+import io.temporal.activity.ActivityInterface;\n+import io.temporal.activity.ActivityMethod;\n+import io.temporal.activity.ActivityOptions;\n+import io.temporal.client.WorkflowOptions;\n+import io.temporal.common.RetryOptions;\n+import io.temporal.worker.WorkerOptions;\n+import java.time.Duration;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.junit.Assert;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+public class ActivityPollerPrefetchingTest {\n+\n+  @Rule\n+  public WorkerRule workerRule =\n+      new WorkerRule.Builder()", "originalCommit": "1604ecd0dd950f51a8c9eb4e914bd6c0d7f61896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5MDA3Mw==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547490073", "bodyText": "Done", "author": "vitarb", "createdAt": "2020-12-22T20:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQyMjk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQyMzM4NA==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547423384", "bodyText": "I would make all the fields final.", "author": "mfateev", "createdAt": "2020-12-22T18:07:13Z", "path": "temporal-sdk/src/test/java/io/temporal/workflow/WorkerRule.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.workflow;\n+\n+import io.temporal.client.WorkflowClient;\n+import io.temporal.client.WorkflowClientOptions;\n+import io.temporal.testing.TestEnvironmentOptions;\n+import io.temporal.testing.TestWorkflowEnvironment;\n+import io.temporal.worker.Worker;\n+import io.temporal.worker.WorkerFactoryOptions;\n+import io.temporal.worker.WorkerOptions;\n+import java.util.UUID;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class WorkerRule implements TestRule {\n+\n+  private Class<?>[] workflowTypes;\n+  private Object[] activityImplementations;\n+  private TestWorkflowEnvironment testEnvironment;\n+  private WorkerOptions workerOptions;\n+  private Worker worker;\n+  private String taskQueue;\n+  private boolean useExternalService;", "originalCommit": "1604ecd0dd950f51a8c9eb4e914bd6c0d7f61896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5MDI4MQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547490281", "bodyText": "We can't do them all final as worker/task queue are initialized in the init method that is called from apply rather then constructor, but most of them can.", "author": "vitarb", "createdAt": "2020-12-22T20:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQyMzM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQyMzU1NQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547423555", "bodyText": "Add public modifier.", "author": "mfateev", "createdAt": "2020-12-22T18:07:37Z", "path": "temporal-sdk/src/test/java/io/temporal/workflow/WorkerRule.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.workflow;\n+\n+import io.temporal.client.WorkflowClient;\n+import io.temporal.client.WorkflowClientOptions;\n+import io.temporal.testing.TestEnvironmentOptions;\n+import io.temporal.testing.TestWorkflowEnvironment;\n+import io.temporal.worker.Worker;\n+import io.temporal.worker.WorkerFactoryOptions;\n+import io.temporal.worker.WorkerOptions;\n+import java.util.UUID;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class WorkerRule implements TestRule {\n+\n+  private Class<?>[] workflowTypes;\n+  private Object[] activityImplementations;\n+  private TestWorkflowEnvironment testEnvironment;\n+  private WorkerOptions workerOptions;\n+  private Worker worker;\n+  private String taskQueue;\n+  private boolean useExternalService;\n+\n+  private WorkerRule(\n+      TestWorkflowEnvironment testEnvironment,\n+      boolean useExternalService,\n+      Class<?>[] workflowTypes,\n+      Object[] activityImplementations,\n+      WorkerOptions workerOptions) {\n+    this.testEnvironment = testEnvironment;\n+    this.useExternalService = useExternalService;\n+    this.workflowTypes = workflowTypes;\n+    this.activityImplementations = activityImplementations;\n+    this.workerOptions = workerOptions;\n+  }\n+\n+  static class Builder {", "originalCommit": "1604ecd0dd950f51a8c9eb4e914bd6c0d7f61896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5MDM5Mg==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547490392", "bodyText": "Done", "author": "vitarb", "createdAt": "2020-12-22T20:22:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQyMzU1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3NDU0OA==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547474548", "bodyText": "I would rename it to TestWorkflowRule to be consistent with TestWorkflowEnvironment", "author": "mfateev", "createdAt": "2020-12-22T19:44:59Z", "path": "temporal-sdk/src/test/java/io/temporal/workflow/WorkerRule.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.workflow;\n+\n+import io.temporal.client.WorkflowClient;\n+import io.temporal.client.WorkflowClientOptions;\n+import io.temporal.testing.TestEnvironmentOptions;\n+import io.temporal.testing.TestWorkflowEnvironment;\n+import io.temporal.worker.Worker;\n+import io.temporal.worker.WorkerFactoryOptions;\n+import io.temporal.worker.WorkerOptions;\n+import java.util.UUID;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class WorkerRule implements TestRule {", "originalCommit": "1604ecd0dd950f51a8c9eb4e914bd6c0d7f61896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5MDM2OA==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547490368", "bodyText": "Done", "author": "vitarb", "createdAt": "2020-12-22T20:22:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3NDU0OA=="}], "type": "inlineReview"}, {"oid": "dc870c3718a43f0e47307b123d468e4dba857737", "url": "https://github.com/temporalio/sdk-java/commit/dc870c3718a43f0e47307b123d468e4dba857737", "message": "Address PR feedback", "committedDate": "2020-12-22T20:46:11Z", "type": "commit"}, {"oid": "02213508c966379f08015cc457971db6cd22e07e", "url": "https://github.com/temporalio/sdk-java/commit/02213508c966379f08015cc457971db6cd22e07e", "message": "remove duplicate tests", "committedDate": "2020-12-22T20:46:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUzNTYyNA==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547535624", "bodyText": "Add JavaDoc explaining the meaning of the target and useExternalService properties.", "author": "mfateev", "createdAt": "2020-12-22T22:22:54Z", "path": "temporal-sdk/src/test/java/io/temporal/workflow/TestWorkflowRule.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.workflow;\n+\n+import io.temporal.client.WorkflowClient;\n+import io.temporal.client.WorkflowClientOptions;\n+import io.temporal.testing.TestEnvironmentOptions;\n+import io.temporal.testing.TestWorkflowEnvironment;\n+import io.temporal.worker.Worker;\n+import io.temporal.worker.WorkerFactoryOptions;\n+import io.temporal.worker.WorkerOptions;\n+import java.util.UUID;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class TestWorkflowRule implements TestRule {\n+\n+  private final Class<?>[] workflowTypes;\n+  private final Object[] activityImplementations;\n+  private final TestWorkflowEnvironment testEnvironment;\n+  private final WorkerOptions workerOptions;\n+  private final boolean useExternalService;\n+  private Worker worker;\n+  private String taskQueue;\n+\n+  private TestWorkflowRule(\n+      TestWorkflowEnvironment testEnvironment,\n+      boolean useExternalService,\n+      Class<?>[] workflowTypes,\n+      Object[] activityImplementations,\n+      WorkerOptions workerOptions) {\n+    this.testEnvironment = testEnvironment;\n+    this.useExternalService = useExternalService;\n+    this.workflowTypes = workflowTypes;\n+    this.activityImplementations = activityImplementations;\n+    this.workerOptions = workerOptions;\n+  }\n+\n+  public static Builder newBuilder() {\n+    return new Builder();\n+  }\n+\n+  public static class Builder {\n+    private WorkerOptions workerOptions;\n+    private String namespace;\n+    private Class<?>[] workflowTypes;\n+    private Object[] activityImplementations;\n+    private boolean useExternalService;\n+    private String target;\n+\n+    private Builder() {}\n+\n+    public Builder setWorkerOptions(WorkerOptions options) {\n+      this.workerOptions = options;\n+      return this;\n+    }\n+\n+    public Builder setNamespace(String namespace) {\n+      this.namespace = namespace;\n+      return this;\n+    }\n+\n+    public Builder setWorkflowTypes(Class<?>... workflowTypes) {\n+      this.workflowTypes = workflowTypes;\n+      return this;\n+    }\n+\n+    public Builder setActivityImplementations(Object... activityImplementations) {\n+      this.activityImplementations = activityImplementations;\n+      return this;\n+    }\n+\n+    public Builder setUseExternalService(boolean useExternalService) {\n+      this.useExternalService = useExternalService;\n+      return this;\n+    }\n+\n+    public Builder setTarget(String target) {", "originalCommit": "02213508c966379f08015cc457971db6cd22e07e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1MDk5Mg==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547550992", "bodyText": "Added here as well  as also included a java doc with example for the entire rule.", "author": "vitarb", "createdAt": "2020-12-22T23:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUzNTYyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUzNTc3NQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547535775", "bodyText": "rename to target and add appropriate JavaDoc.", "author": "mfateev", "createdAt": "2020-12-22T22:23:23Z", "path": "temporal-sdk/src/main/java/io/temporal/testing/TestEnvironmentOptions.java", "diffHunk": "@@ -77,29 +83,52 @@ public Builder setMetricsScope(Scope metricsScope) {\n       return this;\n     }\n \n+    public Builder setUseExternalService(boolean useExternalService) {", "originalCommit": "02213508c966379f08015cc457971db6cd22e07e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1MTEyNQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547551125", "bodyText": "Do you want to rename to setUseExternalTarget? Added a javadoc.", "author": "vitarb", "createdAt": "2020-12-22T23:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUzNTc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1Mzg3OA==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547553878", "bodyText": "Addressed the naming in WorkerFactoryOptions", "author": "vitarb", "createdAt": "2020-12-22T23:21:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUzNTc3NQ=="}], "type": "inlineReview"}, {"oid": "a22bec502c1e0790264a2cef0a4d2c734e5c373e", "url": "https://github.com/temporalio/sdk-java/commit/a22bec502c1e0790264a2cef0a4d2c734e5c373e", "message": "Add comments and hide workflow worker from the consumer", "committedDate": "2020-12-22T23:10:30Z", "type": "commit"}, {"oid": "3b3bc190e392bba64ebc20d5a2b2f31a606a8601", "url": "https://github.com/temporalio/sdk-java/commit/3b3bc190e392bba64ebc20d5a2b2f31a606a8601", "message": "Rename service address to target in env options", "committedDate": "2020-12-22T23:21:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1MTkzNw==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547551937", "bodyText": "Rename to setTarget", "author": "mfateev", "createdAt": "2020-12-22T23:15:44Z", "path": "temporal-sdk/src/main/java/io/temporal/testing/TestEnvironmentOptions.java", "diffHunk": "@@ -77,29 +83,52 @@ public Builder setMetricsScope(Scope metricsScope) {\n       return this;\n     }\n \n+    public Builder setUseExternalService(boolean useExternalService) {\n+      this.useExternalService = useExternalService;\n+      return this;\n+    }\n+\n+    public Builder setServiceAddress(String serviceAddress) {", "originalCommit": "a22bec502c1e0790264a2cef0a4d2c734e5c373e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1NDQxNQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547554415", "bodyText": "Let's move the try to the beginning of the method. For example, if propagateContext throws we are going to leak semaphore.", "author": "mfateev", "createdAt": "2020-12-22T23:23:49Z", "path": "temporal-sdk/src/main/java/io/temporal/internal/worker/ActivityWorker.java", "diffHunk": "@@ -161,44 +160,44 @@ private TaskHandlerImpl(ActivityTaskHandler handler) {\n     }\n \n     @Override\n-    public void handle(PollActivityTaskQueueResponse task) throws Exception {\n-\n+    public void handle(ActivityTask task) throws Exception {\n+      PollActivityTaskQueueResponse r = task.getResponse();\n       Scope metricsScope =\n           options\n               .getMetricsScope()\n               .tagged(\n                   ImmutableMap.of(\n                       MetricsTag.ACTIVITY_TYPE,\n-                      task.getActivityType().getName(),\n+                      r.getActivityType().getName(),\n                       MetricsTag.WORKFLOW_TYPE,\n-                      task.getWorkflowType().getName()));\n+                      r.getWorkflowType().getName()));\n \n       metricsScope\n           .timer(MetricsType.ACTIVITY_SCHEDULE_TO_START_LATENCY)\n           .record(\n               ProtobufTimeUtils.toM3Duration(\n-                  task.getStartedTime(), task.getCurrentAttemptScheduledTime()));\n+                  r.getStartedTime(), r.getCurrentAttemptScheduledTime()));\n \n       // The following tags are for logging.\n-      MDC.put(LoggerTag.ACTIVITY_ID, task.getActivityId());\n-      MDC.put(LoggerTag.ACTIVITY_TYPE, task.getActivityType().getName());\n-      MDC.put(LoggerTag.WORKFLOW_ID, task.getWorkflowExecution().getWorkflowId());\n-      MDC.put(LoggerTag.RUN_ID, task.getWorkflowExecution().getRunId());\n+      MDC.put(LoggerTag.ACTIVITY_ID, r.getActivityId());\n+      MDC.put(LoggerTag.ACTIVITY_TYPE, r.getActivityType().getName());\n+      MDC.put(LoggerTag.WORKFLOW_ID, r.getWorkflowExecution().getWorkflowId());\n+      MDC.put(LoggerTag.RUN_ID, r.getWorkflowExecution().getRunId());\n \n-      propagateContext(task);\n+      propagateContext(r);\n \n       try {", "originalCommit": "3b3bc190e392bba64ebc20d5a2b2f31a606a8601", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1ODg3MQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547558871", "bodyText": "Done, we still need to have metric scope and response variables declared outside of the try block though.\nI think it should be safe this way.", "author": "vitarb", "createdAt": "2020-12-22T23:39:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1NDQxNQ=="}], "type": "inlineReview"}, {"oid": "6713082a8120c1a6cbb1346f0e3314300966b4bf", "url": "https://github.com/temporalio/sdk-java/commit/6713082a8120c1a6cbb1346f0e3314300966b4bf", "message": "Make try block wider", "committedDate": "2020-12-22T23:34:29Z", "type": "commit"}, {"oid": "59133a170d8bb69cf7d6a41b949e8db327df7fb2", "url": "https://github.com/temporalio/sdk-java/commit/59133a170d8bb69cf7d6a41b949e8db327df7fb2", "message": "update javadocs", "committedDate": "2020-12-22T23:37:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1OTM0MQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547559341", "bodyText": "I believe we have to move this acquire to before the try", "author": "mfateev", "createdAt": "2020-12-22T23:41:16Z", "path": "temporal-sdk/src/main/java/io/temporal/internal/worker/ActivityPollTask.java", "diffHunk": "@@ -86,31 +89,39 @@ public PollActivityTaskQueueResponse poll() {\n     if (log.isTraceEnabled()) {\n       log.trace(\"poll request begin: \" + pollRequest);\n     }\n-    PollActivityTaskQueueResponse result;\n+    PollActivityTaskQueueResponse response;\n+    boolean isSuccessful = false;\n     try {\n-      result =\n-          service\n-              .blockingStub()\n-              .withOption(METRICS_TAGS_CALL_OPTIONS_KEY, metricsScope)\n-              .pollActivityTaskQueue(pollRequest.build());\n-    } catch (StatusRuntimeException e) {\n-      if (e.getStatus().getCode() == Status.Code.UNAVAILABLE\n-          && e.getMessage().startsWith(\"UNAVAILABLE: Channel shutdown\")) {\n-        return null;\n+      pollSemaphore.acquire();", "originalCommit": "59133a170d8bb69cf7d6a41b949e8db327df7fb2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2MTYwOQ==", "url": "https://github.com/temporalio/sdk-java/pull/286#discussion_r547561609", "bodyText": "done", "author": "vitarb", "createdAt": "2020-12-22T23:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1OTM0MQ=="}], "type": "inlineReview"}, {"oid": "827c08644ab2e1b9cef44ea1ea690c8186e07f28", "url": "https://github.com/temporalio/sdk-java/commit/827c08644ab2e1b9cef44ea1ea690c8186e07f28", "message": "move semaphore acquire out of try", "committedDate": "2020-12-22T23:44:33Z", "type": "commit"}, {"oid": "74a2fc1d54e80f6d5b74227ec721b500c9d51d32", "url": "https://github.com/temporalio/sdk-java/commit/74a2fc1d54e80f6d5b74227ec721b500c9d51d32", "message": "Consolidate try catch", "committedDate": "2020-12-22T23:49:07Z", "type": "commit"}]}