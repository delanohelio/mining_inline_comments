{"pr_number": 516, "pr_title": "feat(pubsub): initial port of kork-pubsub", "pr_createdAt": "2020-02-14T20:17:01Z", "pr_url": "https://github.com/spinnaker/kork/pull/516", "timeline": [{"oid": "72306a07693af35fc8dd1f75732461008230f798", "url": "https://github.com/spinnaker/kork/commit/72306a07693af35fc8dd1f75732461008230f798", "message": "feat(pubsub): initial port of kork-pubsub\n\nThis is mostly a port of echo's pubsub support, with some additional SNS coming from clouddriver.\n\nThere are minor differences with some classes from echo, but overall the idea is that one can configure a subscription (topic + queue) through Spring these classes will:\n- parse the list of subscriptions from the configuration\n- make sure the topics and queues for each subscription exist\n- start a polling thread to read messages from each queue\n- hand over messages to the handlers registered by the application", "committedDate": "2020-02-14T20:07:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyOTIxNw==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379629217", "bodyText": "There might be something weird with having an args constructor and not having a no args constructor and serialization... I don't remember.", "author": "emjburns", "createdAt": "2020-02-14T20:25:49Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/config/AmazonPubsubProperties.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws.config;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import javax.validation.Valid;\n+import javax.validation.constraints.NotEmpty;\n+import lombok.Data;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+\n+@Data\n+@ConfigurationProperties(prefix = \"pubsub.amazon\")\n+public class AmazonPubsubProperties {\n+\n+  @Valid private List<AmazonPubsubSubscription> subscriptions;\n+\n+  @Data\n+  public static class AmazonPubsubSubscription {\n+    private static final Logger log = LoggerFactory.getLogger(AmazonPubsubSubscription.class);\n+\n+    @NotEmpty private String name;\n+\n+    @NotEmpty private String topicARN;\n+\n+    @NotEmpty private String queueARN;\n+\n+    private List<String> accountIds = Collections.emptyList();\n+\n+    int visibilityTimeout = 30;\n+    int sqsMessageRetentionPeriodSeconds = 120;\n+    int waitTimeSeconds = 5;\n+    int maxNumberOfMessages = 1;\n+\n+    // TODO: why the constructors?", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0NTQ5OQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379645499", "bodyText": "i believe spring will call the no args .ctor and then set props, but not 100% sure", "author": "marchello2000", "createdAt": "2020-02-14T21:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyOTIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2MDY0MQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379660641", "bodyText": "Do we serialize these configuration properties anywhere? Spring does not need constructors for its properties.", "author": "robzienert", "createdAt": "2020-02-14T21:49:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyOTIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3ODMwNw==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379678307", "bodyText": "I think @marchello2000 is right, I tried to remove the no args constructor and then Spring got angry at me", "author": "dreynaud", "createdAt": "2020-02-14T22:45:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyOTIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgzNzExMw==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r380837113", "bodyText": "@marchello2000 's explanation matches my understanding of what Spring does under the hood.", "author": "ttomsu", "createdAt": "2020-02-18T17:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyOTIxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0MzgxNA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379643814", "bodyText": "why not init it once and store as instance var?", "author": "marchello2000", "createdAt": "2020-02-14T21:05:04Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/SNSPublisher.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws;\n+\n+import com.amazonaws.services.sns.AmazonSNS;\n+import com.amazonaws.services.sns.model.PublishRequest;\n+import com.amazonaws.services.sns.model.PublishResult;\n+import com.netflix.spectator.api.Counter;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.spinnaker.kork.aws.ARN;\n+import com.netflix.spinnaker.kork.pubsub.aws.config.AmazonPubsubProperties;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubPublisher;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubSystem;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/** One publisher for each topic */\n+public class SNSPublisher implements PubsubPublisher {\n+  private static final Logger log = LoggerFactory.getLogger(SNSPublisher.class);\n+\n+  private final AmazonSNS amazonSNS;\n+  private final AmazonPubsubProperties.AmazonPubsubSubscription subscription;\n+  private final Registry registry;\n+  private final Supplier<Boolean> isEnabled;\n+\n+  private final ARN topicARN;\n+\n+  public SNSPublisher(\n+      AmazonPubsubProperties.AmazonPubsubSubscription subscription,\n+      AmazonSNS amazonSNS,\n+      Supplier<Boolean> isEnabled,\n+      Registry registry) {\n+    this.subscription = subscription;\n+    this.amazonSNS = amazonSNS;\n+    this.isEnabled = isEnabled;\n+    this.registry = registry;\n+    this.topicARN = new ARN(subscription.getTopicARN());\n+\n+    initializeTopic();\n+  }\n+\n+  @Override\n+  public PubsubSystem getPubsubSystem() {\n+    return PubsubSystem.AMAZON;\n+  }\n+\n+  @Override\n+  public String getTopicName() {\n+    return subscription.getName();\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return getTopicName();\n+  }\n+\n+  private void initializeTopic() {\n+    PubSubUtils.ensureTopicExists(amazonSNS, topicARN, subscription);\n+  }\n+\n+  @Override\n+  public void publish(String message, Map<String, String> attributes) {\n+    publishMessage(message);\n+  }\n+\n+  public Optional<PublishResult> publishMessage(String message) {\n+    if (!isEnabled.get()) {\n+      log.warn(\"Publishing is disabled for topic {}, dropping message {}\", topicARN, message);\n+      return Optional.empty();\n+    }\n+\n+    try {\n+      PublishRequest publishRequest = new PublishRequest(topicARN.getArn(), message);\n+      PublishResult publishResponse = amazonSNS.publish(publishRequest);\n+      log.debug(\n+          \"Published message {} with id {} to topic {}\",\n+          message,\n+          publishResponse.getMessageId(),\n+          topicARN);\n+      getSuccessCounter().increment();\n+      return Optional.of(publishResponse);\n+    } catch (Exception e) {\n+      log.error(\"failed to publish message {} to topic {}\", message, topicARN, e);\n+      getErrorCounter(e).increment();\n+      return Optional.empty();\n+    }\n+  }\n+\n+  private Counter getSuccessCounter() {\n+    return registry.counter(\"pubsub.amazon.published\", \"name\", getName(), \"topic\", getTopicName());", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3ODUyMw==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379678523", "bodyText": "why not indeed", "author": "dreynaud", "createdAt": "2020-02-14T22:46:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0MzgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0NDYyNQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379644625", "bodyText": "personally, i prefer something like this:\nhttps://github.com/spinnaker/orca/pull/3430/files#diff-9c5eb62982a1c7e4a37c3f0b83973543R96\nand\nhttps://github.com/spinnaker/orca/pull/3430/files#diff-541df92cd9036d3155fe9bf54405fac3R23\nbut... don't feel strongly but slight less work on every invocation", "author": "marchello2000", "createdAt": "2020-02-14T21:07:24Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/SNSPublisher.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws;\n+\n+import com.amazonaws.services.sns.AmazonSNS;\n+import com.amazonaws.services.sns.model.PublishRequest;\n+import com.amazonaws.services.sns.model.PublishResult;\n+import com.netflix.spectator.api.Counter;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.spinnaker.kork.aws.ARN;\n+import com.netflix.spinnaker.kork.pubsub.aws.config.AmazonPubsubProperties;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubPublisher;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubSystem;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/** One publisher for each topic */\n+public class SNSPublisher implements PubsubPublisher {\n+  private static final Logger log = LoggerFactory.getLogger(SNSPublisher.class);\n+\n+  private final AmazonSNS amazonSNS;\n+  private final AmazonPubsubProperties.AmazonPubsubSubscription subscription;\n+  private final Registry registry;\n+  private final Supplier<Boolean> isEnabled;\n+\n+  private final ARN topicARN;\n+\n+  public SNSPublisher(\n+      AmazonPubsubProperties.AmazonPubsubSubscription subscription,\n+      AmazonSNS amazonSNS,\n+      Supplier<Boolean> isEnabled,\n+      Registry registry) {\n+    this.subscription = subscription;\n+    this.amazonSNS = amazonSNS;\n+    this.isEnabled = isEnabled;\n+    this.registry = registry;\n+    this.topicARN = new ARN(subscription.getTopicARN());\n+\n+    initializeTopic();\n+  }\n+\n+  @Override\n+  public PubsubSystem getPubsubSystem() {\n+    return PubsubSystem.AMAZON;\n+  }\n+\n+  @Override\n+  public String getTopicName() {\n+    return subscription.getName();\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return getTopicName();\n+  }\n+\n+  private void initializeTopic() {\n+    PubSubUtils.ensureTopicExists(amazonSNS, topicARN, subscription);\n+  }\n+\n+  @Override\n+  public void publish(String message, Map<String, String> attributes) {\n+    publishMessage(message);\n+  }\n+\n+  public Optional<PublishResult> publishMessage(String message) {\n+    if (!isEnabled.get()) {\n+      log.warn(\"Publishing is disabled for topic {}, dropping message {}\", topicARN, message);\n+      return Optional.empty();\n+    }\n+\n+    try {\n+      PublishRequest publishRequest = new PublishRequest(topicARN.getArn(), message);\n+      PublishResult publishResponse = amazonSNS.publish(publishRequest);\n+      log.debug(\n+          \"Published message {} with id {} to topic {}\",\n+          message,\n+          publishResponse.getMessageId(),\n+          topicARN);\n+      getSuccessCounter().increment();\n+      return Optional.of(publishResponse);\n+    } catch (Exception e) {\n+      log.error(\"failed to publish message {} to topic {}\", message, topicARN, e);\n+      getErrorCounter(e).increment();\n+      return Optional.empty();\n+    }\n+  }\n+\n+  private Counter getSuccessCounter() {\n+    return registry.counter(\"pubsub.amazon.published\", \"name\", getName(), \"topic\", getTopicName());\n+  }\n+\n+  private Counter getErrorCounter(Exception e) {\n+    return registry.counter(", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4MDkwNA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379680904", "bodyText": "noted, thanks", "author": "dreynaud", "createdAt": "2020-02-14T22:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0NDYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1ODIyNA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379658224", "bodyText": "We should probably stay consistent in OSS on calling Eureka, Eureka rather than also calling it Discovery.", "author": "robzienert", "createdAt": "2020-02-14T21:42:33Z", "path": "kork-core/src/main/java/com/netflix/spinnaker/kork/eureka/EurekaActivated.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.eureka;\n+\n+import com.netflix.appinfo.InstanceInfo;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.ApplicationListener;\n+\n+/**\n+ * A component that starts doing something when the instance is up in discovery and stops doing that\n+ * thing when it goes down.", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4Mjg4Mg==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379682882", "bodyText": "Trying to remember what this is... It's a copy from DiscoveryActivated in echo, I renamed it EurekaActivated for OSS consistency but forgot the javadoc. Good catch!", "author": "dreynaud", "createdAt": "2020-02-14T23:04:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1ODIyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1OTUzNw==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379659537", "bodyText": "I feel like this should throw an exception, or at minimum log an error. If you've gone the distance of setting up configuration to the point that @ConditionalOnExpression(\"${pubsub.enabled:false} && ${pubsub.amazon.enabled:false}\") evaluates true, I would think the application is misconfigured and should not silently fail to do what it's supposedly enabled to do.", "author": "robzienert", "createdAt": "2020-02-14T21:46:07Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/SQSSubscriberProvider.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws;\n+\n+import com.amazonaws.ClientConfiguration;\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+import com.amazonaws.services.sns.AmazonSNSClientBuilder;\n+import com.amazonaws.services.sqs.AmazonSQSClientBuilder;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.spinnaker.kork.aws.ARN;\n+import com.netflix.spinnaker.kork.eureka.EurekaActivated;\n+import com.netflix.spinnaker.kork.pubsub.PubsubSubscribers;\n+import com.netflix.spinnaker.kork.pubsub.aws.api.AmazonPubsubMessageHandlerFactory;\n+import com.netflix.spinnaker.kork.pubsub.aws.config.AmazonPubsubProperties;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubSubscriber;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.RejectedExecutionException;\n+import javax.annotation.PostConstruct;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnExpression;\n+import org.springframework.stereotype.Component;\n+\n+/** * Starts the individual SQS workers (one for each subscription) */\n+@Component\n+@ConditionalOnExpression(\"${pubsub.enabled:false} && ${pubsub.amazon.enabled:false}\")\n+public class SQSSubscriberProvider implements EurekaActivated {\n+  private static final Logger log = LoggerFactory.getLogger(SQSSubscriberProvider.class);\n+\n+  private final AWSCredentialsProvider awsCredentialsProvider;\n+  private final AmazonPubsubProperties properties;\n+  private final PubsubSubscribers pubsubSubscribers;\n+  private final AmazonPubsubMessageHandlerFactory pubsubMessageHandlerFactory;\n+  private final Registry registry;\n+\n+  @Autowired\n+  public SQSSubscriberProvider(\n+      AWSCredentialsProvider awsCredentialsProvider,\n+      AmazonPubsubProperties properties,\n+      PubsubSubscribers pubsubSubscribers,\n+      AmazonPubsubMessageHandlerFactory pubsubMessageHandlerFactory,\n+      Registry registry) {\n+    this.awsCredentialsProvider = awsCredentialsProvider;\n+    this.properties = properties;\n+    this.pubsubSubscribers = pubsubSubscribers;\n+    this.pubsubMessageHandlerFactory = pubsubMessageHandlerFactory;\n+    this.registry = registry;\n+  }\n+\n+  @PostConstruct\n+  public void start() {\n+    if (properties == null) {\n+      return;", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1OTYzMg==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379659632", "bodyText": "Class and method docs on interfaces.", "author": "robzienert", "createdAt": "2020-02-14T21:46:27Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/api/AmazonPubsubMessageHandler.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws.api;\n+\n+import com.amazonaws.services.sqs.model.Message;\n+\n+public interface AmazonPubsubMessageHandler {\n+  void handleMessage(Message message);", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1OTcxOA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379659718", "bodyText": "Docs on interfaces.", "author": "robzienert", "createdAt": "2020-02-14T21:46:42Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/api/AmazonPubsubMessageHandlerFactory.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws.api;\n+\n+import com.netflix.spinnaker.kork.pubsub.aws.config.AmazonPubsubProperties;\n+\n+public interface AmazonPubsubMessageHandlerFactory {\n+  AmazonPubsubMessageHandler create(AmazonPubsubProperties.AmazonPubsubSubscription subscription);", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2MDIxMw==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379660213", "bodyText": "Now that I see this, SQSSubscriberProvider has a redundant @ConditionalOnExpression annotation, and the conditional handling that its properties member is null will always evaluate to false.", "author": "robzienert", "createdAt": "2020-02-14T21:48:02Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/config/AmazonPubsubConfig.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws.config;\n+\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.spinnaker.kork.aws.bastion.BastionConfig;\n+import com.netflix.spinnaker.kork.pubsub.PubsubPublishers;\n+import com.netflix.spinnaker.kork.pubsub.PubsubSubscribers;\n+import com.netflix.spinnaker.kork.pubsub.aws.SNSPublisherProvider;\n+import com.netflix.spinnaker.kork.pubsub.aws.SQSSubscriberProvider;\n+import com.netflix.spinnaker.kork.pubsub.aws.api.AmazonPubsubMessageHandlerFactory;\n+import javax.validation.Valid;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnExpression;\n+import org.springframework.boot.context.properties.EnableConfigurationProperties;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Import;\n+\n+@Configuration\n+@ConditionalOnExpression(\"${pubsub.enabled:false} && ${pubsub.amazon.enabled:false}\")\n+@EnableConfigurationProperties(AmazonPubsubProperties.class)\n+@Import(BastionConfig.class)\n+public class AmazonPubsubConfig {\n+  @Valid @Autowired private AmazonPubsubProperties amazonPubsubProperties;", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2MDk1Nw==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379660957", "bodyText": "Docs.", "author": "robzienert", "createdAt": "2020-02-14T21:50:08Z", "path": "kork-pubsub/src/main/java/com/netflix/spinnaker/kork/pubsub/model/PubsubPublisher.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.model;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+\n+public interface PubsubPublisher {", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2MTM4OA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379661388", "bodyText": "nit: I'm not particularly stoked on using enums for things like this. It means that if anyone comes along and wants to add an extension for their own pubsub implementation, they need to make a change to core Spinnaker code before it's even possible to do so.", "author": "robzienert", "createdAt": "2020-02-14T21:51:23Z", "path": "kork-pubsub/src/main/java/com/netflix/spinnaker/kork/pubsub/model/PubsubSystem.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.model;\n+\n+public enum PubsubSystem {", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4NjkwMQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379686901", "bodyText": "ok, so straight up String then?", "author": "dreynaud", "createdAt": "2020-02-14T23:22:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2MTM4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4Njk4Mg==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379686982", "bodyText": "(for context, this is straight from echo)", "author": "dreynaud", "createdAt": "2020-02-14T23:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2MTM4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ3NTM5MA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r381475390", "bodyText": "Ya, I think String would do just fine.", "author": "robzienert", "createdAt": "2020-02-19T18:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2MTM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NTk4OA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379665988", "bodyText": "this field is static since declared on the interface - I feel like if that is the intention then there should be a single concrete EurekaActivated object in the application context that other components could have injected rather than having things extend this interface", "author": "cfieber", "createdAt": "2020-02-14T22:04:44Z", "path": "kork-core/src/main/java/com/netflix/spinnaker/kork/eureka/EurekaActivated.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.eureka;\n+\n+import com.netflix.appinfo.InstanceInfo;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.ApplicationListener;\n+\n+/**\n+ * A component that starts doing something when the instance is up in discovery and stops doing that\n+ * thing when it goes down.\n+ */\n+public interface EurekaActivated extends ApplicationListener<RemoteStatusChangedEvent> {\n+\n+  Logger log = LoggerFactory.getLogger(EurekaActivated.class);\n+\n+  AtomicBoolean enabled = new AtomicBoolean();", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NjYyMg==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379666622", "bodyText": "I think you can control constructors via some lombokery (@NoArgsConstructor and @AllArgsConstructor some of which you maybe get for free from @Data)", "author": "cfieber", "createdAt": "2020-02-14T22:06:52Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/MessageAttribute.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.Data;\n+\n+@Data\n+public class MessageAttribute {\n+\n+  @JsonProperty(\"Type\")\n+  private String attributeType;\n+\n+  @JsonProperty(\"Value\")\n+  private String attributeValue;\n+\n+  public MessageAttribute() {}", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2Njk1MQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379666951", "bodyText": "would type this if you can't get the constructors for free", "author": "cfieber", "createdAt": "2020-02-14T22:07:57Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/NotificationMessage.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import java.util.Map;\n+import lombok.Data;\n+\n+@Data\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class NotificationMessage {\n+  @JsonProperty(\"Type\")\n+  private String type;\n+\n+  @JsonProperty(\"MessageId\")\n+  private String messageId;\n+\n+  @JsonProperty(\"TopicArn\")\n+  private String topicArn;\n+\n+  @JsonProperty(\"Subject\")\n+  private String subject;\n+\n+  @JsonProperty(\"Message\")\n+  private String message;\n+\n+  @JsonProperty(\"MessageAttributes\")\n+  private Map<String, MessageAttribute> messageAttributes;\n+\n+  public NotificationMessage() {}\n+\n+  public NotificationMessage(\n+      String type,\n+      String messageId,\n+      String topicArn,\n+      String subject,\n+      String message,\n+      Map messageAttributes) {", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NzE1Ng==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379667156", "bodyText": "maybe worth some retrys around this bit", "author": "cfieber", "createdAt": "2020-02-14T22:08:35Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/PubSubUtils.java", "diffHunk": "@@ -14,26 +14,44 @@\n  * limitations under the License.\n  */\n \n-package com.netflix.spinnaker.kork.aws.pubsub;\n+package com.netflix.spinnaker.kork.pubsub.aws;\n \n import com.amazonaws.auth.policy.*;\n+import com.amazonaws.auth.policy.actions.SNSActions;\n import com.amazonaws.auth.policy.actions.SQSActions;\n import com.amazonaws.services.sns.AmazonSNS;\n+import com.amazonaws.services.sns.model.SetTopicAttributesRequest;\n import com.amazonaws.services.sqs.AmazonSQS;\n+import com.amazonaws.services.sqs.model.QueueDoesNotExistException;\n import com.netflix.spinnaker.kork.aws.ARN;\n+import com.netflix.spinnaker.kork.pubsub.aws.config.AmazonPubsubProperties.AmazonPubsubSubscription;\n import java.util.Collections;\n import java.util.HashMap;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n /** Utils for working with AWS SNS and SQS across services */\n public class PubSubUtils {\n   private static final Logger log = LoggerFactory.getLogger(PubSubUtils.class);\n \n+  private static String getQueueUrl(AmazonSQS amazonSQS, ARN queueARN) {\n+    String queueUrl;\n+    try {", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5MjgyOQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379692829", "bodyText": "done! thanks", "author": "dreynaud", "createdAt": "2020-02-14T23:47:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NzE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NzUwNA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379667504", "bodyText": "maybe worth some retries on this too - I suspect topic creation is idempotentish so probably safe to retry.", "author": "cfieber", "createdAt": "2020-02-14T22:09:47Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/PubSubUtils.java", "diffHunk": "@@ -63,4 +81,37 @@ public static Policy buildSQSPolicy(ARN queue, ARN topic) {\n \n     return new Policy(\"allow-sns-send\", Collections.singletonList(snsStatement));\n   }\n+\n+  /**\n+   * Ensure that the topic exists and has a policy granting the specified accounts permission to\n+   * publish messages to it\n+   */\n+  public static String ensureTopicExists(\n+      AmazonSNS amazonSNS, ARN topicARN, AmazonPubsubSubscription subscription) {\n+    String createdTopicARN = amazonSNS.createTopic(topicARN.getName()).getTopicArn();", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5Mjg3MQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379692871", "bodyText": "badaboom, badadone", "author": "dreynaud", "createdAt": "2020-02-14T23:47:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NzUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2Nzc4Mg==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379667782", "bodyText": "any thing we could do to safely retry in here?", "author": "cfieber", "createdAt": "2020-02-14T22:10:46Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/SNSPublisher.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws;\n+\n+import com.amazonaws.services.sns.AmazonSNS;\n+import com.amazonaws.services.sns.model.PublishRequest;\n+import com.amazonaws.services.sns.model.PublishResult;\n+import com.netflix.spectator.api.Counter;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.spinnaker.kork.aws.ARN;\n+import com.netflix.spinnaker.kork.pubsub.aws.config.AmazonPubsubProperties;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubPublisher;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubSystem;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/** One publisher for each topic */\n+public class SNSPublisher implements PubsubPublisher {\n+  private static final Logger log = LoggerFactory.getLogger(SNSPublisher.class);\n+\n+  private final AmazonSNS amazonSNS;\n+  private final AmazonPubsubProperties.AmazonPubsubSubscription subscription;\n+  private final Registry registry;\n+  private final Supplier<Boolean> isEnabled;\n+\n+  private final ARN topicARN;\n+\n+  public SNSPublisher(\n+      AmazonPubsubProperties.AmazonPubsubSubscription subscription,\n+      AmazonSNS amazonSNS,\n+      Supplier<Boolean> isEnabled,\n+      Registry registry) {\n+    this.subscription = subscription;\n+    this.amazonSNS = amazonSNS;\n+    this.isEnabled = isEnabled;\n+    this.registry = registry;\n+    this.topicARN = new ARN(subscription.getTopicARN());\n+\n+    initializeTopic();\n+  }\n+\n+  @Override\n+  public PubsubSystem getPubsubSystem() {\n+    return PubsubSystem.AMAZON;\n+  }\n+\n+  @Override\n+  public String getTopicName() {\n+    return subscription.getName();\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return getTopicName();\n+  }\n+\n+  private void initializeTopic() {\n+    PubSubUtils.ensureTopicExists(amazonSNS, topicARN, subscription);\n+  }\n+\n+  @Override\n+  public void publish(String message, Map<String, String> attributes) {\n+    publishMessage(message);\n+  }\n+\n+  public Optional<PublishResult> publishMessage(String message) {\n+    if (!isEnabled.get()) {\n+      log.warn(\"Publishing is disabled for topic {}, dropping message {}\", topicARN, message);\n+      return Optional.empty();\n+    }\n+\n+    try {\n+      PublishRequest publishRequest = new PublishRequest(topicARN.getArn(), message);\n+      PublishResult publishResponse = amazonSNS.publish(publishRequest);", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2OTc3Mg==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379669772", "bodyText": "can replace this with @ConditionalOnProperty({\"pubsub.enabled\", \"pubsub.amazon.enabled\"})", "author": "cfieber", "createdAt": "2020-02-14T22:16:56Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/SNSPublisherProvider.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws;\n+\n+import com.amazonaws.ClientConfiguration;\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+import com.amazonaws.services.sns.AmazonSNSClientBuilder;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.spinnaker.kork.aws.ARN;\n+import com.netflix.spinnaker.kork.eureka.EurekaActivated;\n+import com.netflix.spinnaker.kork.pubsub.PubsubPublishers;\n+import com.netflix.spinnaker.kork.pubsub.aws.config.AmazonPubsubProperties;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubPublisher;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.annotation.PostConstruct;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnExpression;\n+import org.springframework.stereotype.Component;\n+\n+/** Creates one SNSPublisher per subscription */\n+@Component\n+@ConditionalOnExpression(\"${pubsub.enabled:false} && ${pubsub.amazon.enabled:false}\")", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NDE0Ng==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379694146", "bodyText": "TIL I learned! \ud83d\ude4f", "author": "dreynaud", "createdAt": "2020-02-14T23:54:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2OTc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDI2Ng==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379670266", "bodyText": "might need error handling here not to break out of the while loop on an AmazonException", "author": "cfieber", "createdAt": "2020-02-14T22:18:35Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/SQSSubscriber.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws;\n+\n+import com.amazonaws.services.sns.AmazonSNS;\n+import com.amazonaws.services.sqs.AmazonSQS;\n+import com.amazonaws.services.sqs.model.Message;\n+import com.amazonaws.services.sqs.model.QueueDoesNotExistException;\n+import com.amazonaws.services.sqs.model.ReceiveMessageRequest;\n+import com.amazonaws.services.sqs.model.ReceiveMessageResult;\n+import com.netflix.spectator.api.Counter;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.spinnaker.kork.aws.ARN;\n+import com.netflix.spinnaker.kork.pubsub.aws.api.AmazonPubsubMessageHandler;\n+import com.netflix.spinnaker.kork.pubsub.aws.config.AmazonPubsubProperties;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubSubscriber;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubSystem;\n+import java.util.function.Supplier;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * One subscriber for each subscription. The subscriber makes sure the SQS queue is created,\n+ * subscribes to the SNS topic, polls the queue for messages, and removes them once processed.\n+ */\n+public class SQSSubscriber implements Runnable, PubsubSubscriber {\n+  private static final Logger log = LoggerFactory.getLogger(SQSSubscriber.class);\n+  private static final PubsubSystem pubsubSystem = PubsubSystem.AMAZON;\n+\n+  private final AmazonSNS amazonSNS;\n+  private final AmazonSQS amazonSQS;\n+  private final AmazonPubsubProperties.AmazonPubsubSubscription subscription;\n+  private final AmazonPubsubMessageHandler messageHandler;\n+  private final Registry registry;\n+  private final Supplier<Boolean> isEnabled;\n+\n+  private final ARN queueARN;\n+  private final ARN topicARN;\n+  private String queueUrl;\n+\n+  public SQSSubscriber(\n+      AmazonPubsubProperties.AmazonPubsubSubscription subscription,\n+      AmazonPubsubMessageHandler messageHandler,\n+      AmazonSNS amazonSNS,\n+      AmazonSQS amazonSQS,\n+      Supplier<Boolean> isEnabled,\n+      Registry registry) {\n+    this.subscription = subscription;\n+    this.messageHandler = messageHandler;\n+    this.amazonSNS = amazonSNS;\n+    this.amazonSQS = amazonSQS;\n+    this.isEnabled = isEnabled;\n+    this.registry = registry;\n+\n+    this.queueARN = new ARN(subscription.getQueueARN());\n+    this.topicARN = new ARN(subscription.getTopicARN());\n+  }\n+\n+  public String getWorkerName() {\n+    return queueARN.getArn() + \"/\" + SQSSubscriber.class.getSimpleName();\n+  }\n+\n+  @Override\n+  public PubsubSystem getPubsubSystem() {\n+    return pubsubSystem;\n+  }\n+\n+  @Override\n+  public String getSubscriptionName() {\n+    return subscription.getName();\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return getSubscriptionName();\n+  }\n+\n+  @Override\n+  public void run() {\n+    log.info(\"Starting {}\", getWorkerName());\n+    try {\n+      initializeQueue();\n+    } catch (Exception e) {\n+      log.error(\"Error initializing queue {}\", queueARN, e);\n+      throw e;\n+    }\n+\n+    while (true) {\n+      try {\n+        listenForMessages();\n+      } catch (QueueDoesNotExistException e) {\n+        log.warn(\"Queue {} does not exist, recreating\", queueARN, e);\n+        initializeQueue();\n+      } catch (Exception e) {\n+        log.error(\"Unexpected error running {}, restarting worker\", getWorkerName(), e);\n+        try {\n+          Thread.sleep(500);\n+        } catch (InterruptedException e1) {\n+          log.error(\"Thread {} interrupted while sleeping\", getWorkerName(), e1);\n+        }\n+      }\n+    }\n+  }\n+\n+  private void initializeQueue() {\n+    this.queueUrl =\n+        PubSubUtils.ensureQueueExists(\n+            amazonSQS, queueARN, topicARN, subscription.getSqsMessageRetentionPeriodSeconds());\n+    PubSubUtils.subscribeToTopic(amazonSNS, topicARN, queueARN);\n+  }\n+\n+  private void listenForMessages() {\n+    while (isEnabled.get()) {\n+      ReceiveMessageResult receiveMessageResult =", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MTg3OQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379671879", "bodyText": "other thing here is that SQS can deliver the same message twice (in a short-ish span of time) - do we want to do anything here to try to prevent processing the same message twice in a cluster (shared datasource in which to try and dibs the specific message for example)", "author": "cfieber", "createdAt": "2020-02-14T22:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4MjQ1OQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379682459", "bodyText": "There's another bit of the echo pubsub bits that do this here", "author": "emjburns", "createdAt": "2020-02-14T23:02:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NDYzNQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379694635", "bodyText": "I was thinking it's kind of up to the app to handles duplicates \ud83e\udd37\u200d\u2642 Or at least document it for now, and see later if we want to have duplicate support in kork", "author": "dreynaud", "createdAt": "2020-02-14T23:56:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NTE0NA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379695144", "bodyText": "re: exception handling, there is a catch (Exception e) around the call to listenForMessages() which should work", "author": "dreynaud", "createdAt": "2020-02-14T23:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg0NzExNA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r380847114", "bodyText": "@dreynaud I think duplicate notifications should be part of the kork support. It feels weird that the duplicate support is already part of the echo support, but you wouldn't port it over. It seems like a really helpful feature that would be tricky to implement again and again.", "author": "emjburns", "createdAt": "2020-02-18T18:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ3NjE5MA==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r381476190", "bodyText": "I'd agree with @emjburns that duplicates should be handled by kork. Perhaps this could be done via an interface & default implementation that services can override if they need to, but I don't suspect it would be overridden often.", "author": "robzienert", "createdAt": "2020-02-19T18:53:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDI2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MTI1Nw==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379671257", "bodyText": "is it the messageHandler's job to mark the message as handled successfully?\nwould it make sense to put that responsibility in here, and then maybe on error we could know that we could return the message to the queue with a failure status and eventually it can get DLQ'd (otherwise it won't redrive until its visiblity timeout expires - maybe a longer backoff than we want)", "author": "cfieber", "createdAt": "2020-02-14T22:21:44Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/SQSSubscriber.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws;\n+\n+import com.amazonaws.services.sns.AmazonSNS;\n+import com.amazonaws.services.sqs.AmazonSQS;\n+import com.amazonaws.services.sqs.model.Message;\n+import com.amazonaws.services.sqs.model.QueueDoesNotExistException;\n+import com.amazonaws.services.sqs.model.ReceiveMessageRequest;\n+import com.amazonaws.services.sqs.model.ReceiveMessageResult;\n+import com.netflix.spectator.api.Counter;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.spinnaker.kork.aws.ARN;\n+import com.netflix.spinnaker.kork.pubsub.aws.api.AmazonPubsubMessageHandler;\n+import com.netflix.spinnaker.kork.pubsub.aws.config.AmazonPubsubProperties;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubSubscriber;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubSystem;\n+import java.util.function.Supplier;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * One subscriber for each subscription. The subscriber makes sure the SQS queue is created,\n+ * subscribes to the SNS topic, polls the queue for messages, and removes them once processed.\n+ */\n+public class SQSSubscriber implements Runnable, PubsubSubscriber {\n+  private static final Logger log = LoggerFactory.getLogger(SQSSubscriber.class);\n+  private static final PubsubSystem pubsubSystem = PubsubSystem.AMAZON;\n+\n+  private final AmazonSNS amazonSNS;\n+  private final AmazonSQS amazonSQS;\n+  private final AmazonPubsubProperties.AmazonPubsubSubscription subscription;\n+  private final AmazonPubsubMessageHandler messageHandler;\n+  private final Registry registry;\n+  private final Supplier<Boolean> isEnabled;\n+\n+  private final ARN queueARN;\n+  private final ARN topicARN;\n+  private String queueUrl;\n+\n+  public SQSSubscriber(\n+      AmazonPubsubProperties.AmazonPubsubSubscription subscription,\n+      AmazonPubsubMessageHandler messageHandler,\n+      AmazonSNS amazonSNS,\n+      AmazonSQS amazonSQS,\n+      Supplier<Boolean> isEnabled,\n+      Registry registry) {\n+    this.subscription = subscription;\n+    this.messageHandler = messageHandler;\n+    this.amazonSNS = amazonSNS;\n+    this.amazonSQS = amazonSQS;\n+    this.isEnabled = isEnabled;\n+    this.registry = registry;\n+\n+    this.queueARN = new ARN(subscription.getQueueARN());\n+    this.topicARN = new ARN(subscription.getTopicARN());\n+  }\n+\n+  public String getWorkerName() {\n+    return queueARN.getArn() + \"/\" + SQSSubscriber.class.getSimpleName();\n+  }\n+\n+  @Override\n+  public PubsubSystem getPubsubSystem() {\n+    return pubsubSystem;\n+  }\n+\n+  @Override\n+  public String getSubscriptionName() {\n+    return subscription.getName();\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return getSubscriptionName();\n+  }\n+\n+  @Override\n+  public void run() {\n+    log.info(\"Starting {}\", getWorkerName());\n+    try {\n+      initializeQueue();\n+    } catch (Exception e) {\n+      log.error(\"Error initializing queue {}\", queueARN, e);\n+      throw e;\n+    }\n+\n+    while (true) {\n+      try {\n+        listenForMessages();\n+      } catch (QueueDoesNotExistException e) {\n+        log.warn(\"Queue {} does not exist, recreating\", queueARN, e);\n+        initializeQueue();\n+      } catch (Exception e) {\n+        log.error(\"Unexpected error running {}, restarting worker\", getWorkerName(), e);\n+        try {\n+          Thread.sleep(500);\n+        } catch (InterruptedException e1) {\n+          log.error(\"Thread {} interrupted while sleeping\", getWorkerName(), e1);\n+        }\n+      }\n+    }\n+  }\n+\n+  private void initializeQueue() {\n+    this.queueUrl =\n+        PubSubUtils.ensureQueueExists(\n+            amazonSQS, queueARN, topicARN, subscription.getSqsMessageRetentionPeriodSeconds());\n+    PubSubUtils.subscribeToTopic(amazonSNS, topicARN, queueARN);\n+  }\n+\n+  private void listenForMessages() {\n+    while (isEnabled.get()) {\n+      ReceiveMessageResult receiveMessageResult =\n+          amazonSQS.receiveMessage(\n+              new ReceiveMessageRequest(this.queueUrl)\n+                  .withMaxNumberOfMessages(subscription.getMaxNumberOfMessages())\n+                  .withVisibilityTimeout(subscription.getVisibilityTimeout())\n+                  .withWaitTimeSeconds(subscription.getWaitTimeSeconds())\n+                  .withMessageAttributeNames(\"All\"));\n+\n+      if (receiveMessageResult.getMessages().isEmpty()) {\n+        log.debug(\"Received no messages for queue {}\", queueARN);\n+        continue;\n+      }\n+\n+      receiveMessageResult.getMessages().forEach(this::handleMessage);\n+    }\n+  }\n+\n+  private void handleMessage(Message message) {\n+    try {\n+      messageHandler.handleMessage(message);", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NTcyNQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379695725", "bodyText": "good point, I haven't dealt with message acknowledgement yet", "author": "dreynaud", "createdAt": "2020-02-15T00:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MTI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MjA0MQ==", "url": "https://github.com/spinnaker/kork/pull/516#discussion_r379672041", "bodyText": "same on the collapsing this to a @ConditionalOnProperty", "author": "cfieber", "createdAt": "2020-02-14T22:24:06Z", "path": "kork-pubsub-aws/src/main/java/com/netflix/spinnaker/kork/pubsub/aws/SQSSubscriberProvider.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.pubsub.aws;\n+\n+import com.amazonaws.ClientConfiguration;\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+import com.amazonaws.services.sns.AmazonSNSClientBuilder;\n+import com.amazonaws.services.sqs.AmazonSQSClientBuilder;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.spinnaker.kork.aws.ARN;\n+import com.netflix.spinnaker.kork.eureka.EurekaActivated;\n+import com.netflix.spinnaker.kork.pubsub.PubsubSubscribers;\n+import com.netflix.spinnaker.kork.pubsub.aws.api.AmazonPubsubMessageHandlerFactory;\n+import com.netflix.spinnaker.kork.pubsub.aws.config.AmazonPubsubProperties;\n+import com.netflix.spinnaker.kork.pubsub.model.PubsubSubscriber;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.RejectedExecutionException;\n+import javax.annotation.PostConstruct;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnExpression;\n+import org.springframework.stereotype.Component;\n+\n+/** * Starts the individual SQS workers (one for each subscription) */\n+@Component\n+@ConditionalOnExpression(\"${pubsub.enabled:false} && ${pubsub.amazon.enabled:false}\")", "originalCommit": "72306a07693af35fc8dd1f75732461008230f798", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3dbc7315885afb8b4e99994a771eb1fc0d99c5fb", "url": "https://github.com/spinnaker/kork/commit/3dbc7315885afb8b4e99994a771eb1fc0d99c5fb", "message": "chore(pubsub): retry support, docs and cleanups\n\n- add retry support in a few places where it makes sense\n- replace the PubsubSystem enum with a String\n- lombokify unnecessary constructors\n- document interfaces\n- replace a handful of @ConditionalOnExpression with @ConditionalOnProperty", "committedDate": "2020-02-15T01:31:59Z", "type": "commit"}, {"oid": "51dc54db6bb2442b342d12e47d6d4d2164942237", "url": "https://github.com/spinnaker/kork/commit/51dc54db6bb2442b342d12e47d6d4d2164942237", "message": "feat(pubsub): check dynamic config for enabled flag\n\nAlso address an issue where EurekaActivated was an interface with a static enabled flag.\n\nInstead, let's replace it with single EurekaStatusListener bean that can be injected, per cfieber's recommendation.", "committedDate": "2020-02-18T21:28:32Z", "type": "commit"}, {"oid": "755c00e10351811b9c750974035b64c455f89ebc", "url": "https://github.com/spinnaker/kork/commit/755c00e10351811b9c750974035b64c455f89ebc", "message": "test(pubsub): add serde test for NotificationMessage", "committedDate": "2020-02-18T22:08:23Z", "type": "commit"}, {"oid": "3b9e18a5486e5f1d82337569f31b9dc0ed780663", "url": "https://github.com/spinnaker/kork/commit/3b9e18a5486e5f1d82337569f31b9dc0ed780663", "message": "feat(pubsub): add message acknowledger interface\n\n+ default implementation for SQS that deletes messages and records metrics\n+ default config, conditional on missing bean so that it can be customized\n+ test that we either ack or nack based on the message handler throwing", "committedDate": "2020-02-19T01:43:39Z", "type": "commit"}, {"oid": "9575cd37e8a7860877bf90d8bca48c11088f203a", "url": "https://github.com/spinnaker/kork/commit/9575cd37e8a7860877bf90d8bca48c11088f203a", "message": "feat(pubsub): add a per-subscription toggle", "committedDate": "2020-02-20T01:43:26Z", "type": "commit"}, {"oid": "c29674c46af8c631043777f43d7940455b019911", "url": "https://github.com/spinnaker/kork/commit/c29674c46af8c631043777f43d7940455b019911", "message": "docs(pubsub): add a README file for kork-pubsub", "committedDate": "2020-02-20T01:44:07Z", "type": "commit"}, {"oid": "480870aaf7b4414c044d3687fd13f8697175f194", "url": "https://github.com/spinnaker/kork/commit/480870aaf7b4414c044d3687fd13f8697175f194", "message": "Merge branch 'master' into pubsub-squashed", "committedDate": "2020-02-20T17:28:42Z", "type": "commit"}]}