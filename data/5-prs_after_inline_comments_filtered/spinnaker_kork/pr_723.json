{"pr_number": 723, "pr_title": "feat(plugins): added the SpringLoaderPlugin", "pr_createdAt": "2020-07-13T21:43:03Z", "pr_url": "https://github.com/spinnaker/kork/pull/723", "timeline": [{"oid": "7f4f6ba6f5680cf1f0ebc3a24a9dde4813ce3b1e", "url": "https://github.com/spinnaker/kork/commit/7f4f6ba6f5680cf1f0ebc3a24a9dde4813ce3b1e", "message": "feat(plugins): added the SpringLoaderPlugin\n\nIt allows the use of package scanning and Spring Configurations.\nThe ExposeToApp annotation promotes beans to the application context.\nThis is a plugin written using SpringLoaderPlugin: https://github.com/spinnaker-plugin-examples/springExamplePlugin/pull/4", "committedDate": "2020-07-13T21:37:50Z", "type": "commit"}, {"oid": "5e7a3f0c03237d727ffc151c225a5ddba0ef6933", "url": "https://github.com/spinnaker/kork/commit/5e7a3f0c03237d727ffc151c225a5ddba0ef6933", "message": "Merge branch 'master' into addSpringLoaderPlugin", "committedDate": "2020-07-14T17:40:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA4Ng==", "url": "https://github.com/spinnaker/kork/pull/723#discussion_r455411086", "bodyText": "Does this actually work with multiple plugins? Line 59, we register the SpringLoader bean but the next plugin will also try to do the same. Even in the event that it works, I imagine it wouldn't wait for the package scan of all loaders. Should we instead just register the bean with a unique name (e.g. this.getClass().getName())", "author": "ncknt", "createdAt": "2020-07-15T22:55:29Z", "path": "kork-plugins-spring-api/src/main/java/com/netflix/spinnaker/kork/plugins/api/spring/SpringLoaderPlugin.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 Armory, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.api.spring;\n+\n+import com.netflix.spinnaker.kork.annotations.Alpha;\n+import java.util.Collections;\n+import java.util.List;\n+import org.pf4j.PluginWrapper;\n+import org.springframework.beans.factory.config.AutowireCapableBeanFactory;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.beans.factory.support.BeanDefinitionBuilder;\n+import org.springframework.beans.factory.support.BeanDefinitionRegistry;\n+import org.springframework.context.annotation.AnnotationConfigApplicationContext;\n+\n+/** Allows a plugin to scan packages for beans and load Spring Configurations. */\n+@Alpha\n+public abstract class SpringLoaderPlugin extends PrivilegedSpringPlugin {\n+\n+  protected AnnotationConfigApplicationContext pluginContext =\n+      new AnnotationConfigApplicationContext();\n+\n+  /**\n+   * Constructor to be used by plugin manager for plugin instantiation. Your plugins have to provide\n+   * constructor with this exact signature to be successfully loaded by manager.\n+   *\n+   * @param wrapper\n+   */\n+  public SpringLoaderPlugin(PluginWrapper wrapper) {\n+    super(wrapper);\n+  }\n+\n+  @Override\n+  public void registerBeanDefinitions(BeanDefinitionRegistry registry) {\n+    ClassLoader pluginClassLoader = getClass().getClassLoader();\n+    BeanDefinition springLoaderBeanDefinition =\n+        BeanDefinitionBuilder.genericBeanDefinition(SpringLoader.class)\n+            .setScope(BeanDefinition.SCOPE_SINGLETON)\n+            .setAutowireMode(AutowireCapableBeanFactory.AUTOWIRE_NO)\n+            .addConstructorArgValue(pluginContext)\n+            .addConstructorArgValue(pluginClassLoader)\n+            .addConstructorArgValue(getPackagesToScan())\n+            .addConstructorArgValue(getClassesToRegister())\n+            .getBeanDefinition();\n+    try {\n+      registerBean(springLoaderBeanDefinition, registry);\n+    } catch (ClassNotFoundException e) {\n+      throw new IllegalStateException(e);\n+    }\n+\n+    // delay controller mapping until after the plugin has a chance to load its own controllers\n+    registry\n+        .getBeanDefinition(\"requestMappingHandlerMapping\")\n+        .setDependsOn(\"com.netflix.spinnaker.kork.plugins.api.spring.SpringLoader\");", "originalCommit": "5e7a3f0c03237d727ffc151c225a5ddba0ef6933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxNDA0OQ==", "url": "https://github.com/spinnaker/kork/pull/723#discussion_r455414049", "bodyText": "Good point. I'll test this. I should probably differientiat based on the plugin.", "author": "claymccoy", "createdAt": "2020-07-15T23:04:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4MjU5Mg==", "url": "https://github.com/spinnaker/kork/pull/723#discussion_r455882592", "bodyText": "@ncknt I added a new commit that fixes this and tested with mulitple plugins.", "author": "claymccoy", "createdAt": "2020-07-16T15:39:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzNzI5Ng==", "url": "https://github.com/spinnaker/kork/pull/723#discussion_r455537296", "bodyText": "Do you see a use for a standalone PrivilegedSpringPlugin or should this be consolidated into one class?", "author": "jonsie", "createdAt": "2020-07-16T06:26:41Z", "path": "kork-plugins-spring-api/src/main/java/com/netflix/spinnaker/kork/plugins/api/spring/SpringLoaderPlugin.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 Armory, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.api.spring;\n+\n+import com.netflix.spinnaker.kork.annotations.Alpha;\n+import java.util.Collections;\n+import java.util.List;\n+import org.pf4j.PluginWrapper;\n+import org.springframework.beans.factory.config.AutowireCapableBeanFactory;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.beans.factory.support.BeanDefinitionBuilder;\n+import org.springframework.beans.factory.support.BeanDefinitionRegistry;\n+import org.springframework.context.annotation.AnnotationConfigApplicationContext;\n+\n+/** Allows a plugin to scan packages for beans and load Spring Configurations. */\n+@Alpha\n+public abstract class SpringLoaderPlugin extends PrivilegedSpringPlugin {", "originalCommit": "5e7a3f0c03237d727ffc151c225a5ddba0ef6933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc3OTQ2OA==", "url": "https://github.com/spinnaker/kork/pull/723#discussion_r455779468", "bodyText": "Yes, there are a few reasons that I did this.\n\nBackwards compatibility. Several of our early plugins use this and there are no changes to it.\nThis is the core functionality that registers bean definitions. SpringLoader just decorates that with some niceties. There may be different and better ways to do this. I didn't want to conflate the core functionality with the icing that may not ultimately be ideal.\n\nAt this point I kind of wish that I had put primaryBeanDefinitionFor() and registerBean() in a separate class than PrivilegedSpringPlugin.", "author": "claymccoy", "createdAt": "2020-07-16T13:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzNzI5Ng=="}], "type": "inlineReview"}, {"oid": "91e0650f5c818ae1dad06d93faa90bd91a4013ef", "url": "https://github.com/spinnaker/kork/commit/91e0650f5c818ae1dad06d93faa90bd91a4013ef", "message": "namespace SpringLoader bean name with pluginID\n\nThis allows multiple SpringLoaderPlugins to load without conflicting. Also had to beef up the dependency setting on request mapping to make sure the other plugins don't overwrite it.", "committedDate": "2020-07-16T15:38:21Z", "type": "commit"}, {"oid": "e86c13cdd41612d46768b026a6a73d526aefb2ea", "url": "https://github.com/spinnaker/kork/commit/e86c13cdd41612d46768b026a6a73d526aefb2ea", "message": "Merge branch 'master' into addSpringLoaderPlugin", "committedDate": "2020-07-16T15:38:51Z", "type": "commit"}, {"oid": "66366bebe867ac721ca586cc82c8c8fbfc5dc421", "url": "https://github.com/spinnaker/kork/commit/66366bebe867ac721ca586cc82c8c8fbfc5dc421", "message": "fix unit test", "committedDate": "2020-07-16T15:49:20Z", "type": "commit"}]}