{"pr_number": 595, "pr_title": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "pr_createdAt": "2020-04-08T03:25:19Z", "pr_url": "https://github.com/spinnaker/kork/pull/595", "timeline": [{"oid": "a1adbffc198e1218b868a6e26f3ff9e26450aaa7", "url": "https://github.com/spinnaker/kork/commit/a1adbffc198e1218b868a6e26f3ff9e26450aaa7", "message": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "committedDate": "2020-04-08T04:26:10Z", "type": "forcePushed"}, {"oid": "edcd94268ae120679098dadae0080abcaa46b7b6", "url": "https://github.com/spinnaker/kork/commit/edcd94268ae120679098dadae0080abcaa46b7b6", "message": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "committedDate": "2020-04-08T04:37:17Z", "type": "forcePushed"}, {"oid": "6082fc4ff1730b4e4f782608d9bfafd45d3490c8", "url": "https://github.com/spinnaker/kork/commit/6082fc4ff1730b4e4f782608d9bfafd45d3490c8", "message": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "committedDate": "2020-04-08T04:51:29Z", "type": "forcePushed"}, {"oid": "7ca3f30d6158495db048aff06c69f9dea416d5d3", "url": "https://github.com/spinnaker/kork/commit/7ca3f30d6158495db048aff06c69f9dea416d5d3", "message": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "committedDate": "2020-04-08T17:55:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwOTk0OA==", "url": "https://github.com/spinnaker/kork/pull/595#discussion_r405709948", "bodyText": "ManifestVersionResolver was flawed and I didn't see a good path forward to keep using it.  It assembles URLS to manifest files from the filesystem, but then it tries to match the manifest against a package (com.netflix.spinnaker.orca, for example). This works in the unit test when looking up the manifest for org.springframework.boot because the dependency comes from the local maven cache which stores deps on the filesystem according to their package (/org/springframework/boot). However, this doesn\u2019t work when running a test on a service locally and the service JAR exists at something like ~/orca/orca-web/build/libs/orca-web.jar or when running in an env wherein the JAR is at some non-package specific path.", "author": "jonsie", "createdAt": "2020-04-08T17:57:54Z", "path": "kork-core/src/main/java/com/netflix/spinnaker/kork/PlatformComponents.java", "diffHunk": "@@ -63,9 +61,9 @@ ServiceVersion serviceVersion(\n   }\n \n   @Bean\n-  @ConditionalOnMissingBean(ManifestVersionResolver.class)\n-  VersionResolver manifestVersionResolver(ManifestVersionResolver.Properties properties) {\n-    return new ManifestVersionResolver(properties.useOssVersionManifestAttribute);\n+  @ConditionalOnMissingBean(SpringPackageVersionResolver.class)\n+  VersionResolver springPackageVersionResolver(ApplicationContext applicationContext) {\n+    return new SpringPackageVersionResolver(applicationContext);", "originalCommit": "7ca3f30d6158495db048aff06c69f9dea416d5d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMDI2Ng==", "url": "https://github.com/spinnaker/kork/pull/595#discussion_r405710266", "bodyText": "We use SpringBootApplication annotation on some of our main classes, but not all.  As a follow up to this PR, I will add the annotation where necessary.", "author": "jonsie", "createdAt": "2020-04-08T17:58:27Z", "path": "kork-core/src/main/java/com/netflix/spinnaker/kork/version/SpringPackageVersionResolver.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.version;\n+\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.context.ApplicationContext;\n+\n+/**\n+ * Resolves the version by finding the Spring bean annotated with {@link\n+ * org.springframework.boot.autoconfigure.SpringBootApplication} and then determining the\n+ * Implementation-Version attribute from the package.\n+ *\n+ * <p>See {@link java.lang.Package#getImplementationVersion()}\n+ */\n+public class SpringPackageVersionResolver implements VersionResolver {\n+\n+  ApplicationContext applicationContext;\n+\n+  public SpringPackageVersionResolver(ApplicationContext applicationContext) {\n+    this.applicationContext = applicationContext;\n+  }\n+\n+  @Nullable\n+  @Override\n+  public String resolve(@Nonnull String serviceName) {\n+    Map<String, Object> annotatedBeans =\n+        applicationContext.getBeansWithAnnotation(SpringBootApplication.class);", "originalCommit": "7ca3f30d6158495db048aff06c69f9dea416d5d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4NzQ3Mg==", "url": "https://github.com/spinnaker/kork/pull/595#discussion_r406887472", "bodyText": "If more service alignment falls out of this work, I'm all for it! Do you know if there's any reason to not add that annotation to each Main?", "author": "robzienert", "createdAt": "2020-04-10T18:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMDI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5Njg0MQ==", "url": "https://github.com/spinnaker/kork/pull/595#discussion_r406896841", "bodyText": "I couldn't find a reason not to add the annotation, seems harmless.", "author": "jonsie", "createdAt": "2020-04-10T18:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMDI2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMDg0MA==", "url": "https://github.com/spinnaker/kork/pull/595#discussion_r405710840", "bodyText": "This change allows the path to the root plugins dir to be relative, so that we can easily test plugins in Spinnaker services.", "author": "jonsie", "createdAt": "2020-04-08T17:59:22Z", "path": "kork-plugins/src/main/java/com/netflix/spinnaker/config/PluginsAutoConfiguration.java", "diffHunk": "@@ -140,15 +134,24 @@ public static SpinnakerPluginManager pluginManager(\n         sdkFactories,\n         Objects.requireNonNull(\n             applicationContext.getEnvironment().getProperty(\"spring.application.name\")),\n-        Paths.get(\n-            applicationContext\n-                .getEnvironment()\n-                .getProperty(\n-                    PluginsConfigurationProperties.ROOT_PATH_CONFIG,\n-                    PluginsConfigurationProperties.DEFAULT_ROOT_PATH)),\n+        determineRootPluginPath(applicationContext),\n         pluginBundleExtractor);\n   }\n \n+  /**\n+   * If the plugins-root-path property is set, returns the absolute path to the property. Otherwise,\n+   * returns the default root path 'plugins'.\n+   */\n+  private static Path determineRootPluginPath(ApplicationContext applicationContext) {\n+    String rootPathConfig =\n+        applicationContext\n+            .getEnvironment()\n+            .getProperty(PluginsConfigurationProperties.ROOT_PATH_CONFIG);\n+    return rootPathConfig == null\n+        ? Paths.get(PluginsConfigurationProperties.DEFAULT_ROOT_PATH)\n+        : Paths.get(rootPathConfig).toAbsolutePath();", "originalCommit": "7ca3f30d6158495db048aff06c69f9dea416d5d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f8f3ed0f0b2482982ca11e1ddbe358f02e0101d", "url": "https://github.com/spinnaker/kork/commit/6f8f3ed0f0b2482982ca11e1ddbe358f02e0101d", "message": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "committedDate": "2020-04-08T18:02:12Z", "type": "forcePushed"}, {"oid": "e01857db9e337e1c8f9bc971e9824596818a015b", "url": "https://github.com/spinnaker/kork/commit/e01857db9e337e1c8f9bc971e9824596818a015b", "message": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "committedDate": "2020-04-08T18:13:34Z", "type": "forcePushed"}, {"oid": "0d1bce8165c8b199896f9abb81af8ffe5a548621", "url": "https://github.com/spinnaker/kork/commit/0d1bce8165c8b199896f9abb81af8ffe5a548621", "message": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "committedDate": "2020-04-09T03:33:36Z", "type": "forcePushed"}, {"oid": "d3a343935fcae7736d377fe44e7e475f6a80a26b", "url": "https://github.com/spinnaker/kork/commit/d3a343935fcae7736d377fe44e7e475f6a80a26b", "message": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "committedDate": "2020-04-11T21:52:00Z", "type": "forcePushed"}, {"oid": "7570f640a091eb98b3a8ed1cdcf27f4e658e5ab0", "url": "https://github.com/spinnaker/kork/commit/7570f640a091eb98b3a8ed1cdcf27f4e658e5ab0", "message": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "committedDate": "2020-04-11T21:58:04Z", "type": "commit"}, {"oid": "7570f640a091eb98b3a8ed1cdcf27f4e658e5ab0", "url": "https://github.com/spinnaker/kork/commit/7570f640a091eb98b3a8ed1cdcf27f4e658e5ab0", "message": "feat(plugins): Add kork-plugins-tck module to support testing plugins in services", "committedDate": "2020-04-11T21:58:04Z", "type": "forcePushed"}, {"oid": "354380d00afded21ba886699ec93e095eee403f5", "url": "https://github.com/spinnaker/kork/commit/354380d00afded21ba886699ec93e095eee403f5", "message": "Merge branch 'master' into kork-plugins-tck", "committedDate": "2020-04-11T21:59:32Z", "type": "commit"}, {"oid": "0fc0dc67c39cdfd20525ebf2a89cf29227d40cd5", "url": "https://github.com/spinnaker/kork/commit/0fc0dc67c39cdfd20525ebf2a89cf29227d40cd5", "message": "fix(tests): Add junit engines to junit platform test", "committedDate": "2020-04-11T22:05:00Z", "type": "commit"}, {"oid": "fb5fda6c6b4d1ecc86423cab24fc34a5cd5e659a", "url": "https://github.com/spinnaker/kork/commit/fb5fda6c6b4d1ecc86423cab24fc34a5cd5e659a", "message": "fix(plugins): Add runtime deps for tests", "committedDate": "2020-04-11T22:10:43Z", "type": "commit"}]}