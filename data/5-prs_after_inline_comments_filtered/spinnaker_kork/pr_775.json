{"pr_number": 775, "pr_title": "feat(credentials): Add credentials abstraction", "pr_createdAt": "2020-09-04T18:42:07Z", "pr_url": "https://github.com/spinnaker/kork/pull/775", "timeline": [{"oid": "31c0eb4795ec45f0b910b7c919467feb0f3be7b8", "url": "https://github.com/spinnaker/kork/commit/31c0eb4795ec45f0b910b7c919467feb0f3be7b8", "message": "feat(credentials): Add credential abstraction\nCredentials are held in a CredentialsRepository - one per type of credentials. They can be built from CredentialsDefinitions obtained from a CredentialsSource and parsed in a CredentialsParser.", "committedDate": "2020-09-01T23:07:25Z", "type": "commit"}, {"oid": "836d861e4e97ff2f7c7020a4ff59b7b32f493ee9", "url": "https://github.com/spinnaker/kork/commit/836d861e4e97ff2f7c7020a4ff59b7b32f493ee9", "message": "feat(credentials): Rename loader to poller\nAdd test, support optionally parallel lifecycle handlers to speed startup", "committedDate": "2020-09-04T02:41:59Z", "type": "commit"}, {"oid": "ed3bf057c618a952cae0f4e6e013e176bfb530b6", "url": "https://github.com/spinnaker/kork/commit/ed3bf057c618a952cae0f4e6e013e176bfb530b6", "message": "feat(credentials): Add credential abstraction\nCredentials are held in a CredentialsRepository - one per type of credentials. They can be built from CredentialsDefinitions obtained from a CredentialsSource and parsed in a CredentialsParser.", "committedDate": "2020-09-04T02:44:19Z", "type": "commit"}, {"oid": "c67f0e19fab361101b4d2df571b02a00c7912ca9", "url": "https://github.com/spinnaker/kork/commit/c67f0e19fab361101b4d2df571b02a00c7912ca9", "message": "feat(credentials): more tests and cleanup", "committedDate": "2020-09-04T17:59:59Z", "type": "commit"}, {"oid": "6ec1df36f5efda51d91e194043ab23235836b1ab", "url": "https://github.com/spinnaker/kork/commit/6ec1df36f5efda51d91e194043ab23235836b1ab", "message": "Merge branch 'master' into feat/kork-credentials", "committedDate": "2020-09-04T18:45:20Z", "type": "commit"}, {"oid": "bd8765a48aba79dbcc5834890ce19f75be68991f", "url": "https://github.com/spinnaker/kork/commit/bd8765a48aba79dbcc5834890ce19f75be68991f", "message": "Merge branch 'master' into feat/kork-credentials", "committedDate": "2020-09-04T20:42:28Z", "type": "commit"}, {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948", "url": "https://github.com/spinnaker/kork/commit/07bd0e32ca32915324961a6cd0c8e941f6252948", "message": "Merge branch 'master' into feat/kork-credentials", "committedDate": "2020-09-08T16:28:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMDc0OA==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485120748", "bodyText": "Could be Strings.isEmptyOrNull()?", "author": "robzienert", "createdAt": "2020-09-08T18:37:55Z", "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CompositeCredentialsRepository.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+import java.util.*;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Provides access to credentials (or extension of Credentials) across credentials types.\n+ *\n+ * @param <T>\n+ */\n+public class CompositeCredentialsRepository<T extends Credentials> {\n+  private Map<String, CredentialsRepository<? extends T>> allRepositories;\n+\n+  public CompositeCredentialsRepository(List<CredentialsRepository<? extends T>> repositories) {\n+    allRepositories = new HashMap<>();\n+    repositories.forEach(this::registerRepository);\n+  }\n+\n+  public void registerRepository(CredentialsRepository<? extends T> repository) {\n+    allRepositories.put(repository.getType(), repository);\n+  }\n+\n+  public T getCredentials(String accountName, String type) {\n+    if (accountName == null || accountName.equals(\"\")) {", "originalCommit": "07bd0e32ca32915324961a6cd0c8e941f6252948", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTQwNw==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485121407", "bodyText": "Please make use of SpinnakerException and its child exception classes, making subclasses where it makes sense.", "author": "robzienert", "createdAt": "2020-09-08T18:39:14Z", "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CompositeCredentialsRepository.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+import java.util.*;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Provides access to credentials (or extension of Credentials) across credentials types.\n+ *\n+ * @param <T>\n+ */\n+public class CompositeCredentialsRepository<T extends Credentials> {\n+  private Map<String, CredentialsRepository<? extends T>> allRepositories;\n+\n+  public CompositeCredentialsRepository(List<CredentialsRepository<? extends T>> repositories) {\n+    allRepositories = new HashMap<>();\n+    repositories.forEach(this::registerRepository);\n+  }\n+\n+  public void registerRepository(CredentialsRepository<? extends T> repository) {\n+    allRepositories.put(repository.getType(), repository);\n+  }\n+\n+  public T getCredentials(String accountName, String type) {\n+    if (accountName == null || accountName.equals(\"\")) {\n+      throw new IllegalArgumentException(\"An account name must be supplied\");\n+    }\n+\n+    CredentialsRepository<? extends T> repository = allRepositories.get(type);\n+    if (repository == null) {\n+      throw new IllegalArgumentException(\"No credentials of type '\" + type + \"' found\");", "originalCommit": "07bd0e32ca32915324961a6cd0c8e941f6252948", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0Mjg4MA==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485142880", "bodyText": "I had copied the IllegalArgumentException from https://github.com/spinnaker/clouddriver/blob/master/clouddriver-artifacts/src/main/java/com/netflix/spinnaker/clouddriver/artifacts/ArtifactCredentialsRepository.java#L49 and tried to keep the same unchecked exception for backward compatibility. Adding a new exception for that.", "author": "ncknt", "createdAt": "2020-09-08T19:19:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTc5Mw==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485121793", "bodyText": "Need docs. What's the difference between these two, what are they used for?", "author": "robzienert", "createdAt": "2020-09-08T18:39:57Z", "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/Credentials.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+/** Credentials to an external system. Each credentials has a unique name for its type. */\n+public interface Credentials {\n+\n+  String getName();\n+\n+  String getType();", "originalCommit": "07bd0e32ca32915324961a6cd0c8e941f6252948", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTk0OQ==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485121949", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Credentials have been added. This is called before credentials are available in @{@link\n          \n          \n            \n               * Credentials have been added. This is called before credentials are available in {@link", "author": "robzienert", "createdAt": "2020-09-08T18:40:19Z", "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CredentialsLifecycleHandler.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+/**\n+ * After {@link Credentials} have been parsed, they can be activated, refreshed, or retired - e.g.\n+ * adding agents. This happens before credentials are added or updated in the {@link\n+ * CredentialsRepository} and after credentials are removed from the {@link CredentialsRepository}.\n+ *\n+ * @param <T>\n+ */\n+public interface CredentialsLifecycleHandler<T extends Credentials> {\n+\n+  /**\n+   * Credentials have been added. This is called before credentials are available in @{@link", "originalCommit": "07bd0e32ca32915324961a6cd0c8e941f6252948", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMjA5MA==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485122090", "bodyText": "This change should be applied to the other areas this happens, too.", "author": "robzienert", "createdAt": "2020-09-08T18:40:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMjQxNQ==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485122415", "bodyText": "Docs on interfaces and their methods, as well as any classes that do not implement an interface and cannot inherit the docs from a parent.", "author": "robzienert", "createdAt": "2020-09-08T18:41:11Z", "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CredentialsRepository.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+import java.util.Set;\n+\n+/**\n+ * Repository of credentials of a given type\n+ *\n+ * @param <T>\n+ */\n+public interface CredentialsRepository<T extends Credentials> {\n+  T getOne(String name);\n+\n+  boolean has(String name);\n+\n+  Set<T> getAll();\n+\n+  T save(T credentials);\n+\n+  void delete(String name);\n+\n+  String getType();", "originalCommit": "07bd0e32ca32915324961a6cd0c8e941f6252948", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMzEzMA==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485123130", "bodyText": "Are we at risk of concurrent modification issues by having this just be a HashMap?", "author": "robzienert", "createdAt": "2020-09-08T18:42:32Z", "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/MapBackedCredentialsRepository.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+import java.util.*;\n+import javax.annotation.Nonnull;\n+import lombok.Getter;\n+\n+public class MapBackedCredentialsRepository<T extends Credentials>\n+    implements CredentialsRepository<T> {\n+  protected Map<String, T> credentials = new HashMap<>();", "originalCommit": "07bd0e32ca32915324961a6cd0c8e941f6252948", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE1ODcwMA==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485158700", "bodyText": "Yes, thanks!", "author": "ncknt", "createdAt": "2020-09-08T19:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMzEzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNDA4Mw==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485124083", "bodyText": "Docs would be useful here. Since the return value is void, I'm having to assume each implementor would be responsible for adding the final loaded credentials into the CredentialsRepository themselves?", "author": "robzienert", "createdAt": "2020-09-08T18:44:19Z", "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/definition/AbstractCredentialsLoader.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials.definition;\n+\n+import com.netflix.spinnaker.credentials.Credentials;\n+import com.netflix.spinnaker.credentials.CredentialsRepository;\n+import com.netflix.spinnaker.kork.annotations.NonnullByDefault;\n+import javax.annotation.PostConstruct;\n+import lombok.Getter;\n+\n+@NonnullByDefault\n+public abstract class AbstractCredentialsLoader<T extends Credentials> {\n+  @Getter protected final CredentialsRepository<T> credentialsRepository;\n+\n+  public AbstractCredentialsLoader(CredentialsRepository<T> credentialsRepository) {\n+    this.credentialsRepository = credentialsRepository;\n+  }\n+\n+  @PostConstruct\n+  public abstract void load();", "originalCommit": "07bd0e32ca32915324961a6cd0c8e941f6252948", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0NTg4Ng==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485145886", "bodyText": "I think it may be an improvement, actually, to do public Credentials load() and just handle the wiring in Poller, this would remove some boilerplate from implementations of CredentialsLoader (and wouldn't require an abstract class, which is a big win), and would improve the testability of CredentialsLoader implementations: Just assert on the response instead of mocking / verifying interactions with the CredentialsRepository.", "author": "robzienert", "createdAt": "2020-09-08T19:25:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5Mjc0NA==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485192744", "bodyText": "load() loads all credentials of a given type (e.g. all AWS accounts) in the repository. The default (BasicCredentialsLoader) implementation takes an account source (by default a getter on a Spring config object) -> passes it in a parser -> (we get a collection of Credentials) -> applies differences to the repository. It's simple to use for services using it, e.g. for k8s:\n  public AbstractCredentialsLoader<KubernetesNamedAccountCredentials> kubernetesCredentialsLoader(\n      KubernetesConfigurationProperties configurationProperties,\n      KubernetesCredentials.Factory credentialFactory,\n      CredentialsRepository<KubernetesNamedAccountCredentials> kubernetesCredentialsRepository) {\n    return new BasicCredentialsLoader<>(\n        configurationProperties::getAccounts,\n        a -> new KubernetesNamedAccountCredentials(a, credentialFactory),\n        kubernetesCredentialsRepository);\n  }\n\nThe abstract class provides room for other implementations. For example, an event based implementation can query an external system and get responses such as account X removed or new account Y added. We have one implementation like that but it's hard to make generic enough to be included here.\nThe advantage for the developer of such an implementation is that the lifecycle (e.g. add agent A and B)  and the Spinnaker internal considerations (wire these beans to create Credentials) are separate and can evolve with each release without requiring maintenance of the associated plugin.", "author": "ncknt", "createdAt": "2020-09-08T20:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2MDUxOQ==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r488160519", "bodyText": "This is helpful, thanks. I think it would be beneficial to capture this reasoning in the abstract class docs.", "author": "robzienert", "createdAt": "2020-09-14T19:10:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNDA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNDUyMA==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485124520", "bodyText": "Also curious about concurrency here.", "author": "robzienert", "createdAt": "2020-09-08T18:45:05Z", "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/definition/BasicCredentialsLoader.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials.definition;\n+\n+import com.netflix.spinnaker.credentials.Credentials;\n+import com.netflix.spinnaker.credentials.CredentialsRepository;\n+import com.netflix.spinnaker.kork.annotations.NonnullByDefault;\n+import java.util.*;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+/**\n+ * CredentialsLoader that expects the full list of credentials on each load, and updates the\n+ * credential repository on each run. It can be run once or multiple times.\n+ *\n+ * @param <T>\n+ * @param <U>\n+ */\n+@NonnullByDefault\n+public class BasicCredentialsLoader<T extends CredentialsDefinition, U extends Credentials>\n+    extends AbstractCredentialsLoader<U> {\n+  protected final CredentialsParser<T, U> parser;\n+  protected final CredentialsDefinitionSource<T> definitionSource;\n+  /**\n+   * When parallel is true, the loader may apply changes in parallel. See {@link\n+   * java.util.concurrent.ForkJoinPool} for limitations. This can be useful when adding or updating\n+   * credentials is expected to take some time, as for instance when making a network call.\n+   */\n+  @Setter @Getter protected boolean parallel;\n+  // Definition is kept so we can quickly check for changes before parsing\n+  protected final Map<String, T> loadedDefinitions = new HashMap<>();", "originalCommit": "07bd0e32ca32915324961a6cd0c8e941f6252948", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "619620f217f9b70efeb21fa36e2770d61007706e", "url": "https://github.com/spinnaker/kork/commit/619620f217f9b70efeb21fa36e2770d61007706e", "message": "feat(credentials): more tests and cleanup", "committedDate": "2020-09-08T20:38:03Z", "type": "commit"}, {"oid": "03b0dd720b0fd322ccd0f47c68d34204627db7a6", "url": "https://github.com/spinnaker/kork/commit/03b0dd720b0fd322ccd0f47c68d34204627db7a6", "message": "feat(credentials): Strings.isEmpty", "committedDate": "2020-09-08T20:43:45Z", "type": "commit"}, {"oid": "186a4658b6778c69f6034717a3e75d26a829a3dc", "url": "https://github.com/spinnaker/kork/commit/186a4658b6778c69f6034717a3e75d26a829a3dc", "message": "Merge branch 'master' into feat/kork-credentials", "committedDate": "2020-09-08T20:59:53Z", "type": "commit"}, {"oid": "f5ee2d22a3575f2b034f3d5e8b10f731234d7342", "url": "https://github.com/spinnaker/kork/commit/f5ee2d22a3575f2b034f3d5e8b10f731234d7342", "message": "feat(credentials): Add test for type check", "committedDate": "2020-09-08T21:10:41Z", "type": "commit"}, {"oid": "182d4d4015998d7cabeff611dfb9d6ed3fb2bb56", "url": "https://github.com/spinnaker/kork/commit/182d4d4015998d7cabeff611dfb9d6ed3fb2bb56", "message": "Merge branch 'master' into feat/kork-credentials", "committedDate": "2020-09-09T20:07:53Z", "type": "commit"}, {"oid": "03f8ce49ab8668a069a050d11c1ef5eb5d7ddc29", "url": "https://github.com/spinnaker/kork/commit/03f8ce49ab8668a069a050d11c1ef5eb5d7ddc29", "message": "Merge branch 'master' into feat/kork-credentials", "committedDate": "2020-09-09T22:46:08Z", "type": "commit"}, {"oid": "43b9200f7eee632bc838915619cf87713ec3795e", "url": "https://github.com/spinnaker/kork/commit/43b9200f7eee632bc838915619cf87713ec3795e", "message": "Merge branch 'master' into feat/kork-credentials", "committedDate": "2020-09-11T18:25:19Z", "type": "commit"}, {"oid": "4b94eda1cf9036ee420c95fd7518b17c3ea9e8bb", "url": "https://github.com/spinnaker/kork/commit/4b94eda1cf9036ee420c95fd7518b17c3ea9e8bb", "message": "feat(credentials): Default non nullable", "committedDate": "2020-09-11T21:09:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE1ODQ5NQ==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r488158495", "bodyText": "Would be useful to move to SpinnakerException family for all exceptions. There's a number of places in the PR that need to change beyond this one point. Also happy to explain this (or doc if I haven't) why it's beneficial to do so.", "author": "robzienert", "createdAt": "2020-09-14T19:07:14Z", "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CompositeCredentialsRepository.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+import com.netflix.spinnaker.kork.exceptions.UnknownCredentialsTypeException;\n+import java.util.*;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nullable;\n+import org.springframework.util.StringUtils;\n+\n+/**\n+ * Provides access to credentials (or extension of Credentials) across credentials types.\n+ *\n+ * @param <T>\n+ */\n+public class CompositeCredentialsRepository<T extends Credentials> {\n+  private Map<String, CredentialsRepository<? extends T>> allRepositories;\n+\n+  public CompositeCredentialsRepository(List<CredentialsRepository<? extends T>> repositories) {\n+    allRepositories = new HashMap<>();\n+    repositories.forEach(this::registerRepository);\n+  }\n+\n+  public void registerRepository(CredentialsRepository<? extends T> repository) {\n+    allRepositories.put(repository.getType(), repository);\n+  }\n+\n+  public T getCredentials(String credentialsName, String type) {\n+    if (StringUtils.isEmpty(credentialsName)) {\n+      throw new IllegalArgumentException(\"Credentials name must be supplied\");\n+    }\n+\n+    CredentialsRepository<? extends T> repository = allRepositories.get(type);\n+    if (repository == null) {\n+      throw new UnknownCredentialsTypeException(\"No credentials of type '\" + type + \"' found\");\n+    }\n+\n+    T creds = repository.getOne(credentialsName);\n+    if (creds == null) {\n+      throw new IllegalArgumentException(", "originalCommit": "4b94eda1cf9036ee420c95fd7518b17c3ea9e8bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzMTIwNQ==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r488231205", "bodyText": "Oh I thought you had +1'd the backward compatibility of raising IllegalArgumentException. I like the typed exceptions.", "author": "ncknt", "createdAt": "2020-09-14T21:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE1ODQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2MDkzNQ==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r488160935", "bodyText": "How is the interval configured? For sake of docs, I see it's done via PollerConfiguration here - even just {@link PollerConfiguration} would be valuable.", "author": "robzienert", "createdAt": "2020-09-14T19:11:31Z", "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/poller/Poller.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials.poller;\n+\n+import com.netflix.spinnaker.credentials.Credentials;\n+import com.netflix.spinnaker.credentials.definition.AbstractCredentialsLoader;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * A poller attempts to reload credentials from its source at a regular interval.", "originalCommit": "4b94eda1cf9036ee420c95fd7518b17c3ea9e8bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI0MDAyMA==", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r488240020", "bodyText": "Added comments (credentials.poller.<type of creds>.reloadFrequencyMs -> credentials.poller.default.reloadFrequencyMs) + credentials.poller.enabled.", "author": "ncknt", "createdAt": "2020-09-14T21:50:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2MDkzNQ=="}], "type": "inlineReview"}, {"oid": "3032289ffa33d9bbdbc3c91258980c4b7dfcec00", "url": "https://github.com/spinnaker/kork/commit/3032289ffa33d9bbdbc3c91258980c4b7dfcec00", "message": "Merge branch 'master' into feat/kork-credentials", "committedDate": "2020-09-14T19:21:46Z", "type": "commit"}, {"oid": "f30801dcc77adc4557521f0195ed58729ff4b53b", "url": "https://github.com/spinnaker/kork/commit/f30801dcc77adc4557521f0195ed58729ff4b53b", "message": "feat(credentials): Default non nullable", "committedDate": "2020-09-14T19:34:52Z", "type": "commit"}, {"oid": "9d3a858dd0959c16ef3865646e2a3111d0f8c9cc", "url": "https://github.com/spinnaker/kork/commit/9d3a858dd0959c16ef3865646e2a3111d0f8c9cc", "message": "feat(credentials): Move poller.enabled to kork", "committedDate": "2020-09-14T21:49:22Z", "type": "commit"}, {"oid": "42d18423e6db64c889afc591a109883eaeb010a6", "url": "https://github.com/spinnaker/kork/commit/42d18423e6db64c889afc591a109883eaeb010a6", "message": "feat(credentials): clean up dependencies", "committedDate": "2020-09-14T22:32:28Z", "type": "commit"}]}