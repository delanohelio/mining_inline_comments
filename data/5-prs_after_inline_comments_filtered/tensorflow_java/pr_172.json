{"pr_number": 172, "pr_title": "[Type Refactor] Move type implementations and mappers to internal package", "pr_createdAt": "2020-12-18T03:13:55Z", "pr_url": "https://github.com/tensorflow/java/pull/172", "timeline": [{"oid": "f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "url": "https://github.com/tensorflow/java/commit/f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "message": "Move type implementations and mappers to internal package", "committedDate": "2020-12-18T03:15:39Z", "type": "commit"}, {"oid": "f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "url": "https://github.com/tensorflow/java/commit/f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "message": "Move type implementations and mappers to internal package", "committedDate": "2020-12-18T03:15:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MDQwNA==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545550404", "bodyText": "We might want to have this in a different package as the module system operates on a package level (so when we go to 11 we could not export that package). Though it depends how the methods are used.", "author": "Craigacp", "createdAt": "2020-12-18T03:29:45Z", "path": "tensorflow-core/tensorflow-core-api/src/main/java/org/tensorflow/TensorMapper.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package org.tensorflow;\n+\n+import org.tensorflow.internal.c_api.TF_Tensor;\n+import org.tensorflow.types.family.TType;\n+\n+/**\n+ * Maps the native memory of a {@link RawTensor} to a n-dimensional typed data space\n+ * accessible from the JVM.\n+ *\n+ * <p>Usage of this class is reserved for internal purposes only.", "originalCommit": "f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0MzE3OQ==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545843179", "bodyText": "One of the goal of this abstract class is to be able to access the native handle of the raw tensor from a TensorMapper subclass, this is done via nativeTensor(RawTensor) and it needs to reside in the org.tensorflow package.\nUnless we want to make RawTensor.nativeHandle() public (which I would prefer to avoid) or go back to the previous design where both RawTensor and TF_Tensor are passed to the mapper but that triggered a series of other concerns as discussed in my previous PR.", "author": "karllessard", "createdAt": "2020-12-18T13:51:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MDQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk2NTAyNg==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545965026", "bodyText": "Ok. I definitely don't want the native handle method to be public. I feel like there is probably a way around this, but it might be more trouble than it's worth, so leaving it here is fine.", "author": "Craigacp", "createdAt": "2020-12-18T17:01:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MDQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE2NTI4Mw==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r546165283", "bodyText": "Split packages are definitely something you want to avoid at all costs. These are going to be OSGi users complaining about this as well.", "author": "saudet", "createdAt": "2020-12-19T00:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MDQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4MjAyMg==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r546182022", "bodyText": "Well we could reflectively access a private method as we'd be in the same module. But that's asking for trouble and sets a bad precedent. There's probably something we could do that's a bit tricksy with inner classes, but I can't currently see all the way through it, and again it's probably more trouble than it's worth.", "author": "Craigacp", "createdAt": "2020-12-19T03:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MDQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MTA0NA==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545551044", "bodyText": "Maybe ByteArrayProducer? ByteSequencer sounds like it can change the sequence but my reading of the iterator is that the iteration order is fixed.", "author": "Craigacp", "createdAt": "2020-12-18T03:32:13Z", "path": "tensorflow-core/tensorflow-core-api/src/main/java/org/tensorflow/internal/buffer/ByteSequencer.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.tensorflow.internal.buffer;\n+\n+import java.util.Iterator;\n+import java.util.function.Function;\n+import org.tensorflow.ndarray.NdArray;\n+import org.tensorflow.ndarray.NdArraySequence;\n+\n+/**\n+ * Produces sequence of bytes to be stored in a {@link ByteSequenceTensorBuffer}.\n+ *\n+ * @param <T> source of bytes (byte arrays or strings)\n+ */\n+public class ByteSequencer<T> implements Iterable<byte[]> {", "originalCommit": "f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NTA0Nw==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545845047", "bodyText": "Yeah, I wasn't sure about this one neither... I was hesitating between this and ByteSequenceProducer so sounds like the second choice would be a good trade off? (I prefer ByteSequence to ByteArray to preserve the symmetry with ByteSequenceTensorBuffer, or I rename the latter to ByteArrayTensorBuffer?).", "author": "karllessard", "createdAt": "2020-12-18T13:55:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MTA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk2NTgyNw==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545965827", "bodyText": "I think ByteSequenceProducer works.", "author": "Craigacp", "createdAt": "2020-12-18T17:02:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MTA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MTM2Nw==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545551367", "bodyText": "Did you mean to change the access level of mapDense here? It's protected in the super class and the other implementations.", "author": "Craigacp", "createdAt": "2020-12-18T03:33:28Z", "path": "tensorflow-core/tensorflow-core-api/src/main/java/org/tensorflow/internal/types/TBfloat16Mapper.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package org.tensorflow.internal.types;\n+\n+import org.tensorflow.TensorMapper;\n+import org.tensorflow.DataType;\n+import org.tensorflow.RawTensor;\n+import org.tensorflow.internal.buffer.TensorBuffers;\n+import org.tensorflow.ndarray.buffer.FloatDataBuffer;\n+import org.tensorflow.ndarray.buffer.layout.DataLayouts;\n+import org.tensorflow.ndarray.impl.dense.FloatDenseNdArray;\n+import org.tensorflow.types.TBfloat16;\n+\n+/**\n+ * Maps memory of {@link org.tensorflow.proto.framework.DataType#DT_BFLOAT16} tensors\n+ * to a n-dimensional data space.\n+ */\n+public class TBfloat16Mapper extends TensorMapper<TBfloat16> {\n+\n+  @Override\n+  public TBfloat16 mapDense(RawTensor tensor) {", "originalCommit": "f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NTM5OA==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545845398", "bodyText": "ah true thanks, I'll keep it protected in subclasses as well, good catch!", "author": "karllessard", "createdAt": "2020-12-18T13:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MTM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MjAxMA==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545552010", "bodyText": "Should we make this final?", "author": "Craigacp", "createdAt": "2020-12-18T03:35:48Z", "path": "tensorflow-core/tensorflow-core-api/src/main/java/org/tensorflow/internal/types/TInt64Mapper.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package org.tensorflow.internal.types;\n+\n+import org.tensorflow.DataType;\n+import org.tensorflow.RawTensor;\n+import org.tensorflow.TensorMapper;\n+import org.tensorflow.internal.buffer.TensorBuffers;\n+import org.tensorflow.ndarray.buffer.LongDataBuffer;\n+import org.tensorflow.ndarray.impl.dense.LongDenseNdArray;\n+import org.tensorflow.types.TInt64;\n+\n+/**\n+ * Maps memory of {@link org.tensorflow.proto.framework.DataType#DT_INT64} tensors\n+ * to a n-dimensional data space.\n+ */\n+public class TInt64Mapper extends TensorMapper<TInt64> {\n+\n+  @Override\n+  protected TInt64 mapDense(RawTensor tensor) {\n+    LongDataBuffer buffer = TensorBuffers.toLongs(nativeHandle(tensor));\n+    return new DenseTInt64(tensor, buffer);\n+  }\n+\n+  private static class DenseTInt64 extends LongDenseNdArray implements TInt64 {", "originalCommit": "f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NTYyOA==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545845628", "bodyText": "We should yes, thanks", "author": "karllessard", "createdAt": "2020-12-18T13:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MjAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MjA2OQ==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545552069", "bodyText": "Should these classes all be final?", "author": "Craigacp", "createdAt": "2020-12-18T03:35:58Z", "path": "tensorflow-core/tensorflow-core-api/src/main/java/org/tensorflow/internal/types/TInt64Mapper.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package org.tensorflow.internal.types;\n+\n+import org.tensorflow.DataType;\n+import org.tensorflow.RawTensor;\n+import org.tensorflow.TensorMapper;\n+import org.tensorflow.internal.buffer.TensorBuffers;\n+import org.tensorflow.ndarray.buffer.LongDataBuffer;\n+import org.tensorflow.ndarray.impl.dense.LongDenseNdArray;\n+import org.tensorflow.types.TInt64;\n+\n+/**\n+ * Maps memory of {@link org.tensorflow.proto.framework.DataType#DT_INT64} tensors\n+ * to a n-dimensional data space.\n+ */\n+public class TInt64Mapper extends TensorMapper<TInt64> {", "originalCommit": "f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MzczMg==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545553732", "bodyText": "Should we explicitly put static final on here? The NAME field is marked as such, and I spent a while looking at this line before I remembered that fields are always static and final on interfaces.", "author": "Craigacp", "createdAt": "2020-12-18T03:42:06Z", "path": "tensorflow-core/tensorflow-core-api/src/main/java/org/tensorflow/types/TBfloat16.java", "diffHunk": "@@ -54,7 +50,7 @@\n   static final String NAME = \"BFLOAT16\";\n \n   /** Type metadata */\n-  DataType<TBfloat16> DTYPE = DataType.create(NAME, 14, 2, TBfloat16Impl::mapTensor);\n+  DataType<TBfloat16> DTYPE = DataType.create(NAME, 14, 2, new TBfloat16Mapper());", "originalCommit": "f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NjI5Nw==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545846297", "bodyText": "We could but this DataType class is going to disappear in my next (and last?) PR about the tensor type refactoring so let's leave it as is for now.", "author": "karllessard", "createdAt": "2020-12-18T13:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MzczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk2NTI5OA==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545965298", "bodyText": "Sure.", "author": "Craigacp", "createdAt": "2020-12-18T17:01:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1MzczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1Mzc5Ng==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545553796", "bodyText": "static final?", "author": "Craigacp", "createdAt": "2020-12-18T03:42:24Z", "path": "tensorflow-core/tensorflow-core-api/src/main/java/org/tensorflow/types/TBool.java", "diffHunk": "@@ -45,7 +46,7 @@\n   static final String NAME = \"BOOL\";\n \n   /** Type metadata */\n-  DataType<TBool> DTYPE = DataType.create(NAME, 10, 1, TBoolImpl::mapTensor);\n+  DataType<TBool> DTYPE = DataType.create(NAME, 10, 1, new TBoolMapper());", "originalCommit": "f4b6fe3fe53421e416b5dd9f130da862f3e6ca4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NjYxMQ==", "url": "https://github.com/tensorflow/java/pull/172#discussion_r545846611", "bodyText": "Idem as here", "author": "karllessard", "createdAt": "2020-12-18T13:57:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1Mzc5Ng=="}], "type": "inlineReview"}, {"oid": "26fba687d775f81b936b525f2467d0ad881c53fe", "url": "https://github.com/tensorflow/java/commit/26fba687d775f81b936b525f2467d0ad881c53fe", "message": "Mark classes as final", "committedDate": "2020-12-18T14:10:14Z", "type": "commit"}, {"oid": "6de5ed2eaa701951db7914cc03d8b43f7093cafd", "url": "https://github.com/tensorflow/java/commit/6de5ed2eaa701951db7914cc03d8b43f7093cafd", "message": "Rename ByteSequencer to ByteSequenceProvider", "committedDate": "2020-12-18T19:11:58Z", "type": "commit"}]}