{"pr_number": 1072, "pr_title": "Macro support for format field in AbstractFileSource, AbstractFileSink", "pr_createdAt": "2020-04-07T19:58:43Z", "pr_url": "https://github.com/cdapio/hydrator-plugins/pull/1072", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzMDgyMQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r405830821", "bodyText": "are there any format properties that are required by some formats and optional for others? If so, this can run into errors", "author": "albertshau", "createdAt": "2020-04-08T21:39:00Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSink.java", "diffHunk": "@@ -64,10 +64,20 @@ public void configurePipeline(PipelineConfigurer pipelineConfigurer) {\n     // invalid\n     collector.getOrThrowException();\n \n+    if (config.containsMacro(NAME_FORMAT)) {\n+      // Deploy all format plugins. This ensures that the required plugin is available when\n+      // the format macro is evaluated in prepareRun,\n+      for (FileFormat f: FileFormat.values()) {\n+        pipelineConfigurer.usePlugin(ValidatingOutputFormat.PLUGIN_TYPE, f.name().toLowerCase(), f.name().toLowerCase(),", "originalCommit": "ec914a3cb4a276aff0411626a209abb05399648d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzOTU4OA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r406439588", "bodyText": "Thanks for pointing this out. Handled InvalidPluginConfigException as discussed offline.", "author": "rmstar", "createdAt": "2020-04-09T19:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzMDgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NjM0OA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r406866348", "bodyText": "error messages should inform the reader about the implications. Something like:\nFailed to register format '{}', which means it cannot be used when the pipeline is run. Missing properties ...", "author": "albertshau", "createdAt": "2020-04-10T17:43:26Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSink.java", "diffHunk": "@@ -64,10 +68,25 @@ public void configurePipeline(PipelineConfigurer pipelineConfigurer) {\n     // invalid\n     collector.getOrThrowException();\n \n+    if (config.containsMacro(NAME_FORMAT)) {\n+      // Deploy all format plugins. This ensures that the required plugin is available when\n+      // the format macro is evaluated in prepareRun,\n+      for (FileFormat f: FileFormat.values()) {\n+        try {\n+          pipelineConfigurer.usePlugin(ValidatingOutputFormat.PLUGIN_TYPE, f.name().toLowerCase(),\n+                                       f.name().toLowerCase(), config.getRawProperties());\n+        } catch (InvalidPluginConfigException e) {\n+          LOG.warn(\"Failed to configure {}, missing properties: {}, invalid properties: {}\",", "originalCommit": "1d8ab12865187d47c4609d7622a12a83ad967d17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2ODg4Ng==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r406868886", "bodyText": "In general, avoid this type of pattern where an exception is caught, logged, and then re-thrown. What ends up happening is that the error gets logged here and then later on by the caller, generating extra logs and confusing the user.\nInstead, you can wrap the exception with a more specific error message and propagate it up. Something like:\nthrow new IllegalArgumentException(\"...\", e);\n\nThe message should also give more information to the user about what they should do to fix the problem. This particular case can only happen when the format was a macro, otherwise it would have caused an error in configurePipeline. So a better message would be:\nFormat '{}' cannot be used because properties {} were not provided or were invalid when the pipeline was deployed. Set the format to a different value, or re-create the pipeline with all required properties.", "author": "albertshau", "createdAt": "2020-04-10T17:49:58Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSink.java", "diffHunk": "@@ -76,8 +95,15 @@ public void configurePipeline(PipelineConfigurer pipelineConfigurer) {\n   public void prepareRun(BatchSinkContext context) throws Exception {\n     FailureCollector collector = context.getFailureCollector();\n     config.validate(collector);\n-    ValidatingOutputFormat validatingOutputFormat = context.newPluginInstance(FORMAT_PLUGIN_ID);\n     FileFormat fileFormat = config.getFormat();\n+    ValidatingOutputFormat validatingOutputFormat;\n+    try {\n+      validatingOutputFormat = context.newPluginInstance(fileFormat.name().toLowerCase());\n+    } catch (InvalidPluginConfigException e) {\n+      LOG.error(\"Failed to create config for {} plugin missing properties: {} invalid properties: {}\",", "originalCommit": "1d8ab12865187d47c4609d7622a12a83ad967d17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNDY0Ng==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r407724646", "bodyText": "properties in the message should include both the missing and the invalid. Otherwise if it was from just invalid, the message will look weird.", "author": "albertshau", "createdAt": "2020-04-13T21:13:08Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSink.java", "diffHunk": "@@ -76,8 +96,17 @@ public void configurePipeline(PipelineConfigurer pipelineConfigurer) {\n   public void prepareRun(BatchSinkContext context) throws Exception {\n     FailureCollector collector = context.getFailureCollector();\n     config.validate(collector);\n-    ValidatingOutputFormat validatingOutputFormat = context.newPluginInstance(FORMAT_PLUGIN_ID);\n     FileFormat fileFormat = config.getFormat();\n+    ValidatingOutputFormat validatingOutputFormat;\n+    try {\n+      validatingOutputFormat = context.newPluginInstance(fileFormat.name().toLowerCase());\n+    } catch (InvalidPluginConfigException e) {\n+      String errorMessage = String.format(\"Format '%s' cannot be used because properties %s were not provided or \" +\n+                                          \"were invalid when the pipeline was deployed. Set the format to a \" +\n+                                          \"different value, or re-create the pipeline with all required properties.\",\n+                                          fileFormat.name(), e.getMissingProperties());", "originalCommit": "587a61e9b8905250b541ea460df2f780342c599b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc2OTUxNA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r407769514", "bodyText": "Added invalid properties in error msg.", "author": "rmstar", "createdAt": "2020-04-13T23:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNDY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNTQ3OQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r407725479", "bodyText": "we should have similar error handling here in the source if there is an error at configure or prepare time.", "author": "albertshau", "createdAt": "2020-04-13T21:14:44Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSource.java", "diffHunk": "@@ -79,11 +79,21 @@ public void configurePipeline(PipelineConfigurer pipelineConfigurer) {\n     // invalid\n     collector.getOrThrowException();\n \n+    if (config.containsMacro(NAME_FORMAT)) {\n+      // Deploy all format plugins. This ensures that the required plugin is available when\n+      // the format macro is evaluated in prepareRun,\n+      for (FileFormat f: FileFormat.values()) {\n+        pipelineConfigurer.usePlugin(ValidatingInputFormat.PLUGIN_TYPE, f.name().toLowerCase(), f.name().toLowerCase(),\n+          config.getRawProperties());\n+      }", "originalCommit": "587a61e9b8905250b541ea460df2f780342c599b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc2OTU5MQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r407769591", "bodyText": "fixed", "author": "rmstar", "createdAt": "2020-04-13T23:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNTQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNjQ0Mg==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r407726442", "bodyText": "have we tested a pipeline where all of these are macros? Have seen bugs introduced in the past where the property is assumed to not be a macro and a null pointer exception is generated at configure time.", "author": "albertshau", "createdAt": "2020-04-13T21:16:36Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSourceConfig.java", "diffHunk": "@@ -60,28 +61,33 @@\n   @Macro\n   private Long maxSplitSize;\n \n+  @Macro\n   @Nullable\n   @Description(\"Whether to allow an input that does not exist. When false, the source will fail the run if the input \"\n     + \"does not exist. When true, the run will not fail and the source will not generate any output. \"\n     + \"The default value is false.\")\n   private Boolean ignoreNonExistingFolders;\n \n+  @Macro\n   @Nullable\n   @Description(\"Whether to recursively read directories within the input directory. The default is false.\")\n   private Boolean recursive;\n \n   @Name(PATH_FIELD)\n+  @Macro\n   @Nullable\n   @Description(\"Output field to place the path of the file that the record was read from. \"\n     + \"If not specified, the file path will not be included in output records. \"\n     + \"If specified, the field must exist in the output schema as a string.\")\n   private String pathField;\n \n+  @Macro", "originalCommit": "587a61e9b8905250b541ea460df2f780342c599b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc2OTgwMg==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r407769802", "bodyText": "yes, I tested a File source -> File sink pipeline where all these fields are macros.", "author": "rmstar", "createdAt": "2020-04-13T23:06:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNjQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MTU3Mg==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r408481572", "bodyText": "e.getInvalidProperties() is a set of objects, not property names. It will not display nicely. The location of that third '%s' is also awkward, it won't be a good sentence.\nLet's remove that last %s\ninvalid %s -> invalid\nand create a union of the property names from missing properties and invalid properties.", "author": "albertshau", "createdAt": "2020-04-14T22:51:43Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSink.java", "diffHunk": "@@ -76,8 +96,17 @@ public void configurePipeline(PipelineConfigurer pipelineConfigurer) {\n   public void prepareRun(BatchSinkContext context) throws Exception {\n     FailureCollector collector = context.getFailureCollector();\n     config.validate(collector);\n-    ValidatingOutputFormat validatingOutputFormat = context.newPluginInstance(FORMAT_PLUGIN_ID);\n     FileFormat fileFormat = config.getFormat();\n+    ValidatingOutputFormat validatingOutputFormat;\n+    try {\n+      validatingOutputFormat = context.newPluginInstance(fileFormat.name().toLowerCase());\n+    } catch (InvalidPluginConfigException e) {\n+      String errorMessage = String.format(\"Format '%s' cannot be used because properties %s were not provided or \" +\n+                                          \"were invalid %s when the pipeline was deployed. Set the format to a \" +", "originalCommit": "fab1056fc6b18cccbc8556096b08e39c406791aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MjU1Nw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r408482557", "bodyText": "also, indentation here is inconsistent. Continuing a statement on the next line should be a 2 space indent, not aligned with the previous line. alignment is used when there are multiple arguments for a single method call spread out across multiple lines.\nformat(\"message '%s' \" + \n         \"wraps \",\n       arg);\n\nplease see rest of the project for examples, and update your IDE accordingly.", "author": "albertshau", "createdAt": "2020-04-14T22:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MTU3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU4NDE4Nw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r408584187", "bodyText": "fixed indentation and error msg.", "author": "rmstar", "createdAt": "2020-04-15T05:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MTU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MTc5NA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r408481794", "bodyText": "indentation should be 2 spaces not 4", "author": "albertshau", "createdAt": "2020-04-14T22:52:23Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSource.java", "diffHunk": "@@ -79,11 +83,27 @@ public void configurePipeline(PipelineConfigurer pipelineConfigurer) {\n     // invalid\n     collector.getOrThrowException();\n \n+    if (config.containsMacro(NAME_FORMAT)) {\n+      // Deploy all format plugins. This ensures that the required plugin is available when\n+      // the format macro is evaluated in prepareRun,\n+      for (FileFormat f: FileFormat.values()) {\n+        try {\n+          pipelineConfigurer.usePlugin(ValidatingInputFormat.PLUGIN_TYPE, f.name().toLowerCase(),\n+                                       f.name().toLowerCase(), config.getRawProperties());\n+        } catch (InvalidPluginConfigException e) {\n+          LOG.warn(\"Failed to register format '{}', which means it cannot be used when the pipeline is run.\" +\n+              \"Missing properties: {}, invalid properties: {}\",", "originalCommit": "fab1056fc6b18cccbc8556096b08e39c406791aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU4NDQ4OQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r408584489", "bodyText": "fixed", "author": "rmstar", "createdAt": "2020-04-15T05:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MTc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MTgzMg==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r408481832", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-04-14T22:52:30Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSource.java", "diffHunk": "@@ -99,8 +119,18 @@ public void configurePipeline(PipelineConfigurer pipelineConfigurer) {\n   public void prepareRun(BatchSourceContext context) throws Exception {\n     FailureCollector collector = context.getFailureCollector();\n     config.validate(collector);\n-    ValidatingInputFormat validatingInputFormat = context.newPluginInstance(FORMAT_PLUGIN_ID);\n     FileFormat fileFormat = config.getFormat();\n+    ValidatingInputFormat validatingInputFormat;\n+    try {\n+      validatingInputFormat = context.newPluginInstance(fileFormat.name().toLowerCase());\n+    } catch (InvalidPluginConfigException e) {\n+      String errorMessage = String.format(\"Format '%s' cannot be used because properties %s were not provided or \" +\n+          \"were invalid %s when the pipeline was deployed. Set the format to a \" +", "originalCommit": "fab1056fc6b18cccbc8556096b08e39c406791aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MjAwMA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r408482000", "bodyText": "same comment as above about the error message", "author": "albertshau", "createdAt": "2020-04-14T22:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MTgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU4NDU5OA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1072#discussion_r408584598", "bodyText": "fixed indent and error msg", "author": "rmstar", "createdAt": "2020-04-15T05:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MTgzMg=="}], "type": "inlineReview"}, {"oid": "e98874430ac2414ca41b68234754181c185c90f3", "url": "https://github.com/cdapio/hydrator-plugins/commit/e98874430ac2414ca41b68234754181c185c90f3", "message": "Add macro support for format field in AbstractFileSource, AbstractFileSink", "committedDate": "2020-04-15T20:32:24Z", "type": "commit"}, {"oid": "e98874430ac2414ca41b68234754181c185c90f3", "url": "https://github.com/cdapio/hydrator-plugins/commit/e98874430ac2414ca41b68234754181c185c90f3", "message": "Add macro support for format field in AbstractFileSource, AbstractFileSink", "committedDate": "2020-04-15T20:32:24Z", "type": "forcePushed"}]}