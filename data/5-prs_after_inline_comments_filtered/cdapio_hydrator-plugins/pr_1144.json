{"pr_number": 1144, "pr_title": "(PLUGIN-303) Add distribution to Joiner Plugin", "pr_createdAt": "2020-07-23T20:30:29Z", "pr_url": "https://github.com/cdapio/hydrator-plugins/pull/1144", "timeline": [{"oid": "a5113f89fcbfd7a36fc0e6340cbeef01325bef02", "url": "https://github.com/cdapio/hydrator-plugins/commit/a5113f89fcbfd7a36fc0e6340cbeef01325bef02", "message": "(PLUGIN-303) Add distribution to Joiner Plugin", "committedDate": "2020-07-23T20:32:43Z", "type": "forcePushed"}, {"oid": "505aa132d0ab90d110bae3b964b189dcb6b9eadd", "url": "https://github.com/cdapio/hydrator-plugins/commit/505aa132d0ab90d110bae3b964b189dcb6b9eadd", "message": "(PLUGIN-303) Add distribution to Joiner Plugin", "committedDate": "2020-07-23T21:12:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMjEyNw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461122127", "bodyText": "nit: remove the 'currently' in parentheses to shorten the message a little.", "author": "albertshau", "createdAt": "2020-07-27T19:35:31Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -144,25 +162,30 @@ public JoinDefinition define(AutoJoinerContext context) {\n   public void prepareRun(BatchJoinerContext context) {\n     if (conf.getNumPartitions() != null) {\n       context.setNumPartitions(conf.getNumPartitions());\n+      if (conf.getDistributionFactor() != null && conf.getDistributionFactor() < conf.getNumPartitions()) {\n+        LOG.warn(String.format(\n+          \"Number of partitions (currently %d) should be greater than or equal to distribution factor (currently %d) \"", "originalCommit": "0cfc6ccccb5336d3ce35b7b670b1126d8eb727f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0NDE1NA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461144154", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T20:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMjEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMjU5NA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461122594", "bodyText": "distribution. The number", "author": "albertshau", "createdAt": "2020-07-27T19:36:30Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/JoinerConfig.java", "diffHunk": "@@ -67,6 +68,15 @@\n     \" Required input stages decide the type of the join. If all the input stages are present in required inputs, \" +\n     \"inner join will be performed. Otherwise, outer join will be performed considering non-required inputs as \" +\n     \"optional.\";\n+  private static final String DISTRIBUTION_STAGE_DESC =\n+    \"Name of the skewed input stage. The skewed input stage is the one that contains many rows that join \"\n+      + \"to the same row in the non-skewed stage. Ex. If stage A has 10 rows that join on the same row in stage B, then\"\n+      + \" stage A is the skewed input stage\";\n+  private static final String DISTRIBUTION_FACTOR_DESC =\n+    \"This controls the size of the salt that will be generated for distribution, the number of partitions \"", "originalCommit": "0cfc6ccccb5336d3ce35b7b670b1126d8eb727f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0NjI4Mg==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461146282", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T20:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMjU5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMjg1MQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461122851", "bodyText": "skewed. Enabling will increase the parallelism", "author": "albertshau", "createdAt": "2020-07-27T19:36:57Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/JoinerConfig.java", "diffHunk": "@@ -104,6 +114,22 @@\n     \"and this value is false, records with a null id from input stages A and B will not get joined together.\")\n   private Boolean joinNullKeys;\n \n+  @Nullable\n+  @Macro\n+  @Description(DISTRIBUTION_FACTOR_DESC)\n+  private Integer distributionFactor;\n+\n+  @Nullable\n+  @Macro\n+  @Description(DISTRIBUTION_STAGE_DESC)\n+  private String distributionStageName;\n+\n+  @Macro\n+  @Nullable\n+  @Description(\"Distribution is useful when the input data is skewed, enabling distribution will allow you to \"", "originalCommit": "0cfc6ccccb5336d3ce35b7b670b1126d8eb727f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0NjQ2Nw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461146467", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T20:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMjg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMzYyOA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461123628", "bodyText": "if there is some error with the distribution values (ex: not an inner or left outer join), they should be handled here, with the proper property highlighted. This will require some more specific error in your other CDAP PR.", "author": "albertshau", "createdAt": "2020-07-27T19:38:31Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -113,6 +116,21 @@ public JoinDefinition define(AutoJoinerContext context) {\n       } else {\n         joinBuilder.setOutputSchemaName(\"join.output\");\n       }\n+\n+      if (conf.isDistributionEnabled()) {\n+        if (!Strings.isNullOrEmpty(conf.getDistributionStageName()) && conf.getDistributionFactor() != null) {\n+          joinBuilder.setDistributionFactor(conf.getDistributionFactor(), conf.getDistributionStageName());\n+        } else {\n+          if (conf.getDistributionFactor() == null) {\n+            collector.addFailure(\"Distribution Size is a required value if distribution is enabled.\", \"\")\n+              .withConfigProperty(\"distributionFactor\");\n+          }\n+          if (Strings.isNullOrEmpty(conf.getDistributionStageName())) {\n+            collector.addFailure(\"Skewed Stage name is a required value if distribution is enabled.\", \"\")\n+              .withConfigProperty(\"distributionStageName\");\n+          }\n+        }\n+      }\n       return joinBuilder.build();\n     } catch (InvalidJoinException e) {", "originalCommit": "0cfc6ccccb5336d3ce35b7b670b1126d8eb727f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0MzYwNw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461143607", "bodyText": "Noted", "author": "MEseifan", "createdAt": "2020-07-27T20:16:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMzYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5Mzk0Mw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461193943", "bodyText": "Added new error types and handling for error types", "author": "MEseifan", "createdAt": "2020-07-27T21:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMzYyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyNDU1Mg==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461124552", "bodyText": "there's a lot of nesting here which makes it hard to read. Can you pull this out into a separate method?", "author": "albertshau", "createdAt": "2020-07-27T19:40:27Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -113,6 +116,21 @@ public JoinDefinition define(AutoJoinerContext context) {\n       } else {\n         joinBuilder.setOutputSchemaName(\"join.output\");\n       }\n+\n+      if (conf.isDistributionEnabled()) {", "originalCommit": "0cfc6ccccb5336d3ce35b7b670b1126d8eb727f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0MzQzNw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461143437", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T20:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyNDU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMjg3Nw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461212877", "bodyText": "nit: extra newline", "author": "albertshau", "createdAt": "2020-07-27T22:45:30Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/JoinerConfig.java", "diffHunk": "@@ -238,4 +266,47 @@ boolean isNullSafe() {\n     }\n     return set;\n   }\n+\n+  @Nullable\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  @Nullable\n+  public String getDistributionStageName() {\n+    return distributionStageName;\n+  }\n+\n+  public boolean isDistributionValid(FailureCollector collector) {\n+    int startFailures = collector.getValidationFailures().size();\n+\n+    //If distribution is disabled then no need to validate further\n+    if (!containsMacro(\"distributionEnabled\") && !distributionEnabled) {\n+      return false;\n+    }\n+\n+    if (!containsMacro(DISTRIBUTION_FACTOR) && distributionFactor == null) {\n+      collector.addFailure(\"Distribution Size is a required value if distribution is enabled.\", \"\")\n+        .withConfigProperty(DISTRIBUTION_FACTOR);\n+", "originalCommit": "26a81c23076416509454e3d9575f757827e3b951", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyOTM3NQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461229375", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T23:33:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMjg3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMzAzOQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461213039", "bodyText": "nit: extra newline", "author": "albertshau", "createdAt": "2020-07-27T22:45:57Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/JoinerConfig.java", "diffHunk": "@@ -238,4 +266,47 @@ boolean isNullSafe() {\n     }\n     return set;\n   }\n+\n+  @Nullable\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  @Nullable\n+  public String getDistributionStageName() {\n+    return distributionStageName;\n+  }\n+\n+  public boolean isDistributionValid(FailureCollector collector) {\n+    int startFailures = collector.getValidationFailures().size();\n+\n+    //If distribution is disabled then no need to validate further\n+    if (!containsMacro(\"distributionEnabled\") && !distributionEnabled) {\n+      return false;\n+    }\n+\n+    if (!containsMacro(DISTRIBUTION_FACTOR) && distributionFactor == null) {\n+      collector.addFailure(\"Distribution Size is a required value if distribution is enabled.\", \"\")\n+        .withConfigProperty(DISTRIBUTION_FACTOR);\n+\n+    }\n+    if (!containsMacro(DISTRIBUTION_STAGE) && Strings.isNullOrEmpty(distributionStageName)) {\n+      collector.addFailure(\"Skewed Stage name is a required value if distribution is enabled.\", \"\")\n+        .withConfigProperty(DISTRIBUTION_STAGE);\n+    }\n+\n+    // If there are still macro values then this config is not valid\n+    if (distributionContainsMacro()) {\n+      return false;\n+    }\n+\n+    return startFailures == collector.getValidationFailures().size();\n+", "originalCommit": "26a81c23076416509454e3d9575f757827e3b951", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyOTQwMQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461229401", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T23:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMzAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMzMxMw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461213313", "bodyText": "add one case for the broadcast error", "author": "albertshau", "createdAt": "2020-07-27T22:46:43Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -134,6 +140,13 @@ public JoinDefinition define(AutoJoinerContext context) {\n           case OUTPUT_SCHEMA:\n             OutputSchemaError schemaError = (OutputSchemaError) error;\n             failure.withOutputSchemaField(schemaError.getField());\n+            break;\n+          case DISTRIBUTION_SIZE:\n+            failure.withConfigProperty(JoinerConfig.DISTRIBUTION_FACTOR);\n+            break;\n+          case DISTRIBUTION_STAGE:", "originalCommit": "26a81c23076416509454e3d9575f757827e3b951", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyOTQ5OA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461229498", "bodyText": "whoops, forgot to push my changes..its there now", "author": "MEseifan", "createdAt": "2020-07-27T23:34:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMzMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMzgzMg==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461213832", "bodyText": "this is an existing problem, but we should have a default case to make sure other types of errors (like the generic join error) are collected.", "author": "albertshau", "createdAt": "2020-07-27T22:48:19Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -134,6 +140,13 @@ public JoinDefinition define(AutoJoinerContext context) {\n           case OUTPUT_SCHEMA:\n             OutputSchemaError schemaError = (OutputSchemaError) error;\n             failure.withOutputSchemaField(schemaError.getField());\n+            break;\n+          case DISTRIBUTION_SIZE:\n+            failure.withConfigProperty(JoinerConfig.DISTRIBUTION_FACTOR);\n+            break;\n+          case DISTRIBUTION_STAGE:\n+            failure.withConfigProperty(JoinerConfig.DISTRIBUTION_STAGE);\n+            break;", "originalCommit": "26a81c23076416509454e3d9575f757827e3b951", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzMTIxMA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461231210", "bodyText": "The first line before the switch-case handles all the errors:\nValidationFailure failure = collector.addFailure(error.getMessage(), error.getCorrectiveAction());\nIts just that the errors with types get modified to target a particular property. So the generic errors are captured, they just appear at the top of the plugin instead of underneath a given property", "author": "MEseifan", "createdAt": "2020-07-27T23:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTczMDU5MQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461730591", "bodyText": "ah ok, makes sense", "author": "albertshau", "createdAt": "2020-07-28T16:55:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMzgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzMTYyNA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461431624", "bodyText": "Use please holder {} instead of String.format when using Logger.", "author": "chtyim", "createdAt": "2020-07-28T09:06:22Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -144,25 +160,30 @@ public JoinDefinition define(AutoJoinerContext context) {\n   public void prepareRun(BatchJoinerContext context) {\n     if (conf.getNumPartitions() != null) {\n       context.setNumPartitions(conf.getNumPartitions());\n+      if (conf.getDistributionFactor() != null && conf.getDistributionFactor() < conf.getNumPartitions()) {\n+        LOG.warn(String.format(\n+          \"Number of partitions (%d) should be greater than or equal to distribution factor (currently %d) \"", "originalCommit": "c6078a6abb0d786ec5eb8297b398461ac167c0fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc0NjIwMg==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1144#discussion_r461746202", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-28T17:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzMTYyNA=="}], "type": "inlineReview"}, {"oid": "d559bbd6b9b37cec2e36a6139932da239a7a8d46", "url": "https://github.com/cdapio/hydrator-plugins/commit/d559bbd6b9b37cec2e36a6139932da239a7a8d46", "message": "(PLUGIN-303) Add distribution to Joiner Plugin", "committedDate": "2020-07-28T18:15:46Z", "type": "commit"}, {"oid": "d559bbd6b9b37cec2e36a6139932da239a7a8d46", "url": "https://github.com/cdapio/hydrator-plugins/commit/d559bbd6b9b37cec2e36a6139932da239a7a8d46", "message": "(PLUGIN-303) Add distribution to Joiner Plugin", "committedDate": "2020-07-28T18:15:46Z", "type": "forcePushed"}]}