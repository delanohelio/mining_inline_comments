{"pr_number": 344, "pr_title": "Add ability to reference repeating group value from another widget", "pr_createdAt": "2020-01-21T18:05:15Z", "pr_url": "https://github.com/opensrp/opensrp-client-native-form/pull/344", "timeline": [{"oid": "e54baf2c3e24ef6c69ef6c346e4e2d665b1f62d1", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/e54baf2c3e24ef6c69ef6c346e4e2d665b1f62d1", "message": "Add ability to reference repeating group value from another widget\n\n- A repeating group can have a property reference_edit_text\nwhich will provide the value used to determine the\nnumber of repeating groups to create.\n\nThis decouples the repeating group value used from the actual\nrepeating group", "committedDate": "2020-01-21T18:04:14Z", "type": "commit"}, {"oid": "3102603f687213a712c0178a514e13d7ac54ba7c", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/3102603f687213a712c0178a514e13d7ac54ba7c", "message": "Add documentation for repeating grp remote ref & clean code", "committedDate": "2020-01-22T07:00:54Z", "type": "commit"}, {"oid": "5b03c0789f68f0d4b15d1d66dd7bd295c4f38a1e", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/5b03c0789f68f0d4b15d1d66dd7bd295c4f38a1e", "message": ":arrow-up: Increment native form library to 1.7.12-SNAPSHOT", "committedDate": "2020-01-22T07:03:36Z", "type": "commit"}, {"oid": "331554df4c5a69794fe95733e44e1c4257eb2b60", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/331554df4c5a69794fe95733e44e1c4257eb2b60", "message": "Code cleanup", "committedDate": "2020-01-22T07:47:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQxMTE5MA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/344#discussion_r369411190", "bodyText": "Might need to check the length here to avoid errors when you reference indexes that do not exist", "author": "dubdabasoduba", "createdAt": "2020-01-22T07:55:31Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -79,33 +89,79 @@\n         final MaterialEditText referenceEditText = rootLayout.findViewById(R.id.reference_edit_text);\n         final String referenceEditTextHint = jsonObject.optString(REFERENCE_EDIT_TEXT_HINT, context.getString(R.string.enter_number_of_repeating_group_items));\n         final String repeatingGroupLabel = jsonObject.optString(REPEATING_GROUP_LABEL, context.getString(R.string.repeating_group_item));\n+        String remoteReferenceEditText = jsonObject.optString(REFERENCE_EDIT_TEXT);\n+\n+        // Enables us to fetch this value from a previous edit_text & disable this one\n+        retrieveRepeatingGroupCountFromRemoteReferenceEditText((JsonApi) context, referenceEditText, remoteReferenceEditText);\n         setUpReferenceEditText(referenceEditText, referenceEditTextHint, repeatingGroupLabel);\n \n-        doneButton = rootLayout.findViewById(R.id.btn_repeating_group_done);\n-        doneButton.setOnClickListener(new View.OnClickListener() {\n-            @Override\n-            public void onClick(View v) {\n-                addOnDoneAction(referenceEditText);\n-            }\n-        });\n+        // Disable the done button if the reference edit text being used is remote & has a valid value\n+        if (isRemoteReferenceValueUsed) {\n+            doneButton.setVisibility(View.GONE);\n+        } else {\n+            doneButton.setOnClickListener(new View.OnClickListener() {\n+                @Override\n+                public void onClick(View v) {\n+                    addOnDoneAction(referenceEditText);\n+                }\n+            });\n+        }\n \n         ((JsonApi) context).addFormDataView(referenceEditText);\n \n         return views;\n     }\n \n+    private void retrieveRepeatingGroupCountFromRemoteReferenceEditText(@NonNull JsonApi context, @NonNull MaterialEditText referenceEditText, @Nullable String remoteReferenceEditTextAddress) throws JSONException {\n+        if (!TextUtils.isEmpty(remoteReferenceEditTextAddress) && remoteReferenceEditTextAddress.contains(\":\")) {\n+            String finalRemoteReferenceEditTextAddress = remoteReferenceEditTextAddress.trim();\n+            String[] addressSections = finalRemoteReferenceEditTextAddress.split(\":\");", "originalCommit": "331554df4c5a69794fe95733e44e1c4257eb2b60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQxNDE4Ng==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/344#discussion_r369414186", "bodyText": "Use StringUtils.isNotBlank it even checks for white spaces https://javakeypoint.wordpress.com/2018/01/18/stringutils-isnotempty-vs-stringutils-isnotblank/", "author": "dubdabasoduba", "createdAt": "2020-01-22T08:05:13Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -79,33 +89,79 @@\n         final MaterialEditText referenceEditText = rootLayout.findViewById(R.id.reference_edit_text);\n         final String referenceEditTextHint = jsonObject.optString(REFERENCE_EDIT_TEXT_HINT, context.getString(R.string.enter_number_of_repeating_group_items));\n         final String repeatingGroupLabel = jsonObject.optString(REPEATING_GROUP_LABEL, context.getString(R.string.repeating_group_item));\n+        String remoteReferenceEditText = jsonObject.optString(REFERENCE_EDIT_TEXT);\n+\n+        // Enables us to fetch this value from a previous edit_text & disable this one\n+        retrieveRepeatingGroupCountFromRemoteReferenceEditText((JsonApi) context, referenceEditText, remoteReferenceEditText);\n         setUpReferenceEditText(referenceEditText, referenceEditTextHint, repeatingGroupLabel);\n \n-        doneButton = rootLayout.findViewById(R.id.btn_repeating_group_done);\n-        doneButton.setOnClickListener(new View.OnClickListener() {\n-            @Override\n-            public void onClick(View v) {\n-                addOnDoneAction(referenceEditText);\n-            }\n-        });\n+        // Disable the done button if the reference edit text being used is remote & has a valid value\n+        if (isRemoteReferenceValueUsed) {\n+            doneButton.setVisibility(View.GONE);\n+        } else {\n+            doneButton.setOnClickListener(new View.OnClickListener() {\n+                @Override\n+                public void onClick(View v) {\n+                    addOnDoneAction(referenceEditText);\n+                }\n+            });\n+        }\n \n         ((JsonApi) context).addFormDataView(referenceEditText);\n \n         return views;\n     }\n \n+    private void retrieveRepeatingGroupCountFromRemoteReferenceEditText(@NonNull JsonApi context, @NonNull MaterialEditText referenceEditText, @Nullable String remoteReferenceEditTextAddress) throws JSONException {\n+        if (!TextUtils.isEmpty(remoteReferenceEditTextAddress) && remoteReferenceEditTextAddress.contains(\":\")) {\n+            String finalRemoteReferenceEditTextAddress = remoteReferenceEditTextAddress.trim();\n+            String[] addressSections = finalRemoteReferenceEditTextAddress.split(\":\");\n+            String remoteReferenceEditTextStep = addressSections[0];\n+            String remoteReferenceEditTextKey = addressSections[1];\n+            JSONObject stepJsonObject = context.getmJSONObject().optJSONObject(remoteReferenceEditTextStep);\n+\n+            if (stepJsonObject != null) {\n+                JSONArray fields = stepJsonObject.optJSONArray(FIELDS);\n+\n+                for (int i = 0; i < fields.length(); i++) {\n+                    JSONObject stepField = fields.optJSONObject(i);\n+                    if (stepField != null && stepField.has(KEY) && stepField.getString(KEY).equals(remoteReferenceEditTextKey)) {\n+                        String fieldValue = stepField.optString(VALUE);\n+\n+                        if (!TextUtils.isEmpty(fieldValue)) {", "originalCommit": "331554df4c5a69794fe95733e44e1c4257eb2b60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQxODc0OQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/344#discussion_r369418749", "bodyText": "Rename this parameter from v to something more readable", "author": "dubdabasoduba", "createdAt": "2020-01-22T08:17:58Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -79,33 +89,79 @@\n         final MaterialEditText referenceEditText = rootLayout.findViewById(R.id.reference_edit_text);\n         final String referenceEditTextHint = jsonObject.optString(REFERENCE_EDIT_TEXT_HINT, context.getString(R.string.enter_number_of_repeating_group_items));\n         final String repeatingGroupLabel = jsonObject.optString(REPEATING_GROUP_LABEL, context.getString(R.string.repeating_group_item));\n+        String remoteReferenceEditText = jsonObject.optString(REFERENCE_EDIT_TEXT);\n+\n+        // Enables us to fetch this value from a previous edit_text & disable this one\n+        retrieveRepeatingGroupCountFromRemoteReferenceEditText((JsonApi) context, referenceEditText, remoteReferenceEditText);\n         setUpReferenceEditText(referenceEditText, referenceEditTextHint, repeatingGroupLabel);\n \n-        doneButton = rootLayout.findViewById(R.id.btn_repeating_group_done);\n-        doneButton.setOnClickListener(new View.OnClickListener() {\n-            @Override\n-            public void onClick(View v) {\n-                addOnDoneAction(referenceEditText);\n-            }\n-        });\n+        // Disable the done button if the reference edit text being used is remote & has a valid value\n+        if (isRemoteReferenceValueUsed) {\n+            doneButton.setVisibility(View.GONE);\n+        } else {\n+            doneButton.setOnClickListener(new View.OnClickListener() {\n+                @Override\n+                public void onClick(View v) {\n+                    addOnDoneAction(referenceEditText);\n+                }\n+            });\n+        }\n \n         ((JsonApi) context).addFormDataView(referenceEditText);\n \n         return views;\n     }\n \n+    private void retrieveRepeatingGroupCountFromRemoteReferenceEditText(@NonNull JsonApi context, @NonNull MaterialEditText referenceEditText, @Nullable String remoteReferenceEditTextAddress) throws JSONException {\n+        if (!TextUtils.isEmpty(remoteReferenceEditTextAddress) && remoteReferenceEditTextAddress.contains(\":\")) {\n+            String finalRemoteReferenceEditTextAddress = remoteReferenceEditTextAddress.trim();\n+            String[] addressSections = finalRemoteReferenceEditTextAddress.split(\":\");\n+            String remoteReferenceEditTextStep = addressSections[0];\n+            String remoteReferenceEditTextKey = addressSections[1];\n+            JSONObject stepJsonObject = context.getmJSONObject().optJSONObject(remoteReferenceEditTextStep);\n+\n+            if (stepJsonObject != null) {\n+                JSONArray fields = stepJsonObject.optJSONArray(FIELDS);\n+\n+                for (int i = 0; i < fields.length(); i++) {\n+                    JSONObject stepField = fields.optJSONObject(i);\n+                    if (stepField != null && stepField.has(KEY) && stepField.getString(KEY).equals(remoteReferenceEditTextKey)) {\n+                        String fieldValue = stepField.optString(VALUE);\n+\n+                        if (!TextUtils.isEmpty(fieldValue)) {\n+                            try {\n+                                remoteReferenceValue = Integer.parseInt(fieldValue);\n+                                isRemoteReferenceValueUsed = true;\n+\n+                                // Start the repeating groups\n+                                attachRepeatingGroup(referenceEditText.getParent().getParent(), remoteReferenceValue);\n+                            } catch (NumberFormatException ex) {\n+                                Timber.e(ex);\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n     private void setUpReferenceEditText(final MaterialEditText referenceEditText, String referenceEditTextHint, String repeatingGroupLabel) throws JSONException {\n+        // We should disable this edit_text if another referenced edit text is being used\n         Context context = widgetArgs.getContext();\n-        referenceEditText.setOnEditorActionListener(new TextView.OnEditorActionListener() {\n-            @Override\n-            public boolean onEditorAction(TextView v, int actionId, KeyEvent event) {\n-                if (actionId == EditorInfo.IME_ACTION_DONE) {\n-                    addOnDoneAction(v);\n-                    return true;\n+        if (isRemoteReferenceValueUsed) {\n+            referenceEditText.setVisibility(View.GONE);\n+        } else {\n+            referenceEditText.setOnEditorActionListener(new TextView.OnEditorActionListener() {\n+                @Override\n+                public boolean onEditorAction(TextView v, int actionId, KeyEvent event) {", "originalCommit": "331554df4c5a69794fe95733e44e1c4257eb2b60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2453517d67edd8ffd89ac25aa2972fe74b0afbcf", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/2453517d67edd8ffd89ac25aa2972fe74b0afbcf", "message": "Code cleanup", "committedDate": "2020-01-22T08:23:11Z", "type": "forcePushed"}, {"oid": "6cef8e4601d8b877f759f68ff016cdfb8df01b35", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/6cef8e4601d8b877f759f68ff016cdfb8df01b35", "message": "Code cleanup", "committedDate": "2020-01-22T08:35:08Z", "type": "commit"}, {"oid": "6cef8e4601d8b877f759f68ff016cdfb8df01b35", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/6cef8e4601d8b877f759f68ff016cdfb8df01b35", "message": "Code cleanup", "committedDate": "2020-01-22T08:35:08Z", "type": "forcePushed"}, {"oid": "0643a22daa666a98f1a95451908ac2307aee74c7", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/0643a22daa666a98f1a95451908ac2307aee74c7", "message": "Make sure the field adress contains a field key after colon", "committedDate": "2020-01-22T08:41:26Z", "type": "commit"}]}