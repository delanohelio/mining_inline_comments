{"pr_number": 838, "pr_title": "Small code improvements & refactoring", "pr_createdAt": "2020-04-10T15:14:01Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838", "timeline": [{"oid": "816a0a05ddb6fef9bdfe97c8c2ff9dee6094844d", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/816a0a05ddb6fef9bdfe97c8c2ff9dee6094844d", "message": "Small code improvements", "committedDate": "2020-04-16T18:16:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM3NjA0Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416376043", "bodyText": "Written like this, it seems like a bug that || is not &&. I'd like it more like this:\nif (containsPlan(v1Plans, servicePlanName)) {\n     return v1Plans;\n}\nif (containsPlan(v2Plans, servicePlanName)) {\n    return v2Plans;\n}\nreturn v1Plans;\n\nThat way it's clear that v1Plans is the default.", "author": "nictas", "createdAt": "2020-04-28T07:00:59Z", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/clients/ServiceWithAlternativesCreator.java", "diffHunk": "@@ -63,17 +61,17 @@ public ServiceWithAlternativesCreator(UserMessageLogger userMessageLogger) {\n         return attemptToFindServiceOfferingAndCreateService(client, serviceInstance, validServiceOfferings);\n     }\n \n-    private List<CloudServicePlan> retrievePlanListFromServicePlan(CloudServiceInstanceExtended serviceInstance,\n-                                                                   List<CloudServicePlan>... listOfPlans) {\n+    private List<CloudServicePlan> retrievePlanListFromServicePlan(CloudServiceInstanceExtended serviceInstance, List<CloudServicePlan> v1Plans,\n+                                                                   List<CloudServicePlan> v2Plans) {\n         String servicePlanName = serviceInstance.getPlan();\n-        if (ArrayUtils.isEmpty(listOfPlans)) {\n+        if (v1Plans.isEmpty() || v2Plans.isEmpty()) {\n             throw new SLException(Messages.EMPTY_SERVICE_PLANS_LIST_FOUND, servicePlanName);\n         }\n \n-        return Stream.of(listOfPlans)\n-                     .filter(plans -> containsPlan(plans, servicePlanName))\n-                     .findFirst()\n-                     .orElse(listOfPlans[0]);\n+        if (containsPlan(v1Plans, servicePlanName) || !containsPlan(v2Plans, servicePlanName)) {", "originalCommit": "d2e775673076eddfeb6ca8c23facb008fa3f1079", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ2NjgyOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416466828", "bodyText": "Done", "author": "radito3", "createdAt": "2020-04-28T09:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM3NjA0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM4OTI3Mg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416389272", "bodyText": "You're relying on the equals method of X509Certificate. Does it do the same thing as the previous check?", "author": "nictas", "createdAt": "2020-04-28T07:25:51Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/JarSignatureVerifier.java", "diffHunk": "@@ -142,21 +139,13 @@ private String getJarEntriesNames(List<JarEntry> jarEntries) {\n \n     private void validateCertificateChain(List<X509Certificate> targetCertificates, List<X509Certificate> candidateCertificateChain,\n                                           String certificateCN) {\n-        boolean certificateCNMatches = false;\n-        boolean targetCertificatesMatchEntryCertificate = false;\n-        for (X509Certificate certificate : candidateCertificateChain) {\n-            checkValidityOfCertificate(certificate);\n-            if (!certificateCNMatches) {\n-                certificateCNMatches = certificateCNMatches(certificate, certificateCN);\n-            }\n-            if (!targetCertificatesMatchEntryCertificate) {\n-                targetCertificatesMatchEntryCertificate = doTargetCertificatesMatchEntryCertificate(targetCertificates, certificate);\n-            }\n-        }\n-        if (!certificateCNMatches) {\n+        candidateCertificateChain.forEach(this::checkValidityOfCertificate);\n+\n+        List<String> certificateCNs = getCertificatesNames(candidateCertificateChain);\n+        if (certificateCN != null && !certificateCNs.contains(certificateCN)) {\n             throw new SLException(Messages.WILL_LOOK_FOR_CERTIFICATE_CN, certificateCN);\n         }\n-        if (!targetCertificatesMatchEntryCertificate) {\n+        if (Collections.disjoint(candidateCertificateChain, targetCertificates)) {", "originalCommit": "d2e775673076eddfeb6ca8c23facb008fa3f1079", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ2ODQzOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416468438", "bodyText": "Yes, it was the same check previously, although in a much more ineffective way\ntargetCertificates.stream().anyMatch(cert -> Object.equals(cert, givenCert))", "author": "radito3", "createdAt": "2020-04-28T09:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM4OTI3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MzEyNQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416473125", "bodyText": "Ok.", "author": "nictas", "createdAt": "2020-04-28T09:37:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM4OTI3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM5MDI3MQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416390271", "bodyText": "Why were we using this in the first place?? /facepalm", "author": "nictas", "createdAt": "2020-04-28T07:27:29Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ServiceRemover.java", "diffHunk": "@@ -58,13 +56,9 @@ private void unbindService(CloudControllerClient client, StepLogger stepLogger,\n             return;\n         }\n         stepLogger.debug(Messages.SERVICE_BINDINGS_EXISTS, secureSerializer.toJson(serviceBindings));\n-        List<CloudApplication> applications = client.getApplications();", "originalCommit": "d2e775673076eddfeb6ca8c23facb008fa3f1079", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQwNTc1Ng==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416405756", "bodyText": "The name of the method does not make much sense after removing the int numberOfDays argument. Put it back.", "author": "nictas", "createdAt": "2020-04-28T07:53:11Z", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/security/data/termination/DataTerminationService.java", "diffHunk": "@@ -94,12 +94,11 @@ private CloudControllerClientImpl getCFClient() {\n         return cfClient;\r\n     }\r\n \r\n-    private String getDateBeforeDays(int numberOfDays) {\r\n-        SimpleDateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd\");\r\n-        long currentDateInMillis = new Date().getTime();\r\n-        long timeInMillisBeforeTwoDays = currentDateInMillis - numberOfDays * DateUtils.MILLIS_PER_DAY;\r\n-        Date dateBeforeTwoDays = new Date(timeInMillisBeforeTwoDays);\r\n-        String result = sdf.format(dateBeforeTwoDays);\r\n+    private String getDateBeforeDays() {\r", "originalCommit": "816a0a05ddb6fef9bdfe97c8c2ff9dee6094844d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MDU3MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416470570", "bodyText": "Done", "author": "radito3", "createdAt": "2020-04-28T09:33:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQwNTc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQwNjg5NA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416406894", "bodyText": "applicationGuid is more consistent with the name of the method. Additionally, this really is a GUID, even though the name of the VCAP_APPLICATION field does not reflect that.", "author": "nictas", "createdAt": "2020-04-28T07:54:59Z", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/util/ApplicationConfiguration.java", "diffHunk": "@@ -755,9 +755,9 @@ private Integer getHealthCheckTimeRangeFromEnvironment() {\n \r\n     private String getApplicationGuidFromEnvironment() {\r\n         Map<String, Object> vcapApplicationMap = getVcapApplication();\r\n-        String applicationGuid = (String) vcapApplicationMap.get(\"application_id\");\r", "originalCommit": "816a0a05ddb6fef9bdfe97c8c2ff9dee6094844d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MTU5Nw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416471597", "bodyText": "This change was due to a sonar code smell because there is an instance variable named applicationGuid and this was the same, although with a smaller scope", "author": "radito3", "createdAt": "2020-04-28T09:34:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQwNjg5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQwNzg3Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416407873", "bodyText": "The name of the method does not make much sense after removing the String path argument. Put it back.", "author": "nictas", "createdAt": "2020-04-28T07:56:26Z", "path": "com.sap.cloud.lm.sl.cf.core/src/test/java/com/sap/cloud/lm/sl/cf/core/helpers/MtaConfigurationPurgerTest.java", "diffHunk": "@@ -153,8 +153,8 @@ private CloudApplication createApplication(String applicationName, Map<String, O\n                                         .build();\n     }\n \n-    private Map<String, Object> getApplicationEnvFromFile(String path) {", "originalCommit": "816a0a05ddb6fef9bdfe97c8c2ff9dee6094844d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDA4MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/838#discussion_r416474080", "bodyText": "Done", "author": "radito3", "createdAt": "2020-04-28T09:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQwNzg3Mw=="}], "type": "inlineReview"}, {"oid": "e02aff8d799353902f2eb59d378b4209dc3148bf", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/e02aff8d799353902f2eb59d378b4209dc3148bf", "message": "Refactor variable APP_CONTENT_CHANGED", "committedDate": "2020-04-28T09:25:19Z", "type": "commit"}, {"oid": "d6fdb2104144decf6817294dcc123b85fc0beac3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/d6fdb2104144decf6817294dcc123b85fc0beac3", "message": "Remove redundant FileUtils method", "committedDate": "2020-04-28T09:25:19Z", "type": "commit"}, {"oid": "a7df8e06a3be581d8730664e0d06accffd572339", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/a7df8e06a3be581d8730664e0d06accffd572339", "message": "Small refactoring in UploadAppStep and its test", "committedDate": "2020-04-28T09:25:20Z", "type": "commit"}, {"oid": "6a40585cc9921ab92447d150de8403b5f0c7d603", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6a40585cc9921ab92447d150de8403b5f0c7d603", "message": "Refactor ThreadInfo classes to reduce redundancy", "committedDate": "2020-04-28T09:25:20Z", "type": "commit"}, {"oid": "142bebb099d4b9efce89b66c4a51c2a84b3e8161", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/142bebb099d4b9efce89b66c4a51c2a84b3e8161", "message": "Make ApplicationStartupCalculator a bean", "committedDate": "2020-04-28T09:25:20Z", "type": "commit"}, {"oid": "e359ab78d9a3a713485da96b6df4df69c9c1351e", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/e359ab78d9a3a713485da96b6df4df69c9c1351e", "message": "Remove unused methods/parameters/variables", "committedDate": "2020-04-28T09:25:20Z", "type": "commit"}, {"oid": "2a664a74f591cd03f1ad4dedbb5d8aa424663a55", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/2a664a74f591cd03f1ad4dedbb5d8aa424663a55", "message": "Refactoring", "committedDate": "2020-04-28T09:49:59Z", "type": "commit"}, {"oid": "5999652e80104ca2cbfeb6d8955177aa00d9174b", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/5999652e80104ca2cbfeb6d8955177aa00d9174b", "message": "Small code improvements", "committedDate": "2020-04-28T09:50:00Z", "type": "commit"}, {"oid": "5999652e80104ca2cbfeb6d8955177aa00d9174b", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/5999652e80104ca2cbfeb6d8955177aa00d9174b", "message": "Small code improvements", "committedDate": "2020-04-28T09:50:00Z", "type": "forcePushed"}]}