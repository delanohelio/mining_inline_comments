{"pr_number": 909, "pr_title": "Add metric for Flowable Queue size", "pr_createdAt": "2020-07-22T07:59:48Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/909", "timeline": [{"oid": "0e688a9aa5b6ad9ac63ed48dd2ed523425aa6330", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/0e688a9aa5b6ad9ac63ed48dd2ed523425aa6330", "message": "Add metric for Flowable Queue size", "committedDate": "2020-07-22T07:59:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzNTA4OA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/909#discussion_r458635088", "bodyText": "Is this operation expensive enough to justify the cache?", "author": "nictas", "createdAt": "2020-07-22T08:45:56Z", "path": "com.sap.cloud.lm.sl.cf.web/src/main/java/com/sap/cloud/lm/sl/cf/web/monitoring/FlowableJobExecutorInformation.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package com.sap.cloud.lm.sl.cf.web.monitoring;\n+\n+import java.time.Instant;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import org.flowable.job.service.impl.asyncexecutor.DefaultAsyncJobExecutor;\n+\n+@Named\n+public class FlowableJobExecutorInformation {\n+\n+    private static final int CACHE_TIMEOUT_IN_SECONDS = 60;\n+\n+    protected Instant lastUpdateTime;\n+\n+    private DefaultAsyncJobExecutor jobExecutor;\n+\n+    private int currentJobExecutorQueueSize = 0;\n+\n+    @Inject\n+    public FlowableJobExecutorInformation(DefaultAsyncJobExecutor jobExecutor) {\n+        this.jobExecutor = jobExecutor;\n+    }\n+\n+    public int getCurrentJobExecutorQueueSize() {\n+        if (lastUpdateTime == null || isPastCacheTimeout()) {\n+            updateCurrentJobExecutorQueueSize();\n+        }\n+        return currentJobExecutorQueueSize;\n+    }\n+\n+    private boolean isPastCacheTimeout() {\n+        return Instant.now()\n+                      .minusSeconds(CACHE_TIMEOUT_IN_SECONDS)\n+                      .isAfter(lastUpdateTime);\n+    }\n+\n+    private void updateCurrentJobExecutorQueueSize() {\n+        currentJobExecutorQueueSize = jobExecutor.getThreadPoolQueue()", "originalCommit": "0e688a9aa5b6ad9ac63ed48dd2ed523425aa6330", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzODg5NA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/909#discussion_r458638894", "bodyText": "For every execution of size() method, it obtains lock over blocking queue and this could slow add/remove jobs from queue because of frequent polling of jmx beans from Dynatrace. I have already execute stress tests with cache mechanism and now I will execute without cache.", "author": "theghost5800", "createdAt": "2020-07-22T08:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzNTA4OA=="}], "type": "inlineReview"}]}