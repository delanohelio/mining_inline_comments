{"pr_number": 953, "pr_title": "Replace Spring Cloud libraries", "pr_createdAt": "2020-09-18T09:43:53Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/953", "timeline": [{"oid": "8aeb0272b27449c9d36f77e06330df8bf82d8bd3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/8aeb0272b27449c9d36f77e06330df8bf82d8bd3", "message": "Replace Spring Cloud libraries\n\nThey're deprecated in favor of https://github.com/pivotal-cf/java-cfenv", "committedDate": "2020-09-18T09:47:31Z", "type": "forcePushed"}, {"oid": "559b1b671dd38441ef60dcdd0531b2ff53837242", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/559b1b671dd38441ef60dcdd0531b2ff53837242", "message": "Replace Spring Cloud libraries\n\nThey're deprecated in favor of https://github.com/pivotal-cf/java-cfenv", "committedDate": "2020-09-18T13:43:42Z", "type": "forcePushed"}, {"oid": "83a32d82c57307d1153f095dd9760dd7ce340b66", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/83a32d82c57307d1153f095dd9760dd7ce340b66", "message": "Replace Spring Cloud libraries\n\nThey're deprecated in favor of https://github.com/pivotal-cf/java-cfenv", "committedDate": "2020-09-23T09:43:33Z", "type": "forcePushed"}, {"oid": "bcbd712ccd34b039c61c42d67127fe81209a007f", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/bcbd712ccd34b039c61c42d67127fe81209a007f", "message": "Replace Spring Cloud libraries\n\nThey're deprecated in favor of https://github.com/pivotal-cf/java-cfenv", "committedDate": "2020-09-23T10:08:49Z", "type": "forcePushed"}, {"oid": "8ad318cbd6ed134231f0b2fc6400b59803afde9e", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/8ad318cbd6ed134231f0b2fc6400b59803afde9e", "message": "Replace Spring Cloud libraries\n\nThey're deprecated in favor of https://github.com/pivotal-cf/java-cfenv", "committedDate": "2020-09-23T10:18:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQzNzM3NA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/953#discussion_r493437374", "bodyText": "Are volume_mounts and container_dir properties names from FSS binding?", "author": "theghost5800", "createdAt": "2020-09-23T10:43:44Z", "path": "multiapps-controller-web/src/main/java/org/cloudfoundry/multiapps/controller/web/configuration/bean/factory/FileSystemFileStorageFactoryBean.java", "diffHunk": "@@ -1,69 +1,60 @@\n package org.cloudfoundry.multiapps.controller.web.configuration.bean.factory;\n \n-import java.text.MessageFormat;\n+import java.util.List;\n+import java.util.Map;\n \n-import org.apache.commons.lang3.StringUtils;\n import org.cloudfoundry.multiapps.controller.persistence.services.FileSystemFileStorage;\n-import org.cloudfoundry.multiapps.controller.web.Messages;\n-import org.cloudfoundry.multiapps.controller.web.configuration.service.FileSystemServiceInfo;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import org.cloudfoundry.multiapps.controller.web.util.VcapServiceFinder;\n import org.springframework.beans.factory.FactoryBean;\n import org.springframework.beans.factory.InitializingBean;\n-import org.springframework.cloud.Cloud;\n-import org.springframework.cloud.CloudException;\n-import org.springframework.cloud.CloudFactory;\n \n-public class FileSystemFileStorageFactoryBean implements FactoryBean<FileSystemFileStorage>, InitializingBean {\n+import io.pivotal.cfenv.core.CfService;\n \n-    private static final Logger LOGGER = LoggerFactory.getLogger(FileSystemFileStorageFactoryBean.class);\n+public class FileSystemFileStorageFactoryBean implements FactoryBean<FileSystemFileStorage>, InitializingBean {\n \n     private final String serviceName;\n+    private final VcapServiceFinder vcapServiceFinder;\n     private FileSystemFileStorage fileSystemFileStorage;\n \n-    public FileSystemFileStorageFactoryBean(String serviceName) {\n+    public FileSystemFileStorageFactoryBean(String serviceName, VcapServiceFinder vcapServiceFinder) {\n         this.serviceName = serviceName;\n+        this.vcapServiceFinder = vcapServiceFinder;\n     }\n \n     @Override\n     public void afterPropertiesSet() {\n         String storagePath = getStoragePath(serviceName);\n-        this.fileSystemFileStorage = createFileSystemFileStorage(storagePath);\n-    }\n-\n-    private FileSystemFileStorage createFileSystemFileStorage(String storagePath) {\n-        return storagePath == null ? null : new FileSystemFileStorage(storagePath);\n-    }\n-\n-    @Override\n-    public FileSystemFileStorage getObject() {\n-        return fileSystemFileStorage;\n+        if (storagePath == null) {\n+            return;\n+        }\n+        this.fileSystemFileStorage = new FileSystemFileStorage(storagePath);\n     }\n \n     @Override\n-    public Class<?> getObjectType() {\n+    public Class<FileSystemFileStorage> getObjectType() {\n         return FileSystemFileStorage.class;\n     }\n \n     @Override\n-    public boolean isSingleton() {\n-        return true;\n+    public FileSystemFileStorage getObject() {\n+        return fileSystemFileStorage;\n     }\n \n     private String getStoragePath(String serviceName) {\n-        if (StringUtils.isEmpty(serviceName)) {\n-            LOGGER.warn(Messages.FILE_SYSTEM_SERVICE_NAME_IS_NOT_SPECIFIED);\n+        CfService service = vcapServiceFinder.findService(serviceName);\n+        if (service == null) {\n             return null;\n         }\n-        try {\n-            CloudFactory cloudFactory = new CloudFactory();\n-            Cloud cloud = cloudFactory.getCloud();\n-            FileSystemServiceInfo serviceInfo = (FileSystemServiceInfo) cloud.getServiceInfo(serviceName);\n-            return serviceInfo.getStoragePath();\n-        } catch (CloudException e) {\n-            LOGGER.warn(MessageFormat.format(Messages.FAILED_TO_DETECT_FILE_SERVICE_STORAGE_PATH, serviceName), e);\n-        }\n-        return null;\n+        return getStoragePath(service);\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private String getStoragePath(CfService service) {\n+        Map<String, Object> credentials = service.getCredentials()\n+                                                 .getMap();\n+        List<Object> volumeMounts = (List<Object>) credentials.get(\"volume_mounts\");\n+        Map<String, Object> volumeMount = (Map<String, Object>) volumeMounts.get(0);\n+        return (String) volumeMount.get(\"container_dir\");", "originalCommit": "8ad318cbd6ed134231f0b2fc6400b59803afde9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ5NjYyOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/953#discussion_r493496628", "bodyText": "I don't know. This is unchanged code from: \n  \n    \n      multiapps-controller/multiapps-controller-web/src/main/java/org/cloudfoundry/multiapps/controller/web/configuration/service/FileSystemServiceInfoCreator.java\n    \n    \n         Line 31\n      in\n      4f9ad9d\n    \n    \n    \n    \n\n        \n          \n           public FileSystemServiceInfo createServiceInfo(Map<String, Object> serviceData) {", "author": "nictas", "createdAt": "2020-09-23T11:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQzNzM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ0MDY4NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/953#discussion_r493440685", "bodyText": "You can remove this method like other FactoryBean implementation classes. I saw that default implementation of this method always return true.", "author": "theghost5800", "createdAt": "2020-09-23T10:47:19Z", "path": "multiapps-controller-web/src/main/java/org/cloudfoundry/multiapps/controller/web/configuration/bean/factory/ObjectStoreFileStorageFactoryBean.java", "diffHunk": "@@ -85,4 +69,5 @@ public ObjectStoreFileStorage getObject() {\n     public boolean isSingleton() {", "originalCommit": "8ad318cbd6ed134231f0b2fc6400b59803afde9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ0NjI1Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/953#discussion_r493446253", "bodyText": "Is it expected to pass null or empty String?", "author": "theghost5800", "createdAt": "2020-09-23T10:53:33Z", "path": "multiapps-controller-web/src/main/java/org/cloudfoundry/multiapps/controller/web/util/VcapServiceFinder.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.cloudfoundry.multiapps.controller.web.util;\n+\n+import javax.inject.Named;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.util.CollectionUtils;\n+\n+import io.pivotal.cfenv.core.CfService;\n+import io.pivotal.cfenv.jdbc.CfJdbcEnv;\n+import io.pivotal.cfenv.jdbc.CfJdbcService;\n+\n+@Named\n+public class VcapServiceFinder {\n+\n+    private final CfJdbcEnv env = new CfJdbcEnv();\n+\n+    public CfJdbcService findJdbcService(String name) {\n+        if (StringUtils.isEmpty(name)) {", "originalCommit": "8ad318cbd6ed134231f0b2fc6400b59803afde9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ5OTI5Mg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/953#discussion_r493499292", "bodyText": "No idea. Same code as in: \n  \n    \n      multiapps-controller/multiapps-controller-web/src/main/java/org/cloudfoundry/multiapps/controller/web/configuration/bean/factory/CloudDataSourceFactoryBean.java\n    \n    \n         Line 59\n      in\n      4f9ad9d\n    \n    \n    \n    \n\n        \n          \n           if (serviceName != null && !serviceName.isEmpty()) { \n        \n    \n  \n\n\nMy goal was to change as little as possible.", "author": "nictas", "createdAt": "2020-09-23T11:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ0NjI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ1MjUzNg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/953#discussion_r493452536", "bodyText": "Same comment", "author": "theghost5800", "createdAt": "2020-09-23T11:00:43Z", "path": "multiapps-controller-web/src/main/java/org/cloudfoundry/multiapps/controller/web/util/VcapServiceFinder.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.cloudfoundry.multiapps.controller.web.util;\n+\n+import javax.inject.Named;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.util.CollectionUtils;\n+\n+import io.pivotal.cfenv.core.CfService;\n+import io.pivotal.cfenv.jdbc.CfJdbcEnv;\n+import io.pivotal.cfenv.jdbc.CfJdbcService;\n+\n+@Named\n+public class VcapServiceFinder {\n+\n+    private final CfJdbcEnv env = new CfJdbcEnv();\n+\n+    public CfJdbcService findJdbcService(String name) {\n+        if (StringUtils.isEmpty(name)) {\n+            return null;\n+        }\n+        try {\n+            return env.findJdbcServiceByName(name);\n+        } catch (IllegalArgumentException e) { // Thrown when there are 0 or more matches for the specified name.\n+            return null;\n+        }\n+    }\n+\n+    public CfService findService(String name) {\n+        if (StringUtils.isEmpty(name)) {", "originalCommit": "8ad318cbd6ed134231f0b2fc6400b59803afde9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "41a6992fa8d9eecf3ab1263d86798e82668f2de8", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/41a6992fa8d9eecf3ab1263d86798e82668f2de8", "message": "Replace Spring Cloud libraries\n\nThey're deprecated in favor of https://github.com/pivotal-cf/java-cfenv", "committedDate": "2020-09-23T11:49:29Z", "type": "forcePushed"}, {"oid": "3ee2adec57dda4a55714629e963bf719b1664496", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/3ee2adec57dda4a55714629e963bf719b1664496", "message": "Replace Spring Cloud libraries\n\nThey're deprecated in favor of https://github.com/pivotal-cf/java-cfenv", "committedDate": "2020-09-23T11:55:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYxNjMxNA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/953#discussion_r493616314", "bodyText": "Shouldn't this be annotated with @Inject ?", "author": "radito3", "createdAt": "2020-09-23T13:59:39Z", "path": "multiapps-controller-web/src/main/java/org/cloudfoundry/multiapps/controller/web/configuration/bean/factory/DataSourceFactory.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package org.cloudfoundry.multiapps.controller.web.configuration.bean.factory;\n+\n+import javax.inject.Named;\n+\n+import org.cloudfoundry.multiapps.controller.core.util.ApplicationConfiguration;\n+\n+import com.zaxxer.hikari.HikariConfig;\n+import com.zaxxer.hikari.HikariDataSource;\n+\n+import io.pivotal.cfenv.jdbc.CfJdbcService;\n+\n+@Named\n+public class DataSourceFactory {\n+\n+    private final ApplicationConfiguration configuration;\n+\n+    public DataSourceFactory(ApplicationConfiguration configuration) {", "originalCommit": "3ee2adec57dda4a55714629e963bf719b1664496", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYxNzM2MQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/953#discussion_r493617361", "bodyText": "Nice", "author": "radito3", "createdAt": "2020-09-23T14:00:55Z", "path": "multiapps-controller-web/src/main/java/org/cloudfoundry/multiapps/controller/web/configuration/service/ObjectStoreServiceInfo.java", "diffHunk": "@@ -1,103 +1,23 @@\n package org.cloudfoundry.multiapps.controller.web.configuration.service;\n \n-import org.springframework.cloud.service.BaseServiceInfo;\n-import org.springframework.cloud.service.ServiceInfo.ServiceLabel;\n+import org.cloudfoundry.multiapps.common.Nullable;\n+import org.immutables.value.Value;\n \n-@ServiceLabel(\"objectstore\")\n-public class ObjectStoreServiceInfo extends BaseServiceInfo {\n+@Value.Immutable", "originalCommit": "3ee2adec57dda4a55714629e963bf719b1664496", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "08bddda06c4fd7dff9cdd9cd15fc1714b5491d2a", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/08bddda06c4fd7dff9cdd9cd15fc1714b5491d2a", "message": "Replace Spring Cloud libraries\n\nThey're deprecated in favor of https://github.com/pivotal-cf/java-cfenv", "committedDate": "2020-09-23T14:26:21Z", "type": "commit"}, {"oid": "08bddda06c4fd7dff9cdd9cd15fc1714b5491d2a", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/08bddda06c4fd7dff9cdd9cd15fc1714b5491d2a", "message": "Replace Spring Cloud libraries\n\nThey're deprecated in favor of https://github.com/pivotal-cf/java-cfenv", "committedDate": "2020-09-23T14:26:21Z", "type": "forcePushed"}]}