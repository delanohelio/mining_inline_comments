{"pr_number": 897, "pr_title": "Skip user filtering if needed", "pr_createdAt": "2020-07-03T08:09:41Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/897", "timeline": [{"oid": "1c202493d0fea70f357d0cceea1493f4417aec7f", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/1c202493d0fea70f357d0cceea1493f4417aec7f", "message": "Skip user filtering if needed", "committedDate": "2020-07-03T08:37:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2OTY0OQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/897#discussion_r449469649", "bodyText": "Is there a chance that something else is null?", "author": "radoslav-d", "createdAt": "2020-07-03T09:05:38Z", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/health/HealthRetriever.java", "diffHunk": "@@ -38,15 +39,21 @@ public Health getHealth() {\n         HealthCheckConfiguration healthCheckConfiguration = configuration.getHealthCheckConfiguration();\n         ZonedDateTime currentTime = currentTimeSupplier.get();\n         ZonedDateTime xSecondsAgo = currentTime.minusSeconds(healthCheckConfiguration.getTimeRangeInSeconds());\n-        List<Operation> healthCheckOperations = operationService.createQuery()\n-                                                                .mtaId(healthCheckConfiguration.getMtaId())\n-                                                                .spaceId(healthCheckConfiguration.getSpaceId())\n-                                                                .user(healthCheckConfiguration.getUserName())\n-                                                                .endedAfter(Date.from(xSecondsAgo.toInstant()))\n-                                                                .inFinalState()\n-                                                                .orderByEndTime(OrderDirection.DESCENDING)\n-                                                                .list();\n+        List<Operation> healthCheckOperations = getHealthCheckOperations(healthCheckConfiguration, xSecondsAgo);\n         return Health.fromOperations(healthCheckOperations);\n     }\n \n+    private List<Operation> getHealthCheckOperations(HealthCheckConfiguration healthCheckConfiguration, ZonedDateTime xSecondsAgo) {\n+        OperationQuery healthCheckOperationsQuery = operationService.createQuery()\n+                                                                    .mtaId(healthCheckConfiguration.getMtaId())\n+                                                                    .spaceId(healthCheckConfiguration.getSpaceId())\n+                                                                    .endedAfter(Date.from(xSecondsAgo.toInstant()))\n+                                                                    .inFinalState()\n+                                                                    .orderByEndTime(OrderDirection.DESCENDING);\n+        if (healthCheckConfiguration.getUserName() != null) {\n+            healthCheckOperationsQuery.user(healthCheckConfiguration.getUserName());", "originalCommit": "1c202493d0fea70f357d0cceea1493f4417aec7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ3MDk2Mg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/897#discussion_r449470962", "bodyText": "I think that there is never() or something similar, which can be used instead of times(0).", "author": "radoslav-d", "createdAt": "2020-07-03T09:08:01Z", "path": "com.sap.cloud.lm.sl.cf.core/src/test/java/com/sap/cloud/lm/sl/cf/core/health/HealthRetrieverTest.java", "diffHunk": "@@ -101,15 +106,49 @@ public void testGetHealth() {\n \n         HealthCheckOperation healthCheckOperation = health.getHealthCheckOperations()\n                                                           .get(0);\n+        validateHealthCheckOperationParameters(healthCheckOperation);\n+        Mockito.verify(operationQuery, times(1))\n+               .user(USER_NAME);\n+        validateMandatoryParametersAreSet();\n+    }\n+\n+    @Test\n+    void testGetHealthWithoutUsername() {\n+        prepareConfiguration(ImmutableHealthCheckConfiguration.builder()\n+                                                              .mtaId(MTA_ID)\n+                                                              .spaceId(SPACE_ID)\n+                                                              .timeRangeInSeconds(TIME_RANGE_IN_SECONDS)\n+                                                              .build());\n+        Health health = healthRetriever.getHealth();\n+\n+        assertTrue(health.isHealthy());\n+        HealthCheckOperation healthCheckOperation = health.getHealthCheckOperations()\n+                                                          .get(0);\n+        validateHealthCheckOperationParameters(healthCheckOperation);\n+        Mockito.verify(operationQuery, times(0))", "originalCommit": "1c202493d0fea70f357d0cceea1493f4417aec7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "638a980f0a6e2bfa2c7ea89a308f6b59d7aef742", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/638a980f0a6e2bfa2c7ea89a308f6b59d7aef742", "message": "Skip user filtering if needed", "committedDate": "2020-07-03T09:17:21Z", "type": "commit"}, {"oid": "638a980f0a6e2bfa2c7ea89a308f6b59d7aef742", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/638a980f0a6e2bfa2c7ea89a308f6b59d7aef742", "message": "Skip user filtering if needed", "committedDate": "2020-07-03T09:17:21Z", "type": "forcePushed"}]}