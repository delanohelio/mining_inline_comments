{"pr_number": 26692, "pr_title": "Introduce a function for adding custom tags to system metrics", "pr_createdAt": "2020-11-01T06:21:45Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692", "timeline": [{"oid": "9c6da1a019f876ff7535adbde944df991f7ec051", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9c6da1a019f876ff7535adbde944df991f7ec051", "message": "format code", "committedDate": "2020-11-01T07:35:58Z", "type": "forcePushed"}, {"oid": "e6bb4c8434bf51987bc81fdbf7267b88b9f87f65", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e6bb4c8434bf51987bc81fdbf7267b88b9f87f65", "message": "add test cases", "committedDate": "2020-11-05T08:16:29Z", "type": "forcePushed"}, {"oid": "51922344816aa982bf20f552fd13646e75b58a3a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/51922344816aa982bf20f552fd13646e75b58a3a", "message": "add test cases", "committedDate": "2020-11-05T08:39:43Z", "type": "forcePushed"}, {"oid": "e55a0f2399ab0544a06d91024007b71eea60c620", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e55a0f2399ab0544a06d91024007b71eea60c620", "message": "add test cases", "committedDate": "2020-11-05T09:26:18Z", "type": "forcePushed"}, {"oid": "9a02c34e53d9d7353111e6acb93efd5f83ba326c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9a02c34e53d9d7353111e6acb93efd5f83ba326c", "message": "add test cases", "committedDate": "2020-11-05T11:50:07Z", "type": "forcePushed"}, {"oid": "153e439a3655ca6d4b38b5d047762a9199fc7a40", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/153e439a3655ca6d4b38b5d047762a9199fc7a40", "message": "Add test cases", "committedDate": "2020-11-06T05:43:56Z", "type": "forcePushed"}, {"oid": "cd3c8570a908a1f521aa2b266ede6e8ba5cbecc7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cd3c8570a908a1f521aa2b266ede6e8ba5cbecc7", "message": "Fix lint issues", "committedDate": "2020-11-10T07:00:04Z", "type": "forcePushed"}, {"oid": "a39dda40f83ff72a39cc7696735b12c3488af4b3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a39dda40f83ff72a39cc7696735b12c3488af4b3", "message": "Fix lint issue", "committedDate": "2020-11-10T08:22:21Z", "type": "forcePushed"}, {"oid": "944329c585dc420a6e902e1bdfd9002fbec66f8c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/944329c585dc420a6e902e1bdfd9002fbec66f8c", "message": "Fix lint issue", "committedDate": "2020-11-10T09:15:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4OTY2NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r521789665", "bodyText": "U can directly add the property here without maintaining a separate isCustomTagsAvailable variable", "author": "nadundesilva", "createdAt": "2020-11-12T03:09:18Z", "path": "observelib/observe/src/main/java/org/ballerinalang/observe/nativeimpl/AddTagToMetrics.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.ballerinalang.observe.nativeimpl;\n+\n+import io.ballerina.runtime.api.Environment;\n+import io.ballerina.runtime.api.creators.ErrorCreator;\n+import io.ballerina.runtime.api.utils.StringUtils;\n+import io.ballerina.runtime.api.values.BString;\n+import io.ballerina.runtime.observability.ObserveUtils;\n+import io.ballerina.runtime.observability.ObserverContext;\n+import io.ballerina.runtime.observability.metrics.BallerinaMetricsObserver;\n+import io.ballerina.runtime.observability.metrics.Tag;\n+\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * This function add tags to System Metrics.\n+ * Custom tag is not included in the 'in progress-requests'\n+ */\n+public class AddTagToMetrics {\n+\n+    public static Object addTagToMetrics(Environment env, BString tagKey, BString tagValue) {\n+\n+        ObserverContext observerContext = ObserveUtils.getObserverContextOfCurrentFrame(env);\n+        boolean isCustomTagsAvailable = true;\n+        if (observerContext != null) {\n+            Map<String, Tag> customTags =\n+                    (Map<String, Tag>) observerContext.getProperty(BallerinaMetricsObserver.PROPERTY_CUSTOM_TAGS);\n+            if (customTags == null) {\n+                customTags = new HashMap<>();\n+                isCustomTagsAvailable = false;", "originalCommit": "bbe233128859456e48d18b0bb66d24fbdc5d36e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7f130b44290ea3dcab7bd4b145075e2c64c8ba03", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7f130b44290ea3dcab7bd4b145075e2c64c8ba03", "message": "add test cases", "committedDate": "2020-11-20T03:51:47Z", "type": "commit"}, {"oid": "9968be3ec391c3c3cc170b6bd9ace41475933ae2", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9968be3ec391c3c3cc170b6bd9ace41475933ae2", "message": "Add native implementation for AddTagToMetrics", "committedDate": "2020-11-20T04:11:05Z", "type": "commit"}, {"oid": "1cd8fe3f0263f88e851d9e5af047ae5d98a46d91", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1cd8fe3f0263f88e851d9e5af047ae5d98a46d91", "message": "Create AddTagToMetrics java class", "committedDate": "2020-11-20T04:11:05Z", "type": "commit"}, {"oid": "14d4081fb7e9c8835ccb767071cdb777664f5676", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/14d4081fb7e9c8835ccb767071cdb777664f5676", "message": "Add methods to store a single tag", "committedDate": "2020-11-20T04:11:05Z", "type": "commit"}, {"oid": "6b40a2aa20845d1f148f12e92872aba2896e2bfe", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6b40a2aa20845d1f148f12e92872aba2896e2bfe", "message": "Use bspan property to store custom tags", "committedDate": "2020-11-20T04:11:06Z", "type": "commit"}, {"oid": "8291e137fb061d4506d30591340e1233f19a170c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8291e137fb061d4506d30591340e1233f19a170c", "message": "Move status code group to metrics observer", "committedDate": "2020-11-20T04:11:06Z", "type": "commit"}, {"oid": "d4db646b05770aea8a58b79340cffd1bee3f2474", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d4db646b05770aea8a58b79340cffd1bee3f2474", "message": "Format code", "committedDate": "2020-11-20T04:11:06Z", "type": "commit"}, {"oid": "038ae35d68470fdae0c3de269f7d6dfa1dd52ae0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/038ae35d68470fdae0c3de269f7d6dfa1dd52ae0", "message": "Fix import order", "committedDate": "2020-11-20T04:11:06Z", "type": "commit"}, {"oid": "59a9f27437c61613e9ea32647812915775f8c5e5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/59a9f27437c61613e9ea32647812915775f8c5e5", "message": "Add test cases", "committedDate": "2020-11-20T04:12:05Z", "type": "commit"}, {"oid": "cef4c587707ed3f98a5fa427882a79eb68e788eb", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cef4c587707ed3f98a5fa427882a79eb68e788eb", "message": "Add map only if customTags exist", "committedDate": "2020-11-20T04:12:05Z", "type": "commit"}, {"oid": "de53b305ca48c1d8a30f0d2429a807d34da47651", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/de53b305ca48c1d8a30f0d2429a807d34da47651", "message": "Improve addTag functionality", "committedDate": "2020-11-20T04:12:05Z", "type": "commit"}, {"oid": "16fcb68dcd7c12b09becff39ae893df9f6a8e9db", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/16fcb68dcd7c12b09becff39ae893df9f6a8e9db", "message": "Refactor code styles", "committedDate": "2020-11-20T04:12:05Z", "type": "commit"}, {"oid": "f9a1f95b3d8c09b01a8bd97e6f19faea232c9f0e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f9a1f95b3d8c09b01a8bd97e6f19faea232c9f0e", "message": "Update test cases", "committedDate": "2020-11-20T04:12:06Z", "type": "commit"}, {"oid": "5a4056a4e9c1fb5fcd295c5a82cbb246d1416b9a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5a4056a4e9c1fb5fcd295c5a82cbb246d1416b9a", "message": "Fix lint issues", "committedDate": "2020-11-20T04:12:06Z", "type": "commit"}, {"oid": "64fd21bf43d7f3d43816bf5ac000bb8600163f64", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/64fd21bf43d7f3d43816bf5ac000bb8600163f64", "message": "Update strand with env", "committedDate": "2020-11-20T04:12:06Z", "type": "commit"}, {"oid": "f67c786f9c0da3d25b638244b9e7fa9e3d043d44", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f67c786f9c0da3d25b638244b9e7fa9e3d043d44", "message": "Fix lint issue", "committedDate": "2020-11-20T04:12:06Z", "type": "commit"}, {"oid": "216e3a172a0713bba98849fb65130f9a2b693284", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/216e3a172a0713bba98849fb65130f9a2b693284", "message": "Update docs", "committedDate": "2020-11-20T04:12:07Z", "type": "commit"}, {"oid": "b961187d5f17259ba198f17e5e56ff2cf5df1502", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b961187d5f17259ba198f17e5e56ff2cf5df1502", "message": "Remove boolean flag", "committedDate": "2020-11-20T04:12:07Z", "type": "commit"}, {"oid": "b961187d5f17259ba198f17e5e56ff2cf5df1502", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b961187d5f17259ba198f17e5e56ff2cf5df1502", "message": "Remove boolean flag", "committedDate": "2020-11-20T04:12:07Z", "type": "forcePushed"}, {"oid": "d9ceec95479dfd2bbf79ef4c39221209927debbf", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d9ceec95479dfd2bbf79ef4c39221209927debbf", "message": "Move addTagToMetrics test case", "committedDate": "2020-11-20T04:54:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM5ODM0Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r527398346", "bodyText": "Let's remove this additional line here", "author": "nadundesilva", "createdAt": "2020-11-20T05:00:00Z", "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/observability/metrics/BallerinaMetricsObserver.java", "diffHunk": "@@ -22,15 +22,23 @@\n \n import java.io.PrintStream;\n import java.time.Duration;\n+import java.util.HashSet;\n+import java.util.Map;\n import java.util.Set;\n \n+import static io.ballerina.runtime.observability.ObservabilityConstants.PROPERTY_KEY_HTTP_STATUS_CODE;\n+import static io.ballerina.runtime.observability.ObservabilityConstants.STATUS_CODE_GROUP_SUFFIX;\n+import static io.ballerina.runtime.observability.ObservabilityConstants.TAG_KEY_HTTP_STATUS_CODE_GROUP;\n+\n+", "originalCommit": "d9ceec95479dfd2bbf79ef4c39221209927debbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQwMjQ5MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r527402490", "bodyText": "We should rename the param and rephrase the description. endObservationTags is actually the additional tags added after start here.", "author": "nadundesilva", "createdAt": "2020-11-20T05:15:29Z", "path": "tests/jballerina-integration-test/src/test/java/org/ballerinalang/test/observability/metrics/MetricsTestCase.java", "diffHunk": "@@ -125,21 +125,41 @@ private Metrics filterByTag(Metrics metrics, String key, String value) {\n     /**\n      * Test the metrics generated for a particular function invocation.\n      *\n-     * @param allMetrics All the metrics collected from Metrics Registry\n+     * @param allMetrics         All the metrics collected from Metrics Registry\n      * @param invocationPosition The invocation position of the function invocation\n-     * @param invocationCount The number of times the function should have been called\n-     * @param additionalTags Additional tags that should be present in the metrics\n+     * @param invocationCount    The number of times the function should have been called\n+     * @param additionalTags     Additional tags that should be present in the metrics\n+     */\n+    private void testFunctionMetrics(Metrics allMetrics, String invocationPosition, long invocationCount,\n+                                     Tag... additionalTags) {\n+\n+        testFunctionMetrics(allMetrics, invocationPosition, invocationCount, additionalTags, null);\n+    }\n+\n+    /**\n+     * Test the metrics generated for a particular function invocation for a given start and end tag set.\n+     *\n+     * @param allMetrics           All the metrics collected from Metrics Registry\n+     * @param invocationPosition   The invocation position of the function invocation\n+     * @param invocationCount      The number of times the function should have been called\n+     * @param startObservationTags tags at the observation start which should be present in the metrics\n+     * @param endObservationTags   tags at the observation end which should be present in the metrics", "originalCommit": "d9ceec95479dfd2bbf79ef4c39221209927debbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQwMjY3Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r527402677", "bodyText": "Minor alignment issue here in the javadoc.", "author": "nadundesilva", "createdAt": "2020-11-20T05:16:23Z", "path": "tests/jballerina-integration-test/src/test/java/org/ballerinalang/test/observability/metrics/MetricsTestCase.java", "diffHunk": "@@ -175,25 +195,28 @@ private void testFunctionCounters(long invocationCount, Metrics functionMetrics,\n     }\n \n     /**\n-     * Test the gauge metrics generated for a particular function invocation.\n+     * Test the gauge metrics generated for a particular function invocation for given start and end tag set.\n      *\n      * @param invocationCount The number of times the function should have been called\n      * @param functionMetrics All the metrics generated for the function invocation\n-     * @param tags Tags that should be present in metrics\n+     * @param startTags            Tags that should be present in metrics at observation start\n+     * @param endTags            Tags that should be present in metrics at observation end", "originalCommit": "d9ceec95479dfd2bbf79ef4c39221209927debbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "358d0d9277c299b75ab26dc7bb862c8fad36bf49", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/358d0d9277c299b75ab26dc7bb862c8fad36bf49", "message": "Fix styling issues", "committedDate": "2020-11-20T07:14:48Z", "type": "commit"}, {"oid": "a99c4fea351f227d49e340ed958be4407e3b4575", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a99c4fea351f227d49e340ed958be4407e3b4575", "message": "Remove additional spacing", "committedDate": "2020-11-20T07:21:52Z", "type": "commit"}, {"oid": "1e817a4d1ac03d3157c560cd1a766dfc91c49fee", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e817a4d1ac03d3157c560cd1a766dfc91c49fee", "message": "Remove additional spacing", "committedDate": "2020-11-20T09:28:37Z", "type": "commit"}, {"oid": "4ce2de4eb17528c955ccebd54ddad9a4cd02e95c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4ce2de4eb17528c955ccebd54ddad9a4cd02e95c", "message": "Create custom metrics tags map", "committedDate": "2020-12-04T04:47:10Z", "type": "commit"}, {"oid": "837248703671dbbc91415cad924f51a81fb97884", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/837248703671dbbc91415cad924f51a81fb97884", "message": "Initialize custom metric tags map", "committedDate": "2020-12-04T04:50:58Z", "type": "commit"}, {"oid": "3a05dc5396dd8999f322b1d28a39868b9da71550", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3a05dc5396dd8999f322b1d28a39868b9da71550", "message": "Capture not found span error and log", "committedDate": "2020-12-04T04:51:16Z", "type": "commit"}, {"oid": "73e78a56f93ef308ca08f2cf1b29174da8844bf6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/73e78a56f93ef308ca08f2cf1b29174da8844bf6", "message": "Merge branch 'master-upstream'", "committedDate": "2020-12-04T04:53:58Z", "type": "commit"}, {"oid": "917ca30949fbb5b4d8c933c89811644c24aa732f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/917ca30949fbb5b4d8c933c89811644c24aa732f", "message": "Merge branch 'master' into feature-add-tags", "committedDate": "2020-12-04T04:54:23Z", "type": "commit"}, {"oid": "3a1a337fb47b63c3972b3518da67d844eabb3ab5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3a1a337fb47b63c3972b3518da67d844eabb3ab5", "message": "Fix custom metrics update", "committedDate": "2020-12-06T17:06:54Z", "type": "commit"}, {"oid": "9d55d638a2ccad127b1c5da0e781864b97965459", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9d55d638a2ccad127b1c5da0e781864b97965459", "message": "Fix check style issues", "committedDate": "2020-12-06T17:17:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMDc3MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r537210770", "bodyText": "Can't we remove this now ?", "author": "nadundesilva", "createdAt": "2020-12-07T03:44:00Z", "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/observability/metrics/BallerinaMetricsObserver.java", "diffHunk": "@@ -22,15 +22,22 @@\n \n import java.io.PrintStream;\n import java.time.Duration;\n+import java.util.HashSet;\n+import java.util.Map;\n import java.util.Set;\n \n+import static io.ballerina.runtime.observability.ObservabilityConstants.PROPERTY_KEY_HTTP_STATUS_CODE;\n+import static io.ballerina.runtime.observability.ObservabilityConstants.STATUS_CODE_GROUP_SUFFIX;\n+import static io.ballerina.runtime.observability.ObservabilityConstants.TAG_KEY_HTTP_STATUS_CODE_GROUP;\n+\n /**\n  * Observe the runtime and collect measurements.\n  */\n public class BallerinaMetricsObserver implements BallerinaObserver {\n \n     private static final String PROPERTY_START_TIME = \"_observation_start_time_\";\n     private static final String PROPERTY_IN_PROGRESS_COUNTER = \"_observation_in_progress_counter_\";\n+    public static final String PROPERTY_CUSTOM_TAGS = \"_custom_metric_tags_\";", "originalCommit": "9d55d638a2ccad127b1c5da0e781864b97965459", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMTYzMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r537211631", "bodyText": "Do we need this ?", "author": "nadundesilva", "createdAt": "2020-12-07T03:47:03Z", "path": "observelib/observe/src/main/java/module-info.java", "diffHunk": "@@ -3,4 +3,5 @@\n     requires io.ballerina.runtime;\n     requires opentracing.api;\n     requires io.ballerina.config;\n+    requires slf4j.api;", "originalCommit": "9d55d638a2ccad127b1c5da0e781864b97965459", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxNTgxNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r537215817", "bodyText": "This for logging the span not found error", "author": "LakshanKarunathilake", "createdAt": "2020-12-07T04:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMTYzMQ=="}], "type": "inlineReview"}, {"oid": "df3db9d5dfc75d8988bdeb8df3bdb814cdcdd37f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/df3db9d5dfc75d8988bdeb8df3bdb814cdcdd37f", "message": "Add tags only if observability enabled", "committedDate": "2020-12-07T04:01:32Z", "type": "commit"}, {"oid": "d5efa7a8c2c912e8d5335800b98cc5bf75ae1d58", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d5efa7a8c2c912e8d5335800b98cc5bf75ae1d58", "message": "Remove unused property", "committedDate": "2020-12-07T04:01:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxODI5Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r538218297", "bodyText": "please extract this to a variable", "author": "manuranga", "createdAt": "2020-12-08T10:28:01Z", "path": "observelib/observe/src/main/java/org/ballerinalang/observe/nativeimpl/OpenTracerBallerinaWrapper.java", "diffHunk": "@@ -149,29 +155,41 @@ public boolean finishSpan(Environment env, long spanId) {\n     /**\n      * Method to add tags to an existing span.\n      *\n-     * @param env current environment\n-     * @param tagKey the key of the tag\n+     * @param env      current environment\n+     * @param tagKey   the key of the tag\n      * @param tagValue the value of the tag\n-     * @param spanId id of the Span\n-     * @return boolean to indicate if tag was added to the span\n+     * @param spanId   id of the Span\n+     * @return Object to indicate if tag was added to the span\n      */\n-    public boolean addTag(Environment env, String tagKey, String tagValue, long spanId) {\n+    public Object addTag(Environment env, String tagKey, String tagValue, long spanId) {\n+\n         if (!enabled) {\n-            return false;\n+            return null;\n         }\n+\n+        final BSpan span;\n         if (spanId == -1) {\n             ObserverContext observer = ObserveUtils.getObserverContextOfCurrentFrame(env);\n-            if (observer != null) {\n-                observer.addTag(tagKey, tagValue);\n-                return true;\n+            if (observer == null) {\n+                return ErrorCreator.createError(\n+                        StringUtils.fromString(\n+                                (\"Span already finished. Can not add tag {\" + tagKey + \":\" + tagValue + \"}\")));\n             }\n-        }\n-        ObserverContext observerContext = observerContextMap.get(spanId);\n-        if (observerContext != null) {\n-            observerContext.addTag(tagKey, tagValue);\n-            return true;\n+            span = (BSpan) observer.getProperty(TraceConstants.KEY_SPAN);\n         } else {\n-            return false;\n+            ObserverContext observerContext = observerContextMap.get(spanId);\n+            if (observerContext == null) {\n+                log.info(\"Could not find the trace for given span id. Can not add tag {\" + tagKey + \":\" + tagValue +", "originalCommit": "d5efa7a8c2c912e8d5335800b98cc5bf75ae1d58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2742ee2c382da891b1a38c35fe3259c59ee95fec", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2742ee2c382da891b1a38c35fe3259c59ee95fec", "message": "Remove duplicated strings", "committedDate": "2020-12-08T17:22:59Z", "type": "commit"}, {"oid": "1e5ab0478255188f891a42b94ab221c4bcf55017", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e5ab0478255188f891a42b94ab221c4bcf55017", "message": "Change error msg scope", "committedDate": "2020-12-09T05:23:53Z", "type": "commit"}, {"oid": "1e5ab0478255188f891a42b94ab221c4bcf55017", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e5ab0478255188f891a42b94ab221c4bcf55017", "message": "Change error msg scope", "committedDate": "2020-12-09T05:23:53Z", "type": "forcePushed"}]}