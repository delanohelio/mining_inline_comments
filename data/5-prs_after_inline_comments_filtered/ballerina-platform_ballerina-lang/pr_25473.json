{"pr_number": 25473, "pr_title": "Fix query join spec deviations", "pr_createdAt": "2020-08-27T12:09:35Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/25473", "timeline": [{"oid": "15dd8e177e6148589dd7aac70925593a4f06da0c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/15dd8e177e6148589dd7aac70925593a4f06da0c", "message": "Fix join spec deviations", "committedDate": "2020-08-26T04:32:07Z", "type": "commit"}, {"oid": "00e2ed6d4877202527af129a1f725a01140fba03", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/00e2ed6d4877202527af129a1f725a01140fba03", "message": "Merge upstream", "committedDate": "2020-08-26T04:48:51Z", "type": "commit"}, {"oid": "333bdfef2f8fa892528bfe8f71da17e9298d3762", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/333bdfef2f8fa892528bfe8f71da17e9298d3762", "message": "Fix parser error recovery", "committedDate": "2020-08-26T05:41:44Z", "type": "commit"}, {"oid": "7cd50902282964bd449b88ff521d1083398f829b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7cd50902282964bd449b88ff521d1083398f829b", "message": "Fix formatter for join spec deviation changes", "committedDate": "2020-08-26T06:08:43Z", "type": "commit"}, {"oid": "1e2ec8ce6a38a1d862d4d25d32bdf89a9c5c1d17", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e2ec8ce6a38a1d862d4d25d32bdf89a9c5c1d17", "message": "Fix key function type issue in codegen", "committedDate": "2020-08-27T06:30:20Z", "type": "commit"}, {"oid": "a6a228ea69e152e56cfbffed117b7c7c2ac494be", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a6a228ea69e152e56cfbffed117b7c7c2ac494be", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into fix-25152", "committedDate": "2020-08-27T06:31:00Z", "type": "commit"}, {"oid": "4d0e8b0c6cc0d1c9f7fea5bc6dd1d145eafbfb5c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4d0e8b0c6cc0d1c9f7fea5bc6dd1d145eafbfb5c", "message": "Fix tests for join spec deviations", "committedDate": "2020-08-27T12:01:32Z", "type": "commit"}, {"oid": "f8af29b79d821de44ee280a0e7ff4413dbd935b7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f8af29b79d821de44ee280a0e7ff4413dbd935b7", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into fix-25152", "committedDate": "2020-08-27T12:01:59Z", "type": "commit"}, {"oid": "73e7c213c7f08ed22e334f2312ebd256bdca24cd", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/73e7c213c7f08ed22e334f2312ebd256bdca24cd", "message": "Remove un-used methods", "committedDate": "2020-08-27T12:10:23Z", "type": "commit"}, {"oid": "345d6a615068930d0212a9ad38549f345e3bc365", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/345d6a615068930d0212a9ad38549f345e3bc365", "message": "Fix parser tests", "committedDate": "2020-08-27T13:02:58Z", "type": "commit"}, {"oid": "b9893af56145e0396cf5c7ebc043ddabbce607c3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b9893af56145e0396cf5c7ebc043ddabbce607c3", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into fix-25152", "committedDate": "2020-08-27T17:18:52Z", "type": "commit"}, {"oid": "60acc39b0be0a371bbadefe6434b872dcd6cb1b6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/60acc39b0be0a371bbadefe6434b872dcd6cb1b6", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into fix-25152", "committedDate": "2020-08-28T00:12:25Z", "type": "commit"}, {"oid": "2e581773d8653a2cc563ab804e4e5d8bd82b99f5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2e581773d8653a2cc563ab804e4e5d8bd82b99f5", "message": "Fix LS tests", "committedDate": "2020-08-28T01:16:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgwOTk5MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25473#discussion_r478809990", "bodyText": "Shall we end the join-clause context before parsing the on-clause. like we had earlier?\n\nSince we already have a expr parsing(L9504) within join-clause context, cannot parse another expr under the same parent context as there would be an ambiguity.\nIn the error handler get next rule for the expression-rhs when the parent ctx is  join-clause includes on-clause as an alternative path.\nConsider recovery for, from int a in b join int d in e on <missing expr> select f\nafter recoverying the missing expr, error handler will then check on-clause as the next rule.\ni.e could have two on-clauses after recovery", "author": "lochana-chathura", "createdAt": "2020-08-28T03:27:20Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParser.java", "diffHunk": "@@ -9486,16 +9502,8 @@ private STNode parseJoinClause(boolean isRhsExpr) {\n         // allow-actions flag is always false, since there will not be any actions\n         // within the from-clause, due to the precedence.\n         STNode expression = parseExpression(OperatorPrecedence.QUERY, isRhsExpr, false);\n+        STNode onCondition = parseOnClause(isRhsExpr);\n         endContext();", "originalCommit": "2e581773d8653a2cc563ab804e4e5d8bd82b99f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMjg2OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25473#discussion_r478812869", "bodyText": "Pleas update the doc comment above this method indicating optional on-clause as well", "author": "lochana-chathura", "createdAt": "2020-08-28T03:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgwOTk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM3Njc0OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25473#discussion_r479376748", "bodyText": "According to the spec, on-clause is part of the join clause. So I assumed context should be closed ones everything is parsed. I'm confused here on what is context and how it works. Is there documentation which I can refer to?", "author": "grainier", "createdAt": "2020-08-28T15:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgwOTk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcyNjM1Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25473#discussion_r479726357", "bodyText": "Spec says follows, and according to that equals is only valid within a join. So, If we close the join context before finishing up with the join-on-condition, how are we suppose to know, for example on expression should followed by an equals?\njoin-clause := \"join\" typed-binding-pattern \"in\" expression join-on-condition\njoin-on-condition := \"on\" expression \"equals\" expression", "author": "grainier", "createdAt": "2020-08-30T06:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgwOTk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMTAzNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25473#discussion_r478811034", "bodyText": "This is related to above comment. Since we end the join-clause ctx for on-clause we don't need this if condition.\nnext rule will be taken as expresssion under QUERY_EXPRESSION parent context in L2731-L2732", "author": "lochana-chathura", "createdAt": "2020-08-28T03:31:29Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParserErrorHandler.java", "diffHunk": "@@ -2730,6 +2730,8 @@ private ParserRuleContext getNextRuleForKeywords(ParserRuleContext currentCtx, i\n                     return ParserRuleContext.CONFLICT_KEYWORD;\n                 } else if (parentCtx == ParserRuleContext.QUERY_EXPRESSION) {\n                     return ParserRuleContext.EXPRESSION;\n+                } else if (parentCtx == ParserRuleContext.JOIN_CLAUSE) {\n+                    return ParserRuleContext.EXPRESSION;", "originalCommit": "2e581773d8653a2cc563ab804e4e5d8bd82b99f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "38c43d3409b9f63c69bfa1514ea97a9c29e2fb1a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/38c43d3409b9f63c69bfa1514ea97a9c29e2fb1a", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into fix-25152", "committedDate": "2020-08-31T07:27:02Z", "type": "commit"}, {"oid": "7cbebd1f47e78021801025b25fb3b4fa48114ae0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7cbebd1f47e78021801025b25fb3b4fa48114ae0", "message": "Fix parser error recovery for join condition", "committedDate": "2020-08-31T08:27:40Z", "type": "commit"}, {"oid": "b703f6f7be85ed95c5af3abeecf6ab436acafb46", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b703f6f7be85ed95c5af3abeecf6ab436acafb46", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into fix-25152", "committedDate": "2020-08-31T08:38:36Z", "type": "commit"}]}