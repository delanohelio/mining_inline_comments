{"pr_number": 22961, "pr_title": "Add Union type support to new parser", "pr_createdAt": "2020-04-29T10:02:37Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961", "timeline": [{"oid": "f2fc81ea51d7c09ded316b943ff71a2dbf66d502", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f2fc81ea51d7c09ded316b943ff71a2dbf66d502", "message": "Union type descriptor support with recovery logic.", "committedDate": "2020-04-24T06:56:15Z", "type": "commit"}, {"oid": "aa4c1a3c46b36ab51b93ec91107eb23b20b6249e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/aa4c1a3c46b36ab51b93ec91107eb23b20b6249e", "message": "Added test cases for the union type", "committedDate": "2020-04-24T08:16:49Z", "type": "commit"}, {"oid": "cad479e97b1a6ba36d1157cd1a05a81518914a18", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cad479e97b1a6ba36d1157cd1a05a81518914a18", "message": "Changed next rule for VAR_DECL_STMT\n\nChanged next rule for VAR_DECL_STMT from SIMPLE_TYPE_DESCRIPTOR to TYPE_DESCRIPTOR in BallerinaParserErrorHandler", "committedDate": "2020-04-24T13:43:11Z", "type": "commit"}, {"oid": "3e5047fd4a72f44ab14b55d9378d22f5a97129dd", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3e5047fd4a72f44ab14b55d9378d22f5a97129dd", "message": "Merge branch 'incremental-parser' of https://github.com/ballerina-platform/ballerina-lang into union-type\n\n# Conflicts:\n#\tcompiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParser.java\n#\tcompiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParserErrorHandler.java\n#\tcompiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/tree/STNodeFactory.java\n#\tcompiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/syntax/tree/NodeFactory.java\n#\tcompiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/syntax/tree/NodeTransformer.java\n#\tcompiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/syntax/tree/NodeVisitor.java\n#\tcompiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/syntax/tree/SyntaxKind.java\n#\tcompiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/syntax/tree/TreeModifier.java\n#\tcompiler/ballerina-treegen/src/main/resources/syntax_tree_descriptor.json", "committedDate": "2020-04-28T08:27:57Z", "type": "commit"}, {"oid": "09b3e91fb105c0dee56e1d31cee4f4f04910ae31", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/09b3e91fb105c0dee56e1d31cee4f4f04910ae31", "message": "Merge branch 'incremental-parser' of https://github.com/ballerina-platform/ballerina-lang into union-type", "committedDate": "2020-04-28T14:40:36Z", "type": "commit"}, {"oid": "ea2f76db118922c7e01dbcd8cc98f75b8059c388", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ea2f76db118922c7e01dbcd8cc98f75b8059c388", "message": "Added getTypeDescRHS method.", "committedDate": "2020-04-29T06:45:03Z", "type": "commit"}, {"oid": "9d84560bdab649116310faf0053ac91289872a87", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9d84560bdab649116310faf0053ac91289872a87", "message": "Apply a fix and new test case for FunctionDefinitionTest.java", "committedDate": "2020-04-29T09:55:56Z", "type": "commit"}, {"oid": "51cbcb90358f81f2bcc256d21079b2986787a9d4", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/51cbcb90358f81f2bcc256d21079b2986787a9d4", "message": "Remove extra spaces.", "committedDate": "2020-04-29T09:57:42Z", "type": "commit"}, {"oid": "fc16760353f3bd8612cbfaf26dc2862a1ca86143", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fc16760353f3bd8612cbfaf26dc2862a1ca86143", "message": "Added new lines to eof.", "committedDate": "2020-04-29T10:06:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMyNTA3Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r417325073", "bodyText": "I think we should remove from L#2851-L#2867. This should be handled inside the parseStatementStartsWithIdentifier() method. Similar cases are handled in that method.", "author": "SupunS", "createdAt": "2020-04-29T13:44:06Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParser.java", "diffHunk": "@@ -2842,6 +2856,15 @@ private STNode parseStatement(SyntaxKind tokenKind, STNode annots) {\n                     finalKeyword = STNodeFactory.createEmptyNode();\n                     return parseVariableDecl(getAnnotations(annots), finalKeyword, false);\n                 }\n+                //If the nex token is pipe token then it can be unary type or compound assignment statement.\n+                if (nextToken.kind == SyntaxKind.PIPE_TOKEN) {\n+                    STToken nextNextToken = peek(3);\n+                    // if the nextNextToken is not an equal token then it is a unary type with user defined type\n+                    if (nextNextToken.kind != SyntaxKind.EQUAL_TOKEN) {\n+                        finalKeyword = STNodeFactory.createEmptyNode();\n+                        return parseVariableDecl(getAnnotations(annots), finalKeyword, false);\n+                    }\n+                }", "originalCommit": "fc16760353f3bd8612cbfaf26dc2862a1ca86143", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQzNjgyNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r417436827", "bodyText": "will look at it", "author": "rdulmina", "createdAt": "2020-04-29T16:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMyNTA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0NjM5Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r417746397", "bodyText": "Changed. Please check that change is enough.", "author": "rdulmina", "createdAt": "2020-04-30T04:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMyNTA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMyNzc4MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r417327781", "bodyText": "I feel ParserRuleContext.UNION_TYPE_DESCRIPTOR is not needed at all. Looks like it is not being used for any decision making within the error recovery. Only pushed and popped from the stack.\nCan we use ParserRuleContext.PIPE here?", "author": "SupunS", "createdAt": "2020-04-29T13:47:49Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParserErrorHandler.java", "diffHunk": "@@ -259,7 +259,8 @@\n             { ParserRuleContext.BASIC_LITERAL, ParserRuleContext.VARIABLE_REF };\n \n     private static final ParserRuleContext[] TYPEDESC_RHS = {ParserRuleContext.NON_RECURSIVE_TYPE,\n-            ParserRuleContext.ARRAY_TYPE_DESCRIPTOR, ParserRuleContext.OPTIONAL_TYPE_DESCRIPTOR };\n+            ParserRuleContext.ARRAY_TYPE_DESCRIPTOR, ParserRuleContext.OPTIONAL_TYPE_DESCRIPTOR,\n+            ParserRuleContext.UNION_TYPE_DESCRIPTOR };", "originalCommit": "fc16760353f3bd8612cbfaf26dc2862a1ca86143", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQzNjM4Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r417436387", "bodyText": "Yeh seems like we can do that. But It will affect readability.", "author": "rdulmina", "createdAt": "2020-04-29T16:10:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMyNzc4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0NjE2Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r417746162", "bodyText": "Used ParserRuleContext.PIPE and removed ParserRuleContext.UNION_TYPE_DESCRIPTOR", "author": "rdulmina", "createdAt": "2020-04-30T04:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMyNzc4MQ=="}], "type": "inlineReview"}, {"oid": "d5ce6567e00e54b2e947f506d1468bacd5ac3310", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d5ce6567e00e54b2e947f506d1468bacd5ac3310", "message": "Removed parser rule context UNION_TYPE_DESCRIPTOR.\n\nRemoved parser rule context UNION_TYPE_DESCRIPTOR. Moved union and optional type detection logic to the parseStatementStartsWithIdentifier(STNode annots) method.", "committedDate": "2020-04-30T04:13:49Z", "type": "commit"}, {"oid": "f23d22dbf0353b14a866b7750eed30dbbd313c00", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f23d22dbf0353b14a866b7750eed30dbbd313c00", "message": "Resolve conflicts and merge.", "committedDate": "2020-04-30T04:23:54Z", "type": "commit"}, {"oid": "0fcbbe758d6cd39e474f921cf9d4a5a54eb6163c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0fcbbe758d6cd39e474f921cf9d4a5a54eb6163c", "message": "Moved union and optional type detection logic to the parseStatementStartsWithIdentifier(SyntaxKind nextTokenKind, STNode annots, STNode identifier) method.", "committedDate": "2020-04-30T07:48:25Z", "type": "commit"}, {"oid": "7c0c897e123a7ba21ce474c49571e29f20b7c983", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7c0c897e123a7ba21ce474c49571e29f20b7c983", "message": "Undo test1.bal file change.", "committedDate": "2020-04-30T07:50:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0MDYzMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r418040632", "bodyText": "Can't we use parseComplexTypeDescriptor() method?\nyou'll need to extract the content out in that method to a new method like: parseComplexTypeDescriptor(SyntaxKind kind)", "author": "SupunS", "createdAt": "2020-04-30T14:12:05Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParser.java", "diffHunk": "@@ -5587,12 +5593,32 @@ private STNode parseStatementStartsWithIdentifier(SyntaxKind nextTokenKind, STNo\n             case SEMICOLON_TOKEN:\n                 // Here we directly start parsing as a statement that starts with an expression.\n                 return parseStamentStartWithExpr(nextTokenKind, identifier);\n+            case QUESTION_MARK_TOKEN:\n+                // if the next token is question-mark then it is an optional type descriptor with user defined type\n+                switchContext(ParserRuleContext.VAR_DECL_STMT);\n+                STNode questionMarkToken = parseQuestionMark();\n+                STNode optionalTypeDesc = STNodeFactory.createOptionalTypeDescriptorNode(identifier, questionMarkToken);\n+                //check whether if there is more type descriptor elements\n+                STNode typeDesc = parseComplexTypeDescriptor(optionalTypeDesc);", "originalCommit": "7c0c897e123a7ba21ce474c49571e29f20b7c983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEyNDk0OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r418124949", "bodyText": "done", "author": "rdulmina", "createdAt": "2020-04-30T16:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0MDYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0MjE4OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r418042188", "bodyText": "Similarly, can we call parseUnionTypeDescriptor() here?", "author": "SupunS", "createdAt": "2020-04-30T14:14:20Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParser.java", "diffHunk": "@@ -5587,12 +5593,32 @@ private STNode parseStatementStartsWithIdentifier(SyntaxKind nextTokenKind, STNo\n             case SEMICOLON_TOKEN:\n                 // Here we directly start parsing as a statement that starts with an expression.\n                 return parseStamentStartWithExpr(nextTokenKind, identifier);\n+            case QUESTION_MARK_TOKEN:\n+                // if the next token is question-mark then it is an optional type descriptor with user defined type\n+                switchContext(ParserRuleContext.VAR_DECL_STMT);\n+                STNode questionMarkToken = parseQuestionMark();\n+                STNode optionalTypeDesc = STNodeFactory.createOptionalTypeDescriptorNode(identifier, questionMarkToken);\n+                //check whether if there is more type descriptor elements\n+                STNode typeDesc = parseComplexTypeDescriptor(optionalTypeDesc);\n+                varName = parseVariableName();\n+                finalKeyword = STNodeFactory.createEmptyNode();\n+                return parseVarDeclRhs(annots, finalKeyword, typeDesc, varName, false);\n             default:\n                 // If its a binary operator then this can be a compound assignment statement\n                 if (isCompoundBinaryOperator(nextTokenKind)) {\n                     return parseCompoundAssignmentStmtRhs(identifier);\n                 }\n-\n+                // If its not a compound assignment statement then it can be union type desc.\n+                if (nextTokenKind == SyntaxKind.PIPE_TOKEN) {\n+                    switchContext(ParserRuleContext.VAR_DECL_STMT);\n+                    STNode pipeToken = parsePipeToken();\n+                    STNode rightTypeDesc = parseTypeDescriptor();\n+                    STNode unionTypeDesc = STNodeFactory.createUnionTypeDescriptorNode(identifier, pipeToken,\n+                            rightTypeDesc);", "originalCommit": "7c0c897e123a7ba21ce474c49571e29f20b7c983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEyNTY1Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r418125656", "bodyText": "@SupunS found a better way. Please check.", "author": "rdulmina", "createdAt": "2020-04-30T16:11:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0MjE4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0MzgzOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r418043839", "bodyText": "These three lines seems to be repeating in three places inside this method. Better to take it out as a method and re-use it.", "author": "SupunS", "createdAt": "2020-04-30T14:16:38Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParser.java", "diffHunk": "@@ -5587,12 +5593,32 @@ private STNode parseStatementStartsWithIdentifier(SyntaxKind nextTokenKind, STNo\n             case SEMICOLON_TOKEN:\n                 // Here we directly start parsing as a statement that starts with an expression.\n                 return parseStamentStartWithExpr(nextTokenKind, identifier);\n+            case QUESTION_MARK_TOKEN:\n+                // if the next token is question-mark then it is an optional type descriptor with user defined type\n+                switchContext(ParserRuleContext.VAR_DECL_STMT);\n+                STNode questionMarkToken = parseQuestionMark();\n+                STNode optionalTypeDesc = STNodeFactory.createOptionalTypeDescriptorNode(identifier, questionMarkToken);\n+                //check whether if there is more type descriptor elements\n+                STNode typeDesc = parseComplexTypeDescriptor(optionalTypeDesc);\n+                varName = parseVariableName();\n+                finalKeyword = STNodeFactory.createEmptyNode();\n+                return parseVarDeclRhs(annots, finalKeyword, typeDesc, varName, false);", "originalCommit": "7c0c897e123a7ba21ce474c49571e29f20b7c983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEyNTc1MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r418125750", "bodyText": "done", "author": "rdulmina", "createdAt": "2020-04-30T16:11:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0MzgzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0NjcxMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r418046710", "bodyText": "Shall we move this as another case in the switch-case? If the token after pipe is a = then we can fall through.\nReason is, use of  union-types is a more prominent use-case compared to compound operators. So moving this to switch case lets us exit-early.", "author": "SupunS", "createdAt": "2020-04-30T14:20:33Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParser.java", "diffHunk": "@@ -5587,12 +5593,32 @@ private STNode parseStatementStartsWithIdentifier(SyntaxKind nextTokenKind, STNo\n             case SEMICOLON_TOKEN:\n                 // Here we directly start parsing as a statement that starts with an expression.\n                 return parseStamentStartWithExpr(nextTokenKind, identifier);\n+            case QUESTION_MARK_TOKEN:\n+                // if the next token is question-mark then it is an optional type descriptor with user defined type\n+                switchContext(ParserRuleContext.VAR_DECL_STMT);\n+                STNode questionMarkToken = parseQuestionMark();\n+                STNode optionalTypeDesc = STNodeFactory.createOptionalTypeDescriptorNode(identifier, questionMarkToken);\n+                //check whether if there is more type descriptor elements\n+                STNode typeDesc = parseComplexTypeDescriptor(optionalTypeDesc);\n+                varName = parseVariableName();\n+                finalKeyword = STNodeFactory.createEmptyNode();\n+                return parseVarDeclRhs(annots, finalKeyword, typeDesc, varName, false);\n             default:\n                 // If its a binary operator then this can be a compound assignment statement\n                 if (isCompoundBinaryOperator(nextTokenKind)) {\n                     return parseCompoundAssignmentStmtRhs(identifier);\n                 }\n-\n+                // If its not a compound assignment statement then it can be union type desc.\n+                if (nextTokenKind == SyntaxKind.PIPE_TOKEN) {", "originalCommit": "7c0c897e123a7ba21ce474c49571e29f20b7c983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEyNTg1Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22961#discussion_r418125853", "bodyText": "done", "author": "rdulmina", "createdAt": "2020-04-30T16:11:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0NjcxMA=="}], "type": "inlineReview"}, {"oid": "2bfe30934a1a356fce3d6c9e3bc2b9aa95900fbe", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2bfe30934a1a356fce3d6c9e3bc2b9aa95900fbe", "message": "Changed the logic of detecting optional and union type start with user defined type.", "committedDate": "2020-04-30T16:04:42Z", "type": "commit"}]}