{"pr_number": 26693, "pr_title": "Add a multi-language extension support", "pr_createdAt": "2020-11-01T10:32:35Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/26693", "timeline": [{"oid": "2b326a82c9406d17d3e6d75bef63e62e0d1c6e4f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2b326a82c9406d17d3e6d75bef63e62e0d1c6e4f", "message": "add a multi-language extension support", "committedDate": "2020-11-01T10:02:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODY3OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26693#discussion_r515718679", "bodyText": "Specific reason to limit to one? We can merge the results from multiple filtered extensions. eg. there can be two completion extensions with the same uri pattern.", "author": "rasika", "createdAt": "2020-11-02T03:01:03Z", "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/LangExtensionDelegator.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+package org.ballerinalang.langserver;\n+\n+import org.ballerinalang.langserver.commons.CompletionExtension;\n+import org.ballerinalang.langserver.commons.DiagnosticsExtension;\n+import org.ballerinalang.langserver.commons.FormattingExtension;\n+import org.ballerinalang.langserver.commons.LSContext;\n+import org.ballerinalang.langserver.commons.LanguageExtension;\n+import org.eclipse.lsp4j.CompletionItem;\n+import org.eclipse.lsp4j.CompletionList;\n+import org.eclipse.lsp4j.CompletionParams;\n+import org.eclipse.lsp4j.DocumentFormattingParams;\n+import org.eclipse.lsp4j.PublishDiagnosticsParams;\n+import org.eclipse.lsp4j.TextEdit;\n+import org.eclipse.lsp4j.jsonrpc.messages.Either;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.ServiceLoader;\n+\n+/**\n+ * Delegate the operation to the valid extension.\n+ *\n+ * @since 2.0.0\n+ */\n+public class LangExtensionDelegator {\n+\n+    private static final LangExtensionDelegator INSTANCE = new LangExtensionDelegator();\n+\n+    private final List<CompletionExtension> completionExtensions = new ArrayList<>();\n+    private final List<FormattingExtension> formatExtensions = new ArrayList<>();\n+    private final List<DiagnosticsExtension> diagExtensions = new ArrayList<>();\n+\n+    private LangExtensionDelegator() {\n+        ServiceLoader.load(LanguageExtension.class).forEach(languageExtension -> {\n+            switch (languageExtension.kind()) {\n+                case COMPLETION:\n+                    completionExtensions.add((CompletionExtension) languageExtension);\n+                    break;\n+                case FORMAT:\n+                    formatExtensions.add((FormattingExtension) languageExtension);\n+                    break;\n+                case DIAGNOSTIC:\n+                    diagExtensions.add((DiagnosticsExtension) languageExtension);\n+                    break;\n+                default:\n+                    break;\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Get the completions.\n+     *\n+     * @param params completion parameters\n+     * @return {@link Either} completion results\n+     */\n+    public Either<List<CompletionItem>, CompletionList> completion(CompletionParams params, LSContext context) {\n+        return completionExtensions.stream().filter(ext -> ext.validate(params))\n+                .map(ext -> ext.execute(params, context))\n+                .findFirst()\n+                .orElse(Either.forRight(new CompletionList()));", "originalCommit": "2b326a82c9406d17d3e6d75bef63e62e0d1c6e4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODc1NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26693#discussion_r515718754", "bodyText": "Specific reason to limit to one? We can merge the results from multiple filtered extensions. eg. there can be two completion extensions with the same uri pattern.", "author": "rasika", "createdAt": "2020-11-02T03:01:25Z", "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/LangExtensionDelegator.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+package org.ballerinalang.langserver;\n+\n+import org.ballerinalang.langserver.commons.CompletionExtension;\n+import org.ballerinalang.langserver.commons.DiagnosticsExtension;\n+import org.ballerinalang.langserver.commons.FormattingExtension;\n+import org.ballerinalang.langserver.commons.LSContext;\n+import org.ballerinalang.langserver.commons.LanguageExtension;\n+import org.eclipse.lsp4j.CompletionItem;\n+import org.eclipse.lsp4j.CompletionList;\n+import org.eclipse.lsp4j.CompletionParams;\n+import org.eclipse.lsp4j.DocumentFormattingParams;\n+import org.eclipse.lsp4j.PublishDiagnosticsParams;\n+import org.eclipse.lsp4j.TextEdit;\n+import org.eclipse.lsp4j.jsonrpc.messages.Either;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.ServiceLoader;\n+\n+/**\n+ * Delegate the operation to the valid extension.\n+ *\n+ * @since 2.0.0\n+ */\n+public class LangExtensionDelegator {\n+\n+    private static final LangExtensionDelegator INSTANCE = new LangExtensionDelegator();\n+\n+    private final List<CompletionExtension> completionExtensions = new ArrayList<>();\n+    private final List<FormattingExtension> formatExtensions = new ArrayList<>();\n+    private final List<DiagnosticsExtension> diagExtensions = new ArrayList<>();\n+\n+    private LangExtensionDelegator() {\n+        ServiceLoader.load(LanguageExtension.class).forEach(languageExtension -> {\n+            switch (languageExtension.kind()) {\n+                case COMPLETION:\n+                    completionExtensions.add((CompletionExtension) languageExtension);\n+                    break;\n+                case FORMAT:\n+                    formatExtensions.add((FormattingExtension) languageExtension);\n+                    break;\n+                case DIAGNOSTIC:\n+                    diagExtensions.add((DiagnosticsExtension) languageExtension);\n+                    break;\n+                default:\n+                    break;\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Get the completions.\n+     *\n+     * @param params completion parameters\n+     * @return {@link Either} completion results\n+     */\n+    public Either<List<CompletionItem>, CompletionList> completion(CompletionParams params, LSContext context) {\n+        return completionExtensions.stream().filter(ext -> ext.validate(params))\n+                .map(ext -> ext.execute(params, context))\n+                .findFirst()\n+                .orElse(Either.forRight(new CompletionList()));\n+    }\n+\n+    /**\n+     * Get the formatting.\n+     *\n+     * @param params formatting parameters\n+     * @return {@link List} of text edits\n+     */\n+    public List<? extends TextEdit> formatting(DocumentFormattingParams params, LSContext context) {\n+        return formatExtensions.stream().filter(ext -> ext.validate(params))\n+                .map(ext -> ext.execute(params, context))\n+                .findFirst()\n+                .orElse(new ArrayList<>());\n+    }\n+\n+    /**\n+     * Get the Diagnostics.\n+     *\n+     * @param uri document URI\n+     * @return {@link PublishDiagnosticsParams} diagnostic params calculated\n+     */\n+    public PublishDiagnosticsParams diagnostics(String uri, LSContext context) {\n+        return diagExtensions.stream().filter(ext -> ext.validate(uri))\n+                .map(ext -> ext.execute(uri, context))\n+                .findFirst()\n+                .orElse(new PublishDiagnosticsParams());", "originalCommit": "2b326a82c9406d17d3e6d75bef63e62e0d1c6e4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcyMTg1Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26693#discussion_r515721856", "bodyText": "Yes, I added this one to force only one at this time because we need to decide whether we collect from all the extensions and if we do so, do we need a specific enable disable mechanism (Because as an example, for completions and signatures, ordering of the items matters). We need to decide that.", "author": "nadeeshaan", "createdAt": "2020-11-02T03:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NTEzMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26693#discussion_r515745131", "bodyText": "Added the aggregated result support", "author": "nadeeshaan", "createdAt": "2020-11-02T05:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODc4NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26693#discussion_r515718785", "bodyText": "Specific reason to limit to one? We can merge the results from multiple filtered extensions. eg. there can be two completion extensions with the same uri pattern.", "author": "rasika", "createdAt": "2020-11-02T03:01:38Z", "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/LangExtensionDelegator.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+package org.ballerinalang.langserver;\n+\n+import org.ballerinalang.langserver.commons.CompletionExtension;\n+import org.ballerinalang.langserver.commons.DiagnosticsExtension;\n+import org.ballerinalang.langserver.commons.FormattingExtension;\n+import org.ballerinalang.langserver.commons.LSContext;\n+import org.ballerinalang.langserver.commons.LanguageExtension;\n+import org.eclipse.lsp4j.CompletionItem;\n+import org.eclipse.lsp4j.CompletionList;\n+import org.eclipse.lsp4j.CompletionParams;\n+import org.eclipse.lsp4j.DocumentFormattingParams;\n+import org.eclipse.lsp4j.PublishDiagnosticsParams;\n+import org.eclipse.lsp4j.TextEdit;\n+import org.eclipse.lsp4j.jsonrpc.messages.Either;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.ServiceLoader;\n+\n+/**\n+ * Delegate the operation to the valid extension.\n+ *\n+ * @since 2.0.0\n+ */\n+public class LangExtensionDelegator {\n+\n+    private static final LangExtensionDelegator INSTANCE = new LangExtensionDelegator();\n+\n+    private final List<CompletionExtension> completionExtensions = new ArrayList<>();\n+    private final List<FormattingExtension> formatExtensions = new ArrayList<>();\n+    private final List<DiagnosticsExtension> diagExtensions = new ArrayList<>();\n+\n+    private LangExtensionDelegator() {\n+        ServiceLoader.load(LanguageExtension.class).forEach(languageExtension -> {\n+            switch (languageExtension.kind()) {\n+                case COMPLETION:\n+                    completionExtensions.add((CompletionExtension) languageExtension);\n+                    break;\n+                case FORMAT:\n+                    formatExtensions.add((FormattingExtension) languageExtension);\n+                    break;\n+                case DIAGNOSTIC:\n+                    diagExtensions.add((DiagnosticsExtension) languageExtension);\n+                    break;\n+                default:\n+                    break;\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Get the completions.\n+     *\n+     * @param params completion parameters\n+     * @return {@link Either} completion results\n+     */\n+    public Either<List<CompletionItem>, CompletionList> completion(CompletionParams params, LSContext context) {\n+        return completionExtensions.stream().filter(ext -> ext.validate(params))\n+                .map(ext -> ext.execute(params, context))\n+                .findFirst()\n+                .orElse(Either.forRight(new CompletionList()));\n+    }\n+\n+    /**\n+     * Get the formatting.\n+     *\n+     * @param params formatting parameters\n+     * @return {@link List} of text edits\n+     */\n+    public List<? extends TextEdit> formatting(DocumentFormattingParams params, LSContext context) {\n+        return formatExtensions.stream().filter(ext -> ext.validate(params))\n+                .map(ext -> ext.execute(params, context))\n+                .findFirst()\n+                .orElse(new ArrayList<>());", "originalCommit": "2b326a82c9406d17d3e6d75bef63e62e0d1c6e4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NTE1MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26693#discussion_r515745150", "bodyText": "fixed", "author": "nadeeshaan", "createdAt": "2020-11-02T05:21:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxOTE4MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26693#discussion_r515719181", "bodyText": "Instead of returning new ArrayList<>() for erroneous cases we can return an unmodifiable pre-declared empty list with Collections.emptyList(). This will limit ad-hoc new list objects creations. Check for other places in the PR that returns new arraylist as well.", "author": "rasika", "createdAt": "2020-11-02T03:04:01Z", "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/BallerinaTextDocumentService.java", "diffHunk": "@@ -156,14 +155,13 @@ void setClientCapabilities(LSClientCapabilities clientCapabilities) {\n \n     @Override\n     public CompletableFuture<Either<List<CompletionItem>, CompletionList>> completion(CompletionParams position) {\n-        final List<CompletionItem> completions = new ArrayList<>();\n         return CompletableFuture.supplyAsync(() -> {\n             String fileUri = position.getTextDocument().getUri();\n             Optional<Path> completionPath = CommonUtil.getPathFromURI(fileUri);\n \n             // Note: If the source is a cached stdlib source or path does not exist, then return early and ignore\n             if (completionPath.isEmpty() || CommonUtil.isCachedExternalSource(fileUri)) {\n-                return Either.forLeft(completions);\n+                return Either.forLeft(new ArrayList<>());", "originalCommit": "2b326a82c9406d17d3e6d75bef63e62e0d1c6e4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcyMTg3Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26693#discussion_r515721877", "bodyText": "+1", "author": "nadeeshaan", "createdAt": "2020-11-02T03:18:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxOTE4MQ=="}], "type": "inlineReview"}, {"oid": "f6919e578942ccf8b4acbeba12e21d1fc8daa78f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f6919e578942ccf8b4acbeba12e21d1fc8daa78f", "message": "add aggregated result support", "committedDate": "2020-11-02T05:19:36Z", "type": "commit"}]}