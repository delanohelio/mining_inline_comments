{"pr_number": 25892, "pr_title": "Add support for class related formatting and remove superfluous newlines at the end of assertion files", "pr_createdAt": "2020-09-17T14:17:10Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892", "timeline": [{"oid": "e949b176d4a3c4d6af06cf63ef74fed50ce1c65f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e949b176d4a3c4d6af06cf63ef74fed50ce1c65f", "message": "Add support for classes in formatter", "committedDate": "2020-09-15T14:16:29Z", "type": "commit"}, {"oid": "c93574c6286685889231ee0eb7287adfff58aae8", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c93574c6286685889231ee0eb7287adfff58aae8", "message": "Expand test case scenarios for class related formatting", "committedDate": "2020-09-16T10:08:09Z", "type": "commit"}, {"oid": "36c38d8a9dcfcab06a04967ca07fad7ad6752bfa", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/36c38d8a9dcfcab06a04967ca07fad7ad6752bfa", "message": "Merge branch 'master' into formatter-fixes", "committedDate": "2020-09-17T05:29:30Z", "type": "commit"}, {"oid": "b4e540382b7dbdf20cd62b5e91249224b9412c7e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b4e540382b7dbdf20cd62b5e91249224b9412c7e", "message": "Expand the testing scope of class related formatting", "committedDate": "2020-09-17T13:59:41Z", "type": "commit"}, {"oid": "f8675e90090bf6a52fb501b9cc185942fdeecb70", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f8675e90090bf6a52fb501b9cc185942fdeecb70", "message": "Merge branch 'master' into formatter-fixes", "committedDate": "2020-09-17T14:00:49Z", "type": "commit"}, {"oid": "f6b3c7d89ef748e55790d84a78e7af0a11e1abc7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f6b3c7d89ef748e55790d84a78e7af0a11e1abc7", "message": "Fix checkstyle failing issue in FormattingTreeModifier.java", "committedDate": "2020-09-17T14:33:19Z", "type": "commit"}, {"oid": "ed6a6ebf1deba2f73c9b7c92acf65be3d34a9d7e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ed6a6ebf1deba2f73c9b7c92acf65be3d34a9d7e", "message": "Add missing Javadoc comment", "committedDate": "2020-09-17T15:13:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQwMDIzMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490400231", "bodyText": "shall we use isEmpty instead of checking size equals to zero", "author": "nadeeshaan", "createdAt": "2020-09-17T16:32:18Z", "path": "misc/formatter/modules/formatter-core/src/main/java/org/ballerinalang/formatter/core/FormattingTreeModifier.java", "diffHunk": "@@ -360,8 +361,11 @@ public FunctionDefinitionNode transform(FunctionDefinitionNode functionDefinitio\n             functionDefinitionNode = functionDefinitionNode.modify()\n                     .withMetadata(metadata).apply();\n         }\n+\n+        int startColumn = qualifierList.size() == 0 ? getStartColumn(functionDefinitionNode, true) : 0;", "originalCommit": "f6b3c7d89ef748e55790d84a78e7af0a11e1abc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ1ODgwOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490458809", "bodyText": "Fixed", "author": "sanjana", "createdAt": "2020-09-17T18:09:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQwMDIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQwMzQyMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490403423", "bodyText": "since we return within each of the clauses, shall we use if clauses", "author": "nadeeshaan", "createdAt": "2020-09-17T16:37:22Z", "path": "misc/formatter/modules/formatter-core/src/main/java/org/ballerinalang/formatter/core/FormattingTreeModifier.java", "diffHunk": "@@ -3687,12 +3697,51 @@ public OrderKeyNode transform(OrderKeyNode orderKeyNode) {\n                 .apply();\n     }\n \n+    @Override\n+    public ClassDefinitionNode transform(ClassDefinitionNode classDefinitionNode) {\n+        if (!isInLineRange(classDefinitionNode, lineRange)) {\n+            return classDefinitionNode;\n+        }\n+\n+        Token visibilityQualifier = getToken(classDefinitionNode.visibilityQualifier().orElse(null));\n+        MetadataNode metadata = this.modifyNode(classDefinitionNode.metadata().orElse(null));\n+        NodeList<Token> qualifierList = this.modifyNodeList(classDefinitionNode.classTypeQualifiers());\n+        Token classKeyword = getToken(classDefinitionNode.classKeyword());\n+        Token className = getToken(classDefinitionNode.className());\n+        NodeList<Node> members = this.modifyNodeList(classDefinitionNode.members());\n+        Token openBrace = getToken(classDefinitionNode.openBrace());\n+        Token closeBrace = getToken(classDefinitionNode.closeBrace());\n+        int startColumn = getStartColumn(classDefinitionNode, true);\n+\n+        if (metadata != null) {\n+            classDefinitionNode = classDefinitionNode.modify()\n+                    .withMetadata(metadata).apply();\n+        }\n+\n+        if (visibilityQualifier != null && !visibilityQualifier.isMissing()) {\n+            classDefinitionNode = classDefinitionNode.modify()\n+                    .withVisibilityQualifier(formatToken(visibilityQualifier, startColumn, 1, 0, 0))\n+                    .apply();\n+            startColumn = 0;\n+        }\n+\n+        return classDefinitionNode.modify()\n+                .withClassKeyword(formatToken(classKeyword, startColumn, 0, 0, 0))\n+                .withClassName(formatToken(className, 1, 0, 0, 0))\n+                .withOpenBrace(formatToken(openBrace, 1, 0, 0, 1))\n+                .withCloseBrace(formatToken(closeBrace, 0, 0, 0, 1))\n+                .withClassTypeQualifiers(qualifierList)\n+                .withMembers(members)\n+                .apply();\n+    }\n+\n     @Override\n     public Token transform(Token token) {\n         int startColumn = getStartColumn(token, true);\n         if (token.kind() == (SyntaxKind.COMMA_TOKEN)) {\n             return formatToken(token, 0, 1, 0, 0);\n-        } else if (token.kind() == (SyntaxKind.PUBLIC_KEYWORD) || token.kind() == (SyntaxKind.ABSTRACT_KEYWORD)) {\n+        } else if (token.kind() == (SyntaxKind.PUBLIC_KEYWORD) || token.kind() == (SyntaxKind.ABSTRACT_KEYWORD) ||", "originalCommit": "f6b3c7d89ef748e55790d84a78e7af0a11e1abc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ3MjcxNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490472715", "bodyText": "Updated.", "author": "sanjana", "createdAt": "2020-09-17T18:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQwMzQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxMjc0Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490412743", "bodyText": "Might need a doc comment here to pass the check style.", "author": "IrushiL", "createdAt": "2020-09-17T16:51:38Z", "path": "misc/formatter/modules/formatter-core/src/test/java/org/ballerinalang/formatter/core/declarations/ClassDefinitionDeclarationsTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.ballerinalang.formatter.core.declarations;\n+\n+import org.ballerinalang.formatter.core.FormatterTest;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class ClassDefinitionDeclarationsTest extends FormatterTest {", "originalCommit": "f6b3c7d89ef748e55790d84a78e7af0a11e1abc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ2MDAyNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490460024", "bodyText": "Added the required Javadoc.", "author": "sanjana", "createdAt": "2020-09-17T18:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxMjc0Mw=="}], "type": "inlineReview"}, {"oid": "b8be917d69a8feabf5a8de86bdde22f211f6800c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b8be917d69a8feabf5a8de86bdde22f211f6800c", "message": "Merge branch 'master' into formatter-fixes-resolve-conflicts", "committedDate": "2020-09-17T17:20:28Z", "type": "commit"}, {"oid": "f80b02cf06ad4bae3b662fedfb7f01e9b779e9d7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f80b02cf06ad4bae3b662fedfb7f01e9b779e9d7", "message": "Resolve conflicts", "committedDate": "2020-09-17T18:04:13Z", "type": "commit"}, {"oid": "ebd2ae03fc1958b9c277dbe0baaa58421cc0325b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ebd2ae03fc1958b9c277dbe0baaa58421cc0325b", "message": "Merge branch 'master' into formatter-fixes", "committedDate": "2020-09-17T18:05:27Z", "type": "commit"}, {"oid": "b3484c4e2c164f51d33cb9a4fd6336f550cb435a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b3484c4e2c164f51d33cb9a4fd6336f550cb435a", "message": "Reformat the code", "committedDate": "2020-09-17T18:32:21Z", "type": "commit"}, {"oid": "961c0978f422d0fc6ab1b358cdef863e67b41174", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/961c0978f422d0fc6ab1b358cdef863e67b41174", "message": "Merge branch 'master' into formatter-fixes", "committedDate": "2020-09-17T18:33:16Z", "type": "commit"}, {"oid": "20b6415e12c5b0220fde94dbdd76b5fa6197d5ce", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/20b6415e12c5b0220fde94dbdd76b5fa6197d5ce", "message": "Reformat the code", "committedDate": "2020-09-17T18:50:58Z", "type": "commit"}, {"oid": "dd2aec6775d30e7a4f9fb16c4132e0db8dfa1700", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dd2aec6775d30e7a4f9fb16c4132e0db8dfa1700", "message": "Add missing newline character", "committedDate": "2020-09-17T19:04:32Z", "type": "commit"}, {"oid": "28cb87295a1453b5aa7cbc65421455f475674560", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/28cb87295a1453b5aa7cbc65421455f475674560", "message": "Add extra newline at the end of each class definition declaration", "committedDate": "2020-09-17T19:30:42Z", "type": "commit"}, {"oid": "882c5d894f19f8063bfdb90fd8d9ecaacaaca1e4", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/882c5d894f19f8063bfdb90fd8d9ecaacaaca1e4", "message": "Remove superfluous spaces and newlines at the end of each file and leave only with a newline character", "committedDate": "2020-09-17T20:32:14Z", "type": "commit"}, {"oid": "5c128d13051ada7ad8530e40b051dde6f982a3fd", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5c128d13051ada7ad8530e40b051dde6f982a3fd", "message": "Add blank line between empty class blocks", "committedDate": "2020-09-17T21:25:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY4MDQ4Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490680487", "bodyText": "Shall we add this method inside the formatter without altering the parser? Since this new line is something added by the formatter itself?\nWe could move this to the FormatterUtils class.", "author": "IrushiL", "createdAt": "2020-09-18T03:33:46Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/syntax/tree/SyntaxTree.java", "diffHunk": "@@ -124,6 +124,17 @@ public String toSourceCode() {\n         return rootNode.toSourceCode();\n     }\n \n+    /**", "originalCommit": "5c128d13051ada7ad8530e40b051dde6f982a3fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcwMTY0MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490701640", "bodyText": "Moved.", "author": "sanjana", "createdAt": "2020-09-18T04:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY4MDQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY4NjMwMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490686302", "bodyText": "Shall we change the actual formatter API (inside the Formatter class) output also? Since that would be what is returned to someone calling the formatter.", "author": "IrushiL", "createdAt": "2020-09-18T03:50:22Z", "path": "misc/formatter/modules/formatter-core/src/test/java/org/ballerinalang/formatter/core/FormatterTest.java", "diffHunk": "@@ -61,7 +61,7 @@ public void test(String source, String sourcePath) throws IOException {\n         SyntaxTree syntaxTree = SyntaxTree.from(textDocument);\n         SyntaxTree newSyntaxTree = Formatter.format(syntaxTree);\n         Assert.assertFalse(newSyntaxTree.hasDiagnostics());\n-        Assert.assertEquals(newSyntaxTree.toSourceCode(), getSourceText(assertFilePath));\n+        Assert.assertEquals(newSyntaxTree.toFormatterSourceCode(), getSourceText(assertFilePath));", "originalCommit": "5c128d13051ada7ad8530e40b051dde6f982a3fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcwNzk2MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490707960", "bodyText": "Done.", "author": "sanjana", "createdAt": "2020-09-18T05:19:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY4NjMwMg=="}], "type": "inlineReview"}, {"oid": "0f5c9c03c6e14566d5a43cddd5955b6d4c8457b4", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0f5c9c03c6e14566d5a43cddd5955b6d4c8457b4", "message": "Move toFormattedSourceCode() method into FormatterUtils", "committedDate": "2020-09-18T04:53:15Z", "type": "commit"}, {"oid": "240a2fd428109572bc82061ab351ffefd598ecae", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/240a2fd428109572bc82061ab351ffefd598ecae", "message": "Merge branch 'master' into formatter-fixes", "committedDate": "2020-09-18T04:54:17Z", "type": "commit"}, {"oid": "39113ce725b968750cf8654a7d372f0502f6cc63", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/39113ce725b968750cf8654a7d372f0502f6cc63", "message": "Update Formatter API to use toFormattedSourceCode() when returning a formatted string", "committedDate": "2020-09-18T05:13:57Z", "type": "commit"}, {"oid": "bc7df351f9ffe107ff07fa0fad6236451a5b6c9b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bc7df351f9ffe107ff07fa0fad6236451a5b6c9b", "message": "Merge branch 'master' into formatter-fixes", "committedDate": "2020-09-18T05:14:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcxNTk1Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25892#discussion_r490715957", "bodyText": "There are multiple places we call System.getProperty(LINE_SEPARATOR), instead of keeping just the LINE_SEPARATOR as a static field, let's keep the actual return value.", "author": "nadeeshaan", "createdAt": "2020-09-18T05:47:49Z", "path": "misc/formatter/modules/formatter-core/src/main/java/org/ballerinalang/formatter/core/FormatterUtils.java", "diffHunk": "@@ -551,6 +554,18 @@ static boolean addNewTrailingLine(NonTerminalNode parent, NonTerminalNode node)\n         return true;\n     }\n \n+    /**\n+     * Converts the syntax tree into source code, remove superfluous spaces and newlines at the ending and returns it\n+     * as a string.\n+     *\n+     * @param syntaxTree       syntaxTree\n+     * @return source code as a string\n+     */\n+    public static String toFormattedSourceCode(SyntaxTree syntaxTree) {\n+        return syntaxTree.toSourceCode().trim() +\n+                System.getProperty(LINE_SEPARATOR);", "originalCommit": "bc7df351f9ffe107ff07fa0fad6236451a5b6c9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}