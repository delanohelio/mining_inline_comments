{"pr_number": 22860, "pr_title": "Add support for fork statement incremental parser", "pr_createdAt": "2020-04-23T11:52:32Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/22860", "timeline": [{"oid": "03f4f0a4c40476ac78c4031593c959dccca51fd1", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/03f4f0a4c40476ac78c4031593c959dccca51fd1", "message": "Add fork statement support", "committedDate": "2020-04-23T10:02:46Z", "type": "commit"}, {"oid": "e673f3e3ba41f6e385faf9333e9fd71997ca40d5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e673f3e3ba41f6e385faf9333e9fd71997ca40d5", "message": "Add test", "committedDate": "2020-04-23T11:45:27Z", "type": "commit"}, {"oid": "2439bfa427013d9d92e43a23562f21fd4b51c896", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2439bfa427013d9d92e43a23562f21fd4b51c896", "message": "Add forkstatement json", "committedDate": "2020-04-23T11:46:50Z", "type": "commit"}, {"oid": "d71ecb25083e743acef947ae6ae13de4da9b09b0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d71ecb25083e743acef947ae6ae13de4da9b09b0", "message": "Merge branch 'incremental-parser' of https://github.com/ballerina-platform/ballerina-lang into incremental-parser", "committedDate": "2020-04-23T11:55:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMTk3OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22860#discussion_r415301978", "bodyText": "Please remove unnecessary newlines L#668 and L#6670", "author": "SupunS", "createdAt": "2020-04-26T12:42:48Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParser.java", "diffHunk": "@@ -6638,4 +6643,70 @@ private STNode parseLockKeyword() {\n             return sol.recoveredNode;\n         }\n     }\n+\n+    /**\n+     * Parse fork-keyword.\n+     *\n+     * @return Fork-keyword node\n+     */\n+    private STNode parseForkKeyword() {\n+        STToken token = peek();\n+        if (token.kind == SyntaxKind.FORK_KEYWORD) {\n+            return consume();\n+        } else {\n+            Solution sol = recover(token, ParserRuleContext.FORK_KEYWORD);\n+            return sol.recoveredNode;\n+        }\n+    }\n+\n+    /**\n+    * Parse multiple named worker declarations.\n+    *\n+    * @return named-worker-declarations node array\n+    */\n+    private STNode parseMultileNamedWorkerDeclarations() {\n+\n+        STToken token = peek();\n+", "originalCommit": "d71ecb25083e743acef947ae6ae13de4da9b09b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMjUxMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22860#discussion_r415302513", "bodyText": "Else throw an error. Then we know the parser has come to an invalid state, and easy to debug :)", "author": "SupunS", "createdAt": "2020-04-26T12:45:37Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParserErrorHandler.java", "diffHunk": "@@ -2187,6 +2199,17 @@ private ParserRuleContext getNextRuleForCloseBrace(int nextLookahead) {\n                     return ParserRuleContext.STATEMENT;\n                 } else if (parentCtx == ParserRuleContext.NAMED_WORKER_DECL) {\n                     endContext(); // end named-worker\n+                    parentCtx = getParentContext();\n+                    if (parentCtx == ParserRuleContext.FORK_STMT) {\n+                        nextToken = this.tokenReader.peek(nextLookahead);\n+                        switch (nextToken.kind) {\n+                            case AT_TOKEN:\n+                            case WORKER_KEYWORD:\n+                                return ParserRuleContext.NAMED_WORKER_DECL;\n+                            default:\n+                                return ParserRuleContext.CLOSE_BRACE;\n+                        }\n+                    }", "originalCommit": "d71ecb25083e743acef947ae6ae13de4da9b09b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU3OTkyMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22860#discussion_r415579920", "bodyText": "else for the if at L#2203?, its ok if the flow doesnt go through that because when doing a normal worker declaration the flow is to return a statement at that point.", "author": "m36dot", "createdAt": "2020-04-27T07:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMjUxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzQwNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22860#discussion_r415303405", "bodyText": "I feel we should make STATEMENT as the next rule. So that it will proceed even when there are other statements thought its not valid. But the parser will do that validation anyway.\nOtherwise the issue here is, if there is some additional token before the@ or worker keyword, then this will try searching for a close brace, which is kind of wrong.", "author": "SupunS", "createdAt": "2020-04-26T12:49:50Z", "path": "compiler/ballerina-parser/src/main/java/io/ballerinalang/compiler/internal/parser/BallerinaParserErrorHandler.java", "diffHunk": "@@ -2187,6 +2199,17 @@ private ParserRuleContext getNextRuleForCloseBrace(int nextLookahead) {\n                     return ParserRuleContext.STATEMENT;\n                 } else if (parentCtx == ParserRuleContext.NAMED_WORKER_DECL) {\n                     endContext(); // end named-worker\n+                    parentCtx = getParentContext();\n+                    if (parentCtx == ParserRuleContext.FORK_STMT) {\n+                        nextToken = this.tokenReader.peek(nextLookahead);\n+                        switch (nextToken.kind) {\n+                            case AT_TOKEN:\n+                            case WORKER_KEYWORD:\n+                                return ParserRuleContext.NAMED_WORKER_DECL;\n+                            default:\n+                                return ParserRuleContext.CLOSE_BRACE;", "originalCommit": "d71ecb25083e743acef947ae6ae13de4da9b09b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU3NDc2MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22860#discussion_r415574760", "bodyText": "yea that makes more sense, will change it to statement.", "author": "m36dot", "createdAt": "2020-04-27T07:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzc2Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22860#discussion_r415303762", "bodyText": "add version", "author": "SupunS", "createdAt": "2020-04-26T12:51:23Z", "path": "compiler/ballerina-parser/src/test/java/io/ballerinalang/compiler/parser/test/syntax/statements/ForkStatement.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.ballerinalang.compiler.parser.test.syntax.statements;\n+\n+import org.testng.annotations.Test;\n+\n+/**\n+ * Test parsing Fork Statements.\n+ */", "originalCommit": "d71ecb25083e743acef947ae6ae13de4da9b09b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzg4OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22860#discussion_r415303889", "bodyText": "Class name should be LockStatementTest", "author": "SupunS", "createdAt": "2020-04-26T12:52:04Z", "path": "compiler/ballerina-parser/src/test/java/io/ballerinalang/compiler/parser/test/syntax/statements/LockStatement.java", "diffHunk": "@@ -20,7 +20,7 @@\n import org.testng.annotations.Test;\n \n /**\n- * Test parsing object type definitions.\n+ * Test parsing Lock statements.", "originalCommit": "d71ecb25083e743acef947ae6ae13de4da9b09b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzkxNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22860#discussion_r415303914", "bodyText": "Should be ForkStatementTest", "author": "SupunS", "createdAt": "2020-04-26T12:52:17Z", "path": "compiler/ballerina-parser/src/test/java/io/ballerinalang/compiler/parser/test/syntax/statements/ForkStatement.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.ballerinalang.compiler.parser.test.syntax.statements;\n+\n+import org.testng.annotations.Test;\n+\n+/**\n+ * Test parsing Fork Statements.\n+ */\n+public class ForkStatement extends AbstractStatementTest {", "originalCommit": "d71ecb25083e743acef947ae6ae13de4da9b09b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "01ddf7f42d83c11d8d0d597294176b80787ff042", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/01ddf7f42d83c11d8d0d597294176b80787ff042", "message": "Fix recovery for ForkStatement and some typos", "committedDate": "2020-04-27T07:54:44Z", "type": "commit"}, {"oid": "eae2496c643a4ceccd0e76dca59f6f45c421a65d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/eae2496c643a4ceccd0e76dca59f6f45c421a65d", "message": "Fix merge conflict", "committedDate": "2020-04-27T08:16:20Z", "type": "commit"}]}