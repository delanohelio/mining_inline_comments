{"pr_number": 25378, "pr_title": "Add fromJsonFloatString and fromJsonDecimalString langlib functions for value", "pr_createdAt": "2020-08-23T05:21:00Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378", "timeline": [{"oid": "4e8493ed626cacd8d844f79b85aa9b8f72aebf97", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4e8493ed626cacd8d844f79b85aa9b8f72aebf97", "message": "Add fromJsonFloatString and fromJsonDecimalString functions for value", "committedDate": "2020-08-23T05:01:29Z", "type": "commit"}, {"oid": "263568010bb6189acce197f1b6168708a066784c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/263568010bb6189acce197f1b6168708a066784c", "message": "Refactor processNonStringValue function in JSONParser", "committedDate": "2020-08-23T06:40:57Z", "type": "commit"}, {"oid": "8fa6b883161f728c13d4021026c6ab756791697d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8fa6b883161f728c13d4021026c6ab756791697d", "message": "Add tests for fromJsonFloatString and fromJsonDecimalString", "committedDate": "2020-08-23T06:41:07Z", "type": "commit"}, {"oid": "8fa6b883161f728c13d4021026c6ab756791697d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8fa6b883161f728c13d4021026c6ab756791697d", "message": "Add tests for fromJsonFloatString and fromJsonDecimalString", "committedDate": "2020-08-23T06:41:07Z", "type": "forcePushed"}, {"oid": "d3c2fa78294e260469de8887289a32643f7b22d6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d3c2fa78294e260469de8887289a32643f7b22d6", "message": "Add support for decimal values in JSON", "committedDate": "2020-08-23T18:55:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTMyMTQyNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r475321426", "bodyText": "We don't need !fromJsonFloatStringMode in first if condition due to second if else condition fromJsonFloatStringMode.", "author": "KRVPerera", "createdAt": "2020-08-24T03:22:57Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -874,28 +875,49 @@ private void processNonStringValue(ValueType type) throws JsonParserException {\n                     }\n                 } else {\n                     try {\n-                        long longValue = Long.parseLong(str);\n-                        switch (type) {\n-                            case ARRAY_ELEMENT:\n-                                ((ArrayValue) this.currentJsonNode).append(longValue);\n-                                break;\n-                            case FIELD:\n-                                ((MapValueImpl<BString, Object>) this.currentJsonNode).put(\n-                                        StringUtils.fromString(this.fieldNames.pop()), longValue);\n-                                break;\n-                            case VALUE:\n-                                currentJsonNode = longValue;\n-                                break;\n-                            default:\n-                                break;\n+                        if (ch == '-' && !fromJsonFloatStringMode && !fromJsonDecimalStringMode && isZero(str)) {", "originalCommit": "d3c2fa78294e260469de8887289a32643f7b22d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4Njc1Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r475586752", "bodyText": "Fixed.", "author": "chiranSachintha", "createdAt": "2020-08-24T13:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTMyMTQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTMyMTUzNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r475321537", "bodyText": "We don't need !fromJsonFloatStringMode in first if condition due to second if else condition fromJsonFloatStringMode.", "author": "KRVPerera", "createdAt": "2020-08-24T03:23:31Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -806,23 +809,21 @@ public State transition(StateMachine sm, char[] buff, int i, int count) throws J\n         private void processNonStringValue(ValueType type) throws JsonParserException {\n             String str = value();\n             if (str.indexOf('.') >= 0) {\n+                char ch = str.charAt(0);\n                 try {\n-                    double doubleValue = Double.parseDouble(str);\n-                    switch (type) {\n-                        case ARRAY_ELEMENT:\n-                            ((ArrayValue) this.currentJsonNode).append(doubleValue);\n-                            break;\n-                        case FIELD:\n-                            ((MapValueImpl<BString, Object>) this.currentJsonNode).put(\n-                                    StringUtils.fromString(this.fieldNames.pop()), doubleValue);\n-                            break;\n-                        case VALUE:\n-                            currentJsonNode = doubleValue;\n-                            break;\n-                        default:\n-                            break;\n+                    if (ch == '-' && !fromJsonFloatStringMode && !fromJsonDecimalStringMode && isZero(str)) {", "originalCommit": "d3c2fa78294e260469de8887289a32643f7b22d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4NjU4OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r475586588", "bodyText": "Fixed", "author": "chiranSachintha", "createdAt": "2020-08-24T13:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTMyMTUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTMyMzE2OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r475323169", "bodyText": "not sure a static state variable is a good idea. And to properly set it to false we may need to set it to false when there is an exception also.\nAlso when the condition str.equals(\"null\") is true we forget to set it back to false.", "author": "KRVPerera", "createdAt": "2020-08-24T03:30:50Z", "path": "langlib/lang.value/src/main/java/org/ballerinalang/langlib/value/FromJsonFloatString.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ *   Copyright (c) 2019, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.ballerinalang.langlib.value;\n+\n+import org.ballerinalang.jvm.BallerinaErrors;\n+import org.ballerinalang.jvm.JSONParser;\n+import org.ballerinalang.jvm.scheduling.Strand;\n+import org.ballerinalang.jvm.util.exceptions.BallerinaException;\n+import org.ballerinalang.jvm.values.api.BString;\n+import org.ballerinalang.model.types.TypeKind;\n+import org.ballerinalang.natives.annotations.Argument;\n+import org.ballerinalang.natives.annotations.BallerinaFunction;\n+import org.ballerinalang.natives.annotations.ReturnType;\n+\n+import static org.ballerinalang.util.BLangCompilerConstants.VALUE_VERSION;\n+\n+/**\n+ * Parse a string in JSON format and return the the value that it represents.\n+ * All numbers in the JSON will be represented as float values.\n+ */\n+\n+@BallerinaFunction(\n+        orgName = \"ballerina\", packageName = \"lang.value\", version = VALUE_VERSION,\n+        functionName = \"fromJsonFloatString\",\n+        args = {@Argument(name = \"str\", type = TypeKind.STRING)},\n+        returnType = {@ReturnType(type = TypeKind.JSON), @ReturnType(type = TypeKind.ERROR)},\n+        isPublic = true\n+)\n+\n+public class FromJsonFloatString {\n+\n+    public static Object fromJsonFloatString(Strand strand, BString value) {\n+\n+        JSONParser.fromJsonFloatStringMode = true;", "originalCommit": "d3c2fa78294e260469de8887289a32643f7b22d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI0NTE2Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r477245166", "bodyText": "Changed", "author": "chiranSachintha", "createdAt": "2020-08-26T12:00:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTMyMzE2OQ=="}], "type": "inlineReview"}, {"oid": "ef9d6b538c6d3bac94fb0a1562fd8f0d4a7f8898", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ef9d6b538c6d3bac94fb0a1562fd8f0d4a7f8898", "message": "Fix review suggestions", "committedDate": "2020-08-24T13:05:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYzMzUyMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r476633521", "bodyText": "Can't we merge these two conditions, it seems that same this is doing in both cases.", "author": "KavinduZoysa", "createdAt": "2020-08-25T17:52:55Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -806,23 +809,21 @@ public State transition(StateMachine sm, char[] buff, int i, int count) throws J\n         private void processNonStringValue(ValueType type) throws JsonParserException {\n             String str = value();\n             if (str.indexOf('.') >= 0) {\n+                char ch = str.charAt(0);\n                 try {\n-                    double doubleValue = Double.parseDouble(str);\n-                    switch (type) {\n-                        case ARRAY_ELEMENT:\n-                            ((ArrayValue) this.currentJsonNode).append(doubleValue);\n-                            break;\n-                        case FIELD:\n-                            ((MapValueImpl<BString, Object>) this.currentJsonNode).put(\n-                                    StringUtils.fromString(this.fieldNames.pop()), doubleValue);\n-                            break;\n-                        case VALUE:\n-                            currentJsonNode = doubleValue;\n-                            break;\n-                        default:\n-                            break;\n+                    if (ch == '-' && !fromJsonDecimalStringMode && isZero(str)) {\n+                        double doubleValue = Double.parseDouble(str);\n+                        setValueToJsonType(type, doubleValue);\n+                    } else if (fromJsonFloatStringMode) {\n+                        double doubleValue = Double.parseDouble(str);\n+                        setValueToJsonType(type, doubleValue);", "originalCommit": "ef9d6b538c6d3bac94fb0a1562fd8f0d4a7f8898", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI0NTM1MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r477245351", "bodyText": "Changed", "author": "chiranSachintha", "createdAt": "2020-08-26T12:00:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYzMzUyMQ=="}], "type": "inlineReview"}, {"oid": "b979acf04ea612ee9d385a44db32f6dfa657b18f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b979acf04ea612ee9d385a44db32f6dfa657b18f", "message": "Fix review suggestions", "committedDate": "2020-08-26T11:46:53Z", "type": "commit"}, {"oid": "b979acf04ea612ee9d385a44db32f6dfa657b18f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b979acf04ea612ee9d385a44db32f6dfa657b18f", "message": "Fix review suggestions", "committedDate": "2020-08-26T11:46:53Z", "type": "forcePushed"}, {"oid": "f511ab3405eca0e8208adc340e48b72923a91451", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f511ab3405eca0e8208adc340e48b72923a91451", "message": "fix lang server test fails", "committedDate": "2020-08-27T02:38:41Z", "type": "commit"}, {"oid": "2354669bc22a5b40e53a480b309c7f100b85ff15", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2354669bc22a5b40e53a480b309c7f100b85ff15", "message": "Merge pull request #2 from nadeeshaan/issue-25341\n\nFix lang server test fails", "committedDate": "2020-08-27T03:24:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc4NDExMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r481784113", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param mode    set the mode which process numeric values\n          \n          \n            \n                 * @param mode    the mode to use when processing numeric values", "author": "MaryamZi", "createdAt": "2020-09-02T06:28:45Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -93,6 +101,18 @@ public static Object parse(String jsonStr) throws BallerinaException {\n         return parse(new StringReader(jsonStr));\n     }\n \n+    /**\n+     * Parses the contents in the given string and returns a json.\n+     *\n+     * @param jsonStr the string which contains the JSON content\n+     * @param mode    set the mode which process numeric values", "originalCommit": "2354669bc22a5b40e53a480b309c7f100b85ff15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5NDk2Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r484194967", "bodyText": "Fixed", "author": "chiranSachintha", "createdAt": "2020-09-07T05:49:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc4NDExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc4NDM5OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r481784398", "bodyText": "Shall we say\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return JSON structure\n          \n          \n            \n                 * @return JSON value if parsing is successful", "author": "MaryamZi", "createdAt": "2020-09-02T06:29:08Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -93,6 +101,18 @@ public static Object parse(String jsonStr) throws BallerinaException {\n         return parse(new StringReader(jsonStr));\n     }\n \n+    /**\n+     * Parses the contents in the given string and returns a json.\n+     *\n+     * @param jsonStr the string which contains the JSON content\n+     * @param mode    set the mode which process numeric values\n+     * @return JSON structure", "originalCommit": "2354669bc22a5b40e53a480b309c7f100b85ff15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5NDkwNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r484194907", "bodyText": "Fixed", "author": "chiranSachintha", "createdAt": "2020-09-07T05:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc4NDM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc4NTk2Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r481785966", "bodyText": "This method seems to duplicate the logic in org.ballerinalang.jvm.JSONParser#parse(java.io.Reader). Shall we call this method from that by passing the default mode as the second arg?", "author": "MaryamZi", "createdAt": "2020-09-02T06:31:16Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -118,6 +138,26 @@ public static Object parse(Reader reader) throws BallerinaException {\n         }\n     }\n \n+    /**\n+     * Parses the contents in the given {@link Reader} and returns a json.\n+     *\n+     * @param reader reader which contains the JSON content\n+     * @param mode   set the mode which process numeric values\n+     * @return JSON structure\n+     * @throws BallerinaException for any parsing error\n+     */\n+    public static Object parse(Reader reader, NonStringValueProcessingMode mode) throws BallerinaException {", "originalCommit": "2354669bc22a5b40e53a480b309c7f100b85ff15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5NDgwNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r484194805", "bodyText": "Changed", "author": "chiranSachintha", "createdAt": "2020-09-07T05:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc4NTk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1MzMyNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r481853327", "bodyText": "Would this static variable approach work with concurrent invocations of functions that use the JSON parser? We seem to be updating this via instance methods.", "author": "MaryamZi", "createdAt": "2020-09-02T07:55:05Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -181,6 +221,7 @@ public JsonParserException(String msg) {\n                 new StringFieldUnicodeHexProcessingState();\n         private static final State STRING_VALUE_UNICODE_HEX_PROCESSING_STATE =\n                 new StringValueUnicodeHexProcessingState();\n+        private static NonStringValueProcessingMode mode = NonStringValueProcessingMode.FROM_JSON_STRING;", "originalCommit": "2354669bc22a5b40e53a480b309c7f100b85ff15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI4MjQ3OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r484282478", "bodyText": "Changed it as a non-static variable.", "author": "chiranSachintha", "createdAt": "2020-09-07T08:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1MzMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1NTgyNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r481855825", "bodyText": "Since we only use this in conjunction with ch == '-', IMO, we can change this method to something like isNegativeZero, and bring the ch == '-' check also into this method.", "author": "MaryamZi", "createdAt": "2020-09-02T07:57:51Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -896,6 +939,27 @@ private void processNonStringValue(ValueType type) throws JsonParserException {\n             }\n         }\n \n+        private void setValueToJsonType(ValueType type, Object value) {\n+            switch (type) {\n+                case ARRAY_ELEMENT:\n+                    ((ArrayValue) this.currentJsonNode).append(value);\n+                    break;\n+                case FIELD:\n+                    ((MapValueImpl<BString, Object>) this.currentJsonNode).put(\n+                            StringUtils.fromString(this.fieldNames.pop()), value);\n+                    break;\n+                case VALUE:\n+                    currentJsonNode = value;\n+                    break;\n+                default:\n+                    break;\n+            }\n+        }\n+\n+        private boolean isZero(String str) {", "originalCommit": "2354669bc22a5b40e53a480b309c7f100b85ff15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5NDcyOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r484194729", "bodyText": "Changed", "author": "chiranSachintha", "createdAt": "2020-09-07T05:48:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1NTgyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1NzEwMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r481857102", "bodyText": "Do we need a separate variable for this? If we do, IMO, it has to be final.", "author": "MaryamZi", "createdAt": "2020-09-02T07:59:17Z", "path": "langlib/lang.value/src/main/java/org/ballerinalang/langlib/value/FromJsonDecimalString.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ *   Copyright (c) 2019, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.ballerinalang.langlib.value;\n+\n+import org.ballerinalang.jvm.BallerinaErrors;\n+import org.ballerinalang.jvm.JSONParser;\n+import org.ballerinalang.jvm.scheduling.Strand;\n+import org.ballerinalang.jvm.util.exceptions.BallerinaException;\n+import org.ballerinalang.jvm.values.api.BString;\n+import org.ballerinalang.model.types.TypeKind;\n+import org.ballerinalang.natives.annotations.Argument;\n+import org.ballerinalang.natives.annotations.BallerinaFunction;\n+import org.ballerinalang.natives.annotations.ReturnType;\n+\n+import static org.ballerinalang.util.BLangCompilerConstants.VALUE_VERSION;\n+\n+/**\n+ * Parse a string in JSON format and return the the value that it represents.\n+ * All numbers in the JSON will be represented as decimal values.\n+ */\n+\n+@BallerinaFunction(\n+        orgName = \"ballerina\", packageName = \"lang.value\", version = VALUE_VERSION,\n+        functionName = \"fromJsonDecimalString\",\n+        args = {@Argument(name = \"str\", type = TypeKind.STRING)},\n+        returnType = {@ReturnType(type = TypeKind.JSON), @ReturnType(type = TypeKind.ERROR)},\n+        isPublic = true\n+)\n+\n+public class FromJsonDecimalString {\n+\n+    public static Object fromJsonDecimalString(Strand strand, BString value) {\n+\n+        JSONParser.NonStringValueProcessingMode mode = JSONParser.NonStringValueProcessingMode.FROM_JSON_DECIMAL_STRING;", "originalCommit": "2354669bc22a5b40e53a480b309c7f100b85ff15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5NDUzMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r484194531", "bodyText": "Removed that variable.", "author": "chiranSachintha", "createdAt": "2020-09-07T05:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1NzEwMg=="}], "type": "inlineReview"}, {"oid": "8d9b2b7f62c6c16d78ccfa22790c8115c831904b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8d9b2b7f62c6c16d78ccfa22790c8115c831904b", "message": "Fix review suggestions", "committedDate": "2020-09-07T05:45:22Z", "type": "commit"}, {"oid": "69307e47af6918b273067e8c33247a51917fb8cc", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/69307e47af6918b273067e8c33247a51917fb8cc", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into issue-25341\n\n\u0001 Conflicts:\n\u0001\tstdlib/database/sql/src/main/java/org/ballerinalang/sql/utils/RecordIteratorUtils.java", "committedDate": "2020-09-07T06:26:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzNDQ2OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r485534468", "bodyText": "Shall we document these fields since these modes aren't quite intuitive when it comes to the JSONParser?", "author": "MaryamZi", "createdAt": "2020-09-09T11:21:56Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -53,6 +54,13 @@ public StateMachine initialValue() {\n         }\n     };\n \n+    /**\n+     * Represents the modes which process numeric values.\n+     */\n+    public enum NonStringValueProcessingMode {\n+        FROM_JSON_STRING, FROM_JSON_FLOAT_STRING, FROM_JSON_DECIMAL_STRING", "originalCommit": "69307e47af6918b273067e8c33247a51917fb8cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY1NTYwNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r487655606", "bodyText": "Added.", "author": "chiranSachintha", "createdAt": "2020-09-14T05:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzNDQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzOTE0Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r485539146", "bodyText": "Still not sure if we can set the mode directly to the state machine even though it is a thread local variable since we can have a scenario with multiple workers on the same thread?", "author": "MaryamZi", "createdAt": "2020-09-09T11:31:27Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -107,8 +128,9 @@ private static Object changeForBString(Object jsonObj) {\n      * @return JSON structure\n      * @throws BallerinaException for any parsing error\n      */\n-    public static Object parse(Reader reader) throws BallerinaException {\n+    public static Object parse(Reader reader, NonStringValueProcessingMode mode) throws BallerinaException {\n         StateMachine sm = tlStateMachine.get();\n+        sm.mode = mode;", "originalCommit": "69307e47af6918b273067e8c33247a51917fb8cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIxNzQyMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r487217420", "bodyText": "Looking at reset method I don't believe parser is created to be used by two workers on same thread.\n\n  \n    \n      ballerina-lang/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java\n    \n    \n         Line 202\n      in\n      4babdba\n    \n    \n    \n    \n\n        \n          \n           public void reset() {", "author": "KRVPerera", "createdAt": "2020-09-11T18:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzOTE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc3MDA1OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r488770058", "bodyText": "Yeah, we'll have to verify this and introduce changes if required.\nI guess we can go ahead with Chiran's changes for the time-being if this is an issue in general, but let's verify first.", "author": "MaryamZi", "createdAt": "2020-09-15T15:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzOTE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE0ODgyMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r489148822", "bodyText": "@manuranga  Any suggestions?", "author": "chiranSachintha", "createdAt": "2020-09-16T04:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzOTE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE5MTcxMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r489191713", "bodyText": "Ballerina schedule will reuse the same thread for multiple workers, but it uses a non-preemptive strategy. That is, we only yield and resume strands at given points. Since there are no resume points inside extern  code, java method should execute from the top each time (ie, atomic).\nTherefor, thread local state should be safe.", "author": "manuranga", "createdAt": "2020-09-16T06:25:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzOTE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM1MDkwNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r489350906", "bodyText": "@chiranSachintha any workaround for adhering to this breaking API change. And please add the API doc description for this new param.", "author": "BuddhiWathsala", "createdAt": "2020-09-16T11:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzOTE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ4ODE0Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r489488143", "bodyText": "@manuranga, ack, thank you!", "author": "MaryamZi", "createdAt": "2020-09-16T14:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzOTE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE4Mjg2Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r490182866", "bodyText": "@chiranSachintha any workaround for adhering to this breaking API change. And please add the API doc description for this new param.\n\nFixed with this PR (#25881)", "author": "chiranSachintha", "createdAt": "2020-09-17T11:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzOTE0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzOTYzMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r485539630", "bodyText": "Is this used?", "author": "MaryamZi", "createdAt": "2020-09-09T11:32:21Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -806,20 +830,21 @@ public State transition(StateMachine sm, char[] buff, int i, int count) throws J\n         private void processNonStringValue(ValueType type) throws JsonParserException {\n             String str = value();\n             if (str.indexOf('.') >= 0) {\n+                char ch = str.charAt(0);", "originalCommit": "69307e47af6918b273067e8c33247a51917fb8cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY1NTUyNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r487655525", "bodyText": "No, Removed", "author": "chiranSachintha", "createdAt": "2020-09-14T05:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzOTYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU0MzE1OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r485543158", "bodyText": "Can't we make this the default case and remove the one below?", "author": "MaryamZi", "createdAt": "2020-09-09T11:38:54Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -896,6 +921,27 @@ private void processNonStringValue(ValueType type) throws JsonParserException {\n             }\n         }\n \n+        private void setValueToJsonType(ValueType type, Object value) {\n+            switch (type) {\n+                case ARRAY_ELEMENT:\n+                    ((ArrayValue) this.currentJsonNode).append(value);\n+                    break;\n+                case FIELD:\n+                    ((MapValueImpl<BString, Object>) this.currentJsonNode).put(\n+                            StringUtils.fromString(this.fieldNames.pop()), value);\n+                    break;\n+                case VALUE:", "originalCommit": "69307e47af6918b273067e8c33247a51917fb8cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY1NTM5OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r487655399", "bodyText": "Changed", "author": "chiranSachintha", "createdAt": "2020-09-14T05:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU0MzE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU0NTc3Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r485545772", "bodyText": "The prefix we use usually indicates the langlib module the error originates from, so in this case it has to be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return BallerinaErrors.createError(\"{ballerina}FromJsonDecimalStringError\", e.getMessage());\n          \n          \n            \n                        return BallerinaErrors.createError(\"{ballerina/lang.value}FromJsonDecimalStringError\", e.getMessage());\n          \n      \n    \n    \n  \n\nfromJsonString also seems to have just {ballerina}.", "author": "MaryamZi", "createdAt": "2020-09-09T11:43:56Z", "path": "langlib/lang.value/src/main/java/org/ballerinalang/langlib/value/FromJsonDecimalString.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ *   Copyright (c) 2019, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.ballerinalang.langlib.value;\n+\n+import org.ballerinalang.jvm.BallerinaErrors;\n+import org.ballerinalang.jvm.JSONParser;\n+import org.ballerinalang.jvm.scheduling.Strand;\n+import org.ballerinalang.jvm.util.exceptions.BallerinaException;\n+import org.ballerinalang.jvm.values.api.BString;\n+import org.ballerinalang.model.types.TypeKind;\n+import org.ballerinalang.natives.annotations.Argument;\n+import org.ballerinalang.natives.annotations.BallerinaFunction;\n+import org.ballerinalang.natives.annotations.ReturnType;\n+\n+import static org.ballerinalang.util.BLangCompilerConstants.VALUE_VERSION;\n+\n+/**\n+ * Parse a string in JSON format and return the the value that it represents.\n+ * All numbers in the JSON will be represented as decimal values.\n+ */\n+\n+@BallerinaFunction(\n+        orgName = \"ballerina\", packageName = \"lang.value\", version = VALUE_VERSION,\n+        functionName = \"fromJsonDecimalString\",\n+        args = {@Argument(name = \"str\", type = TypeKind.STRING)},\n+        returnType = {@ReturnType(type = TypeKind.JSON), @ReturnType(type = TypeKind.ERROR)},\n+        isPublic = true\n+)\n+\n+public class FromJsonDecimalString {\n+\n+    public static Object fromJsonDecimalString(Strand strand, BString value) {\n+\n+        String str = value.getValue();\n+        if (str.equals(\"null\")) {\n+            return null;\n+        }\n+        try {\n+            return JSONParser.parse(str, JSONParser.NonStringValueProcessingMode.FROM_JSON_DECIMAL_STRING);\n+        } catch (BallerinaException e) {\n+            return BallerinaErrors.createError(\"{ballerina}FromJsonDecimalStringError\", e.getMessage());", "originalCommit": "69307e47af6918b273067e8c33247a51917fb8cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY1NTI4OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r487655289", "bodyText": "Changed", "author": "chiranSachintha", "createdAt": "2020-09-14T05:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU0NTc3Mg=="}], "type": "inlineReview"}, {"oid": "d3467730b4ee01d91493e19f9c98c3df54fccbca", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d3467730b4ee01d91493e19f9c98c3df54fccbca", "message": "Fix review suggestions", "committedDate": "2020-09-14T05:11:15Z", "type": "commit"}, {"oid": "2a22c00344ee1dc34b462f7560c1c91f0fba0e92", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2a22c00344ee1dc34b462f7560c1c91f0fba0e92", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into issue-25341", "committedDate": "2020-09-15T08:48:13Z", "type": "commit"}, {"oid": "33a2d5e0319784f974865b67ae9e4ca8760d910f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/33a2d5e0319784f974865b67ae9e4ca8760d910f", "message": "fix failing lang server tests", "committedDate": "2020-09-15T09:05:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MTM4MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r488741381", "bodyText": "We can document this at field level.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /**\n          \n          \n            \n                 * Represents the modes which process numeric values.\n          \n          \n            \n                 * FROM_JSON_STRING convert numeric values that starts with minus(-) and numerically equal zero(0) to -0.0f, numeric\n          \n          \n            \n                 * values that is syntactically an integer to int and all other numeric values to decimal while converting a string\n          \n          \n            \n                 * to JSON\n          \n          \n            \n                 * FROM_JSON_FLOAT_STRING convert all numerical values to float while converting a string to JSON\n          \n          \n            \n                 * FROM_JSON_DECIMAL_STRING convert all numerical values to decimal while converting a string to JSON\n          \n          \n            \n                 */\n          \n          \n            \n                public enum NonStringValueProcessingMode {\n          \n          \n            \n                    FROM_JSON_STRING, FROM_JSON_FLOAT_STRING, FROM_JSON_DECIMAL_STRING\n          \n          \n            \n                }\n          \n          \n            \n                /**\n          \n          \n            \n                 * Represents the modes which process numeric values while converting a string to JSON.\n          \n          \n            \n                 */\n          \n          \n            \n                public enum NonStringValueProcessingMode {\n          \n          \n            \n                    /**\n          \n          \n            \n                     * FROM_JSON_STRING converts a numeric value that\n          \n          \n            \n                     * - starts with the negative sign (-) and is numerically equal to zero (0) to `-0.0f`\n          \n          \n            \n                     * - is syntactically an integer to an `int`\n          \n          \n            \n                     * - doesn't belong to the above to decimal.\n          \n          \n            \n                     */\n          \n          \n            \n                    FROM_JSON_STRING,\n          \n          \n            \n            \n          \n          \n            \n                    /**\n          \n          \n            \n                     * FROM_JSON_FLOAT_STRING converts all numerical values to float.\n          \n          \n            \n                     */\n          \n          \n            \n                    FROM_JSON_FLOAT_STRING,\n          \n          \n            \n            \n          \n          \n            \n                    /**\n          \n          \n            \n                     * FROM_JSON_DECIMAL_STRING converts all numerical values to decimal.\n          \n          \n            \n                     */\n          \n          \n            \n                    FROM_JSON_DECIMAL_STRING\n          \n          \n            \n                }\n          \n      \n    \n    \n  \n\nSuggested a few changes to the documentation itself too.", "author": "MaryamZi", "createdAt": "2020-09-15T15:04:00Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/JSONParser.java", "diffHunk": "@@ -53,6 +54,18 @@ public StateMachine initialValue() {\n         }\n     };\n \n+    /**\n+     * Represents the modes which process numeric values.\n+     * FROM_JSON_STRING convert numeric values that starts with minus(-) and numerically equal zero(0) to -0.0f, numeric\n+     * values that is syntactically an integer to int and all other numeric values to decimal while converting a string\n+     * to JSON\n+     * FROM_JSON_FLOAT_STRING convert all numerical values to float while converting a string to JSON\n+     * FROM_JSON_DECIMAL_STRING convert all numerical values to decimal while converting a string to JSON\n+     */\n+    public enum NonStringValueProcessingMode {\n+        FROM_JSON_STRING, FROM_JSON_FLOAT_STRING, FROM_JSON_DECIMAL_STRING\n+    }", "originalCommit": "33a2d5e0319784f974865b67ae9e4ca8760d910f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE4MzA1NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25378#discussion_r490183054", "bodyText": "Changed", "author": "chiranSachintha", "createdAt": "2020-09-17T11:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MTM4MQ=="}], "type": "inlineReview"}]}