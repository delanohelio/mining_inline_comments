{"pr_number": 22401, "pr_title": "Add MIME features to Email Connector", "pr_createdAt": "2020-04-01T13:17:27Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401", "timeline": [{"oid": "bb7cd2fd4ae441ac83b170e94e9fba2ee37d84f3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bb7cd2fd4ae441ac83b170e94e9fba2ee37d84f3", "message": "Add MIME features to Email Connector", "committedDate": "2020-04-01T13:05:10Z", "type": "commit"}, {"oid": "b8c69192c1f000632f4968e825be23e81118c981", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b8c69192c1f000632f4968e825be23e81118c981", "message": "Add build file changes", "committedDate": "2020-04-01T13:26:22Z", "type": "commit"}, {"oid": "04bc10d56a07798ab295bbd16d2ce4f1d857aab0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/04bc10d56a07798ab295bbd16d2ce4f1d857aab0", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into mime", "committedDate": "2020-04-01T13:29:35Z", "type": "commit"}, {"oid": "be6013d0d6b28e51cbd28a8e0557161163c46f18", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/be6013d0d6b28e51cbd28a8e0557161163c46f18", "message": "Update a dependency version", "committedDate": "2020-04-01T14:11:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxNzcwNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r401717705", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return string != null && !string.equals(\"\");\n          \n          \n            \n                    return string != null && !string.isEmpty();", "author": "chamil321", "createdAt": "2020-04-01T15:45:57Z", "path": "stdlib/email/src/main/java/org/ballerinalang/stdlib/email/util/SmtpUtil.java", "diffHunk": "@@ -125,4 +225,8 @@ private static String getNullCheckedString(String string) {\n         return string == null ? \"\" : string;\n     }\n \n+    private static boolean stringIsNotNullOrEmpty(String string) {\n+        return string != null && !string.equals(\"\");", "originalCommit": "be6013d0d6b28e51cbd28a8e0557161163c46f18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxODA1NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r401718055", "bodyText": "May be we can rename the variable name as well", "author": "chamil321", "createdAt": "2020-04-01T15:46:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxNzcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1OTEwOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r404859109", "bodyText": "Changed.", "author": "Maninda", "createdAt": "2020-04-07T14:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxNzcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyNDYzMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r401724630", "bodyText": "Shouldn't the contentType be checked for null here? message.getContentType() can result null according to the API docs", "author": "chamil321", "createdAt": "2020-04-01T15:55:17Z", "path": "stdlib/email/src/main/java/org/ballerinalang/stdlib/email/util/CommonUtil.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) 2020 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.ballerinalang.stdlib.email.util;\n+\n+import org.ballerinalang.mime.util.MimeConstants;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+/**\n+ * Contains the common utility functions.\n+ *\n+ * @since 1.2.1\n+ */\n+public class CommonUtil {\n+\n+    /**\n+     * Check whether the content type is based on text.\n+     *\n+     * @param contentType Content Type of a MIME Body Type\n+     * @return boolean Whether the MIME Body Type is text based\n+     */\n+    protected static boolean isTextBased(String contentType) {\n+        return contentType.startsWith(MimeConstants.TEXT_AS_PRIMARY_TYPE)", "originalCommit": "be6013d0d6b28e51cbd28a8e0557161163c46f18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyNjE5MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r401726191", "bodyText": "Maybe we need to check other methods as well", "author": "chamil321", "createdAt": "2020-04-01T15:57:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyNDYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1OTU0NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r404859545", "bodyText": "Checked in all the instances.", "author": "Maninda", "createdAt": "2020-04-07T14:36:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyNDYzMA=="}], "type": "inlineReview"}, {"oid": "69fcb1d89e39b67083f2714cf942f5258e061513", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/69fcb1d89e39b67083f2714cf942f5258e061513", "message": "Fix issues in MIME features in Email connector including the suggestions given in the PR", "committedDate": "2020-04-07T14:14:08Z", "type": "commit"}, {"oid": "bae482265a64a0f2bddb18305979e55f9c307ab4", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bae482265a64a0f2bddb18305979e55f9c307ab4", "message": "Refactor MIME features for Email connector and fix issues with Entity headers", "committedDate": "2020-04-07T18:34:04Z", "type": "commit"}, {"oid": "5defb2b1d2436e4d0d2d8d2a0a015fd95263e2d7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5defb2b1d2436e4d0d2d8d2a0a015fd95263e2d7", "message": "Rename a method", "committedDate": "2020-04-15T11:27:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwMzc1Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r408803757", "bodyText": "What happens if this condition does not satisfied?", "author": "ThisaruGuruge", "createdAt": "2020-04-15T12:29:39Z", "path": "stdlib/email/src/main/java/org/ballerinalang/stdlib/email/util/SmtpUtil.java", "diffHunk": "@@ -94,14 +112,96 @@ public static MimeMessage generateMessage(Session session, String username, MapV\n             emailMessage.setReplyTo(replyToAddressArray);\n         }\n         emailMessage.setSubject(subject);\n-        emailMessage.setText(messageBody);\n         emailMessage.setFrom(new InternetAddress(fromAddress));\n         if (!senderAddress.isEmpty()) {\n             emailMessage.setSender(new InternetAddress(senderAddress));\n         }\n+        ArrayValue attachments = message.getArrayValue(EmailConstants.MESSAGE_ATTACHMENTS);\n+        if (attachments == null) {\n+            emailMessage.setText(messageBody);\n+        } else {\n+            addBodyAndAttachments(emailMessage, messageBody, attachments);\n+        }\n         return emailMessage;\n     }\n \n+    private static void addBodyAndAttachments(MimeMessage emailMessage, String messageBody, ArrayValue attachments)\n+            throws MessagingException, IOException {\n+        BodyPart messageBodyPart = new MimeBodyPart();\n+        messageBodyPart.setText(messageBody);\n+        Multipart multipart = new MimeMultipart();\n+        multipart.addBodyPart(messageBodyPart);\n+        for (int i = 0; i < attachments.size(); i++) {\n+            if (attachments.get(i) instanceof ObjectValue) {", "originalCommit": "5defb2b1d2436e4d0d2d8d2a0a015fd95263e2d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgzNjcwNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r408836706", "bodyText": "It will be skipped getting added as an attachment. Anyway, this case will not happen according to the referred code of this method.", "author": "Maninda", "createdAt": "2020-04-15T13:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwMzc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg0NTMwOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r408845308", "bodyText": "Then it's better to add it as a comment at least I guess. This may lead to confusions in the future.", "author": "ThisaruGuruge", "createdAt": "2020-04-15T13:34:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwMzc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg3MDA2OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r408870069", "bodyText": "I think that is implicit as there can be emails without attachments too.", "author": "Maninda", "createdAt": "2020-04-15T14:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwMzc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwNDIwOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r408804208", "bodyText": "Can be replaced with a for each loop ?", "author": "ThisaruGuruge", "createdAt": "2020-04-15T12:30:24Z", "path": "stdlib/email/src/main/java/org/ballerinalang/stdlib/email/util/SmtpUtil.java", "diffHunk": "@@ -94,14 +112,96 @@ public static MimeMessage generateMessage(Session session, String username, MapV\n             emailMessage.setReplyTo(replyToAddressArray);\n         }\n         emailMessage.setSubject(subject);\n-        emailMessage.setText(messageBody);\n         emailMessage.setFrom(new InternetAddress(fromAddress));\n         if (!senderAddress.isEmpty()) {\n             emailMessage.setSender(new InternetAddress(senderAddress));\n         }\n+        ArrayValue attachments = message.getArrayValue(EmailConstants.MESSAGE_ATTACHMENTS);\n+        if (attachments == null) {\n+            emailMessage.setText(messageBody);\n+        } else {\n+            addBodyAndAttachments(emailMessage, messageBody, attachments);\n+        }\n         return emailMessage;\n     }\n \n+    private static void addBodyAndAttachments(MimeMessage emailMessage, String messageBody, ArrayValue attachments)\n+            throws MessagingException, IOException {\n+        BodyPart messageBodyPart = new MimeBodyPart();\n+        messageBodyPart.setText(messageBody);\n+        Multipart multipart = new MimeMultipart();\n+        multipart.addBodyPart(messageBodyPart);\n+        for (int i = 0; i < attachments.size(); i++) {\n+            if (attachments.get(i) instanceof ObjectValue) {\n+                ObjectValue mimeEntity = (ObjectValue) attachments.get(i);\n+                String contentType = getContentTypeWithParameters(mimeEntity);\n+                if (contentType.startsWith(MimeConstants.MULTIPART_AS_PRIMARY_TYPE)) {\n+                    multipart.addBodyPart(populateMultipart(mimeEntity));\n+                } else {\n+                    multipart.addBodyPart(buildJavaMailBodyPart(mimeEntity, contentType));\n+                }\n+            }\n+        }\n+        emailMessage.setContent(multipart);\n+    }\n+\n+    private static MimeBodyPart populateMultipart(ObjectValue mimeEntity) throws IOException, MessagingException {\n+        Multipart multipart = new MimeMultipart();\n+        ArrayValue multipartMimeEntityArrayValue = EntityBodyHandler.getBodyPartArray(mimeEntity);\n+        int entityCount = multipartMimeEntityArrayValue.size();\n+        for (int i = 0; i < entityCount; i++) {", "originalCommit": "5defb2b1d2436e4d0d2d8d2a0a015fd95263e2d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg0MzEwMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r408843101", "bodyText": "for each loop is not supporting ArrayValue type by default. Therefore, it is better to use a counter to access the ObjectValue entries with the for loop.", "author": "Maninda", "createdAt": "2020-04-15T13:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwNDIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgxNTY0NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r408815644", "bodyText": "Shall we replace this with a for each loop?", "author": "ThisaruGuruge", "createdAt": "2020-04-15T12:49:41Z", "path": "stdlib/email/src/main/java/org/ballerinalang/stdlib/email/util/SmtpUtil.java", "diffHunk": "@@ -94,14 +112,96 @@ public static MimeMessage generateMessage(Session session, String username, MapV\n             emailMessage.setReplyTo(replyToAddressArray);\n         }\n         emailMessage.setSubject(subject);\n-        emailMessage.setText(messageBody);\n         emailMessage.setFrom(new InternetAddress(fromAddress));\n         if (!senderAddress.isEmpty()) {\n             emailMessage.setSender(new InternetAddress(senderAddress));\n         }\n+        ArrayValue attachments = message.getArrayValue(EmailConstants.MESSAGE_ATTACHMENTS);\n+        if (attachments == null) {\n+            emailMessage.setText(messageBody);\n+        } else {\n+            addBodyAndAttachments(emailMessage, messageBody, attachments);\n+        }\n         return emailMessage;\n     }\n \n+    private static void addBodyAndAttachments(MimeMessage emailMessage, String messageBody, ArrayValue attachments)\n+            throws MessagingException, IOException {\n+        BodyPart messageBodyPart = new MimeBodyPart();\n+        messageBodyPart.setText(messageBody);\n+        Multipart multipart = new MimeMultipart();\n+        multipart.addBodyPart(messageBodyPart);\n+        for (int i = 0; i < attachments.size(); i++) {\n+            if (attachments.get(i) instanceof ObjectValue) {\n+                ObjectValue mimeEntity = (ObjectValue) attachments.get(i);\n+                String contentType = getContentTypeWithParameters(mimeEntity);\n+                if (contentType.startsWith(MimeConstants.MULTIPART_AS_PRIMARY_TYPE)) {\n+                    multipart.addBodyPart(populateMultipart(mimeEntity));\n+                } else {\n+                    multipart.addBodyPart(buildJavaMailBodyPart(mimeEntity, contentType));\n+                }\n+            }\n+        }\n+        emailMessage.setContent(multipart);\n+    }\n+\n+    private static MimeBodyPart populateMultipart(ObjectValue mimeEntity) throws IOException, MessagingException {\n+        Multipart multipart = new MimeMultipart();\n+        ArrayValue multipartMimeEntityArrayValue = EntityBodyHandler.getBodyPartArray(mimeEntity);\n+        int entityCount = multipartMimeEntityArrayValue.size();\n+        for (int i = 0; i < entityCount; i++) {\n+            ObjectValue childMimeEntity = (ObjectValue) multipartMimeEntityArrayValue.get(i);\n+            String childContentType = getContentTypeWithParameters(childMimeEntity);\n+            if (childContentType.startsWith(MimeConstants.MULTIPART_AS_PRIMARY_TYPE)) {\n+                multipart.addBodyPart(populateMultipart(childMimeEntity));\n+            } else {\n+                multipart.addBodyPart(buildJavaMailBodyPart(childMimeEntity, childContentType));\n+            }\n+        }\n+        MimeBodyPart returnMimeBodyPart = new MimeBodyPart();\n+        returnMimeBodyPart.setContent(multipart);\n+        return returnMimeBodyPart;\n+    }\n+\n+    private static MimeBodyPart buildJavaMailBodyPart(ObjectValue mimeEntity, String contentType)\n+            throws MessagingException, IOException {\n+        MimeBodyPart attachmentBodyPart = new MimeBodyPart();\n+        Channel channel = EntityBodyHandler.getByteChannel(mimeEntity);\n+        if (channel != null) {\n+            InputStream inputStream = channel.getInputStream();\n+            ByteArrayDataSource ds = new ByteArrayDataSource(inputStream, contentType);\n+            attachmentBodyPart.setDataHandler(new DataHandler(ds));\n+        } else {\n+            if (CommonUtil.isTextBased(contentType)) {\n+                attachmentBodyPart.setText((String) MimeDataSourceBuilder.getText(mimeEntity));\n+            } else {\n+                ArrayValue binaryContent = (ArrayValue) MimeDataSourceBuilder.getByteArray(mimeEntity);\n+                attachmentBodyPart.setContent(binaryContent.getBytes(), MimeConstants.OCTET_STREAM);\n+            }\n+        }\n+        addHeadersToJavaMailBodyPart(mimeEntity, attachmentBodyPart);\n+        return attachmentBodyPart;\n+    }\n+\n+    private static void addHeadersToJavaMailBodyPart(ObjectValue mimeEntity, MimeBodyPart attachmentBodyPart)\n+            throws MessagingException {\n+        ArrayValue headerNamesArrayValue = EntityHeaders.getHeaderNames(mimeEntity, MimeConstants.LEADING_HEADER);\n+        HandleValue[] handleValues = (HandleValue[]) headerNamesArrayValue.getValues();\n+        String[] headerNames = new String[handleValues.length];\n+        for (int j = 0; j < handleValues.length; j++) {\n+            headerNames[j] = handleValues[j].stringValue();\n+        }\n+        if (headerNames.length > 0) {\n+            for (String headerName : headerNames) {", "originalCommit": "5defb2b1d2436e4d0d2d8d2a0a015fd95263e2d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg1MTgwMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r408851801", "bodyText": "This is already a for each loop. If you are referring to something else can you please suggest the code.", "author": "Maninda", "createdAt": "2020-04-15T13:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgxNTY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgxNTgzOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r408815838", "bodyText": "Can be replaced with a for each loop ?", "author": "ThisaruGuruge", "createdAt": "2020-04-15T12:50:01Z", "path": "stdlib/email/src/main/java/org/ballerinalang/stdlib/email/util/SmtpUtil.java", "diffHunk": "@@ -94,14 +112,96 @@ public static MimeMessage generateMessage(Session session, String username, MapV\n             emailMessage.setReplyTo(replyToAddressArray);\n         }\n         emailMessage.setSubject(subject);\n-        emailMessage.setText(messageBody);\n         emailMessage.setFrom(new InternetAddress(fromAddress));\n         if (!senderAddress.isEmpty()) {\n             emailMessage.setSender(new InternetAddress(senderAddress));\n         }\n+        ArrayValue attachments = message.getArrayValue(EmailConstants.MESSAGE_ATTACHMENTS);\n+        if (attachments == null) {\n+            emailMessage.setText(messageBody);\n+        } else {\n+            addBodyAndAttachments(emailMessage, messageBody, attachments);\n+        }\n         return emailMessage;\n     }\n \n+    private static void addBodyAndAttachments(MimeMessage emailMessage, String messageBody, ArrayValue attachments)\n+            throws MessagingException, IOException {\n+        BodyPart messageBodyPart = new MimeBodyPart();\n+        messageBodyPart.setText(messageBody);\n+        Multipart multipart = new MimeMultipart();\n+        multipart.addBodyPart(messageBodyPart);\n+        for (int i = 0; i < attachments.size(); i++) {\n+            if (attachments.get(i) instanceof ObjectValue) {\n+                ObjectValue mimeEntity = (ObjectValue) attachments.get(i);\n+                String contentType = getContentTypeWithParameters(mimeEntity);\n+                if (contentType.startsWith(MimeConstants.MULTIPART_AS_PRIMARY_TYPE)) {\n+                    multipart.addBodyPart(populateMultipart(mimeEntity));\n+                } else {\n+                    multipart.addBodyPart(buildJavaMailBodyPart(mimeEntity, contentType));\n+                }\n+            }\n+        }\n+        emailMessage.setContent(multipart);\n+    }\n+\n+    private static MimeBodyPart populateMultipart(ObjectValue mimeEntity) throws IOException, MessagingException {\n+        Multipart multipart = new MimeMultipart();\n+        ArrayValue multipartMimeEntityArrayValue = EntityBodyHandler.getBodyPartArray(mimeEntity);\n+        int entityCount = multipartMimeEntityArrayValue.size();\n+        for (int i = 0; i < entityCount; i++) {\n+            ObjectValue childMimeEntity = (ObjectValue) multipartMimeEntityArrayValue.get(i);\n+            String childContentType = getContentTypeWithParameters(childMimeEntity);\n+            if (childContentType.startsWith(MimeConstants.MULTIPART_AS_PRIMARY_TYPE)) {\n+                multipart.addBodyPart(populateMultipart(childMimeEntity));\n+            } else {\n+                multipart.addBodyPart(buildJavaMailBodyPart(childMimeEntity, childContentType));\n+            }\n+        }\n+        MimeBodyPart returnMimeBodyPart = new MimeBodyPart();\n+        returnMimeBodyPart.setContent(multipart);\n+        return returnMimeBodyPart;\n+    }\n+\n+    private static MimeBodyPart buildJavaMailBodyPart(ObjectValue mimeEntity, String contentType)\n+            throws MessagingException, IOException {\n+        MimeBodyPart attachmentBodyPart = new MimeBodyPart();\n+        Channel channel = EntityBodyHandler.getByteChannel(mimeEntity);\n+        if (channel != null) {\n+            InputStream inputStream = channel.getInputStream();\n+            ByteArrayDataSource ds = new ByteArrayDataSource(inputStream, contentType);\n+            attachmentBodyPart.setDataHandler(new DataHandler(ds));\n+        } else {\n+            if (CommonUtil.isTextBased(contentType)) {\n+                attachmentBodyPart.setText((String) MimeDataSourceBuilder.getText(mimeEntity));\n+            } else {\n+                ArrayValue binaryContent = (ArrayValue) MimeDataSourceBuilder.getByteArray(mimeEntity);\n+                attachmentBodyPart.setContent(binaryContent.getBytes(), MimeConstants.OCTET_STREAM);\n+            }\n+        }\n+        addHeadersToJavaMailBodyPart(mimeEntity, attachmentBodyPart);\n+        return attachmentBodyPart;\n+    }\n+\n+    private static void addHeadersToJavaMailBodyPart(ObjectValue mimeEntity, MimeBodyPart attachmentBodyPart)\n+            throws MessagingException {\n+        ArrayValue headerNamesArrayValue = EntityHeaders.getHeaderNames(mimeEntity, MimeConstants.LEADING_HEADER);\n+        HandleValue[] handleValues = (HandleValue[]) headerNamesArrayValue.getValues();\n+        String[] headerNames = new String[handleValues.length];\n+        for (int j = 0; j < handleValues.length; j++) {", "originalCommit": "5defb2b1d2436e4d0d2d8d2a0a015fd95263e2d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg1MTkxNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22401#discussion_r408851914", "bodyText": "As this needs to iterate two arrays handleValues and headerNames it seems the for each loop is not suitable. If you are referring to something else can you please suggest the code.", "author": "Maninda", "createdAt": "2020-04-15T13:43:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgxNTgzOA=="}], "type": "inlineReview"}]}