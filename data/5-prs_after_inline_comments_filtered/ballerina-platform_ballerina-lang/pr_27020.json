{"pr_number": 27020, "pr_title": "Implement DynamicListener ", "pr_createdAt": "2020-11-19T11:23:14Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/27020", "timeline": [{"oid": "961d636022f62d9c39f7538b1ee55174d3f67c82", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/961d636022f62d9c39f7538b1ee55174d3f67c82", "message": "Fix tests", "committedDate": "2020-11-20T13:59:45Z", "type": "forcePushed"}, {"oid": "6a152198b586c7ded4ba43257c04a9ac9ab8663d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6a152198b586c7ded4ba43257c04a9ac9ab8663d", "message": "Fix failing tests", "committedDate": "2020-11-21T01:12:45Z", "type": "forcePushed"}, {"oid": "1ed0dc15bc2c202eb6ec6572a393abbfb72ddd3e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1ed0dc15bc2c202eb6ec6572a393abbfb72ddd3e", "message": "Fix failing tests", "committedDate": "2020-11-21T09:32:58Z", "type": "forcePushed"}, {"oid": "2d76af902483646a2dab02ffbc2738035965a50e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2d76af902483646a2dab02ffbc2738035965a50e", "message": "Fix failing tests", "committedDate": "2020-11-21T10:00:10Z", "type": "forcePushed"}, {"oid": "34153f8bc62ff37bf2b320ea42644660bd608016", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/34153f8bc62ff37bf2b320ea42644660bd608016", "message": "Fix for project api changes", "committedDate": "2020-11-21T17:41:49Z", "type": "forcePushed"}, {"oid": "e6a419541909ddaba6e55818779557d50c1fc56c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e6a419541909ddaba6e55818779557d50c1fc56c", "message": "Fix for project api changes", "committedDate": "2020-11-21T17:46:58Z", "type": "forcePushed"}, {"oid": "16511054caa0c52a275cecb68221f873acceee02", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/16511054caa0c52a275cecb68221f873acceee02", "message": "Fix for project api changes", "committedDate": "2020-11-22T00:39:43Z", "type": "forcePushed"}, {"oid": "78be06db7f7a0de8eec7ef861fbce45e5cbea8ea", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/78be06db7f7a0de8eec7ef861fbce45e5cbea8ea", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-22T13:33:40Z", "type": "forcePushed"}, {"oid": "33ac9fb123fa2b5633e42709891db788e23fda88", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/33ac9fb123fa2b5633e42709891db788e23fda88", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-22T13:43:40Z", "type": "forcePushed"}, {"oid": "e7dd79dfe49dd5f220c25c320fc7094b950ad73d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e7dd79dfe49dd5f220c25c320fc7094b950ad73d", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-22T14:19:18Z", "type": "forcePushed"}, {"oid": "670ac236f0e27f2ca628733d26568609374b508e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/670ac236f0e27f2ca628733d26568609374b508e", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-22T14:28:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ3MjMzNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27020#discussion_r528472336", "bodyText": "listenerSet.remove(listener) only invoked if isListenerDeclarationFound is false, is that the correct thing?", "author": "manuranga", "createdAt": "2020-11-23T04:58:24Z", "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/scheduling/Scheduler.java", "diffHunk": "@@ -465,6 +473,45 @@ public void poison() {\n             runnableList.add(POISON_PILL);\n         }\n     }\n+\n+    public void setListenerDeclarationFound(boolean listenerDeclarationFound) {\n+        this.listenerDeclarationFound = listenerDeclarationFound;\n+        if (listenerDeclarationFound) {\n+            setImmortal(true);\n+        }\n+    }\n+\n+    public boolean isListenerDeclarationFound() {\n+        return listenerDeclarationFound;\n+    }\n+\n+    public ListenerRegistry getListenerRegistry() {\n+        return listenerRegistry;\n+    }\n+\n+    /**\n+     * The registry for runtime dynamic listeners.\n+     */\n+    public class ListenerRegistry {\n+        private final Set<BObject> listenerSet = new HashSet<>();\n+\n+        public synchronized void registerListener(BObject listener) {\n+            listenerSet.add(listener);\n+            setImmortal(true);\n+        }\n+\n+        public synchronized void deregisterListener(BObject listener) {\n+            if (!isListenerDeclarationFound() && listenerSet.remove(listener) && listenerSet.isEmpty()) {\n+                setImmortal(false);", "originalCommit": "670ac236f0e27f2ca628733d26568609374b508e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ3MzA2NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27020#discussion_r528473064", "bodyText": "will fix", "author": "riyafa", "createdAt": "2020-11-23T05:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ3MjMzNg=="}], "type": "inlineReview"}, {"oid": "b8872357051cf8e145b1cc38e203147df011f1ec", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b8872357051cf8e145b1cc38e203147df011f1ec", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-23T10:04:28Z", "type": "forcePushed"}, {"oid": "c5ebd5ed11b5c648cd04a31e216fd8947a6b65c6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c5ebd5ed11b5c648cd04a31e216fd8947a6b65c6", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-23T11:56:14Z", "type": "forcePushed"}, {"oid": "a3a650217e47a1a261d77871fdb95f3ce18d3ecf", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a3a650217e47a1a261d77871fdb95f3ce18d3ecf", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-23T12:05:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY2MDg4Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27020#discussion_r528660887", "bodyText": "Missing since annotation", "author": "warunalakshitha", "createdAt": "2020-11-23T12:15:09Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/codegen/ShutDownListenerGen.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.ballerinalang.compiler.bir.codegen;\n+\n+import org.objectweb.asm.ClassWriter;\n+import org.objectweb.asm.FieldVisitor;\n+import org.objectweb.asm.MethodVisitor;\n+\n+import java.util.Map;\n+\n+import static org.objectweb.asm.ClassWriter.COMPUTE_FRAMES;\n+import static org.objectweb.asm.Opcodes.ACC_PRIVATE;\n+import static org.objectweb.asm.Opcodes.ACC_PUBLIC;\n+import static org.objectweb.asm.Opcodes.ACC_SUPER;\n+import static org.objectweb.asm.Opcodes.ALOAD;\n+import static org.objectweb.asm.Opcodes.GETFIELD;\n+import static org.objectweb.asm.Opcodes.INVOKESPECIAL;\n+import static org.objectweb.asm.Opcodes.INVOKESTATIC;\n+import static org.objectweb.asm.Opcodes.PUTFIELD;\n+import static org.objectweb.asm.Opcodes.RETURN;\n+import static org.objectweb.asm.Opcodes.V1_8;\n+import static org.wso2.ballerinalang.compiler.bir.codegen.JvmConstants.JAVA_THREAD;\n+import static org.wso2.ballerinalang.compiler.bir.codegen.JvmConstants.JVM_INIT_METHOD;\n+import static org.wso2.ballerinalang.compiler.bir.codegen.JvmConstants.MODULE_STOP;\n+\n+/**\n+ * Generate the thread for the addShutDownHook.\n+ */", "originalCommit": "a3a650217e47a1a261d77871fdb95f3ce18d3ecf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aa11fcb70d9a6f0ec040ff29f6db522d015dfa32", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/aa11fcb70d9a6f0ec040ff29f6db522d015dfa32", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-23T12:32:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTQwMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27020#discussion_r528681402", "bodyText": "Why do we have Var suffix in only initFuture variable? Shall we make all three names consistent as they are for similar purpose?", "author": "HindujaB", "createdAt": "2020-11-23T12:52:44Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/codegen/methodgen/MainMethodGen.java", "diffHunk": "@@ -69,6 +69,9 @@\n  */\n public class MainMethodGen {\n \n+    public static final String INIT_FUTURE_VAR = \"initFutureVar\";", "originalCommit": "aa11fcb70d9a6f0ec040ff29f6db522d015dfa32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d0ea9c6fdc289f68b20029ce9304cf198029a7c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9d0ea9c6fdc289f68b20029ce9304cf198029a7c", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-23T13:33:58Z", "type": "forcePushed"}, {"oid": "3a91fdd7466eafe4739a6d2482a91f2753f81b58", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3a91fdd7466eafe4739a6d2482a91f2753f81b58", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-23T15:13:22Z", "type": "forcePushed"}, {"oid": "d7343260f9edc0ab24e6036486010585c4e50abd", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d7343260f9edc0ab24e6036486010585c4e50abd", "message": "Implement DynamicListener\n\n- Adds the runtime module with the DynamicListener implementation. Resolve https://github.com/ballerina-platform/ballerina-lang/issues/26769\n- This will fix the program not exiting when there's a service. Now the program exits if there's only a service. It will not exit when there's a registered module listener. Module Listeners can be registered using the runtime:registerListener function or by means of a listener declaration. Resolve https://github.com/ballerina-platform/ballerina-lang/issues/18601", "committedDate": "2020-11-24T00:20:00Z", "type": "commit"}, {"oid": "9330eae6531e578601e552dd141bbb05e30a2d9e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9330eae6531e578601e552dd141bbb05e30a2d9e", "message": "Fix code issues in BIRGen", "committedDate": "2020-11-24T00:20:00Z", "type": "commit"}, {"oid": "66f36f35e6629588dcb030f3629c586732db8513", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/66f36f35e6629588dcb030f3629c586732db8513", "message": "Fix failing tests", "committedDate": "2020-11-24T00:20:00Z", "type": "commit"}, {"oid": "adc13908e3edc143ca696ee3a50bb9d033111a4f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/adc13908e3edc143ca696ee3a50bb9d033111a4f", "message": "Fix for project api changes", "committedDate": "2020-11-24T00:20:01Z", "type": "commit"}, {"oid": "ce771e3de000576a14ee305707ca23b165e7517f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ce771e3de000576a14ee305707ca23b165e7517f", "message": "Add tests for DynamicListeners", "committedDate": "2020-11-24T00:20:01Z", "type": "commit"}, {"oid": "935f1d62a391ed8b00064618e1b82a3a0d310237", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/935f1d62a391ed8b00064618e1b82a3a0d310237", "message": "Fix failing language-server tests\n\nThese tests failed because of the addition of a new module.", "committedDate": "2020-11-24T00:20:01Z", "type": "commit"}, {"oid": "33b0f055cf02435d941d13a702220d9fa2a301c3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/33b0f055cf02435d941d13a702220d9fa2a301c3", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-24T00:20:01Z", "type": "commit"}, {"oid": "33b0f055cf02435d941d13a702220d9fa2a301c3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/33b0f055cf02435d941d13a702220d9fa2a301c3", "message": "Allow not exiting for services as well\n\nThis will undo the fix that exits when there's only services. This is to keep supporting WebSocket clients for a while.", "committedDate": "2020-11-24T00:20:01Z", "type": "forcePushed"}]}