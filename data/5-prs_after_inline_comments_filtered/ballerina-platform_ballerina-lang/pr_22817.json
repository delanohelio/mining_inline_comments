{"pr_number": 22817, "pr_title": "Populate dependencies based on 'scope' parameter", "pr_createdAt": "2020-04-21T13:36:36Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817", "timeline": [{"oid": "bd161d1a387b8a51a9facbd2ef15e010ff240dfd", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bd161d1a387b8a51a9facbd2ef15e010ff240dfd", "message": "Populate platform libs based on 'scope' parameter", "committedDate": "2020-04-21T10:22:25Z", "type": "commit"}, {"oid": "caf089561ee7ec77251107885e9f91614af8031f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/caf089561ee7ec77251107885e9f91614af8031f", "message": "Add dependency scope test cases", "committedDate": "2020-04-21T13:32:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzMjYxOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r412332618", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (null == libraries) {\n          \n          \n            \n                    if (libraries == null) {", "author": "praveennadarajah", "createdAt": "2020-04-21T17:03:31Z", "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/task/CopyNativeLibTask.java", "diffHunk": "@@ -120,6 +122,26 @@ private void copyImportedJarsForModules(BuildContext buildContext, List<BLangPac\n         }\n     }\n \n+    private void copyPlatformLibsForModules(PackageID packageID, ExecutableJar executableJar, Path project) {\n+        List<Library> libraries = manifest.getPlatform().libraries;\n+        if (null == libraries) {", "originalCommit": "caf089561ee7ec77251107885e9f91614af8031f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzMzk4Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r412333986", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (null != libFilePath) {\n          \n          \n            \n                        if (libFilePath != null) {", "author": "praveennadarajah", "createdAt": "2020-04-21T17:05:36Z", "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/task/CopyNativeLibTask.java", "diffHunk": "@@ -120,6 +122,26 @@ private void copyImportedJarsForModules(BuildContext buildContext, List<BLangPac\n         }\n     }\n \n+    private void copyPlatformLibsForModules(PackageID packageID, ExecutableJar executableJar, Path project) {\n+        List<Library> libraries = manifest.getPlatform().libraries;\n+        if (null == libraries) {\n+            return;\n+        }\n+        List<Library> libs = libraries.stream().filter(lib -> lib.getModules() == null ||\n+                Arrays.asList(lib.getModules()).contains(packageID.name.value)).collect(Collectors.toList());\n+        for (Library lib : libs) {\n+            String libFilePath = lib.getPath();\n+            if (null != libFilePath) {", "originalCommit": "caf089561ee7ec77251107885e9f91614af8031f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzODcxNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r412338714", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Assert.fail(\"error loading resources\");\n          \n          \n            \n                        Assert.fail(\"Error loading resources\");", "author": "praveennadarajah", "createdAt": "2020-04-21T17:12:05Z", "path": "cli/ballerina-packerina/src/test/java/org/ballerinalang/packerina/cmd/DependencyScopeTest.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.ballerinalang.packerina.cmd;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+import org.wso2.ballerinalang.compiler.util.ProjectDirConstants;\n+import org.wso2.ballerinalang.programfile.ProgramFileConstants;\n+import picocli.CommandLine;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Enumeration;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipFile;\n+\n+import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;\n+import static org.wso2.ballerinalang.compiler.util.ProjectDirConstants.BLANG_COMPILED_PKG_BINARY_EXT;\n+\n+/**\n+ * Dependency scope tests.\n+ *\n+ * @since 1.2.x\n+ */\n+public class DependencyScopeTest extends CommandTest {\n+\n+    private Path testResources;\n+    private URI testResourcesURI;\n+\n+    @BeforeClass\n+    public void setup() throws IOException {\n+        super.setup();\n+        try {\n+            this.testResources = super.tmpDir.resolve(\"scope-test-resources\");\n+            testResourcesURI = getClass().getClassLoader().getResource(\"test-resources\").toURI();\n+            Path storedJarDependencyProject = Paths.get(testResourcesURI).resolve(\"stored-jar-dependency-project\");\n+            Files.walkFileTree(storedJarDependencyProject, new BuildCommandTest.Copy(storedJarDependencyProject,\n+                    this.testResources));\n+        } catch (URISyntaxException e) {\n+            Assert.fail(\"error loading resources\");", "originalCommit": "caf089561ee7ec77251107885e9f91614af8031f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM2NTk2Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r412365963", "bodyText": "Error messages start with simple letters.", "author": "suganyasuven", "createdAt": "2020-04-21T17:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzODcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3MTYxMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r412371612", "bodyText": "No need to iterate all the zip entries and find whether a particular entry is there or not. The time complexity and performance hit would be high by doing this way. Instead, you can directly check a particular entry's presence in the following way.\nreturn new ZipFile(file).getEntry(jarEntry) != null;", "author": "praveennadarajah", "createdAt": "2020-04-21T17:57:45Z", "path": "cli/ballerina-packerina/src/test/java/org/ballerinalang/packerina/cmd/DependencyScopeTest.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.ballerinalang.packerina.cmd;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+import org.wso2.ballerinalang.compiler.util.ProjectDirConstants;\n+import org.wso2.ballerinalang.programfile.ProgramFileConstants;\n+import picocli.CommandLine;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Enumeration;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipFile;\n+\n+import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;\n+import static org.wso2.ballerinalang.compiler.util.ProjectDirConstants.BLANG_COMPILED_PKG_BINARY_EXT;\n+\n+/**\n+ * Dependency scope tests.\n+ *\n+ * @since 1.2.x\n+ */\n+public class DependencyScopeTest extends CommandTest {\n+\n+    private Path testResources;\n+    private URI testResourcesURI;\n+\n+    @BeforeClass\n+    public void setup() throws IOException {\n+        super.setup();\n+        try {\n+            this.testResources = super.tmpDir.resolve(\"scope-test-resources\");\n+            testResourcesURI = getClass().getClassLoader().getResource(\"test-resources\").toURI();\n+            Path storedJarDependencyProject = Paths.get(testResourcesURI).resolve(\"stored-jar-dependency-project\");\n+            Files.walkFileTree(storedJarDependencyProject, new BuildCommandTest.Copy(storedJarDependencyProject,\n+                    this.testResources));\n+        } catch (URISyntaxException e) {\n+            Assert.fail(\"error loading resources\");\n+        }\n+    }\n+\n+    @Test(description = \"Test if platform libs are packed with the balo based on the scope.\")\n+    public void testBuildCommandWithStoredJarDependency() throws IOException {\n+        String baloFileName = \"mymodule-\" + ProgramFileConstants.IMPLEMENTATION_VERSION + \"-java8-0.1.0\"\n+                + BLANG_COMPILED_PKG_BINARY_EXT;\n+        Path balo = this.testResources.resolve(ProjectDirConstants.TARGET_DIR_NAME).\n+                resolve(ProjectDirConstants.TARGET_BALO_DIRECTORY);\n+        File baloFile = new File(balo.toString() + File.separator + baloFileName);\n+        File baloZipFile = new File(balo.toString() + File.separator +\n+                baloFileName.concat(\".zip\"));\n+        Path scopeToml = Paths.get(testResourcesURI).resolve(\"scope-toml\");\n+        String storedJarPath = \"platform-libs/storedJar.jar\";\n+\n+        // Build the project\n+        String[] compileArgs = {\"--all\", \"--skip-tests\"};\n+        BuildCommand buildCommand = new BuildCommand(this.testResources, printStream, printStream,\n+                false, true);\n+        new CommandLine(buildCommand).parse(compileArgs);\n+        // default scope\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertTrue(isJarExists(baloZipFile, storedJarPath));\n+\n+        // package scope\n+        copy(scopeToml.resolve(\"case1\").resolve(ProjectDirConstants.MANIFEST_FILE_NAME),\n+                this.testResources.resolve(ProjectDirConstants.MANIFEST_FILE_NAME));\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertTrue(isJarExists(baloZipFile, storedJarPath));\n+\n+        // package scope\n+        copy(scopeToml.resolve(\"case2\").resolve(ProjectDirConstants.MANIFEST_FILE_NAME),\n+                this.testResources.resolve(ProjectDirConstants.MANIFEST_FILE_NAME));\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertFalse(isJarExists(baloZipFile, storedJarPath));\n+\n+        // compile scope\n+        copy(scopeToml.resolve(\"case3\").resolve(ProjectDirConstants.MANIFEST_FILE_NAME),\n+                this.testResources.resolve(ProjectDirConstants.MANIFEST_FILE_NAME));\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertFalse(isJarExists(baloZipFile, storedJarPath));\n+    }\n+\n+    private boolean renameFile(File oldName, File newName) {\n+        return oldName.renameTo(newName);\n+    }\n+\n+    private boolean isJarExists (File file, String jarEntry) throws IOException {\n+        try (ZipFile zipFile = new ZipFile(file)) {\n+            Enumeration<? extends ZipEntry> entries = zipFile.entries();", "originalCommit": "caf089561ee7ec77251107885e9f91614af8031f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwMzUyMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r413503521", "bodyText": "When checking the Ballerina.toml file, it looks like \"case3\" should be the \"test\" scope.", "author": "IrushiL", "createdAt": "2020-04-23T04:40:31Z", "path": "cli/ballerina-packerina/src/test/java/org/ballerinalang/packerina/cmd/DependencyScopeTest.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.ballerinalang.packerina.cmd;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+import org.wso2.ballerinalang.compiler.util.ProjectDirConstants;\n+import org.wso2.ballerinalang.programfile.ProgramFileConstants;\n+import picocli.CommandLine;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.zip.ZipFile;\n+\n+import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;\n+import static org.wso2.ballerinalang.compiler.util.ProjectDirConstants.BLANG_COMPILED_PKG_BINARY_EXT;\n+\n+/**\n+ * Dependency scope tests.\n+ *\n+ * @since 1.2.x\n+ */\n+public class DependencyScopeTest extends CommandTest {\n+\n+    private Path testResources;\n+    private URI testResourcesURI;\n+\n+    @BeforeClass\n+    public void setup() throws IOException {\n+        super.setup();\n+        try {\n+            this.testResources = super.tmpDir.resolve(\"scope-test-resources\");\n+            testResourcesURI = getClass().getClassLoader().getResource(\"test-resources\").toURI();\n+            Path storedJarDependencyProject = Paths.get(testResourcesURI).resolve(\"stored-jar-dependency-project\");\n+            Files.walkFileTree(storedJarDependencyProject, new BuildCommandTest.Copy(storedJarDependencyProject,\n+                    this.testResources));\n+        } catch (URISyntaxException e) {\n+            Assert.fail(\"error loading resources\");\n+        }\n+    }\n+\n+    @Test(description = \"Test if platform libs are packed with the balo based on the scope.\")\n+    public void testBuildCommandWithStoredJarDependency() throws IOException {\n+        String baloFileName = \"mymodule-\" + ProgramFileConstants.IMPLEMENTATION_VERSION + \"-java8-0.1.0\"\n+                + BLANG_COMPILED_PKG_BINARY_EXT;\n+        Path balo = this.testResources.resolve(ProjectDirConstants.TARGET_DIR_NAME).\n+                resolve(ProjectDirConstants.TARGET_BALO_DIRECTORY);\n+        File baloFile = new File(balo.toString() + File.separator + baloFileName);\n+        File baloZipFile = new File(balo.toString() + File.separator +\n+                baloFileName.concat(\".zip\"));\n+        Path scopeToml = Paths.get(testResourcesURI).resolve(\"scope-toml\");\n+        String storedJarPath = \"platform-libs/storedJar.jar\";\n+\n+        // Build the project\n+        String[] compileArgs = {\"--all\", \"--skip-tests\"};\n+        BuildCommand buildCommand = new BuildCommand(this.testResources, printStream, printStream,\n+                false, true);\n+        new CommandLine(buildCommand).parse(compileArgs);\n+        // default scope\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertTrue(isJarExists(baloZipFile, storedJarPath));\n+\n+        // package scope\n+        copy(scopeToml.resolve(\"case1\").resolve(ProjectDirConstants.MANIFEST_FILE_NAME),\n+                this.testResources.resolve(ProjectDirConstants.MANIFEST_FILE_NAME));\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertTrue(isJarExists(baloZipFile, storedJarPath));\n+\n+        // package scope\n+        copy(scopeToml.resolve(\"case2\").resolve(ProjectDirConstants.MANIFEST_FILE_NAME),\n+                this.testResources.resolve(ProjectDirConstants.MANIFEST_FILE_NAME));\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertFalse(isJarExists(baloZipFile, storedJarPath));\n+\n+        // compile scope", "originalCommit": "04fdfa54a580ec8fa1603dc67157d4d5db347f17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwMzYyMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r413503621", "bodyText": "When checking the Ballerina.toml file, it looks like \"case2\" should be the \"compile\" scope.", "author": "IrushiL", "createdAt": "2020-04-23T04:40:54Z", "path": "cli/ballerina-packerina/src/test/java/org/ballerinalang/packerina/cmd/DependencyScopeTest.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.ballerinalang.packerina.cmd;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+import org.wso2.ballerinalang.compiler.util.ProjectDirConstants;\n+import org.wso2.ballerinalang.programfile.ProgramFileConstants;\n+import picocli.CommandLine;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.zip.ZipFile;\n+\n+import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;\n+import static org.wso2.ballerinalang.compiler.util.ProjectDirConstants.BLANG_COMPILED_PKG_BINARY_EXT;\n+\n+/**\n+ * Dependency scope tests.\n+ *\n+ * @since 1.2.x\n+ */\n+public class DependencyScopeTest extends CommandTest {\n+\n+    private Path testResources;\n+    private URI testResourcesURI;\n+\n+    @BeforeClass\n+    public void setup() throws IOException {\n+        super.setup();\n+        try {\n+            this.testResources = super.tmpDir.resolve(\"scope-test-resources\");\n+            testResourcesURI = getClass().getClassLoader().getResource(\"test-resources\").toURI();\n+            Path storedJarDependencyProject = Paths.get(testResourcesURI).resolve(\"stored-jar-dependency-project\");\n+            Files.walkFileTree(storedJarDependencyProject, new BuildCommandTest.Copy(storedJarDependencyProject,\n+                    this.testResources));\n+        } catch (URISyntaxException e) {\n+            Assert.fail(\"error loading resources\");\n+        }\n+    }\n+\n+    @Test(description = \"Test if platform libs are packed with the balo based on the scope.\")\n+    public void testBuildCommandWithStoredJarDependency() throws IOException {\n+        String baloFileName = \"mymodule-\" + ProgramFileConstants.IMPLEMENTATION_VERSION + \"-java8-0.1.0\"\n+                + BLANG_COMPILED_PKG_BINARY_EXT;\n+        Path balo = this.testResources.resolve(ProjectDirConstants.TARGET_DIR_NAME).\n+                resolve(ProjectDirConstants.TARGET_BALO_DIRECTORY);\n+        File baloFile = new File(balo.toString() + File.separator + baloFileName);\n+        File baloZipFile = new File(balo.toString() + File.separator +\n+                baloFileName.concat(\".zip\"));\n+        Path scopeToml = Paths.get(testResourcesURI).resolve(\"scope-toml\");\n+        String storedJarPath = \"platform-libs/storedJar.jar\";\n+\n+        // Build the project\n+        String[] compileArgs = {\"--all\", \"--skip-tests\"};\n+        BuildCommand buildCommand = new BuildCommand(this.testResources, printStream, printStream,\n+                false, true);\n+        new CommandLine(buildCommand).parse(compileArgs);\n+        // default scope\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertTrue(isJarExists(baloZipFile, storedJarPath));\n+\n+        // package scope\n+        copy(scopeToml.resolve(\"case1\").resolve(ProjectDirConstants.MANIFEST_FILE_NAME),\n+                this.testResources.resolve(ProjectDirConstants.MANIFEST_FILE_NAME));\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertTrue(isJarExists(baloZipFile, storedJarPath));\n+\n+        // package scope", "originalCommit": "04fdfa54a580ec8fa1603dc67157d4d5db347f17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwNDc0Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r413504747", "bodyText": "This code segment seems to be repeating for all 3 scopes. Is it possible to separate it out and avoid the code duplication?", "author": "IrushiL", "createdAt": "2020-04-23T04:44:26Z", "path": "cli/ballerina-packerina/src/test/java/org/ballerinalang/packerina/cmd/DependencyScopeTest.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.ballerinalang.packerina.cmd;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+import org.wso2.ballerinalang.compiler.util.ProjectDirConstants;\n+import org.wso2.ballerinalang.programfile.ProgramFileConstants;\n+import picocli.CommandLine;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.zip.ZipFile;\n+\n+import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;\n+import static org.wso2.ballerinalang.compiler.util.ProjectDirConstants.BLANG_COMPILED_PKG_BINARY_EXT;\n+\n+/**\n+ * Dependency scope tests.\n+ *\n+ * @since 1.2.x\n+ */\n+public class DependencyScopeTest extends CommandTest {\n+\n+    private Path testResources;\n+    private URI testResourcesURI;\n+\n+    @BeforeClass\n+    public void setup() throws IOException {\n+        super.setup();\n+        try {\n+            this.testResources = super.tmpDir.resolve(\"scope-test-resources\");\n+            testResourcesURI = getClass().getClassLoader().getResource(\"test-resources\").toURI();\n+            Path storedJarDependencyProject = Paths.get(testResourcesURI).resolve(\"stored-jar-dependency-project\");\n+            Files.walkFileTree(storedJarDependencyProject, new BuildCommandTest.Copy(storedJarDependencyProject,\n+                    this.testResources));\n+        } catch (URISyntaxException e) {\n+            Assert.fail(\"error loading resources\");\n+        }\n+    }\n+\n+    @Test(description = \"Test if platform libs are packed with the balo based on the scope.\")\n+    public void testBuildCommandWithStoredJarDependency() throws IOException {\n+        String baloFileName = \"mymodule-\" + ProgramFileConstants.IMPLEMENTATION_VERSION + \"-java8-0.1.0\"\n+                + BLANG_COMPILED_PKG_BINARY_EXT;\n+        Path balo = this.testResources.resolve(ProjectDirConstants.TARGET_DIR_NAME).\n+                resolve(ProjectDirConstants.TARGET_BALO_DIRECTORY);\n+        File baloFile = new File(balo.toString() + File.separator + baloFileName);\n+        File baloZipFile = new File(balo.toString() + File.separator +\n+                baloFileName.concat(\".zip\"));\n+        Path scopeToml = Paths.get(testResourcesURI).resolve(\"scope-toml\");\n+        String storedJarPath = \"platform-libs/storedJar.jar\";\n+\n+        // Build the project\n+        String[] compileArgs = {\"--all\", \"--skip-tests\"};\n+        BuildCommand buildCommand = new BuildCommand(this.testResources, printStream, printStream,\n+                false, true);\n+        new CommandLine(buildCommand).parse(compileArgs);\n+        // default scope\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertTrue(isJarExists(baloZipFile, storedJarPath));\n+\n+        // package scope\n+        copy(scopeToml.resolve(\"case1\").resolve(ProjectDirConstants.MANIFEST_FILE_NAME),\n+                this.testResources.resolve(ProjectDirConstants.MANIFEST_FILE_NAME));\n+        buildCommand.execute();\n+        Assert.assertTrue(Files.exists(balo), \"Check if balo directory exists\");\n+\n+        // Check whether dependency jars getting packed to balo\n+        Assert.assertTrue(renameFile(baloFile, baloZipFile));\n+        Assert.assertTrue(isJarExists(baloZipFile, storedJarPath));", "originalCommit": "04fdfa54a580ec8fa1603dc67157d4d5db347f17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxMTE3OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r413511178", "bodyText": "May be we can have three test cases for each scope which will be more clear", "author": "warunalakshitha", "createdAt": "2020-04-23T05:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwNDc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwNjMwOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r413506308", "bodyText": "This method does not seem to be used, but the scope should be set somewhere as far as I understand. Am I missing something here?", "author": "IrushiL", "createdAt": "2020-04-23T04:49:26Z", "path": "compiler/ballerina-lang/src/main/java/org/ballerinalang/toml/model/Library.java", "diffHunk": "@@ -68,4 +69,12 @@ public String getArtifactId() {\n     public void setArtifactId(String artifactId) {\n         this.artifactId = artifactId;\n     }\n+\n+    public String getScope() {\n+        return scope;\n+    }\n+\n+    public void setScope(String scope) {", "originalCommit": "04fdfa54a580ec8fa1603dc67157d4d5db347f17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzMTE2MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r413531161", "bodyText": "Yes we can remove the setter", "author": "suganyasuven", "createdAt": "2020-04-23T06:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwNjMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwNjUwNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r413506504", "bodyText": "Can we make this a private field?", "author": "IrushiL", "createdAt": "2020-04-23T04:50:04Z", "path": "compiler/ballerina-lang/src/main/java/org/ballerinalang/toml/model/Library.java", "diffHunk": "@@ -28,6 +28,7 @@\n     public String path;\n     public String groupId;\n     public String[] modules;\n+    public String scope;", "originalCommit": "04fdfa54a580ec8fa1603dc67157d4d5db347f17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxMDc0Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r413510747", "bodyText": "Shall we replace with for loop without using java streams.", "author": "warunalakshitha", "createdAt": "2020-04-23T05:03:03Z", "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/writer/BaloFileWriter.java", "diffHunk": "@@ -298,15 +295,15 @@ private void addModuleDoc(Path root, Path moduleSourceDir) throws IOException {\n         }\n     }\n \n-    private void addPlatformLibs(Path root, Path projectDirectory, String moduleName,\n-                                 HashSet<Path> moduleDependencyList) throws IOException {\n+    private void addPlatformLibs(Path root, Path projectDirectory, String moduleName) throws IOException {\n         //If platform libs are defined add them to balo\n         if (null != manifest.getPlatform().libraries) {\n             Path platformLibsDir = root.resolve(ProjectDirConstants.BALO_PLATFORM_LIB_DIR_NAME);\n             Files.createDirectory(platformLibsDir);\n \n             List<Path> libs = manifest.getPlatform().libraries.stream()\n-                    .filter(lib -> lib.getModules() == null || Arrays.asList(lib.getModules()).contains(moduleName))\n+                    .filter(lib -> (lib.getModules() == null || Arrays.asList(lib.getModules()).contains(moduleName))", "originalCommit": "04fdfa54a580ec8fa1603dc67157d4d5db347f17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91a52bf95ea27721b95676514d744c689adb751a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/91a52bf95ea27721b95676514d744c689adb751a", "message": "Fix review comments", "committedDate": "2020-04-23T14:43:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMwNjg0Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r414306847", "bodyText": "Should be 1.3.0", "author": "warunalakshitha", "createdAt": "2020-04-24T05:38:01Z", "path": "cli/ballerina-packerina/src/test/java/org/ballerinalang/packerina/cmd/DependencyScopeTest.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.ballerinalang.packerina.cmd;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+import org.wso2.ballerinalang.compiler.util.ProjectDirConstants;\n+import org.wso2.ballerinalang.programfile.ProgramFileConstants;\n+import picocli.CommandLine;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.zip.ZipFile;\n+\n+import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;\n+import static org.wso2.ballerinalang.compiler.util.ProjectDirConstants.BLANG_COMPILED_PKG_BINARY_EXT;\n+\n+/**\n+ * Dependency scope tests.\n+ *\n+ * @since 1.2.x", "originalCommit": "91a52bf95ea27721b95676514d744c689adb751a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "960fdb726065d563156f14b75bc88c785aeda0f4", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/960fdb726065d563156f14b75bc88c785aeda0f4", "message": "Add integration tests for scoping jar dependencies", "committedDate": "2020-04-28T06:45:26Z", "type": "commit"}, {"oid": "34de50ca0b01c20a82943c64356cf8426fa9b447", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/34de50ca0b01c20a82943c64356cf8426fa9b447", "message": "Validate platform libs of the balo when copying native libs", "committedDate": "2020-05-04T11:33:28Z", "type": "commit"}, {"oid": "28c4b18b7449278bf69349dc29f9a8744ce4e47b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/28c4b18b7449278bf69349dc29f9a8744ce4e47b", "message": "Add test to validate platform libs of the balo", "committedDate": "2020-05-04T11:51:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2MDU0OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r420560549", "bodyText": "If I import 2 modules (mod1, mod2) and mod1 has compiler dependency and same compiler dependency add as default in mod2. So that dependency will be packed in mod2 balo and at runtime everything will work fine. But still warning message will be shown during compilation as per below logic. Shall we fix that case as well", "author": "warunalakshitha", "createdAt": "2020-05-06T05:58:51Z", "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/task/CopyNativeLibTask.java", "diffHunk": "@@ -239,6 +243,42 @@ private void copyLibsFromBalo(Path baloFilePath, Set<Path> moduleDependencySet)\n         }\n     }\n \n+    private void copyAndValidateBaloDependencies(BuildContext buildContext, Path importDependencyPath,", "originalCommit": "28c4b18b7449278bf69349dc29f9a8744ce4e47b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2NzI2Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r420567263", "bodyText": "Still, we need that warning message as dependencies of mod2 will be copied to the  mod2 and the current module only. For compiling mod1, we need to copy that dependency to mod1. As we are copying the dependencies based on the modules, the user have to define that dependency for mod1 as well. Please correct me if I'm wrong.", "author": "suganyasuven", "createdAt": "2020-05-06T06:20:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2MDU0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2MjIzNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r420562235", "bodyText": "This logic has performance impact due to loop inside loop. Can we collect all compiler libs of balos in a hash set( key can be orgname+ packageid+ artfactID+ filename) and default libs two another set. Then we can compare those two hashsets two check first one is subset of default(packing) libs.", "author": "warunalakshitha", "createdAt": "2020-05-06T06:04:15Z", "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/task/CopyNativeLibTask.java", "diffHunk": "@@ -239,6 +243,42 @@ private void copyLibsFromBalo(Path baloFilePath, Set<Path> moduleDependencySet)\n         }\n     }\n \n+    private void copyAndValidateBaloDependencies(BuildContext buildContext, Path importDependencyPath,\n+                                                 PackageID packageID, Path project, Set<Path> moduleDependencySet) {\n+        Manifest manifestFromBalo = RepoUtils.getManifestFromBalo(importDependencyPath);\n+        List<Library> baloDependencies = manifestFromBalo.getPlatform().libraries;\n+\n+        if (baloDependencies == null) {\n+            return;\n+        }\n+\n+        // If platform libs are defined, copy them to target\n+        List<Library> libraries = manifest.getPlatform().libraries;\n+        for (Library baloTomlLib : baloDependencies) {", "originalCommit": "28c4b18b7449278bf69349dc29f9a8744ce4e47b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2836a1d26a03c03d55a16819a0341eab974ec7e0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2836a1d26a03c03d55a16819a0341eab974ec7e0", "message": "Add suggested changes", "committedDate": "2020-05-09T16:40:45Z", "type": "commit"}, {"oid": "c5811f951addb179058dd90eed9e59bfb7b1f18d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c5811f951addb179058dd90eed9e59bfb7b1f18d", "message": "Merge branch 'master' into scoping-jar", "committedDate": "2020-05-09T16:51:38Z", "type": "commit"}, {"oid": "94d7345bb9412f0269e9f2ee238c428caf51eeaf", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/94d7345bb9412f0269e9f2ee238c428caf51eeaf", "message": "Update with the latest changes in the scope spec", "committedDate": "2020-05-11T07:32:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY2NTk3MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22817#discussion_r425665970", "bodyText": "can we check !platformLibs.contains(baloTomlLib) and then log warning. so we can get rid of 276 to 280 lines", "author": "warunalakshitha", "createdAt": "2020-05-15T09:03:51Z", "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/task/CopyNativeLibTask.java", "diffHunk": "@@ -239,6 +244,46 @@ private void copyLibsFromBalo(Path baloFilePath, Set<Path> moduleDependencySet)\n         }\n     }\n \n+    private void copyAndValidateBaloDependencies(BuildContext buildContext, Path importDependencyPath,\n+                                                 PackageID packageID, Path project, Set<Path> moduleDependencySet) {\n+        Manifest manifestFromBalo = RepoUtils.getManifestFromBalo(importDependencyPath);\n+        List<Library> baloDependencies = manifestFromBalo.getPlatform().libraries;\n+        List<Library> libraries = manifest.getPlatform().libraries;\n+        HashSet<Path> baloCompileScopeDependencies = new HashSet<>();\n+        HashSet<Path> platformLibs = new HashSet<>();\n+\n+        if (baloDependencies == null) {\n+            return;\n+        }\n+\n+        for (Library baloTomlLib : baloDependencies) {\n+            if (baloTomlLib.getScope() != null && baloTomlLib.getScope().equalsIgnoreCase(\"provided\")) {\n+                baloCompileScopeDependencies.add(Paths.get(baloTomlLib.getPath()).getFileName());\n+            }\n+        }\n+\n+        if (libraries != null) {\n+            for (Library library : libraries) {\n+                if (Arrays.asList(library.getModules()).contains(packageID.orgName.value + \"/\" +\n+                        packageID.name.value)) {\n+                    Path libFilePath = Paths.get(library.getPath());\n+                    platformLibs.add(libFilePath.getFileName());\n+                    moduleDependencySet.add(project.resolve(libFilePath));\n+                }\n+            }\n+        }\n+\n+        if (platformLibs.containsAll(baloCompileScopeDependencies)) {\n+            return;\n+        }\n+\n+        baloCompileScopeDependencies.removeAll(platformLibs);\n+        for (Path baloTomlLib : baloCompileScopeDependencies) {\n+            buildContext.out().println(\"warning: \" + packageID + \" is missing a native library dependency - \" +", "originalCommit": "94d7345bb9412f0269e9f2ee238c428caf51eeaf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "efa477ef659ac4dcb8ecf20bb54f856ab32f5d78", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/efa477ef659ac4dcb8ecf20bb54f856ab32f5d78", "message": "Apply suggested change", "committedDate": "2020-05-15T09:58:47Z", "type": "commit"}]}