{"pr_number": 27544, "pr_title": "Allow `readonly` intersection types with classes and allow `readonly class` types in `readonly` record fields", "pr_createdAt": "2020-12-17T07:08:06Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/27544", "timeline": [{"oid": "c22d665c4d049ffe6ca114d6aa4ac314941ae913", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c22d665c4d049ffe6ca114d6aa4ac314941ae913", "message": "Fix using readonly with classes\n\nAllow using readonly intersections with classes and allow using a readonly class as the type of a readonly record field.", "committedDate": "2020-12-16T16:24:31Z", "type": "commit"}, {"oid": "1a57e8d8413e162f32561ffe1a53bdd6217b15b9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1a57e8d8413e162f32561ffe1a53bdd6217b15b9", "message": "Fix all field compatibility check and fix tests", "committedDate": "2020-12-16T17:20:06Z", "type": "commit"}, {"oid": "1dd4a31d076971a16593bcfcb91e6c44c9f18ba5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1dd4a31d076971a16593bcfcb91e6c44c9f18ba5", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into fix-readonly-deviations", "committedDate": "2020-12-17T04:04:12Z", "type": "commit"}, {"oid": "86f556b2975a781922133c7e82ae18485acc4550", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/86f556b2975a781922133c7e82ae18485acc4550", "message": "Add tests for classes as readonly record fields", "committedDate": "2020-12-17T05:09:19Z", "type": "commit"}, {"oid": "07010e33df9952eeeb4382dc737fd124016dad5d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/07010e33df9952eeeb4382dc737fd124016dad5d", "message": "Add tests for readonly intersections with classes", "committedDate": "2020-12-17T06:28:20Z", "type": "commit"}, {"oid": "864da4a1918875ab9795025a6d844de4607ef3fc", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/864da4a1918875ab9795025a6d844de4607ef3fc", "message": "Add readonly record field test for implicitly readonly class", "committedDate": "2020-12-17T07:00:40Z", "type": "commit"}, {"oid": "b2d75b370bb0fcb653e4799adde573f6a2ba5b75", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b2d75b370bb0fcb653e4799adde573f6a2ba5b75", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into fix-readonly-deviations", "committedDate": "2020-12-18T04:53:18Z", "type": "commit"}, {"oid": "647e8c2a9f0e55ab8aecb17200e5bea7ae143240", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/647e8c2a9f0e55ab8aecb17200e5bea7ae143240", "message": "Fix readonly flag not being set for compliant anon records", "committedDate": "2020-12-18T14:22:45Z", "type": "commit"}, {"oid": "71afbb5e3a798394d8720888807a455453300853", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/71afbb5e3a798394d8720888807a455453300853", "message": "Add tests", "committedDate": "2020-12-18T15:03:36Z", "type": "commit"}, {"oid": "983501c704a0447b3e5b0f66d17b335c38ac22f6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/983501c704a0447b3e5b0f66d17b335c38ac22f6", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into fix-readonly-deviations", "committedDate": "2021-01-04T05:26:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjUwNzU5OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27544#discussion_r552507598", "bodyText": "Can we extract a method here", "author": "rdhananjaya", "createdAt": "2021-01-06T10:59:20Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/SemanticAnalyzer.java", "diffHunk": "@@ -602,7 +607,53 @@ public void visit(BLangObjectTypeNode objectTypeNode) {\n     @Override\n     public void visit(BLangRecordTypeNode recordTypeNode) {\n         SymbolEnv recordEnv = SymbolEnv.createTypeEnv(recordTypeNode, recordTypeNode.symbol.scope, env);\n-        recordTypeNode.fields.forEach(field -> analyzeDef(field, recordEnv));\n+\n+        BType type = recordTypeNode.type;\n+\n+        boolean isRecordType = false;\n+        LinkedHashMap<String, BField> fields = null;\n+\n+        boolean allReadOnlyFields = false;\n+\n+        if (type.tag == TypeTags.RECORD) {\n+            isRecordType = true;\n+\n+            BRecordType recordType = (BRecordType) type;\n+            fields = recordType.fields;\n+            allReadOnlyFields = recordType.sealed;\n+        }\n+\n+        for (BLangSimpleVariable field : recordTypeNode.fields) {\n+            if (field.flagSet.contains(Flag.READONLY)) {\n+                BType fieldType = field.type;\n+\n+                if (fieldType == symTable.semanticError) {\n+                    continue;\n+                }\n+\n+                BType readOnlyFieldType = getReadOnlyFieldType(field.pos, fieldType);\n+\n+                if (readOnlyFieldType == symTable.semanticError) {\n+                    dlog.error(field.pos, DiagnosticErrorCode.INVALID_READONLY_FIELD_TYPE, fieldType);\n+                } else {\n+                    if (isRecordType) {\n+                        fields.get(field.name.value).type = readOnlyFieldType;\n+                    }\n+\n+                    field.type = field.symbol.type = readOnlyFieldType;\n+                }\n+            } else {\n+                allReadOnlyFields = false;\n+            }", "originalCommit": "983501c704a0447b3e5b0f66d17b335c38ac22f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjY2Njc0Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27544#discussion_r552666746", "bodyText": "Moved the logic in the if block to a separate method in af704cb.", "author": "MaryamZi", "createdAt": "2021-01-06T14:33:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjUwNzU5OA=="}], "type": "inlineReview"}, {"oid": "6180f72a5ba0341ac93081b43df6f5e7ce2dc29f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6180f72a5ba0341ac93081b43df6f5e7ce2dc29f", "message": "Resolve conflicts and merge branch 'master' of https://github.com/ballerina-lang/ballerina into fix-readonly-deviations", "committedDate": "2021-01-06T13:49:44Z", "type": "commit"}, {"oid": "af704cb38e707b6ed10f05520e7e08936ec15fa2", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/af704cb38e707b6ed10f05520e7e08936ec15fa2", "message": "Refactor code", "committedDate": "2021-01-06T14:34:27Z", "type": "commit"}, {"oid": "af704cb38e707b6ed10f05520e7e08936ec15fa2", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/af704cb38e707b6ed10f05520e7e08936ec15fa2", "message": "Refactor code", "committedDate": "2021-01-06T14:34:27Z", "type": "forcePushed"}]}