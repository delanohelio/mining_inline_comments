{"pr_number": 23703, "pr_title": "Fix unnecessary <any|error> type passing for map store access. ", "pr_createdAt": "2020-06-03T14:18:16Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/23703", "timeline": [{"oid": "b26c73fbd0979bcc1b3d25e45d064e9d9a400911", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b26c73fbd0979bcc1b3d25e45d064e9d9a400911", "message": "Add new line for checkstyle", "committedDate": "2020-06-04T06:24:59Z", "type": "forcePushed"}, {"oid": "606256e6ec2e85ecb5c3850aaae41b84bb9cbae3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/606256e6ec2e85ecb5c3850aaae41b84bb9cbae3", "message": "Add new line for checkstyle", "committedDate": "2020-06-04T09:02:36Z", "type": "forcePushed"}, {"oid": "2644389a5d0db25f683c19b3d5de5a9006454180", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2644389a5d0db25f683c19b3d5de5a9006454180", "message": "Rename test variable to be clear", "committedDate": "2020-06-08T05:34:48Z", "type": "forcePushed"}, {"oid": "ead4e55ccfb7adaf5f6eefbc02239cbcdca3d60d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ead4e55ccfb7adaf5f6eefbc02239cbcdca3d60d", "message": "Rename test variable to be clear", "committedDate": "2020-06-08T06:39:49Z", "type": "forcePushed"}, {"oid": "d9dda84f67500ae9b82db54ab0cb6cc8f751f0e8", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d9dda84f67500ae9b82db54ab0cb6cc8f751f0e8", "message": "Modify unit test", "committedDate": "2020-06-08T15:26:38Z", "type": "forcePushed"}, {"oid": "ab0369f57b36d25819a79bd69cc7bd42a30ce6b6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ab0369f57b36d25819a79bd69cc7bd42a30ce6b6", "message": "Add EOF line", "committedDate": "2020-06-08T23:47:54Z", "type": "forcePushed"}, {"oid": "68cd957f9b6f44a69d61d713c8e8fc99fd53e5f0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/68cd957f9b6f44a69d61d713c8e8fc99fd53e5f0", "message": "Add EOF line", "committedDate": "2020-06-09T03:22:16Z", "type": "forcePushed"}, {"oid": "d90ee86ef25068cedbcda01f055a8789a6c12a5d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d90ee86ef25068cedbcda01f055a8789a6c12a5d", "message": "Add EOF line", "committedDate": "2020-06-09T07:15:33Z", "type": "forcePushed"}, {"oid": "86b9ed6d905074e6f674693fe8d7c463972f0cbc", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/86b9ed6d905074e6f674693fe8d7c463972f0cbc", "message": "Add EOF line", "committedDate": "2020-06-09T10:46:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5MTk3Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23703#discussion_r437891976", "bodyText": "Thinking out loud, the closure map is a map<any|error> right?\nLooking at the comments and the logic, it seems like there' some legacy code (based on simple basic types vs ref types in the BVM) which may not be valid now.\nSo basically what I believe we've tried to do here is if it is a simple assignment like x = 1; where the ref we're working is on the LHS, we use any|error as the type of index-based access for simple basic types with an eventual cast on the RHS, whereas for ref types we're using the original types (which were compatible with the ref type impl). IIRC, we used to need this in the BVM based implementation (boxing), I'm not sure if we still need to do it in the front-end.\nWhere we have the closure map map<any|error> $innerMap$1.\nx = 1;\nbecomes\n$innerMap$1[\"x\"] = <any> 1;\nThen we have the access on the RHS, where in L1118 we've added a cast to the expected type. Basically, we access the relevant value from the map<any|error> and cast to the expected type.\nint i = x;\nbecomes\nint i = <int> $innerMap$1[\"x\"] ;\nSo coming back to the problem we're trying to solve,\n    var fn = function () {\n        fb.i = 3;\n    };\nit seems like even for this, it goes in the lhsVar path, without the cast. We seem to be returning $innerMap$1[\"fb\"] instead of <Foo|Bar> $innerMap$1[\"fb\"].\nIMO we can do one of the following.\n\nSemantically, a map (map<T>) access on the RHS returns T? so if someone writes this code in Ballerina, the type of access expr will be T on the LHS, but T? on the RHS. With the current changes, we're changing this for both LHS and RHS to T, but I guess i's OK since we know that value is always present in the map. If we are going ahead with this though let's check\na) if this works as expected for simple basic types (int, byte, float, etc.)\nb) if we need the desugar.addConversionExprIfRequired(accessExpr, varRefExpr.type) anymore since the access expression's type is now varRefExpr.type\n\nor\n\nwe need to figure out if we can add the cast on the LHS side also if the current var ref is part of a compound expression.", "author": "MaryamZi", "createdAt": "2020-06-10T06:40:21Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ClosureDesugar.java", "diffHunk": "@@ -1122,28 +1118,6 @@ private void updateClosureVars(BLangSimpleVarRef varRefExpr, BVarSymbol mapSymbo\n         result = rewriteExpr(desugar.addConversionExprIfRequired(accessExpr, varRefExpr.type));", "originalCommit": "86b9ed6d905074e6f674693fe8d7c463972f0cbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "536c244b1d7fc6ddd162ee0774d7f17628bd1ad3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/536c244b1d7fc6ddd162ee0774d7f17628bd1ad3", "message": "Add test to access simple types from function pointer", "committedDate": "2020-06-12T13:14:21Z", "type": "forcePushed"}, {"oid": "4101c4d2c2d6d6afeb09dae644714632a0bc5063", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4101c4d2c2d6d6afeb09dae644714632a0bc5063", "message": "Modify Test case", "committedDate": "2020-06-13T18:01:33Z", "type": "forcePushed"}, {"oid": "399ae02294604d10fabf71c65edf8d654d8aeb8f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/399ae02294604d10fabf71c65edf8d654d8aeb8f", "message": "Remove unnecessary type definition, add unit test", "committedDate": "2020-06-14T00:42:49Z", "type": "commit"}, {"oid": "6cbbc1efc134a7032c5cddc20ff69649faf8f315", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6cbbc1efc134a7032c5cddc20ff69649faf8f315", "message": "Add new line for checkstyle", "committedDate": "2020-06-14T00:42:49Z", "type": "commit"}, {"oid": "239fa1fe7290d15761ad3cd74ca02e5c3c215fe8", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/239fa1fe7290d15761ad3cd74ca02e5c3c215fe8", "message": "Rename test variable to be clear", "committedDate": "2020-06-14T00:42:49Z", "type": "commit"}, {"oid": "940667a43e1d052e78de64d5829567b278b138fa", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/940667a43e1d052e78de64d5829567b278b138fa", "message": "Modify unit test", "committedDate": "2020-06-14T00:42:49Z", "type": "commit"}, {"oid": "f5f1ab189315cc16f707dc2f63e0dd0b167e9a97", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f5f1ab189315cc16f707dc2f63e0dd0b167e9a97", "message": "Add EOF line", "committedDate": "2020-06-14T00:42:49Z", "type": "commit"}, {"oid": "82cfbd38d1bb547318a90a61201297533f8b92fc", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/82cfbd38d1bb547318a90a61201297533f8b92fc", "message": "Add test to access simple types from function pointer", "committedDate": "2020-06-14T00:42:49Z", "type": "commit"}, {"oid": "5ad5d610267e48bc000a161c2bfad7c465fac414", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5ad5d610267e48bc000a161c2bfad7c465fac414", "message": "Modify Test case", "committedDate": "2020-06-14T00:42:49Z", "type": "commit"}, {"oid": "5ad5d610267e48bc000a161c2bfad7c465fac414", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5ad5d610267e48bc000a161c2bfad7c465fac414", "message": "Modify Test case", "committedDate": "2020-06-14T00:42:49Z", "type": "forcePushed"}]}