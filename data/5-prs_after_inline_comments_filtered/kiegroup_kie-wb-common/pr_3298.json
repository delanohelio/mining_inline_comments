{"pr_number": 3298, "pr_title": "KOGITO-1508: Add initial selenium tests for kogito bpmn client", "pr_createdAt": "2020-05-11T10:56:26Z", "pr_url": "https://github.com/kiegroup/kie-wb-common/pull/3298", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1OTA2NQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r422959065", "bodyText": "@romartin @hasys  the editor is not showing upon opening the index.html and only way to make it show was to include these two lines. Removing one of them prevents the tests from seeing the editor.", "author": "domhanak", "createdAt": "2020-05-11T11:00:08Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-kogito-runtime/src/test/java/org/kie/workbench/common/stunner/kogito/client/selenium/BPMNDesignerKogitoSeleniumIT.java", "diffHunk": "@@ -0,0 +1,310 @@\n+/*\n+ * Copyright 2019 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.workbench.common.stunner.kogito.client.selenium;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+import io.github.bonigarcia.wdm.WebDriverManager;\n+import org.apache.commons.io.IOUtils;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TestWatcher;\n+import org.junit.runner.Description;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.JavascriptExecutor;\n+import org.openqa.selenium.OutputType;\n+import org.openqa.selenium.TakesScreenshot;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.WebElement;\n+import org.openqa.selenium.firefox.FirefoxDriver;\n+import org.openqa.selenium.firefox.FirefoxOptions;\n+import org.openqa.selenium.support.ui.ExpectedCondition;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.xmlunit.assertj.XmlAssert;\n+\n+import static org.apache.commons.io.FileUtils.copyFile;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.openqa.selenium.By.className;\n+import static org.openqa.selenium.By.xpath;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.visibilityOfElementLocated;\n+\n+public class BPMNDesignerKogitoSeleniumIT {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(BPMNDesignerKogitoSeleniumIT.class);\n+\n+    private static final String SET_CONTENT_TEMPLATE =\n+            \"gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().setContent(\\\"\\\", '%s')\";\n+    private static final String GET_CONTENT_TEMPLATE =\n+            \"return gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().getContent()\";\n+\n+\n+    private static final String INDEX_HTML = \"target/kie-wb-common-stunner-bpmn-kogito-runtime/index.html\";\n+    private static final String INDEX_HTML_PATH = \"file:///\" + new File(INDEX_HTML).getAbsolutePath();\n+\n+\n+\n+    private static final String NOT_PRESENT_IN_NAVIGATOR = \"' was not present in the process navigator\";\n+    private static final String PROPERTIES_PANEL = \"qe-docks-item-E-DiagramEditorPropertiesScreen\";\n+    private static final String DIAGRAM_EXPLORER = \"qe-docks-item-E-ProjectDiagramExplorerScreen\";\n+    private static final String DIAGRAM_EXPLORER_EXPANDED = \"qe-docks-bar-expanded-E\";\n+    private static final String DIAGRAM_PANEL = \"qe-static-workbench-panel-view\";\n+    private static final String ACE_EDITOR = \"//div[@class='ace_content']\";\n+    private static final String PALETTE = \"//div[@data-field=\\\"kie-palette\\\"]\";\n+    private static final String PALETTE_START_EVENTS_CATEGORY_BUTTON = \"//button[@data-field='categoryItem', @title=`Start Events`]\";\n+    private static final String ERROR_MODAL_DIALOG = \"//div[@class='modal-dialog']\";\n+    private static final String ERROR_MODAL_BODY = \"//div[@class='modal-body']\";\n+\n+    private static final String CREATE_NEW_DIAGRAM_BUTTON = \"//input[@value=\\\"Create new Diagram\\\"]\";\n+\n+    private static final String PROCESS_NODE = \"//div[@data-field='explorerPanelBody']//a[text()='%s']\";\n+\n+    private static final Boolean HEADLESS = Boolean.valueOf(System.getProperty(\"org.kie.bpmn.kogito.browser.headless\"));\n+    private static final String SCREENSHOTS_DIR = System.getProperty(\"org.kie.bpmn.kogito.screenshots.dir\");\n+\n+    /**\n+     * Selenium web driver\n+     */\n+    private WebDriver driver;\n+\n+    /**\n+     * Properties panel of BPMN Designer\n+     */\n+    private WebElement propertiesPanel;\n+\n+    /**\n+     * Start events category button in Palette\n+     */\n+    private WebElement paletteStartEventCategory;\n+\n+    /**\n+     * Explore diagram panel of BPMN Designer\n+     */\n+    private WebElement bpmnDesignerExplorerButton;\n+\n+\n+    @BeforeClass\n+    public static void setupClass() {\n+        WebDriverManager.firefoxdriver().setup();\n+    }\n+\n+    @Before\n+    public void openBPMNDesigner() {\n+        final FirefoxOptions firefoxOptions = new FirefoxOptions();\n+        firefoxOptions.setHeadless(HEADLESS);\n+        driver = new FirefoxDriver(firefoxOptions);\n+        driver.manage().window().maximize();\n+\n+        driver.get(INDEX_HTML_PATH);\n+\n+        // init diagram to initial state to see if we can load properties panel and diagram explorer\n+        setContent(\"\");\n+       ((JavascriptExecutor) driver).executeScript(String.format(SET_CONTENT_TEMPLATE, \"\"));", "originalCommit": "4e40a21eb695d20d7b32efac675b98ec648f180b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3OTg2NA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r428979864", "bodyText": "Hey @domhanak  @hasys\nWe've to be careful on this yeah, good catch, lemme explain:\n\nThe editor's setContent() method returns a Promise, it means the response is asynchronous\nThe API is intentionally done this way because editor's, during loading, are also performing arynchronous operations (eg: fetching icons, other services). So once the editor \"completes\" loading the content being set, it properly resolves the promise.\n\nIt means doing a double setContent call to the editor, although seems to make it work properly, it's NOT correct, it's not the expected way to use it. Errors can appear from this point. You've to properly follow the API...\nSoo I think the right fix is just about taking into account the Promise return type, once calling the setContent method, and please do not call it twice! :)\nLemme know if any Qs. Thanks!", "author": "romartin", "createdAt": "2020-05-22T00:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1OTA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkzNDY2Ng==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r437934666", "bodyText": "There's a synchronous Promise in appformer (somewhere) that you can use to replace the default asynchronous one... @ederign can probably jump straight to where it is (as IIRC it's used by some appformer tests too).", "author": "manstis", "createdAt": "2020-06-10T08:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1OTA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAyMjU5OA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r438022598", "bodyText": "setContent is a helper method (naming just says what it does) that executes\n((JavascriptExecutor) driver).executeScript(String.format(SET_CONTENT_TEMPLATE, \"\"));\nHow should I properly follow the API? When I execute the script manually on test page in console, it loads the editor right away. And I can see in console that it returned a Promise but it's state is pending even after the editor is loaded and content resolved.\nNot sure I follow, in DMN test suite just executing this once ((JavascriptExecutor) driver).executeScript(String.format(SET_CONTENT_TEMPLATE, \"\")); shows the editor.  I do not understand the difference.", "author": "domhanak", "createdAt": "2020-06-10T10:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1OTA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA0Njg3MQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r438046871", "bodyText": "I am a bit confused, the idea is that I will use the Promise from appformer to call setContent in tests, correct?", "author": "domhanak", "createdAt": "2020-06-10T11:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1OTA2NQ=="}], "type": "inlineReview"}, {"oid": "26775be0bfccff201dbfd55ddc83b62ab99f748f", "url": "https://github.com/kiegroup/kie-wb-common/commit/26775be0bfccff201dbfd55ddc83b62ab99f748f", "message": "Add workaround for KOGITO-1795", "committedDate": "2020-05-12T05:38:02Z", "type": "forcePushed"}, {"oid": "46f62c9dd787200ae0152e4bef57316e45fb727d", "url": "https://github.com/kiegroup/kie-wb-common/commit/46f62c9dd787200ae0152e4bef57316e45fb727d", "message": "Add workaround for KOGITO-1795", "committedDate": "2020-05-18T11:46:21Z", "type": "forcePushed"}, {"oid": "3a5e7f996e3db6e05b970fc29062fdc8447f2abe", "url": "https://github.com/kiegroup/kie-wb-common/commit/3a5e7f996e3db6e05b970fc29062fdc8447f2abe", "message": "KOGITO-1508: Fix test precondition wait", "committedDate": "2020-06-22T08:35:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkyOTIzNg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r446929236", "bodyText": "This test should pass already.", "author": "hasys", "createdAt": "2020-06-29T12:24:31Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-kogito-runtime/src/test/java/org/kie/workbench/common/stunner/kogito/client/selenium/BPMNDesignerKogitoSeleniumIT.java", "diffHunk": "@@ -0,0 +1,306 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.workbench.common.stunner.kogito.client.selenium;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+import io.github.bonigarcia.wdm.WebDriverManager;\n+import org.apache.commons.io.IOUtils;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Ignore;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TestWatcher;\n+import org.junit.runner.Description;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.JavascriptExecutor;\n+import org.openqa.selenium.OutputType;\n+import org.openqa.selenium.TakesScreenshot;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.WebElement;\n+import org.openqa.selenium.firefox.FirefoxDriver;\n+import org.openqa.selenium.firefox.FirefoxOptions;\n+import org.openqa.selenium.support.ui.ExpectedCondition;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.xmlunit.assertj.XmlAssert;\n+\n+import static org.apache.commons.io.FileUtils.copyFile;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.openqa.selenium.By.className;\n+import static org.openqa.selenium.By.xpath;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.visibilityOfElementLocated;\n+\n+public class BPMNDesignerKogitoSeleniumIT {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(BPMNDesignerKogitoSeleniumIT.class);\n+\n+    private static final String SET_CONTENT_TEMPLATE =\n+            \"gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().setContent(\\\"\\\", '%s')\";\n+    private static final String GET_CONTENT_TEMPLATE =\n+            \"return gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().getContent()\";\n+\n+    private static final String INDEX_HTML = \"target/kie-wb-common-stunner-bpmn-kogito-runtime/index.html\";\n+    private static final String INDEX_HTML_PATH = \"file:///\" + new File(INDEX_HTML).getAbsolutePath();\n+\n+    private static final String NOT_PRESENT_IN_NAVIGATOR = \"' was not present in the process navigator\";\n+    private static final String PROPERTIES_PANEL = \"qe-docks-item-E-DiagramEditorPropertiesScreen\";\n+    private static final String DIAGRAM_EXPLORER = \"qe-docks-item-E-ProjectDiagramExplorerScreen\";\n+    private static final String DIAGRAM_EXPLORER_EXPANDED = \"qe-docks-bar-expanded-E\";\n+    private static final String DIAGRAM_PANEL = \"qe-static-workbench-panel-view\";\n+    private static final String ACE_EDITOR = \"//div[@class='ace_content']\";\n+    private static final String ERROR_MODAL_DIALOG = \"//div[@class='modal-dialog']\";\n+    private static final String ERROR_MODAL_BODY = \"//div[@class='modal-body']\";\n+    private static final String PROCESS_NODE = \"//div[@data-field='explorerPanelBody']//a[text()='%s']\";\n+    private static final Boolean HEADLESS = Boolean.valueOf(System.getProperty(\"org.kie.bpmn.kogito.browser.headless\"));\n+    private static final String SCREENSHOTS_DIR = System.getProperty(\"org.kie.bpmn.kogito.screenshots.dir\");\n+\n+    /**\n+     * Selenium web driver\n+     */\n+    private WebDriver driver;\n+\n+    /**\n+     * Properties panel of BPMN Designer\n+     */\n+    private WebElement propertiesPanel;\n+\n+    /**\n+     * Explore diagram panel of BPMN Designer\n+     */\n+    private WebElement bpmnDesignerExplorerButton;\n+\n+    @BeforeClass\n+    public static void setupClass() {\n+        WebDriverManager.firefoxdriver().setup();\n+    }\n+\n+    @Before\n+    public void openBPMNDesigner() {\n+        final FirefoxOptions firefoxOptions = new FirefoxOptions();\n+        firefoxOptions.setHeadless(HEADLESS);\n+        driver = new FirefoxDriver(firefoxOptions);\n+        driver.manage().window().maximize();\n+\n+        driver.get(INDEX_HTML_PATH);\n+\n+        final WebElement designer = waitOperation()\n+                .until(presenceOfElementLocated(className(DIAGRAM_PANEL)));\n+        assertThat(designer)\n+                .as(\"Diagram panel is a prerequisite for all tests. \" +\n+                            \"its absence is indicator of designer load fail.\")\n+                .isNotNull();\n+    }\n+\n+    private final File screenshotDirectory = initScreenshotDirectory();\n+\n+    @Rule\n+    public TestWatcher takeScreenShotAndCleanUp = new TestWatcher() {\n+        @Override\n+        protected void failed(Throwable e, Description description) {\n+            final File screenshotFile = ((TakesScreenshot) driver).getScreenshotAs(OutputType.FILE);\n+            final String testClassName = description.getTestClass().getSimpleName();\n+            final String testMethodName = description.getMethodName();\n+            final String filename = testClassName + \"_\" + testMethodName;\n+            try {\n+                copyFile(screenshotFile, new File(screenshotDirectory, filename + \".png\"));\n+            } catch (IOException ioe) {\n+                LOG.error(\"Unable to take screenshot\", ioe);\n+            }\n+        }\n+\n+        @Override\n+        protected void finished(Description description) {\n+            if (driver != null) {\n+                driver.quit();\n+            }\n+        }\n+    };\n+\n+    @Test\n+    @Ignore", "originalCommit": "3a5e7f996e3db6e05b970fc29062fdc8447f2abe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkzMDc1MQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r446930751", "bodyText": "Thanks, Ill fix.", "author": "domhanak", "createdAt": "2020-06-29T12:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkyOTIzNg=="}], "type": "inlineReview"}, {"oid": "2d56d3f5943711eea5dae23b7349264308aa03aa", "url": "https://github.com/kiegroup/kie-wb-common/commit/2d56d3f5943711eea5dae23b7349264308aa03aa", "message": "Unignore fixed test", "committedDate": "2020-06-29T13:48:06Z", "type": "forcePushed"}, {"oid": "24175db63c242f65e8e5ff576e06b2ea317e794d", "url": "https://github.com/kiegroup/kie-wb-common/commit/24175db63c242f65e8e5ff576e06b2ea317e794d", "message": "Unignore fixed test", "committedDate": "2020-07-14T07:56:36Z", "type": "forcePushed"}, {"oid": "57cd87977e57e93025759d2de1d486f9249e5c1b", "url": "https://github.com/kiegroup/kie-wb-common/commit/57cd87977e57e93025759d2de1d486f9249e5c1b", "message": "KOGITO-1508: Add initial selenium tests for kogito client", "committedDate": "2020-07-30T07:59:53Z", "type": "commit"}, {"oid": "420f12e892e09f6030998544a7e9d15f83118bab", "url": "https://github.com/kiegroup/kie-wb-common/commit/420f12e892e09f6030998544a7e9d15f83118bab", "message": "Add workaround for KOGITO-1795", "committedDate": "2020-07-30T07:59:53Z", "type": "commit"}, {"oid": "721d6b33d228fddd22812fd90ad13ec1c1773bd9", "url": "https://github.com/kiegroup/kie-wb-common/commit/721d6b33d228fddd22812fd90ad13ec1c1773bd9", "message": "Ignore invalid content test", "committedDate": "2020-07-30T07:59:53Z", "type": "commit"}, {"oid": "fab5839d2cec86e02ca77dfd434ddd8deae1f021", "url": "https://github.com/kiegroup/kie-wb-common/commit/fab5839d2cec86e02ca77dfd434ddd8deae1f021", "message": "Fix resource not having updated package", "committedDate": "2020-07-30T07:59:53Z", "type": "commit"}, {"oid": "857a02870d80c0801536e4a2320fe8ecc6fca34a", "url": "https://github.com/kiegroup/kie-wb-common/commit/857a02870d80c0801536e4a2320fe8ecc6fca34a", "message": "KOGITO-1508: Fix test precondition wait", "committedDate": "2020-07-30T07:59:53Z", "type": "commit"}, {"oid": "44de5c614b41ae92aa4f3371886a2691db5d865d", "url": "https://github.com/kiegroup/kie-wb-common/commit/44de5c614b41ae92aa4f3371886a2691db5d865d", "message": "Unignore fixed test", "committedDate": "2020-07-30T07:59:53Z", "type": "commit"}, {"oid": "44de5c614b41ae92aa4f3371886a2691db5d865d", "url": "https://github.com/kiegroup/kie-wb-common/commit/44de5c614b41ae92aa4f3371886a2691db5d865d", "message": "Unignore fixed test", "committedDate": "2020-07-30T07:59:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2NzA3NQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r464967075", "bodyText": "This can be simplified:\n        final WebElement designer = waitOperation()\n                .withMessage(\"Diagram panel is a prerequisite for all tests. \" +\n                            \"its absence is indicator of designer load fail.\")\n                .until(presenceOfElementLocated(className(DIAGRAM_PANEL)));", "author": "jomarko", "createdAt": "2020-08-04T10:55:35Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-kogito-runtime/src/test/java/org/kie/workbench/common/stunner/kogito/client/selenium/BPMNDesignerKogitoSeleniumIT.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.workbench.common.stunner.kogito.client.selenium;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+import io.github.bonigarcia.wdm.WebDriverManager;\n+import org.apache.commons.io.IOUtils;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TestWatcher;\n+import org.junit.runner.Description;\n+import org.openqa.selenium.JavascriptExecutor;\n+import org.openqa.selenium.OutputType;\n+import org.openqa.selenium.TakesScreenshot;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.WebElement;\n+import org.openqa.selenium.firefox.FirefoxDriver;\n+import org.openqa.selenium.firefox.FirefoxOptions;\n+import org.openqa.selenium.support.ui.ExpectedCondition;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.xmlunit.assertj.XmlAssert;\n+\n+import static org.apache.commons.io.FileUtils.copyFile;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.openqa.selenium.By.className;\n+import static org.openqa.selenium.By.xpath;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.visibilityOfElementLocated;\n+\n+public class BPMNDesignerKogitoSeleniumIT {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(BPMNDesignerKogitoSeleniumIT.class);\n+\n+    private static final String SET_CONTENT_TEMPLATE =\n+            \"gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().setContent(\\\"\\\", '%s')\";\n+    private static final String GET_CONTENT_TEMPLATE =\n+            \"return gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().getContent()\";\n+\n+    private static final String INDEX_HTML = \"target/kie-wb-common-stunner-bpmn-kogito-runtime/index.html\";\n+    private static final String INDEX_HTML_PATH = \"file:///\" + new File(INDEX_HTML).getAbsolutePath();\n+\n+    private static final String NOT_PRESENT_IN_NAVIGATOR = \"' was not present in the process navigator\";\n+    private static final String PROPERTIES_PANEL = \"qe-docks-item-E-DiagramEditorPropertiesScreen\";\n+    private static final String DIAGRAM_EXPLORER = \"qe-docks-item-E-ProjectDiagramExplorerScreen\";\n+    private static final String DIAGRAM_EXPLORER_EXPANDED = \"qe-docks-bar-expanded-E\";\n+    private static final String DIAGRAM_PANEL = \"qe-static-workbench-panel-view\";\n+    private static final String ACE_EDITOR = \"//div[@class='ace_content']\";\n+    private static final String ERROR_MODAL_DIALOG = \"//div[@class='modal-dialog']\";\n+    private static final String ERROR_MODAL_BODY = \"//div[@class='modal-body']\";\n+    private static final String PROCESS_NODE = \"//div[@data-field='explorerPanelBody']//a[text()='%s']\";\n+    private static final Boolean HEADLESS = Boolean.valueOf(System.getProperty(\"org.kie.bpmn.kogito.browser.headless\"));\n+    private static final String SCREENSHOTS_DIR = System.getProperty(\"org.kie.bpmn.kogito.screenshots.dir\");\n+\n+    /**\n+     * Selenium web driver\n+     */\n+    private WebDriver driver;\n+\n+    /**\n+     * Properties panel of BPMN Designer\n+     */\n+    private WebElement propertiesPanel;\n+\n+    /**\n+     * Explore diagram panel of BPMN Designer\n+     */\n+    private WebElement bpmnDesignerExplorerButton;\n+\n+    @BeforeClass\n+    public static void setupClass() {\n+        WebDriverManager.firefoxdriver().setup();\n+    }\n+\n+    @Before\n+    public void openBPMNDesigner() {\n+        final FirefoxOptions firefoxOptions = new FirefoxOptions();\n+        firefoxOptions.setHeadless(HEADLESS);\n+        driver = new FirefoxDriver(firefoxOptions);\n+        driver.manage().window().maximize();\n+\n+        driver.get(INDEX_HTML_PATH);\n+\n+        final WebElement designer = waitOperation()\n+                .until(presenceOfElementLocated(className(DIAGRAM_PANEL)));\n+        assertThat(designer)\n+                .as(\"Diagram panel is a prerequisite for all tests. \" +\n+                            \"its absence is indicator of designer load fail.\")\n+                .isNotNull();", "originalCommit": "44de5c614b41ae92aa4f3371886a2691db5d865d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2NzIwOQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r464967209", "bodyText": "Similar comment as above", "author": "jomarko", "createdAt": "2020-08-04T10:55:52Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-kogito-runtime/src/test/java/org/kie/workbench/common/stunner/kogito/client/selenium/BPMNDesignerKogitoSeleniumIT.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.workbench.common.stunner.kogito.client.selenium;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+import io.github.bonigarcia.wdm.WebDriverManager;\n+import org.apache.commons.io.IOUtils;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TestWatcher;\n+import org.junit.runner.Description;\n+import org.openqa.selenium.JavascriptExecutor;\n+import org.openqa.selenium.OutputType;\n+import org.openqa.selenium.TakesScreenshot;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.WebElement;\n+import org.openqa.selenium.firefox.FirefoxDriver;\n+import org.openqa.selenium.firefox.FirefoxOptions;\n+import org.openqa.selenium.support.ui.ExpectedCondition;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.xmlunit.assertj.XmlAssert;\n+\n+import static org.apache.commons.io.FileUtils.copyFile;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.openqa.selenium.By.className;\n+import static org.openqa.selenium.By.xpath;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.visibilityOfElementLocated;\n+\n+public class BPMNDesignerKogitoSeleniumIT {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(BPMNDesignerKogitoSeleniumIT.class);\n+\n+    private static final String SET_CONTENT_TEMPLATE =\n+            \"gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().setContent(\\\"\\\", '%s')\";\n+    private static final String GET_CONTENT_TEMPLATE =\n+            \"return gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().getContent()\";\n+\n+    private static final String INDEX_HTML = \"target/kie-wb-common-stunner-bpmn-kogito-runtime/index.html\";\n+    private static final String INDEX_HTML_PATH = \"file:///\" + new File(INDEX_HTML).getAbsolutePath();\n+\n+    private static final String NOT_PRESENT_IN_NAVIGATOR = \"' was not present in the process navigator\";\n+    private static final String PROPERTIES_PANEL = \"qe-docks-item-E-DiagramEditorPropertiesScreen\";\n+    private static final String DIAGRAM_EXPLORER = \"qe-docks-item-E-ProjectDiagramExplorerScreen\";\n+    private static final String DIAGRAM_EXPLORER_EXPANDED = \"qe-docks-bar-expanded-E\";\n+    private static final String DIAGRAM_PANEL = \"qe-static-workbench-panel-view\";\n+    private static final String ACE_EDITOR = \"//div[@class='ace_content']\";\n+    private static final String ERROR_MODAL_DIALOG = \"//div[@class='modal-dialog']\";\n+    private static final String ERROR_MODAL_BODY = \"//div[@class='modal-body']\";\n+    private static final String PROCESS_NODE = \"//div[@data-field='explorerPanelBody']//a[text()='%s']\";\n+    private static final Boolean HEADLESS = Boolean.valueOf(System.getProperty(\"org.kie.bpmn.kogito.browser.headless\"));\n+    private static final String SCREENSHOTS_DIR = System.getProperty(\"org.kie.bpmn.kogito.screenshots.dir\");\n+\n+    /**\n+     * Selenium web driver\n+     */\n+    private WebDriver driver;\n+\n+    /**\n+     * Properties panel of BPMN Designer\n+     */\n+    private WebElement propertiesPanel;\n+\n+    /**\n+     * Explore diagram panel of BPMN Designer\n+     */\n+    private WebElement bpmnDesignerExplorerButton;\n+\n+    @BeforeClass\n+    public static void setupClass() {\n+        WebDriverManager.firefoxdriver().setup();\n+    }\n+\n+    @Before\n+    public void openBPMNDesigner() {\n+        final FirefoxOptions firefoxOptions = new FirefoxOptions();\n+        firefoxOptions.setHeadless(HEADLESS);\n+        driver = new FirefoxDriver(firefoxOptions);\n+        driver.manage().window().maximize();\n+\n+        driver.get(INDEX_HTML_PATH);\n+\n+        final WebElement designer = waitOperation()\n+                .until(presenceOfElementLocated(className(DIAGRAM_PANEL)));\n+        assertThat(designer)\n+                .as(\"Diagram panel is a prerequisite for all tests. \" +\n+                            \"its absence is indicator of designer load fail.\")\n+                .isNotNull();\n+    }\n+\n+    private final File screenshotDirectory = initScreenshotDirectory();\n+\n+    @Rule\n+    public TestWatcher takeScreenShotAndCleanUp = new TestWatcher() {\n+        @Override\n+        protected void failed(Throwable e, Description description) {\n+            final File screenshotFile = ((TakesScreenshot) driver).getScreenshotAs(OutputType.FILE);\n+            final String testClassName = description.getTestClass().getSimpleName();\n+            final String testMethodName = description.getMethodName();\n+            final String filename = testClassName + \"_\" + testMethodName;\n+            try {\n+                copyFile(screenshotFile, new File(screenshotDirectory, filename + \".png\"));\n+            } catch (IOException ioe) {\n+                LOG.error(\"Unable to take screenshot\", ioe);\n+            }\n+        }\n+\n+        @Override\n+        protected void finished(Description description) {\n+            if (driver != null) {\n+                driver.quit();\n+            }\n+        }\n+    };\n+\n+    @Test\n+    public void testHandlingInvalidContent() {\n+        setContent(\"<!!!invalid!!!>\");\n+\n+        // Verify ACE editor (default text editor) is in place and shown to user\n+        final WebElement aceEditor = waitOperation().until(element(ACE_EDITOR));\n+        assertThat(aceEditor)\n+                .as(\"If invalid bpmn is loaded, ace editor needs to be shown\")\n+                .isNotNull();", "originalCommit": "44de5c614b41ae92aa4f3371886a2691db5d865d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2NzM2Nw==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r464967367", "bodyText": "Similar comment", "author": "jomarko", "createdAt": "2020-08-04T10:56:12Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-kogito-runtime/src/test/java/org/kie/workbench/common/stunner/kogito/client/selenium/BPMNDesignerKogitoSeleniumIT.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.workbench.common.stunner.kogito.client.selenium;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+import io.github.bonigarcia.wdm.WebDriverManager;\n+import org.apache.commons.io.IOUtils;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TestWatcher;\n+import org.junit.runner.Description;\n+import org.openqa.selenium.JavascriptExecutor;\n+import org.openqa.selenium.OutputType;\n+import org.openqa.selenium.TakesScreenshot;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.WebElement;\n+import org.openqa.selenium.firefox.FirefoxDriver;\n+import org.openqa.selenium.firefox.FirefoxOptions;\n+import org.openqa.selenium.support.ui.ExpectedCondition;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.xmlunit.assertj.XmlAssert;\n+\n+import static org.apache.commons.io.FileUtils.copyFile;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.openqa.selenium.By.className;\n+import static org.openqa.selenium.By.xpath;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.visibilityOfElementLocated;\n+\n+public class BPMNDesignerKogitoSeleniumIT {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(BPMNDesignerKogitoSeleniumIT.class);\n+\n+    private static final String SET_CONTENT_TEMPLATE =\n+            \"gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().setContent(\\\"\\\", '%s')\";\n+    private static final String GET_CONTENT_TEMPLATE =\n+            \"return gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().getContent()\";\n+\n+    private static final String INDEX_HTML = \"target/kie-wb-common-stunner-bpmn-kogito-runtime/index.html\";\n+    private static final String INDEX_HTML_PATH = \"file:///\" + new File(INDEX_HTML).getAbsolutePath();\n+\n+    private static final String NOT_PRESENT_IN_NAVIGATOR = \"' was not present in the process navigator\";\n+    private static final String PROPERTIES_PANEL = \"qe-docks-item-E-DiagramEditorPropertiesScreen\";\n+    private static final String DIAGRAM_EXPLORER = \"qe-docks-item-E-ProjectDiagramExplorerScreen\";\n+    private static final String DIAGRAM_EXPLORER_EXPANDED = \"qe-docks-bar-expanded-E\";\n+    private static final String DIAGRAM_PANEL = \"qe-static-workbench-panel-view\";\n+    private static final String ACE_EDITOR = \"//div[@class='ace_content']\";\n+    private static final String ERROR_MODAL_DIALOG = \"//div[@class='modal-dialog']\";\n+    private static final String ERROR_MODAL_BODY = \"//div[@class='modal-body']\";\n+    private static final String PROCESS_NODE = \"//div[@data-field='explorerPanelBody']//a[text()='%s']\";\n+    private static final Boolean HEADLESS = Boolean.valueOf(System.getProperty(\"org.kie.bpmn.kogito.browser.headless\"));\n+    private static final String SCREENSHOTS_DIR = System.getProperty(\"org.kie.bpmn.kogito.screenshots.dir\");\n+\n+    /**\n+     * Selenium web driver\n+     */\n+    private WebDriver driver;\n+\n+    /**\n+     * Properties panel of BPMN Designer\n+     */\n+    private WebElement propertiesPanel;\n+\n+    /**\n+     * Explore diagram panel of BPMN Designer\n+     */\n+    private WebElement bpmnDesignerExplorerButton;\n+\n+    @BeforeClass\n+    public static void setupClass() {\n+        WebDriverManager.firefoxdriver().setup();\n+    }\n+\n+    @Before\n+    public void openBPMNDesigner() {\n+        final FirefoxOptions firefoxOptions = new FirefoxOptions();\n+        firefoxOptions.setHeadless(HEADLESS);\n+        driver = new FirefoxDriver(firefoxOptions);\n+        driver.manage().window().maximize();\n+\n+        driver.get(INDEX_HTML_PATH);\n+\n+        final WebElement designer = waitOperation()\n+                .until(presenceOfElementLocated(className(DIAGRAM_PANEL)));\n+        assertThat(designer)\n+                .as(\"Diagram panel is a prerequisite for all tests. \" +\n+                            \"its absence is indicator of designer load fail.\")\n+                .isNotNull();\n+    }\n+\n+    private final File screenshotDirectory = initScreenshotDirectory();\n+\n+    @Rule\n+    public TestWatcher takeScreenShotAndCleanUp = new TestWatcher() {\n+        @Override\n+        protected void failed(Throwable e, Description description) {\n+            final File screenshotFile = ((TakesScreenshot) driver).getScreenshotAs(OutputType.FILE);\n+            final String testClassName = description.getTestClass().getSimpleName();\n+            final String testMethodName = description.getMethodName();\n+            final String filename = testClassName + \"_\" + testMethodName;\n+            try {\n+                copyFile(screenshotFile, new File(screenshotDirectory, filename + \".png\"));\n+            } catch (IOException ioe) {\n+                LOG.error(\"Unable to take screenshot\", ioe);\n+            }\n+        }\n+\n+        @Override\n+        protected void finished(Description description) {\n+            if (driver != null) {\n+                driver.quit();\n+            }\n+        }\n+    };\n+\n+    @Test\n+    public void testHandlingInvalidContent() {\n+        setContent(\"<!!!invalid!!!>\");\n+\n+        // Verify ACE editor (default text editor) is in place and shown to user\n+        final WebElement aceEditor = waitOperation().until(element(ACE_EDITOR));\n+        assertThat(aceEditor)\n+                .as(\"If invalid bpmn is loaded, ace editor needs to be shown\")\n+                .isNotNull();\n+    }\n+\n+    @Test\n+    public void testNewDiagram() throws Exception {\n+        final String expected = loadResource(\"new-diagram.bpmn2\");\n+        setContent(\"\");\n+\n+        waitPropertiesAndExplorer();\n+\n+        final String actual = getContent();\n+        assertThat(actual).isNotBlank();\n+\n+        // Skip, id, name and namespace in the comparison - they are dynamic\n+        XmlAssert.assertThat(actual)\n+                .and(expected)\n+                .ignoreComments()\n+                .ignoreWhitespace()\n+                .withAttributeFilter(\n+                        attr -> !(Objects.equals(attr.getName(), \"id\")\n+                                || Objects.equals(attr.getName(), \"name\")\n+                                || Objects.equals(attr.getName(), \"namespace\")))\n+                .withNodeFilter(\n+                        node -> !(Objects.equals(node.getNodeName(), \"bpmn2:source\")\n+                                || Objects.equals(node.getNodeName(), \"bpmn2:target\")))\n+                .areIdentical();\n+    }\n+\n+    @Test\n+    public void testBasicModel() throws Exception {\n+        final String expected = loadResource(\"basic-process.bpmn2\");\n+        setContent(expected);\n+\n+        waitPropertiesAndExplorer();\n+\n+        assertDiagramNodeIsPresentInProcessNavigator(\"Start\");\n+        assertDiagramNodeIsPresentInProcessNavigator(\"Add user to database\");\n+        assertDiagramNodeIsPresentInProcessNavigator(\"End\");\n+\n+        final String actual = getContent();\n+        assertThat(actual).isNotBlank();\n+\n+        XmlAssert.assertThat(actual)\n+                .and(expected)\n+                .ignoreComments()\n+                .ignoreWhitespace()\n+                // KOGITO-1795\n+                .withAttributeFilter(\n+                        attr -> (!(Objects.equals(attr.getName(), \"id\") &&\n+                                !(Objects.equals(attr.getOwnerElement().getTagName(), \"bpmn2:defintions\"))))\n+                )\n+                .withNodeFilter(\n+                        node -> !(Objects.equals(node.getNodeName(), \"bpmn2:source\")\n+                                || Objects.equals(node.getNodeName(), \"bpmn2:target\")))\n+                .areIdentical();\n+    }\n+\n+    private void assertDiagramNodeIsPresentInProcessNavigator(final String nodeName) {\n+        expandBpmnNavigatorDock();\n+        final WebElement node = waitOperation().until(element(PROCESS_NODE, nodeName));\n+        assertThat(node)\n+                .as(\"Node '\" + nodeName + NOT_PRESENT_IN_NAVIGATOR)\n+                .isNotNull();\n+        collapseBpmnNavigatorDock();\n+    }\n+\n+    /**\n+     * Click on 'Explore Diagram' panel dock icon\n+     * @throws NullPointerException if 'setContent(final String content)' was not called before\n+     */\n+    private void expandBpmnNavigatorDock() throws NullPointerException {\n+        bpmnDesignerExplorerButton.click();\n+    }\n+\n+    private void collapseBpmnNavigatorDock() {\n+        final WebElement expandedDiagramNavigator = waitOperation()\n+                .until(visibilityOfElementLocated(className(DIAGRAM_EXPLORER_EXPANDED)));\n+        assertThat(expandedDiagramNavigator)\n+                .as(\"Unable to locate expanded decision navigator dock\")\n+                .isNotNull();", "originalCommit": "44de5c614b41ae92aa4f3371886a2691db5d865d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2NzU3Mw==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3298#discussion_r464967573", "bodyText": "Similar comment as above", "author": "jomarko", "createdAt": "2020-08-04T10:56:38Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-kogito-runtime/src/test/java/org/kie/workbench/common/stunner/kogito/client/selenium/BPMNDesignerKogitoSeleniumIT.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.workbench.common.stunner.kogito.client.selenium;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+import io.github.bonigarcia.wdm.WebDriverManager;\n+import org.apache.commons.io.IOUtils;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TestWatcher;\n+import org.junit.runner.Description;\n+import org.openqa.selenium.JavascriptExecutor;\n+import org.openqa.selenium.OutputType;\n+import org.openqa.selenium.TakesScreenshot;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.WebElement;\n+import org.openqa.selenium.firefox.FirefoxDriver;\n+import org.openqa.selenium.firefox.FirefoxOptions;\n+import org.openqa.selenium.support.ui.ExpectedCondition;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.xmlunit.assertj.XmlAssert;\n+\n+import static org.apache.commons.io.FileUtils.copyFile;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.openqa.selenium.By.className;\n+import static org.openqa.selenium.By.xpath;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.visibilityOfElementLocated;\n+\n+public class BPMNDesignerKogitoSeleniumIT {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(BPMNDesignerKogitoSeleniumIT.class);\n+\n+    private static final String SET_CONTENT_TEMPLATE =\n+            \"gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().setContent(\\\"\\\", '%s')\";\n+    private static final String GET_CONTENT_TEMPLATE =\n+            \"return gwtEditorBeans.get(\\\"BPMNDiagramEditor\\\").get().getContent()\";\n+\n+    private static final String INDEX_HTML = \"target/kie-wb-common-stunner-bpmn-kogito-runtime/index.html\";\n+    private static final String INDEX_HTML_PATH = \"file:///\" + new File(INDEX_HTML).getAbsolutePath();\n+\n+    private static final String NOT_PRESENT_IN_NAVIGATOR = \"' was not present in the process navigator\";\n+    private static final String PROPERTIES_PANEL = \"qe-docks-item-E-DiagramEditorPropertiesScreen\";\n+    private static final String DIAGRAM_EXPLORER = \"qe-docks-item-E-ProjectDiagramExplorerScreen\";\n+    private static final String DIAGRAM_EXPLORER_EXPANDED = \"qe-docks-bar-expanded-E\";\n+    private static final String DIAGRAM_PANEL = \"qe-static-workbench-panel-view\";\n+    private static final String ACE_EDITOR = \"//div[@class='ace_content']\";\n+    private static final String ERROR_MODAL_DIALOG = \"//div[@class='modal-dialog']\";\n+    private static final String ERROR_MODAL_BODY = \"//div[@class='modal-body']\";\n+    private static final String PROCESS_NODE = \"//div[@data-field='explorerPanelBody']//a[text()='%s']\";\n+    private static final Boolean HEADLESS = Boolean.valueOf(System.getProperty(\"org.kie.bpmn.kogito.browser.headless\"));\n+    private static final String SCREENSHOTS_DIR = System.getProperty(\"org.kie.bpmn.kogito.screenshots.dir\");\n+\n+    /**\n+     * Selenium web driver\n+     */\n+    private WebDriver driver;\n+\n+    /**\n+     * Properties panel of BPMN Designer\n+     */\n+    private WebElement propertiesPanel;\n+\n+    /**\n+     * Explore diagram panel of BPMN Designer\n+     */\n+    private WebElement bpmnDesignerExplorerButton;\n+\n+    @BeforeClass\n+    public static void setupClass() {\n+        WebDriverManager.firefoxdriver().setup();\n+    }\n+\n+    @Before\n+    public void openBPMNDesigner() {\n+        final FirefoxOptions firefoxOptions = new FirefoxOptions();\n+        firefoxOptions.setHeadless(HEADLESS);\n+        driver = new FirefoxDriver(firefoxOptions);\n+        driver.manage().window().maximize();\n+\n+        driver.get(INDEX_HTML_PATH);\n+\n+        final WebElement designer = waitOperation()\n+                .until(presenceOfElementLocated(className(DIAGRAM_PANEL)));\n+        assertThat(designer)\n+                .as(\"Diagram panel is a prerequisite for all tests. \" +\n+                            \"its absence is indicator of designer load fail.\")\n+                .isNotNull();\n+    }\n+\n+    private final File screenshotDirectory = initScreenshotDirectory();\n+\n+    @Rule\n+    public TestWatcher takeScreenShotAndCleanUp = new TestWatcher() {\n+        @Override\n+        protected void failed(Throwable e, Description description) {\n+            final File screenshotFile = ((TakesScreenshot) driver).getScreenshotAs(OutputType.FILE);\n+            final String testClassName = description.getTestClass().getSimpleName();\n+            final String testMethodName = description.getMethodName();\n+            final String filename = testClassName + \"_\" + testMethodName;\n+            try {\n+                copyFile(screenshotFile, new File(screenshotDirectory, filename + \".png\"));\n+            } catch (IOException ioe) {\n+                LOG.error(\"Unable to take screenshot\", ioe);\n+            }\n+        }\n+\n+        @Override\n+        protected void finished(Description description) {\n+            if (driver != null) {\n+                driver.quit();\n+            }\n+        }\n+    };\n+\n+    @Test\n+    public void testHandlingInvalidContent() {\n+        setContent(\"<!!!invalid!!!>\");\n+\n+        // Verify ACE editor (default text editor) is in place and shown to user\n+        final WebElement aceEditor = waitOperation().until(element(ACE_EDITOR));\n+        assertThat(aceEditor)\n+                .as(\"If invalid bpmn is loaded, ace editor needs to be shown\")\n+                .isNotNull();\n+    }\n+\n+    @Test\n+    public void testNewDiagram() throws Exception {\n+        final String expected = loadResource(\"new-diagram.bpmn2\");\n+        setContent(\"\");\n+\n+        waitPropertiesAndExplorer();\n+\n+        final String actual = getContent();\n+        assertThat(actual).isNotBlank();\n+\n+        // Skip, id, name and namespace in the comparison - they are dynamic\n+        XmlAssert.assertThat(actual)\n+                .and(expected)\n+                .ignoreComments()\n+                .ignoreWhitespace()\n+                .withAttributeFilter(\n+                        attr -> !(Objects.equals(attr.getName(), \"id\")\n+                                || Objects.equals(attr.getName(), \"name\")\n+                                || Objects.equals(attr.getName(), \"namespace\")))\n+                .withNodeFilter(\n+                        node -> !(Objects.equals(node.getNodeName(), \"bpmn2:source\")\n+                                || Objects.equals(node.getNodeName(), \"bpmn2:target\")))\n+                .areIdentical();\n+    }\n+\n+    @Test\n+    public void testBasicModel() throws Exception {\n+        final String expected = loadResource(\"basic-process.bpmn2\");\n+        setContent(expected);\n+\n+        waitPropertiesAndExplorer();\n+\n+        assertDiagramNodeIsPresentInProcessNavigator(\"Start\");\n+        assertDiagramNodeIsPresentInProcessNavigator(\"Add user to database\");\n+        assertDiagramNodeIsPresentInProcessNavigator(\"End\");\n+\n+        final String actual = getContent();\n+        assertThat(actual).isNotBlank();\n+\n+        XmlAssert.assertThat(actual)\n+                .and(expected)\n+                .ignoreComments()\n+                .ignoreWhitespace()\n+                // KOGITO-1795\n+                .withAttributeFilter(\n+                        attr -> (!(Objects.equals(attr.getName(), \"id\") &&\n+                                !(Objects.equals(attr.getOwnerElement().getTagName(), \"bpmn2:defintions\"))))\n+                )\n+                .withNodeFilter(\n+                        node -> !(Objects.equals(node.getNodeName(), \"bpmn2:source\")\n+                                || Objects.equals(node.getNodeName(), \"bpmn2:target\")))\n+                .areIdentical();\n+    }\n+\n+    private void assertDiagramNodeIsPresentInProcessNavigator(final String nodeName) {\n+        expandBpmnNavigatorDock();\n+        final WebElement node = waitOperation().until(element(PROCESS_NODE, nodeName));\n+        assertThat(node)\n+                .as(\"Node '\" + nodeName + NOT_PRESENT_IN_NAVIGATOR)\n+                .isNotNull();\n+        collapseBpmnNavigatorDock();\n+    }\n+\n+    /**\n+     * Click on 'Explore Diagram' panel dock icon\n+     * @throws NullPointerException if 'setContent(final String content)' was not called before\n+     */\n+    private void expandBpmnNavigatorDock() throws NullPointerException {\n+        bpmnDesignerExplorerButton.click();\n+    }\n+\n+    private void collapseBpmnNavigatorDock() {\n+        final WebElement expandedDiagramNavigator = waitOperation()\n+                .until(visibilityOfElementLocated(className(DIAGRAM_EXPLORER_EXPANDED)));\n+        assertThat(expandedDiagramNavigator)\n+                .as(\"Unable to locate expanded decision navigator dock\")\n+                .isNotNull();\n+\n+        expandedDiagramNavigator.findElement(className(\"fa\")).click();\n+    }\n+\n+    private File initScreenshotDirectory() {\n+        if (SCREENSHOTS_DIR == null) {\n+            throw new IllegalStateException(\n+                    \"Property org.kie.dmn.kogito.screenshots.dir (where screenshot taken by WebDriver will be put) was null\");\n+        }\n+        File scd = new File(SCREENSHOTS_DIR);\n+        if (!scd.exists()) {\n+            boolean mkdirSuccess = scd.mkdir();\n+            if (!mkdirSuccess) {\n+                throw new IllegalStateException(\"Creation of screenshots dir failed \" + scd);\n+            }\n+        }\n+        if (!scd.canWrite()) {\n+            throw new IllegalStateException(\"The screenshotDir must be writable\" + scd);\n+        }\n+        return scd;\n+    }\n+\n+    private void waitPropertiesAndExplorer() {\n+        final WebElement propertiesPanelDockIcon = waitOperation()\n+                .until(visibilityOfElementLocated(className(PROPERTIES_PANEL)));\n+        assertThat(propertiesPanelDockIcon)\n+                .as(\"Once content is set properties panel dock icon visibility is a prerequisite\" +\n+                            \"for further test execution.\")\n+                .isNotNull();\n+\n+        bpmnDesignerExplorerButton = waitOperation()\n+                .until(visibilityOfElementLocated(className(DIAGRAM_EXPLORER)));\n+        assertThat(bpmnDesignerExplorerButton)\n+                .as(\"Once content is set diagram explorer panel dock icon visibility is a prerequisite\" +\n+                            \"for further test execution.\")\n+                .isNotNull();", "originalCommit": "44de5c614b41ae92aa4f3371886a2691db5d865d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}