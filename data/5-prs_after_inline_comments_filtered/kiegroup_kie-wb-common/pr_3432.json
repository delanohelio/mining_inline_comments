{"pr_number": 3432, "pr_title": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename", "pr_createdAt": "2020-09-23T16:42:52Z", "pr_url": "https://github.com/kiegroup/kie-wb-common/pull/3432", "timeline": [{"oid": "4eaa7971453b7c1e35a56a60bbbc57a55de64045", "url": "https://github.com/kiegroup/kie-wb-common/commit/4eaa7971453b7c1e35a56a60bbbc57a55de64045", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource", "committedDate": "2020-09-23T17:21:48Z", "type": "forcePushed"}, {"oid": "594b992aea0f5b47ae665f5896ba73a9cce0def6", "url": "https://github.com/kiegroup/kie-wb-common/commit/594b992aea0f5b47ae665f5896ba73a9cce0def6", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource", "committedDate": "2020-09-24T08:28:42Z", "type": "commit"}, {"oid": "594b992aea0f5b47ae665f5896ba73a9cce0def6", "url": "https://github.com/kiegroup/kie-wb-common/commit/594b992aea0f5b47ae665f5896ba73a9cce0def6", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource", "committedDate": "2020-09-24T08:28:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1Njg2MA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494356860", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                * */\n          \n          \n            \n                                 */", "author": "caponetto", "createdAt": "2020-09-24T14:17:21Z", "path": "kie-wb-common-screens/kie-wb-common-data-modeller/kie-wb-common-data-modeller-client/src/main/java/org/kie/workbench/common/screens/datamodeller/client/DataModelerScreenPresenter.java", "diffHunk": "@@ -588,23 +588,16 @@ public void execute(final String commitMessage) {\n \n                 final DataObject[] modifiedDataObject = new DataObject[1];\n                 if (isDirty()) {\n-                    if (context.isEditorChanged()) {\n-\n-                        //at save time the source has always priority over the model.\n-                        //If the source was properly parsed and the editor has changes, we need to send the DataObject\n-                        //to the server in order to let the source to be updated prior to save.\n-                        modifiedDataObject[0] = context.getDataObject();\n-                    } else {\n-                        //if the source has changes, no update form the UI to the source will be performed.\n-                        //instead the parsed DataObject must be returned from the server.\n-                        modifiedDataObject[0] = null;\n-                    }\n+                    /* when DataObject editor or source is changed we\n+                     * need to send the DataObject to the server  in order\n+                     *  to let the source to be updated prior to save.\n+                    * */", "originalCommit": "594b992aea0f5b47ae665f5896ba73a9cce0def6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5MjQzMg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494592432", "bodyText": "Done!", "author": "akumar074", "createdAt": "2020-09-24T20:30:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1Njg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2ODQ5Nw==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494368497", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private RemoteCallback<GenerationResult> getSaveSuccessCallback( final Path currentPath) {\n          \n          \n            \n                private RemoteCallback<GenerationResult> getSaveSuccessCallback(final Path currentPath) {", "author": "caponetto", "createdAt": "2020-09-24T14:32:03Z", "path": "kie-wb-common-screens/kie-wb-common-data-modeller/kie-wb-common-data-modeller-client/src/main/java/org/kie/workbench/common/screens/datamodeller/client/DataModelerScreenPresenter.java", "diffHunk": "@@ -627,17 +619,14 @@ public void execute(final String commitMessage) {\n         };\n     }\n \n-    private RemoteCallback<GenerationResult> getSaveSuccessCallback(final JavaTypeInfo newTypeInfo,\n-                                                                    final Path currentPath) {\n+    private RemoteCallback<GenerationResult> getSaveSuccessCallback( final Path currentPath) {", "originalCommit": "594b992aea0f5b47ae665f5896ba73a9cce0def6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5MjUyMA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494592520", "bodyText": "Done!", "author": "akumar074", "createdAt": "2020-09-24T20:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2ODQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3ODIzNA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494378234", "bodyText": "Given the comment below If the file was renamed as part of the file saving, don't do anything.,\nwould you mind explaining the reason for removing this if-else block?\nAlso, there is no unit test for exercising this method.\nIt'd be great if you could create a few ones.", "author": "caponetto", "createdAt": "2020-09-24T14:44:38Z", "path": "kie-wb-common-screens/kie-wb-common-data-modeller/kie-wb-common-data-modeller-client/src/main/java/org/kie/workbench/common/screens/datamodeller/client/DataModelerScreenPresenter.java", "diffHunk": "@@ -627,17 +619,14 @@ public void execute(final String commitMessage) {\n         };\n     }\n \n-    private RemoteCallback<GenerationResult> getSaveSuccessCallback(final JavaTypeInfo newTypeInfo,\n-                                                                    final Path currentPath) {\n+    private RemoteCallback<GenerationResult> getSaveSuccessCallback( final Path currentPath) {\n         return new RemoteCallback<GenerationResult>() {\n \n             @Override\n             public void callback(GenerationResult result) {\n \n                 view.hideBusyIndicator();\n \n-                if (newTypeInfo == null) {", "originalCommit": "594b992aea0f5b47ae665f5896ba73a9cce0def6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ4OTQwMw==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494489403", "bodyText": "Hi @caponetto , The condition is used to identify if we have changed the package or file name. If the package or file name is changed, the source and source hash will be updated in reload because of ResourceRenamedEvent in the observable path. The \"reload\" caused some delay before the hash could be updated and the Unsaved changes dialog can appear. Removing this condition helps to update the source before reload.\nThe method is private so, didn't add the unit test for this.", "author": "akumar074", "createdAt": "2020-09-24T17:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3ODIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1NTA4NQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494955085", "bodyText": "I see, thanks for the explanation @akumar074!", "author": "caponetto", "createdAt": "2020-09-25T12:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3ODIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4NDc2Ng==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494384766", "bodyText": "I'd move this code into the if blocks above because there is no need for doing setName and setPackageName if name and package didn't change, respectively. It also avoids having to remove \".java\" from targetName.\nSomething like this:\nif (newPackageName != null && (currentPackage == null || !newPackageName.equals(currentPackage.getPackageName()))) {\n    targetPackage = serviceHelper.ensurePackageStructure(moduleService.resolveModule(path),\n                                                         newPackageName);\n\n    // Moved here\n    if (dataObject != null && targetPackage != null) {\n        dataObject.setPackageName(targetPackage.getPackageName());\n    }\n\n    packageChanged = true;\n}\n\nif (newFileName != null && !(newFileName + \".java\").equals(path.getFileName())) {\n    targetName = newFileName + \".java\";\n\n    // Moved here\n    if (dataObject != null) {\n        dataObject.setName(newFileName);\n    }\n\n    nameChanged = true;\n}", "author": "caponetto", "createdAt": "2020-09-24T14:52:51Z", "path": "kie-wb-common-screens/kie-wb-common-data-modeller/kie-wb-common-data-modeller-backend/src/main/java/org/kie/workbench/common/screens/datamodeller/backend/server/DataModelerServiceImpl.java", "diffHunk": "@@ -569,6 +566,19 @@ public GenerationResult saveSource(final String source,\n                 targetName = newFileName + \".java\";\n                 nameChanged = true;\n             }\n+            \n+            /* Modify data object with updated fileName and packageName\n+             * before resolving source to handle inconsistencies in\n+             * source code and data object\n+             * */\n+            if  (dataObject  != null) {\n+                dataObject.setName(targetName.replace(\".java\", \"\"));\n+                dataObject.setPackageName(targetPackage.getPackageName());\n+            }", "originalCommit": "594b992aea0f5b47ae665f5896ba73a9cce0def6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ5MDg3NA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494490874", "bodyText": "Thanks @caponetto Good suggestion. I'll update this :)", "author": "akumar074", "createdAt": "2020-09-24T17:30:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4NDc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5NjQzMg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494596432", "bodyText": "Hey @caponetto , moving the DataObject update doesn't work as expected. The data object is also updated with fileName and currentPackage resolved from the path. For example, if we are changing the package or fileName in editor/source but while saving the changes we chose not to move the package or file name, then the source or DataObject editor can have changed values. In this case, we are updating the data object with the path or if package or fileName is changed update it.", "author": "akumar074", "createdAt": "2020-09-24T20:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4NDc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1NTIxNA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494955214", "bodyText": "I see, thanks for the explanation @akumar074!", "author": "caponetto", "createdAt": "2020-09-25T12:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4NDc2Ng=="}], "type": "inlineReview"}, {"oid": "b2b52043e3a9e22cae6e3431f4a6165dc80aa1b7", "url": "https://github.com/kiegroup/kie-wb-common/commit/b2b52043e3a9e22cae6e3431f4a6165dc80aa1b7", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource", "committedDate": "2020-09-24T20:12:25Z", "type": "commit"}, {"oid": "bb37f0eda657ef39a932630f5fd88bc70d4de2f8", "url": "https://github.com/kiegroup/kie-wb-common/commit/bb37f0eda657ef39a932630f5fd88bc70d4de2f8", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource\n - Added tests", "committedDate": "2020-09-25T09:53:06Z", "type": "commit"}, {"oid": "bb37f0eda657ef39a932630f5fd88bc70d4de2f8", "url": "https://github.com/kiegroup/kie-wb-common/commit/bb37f0eda657ef39a932630f5fd88bc70d4de2f8", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource\n - Added tests", "committedDate": "2020-09-25T09:53:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk2MTc0MQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494961741", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if  (dataObject  != null) {\n          \n          \n            \n                        if (dataObject != null) {\n          \n      \n    \n    \n  \n\nSince we are keeping this if block, can you please remove these extra spaces?", "author": "caponetto", "createdAt": "2020-09-25T12:44:29Z", "path": "kie-wb-common-screens/kie-wb-common-data-modeller/kie-wb-common-data-modeller-backend/src/main/java/org/kie/workbench/common/screens/datamodeller/backend/server/DataModelerServiceImpl.java", "diffHunk": "@@ -569,6 +566,19 @@ public GenerationResult saveSource(final String source,\n                 targetName = newFileName + \".java\";\n                 nameChanged = true;\n             }\n+            \n+            /* Modify data object with updated fileName and packageName\n+             * or by resolving from @path before resolving source to handle\n+             * inconsistencies in source code and data object\n+             * */\n+            if  (dataObject  != null) {", "originalCommit": "bb37f0eda657ef39a932630f5fd88bc70d4de2f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "188ba5025926701f6bc69ae560764ab12b95d878", "url": "https://github.com/kiegroup/kie-wb-common/commit/188ba5025926701f6bc69ae560764ab12b95d878", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\r\n\r\n- DataObject is being send to the server if any change in Source or DataModeler\r\n- DataModeler context and source updated after package or file name changes\r\n- DataObject package and file name updates before\u00a0 resolveSaveSource\r\n- Added tests\n\nCo-authored-by: Guilherme Caponetto <638737+caponetto@users.noreply.github.com>", "committedDate": "2020-09-25T13:20:18Z", "type": "commit"}]}