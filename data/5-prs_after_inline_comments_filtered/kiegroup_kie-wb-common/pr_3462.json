{"pr_number": 3462, "pr_title": "DROOLS-5749: [DMN Designer] Multiple DRDs support - When users open a DMN with duplicated information requirements, the marshaller doesn't fix it", "pr_createdAt": "2020-10-22T03:35:37Z", "pr_url": "https://github.com/kiegroup/kie-wb-common/pull/3462", "timeline": [{"oid": "f9737808a0429e4e5c69aa1a2e86f97665745641", "url": "https://github.com/kiegroup/kie-wb-common/commit/f9737808a0429e4e5c69aa1a2e86f97665745641", "message": "DROOLS-5749: [DMN Designer] Multiple DRDs support - When users open a DMN with duplicated information requirements, the marshaller doesn't fix it", "committedDate": "2020-10-22T03:15:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAwNzkyOA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3462#discussion_r510007928", "bodyText": "Could we add here second argument and combine the lists like:\nprivate <T extends JSITDMNElement> List<T> distinct(final List<T> list, final List<T> secondList) {\n    List<T> toBeProcessed = new ArrayList(list);\n    toBeProcessed.addAll(secondList);\n    // the rest is the same, just process the combined list\n    final Map<String, T> map = new HashMap<>();\n    forEach(toBeProcessed, item -> {\n        map.putIfAbsent(item.getId(), Js.uncheckedCast(item));\n    });\n    return new ArrayList<>(map.values());\n}\n\nThe usage then wouldn't need to first to invoke addAllAuthorityRequirement and then retrospectively filtering and setting using setAuthorityRequirement.\nResulting in a single call for each requirement type\nexistingKnowledgeSource.setAuthorityRequirement(\n    distinct(\n        existingKnowledgeSource.getAuthorityRequirement(),\n        nodeKnowledgeSource.getAuthorityRequirement()\n    )\n);\n\nwhich is IMO nicer than\nexistingKnowledgeSource.addAllAuthorityRequirement(nodeKnowledgeSource.getAuthorityRequirement().toArray(new JSITAuthorityRequirement[0]));\nexistingKnowledgeSource.setAuthorityRequirement(distinct(existingKnowledgeSource.getAuthorityRequirement()));", "author": "jstastny-cz", "createdAt": "2020-10-22T09:16:53Z", "path": "kie-wb-common-dmn/kie-wb-common-dmn-client/src/main/java/org/kie/workbench/common/dmn/client/marshaller/marshall/DMNMarshaller.java", "diffHunk": "@@ -352,58 +365,41 @@ private void mergeNodeRequirements(final JSITDRGElement node,\n             final JSITBusinessKnowledgeModel existingBkm = Js.uncheckedCast(existingDRGElement);\n             final JSITBusinessKnowledgeModel nodeBkm = Js.uncheckedCast(node);\n \n-            forEach(nodeBkm.getAuthorityRequirement(),\n-                    authorityRequirement -> {\n-                        if (!existingBkm.getAuthorityRequirement().contains(authorityRequirement)) {\n-                            existingBkm.addAuthorityRequirement(authorityRequirement);\n-                        }\n-                    });\n+            existingBkm.addAllAuthorityRequirement(nodeBkm.getAuthorityRequirement().toArray(new JSITAuthorityRequirement[0]));\n+            existingBkm.addAllKnowledgeRequirement(nodeBkm.getKnowledgeRequirement().toArray(new JSITKnowledgeRequirement[0]));\n \n-            forEach(nodeBkm.getKnowledgeRequirement(),\n-                    knowledgeRequirement -> {\n-                        if (!existingBkm.getKnowledgeRequirement().contains(knowledgeRequirement)) {\n-                            existingBkm.addKnowledgeRequirement(knowledgeRequirement);\n-                        }\n-                    });\n+            existingBkm.setAuthorityRequirement(distinct(existingBkm.getAuthorityRequirement()));\n+            existingBkm.setKnowledgeRequirement(distinct(existingBkm.getKnowledgeRequirement()));\n         } else if (instanceOfDecision(node)) {\n \n             final JSITDecision existingDecision = Js.uncheckedCast(existingDRGElement);\n             final JSITDecision nodeDecision = Js.uncheckedCast(node);\n \n-            forEach(nodeDecision.getAuthorityRequirement(),\n-                    authorityRequirement -> {\n-                        if (!existingDecision.getAuthorityRequirement().contains(authorityRequirement)) {\n-                            existingDecision.addAuthorityRequirement(authorityRequirement);\n-                        }\n-                    });\n-\n-            forEach(nodeDecision.getInformationRequirement(),\n-                    informationRequirement -> {\n-                        if (!existingDecision.getInformationRequirement().contains(informationRequirement)) {\n-                            existingDecision.addInformationRequirement(informationRequirement);\n-                        }\n-                    });\n+            existingDecision.addAllAuthorityRequirement(nodeDecision.getAuthorityRequirement().toArray(new JSITAuthorityRequirement[0]));\n+            existingDecision.addAllInformationRequirement(nodeDecision.getInformationRequirement().toArray(new JSITInformationRequirement[0]));\n+            existingDecision.addAllKnowledgeRequirement(nodeDecision.getKnowledgeRequirement().toArray(new JSITKnowledgeRequirement[0]));\n \n-            forEach(nodeDecision.getKnowledgeRequirement(),\n-                    knowledgeRequirement -> {\n-                        if (!existingDecision.getKnowledgeRequirement().contains(knowledgeRequirement)) {\n-                            existingDecision.addKnowledgeRequirement(knowledgeRequirement);\n-                        }\n-                    });\n+            existingDecision.setAuthorityRequirement(distinct(existingDecision.getAuthorityRequirement()));\n+            existingDecision.setInformationRequirement(distinct(existingDecision.getInformationRequirement()));\n+            existingDecision.setKnowledgeRequirement(distinct(existingDecision.getKnowledgeRequirement()));\n         } else if (instanceOfKnowledgeSource(node)) {\n \n             final JSITKnowledgeSource existingKnowledgeSource = Js.uncheckedCast(existingDRGElement);\n             final JSITKnowledgeSource nodeKnowledgeSource = Js.uncheckedCast(node);\n \n-            forEach(nodeKnowledgeSource.getAuthorityRequirement(),\n-                    authorityRequirement -> {\n-                        if (!existingKnowledgeSource.getAuthorityRequirement().contains(authorityRequirement)) {\n-                            existingKnowledgeSource.addAuthorityRequirement(authorityRequirement);\n-                        }\n-                    });\n+            existingKnowledgeSource.addAllAuthorityRequirement(nodeKnowledgeSource.getAuthorityRequirement().toArray(new JSITAuthorityRequirement[0]));\n+            existingKnowledgeSource.setAuthorityRequirement(distinct(existingKnowledgeSource.getAuthorityRequirement()));\n         }\n     }\n \n+    private <T extends JSITDMNElement> List<T> distinct(final List<T> list) {", "originalCommit": "f9737808a0429e4e5c69aa1a2e86f97665745641", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyNzg4Mg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3462#discussion_r510127882", "bodyText": "Nice enhancement. Thanks, @jstastny-cz!", "author": "karreiro", "createdAt": "2020-10-22T12:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAwNzkyOA=="}], "type": "inlineReview"}, {"oid": "8231bf3b0d4b343099571be672026d545cde033a", "url": "https://github.com/kiegroup/kie-wb-common/commit/8231bf3b0d4b343099571be672026d545cde033a", "message": " - Simplify 'mergeNodeRequirements' (reviewer: Jan)", "committedDate": "2020-10-22T12:40:40Z", "type": "commit"}]}