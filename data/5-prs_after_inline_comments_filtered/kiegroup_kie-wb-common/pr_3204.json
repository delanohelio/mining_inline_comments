{"pr_number": 3204, "pr_title": "KOGITO-1014: DMN editor doesn't show Ace editor on invalid DMN content", "pr_createdAt": "2020-03-02T15:10:42Z", "pr_url": "https://github.com/kiegroup/kie-wb-common/pull/3204", "timeline": [{"oid": "78bd074e73f12e43cb7160c68fa4995abca79617", "url": "https://github.com/kiegroup/kie-wb-common/commit/78bd074e73f12e43cb7160c68fa4995abca79617", "message": "KOGITO-1014: DMN editor doesn't show Ace editor on invalid DMN content", "committedDate": "2020-03-03T15:45:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxOTExMw==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3204#discussion_r387619113", "bodyText": "To me it is not clear, what exception can be propagated to this try catch.\nJira says open invalid content == open some non empty content. So when  I check transform implementation, I guess we speak about DMNClientDiagramServiceImpl.doTransformation where we have one try catch block wrapping all the code and handling all errors via, callback.\nAm I missing something?", "author": "jomarko", "createdAt": "2020-03-04T11:55:05Z", "path": "kie-wb-common-dmn/kie-wb-common-dmn-webapp-kogito-common/src/main/java/org/kie/workbench/common/dmn/webapp/kogito/common/client/editor/AbstractDMNDiagramEditor.java", "diffHunk": "@@ -392,19 +393,23 @@ public boolean isDirty() {\n     @Override\n     @SetContent\n     public void setContent(final String path, final String value) {\n-        diagramServices.transform(value,\n-                                  new ServiceCallback<Diagram>() {\n-\n-                                      @Override\n-                                      public void onSuccess(final Diagram diagram) {\n-                                          AbstractDMNDiagramEditor.this.open(diagram);\n-                                      }\n-\n-                                      @Override\n-                                      public void onError(final ClientRuntimeError error) {\n-                                          AbstractDMNDiagramEditor.this.getEditor().onLoadError(error);\n-                                      }\n-                                  });\n+        try {\n+            diagramServices.transform(value,\n+                                      new ServiceCallback<Diagram>() {\n+\n+                                          @Override\n+                                          public void onSuccess(final Diagram diagram) {\n+                                              AbstractDMNDiagramEditor.this.open(diagram);\n+                                          }\n+\n+                                          @Override\n+                                          public void onError(final ClientRuntimeError error) {\n+                                              AbstractDMNDiagramEditor.this.getEditor().onLoadError(error);\n+                                          }\n+                                      });\n+        } catch (Exception e) {\n+            getEditor().showError(e.getMessage());\n+        }", "originalCommit": "78bd074e73f12e43cb7160c68fa4995abca79617", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYyMTY0MQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3204#discussion_r387621641", "bodyText": "Hi @jomarko this try {...} catch(.) block will be deleted when this PR is ready for review.\nAt the moment it was added to allow me to observe what was causing the error handled by the kogito-tooling code. Whatever it was, was leading to the ACE Editor not to be shown for invalid DMN files. We now know it's kogito-tooling calls to setContent(..) with valid and then invalid files in quick succession that is causing the problem..\nThe problem is that the Monaco editor (used for auto-complete of FEEL expressions) changes a JavaScript \"module loader\" to load itself. The same \"module loader\" is used by ACE to load itself (for the XML editor used to show invalid files). When the two calls occur in quick succession the Monaco editor loading is not complete and the ACE editor fails to load.\nA fix is still being researched......", "author": "manstis", "createdAt": "2020-03-04T12:00:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxOTExMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYyMzQ4OA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3204#discussion_r387623488", "bodyText": "Sorry, take your time, let me know when ready for review", "author": "jomarko", "createdAt": "2020-03-04T12:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxOTExMw=="}], "type": "inlineReview"}, {"oid": "0d746c225915424e0331e647ad083402be74de59", "url": "https://github.com/kiegroup/kie-wb-common/commit/0d746c225915424e0331e647ad083402be74de59", "message": "KOGITO-1014: [DMN Designer] ACE Editor is not shown for invalid DMN content", "committedDate": "2020-03-05T15:20:19Z", "type": "forcePushed"}, {"oid": "6ecea69f452f0261f84ec5e7dc63b564ab155e93", "url": "https://github.com/kiegroup/kie-wb-common/commit/6ecea69f452f0261f84ec5e7dc63b564ab155e93", "message": "KOGITO-1014: [DMN Designer] ACE Editor is not shown for invalid DMN content", "committedDate": "2020-03-05T15:24:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQxMjM5OA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3204#discussion_r388412398", "bodyText": "This is a workaround.\nIf I simply used the member variable dataTypesPage here the Java compiler complained that it may not have been set.", "author": "manstis", "createdAt": "2020-03-05T16:32:55Z", "path": "kie-wb-common-dmn/kie-wb-common-dmn-webapp-kogito-common/src/main/java/org/kie/workbench/common/dmn/webapp/kogito/common/client/editor/AbstractDMNDiagramEditor.java", "diffHunk": "@@ -186,21 +208,20 @@ public void onStartup(final PlaceRequest place) {\n         diagramPropertiesDock.init(PERSPECTIVE_ID);\n         diagramPreviewAndExplorerDock.init(PERSPECTIVE_ID);\n \n-        feelInitializer.initializeFEELEditor();\n+        initialiseKieEditorForSessionProxy = VALID_DIAGRAM_PROXY;\n     }\n \n     void superDoStartUp(final PlaceRequest place) {\n         super.doStartUp(place);\n     }\n \n+    private DataTypesPage getDataTypesPage() {", "originalCommit": "6ecea69f452f0261f84ec5e7dc63b564ab155e93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQxMzQxOQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3204#discussion_r388413419", "bodyText": "I've moved use of feelInitializer from the start-up methods to when the Diagram is successfully loaded and the Monaco editor (and hence FEEL support) is actually needed. Use of feelInitializer is not needed if the file contained invalid content and the ACE editor displayed.", "author": "manstis", "createdAt": "2020-03-05T16:34:30Z", "path": "kie-wb-common-dmn/kie-wb-common-dmn-project-client/src/main/java/org/kie/workbench/common/dmn/project/client/editor/DMNDiagramEditor.java", "diffHunk": "@@ -197,7 +197,6 @@ public void init() {\n         getMenuSessionItems().setErrorConsumer(e -> hideLoadingViews());\n         editorSearchIndex.setCurrentAssetHashcodeSupplier(getGetCurrentContentHashSupplier());\n         editorSearchIndex.setIsDataTypesTabActiveSupplier(getIsDataTypesTabActiveSupplier());\n-        feelInitializer.initializeFEELEditor();", "originalCommit": "6ecea69f452f0261f84ec5e7dc63b564ab155e93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "db70bf99307723b0a2ef5d7049df319175907038", "url": "https://github.com/kiegroup/kie-wb-common/commit/db70bf99307723b0a2ef5d7049df319175907038", "message": "KOGITO-1014: [DMN Designer] ACE Editor is not shown for invalid DMN content", "committedDate": "2020-03-11T09:27:00Z", "type": "forcePushed"}, {"oid": "eb498bd8064131b93b8353c8b6437b65b7f33615", "url": "https://github.com/kiegroup/kie-wb-common/commit/eb498bd8064131b93b8353c8b6437b65b7f33615", "message": "More updates to support the session being potentially closed.", "committedDate": "2020-03-12T10:56:04Z", "type": "forcePushed"}, {"oid": "b0e2dc5e78de36fa5d3f4739638d9a42de3307a8", "url": "https://github.com/kiegroup/kie-wb-common/commit/b0e2dc5e78de36fa5d3f4739638d9a42de3307a8", "message": "Fix for calls to getDiagram() when session has been closed.", "committedDate": "2020-03-12T11:33:11Z", "type": "forcePushed"}, {"oid": "ee788797b28237d904ea2843e2d45039c1cf4131", "url": "https://github.com/kiegroup/kie-wb-common/commit/ee788797b28237d904ea2843e2d45039c1cf4131", "message": "KOGITO-1014: [DMN Designer] ACE Editor is not shown for invalid DMN content", "committedDate": "2020-03-12T11:34:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU2MzgzMA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3204#discussion_r391563830", "bodyText": "Just moved method to interface (to avoid a cast later) and re-ordered methods.", "author": "manstis", "createdAt": "2020-03-12T11:40:50Z", "path": "kie-wb-common-dmn/kie-wb-common-dmn-client/src/main/java/org/kie/workbench/common/dmn/client/editors/expressions/ExpressionEditor.java", "diffHunk": "@@ -151,11 +151,12 @@ public void handleCanvasElementUpdated(final CanvasElementUpdatedEvent event) {\n         }\n     }\n \n-    Optional<Command> getExitCommand() {\n-        return exitCommand;\n+    @Override", "originalCommit": "ee788797b28237d904ea2843e2d45039c1cf4131", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU2NDQzMg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3204#discussion_r391564432", "bodyText": "There was an issue with subsequent calls to setContent(..) after the editor had had invalid state initially set (as there was no session and this code failed).", "author": "manstis", "createdAt": "2020-03-12T11:41:58Z", "path": "kie-wb-common-dmn/kie-wb-common-dmn-client/src/main/java/org/kie/workbench/common/dmn/client/editors/search/DMNEditorSearchIndex.java", "diffHunk": "@@ -126,14 +126,18 @@ private SearchContext currentSearchContext() {\n         if (getIsDataTypesTabActiveSupplier().get()) {\n             return DATA_TYPES;\n         }\n-        if (getExpressionEditor().isActive()) {\n+        if (isExpressionEditorActive()) {\n             return BOXED_EXPRESSION;\n         }\n         return GRAPH;\n     }\n \n-    private ExpressionEditor getExpressionEditor() {\n-        return (ExpressionEditor) getCurrentSession().getExpressionEditor();\n+    private boolean isExpressionEditorActive() {", "originalCommit": "ee788797b28237d904ea2843e2d45039c1cf4131", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU2NTQ3Nw==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3204#discussion_r391565477", "bodyText": "Another NPE being thrown following the change for KOGITO-437. Simple null safe-guard.", "author": "manstis", "createdAt": "2020-03-12T11:43:58Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-client/kie-wb-common-stunner-widgets/src/main/java/org/kie/workbench/common/stunner/client/widgets/presenters/session/impl/SessionEditorImpl.java", "diffHunk": "@@ -96,7 +97,7 @@ public ScrollableLienzoPanel getCanvasPanel() {\n \n     @Override\n     protected Diagram getDiagram() {\n-        return diagramSupplier.get();\n+        return Objects.nonNull(diagramSupplier) ? diagramSupplier.get() : null;", "originalCommit": "ee788797b28237d904ea2843e2d45039c1cf4131", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU2NTUyOA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3204#discussion_r391565528", "bodyText": "Another NPE being thrown following the change for KOGITO-437. Simple null safe-guard.", "author": "manstis", "createdAt": "2020-03-12T11:44:05Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-client/kie-wb-common-stunner-widgets/src/main/java/org/kie/workbench/common/stunner/client/widgets/presenters/session/impl/SessionViewerImpl.java", "diffHunk": "@@ -76,7 +77,7 @@ public SessionViewerImpl(final WidgetWrapperView view,\n \n     @Override\n     protected Diagram getDiagram() {\n-        return diagramSupplier.get();\n+        return Objects.nonNull(diagramSupplier) ? diagramSupplier.get() : null;", "originalCommit": "ee788797b28237d904ea2843e2d45039c1cf4131", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de66e2cefe926afa46dfb7f0057d19eab5d99306", "url": "https://github.com/kiegroup/kie-wb-common/commit/de66e2cefe926afa46dfb7f0057d19eab5d99306", "message": "KOGITO-1014: [DMN Designer] ACE Editor is not shown for invalid DMN content", "committedDate": "2020-03-12T12:17:40Z", "type": "commit"}, {"oid": "de66e2cefe926afa46dfb7f0057d19eab5d99306", "url": "https://github.com/kiegroup/kie-wb-common/commit/de66e2cefe926afa46dfb7f0057d19eab5d99306", "message": "KOGITO-1014: [DMN Designer] ACE Editor is not shown for invalid DMN content", "committedDate": "2020-03-12T12:17:40Z", "type": "forcePushed"}]}