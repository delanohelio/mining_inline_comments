{"pr_number": 3116, "pr_title": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard sh\u2026", "pr_createdAt": "2020-01-21T02:29:12Z", "pr_url": "https://github.com/kiegroup/kie-wb-common/pull/3116", "timeline": [{"oid": "50537d8d12e5bce820d458c03bdfc607fed78784", "url": "https://github.com/kiegroup/kie-wb-common/commit/50537d8d12e5bce820d458c03bdfc607fed78784", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-21T02:32:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgxOTk3OA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r368819978", "bodyText": "mock(WizardPage.class) ?", "author": "cristianonicolai", "createdAt": "2020-01-21T05:45:33Z", "path": "kie-wb-common-screens/kie-wb-common-server-ui/kie-wb-common-server-ui-client/src/test/java/org/kie/workbench/common/screens/server/management/client/wizard/NewContainerWizardTest.java", "diffHunk": "@@ -176,4 +209,51 @@ public void testClose() {\n         verifyClear();\n     }\n \n-}\n\\ No newline at end of file\n+    @Test\n+    public void testPageSelected() {\n+        PageResponse<JarListPageRow> response = new PageResponse<JarListPageRow>();\n+        JarListPageRow jarListPageRow = new JarListPageRow();\n+        GAV gav = new GAV(\"test\", \"test\", \"\");\n+        jarListPageRow.setGav(gav);\n+        jarListPageRow.setPath(\"test_path\");\n+        response.setPageRowList(Arrays.asList(jarListPageRow));\n+        when(m2RepoService.listArtifacts(any())).thenReturn(response);\n+        when(newContainerFormPresenter.getCurrentGAV()).thenReturn(gav);\n+\n+        newContainerWizard.pages.add(initWizardPage());", "originalCommit": "50537d8d12e5bce820d458c03bdfc607fed78784", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgyMzU1NA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r368823554", "bodyText": "ok", "author": "bxf12315", "createdAt": "2020-01-21T06:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgxOTk3OA=="}], "type": "inlineReview"}, {"oid": "aa49997fc76f08c2ae278449ed154483b14f355a", "url": "https://github.com/kiegroup/kie-wb-common/commit/aa49997fc76f08c2ae278449ed154483b14f355a", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-21T06:08:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgyODYyMA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r368828620", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!isSelected == that.isSelected) {\n          \n          \n            \n                    if (isSelected != that.isSelected) {", "author": "cristianonicolai", "createdAt": "2020-01-21T06:25:11Z", "path": "kie-wb-common-screens/kie-wb-common-server-ui/kie-wb-common-server-ui-client/src/main/java/org/kie/workbench/common/screens/server/management/client/events/DependencyPathSelectedEvent.java", "diffHunk": "@@ -49,6 +60,10 @@ public boolean equals( final Object o ) {\n         if ( !context.equals( that.context ) ) {\n             return false;\n         }\n+\n+        if (!isSelected == that.isSelected) {", "originalCommit": "aa49997fc76f08c2ae278449ed154483b14f355a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgzNDcyMg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r368834722", "bodyText": "done", "author": "bxf12315", "createdAt": "2020-01-21T06:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgyODYyMA=="}], "type": "inlineReview"}, {"oid": "741790e89a7c2fb4968b75b660cd49cb5892d0ac", "url": "https://github.com/kiegroup/kie-wb-common/commit/741790e89a7c2fb4968b75b660cd49cb5892d0ac", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-21T06:50:49Z", "type": "forcePushed"}, {"oid": "895121c79f4b7c0d8cb75e69927b04c162b11e43", "url": "https://github.com/kiegroup/kie-wb-common/commit/895121c79f4b7c0d8cb75e69927b04c162b11e43", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-21T15:35:45Z", "type": "forcePushed"}, {"oid": "5c5f1106e84d42cfa0a774757d868d32915f1212", "url": "https://github.com/kiegroup/kie-wb-common/commit/5c5f1106e84d42cfa0a774757d868d32915f1212", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-21T16:45:59Z", "type": "forcePushed"}, {"oid": "f2fadb9f96ada56f22768f1b302e95773875cbb4", "url": "https://github.com/kiegroup/kie-wb-common/commit/f2fadb9f96ada56f22768f1b302e95773875cbb4", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-21T16:48:39Z", "type": "forcePushed"}, {"oid": "78a47d10e1002d2b2dda4478d8986f6d92fb0e2e", "url": "https://github.com/kiegroup/kie-wb-common/commit/78a47d10e1002d2b2dda4478d8986f6d92fb0e2e", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-22T05:51:07Z", "type": "forcePushed"}, {"oid": "3e48e35f38af577f986251cd8eec82cafebf29ad", "url": "https://github.com/kiegroup/kie-wb-common/commit/3e48e35f38af577f986251cd8eec82cafebf29ad", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-30T05:26:33Z", "type": "forcePushed"}, {"oid": "1dd14d41ca965575a0f5003a4433fe57af622e7b", "url": "https://github.com/kiegroup/kie-wb-common/commit/1dd14d41ca965575a0f5003a4433fe57af622e7b", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-30T05:36:42Z", "type": "forcePushed"}, {"oid": "a44f26244701ba75df18ebcd9622b88f42df53fb", "url": "https://github.com/kiegroup/kie-wb-common/commit/a44f26244701ba75df18ebcd9622b88f42df53fb", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-30T10:09:30Z", "type": "forcePushed"}, {"oid": "738876a84962ca3007ae1caa12c49ac2624f6b17", "url": "https://github.com/kiegroup/kie-wb-common/commit/738876a84962ca3007ae1caa12c49ac2624f6b17", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-01-30T12:36:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxNDYxNg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r373014616", "bodyText": "@bxf12315  If we launch here DependencyPathSelectedEvent with the param isselected = true allows to respect the changes done at Runtime Strategy configuration changed by the user throw the wizard. I think the behaviour would be more consistent with the one that is performed when a kjar is selected from list. WDYT?", "author": "nmirasch", "createdAt": "2020-01-30T15:24:04Z", "path": "kie-wb-common-screens/kie-wb-common-server-ui/kie-wb-common-server-ui-client/src/main/java/org/kie/workbench/common/screens/server/management/client/wizard/NewContainerWizard.java", "diffHunk": "@@ -109,30 +129,66 @@ public void close() {\n     @Override\n     public void complete() {\n         final Map<Capability, ContainerConfig> mapConfig = new HashMap<Capability, ContainerConfig>();\n-        if ( getPages().size() == 2 ) {\n-            mapConfig.put( Capability.PROCESS, processConfigPagePresenter.buildProcessConfig() );\n+        if (getPages().size() == 2) {\n+            mapConfig.put(Capability.PROCESS, processConfigPagePresenter.buildProcessConfig());\n         }\n-        mapConfig.put( Capability.RULE, new RuleConfig( null, KieScannerStatus.STOPPED ) );\n-        final ContainerSpec newContainer = newContainerFormPresenter.buildContainerSpec( newContainerFormPresenter.getServerTemplate().getId(),\n-                                                                                         mapConfig );\n-        specManagementService.call( new RemoteCallback<Void>() {\n-            @Override\n-            public void callback( final Void o ) {\n-                notification.fire( new NotificationEvent( newContainerFormPresenter.getView().getNewContainerWizardSaveSuccess(), NotificationEvent.NotificationType.SUCCESS ) );\n-                clear();\n-                NewContainerWizard.super.complete();\n-                serverTemplateSelectedEvent.fire( new ServerTemplateSelected( serverTemplate, newContainer.getId() ) );\n-            }\n-        }, new ErrorCallback<Object>() {\n-            @Override\n-            public boolean error( final Object o,\n-                                  final Throwable throwable ) {\n-                notification.fire( new NotificationEvent( newContainerFormPresenter.getView().getNewContainerWizardSaveError(), NotificationEvent.NotificationType.ERROR ) );\n-                NewContainerWizard.this.pageSelected( 0 );\n-                NewContainerWizard.this.start();\n-                return false;\n+        mapConfig.put(Capability.RULE, new RuleConfig(null, KieScannerStatus.STOPPED));\n+        final ContainerSpec newContainer = newContainerFormPresenter.buildContainerSpec(newContainerFormPresenter.getServerTemplate().getId(),\n+                                                                                        mapConfig);\n+        GAV gav = new GAV(newContainer.getReleasedId().getGroupId(), newContainer.getReleasedId().getArtifactId(), newContainer.getReleasedId().getVersion());\n+        JarListPageRequest request = new JarListPageRequest(0, Integer.MAX_VALUE, null, Arrays.asList(\"jar\"), null, false);\n+\n+        m2RepoService.call(response -> {\n+            List<JarListPageRow> jarListPageRowList = ((PageResponse<JarListPageRow>) response).getPageRowList();\n+            Optional<JarListPageRow> optionalJarListPageRow = jarListPageRowList.stream().filter(jarListPageRow -> jarListPageRow.getGav().equals(gav)).findFirst();\n+            if (optionalJarListPageRow.isPresent()) {\n+                specManagementService.call(new RemoteCallback<Void>() {\n+                    @Override\n+                    public void callback(final Void o) {\n+                        notification.fire(new NotificationEvent(newContainerFormPresenter.getView().getNewContainerWizardSaveSuccess(), NotificationEvent.NotificationType.SUCCESS));\n+                        clear();\n+                        NewContainerWizard.super.complete();\n+                        serverTemplateSelectedEvent.fire(new ServerTemplateSelected(serverTemplate, newContainer.getId()));\n+                    }\n+                }, new ErrorCallback<Object>() {\n+                    @Override\n+                    public boolean error(final Object o,\n+                                         final Throwable throwable) {\n+                        notification.fire(new NotificationEvent(newContainerFormPresenter.getView().getNewContainerWizardSaveError(), NotificationEvent.NotificationType.ERROR));\n+                        NewContainerWizard.this.pageSelected(0);\n+                        NewContainerWizard.this.start();\n+                        return false;\n+                    }\n+                }).saveContainerSpec(newContainerFormPresenter.getServerTemplate().getId(), newContainer);\n+            } else {\n+                notification.fire(new NotificationEvent(newContainerFormPresenter.getView().getNewContainerGAVNotExist(gav.toString()), NotificationEvent.NotificationType.ERROR));\n             }\n-        } ).saveContainerSpec( newContainerFormPresenter.getServerTemplate().getId(), newContainer );\n+        }).listArtifacts(request);\n+    }\n+\n+    public void onDependencyPathSelectedEvent(@Observes DependencyPathSelectedEvent event){\n+            this.isSelected = event.isSelected();\n     }\n \n+    @Override\n+    public void pageSelected(final int pageNumber) {\n+        if (pageNumber == 1 && !isSelected) {\n+            GAV gav = newContainerFormPresenter.getCurrentGAV();\n+            JarListPageRequest request = new JarListPageRequest(0, Integer.MAX_VALUE, null, Arrays.asList(\"jar\"), null, false);\n+\n+            m2RepoService.call(response -> {\n+                List<JarListPageRow> jarListPageRowList = ((PageResponse<JarListPageRow>) response).getPageRowList();\n+                Optional<JarListPageRow> optionalJarListPageRow = jarListPageRowList.stream().filter(jarListPageRow -> jarListPageRow.getGav().equals(gav))\n+                        .sorted(Comparator.comparing(JarListPageRow::getLastModified).reversed()).findFirst();\n+                if (optionalJarListPageRow.isPresent()) {\n+                    if (optionalJarListPageRow.get().getPath() != null && !optionalJarListPageRow.get().getPath().isEmpty()) {\n+                        dependencyPathSelectedEvent.fire(new DependencyPathSelectedEvent(this, optionalJarListPageRow.get().getPath(), false));", "originalCommit": "738876a84962ca3007ae1caa12c49ac2624f6b17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM4OTgzMg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r373389832", "bodyText": "+1", "author": "cristianonicolai", "createdAt": "2020-01-31T09:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxNDYxNg=="}], "type": "inlineReview"}, {"oid": "bbc9e5e9bf6164abab9e7d709a3caa24d939c0df", "url": "https://github.com/kiegroup/kie-wb-common/commit/bbc9e5e9bf6164abab9e7d709a3caa24d939c0df", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-02-01T04:06:56Z", "type": "forcePushed"}, {"oid": "d50fcd058c626b44292ebd14884b240b1dad7bcb", "url": "https://github.com/kiegroup/kie-wb-common/commit/d50fcd058c626b44292ebd14884b240b1dad7bcb", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-02-01T06:53:16Z", "type": "forcePushed"}, {"oid": "7019a7f6b9f4c25cd04b231f5b4a9874ca7370ed", "url": "https://github.com/kiegroup/kie-wb-common/commit/7019a7f6b9f4c25cd04b231f5b4a9874ca7370ed", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-02-01T08:05:04Z", "type": "forcePushed"}, {"oid": "57b45def152dcbb13ea8e44de7cebdb54babbb9e", "url": "https://github.com/kiegroup/kie-wb-common/commit/57b45def152dcbb13ea8e44de7cebdb54babbb9e", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-02-01T08:19:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ1NDI4NA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r374454284", "bodyText": "check if needed", "author": "cristianonicolai", "createdAt": "2020-02-04T03:07:47Z", "path": "kie-wb-common-screens/kie-wb-common-server-ui/kie-wb-common-server-ui-client/src/main/java/org/kie/workbench/common/screens/server/management/client/events/DependencyPathSelectedEvent.java", "diffHunk": "@@ -20,13 +20,20 @@\n \n     private final Object context;\n     private final String path;\n+    private boolean isSelected = true;", "originalCommit": "57b45def152dcbb13ea8e44de7cebdb54babbb9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ1NzIxNg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r374457216", "bodyText": "done", "author": "bxf12315", "createdAt": "2020-02-04T03:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ1NDI4NA=="}], "type": "inlineReview"}, {"oid": "21b83ba3a130fec7e67135cae3c64e8e4e43a6c8", "url": "https://github.com/kiegroup/kie-wb-common/commit/21b83ba3a130fec7e67135cae3c64e8e4e43a6c8", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-02-04T03:21:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1Nzk2OQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r374557969", "bodyText": "remove change", "author": "cristianonicolai", "createdAt": "2020-02-04T09:28:22Z", "path": "kie-wb-common-screens/kie-wb-common-server-ui/kie-wb-common-server-ui-client/src/main/java/org/kie/workbench/common/screens/server/management/client/events/DependencyPathSelectedEvent.java", "diffHunk": "@@ -27,6 +27,7 @@ public DependencyPathSelectedEvent( final Object context,\n         this.path = path;\n     }\n \n+", "originalCommit": "21b83ba3a130fec7e67135cae3c64e8e4e43a6c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1ODAwNQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r374558005", "bodyText": "remove change", "author": "cristianonicolai", "createdAt": "2020-02-04T09:28:26Z", "path": "kie-wb-common-screens/kie-wb-common-server-ui/kie-wb-common-server-ui-client/src/main/java/org/kie/workbench/common/screens/server/management/client/events/DependencyPathSelectedEvent.java", "diffHunk": "@@ -35,6 +36,7 @@ public String getPath() {\n         return path;\n     }\n \n+", "originalCommit": "21b83ba3a130fec7e67135cae3c64e8e4e43a6c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1ODA1OA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3116#discussion_r374558058", "bodyText": "remove change", "author": "cristianonicolai", "createdAt": "2020-02-04T09:28:34Z", "path": "kie-wb-common-screens/kie-wb-common-server-ui/kie-wb-common-server-ui-client/src/main/java/org/kie/workbench/common/screens/server/management/client/events/DependencyPathSelectedEvent.java", "diffHunk": "@@ -49,6 +51,7 @@ public boolean equals( final Object o ) {\n         if ( !context.equals( that.context ) ) {\n             return false;\n         }\n+", "originalCommit": "21b83ba3a130fec7e67135cae3c64e8e4e43a6c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "65e1aa11a1b5fe25f56821e1d983f346485f9104", "url": "https://github.com/kiegroup/kie-wb-common/commit/65e1aa11a1b5fe25f56821e1d983f346485f9104", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-02-04T10:11:31Z", "type": "commit"}, {"oid": "65e1aa11a1b5fe25f56821e1d983f346485f9104", "url": "https://github.com/kiegroup/kie-wb-common/commit/65e1aa11a1b5fe25f56821e1d983f346485f9104", "message": "JBPM-8984 Default runtime strategy of 'New Deployment Unit' wizard should respect kie-deployment-descriptor.xml when manually inputting GAV", "committedDate": "2020-02-04T10:11:31Z", "type": "forcePushed"}]}