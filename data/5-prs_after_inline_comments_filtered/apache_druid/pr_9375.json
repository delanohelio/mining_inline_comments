{"pr_number": 9375, "pr_title": "Add support for optional aws credentials for s3 for ingestion", "pr_createdAt": "2020-02-18T20:31:53Z", "pr_url": "https://github.com/apache/druid/pull/9375", "timeline": [{"oid": "7c60b8e88fdee93e85c5c588d3e061f55755adf0", "url": "https://github.com/apache/druid/commit/7c60b8e88fdee93e85c5c588d3e061f55755adf0", "message": "Add support for optional cloud (aws, gcs, etc.) credentials for s3 for ingestion", "committedDate": "2020-02-11T21:03:18Z", "type": "commit"}, {"oid": "30c24343b60d825dabf86037d15ceade78e32882", "url": "https://github.com/apache/druid/commit/30c24343b60d825dabf86037d15ceade78e32882", "message": "Add support for optional cloud (aws, gcs, etc.) credentials for s3 for ingestion", "committedDate": "2020-02-18T20:30:23Z", "type": "commit"}, {"oid": "501dc4b565ba890587d2605baefe5b509747b8c1", "url": "https://github.com/apache/druid/commit/501dc4b565ba890587d2605baefe5b509747b8c1", "message": "Add support for optional cloud (aws, gcs, etc.) credentials for s3 for ingestion", "committedDate": "2020-02-19T01:13:52Z", "type": "commit"}, {"oid": "111fa05a6aa56e3600893c1c317db67bb6d7e8c9", "url": "https://github.com/apache/druid/commit/111fa05a6aa56e3600893c1c317db67bb6d7e8c9", "message": "Merge remote-tracking branch 'upstream/master' into IMPLY-1582", "committedDate": "2020-02-19T18:59:22Z", "type": "commit"}, {"oid": "dc6b252535e79c5b6b17e84f3466323b74d61ae3", "url": "https://github.com/apache/druid/commit/dc6b252535e79c5b6b17e84f3466323b74d61ae3", "message": "fix build failure", "committedDate": "2020-02-19T19:21:34Z", "type": "commit"}, {"oid": "8a216b4a6e9e19573fea6363ac12dfb2f35135a7", "url": "https://github.com/apache/druid/commit/8a216b4a6e9e19573fea6363ac12dfb2f35135a7", "message": "fix failing build", "committedDate": "2020-02-19T20:24:53Z", "type": "commit"}, {"oid": "13a9181730043e4d3d466510b4938be450321b45", "url": "https://github.com/apache/druid/commit/13a9181730043e4d3d466510b4938be450321b45", "message": "fix failing build", "committedDate": "2020-02-19T21:19:55Z", "type": "commit"}, {"oid": "5f83962931718f222f4b96ff84cb077591827708", "url": "https://github.com/apache/druid/commit/5f83962931718f222f4b96ff84cb077591827708", "message": "Code cleanup", "committedDate": "2020-02-19T23:00:51Z", "type": "commit"}, {"oid": "960fcaa0e15b23291a77ae23631240fd0bcaefe8", "url": "https://github.com/apache/druid/commit/960fcaa0e15b23291a77ae23631240fd0bcaefe8", "message": "fix failing test", "committedDate": "2020-02-20T02:30:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcwOTIwMg==", "url": "https://github.com/apache/druid/pull/9375#discussion_r381709202", "bodyText": "This should probably be added to https://druid.apache.org/docs/latest/ingestion/native-batch.html#s3-input-source. Similar comment for the other modified input sources.", "author": "ccaominh", "createdAt": "2020-02-20T03:24:30Z", "path": "extensions-core/s3-extensions/src/main/java/org/apache/druid/data/input/s3/S3InputSource.java", "diffHunk": "@@ -46,13 +51,25 @@\n   @JsonCreator\n   public S3InputSource(\n       @JacksonInject ServerSideEncryptingAmazonS3 s3Client,\n+      @JacksonInject AmazonS3ClientBuilder amazonS3ClientBuilder,\n+      @JacksonInject S3StorageConfig storageConfig,\n       @JsonProperty(\"uris\") @Nullable List<URI> uris,\n       @JsonProperty(\"prefixes\") @Nullable List<URI> prefixes,\n-      @JsonProperty(\"objects\") @Nullable List<CloudObjectLocation> objects\n+      @JsonProperty(\"objects\") @Nullable List<CloudObjectLocation> objects,\n+      @JsonProperty(\"properties\") @Nullable CloudConfigProperties cloudConfigProperties", "originalCommit": "960fcaa0e15b23291a77ae23631240fd0bcaefe8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MTIwNQ==", "url": "https://github.com/apache/druid/pull/9375#discussion_r382281205", "bodyText": "I don't think the other docs should be modified yet, only s3, since the others are not wired up to anything there like it is in S3InputSource.", "author": "clintropolis", "createdAt": "2020-02-20T21:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcwOTIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4NTUwMA==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383085500", "bodyText": "Yep. Will only modify docs for s3", "author": "maytasm", "createdAt": "2020-02-24T04:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcwOTIwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE5NzY0MA==", "url": "https://github.com/apache/druid/pull/9375#discussion_r382197640", "bodyText": "Do we want to support Azure with this too? If so Azure is a bit different; requires an account id, and secret key. Can this be extended for that easily?", "author": "zachjsh", "createdAt": "2020-02-20T19:04:16Z", "path": "core/src/main/java/org/apache/druid/data/input/impl/CloudConfigProperties.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.data.input.impl;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import org.apache.druid.metadata.PasswordProvider;\n+\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n+public class CloudConfigProperties\n+{\n+  @JsonCreator\n+  public CloudConfigProperties(\n+      @JsonProperty(\"accessKeyId\") @Nullable PasswordProvider accessKeyId,", "originalCommit": "960fcaa0e15b23291a77ae23631240fd0bcaefe8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE5OTAxNg==", "url": "https://github.com/apache/druid/pull/9375#discussion_r382199016", "bodyText": "Yes. Maybe we can rename the accessKeyId to something more generic. But all the cloud (s3, G, Azure) requires a \"user\" and a \"password\" which this should work for all", "author": "maytasm", "createdAt": "2020-02-20T19:06:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE5NzY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4NTU5MQ==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383085591", "bodyText": "Making a specific configProperties class for each cloudInputSource without sharing inheritance", "author": "maytasm", "createdAt": "2020-02-24T04:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE5NzY0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MDcwMw==", "url": "https://github.com/apache/druid/pull/9375#discussion_r382280703", "bodyText": "I wonder if this class is too synthetic, and instead should not be a shared base type, and rather be input source specific. Like I imagine it could be useful in the future to support additional properties, but beyond the 'username' and 'password' model that is common to all clouds, further stuff probably starts to get really cloud specific and probably not a lot of benefit being down here.\nIt might be better if in this PR you would add a S3InputSourceConfig or whatever directly to S3InputSource and not pass it down to the base type, since it doesn't actually seem to be of any use there, and also not modify azure and google cloud since they can add their own specific implementations when support is added for credentials override there (and use their own terminology for username/password). @maytasm3 / @jihoonson what do you think?", "author": "clintropolis", "createdAt": "2020-02-20T21:57:49Z", "path": "core/src/main/java/org/apache/druid/data/input/impl/CloudConfigProperties.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.data.input.impl;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import org.apache.druid.metadata.PasswordProvider;\n+\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n+public class CloudConfigProperties", "originalCommit": "960fcaa0e15b23291a77ae23631240fd0bcaefe8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4NTgyNg==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383085826", "bodyText": "Make sense to me. Making a specific configProperties class for each cloudInputSource without sharing inheritance. (For this PR, just the S3 stuff and Azure and G will comes in a later PR).", "author": "maytasm", "createdAt": "2020-02-24T04:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MDcwMw=="}], "type": "inlineReview"}, {"oid": "f3a6216c9581134d6910ab951d93cb6d533b52c0", "url": "https://github.com/apache/druid/commit/f3a6216c9581134d6910ab951d93cb6d533b52c0", "message": "Removed CloudConfigProperties and make specific class for each cloudInputSource", "committedDate": "2020-02-24T04:52:24Z", "type": "commit"}, {"oid": "2b585dd533af8d4894667c0245fee4f04dfdfabd", "url": "https://github.com/apache/druid/commit/2b585dd533af8d4894667c0245fee4f04dfdfabd", "message": "Removed CloudConfigProperties and make specific class for each cloudInputSource", "committedDate": "2020-02-24T05:00:40Z", "type": "commit"}, {"oid": "234dc14dbd5cdb8ec2540e7f3ce9119732da13a8", "url": "https://github.com/apache/druid/commit/234dc14dbd5cdb8ec2540e7f3ce9119732da13a8", "message": "pass s3ConfigProperties for split", "committedDate": "2020-02-24T05:09:49Z", "type": "commit"}, {"oid": "dc1f1082018e476953fc19332f14539b03488862", "url": "https://github.com/apache/druid/commit/dc1f1082018e476953fc19332f14539b03488862", "message": "lazy init s3client", "committedDate": "2020-02-24T06:26:04Z", "type": "commit"}, {"oid": "1e01443b092578953a90e500a9227c1e1ac7348c", "url": "https://github.com/apache/druid/commit/1e01443b092578953a90e500a9227c1e1ac7348c", "message": "update docs", "committedDate": "2020-02-24T08:13:47Z", "type": "commit"}, {"oid": "ad62c83efbc7ddb4bbaa52a10edd74568a137ad3", "url": "https://github.com/apache/druid/commit/ad62c83efbc7ddb4bbaa52a10edd74568a137ad3", "message": "fix merge conflict", "committedDate": "2020-02-24T08:46:14Z", "type": "commit"}, {"oid": "64d2720829fbc7ed32a40afb3bbd36e9920370fe", "url": "https://github.com/apache/druid/commit/64d2720829fbc7ed32a40afb3bbd36e9920370fe", "message": "fix docs check", "committedDate": "2020-02-24T18:44:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMDMwOQ==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383510309", "bodyText": "This should live in the s3 extension, not in druid-core", "author": "clintropolis", "createdAt": "2020-02-24T20:58:18Z", "path": "core/src/main/java/org/apache/druid/data/input/impl/S3ConfigProperties.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.data.input.impl;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import org.apache.druid.metadata.PasswordProvider;\n+\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n+/**\n+ * Contains properties for s3 access configuration.\n+ * Properties can be specified by ingestionSpec and override system default.\n+ */\n+public class S3ConfigProperties", "originalCommit": "64d2720829fbc7ed32a40afb3bbd36e9920370fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5Njg3Nw==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383596877", "bodyText": "Oops forgot that. Done.", "author": "maytasm", "createdAt": "2020-02-25T00:37:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMDMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMDk2Mg==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383510962", "bodyText": "nit: formatting looks sort of funny here to me, unfortunately i think this is one of the few things style checks don't catch", "author": "clintropolis", "createdAt": "2020-02-24T20:59:43Z", "path": "extensions-core/s3-extensions/src/main/java/org/apache/druid/data/input/s3/S3InputSource.java", "diffHunk": "@@ -76,7 +114,41 @@ protected S3Entity createEntity(InputSplit<CloudObjectLocation> split)\n   @Override\n   public SplittableInputSource<CloudObjectLocation> withSplit(InputSplit<CloudObjectLocation> split)\n   {\n-    return new S3InputSource(s3Client, inputDataConfig, null, null, ImmutableList.of(split.get()));\n+    return new S3InputSource(\n+        s3Client.get(),", "originalCommit": "64d2720829fbc7ed32a40afb3bbd36e9920370fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5Mzk4Mw==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383593983", "bodyText": "Not sure what is the correct formatting here.\nI do see something like below in the code\n        CloudFilesObject segmentData = new CloudFilesObject(\n            segmentPath,\n            outFile,\n            objectApi.getRegion(),\n            objectApi.getContainer()\n        );\n\nand\n    return Iterables.transform(\n        supervisorSpec.getSpec().getDataSources(),\n        AuthorizationUtils.DATASOURCE_READ_RA_GENERATOR\n    );", "author": "maytasm", "createdAt": "2020-02-25T00:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMDk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5NDM0OQ==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383594349", "bodyText": "I think that's the same formatting.", "author": "maytasm", "createdAt": "2020-02-25T00:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMDk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5ODQzMg==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383598432", "bodyText": "oops. Totally didn't see the extra whitespace at the beginning of some lines. Fixed. Thanks", "author": "maytasm", "createdAt": "2020-02-25T00:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMDk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMTE4Mg==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383511182", "bodyText": "nit: this could be one line", "author": "clintropolis", "createdAt": "2020-02-24T21:00:15Z", "path": "extensions-core/s3-extensions/src/main/java/org/apache/druid/data/input/s3/S3InputSource.java", "diffHunk": "@@ -76,7 +114,41 @@ protected S3Entity createEntity(InputSplit<CloudObjectLocation> split)\n   @Override\n   public SplittableInputSource<CloudObjectLocation> withSplit(InputSplit<CloudObjectLocation> split)\n   {\n-    return new S3InputSource(s3Client, inputDataConfig, null, null, ImmutableList.of(split.get()));\n+    return new S3InputSource(\n+        s3Client.get(),\n+       null,\n+       null,\n+        inputDataConfig,\n+       null,\n+       null,\n+       ImmutableList.of(split.get()),\n+       getS3ConfigProperties()\n+    );\n+  }\n+\n+  @Override\n+  public int hashCode()\n+  {\n+    return Objects.hash(\n+        super.hashCode(),", "originalCommit": "64d2720829fbc7ed32a40afb3bbd36e9920370fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5NzAxNQ==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383597015", "bodyText": "done", "author": "maytasm", "createdAt": "2020-02-25T00:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMTE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNzI3OQ==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383517279", "bodyText": "hmm, should the check that one of s3Client or amazonS3ClientBuilder and storageConfig  are not null be done eagerly instead of in the supplier? (i'm not certain either way, just thinking out loud)", "author": "clintropolis", "createdAt": "2020-02-24T21:13:08Z", "path": "extensions-core/s3-extensions/src/main/java/org/apache/druid/data/input/s3/S3InputSource.java", "diffHunk": "@@ -19,50 +19,88 @@\n \n package org.apache.druid.data.input.s3;\n \n+import com.amazonaws.auth.AWSStaticCredentialsProvider;\n+import com.amazonaws.auth.BasicAWSCredentials;\n+import com.amazonaws.services.s3.AmazonS3ClientBuilder;\n import com.amazonaws.services.s3.model.S3ObjectSummary;\n import com.fasterxml.jackson.annotation.JacksonInject;\n import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonProperty;\n import com.google.common.base.Preconditions;\n+import com.google.common.base.Supplier;\n+import com.google.common.base.Suppliers;\n import com.google.common.collect.ImmutableList;\n import org.apache.druid.data.input.InputSplit;\n import org.apache.druid.data.input.impl.CloudObjectInputSource;\n import org.apache.druid.data.input.impl.CloudObjectLocation;\n+import org.apache.druid.data.input.impl.S3ConfigProperties;\n import org.apache.druid.data.input.impl.SplittableInputSource;\n import org.apache.druid.storage.s3.S3InputDataConfig;\n+import org.apache.druid.storage.s3.S3StorageConfig;\n import org.apache.druid.storage.s3.S3StorageDruidModule;\n import org.apache.druid.storage.s3.S3Utils;\n import org.apache.druid.storage.s3.ServerSideEncryptingAmazonS3;\n \n import javax.annotation.Nullable;\n import java.net.URI;\n import java.util.List;\n+import java.util.Objects;\n import java.util.stream.Stream;\n import java.util.stream.StreamSupport;\n \n public class S3InputSource extends CloudObjectInputSource<S3Entity>\n {\n-  private final ServerSideEncryptingAmazonS3 s3Client;\n+  // We lazily initialize s3Client to avoid costly s3 operation when we only need S3InputSource for stored information\n+  // (such as for task logs) and not for ingestion. (This cost only applies for new s3Client created with\n+  // s3ConfigProperties given).\n+  private final Supplier<ServerSideEncryptingAmazonS3> s3Client;\n+  @JsonProperty(\"properties\")\n+  private final S3ConfigProperties s3ConfigProperties;\n   private final S3InputDataConfig inputDataConfig;\n \n   @JsonCreator\n   public S3InputSource(\n       @JacksonInject ServerSideEncryptingAmazonS3 s3Client,\n+      @JacksonInject AmazonS3ClientBuilder amazonS3ClientBuilder,\n+      @JacksonInject S3StorageConfig storageConfig,\n       @JacksonInject S3InputDataConfig inputDataConfig,\n       @JsonProperty(\"uris\") @Nullable List<URI> uris,\n       @JsonProperty(\"prefixes\") @Nullable List<URI> prefixes,\n-      @JsonProperty(\"objects\") @Nullable List<CloudObjectLocation> objects\n+      @JsonProperty(\"objects\") @Nullable List<CloudObjectLocation> objects,\n+      @JsonProperty(\"properties\") @Nullable S3ConfigProperties s3ConfigProperties\n   )\n   {\n     super(S3StorageDruidModule.SCHEME, uris, prefixes, objects);\n-    this.s3Client = Preconditions.checkNotNull(s3Client, \"s3Client\");\n     this.inputDataConfig = Preconditions.checkNotNull(inputDataConfig, \"S3DataSegmentPusherConfig\");\n+    this.s3ConfigProperties = s3ConfigProperties;\n+    this.s3Client = Suppliers.memoize(\n+        () -> {\n+          if (amazonS3ClientBuilder != null && storageConfig != null && s3ConfigProperties != null) {\n+            if (s3ConfigProperties.isCredentialsConfigured()) {\n+              BasicAWSCredentials creds = new BasicAWSCredentials(\n+                  s3ConfigProperties.getAccessKeyId().getPassword(),\n+                  s3ConfigProperties.getSecretAccessKey().getPassword());\n+              amazonS3ClientBuilder.withCredentials(new AWSStaticCredentialsProvider(creds));\n+            }\n+            return new ServerSideEncryptingAmazonS3(amazonS3ClientBuilder.build(), storageConfig.getServerSideEncryption());\n+          } else {\n+            return Preconditions.checkNotNull(s3Client, \"s3Client\");", "originalCommit": "64d2720829fbc7ed32a40afb3bbd36e9920370fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5OTI4MQ==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383599281", "bodyText": "I think it will be the same either way. Had it this way to keep all relevant logic for determining which s3Client to use together (inside the Suppliers.memorize(). I'm fine either way though.", "author": "maytasm", "createdAt": "2020-02-25T00:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNzI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYwMDMxOQ==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383600319", "bodyText": "I guess it may not matter much here since this is just a sanity check which shouldn't happen, but it would be better to fail as early as possible. The check in the constructor will be called in the JSON deserialization while other methods will be called after the task is scheduled on a middleManager.", "author": "jihoonson", "createdAt": "2020-02-25T00:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNzI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMjE0Mg==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383612142", "bodyText": "Moved all the Preconditions.checkNotNull outside", "author": "maytasm", "createdAt": "2020-02-25T01:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNzI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzODkyNw==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383538927", "bodyText": "nit: suggest s3ClientSupplier.", "author": "jihoonson", "createdAt": "2020-02-24T21:57:03Z", "path": "extensions-core/s3-extensions/src/main/java/org/apache/druid/data/input/s3/S3InputSource.java", "diffHunk": "@@ -19,50 +19,88 @@\n \n package org.apache.druid.data.input.s3;\n \n+import com.amazonaws.auth.AWSStaticCredentialsProvider;\n+import com.amazonaws.auth.BasicAWSCredentials;\n+import com.amazonaws.services.s3.AmazonS3ClientBuilder;\n import com.amazonaws.services.s3.model.S3ObjectSummary;\n import com.fasterxml.jackson.annotation.JacksonInject;\n import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonProperty;\n import com.google.common.base.Preconditions;\n+import com.google.common.base.Supplier;\n+import com.google.common.base.Suppliers;\n import com.google.common.collect.ImmutableList;\n import org.apache.druid.data.input.InputSplit;\n import org.apache.druid.data.input.impl.CloudObjectInputSource;\n import org.apache.druid.data.input.impl.CloudObjectLocation;\n+import org.apache.druid.data.input.impl.S3ConfigProperties;\n import org.apache.druid.data.input.impl.SplittableInputSource;\n import org.apache.druid.storage.s3.S3InputDataConfig;\n+import org.apache.druid.storage.s3.S3StorageConfig;\n import org.apache.druid.storage.s3.S3StorageDruidModule;\n import org.apache.druid.storage.s3.S3Utils;\n import org.apache.druid.storage.s3.ServerSideEncryptingAmazonS3;\n \n import javax.annotation.Nullable;\n import java.net.URI;\n import java.util.List;\n+import java.util.Objects;\n import java.util.stream.Stream;\n import java.util.stream.StreamSupport;\n \n public class S3InputSource extends CloudObjectInputSource<S3Entity>\n {\n-  private final ServerSideEncryptingAmazonS3 s3Client;\n+  // We lazily initialize s3Client to avoid costly s3 operation when we only need S3InputSource for stored information\n+  // (such as for task logs) and not for ingestion. (This cost only applies for new s3Client created with\n+  // s3ConfigProperties given).\n+  private final Supplier<ServerSideEncryptingAmazonS3> s3Client;", "originalCommit": "64d2720829fbc7ed32a40afb3bbd36e9920370fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMjE5MA==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383612190", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-02-25T01:31:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzODkyNw=="}], "type": "inlineReview"}, {"oid": "13c2d6e9f3380a1a1e8cc0fdad197bf9c9499ee4", "url": "https://github.com/apache/druid/commit/13c2d6e9f3380a1a1e8cc0fdad197bf9c9499ee4", "message": "address comments", "committedDate": "2020-02-25T01:06:55Z", "type": "commit"}, {"oid": "062e487ba4131a12d08dcdb7cf7daf2c67e4a3fd", "url": "https://github.com/apache/druid/commit/062e487ba4131a12d08dcdb7cf7daf2c67e4a3fd", "message": "add ServerSideEncryptingAmazonS3.Builder", "committedDate": "2020-02-25T02:30:22Z", "type": "commit"}, {"oid": "af0c9235800b736c44d378a7e93abe2a6e8d5401", "url": "https://github.com/apache/druid/commit/af0c9235800b736c44d378a7e93abe2a6e8d5401", "message": "resolve merge conflict", "committedDate": "2020-02-25T02:47:32Z", "type": "commit"}, {"oid": "1ac7dc7d8c3fb9fcbd7320b0d94eb2686759b7c4", "url": "https://github.com/apache/druid/commit/1ac7dc7d8c3fb9fcbd7320b0d94eb2686759b7c4", "message": "fix failing checkstyle", "committedDate": "2020-02-25T02:49:17Z", "type": "commit"}, {"oid": "05395fde480c13f67180a92627d9bf6d82726a3c", "url": "https://github.com/apache/druid/commit/05395fde480c13f67180a92627d9bf6d82726a3c", "message": "fix typo", "committedDate": "2020-02-25T03:00:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgwNDk2NQ==", "url": "https://github.com/apache/druid/pull/9375#discussion_r383804965", "bodyText": "this maybe should be named S3InputSourceConfig or something to be more consistently named with other config-ish classes (there is not any types of the form {name}Properties.java in druid currently, and I associate the word to java.util.Properties which this isn't related to)", "author": "clintropolis", "createdAt": "2020-02-25T10:54:12Z", "path": "extensions-core/s3-extensions/src/main/java/org/apache/druid/data/input/s3/S3InputSourceProperties.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.data.input.s3;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import org.apache.druid.metadata.PasswordProvider;\n+\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n+/**\n+ * Contains properties for s3 input source.\n+ * Properties can be specified by ingestionSpec which will override system default.\n+ */\n+public class S3InputSourceProperties", "originalCommit": "05395fde480c13f67180a92627d9bf6d82726a3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE2OTk1OA==", "url": "https://github.com/apache/druid/pull/9375#discussion_r384169958", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-02-25T22:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgwNDk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyNjE4Mw==", "url": "https://github.com/apache/druid/pull/9375#discussion_r384026183", "bodyText": "modify -> modified?", "author": "jihoonson", "createdAt": "2020-02-25T17:39:37Z", "path": "extensions-core/s3-extensions/src/main/java/org/apache/druid/storage/s3/S3StorageDruidModule.java", "diffHunk": "@@ -166,9 +166,11 @@ public void configure(Binder binder)\n     binder.bind(S3TaskLogs.class).in(LazySingleton.class);\n   }\n \n+  // This provides ServerSideEncryptingAmazonS3.Builder with default configs from Guice injection initially set.\n+  // However, this builder can then be modify and have configuration(s) inside", "originalCommit": "05395fde480c13f67180a92627d9bf6d82726a3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE2OTk4Mw==", "url": "https://github.com/apache/druid/pull/9375#discussion_r384169983", "bodyText": "done", "author": "maytasm", "createdAt": "2020-02-25T22:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyNjE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyNzcyNQ==", "url": "https://github.com/apache/druid/pull/9375#discussion_r384027725", "bodyText": "Do we still need this s3Client parameter to reuse the singleton client? If so, please leave a comment about it.", "author": "jihoonson", "createdAt": "2020-02-25T17:42:19Z", "path": "extensions-core/s3-extensions/src/main/java/org/apache/druid/data/input/s3/S3InputSource.java", "diffHunk": "@@ -42,32 +46,66 @@\n import java.net.URI;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.Objects;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n public class S3InputSource extends CloudObjectInputSource\n {\n-  private final ServerSideEncryptingAmazonS3 s3Client;\n+  // We lazily initialize ServerSideEncryptingAmazonS3 to avoid costly s3 operation when we only need S3InputSource\n+  // for stored information (such as for task logs) and not for ingestion.\n+  // (This cost only applies for new ServerSideEncryptingAmazonS3 created with s3InputSourceProperties given).\n+  private final Supplier<ServerSideEncryptingAmazonS3> s3ClientSupplier;\n+  @JsonProperty(\"properties\")\n+  private final S3InputSourceProperties s3InputSourceProperties;\n   private final S3InputDataConfig inputDataConfig;\n \n   @JsonCreator\n   public S3InputSource(\n       @JacksonInject ServerSideEncryptingAmazonS3 s3Client,", "originalCommit": "05395fde480c13f67180a92627d9bf6d82726a3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE2OTk5Ng==", "url": "https://github.com/apache/druid/pull/9375#discussion_r384169996", "bodyText": "Yea..we still need it to use the singleton client for when the properties is not present in the JSON. This will save the cost of initializing the s3client using the s3ClientSupplier since we can reuse the  injected singleton", "author": "maytasm", "createdAt": "2020-02-25T22:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyNzcyNQ=="}], "type": "inlineReview"}, {"oid": "fe3aa7402b160e0e389c5e7184d3e384c20de5db", "url": "https://github.com/apache/druid/commit/fe3aa7402b160e0e389c5e7184d3e384c20de5db", "message": "wrap the ServerSideEncryptingAmazonS3.Builder in a provider", "committedDate": "2020-02-25T22:38:36Z", "type": "commit"}, {"oid": "e119516ee9d45ddfbe24a336445828b532608bd6", "url": "https://github.com/apache/druid/commit/e119516ee9d45ddfbe24a336445828b532608bd6", "message": "added java docs for S3InputSource constructor", "committedDate": "2020-02-25T22:57:28Z", "type": "commit"}, {"oid": "00b3e1dee1c1fa88cebaf693ee1ec3071e891713", "url": "https://github.com/apache/druid/commit/00b3e1dee1c1fa88cebaf693ee1ec3071e891713", "message": "added java docs for S3InputSource constructor", "committedDate": "2020-02-25T23:00:05Z", "type": "commit"}, {"oid": "09e0d6ea7efbf9c03c029d307e8b2fdbf7009ffe", "url": "https://github.com/apache/druid/commit/09e0d6ea7efbf9c03c029d307e8b2fdbf7009ffe", "message": "remove wrap the ServerSideEncryptingAmazonS3.Builder in a provider", "committedDate": "2020-02-26T00:20:11Z", "type": "commit"}]}