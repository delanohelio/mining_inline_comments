{"pr_number": 10688, "pr_title": "Historical unloads damaged segments automatically when lazy on start.", "pr_createdAt": "2020-12-17T13:51:34Z", "pr_url": "https://github.com/apache/druid/pull/10688", "timeline": [{"oid": "0a6eb308f5f3c01099f6cf540dd67eaacc4f85ed", "url": "https://github.com/apache/druid/commit/0a6eb308f5f3c01099f6cf540dd67eaacc4f85ed", "message": "ready to test", "committedDate": "2021-01-05T03:45:26Z", "type": "commit"}, {"oid": "4c3e69770ccfed29ac0e5d77fbd3fa6495493da5", "url": "https://github.com/apache/druid/commit/4c3e69770ccfed29ac0e5d77fbd3fa6495493da5", "message": "tested on dev cluster", "committedDate": "2021-01-05T03:47:57Z", "type": "commit"}, {"oid": "7775658a57209265762bc41e30b90d7774a3e362", "url": "https://github.com/apache/druid/commit/7775658a57209265762bc41e30b90d7774a3e362", "message": "tested", "committedDate": "2021-01-05T04:38:27Z", "type": "commit"}, {"oid": "7775658a57209265762bc41e30b90d7774a3e362", "url": "https://github.com/apache/druid/commit/7775658a57209265762bc41e30b90d7774a3e362", "message": "tested", "committedDate": "2021-01-05T04:38:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5NTE3OQ==", "url": "https://github.com/apache/druid/pull/10688#discussion_r552395179", "bodyText": "Use a more meaningful name, like SegmentLazyLoadFailCallback", "author": "kaijianding", "createdAt": "2021-01-06T06:34:48Z", "path": "core/src/main/java/org/apache/druid/coordination/CommonCallback.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.coordination;\n+\n+public interface CommonCallback", "originalCommit": "7775658a57209265762bc41e30b90d7774a3e362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE3MzI0NQ==", "url": "https://github.com/apache/druid/pull/10688#discussion_r553173245", "bodyText": "done.", "author": "zhangyue19921010", "createdAt": "2021-01-07T08:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5NTE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5NTU0MA==", "url": "https://github.com/apache/druid/pull/10688#discussion_r552395540", "bodyText": "add blank line here", "author": "kaijianding", "createdAt": "2021-01-06T06:36:02Z", "path": "processing/src/main/java/org/apache/druid/segment/IndexIO.java", "diffHunk": "@@ -182,16 +183,16 @@ public void validateTwoSegments(final IndexableAdapter adapter1, final Indexable\n \n   public QueryableIndex loadIndex(File inDir) throws IOException\n   {\n-    return loadIndex(inDir, false);\n+    return loadIndex(inDir, false, CommonCallback.NOOP);\n   }", "originalCommit": "7775658a57209265762bc41e30b90d7774a3e362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE3MzMwMQ==", "url": "https://github.com/apache/druid/pull/10688#discussion_r553173301", "bodyText": "done.", "author": "zhangyue19921010", "createdAt": "2021-01-07T08:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5NTU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5NzA1OQ==", "url": "https://github.com/apache/druid/pull/10688#discussion_r552397059", "bodyText": "why RuntimeException here?", "author": "kaijianding", "createdAt": "2021-01-06T06:41:04Z", "path": "processing/src/main/java/org/apache/druid/segment/IndexIO.java", "diffHunk": "@@ -644,7 +649,7 @@ public QueryableIndex load(File inDir, ObjectMapper mapper, boolean lazy) throws\n     }\n \n     private ColumnHolder deserializeColumn(ObjectMapper mapper, ByteBuffer byteBuffer, SmooshedFileMapper smooshedFiles)\n-        throws IOException\n+        throws IOException, RuntimeException", "originalCommit": "7775658a57209265762bc41e30b90d7774a3e362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE3MzU2MA==", "url": "https://github.com/apache/druid/pull/10688#discussion_r553173560", "bodyText": "No need actually. Remove now.", "author": "zhangyue19921010", "createdAt": "2021-01-07T08:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5NzA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQwNDA3Mw==", "url": "https://github.com/apache/druid/pull/10688#discussion_r552404073", "bodyText": "I guess this interface should be in org.apache.druid.segment, beside the IndexIO", "author": "kaijianding", "createdAt": "2021-01-06T07:05:14Z", "path": "core/src/main/java/org/apache/druid/coordination/CommonCallback.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.coordination;", "originalCommit": "7775658a57209265762bc41e30b90d7774a3e362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE3MzYyMw==", "url": "https://github.com/apache/druid/pull/10688#discussion_r553173623", "bodyText": "done.", "author": "zhangyue19921010", "createdAt": "2021-01-07T08:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQwNDA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQwNzY0Ng==", "url": "https://github.com/apache/druid/pull/10688#discussion_r552407646", "bodyText": "why not just use Runnable? There is even a Runnables.getNoopRunnable()", "author": "clintropolis", "createdAt": "2021-01-06T07:17:39Z", "path": "core/src/main/java/org/apache/druid/coordination/CommonCallback.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.coordination;\n+\n+public interface CommonCallback", "originalCommit": "7775658a57209265762bc41e30b90d7774a3e362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQwOTg5NQ==", "url": "https://github.com/apache/druid/pull/10688#discussion_r552409895", "bodyText": "I think a meaningful name is better for code readiness through the method arguments", "author": "kaijianding", "createdAt": "2021-01-06T07:24:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQwNzY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQxNDc2OQ==", "url": "https://github.com/apache/druid/pull/10688#discussion_r552414769", "bodyText": "I don't feel super strongly about this, while I find it pretty obvious what Runnable does and don't think a new interface adds much here, I can see your point as well.\nI would agree that if we insist on using a separate interface that it should have a better name more indicative of its function.", "author": "clintropolis", "createdAt": "2021-01-06T07:39:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQwNzY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE3NTA3OQ==", "url": "https://github.com/apache/druid/pull/10688#discussion_r553175079", "bodyText": "Change the name to SegmentLazyLoadFailCallback as you guys suggested. Thanks for review :)", "author": "zhangyue19921010", "createdAt": "2021-01-07T08:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQwNzY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQxMDc2Mw==", "url": "https://github.com/apache/druid/pull/10688#discussion_r552410763", "bodyText": "add a new @param in the method comment", "author": "kaijianding", "createdAt": "2021-01-06T07:26:52Z", "path": "server/src/main/java/org/apache/druid/server/SegmentManager.java", "diffHunk": "@@ -219,9 +220,9 @@ private TableDataSource getTableDataSource(DataSourceAnalysis analysis)\n    *\n    * @throws SegmentLoadingException if the segment cannot be loaded\n    */\n-  public boolean loadSegment(final DataSegment segment, boolean lazy) throws SegmentLoadingException\n+  public boolean loadSegment(final DataSegment segment, boolean lazy, CommonCallback loadFailed) throws SegmentLoadingException", "originalCommit": "7775658a57209265762bc41e30b90d7774a3e362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE3NTExNg==", "url": "https://github.com/apache/druid/pull/10688#discussion_r553175116", "bodyText": "done", "author": "zhangyue19921010", "createdAt": "2021-01-07T08:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQxMDc2Mw=="}], "type": "inlineReview"}, {"oid": "6b9595e5ebe3b67ae0795402a1c799a69d7a821f", "url": "https://github.com/apache/druid/commit/6b9595e5ebe3b67ae0795402a1c799a69d7a821f", "message": "code review", "committedDate": "2021-01-07T02:26:04Z", "type": "commit"}, {"oid": "ff6deb5a1c99f725902e0655efbdfbbdfc3b6c5e", "url": "https://github.com/apache/druid/commit/ff6deb5a1c99f725902e0655efbdfbbdfc3b6c5e", "message": "add UTs", "committedDate": "2021-01-07T03:40:41Z", "type": "commit"}, {"oid": "9fefdff30f57c621a9dead0ecb1b68b0453b7c69", "url": "https://github.com/apache/druid/commit/9fefdff30f57c621a9dead0ecb1b68b0453b7c69", "message": "add UTs", "committedDate": "2021-01-07T03:53:07Z", "type": "commit"}, {"oid": "13710d9d2eb46d57a8fb4ec920706303024bd33e", "url": "https://github.com/apache/druid/commit/13710d9d2eb46d57a8fb4ec920706303024bd33e", "message": "ut passed", "committedDate": "2021-01-07T06:36:39Z", "type": "commit"}, {"oid": "f67b334ad9a0a6d9e46855a4505e8c0fda6cf13b", "url": "https://github.com/apache/druid/commit/f67b334ad9a0a6d9e46855a4505e8c0fda6cf13b", "message": "ut passed", "committedDate": "2021-01-07T06:37:45Z", "type": "commit"}, {"oid": "7dd33e2571f913c7c1b4dcb8d36dbf4f2c209389", "url": "https://github.com/apache/druid/commit/7dd33e2571f913c7c1b4dcb8d36dbf4f2c209389", "message": "opti imports", "committedDate": "2021-01-07T07:04:35Z", "type": "commit"}, {"oid": "dd4fd45a0a1a24acec5e91696c97f99173b76321", "url": "https://github.com/apache/druid/commit/dd4fd45a0a1a24acec5e91696c97f99173b76321", "message": "Merge branch 'master' into historical-lazyOnStart-with-fileCheck", "committedDate": "2021-01-07T07:51:02Z", "type": "commit"}, {"oid": "eac89198e4079772fa56d100b18ba4b8aa964e93", "url": "https://github.com/apache/druid/commit/eac89198e4079772fa56d100b18ba4b8aa964e93", "message": "done", "committedDate": "2021-01-07T08:10:30Z", "type": "commit"}, {"oid": "e1eca76b4ae50733b9d922c4a94c356d18d51201", "url": "https://github.com/apache/druid/commit/e1eca76b4ae50733b9d922c4a94c356d18d51201", "message": "done", "committedDate": "2021-01-07T08:39:46Z", "type": "commit"}, {"oid": "3d567da3d1a493d63fac36705a371cb9742dc0da", "url": "https://github.com/apache/druid/commit/3d567da3d1a493d63fac36705a371cb9742dc0da", "message": "fix checkstyle", "committedDate": "2021-01-08T02:40:11Z", "type": "commit"}, {"oid": "34f98f024e7a0cc02f9e187e919d8b1886cffc38", "url": "https://github.com/apache/druid/commit/34f98f024e7a0cc02f9e187e919d8b1886cffc38", "message": "Merge branch 'master' into historical-lazyOnStart-with-fileCheck", "committedDate": "2021-01-08T03:01:33Z", "type": "commit"}, {"oid": "6b82e6c64ded714a0285afac83876e1d4827edaf", "url": "https://github.com/apache/druid/commit/6b82e6c64ded714a0285afac83876e1d4827edaf", "message": "modify uts", "committedDate": "2021-01-08T04:22:01Z", "type": "commit"}, {"oid": "c5737724fa8e9fb8e88a716d30ba610a62527169", "url": "https://github.com/apache/druid/commit/c5737724fa8e9fb8e88a716d30ba610a62527169", "message": "Merge branch 'master' into historical-lazyOnStart-with-fileCheck", "committedDate": "2021-01-09T00:29:08Z", "type": "commit"}, {"oid": "f113ed3e803b1bc8e110190b86bf7362a1844c69", "url": "https://github.com/apache/druid/commit/f113ed3e803b1bc8e110190b86bf7362a1844c69", "message": "modify logs", "committedDate": "2021-01-09T11:50:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ3ODU3NQ==", "url": "https://github.com/apache/druid/pull/10688#discussion_r555478575", "bodyText": "I suggest this interface should be in org.apache.druid.segment, beside the IndexIO", "author": "kaijianding", "createdAt": "2021-01-12T02:55:59Z", "path": "processing/src/main/java/org/apache/druid/segment/coordination/SegmentLazyLoadFailCallback.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.segment.coordination;", "originalCommit": "f113ed3e803b1bc8e110190b86bf7362a1844c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5bfca47513fad5274ec0c9578291622e1b8ed2c3", "url": "https://github.com/apache/druid/commit/5bfca47513fad5274ec0c9578291622e1b8ed2c3", "message": "changing the package of SegmentLazyLoadFailCallback.java to org.apache.druid.segment", "committedDate": "2021-01-12T03:27:19Z", "type": "commit"}, {"oid": "6284c5f26614810289331d74e41a625c955de8f8", "url": "https://github.com/apache/druid/commit/6284c5f26614810289331d74e41a625c955de8f8", "message": "Merge branch 'master' into historical-lazyOnStart-with-fileCheck", "committedDate": "2021-01-12T03:29:39Z", "type": "commit"}, {"oid": "c7d9115a568b8e98a407362cac1f6cca7644d1e8", "url": "https://github.com/apache/druid/commit/c7d9115a568b8e98a407362cac1f6cca7644d1e8", "message": "merge from master", "committedDate": "2021-01-12T03:48:28Z", "type": "commit"}, {"oid": "ba5dd23355f5aad070743702a5ad501c068a2e72", "url": "https://github.com/apache/druid/commit/ba5dd23355f5aad070743702a5ad501c068a2e72", "message": "modify import orders", "committedDate": "2021-01-12T08:54:34Z", "type": "commit"}, {"oid": "5c892323446b07a33284a983f86094e8f7902b32", "url": "https://github.com/apache/druid/commit/5c892323446b07a33284a983f86094e8f7902b32", "message": "merge from master", "committedDate": "2021-01-12T09:07:53Z", "type": "commit"}, {"oid": "7714f81bfcf21bf0c581a2b1135a9c27a0f82b07", "url": "https://github.com/apache/druid/commit/7714f81bfcf21bf0c581a2b1135a9c27a0f82b07", "message": "merge from master", "committedDate": "2021-01-12T09:17:31Z", "type": "commit"}, {"oid": "65f17df837e066379b2ef0f1d4c8465aecf35875", "url": "https://github.com/apache/druid/commit/65f17df837e066379b2ef0f1d4c8465aecf35875", "message": "modify logs", "committedDate": "2021-01-12T14:25:25Z", "type": "commit"}, {"oid": "dd46d753abd1d5417d55566b9d88aea62aa819de", "url": "https://github.com/apache/druid/commit/dd46d753abd1d5417d55566b9d88aea62aa819de", "message": "modify docs", "committedDate": "2021-01-12T16:30:26Z", "type": "commit"}, {"oid": "15a4c3e8770acb1a992114d7121de8f6f0b89ed8", "url": "https://github.com/apache/druid/commit/15a4c3e8770acb1a992114d7121de8f6f0b89ed8", "message": "modify logs to rerun ci", "committedDate": "2021-01-12T19:58:21Z", "type": "commit"}, {"oid": "80accce200c0c9bf555f644ee88eafd82225e983", "url": "https://github.com/apache/druid/commit/80accce200c0c9bf555f644ee88eafd82225e983", "message": "modify logs to rerun ci", "committedDate": "2021-01-12T21:23:57Z", "type": "commit"}, {"oid": "78f5ff3d836c8e66ee1c2b7313710a8eaf7e8290", "url": "https://github.com/apache/druid/commit/78f5ff3d836c8e66ee1c2b7313710a8eaf7e8290", "message": "modify logs to rerun ci", "committedDate": "2021-01-13T03:43:12Z", "type": "commit"}, {"oid": "9dec7bd5130d2c244c83ad8fbf15faafaa7357e3", "url": "https://github.com/apache/druid/commit/9dec7bd5130d2c244c83ad8fbf15faafaa7357e3", "message": "modify logs to rerun ci", "committedDate": "2021-01-13T10:33:23Z", "type": "commit"}, {"oid": "6bb59ce5a3ddacffc68cad659a12e5fc9735c599", "url": "https://github.com/apache/druid/commit/6bb59ce5a3ddacffc68cad659a12e5fc9735c599", "message": "modify logs to rerun ci", "committedDate": "2021-01-13T16:23:25Z", "type": "commit"}, {"oid": "b5aa6102aac6cb8d6399962c819bebe21666cf1d", "url": "https://github.com/apache/druid/commit/b5aa6102aac6cb8d6399962c819bebe21666cf1d", "message": "modify logs to rerun ci", "committedDate": "2021-01-13T23:48:39Z", "type": "commit"}, {"oid": "4fdbc257c1c8f59260fc71a749ee9f3c0e1e8d0f", "url": "https://github.com/apache/druid/commit/4fdbc257c1c8f59260fc71a749ee9f3c0e1e8d0f", "message": "Merge branch 'master' into historical-lazyOnStart-with-fileCheck", "committedDate": "2021-01-14T08:06:56Z", "type": "commit"}, {"oid": "a510bee83be87f85720d87c51ed82755d52b7d25", "url": "https://github.com/apache/druid/commit/a510bee83be87f85720d87c51ed82755d52b7d25", "message": "modify logs to rerun ci", "committedDate": "2021-01-14T23:56:01Z", "type": "commit"}, {"oid": "fef72a7ad29c1a0937b7cc45f8f706c7e546b62a", "url": "https://github.com/apache/druid/commit/fef72a7ad29c1a0937b7cc45f8f706c7e546b62a", "message": "modify logs to rerun ci", "committedDate": "2021-01-15T01:50:33Z", "type": "commit"}]}