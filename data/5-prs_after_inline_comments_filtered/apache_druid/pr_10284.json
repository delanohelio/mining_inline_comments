{"pr_number": 10284, "pr_title": "Add dynamic coordinator config that allows control over how many segments are considered when picking a segment to move.", "pr_createdAt": "2020-08-14T17:33:36Z", "pr_url": "https://github.com/apache/druid/pull/10284", "timeline": [{"oid": "614a96bb4ec9f52a2654e0ea39f769a759aedcb3", "url": "https://github.com/apache/druid/commit/614a96bb4ec9f52a2654e0ea39f769a759aedcb3", "message": "dynamic coord config adding more balancing control\n\nadd new dynamic coordinator config, maxSegmentsToConsiderPerMove. This\nconfig caps the number of segments that are iterated over when selecting\na segment to move. The default value combined with current balancing\nstrategies will still iterate over all provided segments. However,\nsetting this value to something > 0 will cap the number of segments\nvisited. This could make sense in cases where a cluster has a very large\nnumber of segments and the admins prefer less iterations vs a thorough\nconsideration of all segments provided.", "committedDate": "2020-08-14T17:32:24Z", "type": "commit"}, {"oid": "f7c53cd91368d070f4fe9a6d5c95dc1045db75dc", "url": "https://github.com/apache/druid/commit/f7c53cd91368d070f4fe9a6d5c95dc1045db75dc", "message": "fix checkstyle failure", "committedDate": "2020-08-14T23:02:22Z", "type": "commit"}, {"oid": "e1d47653b9ec74e97ed64a3ea57687d9ca9bc404", "url": "https://github.com/apache/druid/commit/e1d47653b9ec74e97ed64a3ea57687d9ca9bc404", "message": "Make doc more detailed for admin to understand when/why to use new config", "committedDate": "2020-09-02T20:35:40Z", "type": "commit"}, {"oid": "f525f0aba4266932578188d94c6b5cd7bd664611", "url": "https://github.com/apache/druid/commit/f525f0aba4266932578188d94c6b5cd7bd664611", "message": "Merge branch 'master' into bounded-segment-balancer", "committedDate": "2020-09-02T20:36:03Z", "type": "commit"}, {"oid": "0ff7c5aefd947ed20e289fc8e0309aa77628c943", "url": "https://github.com/apache/druid/commit/0ff7c5aefd947ed20e289fc8e0309aa77628c943", "message": "refactor PR to use a % of segments instead of raw number", "committedDate": "2020-09-03T14:41:40Z", "type": "commit"}, {"oid": "f3993e34b2464c83c17ff15f9a50a3132bc0fbd6", "url": "https://github.com/apache/druid/commit/f3993e34b2464c83c17ff15f9a50a3132bc0fbd6", "message": "update the docs", "committedDate": "2020-09-03T15:01:59Z", "type": "commit"}, {"oid": "3b042135fb261eced2ce09cc127ce568aa305e2b", "url": "https://github.com/apache/druid/commit/3b042135fb261eced2ce09cc127ce568aa305e2b", "message": "remove bad doc line", "committedDate": "2020-09-03T15:02:30Z", "type": "commit"}, {"oid": "d69897e47cea1e4671dc3b7780e93b9419b85244", "url": "https://github.com/apache/druid/commit/d69897e47cea1e4671dc3b7780e93b9419b85244", "message": "fix typo in name of new dynamic config", "committedDate": "2020-09-03T15:03:26Z", "type": "commit"}, {"oid": "213599aaedf106581959acb9c2143499fad95062", "url": "https://github.com/apache/druid/commit/213599aaedf106581959acb9c2143499fad95062", "message": "update RservoirSegmentSampler to gracefully deal with values > 100%", "committedDate": "2020-09-03T15:11:02Z", "type": "commit"}, {"oid": "8e5a1df98cd935979fc503222dc6e286fc431cf4", "url": "https://github.com/apache/druid/commit/8e5a1df98cd935979fc503222dc6e286fc431cf4", "message": "add handler for <= 0 in ReservoirSegmentSampler", "committedDate": "2020-09-03T18:16:49Z", "type": "commit"}, {"oid": "b3f680dfc1dcf0418b6c8cc8d910e2211779f10e", "url": "https://github.com/apache/druid/commit/b3f680dfc1dcf0418b6c8cc8d910e2211779f10e", "message": "fixup CoordinatorDynamicConfigTest naming and argument ordering", "committedDate": "2020-09-03T18:17:05Z", "type": "commit"}, {"oid": "a8a7c4277f4a1654a319bdf2f9668578cb260f05", "url": "https://github.com/apache/druid/commit/a8a7c4277f4a1654a319bdf2f9668578cb260f05", "message": "fix items in docs after spellcheck flags", "committedDate": "2020-09-08T17:18:13Z", "type": "commit"}, {"oid": "fb20cb2cad1efee921acbe44091255d8487b3b4c", "url": "https://github.com/apache/druid/commit/fb20cb2cad1efee921acbe44091255d8487b3b4c", "message": "Fix lgtm flag on missing space in string literal", "committedDate": "2020-09-08T21:04:32Z", "type": "commit"}, {"oid": "fd221c8ad96c05bbec2841aba0c46f29d0aba535", "url": "https://github.com/apache/druid/commit/fd221c8ad96c05bbec2841aba0c46f29d0aba535", "message": "Merge branch 'master' into bounded-segment-balancer", "committedDate": "2020-10-29T13:49:30Z", "type": "commit"}, {"oid": "85660be45588b0ac53dc3534faa2fc1937188ed6", "url": "https://github.com/apache/druid/commit/85660be45588b0ac53dc3534faa2fc1937188ed6", "message": "improve documentation for new config", "committedDate": "2020-10-29T14:00:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5OTc2Nw==", "url": "https://github.com/apache/druid/pull/10284#discussion_r515299767", "bodyText": "Thanks for the doc \ud83d\udc4d", "author": "a2l007", "createdAt": "2020-10-30T18:27:43Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/ReservoirSegmentSampler.java", "diffHunk": "@@ -28,15 +29,50 @@\n final class ReservoirSegmentSampler\n {\n \n+  private static final EmittingLogger log = new EmittingLogger(ReservoirSegmentSampler.class);\n+\n+  /**\n+   * Iterates over segments that live on the candidate servers passed in {@link ServerHolder} and (possibly) picks a\n+   * segment to return to caller in a {@link BalancerSegmentHolder} object.\n+   *\n+   * @param serverHolders List of {@link ServerHolder} objects containing segments who are candidates to be chosen.\n+   * @param broadcastDatasources Set of DataSource names that identify broadcast datasources. We don't want to consider\n+   *                             segments from these datasources.\n+   * @param percentOfSegmentsToConsider The % of total cluster segments to consider before short-circuiting and\n+   *                                   returning immediately.\n+   * @return\n+   */", "originalCommit": "85660be45588b0ac53dc3534faa2fc1937188ed6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f899ade562426c903aa92cb4f0e1a8f8a7a6a23d", "url": "https://github.com/apache/druid/commit/f899ade562426c903aa92cb4f0e1a8f8a7a6a23d", "message": "Add default value to config docs and add advice in cluster tuning doc", "committedDate": "2020-10-30T20:53:05Z", "type": "commit"}, {"oid": "848ac007d557347b039bd1611e1c30cb215661ea", "url": "https://github.com/apache/druid/commit/848ac007d557347b039bd1611e1c30cb215661ea", "message": "Add percentOfSegmentsToConsiderPerMove to web console coord config dialog", "committedDate": "2020-10-30T21:59:01Z", "type": "commit"}, {"oid": "982b0167153fecb8b9e0701af9a7cb5f9c8c4af5", "url": "https://github.com/apache/druid/commit/982b0167153fecb8b9e0701af9a7cb5f9c8c4af5", "message": "update jest snapshot after console change", "committedDate": "2020-11-03T16:06:14Z", "type": "commit"}, {"oid": "cce72eb3fc67e1980ef45f2598068cee7f7e5b38", "url": "https://github.com/apache/druid/commit/cce72eb3fc67e1980ef45f2598068cee7f7e5b38", "message": "fix spell checker errors", "committedDate": "2020-11-03T16:07:56Z", "type": "commit"}, {"oid": "1c8e9da06a6455bd461e16556c95e0b5cd6e3ee1", "url": "https://github.com/apache/druid/commit/1c8e9da06a6455bd461e16556c95e0b5cd6e3ee1", "message": "Improve debug logging in getRandomSegmentBalancerHolder to cover all bad inputs for % of segments to consider", "committedDate": "2020-11-03T18:15:03Z", "type": "commit"}, {"oid": "48f0a928bee7addd8eea36236230d4254bb62bba", "url": "https://github.com/apache/druid/commit/48f0a928bee7addd8eea36236230d4254bb62bba", "message": "Merge branch 'master' into bounded-segment-balancer", "committedDate": "2020-12-18T23:04:25Z", "type": "commit"}, {"oid": "bf5907491dc33809c150f1c26140f3dae951dfd5", "url": "https://github.com/apache/druid/commit/bf5907491dc33809c150f1c26140f3dae951dfd5", "message": "add new config back to web console module after merge with master", "committedDate": "2020-12-18T23:19:09Z", "type": "commit"}, {"oid": "dc3f80af30d215ef231b19e183494c9aff562348", "url": "https://github.com/apache/druid/commit/dc3f80af30d215ef231b19e183494c9aff562348", "message": "fix ReservoirSegmentSamplerTest", "committedDate": "2020-12-18T23:19:21Z", "type": "commit"}, {"oid": "9ac54ffddbd6ada5f4c4dda4677cde3f1a383673", "url": "https://github.com/apache/druid/commit/9ac54ffddbd6ada5f4c4dda4677cde3f1a383673", "message": "fix line breaks in coordinator console dialog", "committedDate": "2020-12-18T23:30:43Z", "type": "commit"}, {"oid": "9197bb0b1738be30f79016dab9837002a8056152", "url": "https://github.com/apache/druid/commit/9197bb0b1738be30f79016dab9837002a8056152", "message": "Add a test that helps ensure not regressions for percentOfSegmentsToConsiderPerMove", "committedDate": "2020-12-19T00:42:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTA0MQ==", "url": "https://github.com/apache/druid/pull/10284#discussion_r546171041", "bodyText": "Since this is a json configured property, I think we should throw an exception here so the user knows they've done something incorrect.\nEDIT: Something like\nPreconditions.checkArgument(percentOfSegmentsToConsiderPerMove > 0 && percentOfSegmentsToConsiderPerMove <= 100, \"percentOfSegmentsToConsiderPerMove should be between 0 and 100!\");", "author": "suneet-s", "createdAt": "2020-12-19T01:31:29Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/CoordinatorDynamicConfig.java", "diffHunk": "@@ -123,6 +125,12 @@ public CoordinatorDynamicConfig(\n     this.mergeBytesLimit = mergeBytesLimit;\n     this.mergeSegmentsLimit = mergeSegmentsLimit;\n     this.maxSegmentsToMove = maxSegmentsToMove;\n+    // This helps with ease of migration to the new config, but could confuse users. Docs explicitly state this value must be > 0\n+    if (percentOfSegmentsToConsiderPerMove <= 0 || percentOfSegmentsToConsiderPerMove > 100) {\n+      this.percentOfSegmentsToConsiderPerMove = 100;", "originalCommit": "9197bb0b1738be30f79016dab9837002a8056152", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4NzAwNQ==", "url": "https://github.com/apache/druid/pull/10284#discussion_r546187005", "bodyText": "I agree, it's confusing to mask an error like I was. fixed", "author": "capistrant", "createdAt": "2020-12-19T04:01:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTE4Mw==", "url": "https://github.com/apache/druid/pull/10284#discussion_r546171183", "bodyText": "Should this be a double since we're dealing with percentages? I think it would make it less likely for someone in the future to make some math mistake by accidentally dividing by an integer.", "author": "suneet-s", "createdAt": "2020-12-19T01:32:32Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/CoordinatorDynamicConfig.java", "diffHunk": "@@ -95,6 +96,7 @@ public CoordinatorDynamicConfig(\n       @JsonProperty(\"mergeBytesLimit\") long mergeBytesLimit,\n       @JsonProperty(\"mergeSegmentsLimit\") int mergeSegmentsLimit,\n       @JsonProperty(\"maxSegmentsToMove\") int maxSegmentsToMove,\n+      @JsonProperty(\"percentOfSegmentsToConsiderPerMove\") int percentOfSegmentsToConsiderPerMove,", "originalCommit": "9197bb0b1738be30f79016dab9837002a8056152", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4NzA2OQ==", "url": "https://github.com/apache/druid/pull/10284#discussion_r546187069", "bodyText": "ya, this is a good point. using double up front makes things a lot more straightforward", "author": "capistrant", "createdAt": "2020-12-19T04:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTQwNQ==", "url": "https://github.com/apache/druid/pull/10284#discussion_r546171405", "bodyText": "Should this have a PreCondition check that it falls between 0 - 100 ?", "author": "suneet-s", "createdAt": "2020-12-19T01:34:07Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/CoordinatorDynamicConfig.java", "diffHunk": "@@ -463,6 +485,7 @@ public Builder(\n       this.mergeBytesLimit = mergeBytesLimit;\n       this.mergeSegmentsLimit = mergeSegmentsLimit;\n       this.maxSegmentsToMove = maxSegmentsToMove;\n+      this.percentOfSegmentsToConsiderPerMove = percentOfSegmentsToConsiderPerMove;", "originalCommit": "9197bb0b1738be30f79016dab9837002a8056152", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgwNTYxOQ==", "url": "https://github.com/apache/druid/pull/10284#discussion_r546805619", "bodyText": "hmm, Since this is a Builder class that builds a CoordinatorDynamicConfig object, I think this precondition is covered by the actual constructor for the CoordinatorDynamicConfig class. IMO, having another precondition here is redundant", "author": "capistrant", "createdAt": "2020-12-21T16:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgwODgyMg==", "url": "https://github.com/apache/druid/pull/10284#discussion_r546808822", "bodyText": "makes sense to me", "author": "suneet-s", "createdAt": "2020-12-21T16:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTU2Ng==", "url": "https://github.com/apache/druid/pull/10284#discussion_r546171566", "bodyText": "IMO this should be at least a WARN since it should be impossible that percentOfSegmentsToConsider should have already been checked earlier in the system", "author": "suneet-s", "createdAt": "2020-12-19T01:35:12Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/ReservoirSegmentSampler.java", "diffHunk": "@@ -28,15 +29,51 @@\n final class ReservoirSegmentSampler\n {\n \n+  private static final EmittingLogger log = new EmittingLogger(ReservoirSegmentSampler.class);\n+\n+  /**\n+   * Iterates over segments that live on the candidate servers passed in {@link ServerHolder} and (possibly) picks a\n+   * segment to return to caller in a {@link BalancerSegmentHolder} object.\n+   *\n+   * @param serverHolders List of {@link ServerHolder} objects containing segments who are candidates to be chosen.\n+   * @param broadcastDatasources Set of DataSource names that identify broadcast datasources. We don't want to consider\n+   *                             segments from these datasources.\n+   * @param percentOfSegmentsToConsider The % of total cluster segments to consider before short-circuiting and\n+   *                                   returning immediately.\n+   * @return\n+   */\n   static BalancerSegmentHolder getRandomBalancerSegmentHolder(\n       final List<ServerHolder> serverHolders,\n-      Set<String> broadcastDatasources\n+      Set<String> broadcastDatasources,\n+      int percentOfSegmentsToConsider\n   )\n   {\n     ServerHolder fromServerHolder = null;\n     DataSegment proposalSegment = null;\n+    int calculatedSegmentLimit = Integer.MAX_VALUE;\n     int numSoFar = 0;\n \n+    // Reset a bad value of percentOfSegmentsToConsider to 100. We don't allow consideration less than or equal to\n+    // 0% of segments or greater than 100% of segments.\n+    if (percentOfSegmentsToConsider <= 0 || percentOfSegmentsToConsider > 100) {\n+      log.debug(\"Resetting percentOfSegmentsToConsider to 100 because only values from 1 to 100 are allowed.\"", "originalCommit": "9197bb0b1738be30f79016dab9837002a8056152", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4NzA5MA==", "url": "https://github.com/apache/druid/pull/10284#discussion_r546187090", "bodyText": "I'm cool with this being warn", "author": "capistrant", "createdAt": "2020-12-19T04:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTU2Ng=="}], "type": "inlineReview"}, {"oid": "6f24d44757ea227aae61f6fd0ea7c7fb1d54ae4f", "url": "https://github.com/apache/druid/commit/6f24d44757ea227aae61f6fd0ea7c7fb1d54ae4f", "message": "Make improvements based off of feedback in review", "committedDate": "2020-12-19T04:01:24Z", "type": "commit"}, {"oid": "62962e0bcfe0afb57440f9ed1317db566066a3fa", "url": "https://github.com/apache/druid/commit/62962e0bcfe0afb57440f9ed1317db566066a3fa", "message": "additional cleanup coming from review", "committedDate": "2020-12-19T04:06:56Z", "type": "commit"}, {"oid": "93bed105b71da265866bbf5bbc6dd41d5fa5218f", "url": "https://github.com/apache/druid/commit/93bed105b71da265866bbf5bbc6dd41d5fa5218f", "message": "Add a warning log if limit on segments to consider for move can't be calcluated", "committedDate": "2020-12-21T16:14:36Z", "type": "commit"}, {"oid": "d76c92487e4e70c75633ab0ead3670e6152af3cb", "url": "https://github.com/apache/druid/commit/d76c92487e4e70c75633ab0ead3670e6152af3cb", "message": "remove unused import", "committedDate": "2020-12-21T16:24:53Z", "type": "commit"}, {"oid": "e30ddf3e9247968a4dc468a1a18f7e3b2a453000", "url": "https://github.com/apache/druid/commit/e30ddf3e9247968a4dc468a1a18f7e3b2a453000", "message": "fix tests for CoordinatorDynamicConfig", "committedDate": "2020-12-21T16:31:39Z", "type": "commit"}, {"oid": "43766ed659a84e547fb0f25dc4a82ea5692b6788", "url": "https://github.com/apache/druid/commit/43766ed659a84e547fb0f25dc4a82ea5692b6788", "message": "remove precondition test that is redundant in CoordinatorDynamicConfig Builder class", "committedDate": "2020-12-21T16:31:53Z", "type": "commit"}]}