{"pr_number": 9731, "pr_title": "ColumnCapabilities.hasMultipleValues refactor", "pr_createdAt": "2020-04-21T07:44:53Z", "pr_url": "https://github.com/apache/druid/pull/9731", "timeline": [{"oid": "eec2767fbacdb004c7c0c3849cf3df301d83747b", "url": "https://github.com/apache/druid/commit/eec2767fbacdb004c7c0c3849cf3df301d83747b", "message": "transition ColumnCapabilities.hasMultipleValues to Capable enum, remove ColumnCapabilities.isComplete", "committedDate": "2020-04-21T07:32:50Z", "type": "commit"}, {"oid": "11a97132281d6bffa446a3ff0f08d7d0bfc6ccd5", "url": "https://github.com/apache/druid/commit/11a97132281d6bffa446a3ff0f08d7d0bfc6ccd5", "message": "Merge remote-tracking branch 'upstream/master' into column-capabilities-remove-is-complete", "committedDate": "2020-04-30T00:39:46Z", "type": "commit"}, {"oid": "825bca7a3514caab1c1e4b9661622fa9ac3ea1cd", "url": "https://github.com/apache/druid/commit/825bca7a3514caab1c1e4b9661622fa9ac3ea1cd", "message": "remove artifical, always multi-value capabilities from IncrementalIndexStorageAdapter and fix up fallout from that, fix ColumnCapabilities merge in index merger", "committedDate": "2020-04-30T18:57:20Z", "type": "commit"}, {"oid": "223b3e8a23af04b261186bd5db19402aff3bbed4", "url": "https://github.com/apache/druid/commit/223b3e8a23af04b261186bd5db19402aff3bbed4", "message": "fix typo", "committedDate": "2020-04-30T20:08:32Z", "type": "commit"}, {"oid": "8660879fc86b76c3a23cedec0287487f74357c19", "url": "https://github.com/apache/druid/commit/8660879fc86b76c3a23cedec0287487f74357c19", "message": "remove unused method", "committedDate": "2020-04-30T21:20:21Z", "type": "commit"}, {"oid": "fa4d9dea1252a15878f5d91428d994f2a0a9d4cb", "url": "https://github.com/apache/druid/commit/fa4d9dea1252a15878f5d91428d994f2a0a9d4cb", "message": "Merge remote-tracking branch 'upstream/master' into column-capabilities-remove-is-complete", "committedDate": "2020-04-30T23:09:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxODk1Ng==", "url": "https://github.com/apache/druid/pull/9731#discussion_r420318956", "bodyText": "This javadoc doesn't make a ton of sense to me. Specifically it's not clear to me what \"known dimension is absent in a row\" means or what \"account for any missing rows\" might refer to. I wonder if you could find an improved wording.\nIMO it'd be better to not have this method be default. It makes it too easy to forget to override it when necessary.", "author": "gianm", "createdAt": "2020-05-05T18:28:03Z", "path": "processing/src/main/java/org/apache/druid/segment/DimensionIndexer.java", "diffHunk": "@@ -127,6 +127,19 @@\n    */\n   EncodedKeyComponentType processRowValsToUnsortedEncodedKeyComponent(@Nullable Object dimValues, boolean reportParseExceptions);\n \n+  /**\n+   * This method will be called whenever a known dimension is absent in a row to allow an indexer", "originalCommit": "fa4d9dea1252a15878f5d91428d994f2a0a9d4cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2OTY0Nw==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435569647", "bodyText": "I modified the javadocs, hopefully they are a bit clearer, and removed the default implementation", "author": "clintropolis", "createdAt": "2020-06-04T21:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxODk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMzMzI2Ng==", "url": "https://github.com/apache/druid/pull/9731#discussion_r420333266", "bodyText": "The boolean here is tough for me to wrap my head around: when looking at method calls like .complete(true) and .complete(false), it looks like it's describing whether or not things are complete. I think it would be better to use a two-valued enum, so the call would be .makeComplete(UNKNOWN_TO_FALSE) or .makeComplete(UNKNOWN_TO_TRUE).", "author": "gianm", "createdAt": "2020-05-05T18:52:02Z", "path": "processing/src/main/java/org/apache/druid/segment/column/ColumnCapabilities.java", "diffHunk": "@@ -57,6 +50,21 @@ public boolean isTrue()\n       return this == TRUE;\n     }\n \n+    public boolean isMaybeTrue()\n+    {\n+      return isTrue() || isUnknown();\n+    }\n+\n+    public boolean isUnknown()\n+    {\n+      return this == UNKNOWN;\n+    }\n+\n+    public Capable complete(boolean convertUnknownToTrue)", "originalCommit": "fa4d9dea1252a15878f5d91428d994f2a0a9d4cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY4ODg3Mg==", "url": "https://github.com/apache/druid/pull/9731#discussion_r430688872", "bodyText": "I don't think it needs another enum, if anything it could just accept a Capable to use for the default value, though I should enforce that it cannot be unknown. If i rename to coerceIfUnknown or something maybe it would also be more obvious what the purpose is.", "author": "clintropolis", "createdAt": "2020-05-26T20:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMzMzI2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMzNjIzMg==", "url": "https://github.com/apache/druid/pull/9731#discussion_r420336232", "bodyText": "createSimpleNumericCapabilities?", "author": "gianm", "createdAt": "2020-05-05T18:57:26Z", "path": "processing/src/main/java/org/apache/druid/segment/column/ColumnCapabilitiesImpl.java", "diffHunk": "@@ -31,23 +31,66 @@\n  */\n public class ColumnCapabilitiesImpl implements ColumnCapabilities\n {\n-  public static ColumnCapabilitiesImpl copyOf(final ColumnCapabilities other)\n+  public static ColumnCapabilitiesImpl copyOf(@Nullable final ColumnCapabilities other)\n   {\n     final ColumnCapabilitiesImpl capabilities = new ColumnCapabilitiesImpl();\n-    capabilities.merge(other);\n-    capabilities.setFilterable(other.isFilterable());\n-    capabilities.setIsComplete(other.isComplete());\n+    if (other != null) {\n+      capabilities.type = other.getType();\n+      capabilities.dictionaryEncoded = other.isDictionaryEncoded();\n+      capabilities.runLengthEncoded = other.isRunLengthEncoded();\n+      capabilities.hasInvertedIndexes = other.hasBitmapIndexes();\n+      capabilities.hasSpatialIndexes = other.hasSpatialIndexes();\n+      capabilities.hasMultipleValues = other.hasMultipleValues();\n+      capabilities.dictionaryValuesSorted = other.areDictionaryValuesSorted();\n+      capabilities.dictionaryValuesUnique = other.areDictionaryValuesUnique();\n+      capabilities.filterable = other.isFilterable();\n+    }\n     return capabilities;\n   }\n \n+  /**\n+   * Used at indexing time to finalize all {@link ColumnCapabilities.Capable#UNKNOWN} values to\n+   * {@link ColumnCapabilities.Capable#FALSE}, in order to present a snapshot of the state of the this column\n+   */\n+  @Nullable\n+  public static ColumnCapabilitiesImpl complete(\n+      @Nullable final ColumnCapabilities capabilities,\n+      boolean convertUnknownToTrue\n+  )\n+  {\n+    if (capabilities == null) {\n+      return null;\n+    }\n+    ColumnCapabilitiesImpl copy = copyOf(capabilities);\n+    copy.hasMultipleValues = copy.hasMultipleValues.complete(convertUnknownToTrue);\n+    copy.dictionaryValuesSorted = copy.dictionaryValuesSorted.complete(convertUnknownToTrue);\n+    copy.dictionaryValuesUnique = copy.dictionaryValuesUnique.complete(convertUnknownToTrue);\n+    return copy;\n+  }\n+\n+\n+  /**\n+   * Create a no frills, simple column with {@link ValueType} set and everything else false\n+   */\n+  public static ColumnCapabilitiesImpl createSimpleNumericColumn(ValueType valueType)", "originalCommit": "fa4d9dea1252a15878f5d91428d994f2a0a9d4cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MDM1MQ==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435570351", "bodyText": "renamed, except to createSimpleNumericColumnCapabilities because i wasn't paying enough attention to the suggestion i guess, but also ok i think \ud83e\udd37", "author": "clintropolis", "createdAt": "2020-06-04T21:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMzNjIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM2MTk2OA==", "url": "https://github.com/apache/druid/pull/9731#discussion_r420361968", "bodyText": "Nice.", "author": "gianm", "createdAt": "2020-05-05T19:43:50Z", "path": "processing/src/main/java/org/apache/druid/segment/ColumnProcessors.java", "diffHunk": "@@ -197,6 +197,6 @@\n    */\n   private static boolean mayBeMultiValue(@Nullable final ColumnCapabilities capabilities)\n   {\n-    return capabilities == null || !capabilities.isComplete() || capabilities.hasMultipleValues();\n+    return capabilities == null || capabilities.hasMultipleValues().isMaybeTrue();", "originalCommit": "fa4d9dea1252a15878f5d91428d994f2a0a9d4cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM2MjUzOA==", "url": "https://github.com/apache/druid/pull/9731#discussion_r420362538", "bodyText": "IMO, better if this returns a Capable. Then the caller can decide what to do with unknowns.", "author": "gianm", "createdAt": "2020-05-05T19:44:45Z", "path": "processing/src/main/java/org/apache/druid/segment/ColumnSelectorBitmapIndexSelector.java", "diffHunk": "@@ -160,11 +160,11 @@ public void close() throws IOException\n   public boolean hasMultipleValues(final String dimension)", "originalCommit": "fa4d9dea1252a15878f5d91428d994f2a0a9d4cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI1NTMzNQ==", "url": "https://github.com/apache/druid/pull/9731#discussion_r428255335", "bodyText": "This appears to only be used in ExpressionFilter currently, which is one of the few things that has to deal with unknowns, but if we want to do this maybe we should pull the definition of Capable outside of the ColumnCapabilities class to be standalone.", "author": "clintropolis", "createdAt": "2020-05-20T19:24:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM2MjUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3NTA0Mw==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435575043", "bodyText": "IMO, it's ok to return a Capable without it being a standalone class. Like, calling it ColumnCapabilities.Capable isn't that weird and is ok I think.\nAnother alternative is to clarify the behavior of the function through javadocs and, perhaps, changing its name to be more explicit about what it does.", "author": "gianm", "createdAt": "2020-06-04T21:56:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM2MjUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYwNjExOQ==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435606119", "bodyText": "Modified to return ColumnCapabilities.Capable", "author": "clintropolis", "createdAt": "2020-06-04T23:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM2MjUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0NDQ4Mg==", "url": "https://github.com/apache/druid/pull/9731#discussion_r420444482", "bodyText": "Why this change?\nAs I understand it, the previous behavior is roughly equivalent to returning unknown for HMV. (Because it would return false, but complete is also false.)", "author": "gianm", "createdAt": "2020-05-05T22:29:20Z", "path": "processing/src/main/java/org/apache/druid/segment/DimensionHandlerUtils.java", "diffHunk": "@@ -60,7 +60,8 @@\n                                   .setDictionaryEncoded(false)\n                                   .setDictionaryValuesUnique(false)\n                                   .setDictionaryValuesSorted(false)\n-                                  .setHasBitmapIndexes(false);\n+                                  .setHasBitmapIndexes(false)\n+                                  .setHasMultipleValues(false);", "originalCommit": "fa4d9dea1252a15878f5d91428d994f2a0a9d4cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUyODgwNw==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435528807", "bodyText": "The issue with this is that it is used when column capabilities don't exist by getEffectiveCapabilities, and makeVectorProcessor was not in fact checking if it was complete, so the other change in this file to check isMaybeTrue causes a ton of test failures because it now it tries to make multi-value dimension processors/selectors for these columns. We could leave it as unknown, but change makeVectorProcessor to isTrue, but that doesn't seem correct either. Ideally, we remove these default capabilities entirely, but we aren't quite there yet I think.", "author": "clintropolis", "createdAt": "2020-06-04T20:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0NDQ4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2Njk3MA==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435566970", "bodyText": "Since null capabilities for vector selectors means unambiguously that the column doesn't exist, I changed this back to leaving multi-value as unknown in favor of checking for this condition in makeVectorProcessor, which I think is the best thing to do for now", "author": "clintropolis", "createdAt": "2020-06-04T21:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0NDQ4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU4NzkzNg==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435587936", "bodyText": "OK, that makes sense.", "author": "gianm", "createdAt": "2020-06-04T22:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0NDQ4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MjQ1MA==", "url": "https://github.com/apache/druid/pull/9731#discussion_r420492450", "bodyText": "Is this ever called with convertUnknownToTrue == true? If not, it could be named better.", "author": "gianm", "createdAt": "2020-05-06T00:58:49Z", "path": "processing/src/main/java/org/apache/druid/segment/column/ColumnCapabilitiesImpl.java", "diffHunk": "@@ -31,23 +31,66 @@\n  */\n public class ColumnCapabilitiesImpl implements ColumnCapabilities\n {\n-  public static ColumnCapabilitiesImpl copyOf(final ColumnCapabilities other)\n+  public static ColumnCapabilitiesImpl copyOf(@Nullable final ColumnCapabilities other)\n   {\n     final ColumnCapabilitiesImpl capabilities = new ColumnCapabilitiesImpl();\n-    capabilities.merge(other);\n-    capabilities.setFilterable(other.isFilterable());\n-    capabilities.setIsComplete(other.isComplete());\n+    if (other != null) {\n+      capabilities.type = other.getType();\n+      capabilities.dictionaryEncoded = other.isDictionaryEncoded();\n+      capabilities.runLengthEncoded = other.isRunLengthEncoded();\n+      capabilities.hasInvertedIndexes = other.hasBitmapIndexes();\n+      capabilities.hasSpatialIndexes = other.hasSpatialIndexes();\n+      capabilities.hasMultipleValues = other.hasMultipleValues();\n+      capabilities.dictionaryValuesSorted = other.areDictionaryValuesSorted();\n+      capabilities.dictionaryValuesUnique = other.areDictionaryValuesUnique();\n+      capabilities.filterable = other.isFilterable();\n+    }\n     return capabilities;\n   }\n \n+  /**\n+   * Used at indexing time to finalize all {@link ColumnCapabilities.Capable#UNKNOWN} values to", "originalCommit": "fa4d9dea1252a15878f5d91428d994f2a0a9d4cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2ODc2Nw==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435568767", "bodyText": "It wasn't when you left this comment, but is now, I renamed the method to snapshot and the Capable enum method to coerceUnknownToBoolean to better relay it's usage", "author": "clintropolis", "createdAt": "2020-06-04T21:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MjQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MjYxOQ==", "url": "https://github.com/apache/druid/pull/9731#discussion_r420492619", "bodyText": "Why false here instead of true?\nMy understanding is that the HMV capability in the IncrementalIndex is now either going to be UNKNOWN (where it starts) or TRUE (if there are actually MVs). So UNKNOWN means we haven't seen any MV inputs yet.\nBut for the reason mentioned in the comment you deleted (the behavior of StringDimensionIndexer.IndexerDimensionSelector's getRow method), can't we get empty arrays from dimension selectors when querying IncrementalIndexes, even if the capability is UNKNOWN? So shouldn't we treat an unknown here as true rather than false?\nI must be missing something, since the tests are passing, assuming we have tests for this\u2026", "author": "gianm", "createdAt": "2020-05-06T00:59:26Z", "path": "processing/src/main/java/org/apache/druid/segment/incremental/IncrementalIndexStorageAdapter.java", "diffHunk": "@@ -142,24 +141,8 @@ public Comparable getMaxValue(String column)\n   @Override\n   public ColumnCapabilities getColumnCapabilities(String column)\n   {\n-    // Different from index.getCapabilities because, in a way, IncrementalIndex's string-typed dimensions\n-    // are always potentially multi-valued at query time. (Missing / null values for a row can potentially be\n-    // represented by an empty array; see StringDimensionIndexer.IndexerDimensionSelector's getRow method.)\n-    //\n-    // We don't want to represent this as having-multiple-values in index.getCapabilities, because that's used\n-    // at index-persisting time to determine if we need a multi-value column or not. However, that means we\n-    // need to tweak the capabilities here in the StorageAdapter (a query-time construct), so at query time\n-    // they appear multi-valued.\n-\n-    final ColumnCapabilities capabilitiesFromIndex = index.getCapabilities(column);\n-    final IncrementalIndex.DimensionDesc dimensionDesc = index.getDimension(column);\n-    if (dimensionDesc != null && dimensionDesc.getCapabilities().getType() == ValueType.STRING) {\n-      final ColumnCapabilitiesImpl retVal = ColumnCapabilitiesImpl.copyOf(capabilitiesFromIndex);\n-      retVal.setHasMultipleValues(true);\n-      return retVal;\n-    } else {\n-      return capabilitiesFromIndex;\n-    }\n+    // snapshot the current state\n+    return ColumnCapabilitiesImpl.complete(index.getCapabilities(column), false);", "originalCommit": "fa4d9dea1252a15878f5d91428d994f2a0a9d4cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI1NDg5NQ==", "url": "https://github.com/apache/druid/pull/9731#discussion_r428254895", "bodyText": "StringDimensionIndexer.IndexerDimensionSelector will not have hasMultipleValues set until it processes a multi-value row, is there a potential race between the time we look at capabilities that it doesn't yet have a multi-value row, but at execution time the row has appeared and so it will be set and will return an empty array instead of an array with a null?", "author": "clintropolis", "createdAt": "2020-05-20T19:23:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0MDU3MA==", "url": "https://github.com/apache/druid/pull/9731#discussion_r428840570", "bodyText": "Yes, that's what I was thinking: HMV could be set at any time, including between cap-fetch and selector-creation.\nBy the way, it looks like StringDimensionIndexer's handling of hasMultipleValues is not thread-safe (it's updated by the indexing thread and read by querying threads without locking). It'd be good to fix that too.", "author": "gianm", "createdAt": "2020-05-21T18:39:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY5MzAxMQ==", "url": "https://github.com/apache/druid/pull/9731#discussion_r430693011", "bodyText": "Ok, given the race condition I guess I have to revert this behavior so queries use the fake capabilities and to fix the bug for segment metadata based schema discovery to plumb special the actual capabilities to segment metadata queries. Maybe longer term it would be better if we could snapshot the capabilities at the time we query and make a cursor to only read the rows that were available at the time the capabilities were fetched and give those to the string indexer so that we can have more performant queries on incremental indexes at the cost of missing a few rows.", "author": "clintropolis", "createdAt": "2020-05-26T20:35:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MjYxOQ=="}], "type": "inlineReview"}, {"oid": "77624c7a3dedd9bbf99b11c3e7ae571e6ba2cd9a", "url": "https://github.com/apache/druid/commit/77624c7a3dedd9bbf99b11c3e7ae571e6ba2cd9a", "message": "Merge remote-tracking branch 'upstream/master' into column-capabilities-remove-is-complete", "committedDate": "2020-05-19T01:43:35Z", "type": "commit"}, {"oid": "20effb45b9ee7a86ba9877e634404119dc35b4ae", "url": "https://github.com/apache/druid/commit/20effb45b9ee7a86ba9877e634404119dc35b4ae", "message": "review stuffs, revert IncrementalIndexStorageAdapater capabilities change, plumb lame workaround to SegmentAnalyzer", "committedDate": "2020-05-26T23:07:41Z", "type": "commit"}, {"oid": "382c9ded5f9b53fb899f2660a2a638a1d3b0ed22", "url": "https://github.com/apache/druid/commit/382c9ded5f9b53fb899f2660a2a638a1d3b0ed22", "message": "more comment", "committedDate": "2020-05-26T23:19:02Z", "type": "commit"}, {"oid": "b583134171df6dd7b401bbf8d1b1b37dbe43bf66", "url": "https://github.com/apache/druid/commit/b583134171df6dd7b401bbf8d1b1b37dbe43bf66", "message": "use volatile booleans", "committedDate": "2020-05-26T23:43:38Z", "type": "commit"}, {"oid": "a11d95afbf749976dfe2c163e976e81c04fba1d9", "url": "https://github.com/apache/druid/commit/a11d95afbf749976dfe2c163e976e81c04fba1d9", "message": "fix line length", "committedDate": "2020-05-26T23:45:55Z", "type": "commit"}, {"oid": "09ae50e2c1dda614244eb8e0adbd14343b26ae86", "url": "https://github.com/apache/druid/commit/09ae50e2c1dda614244eb8e0adbd14343b26ae86", "message": "Merge remote-tracking branch 'upstream/master' into column-capabilities-remove-is-complete", "committedDate": "2020-06-04T20:18:38Z", "type": "commit"}, {"oid": "f639c2c860e57827ed85740fd242036c73e4dd43", "url": "https://github.com/apache/druid/commit/f639c2c860e57827ed85740fd242036c73e4dd43", "message": "correctly handle missing columns for vector processors", "committedDate": "2020-06-04T21:06:16Z", "type": "commit"}, {"oid": "7dc8754d4363e276b5502f355357a039a5b769b6", "url": "https://github.com/apache/druid/commit/7dc8754d4363e276b5502f355357a039a5b769b6", "message": "return ColumnCapabilities.Capable for BitmapIndexSelector.hasMultipleValues, fix vector processor selection for complex", "committedDate": "2020-06-04T22:25:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY0ODU3Ng==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435648576", "bodyText": "If the column holder is null then we should be able to safely return Capable.TRUE, because getBitmapIndex will return a bitmap index as if the column were full of nulls. This will enable optimizations in ExpressionFilter when the expression is based on a nonexistent column.", "author": "gianm", "createdAt": "2020-06-05T01:55:05Z", "path": "processing/src/main/java/org/apache/druid/segment/ColumnSelectorBitmapIndexSelector.java", "diffHunk": "@@ -157,14 +158,16 @@ public void close() throws IOException\n   }\n \n   @Override\n-  public boolean hasMultipleValues(final String dimension)\n+  public ColumnCapabilities.Capable hasMultipleValues(final String dimension)\n   {\n     if (isVirtualColumn(dimension)) {\n       return virtualColumns.getVirtualColumn(dimension).capabilities(dimension).hasMultipleValues();\n     }\n \n     final ColumnHolder columnHolder = index.getColumnHolder(dimension);\n-    return columnHolder != null && columnHolder.getCapabilities().hasMultipleValues();\n+    return columnHolder != null\n+           ? columnHolder.getCapabilities().hasMultipleValues()\n+           : ColumnCapabilities.Capable.UNKNOWN;", "originalCommit": "7dc8754d4363e276b5502f355357a039a5b769b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY2Njg0Nw==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435666847", "bodyText": "Ah, I changed ExpressionFilter to check isMaybeTrue to handle unknown, so i think unknown is fine here.", "author": "clintropolis", "createdAt": "2020-06-05T03:10:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY0ODU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY2OTIzMg==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435669232", "bodyText": "I think the code you have is correct, but it's not going to do the optimized path (return supportsBitmapIndex = true) for a missing column, even though it would be okay to do it.", "author": "gianm", "createdAt": "2020-06-05T03:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY0ODU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3NzU5MA==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435677590", "bodyText": "Ah, I see what you are saying, but in your first comment you meant Capable.FALSE, so that this code path is taken to use the empty bitmap. Updated the PR and left a comment in the code to explain what is going on there", "author": "clintropolis", "createdAt": "2020-06-05T04:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY0ODU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTcwMTkyOQ==", "url": "https://github.com/apache/druid/pull/9731#discussion_r435701929", "bodyText": "Sorry, you're right, I meant Capable.FALSE. Thanks.", "author": "gianm", "createdAt": "2020-06-05T05:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY0ODU3Ng=="}], "type": "inlineReview"}, {"oid": "33b8313a4c6538ab158cf636a6025e05c4df1885", "url": "https://github.com/apache/druid/commit/33b8313a4c6538ab158cf636a6025e05c4df1885", "message": "false on non-existent", "committedDate": "2020-06-05T03:48:50Z", "type": "commit"}]}