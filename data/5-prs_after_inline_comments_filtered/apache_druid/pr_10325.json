{"pr_number": 10325, "pr_title": "fix NPE in StringGroupByColumnSelectorStrategy#bufferComparator", "pr_createdAt": "2020-08-27T02:38:28Z", "pr_url": "https://github.com/apache/druid/pull/10325", "timeline": [{"oid": "5360a41529dae2ee08609bbe7ce0009b61009208", "url": "https://github.com/apache/druid/commit/5360a41529dae2ee08609bbe7ce0009b61009208", "message": "fix NPE in StringGroupByColumnSelectorStrategy#bufferComparator", "committedDate": "2020-08-27T02:34:18Z", "type": "commit"}, {"oid": "bad4065e4ff4a22ededc908e6503941b9dbc3348", "url": "https://github.com/apache/druid/commit/bad4065e4ff4a22ededc908e6503941b9dbc3348", "message": "Add tests", "committedDate": "2020-09-03T16:03:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwMDA3MQ==", "url": "https://github.com/apache/druid/pull/10325#discussion_r483100071", "bodyText": "Could you add some javadocs to this method explaining what it does in general, and also specifically what it does when stringComparator is null?\nAlso, do you think this NPE could have got triggered by a real query? If so, is defaulting to lexicographic the right behavior for that query?", "author": "gianm", "createdAt": "2020-09-03T16:17:28Z", "path": "processing/src/main/java/org/apache/druid/query/groupby/epinephelinae/column/StringGroupByColumnSelectorStrategy.java", "diffHunk": "@@ -157,8 +157,8 @@ private void initializeGroupingKeyV2Dimension(\n         capabilities != null &&\n         capabilities.hasBitmapIndexes() &&\n         capabilities.areDictionaryValuesSorted().and(capabilities.areDictionaryValuesUnique()).isTrue();\n-\n-    if (canCompareInts && (stringComparator == null || StringComparators.LEXICOGRAPHIC.equals(stringComparator))) {\n+    final StringComparator comparator = stringComparator == null ? StringComparators.LEXICOGRAPHIC : stringComparator;", "originalCommit": "bad4065e4ff4a22ededc908e6503941b9dbc3348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI5MDgzNw==", "url": "https://github.com/apache/druid/pull/10325#discussion_r483290837", "bodyText": "It looks like it can if the Order By is not set for the dimension. See GroupByEngineKeySerde#getDimensionComparators which calls DefaultLimitSpec#getComparatorForDimName which can return null.\nMaybe it makes more sense for the default to be something faster since we can't use the indexes in this case, something like alphanumeric or strlen would be faster.\nI haven't seen this triggered in a real query yet, but I think I've seen the lexicographic comparator used as a default in other parts of the query stack (BoundDimFilter and DimensionTopNMetricSpec)", "author": "suneet-s", "createdAt": "2020-09-03T22:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwMDA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMxMDY0Ng==", "url": "https://github.com/apache/druid/pull/10325#discussion_r483310646", "bodyText": "Lexicographic is our usual default because it matches the order that stuff is stored in the dictionaries. I wouldn't choose something different, since we want to be consistent about what the default ordering is.", "author": "gianm", "createdAt": "2020-09-03T23:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwMDA3MQ=="}], "type": "inlineReview"}, {"oid": "4feba9937f455d2c910b912dc9e6338047e81501", "url": "https://github.com/apache/druid/commit/4feba9937f455d2c910b912dc9e6338047e81501", "message": "Merge remote-tracking branch 'upstream/master' into comparator", "committedDate": "2020-09-03T23:59:18Z", "type": "commit"}, {"oid": "4b7b866900f736404bce5ce91285fd58cf7e0977", "url": "https://github.com/apache/druid/commit/4b7b866900f736404bce5ce91285fd58cf7e0977", "message": "javadocs", "committedDate": "2020-09-04T00:03:26Z", "type": "commit"}]}