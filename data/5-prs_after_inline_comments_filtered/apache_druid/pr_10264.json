{"pr_number": 10264, "pr_title": "Fix CombiningFirehose compatibility", "pr_createdAt": "2020-08-11T17:14:59Z", "pr_url": "https://github.com/apache/druid/pull/10264", "timeline": [{"oid": "356cd432a4e9216c84818ed976d1f9f0fc3f571f", "url": "https://github.com/apache/druid/commit/356cd432a4e9216c84818ed976d1f9f0fc3f571f", "message": "Fix CombiningFirehose", "committedDate": "2020-08-11T17:03:57Z", "type": "commit"}, {"oid": "f62775b5842745e586c3e9d43f145da04e7af412", "url": "https://github.com/apache/druid/commit/f62775b5842745e586c3e9d43f145da04e7af412", "message": "Merge branch 'master' of https://github.com/druid-io/druid into fix_combining", "committedDate": "2020-08-12T15:15:01Z", "type": "commit"}, {"oid": "03b56bc3e5e13b89e3502a5fbbbf32b9744fc080", "url": "https://github.com/apache/druid/commit/03b56bc3e5e13b89e3502a5fbbbf32b9744fc080", "message": "Add integration test", "committedDate": "2020-08-13T16:17:24Z", "type": "commit"}, {"oid": "fcdb6afc4500321b67c46b7c0a6122a184e274d4", "url": "https://github.com/apache/druid/commit/fcdb6afc4500321b67c46b7c0a6122a184e274d4", "message": "Fix path", "committedDate": "2020-08-13T18:15:53Z", "type": "commit"}, {"oid": "8d3f7182feb74c5636cae95a00663f060a49e2ac", "url": "https://github.com/apache/druid/commit/8d3f7182feb74c5636cae95a00663f060a49e2ac", "message": "Add full datasource name", "committedDate": "2020-08-13T20:51:41Z", "type": "commit"}, {"oid": "10ab1298f839b584544047f970f511bb95eb8dcc", "url": "https://github.com/apache/druid/commit/10ab1298f839b584544047f970f511bb95eb8dcc", "message": "Fix input location", "committedDate": "2020-08-14T14:02:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzOTE0Ng==", "url": "https://github.com/apache/druid/pull/10264#discussion_r471539146", "bodyText": "I looked for implementations of FirehoseFactory that do not also implement FiniteFirehoseFactory and I found a few... eg. ClippedFirehoseFactory, FixedCountFirehoseFactory, etc.\nI think the underlying problem is in IndexIOConfig#getNonNullInputSource\nIndexIOConfig accepts a FirehoseFactory, but getNonNullInputSource expects a FiniteFirehoseFactory.\nI wonder if we could fix this by creating an adapter that translates any FirehoseFactory into a non-splittable FiniteFirehoseFactory (ie. the same functionality you've implemented in this class).\nI understand that the FirehoseFactories are deprecated, so I'm open to other ways of fixing the broken quickstart material as well - can we update the spec used so that the combining firehose factory works without a code change?", "author": "suneet-s", "createdAt": "2020-08-17T15:00:08Z", "path": "server/src/main/java/org/apache/druid/segment/realtime/firehose/CombiningFirehoseFactory.java", "diffHunk": "@@ -33,11 +36,12 @@\n import java.io.IOException;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.stream.Stream;\n \n /**\n  * Creates firehose that combines data from different Firehoses. Useful for ingesting data from multiple sources.\n  */\n-public class CombiningFirehoseFactory implements FirehoseFactory<InputRowParser>\n+public class CombiningFirehoseFactory implements FiniteFirehoseFactory<InputRowParser, List<FirehoseFactory>>", "originalCommit": "10ab1298f839b584544047f970f511bb95eb8dcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0Mzk0Mg==", "url": "https://github.com/apache/druid/pull/10264#discussion_r472243942", "bodyText": "I feel that adding a non-splittable adapter would apply only to CombiningFirehoseFactory.  ClippedFirehoseFactory , TimedShutoffFirehoseFactory and FixedCountFirehoseFactory can be potentially splittable if the delegate FirehoseFactory is splittable, it's just that they haven't been fixed yet.\nWhat we actually need is for index_parallel to support nested InputSource say DelegateInputSource. The delegate FirehoseFactories such as the ones listed above can then be easily provided their equivalent InputSource implementations. I've been looking at adding this support and hopefully can have a proposal out once I have something.", "author": "a2l007", "createdAt": "2020-08-18T14:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzOTE0Ng=="}], "type": "inlineReview"}]}