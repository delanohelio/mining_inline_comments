{"pr_number": 9717, "pr_title": "remove DruidLeaderClient.goAsync(..) that does not follow redirect. Replace its usage by DruidLeaderClient.go(..) with InputStreamFullResponseHandler", "pr_createdAt": "2020-04-16T19:57:26Z", "pr_url": "https://github.com/apache/druid/pull/9717", "timeline": [{"oid": "337d70e0a9cdc198195172deba4a743db19cc997", "url": "https://github.com/apache/druid/commit/337d70e0a9cdc198195172deba4a743db19cc997", "message": "remove DruidLeaderClient.goAsync(..) that does not follow redirect.\nReplace its usage by DruidLeaadereClient.go(..) with\nInputStreamFullResponseHandler", "committedDate": "2020-04-16T19:50:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NTI4OQ==", "url": "https://github.com/apache/druid/pull/9717#discussion_r423475289", "bodyText": "addChunk seems to be implemented by all the subclasses, then why remove this ?", "author": "surekhasaharan", "createdAt": "2020-05-12T05:46:23Z", "path": "core/src/main/java/org/apache/druid/java/util/http/client/response/FullResponseHolder.java", "diffHunk": "@@ -49,12 +49,7 @@ public HttpResponse getResponse()\n   }\n \n   /**\n-   * Append a new chunk of data.\n-   */\n-  public abstract FullResponseHolder addChunk(T chunk);", "originalCommit": "337d70e0a9cdc198195172deba4a743db19cc997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NDI1OA==", "url": "https://github.com/apache/druid/pull/9717#discussion_r432784258", "bodyText": "removed it because newly introduced InputStreamFullResponseHolder.addChunk(byte[] chunk) whereas getContent() needs to return InputStream . We could do the necessary wrapping so as to have InputStreamFullResponseHolder.addChunk(InputStream chunk) but would have required an extra wrap/unwrap of byte[] into/outof ByteArrayInputStream in `InputStreamResponseHandler .", "author": "himanshug", "createdAt": "2020-05-29T23:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NTI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3ODE3Mw==", "url": "https://github.com/apache/druid/pull/9717#discussion_r423478173", "bodyText": "it would always use cached \"CurrentKnownLeader\", it lead to some issues earlier if the cached leader is not reachable, is that case handled somewhere now?", "author": "surekhasaharan", "createdAt": "2020-05-12T05:55:24Z", "path": "server/src/main/java/org/apache/druid/discovery/DruidLeaderClient.java", "diffHunk": "@@ -121,42 +120,20 @@ public void stop()\n     log.debug(\"Stopped.\");\n   }\n \n-  /**\n-   * Make a Request object aimed at the leader. Throws IOException if the leader cannot be located.\n-   *\n-   * @param cached Uses cached leader if true, else uses the current leader\n-   */\n-  public Request makeRequest(HttpMethod httpMethod, String urlPath, boolean cached) throws IOException\n-  {\n-    Preconditions.checkState(lifecycleLock.awaitStarted(1, TimeUnit.MILLISECONDS));\n-    return new Request(httpMethod, new URL(StringUtils.format(\"%s%s\", getCurrentKnownLeader(cached), urlPath)));\n-  }\n-\n   /**\n    * Make a Request object aimed at the leader. Throws IOException if the leader cannot be located.\n    */\n   public Request makeRequest(HttpMethod httpMethod, String urlPath) throws IOException\n   {\n-    return makeRequest(httpMethod, urlPath, true);\n+    Preconditions.checkState(lifecycleLock.awaitStarted(1, TimeUnit.MILLISECONDS));\n+    return new Request(httpMethod, new URL(StringUtils.format(\"%s%s\", getCurrentKnownLeader(true), urlPath)));", "originalCommit": "337d70e0a9cdc198195172deba4a743db19cc997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NDczMg==", "url": "https://github.com/apache/druid/pull/9717#discussion_r432784732", "bodyText": "if cached \"leader\" has disappeared then connection to that host will fail and we will  retry with a randomly  chosen  available server in code path starting line-160 .\nif cached \"leader\" is not leader anymore then it should send a TEMPORARY_REDIRECT and we would retry with code flow starting at line 193", "author": "himanshug", "createdAt": "2020-05-29T23:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3ODE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ4NDQ5Nw==", "url": "https://github.com/apache/druid/pull/9717#discussion_r423484497", "bodyText": "instead of query, it should be request.getUrl().toString() or something which gives info about the leader location.", "author": "surekhasaharan", "createdAt": "2020-05-12T06:13:50Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/MetadataSegmentView.java", "diffHunk": "@@ -201,32 +197,41 @@ private void poll()\n       query = \"/druid/coordinator/v1/metadata/segments?includeOvershadowedStatus&\" + sb;\n     }\n     Request request;\n+    InputStreamFullResponseHolder responseHolder;\n     try {\n       request = coordinatorClient.makeRequest(\n           HttpMethod.GET,\n-          StringUtils.format(query),\n-          false\n+          StringUtils.format(query)\n       );\n+\n+      responseHolder = coordinatorClient.go(\n+          request,\n+          new InputStreamFullResponseHandler()\n+      );\n+      if (responseHolder.getStatus().getCode() != HttpServletResponse.SC_OK) {\n+        throw new RE(\n+            \"Failed to talk to coordinator leader at [%s]. Error code[%d], description[%s].\",\n+            query,", "originalCommit": "337d70e0a9cdc198195172deba4a743db19cc997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NTI2NQ==", "url": "https://github.com/apache/druid/pull/9717#discussion_r432785265", "bodyText": "as explained above, since we change the server on-the-fly as explained above, request.getUrl() would contain  the original cached host and might print host1 which has  disappeared and response has really come from current discovered leader inside go(..) method impl, \"request\" object passed is not modified.\nwith some hackery, we could get it to print real server contacted, but I thought that would be overkill  for this logging use case and just printing that got this blah response from \"coordinator leader\" was good enough.", "author": "himanshug", "createdAt": "2020-05-29T23:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ4NDQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ4NTE4Mg==", "url": "https://github.com/apache/druid/pull/9717#discussion_r423485182", "bodyText": "can we remove this param now", "author": "surekhasaharan", "createdAt": "2020-05-12T06:15:38Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/MetadataSegmentView.java", "diffHunk": "@@ -201,32 +197,41 @@ private void poll()\n       query = \"/druid/coordinator/v1/metadata/segments?includeOvershadowedStatus&\" + sb;\n     }\n     Request request;\n+    InputStreamFullResponseHolder responseHolder;\n     try {\n       request = coordinatorClient.makeRequest(\n           HttpMethod.GET,\n-          StringUtils.format(query),\n-          false\n+          StringUtils.format(query)\n       );\n+\n+      responseHolder = coordinatorClient.go(\n+          request,\n+          new InputStreamFullResponseHandler()\n+      );\n+      if (responseHolder.getStatus().getCode() != HttpServletResponse.SC_OK) {\n+        throw new RE(\n+            \"Failed to talk to coordinator leader at [%s]. Error code[%d], description[%s].\",\n+            query,\n+            responseHolder.getStatus().getCode(),\n+            responseHolder.getStatus().getReasonPhrase()\n+        );\n+      }\n     }\n-    catch (IOException e) {\n+    catch (IOException | InterruptedException e) {\n       throw new RuntimeException(e);\n     }\n-    ListenableFuture<InputStream> future = coordinatorClient.goAsync(\n-        request,\n-        responseHandler\n-    );\n \n     final JavaType typeRef = jsonMapper.getTypeFactory().constructType(new TypeReference<SegmentWithOvershadowedStatus>()\n     {\n     });\n     return new JsonParserIterator<>(\n         typeRef,\n-        future,\n+        Futures.immediateFuture(responseHolder.getContent()),\n         request.getUrl().toString(),\n         null,\n         request.getUrl().getHost(),\n         jsonMapper,\n-        responseHandler\n+        null", "originalCommit": "337d70e0a9cdc198195172deba4a743db19cc997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NTM4Ng==", "url": "https://github.com/apache/druid/pull/9717#discussion_r432785386", "bodyText": "I didn't know where else it was used, if it is not used anywhere then we can remove  it yes.", "author": "himanshug", "createdAt": "2020-05-29T23:50:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ4NTE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjIzMg==", "url": "https://github.com/apache/druid/pull/9717#discussion_r432792232", "bodyText": "removed", "author": "himanshug", "createdAt": "2020-05-30T00:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ4NTE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ4NjAyMA==", "url": "https://github.com/apache/druid/pull/9717#discussion_r423486020", "bodyText": "same comment about replacing query with more meaningful info here and at other places", "author": "surekhasaharan", "createdAt": "2020-05-12T06:17:52Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/SystemSchema.java", "diffHunk": "@@ -736,37 +733,48 @@ public void close()\n   //Note that overlord must be up to get tasks\n   private static JsonParserIterator<TaskStatusPlus> getTasks(\n       DruidLeaderClient indexingServiceClient,\n-      ObjectMapper jsonMapper,\n-      BytesAccumulatingResponseHandler responseHandler\n+      ObjectMapper jsonMapper\n   )\n   {\n     Request request;\n+    InputStreamFullResponseHolder responseHolder;\n     try {\n+      String query = \"/druid/indexer/v1/tasks\";\n+\n       request = indexingServiceClient.makeRequest(\n           HttpMethod.GET,\n-          \"/druid/indexer/v1/tasks\",\n-          false\n+          query\n+      );\n+\n+      responseHolder = indexingServiceClient.go(\n+          request,\n+          new InputStreamFullResponseHandler()\n       );\n+\n+      if (responseHolder.getStatus().getCode() != HttpServletResponse.SC_OK) {\n+        throw new RE(\n+            \"Failed to talk to overlord leader at [%s]. Error code[%d], description[%s].\",\n+            query,", "originalCommit": "337d70e0a9cdc198195172deba4a743db19cc997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NTQyMg==", "url": "https://github.com/apache/druid/pull/9717#discussion_r432785422", "bodyText": "same", "author": "himanshug", "createdAt": "2020-05-29T23:50:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ4NjAyMA=="}], "type": "inlineReview"}, {"oid": "6a7cba2cb5387a344a87b7c6fe60c0dce75ac2ed", "url": "https://github.com/apache/druid/commit/6a7cba2cb5387a344a87b7c6fe60c0dce75ac2ed", "message": "remove ByteArrayResponseHolder dependency from JsonParserIterator", "committedDate": "2020-05-30T00:17:21Z", "type": "commit"}, {"oid": "3ef28b6360a08c84565396f8b4346a13d65e95c8", "url": "https://github.com/apache/druid/commit/3ef28b6360a08c84565396f8b4346a13d65e95c8", "message": "Merge remote-tracking branch 'apache/master' into fix_8716", "committedDate": "2020-05-30T00:37:01Z", "type": "commit"}, {"oid": "79a4691cea989fc624aa0d34d827919515fdd63c", "url": "https://github.com/apache/druid/commit/79a4691cea989fc624aa0d34d827919515fdd63c", "message": "Merge remote-tracking branch 'apache/master' into fix_8716", "committedDate": "2020-06-10T16:21:52Z", "type": "commit"}, {"oid": "d458b8ad74c86dca0e3942449386f1f56eb1feb4", "url": "https://github.com/apache/druid/commit/d458b8ad74c86dca0e3942449386f1f56eb1feb4", "message": "Merge remote-tracking branch 'apache/master' into fix_8716", "committedDate": "2020-07-25T17:20:52Z", "type": "commit"}, {"oid": "330aba3dd98ce15a13cd6ca607824bc07036ee81", "url": "https://github.com/apache/druid/commit/330aba3dd98ce15a13cd6ca607824bc07036ee81", "message": "add UT to cover lines in InputStreamFullResponseHandler", "committedDate": "2020-07-26T17:57:31Z", "type": "commit"}, {"oid": "18d1a910bd78cc33cc9729e21269aaf3a929bb5e", "url": "https://github.com/apache/druid/commit/18d1a910bd78cc33cc9729e21269aaf3a929bb5e", "message": "refactor SystemSchema to reduce branches", "committedDate": "2020-07-26T17:57:44Z", "type": "commit"}, {"oid": "ec993a986fe5a4d17c5d808d33d1a1589074042b", "url": "https://github.com/apache/druid/commit/ec993a986fe5a4d17c5d808d33d1a1589074042b", "message": "further reduce branches", "committedDate": "2020-07-26T23:33:40Z", "type": "commit"}, {"oid": "ee0285687413a2d1d7d3f2c9156d0671d6a6c088", "url": "https://github.com/apache/druid/commit/ee0285687413a2d1d7d3f2c9156d0671d6a6c088", "message": "Revert \"add UT to cover lines in InputStreamFullResponseHandler\"\n\nThis reverts commit 330aba3dd98ce15a13cd6ca607824bc07036ee81.", "committedDate": "2020-07-27T00:05:07Z", "type": "commit"}, {"oid": "0b139b8e8ca9f544a99af2bf025652459700a54a", "url": "https://github.com/apache/druid/commit/0b139b8e8ca9f544a99af2bf025652459700a54a", "message": "UTs for InputStreamFullResponseHandler", "committedDate": "2020-07-27T00:05:34Z", "type": "commit"}, {"oid": "e0d64850b29413ba920414ffd8e5feaad206ee46", "url": "https://github.com/apache/druid/commit/e0d64850b29413ba920414ffd8e5feaad206ee46", "message": "remove unused imports", "committedDate": "2020-07-27T01:45:52Z", "type": "commit"}]}