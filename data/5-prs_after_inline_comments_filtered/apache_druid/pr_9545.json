{"pr_number": 9545, "pr_title": "SQL support for joins on subqueries.", "pr_createdAt": "2020-03-20T15:32:37Z", "pr_url": "https://github.com/apache/druid/pull/9545", "timeline": [{"oid": "5eeae13930d3267b6831133a875ea3c9fc6bb66a", "url": "https://github.com/apache/druid/commit/5eeae13930d3267b6831133a875ea3c9fc6bb66a", "message": "SQL support for joins on subqueries.\n\nChanges to SQL module:\n\n- DruidJoinRule: Allow joins on subqueries (left/right are no longer\n  required to be scans or mappings).\n- DruidJoinRel: Add cost estimation code for joins on subqueries.\n- DruidSemiJoinRule, DruidSemiJoinRel: Removed, since DruidJoinRule can\n  handle this case now.\n- DruidRel: Remove Nullable annotation from toDruidQuery, because\n  it is no longer needed (it was used by DruidSemiJoinRel).\n- Update Rules constants to reflect new rules available in our current\n  version of Calcite. Some of these are useful for optimizing joins on\n  subqueries.\n- Rework cost estimation to be in terms of cost per row, and place all\n  relevant constants in CostEstimates.\n\nOther changes:\n\n- RowBasedColumnSelectorFactory: Don't set hasMultipleValues. The lack\n  of isComplete is enough to let callers know that columns might have\n  multiple values, and explicitly setting it to true causes\n  ExpressionSelectors to think it definitely has multiple values, and\n  treat the inputs as arrays. This behavior interfered with some of the\n  new tests that involved queries on lookups.\n- QueryContexts: Add maxSubqueryRows parameter, and use it in druid-sql\n  tests.", "committedDate": "2020-03-20T15:24:04Z", "type": "commit"}, {"oid": "36619ca428280448a8a5dde06277c828863e8a03", "url": "https://github.com/apache/druid/commit/36619ca428280448a8a5dde06277c828863e8a03", "message": "Fixes for tests.", "committedDate": "2020-03-20T17:49:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzNTAwMg==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395835002", "bodyText": "Unused variable.", "author": "jihoonson", "createdAt": "2020-03-20T18:59:32Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/rel/DruidQueryRel.java", "diffHunk": "@@ -34,22 +34,14 @@\n import org.apache.druid.java.util.common.guava.Sequence;\n import org.apache.druid.sql.calcite.table.DruidTable;\n \n-import javax.annotation.Nonnull;\n import java.util.Set;\n \n /**\n  * DruidRel that operates on top of a {@link DruidTable} directly (no joining or subqueries).\n  */\n public class DruidQueryRel extends DruidRel<DruidQueryRel>\n {\n-  // Factors used for computing cost (see computeSelfCost). These are intended to encourage pushing down filters\n-  // and limits through stacks of nested queries when possible.\n-  private static final double COST_BASE = 1.0;\n-  private static final double COST_PER_COLUMN = 0.001;\n-  private static final double COST_FILTER_MULTIPLIER = 0.1;\n-  private static final double COST_GROUPING_MULTIPLIER = 0.5;\n-  private static final double COST_LIMIT_MULTIPLIER = 0.5;\n-  private static final double COST_HAVING_MULTIPLIER = 5.0;\n+  static final double COST_BASE = 1.0;", "originalCommit": "36619ca428280448a8a5dde06277c828863e8a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxODk2OA==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395918968", "bodyText": "Thanks, I'll remove it.", "author": "gianm", "createdAt": "2020-03-20T22:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzNTAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzNjEyNQ==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395836125", "bodyText": "This doesn't seem right since we don't have DruidSemiJoin anymore.", "author": "jihoonson", "createdAt": "2020-03-20T19:01:46Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/rel/DruidRel.java", "diffHunk": "@@ -71,17 +71,14 @@ public boolean isValidDruidQuery()\n    * Convert this DruidRel to a DruidQuery. This may be an expensive operation. For example, DruidSemiJoin needs to", "originalCommit": "36619ca428280448a8a5dde06277c828863e8a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxOTM3OQ==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395919379", "bodyText": "I forgot to update this javadoc! Updated.", "author": "gianm", "createdAt": "2020-03-20T22:38:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzNjEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzNjI0Nw==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395836247", "bodyText": "This method does not return null?", "author": "jihoonson", "createdAt": "2020-03-20T19:02:02Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/rel/DruidRel.java", "diffHunk": "@@ -71,17 +71,14 @@ public boolean isValidDruidQuery()\n    * Convert this DruidRel to a DruidQuery. This may be an expensive operation. For example, DruidSemiJoin needs to\n    * execute the right-hand side query in order to complete this method.\n    *\n-   * This method may return null if it knows that this rel will yield an empty result set.\n+   * This method may not return null.", "originalCommit": "36619ca428280448a8a5dde06277c828863e8a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxOTQxNw==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395919417", "bodyText": "Changed it to \"This method must not return null.\"", "author": "gianm", "createdAt": "2020-03-20T22:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzNjI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg4OTQ1Ng==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395889456", "bodyText": "This doesn't seem right.. I guess it should be always 0.\nBased on the expected results before this PR, it seems that a timeseries query was issued when useDefault = true which returns an empty result. When useDefault = false, no query was issued so probably the query computation was done by Calcite.\nSo, I guess there are two potential issues here. One is the timeseries query returning an empty result and another is Calcite returning an empty result which used to return a valid result. We may want to fix the Calcite issue in this PR. The timeseries issue seems a bug, but since it's not introduced in this PR and we are about to cut the branch for 0.18, I'm ok with merging this PR and backporting the bug fix later.", "author": "jihoonson", "createdAt": "2020-03-20T21:05:41Z", "path": "sql/src/test/java/org/apache/druid/sql/calcite/CalciteParameterQueryTest.java", "diffHunk": "@@ -602,14 +602,13 @@ public void testWrongTypeParameter() throws Exception\n                       and(\n                           bound(\"l1\", \"3\", null, true, false, null, StringComparators.NUMERIC),\n                           selector(\"f1\", useDefault ? \"0.0\" : null, null)\n-\n                       )\n                   )\n                   .aggregators(aggregators(new CountAggregatorFactory(\"a0\")))\n                   .context(TIMESERIES_CONTEXT_DEFAULT)\n                   .build()\n         ) : ImmutableList.of(),\n-        useDefault ? ImmutableList.of() : ImmutableList.of(new Object[]{0L}),\n+        ImmutableList.of(),", "originalCommit": "36619ca428280448a8a5dde06277c828863e8a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MTA4NQ==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395941085", "bodyText": "Your analysis sounds right to me. I tracked this down to the removal of AggregateMergeRule, which I did because it was causing one of the new tests to fail (testDoubleNestedGroupBy2). Without that rule loaded, this query gets executed by a BindableAggregate, which doesn't seem to properly generate the expected row.\nSince this is a situation where two bugs are conflicting, I think it might take some time to unwind. I'd rather look into that in a future patch. My preference would be to do this:\n\nIdentify and fix the bug with AggregateMergeRule, and re-enable it. That should get us back to normal on this test.\nAfter that, stop using Bindable completely, and instead use native Druid queries for everything (even queries on literal values). We can do this by adding a few more capabilities to native Druid queries. Then we won't have to worry about it.", "author": "gianm", "createdAt": "2020-03-21T00:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg4OTQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0NDQ3NQ==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395944475", "bodyText": "Sounds good to me.", "author": "jihoonson", "createdAt": "2020-03-21T00:51:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg4OTQ1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5NjAzNg==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395896036", "bodyText": "Seems like the same Calcite issue.", "author": "jihoonson", "createdAt": "2020-03-20T21:22:50Z", "path": "sql/src/test/java/org/apache/druid/sql/calcite/CalciteQueryTest.java", "diffHunk": "@@ -4841,10 +4982,12 @@ public void testCountStarWithDegenerateFilter() throws Exception\n   @Test\n   public void testCountStarWithNotOfDegenerateFilter() throws Exception\n   {\n+    // This query is evaluated in the planner (no native queries are issued) due to the degenerate filter.\n+\n     testQuery(\n         \"SELECT COUNT(*) FROM druid.foo WHERE dim2 = 'a' and not (dim1 > 'a' OR dim1 < 'b')\",\n         ImmutableList.of(),\n-        ImmutableList.of(new Object[]{0L})\n+        ImmutableList.of()", "originalCommit": "36619ca428280448a8a5dde06277c828863e8a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxOTU5NA==", "url": "https://github.com/apache/druid/pull/9545#discussion_r395919594", "bodyText": "Yeah, I think it is.", "author": "gianm", "createdAt": "2020-03-20T22:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5NjAzNg=="}], "type": "inlineReview"}, {"oid": "5176b4f754b99c30b0893eb84ae850690426e166", "url": "https://github.com/apache/druid/commit/5176b4f754b99c30b0893eb84ae850690426e166", "message": "Adjustments.", "committedDate": "2020-03-21T00:27:04Z", "type": "commit"}]}