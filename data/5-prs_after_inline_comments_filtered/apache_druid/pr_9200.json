{"pr_number": 9200, "pr_title": "Optimize JoinCondition matching", "pr_createdAt": "2020-01-16T23:36:29Z", "pr_url": "https://github.com/apache/druid/pull/9200", "timeline": [{"oid": "1f7e73d1c00cc4e2783ec36e444f77c2b7358be9", "url": "https://github.com/apache/druid/commit/1f7e73d1c00cc4e2783ec36e444f77c2b7358be9", "message": "Optimize JoinCondition matching\n\nThe LookupJoinMatcher needs to check if a condition is always true or false\nmultiple times. This can be pre-computed to speed up the match checking\n\nThis change reduces the time it takes to perform a for joining on a long key\nfrom ~ 36 ms/op to 23 ms/ op", "committedDate": "2020-01-16T23:32:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcxOTM4NA==", "url": "https://github.com/apache/druid/pull/9200#discussion_r367719384", "bodyText": "It seems like allTrueLiteralNonEquiConditions is only used here; how about caching isAlwaysTrue directly?", "author": "gianm", "createdAt": "2020-01-17T00:37:01Z", "path": "processing/src/main/java/org/apache/druid/segment/join/JoinConditionAnalysis.java", "diffHunk": "@@ -133,26 +142,23 @@ public String getOriginalExpression()\n    */\n   public boolean isAlwaysFalse()\n   {\n-    return nonEquiConditions.stream()\n-                            .anyMatch(expr -> expr.isLiteral() && !expr.eval(ExprUtils.nilBindings()).asBoolean());\n+    return anyFalseLiteralNonEquiConditions;\n   }\n \n   /**\n    * Return whether this condition is a constant that is always true.\n    */\n   public boolean isAlwaysTrue()\n   {\n-    return equiConditions.isEmpty() &&\n-           nonEquiConditions.stream()\n-                            .allMatch(expr -> expr.isLiteral() && expr.eval(ExprUtils.nilBindings()).asBoolean());\n+    return equiConditions.isEmpty() && allTrueLiteralNonEquiConditions;", "originalCommit": "1f7e73d1c00cc4e2783ec36e444f77c2b7358be9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4MDg5Ng==", "url": "https://github.com/apache/druid/pull/9200#discussion_r368080896", "bodyText": "Done", "author": "suneet-s", "createdAt": "2020-01-17T18:43:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcxOTM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcxOTQ5OQ==", "url": "https://github.com/apache/druid/pull/9200#discussion_r367719499", "bodyText": "Why not call this isAlwaysFalse? (It looks like it isn't used anywhere else, and it seems to me to be easier to understand the meaning of the field if it's named after what we want it to mean.)", "author": "gianm", "createdAt": "2020-01-17T00:37:32Z", "path": "processing/src/main/java/org/apache/druid/segment/join/JoinConditionAnalysis.java", "diffHunk": "@@ -133,26 +142,23 @@ public String getOriginalExpression()\n    */\n   public boolean isAlwaysFalse()\n   {\n-    return nonEquiConditions.stream()\n-                            .anyMatch(expr -> expr.isLiteral() && !expr.eval(ExprUtils.nilBindings()).asBoolean());\n+    return anyFalseLiteralNonEquiConditions;", "originalCommit": "1f7e73d1c00cc4e2783ec36e444f77c2b7358be9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4MDg3MQ==", "url": "https://github.com/apache/druid/pull/9200#discussion_r368080871", "bodyText": "yeah. I wasn't sure if isAlwaysFalse could be more complex going forward. This is clearer - it took me a while to wrap my head around what isAlwaysFalse was trying to check. Added comments, and used isAlways...", "author": "suneet-s", "createdAt": "2020-01-17T18:43:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcxOTQ5OQ=="}], "type": "inlineReview"}, {"oid": "3cf6abbead11db90f17d0bc314e14fe11fd57b5f", "url": "https://github.com/apache/druid/commit/3cf6abbead11db90f17d0bc314e14fe11fd57b5f", "message": "Rename variables", "committedDate": "2020-01-17T18:49:28Z", "type": "commit"}, {"oid": "bb386761dc60e4e3a18600fe94a166566adc9d28", "url": "https://github.com/apache/druid/commit/bb386761dc60e4e3a18600fe94a166566adc9d28", "message": "fix typo", "committedDate": "2020-01-17T18:50:47Z", "type": "commit"}, {"oid": "e2ae33eff21b46dc9390ec5551c50dc1592a3140", "url": "https://github.com/apache/druid/commit/e2ae33eff21b46dc9390ec5551c50dc1592a3140", "message": "Merge remote-tracking branch 'upstream/master' into join-perf", "committedDate": "2020-01-18T05:42:45Z", "type": "commit"}, {"oid": "8115975ed0690ec381aef630e1f38bb412350a6c", "url": "https://github.com/apache/druid/commit/8115975ed0690ec381aef630e1f38bb412350a6c", "message": "Merge remote-tracking branch 'upstream/master' into join-perf", "committedDate": "2020-01-18T05:43:02Z", "type": "commit"}, {"oid": "0053bf31addd0c2cd6c27ec9f307b7d2d894c782", "url": "https://github.com/apache/druid/commit/0053bf31addd0c2cd6c27ec9f307b7d2d894c782", "message": "Merge remote-tracking branch 'upstream/master' into join-perf", "committedDate": "2020-01-20T18:22:08Z", "type": "commit"}]}