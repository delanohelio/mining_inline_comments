{"pr_number": 9948, "pr_title": "Document unsupported Join on multi-value column", "pr_createdAt": "2020-05-29T04:06:28Z", "pr_url": "https://github.com/apache/druid/pull/9948", "timeline": [{"oid": "99c2c61f32789bbc92f239ff0a9dc6a74e62e7e0", "url": "https://github.com/apache/druid/commit/99c2c61f32789bbc92f239ff0a9dc6a74e62e7e0", "message": "Document Unsupported Join on multi-value column", "committedDate": "2020-05-29T04:01:28Z", "type": "commit"}, {"oid": "528e8e994568b7d8becff3214f5a278dd65f04ae", "url": "https://github.com/apache/druid/commit/528e8e994568b7d8becff3214f5a278dd65f04ae", "message": "Document Unsupported Join on multi-value column", "committedDate": "2020-05-29T04:14:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzNzQxOQ==", "url": "https://github.com/apache/druid/pull/9948#discussion_r432637419", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                 \"Unsupported query on multi-valued column\",\n          \n          \n            \n                                                 \"Joining against a multi-value dimension is not supported.\",", "author": "suneet-s", "createdAt": "2020-05-29T17:36:59Z", "path": "processing/src/main/java/org/apache/druid/segment/join/table/IndexedTableJoinMatcher.java", "diffHunk": "@@ -342,8 +347,12 @@ public ValueType defaultType()\n             IntList rowNumbers = getAndCacheRowNumbers(selector, dimensionId);\n             return rowNumbers.iterator();\n           } else {\n-            // Multi-valued rows are not handled by the join system right now; treat them as nulls.\n-            return IntIterators.EMPTY_ITERATOR;\n+            // Multi-valued rows are not handled by the join system right now\n+            // TODO: Remove when https://github.com/apache/druid/issues/9924 is done\n+            throw new QueryException(\"Unsupported query\",\n+                                     \"Unsupported query on multi-valued column\",", "originalCommit": "528e8e994568b7d8becff3214f5a278dd65f04ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyODE3NA==", "url": "https://github.com/apache/druid/pull/9948#discussion_r433028174", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-06-01T03:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzNzQxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzODI0MQ==", "url": "https://github.com/apache/druid/pull/9948#discussion_r432638241", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                 \"Unsupported query on multi-valued column\",\n          \n          \n            \n                                                 \"Joining against a multi-value dimension is not supported.\",", "author": "suneet-s", "createdAt": "2020-05-29T17:38:35Z", "path": "processing/src/main/java/org/apache/druid/segment/join/table/IndexedTableJoinMatcher.java", "diffHunk": "@@ -327,8 +328,12 @@ public ValueType defaultType()\n             IntList rowNumbers = getRowNumbers(selector, dimensionId);\n             return rowNumbers.iterator();\n           } else {\n-            // Multi-valued rows are not handled by the join system right now; treat them as nulls.\n-            return IntIterators.EMPTY_ITERATOR;\n+            // Multi-valued rows are not handled by the join system right now\n+            // TODO: Remove when https://github.com/apache/druid/issues/9924 is done\n+            throw new QueryException(\"Unsupported query\",\n+                                     \"Unsupported query on multi-valued column\",", "originalCommit": "528e8e994568b7d8becff3214f5a278dd65f04ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyODIyMg==", "url": "https://github.com/apache/druid/pull/9948#discussion_r433028222", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-06-01T03:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzODI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzODM3OA==", "url": "https://github.com/apache/druid/pull/9948#discussion_r432638378", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                   \"Unsupported query on multi-valued column\",\n          \n          \n            \n                                                 \"Joining against a multi-value dimension is not supported.\",", "author": "suneet-s", "createdAt": "2020-05-29T17:38:50Z", "path": "processing/src/main/java/org/apache/druid/segment/join/lookup/LookupJoinMatcher.java", "diffHunk": "@@ -72,8 +73,12 @@ public ValueType defaultType()\n             if (row.size() == 1) {\n               return selector.lookupName(row.get(0));\n             } else {\n-              // Multi-valued rows are not handled by the join system right now; treat them as nulls.\n-              return null;\n+              // Multi-valued rows are not handled by the join system right now\n+              // TODO: Remove when https://github.com/apache/druid/issues/9924 is done\n+              throw new QueryException(\"Unsupported query\",\n+                                       \"Unsupported query on multi-valued column\",", "originalCommit": "528e8e994568b7d8becff3214f5a278dd65f04ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyODI4OA==", "url": "https://github.com/apache/druid/pull/9948#discussion_r433028288", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-06-01T03:35:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzODM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0MDAyMg==", "url": "https://github.com/apache/druid/pull/9948#discussion_r432640022", "bodyText": "super nit: Do you think it's worth adding an UnsupportedQueryException class that other parts of the query stack can re-use for query operations that are unsupported? I don't know of any of these places of the top of my head, so feel free to ignore this comment. I think this is ok for now.", "author": "suneet-s", "createdAt": "2020-05-29T17:41:54Z", "path": "processing/src/main/java/org/apache/druid/segment/join/lookup/LookupJoinMatcher.java", "diffHunk": "@@ -72,8 +73,12 @@ public ValueType defaultType()\n             if (row.size() == 1) {\n               return selector.lookupName(row.get(0));\n             } else {\n-              // Multi-valued rows are not handled by the join system right now; treat them as nulls.\n-              return null;\n+              // Multi-valued rows are not handled by the join system right now\n+              // TODO: Remove when https://github.com/apache/druid/issues/9924 is done\n+              throw new QueryException(\"Unsupported query\",", "originalCommit": "528e8e994568b7d8becff3214f5a278dd65f04ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyODY5MA==", "url": "https://github.com/apache/druid/pull/9948#discussion_r433028690", "bodyText": "I think it'll be useful. Added", "author": "maytasm", "createdAt": "2020-06-01T03:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0MDAyMg=="}], "type": "inlineReview"}, {"oid": "7bcc70efaf6d5ac3c91be8f1c97d8d51c8439dc4", "url": "https://github.com/apache/druid/commit/7bcc70efaf6d5ac3c91be8f1c97d8d51c8439dc4", "message": "address comments", "committedDate": "2020-06-01T03:46:01Z", "type": "commit"}, {"oid": "a8a3d2aac6eb10a9b69384175bf74a28f9942f41", "url": "https://github.com/apache/druid/commit/a8a3d2aac6eb10a9b69384175bf74a28f9942f41", "message": "Add unit tests", "committedDate": "2020-06-01T04:14:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4MjcxMQ==", "url": "https://github.com/apache/druid/pull/9948#discussion_r433282711", "bodyText": "javadocs please. Details about who should use this and when; may be helpful to future devs.\nI think the key fact here is that this error message will be propagated back to the user. Providing guidance on using this error vs a ISE or RE for example would be useful.", "author": "suneet-s", "createdAt": "2020-06-01T14:53:49Z", "path": "processing/src/main/java/org/apache/druid/query/UnsupportedQueryException.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class UnsupportedQueryException extends QueryException", "originalCommit": "a8a3d2aac6eb10a9b69384175bf74a28f9942f41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzOTAzNw==", "url": "https://github.com/apache/druid/pull/9948#discussion_r434239037", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-06-03T00:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4MjcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4NjA1NQ==", "url": "https://github.com/apache/druid/pull/9948#discussion_r433286055", "bodyText": "Do you think we should provide the host as part of the exception? For cases where an issue only happens on a subset of segments (for example: a multi-value dimension is only present in a segment on host abc) this would be very helpful debugging information.", "author": "suneet-s", "createdAt": "2020-06-01T14:59:13Z", "path": "processing/src/main/java/org/apache/druid/query/UnsupportedQueryException.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class UnsupportedQueryException extends QueryException\n+{\n+  private static final String ERROR_CLASS = UnsupportedQueryException.class.getName();\n+  public static final String ERROR_CODE = \"Unsupported query\";\n+\n+  public UnsupportedQueryException(String errorMessage)\n+  {\n+    super(ERROR_CODE, errorMessage, ERROR_CLASS, null);", "originalCommit": "a8a3d2aac6eb10a9b69384175bf74a28f9942f41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI0MTIxMw==", "url": "https://github.com/apache/druid/pull/9948#discussion_r434241213", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-06-03T00:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4NjA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4ODEzOA==", "url": "https://github.com/apache/druid/pull/9948#discussion_r433288138", "bodyText": "nit:since this error message is user facing - do you think we should modify the constructor take in an error code, and generate the message in this class?\nThat would make it less error prone for another dev to pass in sensitive information as part of the error message.\nThis suggestion might be over-engineering. Feel free to ignore.", "author": "suneet-s", "createdAt": "2020-06-01T15:02:40Z", "path": "processing/src/main/java/org/apache/druid/query/UnsupportedQueryException.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class UnsupportedQueryException extends QueryException\n+{\n+  private static final String ERROR_CLASS = UnsupportedQueryException.class.getName();\n+  public static final String ERROR_CODE = \"Unsupported query\";\n+\n+  public UnsupportedQueryException(String errorMessage)", "originalCommit": "a8a3d2aac6eb10a9b69384175bf74a28f9942f41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI0MjA3OA==", "url": "https://github.com/apache/druid/pull/9948#discussion_r434242078", "bodyText": "I feel like keeping an error code to error message mapping will be a pain. There is not a well define set of error code. We can have an unbound number of query type / query feature we don't support. This list would always go up (as we add more functionality) and down (as we fix / iterate). The errorMessage should just indicate what feature exactly is not supported.", "author": "maytasm", "createdAt": "2020-06-03T00:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4ODEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4OTc4Nw==", "url": "https://github.com/apache/druid/pull/9948#discussion_r433289787", "bodyText": "CI is complaining about an un-used return value \ud83e\udd14 Same on line 99", "author": "suneet-s", "createdAt": "2020-06-01T15:05:40Z", "path": "processing/src/test/java/org/apache/druid/segment/join/table/IndexedTableJoinMatcherTest.java", "diffHunk": "@@ -48,12 +54,51 @@\n   {\n     public static class MakeDimensionProcessorTest\n     {\n+      @Mock\n+      private DimensionSelector dimensionSelector;\n+\n       private static final String KEY = \"key\";\n \n       static {\n         NullHandling.initializeForTests();\n       }\n \n+      @Test(expected = UnsupportedQueryException.class)\n+      public void testMatchMultiValuedRowCardinalityUnknownShouldThrowException()\n+      {\n+        MockitoAnnotations.initMocks(this);\n+        ArrayBasedIndexedInts row = new ArrayBasedIndexedInts(new int[]{2, 4, 6});\n+        Mockito.doReturn(row).when(dimensionSelector).getRow();\n+        Mockito.doReturn(DimensionDictionarySelector.CARDINALITY_UNKNOWN).when(dimensionSelector).getValueCardinality();\n+\n+        IndexedTableJoinMatcher.ConditionMatcherFactory conditionMatcherFactory =\n+            new IndexedTableJoinMatcher.ConditionMatcherFactory(\n+                ValueType.STRING,\n+                IndexedTableJoinMatcherTest::createSingletonIntList\n+            );\n+        Supplier<IntIterator> dimensionProcessor = conditionMatcherFactory.makeDimensionProcessor(dimensionSelector, false);\n+        // Test match should throw exception\n+        dimensionProcessor.get();", "originalCommit": "a8a3d2aac6eb10a9b69384175bf74a28f9942f41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1MTM5Nw==", "url": "https://github.com/apache/druid/pull/9948#discussion_r434251397", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-06-03T00:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4OTc4Nw=="}], "type": "inlineReview"}, {"oid": "8321856945404896f77ff7d3df8129d3798d87f8", "url": "https://github.com/apache/druid/commit/8321856945404896f77ff7d3df8129d3798d87f8", "message": "address comments", "committedDate": "2020-06-03T00:57:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NDYwNQ==", "url": "https://github.com/apache/druid/pull/9948#discussion_r434254605", "bodyText": "nit: grammar\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * following reasons: 1) The query is not supported yet. 2) The query is not something Druid would ever supports.\n          \n          \n            \n             * following reasons: 1) The query is not supported yet. 2) The query is not something Druid would ever support.", "author": "suneet-s", "createdAt": "2020-06-03T01:05:18Z", "path": "processing/src/main/java/org/apache/druid/query/QueryUnsupportedException.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import javax.annotation.Nullable;\n+import java.net.InetAddress;\n+\n+/**\n+ * This exception is for the query engine to surface when a query cannot be run. This can be due to the\n+ * following reasons: 1) The query is not supported yet. 2) The query is not something Druid would ever supports.", "originalCommit": "8321856945404896f77ff7d3df8129d3798d87f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f7483a89385efd3292c74b8ecc0a79790434a67d", "url": "https://github.com/apache/druid/commit/f7483a89385efd3292c74b8ecc0a79790434a67d", "message": "add tests", "committedDate": "2020-06-03T10:37:08Z", "type": "commit"}]}