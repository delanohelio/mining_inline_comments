{"pr_number": 10551, "pr_title": "Remove hard limitation that druid(after 0.15.0) only can consume Kafka version 0.11.x or better", "pr_createdAt": "2020-11-03T09:40:32Z", "pr_url": "https://github.com/apache/druid/pull/10551", "timeline": [{"oid": "5e1e6964a6abac81ee6cb0888415bff6593add5d", "url": "https://github.com/apache/druid/commit/5e1e6964a6abac81ee6cb0888415bff6593add5d", "message": "remove build in kafka consumer config :", "committedDate": "2020-11-03T08:51:31Z", "type": "commit"}, {"oid": "ac6dd037a910461462ee9c1e9994176c4c7aab4c", "url": "https://github.com/apache/druid/commit/ac6dd037a910461462ee9c1e9994176c4c7aab4c", "message": "modify druid docs of kafka indexing service", "committedDate": "2020-11-03T09:03:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NDc0MQ==", "url": "https://github.com/apache/druid/pull/10551#discussion_r518654741", "bodyText": "I think to remove isolation.level here and leaves the configuration to users changes the current behavior.\nCurrently users care nothing about this kafka configuration when using a higher version of kafka such as 0.11. By removing it, they need to set this property in supervisor spec,  or the default value, which is read_uncommitted, will be applied, which may be not what they expect.\nIf this is the root cause that limits the Druid to use Kafka lower than 0.11, I think maybe we can introduce another property, as the same way as pollTimeout property does, then we can unset isolation.level property according to the value of this new property. Only those who want to use Druid with older kafka  need to set this new property.", "author": "FrankChen021", "createdAt": "2020-11-06T10:19:28Z", "path": "extensions-core/kafka-indexing-service/src/main/java/org/apache/druid/indexing/kafka/KafkaConsumerConfigs.java", "diffHunk": "@@ -38,7 +38,6 @@\n     props.put(\"group.id\", StringUtils.format(\"kafka-supervisor-%s\", IdUtils.getRandomId()));\n     props.put(\"auto.offset.reset\", \"none\");\n     props.put(\"enable.auto.commit\", \"false\");\n-    props.put(\"isolation.level\", \"read_committed\");", "originalCommit": "ac6dd037a910461462ee9c1e9994176c4c7aab4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc4MDg5Mw==", "url": "https://github.com/apache/druid/pull/10551#discussion_r518780893", "bodyText": "Yes,  It will change the current behavior.\nYou are right, most people really don't care this Kafka configuration(Let it be default behavior). As I know the default logic of the Kafka Producer is not to enable transactions feature and the same as Kafka Consumer. So that maybe Druid Kafka indexing service keep the same default logic is more reasonable.\nFurthermore, if a Druid user want Druid to consume transactional Kafka topics, I think it is more reasonable to let users set this parameter in consumerProperties like 'bootstrap.servers' because he knows what he is going to do and why.\nBy the way, Druid from 0.15 to better can't consume old version Kafka is really confused me(I believe it's not just me). Generally speaking, higher Kafka consumer client is able to consume old version Kafka cluster unless it involves high-version-specific api. And this hard limitation block us to upgrade Druid cluster from 0.14.2 for a long time. If we don't remove this config, we have to upgrade PRD Kafka cluster, which is a much more heavy work to do because there are too many consumers of Kafka such as Spark and Flink. Orz...\nThanks for reviewing!", "author": "zhangyue19921010", "createdAt": "2020-11-06T14:20:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NDc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUxOTYyOQ==", "url": "https://github.com/apache/druid/pull/10551#discussion_r519519629", "bodyText": "We don't know whether or not the users have enabled transactional message in their clusters, so changing the current behavior may cause backward compatibility problem.", "author": "FrankChen021", "createdAt": "2020-11-09T02:19:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NDc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYwMzM2Mg==", "url": "https://github.com/apache/druid/pull/10551#discussion_r519603362", "bodyText": "Make sense! I add a new property named consumeTransactionally in consumerProperties, which is a Kafka consumer level property to control isolation.level.\nIf users don't set consumeTransactionally or set consumeTransactionally true, druid will consume Kafka Transactionally by default.\nSet consumeTransactionally false here can disable druid to consume Kafka Transactionally through unset isolation.level property, which means druid can consume lower version of Kafka now like 0.10.x\nIn this way, we don't change current Druid default behavior and provide a way to let druid consume lower version Kafka.", "author": "zhangyue19921010", "createdAt": "2020-11-09T07:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NDc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE5MTExOA==", "url": "https://github.com/apache/druid/pull/10551#discussion_r521191118", "bodyText": "@FrankChen021  Hi Frank, sorry to bother you. I have tested this change in our Druid cluster recently. What should I do next ?", "author": "zhangyue19921010", "createdAt": "2020-11-11T08:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NDc0MQ=="}], "type": "inlineReview"}, {"oid": "1a2fddbce4d75930f6e36dd64baca7d8bca48365", "url": "https://github.com/apache/druid/commit/1a2fddbce4d75930f6e36dd64baca7d8bca48365", "message": "Merge branch 'master' into modify-kafka-Version", "committedDate": "2020-11-09T02:36:43Z", "type": "commit"}, {"oid": "2b7b6f8a4acfbf95fd5e487ca95a052b09146dfc", "url": "https://github.com/apache/druid/commit/2b7b6f8a4acfbf95fd5e487ca95a052b09146dfc", "message": "Merge branch 'master' into modify-kafka-Version", "committedDate": "2020-11-12T03:08:40Z", "type": "commit"}, {"oid": "885985a3a7d8494725e3a69f2b995df392a8214d", "url": "https://github.com/apache/druid/commit/885985a3a7d8494725e3a69f2b995df392a8214d", "message": "yuezhang", "committedDate": "2020-11-12T03:40:50Z", "type": "commit"}, {"oid": "885985a3a7d8494725e3a69f2b995df392a8214d", "url": "https://github.com/apache/druid/commit/885985a3a7d8494725e3a69f2b995df392a8214d", "message": "yuezhang", "committedDate": "2020-11-12T03:40:50Z", "type": "forcePushed"}, {"oid": "1b4d4d86ff3833058c2609b2f767e6facf1480e0", "url": "https://github.com/apache/druid/commit/1b4d4d86ff3833058c2609b2f767e6facf1480e0", "message": "modify doc", "committedDate": "2020-11-12T05:01:02Z", "type": "commit"}, {"oid": "7b37c2bc09d657e9825b90bc73fc8c2a9c8c97d0", "url": "https://github.com/apache/druid/commit/7b37c2bc09d657e9825b90bc73fc8c2a9c8c97d0", "message": "Merge branch 'master' into modify-kafka-Version", "committedDate": "2020-11-17T08:36:08Z", "type": "commit"}, {"oid": "99e9b028d52622418974e4275c58c56e65c92c2c", "url": "https://github.com/apache/druid/commit/99e9b028d52622418974e4275c58c56e65c92c2c", "message": "modify docs", "committedDate": "2020-11-17T09:16:45Z", "type": "commit"}, {"oid": "808056c8163e7a03aedf227b4eb45fbb600f5589", "url": "https://github.com/apache/druid/commit/808056c8163e7a03aedf227b4eb45fbb600f5589", "message": "fix kafkaindexTaskTest.java", "committedDate": "2020-11-17T10:26:22Z", "type": "commit"}, {"oid": "8ed2ef72b460e215d7ce710aac829e5e97e87a9c", "url": "https://github.com/apache/druid/commit/8ed2ef72b460e215d7ce710aac829e5e97e87a9c", "message": "Merge branch 'master' into modify-kafka-Version", "committedDate": "2020-11-18T02:05:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU0OTc2OA==", "url": "https://github.com/apache/druid/pull/10551#discussion_r526549768", "bodyText": "please revert this unnecessary change", "author": "FrankChen021", "createdAt": "2020-11-19T02:23:15Z", "path": "extensions-core/kafka-indexing-service/src/main/java/org/apache/druid/indexing/kafka/KafkaRecordSupplier.java", "diffHunk": "@@ -37,6 +37,7 @@\n import org.apache.kafka.common.serialization.Deserializer;\n \n import javax.annotation.Nonnull;\n+", "originalCommit": "8ed2ef72b460e215d7ce710aac829e5e97e87a9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY4NzYwMg==", "url": "https://github.com/apache/druid/pull/10551#discussion_r526687602", "bodyText": "Done.", "author": "zhangyue19921010", "createdAt": "2020-11-19T08:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU0OTc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU1MDAwNw==", "url": "https://github.com/apache/druid/pull/10551#discussion_r526550007", "bodyText": "please revert this unnecessary change", "author": "FrankChen021", "createdAt": "2020-11-19T02:23:58Z", "path": "extensions-core/kafka-indexing-service/src/test/java/org/apache/druid/indexing/kafka/supervisor/KafkaSupervisorTest.java", "diffHunk": "@@ -2445,7 +2446,9 @@ public void testCheckpointForInactiveTaskGroup()\n     final TaskLocation location2 = new TaskLocation(\"testHost2\", 145, -1);\n     Collection workItems = new ArrayList<>();\n     workItems.add(new TestTaskRunnerWorkItem(id1, null, location1));\n+", "originalCommit": "8ed2ef72b460e215d7ce710aac829e5e97e87a9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY4NzY2OQ==", "url": "https://github.com/apache/druid/pull/10551#discussion_r526687669", "bodyText": "Done.", "author": "zhangyue19921010", "createdAt": "2020-11-19T08:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU1MDAwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU1MDAyNg==", "url": "https://github.com/apache/druid/pull/10551#discussion_r526550026", "bodyText": "please revert this unnecessary change", "author": "FrankChen021", "createdAt": "2020-11-19T02:24:01Z", "path": "extensions-core/kafka-indexing-service/src/test/java/org/apache/druid/indexing/kafka/supervisor/KafkaSupervisorTest.java", "diffHunk": "@@ -2445,7 +2446,9 @@ public void testCheckpointForInactiveTaskGroup()\n     final TaskLocation location2 = new TaskLocation(\"testHost2\", 145, -1);\n     Collection workItems = new ArrayList<>();\n     workItems.add(new TestTaskRunnerWorkItem(id1, null, location1));\n+\n     workItems.add(new TestTaskRunnerWorkItem(id2, null, location2));\n+", "originalCommit": "8ed2ef72b460e215d7ce710aac829e5e97e87a9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY4NzcyMQ==", "url": "https://github.com/apache/druid/pull/10551#discussion_r526687721", "bodyText": "Done.", "author": "zhangyue19921010", "createdAt": "2020-11-19T08:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU1MDAyNg=="}], "type": "inlineReview"}, {"oid": "108d7b62e688a3ada0a37c73936ac4258f744d35", "url": "https://github.com/apache/druid/commit/108d7b62e688a3ada0a37c73936ac4258f744d35", "message": "revert uncessary change", "committedDate": "2020-11-19T02:32:34Z", "type": "commit"}, {"oid": "40ddf14bdd912e6b24837101424ca350ec98c9f3", "url": "https://github.com/apache/druid/commit/40ddf14bdd912e6b24837101424ca350ec98c9f3", "message": "Merge branch 'master' into modify-kafka-Version", "committedDate": "2020-11-19T02:33:42Z", "type": "commit"}, {"oid": "827a43ac31b0498137260b10c0b10fd29496c9ed", "url": "https://github.com/apache/druid/commit/827a43ac31b0498137260b10c0b10fd29496c9ed", "message": "add more logs and modify docs", "committedDate": "2020-11-23T05:42:14Z", "type": "commit"}, {"oid": "a057e6b5e67d5492e01f87d8c8ba72bcb656eaa2", "url": "https://github.com/apache/druid/commit/a057e6b5e67d5492e01f87d8c8ba72bcb656eaa2", "message": "Merge branch 'master' into modify-kafka-Version", "committedDate": "2020-11-23T05:42:18Z", "type": "commit"}, {"oid": "44a68ca3713388265a8d9e6ec79fdc7dabbf7b9a", "url": "https://github.com/apache/druid/commit/44a68ca3713388265a8d9e6ec79fdc7dabbf7b9a", "message": "revert jdk version", "committedDate": "2020-11-23T05:43:16Z", "type": "commit"}, {"oid": "711f692705fb06389bfd38c20bd878eb07aee893", "url": "https://github.com/apache/druid/commit/711f692705fb06389bfd38c20bd878eb07aee893", "message": "modify docs", "committedDate": "2020-11-23T06:31:48Z", "type": "commit"}, {"oid": "f4e31af7243a74205a9ab1c6b70d78dcb694e0df", "url": "https://github.com/apache/druid/commit/f4e31af7243a74205a9ab1c6b70d78dcb694e0df", "message": "modify-kafka-version v2", "committedDate": "2020-12-01T05:43:20Z", "type": "commit"}, {"oid": "48ec54caac43322a7c96112cd6782654e2e9d2c0", "url": "https://github.com/apache/druid/commit/48ec54caac43322a7c96112cd6782654e2e9d2c0", "message": "v2", "committedDate": "2020-12-01T05:59:03Z", "type": "commit"}, {"oid": "5f411718ca40901e8e9b5aa3a346be7002e92fd6", "url": "https://github.com/apache/druid/commit/5f411718ca40901e8e9b5aa3a346be7002e92fd6", "message": "modify docs", "committedDate": "2020-12-01T06:47:54Z", "type": "commit"}, {"oid": "57761199f7dac7b35d20ea6b3a07f4fd831b597d", "url": "https://github.com/apache/druid/commit/57761199f7dac7b35d20ea6b3a07f4fd831b597d", "message": "modify docs", "committedDate": "2020-12-01T09:47:19Z", "type": "commit"}, {"oid": "061cac5f4f8172a0558da0b162fc2babacff2290", "url": "https://github.com/apache/druid/commit/061cac5f4f8172a0558da0b162fc2babacff2290", "message": "modify docs", "committedDate": "2020-12-01T09:50:56Z", "type": "commit"}, {"oid": "8201b0b2ca8b74d2a209186708a9b55aa5cfcc57", "url": "https://github.com/apache/druid/commit/8201b0b2ca8b74d2a209186708a9b55aa5cfcc57", "message": "modify docs", "committedDate": "2020-12-01T13:08:20Z", "type": "commit"}, {"oid": "69b4d409de14cb83305e5d94e87751542256aa12", "url": "https://github.com/apache/druid/commit/69b4d409de14cb83305e5d94e87751542256aa12", "message": "modify docs", "committedDate": "2020-12-01T13:21:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyNzQ2Ng==", "url": "https://github.com/apache/druid/pull/10551#discussion_r533827466", "bodyText": "it would likely be simpler to leave this alone, remove the line props.put(\"isolation.level\".. altogether\nand put something like  props.put(\"isolation.level\", customerConsumerProperties.getOrDefault(\"isolation.level\", \"read_committed\"));  right after https://github.com/apache/druid/blob/master/extensions-core/kafka-indexing-service/src/main/java/org/apache/druid/indexing/kafka/supervisor/KafkaSupervisorIOConfig.java#L78", "author": "himanshug", "createdAt": "2020-12-02T01:07:53Z", "path": "extensions-core/kafka-indexing-service/src/main/java/org/apache/druid/indexing/kafka/KafkaConsumerConfigs.java", "diffHunk": "@@ -31,14 +31,14 @@\n public class KafkaConsumerConfigs\n {\n \n-  public static Map<String, Object> getConsumerProperties()\n+  public static Map<String, Object> getConsumerProperties(Map<String, Object> customerConsumerProperties)", "originalCommit": "8201b0b2ca8b74d2a209186708a9b55aa5cfcc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI5NzUxOA==", "url": "https://github.com/apache/druid/pull/10551#discussion_r535297518", "bodyText": "Hi @himanshug Thanks for your review!\nI agree with it would likely be simpler to leave this alone, remove the line props.put(\"isolation.level\".. altogether.  But I think maybe it is not very appropriate to modify https://github.com/apache/druid/blob/master/extensions-core/kafka-indexing-service/src/main/java/org/apache/druid/indexing/kafka/supervisor/KafkaSupervisorIOConfig.java#L78\nI have tried to do changes in  KafkaSupervisorIOConfig.java as you said (cc59d8b)\n    this.consumerProperties = Preconditions.checkNotNull(consumerProperties, \"consumerProperties\");\n    consumerProperties.putIfAbsent(\"isolation.level\", \"read_committed\");\n    Preconditions.checkNotNull(\n\nand functional testing is fine while UT is failed at \n  \n    \n      druid/extensions-core/kafka-indexing-service/src/test/java/org/apache/druid/indexing/kafka/KafkaIOConfigTest.java\n    \n    \n         Line 363\n      in\n      ac6d703\n    \n    \n    \n    \n\n        \n          \n           Assert.assertEquals(oldConfig.getConsumerProperties(), currentConfig.getConsumerProperties()); \n        \n    \n  \n\n and \n  \n    \n      druid/extensions-core/kafka-indexing-service/src/test/java/org/apache/druid/indexing/kafka/KafkaIOConfigTest.java\n    \n    \n         Line 332\n      in\n      ac6d703\n    \n    \n    \n    \n\n        \n          \n           Assert.assertEquals(currentConfig.getConsumerProperties(), oldConfig.getConsumerProperties()); \n        \n    \n  \n\n\nThese failure means changes in KafkaSupervisorIOConfig may cause compatibility issues when deserialize from old IoConfig to new IoConfig or deserialize from new IoConfig to old IoConfig. In other words, we need to ensure that the deserialize between new IoConfig and old IoConfig is completely consistent and smooth.\nSo I switched to a safer way in the latest commit.\nAll the changes is tested on Dev cluster.\nPTAL :)", "author": "zhangyue19921010", "createdAt": "2020-12-03T14:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyNzQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc1OTM1OQ==", "url": "https://github.com/apache/druid/pull/10551#discussion_r535759359", "bodyText": "we need to ensure that the deserialize between new IoConfig and old IoConfig is completely consistent and smooth\n\nwell, my main concern was the consumeTransactionally param which has been removed . Though I fail to see why simply adding the default to KafkaSupervisorIOConfig.java would not have same behavior functionally (or for backward compatibility as well)... but I am not so worried about the specifics at this point as it is easy to change later if needed.", "author": "himanshug", "createdAt": "2020-12-04T01:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyNzQ2Ng=="}], "type": "inlineReview"}, {"oid": "cc59d8bbe0175faa269a4bdc06a24f13f6dd220c", "url": "https://github.com/apache/druid/commit/cc59d8bbe0175faa269a4bdc06a24f13f6dd220c", "message": "done", "committedDate": "2020-12-03T04:45:02Z", "type": "commit"}, {"oid": "765ebbb566f747f34bb05cca5446a62a759e5aee", "url": "https://github.com/apache/druid/commit/765ebbb566f747f34bb05cca5446a62a759e5aee", "message": "Merge branch 'master' into modify-kafka-Version", "committedDate": "2020-12-03T04:46:40Z", "type": "commit"}, {"oid": "8197b13bd2e66770297f0e6616073973cc9e9abc", "url": "https://github.com/apache/druid/commit/8197b13bd2e66770297f0e6616073973cc9e9abc", "message": "remove useless import", "committedDate": "2020-12-03T04:48:25Z", "type": "commit"}, {"oid": "2a457d59c202e1a446ddbc53f198849d47cf59fb", "url": "https://github.com/apache/druid/commit/2a457d59c202e1a446ddbc53f198849d47cf59fb", "message": "change code and add UT", "committedDate": "2020-12-03T14:09:32Z", "type": "commit"}, {"oid": "da8df86dade125fdd369800e6e4ce787fd558b5c", "url": "https://github.com/apache/druid/commit/da8df86dade125fdd369800e6e4ce787fd558b5c", "message": "Merge branch 'master' into modify-kafka-Version", "committedDate": "2020-12-03T14:13:46Z", "type": "commit"}, {"oid": "3055978074bce8fa960d55d3565e27e9ebc9b65e", "url": "https://github.com/apache/druid/commit/3055978074bce8fa960d55d3565e27e9ebc9b65e", "message": "Merge branch 'modify-kafka-Version' of https://github.com/zhangyue19921010/druid into modify-kafka-Version", "committedDate": "2020-12-03T14:14:04Z", "type": "commit"}]}