{"pr_number": 9533, "pr_title": "Broker: Add ability to inline subqueries.", "pr_createdAt": "2020-03-18T05:24:42Z", "pr_url": "https://github.com/apache/druid/pull/9533", "timeline": [{"oid": "91ea2e9a760e3724a0584ae117d936c20a52ec37", "url": "https://github.com/apache/druid/commit/91ea2e9a760e3724a0584ae117d936c20a52ec37", "message": "Broker: Add ability to inline subqueries.\n\nThe main changes:\n\n- ClientQuerySegmentWalker: Add ability to inline queries.\n- Query: Add \"getSubQueryId\" and \"withSubQueryId\" methods.\n- QueryMetrics: Add \"subQueryId\" dimension.\n- ServerConfig: Add new \"maxSubqueryRows\" parameter, which is used by\n  ClientQuerySegmentWalker to limit how many rows can be inlined per\n  query.\n- IndexedTableJoinMatcher: Allow creating keys on top of unknown types,\n  by assuming they are strings. This is useful because not all types are\n  known for fields in query results.\n- InlineDataSource: Store RowSignature rather than component parts. Add\n  more zealous \"equals\" and \"hashCode\" methods to ease testing.\n- Moved QuerySegmentWalker test code from CalciteTests and\n  SpecificSegmentsQueryWalker in druid-sql to QueryStackTests in\n  druid-server. Use this to spin up a new ClientQuerySegmentWalkerTest.", "committedDate": "2020-03-18T05:23:11Z", "type": "commit"}, {"oid": "6f73c73aa1012c1f237d1e2e776e577e4e6c45d3", "url": "https://github.com/apache/druid/commit/6f73c73aa1012c1f237d1e2e776e577e4e6c45d3", "message": "Adjustments from CI.", "committedDate": "2020-03-18T15:00:26Z", "type": "commit"}, {"oid": "e6461d97086ae68042d75cfc6d6ba7c916e90a8f", "url": "https://github.com/apache/druid/commit/e6461d97086ae68042d75cfc6d6ba7c916e90a8f", "message": "Fix integration test.", "committedDate": "2020-03-18T16:32:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIwMTIxNg==", "url": "https://github.com/apache/druid/pull/9533#discussion_r394201216", "bodyText": "\ud83d\udc4d", "author": "clintropolis", "createdAt": "2020-03-18T09:16:31Z", "path": "benchmarks/src/test/java/org/apache/druid/benchmark/query/SqlBenchmark.java", "diffHunk": "@@ -183,20 +183,19 @@ public void setup()\n     log.info(\"Starting benchmark setup using cacheDir[%s], rows[%,d].\", segmentGenerator.getCacheDir(), rowsPerSegment);\n     final QueryableIndex index = segmentGenerator.generate(dataSegment, schemaInfo, Granularities.NONE, rowsPerSegment);\n \n-    final Pair<QueryRunnerFactoryConglomerate, Closer> conglomerate = CalciteTests.createQueryRunnerFactoryConglomerate();\n-    closer.register(conglomerate.rhs);\n+    final QueryRunnerFactoryConglomerate conglomerate = QueryStackTests.createQueryRunnerFactoryConglomerate(closer);", "originalCommit": "91ea2e9a760e3724a0584ae117d936c20a52ec37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUzNjE3OQ==", "url": "https://github.com/apache/druid/pull/9533#discussion_r394536179", "bodyText": "Please add @Nullable.", "author": "jihoonson", "createdAt": "2020-03-18T17:54:30Z", "path": "processing/src/main/java/org/apache/druid/query/InlineDataSource.java", "diffHunk": "@@ -104,13 +113,21 @@ public static InlineDataSource fromIterable(\n   @JsonProperty\n   public List<String> getColumnNames()\n   {\n-    return columnNames;\n+    return signature.getColumnNames();\n   }\n \n   @JsonProperty\n+  @JsonInclude(JsonInclude.Include.NON_NULL)", "originalCommit": "e6461d97086ae68042d75cfc6d6ba7c916e90a8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2NjQzNQ==", "url": "https://github.com/apache/druid/pull/9533#discussion_r394666435", "bodyText": "Good point, I'll add this in the next patch.", "author": "gianm", "createdAt": "2020-03-18T22:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUzNjE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0NzY4NA==", "url": "https://github.com/apache/druid/pull/9533#discussion_r394547684", "bodyText": "Maybe worth to add a javadoc explaining what is subQueryId and why we need it?", "author": "jihoonson", "createdAt": "2020-03-18T18:13:51Z", "path": "processing/src/main/java/org/apache/druid/query/Query.java", "diffHunk": "@@ -131,6 +131,11 @@\n   @Nullable\n   String getId();\n \n+  Query<T> withSubQueryId(String subQueryId);", "originalCommit": "e6461d97086ae68042d75cfc6d6ba7c916e90a8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2NjQ1OQ==", "url": "https://github.com/apache/druid/pull/9533#discussion_r394666459", "bodyText": "Good idea, I'll add this in the next patch.", "author": "gianm", "createdAt": "2020-03-18T22:05:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0NzY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMzQzNg==", "url": "https://github.com/apache/druid/pull/9533#discussion_r394613436", "bodyText": "Should this class be mentioned in ServerManager and CachingClusteredClient so that these classes are synced up?", "author": "jihoonson", "createdAt": "2020-03-18T20:16:05Z", "path": "server/src/test/java/org/apache/druid/server/TestClusterQuerySegmentWalker.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Lists;\n+import org.apache.druid.client.SegmentServerSelector;\n+import org.apache.druid.java.util.common.ISE;\n+import org.apache.druid.java.util.common.concurrent.Execs;\n+import org.apache.druid.java.util.common.guava.FunctionalIterable;\n+import org.apache.druid.java.util.common.guava.LazySequence;\n+import org.apache.druid.query.FinalizeResultsQueryRunner;\n+import org.apache.druid.query.NoopQueryRunner;\n+import org.apache.druid.query.Queries;\n+import org.apache.druid.query.Query;\n+import org.apache.druid.query.QueryContexts;\n+import org.apache.druid.query.QueryDataSource;\n+import org.apache.druid.query.QueryRunner;\n+import org.apache.druid.query.QueryRunnerFactory;\n+import org.apache.druid.query.QueryRunnerFactoryConglomerate;\n+import org.apache.druid.query.QuerySegmentWalker;\n+import org.apache.druid.query.QueryToolChest;\n+import org.apache.druid.query.SegmentDescriptor;\n+import org.apache.druid.query.TableDataSource;\n+import org.apache.druid.query.planning.DataSourceAnalysis;\n+import org.apache.druid.query.spec.SpecificSegmentQueryRunner;\n+import org.apache.druid.query.spec.SpecificSegmentSpec;\n+import org.apache.druid.segment.ReferenceCountingSegment;\n+import org.apache.druid.segment.Segment;\n+import org.apache.druid.segment.join.JoinableFactory;\n+import org.apache.druid.segment.join.Joinables;\n+import org.apache.druid.timeline.TimelineObjectHolder;\n+import org.apache.druid.timeline.VersionedIntervalTimeline;\n+import org.apache.druid.timeline.partition.PartitionChunk;\n+import org.apache.druid.timeline.partition.PartitionHolder;\n+import org.joda.time.Interval;\n+\n+import javax.annotation.Nullable;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.function.Function;\n+\n+/**\n+ * Mimics the behavior of {@link org.apache.druid.client.CachingClusteredClient} when it queries data servers (like\n+ * Historicals, which use {@link org.apache.druid.server.coordination.ServerManager}). Used by {@link QueryStackTests}.\n+ *\n+ * This class's logic is like a mashup of those two classes. With the right abstractions, it may be possible to get rid\n+ * of this class and replace it with the production classes.", "originalCommit": "e6461d97086ae68042d75cfc6d6ba7c916e90a8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2NjQ4NQ==", "url": "https://github.com/apache/druid/pull/9533#discussion_r394666485", "bodyText": "I'll add this in the next patch.", "author": "gianm", "createdAt": "2020-03-18T22:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMzQzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxNDg0NQ==", "url": "https://github.com/apache/druid/pull/9533#discussion_r394614845", "bodyText": "this should probably be added to the documentation", "author": "clintropolis", "createdAt": "2020-03-18T20:18:40Z", "path": "server/src/main/java/org/apache/druid/server/initialization/ServerConfig.java", "diffHunk": "@@ -100,6 +103,10 @@ public ServerConfig()\n   @Min(1)\n   private long maxScatterGatherBytes = Long.MAX_VALUE;\n \n+  @JsonProperty\n+  @Min(1)\n+  private int maxSubqueryRows = 100000;", "originalCommit": "e6461d97086ae68042d75cfc6d6ba7c916e90a8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxNTMyNw==", "url": "https://github.com/apache/druid/pull/9533#discussion_r394615327", "bodyText": "Oh yeah, good point.", "author": "jihoonson", "createdAt": "2020-03-18T20:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxNDg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyODkzOQ==", "url": "https://github.com/apache/druid/pull/9533#discussion_r394628939", "bodyText": "I'm hoping to update all the docs at once in a future patch", "author": "gianm", "createdAt": "2020-03-18T20:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxNDg0NQ=="}], "type": "inlineReview"}]}