{"pr_number": 9247, "pr_title": "Add JoinableFactory interface and use it in the query stack.", "pr_createdAt": "2020-01-23T22:11:22Z", "pr_url": "https://github.com/apache/druid/pull/9247", "timeline": [{"oid": "c627f78bc1b7c4b76bf71af61cd38525f981dfda", "url": "https://github.com/apache/druid/commit/c627f78bc1b7c4b76bf71af61cd38525f981dfda", "message": "Add JoinableFactory interface and use it in the query stack.\n\nAlso includes InlineJoinableFactory, which enables joining against\ninline datasources. This is the first patch where a basic join query\nactually works. It includes integration tests.", "committedDate": "2020-01-23T22:07:49Z", "type": "commit"}, {"oid": "b954a64cdefbd88aabecead3ce4408755bce8019", "url": "https://github.com/apache/druid/commit/b954a64cdefbd88aabecead3ce4408755bce8019", "message": "Fix test issues.", "committedDate": "2020-01-24T00:54:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwMjg4Mw==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370702883", "bodyText": "javadocs for utility function please :)", "author": "suneet-s", "createdAt": "2020-01-24T15:47:56Z", "path": "core/src/main/java/org/apache/druid/utils/JvmUtils.java", "diffHunk": "@@ -80,13 +82,25 @@ public static long safeGetThreadCpuTime()\n    * @return total CPU time for the current thread in nanoseconds.\n    *\n    * @throws UnsupportedOperationException if the Java virtual machine does not support CPU time measurement for\n-   * the current thread.\n+   *                                       the current thread.\n    */\n   public static long getCurrentThreadCpuTime()\n   {\n     return THREAD_MX_BEAN.getCurrentThreadCpuTime();\n   }\n \n+  public static <T> T safeAccumulateThreadCpuTime(final AtomicLong accumulator, final Supplier<T> function)", "originalCommit": "b954a64cdefbd88aabecead3ce4408755bce8019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyMTQwMg==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370721402", "bodyText": "\ud83d\udc4d", "author": "gianm", "createdAt": "2020-01-24T16:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwMjg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwODYzOA==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370708638", "bodyText": "Just noticed this pattern in a few files. It would be nice if this was abstracted away from the IndexTask and there was some factory that knew which fields to use from the toolbox to build the Appenderator.\nObviously this doesn't need to be part of your change. Do  you usually create issues in github to track refactoring like this that would be nice to have?", "author": "suneet-s", "createdAt": "2020-01-24T15:58:30Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/seekablestream/SeekableStreamIndexTask.java", "diffHunk": "@@ -206,6 +206,7 @@ public Appenderator newAppenderator(FireDepartmentMetrics metrics, TaskToolbox t\n         toolbox.getSegmentAnnouncer(),\n         toolbox.getEmitter(),\n         toolbox.getQueryExecutorService(),\n+        toolbox.getJoinableFactory(),", "originalCommit": "b954a64cdefbd88aabecead3ce4408755bce8019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyMTgwMw==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370721803", "bodyText": "Yes, GitHub issues are a good place to put stuff like this. I think there's even a 'refactoring' label so the ideas can be searched.", "author": "gianm", "createdAt": "2020-01-24T16:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwODYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwOTMwNw==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370709307", "bodyText": "I think you want to use the joinableFactory here?", "author": "suneet-s", "createdAt": "2020-01-24T15:59:44Z", "path": "indexing-service/src/test/java/org/apache/druid/indexing/common/task/TestAppenderatorsManager.java", "diffHunk": "@@ -78,6 +81,7 @@ public Appenderator createRealtimeAppenderatorForTask(\n         segmentAnnouncer,\n         emitter,\n         queryExecutorService,\n+        NoopJoinableFactory.INSTANCE,", "originalCommit": "b954a64cdefbd88aabecead3ce4408755bce8019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyMTk3Ng==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370721976", "bodyText": "Oops, yes, you're right.", "author": "gianm", "createdAt": "2020-01-24T16:25:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwOTMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxMzQxNA==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370713414", "bodyText": "Does this need to be thread safe?", "author": "suneet-s", "createdAt": "2020-01-24T16:08:10Z", "path": "processing/src/main/java/org/apache/druid/segment/ReferenceCounter.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.segment;\n+\n+import java.io.Closeable;\n+\n+/**\n+ * An interface to reference-counted objects. Used by {@link ReferenceCountingSegment}.\n+ */\n+public interface ReferenceCounter", "originalCommit": "b954a64cdefbd88aabecead3ce4408755bce8019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDczODEwNQ==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370738105", "bodyText": "Yes, it does. I'll add some comments for it.", "author": "gianm", "createdAt": "2020-01-24T16:57:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxMzQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxNTQ3NA==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370715474", "bodyText": "Make ReferenceCountingSegment implement ReferenceCounter. Then this function can just be return this;\nWhich also means less inner classes and less lines of code to read in a delta \ud83d\ude43", "author": "suneet-s", "createdAt": "2020-01-24T16:12:12Z", "path": "processing/src/main/java/org/apache/druid/segment/ReferenceCountingSegment.java", "diffHunk": "@@ -167,6 +166,30 @@ public void close()\n     }\n   }\n \n+  public ReferenceCounter referenceCounter()\n+  {\n+    return new ReferenceCounter()\n+    {\n+      @Override\n+      public boolean increment()\n+      {\n+        return ReferenceCountingSegment.this.increment();\n+      }\n+\n+      @Override\n+      public Closeable decrementOnceCloseable()\n+      {\n+        return ReferenceCountingSegment.this.decrementOnceCloseable();\n+      }\n+\n+      @Override\n+      public void decrement()\n+      {\n+        ReferenceCountingSegment.this.decrement();\n+      }\n+    };", "originalCommit": "b954a64cdefbd88aabecead3ce4408755bce8019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDczODUyNQ==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370738525", "bodyText": "Oh, great idea!", "author": "gianm", "createdAt": "2020-01-24T16:57:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxNTQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxNjM3NA==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370716374", "bodyText": "Does this mean we now allow joins on the time column?", "author": "suneet-s", "createdAt": "2020-01-24T16:13:58Z", "path": "processing/src/main/java/org/apache/druid/segment/join/HashJoinSegment.java", "diffHunk": "@@ -50,15 +49,9 @@ public HashJoinSegment(\n     this.baseSegment = baseSegment;\n     this.clauses = clauses;\n \n-    // Verify no clauses would shadow the special __time field.\n-    for (JoinableClause clause : clauses) {\n-      if (clause.includesColumn(ColumnHolder.TIME_COLUMN_NAME)) {", "originalCommit": "b954a64cdefbd88aabecead3ce4408755bce8019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDczOTE5NQ==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370739195", "bodyText": "Yes, we do, although that's not what this means. This same check is still being applied, but in the constructor of JoinableClause (it calls Joinables.validatePrefix).", "author": "gianm", "createdAt": "2020-01-24T16:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxNjM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxODU4NQ==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370718585", "bodyText": "note to self: Do these 2 need to be tightly coupled? DIg in a little more here", "author": "suneet-s", "createdAt": "2020-01-24T16:18:16Z", "path": "processing/src/main/java/org/apache/druid/query/ReferenceCountingSegmentQueryRunner.java", "diffHunk": "@@ -22,39 +22,41 @@\n import org.apache.druid.java.util.common.guava.Sequence;\n import org.apache.druid.java.util.common.guava.Sequences;\n import org.apache.druid.query.context.ResponseContext;\n-import org.apache.druid.segment.ReferenceCountingSegment;\n+import org.apache.druid.segment.ReferenceCounter;\n+import org.apache.druid.segment.Segment;\n \n-/**\n- */\n public class ReferenceCountingSegmentQueryRunner<T> implements QueryRunner<T>\n {\n   private final QueryRunnerFactory<T, Query<T>> factory;\n-  private final ReferenceCountingSegment adapter;\n+  private final Segment segment;\n+  private final ReferenceCounter segmentReferenceCounter;\n   private final SegmentDescriptor descriptor;\n \n   public ReferenceCountingSegmentQueryRunner(\n       QueryRunnerFactory<T, Query<T>> factory,\n-      ReferenceCountingSegment adapter,\n+      Segment segment,\n+      ReferenceCounter segmentReferenceCounter,", "originalCommit": "b954a64cdefbd88aabecead3ce4408755bce8019", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxODg5Nw==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370718897", "bodyText": "missing unit tests?", "author": "suneet-s", "createdAt": "2020-01-24T16:18:55Z", "path": "processing/src/main/java/org/apache/druid/segment/join/Joinables.java", "diffHunk": "@@ -52,4 +61,56 @@ public static boolean isPrefixedBy(final String columnName, final String prefix)\n   {\n     return columnName.startsWith(prefix) && columnName.length() > prefix.length();\n   }\n+\n+  /**\n+   * Creates a Function that maps base segments to {@link HashJoinSegment} if needed (i.e. if the number of join\n+   * clauses is > 0). If mapping is not needed, this method will return {@link Function#identity()}.\n+   *\n+   * @param clauses            pre-joinable clauses\n+   * @param joinableFactory    factory for joinables\n+   * @param cpuTimeAccumulator an accumulator that we will add CPU nanos to; this is part of the function to encourage\n+   *                           callers to remember to track metrics on CPU time required for creation of Joinables\n+   */\n+  public static Function<Segment, Segment> createSegmentMapFn(", "originalCommit": "b954a64cdefbd88aabecead3ce4408755bce8019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc1ODI3MQ==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370758271", "bodyText": "I'll add some. I'm thinking of adding tests that are a bit on the basic side, because full-on tests require a lot of scaffolding similar to HashJoinSegmentTest. I'm not sure if adding that here adds much value over the tests that are already in HashJoinSegmentTest. So I'm planning to focus on testing the functionality that HashJoinSegmentTest doesn't test (error conditions, special cases).\nLet me know what you think. If you think I should add more tests beyond the ones I'm about to add, please let me know.", "author": "gianm", "createdAt": "2020-01-24T17:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxODg5Nw=="}], "type": "inlineReview"}, {"oid": "8e8fd50ec08cba08569beb013b6ce636e5bef62e", "url": "https://github.com/apache/druid/commit/8e8fd50ec08cba08569beb013b6ce636e5bef62e", "message": "Adjustments from code review.", "committedDate": "2020-01-24T17:43:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc1NTI3MQ==", "url": "https://github.com/apache/druid/pull/9247#discussion_r370755271", "bodyText": "javadocs please.\nI'm a little confused why this is the \"Default\" and not just a delegating factory. Also since this is just one delegate, I think it would be easier to follow if there was just one factory instead of factories.\nWhen we add support for multiple factories, we can change this and think about how to decide precedence if more than one factory can build a joinable.", "author": "suneet-s", "createdAt": "2020-01-24T17:35:57Z", "path": "server/src/main/java/org/apache/druid/segment/join/DefaultJoinableFactory.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.segment.join;\n+\n+import com.google.inject.Inject;\n+import org.apache.druid.query.DataSource;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+\n+public class DefaultJoinableFactory implements JoinableFactory", "originalCommit": "b954a64cdefbd88aabecead3ce4408755bce8019", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}