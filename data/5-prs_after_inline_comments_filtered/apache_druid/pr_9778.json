{"pr_number": 9778, "pr_title": "Fix problem when running single integration test using -Dit.test=", "pr_createdAt": "2020-04-28T02:01:04Z", "pr_url": "https://github.com/apache/druid/pull/9778", "timeline": [{"oid": "bb03274fc6a10282b982a510008b6ee186f68412", "url": "https://github.com/apache/druid/commit/bb03274fc6a10282b982a510008b6ee186f68412", "message": "fix running single it", "committedDate": "2020-04-28T01:59:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkxNTIxNQ==", "url": "https://github.com/apache/druid/pull/9778#discussion_r416915215", "bodyText": "Seems like neither SuiteListener.onStart() nor runTests() throw an Exception. Is this for logging? I changed LoggerListener to print stack trace properly in my PR and this probably wouldn't be necessary.", "author": "jihoonson", "createdAt": "2020-04-28T20:53:38Z", "path": "integration-tests/src/main/java/org/testng/DruidTestRunnerFactory.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package /*CHECKSTYLE.OFF: PackageName*/org.testng/*CHECKSTYLE.ON: PackageName*/;\n+\n+import org.apache.druid.java.util.common.logger.Logger;\n+import org.apache.druid.testing.utils.SuiteListener;\n+import org.testng.internal.IConfiguration;\n+import org.testng.internal.Systematiser;\n+import org.testng.internal.annotations.IAnnotationFinder;\n+import org.testng.xml.XmlTest;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * This class must be in package org.testng to access protected methods like TestNG.getDefault().getConfiguration()\n+ */\n+public class DruidTestRunnerFactory implements ITestRunnerFactory\n+{\n+  private static final Logger LOG = new Logger(DruidTestRunnerFactory.class);\n+  private static final SuiteListener SUITE_LISTENER = new SuiteListener();\n+\n+  @Override\n+  public TestRunner newTestRunner(ISuite suite,\n+                                  XmlTest test,\n+                                  Collection<IInvokedMethodListener> methodListeners,\n+                                  List<IClassListener> classListeners)\n+  {\n+    IConfiguration configuration = TestNG.getDefault().getConfiguration();\n+    String outputDirectory = suite.getOutputDirectory();\n+    IAnnotationFinder annotationFinder = configuration.getAnnotationFinder();\n+    Boolean skipFailedInvocationCounts = suite.getXmlSuite().skipFailedInvocationCounts();\n+    return new DruidTestRunner(\n+        configuration,\n+        suite,\n+        test,\n+        outputDirectory,\n+        annotationFinder,\n+        skipFailedInvocationCounts,\n+        methodListeners,\n+        classListeners\n+    );\n+  }\n+\n+  private static class DruidTestRunner extends TestRunner\n+  {\n+    DruidTestRunner(\n+        IConfiguration configuration,\n+        ISuite suite,\n+        XmlTest test,\n+        String outputDirectory,\n+        IAnnotationFinder finder,\n+        boolean skipFailedInvocationCounts,\n+        Collection<IInvokedMethodListener> methodListeners,\n+        List<IClassListener> classListeners\n+    )\n+    {\n+      super(configuration, suite, test, outputDirectory, finder, skipFailedInvocationCounts, methodListeners, classListeners, Systematiser.getComparator(), Collections.emptyMap());\n+    }\n+\n+    @Override\n+    public void run()\n+    {\n+      try {\n+        // IntegrationTestSuite is run when -Dit.test is not specify in maven command.\n+        // IntegrationTestSuite uses the configuration from integration-tests/src/test/resources/testng.xml\n+        // which already handle suite onStart and onFinish automatically\n+        if (!\"IntegrationTestSuite\".equals(getSuite().getName())) {\n+          SUITE_LISTENER.onStart(getSuite());\n+        }\n+        runTests();\n+      }\n+      catch (Exception e) {\n+        LOG.error(e, \"\");", "originalCommit": "bb03274fc6a10282b982a510008b6ee186f68412", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk0MzQxOA==", "url": "https://github.com/apache/druid/pull/9778#discussion_r416943418", "bodyText": "Removed it.", "author": "maytasm", "createdAt": "2020-04-28T21:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkxNTIxNQ=="}], "type": "inlineReview"}, {"oid": "1d55645a514ec684ff49675bbffcc1dd4abcf873", "url": "https://github.com/apache/druid/commit/1d55645a514ec684ff49675bbffcc1dd4abcf873", "message": "fix checksyle", "committedDate": "2020-04-28T21:49:07Z", "type": "commit"}]}