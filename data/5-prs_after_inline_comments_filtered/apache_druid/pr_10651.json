{"pr_number": 10651, "pr_title": "fixed input source sampler buildReader exp", "pr_createdAt": "2020-12-07T16:37:24Z", "pr_url": "https://github.com/apache/druid/pull/10651", "timeline": [{"oid": "b203bf895d6a9fae2c2c26994c9b44dd8689ff24", "url": "https://github.com/apache/druid/commit/b203bf895d6a9fae2c2c26994c9b44dd8689ff24", "message": "fixed input source sampler buildReader exp", "committedDate": "2020-12-07T15:36:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzczMjEyNw==", "url": "https://github.com/apache/druid/pull/10651#discussion_r537732127", "bodyText": "@egor-ryashin Can you add a test that shows what happens when an error is thrown when building an InputSourceReader", "author": "suneet-s", "createdAt": "2020-12-07T18:29:53Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/overlord/sampler/InputSourceSampler.java", "diffHunk": "@@ -103,90 +103,102 @@ public SamplerResponse sample(\n     final File tempDir = FileUtils.createTempDir();\n     closer.register(() -> FileUtils.deleteDirectory(tempDir));\n \n-    final InputSourceReader reader = buildReader(\n-        nonNullSamplerConfig,\n-        nonNullDataSchema,\n-        inputSource,\n-        inputFormat,\n-        tempDir\n-    );\n-    try (final CloseableIterator<InputRowListPlusRawValues> iterator = reader.sample();\n-         final IncrementalIndex<Aggregator> index = buildIncrementalIndex(nonNullSamplerConfig, nonNullDataSchema);\n-         final Closer closer1 = closer) {\n-      List<SamplerResponseRow> responseRows = new ArrayList<>(nonNullSamplerConfig.getNumRows());\n-      int numRowsIndexed = 0;\n-\n-      while (responseRows.size() < nonNullSamplerConfig.getNumRows() && iterator.hasNext()) {\n-        final InputRowListPlusRawValues inputRowListPlusRawValues = iterator.next();\n-\n-        final List<Map<String, Object>> rawColumnsList = inputRowListPlusRawValues.getRawValuesList();\n-\n-        final ParseException parseException = inputRowListPlusRawValues.getParseException();\n-        if (parseException != null) {\n-          if (rawColumnsList != null) {\n-            // add all rows to response\n-            responseRows.addAll(rawColumnsList.stream()\n-                                              .map(rawColumns -> new SamplerResponseRow(rawColumns, null, true, parseException.getMessage()))\n-                                              .collect(Collectors.toList()));\n-          } else {\n-            // no data parsed, add one response row\n-            responseRows.add(new SamplerResponseRow(null, null, true, parseException.getMessage()));\n+    try {\n+      final InputSourceReader reader = buildReader(\n+          nonNullSamplerConfig,\n+          nonNullDataSchema,\n+          inputSource,\n+          inputFormat,\n+          tempDir\n+      );", "originalCommit": "b203bf895d6a9fae2c2c26994c9b44dd8689ff24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDgxNTM3Nw==", "url": "https://github.com/apache/druid/pull/10651#discussion_r560815377", "bodyText": "I guess that needs a UI test, unfortunately, it will take me more time than I have right now.", "author": "egor-ryashin", "createdAt": "2021-01-20T09:35:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzczMjEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0MDYxMw==", "url": "https://github.com/apache/druid/pull/10651#discussion_r562940613", "bodyText": "@egor-ryashin Why not write a unit test for this sample method that expects a SamplerException to be thrown when buildReader throws an exception. I think that would be sufficient to merge this change", "author": "suneet-s", "createdAt": "2021-01-22T22:06:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzczMjEyNw=="}], "type": "inlineReview"}, {"oid": "35d23f712dd21589f4819b7e41d63594a691c774", "url": "https://github.com/apache/druid/commit/35d23f712dd21589f4819b7e41d63594a691c774", "message": "sampler exception unit test", "committedDate": "2021-02-05T11:18:05Z", "type": "commit"}, {"oid": "03dcde314cd3cd104afe1cba537a162279e29bc5", "url": "https://github.com/apache/druid/commit/03dcde314cd3cd104afe1cba537a162279e29bc5", "message": "Merge branch 'master' into fix-iss-build-reader-exp", "committedDate": "2021-02-05T11:25:55Z", "type": "commit"}, {"oid": "b28cd1df91f0731dea5c7d5932c5a966ada98ff9", "url": "https://github.com/apache/druid/commit/b28cd1df91f0731dea5c7d5932c5a966ada98ff9", "message": "styling", "committedDate": "2021-02-05T11:27:21Z", "type": "commit"}]}