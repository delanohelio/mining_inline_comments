{"pr_number": 10379, "pr_title": "Adding task slot count metrics to Druid Overlord", "pr_createdAt": "2020-09-10T22:45:20Z", "pr_url": "https://github.com/apache/druid/pull/10379", "timeline": [{"oid": "af269ab4d2ae105894e3004fc9c6708968a276a5", "url": "https://github.com/apache/druid/commit/af269ab4d2ae105894e3004fc9c6708968a276a5", "message": "Adding more worker metrics to Druid Overlord", "committedDate": "2020-09-10T22:42:53Z", "type": "commit"}, {"oid": "90a7c72863531d509323fad403639993f7ba314f", "url": "https://github.com/apache/druid/commit/90a7c72863531d509323fad403639993f7ba314f", "message": "Changing the nomenclature from worker to peon as that represents the metrics that we want to monitor better", "committedDate": "2020-09-14T23:12:41Z", "type": "commit"}, {"oid": "c3292dc641e079fbd68ca861c10592095039b659", "url": "https://github.com/apache/druid/commit/c3292dc641e079fbd68ca861c10592095039b659", "message": "Few more instance of worker usage replaced with peon", "committedDate": "2020-09-14T23:20:14Z", "type": "commit"}, {"oid": "73e08eea8a6d4898785625d4e5d2e64295c1ae49", "url": "https://github.com/apache/druid/commit/73e08eea8a6d4898785625d4e5d2e64295c1ae49", "message": "Modifying the peon idle count logic to only use eligible workers available capacity", "committedDate": "2020-09-15T21:21:28Z", "type": "commit"}, {"oid": "df7ff187efcf70aa24bc8b69ab3b8dab9198b9eb", "url": "https://github.com/apache/druid/commit/df7ff187efcf70aa24bc8b69ab3b8dab9198b9eb", "message": "Changing the naming to task slot count instead of peon", "committedDate": "2020-09-15T23:58:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEyMzcyMg==", "url": "https://github.com/apache/druid/pull/10379#discussion_r489123722", "bodyText": "How about adding new interfaces such as TaskSlotCountable and WorkerCountable? Then, we can avoid implementing unnecessary interfaces, e.g., the new methods in SingleThreadedBackgroundRunner, by implementing required interfaces only.", "author": "jihoonson", "createdAt": "2020-09-16T02:27:08Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/overlord/TaskRunner.java", "diffHunk": "@@ -121,4 +121,17 @@ default TaskLocation getTaskLocation(String taskId)\n    * @return ScalingStats if the runner has an underlying resource which can scale, Optional.absent() otherwise\n    */\n   Optional<ScalingStats> getScalingStats();\n+\n+  /**\n+   * APIs useful for emitting statistics for @TaskSlotCountStatsMonitor\n+  */\n+  long getTotalTaskSlotCount();", "originalCommit": "df7ff187efcf70aa24bc8b69ab3b8dab9198b9eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3590ba8be86b21a85cf43815c6b90feac51cf040", "url": "https://github.com/apache/druid/commit/3590ba8be86b21a85cf43815c6b90feac51cf040", "message": "Adding some unit test coverage for the new test runner apis", "committedDate": "2020-09-18T05:52:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkzNTk3Mw==", "url": "https://github.com/apache/druid/pull/10379#discussion_r493935973", "bodyText": "I think this monitor should emit metrics only when TaskMaster is a leader. Check out what TaskCountStatsMonitor does. Probably new interfaces in TaskSlotCountStatsProvider should be able to return null when TaskMaster is not a leader.", "author": "jihoonson", "createdAt": "2020-09-23T22:44:31Z", "path": "server/src/main/java/org/apache/druid/server/metrics/TaskSlotCountStatsMonitor.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.metrics;\n+\n+import com.google.inject.Inject;\n+import org.apache.druid.java.util.emitter.service.ServiceEmitter;\n+import org.apache.druid.java.util.emitter.service.ServiceMetricEvent;\n+import org.apache.druid.java.util.metrics.AbstractMonitor;\n+\n+public class TaskSlotCountStatsMonitor extends AbstractMonitor\n+{\n+  private final TaskSlotCountStatsProvider statsProvider;\n+\n+  @Inject\n+  public TaskSlotCountStatsMonitor(\n+          TaskSlotCountStatsProvider statsProvider\n+  )\n+  {\n+    this.statsProvider = statsProvider;\n+  }\n+\n+  @Override\n+  public boolean doMonitor(ServiceEmitter emitter)\n+  {\n+    emit(emitter, \"taskSlot/total/count\", statsProvider.getTotalTaskSlotCount());", "originalCommit": "3590ba8be86b21a85cf43815c6b90feac51cf040", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3NDI4Ng==", "url": "https://github.com/apache/druid/pull/10379#discussion_r493974286", "bodyText": "This is controlled from TaskMaster and it is the same design as TaskCountStatsMonitor. If you check that code, taskRunner is only set if the current overlord is the leader https://github.com/apache/druid/blob/master/indexing-service/src/main/java/org/apache/druid/indexing/overlord/TaskMaster.java#L113. Then check the implementation of getSuccessfulTaskCount. It only returns a value if the taskRunner is set correctly or else null.", "author": "mghosh4", "createdAt": "2020-09-24T00:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkzNTk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk4MTQxOA==", "url": "https://github.com/apache/druid/pull/10379#discussion_r493981418", "bodyText": "Hmm, if I'm reading code correctly, TaskMaster.getTotalTaskSlotCount() still returns 0 even when it's not a leader. Then, the monitor will emit meaningless 0s for non-leaders.", "author": "jihoonson", "createdAt": "2020-09-24T01:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkzNTk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1NjY5MA==", "url": "https://github.com/apache/druid/pull/10379#discussion_r493956690", "bodyText": "Even though this method was always called under a lock on workerWithUnacknowledgedTask before, this change seems OK because it will still be called under the same lock in tryAssignTask, and the new caller getIdleTaskSlotCount doesn't seem to require locking (as it doesn't update the workerWithUnacknowledgedTask map.", "author": "jihoonson", "createdAt": "2020-09-23T23:43:26Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/overlord/RemoteTaskRunner.java", "diffHunk": "@@ -867,6 +857,18 @@ private boolean tryAssignTask(final Task task, final RemoteTaskRunnerWorkItem ta\n     }\n   }\n \n+  Map<String, ImmutableWorkerInfo> getWorkersEligibleToRunTasks()", "originalCommit": "3590ba8be86b21a85cf43815c6b90feac51cf040", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2MTY5OQ==", "url": "https://github.com/apache/druid/pull/10379#discussion_r493961699", "bodyText": "It seems OK without this synchronization.", "author": "jihoonson", "createdAt": "2020-09-23T23:53:56Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/overlord/hrtr/HttpRemoteTaskRunner.java", "diffHunk": "@@ -1342,6 +1343,13 @@ public TaskLocation getTaskLocation(String taskId)\n     ).collect(Collectors.toList());\n   }\n \n+  public Collection<ImmutableWorkerInfo> getBlackListedWorkers()\n+  {\n+    synchronized (blackListedWorkers) {", "originalCommit": "3590ba8be86b21a85cf43815c6b90feac51cf040", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2MjIwOQ==", "url": "https://github.com/apache/druid/pull/10379#discussion_r493962209", "bodyText": "Please clarify the Javadoc of these methods too. It should be the number of task slots of lazy/blacklisted middleManagers and indexers.", "author": "jihoonson", "createdAt": "2020-09-23T23:55:42Z", "path": "server/src/main/java/org/apache/druid/server/metrics/TaskSlotCountStatsProvider.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.metrics;\n+\n+public interface TaskSlotCountStatsProvider\n+{\n+  /**\n+   * Return the number of total task slots during emission period.\n+   */\n+  long getTotalTaskSlotCount();\n+\n+  /**\n+   * Return the number of idle task slots during emission period.\n+   */\n+  long getIdleTaskSlotCount();\n+\n+  /**\n+   * Return the number of used task slots during emission period.\n+   */\n+  long getUsedTaskSlotCount();\n+\n+  /**\n+   * Return the number of lazy task slots during emission period.\n+   */\n+  long getLazyTaskSlotCount();\n+\n+  /**\n+   * Return the number of blacklisted task slots during emission period.\n+   */\n+  long getBlacklistedTaskSlotCount();", "originalCommit": "3590ba8be86b21a85cf43815c6b90feac51cf040", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7a1673b47956449a230e65eb396360be7cc81637", "url": "https://github.com/apache/druid/commit/7a1673b47956449a230e65eb396360be7cc81637", "message": "Addressing Review Comments", "committedDate": "2020-09-24T01:05:11Z", "type": "commit"}, {"oid": "5a12eb773613bd409c4eea79b902dae67718b807", "url": "https://github.com/apache/druid/commit/5a12eb773613bd409c4eea79b902dae67718b807", "message": "Modifying the TaskSlotCountStatsProvider apis so that overlords which are not leader do not emit these metrics", "committedDate": "2020-09-24T02:26:13Z", "type": "commit"}, {"oid": "61343eb4995b94427816a168d4632e3112b245e2", "url": "https://github.com/apache/druid/commit/61343eb4995b94427816a168d4632e3112b245e2", "message": "Fixing the spelling issue in the docs", "committedDate": "2020-09-24T17:04:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxMTczOA==", "url": "https://github.com/apache/druid/pull/10379#discussion_r494511738", "bodyText": "Please annotate the return value with @Nullable. Same comment for other methods.", "author": "jihoonson", "createdAt": "2020-09-24T18:06:13Z", "path": "server/src/main/java/org/apache/druid/server/metrics/TaskSlotCountStatsProvider.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.metrics;\n+\n+public interface TaskSlotCountStatsProvider\n+{\n+  /**\n+   * Return the number of total task slots during emission period.\n+   */\n+  Long getTotalTaskSlotCount();", "originalCommit": "61343eb4995b94427816a168d4632e3112b245e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9a058cadbdb00bc1cdd2be2f57db67032e3030a9", "url": "https://github.com/apache/druid/commit/9a058cadbdb00bc1cdd2be2f57db67032e3030a9", "message": "Setting the annotation Nullable on the TaskSlotCountStatsProvider methods", "committedDate": "2020-09-24T19:00:16Z", "type": "commit"}]}