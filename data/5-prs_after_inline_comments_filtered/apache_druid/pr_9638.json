{"pr_number": 9638, "pr_title": "refactor internal type system", "pr_createdAt": "2020-04-07T10:27:15Z", "pr_url": "https://github.com/apache/druid/pull/9638", "timeline": [{"oid": "262aa0e5ff9533c52b6bb2688efbbc409c563cea", "url": "https://github.com/apache/druid/commit/262aa0e5ff9533c52b6bb2688efbbc409c563cea", "message": "better type tracking: add typed postaggs, finalized types for agg factories", "committedDate": "2020-04-07T06:01:40Z", "type": "commit"}, {"oid": "a27a4c8004bc391fdde7baf64dbc9e2375167741", "url": "https://github.com/apache/druid/commit/a27a4c8004bc391fdde7baf64dbc9e2375167741", "message": "more javadoc", "committedDate": "2020-04-07T11:07:14Z", "type": "commit"}, {"oid": "f2aa12f64a8291e256ac58e039837057f289822e", "url": "https://github.com/apache/druid/commit/f2aa12f64a8291e256ac58e039837057f289822e", "message": "adjustments", "committedDate": "2020-04-08T19:39:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5MTQ4Ng==", "url": "https://github.com/apache/druid/pull/9638#discussion_r405791486", "bodyText": "why do we need this one ?", "author": "himanshug", "createdAt": "2020-04-08T20:23:17Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/PostAggregator.java", "diffHunk": "@@ -43,6 +45,13 @@\n   @Nullable\n   String getName();\n \n+  String getTypeName();", "originalCommit": "f2aa12f64a8291e256ac58e039837057f289822e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxMTIyMA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r406011220", "bodyText": "Ah, good point, this isn't really used currently. Initially this was the only method I added to PostAggregator in this branch, along with getFinalizedTypeName to AggregatorFactory. However since the main users of getTypeName on AggregatorFactory (besides ComplexMetricSerde) and the only usages of these new methods, are converting to ValueType, I pivoted near completion to add the additional methods that just directly return the needed thing.\nI left it in because I sort of have a dream that one day ComplexMetrics will be rebranded into ComplexTypes to spiritually decouple it from Aggregators, but will still provide a mapping of all the getTypeName strings for aggs (and now maybe postaggs, and anything else?) that have ValueType.COMPLEX for getType to a serde as is now, forming a centralized registry for all complex types. Whether this is actually useful or not I am not yet totally certain, maybe just using jackson like we do now for everything that isn't part of a segment is enough; I think I will need to think a bit more about this, and maybe get deeper into some of the follow-up work before it will become fully apparent.\nShould I remove it for now since it isn't really being used other than as a vessel to convert to ValueType? I still find it sort of useful to make it super obvious what actual type is being spit out by the PostAggregator is since its significantly more descriptive than ValueType.COMPLEX, and easier than examining the output of the compute method closely, but I guess javadocs could accomplish the same thing.\nAt minimum I was still planning to add javadocs to this interface, so could document how it isn't really used, if you're cool with leaving it in for now, or I can remove. I'll try to think about this some more as well as I try to wrap up this PR.", "author": "clintropolis", "createdAt": "2020-04-09T07:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5MTQ4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQxOTY0OA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r406419648", "bodyText": "I think, it could be added in the PR that starts using it so as to remove any confusion unless there is a distinct advantage to adding it now that  I missed :)", "author": "himanshug", "createdAt": "2020-04-09T19:12:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5MTQ4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3ODQ5MA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472478490", "bodyText": "I have removed typeName from PostAggregators since it isn't necessary.\nBetween the changes here, changes in #10277, and some other recent changes I have made, it is almost starting to look to me that perhaps aggs and postaggs should just consider supplying ColumnCapabilities of their own instead of just types, but I'll save that for future consideration.", "author": "clintropolis", "createdAt": "2020-08-18T20:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5MTQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NzcxNA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r405797714", "bodyText": "can we add a blurb recommending this method be explicitly overridden by complex AggregatorFactory impls as the default here is likely wrong for those.", "author": "himanshug", "createdAt": "2020-04-08T20:34:40Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/AggregatorFactory.java", "diffHunk": "@@ -214,19 +216,42 @@ public AggregatorFactory getMergingFactory(AggregatorFactory other) throws Aggre\n    * {@link #deserialize} and the type accepted by {@link #combine}. However, it is *not* necessarily the same type\n    * returned by {@link #finalizeComputation}.\n    *\n-   * If the type is complex (i.e. not a simple, numeric {@link org.apache.druid.segment.column.ValueType}) then there\n+   * If the type is complex (i.e. not a simple, numeric {@link ValueType}) then there\n    * must be a corresponding {@link org.apache.druid.segment.serde.ComplexMetricSerde} which was registered with\n    * {@link org.apache.druid.segment.serde.ComplexMetrics#registerSerde} using this type name.\n    *\n-   * If you need a ValueType enum corresponding to this aggregator, a good way to do that is:\n-   *\n-   * <pre>\n-   *   Optional.ofNullable(GuavaUtils.getEnumIfPresent(ValueType.class, aggregator.getTypeName()))\n-   *           .orElse(ValueType.COMPLEX);\n-   * </pre>\n+   * If you need a ValueType enum corresponding to this aggregator, use {@link #getTypeName} instead.\n    */\n   public abstract String getTypeName();\n \n+  /**\n+   * Get the type name for the 'finalized' type for this aggregator, i.e. the type of the value returned by\n+   * {@link #finalizeComputation}. This may be the same as or different than the types expected in {@link #deserialize}\n+   * and {@link #combine}.\n+   *\n+   * If you need a ValueType enum corresponding to this aggregator, use {@link #getFinalizedType} instead.\n+   */\n+  public String getFinalizedTypeName()\n+  {\n+    return getTypeName();", "originalCommit": "f2aa12f64a8291e256ac58e039837057f289822e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxMjA4Mw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r406012083", "bodyText": "This might actually be better as an abstract method so that all AggregatorFactory must explicitly specify the finalized type, but I was somewhat worried about it being a bit disruptive. I think it is worth discussing if abstract would be better, but yeah at least will add javadocs.", "author": "clintropolis", "createdAt": "2020-04-09T07:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NzcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzNTQxMg==", "url": "https://github.com/apache/druid/pull/9638#discussion_r406435412", "bodyText": "actually, this one can also be removed and we just need to have getFinalizedType() and it having default impl return getType()  .\nI didn't suggest making it abstract because it does work correctly for all of aggregators dealing with primitives, so default is ok specially because \"wrong\" behavior doesn't appear to cause any correctness issue for query processing.", "author": "himanshug", "createdAt": "2020-04-09T19:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NzcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU5MDA1Mw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r406590053", "bodyText": "I think maybe if we remove both getFinalizedTypeName from the AggregatorFactory and getTypeName from the PostAggregator, we should also maybe consider renaming AggregatorFactory.getTypeName to be AggregatorFactory.getComplexTypeName or something similar, and ensure it is only still called for getting a ComplexMetricSerde for the aggregator. I'll look into this when I get back to this branch, but a rename like that might be sort of disruptive to extension writers.", "author": "clintropolis", "createdAt": "2020-04-10T03:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NzcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYxOTQ5MA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r406619490", "bodyText": "ensure it is only still called for getting a ComplexMetricSerde for the aggregator.\n\nthat sounds ok, with ValueType getType() in there, AggregatorFactory.getTypeName() is only used to find  right ComplexMetricSerde object .. you are right  that changing the name might be disruptive, so adding the  right requirement in javadoc would be a good compromise.... or maybe you would find a better alternative.", "author": "himanshug", "createdAt": "2020-04-10T06:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NzcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk5NTIyNw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r410995227", "bodyText": "I've transitioned AggregatorFactory.getTypeName to be used exclusively for complex type serde lookup, and remove all of the other type name functions. All AggregatorFactory implementations now must explicitly implement getType instead of a default that tries to convert it into a ValueType enum from the result of getTypeName, and I removed getTypeName from all non-complex agg factories in favor of a default implementation that throws an exception (to ensure this method isn't called inappropriately).\nSince getType is now abstract, this PR is sort of disruptive to agg extensions, so it might be also ok to change getTypeName to getComplexTypeName since a code change will be required anyway.\nAlternatively, I could restore the default implementation of getType that uses the output of getTypeName to translate into a ValueType if this is too much. I removed it as much so that I would go through and provide explicit implementations for all existing aggregators using errors to hunt them all down.", "author": "clintropolis", "createdAt": "2020-04-19T21:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NzcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NTk5MA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r417755990", "bodyText": "Fwiw, I'm in favor of requiring aggregators to explicitly implement these functions \u2014 especially if 90% of people would be fine with the default! That means it would be really easy for the 10% that need to override it to forget to do so. In general it's good to make it easy to do things right, not easy to forget important stuff.", "author": "gianm", "createdAt": "2020-04-30T05:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NzcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3NjU1Mw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472476553", "bodyText": "I agree, getType and getFinalizedType are now both abstract, and I also have renamed getTypeName to be getComplexTypeName since it didn't seem much more disruptive to rename an existing method on top of having to implement the 2 new methods.", "author": "clintropolis", "createdAt": "2020-08-18T20:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NzcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNTYyNA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r405805624", "bodyText": "nit: these can be  moved to else clause. also aggFactory.getTypeName() can just be inlined for complex clause.", "author": "himanshug", "createdAt": "2020-04-08T20:48:51Z", "path": "indexing-hadoop/src/main/java/org/apache/druid/indexer/InputRowSerde.java", "diffHunk": "@@ -340,22 +340,25 @@ public static SerializeResult toBytes(\n             parseExceptionMessages.add(e.getMessage());\n           }\n \n-          String t = aggFactory.getTypeName();\n+          final ValueType type = aggFactory.getType();\n+          final String typeName = aggFactory.getTypeName();", "originalCommit": "f2aa12f64a8291e256ac58e039837057f289822e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxMjc1OQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r406012759", "bodyText": "Ah, good point, will move \ud83d\udc4d", "author": "clintropolis", "createdAt": "2020-04-09T07:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNTYyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNzAyMQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r405807021", "bodyText": "nit: same", "author": "himanshug", "createdAt": "2020-04-08T20:51:22Z", "path": "indexing-hadoop/src/main/java/org/apache/druid/indexer/InputRowSerde.java", "diffHunk": "@@ -467,21 +470,24 @@ public static InputRow fromBytes(\n       //Read metrics\n       int metricSize = WritableUtils.readVInt(in);\n       for (int i = 0; i < metricSize; i++) {\n-        String metric = readString(in);\n-        String type = getType(metric, aggs, i);\n-        byte metricNullability = in.readByte();\n+        final String metric = readString(in);\n+        final AggregatorFactory agg = getAggregator(metric, aggs, i);\n+        final ValueType type = agg.getType();\n+        final String typeName = agg.getTypeName();\n+        final byte metricNullability = in.readByte();", "originalCommit": "f2aa12f64a8291e256ac58e039837057f289822e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a59a1f662d3c166989ba2fc8c9a2df3aeba82b3", "url": "https://github.com/apache/druid/commit/8a59a1f662d3c166989ba2fc8c9a2df3aeba82b3", "message": "Merge remote-tracking branch 'upstream/master' into there-can-be-only-one", "committedDate": "2020-04-19T07:39:15Z", "type": "commit"}, {"oid": "c81ba6a1002864e56314ffeecb480957b2a2073d", "url": "https://github.com/apache/druid/commit/c81ba6a1002864e56314ffeecb480957b2a2073d", "message": "transition to getTypeName to be used exclusively for complex types", "committedDate": "2020-04-19T21:08:43Z", "type": "commit"}, {"oid": "702b548ec41b41173f846308f092f7327e83c83d", "url": "https://github.com/apache/druid/commit/702b548ec41b41173f846308f092f7327e83c83d", "message": "remove unused fn", "committedDate": "2020-04-19T21:12:24Z", "type": "commit"}, {"oid": "21067bc05b08b180f435ff523e1a90a89d33a43d", "url": "https://github.com/apache/druid/commit/21067bc05b08b180f435ff523e1a90a89d33a43d", "message": "adjust", "committedDate": "2020-04-19T21:20:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NjIwMA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r417756200", "bodyText": "Please add javadocs.", "author": "gianm", "createdAt": "2020-04-30T05:08:47Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/PostAggregator.java", "diffHunk": "@@ -43,6 +44,8 @@\n   @Nullable\n   String getName();\n \n+  ValueType getType();", "originalCommit": "21067bc05b08b180f435ff523e1a90a89d33a43d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NjU2Mw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r417756563", "bodyText": "Why STRING? (Instead of COMPLEX or whatever.)\nWhat bad things could potentially happen if the type returned by this method is wrong? (The javadoc should explain this, ideally.)", "author": "gianm", "createdAt": "2020-04-30T05:09:59Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/post/ExpressionPostAggregator.java", "diffHunk": "@@ -179,6 +169,14 @@ public String getName()\n     return name;\n   }\n \n+  @Override\n+  public ValueType getType()\n+  {\n+    // this is wrong, replace with Expr output type based on the input types once it is available\n+    // but treat as string for now\n+    return ValueType.STRING;", "originalCommit": "21067bc05b08b180f435ff523e1a90a89d33a43d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU0NzM3Ng==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472547376", "bodyText": "Since this is a post-aggregator, probably not a lot will go wrong in most cases. We will potentially predict an incorrect query result signature as having strings instead of whatever the actual expression output type is. I guess it should technically probably return null for now since it is truly unknown, so it will appear in the signature that way. I'm going to consider making this change.\nCOMPLEX could be ok to use here in some circumstances, but would not be correct i think for example, if the row signature for a subquery is computed and then the column from the subquery post-agg is used as an input to another expression (since expression selectors do not currently handle complex inputs). There might be other cases too.", "author": "clintropolis", "createdAt": "2020-08-18T23:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NjU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQzNDk1NA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r473434954", "bodyText": "I've changed this to be null for now, rather than incorrectly calling it string, so it will continue to be treated as unknown, but did go ahead and wire things up for a follow-up PR to be able to add output type inference to expressions during post-agg decoration.", "author": "clintropolis", "createdAt": "2020-08-19T23:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NjU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQzNjQ0Mw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r473436443", "bodyText": "Also i did not explicitly change the output contract of PostAggregator.getType to @Nullable, because I don't think that long term it should be allowed to be that, but could change it to that for now while it is true, and remove in the future once the expression post-agg knows its output type.\nAlternatively, I could have added an explicit output type json property, similar to expression virtual column declaration, but I think we want to deprecate those once output type inference is in place, so decided not to do this at this time, but am open to including it if anyone thinks it is necessary.", "author": "clintropolis", "createdAt": "2020-08-19T23:35:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NjU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI1MDUzMA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r476250530", "bodyText": "I think it'd be good to make it @Nullable for now, with a note that we'd like it to stop being nullable in the future when X/Y/Z things are done. We want to make sure that in the meantime, we don't forget to check it.", "author": "gianm", "createdAt": "2020-08-25T07:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NjU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI1NzUwNQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r476257505", "bodyText": "Ah, I did end up adding it as @Nullable, I forgot to update this comment. It is missing the note on it maybe not being like that in the future, can add.", "author": "clintropolis", "createdAt": "2020-08-25T08:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NjU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NzA4MA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r417757080", "bodyText": "Add a @throws IllegalStateException if getType() != ValueType.COMPLEX", "author": "gianm", "createdAt": "2020-04-30T05:12:07Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/AggregatorFactory.java", "diffHunk": "@@ -210,22 +212,36 @@ public AggregatorFactory getMergingFactory(AggregatorFactory other) throws Aggre\n   public abstract List<String> requiredFields();\n \n   /**\n-   * Get the type name of the intermediate type for this aggregator. This is the same as the type returned by\n+   * Get the \"intermediate\" {@link ValueType} for this aggregator. This is the same as the type returned by\n    * {@link #deserialize} and the type accepted by {@link #combine}. However, it is *not* necessarily the same type\n    * returned by {@link #finalizeComputation}.\n+   */\n+  public abstract ValueType getType();\n+\n+  /**\n+   * Get the type for the final form of this this aggregator, i.e. the type of the value returned by\n+   * {@link #finalizeComputation}. This may be the same as or different than the types expected in {@link #deserialize}\n+   * and {@link #combine}.\n+   * @return\n+   */\n+  public ValueType getFinalizedType()\n+  {\n+    return getType();\n+  }\n+\n+  /**\n+   * Get the complex type name of the intermediate type for this aggregator.\n    *\n-   * If the type is complex (i.e. not a simple, numeric {@link org.apache.druid.segment.column.ValueType}) then there\n+   * This should ONLY be implemented if the type is complex (i.e. not a simple, numeric {@link ValueType}), and there\n    * must be a corresponding {@link org.apache.druid.segment.serde.ComplexMetricSerde} which was registered with\n    * {@link org.apache.druid.segment.serde.ComplexMetrics#registerSerde} using this type name.\n    *\n-   * If you need a ValueType enum corresponding to this aggregator, a good way to do that is:\n-   *\n-   * <pre>\n-   *   Optional.ofNullable(GuavaUtils.getEnumIfPresent(ValueType.class, aggregator.getTypeName()))\n-   *           .orElse(ValueType.COMPLEX);\n-   * </pre>\n+   * If you need a ValueType enum corresponding to this aggregator, use {@link #getTypeName} instead.", "originalCommit": "21067bc05b08b180f435ff523e1a90a89d33a43d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5MDAwNg==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472490006", "bodyText": "added", "author": "clintropolis", "createdAt": "2020-08-18T20:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NzA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NzE4MQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r417757181", "bodyText": "IMO, it would be better for this to be abstract, since this makes it too easy for people to forget to override it.", "author": "gianm", "createdAt": "2020-04-30T05:12:37Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/AggregatorFactory.java", "diffHunk": "@@ -210,22 +212,36 @@ public AggregatorFactory getMergingFactory(AggregatorFactory other) throws Aggre\n   public abstract List<String> requiredFields();\n \n   /**\n-   * Get the type name of the intermediate type for this aggregator. This is the same as the type returned by\n+   * Get the \"intermediate\" {@link ValueType} for this aggregator. This is the same as the type returned by\n    * {@link #deserialize} and the type accepted by {@link #combine}. However, it is *not* necessarily the same type\n    * returned by {@link #finalizeComputation}.\n+   */\n+  public abstract ValueType getType();\n+\n+  /**\n+   * Get the type for the final form of this this aggregator, i.e. the type of the value returned by\n+   * {@link #finalizeComputation}. This may be the same as or different than the types expected in {@link #deserialize}\n+   * and {@link #combine}.\n+   * @return\n+   */\n+  public ValueType getFinalizedType()\n+  {\n+    return getType();", "originalCommit": "21067bc05b08b180f435ff523e1a90a89d33a43d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4NjI4Mw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472486283", "bodyText": "changed to abstract", "author": "clintropolis", "createdAt": "2020-08-18T20:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1NzE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1Nzc5NA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r417757794", "bodyText": "Please add javadocs documenting these types.\nEspecially important things to document include:\n\nWhen do we use STRING and when do we use STRING_ARRAY? (Multivalue strings are type STRING, even though they behave kind of like arrays. How do we explain this coherently?)\nWhat does COMPLEX mean and how can you get more information about something that is COMPLEX?", "author": "gianm", "createdAt": "2020-04-30T05:14:53Z", "path": "core/src/main/java/org/apache/druid/segment/column/ValueType.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.segment.column;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import org.apache.druid.java.util.common.StringUtils;\n+\n+import javax.annotation.Nullable;\n+\n+public enum ValueType\n+{\n+  DOUBLE,\n+  FLOAT,\n+  LONG,\n+  STRING,\n+  COMPLEX,\n+  DOUBLE_ARRAY,\n+  LONG_ARRAY,\n+  STRING_ARRAY;", "originalCommit": "21067bc05b08b180f435ff523e1a90a89d33a43d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU0OTU2Ng==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472549566", "bodyText": "I am still working on javadocs here and other modified places to provide guidance on how types are and should be used, and how to deal with array types until they are fully propagated through the codebase.\nWith regards to COMPLEX, I'm starting to think that in the future we might want to modify RowSignature to potentially have the ability to store the complex type name, similar to what is available for aggregator factory, and what #10277 adds to the ColumnCapabilities of complex type columns it creates. We might actually want a lighter weight ColumnSignature type that is a subset of ColumnCapabilities that RowSignature can be composed of, rather than it's strict ValueType mapping it currently has, but I'm not certain if it is necessary yet.", "author": "clintropolis", "createdAt": "2020-08-18T23:31:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1Nzc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc2MjA2Mg==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472762062", "bodyText": "will it be too complicated for multi value strings to have their own type different from single value string?", "author": "abhishekagarwal87", "createdAt": "2020-08-19T06:36:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1Nzc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjgyMTQwMw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472821403", "bodyText": "Not sure yet, I'm still thinking on the best way to live in a world with the current STRING that can have single or multi values, communicated through ColumnCapabilities.hasMultipleValues, and STRING_ARRAY which is explicitly always multi-valued but can currently only be produced via expressions.\nI think it depends on how we want to encode this information for RowSignature to make available to the broker and higher layers of the query engines. There might be room for a new ValueType to use explicitly for STRING which are multi-valued if we want to keep RowSignature light (and effectively coerce it back to STRING when translating the signature back into ColumnCapabilities for things like the row selectors the broker uses), though between the changes in #10219 which also adds a want to be able to encode in the RowSignature which columns can have null values, making a richer RowSignature is probably the right way forward, which could potentially make a separate ValueType for multi-value strings not necessary.\nI don't think we want to treat the multi-value strings as STRING_ARRAY because I think we probably want to reserve it for if/when we add true array typed columns, so that engines like group by and top-n can process them separately than the funny way we handle existing multi-value strings (which aggregate on individual values, basically  equivalent to UNNEST in SQL) and instead do it in a way that is compatible with SQL array types.", "author": "clintropolis", "createdAt": "2020-08-19T07:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1Nzc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQzODAxOA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r473438018", "bodyText": "I've added a bunch of javadocs trying to advise on what each ValueType represents and how it may be used in the query engines, I hope it is sufficient to provide guidance for complex type/agg/post-agg implementors to think about how the thing is going to be used, but I'm sure that I'm probably leaving out a lot of details, and it might be somewhat brittle to keep in sync with reality as the engines evolve.", "author": "clintropolis", "createdAt": "2020-08-19T23:37:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1Nzc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1ODAzNg==", "url": "https://github.com/apache/druid/pull/9638#discussion_r417758036", "bodyText": "With this logic, DOUBLE_ARRAY.isComplex() is true. This seems weird. I would think only COMPLEX is complex. Please add javadocs to the method and maybe consider renaming it.", "author": "gianm", "createdAt": "2020-04-30T05:15:50Z", "path": "core/src/main/java/org/apache/druid/segment/column/ValueType.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.segment.column;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import org.apache.druid.java.util.common.StringUtils;\n+\n+import javax.annotation.Nullable;\n+\n+public enum ValueType\n+{\n+  DOUBLE,\n+  FLOAT,\n+  LONG,\n+  STRING,\n+  COMPLEX,\n+  DOUBLE_ARRAY,\n+  LONG_ARRAY,\n+  STRING_ARRAY;\n+\n+\n+  public boolean isNumeric()\n+  {\n+    return isNumeric(this);\n+  }\n+\n+  public boolean isPrimitiveScalar()\n+  {\n+    return this.equals(ValueType.STRING) || isNumeric(this);\n+  }\n+\n+  public boolean isComplex()", "originalCommit": "21067bc05b08b180f435ff523e1a90a89d33a43d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4Njg5OQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472486899", "bodyText": "I have removed this method in favor of using isPrimitive directly", "author": "clintropolis", "createdAt": "2020-08-18T20:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1ODAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1ODkyNQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r417758925", "bodyText": "Instead of using null here, we should have different signatures for finalized and nonfinalized rows. Perhaps the row signature builder should have addAggregators(List<AggregatorFactory> aggregators, boolean finalize) and the things that call it should be given knowledge about whether they're going to be finalizing or not.", "author": "gianm", "createdAt": "2020-04-30T05:19:11Z", "path": "processing/src/main/java/org/apache/druid/segment/column/RowSignature.java", "diffHunk": "@@ -237,21 +235,14 @@ public Builder addDimensions(final List<DimensionSpec> dimensions)\n     public Builder addAggregators(final List<AggregatorFactory> aggregators)\n     {\n       for (final AggregatorFactory aggregator : aggregators) {\n-        final ValueType type = GuavaUtils.getEnumIfPresent(\n-            ValueType.class,\n-            StringUtils.toUpperCase(aggregator.getTypeName())\n-        );\n-\n-        // Use null instead of COMPLEX for nonnumeric types, since in that case, the type depends on whether or not\n-        // the aggregator is finalized, and we don't know (a) if it will be finalized, or even (b) what the type would\n-        // be if it were finalized. So null (i.e. unknown) is the proper thing to do.\n-        //\n-        // Another note: technically, we don't know what the finalized type will be even if the type here is numeric,\n-        // but we're assuming that it doesn't change upon finalization. All builtin aggregators work this way.\n+        final ValueType type = aggregator.getType();\n \n-        if (type != null && type.isNumeric()) {\n+        if (type.equals(aggregator.getFinalizedType())) {\n           add(aggregator.getName(), type);\n         } else {\n+          // Use null if the type depends on whether or not the aggregator is finalized, since", "originalCommit": "21067bc05b08b180f435ff523e1a90a89d33a43d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4OTgwOA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472489808", "bodyText": "I agree that this is a nice thing to do in the future so that we can have complete/accurate RowSignature everywhere, as I alluded to in the PR description, but it is a bit much for this PR and not especially needed at this point.", "author": "clintropolis", "createdAt": "2020-08-18T20:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1ODkyNQ=="}], "type": "inlineReview"}, {"oid": "da0936c688591abd0eadb3f565e78c86853259fb", "url": "https://github.com/apache/druid/commit/da0936c688591abd0eadb3f565e78c86853259fb", "message": "Merge remote-tracking branch 'upstream/master' into there-can-be-only-one", "committedDate": "2020-08-14T11:42:44Z", "type": "commit"}, {"oid": "051f53fad51dbf501a58f1eeff33fab85b117ea9", "url": "https://github.com/apache/druid/commit/051f53fad51dbf501a58f1eeff33fab85b117ea9", "message": "Merge remote-tracking branch 'upstream/master' into there-can-be-only-one", "committedDate": "2020-08-17T18:39:14Z", "type": "commit"}, {"oid": "d01fb3627b504202421c642ba2d7ac89927d38c3", "url": "https://github.com/apache/druid/commit/d01fb3627b504202421c642ba2d7ac89927d38c3", "message": "Merge remote-tracking branch 'upstream/master' into there-can-be-only-one", "committedDate": "2020-08-17T22:01:30Z", "type": "commit"}, {"oid": "3aa9958ae3af08598dc76c251b4a656985140652", "url": "https://github.com/apache/druid/commit/3aa9958ae3af08598dc76c251b4a656985140652", "message": "more better", "committedDate": "2020-08-18T18:14:05Z", "type": "commit"}, {"oid": "bbf60e2862c9cd85f13bccb41e610324e4430c2c", "url": "https://github.com/apache/druid/commit/bbf60e2862c9cd85f13bccb41e610324e4430c2c", "message": "rename getTypeName to getComplexTypeName", "committedDate": "2020-08-18T19:31:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc4MDgxNg==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472780816", "bodyText": "thinking out loud. how about having a class such as AggregatorOutputType which can contain combine and finalize types. Aggregators just override one method which can be AggregatorOutputType getType()", "author": "abhishekagarwal87", "createdAt": "2020-08-19T07:00:44Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/AggregatorFactory.java", "diffHunk": "@@ -211,22 +213,35 @@ public AggregatorFactory getMergingFactory(AggregatorFactory other) throws Aggre\n   public abstract List<String> requiredFields();\n \n   /**\n-   * Get the type name of the intermediate type for this aggregator. This is the same as the type returned by\n+   * Get the \"intermediate\" {@link ValueType} for this aggregator. This is the same as the type returned by\n    * {@link #deserialize} and the type accepted by {@link #combine}. However, it is *not* necessarily the same type\n    * returned by {@link #finalizeComputation}.\n+   */\n+  public abstract ValueType getType();", "originalCommit": "bbf60e2862c9cd85f13bccb41e610324e4430c2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc4MjUyMw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472782523", "bodyText": "over time, more information can be added to this class rather than having methods in the interface. one example is complex type name.", "author": "abhishekagarwal87", "createdAt": "2020-08-19T07:02:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc4MDgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjgxMjg4MQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r472812881", "bodyText": "We already have ColumnCapabilities which is a richer but a bit more segment focused version of a thing that provides details about a given column, and #10277 expands that to also include complex type name, so I think if we are going to use a consolidated type we should consider using that since it is used pretty heavily throughout the engines to help determine the correct way to process columns (or a new interface that provides a subset of the functionality that ColumnCapabilities can extend as mentioned in another thread). I need to think a bit harder about what would be most useful for RowSignature to have on hand, which is currently the type used to serve similar functionality to higher levels of the engine what ColumnCapabilities provides at lower levels, before making a change like this though.\nI'm not sure if it is useful to combine the intermediary and finalized types in one place, since callers should typically only need one or the other, depending on the caller, as mentioned in PR description and this thread #9638 (comment). We currently haven't quite added enough information through for most callers to be able to provide this context quite yet though, so it also needs a bit further thought.", "author": "clintropolis", "createdAt": "2020-08-19T07:39:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc4MDgxNg=="}], "type": "inlineReview"}, {"oid": "9cbb602e88ca403dbbfc6ac764125ded25be49c4", "url": "https://github.com/apache/druid/commit/9cbb602e88ca403dbbfc6ac764125ded25be49c4", "message": "setup expression post agg for type inference existing", "committedDate": "2020-08-19T20:48:06Z", "type": "commit"}, {"oid": "0c8173515aee54e738a0a5bca0cb8a0b40810d07", "url": "https://github.com/apache/druid/commit/0c8173515aee54e738a0a5bca0cb8a0b40810d07", "message": "more javadocs", "committedDate": "2020-08-19T23:24:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAxODUyNQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475018525", "bodyText": "Should it be round ? ValueType.LONG : ValueType.DOUBLE?", "author": "jihoonson", "createdAt": "2020-08-22T00:13:34Z", "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/hll/HllSketchToEstimatePostAggregator.java", "diffHunk": "@@ -62,6 +63,12 @@ public String getName()\n     return name;\n   }\n \n+  @Override\n+  public ValueType getType()\n+  {\n+    return ValueType.DOUBLE;", "originalCommit": "0c8173515aee54e738a0a5bca0cb8a0b40810d07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg5MTExMw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475891113", "bodyText": "Oops yes, changed.", "author": "clintropolis", "createdAt": "2020-08-24T21:00:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAxODUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDM1NQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475020355", "bodyText": "Should this be DOUBLE_ARRAY?", "author": "jihoonson", "createdAt": "2020-08-22T00:25:30Z", "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "diffHunk": "@@ -102,6 +103,15 @@ public String getName()\n     return name;\n   }\n \n+  /**\n+   * actual type is {@link DoublesSketch}\n+   */\n+  @Override\n+  public ValueType getType()\n+  {\n+    return ValueType.COMPLEX;", "originalCommit": "0c8173515aee54e738a0a5bca0cb8a0b40810d07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg5MTEwMQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475891101", "bodyText": "Oops yes, changed", "author": "clintropolis", "createdAt": "2020-08-24T21:00:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDM1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDY2MA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475020660", "bodyText": "errorBoundsStdDev != null ? ValueType.COMPLEX : ValueType.DOUBLE?", "author": "jihoonson", "createdAt": "2020-08-22T00:28:00Z", "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/theta/SketchEstimatePostAggregator.java", "diffHunk": "@@ -100,6 +101,12 @@ public String getName()\n     return name;\n   }\n \n+  @Override\n+  public ValueType getType()\n+  {\n+    return ValueType.DOUBLE;", "originalCommit": "0c8173515aee54e738a0a5bca0cb8a0b40810d07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg5MTA1MA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475891050", "bodyText": "Oops yes, changed", "author": "clintropolis", "createdAt": "2020-08-24T21:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNDExMg==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475024112", "bodyText": "Should outputType be in here, equals() and getCacheKey()?", "author": "jihoonson", "createdAt": "2020-08-22T00:54:09Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/post/ExpressionPostAggregator.java", "diffHunk": "@@ -287,10 +295,6 @@ public boolean equals(Object o)\n   @Override\n   public int hashCode()\n   {\n-    int result = name != null ? name.hashCode() : 0;\n-    result = 31 * result + expression.hashCode();\n-    result = 31 * result + comparator.hashCode();\n-    result = 31 * result + (ordering != null ? ordering.hashCode() : 0);\n-    return result;\n+    return Objects.hash(name, expression, comparator, ordering);", "originalCommit": "0c8173515aee54e738a0a5bca0cb8a0b40810d07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNDQ2Nw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475024467", "bodyText": "Doesn't seem nullable.", "author": "jihoonson", "createdAt": "2020-08-22T00:56:43Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/post/FieldAccessPostAggregator.java", "diffHunk": "@@ -40,16 +41,24 @@\n   @Nullable\n   private final String name;\n   private final String fieldName;\n+  @Nullable", "originalCommit": "0c8173515aee54e738a0a5bca0cb8a0b40810d07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc5NTE2OQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475795169", "bodyText": "Oops, it was meant to be nullable instead of using the 'defaultAggregationType'", "author": "clintropolis", "createdAt": "2020-08-24T17:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNDQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNDU0OQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475024549", "bodyText": "type is missing in getCacheKey(), equals(), and hashCode().", "author": "jihoonson", "createdAt": "2020-08-22T00:57:19Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/post/FieldAccessPostAggregator.java", "diffHunk": "@@ -40,16 +41,24 @@\n   @Nullable\n   private final String name;\n   private final String fieldName;\n+  @Nullable\n+  private final ValueType type;", "originalCommit": "0c8173515aee54e738a0a5bca0cb8a0b40810d07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNDY4NQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475024685", "bodyText": "This is nullable. Also missing in getCacheKey(), equals(), and hashCode().", "author": "jihoonson", "createdAt": "2020-08-22T00:58:46Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/post/FinalizingFieldAccessPostAggregator.java", "diffHunk": "@@ -26,16 +26,20 @@\n import org.apache.druid.query.aggregation.AggregatorFactory;\n import org.apache.druid.query.aggregation.PostAggregator;\n import org.apache.druid.query.cache.CacheKeyBuilder;\n+import org.apache.druid.segment.column.ValueType;\n+import org.apache.druid.segment.column.ValueTypes;\n \n import java.util.Comparator;\n import java.util.Map;\n+import java.util.Objects;\n import java.util.Set;\n import java.util.function.Function;\n \n public class FinalizingFieldAccessPostAggregator implements PostAggregator\n {\n   private final String name;\n   private final String fieldName;\n+  private final ValueType finalizedType;", "originalCommit": "0c8173515aee54e738a0a5bca0cb8a0b40810d07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc5NjA1Mw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475796053", "bodyText": "Hmm, I'm undecided if it should it be in equals and hashCode... Should calling decorate still be equal to the postagg before calling decorate? If so, then I think it should be ignored in these places since the value is computed. Same comment for ValueType in the other postaggs.", "author": "clintropolis", "createdAt": "2020-08-24T17:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNDY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4ODI3Mw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475888273", "bodyText": "It seems ok to omit, looking at the code, the only time post-aggs exist as undecorated is for a short period in the constructors of the queries which can have post-aggregators.", "author": "clintropolis", "createdAt": "2020-08-24T20:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNDY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg5NjE0MA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475896140", "bodyText": "Nice finding. Would you leave a comment about why the finalizedType is not in those methods? It could be confusing otherwise.", "author": "jihoonson", "createdAt": "2020-08-24T21:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNDY4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNTI0Nw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475025247", "bodyText": "\ud83d\ude05", "author": "jihoonson", "createdAt": "2020-08-22T01:03:19Z", "path": "processing/src/test/java/org/apache/druid/query/aggregation/AggregatorFactoryTest.java", "diffHunk": "@@ -77,4 +103,168 @@ public void testMergeAggregators()\n     Assert.assertNull(AggregatorFactory.mergeAggregators(ImmutableList.of(af1, af2))\n     );\n   }\n+\n+  @Test\n+  public void testResultArraySignature()", "originalCommit": "0c8173515aee54e738a0a5bca0cb8a0b40810d07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNzA4MQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475027081", "bodyText": "getType() seems too broad even though it is actually an intermediate type. Maybe getIntermediateType() is a better name?", "author": "jihoonson", "createdAt": "2020-08-22T01:07:35Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/AggregatorFactory.java", "diffHunk": "@@ -211,22 +213,38 @@ public AggregatorFactory getMergingFactory(AggregatorFactory other) throws Aggre\n   public abstract List<String> requiredFields();\n \n   /**\n-   * Get the type name of the intermediate type for this aggregator. This is the same as the type returned by\n+   * Get the \"intermediate\" {@link ValueType} for this aggregator. This is the same as the type returned by\n    * {@link #deserialize} and the type accepted by {@link #combine}. However, it is *not* necessarily the same type\n    * returned by {@link #finalizeComputation}.\n    *\n-   * If the type is complex (i.e. not a simple, numeric {@link org.apache.druid.segment.column.ValueType}) then there\n+   * Refer to the {@link ValueType} javadocs for details on the implications of choosing a type.\n+   */\n+  public abstract ValueType getType();", "originalCommit": "0c8173515aee54e738a0a5bca0cb8a0b40810d07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4Njg5OQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r475886899", "bodyText": "Naming things is the hardest \ud83d\ude05\nThat name seems correct, but need to think more if there is an even better name for it or not", "author": "clintropolis", "createdAt": "2020-08-24T20:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyNzA4MQ=="}], "type": "inlineReview"}, {"oid": "2c0347f54c373ad7ffeb02daed73fe29e505e556", "url": "https://github.com/apache/druid/commit/2c0347f54c373ad7ffeb02daed73fe29e505e556", "message": "Merge remote-tracking branch 'upstream/master' into there-can-be-only-one", "committedDate": "2020-08-24T17:55:17Z", "type": "commit"}, {"oid": "c4371c86ddfa8a8b478b1dbaff453410cdf1f307", "url": "https://github.com/apache/druid/commit/c4371c86ddfa8a8b478b1dbaff453410cdf1f307", "message": "fixup", "committedDate": "2020-08-24T20:58:29Z", "type": "commit"}, {"oid": "1e686d80c846aadfc2aee57966d1e2ed9b070cb4", "url": "https://github.com/apache/druid/commit/1e686d80c846aadfc2aee57966d1e2ed9b070cb4", "message": "oops", "committedDate": "2020-08-24T20:59:21Z", "type": "commit"}, {"oid": "881954fc59d5dc219a962e4d25ea41a659fa550e", "url": "https://github.com/apache/druid/commit/881954fc59d5dc219a962e4d25ea41a659fa550e", "message": "more test", "committedDate": "2020-08-24T21:07:16Z", "type": "commit"}, {"oid": "dc27526a18f3378f15031f035dee9b90f54a832a", "url": "https://github.com/apache/druid/commit/dc27526a18f3378f15031f035dee9b90f54a832a", "message": "more test", "committedDate": "2020-08-24T21:14:15Z", "type": "commit"}, {"oid": "6eee25a2579eae9f6450a0a4ce315006ee6027a0", "url": "https://github.com/apache/druid/commit/6eee25a2579eae9f6450a0a4ce315006ee6027a0", "message": "more comments/javadoc", "committedDate": "2020-08-25T04:24:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI2NDgwMQ==", "url": "https://github.com/apache/druid/pull/9638#discussion_r476264801", "bodyText": "Previously this only did createSimpleNumericColumnCapabilities if the type was numeric, now it includes strings too. Is that intentional?", "author": "gianm", "createdAt": "2020-08-25T08:17:59Z", "path": "processing/src/main/java/org/apache/druid/segment/incremental/IncrementalIndex.java", "diffHunk": "@@ -1135,21 +1117,21 @@ public MetricDesc(int index, AggregatorFactory factory)\n       this.index = index;\n       this.name = factory.getName();\n \n-      String typeInfo = factory.getTypeName();\n-      if (\"float\".equalsIgnoreCase(typeInfo)) {\n-        capabilities = ColumnCapabilitiesImpl.createSimpleNumericColumnCapabilities(ValueType.FLOAT);\n-        this.type = typeInfo;\n-      } else if (\"long\".equalsIgnoreCase(typeInfo)) {\n-        capabilities = ColumnCapabilitiesImpl.createSimpleNumericColumnCapabilities(ValueType.LONG);\n-        this.type = typeInfo;\n-      } else if (\"double\".equalsIgnoreCase(typeInfo)) {\n-        capabilities = ColumnCapabilitiesImpl.createSimpleNumericColumnCapabilities(ValueType.DOUBLE);\n-        this.type = typeInfo;\n+      ValueType valueType = factory.getType();\n+\n+      if (valueType.isPrimitive()) {", "originalCommit": "6eee25a2579eae9f6450a0a4ce315006ee6027a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwMTgwMw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r476301803", "bodyText": "Hmm, that is a good point, this should probably check isNumeric. However, should the else be an else if (ValueType.COMPLEX.equals(valueType)) to make sure it is actually is? I'm not sure the previous behavior of treating STRING as a COMPLEX was quite correct, it doesn't seem like it. Instead it should maybe handle STRING (and arrays) separately, though I'm not quite sure which capabilities it should have or if it should be an error case.", "author": "clintropolis", "createdAt": "2020-08-25T09:13:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI2NDgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYxMjkyOA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r476612928", "bodyText": "How about throwing an error that this kind of AggregatorFactory isn't supported at ingestion time?\nI don't think there's a use case for it with any of the builtin aggregators. So we can worry about it when one comes up.", "author": "gianm", "createdAt": "2020-08-25T17:22:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI2NDgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY5MTU1Mw==", "url": "https://github.com/apache/druid/pull/9638#discussion_r476691553", "bodyText": "Changed to handle only numeric and complex types, and left a comment about what needs done if the new else case is encountered.", "author": "clintropolis", "createdAt": "2020-08-25T19:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI2NDgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3MTgzNg==", "url": "https://github.com/apache/druid/pull/9638#discussion_r476271836", "bodyText": "Why not keep it null here? What are the pros and cons of null vs ValueTypes.defaultAggregationType()?", "author": "gianm", "createdAt": "2020-08-25T08:29:07Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/post/FieldAccessPostAggregator.java", "diffHunk": "@@ -78,10 +89,28 @@ public String getName()\n     return name;\n   }\n \n+  @Override\n+  public ValueType getType()\n+  {\n+    return type;\n+  }\n+\n   @Override\n   public FieldAccessPostAggregator decorate(Map<String, AggregatorFactory> aggregators)\n   {\n-    return this;\n+    final ValueType type;\n+\n+    if (aggregators != null && aggregators.containsKey(fieldName)) {\n+      type = aggregators.get(fieldName).getType();\n+    } else {\n+      type = ValueTypes.defaultAggregationType();", "originalCommit": "6eee25a2579eae9f6450a0a4ce315006ee6027a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwMjMwMg==", "url": "https://github.com/apache/druid/pull/9638#discussion_r476302302", "bodyText": "Ah, I think it should be null, this is a leftover from before i made PostAggregator.getType be annotated @Nullable.", "author": "clintropolis", "createdAt": "2020-08-25T09:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3MTgzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3NTQ3OA==", "url": "https://github.com/apache/druid/pull/9638#discussion_r476275478", "bodyText": "Similar comment to FieldAccessPostAggregator: why not keep it null here? What are the pros and cons of null vs ValueTypes.defaultAggregationType()?", "author": "gianm", "createdAt": "2020-08-25T08:34:55Z", "path": "processing/src/main/java/org/apache/druid/query/aggregation/post/FinalizingFieldAccessPostAggregator.java", "diffHunk": "@@ -94,29 +104,35 @@ public String getName()\n     return name;\n   }\n \n+  @Override\n+  public ValueType getType()\n+  {\n+    return finalizedType;\n+  }\n+\n   @Override\n   public FinalizingFieldAccessPostAggregator decorate(final Map<String, AggregatorFactory> aggregators)\n   {\n     final Comparator<Object> theComparator;\n     final Function<Object, Object> theFinalizer;\n+    final ValueType finalizedType;\n \n     if (aggregators != null && aggregators.containsKey(fieldName)) {\n       //noinspection unchecked\n       theComparator = aggregators.get(fieldName).getComparator();\n+      theFinalizer = aggregators.get(fieldName)::finalizeComputation;\n+      finalizedType = aggregators.get(fieldName).getFinalizedType();\n     } else {\n       //noinspection unchecked\n       theComparator = (Comparator) Comparators.naturalNullsFirst();\n-    }\n-\n-    if (aggregators != null && aggregators.containsKey(fieldName)) {\n-      theFinalizer = aggregators.get(fieldName)::finalizeComputation;\n-    } else {\n       theFinalizer = Function.identity();\n+      finalizedType = ValueTypes.defaultAggregationType();", "originalCommit": "6eee25a2579eae9f6450a0a4ce315006ee6027a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0c7ba70f4c768d27d2f34f1c3ea8fb779025a5ab", "url": "https://github.com/apache/druid/commit/0c7ba70f4c768d27d2f34f1c3ea8fb779025a5ab", "message": "nulls", "committedDate": "2020-08-25T11:13:55Z", "type": "commit"}, {"oid": "376728ad761ac78633b9db137fe1dc065a4b1acc", "url": "https://github.com/apache/druid/commit/376728ad761ac78633b9db137fe1dc065a4b1acc", "message": "explicitly handle only numeric and complex aggregators for incremental index", "committedDate": "2020-08-25T19:37:12Z", "type": "commit"}, {"oid": "59515b488bd845ee198fa14fc98aa4f2bba08e1c", "url": "https://github.com/apache/druid/commit/59515b488bd845ee198fa14fc98aa4f2bba08e1c", "message": "checkstyle", "committedDate": "2020-08-25T20:46:03Z", "type": "commit"}, {"oid": "0d709aceee41deaecb64ffa15e4c9865732f6294", "url": "https://github.com/apache/druid/commit/0d709aceee41deaecb64ffa15e4c9865732f6294", "message": "more tests", "committedDate": "2020-08-25T21:53:07Z", "type": "commit"}, {"oid": "207f44846b80c3ebd1bb4d245c200792100d1ad2", "url": "https://github.com/apache/druid/commit/207f44846b80c3ebd1bb4d245c200792100d1ad2", "message": "adjust", "committedDate": "2020-08-25T21:58:27Z", "type": "commit"}, {"oid": "10e2f3ef1f4ed62c6c4445cf45a8f063c2552642", "url": "https://github.com/apache/druid/commit/10e2f3ef1f4ed62c6c4445cf45a8f063c2552642", "message": "more tests to showcase difference in behavior", "committedDate": "2020-08-26T01:22:44Z", "type": "commit"}, {"oid": "16882b5d8a0cadf19a60e54f4622f14cd1bf05f9", "url": "https://github.com/apache/druid/commit/16882b5d8a0cadf19a60e54f4622f14cd1bf05f9", "message": "timeseries longsum array", "committedDate": "2020-08-26T01:42:03Z", "type": "commit"}]}