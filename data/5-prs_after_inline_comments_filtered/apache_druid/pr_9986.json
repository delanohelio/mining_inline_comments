{"pr_number": 9986, "pr_title": "Fix groupBy with literal in subquery grouping", "pr_createdAt": "2020-06-04T10:33:26Z", "pr_url": "https://github.com/apache/druid/pull/9986", "timeline": [{"oid": "32ee2557031adee9e8dd79ccc81ebfec49796d58", "url": "https://github.com/apache/druid/commit/32ee2557031adee9e8dd79ccc81ebfec49796d58", "message": "fix groupBy with literal in subquery grouping", "committedDate": "2020-06-04T10:17:35Z", "type": "commit"}, {"oid": "777a92230df7e5ab3890df4cefe285792f571aba", "url": "https://github.com/apache/druid/commit/777a92230df7e5ab3890df4cefe285792f571aba", "message": "fix groupBy with literal in subquery grouping", "committedDate": "2020-06-04T20:21:50Z", "type": "commit"}, {"oid": "a3e15fd2c021bbe3fa0869c61b80cebad0338bae", "url": "https://github.com/apache/druid/commit/a3e15fd2c021bbe3fa0869c61b80cebad0338bae", "message": "fix groupBy with literal in subquery grouping", "committedDate": "2020-06-04T20:28:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUzMDU3NA==", "url": "https://github.com/apache/druid/pull/9986#discussion_r435530574", "bodyText": "FYI: You could simplify this by using NULL_STRING for the null / \"\" and avoiding the ternary.", "author": "gianm", "createdAt": "2020-06-04T20:29:58Z", "path": "sql/src/test/java/org/apache/druid/sql/calcite/CalciteQueryTest.java", "diffHunk": "@@ -13419,6 +13420,73 @@ public void testNvlColumns() throws Exception\n     );\n   }\n \n+  @Test\n+  public void testGroupByWithLiteralInSubqueryGrouping() throws Exception\n+  {\n+    testQuery(\n+        \"SELECT \\n\"\n+        + \"   t1, t2\\n\"\n+        + \"  FROM\\n\"\n+        + \"   ( SELECT\\n\"\n+        + \"     'dummy' as t1,\\n\"\n+        + \"     CASE\\n\"\n+        + \"       WHEN \\n\"\n+        + \"         dim4 = 'b'\\n\"\n+        + \"       THEN dim4\\n\"\n+        + \"       ELSE NULL\\n\"\n+        + \"     END AS t2\\n\"\n+        + \"     FROM\\n\"\n+        + \"       numfoo\\n\"\n+        + \"     GROUP BY\\n\"\n+        + \"       dim4\\n\"\n+        + \"   )\\n\"\n+        + \" GROUP BY\\n\"\n+        + \"   t1,t2\\n\",\n+        ImmutableList.of(\n+            GroupByQuery.builder()\n+                        .setDataSource(\n+                            GroupByQuery.builder()\n+                                        .setDataSource(CalciteTests.DATASOURCE3)\n+                                        .setInterval(querySegmentSpec(Filtration.eternity()))\n+                                        .setGranularity(Granularities.ALL)\n+                                        .setDimensions(new DefaultDimensionSpec(\"dim4\", \"_d0\", ValueType.STRING))\n+                                        .setContext(QUERY_CONTEXT_DEFAULT)\n+                                        .build()\n+                        )\n+                        .setVirtualColumns(\n+                            expressionVirtualColumn(\n+                                \"v0\",\n+                                \"\\'dummy\\'\",\n+                                ValueType.STRING\n+                            ),\n+                            expressionVirtualColumn(\n+                                \"v1\",\n+                                \"case_searched((\\\"_d0\\\" == 'b'),\\\"_d0\\\",null)\",\n+                                ValueType.STRING\n+                            )\n+                        )                        .setInterval(querySegmentSpec(Filtration.eternity()))\n+                        .setDimensions(\n+                            dimensions(\n+                                new DefaultDimensionSpec(\"v0\", \"d0\", ValueType.STRING),\n+                                new DefaultDimensionSpec(\"v1\", \"d1\", ValueType.STRING)\n+                            )\n+                        )\n+                        .setGranularity(Granularities.ALL)\n+                        .setContext(QUERY_CONTEXT_DEFAULT)\n+                        .build()\n+        ),\n+        NullHandling.replaceWithDefault() ?\n+        ImmutableList.of(\n+            new Object[]{\"dummy\", \"\"},\n+            new Object[]{\"dummy\", \"b\"}\n+        ) :\n+        ImmutableList.of(\n+            new Object[]{\"dummy\", null},", "originalCommit": "777a92230df7e5ab3890df4cefe285792f571aba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUzODkzNA==", "url": "https://github.com/apache/druid/pull/9986#discussion_r435538934", "bodyText": "Nice!", "author": "maytasm", "createdAt": "2020-06-04T20:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUzMDU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUzMTEwMg==", "url": "https://github.com/apache/druid/pull/9986#discussion_r435531102", "bodyText": "This indentation is kind of weird. I'm not sure if checkstyle will flag it, but watch out.", "author": "gianm", "createdAt": "2020-06-04T20:31:04Z", "path": "sql/src/test/java/org/apache/druid/sql/calcite/CalciteQueryTest.java", "diffHunk": "@@ -13419,6 +13420,73 @@ public void testNvlColumns() throws Exception\n     );\n   }\n \n+  @Test\n+  public void testGroupByWithLiteralInSubqueryGrouping() throws Exception\n+  {\n+    testQuery(\n+        \"SELECT \\n\"\n+        + \"   t1, t2\\n\"\n+        + \"  FROM\\n\"\n+        + \"   ( SELECT\\n\"\n+        + \"     'dummy' as t1,\\n\"\n+        + \"     CASE\\n\"\n+        + \"       WHEN \\n\"\n+        + \"         dim4 = 'b'\\n\"\n+        + \"       THEN dim4\\n\"\n+        + \"       ELSE NULL\\n\"\n+        + \"     END AS t2\\n\"\n+        + \"     FROM\\n\"\n+        + \"       numfoo\\n\"\n+        + \"     GROUP BY\\n\"\n+        + \"       dim4\\n\"\n+        + \"   )\\n\"\n+        + \" GROUP BY\\n\"\n+        + \"   t1,t2\\n\",\n+        ImmutableList.of(\n+            GroupByQuery.builder()\n+                        .setDataSource(\n+                            GroupByQuery.builder()\n+                                        .setDataSource(CalciteTests.DATASOURCE3)\n+                                        .setInterval(querySegmentSpec(Filtration.eternity()))\n+                                        .setGranularity(Granularities.ALL)\n+                                        .setDimensions(new DefaultDimensionSpec(\"dim4\", \"_d0\", ValueType.STRING))\n+                                        .setContext(QUERY_CONTEXT_DEFAULT)\n+                                        .build()\n+                        )\n+                        .setVirtualColumns(\n+                            expressionVirtualColumn(\n+                                \"v0\",\n+                                \"\\'dummy\\'\",\n+                                ValueType.STRING\n+                            ),\n+                            expressionVirtualColumn(\n+                                \"v1\",\n+                                \"case_searched((\\\"_d0\\\" == 'b'),\\\"_d0\\\",null)\",\n+                                ValueType.STRING\n+                            )\n+                        )                        .setInterval(querySegmentSpec(Filtration.eternity()))", "originalCommit": "a3e15fd2c021bbe3fa0869c61b80cebad0338bae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUzOTEwOQ==", "url": "https://github.com/apache/druid/pull/9986#discussion_r435539109", "bodyText": "Oops. Fixed.", "author": "maytasm", "createdAt": "2020-06-04T20:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUzMTEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUzMzc5MA==", "url": "https://github.com/apache/druid/pull/9986#discussion_r435533790", "bodyText": "I think there's no need to do this check, because it isn't needed to build the Subtotals object, and computeDimensions will handle the case where we're grouping on something where dimensions are based on expressions that are not translatable.", "author": "gianm", "createdAt": "2020-06-04T20:36:21Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/rel/DruidQuery.java", "diffHunk": "@@ -424,16 +425,39 @@ private static Grouping computeGrouping(\n \n   /**\n    * Builds a {@link Subtotals} object based on {@link Aggregate#getGroupSets()}.\n+   *\n+   * @throws CannotBuildQueryException if subtotals cannot be computed\n    */\n   private static Subtotals computeSubtotals(\n       final PartialDruidQuery partialQuery,\n+      final PlannerContext plannerContext,\n       final RowSignature rowSignature\n   )\n   {\n     final Aggregate aggregate = partialQuery.getAggregate();\n \n     // dimBitMapping maps from input field position to group set position (dimension number).\n-    final int[] dimBitMapping = new int[rowSignature.size()];\n+    final int[] dimBitMapping;\n+    if (partialQuery.getSelectProject() != null) {\n+      int fieldCount = 0;\n+      for (final RexNode rexNode : partialQuery.getSelectProject().getChildExps()) {\n+        final DruidExpression expression = Expressions.toDruidExpression(\n+            plannerContext,\n+            rowSignature,\n+            rexNode\n+        );\n+\n+        if (expression == null) {\n+          throw new CannotBuildQueryException(partialQuery.getSelectProject(), rexNode);", "originalCommit": "a3e15fd2c021bbe3fa0869c61b80cebad0338bae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUzODI0OA==", "url": "https://github.com/apache/druid/pull/9986#discussion_r435538248", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-06-04T20:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUzMzc5MA=="}], "type": "inlineReview"}, {"oid": "19dd058230dd222d2f236ccd9e3fe386f6121b6a", "url": "https://github.com/apache/druid/commit/19dd058230dd222d2f236ccd9e3fe386f6121b6a", "message": "address comments", "committedDate": "2020-06-04T20:47:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3NDA5OA==", "url": "https://github.com/apache/druid/pull/9986#discussion_r435574098", "bodyText": "stale javadoc. remove?", "author": "suneet-s", "createdAt": "2020-06-04T21:53:40Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/rel/DruidQuery.java", "diffHunk": "@@ -424,6 +424,8 @@ private static Grouping computeGrouping(\n \n   /**\n    * Builds a {@link Subtotals} object based on {@link Aggregate#getGroupSets()}.\n+   *\n+   * @throws CannotBuildQueryException if subtotals cannot be computed", "originalCommit": "19dd058230dd222d2f236ccd9e3fe386f6121b6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3ODA1Ng==", "url": "https://github.com/apache/druid/pull/9986#discussion_r435578056", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-06-04T22:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3NDA5OA=="}], "type": "inlineReview"}, {"oid": "8efcb5b725207875b147b4ae62e149c7b09c5932", "url": "https://github.com/apache/druid/commit/8efcb5b725207875b147b4ae62e149c7b09c5932", "message": "update javadocs", "committedDate": "2020-06-04T22:02:30Z", "type": "commit"}]}