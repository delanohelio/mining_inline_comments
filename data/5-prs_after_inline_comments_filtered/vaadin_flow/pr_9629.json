{"pr_number": 9629, "pr_title": "fix(offline): do not cache CSRF token and clear on offline logout", "pr_createdAt": "2020-12-10T11:42:09Z", "pr_url": "https://github.com/vaadin/flow/pull/9629", "timeline": [{"oid": "96d656a3b9bfc80bb9b82b312a38262af31b1def", "url": "https://github.com/vaadin/flow/commit/96d656a3b9bfc80bb9b82b312a38262af31b1def", "message": "fix: do not cache CSRF token and clear on offline logout", "committedDate": "2020-12-10T11:46:39Z", "type": "forcePushed"}, {"oid": "0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6", "url": "https://github.com/vaadin/flow/commit/0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6", "message": "fix: do not cache CSRF token and clear on offline logout", "committedDate": "2020-12-10T12:01:10Z", "type": "commit"}, {"oid": "0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6", "url": "https://github.com/vaadin/flow/commit/0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6", "message": "fix: do not cache CSRF token and clear on offline logout", "committedDate": "2020-12-10T12:01:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1MTUyMw==", "url": "https://github.com/vaadin/flow/pull/9629#discussion_r540951523", "bodyText": "I wonder is it guaranteed that this way of detecting request from SW will keep working in all supported browsers? Have we tested this on Chrome, Firefox and Safari? Any idea if this referer header for SW initiated requests is part of some spec?\nI also started wondering does the user need to download the index page twice now on first load (first normally with the token and then SW would load and precache it without the token)? If so it would be good if we can somehow avoid the double load but that could be a new issue.\nOtherwise the code seems good to me. If it works like intended on all supported browsers now, I'm ok with merging this.", "author": "Haprog", "createdAt": "2020-12-11T13:36:57Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/communication/IndexHtmlRequestHandler.java", "diffHunk": "@@ -162,10 +162,15 @@ private void addDevmodeGizmo(Document indexDocument, VaadinSession session,\n     }\n \n     private void addInitialFlow(JsonObject initialJson, Document indexDocument,\n-                                VaadinSession session) {\n-        String csrfToken = session.getCsrfToken();\n-        if (csrfToken != null) {\n-            initialJson.put(CSRF_TOKEN, csrfToken);\n+                                VaadinSession session, VaadinRequest request) {\n+        // Do not add the CSRF token if the request comes from the service\n+        // worker, to not have the token cached locally (#9537)\n+        String referer = request.getHeader(\"referer\");\n+        if (referer == null || !referer.endsWith(\"/sw.js\")) {", "originalCommit": "0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk5MjQ0OA==", "url": "https://github.com/vaadin/flow/pull/9629#discussion_r540992448", "bodyText": "Tested it on Chrome, Firefox and Safari, and the use case in the ticket work (i.e., enqueueing requests and logging out while offline does not cause the deferred request to complete when going back online). I am doubtful whether referer is a standard or just a lucky coincidence, will do some more investigation regarding that.", "author": "joheriks", "createdAt": "2020-12-11T14:37:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1MTUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2Mjk0OQ==", "url": "https://github.com/vaadin/flow/pull/9629#discussion_r542162949", "bodyText": "I tested that this seems to work ok currently also in Brave, Vivaldi and Firefox with default settings at least.\nBut if I set network.http.sendRefererHeader to 0 in Firefox (about:config), then the detection breaks and CSRF token is stored in workbox cache. Maybe it's still ok for now, but if we get a bug ticket about this later, we might want to consider implementing this in some other way.", "author": "Haprog", "createdAt": "2020-12-14T07:25:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1MTUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI2NjM2Mg==", "url": "https://github.com/vaadin/flow/pull/9629#discussion_r542266362", "bodyText": "Decided to leave this solution for now. Other possibilities if this causes problems are: always sending the token in index.html but filtering it in precaching, as above but with a custom header in the request, or using cookie-based token transfer.", "author": "joheriks", "createdAt": "2020-12-14T10:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1MTUyMw=="}], "type": "inlineReview"}, {"oid": "6c6f748139bb3929669f77f7efaefd53e67a5743", "url": "https://github.com/vaadin/flow/commit/6c6f748139bb3929669f77f7efaefd53e67a5743", "message": "Merge branch 'feature/offline' into joheriks/9537-clear-cstrf-token-on-failed-logout", "committedDate": "2020-12-11T14:07:42Z", "type": "commit"}, {"oid": "a029c0108e92bf76ab140bb1f2f550d8342522c2", "url": "https://github.com/vaadin/flow/commit/a029c0108e92bf76ab140bb1f2f550d8342522c2", "message": "chore: use try-catch instead of then-catch handlers", "committedDate": "2020-12-11T14:13:29Z", "type": "commit"}, {"oid": "56159873cce8f834577f764af7383889d357629f", "url": "https://github.com/vaadin/flow/commit/56159873cce8f834577f764af7383889d357629f", "message": "Merge branch 'feature/offline' into joheriks/9537-clear-cstrf-token-on-failed-logout", "committedDate": "2020-12-14T08:27:58Z", "type": "commit"}]}