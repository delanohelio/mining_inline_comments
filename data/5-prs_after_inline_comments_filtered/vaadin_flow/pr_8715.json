{"pr_number": 8715, "pr_title": "Make it easier to use to paged repositories for data provider data #8557", "pr_createdAt": "2020-07-14T06:07:25Z", "pr_url": "https://github.com/vaadin/flow/pull/8715", "timeline": [{"oid": "21df9570478c48acb047538456ff50728c7a3cc0", "url": "https://github.com/vaadin/flow/commit/21df9570478c48acb047538456ff50728c7a3cc0", "message": "Added shorthands for page index and pagesize\n\nAdded small helpers for those making lazy data binding to \"paging backends\".", "committedDate": "2020-07-13T08:45:15Z", "type": "commit"}, {"oid": "5d3e2b5e52f15e5e7fd10cf48e87cc9d2222bc9f", "url": "https://github.com/vaadin/flow/commit/5d3e2b5e52f15e5e7fd10cf48e87cc9d2222bc9f", "message": "using methods instead of fields directly to pass runtime checks by framework", "committedDate": "2020-07-13T09:00:04Z", "type": "commit"}, {"oid": "218d20d8fdb2dcde1a87c3f80c6c4a84b12ac326", "url": "https://github.com/vaadin/flow/commit/218d20d8fdb2dcde1a87c3f80c6c4a84b12ac326", "message": "Make it easier to use to paged repositories for data provider data #8557", "committedDate": "2020-07-14T06:04:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEzNDU2NQ==", "url": "https://github.com/vaadin/flow/pull/8715#discussion_r454134565", "bodyText": "This and related change in QueryTrace is obsolete as the methods are basically aliases \ud83e\udd14\nBut I'm fine having it this way as well.", "author": "mstahv", "createdAt": "2020-07-14T06:37:11Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -682,20 +707,21 @@ protected Object getFilter() {\n             assert !stream.isParallel();\n         }\n \n-        SizeVerifier verifier = new SizeVerifier<>(limit);\n+        // the number of results can be in range from 0 to pages * pageSize\n+        SizeVerifier verifier = new SizeVerifier<>(pages * pageSize);\n         stream = stream.peek(verifier);\n \n         /*\n          * These restrictions are used to help users to see that they have done\n          * a mistake instead of just letting things work in an unintended way.\n          */\n-        if (!query.isLimitCalled()) {\n+        if (!query.isLimitCalled() && !query.isPageSizeCalled()) {", "originalCommit": "218d20d8fdb2dcde1a87c3f80c6c4a84b12ac326", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE1MjE2Ng==", "url": "https://github.com/vaadin/flow/pull/8715#discussion_r454152166", "bodyText": "I agree, this is a weird change, because page getters call limit&offset getters anyway. I removed page getters verification. The user is able to call only getPage to workaround those checks, but I don't want to attach a heavy verification logic here, checking all combination of getters.", "author": "mshabarov", "createdAt": "2020-07-14T07:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEzNDU2NQ=="}], "type": "inlineReview"}, {"oid": "ed0949a7415125d4705aa2af6e90ea1d19f5503b", "url": "https://github.com/vaadin/flow/commit/ed0949a7415125d4705aa2af6e90ea1d19f5503b", "message": "Page getters verification removed", "committedDate": "2020-07-14T07:14:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MDk1MA==", "url": "https://github.com/vaadin/flow/pull/8715#discussion_r454160950", "bodyText": "This can be achieved with only integer division, by adding the divisor minus one before dividing to ensure upwards rounding:\nfinal int pages = (limit + pageSize-1) / pageSize;\n\nDrawback is it reads less obviously, so would need comment, but I would prefer to do it this way to avoid int \u2194\ufe0e double\u2194\ufe0eint cross-conversion. Alternatively division may not be needed if the below loop is modified to something like:\nfor (int newOffset = offset; newOffset < offset + limit; newOffset += pageSize) {\n ...\n}", "author": "joheriks", "createdAt": "2020-07-14T07:33:24Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -660,19 +660,44 @@ protected Object getFilter() {\n \n     /**\n      * Fetches a list of items from the DataProvider.\n+     * <p>\n+     * <em>NOTE:</em> the {@code limit} parameter shows how many items the\n+     * client wants to fetch, but the actual number of results may be greater,\n+     * and vary from {@code 0 to pages * pageSize}.\n      *\n      * @param offset\n      *            the starting index of the range\n      * @param limit\n-     *            the max number of results\n+     *            the desired number of results\n      * @return the list of items in given range\n      *\n      */\n     @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n     protected Stream<T> fetchFromProvider(int offset, int limit) {\n-        QueryTrace query = new QueryTrace(offset, limit, backEndSorting,\n+        Stream<T> stream = Stream.empty();\n+        QueryTrace query = new QueryTrace(offset, pageSize, backEndSorting,\n                 inMemorySorting, filter);\n-        Stream<T> stream = getDataProvider().fetch(query);\n+        /*\n+         * Items limit value may not be necessarily multiply of page size,\n+         * and thus the pages count is rounded to closest smallest integer.\n+         */\n+        final int pages = (int) Math.ceil((double) limit / pageSize);", "originalCommit": "218d20d8fdb2dcde1a87c3f80c6c4a84b12ac326", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE4MzMwMA==", "url": "https://github.com/vaadin/flow/pull/8715#discussion_r454183300", "bodyText": "Thank you, @joheriks ! That's a great point. I use integer division instead of loop because pages var is used by size verifier either.", "author": "mshabarov", "createdAt": "2020-07-14T08:14:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MDk1MA=="}], "type": "inlineReview"}, {"oid": "4a0f1901262553a99203ede60ce67b3d1e2efee7", "url": "https://github.com/vaadin/flow/commit/4a0f1901262553a99203ede60ce67b3d1e2efee7", "message": "Improve page count calculation", "committedDate": "2020-07-14T08:12:50Z", "type": "commit"}]}