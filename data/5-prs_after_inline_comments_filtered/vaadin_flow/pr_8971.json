{"pr_number": 8971, "pr_title": "Do not force installation of compatible pnpm version when system property `vaadin.ignoreVersionChecks` is set", "pr_createdAt": "2020-09-08T11:41:47Z", "pr_url": "https://github.com/vaadin/flow/pull/8971", "timeline": [{"oid": "fc0086c0799371c20fca93e435fe74636a605e68", "url": "https://github.com/vaadin/flow/commit/fc0086c0799371c20fca93e435fe74636a605e68", "message": "Do not force installation of compatible pnpm version when system property `vaadin.ignoreVersionChecks` is set", "committedDate": "2020-09-08T11:55:04Z", "type": "forcePushed"}, {"oid": "90605de29958098f5bfe7e704e76cf284d075db5", "url": "https://github.com/vaadin/flow/commit/90605de29958098f5bfe7e704e76cf284d075db5", "message": "Do not force installation of compatible pnpm version when system property `vaadin.ignoreVersionChecks` is set", "committedDate": "2020-09-08T11:57:47Z", "type": "commit"}, {"oid": "90605de29958098f5bfe7e704e76cf284d075db5", "url": "https://github.com/vaadin/flow/commit/90605de29958098f5bfe7e704e76cf284d075db5", "message": "Do not force installation of compatible pnpm version when system property `vaadin.ignoreVersionChecks` is set", "committedDate": "2020-09-08T11:57:47Z", "type": "forcePushed"}, {"oid": "87db010b2d80ad940fdc5d33a2dad12c9697960f", "url": "https://github.com/vaadin/flow/commit/87db010b2d80ad940fdc5d33a2dad12c9697960f", "message": "Address Sonar concerns", "committedDate": "2020-09-08T12:49:44Z", "type": "forcePushed"}, {"oid": "0f6d11ec18e20403205d41fc88aaf2301fae9a01", "url": "https://github.com/vaadin/flow/commit/0f6d11ec18e20403205d41fc88aaf2301fae9a01", "message": "Address Sonar concerns", "committedDate": "2020-09-08T13:53:32Z", "type": "commit"}, {"oid": "0f6d11ec18e20403205d41fc88aaf2301fae9a01", "url": "https://github.com/vaadin/flow/commit/0f6d11ec18e20403205d41fc88aaf2301fae9a01", "message": "Address Sonar concerns", "committedDate": "2020-09-08T13:53:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyMjQ0MA==", "url": "https://github.com/vaadin/flow/pull/8971#discussion_r485422440", "bodyText": "Two issues here:\n\nskip version check is done after version check. Version check may throw an exception and skip will not skip.\nFrontendTools has been created to avoid static things like  FrontendUtils.skippingVersionCheck.\n\nskip version check flag should be passed to the FrontendTools  CTOR.\nFrontendUtils  as a helper class should contain only helper generic methods.\nEverything else should be a state of FrontendTools otherwise it goes to the same direction as  FrontendTools", "author": "denis-anisimov", "createdAt": "2020-09-09T08:13:20Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/FrontendTools.java", "diffHunk": "@@ -676,32 +676,39 @@ private String getNonNull(String... valueArray) {\n         return returnCommand;\n     }\n \n-    private List<String> getSuitablePnpm(String dir) {\n+    List<String> getSuitablePnpm(String dir) {\n         final List<String> pnpmCommand = getPnpmExecutable(dir, false);\n-        if (!pnpmCommand.isEmpty()) {\n-            // check whether globally or locally installed pnpm is new enough\n-            try {\n-                List<String> versionCmd = new ArrayList<>(pnpmCommand);\n-                versionCmd.add(\"--version\"); // NOSONAR\n-                FrontendVersion pnpmVersion = FrontendUtils.getVersion(\"pnpm\",\n-                        versionCmd);\n-                if (FrontendUtils.isVersionAtLeast(pnpmVersion,\n-                        SUPPORTED_PNPM_VERSION)\n-                        && pnpmVersion.isOlderThan(BREAKING_PNPM_VERSION)) {\n+        if (pnpmCommand.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+        // check whether globally or locally installed pnpm is new enough\n+        try {\n+            List<String> versionCmd = new ArrayList<>(pnpmCommand);\n+            versionCmd.add(\"--version\"); // NOSONAR\n+            FrontendVersion pnpmVersion = FrontendUtils.getVersion(\"pnpm\",\n+                    versionCmd);\n+            if (FrontendUtils.isVersionAtLeast(pnpmVersion,\n+                    SUPPORTED_PNPM_VERSION)\n+                    && pnpmVersion.isOlderThan(BREAKING_PNPM_VERSION)) {\n+                return pnpmCommand;\n+            } else {\n+                final String pnpmCommandString = String.join(\" \", pnpmCommand);\n+                getLogger().warn(\n+                        \"installed pnpm ('{}', version {}) is not in the compatible versions range (>={}, <{})\",\n+                        pnpmCommandString, pnpmVersion.getFullVersion(),\n+                        SUPPORTED_PNPM_VERSION.getFullVersion(),\n+                        BREAKING_PNPM_VERSION.getFullVersion());\n+                if (FrontendUtils.skippingVersionCheck()) {", "originalCommit": "0f6d11ec18e20403205d41fc88aaf2301fae9a01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxOTMyMQ==", "url": "https://github.com/vaadin/flow/pull/8971#discussion_r485719321", "bodyText": "Good point! Now uses the found pnpm even if the version check failed (i.e., threw UnknownVersionException). Also removed the static method FrontendUtils::skippingVersionCheck, added ctor parameter, and moved the logic to FrontendTools.", "author": "joheriks", "createdAt": "2020-09-09T15:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyMjQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyNDE4Ng==", "url": "https://github.com/vaadin/flow/pull/8971#discussion_r485424186", "bodyText": "Making flag a parameter in the CTOR will allow to test FrontendTools  properly: without any system properties.\nEvery code which sets system property is not thread safe at least: the same property may be modified outside of this test at any time.", "author": "denis-anisimov", "createdAt": "2020-09-09T08:16:19Z", "path": "flow-server/src/test/java/com/vaadin/flow/server/frontend/FrontendToolsTest.java", "diffHunk": "@@ -489,6 +489,49 @@ public void should_useHomeNpmFirst() throws Exception {\n         assertNpmCommand(() -> vaadinHomeDir);\n     }\n \n+    @Test\n+    public void getSuitablePnpm_compatibleVersionInstalled_accepted() throws Exception {\n+        Assume.assumeFalse(\n+                tools.getNodeExecutable().isEmpty());\n+        createFakePnpm(\"4.5.0\");\n+        List<String> pnpmCommand = tools.getSuitablePnpm(baseDir);\n+        Assert.assertNotEquals(\"expected pnpm version 4.5.0 accepted\", 0,\n+                pnpmCommand.size());\n+    }\n+    @Test\n+    public void getSuitablePnpm_tooNewVersionInstalled_rejected() throws Exception {\n+        Assume.assumeFalse(\n+                tools.getNodeExecutable().isEmpty());\n+        createFakePnpm(\"5.5.0\");\n+        List<String> pnpmCommand = tools.getSuitablePnpm(baseDir);\n+        Assert.assertEquals(\"expected pnpm version 5.5.0 rejected\", 0,\n+                pnpmCommand.size());\n+    }\n+\n+    @Test\n+    public void getSuitablePnpm_tooNewVersionInstalledAndSkipVersionCheck_accepted()\n+            throws Exception {\n+        Assume.assumeFalse(\n+                tools.getNodeExecutable().isEmpty());\n+        String originalPropertyValue = System", "originalCommit": "0f6d11ec18e20403205d41fc88aaf2301fae9a01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxOTQ1OQ==", "url": "https://github.com/vaadin/flow/pull/8971#discussion_r485719459", "bodyText": "Done.", "author": "joheriks", "createdAt": "2020-09-09T15:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyNDE4Ng=="}], "type": "inlineReview"}, {"oid": "5ec8b216bca3b8a224c2520a2a62fd838fc84701", "url": "https://github.com/vaadin/flow/commit/5ec8b216bca3b8a224c2520a2a62fd838fc84701", "message": "Use found pnpm even if version check fails when `ignoreVersionChecks=true`. Package private ctor in FrontendTools with ignoreVersionChecks parameter.", "committedDate": "2020-09-09T14:24:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA3MzMzMA==", "url": "https://github.com/vaadin/flow/pull/8971#discussion_r486073330", "bodyText": "I would avoid version check via getVersion  at all if it should be ignored anyway: it takes additional time\nand it may throw an exception whose catching is always more expensive than just check a condition.\nNot blocking though.\nThe only benefit from the current code is logging about failed version check but this is something we failed internally: the node of course has some version and we just not able to detect it. So it's an internal issue which will be ignored anyway. So I don't see why spend significant time on checking something which won't be used anyway.", "author": "denis-anisimov", "createdAt": "2020-09-10T05:26:09Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/FrontendTools.java", "diffHunk": "@@ -297,10 +308,12 @@ public void validateNodeAndNpmVersion() {\n             List<String> nodeVersionCommand = new ArrayList<>();\n             nodeVersionCommand.add(getNodeExecutable());\n             nodeVersionCommand.add(\"--version\"); // NOSONAR\n-            FrontendVersion nodeVersion = FrontendUtils.getVersion(\"node\",\n+            FrontendVersion foundNodeVersion = FrontendUtils.getVersion(\"node\",\n                     nodeVersionCommand);\n-            FrontendUtils.validateToolVersion(\"node\", nodeVersion,\n-                    SUPPORTED_NODE_VERSION, SHOULD_WORK_NODE_VERSION);\n+            if (!ignoreVersionChecks) {", "originalCommit": "5ec8b216bca3b8a224c2520a2a62fd838fc84701", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA5OTUyMA==", "url": "https://github.com/vaadin/flow/pull/8971#discussion_r486099520", "bodyText": "After more consideration, I agree. My initial line of thinking was that the log about incompatible pnpm would be good anyway. And it's \"ignore\" version checks rather than \"skip\" version checks. However, if one is setting this flag one probably knows what one is doing.", "author": "joheriks", "createdAt": "2020-09-10T06:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA3MzMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA3NDI0NQ==", "url": "https://github.com/vaadin/flow/pull/8971#discussion_r486074245", "bodyText": "Same here: check is done after attempt to get a version and check whether it's good enough.\nWhy just don't return immediately without any checks in case  ignoreVersionChecks?", "author": "denis-anisimov", "createdAt": "2020-09-10T05:29:27Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/FrontendTools.java", "diffHunk": "@@ -676,34 +691,42 @@ private String getNonNull(String... valueArray) {\n         return returnCommand;\n     }\n \n-    private List<String> getSuitablePnpm(String dir) {\n+    List<String> getSuitablePnpm(String dir) {\n         final List<String> pnpmCommand = getPnpmExecutable(dir, false);\n-        if (!pnpmCommand.isEmpty()) {\n-            // check whether globally or locally installed pnpm is new enough\n-            try {\n-                List<String> versionCmd = new ArrayList<>(pnpmCommand);\n-                versionCmd.add(\"--version\"); // NOSONAR\n-                FrontendVersion pnpmVersion = FrontendUtils.getVersion(\"pnpm\",\n-                        versionCmd);\n-                if (FrontendUtils.isVersionAtLeast(pnpmVersion,\n-                        SUPPORTED_PNPM_VERSION)\n-                        && pnpmVersion.isOlderThan(BREAKING_PNPM_VERSION)) {\n-                    return pnpmCommand;\n-                } else {\n-                    getLogger().warn(String.format(\n-                            \"installed pnpm ('%s', version %s) is not in the compatible versions range (>=%s, <%s), installing supported version locally\",\n-                            String.join(\" \", pnpmCommand),\n-                            pnpmVersion.getFullVersion(),\n-                            SUPPORTED_PNPM_VERSION.getFullVersion(),\n-                            BREAKING_PNPM_VERSION.getFullVersion()));\n-                }\n-            } catch (UnknownVersionException e) {\n+        if (pnpmCommand.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+        final String pnpmCommandString = String.join(\" \", pnpmCommand);\n+        // check whether globally or locally installed pnpm is new enough\n+        try {\n+            List<String> versionCmd = new ArrayList<>(pnpmCommand);\n+            versionCmd.add(\"--version\"); // NOSONAR\n+            FrontendVersion pnpmVersion = FrontendUtils.getVersion(\"pnpm\",\n+                    versionCmd);\n+            if (FrontendUtils.isVersionAtLeast(pnpmVersion,\n+                    SUPPORTED_PNPM_VERSION)\n+                    && pnpmVersion.isOlderThan(BREAKING_PNPM_VERSION)) {\n+                return pnpmCommand;\n+            } else {\n                 getLogger().warn(\n-                        \"Error checking pnpm version, installing pnpm locally\",\n-                        e);\n+                        \"installed pnpm ('{}', version {}) is not in the compatible versions range (>={}, <{})\",\n+                        pnpmCommandString, pnpmVersion.getFullVersion(),\n+                        SUPPORTED_PNPM_VERSION.getFullVersion(),\n+                        BREAKING_PNPM_VERSION.getFullVersion());\n             }\n+        } catch (UnknownVersionException e) {\n+            getLogger().warn(\"error checking pnpm version\", e);\n+        }\n+        if (ignoreVersionChecks) {", "originalCommit": "5ec8b216bca3b8a224c2520a2a62fd838fc84701", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA5OTU3Mw==", "url": "https://github.com/vaadin/flow/pull/8971#discussion_r486099573", "bodyText": "Done.", "author": "joheriks", "createdAt": "2020-09-10T06:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA3NDI0NQ=="}], "type": "inlineReview"}, {"oid": "8e27ca09f882d066e29c9b39dac039d9d2af9cf1", "url": "https://github.com/vaadin/flow/commit/8e27ca09f882d066e29c9b39dac039d9d2af9cf1", "message": "Skip version check altogether when ignoreVersionChecks flag is set", "committedDate": "2020-09-10T06:35:28Z", "type": "commit"}]}