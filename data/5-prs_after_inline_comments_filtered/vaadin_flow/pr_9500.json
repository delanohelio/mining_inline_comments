{"pr_number": 9500, "pr_title": "fix: Initialize VaadinServlet after Lookup is available", "pr_createdAt": "2020-11-26T05:56:24Z", "pr_url": "https://github.com/vaadin/flow/pull/9500", "timeline": [{"oid": "9ab327090582ce860c482c253cbb6636840551a6", "url": "https://github.com/vaadin/flow/commit/9ab327090582ce860c482c253cbb6636840551a6", "message": "fix: don't initialize Vaadin servlet until Lookup is not available", "committedDate": "2020-11-26T06:26:59Z", "type": "commit"}, {"oid": "9ab327090582ce860c482c253cbb6636840551a6", "url": "https://github.com/vaadin/flow/commit/9ab327090582ce860c482c253cbb6636840551a6", "message": "fix: don't initialize Vaadin servlet until Lookup is not available", "committedDate": "2020-11-26T06:26:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwMzkzMQ==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530803931", "bodyText": "init is called by the container so why would this be called more than once.\nAlso I don't know the reason why we are overriding init(ServletConfig) except to get the config when we could just override init() and get the config with getServletConfig() and not have to call super.init", "author": "caalador", "createdAt": "2020-11-26T06:47:36Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/VaadinServlet.java", "diffHunk": "@@ -64,23 +66,35 @@\n     @Override\n     public void init(ServletConfig servletConfig) throws ServletException {\n         CurrentInstance.clearAll();\n-        super.init(servletConfig);\n \n-        try {\n-            servletService = createServletService();\n-        } catch (ServiceException e) {\n-            throw new ServletException(\"Could not initialize VaadinServlet\", e);\n+        if (getServletConfig() == null) {", "originalCommit": "9ab327090582ce860c482c253cbb6636840551a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwOTU3Mw==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530809573", "bodyText": "Yeah this check makes no sense according to the javadocs of the init methods", "author": "pleku", "createdAt": "2020-11-26T07:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwMzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgxNTM1NA==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530815354", "bodyText": "Yeah, why init is not overriden instead is not clean.\nBut I think it allows to override init without caring to call super.init().\nIt's not supposed that you are going to override super.init(ServletConfig).\nIn \"plain\" WAR case nothing is changed: init will be called once by the container and it never will be called one more time.\nThis is done for OSGi case: even though if ServletContextListener (which is registered via HTTP Whiteboard spec) is instantiated before the servlet is registered the ServletContextListener::contextInitialized method may be called after Servlet::init which is quite unexpected.\nThat doesn't allow to put all necessary info into the ServletContext before the servlet is initialized.\nIn the latter case ServletContextListener::contextInitialized will call Servlet::init  if the servlet is not yet initialized.", "author": "denis-anisimov", "createdAt": "2020-11-26T07:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwMzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgxODc3Mg==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530818772", "bodyText": "Yeah this check makes no sense according to the javadocs of the init methods\n\nI have no any idea what you are talking about .\nWhich javadoc ?\nThis  check allows to check whether this is the first time of method call or not.", "author": "denis-anisimov", "createdAt": "2020-11-26T07:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwMzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgzMzc4Ng==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530833786", "bodyText": "is the initial context more valuable than the secondary?\nShouldn't they be the same so setting it shouldn't be a problem as super.init(context) only stores the reference.", "author": "caalador", "createdAt": "2020-11-26T07:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwMzkzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwMzk1Mw==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530803953", "bodyText": "Who will call again for the init of a VaadinServlet?\nThe container should only inform once that you are being taken into use.", "author": "caalador", "createdAt": "2020-11-26T06:47:38Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/VaadinServlet.java", "diffHunk": "@@ -64,23 +66,35 @@\n     @Override\n     public void init(ServletConfig servletConfig) throws ServletException {\n         CurrentInstance.clearAll();\n-        super.init(servletConfig);\n \n-        try {\n-            servletService = createServletService();\n-        } catch (ServiceException e) {\n-            throw new ServletException(\"Could not initialize VaadinServlet\", e);\n+        if (getServletConfig() == null) {\n+            super.init(servletConfig);\n+        }\n+\n+        ServletContext servletContext = getServletConfig().getServletContext();\n+        if (new VaadinServletContext(servletContext)\n+                .getAttribute(Lookup.class) == null) {\n+            return;", "originalCommit": "9ab327090582ce860c482c253cbb6636840551a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgxNjUxMw==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530816513", "bodyText": "See above.\ninit methods are evil: it's public method which may be called by anyone at any time.\nIt's supposed that it will be called by the container. But Java API doesn't prevent to call this method by anyone at any point.\nSo in fact this method should be normally implemented to be aware of the fact that it can be called several times.\ninit methods make API weak overall.\nIn WAR case nothing changes.\nThis is needed for OSGi only", "author": "denis-anisimov", "createdAt": "2020-11-26T07:21:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwMzk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgzMzI2Mw==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530833263", "bodyText": "I would merge this if check to the lookup check so we would always return if service is initialized or Lookup is missing.", "author": "caalador", "createdAt": "2020-11-26T07:58:15Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/VaadinServlet.java", "diffHunk": "@@ -64,23 +66,35 @@\n     @Override\n     public void init(ServletConfig servletConfig) throws ServletException {\n         CurrentInstance.clearAll();\n-        super.init(servletConfig);\n \n-        try {\n-            servletService = createServletService();\n-        } catch (ServiceException e) {\n-            throw new ServletException(\"Could not initialize VaadinServlet\", e);\n+        if (getServletConfig() == null) {\n+            super.init(servletConfig);\n+        }\n+\n+        ServletContext servletContext = getServletConfig().getServletContext();\n+        if (new VaadinServletContext(servletContext)\n+                .getAttribute(Lookup.class) == null) {\n+            return;\n         }\n \n-        // Sets current service as it is needed in static file server even\n-        // though there are no request and response.\n-        servletService.setCurrentInstances(null, null);\n+        if (servletService == null) {", "originalCommit": "9ab327090582ce860c482c253cbb6636840551a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg0NzIzMw==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530847233", "bodyText": "Actually this comment  allowed me to find a bug: return may be called without calling CurrentInstance.clearAll().", "author": "denis-anisimov", "createdAt": "2020-11-26T08:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgzMzI2Mw=="}], "type": "inlineReview"}, {"oid": "fff803728b9e25b66913a7ffddb41e15c63c065c", "url": "https://github.com/vaadin/flow/commit/fff803728b9e25b66913a7ffddb41e15c63c065c", "message": "fix : merge two \"if\" checks and call clearAll in finally block", "committedDate": "2020-11-26T08:27:38Z", "type": "commit"}, {"oid": "ae6a15965899c79a8816095fd39eee63a3670da7", "url": "https://github.com/vaadin/flow/commit/ae6a15965899c79a8816095fd39eee63a3670da7", "message": "fix: prevent call \"init\" method with different config instance", "committedDate": "2020-11-26T08:41:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2MzM3NA==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530863374", "bodyText": "Please add a comment here that this method is called the second time for OSGi and why it is so.\nThe practice of \"answer review questions in code\" is in my opinion a good one, as it makes the maintenance of the code easier. If there is something that cannot be understood from just looking at the code, it should be commented there.", "author": "pleku", "createdAt": "2020-11-26T08:50:37Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/VaadinServlet.java", "diffHunk": "@@ -64,23 +66,43 @@\n     @Override\n     public void init(ServletConfig servletConfig) throws ServletException {\n         CurrentInstance.clearAll();\n-        super.init(servletConfig);\n \n         try {\n-            servletService = createServletService();\n-        } catch (ServiceException e) {\n-            throw new ServletException(\"Could not initialize VaadinServlet\", e);\n-        }\n+            if (getServletConfig() == null) {", "originalCommit": "ae6a15965899c79a8816095fd39eee63a3670da7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3NzAyOA==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530877028", "bodyText": "I will add it but it's useless.\nOSGi is in the different repo. Without looking at the code and knowing the context the comment means anything to someone who will see this code first time.\nOr may be the comment should be formulated in a totally different way. In that case it makes sense.", "author": "denis-anisimov", "createdAt": "2020-11-26T09:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2MzM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3OTM0OA==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530879348", "bodyText": "In case there is no comment, it will be impossible to know that the reason for this code is to support some code that is in another repository. The tests in this repository should prevent them from breaking things, but they will not still be able to understand why the code is like that when it looks like it should not be (based on the javadocs for servlet). Then they have to spend time to search history/blame for the changes that were done and check the review for help on understanding. That will take time that a simple comment could have spared them from.", "author": "pleku", "createdAt": "2020-11-26T09:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2MzM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg5MjczOA==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530892738", "bodyText": "Yes and no.\nThe comment should be extremely simple and give the idea why it's done this way and not another without going into details.\nI was against of \"mentioning\" OSGi here: because it's useless. If you don't even know what OSGi is the comment gives you 0 chances to make anything clearer.\nBut I've added the comment which makes OSGi just a detail. So that way it has sense.", "author": "denis-anisimov", "createdAt": "2020-11-26T09:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2MzM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2NTQ5NQ==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530865495", "bodyText": "Apparently there is no (existing) test for verifying that the current instances are cleared, as you've stated that you almost caused that bug yourself. Should unit test this ?", "author": "pleku", "createdAt": "2020-11-26T08:54:18Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/VaadinServlet.java", "diffHunk": "@@ -64,23 +66,43 @@\n     @Override\n     public void init(ServletConfig servletConfig) throws ServletException {\n         CurrentInstance.clearAll();\n-        super.init(servletConfig);\n \n         try {\n-            servletService = createServletService();\n-        } catch (ServiceException e) {\n-            throw new ServletException(\"Could not initialize VaadinServlet\", e);\n-        }\n+            if (getServletConfig() == null) {\n+                super.init(servletConfig);\n+            }\n+\n+            if (getServletConfig() != servletConfig) {\n+                throw new IllegalArgumentException(\n+                        \"Servlet config instance may not differ from the \"\n+                                + \"instance which has been used for the initial method call\");\n+            }\n \n-        // Sets current service as it is needed in static file server even\n-        // though there are no request and response.\n-        servletService.setCurrentInstances(null, null);\n+            ServletContext servletContext = getServletConfig()\n+                    .getServletContext();\n+            if (servletService != null\n+                    || new VaadinServletContext(servletContext)\n+                            .getAttribute(Lookup.class) == null) {\n+                return;\n+            }\n \n-        staticFileHandler = createStaticFileHandler(servletService);\n+            try {\n+                servletService = createServletService();\n+            } catch (ServiceException e) {\n+                throw new ServletException(\"Could not initialize VaadinServlet\",\n+                        e);\n+            }\n \n-        servletInitialized();\n-        CurrentInstance.clearAll();\n+            // Sets current service as it is needed in static file server even\n+            // though there are no request and response.\n+            servletService.setCurrentInstances(null, null);\n \n+            staticFileHandler = createStaticFileHandler(servletService);\n+\n+            servletInitialized();\n+        } finally {\n+            CurrentInstance.clearAll();", "originalCommit": "ae6a15965899c79a8816095fd39eee63a3670da7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3ODM3MQ==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530878371", "bodyText": "Sure.\n#9503\nThis is not a new code and it had no unit tests so this is a separate issue.", "author": "denis-anisimov", "createdAt": "2020-11-26T09:15:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2NTQ5NQ=="}], "type": "inlineReview"}, {"oid": "c8385025cad9150d3fe04dac5a8e3cdeb562bc61", "url": "https://github.com/vaadin/flow/commit/c8385025cad9150d3fe04dac5a8e3cdeb562bc61", "message": "fix: fix unit tests", "committedDate": "2020-11-26T09:31:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkyMDY4OA==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530920688", "bodyText": "This could instead just be a check at the beginning of init that if\nif(this.equals(getServlet())) return; or at least the mocks should be included inside the if as they are not used in this case\nBasically we have gone wrong at creation as the constructor init will create an instantiator that we then set later again. Perhaps we should have a constructor that takes in the instantiator so init is only called once by the tests.", "author": "caalador", "createdAt": "2020-11-26T10:18:51Z", "path": "flow-polymer-template/src/test/java/com/vaadin/flow/server/MockVaadinServletService.java", "diffHunk": "@@ -120,7 +120,10 @@ public void init() {\n                     .thenReturn(resourceProvider);\n             Mockito.when(context.getAttribute(Lookup.class.getName()))\n                     .thenReturn(lookup);\n-            getServlet().init(config);\n+            if ( getServlet().getServletConfig() ==null) {", "originalCommit": "e1e889355d8360110bb98a0827f9c221d2568074", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk1MjIwOQ==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530952209", "bodyText": "I didn't get how this which is instance of VaadinService may equal a servlet instance but this doesn't matter.\nI've redone this.", "author": "denis-anisimov", "createdAt": "2020-11-26T11:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkyMDY4OA=="}], "type": "inlineReview"}, {"oid": "3dd49c9b06c1f01fa3eb6c3fc1742c2c88e0f985", "url": "https://github.com/vaadin/flow/commit/3dd49c9b06c1f01fa3eb6c3fc1742c2c88e0f985", "message": "fix: fix unit test", "committedDate": "2020-11-26T11:09:48Z", "type": "commit"}, {"oid": "3dd49c9b06c1f01fa3eb6c3fc1742c2c88e0f985", "url": "https://github.com/vaadin/flow/commit/3dd49c9b06c1f01fa3eb6c3fc1742c2c88e0f985", "message": "fix: fix unit test", "committedDate": "2020-11-26T11:09:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MTc1Mw==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530961753", "bodyText": "This makes the init use the wrong instantiator for all the initial things making this init method basically useless.", "author": "caalador", "createdAt": "2020-11-26T11:26:17Z", "path": "flow-polymer-template/src/test/java/com/vaadin/flow/server/MockVaadinServletService.java", "diffHunk": "@@ -95,8 +95,6 @@ protected RouteRegistry getRouteRegistry() {\n \n     public void init(Instantiator instantiator) {\n         this.instantiator = instantiator;\n-\n-        init();", "originalCommit": "3dd49c9b06c1f01fa3eb6c3fc1742c2c88e0f985", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MzAwMg==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530963002", "bodyText": "Tests are passing........\nWell, I will revert everything back since I don't understand your previous comment.", "author": "denis-anisimov", "createdAt": "2020-11-26T11:28:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk4NTQxOQ==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530985419", "bodyText": "I guess the usage of the init(Instantiator) should be that we wouldn't execute VaadinService.createInstantiator()  but we now execute this as the first line in VaadinService.init() is instantiator = createInstantiator();\nofc it blocks any other instantiations later in the tests.", "author": "caalador", "createdAt": "2020-11-26T12:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MTc1Mw=="}], "type": "inlineReview"}, {"oid": "4363810e206a44ae9e4960aed0ac22f1ce6281d5", "url": "https://github.com/vaadin/flow/commit/4363810e206a44ae9e4960aed0ac22f1ce6281d5", "message": "fix: one more tests fix", "committedDate": "2020-11-26T11:33:15Z", "type": "commit"}, {"oid": "4363810e206a44ae9e4960aed0ac22f1ce6281d5", "url": "https://github.com/vaadin/flow/commit/4363810e206a44ae9e4960aed0ac22f1ce6281d5", "message": "fix: one more tests fix", "committedDate": "2020-11-26T11:33:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk4MzMyMg==", "url": "https://github.com/vaadin/flow/pull/9500#discussion_r530983322", "bodyText": "Non-blocking: typoed servletcontextlistener. Also I don't think it is necessary to lecture about how \"anyone call this method at any time\" and \"weak API\". I would have just settled for the reason:\n\"This init method is called twice in some scenarios, like with OSGi {@code ServletContextListener} because not all things are available when the container triggers the first init. Duplicate initialization needs to be avoided and creation of service needs lookup to be present.\"", "author": "pleku", "createdAt": "2020-11-26T12:05:04Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/VaadinServlet.java", "diffHunk": "@@ -68,6 +68,22 @@ public void init(ServletConfig servletConfig) throws ServletException {\n         CurrentInstance.clearAll();\n \n         try {\n+            /*\n+             * There are plenty of reasons why the check should be done. The\n+             * main reason is: init method is public which means that everyone\n+             * may call this method at any time (including an app developer).\n+             * But it's not supposed to be called any times any time.\n+             * \n+             * This code protects weak API from being called several times so\n+             * that config is reset after the very first initialization.\n+             * \n+             * Normally \"init\" method is called only once by the servlet\n+             * container. But in a specific OSGi case {@code\n+             * ServletCointextListener} may be called after the servlet\n+             * initialized. To be able to initialize the VaadinServlet properly\n+             * its \"init\" method is called from the {@code\n+             * ServletCointextListener} with the same ServletConfig instance.", "originalCommit": "4363810e206a44ae9e4960aed0ac22f1ce6281d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}