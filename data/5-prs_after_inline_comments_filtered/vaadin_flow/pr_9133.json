{"pr_number": 9133, "pr_title": "fix: store app shell title into UI instead of AppShellRegistry", "pr_createdAt": "2020-10-07T19:53:44Z", "pr_url": "https://github.com/vaadin/flow/pull/9133", "timeline": [{"oid": "458040ba7b6a0ee5240a86739bc11d10b4cc8343", "url": "https://github.com/vaadin/flow/commit/458040ba7b6a0ee5240a86739bc11d10b4cc8343", "message": "fix: store app shell title into UI instead of AppShellRegistry", "committedDate": "2020-10-07T19:47:15Z", "type": "commit"}, {"oid": "5bf4664c8a37460f6e9ae24b4e9e94f08c249ce7", "url": "https://github.com/vaadin/flow/commit/5bf4664c8a37460f6e9ae24b4e9e94f08c249ce7", "message": "Merge branch 'master' into haijian/fix-singleton-app-shell-title", "committedDate": "2020-10-07T19:56:41Z", "type": "commit"}, {"oid": "78c7597fd9f8c74dd71d929761525a12293ef8a8", "url": "https://github.com/vaadin/flow/commit/78c7597fd9f8c74dd71d929761525a12293ef8a8", "message": "fix compile errors after merge", "committedDate": "2020-10-07T20:14:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyNDIxMA==", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r501524210", "bodyText": "Note: this is technically a breaking change now that AppShellRegistry#getTitle() is removed.\nShould we deprecate it instead for now?", "author": "platosha", "createdAt": "2020-10-08T08:04:32Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/AppShellRegistry.java", "diffHunk": "@@ -162,15 +160,6 @@ public boolean isShell(Class<?> clz) {\n         }\n     }\n \n-    /**\n-     * Return the text content of the title tag in the application shell.\n-     *\n-     * @return title;\n-     */\n-    public String getTitle() {", "originalCommit": "78c7597fd9f8c74dd71d929761525a12293ef8a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU5NDYwNA==", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r501594604", "bodyText": "I'm not sure. If we deprecate it, do we also need to keep/add logic so it returns what it used to?\nI guess it would be good to have deprecation before removal, but I'm not sure if it's ok to just remove in this case.", "author": "Haprog", "createdAt": "2020-10-08T09:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyNDIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU5ODM0Mg==", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r501598342", "bodyText": "For backporting the fix we probably should not remove it though.", "author": "Haprog", "createdAt": "2020-10-08T10:02:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyNDIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0Mjg2MA==", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r501942860", "bodyText": "Yep, good point, marked it as @Deprecated now", "author": "haijian-vaadin", "createdAt": "2020-10-08T18:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyNDIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4NjAxNA==", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502286014", "bodyText": "This (currently returning null) will make this also a breaking change since most likely most code using this method will end up NPE. Then I wonder if the method should be just removed ? As keeping it for \"backwards compatibility\" but then also making it break apps that use it is a bit weird. So instead of returning a null, you could just throw and exception with a clear message that says \"use xyz instead\". But as this change is targeted for master so IMO it is even fine to remove the method in this PR, and use the deprecation in the change for 4.0 with either a clear error thrown or returning the old value.\nAnyway what happens here should be in the release notes.", "author": "pleku", "createdAt": "2020-10-09T08:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyNDIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzMDgyMg==", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502330822", "bodyText": "This PR should be cherry-picked to 4.0, so I think maybe we keep it as Deprecated in this PR, so we can cherry-pick as is to 4.0, then make another PR in master to remove it.\nI will update the PR to throw an exception instead.", "author": "haijian-vaadin", "createdAt": "2020-10-09T10:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyNDIxMA=="}], "type": "inlineReview"}, {"oid": "7208b0bed573c1390101ca0b85bcd1f7a208a2bf", "url": "https://github.com/vaadin/flow/commit/7208b0bed573c1390101ca0b85bcd1f7a208a2bf", "message": "apply code review suggestions", "committedDate": "2020-10-08T18:51:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4OTQwNg==", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502289406", "bodyText": "a) Isn't this always null unless the legacy bootstrapping is used ? If the code calling this method cannot be moved inside the if-else that checks that checks the bootstrapping mode, a comment could point here that \"this is only for the legacy bootstrapping\"\nb) IMO UI.getCurrent().ifPresent(ui -> ... would be cleaner code\nc) this code is not formatted", "author": "pleku", "createdAt": "2020-10-09T09:01:05Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/communication/IndexHtmlRequestHandler.java", "diffHunk": "@@ -126,6 +130,16 @@ public boolean synchronizedHandleRequest(VaadinSession session,\n         return true;\n     }\n \n+    private void storeAppShellTitleToUI(Document indexDocument) {\n+        if(UI.getCurrent()!=null){", "originalCommit": "7208b0bed573c1390101ca0b85bcd1f7a208a2bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzMTU3Ng==", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502331576", "bodyText": "It's also won't be null when eagerServerLoad is configured.\nI will update the code for other suggestions.", "author": "haijian-vaadin", "createdAt": "2020-10-09T10:19:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4OTQwNg=="}], "type": "inlineReview"}, {"oid": "7c66056755e09098169fb9a5e0561b0c3ebe0fdd", "url": "https://github.com/vaadin/flow/commit/7c66056755e09098169fb9a5e0561b0c3ebe0fdd", "message": "add IT tests, apply code review suggestions", "committedDate": "2020-10-09T11:10:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM2NDk4OQ==", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502364989", "bodyText": "Slightly nit picking and thus not blocking: could verify that the title has been changed here in the middle, since if it for some reason would not be changed from the initial, then this test would not add anything extra to the previous test", "author": "pleku", "createdAt": "2020-10-09T11:31:18Z", "path": "flow-tests/test-ccdm/src/test/java/com/vaadin/flow/ccdmtest/NavigateToServerSideViewWithoutTitleIT.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package com.vaadin.flow.ccdmtest;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+\n+public class NavigateToServerSideViewWithoutTitleIT extends CCDMTest {\n+\n+    @Test\n+    public void should_showAppShellTitle_when_navigateToAServerSideViewWithoutTitle() {\n+        openVaadinRouter();\n+\n+        findAnchor(\"view-with-server-view-button\").click();\n+\n+        // \"app-shell-title\" is defined in AppShell\n+        Assert.assertEquals(\"Shoul use app shell title\", \"app-shell-title\",\n+                getDriver().getTitle());\n+    }\n+\n+    @Test\n+    public void should_showAppShellTitle_after_titleHasBeenChangedOnTheClientSide_when_navigateToAServerSideViewWithoutTitle() {\n+        openVaadinRouter();\n+\n+        // update document.title on the client-side\n+        findElement(By.id(\"updatePageTitle\")).click();", "originalCommit": "7c66056755e09098169fb9a5e0561b0c3ebe0fdd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "789253b6b0dcc84e197816f1019c0dbf6750c99a", "url": "https://github.com/vaadin/flow/commit/789253b6b0dcc84e197816f1019c0dbf6750c99a", "message": "verify document.title was updated on the client-side", "committedDate": "2020-10-09T11:41:56Z", "type": "commit"}, {"oid": "bb559847c8e355b7ca44dd3eeb7a589d195f2ad0", "url": "https://github.com/vaadin/flow/commit/bb559847c8e355b7ca44dd3eeb7a589d195f2ad0", "message": "fix typo", "committedDate": "2020-10-09T11:42:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MTExNQ==", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502381115", "bodyText": "Do not forget to remove this deprecated code someday.", "author": "vaadin-bot", "createdAt": "2020-10-09T12:05:59Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/AppShellRegistry.java", "diffHunk": "@@ -163,12 +161,16 @@ public boolean isShell(Class<?> clz) {\n     }\n \n     /**\n-     * Return the text content of the title tag in the application shell.\n-     *\n-     * @return title;\n+     * @return {code null};\n+     * \n+     * @deprecated this method does not work, to get the application shell title, \n+     * use {code UI.getCurrent().getInternals().getAppShellTitle()} instead.\n      */\n+    @Deprecated\n     public String getTitle() {", "originalCommit": "bb559847c8e355b7ca44dd3eeb7a589d195f2ad0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}