{"pr_number": 7647, "pr_title": "Don't block DevModeInitializer but spawn a thread where all long running tasks are executed", "pr_createdAt": "2020-02-21T14:24:19Z", "pr_url": "https://github.com/vaadin/flow/pull/7647", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYxMzE2Nw==", "url": "https://github.com/vaadin/flow/pull/7647#discussion_r382613167", "bodyText": "Make \"devServerStartFuture\" transient or serializable.", "author": "vaadin-bot", "createdAt": "2020-02-21T14:34:22Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -99,129 +102,34 @@\n \n     private boolean notified = false;\n \n-    private String failedOutput;\n+    private volatile String failedOutput;\n \n     /**\n      * The local installation path of the webpack-dev-server node script.\n      */\n     public static final String WEBPACK_SERVER = \"node_modules/webpack-dev-server/bin/webpack-dev-server.js\";\n \n-    private int port;\n-    private Process webpackProcess;\n+    private volatile int port;\n+    private final AtomicReference<Process> webpackProcess = new AtomicReference<>();\n     private final boolean reuseDevServer;\n-    private DevServerWatchDog watchDog;\n+    private final AtomicReference<DevServerWatchDog> watchDog = new AtomicReference<>();\n \n     private StringBuilder cumulativeOutput = new StringBuilder();\n \n+    private final CompletableFuture<Void> devServerStartFuture;", "originalCommit": "39edc3cb9c00e383b7cf5ba2e69e68016f28e3ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYxMzE4Mg==", "url": "https://github.com/vaadin/flow/pull/7647#discussion_r382613182", "bodyText": "Null passed for non-null parameter of java.util.concurrent.CompletableFuture.getNow(Object) in com.vaadin.flow.server.DevModeHandler.handleRequest(VaadinSession, VaadinRequest, VaadinResponse)", "author": "vaadin-bot", "createdAt": "2020-02-21T14:34:23Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -271,45 +183,44 @@ public static DevModeHandler getDevModeHandler() {\n         return atomicHandler.get();\n     }\n \n+    @Override\n+    public boolean handleRequest(VaadinSession session, VaadinRequest request,\n+            VaadinResponse response) throws IOException {\n+        if (devServerStartFuture.isDone()) {\n+            try {\n+                devServerStartFuture.getNow(null);", "originalCommit": "39edc3cb9c00e383b7cf5ba2e69e68016f28e3ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ea20aa0db1309a0876dcdb662307d1191ec5dba", "url": "https://github.com/vaadin/flow/commit/2ea20aa0db1309a0876dcdb662307d1191ec5dba", "message": "Run (p)npm install and webpack dev server in a separate thread without\nblocking servlet container initializer", "committedDate": "2020-02-21T15:14:42Z", "type": "commit"}, {"oid": "3db3aa04876bbce9ae9f5b2e02e31c2f61eaf6e3", "url": "https://github.com/vaadin/flow/commit/3db3aa04876bbce9ae9f5b2e02e31c2f61eaf6e3", "message": "Read a file from the classpath instead of hardcoding the content.", "committedDate": "2020-02-21T15:14:42Z", "type": "commit"}, {"oid": "fe3e9e36561d13d1225c3a52a2053b5a9d682f8c", "url": "https://github.com/vaadin/flow/commit/fe3e9e36561d13d1225c3a52a2053b5a9d682f8c", "message": "Update unit tests and rewrite exception throwing.", "committedDate": "2020-02-21T15:14:42Z", "type": "commit"}, {"oid": "4fab88d5ecb2fc2986fc2530e76a0b72f531e45a", "url": "https://github.com/vaadin/flow/commit/4fab88d5ecb2fc2986fc2530e76a0b72f531e45a", "message": "Fixes after rebase", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "e02d39bad92054b222625c8e0a7f87ba362b2e36", "url": "https://github.com/vaadin/flow/commit/e02d39bad92054b222625c8e0a7f87ba362b2e36", "message": "Add lost file after rebase back.\nThank you git so much...", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "b5391d1ef8a067783038e7303bbb3d8c83dd47c0", "url": "https://github.com/vaadin/flow/commit/b5391d1ef8a067783038e7303bbb3d8c83dd47c0", "message": "Revert unneeded bootstrap handler changes.", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "f640ccfd13f67bcb31d7f9f9e67819d9dfae17b1", "url": "https://github.com/vaadin/flow/commit/f640ccfd13f67bcb31d7f9f9e67819d9dfae17b1", "message": "Remove TODO", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "b6a4103b9c63bf23d1acae833645a2fbaabe8ae0", "url": "https://github.com/vaadin/flow/commit/b6a4103b9c63bf23d1acae833645a2fbaabe8ae0", "message": "Revert code which was reverted by git rebase.\nThank you git one one more time.", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "4287fe8d219a80802318ac26399acc761b2cef75", "url": "https://github.com/vaadin/flow/commit/4287fe8d219a80802318ac26399acc761b2cef75", "message": "Fix tests and update the code.", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "22c79c9fa0ca422fb4c37a8d7c36040d56e6e37d", "url": "https://github.com/vaadin/flow/commit/22c79c9fa0ca422fb4c37a8d7c36040d56e6e37d", "message": "Fix pnpm unit test in case of globally installed pnpm.", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "a87a8d3c3464969f19e329c2027445d683e0ec50", "url": "https://github.com/vaadin/flow/commit/a87a8d3c3464969f19e329c2027445d683e0ec50", "message": "Correct unit tests to expect exception instead of null handler.", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "5f823f001a829e2e3f670e52fc8e518ace6dd7f2", "url": "https://github.com/vaadin/flow/commit/5f823f001a829e2e3f670e52fc8e518ace6dd7f2", "message": "Update ITs to wait until dev server is started", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "4b97ea779d71edad3f94790d8c3bbfefbaad3d69", "url": "https://github.com/vaadin/flow/commit/4b97ea779d71edad3f94790d8c3bbfefbaad3d69", "message": "Correct waitForDevServer and add javadocs for dev mode handler CTOR", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "22ab685d1400321e7f3723ac29ecb330dd0da436", "url": "https://github.com/vaadin/flow/commit/22ab685d1400321e7f3723ac29ecb330dd0da436", "message": "Disable flow-client tests which are broken.", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "2d3c67caa0d9f2997268f3922f08fb9bd93af827", "url": "https://github.com/vaadin/flow/commit/2d3c67caa0d9f2997268f3922f08fb9bd93af827", "message": "Use the correct waitForDevServer method impl", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "dfed29a1e7a5a53c53a168ee4e1aa9bb0c68eb43", "url": "https://github.com/vaadin/flow/commit/dfed29a1e7a5a53c53a168ee4e1aa9bb0c68eb43", "message": "Use find() instead of match()", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "528e2940868b156bacaf57ba41440107e592cebd", "url": "https://github.com/vaadin/flow/commit/528e2940868b156bacaf57ba41440107e592cebd", "message": "Correct log message in the dev mode handler and startup performance test", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "efcda61d2072cb6283e5fb76439c1c280add3ea7", "url": "https://github.com/vaadin/flow/commit/efcda61d2072cb6283e5fb76439c1c280add3ea7", "message": "More corrections.", "committedDate": "2020-02-21T15:15:25Z", "type": "commit"}, {"oid": "b7b02d244c007f8e4fbf81f1f855c0d408f756aa", "url": "https://github.com/vaadin/flow/commit/b7b02d244c007f8e4fbf81f1f855c0d408f756aa", "message": "1000th attempt to merge with master", "committedDate": "2020-02-21T15:19:19Z", "type": "commit"}, {"oid": "bb5a404674b267ffbdf4e6c14a9e6a4e4da07a62", "url": "https://github.com/vaadin/flow/commit/bb5a404674b267ffbdf4e6c14a9e6a4e4da07a62", "message": "Try to enable flow-client tests back.", "committedDate": "2020-02-21T15:22:23Z", "type": "commit"}, {"oid": "bb5a404674b267ffbdf4e6c14a9e6a4e4da07a62", "url": "https://github.com/vaadin/flow/commit/bb5a404674b267ffbdf4e6c14a9e6a4e4da07a62", "message": "Try to enable flow-client tests back.", "committedDate": "2020-02-21T15:22:23Z", "type": "forcePushed"}, {"oid": "d57961470bd32de9be112a7c588192fa3258b251", "url": "https://github.com/vaadin/flow/commit/d57961470bd32de9be112a7c588192fa3258b251", "message": "Fix SQ complains.", "committedDate": "2020-02-22T14:35:27Z", "type": "commit"}, {"oid": "f17c3fc5335f92e380520828171d87171b886389", "url": "https://github.com/vaadin/flow/commit/f17c3fc5335f92e380520828171d87171b886389", "message": "Don't throw an exception on getCause but just return it", "committedDate": "2020-02-22T16:06:55Z", "type": "commit"}, {"oid": "749e81206e42b62ae6b3d0341a5245af8aeed410", "url": "https://github.com/vaadin/flow/commit/749e81206e42b62ae6b3d0341a5245af8aeed410", "message": "Check that an exception in the prepare tasks ((p)npm install) is\nrethrown on request handling.", "committedDate": "2020-02-24T06:36:24Z", "type": "commit"}, {"oid": "6dc94b5dd3003d45f659c0be017e68445addf456", "url": "https://github.com/vaadin/flow/commit/6dc94b5dd3003d45f659c0be017e68445addf456", "message": "Remove extra javadocs", "committedDate": "2020-02-24T07:29:11Z", "type": "commit"}, {"oid": "048f624c75339739f311cf943b3715efbf20d66d", "url": "https://github.com/vaadin/flow/commit/048f624c75339739f311cf943b3715efbf20d66d", "message": "Fixes based on review", "committedDate": "2020-02-24T09:29:51Z", "type": "commit"}, {"oid": "c4de3f16399162993ddc8f2ee3abd98b4eb77094", "url": "https://github.com/vaadin/flow/commit/c4de3f16399162993ddc8f2ee3abd98b4eb77094", "message": "Schedule page reload without onload", "committedDate": "2020-02-24T10:27:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIwODYyNg==", "url": "https://github.com/vaadin/flow/pull/7647#discussion_r383208626", "bodyText": "Possible null pointer dereference in com.vaadin.flow.server.frontend.TaskRunNpmInstall.cleanUp() due to return value of called method", "author": "vaadin-bot", "createdAt": "2020-02-24T11:17:56Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskRunNpmInstall.java", "diffHunk": "@@ -269,8 +269,16 @@ private void cleanUp() throws IOException {\n         File modulesYaml = new File(packageUpdater.nodeModulesFolder,\n                 MODULES_YAML);\n         boolean hasModulesYaml = modulesYaml.exists() && modulesYaml.isFile();\n-        if (hasModulesYaml != enablePnpm) {\n+        if (!enablePnpm && hasModulesYaml) {\n             FileUtils.forceDelete(packageUpdater.nodeModulesFolder);\n+        } else if (enablePnpm && !hasModulesYaml) {\n+            // presence of .staging dir with a \"pnpm-*\" folder means that pnpm\n+            // download is in progress, don't remove anything in this case\n+            File staging = new File(\".staging\");\n+            if (!staging.isDirectory() || staging.listFiles(", "originalCommit": "cfca85e8c26a8486181641cd917875e5af3cc1e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7fbaeccb8fbb7daef7c6277203425241a4354601", "url": "https://github.com/vaadin/flow/commit/7fbaeccb8fbb7daef7c6277203425241a4354601", "message": "Don't remove node_modules if pnpm is enabled and it's downloading\nresources.", "committedDate": "2020-02-24T11:45:24Z", "type": "commit"}, {"oid": "7fbaeccb8fbb7daef7c6277203425241a4354601", "url": "https://github.com/vaadin/flow/commit/7fbaeccb8fbb7daef7c6277203425241a4354601", "message": "Don't remove node_modules if pnpm is enabled and it's downloading\nresources.", "committedDate": "2020-02-24T11:45:24Z", "type": "forcePushed"}]}