{"pr_number": 8940, "pr_title": "Move service worker generation to webpack config", "pr_createdAt": "2020-09-03T10:41:35Z", "pr_url": "https://github.com/vaadin/flow/pull/8940", "timeline": [{"oid": "34671dcf6ce9b6ec6f1d25757a62c07165b7d625", "url": "https://github.com/vaadin/flow/commit/34671dcf6ce9b6ec6f1d25757a62c07165b7d625", "message": "Move service worker generation to webpack config\n\nWIP related to #8911.\n\nTODO:\n- service worker should be registered and work both in dev and production mode (after `mvn clean` and removal of webpack.generated.js)\n- following things should be somehow added to workbox precache manifest (with hash/revision):\n  - offline.html (currently runtime generated)\n  - manifest.webmanifest (currently runtime generated)\n  - pwa/app icons (currently runtime generated), only webmanifest icons?", "committedDate": "2020-09-03T10:46:27Z", "type": "forcePushed"}, {"oid": "7afb30a15be042cf7cabe961d26c180ad856194f", "url": "https://github.com/vaadin/flow/commit/7afb30a15be042cf7cabe961d26c180ad856194f", "message": "Map all webpack output resource paths listed in manifest.json", "committedDate": "2020-09-22T11:01:03Z", "type": "forcePushed"}, {"oid": "9ed726703cc0f8c6041e2f245295722aab15f3f3", "url": "https://github.com/vaadin/flow/commit/9ed726703cc0f8c6041e2f245295722aab15f3f3", "message": "Move service worker generation to webpack config\n\nWIP related to #8911.\n\nTODO:\n- service worker should be registered and work both in dev and production mode (after `mvn clean` and removal of webpack.generated.js)\n- following things should be somehow added to workbox precache manifest (with hash/revision):\n  - offline.html (currently runtime generated)\n  - manifest.webmanifest (currently runtime generated)\n  - pwa/app icons (currently runtime generated), only webmanifest icons?", "committedDate": "2020-09-23T12:09:44Z", "type": "commit"}, {"oid": "cbf62a68796980560ec50018b5c36041db5425fc", "url": "https://github.com/vaadin/flow/commit/cbf62a68796980560ec50018b5c36041db5425fc", "message": "Fix SonarQube complaints", "committedDate": "2020-09-23T12:09:44Z", "type": "commit"}, {"oid": "d42d57501c1f80d858317465affaba9b6e3b974b", "url": "https://github.com/vaadin/flow/commit/d42d57501c1f80d858317465affaba9b6e3b974b", "message": "Enable serving webpack generated sw and workbox js resources in DevMode", "committedDate": "2020-09-23T12:09:44Z", "type": "commit"}, {"oid": "3ed5a9e2548b346b9b4814b5dfecdb925766e74b", "url": "https://github.com/vaadin/flow/commit/3ed5a9e2548b346b9b4814b5dfecdb925766e74b", "message": "fix typo in webpack.generated.js template", "committedDate": "2020-09-23T12:09:44Z", "type": "commit"}, {"oid": "2b70bca930a751f9a04d1011887fbbd26ee7942c", "url": "https://github.com/vaadin/flow/commit/2b70bca930a751f9a04d1011887fbbd26ee7942c", "message": "Add asset manifest json to webpack", "committedDate": "2020-09-23T12:09:44Z", "type": "commit"}, {"oid": "0724c10b44f277cc22a841a40a2f9bdcedf44306", "url": "https://github.com/vaadin/flow/commit/0724c10b44f277cc22a841a40a2f9bdcedf44306", "message": "Align all webpack output files to use META-INF/VAADIN/webapp/", "committedDate": "2020-09-23T12:09:44Z", "type": "commit"}, {"oid": "a5612818e28054c9f52f6ef68c91876777cfbc65", "url": "https://github.com/vaadin/flow/commit/a5612818e28054c9f52f6ef68c91876777cfbc65", "message": "Map all webpack output resource paths listed in manifest.json", "committedDate": "2020-09-23T12:09:44Z", "type": "commit"}, {"oid": "f7dc4ccc3575d7175333b6f4da070f78094d0f89", "url": "https://github.com/vaadin/flow/commit/f7dc4ccc3575d7175333b6f4da070f78094d0f89", "message": "cleanup in webpack.generated.js", "committedDate": "2020-09-23T12:09:44Z", "type": "commit"}, {"oid": "f7dc4ccc3575d7175333b6f4da070f78094d0f89", "url": "https://github.com/vaadin/flow/commit/f7dc4ccc3575d7175333b6f4da070f78094d0f89", "message": "cleanup in webpack.generated.js", "committedDate": "2020-09-23T12:09:44Z", "type": "forcePushed"}, {"oid": "6d54217da2eaabc6e564f7d0a6e498fc80c34970", "url": "https://github.com/vaadin/flow/commit/6d54217da2eaabc6e564f7d0a6e498fc80c34970", "message": "fix serving root-located Vaadin resources in StaticFileServer.java", "committedDate": "2020-09-24T09:07:05Z", "type": "commit"}, {"oid": "f24a1b05ebc186bff3150aed2db10b97dc4dc26a", "url": "https://github.com/vaadin/flow/commit/f24a1b05ebc186bff3150aed2db10b97dc4dc26a", "message": "Precache the app shell and use it as navigateFallback\n\nMove serviceWorkerPlugin after HtmlWebpackPlugin so that it adds the generated index.html into the precache manifest automatically. Enable navigateFallback to precache the app shell (index.html served from '/' with some runtime changes).", "committedDate": "2020-09-24T09:13:46Z", "type": "commit"}, {"oid": "eebf417a786551b27c90166459653419058c7786", "url": "https://github.com/vaadin/flow/commit/eebf417a786551b27c90166459653419058c7786", "message": "Use CopyPlugin to to include offline resources to workbox precache (#8982)", "committedDate": "2020-09-25T06:23:21Z", "type": "commit"}, {"oid": "36dabe733fd0343e4dc23c5866b31e863bf40551", "url": "https://github.com/vaadin/flow/commit/36dabe733fd0343e4dc23c5866b31e863bf40551", "message": "Move config/ json resources back to META-INF/VAADIN/config\n\nThis partially reverts earlier changes, moving the config output files `META-INF/VAADIN/webapp/VAADIN/config` back to `META-INF/VAADIN/config`. Motivation:\n\n- Configuration resources are not intended for serving. Having `config/` outside of `webapp/` public resource root fits better in that regard.\n- Fixes tests expecting configuration json resources in their original location.\n\nAdditionally, this reverts several constants to their original value, including `VAADIN_SERVLET_RESOURCES`, `STATISTICS_JSON_DEFAULT`, and `VAADIN_CONFIGURATION_FILES_PATH` is removed.\n\nA new constant `VAADIN_WEBAPP_RESOURCES` is introduced to refer to the default location of served resources root.", "committedDate": "2020-09-25T12:05:01Z", "type": "commit"}, {"oid": "7a80a2916bbd15bf150c93e10310015ec3ed9cc0", "url": "https://github.com/vaadin/flow/commit/7a80a2916bbd15bf150c93e10310015ec3ed9cc0", "message": "Move `index.html` test resource to webapp/", "committedDate": "2020-09-25T12:05:32Z", "type": "commit"}, {"oid": "2f53616bcf7b80affaf443b8ec5278f69aeff8f3", "url": "https://github.com/vaadin/flow/commit/2f53616bcf7b80affaf443b8ec5278f69aeff8f3", "message": "fix(test): support manifest.json in StaticFileServerTest", "committedDate": "2020-09-25T16:08:35Z", "type": "commit"}, {"oid": "6bd4ad8734b5596a7b3f1ea3594786c3a21371d7", "url": "https://github.com/vaadin/flow/commit/6bd4ad8734b5596a7b3f1ea3594786c3a21371d7", "message": "fix(test): support \"manifest.json\" request in DevModeHandlerTest", "committedDate": "2020-09-25T16:22:07Z", "type": "commit"}, {"oid": "cf076f5bbda664ce2cbd7ab7b603bc0c538ea9c9", "url": "https://github.com/vaadin/flow/commit/cf076f5bbda664ce2cbd7ab7b603bc0c538ea9c9", "message": "fix: obfuscate root url '/' to pass absolute path test", "committedDate": "2020-09-25T16:52:39Z", "type": "commit"}, {"oid": "22b310a8228792660776398ccd794631a290f03a", "url": "https://github.com/vaadin/flow/commit/22b310a8228792660776398ccd794631a290f03a", "message": "add resourceOutputDirectory parameter to generated webpack config", "committedDate": "2020-09-28T17:46:34Z", "type": "forcePushed"}, {"oid": "bacf4575ca5c5ceb2ce9c84926161daa1aad666f", "url": "https://github.com/vaadin/flow/commit/bacf4575ca5c5ceb2ce9c84926161daa1aad666f", "message": "add resourceOutputDirectory parameter to generated webpack config", "committedDate": "2020-09-28T18:56:46Z", "type": "commit"}, {"oid": "1a629359e4a52cfec127aef97f8fd683c52684db", "url": "https://github.com/vaadin/flow/commit/1a629359e4a52cfec127aef97f8fd683c52684db", "message": "fix: support webpack internal prefixing of output bundles in BootstrapHandler", "committedDate": "2020-09-28T18:56:46Z", "type": "commit"}, {"oid": "1a629359e4a52cfec127aef97f8fd683c52684db", "url": "https://github.com/vaadin/flow/commit/1a629359e4a52cfec127aef97f8fd683c52684db", "message": "fix: support webpack internal prefixing of output bundles in BootstrapHandler", "committedDate": "2020-09-28T18:56:46Z", "type": "forcePushed"}, {"oid": "b0725798b8f2e7d0853863a71825e07a91c08fe9", "url": "https://github.com/vaadin/flow/commit/b0725798b8f2e7d0853863a71825e07a91c08fe9", "message": "fix: skip \"index.html\" in mapped static resource paths", "committedDate": "2020-09-29T10:51:13Z", "type": "commit"}, {"oid": "3f8b2d6542ed83f8648cc14f4a2ef9b07049e663", "url": "https://github.com/vaadin/flow/commit/3f8b2d6542ed83f8648cc14f4a2ef9b07049e663", "message": "fix: relax performance IT startup time threshold", "committedDate": "2020-09-29T11:44:59Z", "type": "commit"}, {"oid": "0122cc6e635aad08a5edf303aa557801bface386", "url": "https://github.com/vaadin/flow/commit/0122cc6e635aad08a5edf303aa557801bface386", "message": "fix(test): skip rootUrl when checking absolute paths in TaskUpdateWebpackTest", "committedDate": "2020-09-29T11:48:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4MjU3NQ==", "url": "https://github.com/vaadin/flow/pull/8940#discussion_r496682575", "bodyText": "Remove this use of \"SERVLET_PARAMETER_PRODUCTION_MODE\"; it is deprecated.", "author": "vaadin-bot", "createdAt": "2020-09-29T12:40:05Z", "path": "flow-maven-plugin/src/main/java/com/vaadin/flow/plugin/maven/PrepareFrontendMojo.java", "diffHunk": "@@ -139,7 +139,7 @@ public void execute() throws MojoExecutionException, MojoFailureException {\n     private void propagateBuildInfo() {\n         // For forked processes not accessing to System.properties we leave a\n         // token file with the information about the build\n-        File token = new File(webpackOutputDirectory, TOKEN_FILE);\n+        File token = new File(resourceOutputDirectory, TOKEN_FILE);\n         JsonObject buildInfo = Json.createObject();\n         buildInfo.put(SERVLET_PARAMETER_PRODUCTION_MODE, productionMode);", "originalCommit": "0122cc6e635aad08a5edf303aa557801bface386", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4MjU5MQ==", "url": "https://github.com/vaadin/flow/pull/8940#discussion_r496682591", "bodyText": "Remove this use of \"SERVLET_PARAMETER_USE_V14_BOOTSTRAP\"; it is deprecated.", "author": "vaadin-bot", "createdAt": "2020-09-29T12:40:06Z", "path": "flow-maven-plugin/src/main/java/com/vaadin/flow/plugin/maven/PrepareFrontendMojo.java", "diffHunk": "@@ -139,7 +139,7 @@ public void execute() throws MojoExecutionException, MojoFailureException {\n     private void propagateBuildInfo() {\n         // For forked processes not accessing to System.properties we leave a\n         // token file with the information about the build\n-        File token = new File(webpackOutputDirectory, TOKEN_FILE);\n+        File token = new File(resourceOutputDirectory, TOKEN_FILE);\n         JsonObject buildInfo = Json.createObject();\n         buildInfo.put(SERVLET_PARAMETER_PRODUCTION_MODE, productionMode);\n         buildInfo.put(SERVLET_PARAMETER_USE_V14_BOOTSTRAP,", "originalCommit": "0122cc6e635aad08a5edf303aa557801bface386", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1c2f6fc8b07a7c9f1b332a4fff6189843ee80b3e", "url": "https://github.com/vaadin/flow/commit/1c2f6fc8b07a7c9f1b332a4fff6189843ee80b3e", "message": "refactor: apply analysis suggestions", "committedDate": "2020-09-29T13:49:41Z", "type": "commit"}, {"oid": "1c2f6fc8b07a7c9f1b332a4fff6189843ee80b3e", "url": "https://github.com/vaadin/flow/commit/1c2f6fc8b07a7c9f1b332a4fff6189843ee80b3e", "message": "refactor: apply analysis suggestions", "committedDate": "2020-09-29T13:49:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc3NDg4NA==", "url": "https://github.com/vaadin/flow/pull/8940#discussion_r496774884", "bodyText": "Immediately return this expression instead of assigning it to the temporary variable \"relativePath\".", "author": "vaadin-bot", "createdAt": "2020-09-29T14:41:35Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateWebpack.java", "diffHunk": "@@ -219,9 +218,10 @@ private String getClientEntryPoint() {\n             Path path = Paths.get(\n                     getEscapedRelativeWebpackPath(webpackConfigPath), TARGET,\n                     INDEX_TS);\n-            String relativePath = String.format(\n-                    \"require('path').resolve(__dirname, '%s')\",\n-                    getEscapedRelativeWebpackPath(path).replaceFirst(\"\\\\.[tj]s$\", \"\"));\n+            String relativePath = formatPathResolve(", "originalCommit": "1c2f6fc8b07a7c9f1b332a4fff6189843ee80b3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9ca5265219ad211123919c4c6d357764280deb28", "url": "https://github.com/vaadin/flow/commit/9ca5265219ad211123919c4c6d357764280deb28", "message": "refactor: apply analysis suggessions", "committedDate": "2020-09-29T16:03:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5NTI5Mg==", "url": "https://github.com/vaadin/flow/pull/8940#discussion_r496895292", "bodyText": "Remove this use of \"REQUIRE_HOME_NODE_EXECUTABLE\"; it is deprecated.", "author": "vaadin-bot", "createdAt": "2020-09-29T16:56:16Z", "path": "flow-maven-plugin/src/main/java/com/vaadin/flow/plugin/maven/FlowModeAbstractMojo.java", "diffHunk": "@@ -120,22 +129,6 @@\n     @Parameter(property = Constants.REQUIRE_HOME_NODE_EXECUTABLE, defaultValue = \"false\")", "originalCommit": "9ca5265219ad211123919c4c6d357764280deb28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI3ODEwOQ==", "url": "https://github.com/vaadin/flow/pull/8940#discussion_r497278109", "bodyText": "it doesn't have the filter .filter(key -> !FrontendUtils.INDEX_HTML.equals(key))\nIs this a wrong comment or the filter was accidentally missing?", "author": "haijian-vaadin", "createdAt": "2020-09-30T06:48:46Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -514,6 +534,41 @@ private void runOnFutureComplete(DeploymentConfiguration config,\n         }\n     }\n \n+    /**\n+     * Get and parse /manifest.json from webpack-dev-server, extracting\n+     * paths to all resources in the webpack output.\n+     *\n+     * Those paths do not necessarily start with /VAADIN, as some resources\n+     * must be served from the root directory, e. g., service worker JS.\n+     *\n+     * @throws IOException\n+     */\n+    private void readManifestPaths() throws IOException {\n+        getLogger().debug(\"Reading manifest.json from webpack\");\n+        HttpURLConnection connection = prepareConnection(\"/manifest.json\",\n+                \"GET\");\n+        int responseCode = connection.getResponseCode();\n+        if (responseCode != HTTP_OK) {\n+            getLogger().error(\"Unable to get manifest.json from \" +\n+                    \"webpack-dev-server, got {} {}\", responseCode,\n+                    connection.getResponseMessage());\n+            return;\n+        }\n+\n+        String content =\n+                FrontendUtils.streamToString(connection.getInputStream());\n+        JsonObject manifest = Json.parse(content);\n+        manifestPaths = Arrays.stream(manifest.keys())\n+                // Skip \"index.html\", as it should go through", "originalCommit": "9ca5265219ad211123919c4c6d357764280deb28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQwMTkzOQ==", "url": "https://github.com/vaadin/flow/pull/8940#discussion_r497401939", "bodyText": "Yeah looking at this commit b072579 it looks like a copy paste mistake to me? The comment is added to two places but filter only in one of them.", "author": "Haprog", "createdAt": "2020-09-30T10:22:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI3ODEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI4MTg5Mw==", "url": "https://github.com/vaadin/flow/pull/8940#discussion_r497281893", "bodyText": "Is there a ticket for this?", "author": "haijian-vaadin", "createdAt": "2020-09-30T06:57:13Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "diffHunk": "@@ -303,8 +304,11 @@ public static void initDevModeHandler(Set<Class<?>> classes,\n                 PACKAGE_JSON);\n \n         // Regenerate webpack configuration, as it may be necessary to update it\n-        builder.withWebpack(builder.npmFolder, FrontendUtils.WEBPACK_CONFIG,\n-                FrontendUtils.WEBPACK_GENERATED);\n+        // TODO: make sure target directories are aligned with build config", "originalCommit": "9ca5265219ad211123919c4c6d357764280deb28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQxNjAxOA==", "url": "https://github.com/vaadin/flow/pull/8940#discussion_r497416018", "bodyText": "Created: #9082\nShould I mention the link in TODO also?", "author": "platosha", "createdAt": "2020-09-30T10:48:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI4MTg5Mw=="}], "type": "inlineReview"}, {"oid": "c06127d240c44f7971547e4e75c39d4470a29f64", "url": "https://github.com/vaadin/flow/commit/c06127d240c44f7971547e4e75c39d4470a29f64", "message": "refactor: extract FrontendUtil.parseManifestPaths utility method", "committedDate": "2020-09-30T10:35:06Z", "type": "commit"}, {"oid": "a24161b7728a7cb3b0705b70705e2c79a82d58f7", "url": "https://github.com/vaadin/flow/commit/a24161b7728a7cb3b0705b70705e2c79a82d58f7", "message": "test: handling manifest paths in DevModeHanlder and StaticFileServer", "committedDate": "2020-09-30T10:35:30Z", "type": "commit"}, {"oid": "41e77280c2459af7b3b320e8ee8c3590a9ae8829", "url": "https://github.com/vaadin/flow/commit/41e77280c2459af7b3b320e8ee8c3590a9ae8829", "message": "chore: mention issue link in TODO", "committedDate": "2020-09-30T10:51:42Z", "type": "commit"}, {"oid": "21dd754caf463287aa7a7d64c7cdd8519987d3db", "url": "https://github.com/vaadin/flow/commit/21dd754caf463287aa7a7d64c7cdd8519987d3db", "message": "Merge branch 'feature/offline' into haprog/offline/sw-gen", "committedDate": "2020-09-30T11:47:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0OTQwOQ==", "url": "https://github.com/vaadin/flow/pull/8940#discussion_r497449409", "bodyText": "Complete the task associated to this TODO comment.", "author": "vaadin-bot", "createdAt": "2020-09-30T11:54:04Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "diffHunk": "@@ -303,8 +304,12 @@ public static void initDevModeHandler(Set<Class<?>> classes,\n                 PACKAGE_JSON);\n \n         // Regenerate webpack configuration, as it may be necessary to update it\n-        builder.withWebpack(builder.npmFolder, FrontendUtils.WEBPACK_CONFIG,\n-                FrontendUtils.WEBPACK_GENERATED);\n+        // TODO: make sure target directories are aligned with build config,", "originalCommit": "21dd754caf463287aa7a7d64c7cdd8519987d3db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0OTQyMA==", "url": "https://github.com/vaadin/flow/pull/8940#discussion_r497449420", "bodyText": "Document the parameter(s): manifestJson", "author": "vaadin-bot", "createdAt": "2020-09-30T11:54:05Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/FrontendUtils.java", "diffHunk": "@@ -1037,6 +1036,23 @@ public static String commandToString(String baseDir, List<String> command) {\n         return retval.toString();\n     }\n \n+    /**\n+     * Parse \"manifest.json\" file contents obtained from webpack and extract\n+     * the list of request paths to handle as static resources.\n+     *\n+     * @param manifestJson\n+     * @return list of paths, each starting with \"/\"\n+     */\n+    public static List<String> parseManifestPaths(String manifestJson) {", "originalCommit": "21dd754caf463287aa7a7d64c7cdd8519987d3db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}