{"pr_number": 9275, "pr_title": "fix: Sync HierarchicalDataCommunicator's expand state with client side", "pr_createdAt": "2020-11-02T07:39:27Z", "pr_url": "https://github.com/vaadin/flow/pull/9275", "timeline": [{"oid": "2ef33373560529c8f694deed074e0878f9c0610f", "url": "https://github.com/vaadin/flow/commit/2ef33373560529c8f694deed074e0878f9c0610f", "message": "Sync expanded state with client side.", "committedDate": "2020-11-02T07:32:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzMzM1NA==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515833354", "bodyText": "For the current implementation they are the result of DataProvider::getId(), aren't they? IdentifierProvider is not used currently in HierarchyMapper, so maybe better to refer to getId method?", "author": "mshabarov", "createdAt": "2020-11-02T09:17:57Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapper.java", "diffHunk": "@@ -627,6 +627,18 @@ public void destroyAllData() {\n      * @return {@code true} if there is any expanded items.\n      */\n     public boolean hasExpandedItems() {\n-        return !expandedItemIds.isEmpty();\n+        return !expandedItems.isEmpty();\n+    }\n+\n+    /**\n+     * Returns the mappings between object-ids and their corresponding items for\n+     * the expanded items. Object ids are the result of applying data provider's\n+     * {@code IdentifierProvider} to the items.", "originalCommit": "2ef33373560529c8f694deed074e0878f9c0610f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDAyNw==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230027", "bodyText": "Done.", "author": "taefi", "createdAt": "2020-11-02T20:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzMzM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzOTM2NA==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515839364", "bodyText": "Is this sout a leftover after debugging? Let's remove it", "author": "mshabarov", "createdAt": "2020-11-02T09:27:51Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-1\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =\n+                new AbstractBackEndHierarchicalDataProvider<TreeNode, Void>() {\n+\n+                    @Override\n+                    public int getChildCount(HierarchicalQuery<TreeNode, Void>\n+                                                     query) {\n+                        if (query.getParent() == null) {\n+                            return 2;\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\") ||\n+                            query.getParent().getName().equals(\"second-1\")) {\n+                            return 1;\n+                        }\n+                        return 0;\n+                    }\n+\n+                    @Override\n+                    public boolean hasChildren(TreeNode item) {\n+                        return item.getParent() == null ||\n+                                item.getName().equals(\"first-1\") ||\n+                                item.getName().equals(\"second-1\");\n+                    }\n+\n+                    @Override\n+                    protected Stream<TreeNode> fetchChildrenFromBackEnd(\n+                            HierarchicalQuery<TreeNode, Void> query) {\n+                        if (query.getParent() == null) {\n+                            return Arrays.stream(new TreeNode[]{\n+                                    first1, second1\n+                            });\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\")) {\n+                            return Arrays.stream(new TreeNode[]{first11});\n+                        }\n+                        if (query.getParent().getName().equals(\"second-1\")) {\n+                            return Arrays.stream(new TreeNode[]{second11});\n+                        }\n+                        return Stream.<TreeNode>builder().build();\n+                    }\n+                };\n+\n+        HierarchyMapper<TreeNode, Void> hierarchyMapper = new HierarchyMapper<>(\n+                dataProvider\n+        );\n+\n+        Map<Object, TreeNode> expandedItems = hierarchyMapper.getExpandedItems();\n+        Assert.assertEquals(0L, expandedItems.keySet().size());\n+\n+        hierarchyMapper.expand(root);\n+        hierarchyMapper.expand(second1);\n+\n+        System.out.println(hierarchyMapper.getExpandedItems());", "originalCommit": "2ef33373560529c8f694deed074e0878f9c0610f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDA0Ng==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230046", "bodyText": "How did I miss that?!\nDone.", "author": "taefi", "createdAt": "2020-11-02T20:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzOTM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0MTE0NA==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515841144", "bodyText": "Good to add a Assert.assertNotNull(expandedItems); right away", "author": "mshabarov", "createdAt": "2020-11-02T09:30:41Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-1\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =\n+                new AbstractBackEndHierarchicalDataProvider<TreeNode, Void>() {\n+\n+                    @Override\n+                    public int getChildCount(HierarchicalQuery<TreeNode, Void>\n+                                                     query) {\n+                        if (query.getParent() == null) {\n+                            return 2;\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\") ||\n+                            query.getParent().getName().equals(\"second-1\")) {\n+                            return 1;\n+                        }\n+                        return 0;\n+                    }\n+\n+                    @Override\n+                    public boolean hasChildren(TreeNode item) {\n+                        return item.getParent() == null ||\n+                                item.getName().equals(\"first-1\") ||\n+                                item.getName().equals(\"second-1\");\n+                    }\n+\n+                    @Override\n+                    protected Stream<TreeNode> fetchChildrenFromBackEnd(\n+                            HierarchicalQuery<TreeNode, Void> query) {\n+                        if (query.getParent() == null) {\n+                            return Arrays.stream(new TreeNode[]{\n+                                    first1, second1\n+                            });\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\")) {\n+                            return Arrays.stream(new TreeNode[]{first11});\n+                        }\n+                        if (query.getParent().getName().equals(\"second-1\")) {\n+                            return Arrays.stream(new TreeNode[]{second11});\n+                        }\n+                        return Stream.<TreeNode>builder().build();\n+                    }\n+                };\n+\n+        HierarchyMapper<TreeNode, Void> hierarchyMapper = new HierarchyMapper<>(\n+                dataProvider\n+        );\n+\n+        Map<Object, TreeNode> expandedItems = hierarchyMapper.getExpandedItems();", "originalCommit": "2ef33373560529c8f694deed074e0878f9c0610f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDA2MQ==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230061", "bodyText": "Done.", "author": "taefi", "createdAt": "2020-11-02T20:17:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0MTE0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0MjYzOQ==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515842639", "bodyText": "Should the test name be like getExpandedItems_expandSomeItems_returnsCorrectExpandedItems", "author": "mshabarov", "createdAt": "2020-11-02T09:33:10Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {", "originalCommit": "2ef33373560529c8f694deed074e0878f9c0610f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDA3OA==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230078", "bodyText": "Done.", "author": "taefi", "createdAt": "2020-11-02T20:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0MjYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0NDE0Mg==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515844142", "bodyText": "Since this data provider is used more than once, is it better to extract it to an inner class and reuse?", "author": "mshabarov", "createdAt": "2020-11-02T09:35:50Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-1\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =\n+                new AbstractBackEndHierarchicalDataProvider<TreeNode, Void>() {\n+\n+                    @Override\n+                    public int getChildCount(HierarchicalQuery<TreeNode, Void>\n+                                                     query) {\n+                        if (query.getParent() == null) {\n+                            return 2;\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\") ||\n+                            query.getParent().getName().equals(\"second-1\")) {\n+                            return 1;\n+                        }\n+                        return 0;\n+                    }\n+\n+                    @Override\n+                    public boolean hasChildren(TreeNode item) {\n+                        return item.getParent() == null ||\n+                                item.getName().equals(\"first-1\") ||\n+                                item.getName().equals(\"second-1\");\n+                    }\n+\n+                    @Override\n+                    protected Stream<TreeNode> fetchChildrenFromBackEnd(\n+                            HierarchicalQuery<TreeNode, Void> query) {\n+                        if (query.getParent() == null) {\n+                            return Arrays.stream(new TreeNode[]{\n+                                    first1, second1\n+                            });\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\")) {\n+                            return Arrays.stream(new TreeNode[]{first11});\n+                        }\n+                        if (query.getParent().getName().equals(\"second-1\")) {\n+                            return Arrays.stream(new TreeNode[]{second11});\n+                        }\n+                        return Stream.<TreeNode>builder().build();\n+                    }\n+                };\n+\n+        HierarchyMapper<TreeNode, Void> hierarchyMapper = new HierarchyMapper<>(\n+                dataProvider\n+        );\n+\n+        Map<Object, TreeNode> expandedItems = hierarchyMapper.getExpandedItems();\n+        Assert.assertEquals(0L, expandedItems.keySet().size());\n+\n+        hierarchyMapper.expand(root);\n+        hierarchyMapper.expand(second1);\n+\n+        System.out.println(hierarchyMapper.getExpandedItems());\n+\n+        expandedItems = hierarchyMapper.getExpandedItems();\n+        Assert.assertNotNull(expandedItems);\n+        Assert.assertEquals(2L, expandedItems.keySet().size());\n+        Assert.assertArrayEquals(new Object[]{\"root\", \"second-1\"},\n+                expandedItems.values().stream()\n+                        .map(TreeNode::getName)\n+                        .sorted().toArray());\n+    }\n+\n+    @Test\n+    public void getExpandedItems_tryToAddItemsToCollection_shouldThrowException() {\n+\n+        exceptionRule.expect(UnsupportedOperationException.class);\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-2\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =", "originalCommit": "2ef33373560529c8f694deed074e0878f9c0610f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDE3MQ==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230171", "bodyText": "Done.", "author": "taefi", "createdAt": "2020-11-02T20:17:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0NDE0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0NjM0MQ==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515846341", "bodyText": "Does it make sense to add one more unit test to verify that the update contains the proper bunch of JsonObject for expanded items after reset()?", "author": "mshabarov", "createdAt": "2020-11-02T09:39:36Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchicalDataCommunicator.java", "diffHunk": "@@ -158,6 +158,19 @@ public void reset() {\n             HierarchicalUpdate update = arrayUpdater\n                     .startUpdate(getHierarchyMapper().getRootSize());\n             update.enqueue(\"$connector.ensureHierarchy\");\n+\n+            Collection<T> expandedItems = getHierarchyMapper().getExpandedItems().values();\n+            update.enqueue(\"$connector.expandItems\",", "originalCommit": "2ef33373560529c8f694deed074e0878f9c0610f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDI1Mw==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230253", "bodyText": "Done.\nCreated a test in HierarchicalCommunicatorTest.java to verify it.", "author": "taefi", "createdAt": "2020-11-02T20:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0NjM0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3MjU0OQ==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515872549", "bodyText": "I believe that it's better to return the collection of items, not a whole mapping. From a client code perspective, it's not that necessary to have a mapping (someone can recalculate the object ids if needed), but to know which items are expanded. So I would suggest to limit this method to return Collection<T>", "author": "mshabarov", "createdAt": "2020-11-02T10:22:25Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapper.java", "diffHunk": "@@ -627,6 +627,18 @@ public void destroyAllData() {\n      * @return {@code true} if there is any expanded items.\n      */\n     public boolean hasExpandedItems() {\n-        return !expandedItemIds.isEmpty();\n+        return !expandedItems.isEmpty();\n+    }\n+\n+    /**\n+     * Returns the mappings between object-ids and their corresponding items for\n+     * the expanded items. Object ids are the result of applying data provider's\n+     * {@code IdentifierProvider} to the items.\n+     *\n+     * @return an unmodifiable {@code Map} between object-ids and their\n+     * items corresponding items for the expanded items.\n+     */\n+    public Map<Object, T> getExpandedItems() {", "originalCommit": "2ef33373560529c8f694deed074e0878f9c0610f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDMwNg==", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230306", "bodyText": "Nice one!\nDone.", "author": "taefi", "createdAt": "2020-11-02T20:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3MjU0OQ=="}], "type": "inlineReview"}, {"oid": "0097eb16de377045538b33202f23130082a2ad18", "url": "https://github.com/vaadin/flow/commit/0097eb16de377045538b33202f23130082a2ad18", "message": "Added a test and applied review changes", "committedDate": "2020-11-02T20:12:38Z", "type": "commit"}]}