{"pr_number": 9484, "pr_title": "fix: optimize handling of requests containing Range header", "pr_createdAt": "2020-11-24T17:10:10Z", "pr_url": "https://github.com/vaadin/flow/pull/9484", "timeline": [{"oid": "62820ba144e4b3ed49d4f6af595a5ab794c6f92c", "url": "https://github.com/vaadin/flow/commit/62820ba144e4b3ed49d4f6af595a5ab794c6f92c", "message": "fix: optimize handling of requests containing Range header\n\nMore efficient parsing of the header value. Also, range count is capped at 16\n(additional will be ignored) and overlapping ranges at 2 (request will be denied\nif above).", "committedDate": "2020-11-24T17:09:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMTI5MQ==", "url": "https://github.com/vaadin/flow/pull/9484#discussion_r530121291", "bodyText": "[0-9] is \\d.\nThe expression will become shorter.", "author": "denis-anisimov", "createdAt": "2020-11-25T05:46:10Z", "path": "flow-server/src/main/java/com/vaadin/flow/internal/ResponseWriter.java", "diffHunk": "@@ -51,8 +51,20 @@\n public class ResponseWriter implements Serializable {\n     private static final int DEFAULT_BUFFER_SIZE = 32 * 1024;\n \n-    private static final Pattern RANGE_HEADER_PATTERN = Pattern.compile(\"^bytes=(([0-9]*-[0-9]*,?\\\\s*)+)$\");\n-    private static final Pattern BYTE_RANGE_PATTERN = Pattern.compile(\"([0-9]*)-([0-9]*)\");\n+    private static final Pattern RANGE_HEADER_PATTERN = Pattern.compile(\n+            \"^bytes=(([0-9]*-[0-9]*\\\\s*,\\\\s*)*[0-9]*-[0-9]*\\\\s*)$\");", "originalCommit": "62820ba144e4b3ed49d4f6af595a5ab794c6f92c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzMjcxMg==", "url": "https://github.com/vaadin/flow/pull/9484#discussion_r530232712", "bodyText": "Done.", "author": "joheriks", "createdAt": "2020-11-25T09:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMTI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMTkwMw==", "url": "https://github.com/vaadin/flow/pull/9484#discussion_r530121903", "bodyText": "unnecessary for inside while : please refactor", "author": "denis-anisimov", "createdAt": "2020-11-25T05:48:17Z", "path": "flow-server/src/main/java/com/vaadin/flow/internal/ResponseWriter.java", "diffHunk": "@@ -208,8 +221,14 @@ private void writeRangeContents(String range, HttpServletResponse response,\n             long start = startGroup.isEmpty() ? 0L : Long.parseLong(startGroup);\n             long end = endGroup.isEmpty() ? Long.MAX_VALUE\n                     : Long.parseLong(endGroup);\n+            for (Pair<Long, Long> accepted : ranges) {", "originalCommit": "62820ba144e4b3ed49d4f6af595a5ab794c6f92c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzMjYzNQ==", "url": "https://github.com/vaadin/flow/pull/9484#discussion_r530232635", "bodyText": "Done. Moved the limit checks to a separate method.", "author": "joheriks", "createdAt": "2020-11-25T09:39:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMTkwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMjY4Mw==", "url": "https://github.com/vaadin/flow/pull/9484#discussion_r530122683", "bodyText": "What happens if ranges.size() >= MAX_RANGE_COUNT?\nThere is no mistake set. The processing goes in happy path.\nThis is not the same as check for overlappingRangeCount which fails the request processing.", "author": "denis-anisimov", "createdAt": "2020-11-25T05:50:51Z", "path": "flow-server/src/main/java/com/vaadin/flow/internal/ResponseWriter.java", "diffHunk": "@@ -196,8 +208,9 @@ private void writeRangeContents(String range, HttpServletResponse response,\n         long resourceLength = connection.getContentLengthLong();\n         Matcher rangeMatcher = BYTE_RANGE_PATTERN.matcher(byteRanges);\n \n+        int overlappingRangeCount = 0;\n         List<Pair<Long, Long>> ranges = new ArrayList<>();\n-        while (rangeMatcher.find()) {\n+        while (rangeMatcher.find() && ranges.size() < MAX_RANGE_COUNT) {", "originalCommit": "62820ba144e4b3ed49d4f6af595a5ab794c6f92c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMzMzMA==", "url": "https://github.com/vaadin/flow/pull/9484#discussion_r530123330", "bodyText": "Ah, is it covered by the case that end < start?\nI would may be refactor this a bit and log an error message depending on what happened (instead of one big if).\nThat will also help to avoid comments: log messages will be self documented.", "author": "denis-anisimov", "createdAt": "2020-11-25T05:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMjY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzMjAwMg==", "url": "https://github.com/vaadin/flow/pull/9484#discussion_r530232002", "bodyText": "According to the RFC, it is acceptable for the server to either drop some ranges or outright reject a request when ranges are out-of-order or overlapping. My implementation was inconsistent in the handling of too many ranges compared to too many overlapping range. In the case of a benevolent client (that happened to asks too many ranges or too many overlapping ranges), it is probably better to serve the maximum amount rather than outright deny the request. Then the client gets at least some of the requested parts and only needs to request the others separately.\nI have amended the implementation to serve only the ranges processed so far when hitting more than 2 overlapping ranges. Also added logging.", "author": "joheriks", "createdAt": "2020-11-25T09:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMjY4Mw=="}], "type": "inlineReview"}, {"oid": "bfd5c0263a9495b232be89678bd44f12e0ce5f55", "url": "https://github.com/vaadin/flow/commit/bfd5c0263a9495b232be89678bd44f12e0ce5f55", "message": "fix: short regex, limit instead of reject when more than 2 overlapping ranges, log when hitting limits", "committedDate": "2020-11-25T09:38:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3MDUzNQ==", "url": "https://github.com/vaadin/flow/pull/9484#discussion_r530270535", "bodyText": "Replace the synchronized class \"Stack\" by an unsynchronized one such as \"Deque\".", "author": "vaadin-bot", "createdAt": "2020-11-25T10:35:59Z", "path": "flow-server/src/main/java/com/vaadin/flow/internal/ResponseWriter.java", "diffHunk": "@@ -196,13 +208,14 @@ private void writeRangeContents(String range, HttpServletResponse response,\n         long resourceLength = connection.getContentLengthLong();\n         Matcher rangeMatcher = BYTE_RANGE_PATTERN.matcher(byteRanges);\n \n-        List<Pair<Long, Long>> ranges = new ArrayList<>();\n-        while (rangeMatcher.find()) {\n+        Stack<Pair<Long, Long>> ranges = new Stack<>();", "originalCommit": "bfd5c0263a9495b232be89678bd44f12e0ce5f55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3MDU0Mg==", "url": "https://github.com/vaadin/flow/pull/9484#discussion_r530270542", "bodyText": "Invoke method(s) only conditionally.", "author": "vaadin-bot", "createdAt": "2020-11-25T10:36:00Z", "path": "flow-server/src/main/java/com/vaadin/flow/internal/ResponseWriter.java", "diffHunk": "@@ -211,11 +224,20 @@ private void writeRangeContents(String range, HttpServletResponse response,\n             if (end < start\n                     || (resourceLength >= 0 && start >= resourceLength)) {\n                 // illegal range -> 416\n+                getLogger().info(\"received an illegal range '{}' for resource '{}'\",\n+                        rangeMatcher.group(), resourceURL);", "originalCommit": "bfd5c0263a9495b232be89678bd44f12e0ce5f55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3MDU1MQ==", "url": "https://github.com/vaadin/flow/pull/9484#discussion_r530270551", "bodyText": "Invoke method(s) only conditionally.", "author": "vaadin-bot", "createdAt": "2020-11-25T10:36:01Z", "path": "flow-server/src/main/java/com/vaadin/flow/internal/ResponseWriter.java", "diffHunk": "@@ -196,13 +208,14 @@ private void writeRangeContents(String range, HttpServletResponse response,\n         long resourceLength = connection.getContentLengthLong();\n         Matcher rangeMatcher = BYTE_RANGE_PATTERN.matcher(byteRanges);\n \n-        List<Pair<Long, Long>> ranges = new ArrayList<>();\n-        while (rangeMatcher.find()) {\n+        Stack<Pair<Long, Long>> ranges = new Stack<>();\n+        while (rangeMatcher.find() && ranges.size() < MAX_RANGE_COUNT) {\n             String startGroup = rangeMatcher.group(1);\n             String endGroup = rangeMatcher.group(2);\n             if (startGroup.isEmpty() && endGroup.isEmpty()) {\n                 response.setContentLengthLong(0L);\n                 response.setStatus(416); // Range Not Satisfiable\n+                getLogger().info(\"received a malformed range: '{}'\", rangeMatcher.group());", "originalCommit": "bfd5c0263a9495b232be89678bd44f12e0ce5f55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}