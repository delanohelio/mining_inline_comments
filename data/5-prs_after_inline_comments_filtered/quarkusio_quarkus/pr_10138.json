{"pr_number": 10138, "pr_title": "Enable forwarded for host header configuration", "pr_createdAt": "2020-06-21T07:28:07Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/10138", "timeline": [{"oid": "1283922327f5c668ff1c10bcf7ef731772609c59", "url": "https://github.com/quarkusio/quarkus/commit/1283922327f5c668ff1c10bcf7ef731772609c59", "message": "Enable forwarded for host header configuration", "committedDate": "2020-06-21T07:41:15Z", "type": "forcePushed"}, {"oid": "4c62aec4ec21470f7cca5307928c76d6015fb0c0", "url": "https://github.com/quarkusio/quarkus/commit/4c62aec4ec21470f7cca5307928c76d6015fb0c0", "message": "Enable forwarded for host header configuration", "committedDate": "2020-06-21T07:42:55Z", "type": "forcePushed"}, {"oid": "12b3076f5818abfa998454e358ad03ebe04b05ee", "url": "https://github.com/quarkusio/quarkus/commit/12b3076f5818abfa998454e358ad03ebe04b05ee", "message": "Enable forwarded for host header configuration", "committedDate": "2020-06-21T07:54:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyOTc5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/10138#discussion_r443329799", "bodyText": "This feels a bit long, maybe 'enableForwardedHost' ?", "author": "stuartwdouglas", "createdAt": "2020-06-22T05:52:08Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package io.quarkus.vertx.http.runtime;\n+\n+import io.quarkus.runtime.annotations.ConfigGroup;\n+import io.quarkus.runtime.annotations.ConfigItem;\n+\n+/**\n+ * Holds configuration related with proxy addressing forward.\n+ */\n+@ConfigGroup\n+public class ProxyConfig {\n+    /**\n+     * Enable override the received request's host through a forwarded host header.\n+     */\n+    @ConfigItem(defaultValue = \"false\")\n+    public boolean enableForwardedForHostHeader;", "originalCommit": "12b3076f5818abfa998454e358ad03ebe04b05ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ4MDQ3NA==", "url": "https://github.com/quarkusio/quarkus/pull/10138#discussion_r444480474", "bodyText": "done", "author": "ejba", "createdAt": "2020-06-23T20:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyOTc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzMDEyMw==", "url": "https://github.com/quarkusio/quarkus/pull/10138#discussion_r443330123", "bodyText": "It would be better to do this in the recorder, and pass it into the parser, so it is only done once and not once per request.", "author": "stuartwdouglas", "createdAt": "2020-06-22T05:53:24Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/ForwardedParser.java", "diffHunk": "@@ -134,9 +136,12 @@ private void calculate() {\n                 port = -1;\n             }\n \n-            String hostHeader = delegate.getHeader(X_FORWARDED_HOST);\n-            if (hostHeader != null) {\n-                setHostAndPort(hostHeader.split(\",\")[0], port);\n+            if (proxyConfig.enableForwardedForHostHeader) {\n+                AsciiString forwardedHeader = AsciiString.cached(proxyConfig.forwardedHostHeader);", "originalCommit": "12b3076f5818abfa998454e358ad03ebe04b05ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ4MDU1MA==", "url": "https://github.com/quarkusio/quarkus/pull/10138#discussion_r444480550", "bodyText": "done", "author": "ejba", "createdAt": "2020-06-23T20:14:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzMDEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzMDg2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/10138#discussion_r443330866", "bodyText": "I think the existing proxy config should be moved to this class as well (proxyAddressForwarding and allowForwarded).\nTo do this mark the original ones deprecated, change them to Optional, and then add new ones here. If the old ones are set then log a warning about deprecation and use those values, otherwise use the new config.", "author": "stuartwdouglas", "createdAt": "2020-06-22T05:56:01Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package io.quarkus.vertx.http.runtime;\n+\n+import io.quarkus.runtime.annotations.ConfigGroup;\n+import io.quarkus.runtime.annotations.ConfigItem;\n+\n+/**\n+ * Holds configuration related with proxy addressing forward.\n+ */\n+@ConfigGroup\n+public class ProxyConfig {", "originalCommit": "12b3076f5818abfa998454e358ad03ebe04b05ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ4MDU5NA==", "url": "https://github.com/quarkusio/quarkus/pull/10138#discussion_r444480594", "bodyText": "done", "author": "ejba", "createdAt": "2020-06-23T20:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzMDg2Ng=="}], "type": "inlineReview"}, {"oid": "46195658aebc99708efb358ea4bfa620ff2f013e", "url": "https://github.com/quarkusio/quarkus/commit/46195658aebc99708efb358ea4bfa620ff2f013e", "message": "Enable forwarded for host header configuration", "committedDate": "2020-06-23T16:03:46Z", "type": "forcePushed"}, {"oid": "f97a3f0e33b16c3083157c3c5a55c0ad3b09d7f2", "url": "https://github.com/quarkusio/quarkus/commit/f97a3f0e33b16c3083157c3c5a55c0ad3b09d7f2", "message": "Enable forwarded for host header configuration", "committedDate": "2020-06-23T16:37:50Z", "type": "forcePushed"}, {"oid": "626c3395e81482a55111652a8d53fac50795cebd", "url": "https://github.com/quarkusio/quarkus/commit/626c3395e81482a55111652a8d53fac50795cebd", "message": "Enable forwarded for host header configuration", "committedDate": "2020-06-23T19:49:04Z", "type": "commit"}, {"oid": "626c3395e81482a55111652a8d53fac50795cebd", "url": "https://github.com/quarkusio/quarkus/commit/626c3395e81482a55111652a8d53fac50795cebd", "message": "Enable forwarded for host header configuration", "committedDate": "2020-06-23T19:49:04Z", "type": "forcePushed"}]}