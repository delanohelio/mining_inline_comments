{"pr_number": 11797, "pr_title": "Make sure the application is shutdown properly in the shutdown hook", "pr_createdAt": "2020-09-01T21:52:14Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11797", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ1NDIzMQ==", "url": "https://github.com/quarkusio/quarkus/pull/11797#discussion_r481454231", "bodyText": "This was what I observed with the reproducer project in the issue", "author": "gastaldi", "createdAt": "2020-09-01T21:55:39Z", "path": "core/runtime/src/main/java/io/quarkus/runtime/ApplicationLifecycleManager.java", "diffHunk": "@@ -294,6 +294,12 @@ public void run() {\n             } finally {\n                 stateLock.unlock();\n             }\n+            if (currentApplication.isStarted()) {\n+                // On CLI apps, SIGINT won't call io.quarkus.runtime.Application#stop(),\n+                // making the awaitShutdown() below block the application termination process\n+                // It should be a noop if called twice anyway", "originalCommit": "32764a82ed4de768bb2d41ea963732aaa29b7aa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMxMjQ2NQ==", "url": "https://github.com/quarkusio/quarkus/pull/11797#discussion_r482312465", "bodyText": "It was there before but I'm not sure it's a good idea to use an util coming from GraalVM svm artifact for such a low level thing.", "author": "gsmet", "createdAt": "2020-09-02T19:00:52Z", "path": "core/runtime/src/main/java/io/quarkus/runtime/ApplicationLifecycleManager.java", "diffHunk": "@@ -159,36 +159,36 @@ public static void run(Application application, Class<? extends QuarkusApplicati\n         (exitCodeHandler == null ? defaultExitCodeHandler : exitCodeHandler).accept(getExitCode()); //this may not be called if shutdown was initiated by a signal\n     }\n \n-    private static void registerHooks() {\n+    private static void registerHooks(final Consumer<Integer> exitCodeHandler) {\n         if (ImageInfo.inImageRuntimeCode() && System.getenv(DISABLE_SIGNAL_HANDLERS) == null) {\n-            registerSignalHandlers();\n+            registerSignalHandlers(exitCodeHandler);\n         }\n         final ShutdownHookThread shutdownHookThread = new ShutdownHookThread();\n         Runtime.getRuntime().addShutdownHook(shutdownHookThread);\n     }\n \n-    private static void registerSignalHandlers() {\n-        final SignalHandler handler = new SignalHandler() {\n+    private static void registerSignalHandlers(final Consumer<Integer> exitCodeHandler) {\n+        final SignalHandler exitHandler = new SignalHandler() {\n             @Override\n             public void handle(Signal signal) {\n-                System.exit(signal.getNumber() + 0x80);\n+                exitCodeHandler.accept(signal.getNumber() + 0x80);\n             }\n         };\n-        final SignalHandler quitHandler = new SignalHandler() {\n+        final SignalHandler diagnosticsHandler = new SignalHandler() {\n             @Override\n             public void handle(Signal signal) {\n                 DiagnosticPrinter.printDiagnostics(System.out);\n             }\n         };\n-        handleSignal(\"INT\", handler);\n-        handleSignal(\"TERM\", handler);\n+        handleSignal(\"INT\", exitHandler);\n+        handleSignal(\"TERM\", exitHandler);\n         // the HUP and QUIT signals are not defined for the Windows OpenJDK implementation:\n         // https://hg.openjdk.java.net/jdk8u/jdk8u-dev/hotspot/file/7d5c800dae75/src/os/windows/vm/jvm_windows.cpp\n-        if (OS.getCurrent() == OS.WINDOWS) {\n-            handleSignal(\"BREAK\", quitHandler);\n+        if (OS.WINDOWS.isCurrent()) {", "originalCommit": "32764a82ed4de768bb2d41ea963732aaa29b7aa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQzMzM5Nw==", "url": "https://github.com/quarkusio/quarkus/pull/11797#discussion_r482433397", "bodyText": "Changed to use System.getProperty(\"os.name\"). We need an utility to reuse that in various places", "author": "gastaldi", "createdAt": "2020-09-02T20:39:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMxMjQ2NQ=="}], "type": "inlineReview"}, {"oid": "b95f4e494b26e9ae632fa8d927999dfff26b2d7b", "url": "https://github.com/quarkusio/quarkus/commit/b95f4e494b26e9ae632fa8d927999dfff26b2d7b", "message": "Make sure the application is shutdown properly in the shutdown hook\n\nAlso make sure the specified exit handler is invoked during SIGINT\n\nFixes #11792", "committedDate": "2020-09-02T20:38:08Z", "type": "commit"}, {"oid": "66e46d44be320c1d480013228d0802f62a07e9bb", "url": "https://github.com/quarkusio/quarkus/commit/66e46d44be320c1d480013228d0802f62a07e9bb", "message": "Do not return false positive on Darwin OS", "committedDate": "2020-09-02T20:38:08Z", "type": "commit"}, {"oid": "66e46d44be320c1d480013228d0802f62a07e9bb", "url": "https://github.com/quarkusio/quarkus/commit/66e46d44be320c1d480013228d0802f62a07e9bb", "message": "Do not return false positive on Darwin OS", "committedDate": "2020-09-02T20:38:08Z", "type": "forcePushed"}]}