{"pr_number": 8556, "pr_title": "Add support for disabling proactive authentication", "pr_createdAt": "2020-04-14T06:40:05Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8556", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkwMDE1Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r407900153", "bodyText": "Note that this is because I need to add a new method to an interface in quarkus-security. If this PR is otherwise fine I will add it and cut a release.", "author": "stuartwdouglas", "createdAt": "2020-04-14T06:41:19Z", "path": "extensions/funqy/funqy-http/runtime/src/main/java/io/quarkus/funqy/runtime/bindings/http/VertxRequestHandler.java", "diffHunk": "@@ -106,9 +109,8 @@ public void handle(RoutingContext request) {\n     private void dispatch(RoutingContext routingContext, FunctionInvoker invoker, Object input) {\n         ManagedContext requestContext = beanContainer.requestContext();\n         requestContext.activate();\n-        QuarkusHttpUser user = (QuarkusHttpUser) routingContext.user();\n-        if (user != null && association != null) {\n-            association.setIdentity(user.getSecurityIdentity());\n+        if (association != null) {\n+            ((Consumer<Uni<SecurityIdentity>>) association).accept(QuarkusHttpUser.getSecurityIdentity(routingContext, null));", "originalCommit": "0de4db012315b1b6a50ce1ca65d2c6c9cdebf0cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "80b546997e4cb705d10f967677cbf6e877c0dcd1", "url": "https://github.com/quarkusio/quarkus/commit/80b546997e4cb705d10f967677cbf6e877c0dcd1", "message": "Add support for disabling proactive authentication\n\nFixes #6096", "committedDate": "2020-04-14T08:13:13Z", "type": "forcePushed"}, {"oid": "e73c86b8283dad65e20d3653d5983a58bd7ac33c", "url": "https://github.com/quarkusio/quarkus/commit/e73c86b8283dad65e20d3653d5983a58bd7ac33c", "message": "Add support for disabling proactive authentication\n\nFixes #6096", "committedDate": "2020-04-14T08:17:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA0ODUzMw==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408048533", "bodyText": "Can it help with #8559 ?", "author": "sberyozkin", "createdAt": "2020-04-14T10:58:09Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcIdentityProvider.java", "diffHunk": "@@ -44,17 +44,22 @@\n             AuthenticationRequestContext context) {\n         ContextAwareTokenCredential credential = (ContextAwareTokenCredential) request.getToken();\n         RoutingContext vertxContext = credential.getContext();\n-\n-        if (tenantResolver.isBlocking(vertxContext)) {\n-            return context.runBlocking(new Supplier<SecurityIdentity>() {\n-                @Override\n-                public SecurityIdentity get() {\n-                    return authenticate(request, vertxContext).await().indefinitely();\n+        return Uni.createFrom().deferred(new Supplier<Uni<SecurityIdentity>>() {\n+            @Override\n+            public Uni<SecurityIdentity> get() {\n+                if (tenantResolver.isBlocking(vertxContext)) {", "originalCommit": "e73c86b8283dad65e20d3653d5983a58bd7ac33c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA1NDU5Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408054593", "bodyText": "Possibly, I would need to investigate before I could say one way or the other.", "author": "stuartwdouglas", "createdAt": "2020-04-14T11:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA0ODUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA2NTkyMA==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408065920", "bodyText": "I suspect not, it is likely to do with the proactive autentication being off", "author": "sberyozkin", "createdAt": "2020-04-14T11:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA0ODUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA1NDk0OA==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408054948", "bodyText": "Why is this mapper needed ?\nI also may have seen ForbiddenException and/or UnauthorizedException thrown on some JAX-RS paths too", "author": "sberyozkin", "createdAt": "2020-04-14T11:10:25Z", "path": "extensions/resteasy/runtime/src/main/java/io/quarkus/resteasy/runtime/AuthenticationFailedExceptionMapper.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.resteasy.runtime;\n+\n+import javax.annotation.Priority;\n+import javax.enterprise.inject.spi.CDI;\n+import javax.ws.rs.Priorities;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.ext.ExceptionMapper;\n+import javax.ws.rs.ext.Provider;\n+\n+import io.quarkus.security.AuthenticationFailedException;\n+import io.quarkus.vertx.http.runtime.CurrentVertxRequest;\n+import io.quarkus.vertx.http.runtime.security.ChallengeData;\n+import io.quarkus.vertx.http.runtime.security.HttpAuthenticator;\n+import io.vertx.ext.web.RoutingContext;\n+\n+@Provider\n+@Priority(Priorities.USER + 1)\n+public class AuthenticationFailedExceptionMapper implements ExceptionMapper<AuthenticationFailedException> {", "originalCommit": "e73c86b8283dad65e20d3653d5983a58bd7ac33c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MzY3NA==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408483674", "bodyText": "This is needed because if you use the @RolesAllowed interceptor with a deferred identity you may get this exception when resolving the deferred identity. This mapper will handle it correctly.\nBy default the deferred identity will automatically handle this on a vert.x level, however we have to disable this for JAX-RS as you get an error if the vert.x response is closed while the JAX-RS request is ongoing.", "author": "stuartwdouglas", "createdAt": "2020-04-14T22:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA1NDk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NDM1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408744351", "bodyText": "@stuartwdouglas OK, makes sense", "author": "sberyozkin", "createdAt": "2020-04-15T10:35:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA1NDk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA1NjAwOA==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408056008", "bodyText": "What is a deferred identity ? Update: after looking through the PR I believe it represents a lazy authentication case", "author": "sberyozkin", "createdAt": "2020-04-14T11:12:41Z", "path": "extensions/security/runtime/src/main/java/io/quarkus/security/runtime/SecurityIdentityAssociation.java", "diffHunk": "@@ -40,11 +43,31 @@ public SecurityIdentity setIdentity(@Observes SecurityIdentity identity) {\n         return old;\n     }\n \n+    public Uni<SecurityIdentity> getDeferredIdentity() {", "originalCommit": "e73c86b8283dad65e20d3653d5983a58bd7ac33c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA1ODY4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408058683", "bodyText": "So if the proactive authentication is disabled then the access will be denied if the resource is secured ? I think this is what you said earlier would happen in such a case, which makes sense", "author": "sberyozkin", "createdAt": "2020-04-14T11:17:52Z", "path": "extensions/undertow/runtime/src/main/java/io/quarkus/undertow/runtime/ServletHttpSecurityPolicy.java", "diffHunk": "@@ -42,21 +44,31 @@\n             } else if (emptyRoleSemantic == SecurityInfo.EmptyRoleSemantic.DENY) {\n                 return Uni.createFrom().item(CheckResult.DENY);\n             } else if (emptyRoleSemantic == SecurityInfo.EmptyRoleSemantic.AUTHENTICATE) {\n-                if (identity.isAnonymous()) {\n-                    return Uni.createFrom().item(CheckResult.DENY);\n-                } else {\n-                    return Uni.createFrom().item(CheckResult.PERMIT);\n-                }\n+                return identity.map(new Function<SecurityIdentity, CheckResult>() {\n+                    @Override\n+                    public CheckResult apply(SecurityIdentity securityIdentity) {\n+                        if (securityIdentity.isAnonymous()) {", "originalCommit": "e73c86b8283dad65e20d3653d5983a58bd7ac33c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA2NDEwMw==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408064103", "bodyText": "Was just about to ask what it means and then saw AUTH_FAILURE_HANDLER docs :-)", "author": "sberyozkin", "createdAt": "2020-04-14T11:28:42Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/security/HttpSecurityRecorder.java", "diffHunk": "@@ -43,50 +53,92 @@ public void handle(RoutingContext event) {\n                 }\n                 //we put the authenticator into the routing context so it can be used by other systems\n                 event.put(HttpAuthenticator.class.getName(), authenticator);\n-                authenticator.attemptAuthentication(event)\n-                        .subscribe().with(new Consumer<SecurityIdentity>() {\n-                            @Override\n-                            public void accept(SecurityIdentity identity) {\n-                                if (event.response().ended()) {\n-                                    return;\n+\n+                //register the default auth failure handler\n+                //if proactive auth is used this is the only one\n+                //if using lazy auth this can be modified downstream, to control authentication behaviour", "originalCommit": "e73c86b8283dad65e20d3653d5983a58bd7ac33c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA2NTMyMg==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408065322", "bodyText": "Which flow is it, reactive route without RestEasy ?", "author": "sberyozkin", "createdAt": "2020-04-14T11:31:04Z", "path": "extensions/vertx-web/runtime/src/main/java/io/quarkus/vertx/web/runtime/RouteHandler.java", "diffHunk": "@@ -19,6 +19,7 @@\n     default void handle(RoutingContext context) {\n         QuarkusHttpUser user = (QuarkusHttpUser) context.user();\n         ManagedContext requestContext = Arc.container().requestContext();\n+        //todo: how should we handle non-proactive authentication here?", "originalCommit": "e73c86b8283dad65e20d3653d5983a58bd7ac33c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5cc304d41a8eae0bbfa288d7144e07cd87ef9adc", "url": "https://github.com/quarkusio/quarkus/commit/5cc304d41a8eae0bbfa288d7144e07cd87ef9adc", "message": "Make the JAX-RS SecurityContext override the SecurityIdentity\n\nFixes #6105", "committedDate": "2020-04-15T00:48:27Z", "type": "forcePushed"}, {"oid": "e97007589e80f046df303e2f6f1132820ef25a5e", "url": "https://github.com/quarkusio/quarkus/commit/e97007589e80f046df303e2f6f1132820ef25a5e", "message": "Make the JAX-RS SecurityContext override the SecurityIdentity\n\nFixes #6105", "committedDate": "2020-04-15T02:30:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1MjM3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r408752373", "bodyText": "@stuartwdouglas Should this delegate to old.checkPermission ?", "author": "sberyozkin", "createdAt": "2020-04-15T10:51:22Z", "path": "extensions/resteasy/runtime/src/main/java/io/quarkus/resteasy/runtime/SecurityContextFilter.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package io.quarkus.resteasy.runtime;\n+\n+import java.io.IOException;\n+import java.security.Permission;\n+import java.security.Principal;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.annotation.Priority;\n+import javax.inject.Inject;\n+import javax.ws.rs.Priorities;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerRequestFilter;\n+import javax.ws.rs.container.PreMatching;\n+import javax.ws.rs.core.SecurityContext;\n+import javax.ws.rs.ext.Provider;\n+\n+import org.jboss.resteasy.plugins.server.servlet.ServletSecurityContext;\n+\n+import io.quarkus.resteasy.runtime.standalone.QuarkusResteasySecurityContext;\n+import io.quarkus.security.credential.Credential;\n+import io.quarkus.security.identity.CurrentIdentityAssociation;\n+import io.quarkus.security.identity.SecurityIdentity;\n+import io.smallrye.mutiny.Uni;\n+\n+@PreMatching\n+@Priority(Priorities.USER + 1)\n+@Provider\n+public class SecurityContextFilter implements ContainerRequestFilter {\n+\n+    @Inject\n+    SecurityIdentity old;\n+\n+    @Inject\n+    CurrentIdentityAssociation currentIdentityAssociation;\n+\n+    @Override\n+    public void filter(ContainerRequestContext requestContext) throws IOException {\n+        SecurityContext modified = requestContext.getSecurityContext();\n+        if (modified instanceof ServletSecurityContext || modified instanceof QuarkusResteasySecurityContext) {\n+            //an original security context, it has not been modified\n+            return;\n+        }\n+        Set<Credential> oldCredentials = old.getCredentials();\n+        Map<String, Object> oldAttributes = old.getAttributes();\n+        SecurityIdentity newIdentity = new SecurityIdentity() {\n+            @Override\n+            public Principal getPrincipal() {\n+                return modified.getUserPrincipal();\n+            }\n+\n+            @Override\n+            public boolean isAnonymous() {\n+                return modified.getUserPrincipal() == null;\n+            }\n+\n+            @Override\n+            public Set<String> getRoles() {\n+                throw new UnsupportedOperationException(\n+                        \"retrieving all roles not supported when JAX-RS security context has been replaced\");\n+            }\n+\n+            @Override\n+            public boolean hasRole(String role) {\n+                return modified.isUserInRole(role);\n+            }\n+\n+            @Override\n+            public <T extends Credential> T getCredential(Class<T> credentialType) {\n+                for (Credential cred : getCredentials()) {\n+                    if (credentialType.isAssignableFrom(cred.getClass())) {\n+                        return (T) cred;\n+                    }\n+                }\n+                return null;\n+            }\n+\n+            @Override\n+            public Set<Credential> getCredentials() {\n+                return oldCredentials;\n+            }\n+\n+            @Override\n+            public <T> T getAttribute(String name) {\n+                return (T) oldAttributes.get(name);\n+            }\n+\n+            @Override\n+            public Map<String, Object> getAttributes() {\n+                return oldAttributes;\n+            }\n+\n+            @Override\n+            public Uni<Boolean> checkPermission(Permission permission) {\n+                return Uni.createFrom().nullItem();", "originalCommit": "e97007589e80f046df303e2f6f1132820ef25a5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMyMjU2NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r409322565", "bodyText": "No, as this is actually a proxy once you replace the identity it would be a recursive invocation.", "author": "stuartwdouglas", "createdAt": "2020-04-16T06:55:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1MjM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ0Njk1OA==", "url": "https://github.com/quarkusio/quarkus/pull/8556#discussion_r409446958", "bodyText": "@stuartwdouglas thanks. I guess the users who would like to do a pure JAX-RS SecurityContext code won't even work with the injected Securityidentity; if ever needed this can be somehow addressed in the future.", "author": "sberyozkin", "createdAt": "2020-04-16T10:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1MjM3Mw=="}], "type": "inlineReview"}, {"oid": "02c1a53a35849adb0d447b6ff19b1d4076723a40", "url": "https://github.com/quarkusio/quarkus/commit/02c1a53a35849adb0d447b6ff19b1d4076723a40", "message": "Add support for disabling proactive authentication\n\nFixes #6096", "committedDate": "2020-04-16T18:02:57Z", "type": "commit"}, {"oid": "70f8288021d7eea10f8e53d8cf22bef2cc924aef", "url": "https://github.com/quarkusio/quarkus/commit/70f8288021d7eea10f8e53d8cf22bef2cc924aef", "message": "Make the JAX-RS SecurityContext override the SecurityIdentity\n\nFixes #6105", "committedDate": "2020-04-16T18:02:57Z", "type": "commit"}, {"oid": "70f8288021d7eea10f8e53d8cf22bef2cc924aef", "url": "https://github.com/quarkusio/quarkus/commit/70f8288021d7eea10f8e53d8cf22bef2cc924aef", "message": "Make the JAX-RS SecurityContext override the SecurityIdentity\n\nFixes #6105", "committedDate": "2020-04-16T18:02:57Z", "type": "forcePushed"}]}