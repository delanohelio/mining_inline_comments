{"pr_number": 6670, "pr_title": "Add configuration for vert.x with native transport #6669", "pr_createdAt": "2020-01-21T05:16:58Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/6670", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA3MDUwNw==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r369070507", "bodyText": "No need to initialize as the default value is false anyway", "author": "gastaldi", "createdAt": "2020-01-21T15:31:08Z", "path": "extensions/vertx-core/runtime/src/test/java/io/quarkus/vertx/core/runtime/VertxCoreProducerTest.java", "diffHunk": "@@ -61,6 +61,7 @@ public void shouldNotFailWithDefaultConfig() {\n         configuration.workerPoolSize = 10;\n         configuration.warningExceptionTime = Duration.ofSeconds(1);\n         configuration.internalBlockingPoolSize = 5;\n+        configuration.preferNativeTransport = false;", "originalCommit": "6a67bb06d9d4fcd301c9c22f8ca37bf32cc89438", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEyNTAwNw==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r369125007", "bodyText": "You're right.", "author": "pcasaes", "createdAt": "2020-01-21T16:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA3MDUwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEzNjIxMQ==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r369136211", "bodyText": "No need to initialize here too, I suppose? :)", "author": "gastaldi", "createdAt": "2020-01-21T17:20:50Z", "path": "extensions/vertx-core/runtime/src/test/java/io/quarkus/vertx/core/runtime/VertxCoreProducerTest.java", "diffHunk": "@@ -100,6 +100,7 @@ private VertxConfiguration createDefaultConfiguration() {\n         vc.maxWorkerExecuteTime = Optional.of(Duration.ofSeconds(1));\n         vc.internalBlockingPoolSize = 20;\n         vc.useAsyncDNS = false;\n+        vc.preferNativeTransport = false;", "originalCommit": "a49454e4c73f886c313d24574471c0f19e8d068b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYzMjUxMg==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r369632512", "bodyText": "This method creates a default configuration and sets all values. I figured best to keep it consistent.", "author": "pcasaes", "createdAt": "2020-01-22T15:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEzNjIxMQ=="}], "type": "inlineReview"}, {"oid": "a49454e4c73f886c313d24574471c0f19e8d068b", "url": "https://github.com/quarkusio/quarkus/commit/a49454e4c73f886c313d24574471c0f19e8d068b", "message": "Remove redundant code", "committedDate": "2020-01-21T16:40:03Z", "type": "forcePushed"}, {"oid": "3bd1d9c4f5ab0cbbbba786a7c80ca89b9525b964", "url": "https://github.com/quarkusio/quarkus/commit/3bd1d9c4f5ab0cbbbba786a7c80ca89b9525b964", "message": "Remove redundant code", "committedDate": "2020-01-21T19:03:39Z", "type": "forcePushed"}, {"oid": "2e4b97ddd9e72b727cbd45450614d24a830c0d9d", "url": "https://github.com/quarkusio/quarkus/commit/2e4b97ddd9e72b727cbd45450614d24a830c0d9d", "message": "Add Vertx initialization log", "committedDate": "2020-01-22T13:46:08Z", "type": "forcePushed"}, {"oid": "5a3db14f7e49fd7aa7118069b012ed27bf15da51", "url": "https://github.com/quarkusio/quarkus/commit/5a3db14f7e49fd7aa7118069b012ed27bf15da51", "message": "Add Vertx initialization log", "committedDate": "2020-01-22T17:07:08Z", "type": "forcePushed"}, {"oid": "5d85cc71f02b26230c51674b3e35dc864bc79ec6", "url": "https://github.com/quarkusio/quarkus/commit/5d85cc71f02b26230c51674b3e35dc864bc79ec6", "message": "Add http configuration for domain sockets", "committedDate": "2020-01-22T22:26:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0MDU4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r369840587", "bodyText": "These variables are redundant since their values are in httpOptions and httpsOptions.", "author": "pcasaes", "createdAt": "2020-01-22T22:29:51Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/VertxHttpRecorder.java", "diffHunk": "@@ -541,39 +592,85 @@ public void addRoute(RuntimeValue<Router> router, Function<Router, Route> route,\n \n     private static class WebDeploymentVerticle extends AbstractVerticle {\n \n-        private final int port;\n-        private final int httpsPort;\n-        private final String host;", "originalCommit": "5d85cc71f02b26230c51674b3e35dc864bc79ec6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d609bf2c7c019674dae5d37957d9f2e1b59d84bf", "url": "https://github.com/quarkusio/quarkus/commit/d609bf2c7c019674dae5d37957d9f2e1b59d84bf", "message": "Add http configuration for domain sockets", "committedDate": "2020-01-23T13:07:26Z", "type": "forcePushed"}, {"oid": "2daa17be2900226b3f71fce50f543b3693048bc2", "url": "https://github.com/quarkusio/quarkus/commit/2daa17be2900226b3f71fce50f543b3693048bc2", "message": "Add http configuration for domain sockets", "committedDate": "2020-01-23T15:46:39Z", "type": "forcePushed"}, {"oid": "e24d81afc7b9e3acf5c27fe7e95dfa5e51c11177", "url": "https://github.com/quarkusio/quarkus/commit/e24d81afc7b9e3acf5c27fe7e95dfa5e51c11177", "message": "Add http configuration for domain sockets", "committedDate": "2020-01-23T17:36:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyNjEwOA==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r370426108", "bodyText": "Why have you changed the default to false? I thought the usual default value here would be true?", "author": "stuartwdouglas", "createdAt": "2020-01-24T00:34:48Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/HttpConfiguration.java", "diffHunk": "@@ -96,6 +96,36 @@\n     @ConfigItem(name = \"auth.session.encryption-key\")\n     public Optional<String> encryptionKey;\n \n+    /**\n+     * Enable socket reuse port\n+     */\n+    @ConfigItem(defaultValue = \"false\", name = \"so-reuse-port\")\n+    public boolean soReusePort;", "originalCommit": "e24d81afc7b9e3acf5c27fe7e95dfa5e51c11177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyNzc0MA==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r370427740", "bodyText": "It's a new configuration. In this case one that enables SO_REUSEPORT. At a first glance I figured it safer to leave this new configurations turned off.\nAll the new configurations here only take effect if native transport is enabled. I'll add that to the documentation.", "author": "pcasaes", "createdAt": "2020-01-24T00:41:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyNjEwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyODY2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r370428662", "bodyText": "Sorry, I should have read it more closely, I was thinking it was SO_REUSEADDR", "author": "stuartwdouglas", "createdAt": "2020-01-24T00:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyNjEwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQzMjQzNg==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r370432436", "bodyText": "No worries. I added this to the docs.", "author": "pcasaes", "createdAt": "2020-01-24T01:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyNjEwOA=="}], "type": "inlineReview"}, {"oid": "8934bf44e7b1287f52b53db2fb34c6894140df67", "url": "https://github.com/quarkusio/quarkus/commit/8934bf44e7b1287f52b53db2fb34c6894140df67", "message": "Document http configuration for linux/macos socket options", "committedDate": "2020-01-24T00:54:53Z", "type": "forcePushed"}, {"oid": "b6677d349aad152c530ce8b6ac734db6469a0b56", "url": "https://github.com/quarkusio/quarkus/commit/b6677d349aad152c530ce8b6ac734db6469a0b56", "message": "Add configuration for vert.x with native transport #6669\n\nMake Netty's native transport dependencies optional\nImprove Netty's native transport documentation\nAdd Vertx initialization log\nAdd http configuration for domain sockets\nDocument http configuration for linux/macos socket options", "committedDate": "2020-01-24T15:37:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3OTkzMA==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371079930", "bodyText": "Why switching this property as optional? It has a default value, so the optional will never be empty.", "author": "cescoffier", "createdAt": "2020-01-27T06:35:29Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/HttpConfiguration.java", "diffHunk": "@@ -35,7 +35,7 @@\n      * The HTTP host\n      */\n     @ConfigItem(defaultValue = \"0.0.0.0\")\n-    public String host;\n+    public Optional<String> host;", "originalCommit": "b6677d349aad152c530ce8b6ac734db6469a0b56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4MzY2OQ==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371883669", "bodyText": "So if you only want to use unix domain sockets you can set\nquarkus.http.host=\nAnd it will disable listening on host:port. Do you think it would be clearer to use a different property to disable this?", "author": "pcasaes", "createdAt": "2020-01-28T15:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3OTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg5MTA4MA==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371891080", "bodyText": "maybe remove the Optional and add these properties with these default?\nquarkus.http.host-enabled=true\nquarkus.http.domain-socket-enabled=false", "author": "pcasaes", "createdAt": "2020-01-28T15:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3OTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg5NTk4NQ==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371895985", "bodyText": "quarkus.http.host.domain-socket won't have a default value so it must be optional.\nSo then we'd only need\nquarkus.http.host-enabled=true\n\nBut having domain-socket and http enabled differently is a bit strange.", "author": "pcasaes", "createdAt": "2020-01-28T16:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3OTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg5OTIyOA==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371899228", "bodyText": "Another option is to give domain-sockets a default value /var/run/io.quarkus.app.socket. That would keep it consistent.", "author": "pcasaes", "createdAt": "2020-01-28T16:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3OTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA3Njk0OQ==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r372076949", "bodyText": "@cescoffier  I went ahead and made these changes.", "author": "pcasaes", "createdAt": "2020-01-28T21:48:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3OTkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA4MDA1Mg==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371080052", "bodyText": "Any reason to set the name? The name you use are the default ones.", "author": "cescoffier", "createdAt": "2020-01-27T06:36:13Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/HttpConfiguration.java", "diffHunk": "@@ -96,6 +96,36 @@\n     @ConfigItem(name = \"auth.session.encryption-key\")\n     public Optional<String> encryptionKey;\n \n+    /**\n+     * Enable socket reuse port (linux/macOs native transport only)\n+     */\n+    @ConfigItem(defaultValue = \"false\", name = \"so-reuse-port\")\n+    public boolean soReusePort;", "originalCommit": "b6677d349aad152c530ce8b6ac734db6469a0b56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4NDE0MA==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371884140", "bodyText": "You're right. I'll fix this.", "author": "pcasaes", "createdAt": "2020-01-28T15:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA4MDA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA4MDI1NQ==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371080255", "bodyText": "no need for get if you remove the optional.", "author": "cescoffier", "createdAt": "2020-01-27T06:37:14Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/VertxHttpRecorder.java", "diffHunk": "@@ -420,9 +447,13 @@ private static HttpServerOptions createSslOptions(HttpConfiguration httpConfigur\n             }\n         }\n         serverOptions.setSsl(true);\n-        serverOptions.setHost(httpConfiguration.host);\n+        serverOptions.setHost(httpConfiguration.host.get());", "originalCommit": "b6677d349aad152c530ce8b6ac734db6469a0b56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA4MDMwNA==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371080304", "bodyText": "cannot be false, it has a default value.", "author": "cescoffier", "createdAt": "2020-01-27T06:37:29Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/VertxHttpRecorder.java", "diffHunk": "@@ -345,6 +368,10 @@ public void handle(AsyncResult<Void> event) {\n      */\n     private static HttpServerOptions createSslOptions(HttpConfiguration httpConfiguration, LaunchMode launchMode)\n             throws IOException {\n+        if (!httpConfiguration.host.isPresent()) {", "originalCommit": "b6677d349aad152c530ce8b6ac734db6469a0b56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA4MDQ4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371080489", "bodyText": "cannot be false. It has a default value.\nIn addition, the caller need to be aware of the possibility to get null.", "author": "cescoffier", "createdAt": "2020-01-27T06:38:14Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/VertxHttpRecorder.java", "diffHunk": "@@ -497,13 +528,33 @@ private static String findKeystoreFileType(Path storePath) {\n \n     private static HttpServerOptions createHttpServerOptions(HttpConfiguration httpConfiguration,\n             LaunchMode launchMode, String websocketSubProtocols) {\n+        if (!httpConfiguration.host.isPresent()) {", "originalCommit": "b6677d349aad152c530ce8b6ac734db6469a0b56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA4MDcxNA==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371080714", "bodyText": "It has a null-check, so it's ok, but it can still never be false.", "author": "cescoffier", "createdAt": "2020-01-27T06:39:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA4MDQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA4MDUzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/6670#discussion_r371080535", "bodyText": "no need for get if you remove the optional.", "author": "cescoffier", "createdAt": "2020-01-27T06:38:28Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/VertxHttpRecorder.java", "diffHunk": "@@ -497,13 +528,33 @@ private static String findKeystoreFileType(Path storePath) {\n \n     private static HttpServerOptions createHttpServerOptions(HttpConfiguration httpConfiguration,\n             LaunchMode launchMode, String websocketSubProtocols) {\n+        if (!httpConfiguration.host.isPresent()) {\n+            return null;\n+        }\n         // TODO other config properties\n         HttpServerOptions options = new HttpServerOptions();\n-        options.setHost(httpConfiguration.host);\n+        options.setHost(httpConfiguration.host.get());", "originalCommit": "b6677d349aad152c530ce8b6ac734db6469a0b56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "16a32d2556ab6a21d76c44bdfc347a2d1a56dab5", "url": "https://github.com/quarkusio/quarkus/commit/16a32d2556ab6a21d76c44bdfc347a2d1a56dab5", "message": "Add configuration for vert.x with native transport #6669\n\nMake Netty's native transport dependencies optional\nImprove Netty's native transport documentation\nAdd Vertx initialization log\nAdd http configuration for domain sockets\nDocument http configuration for linux/macos socket options", "committedDate": "2020-01-28T15:46:38Z", "type": "forcePushed"}, {"oid": "7380dc6ae3a7125a02d78fb160e8dacecd3f32bb", "url": "https://github.com/quarkusio/quarkus/commit/7380dc6ae3a7125a02d78fb160e8dacecd3f32bb", "message": "Add explicit conf to enable/disable host or domain socket listener", "committedDate": "2020-01-28T21:30:17Z", "type": "forcePushed"}, {"oid": "2e56c6921de74ee707958f7f75b3a471df177b06", "url": "https://github.com/quarkusio/quarkus/commit/2e56c6921de74ee707958f7f75b3a471df177b06", "message": "Add explicit conf to enable/disable host or domain socket listener", "committedDate": "2020-02-06T04:16:17Z", "type": "forcePushed"}, {"oid": "35e28e2d2f53f1f84a84fbd4d17a9eedf2711e52", "url": "https://github.com/quarkusio/quarkus/commit/35e28e2d2f53f1f84a84fbd4d17a9eedf2711e52", "message": "Add explicit conf to enable/disable host or domain socket listener", "committedDate": "2020-02-21T22:15:59Z", "type": "forcePushed"}, {"oid": "67fef61b4f4445ed5c40fbbfc723f80ce5524f7c", "url": "https://github.com/quarkusio/quarkus/commit/67fef61b4f4445ed5c40fbbfc723f80ce5524f7c", "message": "Add configuration for vert.x with native transport #6669\n\nMake Netty's native transport dependencies optional\nImprove Netty's native transport documentation\nAdd Vertx initialization log\nAdd http configuration for domain sockets\nDocument http configuration for linux/macos socket options", "committedDate": "2020-02-21T23:26:07Z", "type": "commit"}, {"oid": "b6ee5273bad7458b80370d767f7c179fedd53b29", "url": "https://github.com/quarkusio/quarkus/commit/b6ee5273bad7458b80370d767f7c179fedd53b29", "message": "Remove already default explicit config names", "committedDate": "2020-02-21T23:26:16Z", "type": "commit"}, {"oid": "bdb1e7c9c61feced2f227614c9b6d4bf38a2275c", "url": "https://github.com/quarkusio/quarkus/commit/bdb1e7c9c61feced2f227614c9b6d4bf38a2275c", "message": "Add explicit conf to enable/disable host or domain socket listener", "committedDate": "2020-02-21T23:26:16Z", "type": "commit"}, {"oid": "bdb1e7c9c61feced2f227614c9b6d4bf38a2275c", "url": "https://github.com/quarkusio/quarkus/commit/bdb1e7c9c61feced2f227614c9b6d4bf38a2275c", "message": "Add explicit conf to enable/disable host or domain socket listener", "committedDate": "2020-02-21T23:26:16Z", "type": "forcePushed"}]}