{"pr_number": 9390, "pr_title": "Enable Hibernate ORM multitenancy IT on CI", "pr_createdAt": "2020-05-17T20:43:32Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9390", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMjQ3MQ==", "url": "https://github.com/quarkusio/quarkus/pull/9390#discussion_r427032471", "bodyText": "Are you sure you want to do this? It could introduce a race condition, because multiple parallel requests will use the same object. I think this is not thread safe.", "author": "michael-schnell", "createdAt": "2020-05-19T05:06:01Z", "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/tenant/HibernateMultiTenantConnectionProvider.java", "diffHunk": "@@ -33,12 +33,14 @@ protected ConnectionProvider getAnyConnectionProvider() {\n     }\n \n     @Override\n-    protected ConnectionProvider selectConnectionProvider(String tenantIdentifier) {\n+    protected ConnectionProvider selectConnectionProvider(final String tenantIdentifier) {\n         LOG.debugv(\"selectConnectionProvider({0})\", tenantIdentifier);\n \n         ConnectionProvider provider = providerMap.get(tenantIdentifier);\n         if (provider == null) {\n-            return providerMap.computeIfAbsent(tenantIdentifier, tid -> resolveConnectionProvider(tid));\n+            final ConnectionProvider connectionProvider = resolveConnectionProvider(tenantIdentifier);", "originalCommit": "e432971fb158ef6eea6f987c18c04f1e9a976330", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA2NTQ1Mw==", "url": "https://github.com/quarkusio/quarkus/pull/9390#discussion_r427065453", "bodyText": "It seems fine to me - this is indeed a race condition but it's benign, as the end result doesn't change.", "author": "Sanne", "createdAt": "2020-05-19T06:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMjQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEzOTU0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/9390#discussion_r427139545", "bodyText": "Yes, this is correct. I just thought the \"computeIfAbsent\" is a more accurate usage of the API and does not cause such questions, because it is defined by the API of the hash map implementation.", "author": "michael-schnell", "createdAt": "2020-05-19T08:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMjQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE0NDE3MA==", "url": "https://github.com/quarkusio/quarkus/pull/9390#discussion_r427144170", "bodyText": "I agree with you - your solution was more elegant. But we try to avoid lambdas for efficiency reasons. Of course we're not extreme about it: lambdas are a fine solution when they are a good solution, but I still tend to prefer avoiding them in such situations.", "author": "Sanne", "createdAt": "2020-05-19T09:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMjQ3MQ=="}], "type": "inlineReview"}, {"oid": "7c65431f03c6b8df203a038c4d0a7b1a4cf6958f", "url": "https://github.com/quarkusio/quarkus/commit/7c65431f03c6b8df203a038c4d0a7b1a4cf6958f", "message": "Minor polishing of the Hibernate Multitenancy support code and tests", "committedDate": "2020-05-20T16:17:22Z", "type": "commit"}, {"oid": "cc6f4d5b62072a16750e50a26f10aaf701987c96", "url": "https://github.com/quarkusio/quarkus/commit/cc6f4d5b62072a16750e50a26f10aaf701987c96", "message": "Reconfigure MariaDB in CI actions for multi-DB tests", "committedDate": "2020-05-20T16:17:22Z", "type": "commit"}, {"oid": "bdeab9d1d72e37bf1edcd302606d66603cc93f4e", "url": "https://github.com/quarkusio/quarkus/commit/bdeab9d1d72e37bf1edcd302606d66603cc93f4e", "message": "Introduce a 'mariadb.base_url' variable for multitenancy tests", "committedDate": "2020-05-20T16:17:22Z", "type": "commit"}, {"oid": "78548098d539ec23e1ce36bfa878dadd41c217cd", "url": "https://github.com/quarkusio/quarkus/commit/78548098d539ec23e1ce36bfa878dadd41c217cd", "message": "Add podman instructions to the jpa-mariadb tests as well", "committedDate": "2020-05-20T16:17:22Z", "type": "commit"}, {"oid": "32019289725aa008570f560174a94582247444c2", "url": "https://github.com/quarkusio/quarkus/commit/32019289725aa008570f560174a94582247444c2", "message": "Flyway migrations for Multitenancy IT needs to be more resilient", "committedDate": "2020-05-20T16:17:22Z", "type": "commit"}, {"oid": "32019289725aa008570f560174a94582247444c2", "url": "https://github.com/quarkusio/quarkus/commit/32019289725aa008570f560174a94582247444c2", "message": "Flyway migrations for Multitenancy IT needs to be more resilient", "committedDate": "2020-05-20T16:17:22Z", "type": "forcePushed"}]}