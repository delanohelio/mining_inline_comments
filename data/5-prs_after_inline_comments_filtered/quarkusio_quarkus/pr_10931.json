{"pr_number": 10931, "pr_title": "fixed lost OIDC refresh token when performing a refresh", "pr_createdAt": "2020-07-23T11:11:51Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/10931", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNjA3Mg==", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459406072", "bodyText": "Lets replace null with result.opaqueRefreshToken()", "author": "sberyozkin", "createdAt": "2020-07-23T12:19:07Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -303,7 +303,7 @@ public void accept(SecurityIdentity identity) {\n                                             LOG.debug(\"ID Token is required to contain 'exp' and 'iat' claims\");\n                                             uniEmitter.fail(new AuthenticationCompletionException());\n                                         }\n-                                        processSuccessfulAuthentication(context, configContext, result, identity);\n+                                        processSuccessfulAuthentication(context, configContext, result, null, identity);", "originalCommit": "97b6b0c748f68a535d6d6f33cea6108f4feaa259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNzg1NQ==", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459407855", "bodyText": "LGTM", "author": "sdaschner", "createdAt": "2020-07-23T12:22:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNjA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNjc3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459406773", "bodyText": "Lets replace refreshToken with result.opaqueRefreshToken() != null ? result.opaqueRefreshToken() : refreshToken because this check only makes sense in context of the refresh token grant processing", "author": "sberyozkin", "createdAt": "2020-07-23T12:20:26Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -471,7 +470,7 @@ public void handle(AsyncResult<Void> result) {\n                                                 @Override\n                                                 public void accept(SecurityIdentity identity) {\n                                                     // after a successful refresh, rebuild the identity and update the cookie \n-                                                    processSuccessfulAuthentication(context, configContext, token,\n+                                                    processSuccessfulAuthentication(context, configContext, token, refreshToken,", "originalCommit": "97b6b0c748f68a535d6d6f33cea6108f4feaa259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNzkyOQ==", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459407929", "bodyText": "LGTM", "author": "sdaschner", "createdAt": "2020-07-23T12:22:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNjc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNzgzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459407835", "bodyText": "This line can be removed once the proposed changes have been implemented", "author": "sberyozkin", "createdAt": "2020-07-23T12:22:27Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -348,15 +348,14 @@ private String signJwtWithClientSecret(OidcTenantConfig cfg) {\n     }\n \n     private void processSuccessfulAuthentication(RoutingContext context, TenantConfigContext configContext,\n-            AccessToken result, SecurityIdentity securityIdentity) {\n-\n+            AccessToken result, String refreshToken, SecurityIdentity securityIdentity) {\n         removeCookie(context, configContext, getSessionCookieName(configContext));\n \n-        String cookieValue = new StringBuilder(result.opaqueIdToken())\n-                .append(COOKIE_DELIM)\n-                .append(result.opaqueAccessToken())\n-                .append(COOKIE_DELIM)\n-                .append(result.opaqueRefreshToken()).toString();\n+        String refresh = result.opaqueRefreshToken() != null ? result.opaqueRefreshToken() : refreshToken;", "originalCommit": "97b6b0c748f68a535d6d6f33cea6108f4feaa259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwODQ5Mw==", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459408493", "bodyText": "You mean, rather result.opaqueRefreshToken() being replaced with refreshToken (if that's always set from either two at the method invocation already, as you proposed, right?", "author": "sdaschner", "createdAt": "2020-07-23T12:23:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNzgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQxMDk4MQ==", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459410981", "bodyText": "@sdaschner, this method is called from 2 places, when we complete the code grant exchange and refresh the token, in the former case RT is expected to be avail, in the latter - may not be, so I thought that in this function we should use refreshToken parameter only", "author": "sberyozkin", "createdAt": "2020-07-23T12:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNzgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQxMjE1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459412151", "bodyText": "Yes, exactly +1", "author": "sdaschner", "createdAt": "2020-07-23T12:30:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNzgzNQ=="}], "type": "inlineReview"}, {"oid": "9a3f7e4bd5a6cc48be48ded9ca3cd7bbfd73f2d3", "url": "https://github.com/quarkusio/quarkus/commit/9a3f7e4bd5a6cc48be48ded9ca3cd7bbfd73f2d3", "message": "added PR requested changes", "committedDate": "2020-07-23T14:24:15Z", "type": "forcePushed"}, {"oid": "c5d158226b1a91372712b5f178eb5c1ac50207db", "url": "https://github.com/quarkusio/quarkus/commit/c5d158226b1a91372712b5f178eb5c1ac50207db", "message": "fixed lost OIDC refresh token when performing a refresh", "committedDate": "2020-07-23T14:30:46Z", "type": "commit"}, {"oid": "c5d158226b1a91372712b5f178eb5c1ac50207db", "url": "https://github.com/quarkusio/quarkus/commit/c5d158226b1a91372712b5f178eb5c1ac50207db", "message": "fixed lost OIDC refresh token when performing a refresh", "committedDate": "2020-07-23T14:30:46Z", "type": "forcePushed"}]}