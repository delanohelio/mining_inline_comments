{"pr_number": 8328, "pr_title": "Upgrade to Hibernate Search 6.0.0.Beta6", "pr_createdAt": "2020-04-01T12:46:37Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8328", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2Nzc0NA==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r401867744", "bodyText": "Could you add a short paragraph to describe when one might want to tune this?", "author": "Sanne", "createdAt": "2020-04-01T19:48:21Z", "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -118,6 +119,12 @@\n         @ConfigItem\n         DiscoveryConfig discovery;\n \n+        /**\n+         * Configuration for the thread pool assigned to the backend.", "originalCommit": "0f8b660bd8df2fd375c7a5f4a3166032972e2d2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4MTE0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402081147", "bodyText": "Honestly, for the Elasticsearch backend, I'm not sure. Everything happening in these threads is non-blocking, except maybe some logging than can happen on timeouts/errors. So, theoretically, having more threads than the number of available cores is pointless.\nI suppose one could want to set it to less than the number of cores, just to have less threads around?\nLike all these performance settings, they are mostly here so that users are free to experiment. I don't have the answer to all performance problems, unfortunately.", "author": "yrodiere", "createdAt": "2020-04-02T06:34:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2Nzc0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5MDMxMA==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402290310", "bodyText": "In that case it might be wise to not expose anything?  Remember in Quarkus we're trying to minimise the configuration needs.\nI would suggest to defer exposing this to when we have a better understanding for it. For example, I suppose it's possible such an exploration concludes there's only need for some \"profile\" enums: \"light\" (default) vs \"throughput\" (matching num cores).", "author": "Sanne", "createdAt": "2020-04-02T12:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2Nzc0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5NjEzMg==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402296132", "bodyText": "I came up with a reason to use this setting a few minutes after I wrote this comment, and I documented it in a following commit: you may want to set this to a low number if your machine has many cores and you only have one index with one queue, for example.\nWhile I'm all for this approach of \"not exposing until we're sure\" for feature-related settings, I'm not sure it makes sense when it comes to performance settings which will likely be different for every machine, and for which we don't have a silver bullet. In your example, I'd have a really hard time finding the number of core to assign to the \"light\" profile.", "author": "yrodiere", "createdAt": "2020-04-02T13:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2Nzc0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyMTcyNg==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402321726", "bodyText": "yes I'm skeptical about applying such strategy to performance levers as well - but we're asked to try hard, so here I am having you do this exercise of defending your flags :)\nI suppose one thing we could try to improve on is ergonomic strategies: rather than exposing such options, ideally we'd study our own statistics at runtime and automate what you'd do as a smart human who knows the project well. Essentially: ask yourself which stats would you need to know to make this perform better? Then what would you do? And automate that - sometimes this still needs some configuration flags, but they are more likely to look like \"profiles\" and strategy names, so that people can at least express what they are optimising for.\nI'm sure that won't work with all options, but it makes sense when there's a possibility of automation to avoid exposing options.\n(That being sad - beyond the exercise - I'm fine to keep this configuration property, thanks for your explanations)", "author": "Sanne", "createdAt": "2020-04-02T13:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2Nzc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2OTc3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r401869777", "bodyText": "I'm not entirely sure what a reasonable default would be here - so bear with me as I only know the high level picture.\nI wonder if this is a reasonable value for an high-performance index. But maybe we should default to small and lean for a Quarkus default?", "author": "Sanne", "createdAt": "2020-04-01T19:52:01Z", "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -455,4 +461,30 @@ public String getHibernateSearchString() {\n         @ConfigItem(defaultValueDocumentation = \"10S\")\n         Optional<Duration> requiredStatusWaitTimeout;\n     }\n+\n+    // We can't set actual default values in this section,\n+    // otherwise \"quarkus.hibernate-search.elasticsearch.index-defaults\" will be ignored.\n+    @ConfigGroup\n+    public static class ElasticsearchIndexIndexingConfig {\n+        /**\n+         * The number of indexing queues assigned to each index.\n+         */\n+        // We can't set an actual default value here: see comment on this class.\n+        @ConfigItem(defaultValueDocumentation = \"10\")", "originalCommit": "fe5a6154e798f2d907377c738b3cfc5751182824", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3OTk1Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402079957", "bodyText": "Just so you know, queues don't have an assigned thread, they rely on the global thread pool assigned to the backend.\nThreads will only be used when we process the queues and orchestrate the works, but after the first request is sent, everything happens in the transport threads of the HTTP client. So you can raise the number of queues to 256, if you have a thread pool of size 8, you'll still have only 8 threads. Since queue processing is non-blocking, that shouldn't be a problem.\nThe number of queues defines the level of parallelism, i.e. with 10 queues you will have 10 indexing requests sent in parallel. Crucially, this means we'll use at most 10 connections in parallel for indexing for this index.\nThe \"best\" value will likely depend on many factors. I haven't been able to pinpoint a \"best\" value here, as the setting will have a different effect depending on the number of indexes being written to in parallel, the number of available connections, the topology of your Elasticsearch cluster, ...\nBottom line: I don't know what's best for the user either. Which is why I expose this configuration option: so that they can set it themselves. I can change the default to 5, but that'd be as much guesswork as it is now.\nMaybe after some more performance testing we'll get a better idea of what the default should be.", "author": "yrodiere", "createdAt": "2020-04-02T06:32:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2OTc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5MzY0Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402293646", "bodyText": "Thanks for the explanation.  Yes 10 might be a good starting point then but it feels like a random number - since you mentioned they are non-blocking perhaps the best default is 1? One connection should be able to make a quite efficient use of the available network resources - similar systems will use one by default, and maybe 2 or 3 when they really need to push for the maximum.\nThis also makes me wonder why we expose this. Would you agree that what matters for end users is to understand that this is about the number of connections? Maybe it should be named and documented like that.", "author": "Sanne", "createdAt": "2020-04-02T13:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2OTc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5NDQ2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402294466", "bodyText": "(again: when in doubt or when you believe it won't matter much, make a choice and don't expose it)", "author": "Sanne", "createdAt": "2020-04-02T13:01:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2OTc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyNDM1OA==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402324358", "bodyText": "TL;DR: we don't have great defaults for the most common setups yet, and we will never have defaults that fit every setup. Hence the newly exposed settings.\n\nOne connection should be able to make a quite efficient use of the available network resources - similar systems will use one by default, and maybe 2 or 3 when they really need to push for the maximum.\n\nI'm not sure, but you have more experience about network performance than I do. If you're certain about that, I will definitely change this setting.\nFrom what I've seen with Elasticsearch... in raw throughput tests, where we just push everything we can to the index, and there is only one Elasticsearch instance, you're absolutely right. Less connections is even better, probably because it means larger bulks and those are better handled by Elasticsearch.\nHowever, when I spin up a complete application with database access, with 2 (local) Elasticsearch nodes, and I start mass indexing, I witnessed the opposite: jumping from 2 queues to 10 queues gave a +50% throughput increase in a small local test (~25000 wikipedia pages) I performed. Granted there's nothing scientific to that test, but it's at least enough to give pause about whether \"more connections is pointless\".\nThere are other things that come into play, I suppose; maybe optimizing the global indexing time while allowing high latency from time to time for some documents is not what works best in all situations.\n\nThis also makes me wonder why we expose this.\n\nBecause I can't come up with defaults that will work for the most common setup (which is it, by the way?), much less for everyone. At least, not yet.\n\nwhen in doubt or when you believe it won't matter much, make a choice and don't expose it\n\nI don't believe it won't matter, I just believe I don't have a way to come up with the best set of settings for everyone, especially with varying environments: local Elasticsearch instance vs remote, single ES instance vs 100+ nodes, 1 index vs 50, ...\nI can postpone exposing these settings until we spend a few weeks doing reliable, scientific performance tests, but who knows when that will happen... At least if I expose these settings, users have a way to improve performance while we work on implementing missing features. And who knows, maybe someone tinkering with these settings will give us useful feedback :)", "author": "yrodiere", "createdAt": "2020-04-02T13:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2OTc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMDI4NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402430285", "bodyText": "That's great that you tested it. Ok then keep it :)\n\nAnd who knows, maybe someone tinkering with these settings will give us useful feedback :)\n\n+1 that's a very good point. And a good reason to document some of your suggestions, so that others power users can actually do that.", "author": "Sanne", "createdAt": "2020-04-02T16:04:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2OTc3Nw=="}], "type": "inlineReview"}, {"oid": "a96736cac8806bb2a2f6341e3d334eb59e018ab9", "url": "https://github.com/quarkusio/quarkus/commit/a96736cac8806bb2a2f6341e3d334eb59e018ab9", "message": "hsearch-es: Document in more details the indexing settings", "committedDate": "2020-04-02T07:04:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyMDUzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402320539", "bodyText": "s/you will likely want/you might want/", "author": "Sanne", "createdAt": "2020-04-02T13:40:02Z", "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -399,18 +419,45 @@ public String getHibernateSearchString() {\n         EntityLoadingCacheLookupStrategy strategy;\n     }\n \n-    // We can't set actual default values in this section,\n-    // otherwise \"quarkus.hibernate-search.elasticsearch.index-defaults\" will be ignored.\n     @ConfigGroup\n-    public static class LifecycleConfig {\n+    public static class SchemaManagementConfig {\n \n         /**\n          * The strategy used for index lifecycle.\n          */\n         // We can't set an actual default value here: see comment on this class.\n-        @ConfigItem(defaultValueDocumentation = \"create\")\n-        Optional<IndexLifecycleStrategyName> strategy;\n+        @ConfigItem(defaultValue = \"create-or-validate\")\n+        SchemaManagementStrategyName strategy;\n+\n+    }\n \n+    @ConfigGroup\n+    public static class ThreadPoolConfig {\n+        /**\n+         * The size of the thread pool assigned to the backend.\n+         * <p>\n+         * Note that number is <em>per backend</em>, not per index.\n+         * Adding more indexes will not add more threads.\n+         * <p>\n+         * As all operations happening in this thread-pool are non-blocking,\n+         * raising its size above the number of processor cores available to the JVM will not bring noticeable performance\n+         * benefit.\n+         * The only reason to alter this setting would be to reduce the number of threads;\n+         * for example, in an application with a single index with a single indexing queue,\n+         * running on a machine with 64 processor cores,\n+         * you will likely want to bring the number of threads to a more reasonable number like 1 or 4.", "originalCommit": "a96736cac8806bb2a2f6341e3d334eb59e018ab9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyMDk5NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8328#discussion_r402320995", "bodyText": "s/to a more reasonable number like 1 or 4/to a lower number/", "author": "Sanne", "createdAt": "2020-04-02T13:40:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyMDUzOQ=="}], "type": "inlineReview"}, {"oid": "cf405091c4327e654b3ed21b3233b632f8e8bc70", "url": "https://github.com/quarkusio/quarkus/commit/cf405091c4327e654b3ed21b3233b632f8e8bc70", "message": "hsearch-es: Upgrade to Hibernate Search 6.0.0.Beta6", "committedDate": "2020-04-02T13:48:01Z", "type": "commit"}, {"oid": "7b485d96d13a9a4c11ea676c34dc7ba5d238c036", "url": "https://github.com/quarkusio/quarkus/commit/7b485d96d13a9a4c11ea676c34dc7ba5d238c036", "message": "hsearch-es: Add an option to configure the thread pool size", "committedDate": "2020-04-02T13:48:01Z", "type": "commit"}, {"oid": "92c6e409d56e97e90cd2d7247d9e8ec42a7201b1", "url": "https://github.com/quarkusio/quarkus/commit/92c6e409d56e97e90cd2d7247d9e8ec42a7201b1", "message": "hsearch-es: Add options to configure indexing queues", "committedDate": "2020-04-02T13:48:02Z", "type": "commit"}, {"oid": "961d95b3b8e02c2c104f6ef2bf96d82f822580c8", "url": "https://github.com/quarkusio/quarkus/commit/961d95b3b8e02c2c104f6ef2bf96d82f822580c8", "message": "hsearch-es: Clarify the name of some unit tests", "committedDate": "2020-04-02T13:48:02Z", "type": "commit"}, {"oid": "85fd3eb0ba8963e56818faa3c1ae2a894b34fd38", "url": "https://github.com/quarkusio/quarkus/commit/85fd3eb0ba8963e56818faa3c1ae2a894b34fd38", "message": "hsearch-es: Document in more details the indexing settings", "committedDate": "2020-04-02T13:48:02Z", "type": "forcePushed"}, {"oid": "689e440d75f3a8c2a4650beaf52e495743a2f3d0", "url": "https://github.com/quarkusio/quarkus/commit/689e440d75f3a8c2a4650beaf52e495743a2f3d0", "message": "hsearch-es: Document in more details the thread pool size setting", "committedDate": "2020-04-02T13:53:57Z", "type": "commit"}, {"oid": "4f84f07f3e222640a52b7b7479510833dc9971aa", "url": "https://github.com/quarkusio/quarkus/commit/4f84f07f3e222640a52b7b7479510833dc9971aa", "message": "hsearch-es: Document in more details the indexing settings", "committedDate": "2020-04-02T13:53:58Z", "type": "commit"}, {"oid": "4f84f07f3e222640a52b7b7479510833dc9971aa", "url": "https://github.com/quarkusio/quarkus/commit/4f84f07f3e222640a52b7b7479510833dc9971aa", "message": "hsearch-es: Document in more details the indexing settings", "committedDate": "2020-04-02T13:53:58Z", "type": "forcePushed"}]}