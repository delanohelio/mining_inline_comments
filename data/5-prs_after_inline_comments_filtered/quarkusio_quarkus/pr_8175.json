{"pr_number": 8175, "pr_title": "Support for mocking CDI beans", "pr_createdAt": "2020-03-26T05:54:32Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8175", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMDc3OA==", "url": "https://github.com/quarkusio/quarkus/pull/8175#discussion_r398420778", "bodyText": "You could just use QuarkusMock.installMock(mockableBean1, new HiGreeter()), right?", "author": "mkouba", "createdAt": "2020-03-26T09:18:40Z", "path": "integration-tests/main/src/test/java/io/quarkus/it/main/MockTestCase.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package io.quarkus.it.main;\n+\n+import javax.enterprise.inject.spi.CDI;\n+import javax.inject.Inject;\n+\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import io.quarkus.it.mock.MockableBean1;\n+import io.quarkus.it.mock.MockableBean2;\n+import io.quarkus.test.junit.MockSupport;\n+import io.quarkus.test.junit.QuarkusMock;\n+import io.quarkus.test.junit.QuarkusTest;\n+\n+@QuarkusTest\n+public class MockTestCase {\n+\n+    protected static final String HI = \"Hi \";\n+    protected static final String BONJOUR = \"Bonjour \";\n+\n+    @Inject\n+    MockableBean1 mockableBean1;\n+\n+    @Inject\n+    MockableBean2 mockableBean2;\n+\n+    @BeforeAll\n+    public static void setup() {\n+        QuarkusMock.installMock(CDI.current().select(MockableBean1.class).get(), new HiGreeter());", "originalCommit": "8b8c09ff85b9a185b39abe3a7eac7dab76ca49a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMzg1NA==", "url": "https://github.com/quarkusio/quarkus/pull/8175#discussion_r398423854", "bodyText": "It's a static method", "author": "stuartwdouglas", "createdAt": "2020-03-26T09:23:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMDc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyNTQzOA==", "url": "https://github.com/quarkusio/quarkus/pull/8175#discussion_r398425438", "bodyText": "I see. That's not very nice though. How about specifying the required type/qualifiers, i.e. in this case something like QuarkusMock.installMock(MockableBean1.class, new HiGreeter())?", "author": "mkouba", "createdAt": "2020-03-26T09:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMDc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyNTU4MA==", "url": "https://github.com/quarkusio/quarkus/pull/8175#discussion_r398425580", "bodyText": "And do the lookup under the hood.", "author": "mkouba", "createdAt": "2020-03-26T09:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMDc3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMzY4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8175#discussion_r398423687", "bodyText": "MockSupport is not part of the user API, or? In fact, it could be package-private...", "author": "mkouba", "createdAt": "2020-03-26T09:23:15Z", "path": "integration-tests/main/src/test/java/io/quarkus/it/main/MockTestCase.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package io.quarkus.it.main;\n+\n+import javax.enterprise.inject.spi.CDI;\n+import javax.inject.Inject;\n+\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import io.quarkus.it.mock.MockableBean1;\n+import io.quarkus.it.mock.MockableBean2;\n+import io.quarkus.test.junit.MockSupport;\n+import io.quarkus.test.junit.QuarkusMock;\n+import io.quarkus.test.junit.QuarkusTest;\n+\n+@QuarkusTest\n+public class MockTestCase {\n+\n+    protected static final String HI = \"Hi \";\n+    protected static final String BONJOUR = \"Bonjour \";\n+\n+    @Inject\n+    MockableBean1 mockableBean1;\n+\n+    @Inject\n+    MockableBean2 mockableBean2;\n+\n+    @BeforeAll\n+    public static void setup() {\n+        QuarkusMock.installMock(CDI.current().select(MockableBean1.class).get(), new HiGreeter());\n+    }\n+\n+    @Test\n+    public void testBeforeAll() {\n+        Assertions.assertEquals(\"Hi Stuart\", mockableBean1.greet(\"Stuart\"));\n+        Assertions.assertEquals(\"Hello Stuart\", mockableBean2.greet(\"Stuart\"));\n+    }\n+\n+    @Test\n+    public void testPerTestMock() {\n+        MockSupport.installMock(mockableBean2, new BonourGreeter());", "originalCommit": "8b8c09ff85b9a185b39abe3a7eac7dab76ca49a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0NzE4NA==", "url": "https://github.com/quarkusio/quarkus/pull/8175#discussion_r398447184", "bodyText": "Yea, it should be. Originally this was in the common module and I did not update it.", "author": "stuartwdouglas", "createdAt": "2020-03-26T09:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMzY4Nw=="}], "type": "inlineReview"}, {"oid": "cb11b680340800510189848adee09dbeefa1aed8", "url": "https://github.com/quarkusio/quarkus/commit/cb11b680340800510189848adee09dbeefa1aed8", "message": "Support for mocking CDI beans\n\nThis allows all CDI normal scoped beans to be mocked at\ntest time by adding a form of redirection into the client\nproxy.", "committedDate": "2020-03-26T23:00:04Z", "type": "forcePushed"}, {"oid": "ced4ac427af5a16af87d0d9055f79e6dcbf2d8c3", "url": "https://github.com/quarkusio/quarkus/commit/ced4ac427af5a16af87d0d9055f79e6dcbf2d8c3", "message": "Support for mocking CDI beans\n\nThis allows all CDI normal scoped beans to be mocked at\ntest time by adding a form of redirection into the client\nproxy.", "committedDate": "2020-03-27T03:45:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE5MDY0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8175#discussion_r399190647", "bodyText": "This method should probably be called after the failedBoot because if we do fail to boot, pushMockContext (and popMockContext will throw a NPE, thus masking the real problem)", "author": "geoand", "createdAt": "2020-03-27T11:11:15Z", "path": "test-framework/junit5/src/main/java/io/quarkus/test/junit/QuarkusTestExtension.java", "diffHunk": "@@ -176,6 +177,7 @@ public void beforeEach(ExtensionContext context) throws Exception {\n         if (isNativeTest(context)) {\n             return;\n         }\n+        pushMockContext();", "originalCommit": "ced4ac427af5a16af87d0d9055f79e6dcbf2d8c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4db2f00d2fdfe58dba21d67ae611007d4ff6387f", "url": "https://github.com/quarkusio/quarkus/commit/4db2f00d2fdfe58dba21d67ae611007d4ff6387f", "message": "Support for mocking CDI beans\n\nThis allows all CDI normal scoped beans to be mocked at\ntest time by adding a form of redirection into the client\nproxy.", "committedDate": "2020-03-30T01:31:15Z", "type": "forcePushed"}, {"oid": "bd14e8821d08af37a22d5e052fa70251a12ba7ec", "url": "https://github.com/quarkusio/quarkus/commit/bd14e8821d08af37a22d5e052fa70251a12ba7ec", "message": "Support for mocking CDI beans\n\nThis allows all CDI normal scoped beans to be mocked at\ntest time by adding a form of redirection into the client\nproxy.", "committedDate": "2020-03-31T02:31:37Z", "type": "commit"}, {"oid": "bd14e8821d08af37a22d5e052fa70251a12ba7ec", "url": "https://github.com/quarkusio/quarkus/commit/bd14e8821d08af37a22d5e052fa70251a12ba7ec", "message": "Support for mocking CDI beans\n\nThis allows all CDI normal scoped beans to be mocked at\ntest time by adding a form of redirection into the client\nproxy.", "committedDate": "2020-03-31T02:31:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMzYyMg==", "url": "https://github.com/quarkusio/quarkus/pull/8175#discussion_r400823622", "bodyText": "We should probably add a check that the instance is an instance of io.quarkus.arc.ClientProxy and throw an IAE if it's not? I know that we throw a RuntimeException inside the MockSupport but it would be probably better to fail fast.", "author": "mkouba", "createdAt": "2020-03-31T11:00:32Z", "path": "test-framework/junit5/src/main/java/io/quarkus/test/junit/QuarkusMock.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package io.quarkus.test.junit;\n+\n+import java.lang.annotation.Annotation;\n+\n+import javax.enterprise.inject.spi.CDI;\n+\n+import org.junit.jupiter.api.TestInstance;\n+\n+/**\n+ * Utility class that can be used to mock CDI normal scoped beans.\n+ * \n+ * This includes beans that are {@link javax.enterprise.context.ApplicationScoped} and\n+ * {@link javax.enterprise.context.RequestScoped}.\n+ * \n+ * To use this inject the bean into a test, and then invoke the mock\n+ * method with your mock.\n+ *\n+ * Mocks installed in {@link org.junit.jupiter.api.BeforeAll} will be present for every test,\n+ * while mocks installed within a test are cleared after the test has run. Note that you will\n+ * likely need to use {@link TestInstance.Lifecycle#PER_CLASS} to have a non-static before all method\n+ * that can access injected beans.\n+ *\n+ * Note that as the bean is replaced globally you cannot use parallel test execution, as this will\n+ * result in race conditions where mocks from one test are active in another.\n+ *\n+ */\n+public class QuarkusMock {\n+\n+    /**\n+     * Installs a mock for a CDI normal scoped bean\n+     *\n+     * @param mock The mock object\n+     * @param instance The CDI normal scoped bean that was injected into your test\n+     * @param <T> The bean type\n+     */\n+    public static <T> void installMockForInstance(T mock, T instance) {\n+        //mock support does the actual work, but exposes other methods that are not part of the user API\n+        MockSupport.installMock(instance, mock);", "originalCommit": "bd14e8821d08af37a22d5e052fa70251a12ba7ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5Njg3MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8175#discussion_r401196871", "bodyText": "It does not make any real difference, and this is significantly more complex than it sounds, as MockSupport is inside the application class loader. This would mean a lot of extra logic to duplicate a check that is done first thing in the method call.", "author": "stuartwdouglas", "createdAt": "2020-03-31T20:32:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMzYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ0OTIzNA==", "url": "https://github.com/quarkusio/quarkus/pull/8175#discussion_r401449234", "bodyText": "Ok.", "author": "mkouba", "createdAt": "2020-04-01T08:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMzYyMg=="}], "type": "inlineReview"}]}