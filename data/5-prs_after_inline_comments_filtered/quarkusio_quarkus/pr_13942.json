{"pr_number": 13942, "pr_title": "Add the remaining jdbc data-sources to kubernetes service bindings", "pr_createdAt": "2020-12-17T09:51:38Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13942", "timeline": [{"oid": "031e5bf4eddb2f6399ef8c726e8df8e63bb8439c", "url": "https://github.com/quarkusio/quarkus/commit/031e5bf4eddb2f6399ef8c726e8df8e63bb8439c", "message": "Add the remaining jdbc data-sources to kubernetes service bindings", "committedDate": "2021-01-25T17:32:49Z", "type": "commit"}, {"oid": "031e5bf4eddb2f6399ef8c726e8df8e63bb8439c", "url": "https://github.com/quarkusio/quarkus/commit/031e5bf4eddb2f6399ef8c726e8df8e63bb8439c", "message": "Add the remaining jdbc data-sources to kubernetes service bindings", "committedDate": "2021-01-25T17:32:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkyMDM3Mg==", "url": "https://github.com/quarkusio/quarkus/pull/13942#discussion_r563920372", "bodyText": "Does this really work with all the datasources? I'm wondering if the datasource shouldn't be providing the format?", "author": "gsmet", "createdAt": "2021-01-25T17:47:29Z", "path": "extensions/kubernetes-service-binding/runtime/src/main/java/io/quarkus/kubernetes/service/binding/runtime/JdbcDatasourceUtil.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package io.quarkus.kubernetes.service.binding.runtime;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import org.jboss.logging.Logger;\n+\n+/**\n+ * This utility collects the conversion of Service types that correspond to JDBC data-sources\n+ * into a single place as the code for all is the same.\n+ * This inevitably results in datasource related logic being places inside this (otherwise)\n+ * service binding agnostic module, but it's a small price to pay compared to the alternative\n+ * of copying and pasting the same code for all JDBC data-sources.\n+ */\n+public class JdbcDatasourceUtil {\n+\n+    private static final Logger log = Logger.getLogger(JdbcDatasourceUtil.class);\n+\n+    public static Optional<ServiceBindingConfigSource> convert(List<ServiceBinding> serviceBindings, String type) {\n+        return convert(serviceBindings, type, type);\n+    }\n+\n+    public static Optional<ServiceBindingConfigSource> convert(List<ServiceBinding> serviceBindings, String bindingType,\n+            String urlType) {\n+        Optional<ServiceBinding> matchingByType = ServiceBinding.singleMatchingByType(bindingType, serviceBindings);\n+        if (!matchingByType.isPresent()) {\n+            return Optional.empty();\n+        }\n+\n+        Map<String, String> properties = new HashMap<>();\n+        ServiceBinding binding = matchingByType.get();\n+\n+        String username = binding.getProperties().get(\"username\");\n+        if (username != null) {\n+            properties.put(\"quarkus.datasource.username\", username);\n+        } else {\n+            log.debug(\"Property 'username' was not found\");\n+        }\n+        String password = binding.getProperties().get(\"password\");\n+        if (password != null) {\n+            properties.put(\"quarkus.datasource.password\", password);\n+        } else {\n+            log.debug(\"Property 'password' was not found\");\n+        }\n+        String host = binding.getProperties().get(\"host\");\n+        String port = binding.getProperties().get(\"port\");\n+        String database = binding.getProperties().get(\"database\");\n+        if ((host != null) && (database != null)) {\n+            String portPart = \"\";\n+            if (port != null) {\n+                portPart = \":\" + port;\n+            }\n+            properties.put(\"quarkus.datasource.jdbc.url\",\n+                    String.format(\"jdbc:%s://%s%s/%s\", urlType, host, portPart, database));", "originalCommit": "031e5bf4eddb2f6399ef8c726e8df8e63bb8439c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkyMTI0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/13942#discussion_r563921243", "bodyText": "It seems to be common for all the ones we support, no?", "author": "geoand", "createdAt": "2021-01-25T17:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkyMDM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkyNzQ0MA==", "url": "https://github.com/quarkusio/quarkus/pull/13942#discussion_r563927440", "bodyText": "Maybe. If you have checked them then we can probably live with it for the time being.", "author": "gsmet", "createdAt": "2021-01-25T17:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkyMDM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkyOTg1NA==", "url": "https://github.com/quarkusio/quarkus/pull/13942#discussion_r563929854", "bodyText": "I checked the URLs we use in the integration tests and they are all the same.\nI agree that long term we'll probably need a better strategy (which most likely will that into the various DB specifc properties that Service Binding might give us), but for the time being I think it's OK", "author": "geoand", "createdAt": "2021-01-25T17:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkyMDM3Mg=="}], "type": "inlineReview"}]}