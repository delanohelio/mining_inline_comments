{"pr_number": 13601, "pr_title": "Move non application endpoints to separate URL path", "pr_createdAt": "2020-12-01T20:10:54Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13601", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2OTAwMw==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r535869003", "bodyText": "So, does that mean that Framework is equivalent to NonApplication?\nCan't we have a single word?", "author": "cescoffier", "createdAt": "2020-12-04T06:35:58Z", "path": "extensions/smallrye-metrics/deployment/src/main/java/io/quarkus/smallrye/metrics/deployment/SmallRyeMetricsProcessor.java", "diffHunk": "@@ -154,7 +153,7 @@ MetricsCapabilityBuildItem metricsCapabilityBuildItem() {\n     @Record(STATIC_INIT)\n     void createRoute(BuildProducer<RouteBuildItem> routes,\n             SmallRyeMetricsRecorder recorder,\n-            HttpRootPathBuildItem httpRoot,\n+            FrameworkRootPathBuildItem frameworkRoot,", "originalCommit": "fe24084c5ace32ad009faa20f610a569fdfa2519", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4MTg3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r536081877", "bodyText": "Yeah, I kind of flip flopped between them.\nLeaning towards \"NonApplication\". If that's preferred I can align them all", "author": "kenfinnigan", "createdAt": "2020-12-04T12:58:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2OTAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEwMDkwOA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r536100908", "bodyText": "Yes, I actually prefer avoiding the word \"framework\"", "author": "cescoffier", "createdAt": "2020-12-04T13:31:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2OTAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE1NDkzNA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r537154934", "bodyText": "How about Core?", "author": "gastaldi", "createdAt": "2020-12-07T00:00:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2OTAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE1NTQ0NA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r537155444", "bodyText": "Um, actually I think something like management would make more sense", "author": "gastaldi", "createdAt": "2020-12-07T00:02:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2OTAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE3NDI1MA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r537174250", "bodyText": "management implies you can actually manage something, which isn't the case with these endpoints.\nI've changed it to \"NonApplication\"", "author": "kenfinnigan", "createdAt": "2020-12-07T01:30:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2OTAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2OTYwMA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r535869600", "bodyText": "Why does swagger-ui stay on the main router?\nI understand it's an asset, but that looks not totally right.", "author": "cescoffier", "createdAt": "2020-12-04T06:37:30Z", "path": "extensions/smallrye-openapi/deployment/src/test/java/io/quarkus/smallrye/openapi/test/spring/SwaggerAndOpenAPIWithCommonPrefixTest.java", "diffHunk": "@@ -25,7 +25,7 @@\n     @Test\n     public void shouldWorkEvenWithCommonPrefix() {\n         RestAssured.when().get(\"/swagger-ui/index.html\").then().statusCode(200).body(containsString(\"/swagger\"));", "originalCommit": "fe24084c5ace32ad009faa20f610a569fdfa2519", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4MjQ2NA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r536082464", "bodyText": "My reasoning, for now, is it's a Dev/Test extension only.\nHappy to revise either now or in future if that's the preferred approach", "author": "kenfinnigan", "createdAt": "2020-12-04T12:59:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2OTYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEwMTQxMg==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r536101412", "bodyText": "it's dev mode only because it was exposed on the public internet. But if we fix that \"small\" issue, it might be very useful even in prod.", "author": "cescoffier", "createdAt": "2020-12-04T13:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2OTYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEzNDc2NA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r536134764", "bodyText": "Fair enough, I can move to \"non app\" as well", "author": "kenfinnigan", "createdAt": "2020-12-04T14:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2OTYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MDIxMA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r535870210", "bodyText": "That only configure the \"/q\".\nDon't you want to allow having a separate HTTP server (maybe it's done somewhere else)", "author": "cescoffier", "createdAt": "2020-12-04T06:39:06Z", "path": "extensions/vertx-http/deployment/src/main/java/io/quarkus/vertx/http/deployment/FrameworkRootPathBuildItem.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package io.quarkus.vertx.http.deployment;\n+\n+import io.quarkus.builder.item.SimpleBuildItem;\n+\n+public final class FrameworkRootPathBuildItem extends SimpleBuildItem {\n+    private final String frameworkRootPath;\n+    private final boolean separateRoot;\n+\n+    public FrameworkRootPathBuildItem(String frameworkRootPath) {\n+        this.frameworkRootPath = frameworkRootPath;", "originalCommit": "fe24084c5ace32ad009faa20f610a569fdfa2519", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4MjY5NA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r536082694", "bodyText": "I've created #13602 to handle the port and binding options to keep this PR simple and get it in", "author": "kenfinnigan", "createdAt": "2020-12-04T13:00:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MDIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEwMTU0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r536101545", "bodyText": "ah ok!", "author": "cescoffier", "createdAt": "2020-12-04T13:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MDIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTA0OA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r535871048", "bodyText": "So, we have /quarkus for the console and /q for framework.\nI may be wrong but I don't believe the console should be \"application\".\nAlso, all guides, workshops and quickstarts would need an update once this is merged", "author": "cescoffier", "createdAt": "2020-12-04T06:41:25Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/HttpBuildTimeConfig.java", "diffHunk": "@@ -35,4 +35,13 @@\n      */\n     @ConfigItem(defaultValue = \"/quarkus\")\n     public String consolePath;\n+\n+    /**\n+     * The HTTP root path for framework endpoints. Various endpoints such as metrics, health,\n+     * and open api are deployed under this path.\n+     * Setting the value to \"/\" disables the separate framework root,\n+     * resulting in all framework endpoints being served from \"/\" along with the application.\n+     */\n+    @ConfigItem(defaultValue = \"/q\")\n+    public String frameworkRootPath;", "originalCommit": "fe24084c5ace32ad009faa20f610a569fdfa2519", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEzNTU0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r536135543", "bodyText": "Is that the new dev console that was created as part of Reactive Resteasy? Did that get merged already, might have missed it.\nIf it's in, would /q/console be ok?\nShould the guides be updated as part of this PR?", "author": "kenfinnigan", "createdAt": "2020-12-04T14:24:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1OTY4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r537259689", "bodyText": "I let @FroMage @stuartwdouglas and @geoand decide.", "author": "cescoffier", "createdAt": "2020-12-07T06:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2MDY4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r537260683", "bodyText": "The console started out as part of RESTEasy Reactive, but is now in a separate (not yet merged) branch. The console currently is under /@dev.", "author": "geoand", "createdAt": "2020-12-07T06:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMyNzA5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r537327091", "bodyText": "Who decided on the /q default prefix? Isn't it likely to conflict with user paths?", "author": "FroMage", "createdAt": "2020-12-07T08:48:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4ODA0NA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r537488044", "bodyText": "It was agreed a few weeks ago in a team meeting, but not set in stone", "author": "kenfinnigan", "createdAt": "2020-12-07T13:00:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU3MjM2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r537572362", "bodyText": "I guess I would have made it /@q to make sure it didn't conflict. But if everyone prefers /q let's go with that.\nAs for the dev console it should move to /q/dev if we do that.", "author": "FroMage", "createdAt": "2020-12-07T14:57:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU3NjIyNw==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r537576227", "bodyText": "I think @ is reserved for a special meaning within a scheme (eg.\nhttps://foo:bar@example.com)", "author": "gastaldi", "createdAt": "2020-12-07T15:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU4MzAzMQ==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r537583031", "bodyText": "But looking at the URL RFC I see that @ is accepted as part of the URL path, so I dunno \ud83d\ude03", "author": "gastaldi", "createdAt": "2020-12-07T15:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE0NTI4NA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r538145284", "bodyText": "It's only reserved as part of the authority section (host name).", "author": "FroMage", "createdAt": "2020-12-08T08:46:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTA0OA=="}], "type": "inlineReview"}, {"oid": "75ef760ea20034436e3fa7c1855d49e3f3bffd49", "url": "https://github.com/quarkusio/quarkus/commit/75ef760ea20034436e3fa7c1855d49e3f3bffd49", "message": "- Adds documentation updates\n- Includes Swagger UI under the new non application endpoint path\n- Changes names to refer to \"NonApplication\" instead of Framework", "committedDate": "2020-12-07T16:17:35Z", "type": "forcePushed"}, {"oid": "81c5b7b44e2774d644d3a07b6e0dff30489b6173", "url": "https://github.com/quarkusio/quarkus/commit/81c5b7b44e2774d644d3a07b6e0dff30489b6173", "message": "Move non application endpoints to separate URL path\n\n- Fixes #13144\n- OpenAPI, Metrics, Micrometer, Health, Health UI endpoints are all now served under /q by default\n- Previous behavior can be attained by setting `quarkus.http.framework-root-path` to `/`\n\nSubsequent issue will be created for handling port and binding changes for non application endpoints", "committedDate": "2020-12-09T17:55:45Z", "type": "commit"}, {"oid": "815f4d1dfa335344f176e1c21339dc6d9adedab0", "url": "https://github.com/quarkusio/quarkus/commit/815f4d1dfa335344f176e1c21339dc6d9adedab0", "message": "Fix some more url references in tests found from CI", "committedDate": "2020-12-09T17:55:45Z", "type": "commit"}, {"oid": "7c3b4d4c802155031c2bb4b0a5f7bdd3d67bb559", "url": "https://github.com/quarkusio/quarkus/commit/7c3b4d4c802155031c2bb4b0a5f7bdd3d67bb559", "message": "- Adds documentation updates\n- Includes Swagger UI under the new non application endpoint path\n- Changes names to refer to \"NonApplication\" instead of Framework", "committedDate": "2020-12-09T17:55:46Z", "type": "commit"}, {"oid": "52a3a0a8c3702712296a6ef40e5fed5ffb0aea09", "url": "https://github.com/quarkusio/quarkus/commit/52a3a0a8c3702712296a6ef40e5fed5ffb0aea09", "message": "Forgot I fixed this test in GH UI last week", "committedDate": "2020-12-09T17:55:46Z", "type": "commit"}, {"oid": "90f5e5706ccd3303f831d74748f786e335c048b3", "url": "https://github.com/quarkusio/quarkus/commit/90f5e5706ccd3303f831d74748f786e335c048b3", "message": "Missed a couple of Swagger UI path usages", "committedDate": "2020-12-09T17:55:46Z", "type": "commit"}, {"oid": "b9a8fcfddc973b407d54f5c1657db33f45147c65", "url": "https://github.com/quarkusio/quarkus/commit/b9a8fcfddc973b407d54f5c1657db33f45147c65", "message": "Add HTTP Redirect from current path to new non application endpoint root path", "committedDate": "2020-12-09T17:56:30Z", "type": "commit"}, {"oid": "b9a8fcfddc973b407d54f5c1657db33f45147c65", "url": "https://github.com/quarkusio/quarkus/commit/b9a8fcfddc973b407d54f5c1657db33f45147c65", "message": "Add HTTP Redirect from current path to new non application endpoint root path", "committedDate": "2020-12-09T17:56:30Z", "type": "forcePushed"}, {"oid": "44d55418d49e5eeec611a31ef82750ccdd61eb0e", "url": "https://github.com/quarkusio/quarkus/commit/44d55418d49e5eeec611a31ef82750ccdd61eb0e", "message": "Minor grammar cleanup in docs", "committedDate": "2020-12-09T18:17:44Z", "type": "commit"}, {"oid": "578016b2ec3a0fa3ed006042a4f2ac659451d1ad", "url": "https://github.com/quarkusio/quarkus/commit/578016b2ec3a0fa3ed006042a4f2ac659451d1ad", "message": "- Add ability to disable redirect of non application endpoints to non application root path\n- Renamed property for defining non application root path to no longer use \"framework\"", "committedDate": "2020-12-09T18:28:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0NDk4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r539544986", "bodyText": "Should this be disable-able?", "author": "ebullient", "createdAt": "2020-12-09T18:27:52Z", "path": "extensions/vertx-http/deployment/src/main/java/io/quarkus/vertx/http/deployment/VertxHttpProcessor.java", "diffHunk": "@@ -117,11 +122,28 @@ public KubernetesPortBuildItem kubernetes() {\n     VertxWebRouterBuildItem initializeRouter(VertxHttpRecorder recorder,\n             CoreVertxBuildItem vertx,\n             List<RouteBuildItem> routes,\n+            NonApplicationRootPathBuildItem nonApplicationRootPath,\n+            BuildProducer<VertxNonApplicationRouterBuildItem> frameworkRouterBuildProducer,\n             ShutdownContextBuildItem shutdown) {\n \n         RuntimeValue<Router> router = recorder.initializeRouter(vertx.getVertx());\n+        RuntimeValue<Router> frameworkRouter = recorder.initializeRouter(vertx.getVertx());\n+        boolean frameworkRouterFound = false;\n+\n         for (RouteBuildItem route : routes) {\n-            recorder.addRoute(router, route.getRouteFunction(), route.getHandler(), route.getType());\n+            if (nonApplicationRootPath.isSeparateRoot() && route.isFrameworkRoute()) {\n+                frameworkRouterFound = true;\n+                recorder.addRoute(frameworkRouter, route.getRouteFunction(), route.getHandler(), route.getType());\n+            } else {\n+                recorder.addRoute(router, route.getRouteFunction(), route.getHandler(), route.getType());\n+            }\n+        }\n+\n+        if (frameworkRouterFound && nonApplicationRootPath.isSeparateRoot()) {\n+            // Handle redirects from old paths to new non application endpoint root\n+            recorder.addNonApplicationPathRedirect(router, frameworkRouter, nonApplicationRootPath.getFrameworkRootPath());\n+", "originalCommit": "44d55418d49e5eeec611a31ef82750ccdd61eb0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0OTkwMg==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r539549902", "bodyText": "I think httpBuildTimeConfig.redirectToNonApplicationRootPath came in while I was reviewing .. ;)", "author": "ebullient", "createdAt": "2020-12-09T18:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0NDk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0ODA2MA==", "url": "https://github.com/quarkusio/quarkus/pull/13601#discussion_r539548060", "bodyText": "This is one of the only places w/o the leading '/' ...\nwhile it may work, the inconsistency is noticable", "author": "ebullient", "createdAt": "2020-12-09T18:32:21Z", "path": "integration-tests/main/src/test/java/io/quarkus/it/main/OpenApiTestCase.java", "diffHunk": "@@ -22,7 +22,7 @@\n \n     private static final String DEFAULT_MEDIA_TYPE = \"application/json\";\n \n-    @TestHTTPResource(\"openapi\")\n+    @TestHTTPResource(\"q/openapi\")", "originalCommit": "44d55418d49e5eeec611a31ef82750ccdd61eb0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "663570cd008a0fa892b06a2ffc3d08cec3a261a1", "url": "https://github.com/quarkusio/quarkus/commit/663570cd008a0fa892b06a2ffc3d08cec3a261a1", "message": "Fix my bad substring!", "committedDate": "2020-12-09T20:26:09Z", "type": "commit"}]}