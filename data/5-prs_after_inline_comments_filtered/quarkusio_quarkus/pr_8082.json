{"pr_number": 8082, "pr_title": "fix security checks to make @RolesAllowed(\"**\") work", "pr_createdAt": "2020-03-23T13:43:33Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8082", "timeline": [{"oid": "bd04dc7775b0457050371e98c855722ef030d4ed", "url": "https://github.com/quarkusio/quarkus/commit/bd04dc7775b0457050371e98c855722ef030d4ed", "message": "fix security checks to make @RolesAllowed(\"**\") work\n\nThe correct wildcard to use seems to be `**`, because that's what\nthe Jakarta EE specifications use. More specifically:\n\n- the EJB spec says that `**` means all roles\n  (chapter 12.2.5.2 in EJB 3.2 Core spec)\n- the Servlet spec says that `**` means all roles and `*` should\n  never be used (chapter 13.3 in Servlet 4.0 spec)\n- the JAX-RS specification doesn't seem to define this, but\n  `QuarkusResteasySecurityContext.isUserInRole` already uses `**`", "committedDate": "2020-03-23T13:34:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5MjU2MA==", "url": "https://github.com/quarkusio/quarkus/pull/8082#discussion_r396492560", "bodyText": "So do we support *?\nIf it's what we documented before, we should probably support it.", "author": "gsmet", "createdAt": "2020-03-23T14:29:20Z", "path": "extensions/security/runtime/src/main/java/io/quarkus/security/runtime/interceptor/check/RolesAllowedCheck.java", "diffHunk": "@@ -54,7 +54,7 @@ public void apply(SecurityIdentity identity, Method method, Object[] parameters)\n         Set<String> roles = identity.getRoles();\n         if (roles != null) {\n             for (String role : allowedRoles) {\n-                if (roles.contains(role)) {\n+                if (roles.contains(role) || (\"**\".equals(role) && !identity.isAnonymous())) {", "originalCommit": "bd04dc7775b0457050371e98c855722ef030d4ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwNDQzMg==", "url": "https://github.com/quarkusio/quarkus/pull/8082#discussion_r396504432", "bodyText": "It was in the documentation, but didn't work. ** is what used to work (and still works) on other places (such as isUserInRole), this commit just brings @RolesAllowed on par.", "author": "Ladicek", "createdAt": "2020-03-23T14:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5MjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwODU2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8082#discussion_r396508563", "bodyText": "OK, let's have @sberyozkin check that.", "author": "gsmet", "createdAt": "2020-03-23T14:50:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5MjU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyMzA0NA==", "url": "https://github.com/quarkusio/quarkus/pull/8082#discussion_r396623044", "bodyText": "@Ladicek That looks fine, but do we also have to tweak smallrye-jwt code somewhere as you said it supports * ?", "author": "sberyozkin", "createdAt": "2020-03-23T17:22:35Z", "path": "extensions/security/runtime/src/main/java/io/quarkus/security/runtime/interceptor/check/RolesAllowedCheck.java", "diffHunk": "@@ -54,7 +54,7 @@ public void apply(SecurityIdentity identity, Method method, Object[] parameters)\n         Set<String> roles = identity.getRoles();\n         if (roles != null) {\n             for (String role : allowedRoles) {\n-                if (roles.contains(role)) {\n+                if (roles.contains(role) || (\"**\".equals(role) && !identity.isAnonymous())) {", "originalCommit": "bd04dc7775b0457050371e98c855722ef030d4ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2NDE2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8082#discussion_r396964162", "bodyText": "Yea: https://github.com/smallrye/smallrye-jwt/blob/master/implementation/src/main/java/io/smallrye/jwt/auth/jaxrs/RolesAllowedFilter.java#L45\nI'll submit a PR to SmallRye JWT once I verify that the SmallRye JWT code is actually used. The security stuff in Quarkus is hard to navigate :-)", "author": "Ladicek", "createdAt": "2020-03-24T08:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyMzA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1MDY5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8082#discussion_r397050699", "bodyText": "@Ladicek Cool, thanks for spotting it, that JAX-RS code is not used by quarkus-smallrye-jwt", "author": "sberyozkin", "createdAt": "2020-03-24T10:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyMzA0NA=="}], "type": "inlineReview"}]}