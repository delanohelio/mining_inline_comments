{"pr_number": 7448, "pr_title": "Fix a connection-delay processing", "pr_createdAt": "2020-02-27T00:05:49Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7448", "timeline": [{"oid": "cace3a4d1a503d05dbc9ce33eb726b8c8113875f", "url": "https://github.com/quarkusio/quarkus/commit/cace3a4d1a503d05dbc9ce33eb726b8c8113875f", "message": "Fix a connection-delay processing", "committedDate": "2020-02-27T00:11:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMzNA==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r384848334", "bodyText": "Can this be called in an IO thread?", "author": "stuartwdouglas", "createdAt": "2020-02-27T00:27:39Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcRecorder.java", "diffHunk": "@@ -119,16 +120,22 @@ public void handle(AsyncResult<OAuth2Auth> event) {\n \n                 auth = cf.join();\n                 break;\n-            } catch (OIDCException ex) {\n-                if (i + 1 < connectionRetryCount) {\n-                    try {\n-                        Thread.sleep(2000);\n-                    } catch (InterruptedException iex) {\n-                        // continue connecting\n+            } catch (Throwable throwable) {\n+                while (throwable instanceof CompletionException && throwable.getCause() != null) {\n+                    throwable = throwable.getCause();\n+                }\n+                if (throwable instanceof OIDCException) {\n+                    if (i + 1 < connectionRetryCount) {\n+                        try {\n+                            Thread.sleep(2000);", "originalCommit": "cace3a4d1a503d05dbc9ce33eb726b8c8113875f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4NjE1OA==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385086158", "bodyText": "Hi Stuart @stuartwdouglas Good question, I don't know, do you mean avoid using the future at all ? It just joins till the OIDC server has been contacted, may be it is not needed. This is done at the application start up, no client requests are involved.", "author": "sberyozkin", "createdAt": "2020-02-27T12:07:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4ODAxMQ==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385088011", "bodyText": "@stuartwdouglas runAsync I guess, let me try, though I'd not've guessed it implies a more optimal thread consumption in this case :-)", "author": "sberyozkin", "createdAt": "2020-02-27T12:11:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5NjMyMA==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385096320", "bodyText": "@stuartwdouglas Should be better now", "author": "sberyozkin", "createdAt": "2020-02-27T12:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5NjM4MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385396381", "bodyText": "what I was actually getting at was should we change this to register a timer and callback, rather than blocking a thread for 2s?", "author": "stuartwdouglas", "createdAt": "2020-02-27T22:00:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQxNjUzOA==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385416538", "bodyText": "@stuartwdouglas Callback to what condition though ? Vertx tells us OIDC is not contactable. It won't let us save 1 sec out of those 2 secs by calling back when OIDC becomes contactable unless this timer you are proposing will be pinging OIDC every 100 milliseconds. Is it what you suggest be done here ? I'm not sure it is really worth it, we are not dealing with the actual client request here. May be just reducing a wait period from 2 secs to 200 milliseconds is a simpler version of the timer/callback approach ?", "author": "sberyozkin", "createdAt": "2020-02-27T22:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMzNA=="}], "type": "inlineReview"}, {"oid": "4cef6530304e67282788d2cd025bee45dd43b9c5", "url": "https://github.com/quarkusio/quarkus/commit/4cef6530304e67282788d2cd025bee45dd43b9c5", "message": "Fix a connection-delay processing", "committedDate": "2020-02-27T12:29:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5NjY2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385396661", "bodyText": "runAsync should never be used, it uses the default fork join pool that we have no control over.", "author": "stuartwdouglas", "createdAt": "2020-02-27T22:00:57Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcRecorder.java", "diffHunk": "@@ -119,16 +120,29 @@ public void handle(AsyncResult<OAuth2Auth> event) {\n \n                 auth = cf.join();\n                 break;\n-            } catch (OIDCException ex) {\n-                if (i + 1 < connectionRetryCount) {\n-                    try {\n-                        Thread.sleep(2000);\n-                    } catch (InterruptedException iex) {\n-                        // continue connecting\n+            } catch (Throwable throwable) {\n+                while (throwable instanceof CompletionException && throwable.getCause() != null) {\n+                    throwable = throwable.getCause();\n+                }\n+                if (throwable instanceof OIDCException) {\n+                    if (i + 1 < connectionRetryCount) {\n+                        CompletableFuture.runAsync(", "originalCommit": "4cef6530304e67282788d2cd025bee45dd43b9c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQxNjg0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385416843", "bodyText": "Right, recall you were saying in context of the CL work...", "author": "sberyozkin", "createdAt": "2020-02-27T22:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5NjY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5Njg1Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385396852", "bodyText": "Also this blocks the thread anyway, so now you are blocking 2 threads instead of just one.", "author": "stuartwdouglas", "createdAt": "2020-02-27T22:01:25Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcRecorder.java", "diffHunk": "@@ -119,16 +120,29 @@ public void handle(AsyncResult<OAuth2Auth> event) {\n \n                 auth = cf.join();\n                 break;\n-            } catch (OIDCException ex) {\n-                if (i + 1 < connectionRetryCount) {\n-                    try {\n-                        Thread.sleep(2000);\n-                    } catch (InterruptedException iex) {\n-                        // continue connecting\n+            } catch (Throwable throwable) {\n+                while (throwable instanceof CompletionException && throwable.getCause() != null) {\n+                    throwable = throwable.getCause();\n+                }\n+                if (throwable instanceof OIDCException) {\n+                    if (i + 1 < connectionRetryCount) {\n+                        CompletableFuture.runAsync(\n+                                new Runnable() {\n+                                    @Override\n+                                    public void run() {\n+                                        try {\n+                                            Thread.sleep(2000);\n+                                        } catch (InterruptedException iex) {\n+                                            // continue connecting\n+                                        }\n+                                    }\n+                                })\n+                                .join();", "originalCommit": "4cef6530304e67282788d2cd025bee45dd43b9c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQxNzU3MA==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385417570", "bodyText": "Well it can be concluded I did not draw the right conclusion based on the io thread proposal :-)", "author": "sberyozkin", "createdAt": "2020-02-27T22:52:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5Njg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjQ1Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r386196453", "bodyText": "I misread this, I thought it was happening at runtime. It's not ideal that it connects to each tenant sequentially but it is probably fine for now, sorry for the noise.", "author": "stuartwdouglas", "createdAt": "2020-03-02T04:50:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5Njg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwMTg3Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r386301872", "bodyText": "@stuartwdouglas Hi Stuart, no problems at all, it has been awhile since I had to think so hard, trying to figure out how to link all those Functions and Consumers :-).\nGood point about the runtime, in fact we have 2 cases here, one is when the static TenantContextConfigs are created, those in the application.properties and a new case when the multi-tenancy resolvers may need it, during the client request, and I was thinking may be we should not even support the connection-delay property in this latter case, if someone sets to even 10 sec it won't be good. This property has been added to help in the cases when at the initial start up, the OIDC server is a few secs behind, to help with the tests mainly...I'll create a small issue afterwards, so that we can decide if to ignore this property in those cases or if not then at least make the more optimal use of the current io thread as per your proposal", "author": "sberyozkin", "createdAt": "2020-03-02T10:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5Njg1Mg=="}], "type": "inlineReview"}, {"oid": "2bdd2ea63eb3bc85d9b5749a3ff9c0c38c6f7f1a", "url": "https://github.com/quarkusio/quarkus/commit/2bdd2ea63eb3bc85d9b5749a3ff9c0c38c6f7f1a", "message": "Fix a connection-delay processing", "committedDate": "2020-03-02T10:54:20Z", "type": "forcePushed"}, {"oid": "066712100a56ed70121c8c8a14ac757ab789260e", "url": "https://github.com/quarkusio/quarkus/commit/066712100a56ed70121c8c8a14ac757ab789260e", "message": "Fix a connection-delay processing", "committedDate": "2020-03-03T15:08:26Z", "type": "commit"}, {"oid": "066712100a56ed70121c8c8a14ac757ab789260e", "url": "https://github.com/quarkusio/quarkus/commit/066712100a56ed70121c8c8a14ac757ab789260e", "message": "Fix a connection-delay processing", "committedDate": "2020-03-03T15:08:26Z", "type": "forcePushed"}]}