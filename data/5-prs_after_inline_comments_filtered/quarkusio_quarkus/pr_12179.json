{"pr_number": 12179, "pr_title": "Ability to start test resources in parallel (concurrently)", "pr_createdAt": "2020-09-18T00:39:25Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/12179", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0Mjg4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/12179#discussion_r490642883", "bodyText": "This needs to be shutdown in a finally block", "author": "stuartwdouglas", "createdAt": "2020-09-18T01:06:01Z", "path": "test-framework/common/src/main/java/io/quarkus/test/common/TestResourceManager.java", "diffHunk": "@@ -46,17 +64,41 @@ public void init() {\n \n     public Map<String, String> start() {\n         started = true;\n-        Map<String, String> ret = new HashMap<>();\n-        for (TestResourceEntry entry : testResourceEntries) {\n-            try {\n-                Map<String, String> start = entry.getTestResource().start();\n-                if (start != null) {\n-                    ret.putAll(start);\n+        Map<String, String> ret = new ConcurrentHashMap<>();\n+\n+        ExecutorService executor = newExecutor();", "originalCommit": "b4282979056c2819bcf98e428ff948f7631cb6da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk0MjA1OQ==", "url": "https://github.com/quarkusio/quarkus/pull/12179#discussion_r490942059", "bodyText": "Well spotted! Thanks :)\nI'll fix it along with the other issue you mentioned after you respond", "author": "Nunalves", "createdAt": "2020-09-18T13:17:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0Mjg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MzI0NA==", "url": "https://github.com/quarkusio/quarkus/pull/12179#discussion_r490643244", "bodyText": "I would just use a fixed pool sized to the number of tasks", "author": "stuartwdouglas", "createdAt": "2020-09-18T01:07:16Z", "path": "test-framework/common/src/main/java/io/quarkus/test/common/TestResourceManager.java", "diffHunk": "@@ -69,8 +111,22 @@ public void init() {\n         return ret;\n     }\n \n+    private void waitForAllFutures(List<Future> startFutures) {\n+        for (Future future : startFutures) {\n+            try {\n+                future.get();\n+            } catch (CancellationException | InterruptedException | ExecutionException e) {\n+                throw new RuntimeException(\"Error waiting for test resource future to finish.\", e);\n+            }\n+        }\n+    }\n+\n+    private ExecutorService newExecutor() {\n+        return Executors.newWorkStealingPool();", "originalCommit": "b4282979056c2819bcf98e428ff948f7631cb6da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkzNDA3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/12179#discussion_r490934077", "bodyText": "I thought of doing that. I even searched to see if there was any shared thread pool that would be indicated to use here. I can change it, but shouldn't we have a limit at least? The first test to run will be the one starting up all the different test resources (that should never be something like 100, i don't think so, but you never know :p)\nWhat do you think? fixed pool size to the number of tasks with a limit to the number of CPUs?", "author": "Nunalves", "createdAt": "2020-09-18T13:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MzI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU4Mjk5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/12179#discussion_r497582992", "bodyText": "I agree limiting it to the number of CPUs is a good idea.", "author": "gsmet", "createdAt": "2020-09-30T15:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MzI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczMjM4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/12179#discussion_r497732386", "bodyText": "This ^ plus maybe a system property to override the default?", "author": "famod", "createdAt": "2020-09-30T18:57:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MzI0NA=="}], "type": "inlineReview"}, {"oid": "85279b1487aed7d2447f0f9189441e582195fef8", "url": "https://github.com/quarkusio/quarkus/commit/85279b1487aed7d2447f0f9189441e582195fef8", "message": "Add docs", "committedDate": "2021-01-11T22:18:22Z", "type": "forcePushed"}, {"oid": "2a188672985a6dc0e184aa46d483c8ee77833405", "url": "https://github.com/quarkusio/quarkus/commit/2a188672985a6dc0e184aa46d483c8ee77833405", "message": "Ability to start test resources in parallel (concurrently)", "committedDate": "2021-01-17T20:44:09Z", "type": "commit"}, {"oid": "db47e7bda74f66ace7ed508bf80f94d3f8a00c06", "url": "https://github.com/quarkusio/quarkus/commit/db47e7bda74f66ace7ed508bf80f94d3f8a00c06", "message": "Apply code review suggestions", "committedDate": "2021-01-17T20:44:09Z", "type": "commit"}, {"oid": "a8710c903c9d6ec149599b1cd9afc11261f7e78b", "url": "https://github.com/quarkusio/quarkus/commit/a8710c903c9d6ec149599b1cd9afc11261f7e78b", "message": "fix bad commit", "committedDate": "2021-01-17T20:44:09Z", "type": "commit"}, {"oid": "ae62989ded56cadda70d2d1b73ed6edd4e7c9e8f", "url": "https://github.com/quarkusio/quarkus/commit/ae62989ded56cadda70d2d1b73ed6edd4e7c9e8f", "message": "Add docs", "committedDate": "2021-01-17T20:44:09Z", "type": "commit"}, {"oid": "a11bedf6eec180ac2c31123a572904677d28ed23", "url": "https://github.com/quarkusio/quarkus/commit/a11bedf6eec180ac2c31123a572904677d28ed23", "message": "Don't swallow exception in QuarkusTestExtension#getAdditionalTestResources", "committedDate": "2021-01-17T20:49:55Z", "type": "commit"}, {"oid": "a11bedf6eec180ac2c31123a572904677d28ed23", "url": "https://github.com/quarkusio/quarkus/commit/a11bedf6eec180ac2c31123a572904677d28ed23", "message": "Don't swallow exception in QuarkusTestExtension#getAdditionalTestResources", "committedDate": "2021-01-17T20:49:55Z", "type": "forcePushed"}, {"oid": "3ec965fc3cdb7b09b4384e529446a0a75718a2dd", "url": "https://github.com/quarkusio/quarkus/commit/3ec965fc3cdb7b09b4384e529446a0a75718a2dd", "message": "Fix issue with test profiles", "committedDate": "2021-01-17T23:00:39Z", "type": "commit"}]}