{"pr_number": 9143, "pr_title": "Fail the build when a k8s deployment was requested by API server can't be reached", "pr_createdAt": "2020-05-07T07:42:01Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9143", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0ODc0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/9143#discussion_r421348745", "bodyText": "should this not also include the masterURL?", "author": "maxandersen", "createdAt": "2020-05-07T08:58:20Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesDeploy.java", "diffHunk": "@@ -32,25 +31,28 @@ public boolean getAsBoolean() {\n         if (serverFound) {\n             return true;\n         }\n-        try (final KubernetesClient client = KubernetesClientUtils.createClient()) {\n+\n+        KubernetesClient client = KubernetesClientUtils.createClient();\n+        String masterURL = client.getConfiguration().getMasterUrl();\n+        try {\n+            masterURL = client.getConfiguration().getMasterUrl();\n             //Let's check id we can connect.\n             RootPaths paths = client.rootPaths();\n-            log.info(\"Found kubernetes server.\");\n+            log.info(\"Kubernetes API Server at '\" + masterURL + \"' successfully contacted.\");\n             serverFound = true;\n+            client.close();\n             return true;\n         } catch (Exception e) {\n-            if (!alreadyWarned) {\n-                if (e.getCause() instanceof SSLHandshakeException) {\n-                    String message = \"Although a Kubernetes deployment was requested, it will however not take place because the API Server certificates are not trusted. The certificates can be configured using the relevant configuration propertiers under the 'quarkus.kubernetes-client' config root, or \\\"quarkus.kubernetes-client.trust-certs=true\\\" can be set to explicitly trust the certificates (not recommended)\";\n-                    log.warn(message);\n-                } else {\n-                    log.error(\n-                            \"Although a Kubernetes deployment was requested, it will however not take place because there was an error during communication with the API Server: \"\n-                                    + e.getMessage());\n-                }\n-                alreadyWarned = true;\n+            if (e.getCause() instanceof SSLHandshakeException) {\n+                throw new RuntimeException(\n+                        \"Although a Kubernetes deployment was requested, it however cannot take place because the API Server certificates are not trusted. The certificates can be configured using the relevant configuration propertiers under the 'quarkus.kubernetes-client' config root, or \\\"quarkus.kubernetes-client.trust-certs=true\\\" can be set to explicitly trust the certificates (not recommended)\",", "originalCommit": "c6b4209a8d3558a2017158dcf46379cf398faebb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM1MDEwOA==", "url": "https://github.com/quarkusio/quarkus/pull/9143#discussion_r421350108", "bodyText": "Ah yeah, I missed it", "author": "geoand", "createdAt": "2020-05-07T09:00:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0ODc0NQ=="}], "type": "inlineReview"}, {"oid": "d925a87a0c77711a1eb6dc01faf2f635c185eb40", "url": "https://github.com/quarkusio/quarkus/commit/d925a87a0c77711a1eb6dc01faf2f635c185eb40", "message": "Make KNative test more robust\n\nEnsure that the test always deserializes the proper Service class", "committedDate": "2020-05-07T09:49:43Z", "type": "commit"}, {"oid": "0ca356b07b590bcc3568405e838f8df9e6e6ef5e", "url": "https://github.com/quarkusio/quarkus/commit/0ca356b07b590bcc3568405e838f8df9e6e6ef5e", "message": "Fail the build when a k8s deployment was requested by API server can't be reached\n\nFixes: #9129", "committedDate": "2020-05-07T09:49:43Z", "type": "forcePushed"}, {"oid": "11478a61464f51c741e170c0832f1d5406315b92", "url": "https://github.com/quarkusio/quarkus/commit/11478a61464f51c741e170c0832f1d5406315b92", "message": "Fail the build when a k8s deployment was requested by API server can't be reached\n\nFixes: #9129", "committedDate": "2020-05-07T12:00:04Z", "type": "commit"}, {"oid": "11478a61464f51c741e170c0832f1d5406315b92", "url": "https://github.com/quarkusio/quarkus/commit/11478a61464f51c741e170c0832f1d5406315b92", "message": "Fail the build when a k8s deployment was requested by API server can't be reached\n\nFixes: #9129", "committedDate": "2020-05-07T12:00:04Z", "type": "forcePushed"}]}