{"pr_number": 8327, "pr_title": "Add support for @InjectMock", "pr_createdAt": "2020-04-01T10:45:18Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8327", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1NzE2NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r401657165", "bodyText": "If you store the InstanceHandle you can use it later to destroy a @Dependent bean correctly. See io.quarkus.arc.InstanceHandle.close().", "author": "mkouba", "createdAt": "2020-04-01T14:26:12Z", "path": "test-framework/junit5-mockito/src/main/java/io/quarkus/test/junit/mockito/internal/CreateMockitoMocksCallback.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package io.quarkus.test.junit.mockito.internal;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.inject.Qualifier;\n+\n+import org.mockito.Mockito;\n+\n+import io.quarkus.arc.Arc;\n+import io.quarkus.arc.InstanceHandle;\n+import io.quarkus.test.junit.callback.QuarkusTestBeforeAllCallback;\n+import io.quarkus.test.junit.mockito.MockBean;\n+\n+public class CreateMockitoMocksCallback implements QuarkusTestBeforeAllCallback {\n+\n+    @Override\n+    public void beforeAll(Object testInstance) {\n+        Class<?> current = testInstance.getClass();\n+        while (current.getSuperclass() != null) {\n+            for (Field field : current.getDeclaredFields()) {\n+                MockBean mockBeanAnnotation = field.getAnnotation(MockBean.class);\n+                if (mockBeanAnnotation != null) {\n+                    Object beanInstance = getBeanInstance(testInstance, field);\n+                    Object mock = createMockAndSetTestField(testInstance, field, beanInstance);\n+                    MockitoMocksTracker.track(testInstance, mock, beanInstance);\n+                }\n+            }\n+            current = current.getSuperclass();\n+        }\n+    }\n+\n+    private Object createMockAndSetTestField(Object testInstance, Field field, Object beanInstance) {\n+        Object mock = Mockito.mock(beanInstance.getClass());\n+        field.setAccessible(true);\n+        try {\n+            field.set(testInstance, mock);\n+        } catch (IllegalAccessException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return mock;\n+    }\n+\n+    private Object getBeanInstance(Object testInstance, Field field) {\n+        Class<?> fieldClass = field.getType();\n+        InstanceHandle<?> instance = Arc.container().instance(fieldClass, getQualifiers(field));", "originalCommit": "fa3f510a221c4301fac90bd6bd302de4238af9f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNzg5Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r401927896", "bodyText": "We can't really mock @dependent beans anyway.", "author": "stuartwdouglas", "createdAt": "2020-04-01T21:43:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1NzE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0ODM2OA==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r402048368", "bodyText": "Hm... Here we aren't storing the references, just using them to check and then obtain the bean. So we don't need to close them anywhere, no?", "author": "geoand", "createdAt": "2020-04-02T04:43:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1NzE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4NDY2NA==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r402084664", "bodyText": "We can't really mock @dependent beans anyway.\n\nAh, that's correct. For @Dependent it would fail later when we try to install the mock by means of QuarkusMock.\n\nSo we don't need to close them anywhere, no?\n\nIt's ok for normal scoped beans and @Singleton. Nok for @Dependent.", "author": "mkouba", "createdAt": "2020-04-02T06:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1NzE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4NTgyOQ==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r402085829", "bodyText": "Ah, now I see what your concern was! So yeah, no @Dependent - no problem :)", "author": "geoand", "createdAt": "2020-04-02T06:46:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1NzE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY2NTE2NA==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r401665164", "bodyText": "Since these are not CDI injection points it could happen that ArC will consider the resolved beans removable. Maybe we should handle this use case and mark them unremovable?", "author": "mkouba", "createdAt": "2020-04-01T14:36:26Z", "path": "integration-tests/mockbean/src/test/java/io/quarkus/it/mockbean/GreetingResourceTest.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package io.quarkus.it.mockbean;\n+\n+import static io.restassured.RestAssured.given;\n+import static org.hamcrest.Matchers.is;\n+\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mockito;\n+\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.quarkus.test.junit.mockito.MockBean;\n+\n+@QuarkusTest\n+class GreetingResourceTest {\n+\n+    @MockBean\n+    MessageService messageService;", "originalCommit": "fa3f510a221c4301fac90bd6bd302de4238af9f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0OTM5NA==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r402049394", "bodyText": "Like @stuartwdouglas said, if the bean has been removed, mocking won't change anything, so how would the user see the results of the their test?\nI don't think this scenario is actually possible.\nIt's likely I think that if normally the bean would be removed in the prod app, the user would be injecting some other bean into the test to check the effect of the mock, thus making the mock unremovable.", "author": "geoand", "createdAt": "2020-04-02T04:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY2NTE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r401674194", "bodyText": "So I wonder if we could just get rid of the injection part and provide an API like this:\n@Test\npublic void testGreet() {\n   Mockito.when(MockBean.of(MessageService.class).getMessage()).thenReturn(\"hi\");\n   ...\n}\n... where MockBean.of() would basically do QuarkusMock.installMockForType(Mockito.mock(MessageService.class), MessageService.class) and return the mock instance (and possibly cache the instance or something like that).", "author": "mkouba", "createdAt": "2020-04-01T14:48:23Z", "path": "integration-tests/mockbean/src/test/java/io/quarkus/it/mockbean/GreetingResourceTest.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package io.quarkus.it.mockbean;\n+\n+import static io.restassured.RestAssured.given;\n+import static org.hamcrest.Matchers.is;\n+\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mockito;\n+\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.quarkus.test.junit.mockito.MockBean;\n+\n+@QuarkusTest\n+class GreetingResourceTest {\n+\n+    @MockBean\n+    MessageService messageService;\n+\n+    @MockBean\n+    SuffixService suffixService;\n+\n+    @Test\n+    public void testGreet() {\n+        Mockito.when(messageService.getMessage()).thenReturn(\"hi\");", "originalCommit": "fa3f510a221c4301fac90bd6bd302de4238af9f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3OTg2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r401679861", "bodyText": "Hm, maybe it's not a good idea. The injection points can be reused and allow us to mark the beans unremovable. Another idea - if we do @Inject @MockBean the client proxies will be injected first and we could wrap it afterwards. @MockBean is ignored by ArC but allows CreateMockitoMocksCallback to wrap the stuff. The advantage of this approach would be (1) no need to mark the beans unremovable, (2) no need to hold the instance handles and destroy them correctly.", "author": "mkouba", "createdAt": "2020-04-01T14:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY4Njc2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r401686761", "bodyText": "Let me think about it and get back to you tomorrow :)", "author": "geoand", "createdAt": "2020-04-01T15:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY5NDk0NA==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r401694944", "bodyText": "Feel free to ping me to discuss the API ;-)", "author": "mkouba", "createdAt": "2020-04-01T15:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNzIyMg==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r401927222", "bodyText": "If a bean is removable then then mocking it would have no effect anyway.", "author": "stuartwdouglas", "createdAt": "2020-04-01T21:42:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0ODIwNQ==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r402048205", "bodyText": "@mkouba if we do @Inject @MockBean in the test, then how would the user control the mocks?\nMy idea about @MockBean is that it should just be a Mockito mock that users already know how to handle without having to do anything else.  If we add @Inject in the mix, won't that complicate the mock usage on the user side?", "author": "geoand", "createdAt": "2020-04-02T04:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4MDY4MA==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r402080680", "bodyText": "If a bean is removable then then mocking it would have no effect anyway.\n\nIf a bean is removable then a null would be injected or an exception would be thrown - depends on the CreateMockitoMocksCallback impl. My point is that right now you can test a bean in a @QuarkusTest even if it would be normally removed in production because test class is considered a bean.\n\nif we do @Inject @MockBean in the test, then how would the user control the mocks?\n\nLike I said - the client proxies could be injected by ArC and then wrapped in the CreateMockitoMocksCallback and the wrapped mocks could be set back to the fields. So you would do Mockito.when(messageService.getMessage()).thenReturn(\"hi\") like you do now.", "author": "mkouba", "createdAt": "2020-04-02T06:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4NTMwMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r402085301", "bodyText": "@mkouba I agree completely about testing beans injected into a class - they are made unremovable because you are actually testing those beans.\nIn the mock case however, you aren't testing the injected mocks, you are testing whatever component uses the mocks - so making them unremovable should have no effect.\nAm I missing something?", "author": "geoand", "createdAt": "2020-04-02T06:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEwMTQwMw==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r402101403", "bodyText": "You're probably right. It's a bit confusing though. We should probably add some docs and explain the intention...", "author": "mkouba", "createdAt": "2020-04-02T07:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEwMjIzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r402102239", "bodyText": "Yes of course, I haven't added any docs yet but I absolutely plan to do so.", "author": "geoand", "createdAt": "2020-04-02T07:22:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIxMTI1Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8327#discussion_r402211257", "bodyText": "I added some documentation. WDYT @mkouba ?", "author": "geoand", "createdAt": "2020-04-02T10:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NDE5NA=="}], "type": "inlineReview"}, {"oid": "aee3aa72899766681b0e1e2d3e1b46f02fd7ce14", "url": "https://github.com/quarkusio/quarkus/commit/aee3aa72899766681b0e1e2d3e1b46f02fd7ce14", "message": "Add support for @MockBean\n\nThis allows users to easily combine Mockito with\nQuarkus mocks without having to use anything\nmore than the @MockBean annotation", "committedDate": "2020-04-02T10:28:25Z", "type": "forcePushed"}, {"oid": "6b92320db3c9a50cac32c3871099b4db63b8855b", "url": "https://github.com/quarkusio/quarkus/commit/6b92320db3c9a50cac32c3871099b4db63b8855b", "message": "Add support for @InjectMock\n\nThis allows users to easily combine Mockito with\nQuarkus mocks without having to use anything\nmore than the @InjectMock annotation", "committedDate": "2020-04-02T12:48:46Z", "type": "forcePushed"}, {"oid": "96db1d725d689f441bcf674741ae974a3cf2c90b", "url": "https://github.com/quarkusio/quarkus/commit/96db1d725d689f441bcf674741ae974a3cf2c90b", "message": "Add support for @InjectMock\n\nThis allows users to easily combine Mockito with\nQuarkus mocks without having to use anything\nmore than the @InjectMock annotation", "committedDate": "2020-04-02T13:15:08Z", "type": "commit"}, {"oid": "96db1d725d689f441bcf674741ae974a3cf2c90b", "url": "https://github.com/quarkusio/quarkus/commit/96db1d725d689f441bcf674741ae974a3cf2c90b", "message": "Add support for @InjectMock\n\nThis allows users to easily combine Mockito with\nQuarkus mocks without having to use anything\nmore than the @InjectMock annotation", "committedDate": "2020-04-02T13:15:08Z", "type": "forcePushed"}]}