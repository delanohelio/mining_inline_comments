{"pr_number": 8817, "pr_title": "implemented native SASL/JAAS support for plaintext authentication", "pr_createdAt": "2020-04-24T09:22:48Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8817", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MDExOQ==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414440119", "bodyText": "This list was about serde, LoginModule might go in another list (it's actually not build-in as it comes from javax.security.auth.spi.LoginModule)", "author": "cescoffier", "createdAt": "2020-04-24T09:41:03Z", "path": "extensions/kafka-client/deployment/src/main/java/io/quarkus/kafka/client/deployment/KafkaProcessor.java", "diffHunk": "@@ -68,6 +76,9 @@\n             ByteBufferDeserializer.class,\n             StringDeserializer.class,\n             FloatDeserializer.class,\n+\n+            //login modules\n+            LoginModule.class", "originalCommit": "f8b60e63553decad4ddf79fd85fb321f533f463e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4MTE2NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414481165", "bodyText": "Relocated native-SASL/JAAS code into separate build step.", "author": "schulzp", "createdAt": "2020-04-24T10:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MDExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MDU0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414440542", "bodyText": "I would add the LoginModule directly here.", "author": "cescoffier", "createdAt": "2020-04-24T09:41:39Z", "path": "extensions/kafka-client/deployment/src/main/java/io/quarkus/kafka/client/deployment/KafkaProcessor.java", "diffHunk": "@@ -109,6 +120,12 @@ public void build(CombinedIndexBuildItem indexBuildItem, BuildProducer<Reflectiv\n         // classes needed to perform reflection on DirectByteBuffer - only really needed for Java 8\n         reflectiveClass.produce(new ReflectiveClassBuildItem(true, false, \"java.nio.DirectByteBuffer\"));\n         reflectiveClass.produce(new ReflectiveClassBuildItem(true, false, \"sun.misc.Cleaner\"));\n+\n+        // enable native JAAS/SASL PLAIN support\n+        reflectiveClass", "originalCommit": "f8b60e63553decad4ddf79fd85fb321f533f463e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3NTUyMg==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414475522", "bodyText": "Actually, I need all the sub-classes, for example (but not limited to):\n\nPlainLoginModule (org.apache.kafka.common.security.plain)\n\nThe list of sub-classes also contains:\n\nExternalCertificateLoginModule (org.apache.activemq.artemis.spi.core.security.jaas)\nKrb5LoginModule (org.apache.activemq.artemis.spi.core.security.jaas)\nPropertiesLoginModule (org.apache.activemq.artemis.spi.core.security.jaas)\nDigestLoginModule (org.apache.zookeeper.server.auth)\nLDAPLoginModule (org.apache.activemq.artemis.spi.core.security.jaas)\nScramLoginModule (org.apache.kafka.common.security.scram)\nNTLoginModule (com.sun.security.auth.module)\nGuestLoginModule (org.apache.activemq.artemis.spi.core.security.jaas)\nInVMLoginModule (org.apache.activemq.artemis.spi.core.security.jaas)\nFileLoginModule (com.sun.jmx.remote.security)\nJndiLoginModule (com.sun.security.auth.module)\nAbstractKeycloakLoginModule (org.keycloak.adapters.jaas)\nLdapLoginModule (com.sun.security.auth.module)\nOAuthBearerLoginModule (org.apache.kafka.common.security.oauthbearer)\nUnixLoginModule (com.sun.security.auth.module)\nKrb5LoginModule (com.sun.security.auth.module)\nCertificateLoginModule (org.apache.activemq.artemis.spi.core.security.jaas)\nKeyStoreLoginModule (com.sun.security.auth.module)", "author": "schulzp", "createdAt": "2020-04-24T10:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MDU0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM0NDIyNg==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r415344226", "bodyText": "Relocated native-SASL/JAAS code into separate build step.", "author": "schulzp", "createdAt": "2020-04-26T16:11:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MDU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MTQyMw==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414441423", "bodyText": "How is this related to the issue? I may miss a link.", "author": "cescoffier", "createdAt": "2020-04-24T09:43:03Z", "path": "extensions/kafka-client/runtime/src/main/java/io/quarkus/kafka/client/health/KafkaHealthCheck.java", "diffHunk": "@@ -3,36 +3,39 @@\n import java.util.HashMap;\n import java.util.Map;\n \n-import javax.annotation.PostConstruct;\n import javax.annotation.PreDestroy;\n import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n \n import org.apache.kafka.clients.admin.AdminClient;\n import org.apache.kafka.clients.admin.AdminClientConfig;\n import org.apache.kafka.common.Node;\n-import org.eclipse.microprofile.config.inject.ConfigProperty;\n import org.eclipse.microprofile.health.HealthCheck;\n import org.eclipse.microprofile.health.HealthCheckResponse;\n import org.eclipse.microprofile.health.HealthCheckResponseBuilder;\n import org.eclipse.microprofile.health.Readiness;\n \n+import io.quarkus.kafka.client.runtime.KafkaRuntimeConfig;\n+\n @Readiness\n @ApplicationScoped\n public class KafkaHealthCheck implements HealthCheck {\n \n-    @ConfigProperty(name = \"kafka.bootstrap.servers\", defaultValue = \"localhost:9092\")\n-    private String bootstrapServers;\n-\n     private AdminClient client;\n \n-    @PostConstruct\n-    void init() {\n-        Map<String, Object> conf = new HashMap<>();\n-        conf.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);\n+    @Inject\n+    public KafkaHealthCheck(KafkaRuntimeConfig runtimeConfig) {\n+        Map<String, Object> conf = new HashMap<>(runtimeConfig.getProperties());", "originalCommit": "f8b60e63553decad4ddf79fd85fb321f533f463e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3MzUzNw==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414473537", "bodyText": "the previous @PostConstruct ran into NPEs for the @Injected KafkaRuntimeConfig. Using constructor injection it worked.", "author": "schulzp", "createdAt": "2020-04-24T10:35:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MTQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU3ODA0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r415578045", "bodyText": "Why not using the static access to the configuration? That would remove the bean.", "author": "cescoffier", "createdAt": "2020-04-27T07:33:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MTQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MjY1Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414442652", "bodyText": "If I understand correctly you copy the \"kafka\" configuration and configure the health check admin client with them.\nIs it really related to this PR?", "author": "cescoffier", "createdAt": "2020-04-24T09:44:56Z", "path": "extensions/kafka-client/runtime/src/main/java/io/quarkus/kafka/client/runtime/KafkaRuntimeConfigProducer.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package io.quarkus.kafka.client.runtime;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.stream.StreamSupport;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.context.Dependent;\n+import javax.enterprise.inject.Produces;\n+\n+import org.eclipse.microprofile.config.Config;\n+import org.eclipse.microprofile.config.ConfigProvider;\n+\n+import io.quarkus.arc.DefaultBean;\n+\n+@Dependent\n+public class KafkaRuntimeConfigProducer {\n+\n+    private String configPrefix = \"kafka\";", "originalCommit": "f8b60e63553decad4ddf79fd85fb321f533f463e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3NjQ3MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414476471", "bodyText": "I'd say so. The admin client needs the same security configuration as all consumers/producers. Otherwise authentication will fail once the broker is set up to expect it.", "author": "schulzp", "createdAt": "2020-04-24T10:40:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MjY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU3ODkxNA==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r415578914", "bodyText": "Yes and no. You have applications using multiple brokers, and some parts of Quarkus use a different configuration format.", "author": "cescoffier", "createdAt": "2020-04-27T07:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MjY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MzA5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414443091", "bodyText": "It can be confusing as the Kafka Client is not produced by default. Typically, it would not cover the configuration coming from reactive messaging. Existing applications create their properties directly (following the Kafka documentation).", "author": "cescoffier", "createdAt": "2020-04-24T09:45:40Z", "path": "extensions/kafka-client/runtime/src/main/java/io/quarkus/kafka/client/runtime/KafkaRuntimeConfigProducer.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package io.quarkus.kafka.client.runtime;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.stream.StreamSupport;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.context.Dependent;\n+import javax.enterprise.inject.Produces;\n+\n+import org.eclipse.microprofile.config.Config;\n+import org.eclipse.microprofile.config.ConfigProvider;\n+\n+import io.quarkus.arc.DefaultBean;\n+\n+@Dependent\n+public class KafkaRuntimeConfigProducer {\n+\n+    private String configPrefix = \"kafka\";\n+\n+    @Produces\n+    @DefaultBean\n+    @ApplicationScoped\n+    public KafkaRuntimeConfig createKafkaRuntimeConfig() {\n+        Map<String, String> properties = new HashMap<>();\n+        final Config config = ConfigProvider.getConfig();\n+\n+        StreamSupport\n+                .stream(config.getPropertyNames().spliterator(), false)\n+                .map(String::toLowerCase)\n+                .filter(name -> name.startsWith(configPrefix))", "originalCommit": "f8b60e63553decad4ddf79fd85fb321f533f463e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3ODA3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414478075", "bodyText": "Okay, in that case I could remove the KafkaRuntimeConfiguration again and would only have to make sure all the clients in integration-tests/kafa get the right set of properties. I just found it to be very cumbersome to inject them one by one, especially when extending the test case to more than plain authentication.", "author": "schulzp", "createdAt": "2020-04-24T10:43:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MzA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1MDM5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r414450391", "bodyText": "I believe we should be able to avoid this new bean.\nIt seems to be convenient for the tests, but the Kafka Test Resource can configure properties (that's the Map returned by the start method)", "author": "cescoffier", "createdAt": "2020-04-24T09:57:08Z", "path": "extensions/kafka-client/deployment/src/main/java/io/quarkus/kafka/client/deployment/KafkaProcessor.java", "diffHunk": "@@ -130,4 +147,13 @@ HealthBuildItem addHealthCheck(KafkaBuildTimeConfig buildTimeConfig) {\n         return new HealthBuildItem(\"io.quarkus.kafka.client.health.KafkaHealthCheck\",\n                 buildTimeConfig.healthEnabled, \"kafka\");\n     }\n+\n+    @BuildStep\n+    AdditionalBeanBuildItem addRuntimeConfig() {\n+        final Builder builder = AdditionalBeanBuildItem.builder()", "originalCommit": "f8b60e63553decad4ddf79fd85fb321f533f463e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU3NzY1OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8817#discussion_r415577659", "bodyText": "If we go with this, we would need to adapt the Reactive Messaging Kafka connector to use the same config. This would be a breaking change.", "author": "cescoffier", "createdAt": "2020-04-27T07:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1MDM5MQ=="}], "type": "inlineReview"}, {"oid": "67be4eb132faa16aded9141e1e16bec313dbdd38", "url": "https://github.com/quarkusio/quarkus/commit/67be4eb132faa16aded9141e1e16bec313dbdd38", "message": "#8817 - regarding comments on `KafkaProcessor.java`", "committedDate": "2020-04-26T15:51:16Z", "type": "forcePushed"}, {"oid": "aed66d2c6c57414355068d3d9dcbad6b3dfaa415", "url": "https://github.com/quarkusio/quarkus/commit/aed66d2c6c57414355068d3d9dcbad6b3dfaa415", "message": "#8817 - add native SASL support\n\n* add (native) SASL test\n* runtime configuration as map", "committedDate": "2020-04-28T14:36:54Z", "type": "forcePushed"}, {"oid": "614ba1aae04b2e57567a71e6bc635e050b4ea8de", "url": "https://github.com/quarkusio/quarkus/commit/614ba1aae04b2e57567a71e6bc635e050b4ea8de", "message": "#8817 - runtime configuration as map", "committedDate": "2020-04-30T19:16:41Z", "type": "forcePushed"}, {"oid": "f3dbdcc09cb76db62ccd088207246dc4791bd662", "url": "https://github.com/quarkusio/quarkus/commit/f3dbdcc09cb76db62ccd088207246dc4791bd662", "message": "#8817 - change names for clarity (SSL != SASL)", "committedDate": "2020-05-04T09:47:20Z", "type": "commit"}, {"oid": "ed26e490eb11c2967cf7fa568e6891d6e59933f0", "url": "https://github.com/quarkusio/quarkus/commit/ed26e490eb11c2967cf7fa568e6891d6e59933f0", "message": "#8817 - runtime configuration as map", "committedDate": "2020-05-04T09:47:20Z", "type": "commit"}, {"oid": "ed26e490eb11c2967cf7fa568e6891d6e59933f0", "url": "https://github.com/quarkusio/quarkus/commit/ed26e490eb11c2967cf7fa568e6891d6e59933f0", "message": "#8817 - runtime configuration as map", "committedDate": "2020-05-04T09:47:20Z", "type": "forcePushed"}]}