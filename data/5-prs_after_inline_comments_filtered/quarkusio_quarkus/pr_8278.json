{"pr_number": 8278, "pr_title": "Support OIDC client_secret_jwt", "pr_createdAt": "2020-03-30T17:07:34Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8278", "timeline": [{"oid": "fad88fbe48e6f42d9f422f52032652f1ec763e61", "url": "https://github.com/quarkusio/quarkus/commit/fad88fbe48e6f42d9f422f52032652f1ec763e61", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-03-30T17:16:43Z", "type": "forcePushed"}, {"oid": "939ef336768fd90d1807cacfd9b7037e1cc5a83a", "url": "https://github.com/quarkusio/quarkus/commit/939ef336768fd90d1807cacfd9b7037e1cc5a83a", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-03-31T15:20:20Z", "type": "forcePushed"}, {"oid": "4fb60e88556a3f72a5d39000071a9550666cb2c6", "url": "https://github.com/quarkusio/quarkus/commit/4fb60e88556a3f72a5d39000071a9550666cb2c6", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-06T13:46:00Z", "type": "forcePushed"}, {"oid": "3369f8f29ed7e1faefde67d25d17f2c9caf68fd7", "url": "https://github.com/quarkusio/quarkus/commit/3369f8f29ed7e1faefde67d25d17f2c9caf68fd7", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-06T14:14:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMTI0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r404311242", "bodyText": "I'm wondering if we can't just create the signed JWT at build time? But I guess that would not work for dynamic configurations?", "author": "pedroigor", "createdAt": "2020-04-06T18:46:20Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -194,9 +199,11 @@ private static QuarkusSecurityIdentity augmentIdentity(SecurityIdentity security\n \n         // Client secret has to be posted as a form parameter if OIDC requires the client_secret_post authentication\n         Credentials creds = configContext.oidcConfig.getCredentials();\n-        if (creds.clientSecret.value.isPresent() && creds.clientSecret.method.isPresent()\n-                && Secret.Method.POST == creds.clientSecret.method.get()) {\n+        if (creds.clientSecret.value.isPresent() && Secret.Method.POST == creds.clientSecret.method.orElse(null)) {\n             params.put(\"client_secret\", creds.clientSecret.value.get());\n+        } else if (creds.jwt.secret.isPresent()) {\n+            params.put(\"client_assertion_type\", \"urn:ietf:params:oauth:client-assertion-type:jwt-bearer\");\n+            params.put(\"client_assertion\", signJwtWithClientSecret(configContext.oidcConfig));", "originalCommit": "3369f8f29ed7e1faefde67d25d17f2c9caf68fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5Nzk3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r404397977", "bodyText": "@pedroigor Good idea, I can calculate it in OidcRecorder and save it in TenantConfigContext, if the secret is updated in the dev mode then it will be recalculated", "author": "sberyozkin", "createdAt": "2020-04-06T21:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMTI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMjY3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r404312673", "bodyText": "Maybe it should be createdTenantContextFromPublicKey instead ?", "author": "pedroigor", "createdAt": "2020-04-06T18:48:43Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcRecorder.java", "diffHunk": "@@ -195,6 +190,20 @@ public void handle(AsyncResult<OAuth2Auth> event) {\n         return new TenantConfigContext(auth, oidcConfig);\n     }\n \n+    @SuppressWarnings(\"deprecation\")\n+    private TenantConfigContext createdTenantContextFromPrivateKey(OAuth2ClientOptions options, OidcTenantConfig oidcConfig) {", "originalCommit": "3369f8f29ed7e1faefde67d25d17f2c9caf68fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NjY2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r404396663", "bodyText": "@pedroigor ouch :-), will fix", "author": "sberyozkin", "createdAt": "2020-04-06T21:22:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMjY3Mw=="}], "type": "inlineReview"}, {"oid": "16a3166d4252d8ad3f1581bb100a9a9776401b1e", "url": "https://github.com/quarkusio/quarkus/commit/16a3166d4252d8ad3f1581bb100a9a9776401b1e", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-07T10:07:03Z", "type": "forcePushed"}, {"oid": "a98ae3dcccaf33401dbdd1ce1d7f82a032012d8a", "url": "https://github.com/quarkusio/quarkus/commit/a98ae3dcccaf33401dbdd1ce1d7f82a032012d8a", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-07T16:50:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2MzQ2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r404963462", "bodyText": "oops, that is too much :-)", "author": "sberyozkin", "createdAt": "2020-04-07T16:53:51Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -222,6 +229,25 @@ private static QuarkusSecurityIdentity augmentIdentity(SecurityIdentity security\n         return cf;\n     }\n \n+    private String signJwtWithClientSecret(OidcTenantConfig cfg) {\n+        final byte[] keyBytes = cfg.credentials.jwt.secret.get().getBytes(StandardCharsets.UTF_8);\n+        SecretKey key = new SecretKeySpec(keyBytes, 0, keyBytes.length, \"HMACSHA256\");\n+\n+        // 'jti' claim is created by default.\n+        // 'exp' may be configured if it will be necessary.\n+        final long iat = (System.currentTimeMillis() / 1000);\n+        // 10 seconds\n+        final long exp = iat + 10 * 1000;", "originalCommit": "a98ae3dcccaf33401dbdd1ce1d7f82a032012d8a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c30c0b60fa1c7280da6deae8483ca0d902a2cff5", "url": "https://github.com/quarkusio/quarkus/commit/c30c0b60fa1c7280da6deae8483ca0d902a2cff5", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-07T16:55:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE0MjI1NA==", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r406142254", "bodyText": "This should really be at debug, in general we try not to pollute the log on startup, especially not messages that just inform the user of what they have done.", "author": "stuartwdouglas", "createdAt": "2020-04-09T11:36:03Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcRecorder.java", "diffHunk": "@@ -195,6 +189,20 @@ public void handle(AsyncResult<OAuth2Auth> event) {\n         return new TenantConfigContext(auth, oidcConfig);\n     }\n \n+    @SuppressWarnings(\"deprecation\")\n+    private TenantConfigContext createdTenantContextFromPublicKey(OAuth2ClientOptions options, OidcTenantConfig oidcConfig) {\n+        if (oidcConfig.applicationType == ApplicationType.WEB_APP) {\n+            throw new ConfigurationException(\"'public-key' property can only be used with the 'service' applications\");\n+        }\n+        LOG.info(\"'public-key' property for the local token verification is set,\"", "originalCommit": "c30c0b60fa1c7280da6deae8483ca0d902a2cff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE2NDUyMA==", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r406164520", "bodyText": "@stuartwdouglas Sure, I'm now trying to always set debug but sometimes info gets in :-)", "author": "sberyozkin", "createdAt": "2020-04-09T12:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE0MjI1NA=="}], "type": "inlineReview"}, {"oid": "3b6f2db21dd38b2a5520517cb5c4890914c7c510", "url": "https://github.com/quarkusio/quarkus/commit/3b6f2db21dd38b2a5520517cb5c4890914c7c510", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-09T13:19:40Z", "type": "forcePushed"}, {"oid": "32bb0702b19b7b4604566483a0d904bf07f01ca1", "url": "https://github.com/quarkusio/quarkus/commit/32bb0702b19b7b4604566483a0d904bf07f01ca1", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-09T13:39:25Z", "type": "forcePushed"}, {"oid": "564c1e03a9fa4289955b97a22898e6bde3fa4ada", "url": "https://github.com/quarkusio/quarkus/commit/564c1e03a9fa4289955b97a22898e6bde3fa4ada", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-09T16:14:36Z", "type": "forcePushed"}, {"oid": "273f6ed16243f54b0595e7672e0a65d0b3417463", "url": "https://github.com/quarkusio/quarkus/commit/273f6ed16243f54b0595e7672e0a65d0b3417463", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-09T22:01:46Z", "type": "forcePushed"}, {"oid": "d73541eca61ab7fe3ce7168c8bc4b748f6fcb39a", "url": "https://github.com/quarkusio/quarkus/commit/d73541eca61ab7fe3ce7168c8bc4b748f6fcb39a", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-10T16:28:44Z", "type": "forcePushed"}, {"oid": "0aab27a8ce5184ebb5569b942d06477d22831880", "url": "https://github.com/quarkusio/quarkus/commit/0aab27a8ce5184ebb5569b942d06477d22831880", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-10T16:39:09Z", "type": "commit"}, {"oid": "0aab27a8ce5184ebb5569b942d06477d22831880", "url": "https://github.com/quarkusio/quarkus/commit/0aab27a8ce5184ebb5569b942d06477d22831880", "message": "Support OIDC client_secret_jwt", "committedDate": "2020-04-10T16:39:09Z", "type": "forcePushed"}]}