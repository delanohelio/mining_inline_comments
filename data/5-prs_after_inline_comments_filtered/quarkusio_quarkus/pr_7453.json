{"pr_number": 7453, "pr_title": "Rework datasource configuration", "pr_createdAt": "2020-02-27T10:58:04Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7453", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1NjcyNg==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385056726", "bodyText": "What's the rationale behind this? Not that it's particularly important :)", "author": "geoand", "createdAt": "2020-02-27T11:02:11Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java", "diffHunk": "@@ -221,8 +221,8 @@ public NativeImageBuildItem build(NativeConfig nativeConfig, NativeImageSourceJa\n                 nativeConfig.enableAllSecurityServices = true;\n             }\n \n-            nativeConfig.additionalBuildArgs.ifPresent(l -> l.stream().map(String::trim).forEach(command::add));\n             command.add(\"--initialize-at-build-time=\");\n+            nativeConfig.additionalBuildArgs.ifPresent(l -> l.stream().map(String::trim).forEach(command::add));", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwMTg3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385101876", "bodyText": "Ah sorry, it shouldn't have been there. I removed it.", "author": "gsmet", "createdAt": "2020-02-27T12:42:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1NjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwMzM2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385103366", "bodyText": "Thanks", "author": "geoand", "createdAt": "2020-02-27T12:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1NjcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1ODIzNA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385058234", "bodyText": "I assume this is one has been blessed by @dmlloyd ?", "author": "geoand", "createdAt": "2020-02-27T11:05:26Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/configuration/matching/FieldContainer.java", "diffHunk": "@@ -41,6 +41,7 @@ StringBuilder getCombinedName(final StringBuilder sb) {\n         if (sb.length() > 0) {\n             sb.append(':');\n         }\n+        sb.append(member.getField().getDeclaringClass().getSimpleName()).append('#');", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3NzIwNw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385077207", "bodyText": "Nevermind, I just saw the author of the commit that added this :)", "author": "geoand", "createdAt": "2020-02-27T11:47:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1ODIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MDk5NA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385060994", "bodyText": "Maybe add the initial capacity?", "author": "geoand", "createdAt": "2020-02-27T11:11:26Z", "path": "extensions/datasource/common/src/main/java/io/quarkus/datasource/common/runtime/DatabaseKind.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package io.quarkus.datasource.common.runtime;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * We don't use an enum as we also need to support non built-in database kinds.\n+ */\n+public final class DatabaseKind {\n+\n+    public static final String DERBY = \"derby\";\n+    public static final String H2 = \"h2\";\n+    public static final String MARIADB = \"mariadb\";\n+    public static final String MSSQL = \"mssql\";\n+    public static final String MYSQL = \"mysql\";\n+    public static final String POSTGRESQL = \"postgresql\";\n+\n+    private static final Map<String, String> ALIASES;\n+\n+    static {\n+        Map<String, String> aliases = new HashMap<String, String>();", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MjM5MA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385062390", "bodyText": "Also, you can just use the <> operator to avoid the extra generic type definition", "author": "geoand", "createdAt": "2020-02-27T11:14:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MDk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwMjcyOQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385102729", "bodyText": "It's not easy to have the size of the map given you can have several aliases. Better leave it as that.\nGranted for the diamond operator.", "author": "gsmet", "createdAt": "2020-02-27T12:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MDk5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MTEzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385061135", "bodyText": "This can be private I think", "author": "geoand", "createdAt": "2020-02-27T11:11:38Z", "path": "extensions/datasource/common/src/main/java/io/quarkus/datasource/common/runtime/DatabaseKind.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package io.quarkus.datasource.common.runtime;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * We don't use an enum as we also need to support non built-in database kinds.\n+ */\n+public final class DatabaseKind {\n+\n+    public static final String DERBY = \"derby\";\n+    public static final String H2 = \"h2\";\n+    public static final String MARIADB = \"mariadb\";\n+    public static final String MSSQL = \"mssql\";\n+    public static final String MYSQL = \"mysql\";\n+    public static final String POSTGRESQL = \"postgresql\";\n+\n+    private static final Map<String, String> ALIASES;\n+\n+    static {\n+        Map<String, String> aliases = new HashMap<String, String>();\n+        for (SupportedDatabaseKind kind : SupportedDatabaseKind.values()) {\n+            for (String alias : kind.aliases) {\n+                aliases.put(alias.toLowerCase(Locale.ROOT), kind.mainName.toLowerCase(Locale.ROOT));\n+            }\n+        }\n+        ALIASES = Collections.unmodifiableMap(aliases);\n+    }\n+\n+    public static String normalize(String value) {\n+        if (value == null) {\n+            return null;\n+        }\n+\n+        String lowerCaseValue = value.toLowerCase(Locale.ROOT).trim();\n+\n+        if (lowerCaseValue.isEmpty()) {\n+            return null;\n+        }\n+\n+        String supportedValue = ALIASES.get(lowerCaseValue);\n+        if (supportedValue != null) {\n+            return supportedValue;\n+        }\n+        return lowerCaseValue;\n+    }\n+\n+    public static boolean isDerby(String value) {\n+        return is(value, DERBY);\n+    }\n+\n+    public static boolean isH2(String value) {\n+        return is(value, H2);\n+    }\n+\n+    public static boolean isMariaDB(String value) {\n+        return is(value, MARIADB);\n+    }\n+\n+    public static boolean isMsSQL(String value) {\n+        return is(value, MSSQL);\n+    }\n+\n+    public static boolean isMySQL(String value) {\n+        return is(value, MYSQL);\n+    }\n+\n+    public static boolean isPostgreSQL(String value) {\n+        return is(value, POSTGRESQL);\n+    }\n+\n+    private static boolean is(String value, String mainName) {\n+        if (value == null) {\n+            return false;\n+        }\n+\n+        String normalizedValue = normalize(value);\n+\n+        return mainName.equals(normalizedValue);\n+    }\n+\n+    private DatabaseKind() {\n+    }\n+\n+    enum SupportedDatabaseKind {", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwMjc3OA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385102778", "bodyText": "Sure.", "author": "gsmet", "createdAt": "2020-02-27T12:44:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MTEzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MjAxMA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385062010", "bodyText": "This doesn't seem to be used", "author": "geoand", "createdAt": "2020-02-27T11:13:25Z", "path": "extensions/datasource/common/src/main/java/io/quarkus/datasource/common/runtime/DatabaseKind.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package io.quarkus.datasource.common.runtime;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * We don't use an enum as we also need to support non built-in database kinds.\n+ */\n+public final class DatabaseKind {\n+\n+    public static final String DERBY = \"derby\";\n+    public static final String H2 = \"h2\";\n+    public static final String MARIADB = \"mariadb\";\n+    public static final String MSSQL = \"mssql\";\n+    public static final String MYSQL = \"mysql\";\n+    public static final String POSTGRESQL = \"postgresql\";\n+\n+    private static final Map<String, String> ALIASES;\n+\n+    static {\n+        Map<String, String> aliases = new HashMap<String, String>();\n+        for (SupportedDatabaseKind kind : SupportedDatabaseKind.values()) {\n+            for (String alias : kind.aliases) {\n+                aliases.put(alias.toLowerCase(Locale.ROOT), kind.mainName.toLowerCase(Locale.ROOT));\n+            }\n+        }\n+        ALIASES = Collections.unmodifiableMap(aliases);\n+    }\n+\n+    public static String normalize(String value) {\n+        if (value == null) {\n+            return null;\n+        }\n+\n+        String lowerCaseValue = value.toLowerCase(Locale.ROOT).trim();\n+\n+        if (lowerCaseValue.isEmpty()) {\n+            return null;\n+        }\n+\n+        String supportedValue = ALIASES.get(lowerCaseValue);\n+        if (supportedValue != null) {\n+            return supportedValue;\n+        }\n+        return lowerCaseValue;\n+    }\n+\n+    public static boolean isDerby(String value) {\n+        return is(value, DERBY);\n+    }\n+\n+    public static boolean isH2(String value) {\n+        return is(value, H2);\n+    }\n+\n+    public static boolean isMariaDB(String value) {\n+        return is(value, MARIADB);\n+    }\n+\n+    public static boolean isMsSQL(String value) {\n+        return is(value, MSSQL);\n+    }\n+\n+    public static boolean isMySQL(String value) {\n+        return is(value, MYSQL);\n+    }\n+\n+    public static boolean isPostgreSQL(String value) {\n+        return is(value, POSTGRESQL);\n+    }\n+\n+    private static boolean is(String value, String mainName) {\n+        if (value == null) {\n+            return false;\n+        }\n+\n+        String normalizedValue = normalize(value);\n+\n+        return mainName.equals(normalizedValue);\n+    }\n+\n+    private DatabaseKind() {\n+    }\n+\n+    enum SupportedDatabaseKind {\n+        DERBY(DatabaseKind.DERBY),\n+        H2(DatabaseKind.H2),\n+        MARIADB(DatabaseKind.MARIADB),\n+        MSSQL(DatabaseKind.MSSQL),\n+        MYSQL(DatabaseKind.MYSQL),\n+        POSTGRESQL(DatabaseKind.POSTGRESQL, \"pgsql\", \"pg\");\n+\n+        final String mainName;\n+        final Set<String> aliases;\n+        static final Map<String, String> ALIASES = new HashMap<String, String>();", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwMjgyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385102825", "bodyText": "Removed.", "author": "gsmet", "createdAt": "2020-02-27T12:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MjAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MzM5MA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385063390", "bodyText": "Can we add the capacity here?", "author": "geoand", "createdAt": "2020-02-27T11:16:14Z", "path": "extensions/datasource/common/src/main/java/io/quarkus/datasource/common/runtime/DatabaseKind.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package io.quarkus.datasource.common.runtime;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * We don't use an enum as we also need to support non built-in database kinds.\n+ */\n+public final class DatabaseKind {\n+\n+    public static final String DERBY = \"derby\";\n+    public static final String H2 = \"h2\";\n+    public static final String MARIADB = \"mariadb\";\n+    public static final String MSSQL = \"mssql\";\n+    public static final String MYSQL = \"mysql\";\n+    public static final String POSTGRESQL = \"postgresql\";\n+\n+    private static final Map<String, String> ALIASES;\n+\n+    static {\n+        Map<String, String> aliases = new HashMap<String, String>();\n+        for (SupportedDatabaseKind kind : SupportedDatabaseKind.values()) {\n+            for (String alias : kind.aliases) {\n+                aliases.put(alias.toLowerCase(Locale.ROOT), kind.mainName.toLowerCase(Locale.ROOT));\n+            }\n+        }\n+        ALIASES = Collections.unmodifiableMap(aliases);\n+    }\n+\n+    public static String normalize(String value) {\n+        if (value == null) {\n+            return null;\n+        }\n+\n+        String lowerCaseValue = value.toLowerCase(Locale.ROOT).trim();\n+\n+        if (lowerCaseValue.isEmpty()) {\n+            return null;\n+        }\n+\n+        String supportedValue = ALIASES.get(lowerCaseValue);\n+        if (supportedValue != null) {\n+            return supportedValue;\n+        }\n+        return lowerCaseValue;\n+    }\n+\n+    public static boolean isDerby(String value) {\n+        return is(value, DERBY);\n+    }\n+\n+    public static boolean isH2(String value) {\n+        return is(value, H2);\n+    }\n+\n+    public static boolean isMariaDB(String value) {\n+        return is(value, MARIADB);\n+    }\n+\n+    public static boolean isMsSQL(String value) {\n+        return is(value, MSSQL);\n+    }\n+\n+    public static boolean isMySQL(String value) {\n+        return is(value, MYSQL);\n+    }\n+\n+    public static boolean isPostgreSQL(String value) {\n+        return is(value, POSTGRESQL);\n+    }\n+\n+    private static boolean is(String value, String mainName) {\n+        if (value == null) {\n+            return false;\n+        }\n+\n+        String normalizedValue = normalize(value);\n+\n+        return mainName.equals(normalizedValue);\n+    }\n+\n+    private DatabaseKind() {\n+    }\n+\n+    enum SupportedDatabaseKind {\n+        DERBY(DatabaseKind.DERBY),\n+        H2(DatabaseKind.H2),\n+        MARIADB(DatabaseKind.MARIADB),\n+        MSSQL(DatabaseKind.MSSQL),\n+        MYSQL(DatabaseKind.MYSQL),\n+        POSTGRESQL(DatabaseKind.POSTGRESQL, \"pgsql\", \"pg\");\n+\n+        final String mainName;\n+        final Set<String> aliases;\n+        static final Map<String, String> ALIASES = new HashMap<String, String>();\n+\n+        SupportedDatabaseKind(String mainName) {\n+            this.mainName = mainName;\n+            this.aliases = Collections.singleton(mainName);\n+        }\n+\n+        SupportedDatabaseKind(String mainName, String... aliases) {\n+            this.mainName = mainName;\n+            this.aliases = new HashSet<>();", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwMzQ0MA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385103440", "bodyText": "Computing capacity for something hash based requires some computation. It will make the code less readable and it's really not worth it given it's not a hot path.", "author": "gsmet", "createdAt": "2020-02-27T12:45:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MzM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNTc0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385105745", "bodyText": "Sure, not a big deal", "author": "geoand", "createdAt": "2020-02-27T12:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MzM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MzcyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385063725", "bodyText": "Is this leftover or something?", "author": "geoand", "createdAt": "2020-02-27T11:16:57Z", "path": "extensions/datasource/deployment/src/main/java/io/quarkus/datasource/deployment/DataSourceProcessor.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package io.quarkus.datasource.deployment;\n+\n+public class DataSourceProcessor {", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwMzY3MA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385103670", "bodyText": "No. IIRC, the javadoc plugin complains when releasing when an artifact is entirely empty.", "author": "gsmet", "createdAt": "2020-02-27T12:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MzcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNjI5Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385106296", "bodyText": "Can we then call it something other than DataSourceProcessor? It just seems a little missleading to someone who reads it for the first time.\nOtherwise a tiny bit of Javadoc would be nice", "author": "geoand", "createdAt": "2020-02-27T12:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MzcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2NTEzMw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385065133", "bodyText": "I don't think we need to set the value. We don't do it in any of the other configurations", "author": "geoand", "createdAt": "2020-02-27T11:20:15Z", "path": "extensions/datasource/runtime/src/main/java/io/quarkus/datasource/runtime/DataSourceRuntimeConfig.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package io.quarkus.datasource.runtime;\n+\n+import java.util.Optional;\n+\n+import io.quarkus.runtime.annotations.ConfigGroup;\n+import io.quarkus.runtime.annotations.ConfigItem;\n+\n+@ConfigGroup\n+public class DataSourceRuntimeConfig {\n+\n+    /**\n+     * The datasource username\n+     */\n+    @ConfigItem\n+    public Optional<String> username = Optional.empty();\n+\n+    /**\n+     * The datasource password\n+     */\n+    @ConfigItem\n+    public Optional<String> password = Optional.empty();\n+\n+    /**\n+     * The credentials provider name\n+     */\n+    @ConfigItem\n+    public Optional<String> credentialsProvider = Optional.empty();\n+\n+    /**\n+     * The credentials provider type.\n+     * <p>\n+     * It is the {@code &#64;Named} value of the credentials provider bean. It is used to discriminate if multiple\n+     * CredentialsProvider beans are available.\n+     * <p>\n+     * For Vault it is: vault-credentials-provider. Not necessary if there is only one credentials provider available.\n+     */\n+    @ConfigItem\n+    public Optional<String> credentialsProviderType = Optional.empty();", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNDI3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385104277", "bodyText": "We do. Because I also initialize them via constructor. You cannot trigger the initialization of another map given you have a value present in a map. And when I have some build time config in the map, I need a valid runtime config in the other map so I need to initialize it myself. Talked to David about that a while ago but it's not trivial.\nWe used this pattern for Flyway IIRC.", "author": "gsmet", "createdAt": "2020-02-27T12:47:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2NTEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNjU0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385106542", "bodyText": "Understood, thanks", "author": "geoand", "createdAt": "2020-02-27T12:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2NTEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2NjM2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385066362", "bodyText": "I think we should at least warn users if more than one is configured", "author": "geoand", "createdAt": "2020-02-27T11:22:58Z", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -204,11 +205,16 @@ public void build(RecorderContext recorderContext, HibernateOrmRecorder recorder\n             return;\n         }\n \n+        // we only support the default datasource for now", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNDY3OQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385104679", "bodyText": "Why? They can be used for other purposes. And this patch doesn't change that, it just changes how the default is propagated.", "author": "gsmet", "createdAt": "2020-02-27T12:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2NjM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNzE4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385107187", "bodyText": "I am just saying that a user has no way of knowing this and as someone who looked at it for the first time, it seems suprising to make such a assumption without any warning or anything.\nYou know this part way better than almost anyone, so I'll leave it to you to decide", "author": "geoand", "createdAt": "2020-02-27T12:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2NjM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExMDM1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385110351", "bodyText": "It has been like that since forever so let's not discuss this here. We have an issue for multiple PU support and a lot of people complaining there so I think users are aware of that :).", "author": "gsmet", "createdAt": "2020-02-27T13:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2NjM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExMDk5MA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385110990", "bodyText": "Fine by my, since I'm not the one that will be listening to those users complain :P", "author": "geoand", "createdAt": "2020-02-27T13:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2NjM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2NzEyNw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385067127", "bodyText": "Let's have some minimal Javadoc for this one - it seems like a pretty useful Build Item :)", "author": "geoand", "createdAt": "2020-02-27T11:24:35Z", "path": "extensions/agroal/spi/src/main/java/io/quarkus/agroal/deployment/JdbcDriverBuildItem.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package io.quarkus.agroal.deployment;\n+\n+import java.util.Optional;\n+\n+import io.quarkus.builder.item.MultiBuildItem;\n+\n+public final class JdbcDriverBuildItem extends MultiBuildItem {", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNjMyMQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385106321", "bodyText": "Done.", "author": "gsmet", "createdAt": "2020-02-27T12:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2NzEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2ODQ4MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385068481", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static class JdbcDriverLiteral extends AnnotationLiteral<io.quarkus.agroal.JdbcDriver>\n          \n          \n            \n                class JdbcDriverLiteral extends AnnotationLiteral<io.quarkus.agroal.JdbcDriver>", "author": "geoand", "createdAt": "2020-02-27T11:27:47Z", "path": "extensions/agroal/runtime/src/main/java/io/quarkus/agroal/JdbcDriver.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package io.quarkus.agroal;\n+\n+import static java.lang.annotation.ElementType.FIELD;\n+import static java.lang.annotation.ElementType.METHOD;\n+import static java.lang.annotation.ElementType.PARAMETER;\n+import static java.lang.annotation.ElementType.TYPE;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+import java.lang.annotation.Documented;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import javax.enterprise.util.AnnotationLiteral;\n+import javax.inject.Qualifier;\n+\n+/**\n+ * Defines which database the JDBC driver is compatible with.\n+ */\n+@Target({ METHOD, FIELD, PARAMETER, TYPE })\n+@Retention(RUNTIME)\n+@Documented\n+@Qualifier\n+public @interface JdbcDriver {\n+\n+    String name();\n+\n+    public static class JdbcDriverLiteral extends AnnotationLiteral<io.quarkus.agroal.JdbcDriver>", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNzQ1OA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385107458", "bodyText": "Done.", "author": "gsmet", "createdAt": "2020-02-27T12:54:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2ODQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2ODc5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385068799", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static final Logger log = Logger.getLogger(AgroalConnectionConfigurer.class.getName());\n          \n          \n            \n                Logger log = Logger.getLogger(AgroalConnectionConfigurer.class.getName());", "author": "geoand", "createdAt": "2020-02-27T11:28:32Z", "path": "extensions/agroal/runtime/src/main/java/io/quarkus/agroal/runtime/AgroalConnectionConfigurer.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package io.quarkus.agroal.runtime;\n+\n+import org.jboss.logging.Logger;\n+\n+import io.agroal.api.configuration.supplier.AgroalDataSourceConfigurationSupplier;\n+\n+public interface AgroalConnectionConfigurer {\n+\n+    static final Logger log = Logger.getLogger(AgroalConnectionConfigurer.class.getName());", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNzU5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385107592", "bodyText": "Done.", "author": "gsmet", "createdAt": "2020-02-27T12:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2ODc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2OTU2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385069561", "bodyText": "It seems like this hasn't been preceded by a isPresent anywhere.", "author": "geoand", "createdAt": "2020-02-27T11:30:12Z", "path": "extensions/agroal/runtime/src/main/java/io/quarkus/agroal/runtime/AbstractDataSourceProducer.java", "diffHunk": "@@ -47,61 +55,52 @@\n     @Inject\n     public TransactionSynchronizationRegistry transactionSynchronizationRegistry;\n \n-    public DataSourceBuildTimeConfig getDefaultBuildTimeConfig() {\n-        return buildTimeConfig.defaultDataSource;\n-    }\n-\n-    public Optional<DataSourceRuntimeConfig> getDefaultRuntimeConfig() {\n-        checkRuntimeConfig();\n-\n-        return Optional.of(runtimeConfig.defaultDataSource);\n-    }\n-\n-    public DataSourceBuildTimeConfig getBuildTimeConfig(String dataSourceName) {\n-        return buildTimeConfig.namedDataSources.get(dataSourceName);\n-    }\n-\n-    public Optional<DataSourceRuntimeConfig> getRuntimeConfig(String dataSourceName) {\n-        checkRuntimeConfig();\n-\n-        return Optional.ofNullable(runtimeConfig.namedDataSources.get(dataSourceName));\n+    public void configureDataSources(DataSourcesBuildTimeConfig dataSourcesBuildTimeConfig,\n+            DataSourcesJdbcBuildTimeConfig dataSourcesJdbcBuildTimeConfig,\n+            DataSourcesRuntimeConfig dataSourcesRuntimeConfig,\n+            DataSourcesJdbcRuntimeConfig dataSourcesJdbcRuntimeConfig,\n+            boolean disableSslSupport) {\n+        this.dataSourcesBuildTimeConfig = dataSourcesBuildTimeConfig;\n+        this.dataSourcesJdbcBuildTimeConfig = dataSourcesJdbcBuildTimeConfig;\n+        this.dataSourcesRuntimeConfig = dataSourcesRuntimeConfig;\n+        this.dataSourcesJdbcRuntimeConfig = dataSourcesJdbcRuntimeConfig;\n+        this.disableSslSupport = disableSslSupport;\n     }\n \n     public AgroalDataSource createDataSource(String dataSourceName,\n             DataSourceBuildTimeConfig dataSourceBuildTimeConfig,\n-            Optional<DataSourceRuntimeConfig> dataSourceRuntimeConfigOptional,\n+            DataSourceJdbcBuildTimeConfig dataSourceJdbcBuildTimeConfig,\n+            DataSourceRuntimeConfig dataSourceRuntimeConfig,\n+            DataSourceJdbcRuntimeConfig dataSourceJdbcRuntimeConfig,\n+            String resolvedDriveClass,\n             boolean mpMetricsPresent) {\n-        if (!dataSourceRuntimeConfigOptional.isPresent() || !dataSourceRuntimeConfigOptional.get().url.isPresent()) {\n-            log.warn(\"Datasource \" + dataSourceName + \" not started: driver and/or url are not defined.\");\n+        checkConfigInjection();\n+\n+        if (!dataSourceJdbcBuildTimeConfig.enabled) {\n+            return null;\n+        }\n+\n+        if (!dataSourceJdbcRuntimeConfig.url.isPresent()) {\n+            log.warn(\"JDBC datasource \" + dataSourceName + \" not started: driver and/or url are not defined.\");\n             return null;\n         }\n+\n         // we first make sure that all available JDBC drivers are loaded in the current TCCL\n         loadDriversInTCCL();\n \n-        DataSourceRuntimeConfig dataSourceRuntimeConfig = dataSourceRuntimeConfigOptional.get();\n-\n-        String driverName = dataSourceBuildTimeConfig.driver.get();\n         Class<?> driver;\n         try {\n-            driver = Class.forName(driverName, true, Thread.currentThread().getContextClassLoader());\n+            driver = Class.forName(resolvedDriveClass, true, Thread.currentThread().getContextClassLoader());\n         } catch (ClassNotFoundException e) {\n-            throw new RuntimeException(\"Unable to load the dataSource driver\", e);\n+            throw new RuntimeException(\n+                    \"Unable to load the datasource driver \" + resolvedDriveClass + \" for datasource \" + dataSourceName, e);\n         }\n \n-        String url = dataSourceRuntimeConfig.url.get();\n+        InstanceHandle<AgroalConnectionConfigurer> agroalConnectionConfigurerHandle = Arc.container().instance(\n+                AgroalConnectionConfigurer.class,\n+                new JdbcDriverLiteral(dataSourceBuildTimeConfig.kind.get()));", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNzg4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385107883", "bodyText": "No, if I'm there, I'm sure it has been defined.", "author": "gsmet", "createdAt": "2020-02-27T12:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2OTU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwODY0MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385108641", "bodyText": "OK", "author": "geoand", "createdAt": "2020-02-27T12:56:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2OTU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MTEwNg==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385071106", "bodyText": "Is this empty class needed for anything?", "author": "geoand", "createdAt": "2020-02-27T11:33:48Z", "path": "extensions/reactive-datasource/deployment/src/main/java/io/quarkus/reactive/datasource/deployment/ReactiveDataSourceProcessor.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package io.quarkus.reactive.datasource.deployment;\n+\n+public class ReactiveDataSourceProcessor {", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNzk1MA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385107950", "bodyText": "See previous comment.", "author": "gsmet", "createdAt": "2020-02-27T12:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MTEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwODU2Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385108567", "bodyText": "See previous answer :P", "author": "geoand", "createdAt": "2020-02-27T12:56:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MTEwNg=="}], "type": "inlineReview"}, {"oid": "5f11554eedb15835aee66699d4c1994aacfe63e5", "url": "https://github.com/quarkusio/quarkus/commit/5f11554eedb15835aee66699d4c1994aacfe63e5", "message": "Support legacy configuration for Agroal", "committedDate": "2020-02-27T12:57:43Z", "type": "forcePushed"}, {"oid": "b558107e78d4bbeb925ed7f589c7e1006f48f060", "url": "https://github.com/quarkusio/quarkus/commit/b558107e78d4bbeb925ed7f589c7e1006f48f060", "message": "Support legacy configuration for Agroal", "committedDate": "2020-02-27T13:02:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5OTA0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385099047", "bodyText": "What is \"aggregated\" about it?", "author": "emmanuelbernard", "createdAt": "2020-02-27T12:36:21Z", "path": "extensions/agroal/deployment/src/main/java/io/quarkus/agroal/deployment/AggregatedDataSourceBuildTimeConfigBuildItem.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package io.quarkus.agroal.deployment;\n+\n+import io.quarkus.agroal.runtime.DataSourceJdbcBuildTimeConfig;\n+import io.quarkus.builder.item.MultiBuildItem;\n+import io.quarkus.datasource.common.runtime.DataSourceUtil;\n+import io.quarkus.datasource.runtime.DataSourceBuildTimeConfig;\n+\n+final class AggregatedDataSourceBuildTimeConfigBuildItem extends MultiBuildItem {", "originalCommit": "43855f0b0ad84acda4484e1f013c7798c42fcc0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEyODM1Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385128353", "bodyText": "It aggregates all the different build time configuration objects into one aggregated and consistent view.", "author": "gsmet", "createdAt": "2020-02-27T13:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5OTA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEzNzM0Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385137346", "bodyText": "so aggregated as opposed ton JDBC and Reactive?", "author": "emmanuelbernard", "createdAt": "2020-02-27T13:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5OTA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEzODcwMw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385138703", "bodyText": "No. Aggregated as opposed to split into several smaller pieces you need to assemble. Not sure if I understand your concern?", "author": "gsmet", "createdAt": "2020-02-27T13:53:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5OTA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3MjQyOQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385272429", "bodyText": "Maybe Combined would be a clearer term? Like in CombinedIndexBuildItem?", "author": "gastaldi", "createdAt": "2020-02-27T17:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5OTA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMwNzk1OA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385307958", "bodyText": "Well, aggregating the configuration is exactly what is is so I prefer keeping the name.", "author": "gsmet", "createdAt": "2020-02-27T18:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5OTA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExMzkyMg==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385113922", "bodyText": "is that to be used as ....jdbc.shortname = h2 ? along side kind? I am not following.", "author": "emmanuelbernard", "createdAt": "2020-02-27T13:07:37Z", "path": "extensions/agroal/runtime/src/main/java/io/quarkus/agroal/runtime/DataSourceJdbcBuildTimeConfig.java", "diffHunk": "@@ -6,27 +6,39 @@\n import io.quarkus.runtime.annotations.ConfigItem;\n \n @ConfigGroup\n-public class DataSourceBuildTimeConfig {\n+public class DataSourceJdbcBuildTimeConfig {\n+\n+    /**\n+     * If we create a JDBC datasource for this datasource.\n+     */\n+    @ConfigItem(name = ConfigItem.PARENT, defaultValue = \"true\")\n+    public boolean enabled = true;\n \n     /**\n      * The datasource driver class name\n      */\n     @ConfigItem\n-    public Optional<String> driver;\n+    public Optional<String> driver = Optional.empty();\n \n     /**\n      * Whether we want to use regular JDBC transactions, XA, or disable all transactional capabilities.\n      * <p>\n      * When enabling XA you will need a driver implementing {@link javax.sql.XADataSource}.\n      */\n     @ConfigItem(defaultValue = \"enabled\")\n-    public TransactionIntegration transactions;\n+    public TransactionIntegration transactions = TransactionIntegration.ENABLED;\n \n     /**\n      * Enable datasource metrics collection. If unspecified, collecting metrics will be enabled by default if the\n      * smallrye-metrics extension is active.\n      */\n     @ConfigItem\n-    public Optional<Boolean> enableMetrics;\n+    public Optional<Boolean> enableMetrics = Optional.empty();\n+\n+    /**\n+     * The datasource driver short name\n+     */\n+    @ConfigItem\n+    public Optional<String> shortName;", "originalCommit": "b558107e78d4bbeb925ed7f589c7e1006f48f060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEyNzc5Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385127793", "bodyText": "Ah, this shouldn't be there, it's a leftover. Let me fix that.", "author": "gsmet", "createdAt": "2020-02-27T13:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExMzkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEzOTEwNw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385139107", "bodyText": "Fixed.", "author": "gsmet", "createdAt": "2020-02-27T13:54:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExMzkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExNDQzOA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385114438", "bodyText": "@Sanne you want this to be default = true?", "author": "emmanuelbernard", "createdAt": "2020-02-27T13:08:39Z", "path": "extensions/agroal/runtime/src/main/java/io/quarkus/agroal/runtime/DataSourceJdbcRuntimeConfig.java", "diffHunk": "@@ -111,17 +82,17 @@\n      * no leaks are happening.\n      */\n     @ConfigItem(defaultValue = \"true\")\n-    public boolean detectStatementLeaks;\n+    public boolean detectStatementLeaks = true;", "originalCommit": "b558107e78d4bbeb925ed7f589c7e1006f48f060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEyOTAwMw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385129003", "bodyText": "It was already defaulted to true (see the ConfigItem) so if we need to discuss this, let's not block this PR.", "author": "gsmet", "createdAt": "2020-02-27T13:36:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExNDQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEzNzUzMw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385137533", "bodyText": "Sure,", "author": "emmanuelbernard", "createdAt": "2020-02-27T13:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExNDQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIyNTUwMA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385225500", "bodyText": "yes we want that to be true (as it currently is).  We'll have ORM bypass it, but that's for another day ;)", "author": "Sanne", "createdAt": "2020-02-27T16:33:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExNDQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExNzI1OA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385117258", "bodyText": "See comment about \"system\"", "author": "emmanuelbernard", "createdAt": "2020-02-27T13:14:08Z", "path": "extensions/datasource/common/src/main/java/io/quarkus/datasource/common/runtime/DatabaseKind.java", "diffHunk": "@@ -0,0 +1,113 @@\n+package io.quarkus.datasource.common.runtime;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * We don't use an enum as we also need to support non built-in database kinds.\n+ */\n+public final class DatabaseKind {", "originalCommit": "b558107e78d4bbeb925ed7f589c7e1006f48f060", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExNzc1Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385117753", "bodyText": "Mildly curious, this class has to be runtime? vs deployment time?", "author": "emmanuelbernard", "createdAt": "2020-02-27T13:15:08Z", "path": "extensions/datasource/common/src/main/java/io/quarkus/datasource/common/runtime/DatabaseKind.java", "diffHunk": "@@ -0,0 +1,113 @@\n+package io.quarkus.datasource.common.runtime;", "originalCommit": "b558107e78d4bbeb925ed7f589c7e1006f48f060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEzOTY2OA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385139668", "bodyText": "I want to be able to reference it everywhere. Typically it's used in the qualifier of the JDBC driver specific CDI beans.", "author": "gsmet", "createdAt": "2020-02-27T13:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExNzc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExOTkzMw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385119933", "bodyText": "What's this one about? A move of class or a net new feature?", "author": "emmanuelbernard", "createdAt": "2020-02-27T13:19:28Z", "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/dialect/QuarkusPostgreSQL10Dialect.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package io.quarkus.hibernate.orm.runtime.dialect;\n+\n+import java.sql.DatabaseMetaData;\n+import java.sql.SQLException;\n+\n+import org.hibernate.dialect.PostgreSQL95Dialect;\n+import org.hibernate.engine.jdbc.env.spi.IdentifierCaseStrategy;\n+import org.hibernate.engine.jdbc.env.spi.IdentifierHelper;\n+import org.hibernate.engine.jdbc.env.spi.IdentifierHelperBuilder;\n+\n+/**\n+ * Subclass of PostgreSQL10Dialect fixing schema updates by considering unquoted identifiers as lower case.\n+ * This is PostgreSQL's behavior.\n+ * See https://github.com/quarkusio/quarkus/issues/1886\n+ */\n+public class QuarkusPostgreSQL10Dialect extends PostgreSQL95Dialect {", "originalCommit": "b558107e78d4bbeb925ed7f589c7e1006f48f060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEyOTU5NA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385129594", "bodyText": "Ah silly me, it's supposed to extend PostgreSQL10Dialect. Let me fix that.", "author": "gsmet", "createdAt": "2020-02-27T13:37:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExOTkzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEzOTI3OA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385139278", "bodyText": "Fixed.", "author": "gsmet", "createdAt": "2020-02-27T13:54:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTExOTkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEyMTU5MA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385121590", "bodyText": "runtime? why not deployment time?", "author": "emmanuelbernard", "createdAt": "2020-02-27T13:22:42Z", "path": "extensions/jdbc/jdbc-mariadb/runtime/src/main/java/io/quarkus/jdbc/mariadb/runtime/MariaDBAgroalConnectionConfigurer.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package io.quarkus.jdbc.mariadb.runtime;", "originalCommit": "b558107e78d4bbeb925ed7f589c7e1006f48f060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEyOTk1Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385129956", "bodyText": "Because it's used at runtime to configure the Agroal pool.\nIt's a CDI bean.", "author": "gsmet", "createdAt": "2020-02-27T13:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEyMTU5MA=="}], "type": "inlineReview"}, {"oid": "45829b28f87819e65849067ba7b360318ed9f152", "url": "https://github.com/quarkusio/quarkus/commit/45829b28f87819e65849067ba7b360318ed9f152", "message": "Support legacy configuration for Agroal", "committedDate": "2020-02-27T13:55:35Z", "type": "forcePushed"}, {"oid": "4fc00ab23a8ba1aff86df18fbbb6cb0c2971eb69", "url": "https://github.com/quarkusio/quarkus/commit/4fc00ab23a8ba1aff86df18fbbb6cb0c2971eb69", "message": "fixup! Extract the shared datasource config to a separate extension", "committedDate": "2020-02-27T14:00:07Z", "type": "forcePushed"}, {"oid": "792e0d24879acd324350eb30a0356c2fea90f752", "url": "https://github.com/quarkusio/quarkus/commit/792e0d24879acd324350eb30a0356c2fea90f752", "message": "Add a test for unknown kind support in Agroal", "committedDate": "2020-02-27T14:24:12Z", "type": "forcePushed"}, {"oid": "fbdf6a340c9cef3d6f61e7fc95ce354937c939b0", "url": "https://github.com/quarkusio/quarkus/commit/fbdf6a340c9cef3d6f61e7fc95ce354937c939b0", "message": "Add a test for unknown kind support in Agroal", "committedDate": "2020-02-27T14:30:01Z", "type": "forcePushed"}, {"oid": "520fdcf9a956dc5401b419bd38e11dad55b88ac9", "url": "https://github.com/quarkusio/quarkus/commit/520fdcf9a956dc5401b419bd38e11dad55b88ac9", "message": "Support legacy configurations for the reactive clients", "committedDate": "2020-02-27T18:37:26Z", "type": "forcePushed"}, {"oid": "324bf9e3a3594e0e4edb139a9870b11cf360f8c5", "url": "https://github.com/quarkusio/quarkus/commit/324bf9e3a3594e0e4edb139a9870b11cf360f8c5", "message": "Support legacy configurations for the reactive clients", "committedDate": "2020-02-27T18:49:46Z", "type": "forcePushed"}, {"oid": "35a63429ad13fe2a50ee7fedad0ab7444664178d", "url": "https://github.com/quarkusio/quarkus/commit/35a63429ad13fe2a50ee7fedad0ab7444664178d", "message": "Support legacy configurations for the reactive clients", "committedDate": "2020-02-27T18:57:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNzQ3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385317473", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try (Connection connection = dataSource.getConnection()) {\n          \n          \n            \n                    }\n          \n          \n            \n                    assertThatCode(()->dataSource.getConnection().close()).doesNotThrowAnyException());", "author": "gastaldi", "createdAt": "2020-02-27T19:16:39Z", "path": "extensions/agroal/deployment/src/test/java/io/quarkus/agroal/test/UnknownDriverConfigTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package io.quarkus.agroal.test;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.time.Duration;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import io.agroal.api.AgroalDataSource;\n+import io.agroal.api.configuration.AgroalConnectionFactoryConfiguration;\n+import io.agroal.api.configuration.AgroalConnectionPoolConfiguration;\n+import io.agroal.narayana.NarayanaTransactionIntegration;\n+import io.quarkus.test.QuarkusUnitTest;\n+\n+public class UnknownDriverConfigTest {\n+\n+    @Inject\n+    AgroalDataSource defaultDataSource;\n+\n+    @RegisterExtension\n+    static final QuarkusUnitTest config = new QuarkusUnitTest()\n+            .withConfigurationResource(\"application-default-datasource-unknown-driver.properties\");\n+\n+    @Test\n+    public void testDefaultDataSourceInjection() throws SQLException {\n+        testDataSource(defaultDataSource, \"username-default\", 3, 13, 7, Duration.ofSeconds(53), Duration.ofSeconds(54),\n+                Duration.ofSeconds(55), Duration.ofSeconds(56), Duration.ofSeconds(57),\n+                \"create schema if not exists schema_default\");\n+    }\n+\n+    private static void testDataSource(AgroalDataSource dataSource, String username, int minSize, int maxSize,\n+            int initialSize, Duration backgroundValidationInterval, Duration acquisitionTimeout, Duration leakDetectionInterval,\n+            Duration idleRemovalInterval, Duration maxLifetime, String newConnectionSql) throws SQLException {\n+        AgroalConnectionPoolConfiguration configuration = dataSource.getConfiguration().connectionPoolConfiguration();\n+        AgroalConnectionFactoryConfiguration agroalConnectionFactoryConfiguration = configuration\n+                .connectionFactoryConfiguration();\n+\n+        assertEquals(\"jdbc:h2:tcp://localhost/mem:default\", agroalConnectionFactoryConfiguration.jdbcUrl());\n+        assertEquals(username, agroalConnectionFactoryConfiguration.principal().getName());\n+        assertEquals(minSize, configuration.minSize());\n+        assertEquals(maxSize, configuration.maxSize());\n+        assertEquals(initialSize, configuration.initialSize());\n+        assertEquals(backgroundValidationInterval, configuration.validationTimeout());\n+        assertEquals(acquisitionTimeout, configuration.acquisitionTimeout());\n+        assertEquals(leakDetectionInterval, configuration.leakTimeout());\n+        assertEquals(idleRemovalInterval, configuration.reapTimeout());\n+        assertEquals(maxLifetime, configuration.maxLifetime());\n+        assertTrue(configuration.transactionIntegration() instanceof NarayanaTransactionIntegration);\n+        assertEquals(AgroalConnectionFactoryConfiguration.TransactionIsolation.SERIALIZABLE,\n+                agroalConnectionFactoryConfiguration.jdbcTransactionIsolation());\n+        assertTrue(agroalConnectionFactoryConfiguration.trackJdbcResources());\n+        assertTrue(dataSource.getConfiguration().metricsEnabled());\n+        assertEquals(newConnectionSql, agroalConnectionFactoryConfiguration.initialSql());\n+        try (Connection connection = dataSource.getConnection()) {\n+        }", "originalCommit": "35a63429ad13fe2a50ee7fedad0ab7444664178d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQxOTIwOA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385419208", "bodyText": "It's a copy of an existing test. I will leave it at that.", "author": "gsmet", "createdAt": "2020-02-27T22:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNzQ3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxODQ2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385318466", "bodyText": "Why is this necessary? I thought these fields would be set when injected?", "author": "gastaldi", "createdAt": "2020-02-27T19:18:31Z", "path": "extensions/agroal/runtime/src/main/java/io/quarkus/agroal/runtime/DataSourceJdbcRuntimeConfig.java", "diffHunk": "@@ -8,100 +8,71 @@\n import io.quarkus.runtime.annotations.ConfigItem;\n \n @ConfigGroup\n-public class DataSourceRuntimeConfig {\n+public class DataSourceJdbcRuntimeConfig {\n \n     /**\n      * The datasource URL\n      */\n     @ConfigItem\n-    public Optional<String> url;\n-\n-    /**\n-     * The datasource username\n-     */\n-    @ConfigItem\n-    public Optional<String> username;\n-\n-    /**\n-     * The datasource password\n-     */\n-    @ConfigItem\n-    public Optional<String> password;\n-\n-    /**\n-     * The credentials provider name\n-     */\n-    @ConfigItem\n-    public Optional<String> credentialsProvider;\n-\n-    /**\n-     * The credentials provider type.\n-     * <p>\n-     * It is the {@code &#64;Named} value of the credentials provider bean. It is used to discriminate if multiple\n-     * CredentialsProvider beans are available.\n-     * <p>\n-     * For Vault it is: vault-credentials-provider. Not necessary if there is only one credentials provider available.\n-     */\n-    @ConfigItem\n-    public Optional<String> credentialsProviderType;\n+    public Optional<String> url = Optional.empty();\n \n     /**\n      * The initial size of the pool. Usually you will want to set the initial size to match at least the\n      * minimal size, but this is not enforced so to allow for architectures which prefer a lazy initialization\n      * of the connections on boot, while being able to sustain a minimal pool size after boot.\n      */\n     @ConfigItem\n-    public Optional<Integer> initialSize;\n+    public Optional<Integer> initialSize = Optional.empty();", "originalCommit": "35a63429ad13fe2a50ee7fedad0ab7444664178d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQxOTA1Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385419057", "bodyText": "Already explained above.", "author": "gsmet", "createdAt": "2020-02-27T22:56:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxODQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY4MTM0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385681343", "bodyText": "It should be an OptionalInt at any rate.", "author": "dmlloyd", "createdAt": "2020-02-28T12:58:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxODQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMyMTQ3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385321475", "bodyText": "I can't help but think that the last parameter can be sent as null by other extensions. In order to prevent that, I'd suggest it to be String too and in the constructor body just use an Optional.ofNullable", "author": "gastaldi", "createdAt": "2020-02-27T19:24:02Z", "path": "extensions/agroal/spi/src/main/java/io/quarkus/agroal/deployment/JdbcDriverBuildItem.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package io.quarkus.agroal.deployment;\n+\n+import java.util.Optional;\n+\n+import io.quarkus.builder.item.MultiBuildItem;\n+\n+/**\n+ * Register a JDBC driver for the Agroal extension.\n+ * <p>\n+ * It allows to resolve automatically the driver from the kind, thus users don't have to set the driver anymore, except if they\n+ * want to use a specific one.\n+ */\n+public final class JdbcDriverBuildItem extends MultiBuildItem {\n+\n+    private final String kind;\n+\n+    private final String driverClass;\n+\n+    private final Optional<String> xaDriverClass;\n+\n+    public JdbcDriverBuildItem(String kind, String driverClass, Optional<String> xaDriverClass) {", "originalCommit": "35a63429ad13fe2a50ee7fedad0ab7444664178d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQxODk4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385418982", "bodyText": "I know it's not a pattern people love but I want to be clear it's not mandatory.", "author": "gsmet", "createdAt": "2020-02-27T22:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMyMTQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzMTQyNw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385431427", "bodyText": "In the end I decided to expose two different constructors.", "author": "gsmet", "createdAt": "2020-02-27T23:34:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMyMTQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1NDkzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385354935", "bodyText": "This is now longer used anymore as far as I can tell", "author": "geoand", "createdAt": "2020-02-27T20:31:09Z", "path": "extensions/agroal/runtime/src/main/java/io/quarkus/agroal/runtime/AgroalRecorder.java", "diffHunk": "@@ -1,34 +1,27 @@\n package io.quarkus.agroal.runtime;\n \n import io.quarkus.arc.Arc;\n-import io.quarkus.arc.runtime.BeanContainer;\n-import io.quarkus.arc.runtime.BeanContainerListener;\n+import io.quarkus.datasource.runtime.DataSourcesBuildTimeConfig;\n+import io.quarkus.datasource.runtime.DataSourcesRuntimeConfig;\n+import io.quarkus.datasource.runtime.LegacyDataSourcesRuntimeConfig;\n import io.quarkus.runtime.annotations.Recorder;\n \n @Recorder\n public class AgroalRecorder {\n \n     public static final String DEFAULT_DATASOURCE_NAME = \"<default>\";", "originalCommit": "35a63429ad13fe2a50ee7fedad0ab7444664178d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyNjMyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385426325", "bodyText": "Right, removed.", "author": "gsmet", "createdAt": "2020-02-27T23:17:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1NDkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUyMzM5NQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385523395", "bodyText": "Thanks", "author": "geoand", "createdAt": "2020-02-28T06:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1NDkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2Mzg4MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385363881", "bodyText": "This also requires the Javadoc to be updated", "author": "geoand", "createdAt": "2020-02-27T20:51:05Z", "path": "extensions/elytron-security-jdbc/deployment/src/main/java/io/quarkus/elytron/security/jdbc/deployment/ElytronSecurityJdbcProcessor.java", "diffHunk": "@@ -50,7 +50,7 @@ FeatureBuildItem feature() {\n     void configureJdbcRealmAuthConfig(JdbcRecorder recorder,\n             BuildProducer<SecurityRealmBuildItem> securityRealm,\n             BeanContainerBuildItem beanContainerBuildItem, //we need this to make sure ArC is initialized\n-            Optional<DataSourceInitializedBuildItem> dataSourceInitialized) throws Exception {\n+            List<JdbcDataSourceBuildItem> dataSourcesConfigured) throws Exception {", "originalCommit": "35a63429ad13fe2a50ee7fedad0ab7444664178d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzMTM0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385431347", "bodyText": "Done.", "author": "gsmet", "createdAt": "2020-02-27T23:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2Mzg4MQ=="}], "type": "inlineReview"}, {"oid": "b51901aa52274a9906cb31647aaea3c47771182a", "url": "https://github.com/quarkusio/quarkus/commit/b51901aa52274a9906cb31647aaea3c47771182a", "message": "Remove a now unused constant", "committedDate": "2020-02-27T23:32:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzAyOQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385593029", "bodyText": "old reference to kind", "author": "emmanuelbernard", "createdAt": "2020-02-28T09:35:17Z", "path": "extensions/agroal/runtime/src/main/java/io/quarkus/agroal/runtime/LegacyDataSourceJdbcBuildTimeConfig.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package io.quarkus.agroal.runtime;\n+\n+import java.util.Optional;\n+\n+import io.quarkus.runtime.annotations.ConfigGroup;\n+import io.quarkus.runtime.annotations.ConfigItem;\n+\n+/**\n+ * This configuration class is here for compatibility reason and is planned for removal.\n+ */\n+@Deprecated\n+@ConfigGroup\n+public class LegacyDataSourceJdbcBuildTimeConfig {\n+\n+    /**\n+     * @deprecated use quarkus.datasource.kind (or quarkus.datasource.jdbc.driver if you really need a specific JDBC driver).", "originalCommit": "b51901aa52274a9906cb31647aaea3c47771182a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY1OTY1NA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385659654", "bodyText": "Fixed.", "author": "gsmet", "createdAt": "2020-02-28T12:04:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzAyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzIzNw==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385593237", "bodyText": "not mandatory but renaming dbKind will help a future code reader", "author": "emmanuelbernard", "createdAt": "2020-02-28T09:35:42Z", "path": "extensions/agroal/spi/src/main/java/io/quarkus/agroal/deployment/JdbcDataSourceBuildItem.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.agroal.deployment;\n+\n+import io.quarkus.builder.item.MultiBuildItem;\n+\n+/**\n+ * A build item for JDBC datasources.\n+ * <p>\n+ * If you inject this build item when recording runtime init template calls, you are guaranteed the datasources configuration\n+ * has been injected and datasources can be created.\n+ */\n+public final class JdbcDataSourceBuildItem extends MultiBuildItem {\n+\n+    private final String name;\n+\n+    private final String kind;\n+\n+    private final boolean isDefault;\n+\n+    public JdbcDataSourceBuildItem(String name, String kind, boolean isDefault) {\n+        this.name = name;\n+        this.kind = kind;", "originalCommit": "b51901aa52274a9906cb31647aaea3c47771182a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY1OTgwMg==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385659802", "bodyText": "Done.", "author": "gsmet", "createdAt": "2020-02-28T12:04:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzUwMA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385593500", "bodyText": "not mandatory but a future code reader will be helped by it being name dbKind", "author": "emmanuelbernard", "createdAt": "2020-02-28T09:36:12Z", "path": "extensions/agroal/spi/src/main/java/io/quarkus/agroal/deployment/JdbcDriverBuildItem.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package io.quarkus.agroal.deployment;\n+\n+import java.util.Optional;\n+\n+import io.quarkus.builder.item.MultiBuildItem;\n+\n+/**\n+ * Register a JDBC driver for the Agroal extension.\n+ * <p>\n+ * It allows to resolve automatically the driver from the kind, thus users don't have to set the driver anymore, except if they\n+ * want to use a specific one.\n+ */\n+public final class JdbcDriverBuildItem extends MultiBuildItem {\n+\n+    private final String kind;\n+\n+    private final String driverClass;\n+\n+    private final Optional<String> xaDriverClass;\n+\n+    public JdbcDriverBuildItem(String kind, String driverClass, String xaDriverClass) {\n+        this.kind = kind;", "originalCommit": "b51901aa52274a9906cb31647aaea3c47771182a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY2MDU0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385660545", "bodyText": "Done.", "author": "gsmet", "createdAt": "2020-02-28T12:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzUwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzgwNg==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385593806", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            ? \"Hibernate extension could not guess the dialect from the kind '\" + resolvedKind\n          \n          \n            \n                            ? \"Hibernate extension could not guess the dialect from the database kind '\" + resolvedKind", "author": "emmanuelbernard", "createdAt": "2020-02-28T09:36:49Z", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -710,32 +716,34 @@ private void handleHibernateORMWithNoPersistenceXml(\n         }\n     }\n \n-    private Optional<String> guessDialect(Optional<String> driver) {\n+    private Optional<String> guessDialect(Optional<String> kind) {\n         // For now select the latest dialect from the driver\n         // later, we can keep doing that but also avoid DCE\n         // of all the dialects we want in so that people can override them\n-        String resolvedDriver = driver.orElse(\"NODRIVER\");\n-        if (resolvedDriver.contains(\"postgresql\")) {\n-            return Optional.of(QuarkusPostgreSQL95Dialect.class.getName());\n+        String resolvedKind = kind.orElse(\"NO_KIND\");\n+        if (DatabaseKind.isPostgreSQL(resolvedKind)) {\n+            return Optional.of(QuarkusPostgreSQL10Dialect.class.getName());\n         }\n-        if (resolvedDriver.contains(\"org.h2.Driver\")) {\n+        if (DatabaseKind.isH2(resolvedKind)) {\n             return Optional.of(QuarkusH2Dialect.class.getName());\n         }\n-        if (resolvedDriver.contains(\"org.mariadb.jdbc.Driver\")) {\n+        if (DatabaseKind.isMariaDB(resolvedKind)) {\n             return Optional.of(MariaDB103Dialect.class.getName());\n         }\n-\n-        if (resolvedDriver.contains(\"com.mysql.cj.jdbc.Driver\")) {\n+        if (DatabaseKind.isMySQL(resolvedKind)) {\n             return Optional.of(MySQL8Dialect.class.getName());\n         }\n-        if (resolvedDriver.contains(\"org.apache.derby.jdbc.ClientDriver\")) {\n+        if (DatabaseKind.isDerby(resolvedKind)) {\n             return Optional.of((DerbyTenSevenDialect.class.getName()));\n         }\n+        if (DatabaseKind.isMsSQL(resolvedKind)) {\n+            return Optional.of((SQLServer2012Dialect.class.getName()));\n+        }\n \n-        String error = driver.isPresent()\n-                ? \"Hibernate extension could not guess the dialect from the driver '\" + resolvedDriver\n+        String error = kind.isPresent()\n+                ? \"Hibernate extension could not guess the dialect from the kind '\" + resolvedKind", "originalCommit": "b51901aa52274a9906cb31647aaea3c47771182a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY2MTE2NA==", "url": "https://github.com/quarkusio/quarkus/pull/7453#discussion_r385661164", "bodyText": "Done and fixed a few other things in this message too.", "author": "gsmet", "createdAt": "2020-02-28T12:08:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzgwNg=="}], "type": "inlineReview"}, {"oid": "d14e7446fa015cd6bdd7816aace4e941da517076", "url": "https://github.com/quarkusio/quarkus/commit/d14e7446fa015cd6bdd7816aace4e941da517076", "message": "Fix bug where name conflicts in generated config *GetEnclosing are possible", "committedDate": "2020-02-28T10:37:05Z", "type": "commit"}, {"oid": "0d64d8596242d1900b1f62334e2d89c6fbeaa3aa", "url": "https://github.com/quarkusio/quarkus/commit/0d64d8596242d1900b1f62334e2d89c6fbeaa3aa", "message": "Extract the shared datasource config to a separate extension", "committedDate": "2020-02-28T10:37:05Z", "type": "commit"}, {"oid": "adcf95f40b20f0812a9b2d482440fe96c6d4acd4", "url": "https://github.com/quarkusio/quarkus/commit/adcf95f40b20f0812a9b2d482440fe96c6d4acd4", "message": "Make reactive clients share datasource configuration", "committedDate": "2020-02-28T10:37:05Z", "type": "commit"}, {"oid": "4d0605535e6f21920ee8a67a78165db3fa06d04a", "url": "https://github.com/quarkusio/quarkus/commit/4d0605535e6f21920ee8a67a78165db3fa06d04a", "message": "Introduce DatabaseKind in a quarkus-datasource-common extension", "committedDate": "2020-02-28T10:37:05Z", "type": "commit"}, {"oid": "34290b6101290a3e07b26abe84ac009a1cad739e", "url": "https://github.com/quarkusio/quarkus/commit/34290b6101290a3e07b26abe84ac009a1cad739e", "message": "Upgrade the default PostgreSQL dialect to PostgreSQL 10", "committedDate": "2020-02-28T10:37:05Z", "type": "commit"}, {"oid": "396d1f4716bb2b0bb2cefbb06eb9815e915dcf01", "url": "https://github.com/quarkusio/quarkus/commit/396d1f4716bb2b0bb2cefbb06eb9815e915dcf01", "message": "Resolve automatically the SQL Server dialect", "committedDate": "2020-02-28T10:37:05Z", "type": "commit"}, {"oid": "0312019876e018307b38cc988c645deb078f5147", "url": "https://github.com/quarkusio/quarkus/commit/0312019876e018307b38cc988c645deb078f5147", "message": "Make driver optional and provide a JDBC driver infrastructure\n\nCo-authored-by: Anamarija Talijanac <anamarija.medic@gmail.com>", "committedDate": "2020-02-28T10:37:05Z", "type": "commit"}, {"oid": "7966f972939181793eef0de5a1fd89164a370c72", "url": "https://github.com/quarkusio/quarkus/commit/7966f972939181793eef0de5a1fd89164a370c72", "message": "Support legacy configuration for Agroal", "committedDate": "2020-02-28T10:37:05Z", "type": "commit"}, {"oid": "4e444f9ebdc9e124a263273767728fd23e3e6206", "url": "https://github.com/quarkusio/quarkus/commit/4e444f9ebdc9e124a263273767728fd23e3e6206", "message": "Add a test for unknown kind support in Agroal", "committedDate": "2020-02-28T10:37:05Z", "type": "commit"}, {"oid": "016ca30d6f5cc072e91f2b23af2daca9571e0ad9", "url": "https://github.com/quarkusio/quarkus/commit/016ca30d6f5cc072e91f2b23af2daca9571e0ad9", "message": "Remove a now unused constant", "committedDate": "2020-02-28T10:37:05Z", "type": "forcePushed"}, {"oid": "f1cffc11682a699594bc602470feb3b4573ef3c6", "url": "https://github.com/quarkusio/quarkus/commit/f1cffc11682a699594bc602470feb3b4573ef3c6", "message": "Rename quarkus.datasource.kind to quarkus.datasource.db-kind", "committedDate": "2020-02-28T13:23:07Z", "type": "commit"}, {"oid": "d5ddac4aded119187cbfd4ea62c23405fdd850c7", "url": "https://github.com/quarkusio/quarkus/commit/d5ddac4aded119187cbfd4ea62c23405fdd850c7", "message": "Support legacy configurations for the reactive clients", "committedDate": "2020-02-28T13:23:07Z", "type": "commit"}, {"oid": "483f2bd541ddb2cd4baa94d24b380dfc0dc0c6d8", "url": "https://github.com/quarkusio/quarkus/commit/483f2bd541ddb2cd4baa94d24b380dfc0dc0c6d8", "message": "Remove a now unused constant", "committedDate": "2020-02-28T13:23:07Z", "type": "commit"}, {"oid": "229977e2589744583f9eb278a277d2b46bdb1ca1", "url": "https://github.com/quarkusio/quarkus/commit/229977e2589744583f9eb278a277d2b46bdb1ca1", "message": "Make datasource.initial-size an OptionalInt", "committedDate": "2020-02-28T13:28:28Z", "type": "commit"}, {"oid": "229977e2589744583f9eb278a277d2b46bdb1ca1", "url": "https://github.com/quarkusio/quarkus/commit/229977e2589744583f9eb278a277d2b46bdb1ca1", "message": "Make datasource.initial-size an OptionalInt", "committedDate": "2020-02-28T13:28:28Z", "type": "forcePushed"}]}