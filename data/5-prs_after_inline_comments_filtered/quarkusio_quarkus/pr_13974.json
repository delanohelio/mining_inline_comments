{"pr_number": 13974, "pr_title": "Minor keycloak-authorization code and doc updates", "pr_createdAt": "2020-12-18T18:11:21Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13974", "timeline": [{"oid": "221c918a71ae14a24fbedd4d68aaac8e6273db20", "url": "https://github.com/quarkusio/quarkus/commit/221c918a71ae14a24fbedd4d68aaac8e6273db20", "message": "Minor keycloak-authorization code and doc updates", "committedDate": "2020-12-18T18:09:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDEyMA==", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546100120", "bodyText": "I think debug logs like this should also be in the init method, since it seems that method returns prematurely in this case", "author": "gastaldi", "createdAt": "2020-12-18T21:29:58Z", "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "diffHunk": "@@ -43,6 +46,11 @@\n \n     @Override\n     public CheckResult apply(RoutingContext routingContext, SecurityIdentity identity) {\n+        if (delegate == null) {\n+            LOG.debug(\n+                    \"Keycloak Policy Enforcer has not been initialized - please make sure 'quarkus.oidc.enabled' is not set to 'false'\");", "originalCommit": "221c918a71ae14a24fbedd4d68aaac8e6273db20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExNzU3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546117576", "bodyText": "@gastaldi sure, it is just the way it is currently implemented that a recorder calls the initialization method only if that property is enabled, so the user disabled it, forgot to re-enable and got NPE, so this issue is just about avoiding NPE and saying somethng useful... Pedro @pedroigor is managing this extension, I only venture with some basic fixes into it :-).\nPerhaps indeed a deeper refactoring is required here", "author": "sberyozkin", "createdAt": "2020-12-18T22:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyMzk1NA==", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546123954", "bodyText": "@gastaldi I'll have a quick look as well if it can be caught earlier, there must be a way", "author": "sberyozkin", "createdAt": "2020-12-18T22:39:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDEyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDQwNQ==", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546100405", "bodyText": "Can we also explain why the Authentication failed to the caller here?", "author": "gastaldi", "createdAt": "2020-12-18T21:30:47Z", "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "diffHunk": "@@ -43,6 +46,11 @@\n \n     @Override\n     public CheckResult apply(RoutingContext routingContext, SecurityIdentity identity) {\n+        if (delegate == null) {\n+            LOG.debug(\n+                    \"Keycloak Policy Enforcer has not been initialized - please make sure 'quarkus.oidc.enabled' is not set to 'false'\");\n+            throw new AuthenticationFailedException();\n+        }", "originalCommit": "221c918a71ae14a24fbedd4d68aaac8e6273db20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExODc3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546118777", "bodyText": "I was thinking, since this code is executed as part of the user authentication process, it should be 401. In fact first I coded an IllegalStateException but then I changed my mind, but now that you asked, I wonder if returning 500 would be best as it is really a server configuration issue. What would you prefer yourself ?", "author": "sberyozkin", "createdAt": "2020-12-18T22:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyMTY1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546121651", "bodyText": "Returning 500 makes more sense to me", "author": "gastaldi", "createdAt": "2020-12-18T22:31:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyMzYxMA==", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546123610", "bodyText": "@gastaldi thanks, I'll fix during the next few days, have to sign off now, thanks for starting the review, enjoy the weekend :-)", "author": "sberyozkin", "createdAt": "2020-12-18T22:37:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3NTYwMg==", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546175602", "bodyText": "Likewise, have fun! \ud83d\ude09", "author": "gastaldi", "createdAt": "2020-12-19T02:07:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDQwNQ=="}], "type": "inlineReview"}]}