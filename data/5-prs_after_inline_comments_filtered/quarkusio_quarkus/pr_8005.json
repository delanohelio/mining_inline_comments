{"pr_number": 8005, "pr_title": "Don't let the thread interrupt state interfere with class loading", "pr_createdAt": "2020-03-20T00:32:53Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8005", "timeline": [{"oid": "44c8cf98d37c041b3c9538a7761b1c4b2d6c7db3", "url": "https://github.com/quarkusio/quarkus/commit/44c8cf98d37c041b3c9538a7761b1c4b2d6c7db3", "message": "Don't let the thread interrupt state interfere with class loading", "committedDate": "2020-03-20T00:38:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY0NTY3NA==", "url": "https://github.com/quarkusio/quarkus/pull/8005#discussion_r395645674", "bodyText": "In general I think this makes sense.  It's not perfect in that the thread can be interrupted during the class load, but I don't really have any better solution for that at bootstrap (JBossThread does have support for blocking interrupts but I'm assuming that it isn't available at bootstrap).", "author": "dmlloyd", "createdAt": "2020-03-20T13:45:45Z", "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/classloading/QuarkusClassLoader.java", "diffHunk": "@@ -253,44 +253,55 @@ public InputStream getResourceAsStream(String nm) {\n \n     @Override\n     protected Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {\n-        ClassLoaderState state = getState();\n-        synchronized (getClassLoadingLock(name)) {\n-            Class<?> c = findLoadedClass(name);\n-            if (c != null) {\n-                return c;\n-            }\n-            String resourceName = sanitizeName(name).replace(\".\", \"/\") + \".class\";\n-            boolean parentFirst = parentFirst(resourceName, state);\n-            if (state.bannedResources.contains(resourceName)) {\n-                throw new ClassNotFoundException(name);\n-            }\n-            if (parentFirst) {\n-                try {\n-                    return parent.loadClass(name);\n-                } catch (ClassNotFoundException ignore) {\n-                    log.tracef(\"Class %s not found in parent first load from %s\", name, parent);\n+        //even if the thread is interrupted we still want to be able to load classes\n+        //if the interrupt bit is set then we clear it and restore it at the end\n+        boolean interrupted = Thread.interrupted();\n+        try {", "originalCommit": "44c8cf98d37c041b3c9538a7761b1c4b2d6c7db3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE3MjcyNw==", "url": "https://github.com/quarkusio/quarkus/pull/8005#discussion_r396172727", "bodyText": "I guess we could catch InterruptedIOException and retry if it fails?", "author": "stuartwdouglas", "createdAt": "2020-03-23T01:08:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY0NTY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2NDYyMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8005#discussion_r396464621", "bodyText": "Yeah that could work.  That exception has an int field which contains the number of bytes transferred thus far.  You'll have to clear the interrupt status manually though because InterruptedIOException (unlike InterruptedException) does not imply this.", "author": "dmlloyd", "createdAt": "2020-03-23T13:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY0NTY3NA=="}], "type": "inlineReview"}, {"oid": "5e79b536ed671d293df7eb83d4ecef50aca0a1f1", "url": "https://github.com/quarkusio/quarkus/commit/5e79b536ed671d293df7eb83d4ecef50aca0a1f1", "message": "Don't let the thread interrupt state interfere with class loading", "committedDate": "2020-03-23T03:25:45Z", "type": "forcePushed"}, {"oid": "f96f10ec6e60858970d360f529a0670932e8b572", "url": "https://github.com/quarkusio/quarkus/commit/f96f10ec6e60858970d360f529a0670932e8b572", "message": "Don't let the thread interrupt state interfere with class loading", "committedDate": "2020-03-23T03:55:37Z", "type": "commit"}, {"oid": "f96f10ec6e60858970d360f529a0670932e8b572", "url": "https://github.com/quarkusio/quarkus/commit/f96f10ec6e60858970d360f529a0670932e8b572", "message": "Don't let the thread interrupt state interfere with class loading", "committedDate": "2020-03-23T03:55:37Z", "type": "forcePushed"}]}