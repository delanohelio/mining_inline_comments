{"pr_number": 10576, "pr_title": "Bootstrap workspace discovery: fix infinite loop, pom model cache", "pr_createdAt": "2020-07-08T14:55:51Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/10576", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzNjYwMw==", "url": "https://github.com/quarkusio/quarkus/pull/10576#discussion_r451636603", "bodyText": "This snippet can be replaced with:\n        private Model model(Path pomFile) throws BootstrapMavenException {\n            return cachedModels.computeIfEmpty(pomFile.getParent(), parent->readModel(pomFile));\n        }", "author": "gastaldi", "createdAt": "2020-07-08T15:33:16Z", "path": "independent-projects/bootstrap/maven-resolver/src/main/java/io/quarkus/bootstrap/resolver/maven/workspace/LocalProject.java", "diffHunk": "@@ -30,6 +31,124 @@\n     private static final String PROJECT_BASEDIR = \"${project.basedir}\";\n     private static final String POM_XML = \"pom.xml\";\n \n+    private static class WorkspaceLoader {\n+\n+        private final LocalWorkspace workspace = new LocalWorkspace();\n+        private final Map<Path, Model> cachedModels = new HashMap<>();\n+        private final Path currentProjectPom;\n+        private Path workspaceRootPom;\n+\n+        private WorkspaceLoader(Path currentProjectPom) throws BootstrapMavenException {\n+            this.currentProjectPom = isPom(currentProjectPom) ? currentProjectPom : locateCurrentProjectPom(currentProjectPom, true);\n+        }\n+\n+        private boolean isPom(Path p) {\n+            if (Files.exists(p) && !Files.isDirectory(p)) {\n+                try {\n+                    loadAndCache(p);\n+                    return true;\n+                } catch (BootstrapMavenException e) {\n+                    // not a POM file\n+                }\n+            }\n+            return false;\n+        }\n+\n+        private Model model(Path pomFile) throws BootstrapMavenException {\n+            Model model = cachedModels.get(pomFile.getParent());\n+            if(model == null) {\n+                model = loadAndCache(pomFile);\n+            }\n+            return model;\n+        }\n+\n+        private Model loadAndCache(Path pomFile) throws BootstrapMavenException {\n+            final Model model = readModel(pomFile);\n+            cachedModels.put(pomFile.getParent(), model);\n+            return model;\n+        }", "originalCommit": "b07e455d5121f95f7a337d87f4824c95c7146fcd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzOTQxOQ==", "url": "https://github.com/quarkusio/quarkus/pull/10576#discussion_r451639419", "bodyText": "computeIfAbsent()? But then I'd have to catch the exception and re-throw a runtime one.", "author": "aloubyansky", "createdAt": "2020-07-08T15:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzNjYwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY0MzI1OQ==", "url": "https://github.com/quarkusio/quarkus/pull/10576#discussion_r451643259", "bodyText": "Ah damn checked exceptions, you're right :(", "author": "gastaldi", "createdAt": "2020-07-08T15:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzNjYwMw=="}], "type": "inlineReview"}, {"oid": "297a82b73a063ceb08420b37bc449a602090ef99", "url": "https://github.com/quarkusio/quarkus/commit/297a82b73a063ceb08420b37bc449a602090ef99", "message": "Bootstrap workspace discovery: fix infinite loop, pom model cache", "committedDate": "2020-07-08T15:49:27Z", "type": "commit"}, {"oid": "297a82b73a063ceb08420b37bc449a602090ef99", "url": "https://github.com/quarkusio/quarkus/commit/297a82b73a063ceb08420b37bc449a602090ef99", "message": "Bootstrap workspace discovery: fix infinite loop, pom model cache", "committedDate": "2020-07-08T15:49:27Z", "type": "forcePushed"}]}