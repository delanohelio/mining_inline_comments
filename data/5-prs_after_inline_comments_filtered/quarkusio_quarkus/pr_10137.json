{"pr_number": 10137, "pr_title": "Gradle support - Improve logging/visibility of native image generation", "pr_createdAt": "2020-06-21T05:55:57Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/10137", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4NzY1Nw==", "url": "https://github.com/quarkusio/quarkus/pull/10137#discussion_r443187657", "bodyText": "Given that this code is now repeated everywhere the process is launched, how about adding a method to ProcessInheritIODsiabled that takes ProcessBuilder or arguments necessary to initialize and start it?", "author": "aloubyansky", "createdAt": "2020-06-21T06:41:27Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java", "diffHunk": "@@ -126,9 +129,15 @@ public NativeImageBuildItem build(NativeConfig nativeConfig, NativeImageSourceJa\n                 log.info(\"Pulling image \" + nativeConfig.builderImage);\n                 Process pullProcess = null;\n                 try {\n-                    pullProcess = new ProcessBuilder(Arrays.asList(containerRuntime, \"pull\", nativeConfig.builderImage))\n-                            .inheritIO()\n-                            .start();\n+                    final ProcessBuilder pb = new ProcessBuilder(\n+                            Arrays.asList(containerRuntime, \"pull\", nativeConfig.builderImage));\n+                    if (processInheritIODisabled.isPresent()) {\n+                        // explicitly stream the stdout/stderr of the new process to this process' System.out/System.err\n+                        pullProcess = pb.start();\n+                        ProcessUtil.streamToSysOutSysErr(pb.start());\n+                    } else {\n+                        pullProcess = pb.inheritIO().start();\n+                    }", "originalCommit": "67bd7d61de298c5b88395c598c4cbe2cb757e5b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4NzgwOQ==", "url": "https://github.com/quarkusio/quarkus/pull/10137#discussion_r443187809", "bodyText": "You are right - this is repeated at more than one place, although there's one place where it deals with it differently. Makes sense to have this in a common method and use it wherever appropriate. I'll update the PR shortly.", "author": "jaikiran", "createdAt": "2020-06-21T06:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4NzY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4OTg0MQ==", "url": "https://github.com/quarkusio/quarkus/pull/10137#discussion_r443189841", "bodyText": "Hello @aloubyansky, I've moved that logic into ProcessUtil#launchProcess and ProcessUtil#launchProcessStreamStdOut. PR has now been updated.", "author": "jaikiran", "createdAt": "2020-06-21T07:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4NzY1Nw=="}], "type": "inlineReview"}, {"oid": "8d00d52cdc9b74fa34e96e153b27e3e6dc32c285", "url": "https://github.com/quarkusio/quarkus/commit/8d00d52cdc9b74fa34e96e153b27e3e6dc32c285", "message": "Workaround Gradle issue https://github.com/gradle/gradle/issues/13522\nExplicitly capture stdout/stderr of processes launched by build steps when run in the context of a Gradle build", "committedDate": "2020-06-21T07:11:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwNjY1Mg==", "url": "https://github.com/quarkusio/quarkus/pull/10137#discussion_r443206652", "bodyText": "Aren't standard and error streams merged into one in this case?", "author": "aloubyansky", "createdAt": "2020-06-21T10:46:21Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/util/ProcessUtil.java", "diffHunk": "@@ -0,0 +1,138 @@\n+package io.quarkus.deployment.util;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.PrintStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Optional;\n+\n+import org.jboss.logging.Logger;\n+\n+import io.quarkus.deployment.pkg.builditem.ProcessInheritIODisabled;\n+\n+/**\n+ * Utility for {@link Process} related operations\n+ */\n+public class ProcessUtil {\n+\n+    private static final Logger logger = Logger.getLogger(ProcessUtil.class);\n+\n+    /**\n+     * Launches and returns a {@link Process} built from the {@link ProcessBuilder builder}.\n+     * Before launching the process, this method checks if {@link ProcessInheritIODisabled inherit IO is disabled}\n+     * and if so, streams both the {@code STDOUT} and {@code STDERR} of the launched process using\n+     * {@link #streamToSysOutSysErr(Process)}. Else, it launches the process with {@link ProcessBuilder#inheritIO()}\n+     *\n+     * @param builder The process builder\n+     * @param processInheritIODisabled Whether or not {@link java.lang.ProcessBuilder.Redirect#INHERIT} can be used for\n+     *        launching the process\n+     * @return Returns the newly launched process\n+     * @throws IOException\n+     */\n+    public static Process launchProcess(final ProcessBuilder builder,\n+            final Optional<ProcessInheritIODisabled> processInheritIODisabled) throws IOException {\n+        if (!processInheritIODisabled.isPresent()) {\n+            return builder.inheritIO().start();\n+        }\n+        final Process process = builder.redirectOutput(ProcessBuilder.Redirect.PIPE)\n+                .redirectError(ProcessBuilder.Redirect.PIPE)\n+                .start();\n+        // stream both stdout and stderr of the process\n+        ProcessUtil.streamToSysOutSysErr(process);", "originalCommit": "8d00d52cdc9b74fa34e96e153b27e3e6dc32c285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIxMzU0NA==", "url": "https://github.com/quarkusio/quarkus/pull/10137#discussion_r443213544", "bodyText": "Not unless the ProcessBuilder#redirectErrorStream(boolean) method is called.", "author": "jaikiran", "createdAt": "2020-06-21T12:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwNjY1Mg=="}], "type": "inlineReview"}, {"oid": "96825baf96884b709e09993a3bb11a523c94212d", "url": "https://github.com/quarkusio/quarkus/commit/96825baf96884b709e09993a3bb11a523c94212d", "message": "Workaround Gradle issue https://github.com/gradle/gradle/issues/13522\nExplicitly capture stdout/stderr of processes launched by build steps when run in the context of a Gradle build", "committedDate": "2020-06-21T13:28:18Z", "type": "commit"}, {"oid": "96825baf96884b709e09993a3bb11a523c94212d", "url": "https://github.com/quarkusio/quarkus/commit/96825baf96884b709e09993a3bb11a523c94212d", "message": "Workaround Gradle issue https://github.com/gradle/gradle/issues/13522\nExplicitly capture stdout/stderr of processes launched by build steps when run in the context of a Gradle build", "committedDate": "2020-06-21T13:28:18Z", "type": "forcePushed"}]}