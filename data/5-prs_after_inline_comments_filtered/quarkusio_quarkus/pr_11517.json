{"pr_number": 11517, "pr_title": "Improve robustness of our devtools Gradle code", "pr_createdAt": "2020-08-21T10:16:40Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11517", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxMzI5Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r474613293", "bodyText": "Can't you remove this from addDependencyInModel now that we check before?:\nif (buildContent.indexOf(newDependency) == -1) {", "author": "ia3andy", "createdAt": "2020-08-21T10:27:04Z", "path": "independent-projects/tools/devtools-common/src/main/java/io/quarkus/devtools/project/buildfile/AbstractGradleBuildFile.java", "diffHunk": "@@ -57,23 +56,17 @@ public void writeToDisk() throws IOException {\n         writeToProjectFile(getBuildGradlePath(), getModel().getBuildContent().getBytes());\n     }\n \n-    static String createDependencyCoordinatesString(Model model, AppArtifactCoords coords, boolean managed, char quoteChar) {\n-        boolean isBOM = \"pom\".equals(coords.getType());\n-        // Special case for platform dependency. We will create properties based dependency string.\n-        // It will be ignored if it is already in \"dependencies\" section.\n-        // Note that we ignore version here - if someone tries to add platform with different version, we will still use\n-        // version from properties.\n-        if (isBOM && !managed\n-                && Objects.equals(coords.getGroupId(), getProperty(model, \"quarkusPlatformGroupId\"))\n-                && Objects.equals(coords.getArtifactId(), getProperty(model, \"quarkusPlatformArtifactId\"))) {\n-            return \"enforcedPlatform(\\\"${quarkusPlatformGroupId}:${quarkusPlatformArtifactId}:${quarkusPlatformVersion}\\\")\";\n-        }\n+    static String createDependencyCoordinatesString(AppArtifactCoords coords, boolean managed, char quoteChar) {\n         StringBuilder newDependency = new StringBuilder().append(quoteChar)\n                 .append(coords.getGroupId()).append(\":\").append(coords.getArtifactId());\n         if (!managed &&\n                 (coords.getVersion() != null && !coords.getVersion().isEmpty())) {\n             newDependency.append(\":\").append(coords.getVersion());\n         }\n+        boolean isBOM = \"pom\".equals(coords.getType());\n+        if (isBOM && !managed) {\n+            return String.format(\"enforcedPlatform(%s)\", newDependency.append(quoteChar).toString());\n+        }\n         return newDependency.append(quoteChar).toString();\n     }\n ", "originalCommit": "d67b3b1ec9b5d6c32b3b474e13c8250ae7a6f25c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4MzE0MQ==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r475383141", "bodyText": "Yes, I think we can remove this check now.", "author": "mgorniew", "createdAt": "2020-08-24T07:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxMzI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM5NzI1Mg==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r475397252", "bodyText": "@mgorniew ok I am waiting for this PR to be \"ready for review\" with this change, let me know ;-)", "author": "ia3andy", "createdAt": "2020-08-24T07:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxMzI5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0NjAwOA==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r474746008", "bodyText": "If you are collecting platforms here, deploymentDeps isn't just the platforms (BOMs), it includes the extension deployment artifacts as well.", "author": "aloubyansky", "createdAt": "2020-08-21T14:48:11Z", "path": "devtools/gradle/src/main/java/io/quarkus/gradle/builder/QuarkusModelBuilder.java", "diffHunk": "@@ -101,7 +104,9 @@ public Object buildAll(String modelName, ModelParameter parameter, Project proje\n \n         return new QuarkusModelImpl(new WorkspaceImpl(appArtifactCoords, getWorkspace(project.getRootProject(), mode)),\n                 new LinkedList<>(appDependencies.values()),\n-                extensionDependencies);\n+                extensionDependencies,\n+                deploymentDeps.stream().map(QuarkusModelBuilder::toEnforcedPlatformDependency)\n+                        .filter(Objects::nonNull).collect(Collectors.toList()));", "originalCommit": "d67b3b1ec9b5d6c32b3b474e13c8250ae7a6f25c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQzMDU0NA==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476430544", "bodyText": "@aloubyansky I didn't really get what you mean here, @mgorniew maybe you did?", "author": "ia3andy", "createdAt": "2020-08-25T13:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0NjAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ2NDY2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476464661", "bodyText": "It looks ok now. Alternatively, @mgorniew getEnforcedPlatforms(project) at line 88 returns the enforced platforms. So at that point you could simply make a copy of that set.", "author": "aloubyansky", "createdAt": "2020-08-25T13:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0NjAwOA=="}], "type": "inlineReview"}, {"oid": "035c58305887e1c03e52fba4184dece8802319a0", "url": "https://github.com/quarkusio/quarkus/commit/035c58305887e1c03e52fba4184dece8802319a0", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-08-24T15:09:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MjM0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476242347", "bodyText": "@mgorniew why are we using org.apache.maven.model.Dependency here?", "author": "ia3andy", "createdAt": "2020-08-25T07:42:13Z", "path": "devtools/gradle/src/main/java/io/quarkus/gradle/ConnectorDependencyResolver.java", "diffHunk": "@@ -3,38 +3,37 @@\n import java.nio.file.Path;\n import java.util.Collections;\n import java.util.List;\n-import java.util.Objects;\n import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n \n import org.apache.maven.model.Dependency;\n import org.gradle.tooling.BuildException;\n-import org.gradle.tooling.GradleConnector;\n-import org.gradle.tooling.ProjectConnection;\n-import org.gradle.tooling.model.eclipse.EclipseExternalDependency;\n-import org.gradle.tooling.model.eclipse.EclipseProject;\n+\n+import io.quarkus.bootstrap.resolver.QuarkusGradleModelFactory;\n+import io.quarkus.bootstrap.resolver.model.QuarkusModel;\n+import io.quarkus.runtime.LaunchMode;\n \n public final class ConnectorDependencyResolver {\n \n     private List<Dependency> dependencies = null;", "originalCommit": "035c58305887e1c03e52fba4184dece8802319a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMxNTcxOQ==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476315719", "bodyText": "This is model used by io.quarkus.devtools.project.buildfile.BuildFile.", "author": "mgorniew", "createdAt": "2020-08-25T09:36:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MjM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMyMDMxMw==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476320313", "bodyText": "@mgorniew I think we can easily change that :) just remove getDependencies and have getDependenciesKeys abstract, and move the current getDependenciesKeys logic to the MavenBuildFile, then you can avoid this dependency in Gradle..", "author": "ia3andy", "createdAt": "2020-08-25T09:43:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MjM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1MjU0MA==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476352540", "bodyText": "AppArtifactKey doesn't contain version and there is getInstalled method which uses getDependencies to create AppArtifactCoords.", "author": "mgorniew", "createdAt": "2020-08-25T10:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MjM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NzI2NA==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476357264", "bodyText": "Then use AppArtifactCoords isnted of keys :)", "author": "ia3andy", "createdAt": "2020-08-25T10:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MjM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM2OTQxMg==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476369412", "bodyText": "The issue is that we are using Maven's model Dependency in QuarkusPlatformDescriptor. So either way, we are going to be converting unless we change it in QuarkusPlatformDescriptor and everywhere else.", "author": "aloubyansky", "createdAt": "2020-08-25T11:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MjM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3MDE1Mg==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476370152", "bodyText": "It could put a start to it though.", "author": "aloubyansky", "createdAt": "2020-08-25T11:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MjM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NDQyNg==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476374426", "bodyText": "Sure, I will change maven Dependency to AppArtifactCoords.", "author": "mgorniew", "createdAt": "2020-08-25T11:27:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MjM0Nw=="}], "type": "inlineReview"}, {"oid": "912b41ebd229a413baf7d0bd3966c34192771900", "url": "https://github.com/quarkusio/quarkus/commit/912b41ebd229a413baf7d0bd3966c34192771900", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-08-25T10:16:56Z", "type": "forcePushed"}, {"oid": "413759f81bb1f4466d1a11736a3e3ef9a49ec840", "url": "https://github.com/quarkusio/quarkus/commit/413759f81bb1f4466d1a11736a3e3ef9a49ec840", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-08-25T11:08:51Z", "type": "forcePushed"}, {"oid": "57ead0566f1c8315867b6b7bf168d60af62108ea", "url": "https://github.com/quarkusio/quarkus/commit/57ead0566f1c8315867b6b7bf168d60af62108ea", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-08-25T12:43:37Z", "type": "forcePushed"}, {"oid": "6617aee71880473ba0a2eafb1114b36cbc241986", "url": "https://github.com/quarkusio/quarkus/commit/6617aee71880473ba0a2eafb1114b36cbc241986", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-08-25T13:49:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4NDY2OA==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476484668", "bodyText": "We need to make this less brittle in the future (maybe regexp?)", "author": "gastaldi", "createdAt": "2020-08-25T14:17:29Z", "path": "integration-tests/devtools/src/test/java/io/quarkus/devtools/commands/AddGradleExtensionsTest.java", "diffHunk": "@@ -71,18 +70,26 @@ public TestingGradleBuildFile(Path projectDirPath, QuarkusPlatformDescriptor pla\n         }\n \n         @Override\n-        protected List<Dependency> getDependencies() throws IOException {\n+        protected List<AppArtifactCoords> getDependencies() throws IOException {\n             final Matcher matcher = Pattern.compile(\"\\\\s*implementation\\\\s+'([^\\\\v:]+):([^\\\\v:]+)(:[^:\\\\v]+)?'\")\n                     .matcher(getBuildContent());\n-            final ArrayList<Dependency> builder = new ArrayList<>();\n+            final ArrayList<AppArtifactCoords> builder = new ArrayList<>();\n             while (matcher.find()) {\n-                final Dependency dep = new Dependency();\n-                dep.setGroupId(matcher.group(1));\n-                dep.setArtifactId(matcher.group(2));\n-                dep.setVersion(matcher.group(3));\n-                builder.add(dep);\n+                builder.add(createDependency(matcher.group(1), matcher.group(2), matcher.group(3), \"jar\"));\n+            }\n+            if (getBuildContent().contains(\n+                    \"implementation enforcedPlatform(\\\"${quarkusPlatformGroupId}:${quarkusPlatformArtifactId}:${quarkusPlatformVersion}\\\")\")) {", "originalCommit": "6617aee71880473ba0a2eafb1114b36cbc241986", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5NTU5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476495592", "bodyText": "In the future it should NOT be checking for any specific property names at all.", "author": "aloubyansky", "createdAt": "2020-08-25T14:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4NDY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5NjkzNw==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r476496937", "bodyText": "Ah, it's a test, sorry. Ignore my comment above.", "author": "aloubyansky", "createdAt": "2020-08-25T14:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4NDY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA2MjQ4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r477062483", "bodyText": "@gastaldi this is just for testing ;-)", "author": "ia3andy", "createdAt": "2020-08-26T06:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4NDY2OA=="}], "type": "inlineReview"}, {"oid": "673b5740dfd6d7bbaac145a3d1deded09ddd6205", "url": "https://github.com/quarkusio/quarkus/commit/673b5740dfd6d7bbaac145a3d1deded09ddd6205", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-08-26T07:11:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA2MzQ3MA==", "url": "https://github.com/quarkusio/quarkus/pull/11517#discussion_r477063470", "bodyText": "@mgorniew maybe a regexp here?", "author": "ia3andy", "createdAt": "2020-08-26T06:29:16Z", "path": "independent-projects/tools/devtools-common/src/main/java/io/quarkus/devtools/project/buildfile/AbstractGradleBuildFile.java", "diffHunk": "@@ -57,46 +56,36 @@ public void writeToDisk() throws IOException {\n         writeToProjectFile(getBuildGradlePath(), getModel().getBuildContent().getBytes());\n     }\n \n-    static String createDependencyCoordinatesString(Model model, AppArtifactCoords coords, boolean managed, char quoteChar) {\n-        boolean isBOM = \"pom\".equals(coords.getType());\n-        // Special case for platform dependency. We will create properties based dependency string.\n-        // It will be ignored if it is already in \"dependencies\" section.\n-        // Note that we ignore version here - if someone tries to add platform with different version, we will still use\n-        // version from properties.\n-        if (isBOM && !managed\n-                && Objects.equals(coords.getGroupId(), getProperty(model, \"quarkusPlatformGroupId\"))\n-                && Objects.equals(coords.getArtifactId(), getProperty(model, \"quarkusPlatformArtifactId\"))) {\n-            return \"enforcedPlatform(\\\"${quarkusPlatformGroupId}:${quarkusPlatformArtifactId}:${quarkusPlatformVersion}\\\")\";\n-        }\n+    static String createDependencyCoordinatesString(AppArtifactCoords coords, boolean managed, char quoteChar) {\n         StringBuilder newDependency = new StringBuilder().append(quoteChar)\n                 .append(coords.getGroupId()).append(\":\").append(coords.getArtifactId());\n         if (!managed &&\n                 (coords.getVersion() != null && !coords.getVersion().isEmpty())) {\n             newDependency.append(\":\").append(coords.getVersion());\n         }\n+        boolean isBOM = \"pom\".equals(coords.getType());\n+        if (isBOM && !managed) {\n+            return String.format(\"enforcedPlatform(%s)\", newDependency.append(quoteChar).toString());\n+        }\n         return newDependency.append(quoteChar).toString();\n     }\n \n     static boolean addDependencyInModel(Model model, String newDependency) {\n         StringBuilder buildContent = new StringBuilder(model.getBuildContent());\n-        boolean changed = false;\n-        if (buildContent.indexOf(newDependency) == -1) {\n-            changed = true;\n-            // Add dependency after \"dependencies {\"\n-            int indexOfDeps = buildContent.indexOf(\"dependencies {\");\n-            if (indexOfDeps > -1) {\n-                // The line below fails on Windows if System.lineSeparator() is used\n-                int nextLine = buildContent.indexOf(\"\\n\", indexOfDeps) + 1;\n-                buildContent.insert(nextLine, newDependency);\n-            } else {\n-                // if no \"dependencies {\" found, add one\n-                buildContent.append(\"dependencies {\").append(System.lineSeparator())\n-                        .append(newDependency)\n-                        .append(\"}\").append(System.lineSeparator());\n-            }\n-            model.setBuildContent(buildContent.toString());\n+        // Add dependency after \"dependencies {\"\n+        int indexOfDeps = buildContent.indexOf(\"dependencies {\");\n+        if (indexOfDeps > -1) {", "originalCommit": "6617aee71880473ba0a2eafb1114b36cbc241986", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0e57c1dea787d1896cd2f7b8c1065b062945bdfa", "url": "https://github.com/quarkusio/quarkus/commit/0e57c1dea787d1896cd2f7b8c1065b062945bdfa", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-09-15T07:10:01Z", "type": "forcePushed"}, {"oid": "cddc27c2c3ab1d845e351460325c9a9df9ca640e", "url": "https://github.com/quarkusio/quarkus/commit/cddc27c2c3ab1d845e351460325c9a9df9ca640e", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-09-15T11:36:48Z", "type": "forcePushed"}, {"oid": "7f38fac2211e2f940eef1de5452fd1059fe0cf3b", "url": "https://github.com/quarkusio/quarkus/commit/7f38fac2211e2f940eef1de5452fd1059fe0cf3b", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-09-15T12:31:27Z", "type": "forcePushed"}, {"oid": "0a513f57e57aa6c937037377880c841a98f03349", "url": "https://github.com/quarkusio/quarkus/commit/0a513f57e57aa6c937037377880c841a98f03349", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-09-15T20:21:56Z", "type": "commit"}, {"oid": "0a513f57e57aa6c937037377880c841a98f03349", "url": "https://github.com/quarkusio/quarkus/commit/0a513f57e57aa6c937037377880c841a98f03349", "message": "Improve robustness of our devtools Gradle code", "committedDate": "2020-09-15T20:21:56Z", "type": "forcePushed"}]}