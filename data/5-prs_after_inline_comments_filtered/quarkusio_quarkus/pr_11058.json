{"pr_number": 11058, "pr_title": "Fix MongoClient handling in Mongo Panache", "pr_createdAt": "2020-07-29T11:26:53Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11058", "timeline": [{"oid": "4baaf0de586e5c62227bf67d23159657133c322c", "url": "https://github.com/quarkusio/quarkus/commit/4baaf0de586e5c62227bf67d23159657133c322c", "message": "Add tests for bug #10812", "committedDate": "2020-07-29T11:56:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI2MTU5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462261592", "bodyText": "Shouldn't it be a CombinedIndexBuildItem to allow defining entities inside a third party library ?", "author": "loicmathieu", "createdAt": "2020-07-29T12:31:17Z", "path": "extensions/panache/mongodb-panache/deployment/src/main/java/io/quarkus/mongodb/panache/deployment/PanacheMongoResourceProcessor.java", "diffHunk": "@@ -129,12 +133,28 @@ ReflectiveHierarchyBuildItem registerForReflection(CombinedIndexBuildItem index)\n     }\n \n     @BuildStep\n-    void unremoveableClients(BuildProducer<UnremovableBeanBuildItem> unremovable) {\n-        unremovable.produce(\n-                new UnremovableBeanBuildItem(\n-                        new UnremovableBeanBuildItem.BeanClassNamesExclusion(new HashSet<>(\n-                                Arrays.asList(MongoClient.class.getName(), ReactiveMongoClient.class.getName())))));\n+    void unremoveableClients(BuildProducer<MongoUnremovableClientsBuildItem> unremovable) {\n+        unremovable.produce(new MongoUnremovableClientsBuildItem());\n+    }\n \n+    @BuildStep\n+    public void mongoClientNames(ApplicationArchivesBuildItem applicationArchivesBuildItem,", "originalCommit": "4baaf0de586e5c62227bf67d23159657133c322c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3NTEyMw==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462275123", "bodyText": "I pretty much did what we already do for @MongoClientName, so I propose we keep it like this for now and change in both places if it comes up in the future.", "author": "geoand", "createdAt": "2020-07-29T12:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI2MTU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4OTQwMw==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462289403", "bodyText": "OK, if (when) and issue arise we could fix this later", "author": "loicmathieu", "createdAt": "2020-07-29T13:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI2MTU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI2MzYyMw==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462263623", "bodyText": "This should use the s parameter (better rename it key by the way) to avoid a synthetic accessor", "author": "loicmathieu", "createdAt": "2020-07-29T12:34:52Z", "path": "extensions/panache/mongodb-panache/runtime/src/main/java/io/quarkus/mongodb/panache/reactive/runtime/ReactiveMongoOperations.java", "diffHunk": "@@ -299,36 +301,34 @@ private static ReactiveMongoCollection mongoCollection(Object entity) {\n     }\n \n     private static ReactiveMongoDatabase mongoDatabase(MongoEntity entity) {\n-        ReactiveMongoClient mongoClient = mongoClient(entity);\n+        ReactiveMongoClient mongoClient = clientFromArc(entity, ReactiveMongoClient.class);\n         if (entity != null && !entity.database().isEmpty()) {\n             return mongoClient.getDatabase(entity.database());\n         }\n-        String databaseName = getDefaultDatabaseName();\n+        String databaseName = getDefaultDatabaseName(entity);\n         return mongoClient.getDatabase(databaseName);\n     }\n \n-    private static String getDefaultDatabaseName() {\n-        if (defaultDatabaseName == null) {\n-            synchronized (MongoOperations.class) {\n-                if (defaultDatabaseName == null) {\n-                    defaultDatabaseName = ConfigProvider.getConfig()\n-                            .getValue(MONGODB_DATABASE, String.class);\n+    private static String getDefaultDatabaseName(MongoEntity entity) {\n+        final String beanName = beanName(entity);\n+        return defaultDatabaseName.computeIfAbsent(beanName, new Function<String, String>() {\n+            @Override\n+            public String apply(String s) {\n+                MongoClients mongoClients = Arc.container().instance(MongoClients.class).get();\n+                MongoClientConfig matchingMongoClientConfig = mongoClients.getMatchingMongoClientConfig(beanName);", "originalCommit": "4baaf0de586e5c62227bf67d23159657133c322c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3Njc2OA==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462276768", "bodyText": "Good catch", "author": "geoand", "createdAt": "2020-07-29T12:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI2MzYyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI2ODIxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462268215", "bodyText": "I think we need to better explain what went wrong as the rules are a little complex. And don't forget that entity here can be null so at least you need to provides different error message in case an entity configuration exist (so you can add the name of the entity inside the error message) and none are set.\nNormally, if we are here, this means that no database is configured via the entity annotation so one must be set inside the application.properties, we shoud compute the needed property and log it.", "author": "loicmathieu", "createdAt": "2020-07-29T12:43:07Z", "path": "extensions/panache/mongodb-panache/runtime/src/main/java/io/quarkus/mongodb/panache/reactive/runtime/ReactiveMongoOperations.java", "diffHunk": "@@ -299,36 +301,34 @@ private static ReactiveMongoCollection mongoCollection(Object entity) {\n     }\n \n     private static ReactiveMongoDatabase mongoDatabase(MongoEntity entity) {\n-        ReactiveMongoClient mongoClient = mongoClient(entity);\n+        ReactiveMongoClient mongoClient = clientFromArc(entity, ReactiveMongoClient.class);\n         if (entity != null && !entity.database().isEmpty()) {\n             return mongoClient.getDatabase(entity.database());\n         }\n-        String databaseName = getDefaultDatabaseName();\n+        String databaseName = getDefaultDatabaseName(entity);\n         return mongoClient.getDatabase(databaseName);\n     }\n \n-    private static String getDefaultDatabaseName() {\n-        if (defaultDatabaseName == null) {\n-            synchronized (MongoOperations.class) {\n-                if (defaultDatabaseName == null) {\n-                    defaultDatabaseName = ConfigProvider.getConfig()\n-                            .getValue(MONGODB_DATABASE, String.class);\n+    private static String getDefaultDatabaseName(MongoEntity entity) {\n+        final String beanName = beanName(entity);\n+        return defaultDatabaseName.computeIfAbsent(beanName, new Function<String, String>() {\n+            @Override\n+            public String apply(String s) {\n+                MongoClients mongoClients = Arc.container().instance(MongoClients.class).get();\n+                MongoClientConfig matchingMongoClientConfig = mongoClients.getMatchingMongoClientConfig(beanName);\n+                if (matchingMongoClientConfig.database.isPresent()) {\n+                    return matchingMongoClientConfig.database.get();\n                 }\n-            }\n-        }\n-        return defaultDatabaseName;\n-    }\n \n-    private static ReactiveMongoClient mongoClient(MongoEntity entity) {\n-        if (entity != null && !entity.clientName().isEmpty()) {\n-            Set<Bean<?>> beans = Arc.container().beanManager().getBeans(ReactiveMongoClient.class);\n-            for (Bean<?> bean : beans) {\n-                if (bean.getName() != null) {\n-                    return (ReactiveMongoClient) Arc.container().instance(entity.clientName()).get();\n+                MongoClientConfig defaultMongoClientConfig = mongoClients\n+                        .getMatchingMongoClientConfig(MongoClientBeanUtil.DEFAULT_MONGOCLIENT_NAME);\n+                if (defaultMongoClientConfig.database.isPresent()) {\n+                    return defaultMongoClientConfig.database.get();\n                 }\n+\n+                throw new IllegalArgumentException(\"The database property was not configured for \" + entity);", "originalCommit": "4baaf0de586e5c62227bf67d23159657133c322c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3NjEwMA==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462276100", "bodyText": "Makes sense, I'll try and make it clearer", "author": "geoand", "createdAt": "2020-07-29T12:56:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI2ODIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5MTg2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462291863", "bodyText": "What do you think about it now?", "author": "geoand", "createdAt": "2020-07-29T13:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI2ODIxNQ=="}], "type": "inlineReview"}, {"oid": "bc4b23e39e2a748ee8785ef1dceff5b63fc43c91", "url": "https://github.com/quarkusio/quarkus/commit/bc4b23e39e2a748ee8785ef1dceff5b63fc43c91", "message": "Add tests for bug #10812", "committedDate": "2020-07-29T13:19:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5NzM1NA==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462297354", "bodyText": "Here MongoEntity is an annotation instance so I'll rename to something like this\nThe database attribute was not set for the @MongoEntity annotation and neither ...", "author": "loicmathieu", "createdAt": "2020-07-29T13:27:51Z", "path": "extensions/panache/mongodb-panache/runtime/src/main/java/io/quarkus/mongodb/panache/runtime/BeanUtils.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package io.quarkus.mongodb.panache.runtime;\n+\n+import java.lang.annotation.Annotation;\n+\n+import javax.enterprise.inject.Default;\n+import javax.enterprise.inject.literal.NamedLiteral;\n+import javax.enterprise.util.AnnotationLiteral;\n+import javax.inject.Named;\n+\n+import io.quarkus.arc.Arc;\n+import io.quarkus.arc.InjectableBean;\n+import io.quarkus.arc.InstanceHandle;\n+import io.quarkus.mongodb.panache.MongoEntity;\n+import io.quarkus.mongodb.runtime.MongoClientBeanUtil;\n+import io.quarkus.mongodb.runtime.MongoClientConfig;\n+import io.quarkus.mongodb.runtime.MongoClients;\n+\n+public final class BeanUtils {\n+\n+    private BeanUtils() {\n+    }\n+\n+    public static String beanName(MongoEntity entity) {\n+        if (entity != null && !entity.clientName().isEmpty()) {\n+            return entity.clientName();\n+        }\n+\n+        return MongoClientBeanUtil.DEFAULT_MONGOCLIENT_NAME;\n+    }\n+\n+    public static <T> T clientFromArc(MongoEntity entity, Class<T> clientClass) {\n+        T mongoClient = Arc.container().instance(clientClass, clientLiteral(beanName(entity))).get();\n+        if (mongoClient != null) {\n+            return mongoClient;\n+        }\n+\n+        if ((entity == null) || entity.clientName().isEmpty()) {\n+            // this case happens when there are multiple instances because they are all annotated with @Named\n+            for (InstanceHandle<T> handle : Arc.container().select(clientClass).handles()) {\n+                InjectableBean<T> bean = handle.getBean();\n+                boolean hasNamed = false;\n+                for (Annotation qualifier : bean.getQualifiers()) {\n+                    if (qualifier.annotationType().equals(Named.class)) {\n+                        hasNamed = true;\n+                    }\n+                }\n+                if (!hasNamed) {\n+                    return handle.get();\n+                }\n+            }\n+            throw new IllegalStateException(String.format(\"Unable to find default %s bean\", clientClass.getSimpleName()));\n+        } else {\n+            throw new IllegalStateException(\n+                    String.format(\"Unable to find %s bean for entity %s\", clientClass.getSimpleName(), entity.toString()));\n+        }\n+    }\n+\n+    @SuppressWarnings(\"rawtypes\")\n+    private static AnnotationLiteral clientLiteral(String name) {\n+        if (name.startsWith(MongoClientBeanUtil.DEFAULT_MONGOCLIENT_NAME)) {\n+            return Default.Literal.INSTANCE;\n+        }\n+        return NamedLiteral.of(name);\n+    }\n+\n+    public static String getDatabaseName(MongoEntity entity, String clientBeanName) {\n+        MongoClients mongoClients = Arc.container().instance(MongoClients.class).get();\n+        MongoClientConfig matchingMongoClientConfig = mongoClients.getMatchingMongoClientConfig(clientBeanName);\n+        if (matchingMongoClientConfig.database.isPresent()) {\n+            return matchingMongoClientConfig.database.get();\n+        }\n+\n+        if (!clientBeanName.equals(MongoClientBeanUtil.DEFAULT_MONGOCLIENT_NAME)) {\n+            MongoClientConfig defaultMongoClientConfig = mongoClients\n+                    .getMatchingMongoClientConfig(MongoClientBeanUtil.DEFAULT_MONGOCLIENT_NAME);\n+            if (defaultMongoClientConfig.database.isPresent()) {\n+                return defaultMongoClientConfig.database.get();\n+            }\n+        }\n+\n+        if (entity == null) {\n+            throw new IllegalArgumentException(\n+                    \"The database property was not configured for the default Mongo Client (via 'quarkus.mongodb.database'\");\n+        }\n+        if (entity.clientName().isEmpty()) {\n+            throw new IllegalArgumentException(\"The database method was not set for : \" + entity", "originalCommit": "bc4b23e39e2a748ee8785ef1dceff5b63fc43c91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMwMTI4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462301287", "bodyText": "Done", "author": "geoand", "createdAt": "2020-07-29T13:33:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5NzM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5NzYxNA==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462297614", "bodyText": "Same here I would rephrase to something like\nThe database attribute was not set for the @MongoEntity annotation and neither ...", "author": "loicmathieu", "createdAt": "2020-07-29T13:28:14Z", "path": "extensions/panache/mongodb-panache/runtime/src/main/java/io/quarkus/mongodb/panache/runtime/BeanUtils.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package io.quarkus.mongodb.panache.runtime;\n+\n+import java.lang.annotation.Annotation;\n+\n+import javax.enterprise.inject.Default;\n+import javax.enterprise.inject.literal.NamedLiteral;\n+import javax.enterprise.util.AnnotationLiteral;\n+import javax.inject.Named;\n+\n+import io.quarkus.arc.Arc;\n+import io.quarkus.arc.InjectableBean;\n+import io.quarkus.arc.InstanceHandle;\n+import io.quarkus.mongodb.panache.MongoEntity;\n+import io.quarkus.mongodb.runtime.MongoClientBeanUtil;\n+import io.quarkus.mongodb.runtime.MongoClientConfig;\n+import io.quarkus.mongodb.runtime.MongoClients;\n+\n+public final class BeanUtils {\n+\n+    private BeanUtils() {\n+    }\n+\n+    public static String beanName(MongoEntity entity) {\n+        if (entity != null && !entity.clientName().isEmpty()) {\n+            return entity.clientName();\n+        }\n+\n+        return MongoClientBeanUtil.DEFAULT_MONGOCLIENT_NAME;\n+    }\n+\n+    public static <T> T clientFromArc(MongoEntity entity, Class<T> clientClass) {\n+        T mongoClient = Arc.container().instance(clientClass, clientLiteral(beanName(entity))).get();\n+        if (mongoClient != null) {\n+            return mongoClient;\n+        }\n+\n+        if ((entity == null) || entity.clientName().isEmpty()) {\n+            // this case happens when there are multiple instances because they are all annotated with @Named\n+            for (InstanceHandle<T> handle : Arc.container().select(clientClass).handles()) {\n+                InjectableBean<T> bean = handle.getBean();\n+                boolean hasNamed = false;\n+                for (Annotation qualifier : bean.getQualifiers()) {\n+                    if (qualifier.annotationType().equals(Named.class)) {\n+                        hasNamed = true;\n+                    }\n+                }\n+                if (!hasNamed) {\n+                    return handle.get();\n+                }\n+            }\n+            throw new IllegalStateException(String.format(\"Unable to find default %s bean\", clientClass.getSimpleName()));\n+        } else {\n+            throw new IllegalStateException(\n+                    String.format(\"Unable to find %s bean for entity %s\", clientClass.getSimpleName(), entity.toString()));\n+        }\n+    }\n+\n+    @SuppressWarnings(\"rawtypes\")\n+    private static AnnotationLiteral clientLiteral(String name) {\n+        if (name.startsWith(MongoClientBeanUtil.DEFAULT_MONGOCLIENT_NAME)) {\n+            return Default.Literal.INSTANCE;\n+        }\n+        return NamedLiteral.of(name);\n+    }\n+\n+    public static String getDatabaseName(MongoEntity entity, String clientBeanName) {\n+        MongoClients mongoClients = Arc.container().instance(MongoClients.class).get();\n+        MongoClientConfig matchingMongoClientConfig = mongoClients.getMatchingMongoClientConfig(clientBeanName);\n+        if (matchingMongoClientConfig.database.isPresent()) {\n+            return matchingMongoClientConfig.database.get();\n+        }\n+\n+        if (!clientBeanName.equals(MongoClientBeanUtil.DEFAULT_MONGOCLIENT_NAME)) {\n+            MongoClientConfig defaultMongoClientConfig = mongoClients\n+                    .getMatchingMongoClientConfig(MongoClientBeanUtil.DEFAULT_MONGOCLIENT_NAME);\n+            if (defaultMongoClientConfig.database.isPresent()) {\n+                return defaultMongoClientConfig.database.get();\n+            }\n+        }\n+\n+        if (entity == null) {\n+            throw new IllegalArgumentException(\n+                    \"The database property was not configured for the default Mongo Client (via 'quarkus.mongodb.database'\");\n+        }\n+        if (entity.clientName().isEmpty()) {\n+            throw new IllegalArgumentException(\"The database method was not set for : \" + entity\n+                    + \" and neither was the database property configured for the default Mongo Client (via 'quarkus.mongodb.database')\");\n+        }\n+        throw new IllegalArgumentException(String.format(\n+                \"The database method was not set for : %s and neither was the database property configured for the named Mongo Client (via 'quarkus.mongodb.%s.database')\",", "originalCommit": "bc4b23e39e2a748ee8785ef1dceff5b63fc43c91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMwMTM5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/11058#discussion_r462301391", "bodyText": "Done", "author": "geoand", "createdAt": "2020-07-29T13:33:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5NzYxNA=="}], "type": "inlineReview"}, {"oid": "0974d72f5d7d4fc053c51821566b1e1523a40d06", "url": "https://github.com/quarkusio/quarkus/commit/0974d72f5d7d4fc053c51821566b1e1523a40d06", "message": "Fix default database handling in Mongo Panache\n\nFixes: #10812", "committedDate": "2020-07-29T13:33:03Z", "type": "commit"}, {"oid": "1d128cbbbb94443283e080a1b4f5b352836e9e44", "url": "https://github.com/quarkusio/quarkus/commit/1d128cbbbb94443283e080a1b4f5b352836e9e44", "message": "Add tests for bug #10812", "committedDate": "2020-07-29T13:33:03Z", "type": "commit"}, {"oid": "1d128cbbbb94443283e080a1b4f5b352836e9e44", "url": "https://github.com/quarkusio/quarkus/commit/1d128cbbbb94443283e080a1b4f5b352836e9e44", "message": "Add tests for bug #10812", "committedDate": "2020-07-29T13:33:03Z", "type": "forcePushed"}]}