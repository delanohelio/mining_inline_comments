{"pr_number": 11073, "pr_title": "Add a Micrometer extension", "pr_createdAt": "2020-07-30T01:16:00Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11073", "timeline": [{"oid": "62e5ac0badbcccaeb8f167daa39a150436337a60", "url": "https://github.com/quarkusio/quarkus/commit/62e5ac0badbcccaeb8f167daa39a150436337a60", "message": "hibernate-orm + micrometer", "committedDate": "2020-07-30T14:31:38Z", "type": "forcePushed"}, {"oid": "84d899a730e991a7c765264184c880fa7d453ea0", "url": "https://github.com/quarkusio/quarkus/commit/84d899a730e991a7c765264184c880fa7d453ea0", "message": "jaeger + micrometer", "committedDate": "2020-07-30T20:01:33Z", "type": "forcePushed"}, {"oid": "828acbd0b07b6da28dbdd648354a302c3b1c4b60", "url": "https://github.com/quarkusio/quarkus/commit/828acbd0b07b6da28dbdd648354a302c3b1c4b60", "message": "mongodb + micrometer", "committedDate": "2020-07-31T02:57:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0MDk5NA==", "url": "https://github.com/quarkusio/quarkus/pull/11073#discussion_r463640994", "bodyText": "Are there other exporters that we want to support in the future that have endpoints as well, or is it just Prometheus?", "author": "kenfinnigan", "createdAt": "2020-07-31T14:22:38Z", "path": "extensions/micrometer/deployment/src/main/java/io/quarkus/micrometer/deployment/MicrometerProcessor.java", "diffHunk": "@@ -0,0 +1,195 @@\n+package io.quarkus.micrometer.deployment;\n+\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.BooleanSupplier;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.ClassInfo;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.FieldInfo;\n+import org.jboss.jandex.IndexView;\n+import org.jboss.jandex.MethodInfo;\n+\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.binder.MeterBinder;\n+import io.micrometer.core.instrument.config.MeterFilter;\n+import io.micrometer.core.instrument.config.NamingConvention;\n+import io.quarkus.arc.deployment.AdditionalBeanBuildItem;\n+import io.quarkus.arc.deployment.BeanContainerBuildItem;\n+import io.quarkus.arc.deployment.UnremovableBeanBuildItem;\n+import io.quarkus.arc.processor.DotNames;\n+import io.quarkus.deployment.annotations.*;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.ShutdownContextBuildItem;\n+import io.quarkus.deployment.metrics.MetricsCapabilityBuildItem;\n+import io.quarkus.deployment.metrics.MetricsFactoryConsumerBuildItem;\n+import io.quarkus.micrometer.deployment.export.PrometheusRegistryProcessor;\n+import io.quarkus.micrometer.runtime.ClockProvider;\n+import io.quarkus.micrometer.runtime.CompositeRegistryCreator;\n+import io.quarkus.micrometer.runtime.MeterFilterConstraint;\n+import io.quarkus.micrometer.runtime.MeterFilterConstraints;\n+import io.quarkus.micrometer.runtime.MicrometerRecorder;\n+import io.quarkus.micrometer.runtime.config.MicrometerConfig;\n+import io.quarkus.runtime.RuntimeValue;\n+import io.quarkus.runtime.metrics.MetricsFactory;\n+\n+public class MicrometerProcessor {\n+    private static final DotName METER_REGISTRY = DotName.createSimple(MeterRegistry.class.getName());\n+    private static final DotName METER_BINDER = DotName.createSimple(MeterBinder.class.getName());\n+    private static final DotName METER_FILTER = DotName.createSimple(MeterFilter.class.getName());\n+    private static final DotName NAMING_CONVENTION = DotName.createSimple(NamingConvention.class.getName());\n+\n+    private static final String FEATURE = \"micrometer\";\n+\n+    static class MicrometerEnabled implements BooleanSupplier {\n+        MicrometerConfig mConfig;\n+\n+        public boolean getAsBoolean() {\n+            return mConfig.enabled;\n+        }\n+    }\n+\n+    MicrometerConfig mConfig;\n+\n+    @BuildStep(onlyIf = MicrometerEnabled.class)\n+    FeatureBuildItem feature() {\n+        return new FeatureBuildItem(FEATURE);\n+    }\n+\n+    @BuildStep(onlyIf = MicrometerEnabled.class, onlyIfNot = PrometheusRegistryProcessor.PrometheusEnabled.class)\n+    MetricsCapabilityBuildItem metricsCapabilityBuildItem() {\n+        return new MetricsCapabilityBuildItem(x -> MetricsFactory.MICROMETER.equals(x),\n+                null);", "originalCommit": "828acbd0b07b6da28dbdd648354a302c3b1c4b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczMTU5OA==", "url": "https://github.com/quarkusio/quarkus/pull/11073#discussion_r463731598", "bodyText": "I think the k8s stuff can only look for one scrape path... I left room here should a different registry extension provide one, but I think only prometheus will.", "author": "ebullient", "createdAt": "2020-07-31T17:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0MDk5NA=="}], "type": "inlineReview"}, {"oid": "cf0efcbde6b454bba3147400deb855506ecc76e1", "url": "https://github.com/quarkusio/quarkus/commit/cf0efcbde6b454bba3147400deb855506ecc76e1", "message": "mongodb + micrometer", "committedDate": "2020-07-31T18:08:08Z", "type": "forcePushed"}, {"oid": "89ba87f92570caab14abb10e6f8756ded3a06e43", "url": "https://github.com/quarkusio/quarkus/commit/89ba87f92570caab14abb10e6f8756ded3a06e43", "message": "mongodb + micrometer", "committedDate": "2020-07-31T21:13:29Z", "type": "forcePushed"}, {"oid": "50d1b2ebe1a449ac36f210bffb0cbfdebe81afd6", "url": "https://github.com/quarkusio/quarkus/commit/50d1b2ebe1a449ac36f210bffb0cbfdebe81afd6", "message": "mongodb + micrometer", "committedDate": "2020-08-03T13:29:19Z", "type": "forcePushed"}, {"oid": "2d461f3d25dcbbf2d80650c48a964c6f49985072", "url": "https://github.com/quarkusio/quarkus/commit/2d461f3d25dcbbf2d80650c48a964c6f49985072", "message": "mongodb + micrometer", "committedDate": "2020-08-03T18:29:01Z", "type": "forcePushed"}, {"oid": "501963997b905af0d935d364a493626d4e0ad352", "url": "https://github.com/quarkusio/quarkus/commit/501963997b905af0d935d364a493626d4e0ad352", "message": "mongodb + micrometer", "committedDate": "2020-08-04T18:27:30Z", "type": "forcePushed"}, {"oid": "57ff78cb1fb6949d4de779039ddb34917c65f629", "url": "https://github.com/quarkusio/quarkus/commit/57ff78cb1fb6949d4de779039ddb34917c65f629", "message": "mongodb + micrometer", "committedDate": "2020-08-12T18:41:47Z", "type": "forcePushed"}, {"oid": "38390e7ed3a634f48b982f28e42076dfb24f811f", "url": "https://github.com/quarkusio/quarkus/commit/38390e7ed3a634f48b982f28e42076dfb24f811f", "message": "Micrometer guide", "committedDate": "2020-08-13T02:26:34Z", "type": "forcePushed"}, {"oid": "c0e68107f20e9e1740c013d84d83ef36d09e5e19", "url": "https://github.com/quarkusio/quarkus/commit/c0e68107f20e9e1740c013d84d83ef36d09e5e19", "message": "Micrometer guide", "committedDate": "2020-08-28T04:31:50Z", "type": "forcePushed"}, {"oid": "9c870b3f0707e376d3e926e5feb0fd0fdddaa286", "url": "https://github.com/quarkusio/quarkus/commit/9c870b3f0707e376d3e926e5feb0fd0fdddaa286", "message": "Micrometer guide", "committedDate": "2020-08-28T06:20:41Z", "type": "forcePushed"}, {"oid": "27ff3c596fa71cb7cc0d256a320843b350358ccf", "url": "https://github.com/quarkusio/quarkus/commit/27ff3c596fa71cb7cc0d256a320843b350358ccf", "message": "Micrometer guide", "committedDate": "2020-08-28T11:57:04Z", "type": "forcePushed"}, {"oid": "3cd9b2b6fb296679827579a801979c2763c1a7b1", "url": "https://github.com/quarkusio/quarkus/commit/3cd9b2b6fb296679827579a801979c2763c1a7b1", "message": "native build", "committedDate": "2020-08-28T14:11:11Z", "type": "forcePushed"}, {"oid": "413852d1df3f3305f7611fa17d6265c1d5d19ebf", "url": "https://github.com/quarkusio/quarkus/commit/413852d1df3f3305f7611fa17d6265c1d5d19ebf", "message": "native build", "committedDate": "2020-08-28T15:23:57Z", "type": "forcePushed"}, {"oid": "867b25d37a2f1fbd50bdb53a31553a73c46f1d31", "url": "https://github.com/quarkusio/quarkus/commit/867b25d37a2f1fbd50bdb53a31553a73c46f1d31", "message": "native build", "committedDate": "2020-08-30T22:28:38Z", "type": "forcePushed"}, {"oid": "905d498cebf0403160955baa6ba685a595e96853", "url": "https://github.com/quarkusio/quarkus/commit/905d498cebf0403160955baa6ba685a595e96853", "message": "native build", "committedDate": "2020-08-31T01:15:56Z", "type": "forcePushed"}, {"oid": "c52bf48230ed768ed103b88b35ded0ba1eb19c93", "url": "https://github.com/quarkusio/quarkus/commit/c52bf48230ed768ed103b88b35ded0ba1eb19c93", "message": "native build", "committedDate": "2020-08-31T01:34:07Z", "type": "forcePushed"}, {"oid": "87a02d66f5bc553a560037e1c8c5bcb3a3343baa", "url": "https://github.com/quarkusio/quarkus/commit/87a02d66f5bc553a560037e1c8c5bcb3a3343baa", "message": "native build", "committedDate": "2020-08-31T01:38:03Z", "type": "forcePushed"}, {"oid": "170eef9bd26dfb3dd8ae4f78a29eb24b036c525c", "url": "https://github.com/quarkusio/quarkus/commit/170eef9bd26dfb3dd8ae4f78a29eb24b036c525c", "message": "native build", "committedDate": "2020-08-31T02:36:12Z", "type": "forcePushed"}, {"oid": "e0ed632b8c5364e9b0420fc59c95c9d304d1725f", "url": "https://github.com/quarkusio/quarkus/commit/e0ed632b8c5364e9b0420fc59c95c9d304d1725f", "message": "Micrometer guide", "committedDate": "2020-08-31T13:33:23Z", "type": "forcePushed"}, {"oid": "579aa76304e51b264e6cfd34681cec08f4238607", "url": "https://github.com/quarkusio/quarkus/commit/579aa76304e51b264e6cfd34681cec08f4238607", "message": "Micrometer extension\n\nEnable MP Metrics if API is present by default", "committedDate": "2020-08-31T15:46:38Z", "type": "commit"}, {"oid": "1d66915ca0546c3d5727e13f34db72fafc917ffd", "url": "https://github.com/quarkusio/quarkus/commit/1d66915ca0546c3d5727e13f34db72fafc917ffd", "message": "hibernate-orm + micrometer", "committedDate": "2020-08-31T15:46:38Z", "type": "commit"}, {"oid": "7b08f357e534cabdacd178ac5a4ac1ec91f55596", "url": "https://github.com/quarkusio/quarkus/commit/7b08f357e534cabdacd178ac5a4ac1ec91f55596", "message": "jaeger + micrometer", "committedDate": "2020-08-31T15:46:38Z", "type": "commit"}, {"oid": "3c8b3be56a61f48561ec42fac1bbf192d67337da", "url": "https://github.com/quarkusio/quarkus/commit/3c8b3be56a61f48561ec42fac1bbf192d67337da", "message": "mongodb + micrometer", "committedDate": "2020-08-31T15:46:38Z", "type": "commit"}, {"oid": "405a6f03ef3f0716706725e82e40dd61de6532a2", "url": "https://github.com/quarkusio/quarkus/commit/405a6f03ef3f0716706725e82e40dd61de6532a2", "message": "Micrometer guide", "committedDate": "2020-08-31T15:46:38Z", "type": "commit"}, {"oid": "405a6f03ef3f0716706725e82e40dd61de6532a2", "url": "https://github.com/quarkusio/quarkus/commit/405a6f03ef3f0716706725e82e40dd61de6532a2", "message": "Micrometer guide", "committedDate": "2020-08-31T15:46:38Z", "type": "forcePushed"}]}