{"pr_number": 9151, "pr_title": "Vastly simplify mailer CDI configuration", "pr_createdAt": "2020-05-07T11:27:16Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9151", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ3OTUwOQ==", "url": "https://github.com/quarkusio/quarkus/pull/9151#discussion_r421479509", "bodyText": "Let's drop the lambdas while we're at it?", "author": "gsmet", "createdAt": "2020-05-07T12:53:04Z", "path": "extensions/mailer/runtime/src/main/java/io/quarkus/mailer/runtime/MailClientProducer.java", "diffHunk": "@@ -16,52 +20,74 @@\n \n     private static final Logger LOGGER = Logger.getLogger(MailClientProducer.class);\n \n-    private io.vertx.axle.ext.mail.MailClient axleMailClient;\n-    private io.vertx.reactivex.ext.mail.MailClient rxMailClient;\n-    private io.vertx.mutiny.ext.mail.MailClient mutinyClient;\n-    private MailClient client;\n+    private final io.vertx.mutiny.ext.mail.MailClient mutinyClient;\n+    private final MailClient client;\n \n-    synchronized void initialize(MailClient client) {\n-        this.client = client;\n-        this.mutinyClient = io.vertx.mutiny.ext.mail.MailClient.newInstance(client);\n+    public MailClientProducer(Vertx vertx, MailConfig config) {\n+        this.client = mailClient(vertx, config);\n+        this.mutinyClient = io.vertx.mutiny.ext.mail.MailClient.newInstance(this.client);\n     }\n \n     @Singleton\n     @Produces\n-    public synchronized MailClient mailClient() {\n+    public MailClient mailClient() {\n         return client;\n     }\n \n     @Singleton\n     @Produces\n-    public synchronized io.vertx.mutiny.ext.mail.MailClient mutinyClient() {\n+    public io.vertx.mutiny.ext.mail.MailClient mutinyClient() {\n         return mutinyClient;\n     }\n \n     @Singleton\n     @Produces\n     @Deprecated\n-    public synchronized io.vertx.axle.ext.mail.MailClient axleMailClient() {\n-        if (axleMailClient == null) {\n-            LOGGER.warn(\n-                    \"`io.vertx.axle.ext.mail.MailClient` is deprecated and will be removed in a future version - it is \"\n-                            + \"recommended to switch to `io.vertx.mutiny.ext.mail.MailClient`\");\n-            axleMailClient = io.vertx.axle.ext.mail.MailClient.newInstance(client);\n-        }\n-        return axleMailClient;\n+    public io.vertx.axle.ext.mail.MailClient axleMailClient() {\n+        LOGGER.warn(\n+                \"`io.vertx.axle.ext.mail.MailClient` is deprecated and will be removed in a future version - it is \"\n+                        + \"recommended to switch to `io.vertx.mutiny.ext.mail.MailClient`\");\n+        return io.vertx.axle.ext.mail.MailClient.newInstance(client);\n     }\n \n     @Singleton\n     @Produces\n     @Deprecated\n-    public synchronized io.vertx.reactivex.ext.mail.MailClient rxMailClient() {\n-        if (rxMailClient == null) {\n-            LOGGER.warn(\n-                    \"`io.vertx.reactivex.ext.mail.MailClient` is deprecated and will be removed in a future version - it is \"\n-                            + \"recommended to switch to `io.vertx.mutiny.ext.mail.MailClient`\");\n-            rxMailClient = io.vertx.reactivex.ext.mail.MailClient.newInstance(client);\n-        }\n-        return rxMailClient;\n+    public io.vertx.reactivex.ext.mail.MailClient rxMailClient() {\n+        LOGGER.warn(\n+                \"`io.vertx.reactivex.ext.mail.MailClient` is deprecated and will be removed in a future version - it is \"\n+                        + \"recommended to switch to `io.vertx.mutiny.ext.mail.MailClient`\");\n+        return io.vertx.reactivex.ext.mail.MailClient.newInstance(client);\n+    }\n+\n+    @PreDestroy\n+    public void stop() {\n+        client.close();\n+    }\n+\n+    private MailClient mailClient(Vertx vertx, MailConfig config) {\n+        io.vertx.ext.mail.MailConfig cfg = toVertxMailConfig(config);\n+        return MailClient.createShared(vertx, cfg);\n+    }\n+\n+    private io.vertx.ext.mail.MailConfig toVertxMailConfig(MailConfig config) {\n+        io.vertx.ext.mail.MailConfig cfg = new io.vertx.ext.mail.MailConfig();\n+        config.authMethods.ifPresent(cfg::setAuthMethods);\n+        cfg.setDisableEsmtp(config.disableEsmtp);\n+        cfg.setHostname(config.host);\n+        cfg.setKeepAlive(config.keepAlive);\n+        config.keyStore.ifPresent(cfg::setKeyStore);\n+        config.keyStorePassword.ifPresent(cfg::setKeyStorePassword);\n+        config.login.ifPresent(s -> cfg.setLogin(LoginOption.valueOf(s.toUpperCase())));\n+        config.maxPoolSize.ifPresent(cfg::setMaxPoolSize);\n+        config.ownHostName.ifPresent(cfg::setOwnHostname);\n+        config.username.ifPresent(cfg::setUsername);\n+        config.password.ifPresent(cfg::setPassword);\n+        config.port.ifPresent(cfg::setPort);\n+        cfg.setSsl(config.ssl);\n+        config.startTLS.ifPresent(s -> cfg.setStarttls(StartTLSOptions.valueOf(s.toUpperCase())));\n+        cfg.setTrustAll(config.trustAll);", "originalCommit": "8fca03aaf9d8a60f2d6a668d3c3c49790bbd8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ4NDExOA==", "url": "https://github.com/quarkusio/quarkus/pull/9151#discussion_r421484118", "bodyText": "Sure, I'll do that once I get back to this PR :)", "author": "geoand", "createdAt": "2020-05-07T12:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ3OTUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ4MjEwNg==", "url": "https://github.com/quarkusio/quarkus/pull/9151#discussion_r421482106", "bodyText": "So when you add the mailer extension, this is mandatory and things will fail if undefined? It's a bit different than for the other extensions.\nNot related to this patch but I wonder if we should revisit this at some point.", "author": "gsmet", "createdAt": "2020-05-07T12:56:58Z", "path": "extensions/mailer/runtime/src/main/java/io/quarkus/mailer/runtime/MailClientProducer.java", "diffHunk": "@@ -16,52 +20,74 @@\n \n     private static final Logger LOGGER = Logger.getLogger(MailClientProducer.class);\n \n-    private io.vertx.axle.ext.mail.MailClient axleMailClient;\n-    private io.vertx.reactivex.ext.mail.MailClient rxMailClient;\n-    private io.vertx.mutiny.ext.mail.MailClient mutinyClient;\n-    private MailClient client;\n+    private final io.vertx.mutiny.ext.mail.MailClient mutinyClient;\n+    private final MailClient client;\n \n-    synchronized void initialize(MailClient client) {\n-        this.client = client;\n-        this.mutinyClient = io.vertx.mutiny.ext.mail.MailClient.newInstance(client);\n+    public MailClientProducer(Vertx vertx, MailConfig config) {\n+        this.client = mailClient(vertx, config);\n+        this.mutinyClient = io.vertx.mutiny.ext.mail.MailClient.newInstance(this.client);\n     }\n \n     @Singleton\n     @Produces\n-    public synchronized MailClient mailClient() {\n+    public MailClient mailClient() {\n         return client;\n     }\n \n     @Singleton\n     @Produces\n-    public synchronized io.vertx.mutiny.ext.mail.MailClient mutinyClient() {\n+    public io.vertx.mutiny.ext.mail.MailClient mutinyClient() {\n         return mutinyClient;\n     }\n \n     @Singleton\n     @Produces\n     @Deprecated\n-    public synchronized io.vertx.axle.ext.mail.MailClient axleMailClient() {\n-        if (axleMailClient == null) {\n-            LOGGER.warn(\n-                    \"`io.vertx.axle.ext.mail.MailClient` is deprecated and will be removed in a future version - it is \"\n-                            + \"recommended to switch to `io.vertx.mutiny.ext.mail.MailClient`\");\n-            axleMailClient = io.vertx.axle.ext.mail.MailClient.newInstance(client);\n-        }\n-        return axleMailClient;\n+    public io.vertx.axle.ext.mail.MailClient axleMailClient() {\n+        LOGGER.warn(\n+                \"`io.vertx.axle.ext.mail.MailClient` is deprecated and will be removed in a future version - it is \"\n+                        + \"recommended to switch to `io.vertx.mutiny.ext.mail.MailClient`\");\n+        return io.vertx.axle.ext.mail.MailClient.newInstance(client);\n     }\n \n     @Singleton\n     @Produces\n     @Deprecated\n-    public synchronized io.vertx.reactivex.ext.mail.MailClient rxMailClient() {\n-        if (rxMailClient == null) {\n-            LOGGER.warn(\n-                    \"`io.vertx.reactivex.ext.mail.MailClient` is deprecated and will be removed in a future version - it is \"\n-                            + \"recommended to switch to `io.vertx.mutiny.ext.mail.MailClient`\");\n-            rxMailClient = io.vertx.reactivex.ext.mail.MailClient.newInstance(client);\n-        }\n-        return rxMailClient;\n+    public io.vertx.reactivex.ext.mail.MailClient rxMailClient() {\n+        LOGGER.warn(\n+                \"`io.vertx.reactivex.ext.mail.MailClient` is deprecated and will be removed in a future version - it is \"\n+                        + \"recommended to switch to `io.vertx.mutiny.ext.mail.MailClient`\");\n+        return io.vertx.reactivex.ext.mail.MailClient.newInstance(client);\n+    }\n+\n+    @PreDestroy\n+    public void stop() {\n+        client.close();\n+    }\n+\n+    private MailClient mailClient(Vertx vertx, MailConfig config) {\n+        io.vertx.ext.mail.MailConfig cfg = toVertxMailConfig(config);\n+        return MailClient.createShared(vertx, cfg);\n+    }\n+\n+    private io.vertx.ext.mail.MailConfig toVertxMailConfig(MailConfig config) {\n+        io.vertx.ext.mail.MailConfig cfg = new io.vertx.ext.mail.MailConfig();\n+        config.authMethods.ifPresent(cfg::setAuthMethods);\n+        cfg.setDisableEsmtp(config.disableEsmtp);\n+        cfg.setHostname(config.host);", "originalCommit": "8fca03aaf9d8a60f2d6a668d3c3c49790bbd8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ4NDM2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/9151#discussion_r421484361", "bodyText": "I would prefer not touch that now TBH", "author": "geoand", "createdAt": "2020-05-07T13:00:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ4MjEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzMjU3OA==", "url": "https://github.com/quarkusio/quarkus/pull/9151#discussion_r421532578", "bodyText": "Yeah agreed, thus the \"at some point\". We probably need to discuss that before changing anything.", "author": "gsmet", "createdAt": "2020-05-07T14:07:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ4MjEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzMzA5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/9151#discussion_r421533099", "bodyText": "\ud83d\udc4d", "author": "geoand", "createdAt": "2020-05-07T14:08:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ4MjEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUwMjY3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/9151#discussion_r421502677", "bodyText": "AFAIK it's possible to inject both the config object and the LaunchMode so there is no need to register a synthetic bean, or?", "author": "mkouba", "createdAt": "2020-05-07T13:27:44Z", "path": "extensions/mailer/deployment/src/main/java/io/quarkus/mailer/deployment/MailerProcessor.java", "diffHunk": "@@ -75,18 +74,17 @@ void registerAuthClass(BuildProducer<ReflectiveClassBuildItem> reflectiveClass)\n \n     @BuildStep\n     @Record(ExecutionTime.RUNTIME_INIT)\n-    MailerBuildItem build(BuildProducer<FeatureBuildItem> feature, MailConfigRecorder recorder, VertxBuildItem vertx,\n-            BeanContainerBuildItem beanContainer, LaunchModeBuildItem launchMode, ShutdownContextBuildItem shutdown,\n-            MailConfig config) {\n+    void build(BuildProducer<FeatureBuildItem> feature, MailConfigRecorder recorder,\n+            MailConfig config, LaunchModeBuildItem launchMode,\n+            BuildProducer<SyntheticBeanBuildItem> syntheticBeanBuildItemBuildProducer) {\n \n         feature.produce(new FeatureBuildItem(FeatureBuildItem.MAILER));\n \n-        RuntimeValue<MailClient> client = recorder.configureTheClient(vertx.getVertx(), beanContainer.getValue(), config,\n-                shutdown);\n-\n-        recorder.configureTheMailer(beanContainer.getValue(), config, launchMode.getLaunchMode());\n-\n-        return new MailerBuildItem(client);\n+        syntheticBeanBuildItemBuildProducer.produce(SyntheticBeanBuildItem.configure(MailerSupport.class)\n+                .scope(Singleton.class)\n+                .supplier(recorder.mailerSupportSupplier(config, launchMode.getLaunchMode()))", "originalCommit": "8fca03aaf9d8a60f2d6a668d3c3c49790bbd8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUxMDM5NA==", "url": "https://github.com/quarkusio/quarkus/pull/9151#discussion_r421510394", "bodyText": "Ah yes, I forgot that LaunchMode is also a bean, excellent!", "author": "geoand", "createdAt": "2020-05-07T13:38:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUwMjY3Nw=="}], "type": "inlineReview"}, {"oid": "92fe692f1a6438645c0891d21455f7d6187d8395", "url": "https://github.com/quarkusio/quarkus/commit/92fe692f1a6438645c0891d21455f7d6187d8395", "message": "Vastly simplify mailer CDI configuration", "committedDate": "2020-05-07T13:38:11Z", "type": "commit"}, {"oid": "015a57fff3372208e36fe266f655b9ff0bfeadab", "url": "https://github.com/quarkusio/quarkus/commit/015a57fff3372208e36fe266f655b9ff0bfeadab", "message": "Remove lambdas from MailClientProducer", "committedDate": "2020-05-07T13:38:11Z", "type": "commit"}, {"oid": "015a57fff3372208e36fe266f655b9ff0bfeadab", "url": "https://github.com/quarkusio/quarkus/commit/015a57fff3372208e36fe266f655b9ff0bfeadab", "message": "Remove lambdas from MailClientProducer", "committedDate": "2020-05-07T13:38:11Z", "type": "forcePushed"}]}