{"pr_number": 9182, "pr_title": "Added support to register nested classes and reflection via classNames", "pr_createdAt": "2020-05-08T15:37:44Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9182", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NzAyMA==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422457020", "bodyText": "You can just use toString() here on the result of name()", "author": "geoand", "createdAt": "2020-05-09T05:59:33Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/RegisterForReflectionBuildStep.java", "diffHunk": "@@ -30,18 +33,48 @@\n     public void build() throws Exception {\n         for (AnnotationInstance i : combinedIndexBuildItem.getIndex()\n                 .getAnnotations(DotName.createSimple(RegisterForReflection.class.getName()))) {\n-            ClassInfo target = i.target().asClass();\n+\n             boolean methods = i.value(\"methods\") == null || i.value(\"methods\").asBoolean();\n             boolean fields = i.value(\"fields\") == null || i.value(\"fields\").asBoolean();\n+\n             AnnotationValue targetsValue = i.value(\"targets\");\n-            if (targetsValue == null) {\n+            AnnotationValue namesValue = i.value(\"names\");\n+\n+            if (targetsValue == null && namesValue == null) {\n+                ClassInfo target = i.target().asClass();\n                 reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, target.name().toString()));\n-            } else {\n+                return;\n+            }\n+\n+            Set<String> classNames = new HashSet<>();\n+            if (targetsValue != null) {\n                 Type[] targets = targetsValue.asClassArray();\n                 for (Type type : targets) {\n-                    reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, type.name().toString()));\n+                    classNames.add(String.valueOf(type.name()));", "originalCommit": "f9d0cf5e68cd415ad9b9b73c787bab961aa6b9f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NzExOA==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422457118", "bodyText": "Why the check here?", "author": "geoand", "createdAt": "2020-05-09T06:00:59Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/RegisterForReflectionBuildStep.java", "diffHunk": "@@ -30,18 +33,48 @@\n     public void build() throws Exception {\n         for (AnnotationInstance i : combinedIndexBuildItem.getIndex()\n                 .getAnnotations(DotName.createSimple(RegisterForReflection.class.getName()))) {\n-            ClassInfo target = i.target().asClass();\n+\n             boolean methods = i.value(\"methods\") == null || i.value(\"methods\").asBoolean();\n             boolean fields = i.value(\"fields\") == null || i.value(\"fields\").asBoolean();\n+\n             AnnotationValue targetsValue = i.value(\"targets\");\n-            if (targetsValue == null) {\n+            AnnotationValue namesValue = i.value(\"names\");\n+\n+            if (targetsValue == null && namesValue == null) {\n+                ClassInfo target = i.target().asClass();\n                 reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, target.name().toString()));\n-            } else {\n+                return;\n+            }\n+\n+            Set<String> classNames = new HashSet<>();\n+            if (targetsValue != null) {\n                 Type[] targets = targetsValue.asClassArray();\n                 for (Type type : targets) {\n-                    reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, type.name().toString()));\n+                    classNames.add(String.valueOf(type.name()));\n+                }\n+            }\n+\n+            if (namesValue != null) {\n+                String[] names = namesValue.asStringArray();\n+                for (String name : names) {\n+                    if (isClass(name)) {", "originalCommit": "f9d0cf5e68cd415ad9b9b73c787bab961aa6b9f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NDg4MQ==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422464881", "bodyText": "Wasn't sure how the handling is done afterwards, hence added a validation check. I've removed the validation as per your suggestion.", "author": "lower-case", "createdAt": "2020-05-09T07:39:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NzExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NjY4NA==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422466684", "bodyText": "\ud83d\udc4d", "author": "geoand", "createdAt": "2020-05-09T07:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NzExOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NzIyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422457225", "bodyText": "If you absolutely do need to load a class in a Quarkus build step, you should use the Thread Context Classloader.", "author": "geoand", "createdAt": "2020-05-09T06:02:26Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/RegisterForReflectionBuildStep.java", "diffHunk": "@@ -30,18 +33,48 @@\n     public void build() throws Exception {\n         for (AnnotationInstance i : combinedIndexBuildItem.getIndex()\n                 .getAnnotations(DotName.createSimple(RegisterForReflection.class.getName()))) {\n-            ClassInfo target = i.target().asClass();\n+\n             boolean methods = i.value(\"methods\") == null || i.value(\"methods\").asBoolean();\n             boolean fields = i.value(\"fields\") == null || i.value(\"fields\").asBoolean();\n+\n             AnnotationValue targetsValue = i.value(\"targets\");\n-            if (targetsValue == null) {\n+            AnnotationValue namesValue = i.value(\"names\");\n+\n+            if (targetsValue == null && namesValue == null) {\n+                ClassInfo target = i.target().asClass();\n                 reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, target.name().toString()));\n-            } else {\n+                return;\n+            }\n+\n+            Set<String> classNames = new HashSet<>();\n+            if (targetsValue != null) {\n                 Type[] targets = targetsValue.asClassArray();\n                 for (Type type : targets) {\n-                    reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, type.name().toString()));\n+                    classNames.add(String.valueOf(type.name()));\n+                }\n+            }\n+\n+            if (namesValue != null) {\n+                String[] names = namesValue.asStringArray();\n+                for (String name : names) {\n+                    if (isClass(name)) {\n+                        classNames.add(name);\n+                    }\n                 }\n             }\n+\n+            for (String className : classNames) {\n+                reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, className));\n+            }\n+        }\n+    }\n+\n+    private boolean isClass(String className) {\n+        try {\n+            Class.forName(className, false, getClass().getClassLoader());", "originalCommit": "f9d0cf5e68cd415ad9b9b73c787bab961aa6b9f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NzI1Ng==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422457256", "bodyText": "Perhaps calling it classNames would be better?", "author": "geoand", "createdAt": "2020-05-09T06:03:00Z", "path": "core/runtime/src/main/java/io/quarkus/runtime/annotations/RegisterForReflection.java", "diffHunk": "@@ -30,4 +30,11 @@\n      * generally just be placed on an empty class that is not otherwise used.\n      */\n     Class<?>[] targets() default {};\n+\n+    /**\n+     *\n+     * This allows for classes to be registered via class names. This was introduced to add the facility to\n+     * register private classes for Reflection.\n+     */\n+    String[] names() default {};", "originalCommit": "f9d0cf5e68cd415ad9b9b73c787bab961aa6b9f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NzM3NA==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422457374", "bodyText": "If we are going to load classes (I assume to make things safer for users, we should at least be logging when the load failed.\nBut as I said above, I don't really see much point in this type of validation)", "author": "geoand", "createdAt": "2020-05-09T06:04:25Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/RegisterForReflectionBuildStep.java", "diffHunk": "@@ -30,18 +33,48 @@\n     public void build() throws Exception {\n         for (AnnotationInstance i : combinedIndexBuildItem.getIndex()\n                 .getAnnotations(DotName.createSimple(RegisterForReflection.class.getName()))) {\n-            ClassInfo target = i.target().asClass();\n+\n             boolean methods = i.value(\"methods\") == null || i.value(\"methods\").asBoolean();\n             boolean fields = i.value(\"fields\") == null || i.value(\"fields\").asBoolean();\n+\n             AnnotationValue targetsValue = i.value(\"targets\");\n-            if (targetsValue == null) {\n+            AnnotationValue namesValue = i.value(\"names\");\n+\n+            if (targetsValue == null && namesValue == null) {\n+                ClassInfo target = i.target().asClass();\n                 reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, target.name().toString()));\n-            } else {\n+                return;\n+            }\n+\n+            Set<String> classNames = new HashSet<>();\n+            if (targetsValue != null) {\n                 Type[] targets = targetsValue.asClassArray();\n                 for (Type type : targets) {\n-                    reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, type.name().toString()));\n+                    classNames.add(String.valueOf(type.name()));\n+                }\n+            }\n+\n+            if (namesValue != null) {\n+                String[] names = namesValue.asStringArray();\n+                for (String name : names) {\n+                    if (isClass(name)) {\n+                        classNames.add(name);\n+                    }\n                 }\n             }\n+\n+            for (String className : classNames) {\n+                reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, className));\n+            }\n+        }\n+    }\n+\n+    private boolean isClass(String className) {\n+        try {\n+            Class.forName(className, false, getClass().getClassLoader());\n+            return true;\n+        } catch (ClassNotFoundException e) {\n+            return false;", "originalCommit": "f9d0cf5e68cd415ad9b9b73c787bab961aa6b9f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NDkzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422464935", "bodyText": "Removed the Validation, This won't be required now.", "author": "lower-case", "createdAt": "2020-05-09T07:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NzM3NA=="}], "type": "inlineReview"}, {"oid": "b14798cc3dd0ea4d9f539f88bfab72e75d107caa", "url": "https://github.com/quarkusio/quarkus/commit/b14798cc3dd0ea4d9f539f88bfab72e75d107caa", "message": "9109 | Added support for registering for Reflection  via classNames", "committedDate": "2020-05-09T07:36:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NjY1Mw==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422466653", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * This allows for classes to be registered via class names. This was introduced to add the facility to\n          \n          \n            \n                 * This allows for classes to be registered for reflection via class names. This is useful when it's necessary to", "author": "geoand", "createdAt": "2020-05-09T07:59:17Z", "path": "core/runtime/src/main/java/io/quarkus/runtime/annotations/RegisterForReflection.java", "diffHunk": "@@ -30,4 +30,10 @@\n      * generally just be placed on an empty class that is not otherwise used.\n      */\n     Class<?>[] targets() default {};\n+\n+    /**\n+     * This allows for classes to be registered via class names. This was introduced to add the facility to", "originalCommit": "b14798cc3dd0ea4d9f539f88bfab72e75d107caa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2f9430853c83fcef6eed55fc7e0381b68bda5538", "url": "https://github.com/quarkusio/quarkus/commit/2f9430853c83fcef6eed55fc7e0381b68bda5538", "message": "9109 | Added support for registering for Reflection  via classNames", "committedDate": "2020-05-09T08:23:56Z", "type": "forcePushed"}, {"oid": "a803c0762f0063378c60fe8416ac7742f3aa0011", "url": "https://github.com/quarkusio/quarkus/commit/a803c0762f0063378c60fe8416ac7742f3aa0011", "message": "Added support for registering for Reflection  via classNames", "committedDate": "2020-05-09T08:24:26Z", "type": "forcePushed"}, {"oid": "02b1395152736223747e1ef20000be8b34ee666b", "url": "https://github.com/quarkusio/quarkus/commit/02b1395152736223747e1ef20000be8b34ee666b", "message": "Added support for registering nested classes and reflection via classNames", "committedDate": "2020-05-10T06:13:23Z", "type": "forcePushed"}, {"oid": "6c580f13a45d0df6c3c605b7480cf4c776c5ba92", "url": "https://github.com/quarkusio/quarkus/commit/6c580f13a45d0df6c3c605b7480cf4c776c5ba92", "message": "Added support for registering nested classes and reflection via classNames", "committedDate": "2020-05-10T06:35:48Z", "type": "forcePushed"}, {"oid": "45a5f22c9cd7f12cfd411f0498b632a627473895", "url": "https://github.com/quarkusio/quarkus/commit/45a5f22c9cd7f12cfd411f0498b632a627473895", "message": "Added support for registering nested classes and reflection via classNames", "committedDate": "2020-05-10T06:52:47Z", "type": "forcePushed"}, {"oid": "c62011bdbc8deb2aabca7975b6395bad109c61f4", "url": "https://github.com/quarkusio/quarkus/commit/c62011bdbc8deb2aabca7975b6395bad109c61f4", "message": "Added support for registering nested classes and reflection via classNames", "committedDate": "2020-05-10T09:14:36Z", "type": "forcePushed"}, {"oid": "5399d8b5acca43ee3a4ece5509479ad59ea1bef4", "url": "https://github.com/quarkusio/quarkus/commit/5399d8b5acca43ee3a4ece5509479ad59ea1bef4", "message": "Added support for registering nested classes and reflection via classNames", "committedDate": "2020-05-10T09:20:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYyMDkyNA==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422620924", "bodyText": "Please remove these comments", "author": "geoand", "createdAt": "2020-05-10T10:01:41Z", "path": "integration-tests/main/src/main/java/io/quarkus/it/runtime/ReflectionResource.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package io.quarkus.it.runtime;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.QueryParam;\n+\n+/**\n+ * User : lovekeshgarg", "originalCommit": "5399d8b5acca43ee3a4ece5509479ad59ea1bef4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "af10c503f589533938860b5625ee3c7b1a93085d", "url": "https://github.com/quarkusio/quarkus/commit/af10c503f589533938860b5625ee3c7b1a93085d", "message": "Added support for registering nested classes and reflection via classNames", "committedDate": "2020-05-10T11:51:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY0MDcxMw==", "url": "https://github.com/quarkusio/quarkus/pull/9182#discussion_r422640713", "bodyText": "Actually, this should probably be a warning, not an error", "author": "geoand", "createdAt": "2020-05-10T12:44:27Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/RegisterForReflectionBuildStep.java", "diffHunk": "@@ -27,22 +26,62 @@\n     CombinedIndexBuildItem combinedIndexBuildItem;\n \n     @BuildStep\n-    public void build() throws Exception {\n+    public void build() {\n         for (AnnotationInstance i : combinedIndexBuildItem.getIndex()\n                 .getAnnotations(DotName.createSimple(RegisterForReflection.class.getName()))) {\n-            ClassInfo target = i.target().asClass();\n-            boolean methods = i.value(\"methods\") == null || i.value(\"methods\").asBoolean();\n-            boolean fields = i.value(\"fields\") == null || i.value(\"fields\").asBoolean();\n+\n+            boolean methods = getBooleanValue(i, \"methods\");\n+            boolean fields = getBooleanValue(i, \"fields\");\n+            boolean ignoreNested = getBooleanValue(i, \"ignoreNested\");\n+\n             AnnotationValue targetsValue = i.value(\"targets\");\n-            if (targetsValue == null) {\n-                reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, target.name().toString()));\n-            } else {\n+            AnnotationValue classNamesValue = i.value(\"classNames\");\n+\n+            ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n+            if (targetsValue == null && classNamesValue == null) {\n+                ClassInfo classInfo = i.target().asClass();\n+                registerClass(classLoader, classInfo.name().toString(), methods, fields, ignoreNested);\n+                continue;\n+            }\n+\n+            if (targetsValue != null) {\n                 Type[] targets = targetsValue.asClassArray();\n                 for (Type type : targets) {\n-                    reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, type.name().toString()));\n+                    registerClass(classLoader, type.name().toString(), methods, fields, ignoreNested);\n+                }\n+            }\n+\n+            if (classNamesValue != null) {\n+                String[] classNames = classNamesValue.asStringArray();\n+                for (String className : classNames) {\n+                    registerClass(classLoader, className, methods, fields, ignoreNested);\n                 }\n             }\n         }\n     }\n \n+    /**\n+     * BFS Recursive Method to register a class and it's inner classes for Reflection.\n+     */\n+    private void registerClass(ClassLoader classLoader, String className, boolean methods, boolean fields,\n+            boolean ignoreNested) {\n+        reflectiveClass.produce(new ReflectiveClassBuildItem(methods, fields, className));\n+\n+        if (ignoreNested) {\n+            return;\n+        }\n+\n+        try {\n+            Class<?>[] declaredClasses = classLoader.loadClass(className).getDeclaredClasses();\n+            for (Class<?> clazz : declaredClasses) {\n+                registerClass(classLoader, clazz.getName(), methods, fields, false);\n+            }\n+        } catch (ClassNotFoundException e) {\n+            log.errorf(e, \"Failed to load Class %s\", className);", "originalCommit": "af10c503f589533938860b5625ee3c7b1a93085d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b0af81213ed190d2facdf099dab3de472b61afa1", "url": "https://github.com/quarkusio/quarkus/commit/b0af81213ed190d2facdf099dab3de472b61afa1", "message": "Added support to register nested classes and reflection via classNames", "committedDate": "2020-05-10T13:01:48Z", "type": "commit"}, {"oid": "b0af81213ed190d2facdf099dab3de472b61afa1", "url": "https://github.com/quarkusio/quarkus/commit/b0af81213ed190d2facdf099dab3de472b61afa1", "message": "Added support to register nested classes and reflection via classNames", "committedDate": "2020-05-10T13:01:48Z", "type": "forcePushed"}]}