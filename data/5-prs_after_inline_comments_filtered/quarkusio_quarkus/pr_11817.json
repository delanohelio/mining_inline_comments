{"pr_number": 11817, "pr_title": "Allow RestEasy JAXB collection serialization in native mode", "pr_createdAt": "2020-09-02T12:20:45Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11817", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2ODYwMA==", "url": "https://github.com/quarkusio/quarkus/pull/11817#discussion_r482068600", "bodyText": "Maybe we could be a bit more clever and exit the for loop so that it's done only once?", "author": "gsmet", "createdAt": "2020-09-02T13:28:56Z", "path": "extensions/resteasy-jaxb/deployment/src/main/java/io/quarkus/resteasy/jaxb/deployment/ResteasyJaxbProcessor.java", "diffHunk": "@@ -1,14 +1,54 @@\n package io.quarkus.resteasy.jaxb.deployment;\n \n+import java.lang.annotation.Annotation;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.IndexView;\n+import org.jboss.resteasy.annotations.providers.jaxb.Wrapped;\n+import org.jboss.resteasy.annotations.providers.jaxb.WrappedMap;\n+\n import io.quarkus.deployment.Feature;\n import io.quarkus.deployment.annotations.BuildProducer;\n import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n \n public class ResteasyJaxbProcessor {\n \n+    private static final List<Class<? extends Annotation>> RESTEASY_JAXB_ANNOTATIONS = Arrays.asList(\n+            Wrapped.class,\n+            WrappedMap.class);\n+\n+    @Inject\n+    BuildProducer<ReflectiveClassBuildItem> reflectiveClass;\n+\n+    @BuildStep\n+    void processAnnotations(CombinedIndexBuildItem combinedIndexBuildItem) {\n+        IndexView index = combinedIndexBuildItem.getIndex();\n+\n+        // Handle RESTEasy annotations usage.\n+        for (Class annotationClazz : RESTEASY_JAXB_ANNOTATIONS) {\n+            DotName annotation = DotName.createSimple(annotationClazz.getName());\n+\n+            if (!index.getAnnotations(annotation).isEmpty()) {\n+                addReflectiveClass(true, true, \"org.jboss.resteasy.plugins.providers.jaxb.JaxbCollection\");\n+                addReflectiveClass(true, true, \"org.jboss.resteasy.plugins.providers.jaxb.JaxbMap\");\n+                addReflectiveClass(true, true, \"javax.xml.bind.annotation.W3CDomHandler\");", "originalCommit": "d7b89121699bfe98e5e33c43dac1cab13b4f0d0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA3NDkyNg==", "url": "https://github.com/quarkusio/quarkus/pull/11817#discussion_r482074926", "bodyText": "Absolutely! Will change that.", "author": "lbroudoux", "createdAt": "2020-09-02T13:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2ODYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2ODgzMg==", "url": "https://github.com/quarkusio/quarkus/pull/11817#discussion_r482068832", "bodyText": "Are the providers automatically added to RESTEasy somehow? If so I'm surprised they are not added for reflection there.", "author": "gsmet", "createdAt": "2020-09-02T13:29:14Z", "path": "extensions/resteasy-jaxb/deployment/src/main/java/io/quarkus/resteasy/jaxb/deployment/ResteasyJaxbProcessor.java", "diffHunk": "@@ -1,14 +1,54 @@\n package io.quarkus.resteasy.jaxb.deployment;\n \n+import java.lang.annotation.Annotation;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.IndexView;\n+import org.jboss.resteasy.annotations.providers.jaxb.Wrapped;\n+import org.jboss.resteasy.annotations.providers.jaxb.WrappedMap;\n+\n import io.quarkus.deployment.Feature;\n import io.quarkus.deployment.annotations.BuildProducer;\n import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n \n public class ResteasyJaxbProcessor {\n \n+    private static final List<Class<? extends Annotation>> RESTEASY_JAXB_ANNOTATIONS = Arrays.asList(\n+            Wrapped.class,\n+            WrappedMap.class);\n+\n+    @Inject\n+    BuildProducer<ReflectiveClassBuildItem> reflectiveClass;\n+\n+    @BuildStep\n+    void processAnnotations(CombinedIndexBuildItem combinedIndexBuildItem) {\n+        IndexView index = combinedIndexBuildItem.getIndex();\n+\n+        // Handle RESTEasy annotations usage.\n+        for (Class annotationClazz : RESTEASY_JAXB_ANNOTATIONS) {\n+            DotName annotation = DotName.createSimple(annotationClazz.getName());\n+\n+            if (!index.getAnnotations(annotation).isEmpty()) {\n+                addReflectiveClass(true, true, \"org.jboss.resteasy.plugins.providers.jaxb.JaxbCollection\");\n+                addReflectiveClass(true, true, \"org.jboss.resteasy.plugins.providers.jaxb.JaxbMap\");", "originalCommit": "d7b89121699bfe98e5e33c43dac1cab13b4f0d0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA3ODI3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/11817#discussion_r482078275", "bodyText": "Not sure to see what you mean... This solely based on experiment ;-) I do not have specific knowledge of RestEasy internal. Do you mean there's some other provider classes that should be required too ?", "author": "lbroudoux", "createdAt": "2020-09-02T13:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2ODgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEwMjQxMA==", "url": "https://github.com/quarkusio/quarkus/pull/11817#discussion_r482102410", "bodyText": "I'm just a bit surprised that just registering them for reflection can make things work.\nI would have expected either it would work as is or adding them for reflection won't be enough.", "author": "gsmet", "createdAt": "2020-09-02T14:14:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2ODgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE0MzE5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/11817#discussion_r482143192", "bodyText": "Yes just work as is ;-)", "author": "lbroudoux", "createdAt": "2020-09-02T15:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2ODgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2OTcyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/11817#discussion_r482069725", "bodyText": "Also, could you make it a parameter of the build step rather than injecting it here? It helps keeping track of the dependencies.", "author": "gsmet", "createdAt": "2020-09-02T13:30:28Z", "path": "extensions/resteasy-jaxb/deployment/src/main/java/io/quarkus/resteasy/jaxb/deployment/ResteasyJaxbProcessor.java", "diffHunk": "@@ -1,14 +1,54 @@\n package io.quarkus.resteasy.jaxb.deployment;\n \n+import java.lang.annotation.Annotation;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.IndexView;\n+import org.jboss.resteasy.annotations.providers.jaxb.Wrapped;\n+import org.jboss.resteasy.annotations.providers.jaxb.WrappedMap;\n+\n import io.quarkus.deployment.Feature;\n import io.quarkus.deployment.annotations.BuildProducer;\n import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n \n public class ResteasyJaxbProcessor {\n \n+    private static final List<Class<? extends Annotation>> RESTEASY_JAXB_ANNOTATIONS = Arrays.asList(\n+            Wrapped.class,\n+            WrappedMap.class);\n+\n+    @Inject\n+    BuildProducer<ReflectiveClassBuildItem> reflectiveClass;", "originalCommit": "d7b89121699bfe98e5e33c43dac1cab13b4f0d0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA3NTkxMQ==", "url": "https://github.com/quarkusio/quarkus/pull/11817#discussion_r482075911", "bodyText": "Ok, will change that if it's a best practice.", "author": "lbroudoux", "createdAt": "2020-09-02T13:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2OTcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEwMTY3MA==", "url": "https://github.com/quarkusio/quarkus/pull/11817#discussion_r482101670", "bodyText": "I missed that one but we usually avoid star imports.", "author": "gsmet", "createdAt": "2020-09-02T14:13:16Z", "path": "extensions/resteasy-jaxb/deployment/src/test/java/io/quarkus/resteasy/jaxb/deployment/ProducesXMLTestCase.java", "diffHunk": "@@ -1,11 +1,18 @@\n package io.quarkus.resteasy.jaxb.deployment;\n \n+import static org.hamcrest.Matchers.*;", "originalCommit": "287ea3385074ddb1ad6776ba41438a52f5ab61b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEwODM0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11817#discussion_r482108343", "bodyText": "Will do.", "author": "lbroudoux", "createdAt": "2020-09-02T14:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEwMTY3MA=="}], "type": "inlineReview"}, {"oid": "b318c9030c8cd5ca2b93d7b1cda5596d8f4ffa89", "url": "https://github.com/quarkusio/quarkus/commit/b318c9030c8cd5ca2b93d7b1cda5596d8f4ffa89", "message": "Allow RestEasy JAXB collection serialization in native mode", "committedDate": "2020-09-02T15:02:31Z", "type": "commit"}, {"oid": "b318c9030c8cd5ca2b93d7b1cda5596d8f4ffa89", "url": "https://github.com/quarkusio/quarkus/commit/b318c9030c8cd5ca2b93d7b1cda5596d8f4ffa89", "message": "Allow RestEasy JAXB collection serialization in native mode", "committedDate": "2020-09-02T15:02:31Z", "type": "forcePushed"}]}