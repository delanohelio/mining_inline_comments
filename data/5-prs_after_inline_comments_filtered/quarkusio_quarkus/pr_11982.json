{"pr_number": 11982, "pr_title": "Add OpenShift Client extension", "pr_createdAt": "2020-09-08T15:26:47Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11982", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNTQ5Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485015493", "bodyText": "Please, alphabetical order :).", "author": "gsmet", "createdAt": "2020-09-08T15:36:26Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/Feature.java", "diffHunk": "@@ -54,6 +54,7 @@\n     KOTLIN,\n     KUBERNETES,\n     KUBERNETES_CLIENT,\n+    OPENSHIFT_CLIENT,", "originalCommit": "2d4dea80f70cb19b9a5ecbc7c19b3baeb3a91ee9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNzI3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485017275", "bodyText": "Shouldn't part of this be shared to avoid having to fix bugs in both extension? Most of this doesn't look specific to OpenShift?", "author": "gsmet", "createdAt": "2020-09-08T15:39:09Z", "path": "extensions/openshift-client/deployment/src/main/java/io/quarkus/openshift/client/deployment/OpenShiftClientProcessor.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package io.quarkus.openshift.client.deployment;\n+\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import javax.inject.Inject;\n+\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.Type;\n+import org.jboss.logging.Logger;\n+\n+import io.quarkus.arc.deployment.AdditionalBeanBuildItem;\n+import io.quarkus.deployment.Feature;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.ApplicationIndexBuildItem;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.ExtensionSslNativeSupportBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import io.quarkus.deployment.util.JandexUtil;\n+import io.quarkus.jackson.deployment.IgnoreJsonDeserializeClassBuildItem;\n+import io.quarkus.kubernetes.client.deployment.KubernetesClientProcessor;\n+import io.quarkus.kubernetes.spi.KubernetesRoleBuildItem;\n+import io.quarkus.openshift.client.runtime.OpenShiftClientProducer;\n+\n+public class OpenShiftClientProcessor {\n+\n+    private static final DotName WATCHER = DotName.createSimple(\"io.fabric8.kubernetes.client.Watcher\");\n+    private static final DotName KUBERNETES_RESOURCE = DotName\n+            .createSimple(\"io.fabric8.kubernetes.api.model.KubernetesResource\");\n+\n+    private static final Logger log = Logger.getLogger(OpenShiftClientProcessor.class.getName());\n+\n+    @Inject\n+    BuildProducer<FeatureBuildItem> featureProducer;\n+\n+    @Inject\n+    BuildProducer<ReflectiveClassBuildItem> reflectiveClasses;\n+\n+    @Inject\n+    BuildProducer<IgnoreJsonDeserializeClassBuildItem> ignoredJsonDeserializationClasses;\n+\n+    @Inject\n+    BuildProducer<KubernetesRoleBuildItem> roleProducer;\n+\n+    @BuildStep\n+    public void process(ApplicationIndexBuildItem applicationIndex, CombinedIndexBuildItem combinedIndexBuildItem,\n+            BuildProducer<ExtensionSslNativeSupportBuildItem> sslNativeSupport,\n+            BuildProducer<AdditionalBeanBuildItem> additionalBeanBuildItemBuildItem) {\n+\n+        featureProducer.produce(new FeatureBuildItem(Feature.OPENSHIFT_CLIENT));\n+        // roleProducer.produce(new KubernetesRoleBuildItem(\"view\"));\n+\n+        Set<String> watchedClasses = new HashSet<>();\n+        // make sure the watchers fully (and not weakly) register Kubernetes classes for reflection\n+        applicationIndex.getIndex().getAllKnownImplementors(WATCHER)\n+                .forEach(c -> {\n+                    try {\n+                        final List<Type> watcherGenericTypes = JandexUtil.resolveTypeParameters(c.name(),\n+                                WATCHER, combinedIndexBuildItem.getIndex());\n+                        if (watcherGenericTypes.size() == 1) {\n+                            watchedClasses.add(watcherGenericTypes.get(0).name().toString());\n+                        }\n+                    } catch (IllegalStateException ignored) {\n+                        // when the class has no subclasses and we were not able to determine the generic types, it's likely that\n+                        // the watcher will fail due to not being able to deserialize the class\n+                        if (applicationIndex.getIndex().getAllKnownSubclasses(c.name()).isEmpty()) {\n+                            log.warn(\"Watcher '\" + c.name() + \"' will most likely not work correctly in native mode. \" +\n+                                    \"Consider specifying the generic type of 'io.fabric8.kubernetes.client.Watcher' that this class handles. \"\n+                                    +\n+                                    \"See https://quarkus.io/guides/kubernetes-client#note-on-implementing-the-watcher-interface for more details\");\n+                        }\n+                    }\n+                });\n+        if (!watchedClasses.isEmpty()) {\n+            reflectiveClasses.produce(new ReflectiveClassBuildItem(true, true, watchedClasses.toArray(new String[0])));\n+        }\n+\n+        final String[] modelClasses = combinedIndexBuildItem.getIndex()\n+                .getAllKnownImplementors(KUBERNETES_RESOURCE)\n+                .stream()\n+                .peek(c -> {\n+                    // we need to make sure that the Jackson extension does not try to fully register the model classes\n+                    // since we are going to register them weakly\n+                    ignoredJsonDeserializationClasses.produce(new IgnoreJsonDeserializeClassBuildItem(c.name()));\n+                })\n+                .map(c -> c.name().toString())\n+                .filter(c -> !watchedClasses.contains(c))\n+                .toArray(String[]::new);\n+        reflectiveClasses.produce(ReflectiveClassBuildItem\n+                .builder(modelClasses).weak(true).methods(true).fields(false).build());\n+\n+        // we also ignore some classes that are annotated with @JsonDeserialize that would force the registration of the entire model\n+        ignoredJsonDeserializationClasses.produce(\n+                new IgnoreJsonDeserializeClassBuildItem(DotName.createSimple(\"io.fabric8.kubernetes.api.model.KubeSchema\")));\n+        ignoredJsonDeserializationClasses.produce(\n+                new IgnoreJsonDeserializeClassBuildItem(\n+                        DotName.createSimple(\"io.fabric8.kubernetes.api.model.KubernetesResourceList\")));\n+        ignoredJsonDeserializationClasses.produce(new IgnoreJsonDeserializeClassBuildItem(KUBERNETES_RESOURCE));\n+\n+        final String[] doneables = combinedIndexBuildItem.getIndex()\n+                .getAllKnownImplementors(DotName.createSimple(\"io.fabric8.kubernetes.api.model.Doneable\"))\n+                .stream()\n+                .map(c -> c.name().toString())\n+                .toArray(String[]::new);\n+        reflectiveClasses.produce(ReflectiveClassBuildItem.weakClass(doneables));\n+\n+        final String[] deserializerClasses = combinedIndexBuildItem.getIndex()\n+                .getAllKnownSubclasses(DotName.createSimple(\"com.fasterxml.jackson.databind.JsonDeserializer\"))\n+                .stream()\n+                .map(c -> c.name().toString())\n+                .filter(s -> s.startsWith(\"io.fabric8.kubernetes\"))\n+                .toArray(String[]::new);\n+        reflectiveClasses.produce(new ReflectiveClassBuildItem(true, false, deserializerClasses));\n+\n+        final String[] serializerClasses = combinedIndexBuildItem.getIndex()\n+                .getAllKnownSubclasses(DotName.createSimple(\"com.fasterxml.jackson.databind.JsonSerializer\"))\n+                .stream()\n+                .map(c -> c.name().toString())\n+                .filter(s -> s.startsWith(\"io.fabric8.kubernetes\"))\n+                .toArray(String[]::new);\n+        reflectiveClasses.produce(new ReflectiveClassBuildItem(true, false, serializerClasses));\n+\n+        reflectiveClasses\n+                .produce(new ReflectiveClassBuildItem(true, false, \"io.fabric8.kubernetes.api.model.IntOrString\"));\n+        reflectiveClasses\n+                .produce(new ReflectiveClassBuildItem(true, false, \"io.fabric8.kubernetes.internal.KubernetesDeserializer\"));", "originalCommit": "2d4dea80f70cb19b9a5ecbc7c19b3baeb3a91ee9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUwNTc4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485505787", "bodyText": "If there is a way it would be nice to use it, as more client extensions could be added in the future. Personally I'd love to see kantive and tekton. So that would be awesome!", "author": "iocanel", "createdAt": "2020-09-09T10:25:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNzI3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3MTA5NA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r486971094", "bodyText": "+1 for what both Guillaume and Ioannis said above", "author": "geoand", "createdAt": "2020-09-11T11:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNzI3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM4NzY1NQ==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r487387655", "bodyText": "Shouldn't part of this be shared to avoid having to fix bugs in both extension? Most of this doesn't look specific to OpenShift?\n\nthis code is not duplicated anymore.\nare you suggesting to create a base kubernetes extension that includes part of the KubernetesClientProcessor? then, it would have to depend on the fabric8 kubernetes-client library, right; because the referred classes such as io.fabric8.kubernetes.api.model.IntOrString come from that library.\nthere are not knative or tekton libraries today? if there were, you idea is to get them to share those common classes? then we are talking about some code reuse in the fabric8 project with support for knative and tekton modules, before even talking about some code reuse in quarkus?\nwhat exactly do you think we can do at this point here in quarkus?", "author": "vsevel", "createdAt": "2020-09-12T08:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNzI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNzg4OA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485017888", "bodyText": "Let's make it @Singleton maybe?", "author": "gsmet", "createdAt": "2020-09-08T15:40:02Z", "path": "extensions/openshift-client/runtime/src/main/java/io/quarkus/openshift/client/runtime/OpenShiftClientProducer.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package io.quarkus.openshift.client.runtime;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.inject.Produces;\n+import javax.inject.Singleton;\n+\n+import io.fabric8.kubernetes.client.Config;\n+import io.fabric8.openshift.client.DefaultOpenShiftClient;\n+import io.fabric8.openshift.client.OpenShiftClient;\n+import io.quarkus.arc.DefaultBean;\n+\n+@ApplicationScoped", "originalCommit": "2d4dea80f70cb19b9a5ecbc7c19b3baeb3a91ee9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5MjMzNw==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485392337", "bodyText": "by the way, documentations provides un example with ApplicationScoped\nshould it be changed as well?", "author": "vsevel", "createdAt": "2020-09-09T07:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNzg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3MTMxMA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r486971310", "bodyText": "Yeah, it should be @Singleton", "author": "geoand", "createdAt": "2020-09-11T11:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNzg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgwNTI3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r487805276", "bodyText": "corrected in doc \"https://quarkus.io/guides/writing-extensions\"\nsee 4e5a98a", "author": "vsevel", "createdAt": "2020-09-14T10:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNzg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxOTIwMw==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485019203", "bodyText": "Why is it disabled?", "author": "gsmet", "createdAt": "2020-09-08T15:41:58Z", "path": "integration-tests/openshift-client/src/test/java/io/quarkus/openshift/client/runtime/OpenShiftClientTestIT.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package io.quarkus.openshift.client.runtime;\n+\n+import io.quarkus.test.junit.NativeImageTest;\n+import org.junit.jupiter.api.Disabled;\n+\n+@Disabled", "originalCommit": "2d4dea80f70cb19b9a5ecbc7c19b3baeb3a91ee9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5MjM4NQ==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485392385", "bodyText": "I have implemented the tests.", "author": "vsevel", "createdAt": "2020-09-09T07:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxOTIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA2NDUzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485064539", "bodyText": "This seems to have been copied from KubernetesClientProcessor. Since this extension depends on kubernetes-client, this is not needed. It should contain only what's necessary for OpenShiftClient", "author": "gastaldi", "createdAt": "2020-09-08T16:54:48Z", "path": "extensions/openshift-client/deployment/src/main/java/io/quarkus/openshift/client/deployment/OpenShiftClientProcessor.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package io.quarkus.openshift.client.deployment;\n+\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import javax.inject.Inject;\n+\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.Type;\n+import org.jboss.logging.Logger;\n+\n+import io.quarkus.arc.deployment.AdditionalBeanBuildItem;\n+import io.quarkus.deployment.Feature;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.ApplicationIndexBuildItem;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.ExtensionSslNativeSupportBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import io.quarkus.deployment.util.JandexUtil;\n+import io.quarkus.jackson.deployment.IgnoreJsonDeserializeClassBuildItem;\n+import io.quarkus.kubernetes.client.deployment.KubernetesClientProcessor;\n+import io.quarkus.kubernetes.spi.KubernetesRoleBuildItem;\n+import io.quarkus.openshift.client.runtime.OpenShiftClientProducer;\n+\n+public class OpenShiftClientProcessor {", "originalCommit": "0039f885ca1223e17e24877bf88d8972e0b3a270", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5MjA1OA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485192058", "bodyText": "The kubernetes client extension already does that", "author": "gastaldi", "createdAt": "2020-09-08T20:57:42Z", "path": "extensions/openshift-client/deployment/src/main/java/io/quarkus/openshift/client/deployment/OpenShiftClientProcessor.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package io.quarkus.openshift.client.deployment;\n+\n+import javax.inject.Inject;\n+\n+import org.jboss.logging.Logger;\n+\n+import io.quarkus.arc.deployment.AdditionalBeanBuildItem;\n+import io.quarkus.deployment.Feature;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.ExtensionSslNativeSupportBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.it.openshift.client.OpenShiftClientProducer;\n+\n+public class OpenShiftClientProcessor {\n+\n+    private static final Logger log = Logger.getLogger(OpenShiftClientProcessor.class.getName());\n+\n+    @Inject\n+    BuildProducer<FeatureBuildItem> featureProducer;\n+\n+    @BuildStep\n+    public void process(\n+            BuildProducer<ExtensionSslNativeSupportBuildItem> sslNativeSupport,\n+            BuildProducer<AdditionalBeanBuildItem> additionalBeanBuildItemBuildItem) {\n+\n+        featureProducer.produce(new FeatureBuildItem(Feature.OPENSHIFT_CLIENT));\n+\n+        // Enable SSL support by default\n+        sslNativeSupport.produce(new ExtensionSslNativeSupportBuildItem(Feature.OPENSHIFT_CLIENT));", "originalCommit": "4f3b1eb7b648e7dabea569920a9c0dba98f1227f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM1ODIyMg==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485358222", "bodyText": "it does this:\nfeatureProducer.produce(new FeatureBuildItem(Feature.KUBERNETES_CLIENT));\nsslNativeSupport.produce(new ExtensionSslNativeSupportBuildItem(Feature.KUBERNETES_CLIENT));\n\nnot this:\nfeatureProducer.produce(new FeatureBuildItem(Feature.OPENSHIFT_CLIENT));\nsslNativeSupport.produce(new ExtensionSslNativeSupportBuildItem(Feature.OPENSHIFT_CLIENT));\n\ndon't we want the feature to be displayed?\nand for ssl support I agree.\nit was not clear to me whether or not things needed to be repeated in the context of the new extension (I am not entirely comfortable with processors).", "author": "vsevel", "createdAt": "2020-09-09T06:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5MjA1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ4MTY5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485481692", "bodyText": "Yes, I was referring to the SSL support. Thanks!", "author": "gastaldi", "createdAt": "2020-09-09T09:44:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5MjA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUwMzEyOA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485503128", "bodyText": "openshiftClient maybe?", "author": "iocanel", "createdAt": "2020-09-09T10:20:51Z", "path": "extensions/openshift-client/runtime/src/main/java/io/quarkus/it/openshift/client/OpenShiftClientProducer.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package io.quarkus.it.openshift.client;\n+\n+import javax.enterprise.inject.Produces;\n+import javax.inject.Singleton;\n+\n+import io.fabric8.kubernetes.client.Config;\n+import io.fabric8.openshift.client.DefaultOpenShiftClient;\n+import io.fabric8.openshift.client.OpenShiftClient;\n+import io.quarkus.arc.DefaultBean;\n+\n+@Singleton\n+public class OpenShiftClientProducer {\n+\n+    @DefaultBean\n+    @Singleton\n+    @Produces\n+    public OpenShiftClient kubernetesClient(Config config) {", "originalCommit": "f8b94c86303f85651c1010d5b4d6969bca147e9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0NjI5MA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485646290", "bodyText": "No big deal, but you can move the featureProducer.produce(...) method to a separate method in the processor, like in the example below\n\n  \n    \n      quarkus/extensions/jgit/deployment/src/main/java/io/quarkus/jgit/deployment/JGitProcessor.java\n    \n    \n        Lines 16 to 19\n      in\n      770dbae\n    \n    \n    \n    \n\n        \n          \n           @BuildStep \n        \n\n        \n          \n           FeatureBuildItem feature() { \n        \n\n        \n          \n               return new FeatureBuildItem(Feature.JGIT); \n        \n\n        \n          \n           }", "author": "gastaldi", "createdAt": "2020-09-09T14:14:50Z", "path": "extensions/openshift-client/deployment/src/main/java/io/quarkus/openshift/client/deployment/OpenShiftClientProcessor.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package io.quarkus.openshift.client.deployment;\n+\n+import javax.inject.Inject;\n+\n+import io.quarkus.arc.deployment.AdditionalBeanBuildItem;\n+import io.quarkus.deployment.Feature;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.it.openshift.client.OpenShiftClientProducer;\n+\n+public class OpenShiftClientProcessor {\n+\n+    @Inject\n+    BuildProducer<FeatureBuildItem> featureProducer;\n+\n+    @BuildStep\n+    public void process(BuildProducer<AdditionalBeanBuildItem> additionalBeanBuildItemBuildItem) {\n+\n+        featureProducer.produce(new FeatureBuildItem(Feature.OPENSHIFT_CLIENT));\n+\n+        // wire up the OpenShiftClient bean support\n+        additionalBeanBuildItemBuildItem.produce(AdditionalBeanBuildItem.unremovableOf(OpenShiftClientProducer.class));\n+    }", "originalCommit": "c72e381f26192d0fe715572fbc9b37c35b6692ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0NzE4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485647182", "bodyText": "Nice! \ud83d\udc4d", "author": "gastaldi", "createdAt": "2020-09-09T14:15:56Z", "path": "extensions/kubernetes-client/runtime-internal/src/main/java/io/quarkus/kubernetes/client/runtime/KubernetesClientBuildConfig.java", "diffHunk": "@@ -88,6 +88,12 @@\n     @ConfigItem\n     public Optional<String> password;\n \n+    /**\n+     * Kubernetes oauth token\n+     */\n+    @ConfigItem\n+    public Optional<String> token;", "originalCommit": "c72e381f26192d0fe715572fbc9b37c35b6692ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY1MDI4MA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r485650280", "bodyText": "thanks. yes that was missing for my tests ;)", "author": "vsevel", "createdAt": "2020-09-09T14:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0NzE4Mg=="}], "type": "inlineReview"}, {"oid": "2bd86b941f5e6f5ffecc689763da6ab68acef379", "url": "https://github.com/quarkusio/quarkus/commit/2bd86b941f5e6f5ffecc689763da6ab68acef379", "message": "Add OpenShift Client extension", "committedDate": "2020-09-15T16:36:30Z", "type": "forcePushed"}, {"oid": "d3762f1ee3480a2090172ab53cb8e832b2976532", "url": "https://github.com/quarkusio/quarkus/commit/d3762f1ee3480a2090172ab53cb8e832b2976532", "message": "Add OpenShift Client extension", "committedDate": "2020-09-15T16:37:05Z", "type": "forcePushed"}, {"oid": "b4069fa13c0529949dd69e2dd7df8eca48571de5", "url": "https://github.com/quarkusio/quarkus/commit/b4069fa13c0529949dd69e2dd7df8eca48571de5", "message": "Add OpenShift Client extension", "committedDate": "2020-09-15T16:57:29Z", "type": "forcePushed"}, {"oid": "3404f81f85413e9d2429f39d73fc2a248fd22160", "url": "https://github.com/quarkusio/quarkus/commit/3404f81f85413e9d2429f39d73fc2a248fd22160", "message": "Add OpenShift Client extension", "committedDate": "2020-09-18T06:50:36Z", "type": "forcePushed"}, {"oid": "cfa7bce3c322aa4bc50d9a69121a15829367c49c", "url": "https://github.com/quarkusio/quarkus/commit/cfa7bce3c322aa4bc50d9a69121a15829367c49c", "message": "Add OpenShift Client extension", "committedDate": "2020-09-21T10:54:21Z", "type": "forcePushed"}, {"oid": "9faf666e3c080aad2e5ce32a05c5f06a6c04a750", "url": "https://github.com/quarkusio/quarkus/commit/9faf666e3c080aad2e5ce32a05c5f06a6c04a750", "message": "Add OpenShift Client extension", "committedDate": "2020-10-02T17:27:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk1ODYxOA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r498958618", "bodyText": "No biggie, but instead of storing it in an attribute to destroy later, I think you can pass it as a method argument.\nEg.\n@PreDestroy\npublic void destroy(KubernetesClient client) { \n   client.close();\n}", "author": "gastaldi", "createdAt": "2020-10-02T17:37:23Z", "path": "extensions/kubernetes-client/runtime/src/main/java/io/quarkus/kubernetes/client/runtime/KubernetesClientProducer.java", "diffHunk": "@@ -9,9 +9,11 @@\n import io.fabric8.kubernetes.client.KubernetesClient;\n import io.quarkus.arc.DefaultBean;\n \n-@ApplicationScoped\n+@Singleton\n public class KubernetesClientProducer {\n \n+    private KubernetesClient client;", "originalCommit": "9faf666e3c080aad2e5ce32a05c5f06a6c04a750", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2NDAxMA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r498964010", "bodyText": "Ah ignore me. I am confusing it with CDI's @Destroyed (https://docs.jboss.org/cdi/api/2.0/javax/enterprise/context/Destroyed.html)", "author": "gastaldi", "createdAt": "2020-10-02T17:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk1ODYxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2NjU2MA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r498966560", "bodyText": "looks better, and avoids testing for null.", "author": "vsevel", "createdAt": "2020-10-02T17:54:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk1ODYxOA=="}], "type": "inlineReview"}, {"oid": "b2452b220fb1dbfabaaec14b6958a6acbd61d2e4", "url": "https://github.com/quarkusio/quarkus/commit/b2452b220fb1dbfabaaec14b6958a6acbd61d2e4", "message": "Add OpenShift Client extension", "committedDate": "2020-10-02T17:52:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk3Nzg1NA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r498977854", "bodyText": "This needs to be\n public void destroy(@Observes @Destroyed OpenShiftClient client) {\n...\n}\nAFAIK", "author": "gastaldi", "createdAt": "2020-10-02T18:16:29Z", "path": "extensions/openshift-client/runtime/src/main/java/io/quarkus/it/openshift/client/runtime/OpenShiftClientProducer.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package io.quarkus.it.openshift.client.runtime;\n+\n+import javax.annotation.PreDestroy;\n+import javax.enterprise.inject.Produces;\n+import javax.inject.Singleton;\n+\n+import io.fabric8.kubernetes.client.Config;\n+import io.fabric8.openshift.client.DefaultOpenShiftClient;\n+import io.fabric8.openshift.client.OpenShiftClient;\n+import io.quarkus.arc.DefaultBean;\n+\n+@Singleton\n+public class OpenShiftClientProducer {\n+\n+    @DefaultBean\n+    @Singleton\n+    @Produces\n+    public OpenShiftClient openshiftClient(Config config) {\n+        return new DefaultOpenShiftClient(config);\n+    }\n+\n+    @PreDestroy\n+    public void destroy(OpenShiftClient client) {", "originalCommit": "b2452b220fb1dbfabaaec14b6958a6acbd61d2e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MzA5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r499053091", "bodyText": "I could not get it to work. @Destroyed requires a scope.\nI could not find something that looked like what you are suggesting.\ndo you have another idea, or should I revert the code?", "author": "vsevel", "createdAt": "2020-10-02T21:13:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk3Nzg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2MzM1OA==", "url": "https://github.com/quarkusio/quarkus/pull/11982#discussion_r499063358", "bodyText": "this works:\n    public void destroy(@Observes @Destroyed(ApplicationScoped.class) Object container, OpenShiftClient client) {\n        if (client != null) {\n            LOGGER.info(\"closing openshift client\");\n            client.close();\n        }\n    }\n\nI did not know if the client could be null, so I implemented defensively.\nI squashed the commits.", "author": "vsevel", "createdAt": "2020-10-02T21:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk3Nzg1NA=="}], "type": "inlineReview"}, {"oid": "687e71e695ed751a1101298179db97eb4760f5b7", "url": "https://github.com/quarkusio/quarkus/commit/687e71e695ed751a1101298179db97eb4760f5b7", "message": "Add OpenShift Client extension", "committedDate": "2020-10-02T21:42:53Z", "type": "forcePushed"}, {"oid": "be062c0eba75e95a4452d08741e703f28b0c292b", "url": "https://github.com/quarkusio/quarkus/commit/be062c0eba75e95a4452d08741e703f28b0c292b", "message": "Add OpenShift Client extension", "committedDate": "2020-10-03T06:49:06Z", "type": "forcePushed"}, {"oid": "6c475204c98ad22b0de3c0a7c6382fd414aa0363", "url": "https://github.com/quarkusio/quarkus/commit/6c475204c98ad22b0de3c0a7c6382fd414aa0363", "message": "Add OpenShift Client extension", "committedDate": "2020-10-06T09:19:27Z", "type": "commit"}, {"oid": "6c475204c98ad22b0de3c0a7c6382fd414aa0363", "url": "https://github.com/quarkusio/quarkus/commit/6c475204c98ad22b0de3c0a7c6382fd414aa0363", "message": "Add OpenShift Client extension", "committedDate": "2020-10-06T09:19:27Z", "type": "forcePushed"}]}