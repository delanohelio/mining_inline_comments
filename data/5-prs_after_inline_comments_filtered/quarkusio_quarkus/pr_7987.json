{"pr_number": 7987, "pr_title": "fix OpenTracing trace context propagation with Fault Tolerance @Asynchronous methods", "pr_createdAt": "2020-03-19T15:41:48Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7987", "timeline": [{"oid": "568e4116bef9a163c0c05ac3c175cd96d399e38b", "url": "https://github.com/quarkusio/quarkus/commit/568e4116bef9a163c0c05ac3c175cd96d399e38b", "message": "fix OpenTracing trace context propagation with Fault Tolerance @Asynchronous methods\n\nThere used to be a test for that, but didn't involve `@Asynchronous`\nmethods, so was in fact useless. This commit changes the test to\nactually call an `@Asynchronous` method, which revealed an issue.\nThe `smallrye-fault-tolerance-tracing-propagation` dependency was\nmissing, so trace context propagation didn't actually work.\n\nIn addition to that, this commit also fixes a devmode issue where\non hot reload, the Jaeger extension tried to register a gauge\nthat was already present. That ended up with an exception.\n\nAnd finally, this commit also adds a test for tracing JDBC.", "committedDate": "2020-03-25T13:53:01Z", "type": "forcePushed"}, {"oid": "72358326329c6b77a7f344bc65bd8ff3defda7f3", "url": "https://github.com/quarkusio/quarkus/commit/72358326329c6b77a7f344bc65bd8ff3defda7f3", "message": "fix OpenTracing trace context propagation with Fault Tolerance @Asynchronous methods\n\nThere used to be a test for that, but didn't involve `@Asynchronous`\nmethods, so was in fact useless. This commit changes the test to\nactually call an `@Asynchronous` method, which revealed an issue.\nThe `smallrye-fault-tolerance-tracing-propagation` dependency was\nmissing, so trace context propagation didn't actually work.\n\nThen, the test also uncovered an issue in SmallRye Fault Tolerance\n(see https://github.com/smallrye/smallrye-fault-tolerance/pull/208),\nwhich is why this commit also brings a new version of it.\n\nIn addition to that, this commit also fixes a devmode issue where\non hot reload, the Jaeger extension tried to register a gauge\nthat was already present. That ended up with an exception.\n\nAnd finally, this commit also adds a test for tracing JDBC.", "committedDate": "2020-04-01T14:15:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r402759358", "bodyText": "After #7018 we automatically drop and re-create all metric registries during shutdown before a hot reload, so it should not happen anymore that the gauge is still registered. Are you sure we still need this? That would mean the registry dropping is wrong?!", "author": "jmartisk", "createdAt": "2020-04-03T06:21:10Z", "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/QuarkusJaegerMetricsFactory.java", "diffHunk": "@@ -45,12 +46,17 @@ public void durationMicros(long time) {\n \n     @Override\n     public Gauge createGauge(final String name, final Map<String, String> tags) {\n-        JaegerGauge gauge = registry.register(meta(name, MetricType.GAUGE), new JaegerGauge(), toTagArray(tags));\n+        Tag[] tagArray = toTagArray(tags);\n+        JaegerGauge gauge = (JaegerGauge) registry.getGauges().get(new MetricID(name, tagArray));\n+        if (gauge == null) {", "originalCommit": "72358326329c6b77a7f344bc65bd8ff3defda7f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc3NDUyOQ==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r402774529", "bodyText": "I've seen an exception during hot reload on this. I'll try again.", "author": "Ladicek", "createdAt": "2020-04-03T07:02:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzMTA4MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r403131081", "bodyText": "No, this is still required. When I revert this change, I get this on hot reload:\norg.jboss.resteasy.spi.UnhandledException: java.lang.RuntimeException: No reflection exceptions should be thrown unless there is a fundamental error in your code set up.\n        at org.jboss.resteasy.core.ExceptionHandler.handleException(ExceptionHandler.java:381)\n        at org.jboss.resteasy.core.SynchronousDispatcher.writeException(SynchronousDispatcher.java:216)\n        at org.jboss.resteasy.core.SynchronousDispatcher.invoke(SynchronousDispatcher.java:515)\n        at org.jboss.resteasy.core.SynchronousDispatcher.lambda$invoke$4(SynchronousDispatcher.java:259)\n        at org.jboss.resteasy.core.SynchronousDispatcher.lambda$preprocess$0(SynchronousDispatcher.java:160)\n        at org.jboss.resteasy.core.interception.jaxrs.PreMatchContainerRequestContext.filter(PreMatchContainerRequestContext.java:362)\n        at org.jboss.resteasy.core.SynchronousDispatcher.preprocess(SynchronousDispatcher.java:163)\n        at org.jboss.resteasy.core.SynchronousDispatcher.invoke(SynchronousDispatcher.java:245)\n        at io.quarkus.resteasy.runtime.standalone.RequestDispatcher.service(RequestDispatcher.java:73)\n        at io.quarkus.resteasy.runtime.standalone.VertxRequestHandler.dispatch(VertxRequestHandler.java:122)\n        at io.quarkus.resteasy.runtime.standalone.VertxRequestHandler.access$000(VertxRequestHandler.java:36)\n        at io.quarkus.resteasy.runtime.standalone.VertxRequestHandler$1.run(VertxRequestHandler.java:87)\n        at io.quarkus.runtime.CleanableExecutor$CleaningRunnable.run(CleanableExecutor.java:231)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n        at org.jboss.threads.ContextClassLoaderSavingRunnable.run(ContextClassLoaderSavingRunnable.java:35)\n        at org.jboss.threads.EnhancedQueueExecutor.safeRun(EnhancedQueueExecutor.java:2027)\n        at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.doRunTask(EnhancedQueueExecutor.java:1551)\n        at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1442)\n        at org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\n        at org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\n        at java.lang.Thread.run(Thread.java:748)\n        at org.jboss.threads.JBossThread.run(JBossThread.java:479)\nCaused by: java.lang.RuntimeException: No reflection exceptions should be thrown unless there is a fundamental error in your code set up.\n        at io.jaegertracing.internal.metrics.Metrics.createMetrics(Metrics.java:76)\n        at io.jaegertracing.internal.metrics.Metrics.<init>(Metrics.java:32)\n        at io.jaegertracing.internal.metrics.Metrics.<init>(Metrics.java:28)\n        at io.jaegertracing.Configuration.getTracerBuilder(Configuration.java:221)\n        at io.quarkus.jaeger.runtime.QuarkusJaegerTracer.tracer(QuarkusJaegerTracer.java:40)\n        at io.quarkus.jaeger.runtime.QuarkusJaegerTracer.buildSpan(QuarkusJaegerTracer.java:59)\n        at io.opentracing.util.GlobalTracer.buildSpan(GlobalTracer.java:133)\n        at io.quarkus.smallrye.opentracing.runtime.TracerProducer_ProducerMethod_tracer_96dadb3d6afa0cccadfe742c3e06ad433737c844_ClientProxy.buildSpan(TracerProducer_ProducerMethod_tracer_96dadb3d6afa0cccadfe742c3e06ad433737c844_ClientProxy.zig:238)\n        at io.opentracing.contrib.jaxrs2.server.ServerTracingFilter.filter(ServerTracingFilter.java:69)\n        at org.jboss.resteasy.core.interception.jaxrs.PreMatchContainerRequestContext.filter(PreMatchContainerRequestContext.java:310)\n        at org.jboss.resteasy.core.ResourceMethodInvoker.invokeOnTarget(ResourceMethodInvoker.java:439)\n        at org.jboss.resteasy.core.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:400)\n        at org.jboss.resteasy.core.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:374)\n        at org.jboss.resteasy.core.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:67)\n        at org.jboss.resteasy.core.SynchronousDispatcher.invoke(SynchronousDispatcher.java:488)\n        ... 20 more\nCaused by: java.lang.IllegalArgumentException: A metric with metricID MetricID{name='jaeger_tracer_reporter_queue_length', tags=[]} already exists\n        at io.smallrye.metrics.MetricsRegistryImpl.register(MetricsRegistryImpl.java:131)\n        at io.quarkus.jaeger.runtime.QuarkusJaegerMetricsFactory.createGauge(QuarkusJaegerMetricsFactory.java:48)\n        at io.jaegertracing.internal.metrics.Metrics.createMetrics(Metrics.java:66)\n        ... 34 more", "author": "Ladicek", "createdAt": "2020-04-03T16:33:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMyNzg0MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r405327841", "bodyText": "@jmartisk Any idea? Thanks! :-)", "author": "Ladicek", "createdAt": "2020-04-08T07:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0MDM3MA==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r405340370", "bodyText": "That's fishy, I'll try to reproduce this and let you know", "author": "jmartisk", "createdAt": "2020-04-08T08:16:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1MzQwOQ==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r405353409", "bodyText": "@Ladicek I can't reproduce that - I created a simple app which uses tracing and metrics, called one traced method, triggered a reload, called that traced method again, the jaeger_tracer_reporter_queue_length gauge was re-registered correctly and no errors occurred.\nI used Quarkus built from this PR branch, but with this one change reverted. Any other specific thing that I should try? :)", "author": "jmartisk", "createdAt": "2020-04-08T08:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAyNjU5Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406026597", "bodyText": "Oh well. I've just verified this still occurs, even if I rebase this PR on top of current master. I'll put together a detailed reproducer.", "author": "Ladicek", "createdAt": "2020-04-09T08:04:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA1MzE1NA==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406053154", "bodyText": "@jmartisk Here's a reproducer with detailed instructions: https://github.com/Ladicek/quarkus-jaeger-metrics-hot-reload-issue", "author": "Ladicek", "createdAt": "2020-04-09T08:49:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA2NjUxMA==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406066510", "bodyText": "@Ladicek  Ha! Thanks for the reproducer. I think I understand why this happens now and why it didn't happen with my reproducer: your application does not have a dependency on the quarkus-smallrye-metrics module, so the metrics processor doesn't run and doesn't register the task to clean up registries during reload.\nBut what now? Is it correct that Jaeger registers metrics even if the application does not declare a dependency on quarkus-smallrye-metrics? In other extensions, we generally try to make their dependency on metrics optional, so metrics are activated only if the user explicitly adds the  quarkus-smallrye-metrics dependency.", "author": "jmartisk", "createdAt": "2020-04-09T09:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA2ODQ4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406068483", "bodyText": "And if we can't make changes to the Jaeger extension such that metrics become optional (and we can run without them completely), then I suppose we should make the Jaeger extension depend on quarkus-smallrye-metrics-deployment in order to make sure that the metrics processor is always applied and can do proper cleanup", "author": "jmartisk", "createdAt": "2020-04-09T09:16:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA3NTEyMw==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406075123", "bodyText": "It also happens that if the Metrics extension is not present (as in your reproducer), then metrics are not being exposed on the /metrics endpoint, so they are quite useless.", "author": "jmartisk", "createdAt": "2020-04-09T09:27:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA4NzkwMg==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406087902", "bodyText": "Now that is ... interesting. quarkus-jaeger depends on smallrye-metrics and microprofile-metrics-api, but not on quarkus-smallrye-metrics. That is ... wrong, for sure.", "author": "Ladicek", "createdAt": "2020-04-09T09:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA4ODM2MA==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406088360", "bodyText": "Or perhaps that was done to make metrics semi-optional...", "author": "Ladicek", "createdAt": "2020-04-09T09:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA5MjcyMQ==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406092721", "bodyText": "@jmartisk What's the way to detect if metrics are enabled? I guess capabilities.isCapabilityPresent(Capabilities.METRICS)? If so, then we could decide on that and add either NoopMetricsFactory or QuarkusJaegerMetricsFactory. And probably make the dependencies on smallrye-metrics and microprofile-metrics-api <scope>provided</scope>, because they are only present to be able to compile QuarkusJaegerMetricsFactory. Does that sound about right? If so, I can check if that works and submit a PR.", "author": "Ladicek", "createdAt": "2020-04-09T09:57:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjExMjM4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406112382", "bodyText": "@Ladicek yes, checking for the capability is ok.\nI think the correct way is have an optional dependency on quarkus-smallrye-metrics, like Agroal does it:\nhttps://github.com/quarkusio/quarkus/blob/master/extensions/agroal/runtime/pom.xml#L44", "author": "jmartisk", "createdAt": "2020-04-09T10:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjExNTIyNw==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406115227", "bodyText": "And what would be absolutely optimal and consistent with most other extensions, would be that the metrics from the extension are disabled by default (even if the metrics dependency is present) and have to be enabled by a config property quarkus.jaeger.metrics.enabled. See https://quarkus.io/guides/writing-extensions#extension-metrics\nEven more optimal would be using the Metrics SPI (mentioned in the linked document) to register metrics eagerly, but if you feel that's too much for now, I guess we can leave that for later :)", "author": "jmartisk", "createdAt": "2020-04-09T10:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjExNzY5Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406117693", "bodyText": "Seriously? \ud83d\ude2e \ud83d\ude01", "author": "Ladicek", "createdAt": "2020-04-09T10:44:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEyNDAzMw==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406124033", "bodyText": "I mean, I would probably be able to do all that, but that would make this PR pretty large. I just wanted to fix the trace context propagation, found a dev mode issue, included a fix which was tiny, and now this :-/\nHere's my proposal: I already have finished the conditional inclusion/exclusion of metrics based on the capability. I have also changed quarkus-jaeger to no longer depend on smallrye-metrics and microprofile-metrics-api; instead, it uses an optional dependency on quarkus-smallrye-metrics as you suggest. It seems to work (didn't try native \ud83d\ude01). What's is not done is addressing your 2nd comment, the one starting with \"And what would be absolutely optimal\" -- I'd leave that for future. Agree?", "author": "Ladicek", "createdAt": "2020-04-09T10:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEzMDA2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406130061", "bodyText": "Sure, that's clearly not the goal of this PR.\nI created #8502 for that", "author": "jmartisk", "createdAt": "2020-04-09T11:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEzMDY4OA==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406130688", "bodyText": "Nice, thanks! I'll update this PR in a few minutes.", "author": "Ladicek", "createdAt": "2020-04-09T11:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEzMjYzMQ==", "url": "https://github.com/quarkusio/quarkus/pull/7987#discussion_r406132631", "bodyText": "PR rebased and updated per discussion above.", "author": "Ladicek", "createdAt": "2020-04-09T11:15:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1OTM1OA=="}], "type": "inlineReview"}, {"oid": "362a73dc467ea5e0beb69018c7606e85c5d313b7", "url": "https://github.com/quarkusio/quarkus/commit/362a73dc467ea5e0beb69018c7606e85c5d313b7", "message": "fix OpenTracing trace context propagation with Fault Tolerance @Asynchronous methods\n\nThere used to be a test for that, but didn't involve `@Asynchronous`\nmethods, so was in fact useless. This commit changes the test to\nactually call an `@Asynchronous` method, which revealed an issue.\nThe `smallrye-fault-tolerance-tracing-propagation` dependency was\nmissing, so trace context propagation didn't actually work.\n\nThen, the test also uncovered an issue in SmallRye Fault Tolerance\n(see https://github.com/smallrye/smallrye-fault-tolerance/pull/208),\nwhich is why this commit also brings a new version of it.\n\nIn addition to that, this commit also adds a test for tracing JDBC.", "committedDate": "2020-04-09T11:13:10Z", "type": "commit"}, {"oid": "1b676f39b236dca7b88db9bf79fac496f512d171", "url": "https://github.com/quarkusio/quarkus/commit/1b676f39b236dca7b88db9bf79fac496f512d171", "message": "fix Jaeger metrics collection when SmallRye Metrics is absent\n\nThe Jaeger extension used to collect metrics unconditionally,\neven when the SmallRye Metrics extension wasn't present.\nWith this commit, the Jaeger extension uses `NoopMetricsFactory`\nif SmallRye Metrics are missing, and only uses the real\nmetrics factory if SmallRye Metrics are present.\n\nThis is not totally consistent with how metrics are enabled/disabled\nin all other extensions. Fixing that is left for future.", "committedDate": "2020-04-09T11:13:10Z", "type": "commit"}, {"oid": "1b676f39b236dca7b88db9bf79fac496f512d171", "url": "https://github.com/quarkusio/quarkus/commit/1b676f39b236dca7b88db9bf79fac496f512d171", "message": "fix Jaeger metrics collection when SmallRye Metrics is absent\n\nThe Jaeger extension used to collect metrics unconditionally,\neven when the SmallRye Metrics extension wasn't present.\nWith this commit, the Jaeger extension uses `NoopMetricsFactory`\nif SmallRye Metrics are missing, and only uses the real\nmetrics factory if SmallRye Metrics are present.\n\nThis is not totally consistent with how metrics are enabled/disabled\nin all other extensions. Fixing that is left for future.", "committedDate": "2020-04-09T11:13:10Z", "type": "forcePushed"}]}