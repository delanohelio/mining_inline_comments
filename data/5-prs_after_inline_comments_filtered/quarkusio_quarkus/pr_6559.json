{"pr_number": 6559, "pr_title": "Expose metrics from Hibernate ORM", "pr_createdAt": "2020-01-15T08:24:53Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/6559", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0NTU2MA==", "url": "https://github.com/quarkusio/quarkus/pull/6559#discussion_r367145560", "bodyText": "It's very minor but it would be easier to understand if this variable was called statistics.", "author": "gsmet", "createdAt": "2020-01-15T22:40:29Z", "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/metrics/HibernateCounter.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package io.quarkus.hibernate.orm.runtime.metrics;\n+\n+import org.hibernate.SessionFactory;\n+import org.hibernate.stat.Statistics;\n+\n+import io.quarkus.arc.Arc;\n+import io.quarkus.hibernate.orm.runtime.JPAConfig;\n+\n+public class HibernateCounter implements org.eclipse.microprofile.metrics.Counter {\n+\n+    private volatile SessionFactory sessionFactory;\n+    private String persistenceUnitName;\n+    private String metric;\n+\n+    public HibernateCounter() {\n+    }\n+\n+    public HibernateCounter(String persistenceUnitName, String metric) {\n+        this.persistenceUnitName = persistenceUnitName;\n+        this.metric = metric;\n+    }\n+\n+    public String getPersistenceUnitName() {\n+        return persistenceUnitName;\n+    }\n+\n+    public void setPersistenceUnitName(String persistenceUnitName) {\n+        this.persistenceUnitName = persistenceUnitName;\n+    }\n+\n+    public String getMetric() {\n+        return metric;\n+    }\n+\n+    public void setMetric(String metric) {\n+        this.metric = metric;\n+    }\n+\n+    @Override\n+    public long getCount() {\n+        Statistics metrics = getSessionFactory().getStatistics();", "originalCommit": "f35a70fa423bc48b308970fd258e3a9cf8c8c80b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0NjE3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/6559#discussion_r367146173", "bodyText": "Is it the norm to use dots everywhere? hibernate.second-level-cache.puts would have felt more natural to me.", "author": "gsmet", "createdAt": "2020-01-15T22:42:07Z", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -345,6 +349,163 @@ public void startPersistenceUnits(HibernateOrmRecorder recorder, BeanContainerBu\n         recorder.startAllPersistenceUnits(beanContainer.getValue());\n     }\n \n+    @BuildStep\n+    public void metrics(HibernateOrmConfig config,\n+            BuildProducer<MetricBuildItem> metrics) {\n+        // TODO: When multiple PUs are supported, create metrics for each PU. For now we only assume the \"default\" PU.\n+        boolean metricsEnabled = config.metricsEnabled && config.statistics.orElse(true);\n+        metrics.produce(createMetricBuildItem(\"hibernate.sessions.open\",\n+                \"Global number of sessions opened\",\n+                \"sessionsOpened\",\n+                metricsEnabled));\n+        metrics.produce(createMetricBuildItem(\"hibernate.sessions.closed\",\n+                \"Global number of sessions closed\",\n+                \"sessionsClosed\",\n+                metricsEnabled));\n+        metrics.produce(createMetricBuildItem(\"hibernate.sessions.closed\",\n+                \"Global number of sessions closed\",\n+                \"sessionsClosed\",\n+                metricsEnabled));\n+        metrics.produce(createMetricBuildItem(\"hibernate.transactions\",\n+                \"The number of transactions we know to have completed\",\n+                \"transactionCount\",\n+                metricsEnabled));\n+        metrics.produce(createMetricBuildItem(\"hibernate.transactions.successful\",\n+                \"The number of transactions we know to have been successful\",\n+                \"successfulTransactions\",\n+                metricsEnabled));\n+        metrics.produce(createMetricBuildItem(\"hibernate.optimistic.lock.failures\",\n+                \"The number of Hibernate StaleObjectStateExceptions or JPA OptimisticLockExceptions that occurred.\",\n+                \"optimisticLockFailures\",\n+                metricsEnabled));\n+        metrics.produce(createMetricBuildItem(\"hibernate.flushes\",\n+                \"Global number of flush operations executed (either manual or automatic).\",\n+                \"flushes\",\n+                metricsEnabled));\n+        metrics.produce(createMetricBuildItem(\"hibernate.connections.obtained\",\n+                \"Get the global number of connections asked by the sessions \" +\n+                        \"(the actual number of connections used may be much smaller depending \" +\n+                        \"whether you use a connection pool or not)\",\n+                \"connectionsObtained\",\n+                metricsEnabled));\n+        metrics.produce(createMetricBuildItem(\"hibernate.statements.prepared\",\n+                \"The number of prepared statements that were acquired\",\n+                \"statementsPrepared\",\n+                metricsEnabled));\n+        metrics.produce(createMetricBuildItem(\"hibernate.statements.closed\",\n+                \"The number of prepared statements that were released\",\n+                \"statementsClosed\",\n+                metricsEnabled));\n+        metrics.produce(createMetricBuildItem(\"hibernate.second.level.cache.puts\",", "originalCommit": "f35a70fa423bc48b308970fd258e3a9cf8c8c80b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI0NDI0MQ==", "url": "https://github.com/quarkusio/quarkus/pull/6559#discussion_r367244241", "bodyText": "Ok. I changed natural.id and query.cache and timestamps.cache too in a similar fashion", "author": "jmartisk", "createdAt": "2020-01-16T06:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0NjE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0NjQzNA==", "url": "https://github.com/quarkusio/quarkus/pull/6559#discussion_r367146434", "bodyText": "Could you use an hibernate-orm prefix instead to be consistent with the extension? Moreover, we really want it to be branded as Hibernate ORM because we also have Validator and Search.", "author": "gsmet", "createdAt": "2020-01-15T22:42:52Z", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -345,6 +349,163 @@ public void startPersistenceUnits(HibernateOrmRecorder recorder, BeanContainerBu\n         recorder.startAllPersistenceUnits(beanContainer.getValue());\n     }\n \n+    @BuildStep\n+    public void metrics(HibernateOrmConfig config,\n+            BuildProducer<MetricBuildItem> metrics) {\n+        // TODO: When multiple PUs are supported, create metrics for each PU. For now we only assume the \"default\" PU.\n+        boolean metricsEnabled = config.metricsEnabled && config.statistics.orElse(true);\n+        metrics.produce(createMetricBuildItem(\"hibernate.sessions.open\",", "originalCommit": "f35a70fa423bc48b308970fd258e3a9cf8c8c80b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ff77c36b608bc1128b09e09678c29fa7bc0d08fa", "url": "https://github.com/quarkusio/quarkus/commit/ff77c36b608bc1128b09e09678c29fa7bc0d08fa", "message": "Expose metrics from Hibernate ORM", "committedDate": "2020-01-16T06:01:51Z", "type": "forcePushed"}, {"oid": "cffcfe35c116cc114b4c7862add23964abdbab22", "url": "https://github.com/quarkusio/quarkus/commit/cffcfe35c116cc114b4c7862add23964abdbab22", "message": "Expose metrics from Hibernate ORM", "committedDate": "2020-01-20T05:45:28Z", "type": "commit"}, {"oid": "cffcfe35c116cc114b4c7862add23964abdbab22", "url": "https://github.com/quarkusio/quarkus/commit/cffcfe35c116cc114b4c7862add23964abdbab22", "message": "Expose metrics from Hibernate ORM", "committedDate": "2020-01-20T05:45:28Z", "type": "forcePushed"}]}