{"pr_number": 2138, "pr_title": "#2136 performance improvement 2 step mappings", "pr_createdAt": "2020-07-04T19:08:47Z", "pr_url": "https://github.com/mapstruct/mapstruct/pull/2138", "timeline": [{"oid": "62efe5977c3719bad195841ab331176d1b2ce995", "url": "https://github.com/mapstruct/mapstruct/commit/62efe5977c3719bad195841ab331176d1b2ce995", "message": "#2136 performance improvement 2 step mappings", "committedDate": "2020-07-04T19:08:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODQwMQ==", "url": "https://github.com/mapstruct/mapstruct/pull/2138#discussion_r449798401", "bodyText": "What if the method is not one of these types? It can be an intermediate ForgedMethod or an existing HelperMethod that we have created. Why shouldn't we reuse that one?", "author": "filiphr", "createdAt": "2020-07-04T19:17:22Z", "path": "processor/src/main/java/org/mapstruct/ap/internal/processor/creation/MappingResolverImpl.java", "diffHunk": "@@ -376,32 +377,56 @@ private Assignment resolveViaMethod(Type sourceType, Type targetType, boolean co\n             return null;\n         }\n \n+        /**\n+         * Applies matching to given method only\n+         *\n+         * @param sourceType the source type\n+         * @param targetType the target type\n+         * @param method     the method to match\n+         * @return an assignment if a match, given the criteria could be found. When the method is a\n+         * buildIn method, all the bookkeeping is applied.\n+         */\n+        private Assignment applyMatching(Type sourceType, Type targetType, Method method) {\n+\n+            if ( method instanceof SourceMethod ) {", "originalCommit": "62efe5977c3719bad195841ab331176d1b2ce995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5OTUyMg==", "url": "https://github.com/mapstruct/mapstruct/pull/2138#discussion_r449799522", "bodyText": "is not possible here.. We don't resolve forged methods.. If so, we should throw an unsupported.", "author": "sjaakd", "createdAt": "2020-07-04T19:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwMDEwMg==", "url": "https://github.com/mapstruct/mapstruct/pull/2138#discussion_r449800102", "bodyText": "You are right", "author": "filiphr", "createdAt": "2020-07-04T19:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwMDU3Mw==", "url": "https://github.com/mapstruct/mapstruct/pull/2138#discussion_r449800573", "bodyText": "resolved, I guess?", "author": "sjaakd", "createdAt": "2020-07-04T19:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODY4OQ==", "url": "https://github.com/mapstruct/mapstruct/pull/2138#discussion_r449798689", "bodyText": "Why is this change needed?\nySourceType and targetTypeX don't have to be the same types I think. One can be more specific then the other.", "author": "filiphr", "createdAt": "2020-07-04T19:21:33Z", "path": "processor/src/main/java/org/mapstruct/ap/internal/processor/creation/MappingResolverImpl.java", "diffHunk": "@@ -486,10 +511,9 @@ private Assignment resolveViaConversionAndMethod(Type sourceType, Type targetTyp\n                 ySourceType = ySourceType.resolveTypeVarToType( targetType, methodYCandidate.getResultType() );\n \n                 if ( ySourceType != null ) {\n-                    methodRefY = resolveViaMethod( ySourceType, targetType, true );\n+                    methodRefY = applyMatching( ySourceType, targetType, methodYCandidate );\n                     if ( methodRefY != null ) {\n-                        Type targetTypeX = methodYCandidate.getSourceParameters().get( 0 ).getType();\n-                        ConversionAssignment conversionXRef = resolveViaConversion( sourceType, targetTypeX );\n+                        ConversionAssignment conversionXRef = resolveViaConversion( sourceType, ySourceType );", "originalCommit": "62efe5977c3719bad195841ab331176d1b2ce995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5OTU1NA==", "url": "https://github.com/mapstruct/mapstruct/pull/2138#discussion_r449799554", "bodyText": "the change was forgotten last time.. it's actually a bug.", "author": "sjaakd", "createdAt": "2020-07-04T19:34:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwMDEwOQ==", "url": "https://github.com/mapstruct/mapstruct/pull/2138#discussion_r449800109", "bodyText": "\ud83d\udc4d", "author": "filiphr", "createdAt": "2020-07-04T19:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5OTEyMw==", "url": "https://github.com/mapstruct/mapstruct/pull/2138#discussion_r449799123", "bodyText": "Perhaps this should be named resolveViaGivenMethod? Or something in that direction. applyMatching differs from the other methods in my opinion", "author": "filiphr", "createdAt": "2020-07-04T19:27:58Z", "path": "processor/src/main/java/org/mapstruct/ap/internal/processor/creation/MappingResolverImpl.java", "diffHunk": "@@ -376,32 +377,56 @@ private Assignment resolveViaMethod(Type sourceType, Type targetType, boolean co\n             return null;\n         }\n \n+        /**\n+         * Applies matching to given method only\n+         *\n+         * @param sourceType the source type\n+         * @param targetType the target type\n+         * @param method     the method to match\n+         * @return an assignment if a match, given the criteria could be found. When the method is a\n+         * buildIn method, all the bookkeeping is applied.\n+         */\n+        private Assignment applyMatching(Type sourceType, Type targetType, Method method) {", "originalCommit": "62efe5977c3719bad195841ab331176d1b2ce995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5OTYyMQ==", "url": "https://github.com/mapstruct/mapstruct/pull/2138#discussion_r449799621", "bodyText": "not entirely.. We still have to apply all criteria to really figure out if it matches (qualifiers, xml-stuff, resultTypes, etc)", "author": "sjaakd", "createdAt": "2020-07-04T19:35:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5OTEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwMDE1Ng==", "url": "https://github.com/mapstruct/mapstruct/pull/2138#discussion_r449800156", "bodyText": "OK", "author": "filiphr", "createdAt": "2020-07-04T19:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5OTEyMw=="}], "type": "inlineReview"}]}