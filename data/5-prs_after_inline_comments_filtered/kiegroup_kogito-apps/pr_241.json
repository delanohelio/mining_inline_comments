{"pr_number": 241, "pr_title": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "pr_createdAt": "2020-06-01T16:17:06Z", "pr_url": "https://github.com/kiegroup/kogito-apps/pull/241", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0Njg4OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r433346889", "bodyText": "Keycloack -> Keycloak", "author": "jstastny-cz", "createdAt": "2020-06-01T16:26:37Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -66,27 +70,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloackServedTest(){", "originalCommit": "f19843236009e0554d187eaeb530c2a62936c547", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ4ODIwMg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r434488202", "bodyText": "ups! thanks!", "author": "nmirasch", "createdAt": "2020-06-03T11:09:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0Njg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0Njk3OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r433346978", "bodyText": "why moving this from application.properties to here?", "author": "jstastny-cz", "createdAt": "2020-06-01T16:26:43Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -32,18 +33,25 @@\n @QuarkusTestResource(InfinispanServerTestResource.class)\n public class KeycloakIntegrationIndexingServiceIT {\n \n-    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"keycloak.url\", \"http://localhost:8281/auth\");\n-    private static final String KEYCLOAK_REALM = \"kogito\";\n-    private static final String KEYCLOAK_CLIENT_ID = \"kogito-data-index-service\";\n+    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"quarkus.oidc.auth-server-url\", \"http://localhost:8281/auth/realms/kogito\");\n+    private static final String KEYCLOAK_CLIENT_ID = System.getProperty(\"quarkus.oidc.client-id\", \"kogito-data-index-service\");\n+    private static final String KEYCLOAK_CLIENT_SECRET = System.getProperty(\"quarkus.oidc.credentials.secret\", \"secret\");\n+\n+    @BeforeAll\n+    public static void setup() {\n+        System.setProperty(\"quarkus.http.auth.policy.role-policy1.roles-allowed\", \"confidential\");", "originalCommit": "f19843236009e0554d187eaeb530c2a62936c547", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ4OTQ3Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r434489472", "bodyText": "@jstastny-cz yeah, I agree,  I have removed this. The purpose of this properties setting were regarding isolate  testing at my local, no need to be there.", "author": "nmirasch", "createdAt": "2020-06-03T11:11:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0Njk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0ODUxNA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r433348514", "bodyText": "Is the status code under our control? Some sites use 302 code to signal that the page is there, but something still needs to be done to access it.", "author": "jstastny-cz", "createdAt": "2020-06-01T16:29:35Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -66,27 +70,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloackServedTest(){\n+        // Returning keycloak login page\n+        given().when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);", "originalCommit": "f19843236009e0554d187eaeb530c2a62936c547", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ5MTExNg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r434491116", "bodyText": "@jstastny-cz Yeah, that value is the one returned by the quarkus oidc extension when it's configured as web-app. It returns request code for 'OK' and redirect to keycloak login.", "author": "nmirasch", "createdAt": "2020-06-03T11:15:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0ODUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDQ2NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444634465", "bodyText": "@nmirasch can we perhaps validate something in the body of the response that it actually redirected to Keycloack login page?", "author": "cristianonicolai", "createdAt": "2020-06-24T04:14:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0ODUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ3NzgwNw==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r445477807", "bodyText": "@nmirasch I think just this one needs some improvement. A 200 could also be returned if the auth is disabled right? Anything that checks that it actually reached the login page.", "author": "cristianonicolai", "createdAt": "2020-06-25T11:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0ODUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNjA2NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r447416065", "bodyText": "@nmirasch ^", "author": "cristianonicolai", "createdAt": "2020-06-30T05:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0ODUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM4OTQwMA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r433389400", "bodyText": "so this decides which tenant is accessing the app based on the context, right. graphiql is a UI, thus web-app-tenant should be used, otherwise it will resort to the default config, is that correct?", "author": "jstastny-cz", "createdAt": "2020-06-01T17:46:20Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/auth/MultiTenantResolver.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+\n+import io.quarkus.oidc.TenantResolver;\n+import io.vertx.ext.web.RoutingContext;\n+\n+@ApplicationScoped\n+public class MultiTenantResolver implements TenantResolver {\n+\n+    @Override\n+    public String resolve(RoutingContext context) {\n+        if (context.request().path().startsWith(\"/graphiql\")) {", "originalCommit": "f19843236009e0554d187eaeb530c2a62936c547", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ5MzI4OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r434493288", "bodyText": "@jstastny-cz Correct! that's the idea, define a different oidc configuration for the ui (graphiql) and the graphql service. Regarding the keycloak authentication workflows are different in both cases.", "author": "nmirasch", "createdAt": "2020-06-03T11:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM4OTQwMA=="}], "type": "inlineReview"}, {"oid": "e54775d4f203377ca959a464f1f7d0a9b419a0c1", "url": "https://github.com/kiegroup/kogito-apps/commit/e54775d4f203377ca959a464f1f7d0a9b419a0c1", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-03T10:51:14Z", "type": "forcePushed"}, {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743", "url": "https://github.com/kiegroup/kogito-apps/commit/9c94276237755eb4f2c55f2f09ee82a811aee743", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-03T11:06:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxNzM2MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435017361", "bodyText": "At the moment, I see these hard-coded values:\n\n\"graphiql\": before this PR, this value was only used in VertxRouterSetup, but now it's used also in MultiTenantResolved and KeycloakIntegrationIndexingServiceIT.\n\"web-app-tenant\": it's used here and in the properties to configure the oidc properties.\n\nWhat about to add a property to define the \"graphiql\" property:\n\u00b4\u00b4\u00b4\ndataindex.vertx-graphql.ui.path=/graphiql\n\u00b4\u00b4\u00b4\n| Note that the name property is in sync with the default vertx property called \"quarkus.vertx-graphql.ui.path\" (more in here)\nAnd also define the tenants for each path in the properties:\ndataindex.paths.\"/graphiql\".tenant=web-app-tenant\n\nThis way we can configure the tenants and configuration entirely driven by properties:\n%keycloak.quarkus.oidc.web-app-tenant.auth-server-url=http://localhost:8280/auth/realms/kogito\n%keycloak.quarkus.oidc.web-app-tenant.client-id=kogito-data-index-service\n%keycloak.quarkus.oidc.web-app-tenant.credentials.secret=secret\n%keycloak.quarkus.oidc.web-app-tenant.application-type=web-app\n\nAnd we can even define more custom tenants for different paths:\ndataindex.paths.\"/custom\".tenant=custom-app-tenant\n%keycloak.quarkus.oidc.custom-app-tenant.auth-server-url=http://localhost:8280/auth/realms/kogitocustom\n\nThis is specially interesting to define different roles by paths.\nWhat do you think?", "author": "Sgitario", "createdAt": "2020-06-04T06:22:35Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/auth/MultiTenantResolver.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+\n+import io.quarkus.oidc.TenantResolver;\n+import io.vertx.ext.web.RoutingContext;\n+\n+@ApplicationScoped\n+public class MultiTenantResolver implements TenantResolver {", "originalCommit": "9c94276237755eb4f2c55f2f09ee82a811aee743", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE4MjQ4OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435182489", "bodyText": "Hi @Sgitario, I think it's a good idea of making the graphiql path and oidc-tenant  given as configuration properties.Let me give it a try Thanks!", "author": "nmirasch", "createdAt": "2020-06-04T11:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxNzM2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxODIxOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435018219", "bodyText": "I know this was not changed as part of this PR, but what is the difference between the graphiql and graphql? As far I can see in here, the graphql is only available when running the data index in dev mode?\nCan we remove the \"/graphql\" path and use the property \"quarkus.vertx-graphql.ui.path\" instead? So if in the future, we change this property, we don't need to change this class.", "author": "Sgitario", "createdAt": "2020-06-04T06:24:51Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -43,14 +48,37 @@\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+                MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+                String token = getCurrentAccessToken(rc);\n+                if (token.isEmpty()) {\n+                    token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);\n+                }\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_HEADERS, \"Authorization, Content-Type, Accept\");\n+                multiMap.add(\"Bearer-token\", \"Bearer \" + token);\n+                rc.request().headers().addAll(multiMap);\n+                return multiMap.add(HttpHeaders.AUTHORIZATION, \"Bearer \" + token);\n+            });\n         }\n+        router.route(\"/graphiql/*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));", "originalCommit": "9c94276237755eb4f2c55f2f09ee82a811aee743", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyMzExNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435123115", "bodyText": "That's a different endpoint. graphiql is web app, graphql is the service endpoint.", "author": "jstastny-cz", "createdAt": "2020-06-04T09:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxODIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEzMzEzOA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435133138", "bodyText": "The web application is also exposed via \"graphql-ui\" endpoint (this can be configured via the property \"quarkus.vertx-graphql.ui.path\"). But this is only working when running the app in dev mode (because the property \"quarkus.vertx-graphql.ui.always-include\" defaults to \"false\").\nTherefore, as long as we only have one web app at runtime, we're good. Thanks!", "author": "Sgitario", "createdAt": "2020-06-04T09:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxODIxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyMDMyNw==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435020327", "bodyText": "Suggestion, what about using stream and optionals here?\nprivate String getCurrentAccessToken(RoutingContext routingContext) {\n        return Optional.ofNullable(routingContext.user())\n                .map(user -> ((QuarkusHttpUser) user).getSecurityIdentity())\n                .map(identity -> identity.getCredential(AccessTokenCredential.class))\n                .map(AccessTokenCredential::getToken)\n                .orElse(StringUtils.EMPTY);\n    }\n\nI read this code better like this, what do you think?", "author": "Sgitario", "createdAt": "2020-06-04T06:30:27Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -43,14 +48,37 @@\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+                MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+                String token = getCurrentAccessToken(rc);\n+                if (token.isEmpty()) {\n+                    token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);\n+                }\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_HEADERS, \"Authorization, Content-Type, Accept\");\n+                multiMap.add(\"Bearer-token\", \"Bearer \" + token);\n+                rc.request().headers().addAll(multiMap);\n+                return multiMap.add(HttpHeaders.AUTHORIZATION, \"Bearer \" + token);\n+            });\n         }\n+        router.route(\"/graphiql/*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    private String getCurrentAccessToken(RoutingContext routingContext) {\n+        if ((routingContext.user() != null) &&\n+                ((QuarkusHttpUser) routingContext.user()).getSecurityIdentity() != null &&\n+                ((QuarkusHttpUser) routingContext.user()).getSecurityIdentity().getCredential(AccessTokenCredential.class) != null) {\n+            return ((QuarkusHttpUser) routingContext.user()).getSecurityIdentity().getCredential(AccessTokenCredential.class).getToken();\n+        }\n+        return \"\";\n+    }", "originalCommit": "9c94276237755eb4f2c55f2f09ee82a811aee743", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE4NjE5Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435186196", "bodyText": "Thanks!", "author": "nmirasch", "createdAt": "2020-06-04T11:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyMDMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYyOTQ4Mw==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444629483", "bodyText": "wouldnt be best to not set .orElse(StringUtils.EMPTY); then simply do token.isPresent() as an Optional ?", "author": "cristianonicolai", "createdAt": "2020-06-24T03:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyMDMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjk2OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435032968", "bodyText": "Does it make sense to set the default image properties for infinispan and keycloak?\nI'm using this one for Infinispan:\nprivate static final String INFINISPAN_IMAGE = System.getProperty(\"container.image.infinispan\", \"jboss/infinispan-server:10.1.8.Final\");\n\nAnd this one for keycloak:\nprivate static final String KEYCLOAK_IMAGE = System.getProperty(\"container.image.keycloak\", \"jboss/keycloak:10.0.2\");\n\nSo we can run the tests directly from the IDE with further configuration.", "author": "Sgitario", "createdAt": "2020-06-04T06:59:45Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -32,18 +32,18 @@\n @QuarkusTestResource(InfinispanServerTestResource.class)", "originalCommit": "9c94276237755eb4f2c55f2f09ee82a811aee743", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyMTkxNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435121915", "bodyText": "Not sure what you mean here. Do you mean like in data-index/data-index-service/src/test/java/org/kie/kogito/index/InfinispanServerTestResource.java ? Cause it's already in place.", "author": "jstastny-cz", "createdAt": "2020-06-04T09:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyNDI3MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435124270", "bodyText": "I mean to add a default image in case of the property is not set.", "author": "Sgitario", "createdAt": "2020-06-04T09:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEzMDA0Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435130042", "bodyText": "I would argue against. Having configuration of the images both in pom and in code is not manageable easily, it could hide the fact that you've forgotten to set the property, the \"somewhere defined default\" could become outdated, etc. Anyway that should not be taken care of as part of this PR.", "author": "jstastny-cz", "createdAt": "2020-06-04T09:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEzNzE5MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435137190", "bodyText": "Ok with taking care of this as part of another ticket.\nMy against of having properties in the POM file is that is not IDE compatible (we can't run suites or single tests directly from the IDE) and for me, this is really useful for debugging.", "author": "Sgitario", "createdAt": "2020-06-04T10:00:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEzOTgzOA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435139838", "bodyText": "Well you can, you just need to set the property to your test runner. It's maybe just a question of taste, who likes what. Feel free to open a jira if you like.", "author": "jstastny-cz", "createdAt": "2020-06-04T10:05:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE0NDY2NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435144665", "bodyText": "The problem is that a different test execution is used if we run the whole test suite, or one test or another (at least in Eclipse, not sure about Intellij or VS Code). So, I would need to add the properties in every test execution. Maybe, there could have another approaches.\nHaving these properties in a test.properties (or similar) and injecting this file into Quarkus would work when running the tests from Maven or any IDE.\nHowever, this is out of scope here. I wrote it here as I saw we're using default values for some other properties.", "author": "Sgitario", "createdAt": "2020-06-04T10:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTIwNjc2Nw==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435206767", "bodyText": "@Sgitario I have to say that I have that default value for that props in my local environment to execute test from Intellij.. :-)\nBut maybe we can add there req in another jira just to see it it's convenient .", "author": "nmirasch", "createdAt": "2020-06-04T12:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzODczNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435038735", "bodyText": "There is an extra space here at the beginning.", "author": "Sgitario", "createdAt": "2020-06-04T07:11:48Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -66,27 +62,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloakServedTest(){\n+        // Returning keycloak login page\n+        given().when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);\n+        // Returning keycloak login page\n+        given().auth().oauth2(getAccessToken(\"jdoe\"))\n+                .when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);\n+         given().when().get(\"/other/\")", "originalCommit": "9c94276237755eb4f2c55f2f09ee82a811aee743", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0MTUzOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435041539", "bodyText": "I added this new assertion:\ngiven().auth().oauth2(\"any-wrong-token\")\n        .when().get(\"/graphiql/\")\n        .then().statusCode(401);\n\nAnd it's failing because it retuns 200 OK code. Is this expected? Maybe it's redirecting to a Keycloak page when this is not valid?", "author": "Sgitario", "createdAt": "2020-06-04T07:17:38Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -66,27 +62,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloakServedTest(){", "originalCommit": "9c94276237755eb4f2c55f2f09ee82a811aee743", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTExOTI0Nw==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435119247", "bodyText": "See the comments below, that's the keycloak login page which returns 200.", "author": "jstastny-cz", "createdAt": "2020-06-04T09:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0MTUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA4MTIwMA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435081200", "bodyText": "I'm confused about the tests that cover the \"/graphql\" path.\nI ran the tests using \"mvn clean verify\" and I'm aware of these tests are working fine, but as far I can see in the VertxRouterSetup, we are not doing anything new about this path, right?\nAlso, this path does not allow the GET method, but POST method... so no idea why is working. What am I missing?", "author": "Sgitario", "createdAt": "2020-06-04T08:28:11Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -32,18 +32,18 @@\n @QuarkusTestResource(InfinispanServerTestResource.class)\n public class KeycloakIntegrationIndexingServiceIT {\n \n-    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"keycloak.url\", \"http://localhost:8281/auth\");\n-    private static final String KEYCLOAK_REALM = \"kogito\";\n-    private static final String KEYCLOAK_CLIENT_ID = \"kogito-data-index-service\";\n+    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"quarkus.oidc.auth-server-url\", \"http://localhost:8281/auth/realms/kogito\");\n+    private static final String KEYCLOAK_CLIENT_ID = System.getProperty(\"quarkus.oidc.client-id\", \"kogito-data-index-service\");\n+    private static final String KEYCLOAK_CLIENT_SECRET = System.getProperty(\"quarkus.oidc.credentials.secret\", \"secret\");\n \n     @Test\n     public void testUnauthorizedUserAccess() {\n         //alice only have role User, resource is forbidden\n-        given().auth().oauth2(getAccessToken(\"alice\"))\n-                .when().get(\"/graphiql/\")\n+        given().contentType(ContentType.JSON).body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n+                .auth().oauth2(getAccessToken(\"alice\"))\n+                .when().get(\"/graphql\")\n                 .then()\n-                .statusCode(404);\n-\n+                .statusCode(403);", "originalCommit": "9c94276237755eb4f2c55f2f09ee82a811aee743", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTExODgyNA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435118824", "bodyText": "IMO the important fact is here that the user is not authorized to access the web context, details like methods allowed would be probably checked later on.", "author": "jstastny-cz", "createdAt": "2020-06-04T09:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA4MTIwMA=="}], "type": "inlineReview"}, {"oid": "15bbf07928ed39c63e8571adab174481de035407", "url": "https://github.com/kiegroup/kogito-apps/commit/15bbf07928ed39c63e8571adab174481de035407", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-04T16:35:16Z", "type": "forcePushed"}, {"oid": "7e11ecc44e8a19c818c8d5e3833124b04530d5d2", "url": "https://github.com/kiegroup/kogito-apps/commit/7e11ecc44e8a19c818c8d5e3833124b04530d5d2", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-09T10:29:45Z", "type": "forcePushed"}, {"oid": "32f468f63fbbc7d7436d1b422300716826129e5e", "url": "https://github.com/kiegroup/kogito-apps/commit/32f468f63fbbc7d7436d1b422300716826129e5e", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-11T05:41:47Z", "type": "forcePushed"}, {"oid": "530722473d09f381acd45280813b0a40460d1a7c", "url": "https://github.com/kiegroup/kogito-apps/commit/530722473d09f381acd45280813b0a40460d1a7c", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-15T08:35:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3NDYyNw==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440074627", "bodyText": "I see there is an existing property for data index component called \"kogito.data-index.storage.type=infinispan\". Maybe we should continue this name convention and rename this property to \"kogito.data-index.vertx-graphql.ui.path\".\nThis also applies to \"kogito.data-index.vertx-graphql.ui.tenant\"", "author": "Sgitario", "createdAt": "2020-06-15T10:17:23Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,44 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.dataindex.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")", "originalCommit": "530722473d09f381acd45280813b0a40460d1a7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0MjY2NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440742665", "bodyText": "done", "author": "nmirasch", "createdAt": "2020-06-16T10:16:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3NDYyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwNTM3Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440105376", "bodyText": "This assertion should be:\nassertThat(multiTenantResolver.resolve(routingContextMock)).isEqualTo(GRAPH_UI_TENANT);", "author": "Sgitario", "createdAt": "2020-06-15T11:19:44Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.Before;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.lenient;\n+\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.path\", \"/graphiql\");\n+    private static final String GRAPH_UI_TENANT = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.tenant\", \"web-app-tenant\");\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    HttpServerRequest requestMock;\n+\n+    @InjectMocks\n+    MultiTenantResolver multiTenantResolver;\n+\n+    @Before\n+    public void setup(){\n+        lenient().when(routingContextMock.request()).thenReturn(requestMock);\n+    }\n+\n+    @Test\n+    void resolveGraphiqlTenantTest() {\n+        lenient().when(requestMock.path()).thenReturn(GRAPH_UI_PATH);\n+        assertThat(GRAPH_UI_TENANT.equals(multiTenantResolver.resolve(routingContextMock)));", "originalCommit": "530722473d09f381acd45280813b0a40460d1a7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0Mjc2NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440742764", "bodyText": "updated", "author": "nmirasch", "createdAt": "2020-06-16T10:16:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwNTM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExODI0OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440118248", "bodyText": "This is wrong. It should use \"BeforeEach\" annotation as this is running on JUnit 5.", "author": "Sgitario", "createdAt": "2020-06-15T11:46:52Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.Before;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.lenient;\n+\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.path\", \"/graphiql\");\n+    private static final String GRAPH_UI_TENANT = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.tenant\", \"web-app-tenant\");\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    HttpServerRequest requestMock;\n+\n+    @InjectMocks\n+    MultiTenantResolver multiTenantResolver;\n+\n+    @Before", "originalCommit": "530722473d09f381acd45280813b0a40460d1a7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0Mjg1Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440742856", "bodyText": "updated", "author": "nmirasch", "createdAt": "2020-06-16T10:17:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExODI0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExOTAxOA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440119018", "bodyText": "I think this test relies on some properties being injected from a maven profile.\nIn order to make it isolated, what do you think of creating a givenTenantConfigured where:\nprivate void givenTentantIsConfigured() {\n        multiTenantResolver.graphUITenantId = GRAPH_UI_TENANT;\n        multiTenantResolver.graphUIPath = GRAPH_UI_PATH;\n    }", "author": "Sgitario", "createdAt": "2020-06-15T11:48:29Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.Before;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.lenient;\n+\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.path\", \"/graphiql\");\n+    private static final String GRAPH_UI_TENANT = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.tenant\", \"web-app-tenant\");\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    HttpServerRequest requestMock;\n+\n+    @InjectMocks\n+    MultiTenantResolver multiTenantResolver;\n+\n+    @Before\n+    public void setup(){\n+        lenient().when(routingContextMock.request()).thenReturn(requestMock);\n+    }\n+\n+    @Test\n+    void resolveGraphiqlTenantTest() {", "originalCommit": "530722473d09f381acd45280813b0a40460d1a7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0MzAxMg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440743012", "bodyText": "added", "author": "nmirasch", "createdAt": "2020-06-16T10:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExOTAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzNjI3Nw==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440136277", "bodyText": "Should we cover these changes in VertxRouterSetup in an unit test?", "author": "Sgitario", "createdAt": "2020-06-15T12:21:45Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,44 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.dataindex.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {", "originalCommit": "530722473d09f381acd45280813b0a40460d1a7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0MzE0Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440743146", "bodyText": "added", "author": "nmirasch", "createdAt": "2020-06-16T10:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzNjI3Nw=="}], "type": "inlineReview"}, {"oid": "d236f2b7bf3012cd8993e7de3ccba0fdc1f94a04", "url": "https://github.com/kiegroup/kogito-apps/commit/d236f2b7bf3012cd8993e7de3ccba0fdc1f94a04", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-16T09:56:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5NTQ4OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440795489", "bodyText": "I think private methods should go at the bottom after public and protected methods.", "author": "Sgitario", "createdAt": "2020-06-16T12:00:28Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.lenient;\n+\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.data-index.vertx-graphql.ui.path\", \"/graphiql\");\n+    private static final String GRAPH_UI_TENANT = System.getProperty(\"kogito.data-index.vertx-graphql.ui.tenant\", \"web-app-tenant\");\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    HttpServerRequest requestMock;\n+\n+    @InjectMocks\n+    MultiTenantResolver multiTenantResolver;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routingContextMock.request()).thenReturn(requestMock);\n+        givenTenantIsConfigured();\n+    }\n+\n+    private void givenTenantIsConfigured() {", "originalCommit": "d236f2b7bf3012cd8993e7de3ccba0fdc1f94a04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI5Njc4Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r441296786", "bodyText": "@Sgitario Moved, Thanks!", "author": "nmirasch", "createdAt": "2020-06-17T05:55:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5NTQ4OQ=="}], "type": "inlineReview"}, {"oid": "b7a2c116ed849b1955ddf858cc5776093a6036b0", "url": "https://github.com/kiegroup/kogito-apps/commit/b7a2c116ed849b1955ddf858cc5776093a6036b0", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-17T05:53:31Z", "type": "forcePushed"}, {"oid": "b2c4fe3c6be531ba443623087bb624d3f04796ec", "url": "https://github.com/kiegroup/kogito-apps/commit/b2c4fe3c6be531ba443623087bb624d3f04796ec", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-19T06:00:09Z", "type": "forcePushed"}, {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "url": "https://github.com/kiegroup/kogito-apps/commit/6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-22T11:38:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMDEzNg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444630136", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    router.route(graphUIPath +\"*\").handler(graphiQLHandler);\n          \n          \n            \n                    router.route(graphUIPath + \"*\").handler(graphiQLHandler);", "author": "cristianonicolai", "createdAt": "2020-06-24T03:55:21Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,47 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath +\"*\").handler(graphiQLHandler);", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM3ODc1Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r445378756", "bodyText": "done", "author": "nmirasch", "createdAt": "2020-06-25T08:03:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMDEzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMTE2MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444631161", "bodyText": "@nmirasch I think you don't need to set the headers manually, simply return the multimap that vertx will add it automatically?", "author": "cristianonicolai", "createdAt": "2020-06-24T03:59:35Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,47 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath +\"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    protected void addGraphiqlRequestHeader(GraphiQLHandler graphiQLHandler ){\n+        graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+            MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+            String token = getCurrentAccessToken(rc);\n+            if (token.isEmpty()) {\n+                token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);\n+            }\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_HEADERS, \"Authorization, Content-Type, Accept\");\n+            multiMap.add(\"Bearer-token\", \"Bearer \" + token);\n+            rc.request().headers().addAll(multiMap);", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM3ODYxOA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r445378618", "bodyText": "yep, good catch absolutely right, Thanks!", "author": "nmirasch", "createdAt": "2020-06-25T08:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMTE2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMjEzMg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444632132", "bodyText": "Do we also need this one, isnt just the AUTHORIZATION header the one used to authenticate?", "author": "cristianonicolai", "createdAt": "2020-06-24T04:03:53Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,47 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath +\"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    protected void addGraphiqlRequestHeader(GraphiQLHandler graphiQLHandler ){\n+        graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+            MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+            String token = getCurrentAccessToken(rc);\n+            if (token.isEmpty()) {\n+                token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);\n+            }\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_HEADERS, \"Authorization, Content-Type, Accept\");\n+            multiMap.add(\"Bearer-token\", \"Bearer \" + token);", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM3OTU1Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r445379556", "bodyText": "I have simplified that headers, just passing the Authorization with the current logged user token.", "author": "nmirasch", "createdAt": "2020-06-25T08:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMjEzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMjM3NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444632375", "bodyText": "@nmirasch when you get token like this wouldnt it contain the starting string \"Bearer \" ?", "author": "cristianonicolai", "createdAt": "2020-06-24T04:04:57Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,47 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath +\"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    protected void addGraphiqlRequestHeader(GraphiQLHandler graphiQLHandler ){\n+        graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+            MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+            String token = getCurrentAccessToken(rc);\n+            if (token.isEmpty()) {\n+                token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNzE3OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444637178", "bodyText": "do we actually need or is there a situation where the user could get to the GraphiQL UI and not be logged in or have access to it via a token in the authorization header? Perhaps we can simply send the current access token all the time?", "author": "cristianonicolai", "createdAt": "2020-06-24T04:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMjM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4MDU1OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r445380559", "bodyText": "agree, simplified :)", "author": "nmirasch", "createdAt": "2020-06-25T08:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMjM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMzEwMQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444633101", "bodyText": "@nmirasch just curious why do we need to use lenient in these tests?", "author": "cristianonicolai", "createdAt": "2020-06-24T04:08:07Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.lenient;\n+\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.data-index.vertx-graphql.ui.path\", \"/graphiql\");\n+    private static final String GRAPH_UI_TENANT = System.getProperty(\"kogito.data-index.vertx-graphql.ui.tenant\", \"web-app-tenant\");\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    HttpServerRequest requestMock;\n+\n+    @InjectMocks\n+    MultiTenantResolver multiTenantResolver;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routingContextMock.request()).thenReturn(requestMock);", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMzg5Nw==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444633897", "bodyText": "@nmirasch I got confused here, are we just running the same get request twice?", "author": "cristianonicolai", "createdAt": "2020-06-24T04:11:44Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -31,18 +31,18 @@\n @QuarkusTestResource(DataIndexInfinispanServerTestResource.class)\n public class KeycloakIntegrationIndexingServiceIT {\n \n-    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"keycloak.url\", \"http://localhost:8281/auth\");\n-    private static final String KEYCLOAK_REALM = \"kogito\";\n-    private static final String KEYCLOAK_CLIENT_ID = \"kogito-data-index-service\";\n+    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"quarkus.oidc.auth-server-url\", \"http://localhost:8281/auth/realms/kogito\");\n+    private static final String KEYCLOAK_CLIENT_ID = System.getProperty(\"quarkus.oidc.client-id\", \"kogito-data-index-service\");\n+    private static final String KEYCLOAK_CLIENT_SECRET = System.getProperty(\"quarkus.oidc.credentials.secret\", \"secret\");\n \n     @Test\n     public void testUnauthorizedUserAccess() {\n         //alice only have role User, resource is forbidden\n-        given().auth().oauth2(getAccessToken(\"alice\"))\n-                .when().get(\"/graphiql/\")\n+        given().contentType(ContentType.JSON).body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQwMDcyOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r445400729", "bodyText": "yep double check removed", "author": "nmirasch", "createdAt": "2020-06-25T08:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMzg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDcwOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444634709", "bodyText": "not sure I get the point to check this endpoint as it will always return 404, with or without security :)", "author": "cristianonicolai", "createdAt": "2020-06-24T04:14:58Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -65,27 +61,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloakServedTest() {\n+        // Returning keycloak login page\n+        given().when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);\n+        // Returning keycloak login page\n+        given().auth().oauth2(getAccessToken(\"jdoe\"))\n+                .when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);\n+        given().when().get(\"/other/\")", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDk0NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444634944", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    vertxRouterSetup.graphUIPath=\"/graphiql\";\n          \n          \n            \n                    vertxRouterSetup.graphUIPath = \"/graphiql\";", "author": "cristianonicolai", "createdAt": "2020-06-24T04:15:57Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTAyNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444635025", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    vertxRouterSetup.graphUIPath=\"/graphiql\";\n          \n          \n            \n                    vertxRouterSetup.graphUIPath = \"/graphiql\";", "author": "cristianonicolai", "createdAt": "2020-06-24T04:16:20Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTA2Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444635066", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());\n          \n          \n            \n                    verify(vertxRouterSetup, never()).addGraphiqlRequestHeader(any());", "author": "cristianonicolai", "createdAt": "2020-06-24T04:16:31Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4MDY0NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r445380645", "bodyText": "done", "author": "nmirasch", "createdAt": "2020-06-25T08:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTE5Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444635196", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ArgumentCaptor<MultiMap> multimapCaptor =ArgumentCaptor.forClass(MultiMap.class);\n          \n          \n            \n                    ArgumentCaptor<MultiMap> multimapCaptor = ArgumentCaptor.forClass(MultiMap.class);", "author": "cristianonicolai", "createdAt": "2020-06-24T04:17:10Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAddGraphiqlRequestHeader() {\n+        GraphiQLHandler graphiQLHandlerMock = mock(GraphiQLHandler.class);\n+        HttpServerRequest requestMock = mock(HttpServerRequest.class);\n+        MultiMap multiMapMock = mock(MultiMap.class);\n+        String token = \"TEST_TOKEN\";\n+        when(routingContextMock.request()).thenReturn(requestMock);\n+        when(requestMock.getHeader(HttpHeaders.AUTHORIZATION)).thenReturn(token);\n+        when(requestMock.headers()).thenReturn(multiMapMock);\n+\n+        vertxRouterSetup.addGraphiqlRequestHeader(graphiQLHandlerMock);\n+\n+        ArgumentCaptor<Function<RoutingContext, MultiMap>> functionCaptor =ArgumentCaptor.forClass(Function.class);\n+        verify(graphiQLHandlerMock).graphiQLRequestHeaders(functionCaptor.capture());\n+        functionCaptor.getValue().apply(routingContextMock);\n+\n+        ArgumentCaptor<MultiMap> multimapCaptor =ArgumentCaptor.forClass(MultiMap.class);", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4MDcwNg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r445380706", "bodyText": "done", "author": "nmirasch", "createdAt": "2020-06-25T08:06:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTE5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTIxOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444635219", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ArgumentCaptor<Function<RoutingContext, MultiMap>> functionCaptor =ArgumentCaptor.forClass(Function.class);\n          \n          \n            \n                    ArgumentCaptor<Function<RoutingContext, MultiMap>> functionCaptor = ArgumentCaptor.forClass(Function.class);", "author": "cristianonicolai", "createdAt": "2020-06-24T04:17:17Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAddGraphiqlRequestHeader() {\n+        GraphiQLHandler graphiQLHandlerMock = mock(GraphiQLHandler.class);\n+        HttpServerRequest requestMock = mock(HttpServerRequest.class);\n+        MultiMap multiMapMock = mock(MultiMap.class);\n+        String token = \"TEST_TOKEN\";\n+        when(routingContextMock.request()).thenReturn(requestMock);\n+        when(requestMock.getHeader(HttpHeaders.AUTHORIZATION)).thenReturn(token);\n+        when(requestMock.headers()).thenReturn(multiMapMock);\n+\n+        vertxRouterSetup.addGraphiqlRequestHeader(graphiQLHandlerMock);\n+\n+        ArgumentCaptor<Function<RoutingContext, MultiMap>> functionCaptor =ArgumentCaptor.forClass(Function.class);", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTg4Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444635882", "bodyText": "@nmirasch I think it makes sense to also test when the token is provided by the request headers. perhaps a new test method?", "author": "cristianonicolai", "createdAt": "2020-06-24T04:20:25Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAddGraphiqlRequestHeader() {", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNjEzNg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444636136", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(multimapCaptor.getValue().get(HttpHeaders.AUTHORIZATION).equals(\"Bearer \" + token));\n          \n          \n            \n                    assertThat(multimapCaptor.getValue().get(HttpHeaders.AUTHORIZATION)).isEqualTo(\"Bearer \" + token);", "author": "cristianonicolai", "createdAt": "2020-06-24T04:21:30Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAddGraphiqlRequestHeader() {\n+        GraphiQLHandler graphiQLHandlerMock = mock(GraphiQLHandler.class);\n+        HttpServerRequest requestMock = mock(HttpServerRequest.class);\n+        MultiMap multiMapMock = mock(MultiMap.class);\n+        String token = \"TEST_TOKEN\";\n+        when(routingContextMock.request()).thenReturn(requestMock);\n+        when(requestMock.getHeader(HttpHeaders.AUTHORIZATION)).thenReturn(token);\n+        when(requestMock.headers()).thenReturn(multiMapMock);\n+\n+        vertxRouterSetup.addGraphiqlRequestHeader(graphiQLHandlerMock);\n+\n+        ArgumentCaptor<Function<RoutingContext, MultiMap>> functionCaptor =ArgumentCaptor.forClass(Function.class);\n+        verify(graphiQLHandlerMock).graphiQLRequestHeaders(functionCaptor.capture());\n+        functionCaptor.getValue().apply(routingContextMock);\n+\n+        ArgumentCaptor<MultiMap> multimapCaptor =ArgumentCaptor.forClass(MultiMap.class);\n+        verify(multiMapMock).addAll(multimapCaptor.capture());\n+\n+        assertThat(multimapCaptor.getValue().get(HttpHeaders.AUTHORIZATION).equals(\"Bearer \" + token));", "originalCommit": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13723fe87a6015be833315f2d972490c32ad857a", "url": "https://github.com/kiegroup/kogito-apps/commit/13723fe87a6015be833315f2d972490c32ad857a", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI).", "committedDate": "2020-06-25T08:00:23Z", "type": "forcePushed"}, {"oid": "521228264d4da58c0af6b75cc44046deedc98ba3", "url": "https://github.com/kiegroup/kogito-apps/commit/521228264d4da58c0af6b75cc44046deedc98ba3", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI).", "committedDate": "2020-06-25T08:36:12Z", "type": "forcePushed"}, {"oid": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a", "url": "https://github.com/kiegroup/kogito-apps/commit/40dbe4135ad6bdea4d8d883c517d5804ef3c381a", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-29T11:23:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwOTg4MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r446909881", "bodyText": "@nmirasch Can this be a reusable utils function instead of duplicating it?", "author": "cristianonicolai", "createdAt": "2020-06-29T11:50:11Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,46 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath + \"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(getGraphUIAllowedPath()).handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    protected void addGraphiqlRequestHeader(GraphiQLHandler graphiQLHandler) {\n+        graphiQLHandler.graphiQLRequestHeaders(rc ->\n+                                                       MultiMap.caseInsensitiveMultiMap().add(HttpHeaders.AUTHORIZATION, \"Bearer \" + getCurrentAccessToken(rc))\n+        );\n+    }\n+\n+    private String getCurrentAccessToken(RoutingContext routingContext) {\n+        return Optional.ofNullable(routingContext.user())\n+                .map(user -> ((QuarkusHttpUser) user).getSecurityIdentity())\n+                .map(identity -> identity.getCredential(AccessTokenCredential.class))\n+                .map(AccessTokenCredential::getToken)\n+                .orElse(StringUtils.EMPTY);\n+    }\n+\n+    private String getGraphUIAllowedPath() {", "originalCommit": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxMzUyNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r446913525", "bodyText": "@cristianonicolai  yes, I thought that but I'm not sure where makes sense to have it. I had the temptation to add a property for that.", "author": "nmirasch", "createdAt": "2020-06-29T11:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwOTg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxODk2MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r446918961", "bodyText": "to be honest, I dont see much value to allow customizing this endpoint.", "author": "cristianonicolai", "createdAt": "2020-06-29T12:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwOTg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNDM3Nw==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r447414377", "bodyText": "@cristianonicolai  agree, I keep that as it was before", "author": "nmirasch", "createdAt": "2020-06-30T05:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwOTg4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxNTg3MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r446915871", "bodyText": "should the default be just /graphiql ?", "author": "cristianonicolai", "createdAt": "2020-06-29T12:01:07Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/auth/MultiTenantResolver.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+\n+import io.quarkus.oidc.TenantResolver;\n+import io.vertx.ext.web.RoutingContext;\n+import org.eclipse.microprofile.config.inject.ConfigProperty;\n+\n+@ApplicationScoped\n+public class MultiTenantResolver implements TenantResolver {\n+\n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql/\")", "originalCommit": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNDQ5Nw==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r447414497", "bodyText": "updated", "author": "nmirasch", "createdAt": "2020-06-30T05:15:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxNTg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNzI2OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r446907268", "bodyText": "If we provide the default values above, the graphUIPath and graphUITentantId will never be null.", "author": "Sgitario", "createdAt": "2020-06-29T11:45:27Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/auth/MultiTenantResolver.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+\n+import io.quarkus.oidc.TenantResolver;\n+import io.vertx.ext.web.RoutingContext;\n+import org.eclipse.microprofile.config.inject.ConfigProperty;\n+\n+@ApplicationScoped\n+public class MultiTenantResolver implements TenantResolver {\n+\n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql/\")\n+    String graphUIPath;\n+\n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.tenant\", defaultValue = \"web-app-tenant\")\n+    String graphUITenantId;\n+\n+    @Override\n+    public String resolve(RoutingContext context) {\n+        if (graphUIPath != null\n+                && graphUITenantId != null", "originalCommit": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNDcwNA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r447414704", "bodyText": "@Sgitario yes, removed!", "author": "nmirasch", "createdAt": "2020-06-30T05:16:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNzI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxNzA5MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r446917090", "bodyText": "In order to avoid duplicate code here, does it make sense to have something like:\nrouter.route(graphUIPath + \"*\").handler(setRootLocation());\nrouter.route(\"/\").handler(setRootLocation());\n// ...\n\nprotected Handler<RoutingContext> setRootLocation() {\n     return ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end();\n}", "author": "Sgitario", "createdAt": "2020-06-29T12:03:13Z", "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,46 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath + \"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(getGraphUIAllowedPath()).handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());", "originalCommit": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNTAzNg==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r447415036", "bodyText": "@Sgitario Regarding I just restored the previous served routes, This is not needed now, but thanks!", "author": "nmirasch", "createdAt": "2020-06-30T05:17:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxNzA5MA=="}], "type": "inlineReview"}, {"oid": "0f9f281e2a387266e3cc778d4ca55532c9e0171b", "url": "https://github.com/kiegroup/kogito-apps/commit/0f9f281e2a387266e3cc778d4ca55532c9e0171b", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-29T16:20:00Z", "type": "forcePushed"}, {"oid": "1de19d5bd9ae5285b7554e54f78a8499e754a68b", "url": "https://github.com/kiegroup/kogito-apps/commit/1de19d5bd9ae5285b7554e54f78a8499e754a68b", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-29T21:16:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNTg4OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r447415888", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.data-index.vertx-graphql.ui.path\", \"/graphiql/\");\n          \n          \n            \n                private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.data-index.vertx-graphql.ui.path\", \"/graphiql\");", "author": "cristianonicolai", "createdAt": "2020-06-30T05:20:10Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.data-index.vertx-graphql.ui.path\", \"/graphiql/\");", "originalCommit": "1de19d5bd9ae5285b7554e54f78a8499e754a68b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNjQwMQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r447416401", "bodyText": "@nmirasch I think just this one needs some improvement. A 200 could also be returned if the auth is disabled right? Anything that checks that it actually reached the login page.", "author": "cristianonicolai", "createdAt": "2020-06-30T05:22:03Z", "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -65,27 +56,43 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloakServedTest() {\n+        // Returning keycloak login page\n+        given().when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);", "originalCommit": "1de19d5bd9ae5285b7554e54f78a8499e754a68b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "69938b3bcee827779b54dd712e56381834a24a0e", "url": "https://github.com/kiegroup/kogito-apps/commit/69938b3bcee827779b54dd712e56381834a24a0e", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-30T09:15:20Z", "type": "forcePushed"}, {"oid": "646b063f89cefe51ad73395d5d494c503c2f6917", "url": "https://github.com/kiegroup/kogito-apps/commit/646b063f89cefe51ad73395d5d494c503c2f6917", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-30T09:17:56Z", "type": "commit"}, {"oid": "646b063f89cefe51ad73395d5d494c503c2f6917", "url": "https://github.com/kiegroup/kogito-apps/commit/646b063f89cefe51ad73395d5d494c503c2f6917", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "committedDate": "2020-06-30T09:17:56Z", "type": "forcePushed"}]}