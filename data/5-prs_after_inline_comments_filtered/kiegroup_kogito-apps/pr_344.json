{"pr_number": 344, "pr_title": "KOGITO-2718 creating integration tests for jobs-services into a new module", "pr_createdAt": "2020-07-23T20:11:21Z", "pr_url": "https://github.com/kiegroup/kogito-apps/pull/344", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwNjk1Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r459806956", "bodyText": "@tiagodolphine I think @Sgitario  has been working to make sure tests use random ports to possibly run a few things in parallel, maybe sync with him", "author": "cristianonicolai", "createdAt": "2020-07-24T01:03:29Z", "path": "integration-tests/jobs-service-it/jobs-service-it-springboot/src/test/java/org/kie/kogito/ProcessTimerIT.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/**\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito;\n+\n+import org.junit.jupiter.api.BeforeAll;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.test.annotation.DirtiesContext;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.util.SocketUtils;\n+\n+@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT, classes = {KogitoApplication.class})", "originalCommit": "d3865cfda6bc6d2e468990933957fd1de251bcce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAxNzkzMw==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r460017933", "bodyText": "The problem here is quite different because we need the random port before the application bootstrap to be injected as a configuration property (\"kogito.service.url\") that jobs-service uses to send the callbacks and besides this, we need the current IP address, not the \"localhost\" because the jobs-service is running in a container and it should send requests to the host, that is only achievable by the IP (since it is a different network from the container).", "author": "tiagodolphine", "createdAt": "2020-07-24T12:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwNjk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAxOTE2Mw==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r460019163", "bodyText": "By the way, it is using a random port, doing it programmatically, that is executed as a static method before the application bootstrap.\n@BeforeAll\n    public static void beforeAll() {\n        BaseProcessTimerIT.beforeAll(() -> SocketUtils.findAvailableTcpPort());\n        System.setProperty(\"server.port\", String.valueOf(BaseProcessTimerIT.httpPort));\n    }\n\n@Sgitario @cristianonicolai ^", "author": "tiagodolphine", "createdAt": "2020-07-24T12:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwNjk1Ng=="}], "type": "inlineReview"}, {"oid": "b85b35d804b332a239beb98f5eb55953a5ae7a39", "url": "https://github.com/kiegroup/kogito-apps/commit/b85b35d804b332a239beb98f5eb55953a5ae7a39", "message": "Adding jobs-service container image generation config for integration tests", "committedDate": "2020-08-03T21:05:35Z", "type": "forcePushed"}, {"oid": "9e1e4168c0a9c447675643225f6e1d0879883aa2", "url": "https://github.com/kiegroup/kogito-apps/commit/9e1e4168c0a9c447675643225f6e1d0879883aa2", "message": "Rebasing and fix vervsion on pom, try to fix container and host communication on tests", "committedDate": "2020-08-05T21:33:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzA2Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r466913066", "bodyText": "As the integration-tests is shared across all the kogito apps, I think it's good idea to add a package only for jobs service. What do you think? If so, then the ProcessTimerIT name makes sense.", "author": "Sgitario", "createdAt": "2020-08-07T08:56:58Z", "path": "integration-tests/integration-tests-quarkus/src/test/java/org/kie/kogito/it/ProcessTimerIT.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.it;", "originalCommit": "a3795b243b405149159312fe99627fca2cfcfb44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk1MzQ0OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r466953449", "bodyText": "This line is done here and also in BaseProcessTimerIT.java, but not sure why. I tried removing it in one place and then in the another place and it looks like it's required in both places... do you know why?\nFrom my understanding, it would make more sense to have this functionality here instead of BaseProcessTimerIT.java.", "author": "Sgitario", "createdAt": "2020-08-07T10:19:59Z", "path": "integration-tests/integration-tests-common/src/main/java/org/kie/kogito/testcontainers/JobServiceContainer.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.testcontainers;\n+\n+import java.util.Optional;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.kie.kogito.resources.TestResource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.Testcontainers;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.output.Slf4jLogConsumer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+\n+/**\n+ * This container wraps Infinispan container\n+ *\n+ */\n+public class JobServiceContainer extends GenericContainer<JobServiceContainer> implements TestResource {\n+\n+    public static final String NAME = \"jobs-service\";\n+    public static final int PORT = 8080;\n+    public static final String KOGITO_SERVICE_PORT = \"kogito.service.port\";\n+    public static final String IMAGE = \"container.image.\" + NAME;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(JobServiceContainer.class);\n+\n+    public JobServiceContainer() {\n+        //allow access to the host using hostname \"host.testcontainers.internal\"\n+        final Integer hostPort = Optional.ofNullable(System.getProperty(KOGITO_SERVICE_PORT))\n+                .map(Integer::parseInt)\n+                .orElse(PORT);\n+        Testcontainers.exposeHostPorts(hostPort);", "originalCommit": "a3795b243b405149159312fe99627fca2cfcfb44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwMTUxMw==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r467101513", "bodyText": "The problem is the lifecycle when starting the testcontainer for jobs-service, on Quarkus the container is started after the beforeAll() on the test class where we set the host port/hostname running the test but on SpringBoot test the container is started before it, so it not worked (the hostname could not be resolved inside the container), so that's why I need to set in both places to work with both :(", "author": "tiagodolphine", "createdAt": "2020-08-07T15:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk1MzQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwNDg0OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r467704848", "bodyText": "Ok, thanks for the clarification. I will try to refactor this as a separate task (if I find a way :p ). Mostly, because I would like that the JobServiceContainer is ready to use as it is without needing to configure anything else in your tests. But not important if this is working fine now. Thanks!", "author": "Sgitario", "createdAt": "2020-08-10T06:17:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk1MzQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk1MzYzNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r466953635", "bodyText": "The empty constructor is not necessary.", "author": "Sgitario", "createdAt": "2020-08-07T10:20:24Z", "path": "integration-tests/integration-tests-common/src/main/java/org/kie/kogito/it/BaseProcessTimerIT.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.it;\n+\n+import java.util.function.IntSupplier;\n+\n+import io.restassured.RestAssured;\n+import io.restassured.http.ContentType;\n+import io.restassured.response.ValidatableResponse;\n+import org.junit.jupiter.api.Test;\n+import org.testcontainers.Testcontainers;\n+\n+import static io.restassured.RestAssured.given;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.awaitility.Awaitility.with;\n+import static org.hamcrest.CoreMatchers.notNullValue;\n+import static org.kie.kogito.testcontainers.JobServiceContainer.KOGITO_SERVICE_PORT;\n+\n+public abstract class BaseProcessTimerIT {\n+\n+    public static final String TIMERS = \"timers\";\n+    public static final String TIMERS_CYCLE = \"timerscycle\";\n+    public static final String TIMERS_ON_TASK = \"timersOnTask\";\n+    static Integer httpPort;\n+\n+    public BaseProcessTimerIT() {\n+    }", "originalCommit": "a3795b243b405149159312fe99627fca2cfcfb44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5MDM5Mw==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r467090393", "bodyText": "removed", "author": "tiagodolphine", "createdAt": "2020-08-07T14:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk1MzYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk1MzkyMA==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r466953920", "bodyText": "As some other comments, I think the package should be under jobs service package.", "author": "Sgitario", "createdAt": "2020-08-07T10:20:59Z", "path": "integration-tests/integration-tests-common/src/main/java/org/kie/kogito/it/BaseProcessTimerIT.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.it;", "originalCommit": "a3795b243b405149159312fe99627fca2cfcfb44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5MDM0NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r467090344", "bodyText": "changed", "author": "tiagodolphine", "createdAt": "2020-08-07T14:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk1MzkyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk1NTM4NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r466955384", "bodyText": "Wrong field name, KOGITO_JOBS_SERVICE_PROPERTY.", "author": "Sgitario", "createdAt": "2020-08-07T10:24:19Z", "path": "integration-tests/integration-tests-springboot/src/test/java/org/kie/kogito/resources/JobServiceSpringBootTestResource.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.resources;\n+\n+import org.kie.kogito.testcontainers.JobServiceContainer;\n+\n+/**\n+ * Infinispan spring boot resource that works within the test lifecycle.\n+ *\n+ */\n+public class JobServiceSpringBootTestResource extends ConditionalSpringBootTestResource {\n+\n+    public static final String KOGITO_INFINISPAN_PROPERTY = \"kogito.jobs-service.url\";", "originalCommit": "a3795b243b405149159312fe99627fca2cfcfb44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5MDE5OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/344#discussion_r467090199", "bodyText": "done", "author": "tiagodolphine", "createdAt": "2020-08-07T14:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk1NTM4NA=="}], "type": "inlineReview"}, {"oid": "2adbae6862cac3fd826ac4f04b36f32958849a8b", "url": "https://github.com/kiegroup/kogito-apps/commit/2adbae6862cac3fd826ac4f04b36f32958849a8b", "message": "KOGITO-2718 creating integration tests for jobs-services into a new module\n\nremoving wrong readme.md", "committedDate": "2020-08-07T19:18:35Z", "type": "commit"}, {"oid": "a6463472029ab0b9cf7e2e8882bdede91087582f", "url": "https://github.com/kiegroup/kogito-apps/commit/a6463472029ab0b9cf7e2e8882bdede91087582f", "message": "Moving integration-tests to the parent module and adjust plugin dependencies", "committedDate": "2020-08-07T19:18:35Z", "type": "commit"}, {"oid": "5082e17886d98844f2ccbb37613516efd61e73a6", "url": "https://github.com/kiegroup/kogito-apps/commit/5082e17886d98844f2ccbb37613516efd61e73a6", "message": "inserting junit on test scopoe", "committedDate": "2020-08-07T19:18:35Z", "type": "commit"}, {"oid": "cc57c8b50a63d97ab20f7d762753827085b79d1a", "url": "https://github.com/kiegroup/kogito-apps/commit/cc57c8b50a63d97ab20f7d762753827085b79d1a", "message": "Adding jobs-service container image generation config for integration tests", "committedDate": "2020-08-07T19:18:35Z", "type": "commit"}, {"oid": "bc1943f8fbd48917934b1d5713364c51807086c3", "url": "https://github.com/kiegroup/kogito-apps/commit/bc1943f8fbd48917934b1d5713364c51807086c3", "message": "Adjusting the local address on the integration test", "committedDate": "2020-08-07T19:18:36Z", "type": "commit"}, {"oid": "6826df01ce347fe0509de76fac76d26c34a3c260", "url": "https://github.com/kiegroup/kogito-apps/commit/6826df01ce347fe0509de76fac76d26c34a3c260", "message": "Rebasing and fix vervsion on pom, try to fix container and host communication on tests", "committedDate": "2020-08-07T19:18:36Z", "type": "commit"}, {"oid": "7787d9854bcbdcb57d5782d941c3a85eb453baa0", "url": "https://github.com/kiegroup/kogito-apps/commit/7787d9854bcbdcb57d5782d941c3a85eb453baa0", "message": "Inserting the internal hostname to be used by jobs-service container to acess the host, on the IT", "committedDate": "2020-08-07T19:18:36Z", "type": "commit"}, {"oid": "cc45c1481f3384114ae8c2759adf9a9e4bc519ab", "url": "https://github.com/kiegroup/kogito-apps/commit/cc45c1481f3384114ae8c2759adf9a9e4bc519ab", "message": "code adjusts and sonar issues", "committedDate": "2020-08-07T19:18:37Z", "type": "commit"}, {"oid": "3ffe1e4a8399e4647c79cd9429e5fb3bacb4680e", "url": "https://github.com/kiegroup/kogito-apps/commit/3ffe1e4a8399e4647c79cd9429e5fb3bacb4680e", "message": "Skipping test classes from sonar coverage", "committedDate": "2020-08-07T19:18:37Z", "type": "commit"}, {"oid": "61d45ed6b8b856f30fc9950910c0fd4dbd7e6d67", "url": "https://github.com/kiegroup/kogito-apps/commit/61d45ed6b8b856f30fc9950910c0fd4dbd7e6d67", "message": "Skipping test classes from sonar coverage", "committedDate": "2020-08-07T19:18:37Z", "type": "commit"}, {"oid": "2b7481850bbaee29a75d2b0f16eaa1d9d156e729", "url": "https://github.com/kiegroup/kogito-apps/commit/2b7481850bbaee29a75d2b0f16eaa1d9d156e729", "message": "removing the relativePath from pom", "committedDate": "2020-08-07T19:18:38Z", "type": "commit"}, {"oid": "ec21074c6c393a5b4dfd44dcd680823d1a1c92dd", "url": "https://github.com/kiegroup/kogito-apps/commit/ec21074c6c393a5b4dfd44dcd680823d1a1c92dd", "message": "Applying more PR comments", "committedDate": "2020-08-07T19:18:38Z", "type": "commit"}, {"oid": "ba32b61e79186799082f6e147e6891d78a3d8264", "url": "https://github.com/kiegroup/kogito-apps/commit/ba32b61e79186799082f6e147e6891d78a3d8264", "message": "inserting integration-tests-quarkus/src/main/resources/application.properties cause excetpion during build", "committedDate": "2020-08-07T20:20:26Z", "type": "commit"}, {"oid": "ba32b61e79186799082f6e147e6891d78a3d8264", "url": "https://github.com/kiegroup/kogito-apps/commit/ba32b61e79186799082f6e147e6891d78a3d8264", "message": "inserting integration-tests-quarkus/src/main/resources/application.properties cause excetpion during build", "committedDate": "2020-08-07T20:20:26Z", "type": "forcePushed"}]}