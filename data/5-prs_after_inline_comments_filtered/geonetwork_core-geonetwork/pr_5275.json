{"pr_number": 5275, "pr_title": "Update-fixed-info / Use db dates ", "pr_createdAt": "2020-12-18T08:14:38Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/5275", "timeline": [{"oid": "c264cdeced8f69eac9e3e9f2f48917ba90804b95", "url": "https://github.com/geonetwork/core-geonetwork/commit/c264cdeced8f69eac9e3e9f2f48917ba90804b95", "message": "Update-fixed-info / Set the update date to the same date as in the database. In ISO19115-3, also set record creation date from the database date.", "committedDate": "2020-12-18T08:11:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzQxNQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r546693415", "bodyText": "There's some previous code doing similar stuff:\n\n  \n    \n      core-geonetwork/core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java\n    \n    \n        Lines 918 to 920\n      in\n      c264cde\n    \n    \n    \n    \n\n        \n          \n           if (metadataId.isPresent()) { \n        \n\n        \n          \n               metadata = metadataUtils.findOne(metadataId.get()); \n        \n\n        \n          \n           }", "author": "josegar74", "createdAt": "2020-12-21T13:02:24Z", "path": "core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java", "diffHunk": "@@ -935,7 +935,17 @@ public Element updateFixedInfo(String schema, Optional<Integer> metadataId, Stri\n             env.addContent(schemaLoc);\n \n             if (updateDatestamp == UpdateDatestamp.YES) {\n-                env.addContent(new Element(\"changeDate\").setText(new ISODate().toString()));\n+                String changeDate = new ISODate().toString();\n+                String createDate = \"\";\n+                if (metadataId.isPresent()) {", "originalCommit": "c264cdeced8f69eac9e3e9f2f48917ba90804b95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI2MDUyNA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r612260524", "bodyText": "Indeed", "author": "fxprunayre", "createdAt": "2021-04-13T08:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzgwNQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r546693805", "bodyText": "update-fixed-info is applied before the metadata is saved in the database, no? I think this code will retrieve the previous change date?", "author": "josegar74", "createdAt": "2020-12-21T13:03:24Z", "path": "core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java", "diffHunk": "@@ -935,7 +935,17 @@ public Element updateFixedInfo(String schema, Optional<Integer> metadataId, Stri\n             env.addContent(schemaLoc);\n \n             if (updateDatestamp == UpdateDatestamp.YES) {\n-                env.addContent(new Element(\"changeDate\").setText(new ISODate().toString()));\n+                String changeDate = new ISODate().toString();\n+                String createDate = \"\";\n+                if (metadataId.isPresent()) {\n+                    java.util.Optional<Metadata> record = metadataRepository.findById(metadataId.get());\n+                    if (record.isPresent()) {\n+                        changeDate = record.get().getDataInfo().getChangeDate().getDateAndTime();", "originalCommit": "c264cdeced8f69eac9e3e9f2f48917ba90804b95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjcwMTEzMw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r546701133", "bodyText": "Metadata object is modified before so this is fine.\nBut it does not work on newly created record because the record is not yet in the database. Not sure how can this be solved without adding the creation date as method parameter?", "author": "fxprunayre", "createdAt": "2020-12-21T13:19:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzgwNQ=="}], "type": "inlineReview"}, {"oid": "357c70cdc236888e71f7c1cb6b7f0354065f481f", "url": "https://github.com/geonetwork/core-geonetwork/commit/357c70cdc236888e71f7c1cb6b7f0354065f481f", "message": "Update-fixed-info / Use db dates / Remove existing check", "committedDate": "2021-04-13T08:52:34Z", "type": "commit"}, {"oid": "6c5d30dd0d595fc0ca910635c3242e39aa4272d1", "url": "https://github.com/geonetwork/core-geonetwork/commit/6c5d30dd0d595fc0ca910635c3242e39aa4272d1", "message": "Update-fixed-info / Use db dates / Remove existing check", "committedDate": "2021-04-13T08:53:31Z", "type": "commit"}]}