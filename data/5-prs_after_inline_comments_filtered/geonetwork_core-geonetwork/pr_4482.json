{"pr_number": 4482, "pr_title": "fix memory leak due to incorrect ref count handling (#4481)", "pr_createdAt": "2020-02-27T21:19:46Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4482", "timeline": [{"oid": "dfe48ce70b13d509fae5a0434b532c1fce6b30f7", "url": "https://github.com/geonetwork/core-geonetwork/commit/dfe48ce70b13d509fae5a0434b532c1fce6b30f7", "message": "4481: fix memory leak due to incorrect ref count handling", "committedDate": "2020-02-27T21:07:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUzMTgxMg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4482#discussion_r385531812", "bodyText": "The taxonomyReader is used in LuceneSearcher and CatalogSearcher during the searches to build the facet summary.  In LuceneSearcher:\n\n  \n    \n      core-geonetwork/core/src/main/java/org/fao/geonet/kernel/search/LuceneSearcher.java\n    \n    \n        Lines 1649 to 1662\n      in\n      c085520\n    \n    \n    \n    \n\n        \n          \n           private TopDocs performQuery(ServiceContext context, int startHit, int endHit, boolean buildSummary) throws Exception { \n        \n\n        \n          \n               IndexAndTaxonomy indexAndTaxonomy = _sm.getIndexReader(_language.presentationLanguage, _versionToken); \n        \n\n        \n          \n               _versionToken = indexAndTaxonomy.version; \n        \n\n        \n          \n               Pair<TopDocs, Element> results; \n        \n\n        \n          \n               try { \n        \n\n        \n          \n                   results = doSearchAndMakeSummary(endHit, startHit, endHit, \n        \n\n        \n          \n                       _language.presentationLanguage, \n        \n\n        \n          \n                       _summaryConfig, _luceneConfig, \n        \n\n        \n          \n                       indexAndTaxonomy.indexReader, \n        \n\n        \n          \n                       _query, _filter, _sort, indexAndTaxonomy.taxonomyReader, \n        \n\n        \n          \n                       buildSummary); \n        \n\n        \n          \n               } finally { \n        \n\n        \n          \n                   _sm.releaseIndexReader(indexAndTaxonomy); \n        \n\n        \n          \n               } \n        \n    \n  \n\n\nProbably can be closed, but the existing code is not even calling IndexAndTaxonomy.close(), but _sm.releaseIndexReader(indexAndTaxonomy); that does the same code as in IndexAndTaxonomy.close():\n\n  \n    \n      core-geonetwork/core/src/main/java/org/fao/geonet/kernel/search/SearchManager.java\n    \n    \n        Lines 1211 to 1213\n      in\n      c085520\n    \n    \n    \n    \n\n        \n          \n           public void releaseIndexReader(IndexAndTaxonomy reader) throws InterruptedException, IOException { \n        \n\n        \n          \n               reader.indexReader.releaseToNRTManager(); \n        \n\n        \n          \n           }", "author": "josegar74", "createdAt": "2020-02-28T06:47:03Z", "path": "core/src/main/java/org/fao/geonet/kernel/search/IndexAndTaxonomy.java", "diffHunk": "@@ -44,5 +44,7 @@ public IndexAndTaxonomy(long version, GeonetworkMultiReader indexReader, Taxonom\n     @Override\n     public void close() throws IOException {\n         indexReader.releaseToNRTManager();\n+        //TODO: this has a taxonomyReader in it, and it should be \"closed\" (decrement a ref)", "originalCommit": "dfe48ce70b13d509fae5a0434b532c1fce6b30f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}