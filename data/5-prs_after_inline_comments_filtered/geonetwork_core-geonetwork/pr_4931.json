{"pr_number": 4931, "pr_title": "Security enhancement - support for Keycloak", "pr_createdAt": "2020-08-12T23:14:00Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4931", "timeline": [{"oid": "0a7beeb9ebedba3b5a9c7875952e770830dd9f74", "url": "https://github.com/geonetwork/core-geonetwork/commit/0a7beeb9ebedba3b5a9c7875952e770830dd9f74", "message": "Security enhancement implementation of the Keycloak adapter for OpenID Connect support.", "committedDate": "2020-08-12T22:53:26Z", "type": "commit"}, {"oid": "099708633d7fcdbd86ab365f566d1651c175578e", "url": "https://github.com/geonetwork/core-geonetwork/commit/099708633d7fcdbd86ab365f566d1651c175578e", "message": "Added SSO on guest pages which uses a public client to check if already logged in.\n   Added public client option for cases where we may be using a public client and confidential client.\n   Added required scripts for SSO check\nAdded getSecurityProvider function so that we can get the provider and potentially do special logic.\nUpdate override variables so that they can come from environment variables.", "committedDate": "2020-09-11T16:25:29Z", "type": "commit"}, {"oid": "f4d1b6495dd2a946672795be3ac7cf2ed021f28a", "url": "https://github.com/geonetwork/core-geonetwork/commit/f4d1b6495dd2a946672795be3ac7cf2ed021f28a", "message": "Updated login redirect\n   Added requestCache - taken from ShibbolethPreAuthFilter\n   Updated to use querystring (redirectUrl) value if it exists.\n   If not then default to context root.", "committedDate": "2020-09-16T19:42:35Z", "type": "commit"}, {"oid": "3f0c0e3fccec86dc9807d04838ec7ad389cae7fa", "url": "https://github.com/geonetwork/core-geonetwork/commit/3f0c0e3fccec86dc9807d04838ec7ad389cae7fa", "message": "Added public-client option to keycloak json so that it is configurable.\nAdded autologin logic and make it the default.\nUpdated keycloak configuration to support autologin - had to add special filter to do the redirect if not logged in.\nFixed bug with missing client id - it would occur when using confidential client and no public client.", "committedDate": "2020-09-17T12:13:08Z", "type": "commit"}, {"oid": "25fe011b5cc937ef5e35d0d956434a9d6b9f1157", "url": "https://github.com/geonetwork/core-geonetwork/commit/25fe011b5cc937ef5e35d0d956434a9d6b9f1157", "message": "Changed default to autologin\nRemoved hard coded /signin and base it on the pathinfo from the LoginUrlAuthenticationEntryPoint configuration.\nChange logoutSuccessUrl to use context root instead of hard coded /geonetwork", "committedDate": "2020-09-17T20:51:31Z", "type": "commit"}, {"oid": "bc2a0529565511871387b55e51a78db1891ebc86", "url": "https://github.com/geonetwork/core-geonetwork/commit/bc2a0529565511871387b55e51a78db1891ebc86", "message": "Merge branch 'master' of https://github.com/geonetwork/core-geonetwork into add_keycloak_support\n\n# Conflicts:\n#\tweb/src/main/webapp/WEB-INF/config-security/config-security.xml", "committedDate": "2020-09-22T13:54:01Z", "type": "commit"}, {"oid": "3c9706be6c516639549aa3c44ad38c529a9b3a6c", "url": "https://github.com/geonetwork/core-geonetwork/commit/3c9706be6c516639549aa3c44ad38c529a9b3a6c", "message": "Apply changes required for client back channel logout via admin url", "committedDate": "2020-10-21T19:01:12Z", "type": "commit"}, {"oid": "31eb33deffba922a4ff377cd3cd3cafc9ff3503a", "url": "https://github.com/geonetwork/core-geonetwork/commit/31eb33deffba922a4ff377cd3cd3cafc9ff3503a", "message": "Merge branch 'master' of https://github.com/geonetwork/core-geonetwork into add_keycloak_support", "committedDate": "2020-10-21T19:04:26Z", "type": "commit"}, {"oid": "dfffef564387293cebc6fe034f9cfecf3459c64d", "url": "https://github.com/geonetwork/core-geonetwork/commit/dfffef564387293cebc6fe034f9cfecf3459c64d", "message": "Removed isSSO function as we really only need to know the type of form for the login\nAlso added missing HttpSessionEventPublisher.java", "committedDate": "2020-10-21T19:38:38Z", "type": "commit"}, {"oid": "d84d97275df254a3750659ab7ce53b568ac3d300", "url": "https://github.com/geonetwork/core-geonetwork/commit/d84d97275df254a3750659ab7ce53b568ac3d300", "message": "Forgot to commit this change as part of the removal of issso in recent commits.\nThis fixes bug with logintype=link not working.", "committedDate": "2020-10-26T11:17:35Z", "type": "commit"}, {"oid": "ddd70fade630dd9bb9386f5c2d84d76a1a66a8b4", "url": "https://github.com/geonetwork/core-geonetwork/commit/ddd70fade630dd9bb9386f5c2d84d76a1a66a8b4", "message": "Add IDP logout parameter so that it is possible to do a front channel logout to the IDP.", "committedDate": "2020-10-30T19:56:11Z", "type": "commit"}, {"oid": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6", "url": "https://github.com/geonetwork/core-geonetwork/commit/37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6", "message": "Merge branch 'add_keycloak_support' of https://github.com/ianwallen/core-geonetwork into add_keycloak_support", "committedDate": "2020-10-30T19:59:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk2NjgxNw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r523966817", "bodyText": "Add file header", "author": "josegar74", "createdAt": "2020-11-16T08:28:02Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/keycloak/KeycloakUtil.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.fao.geonet.kernel.security.keycloak;", "originalCommit": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk2NzMyMw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r523967323", "bodyText": "Should be used StringUtils.isEmpty or just need to check for null?", "author": "josegar74", "createdAt": "2020-11-16T08:28:59Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/keycloak/KeycloakUtil.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.fao.geonet.kernel.security.keycloak;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.fao.geonet.utils.Log;\n+import org.springframework.beans.BeansException;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint;\n+\n+import javax.annotation.PostConstruct;\n+\n+public class KeycloakUtil {\n+    public static String signinPath = null;\n+    private static LoginUrlAuthenticationEntryPoint loginUrlAuthenticationEntryPoint;\n+\n+    @Autowired\n+    private LoginUrlAuthenticationEntryPoint loginUrlAuthenticationEntryPoint0;\n+\n+    @PostConstruct\n+    private void init () {\n+        loginUrlAuthenticationEntryPoint = this.loginUrlAuthenticationEntryPoint0;\n+    }\n+\n+    public static String getSigninPath() {\n+        if (signinPath == null) {", "originalCommit": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0NzY2OA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r524247668", "bodyText": "It is used for caching.\npublic static String signinPath = null; \nIt checks to see if signinPath still contains the initial value and if so then sets the values based on configuration values from config-security.properties.\nloginForm=/signin?node=@@nodeId@@\nSubsequent calls should just return the value.\nThe intent was to use existing configuration values instead of hardcoding the value to \"/signin\"  But I did noticed that there are some hard coded values of \"/signin\" elsewhere in the code(mostly in Angular) so I'm not sure how easy it would be to change this property anyway", "author": "ianwallen", "createdAt": "2020-11-16T12:55:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk2NzMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk2NzYyOQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r523967629", "bodyText": "Add file header", "author": "josegar74", "createdAt": "2020-11-16T08:29:31Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/keycloak/keycloakPreAuthActionsLoginFilter.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.fao.geonet.kernel.security.keycloak;", "originalCommit": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIxNTk0OQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r524215949", "bodyText": "header added", "author": "ianwallen", "createdAt": "2020-11-16T12:25:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk2NzYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MjA1Mg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r523972052", "bodyText": "Just to confirm this file is really required?", "author": "josegar74", "createdAt": "2020-11-16T08:37:23Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/keycloak/KeycloakHttpSessionManager.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2016 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+// Changes were taken from org.keycloak/keycloak-adapter-core/11.0.1 as there were bugs in current version\n+// that we prevending the Admin URL client backchannel logout from working.\n+// If upgrading maven dependency then it may be possible that the most recent KeycloakHttpSessionManager can be used", "originalCommit": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyMTk4OQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r524221989", "bodyText": "I updated the comments to make it more clear as to why this was required.\nIt is mostly because the WebApplicationContextUtils.getWebApplicationContext(servletContext) returns null and it was causing NPE.  It seems like the the application is not registered as a WebApplicationContext so I had to modify the code to use ApplicationContextHolder.get() and this fixed the issue.\nMaybe in the future if the application is registered correctly as a WebApplicationContext then this file can be removed.\nIs this correction OK - or should there be a fix to register the application correctly as a WebApplicationContext?", "author": "ianwallen", "createdAt": "2020-11-16T12:31:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MjA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MzY2MA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r523973660", "bodyText": "Just to check this file is required?", "author": "josegar74", "createdAt": "2020-11-16T08:40:16Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/listener/HttpSessionEventPublisher.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package org.fao.geonet.kernel.security.listener;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.fao.geonet.ApplicationContextHolder;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.security.web.session.HttpSessionCreatedEvent;\n+import org.springframework.security.web.session.HttpSessionDestroyedEvent;\n+import org.springframework.web.context.support.WebApplicationContextUtils;\n+\n+import javax.servlet.ServletContext;\n+import javax.servlet.http.HttpSessionEvent;\n+import javax.servlet.http.HttpSessionListener;\n+\n+/* This is just a copy of the org.springframework.security.web.session.HttpSessionEventPublisher", "originalCommit": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyODIwNQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r524228205", "bodyText": "I updated the documentation to provide more details as to why this was required. It also references the bug that describes the issue.\nThis is required because our code was based on 4.8.3 which is the version that RedHat SSO 7.3 uses. This is our target software at the moment.  It was noticed that RedHat SSO has released a newer version that now uses the newer drivers.\nOur intention is to upgrade to the newer version of the software in the new year.  At that time I will create a PR to upgrade to newer version of the keycloak adapter and I can will be able to remove this file.", "author": "ianwallen", "createdAt": "2020-11-16T12:37:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MzY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAwNjcxNg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r524006716", "bodyText": "Does this configuration affects LDAP or CAS providers?", "author": "josegar74", "createdAt": "2020-11-16T09:15:40Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/SecurityProviderConfiguration.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ *  Copyright (C) 2014 GeoSolutions S.A.S.\n+ *  http://www.geo-solutions.it\n+ *\n+ *  GPLv3 + Classpath exception\n+ *\n+ *  This program is free software: you can redistribute it and/or modify\n+ *  it under the terms of the GNU General Public License as published by\n+ *  the Free Software Foundation, either version 3 of the License, or\n+ *  (at your option) any later version.\n+ *\n+ *  This program is distributed in the hope that it will be useful,\n+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ *  GNU General Public License for more details.\n+ *\n+ *  You should have received a copy of the GNU General Public License\n+ *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.fao.geonet.kernel.security;\n+\n+import org.fao.geonet.ApplicationContextHolder;\n+import org.fao.geonet.exceptions.BadInputEx;\n+import org.fao.geonet.exceptions.BadParameterEx;\n+\n+import java.util.Map;\n+\n+/**\n+ * Some basic configuration info to be used by all security\n+ *\n+ */\n+public interface SecurityProviderConfiguration {\n+\n+\tpublic enum LoginType {", "originalCommit": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMzg2Mw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r524233863", "bodyText": "It was mostly used for Shibboleth for the SSO parameters.  For all cases it would check for the existence of the bean and if the bean was not found then then it continued processing as it did before.  So unless LDAP or CAS was using Shibboleth configuration options, they should not be affected by these changes.\nOnce this PR is approved then it would probably be a good idea if LDAP or CAS also used this class if there is a need to support common configurations for SSO.", "author": "ianwallen", "createdAt": "2020-11-16T12:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAwNjcxNg=="}], "type": "inlineReview"}, {"oid": "e99fa6e1cd1d0c3decb1437ebc8f024c5974607f", "url": "https://github.com/geonetwork/core-geonetwork/commit/e99fa6e1cd1d0c3decb1437ebc8f024c5974607f", "message": "Updated documentation and headers.", "committedDate": "2020-11-16T12:21:37Z", "type": "commit"}, {"oid": "5b1f26dc86f1b2f28f4c6906ebc7e90e1c60f423", "url": "https://github.com/geonetwork/core-geonetwork/commit/5b1f26dc86f1b2f28f4c6906ebc7e90e1c60f423", "message": "Change default login type to LINK", "committedDate": "2020-11-17T11:57:50Z", "type": "commit"}]}