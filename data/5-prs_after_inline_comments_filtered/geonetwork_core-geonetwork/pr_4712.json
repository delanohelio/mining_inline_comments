{"pr_number": 4712, "pr_title": "Proxy / Limit to URL host registered in records.", "pr_createdAt": "2020-05-26T13:18:06Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4712", "timeline": [{"oid": "f5cf285df8b9abc2135c4903857df58f62c1cba2", "url": "https://github.com/geonetwork/core-geonetwork/commit/f5cf285df8b9abc2135c4903857df58f62c1cba2", "message": "Proxy / Limit to URL host registered in records.\n\nCurrently the GeoNetwork proxy is quite permissive. It is used mainly in\nthe following cases:\n\n* Map viewer / GetCapabilities document retrieval\n* Map viewer / Load a WFS layer\n* Map viewer / WMS GetFeatureInfo\n* Record view / List atom feed resources\n* Editor / Warning if a link return http errors\n* Admin / Harvesting / GetCapabilities for CSW to retrieve queryable fields\n* Admin / Thesaurus / Add from INSPIRE registry\n* ...\n\nAdd a configuration to limit its usage to some URL host only.\n\n2 modes are available:\n\n* NONE: allow all like before.\n* DB_LINK_CHECK (default):\n   * allow all for authenticated user\n   * allow only host registered in metadata link table\n\nFor anonymous user, if the host of the URL requested is not used in any\nmetadata record links, then a `NotAllowedException` is returned.\n\nIf a WMS URL is registered, all GetCapabilities, GetFeatureInfo will be\naccepted.\n\nAlso if a request is made directly to the proxy, a `SecurityException` is\nreturned because no session exist. This limit its usage to user with a\ncatalog session.\n\nThis means that catalog reviewers have to use the metadata link analysis\ntools to register links allowed for the proxy. In the future we may\ntrigger that as a background task to have an up to date list of links.\nFor now, if the table is empty the exception highlight the fact that the\nlink analysis tools should be used to populate the list.", "committedDate": "2020-05-26T13:06:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzNTQxMQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4712#discussion_r430435411", "bodyText": "Can ApiUtils.getUserSession return null? In that case this will throw a NullPointerException. Shouldn't it throw a SecurityException in that case?", "author": "juanluisrp", "createdAt": "2020-05-26T14:01:28Z", "path": "web/src/main/java/org/fao/geonet/proxy/URITemplateProxyServlet.java", "diffHunk": "@@ -48,4 +89,61 @@ protected HttpClient createHttpClient(RequestConfig requestConfig) {\n             .useSystemProperties()\n             .build();\n     }\n+\n+    protected void service(HttpServletRequest servletRequest, HttpServletResponse servletResponse)\n+        throws ServletException, IOException {\n+        switch (securityMode) {\n+            case NONE:\n+                super.service(servletRequest, servletResponse);\n+                break;\n+            case DB_LINK_CHECK:\n+                boolean proxyCallAllowed = false;\n+\n+                // Check if user is authenticated\n+                UserSession userSession = ApiUtils.getUserSession(servletRequest.getSession());\n+                if (userSession.isAuthenticated()) {", "originalCommit": "f5cf285df8b9abc2135c4903857df58f62c1cba2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDk5OQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4712#discussion_r430444999", "bodyText": "If the session is null, then you get\n\nSee\nhttps://github.com/geonetwork/core-geonetwork/blob/master/services/src/main/java/org/fao/geonet/api/ApiUtils.java#L178-L180", "author": "fxprunayre", "createdAt": "2020-05-26T14:14:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzNTQxMQ=="}], "type": "inlineReview"}, {"oid": "a9c672cfe2cd82318595392e12dae7d53820ecf4", "url": "https://github.com/geonetwork/core-geonetwork/commit/a9c672cfe2cd82318595392e12dae7d53820ecf4", "message": "Proxy / Limit to URL host registered in records / Status 403 on security exception.", "committedDate": "2020-05-26T15:21:45Z", "type": "commit"}]}