{"pr_number": 4878, "pr_title": "New LDAP test cases and infrastructure", "pr_createdAt": "2020-07-24T02:56:40Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4878", "timeline": [{"oid": "6a7eeb3da7ea660d81d8920c912c4c580e6a34eb", "url": "https://github.com/geonetwork/core-geonetwork/commit/6a7eeb3da7ea660d81d8920c912c4c580e6a34eb", "message": "initial commit for new LDAP test cases and infrastructure", "committedDate": "2020-07-24T02:55:14Z", "type": "commit"}, {"oid": "30244a45459c7412787d95432eb8d902f90464ba", "url": "https://github.com/geonetwork/core-geonetwork/commit/30244a45459c7412787d95432eb8d902f90464ba", "message": "fix port change in test case", "committedDate": "2020-07-24T03:42:22Z", "type": "commit"}, {"oid": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "url": "https://github.com/geonetwork/core-geonetwork/commit/97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "message": "add some more strategy object, dox", "committedDate": "2020-07-28T16:26:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk4OTQyNA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r464989424", "bodyText": "Formatting: extra space character in ( (.", "author": "juanluisrp", "createdAt": "2020-08-04T11:42:51Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/AbstractLDAPUserDetailsContextMapper.java", "diffHunk": "@@ -91,13 +96,15 @@ public UserDetails mapUserFromContext(DirContextOperations userCtx,\n                                           String username, Collection<? extends GrantedAuthority> authorities) {\n \n         Profile defaultProfile;\n-        if (mapping.get(\"profile\")[1] != null) {\n+        if ( (mapping.get(\"profile\") != null) && (mapping.get(\"profile\")[1] != null)) {", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5MDQ4NA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r464990484", "bodyText": "Formatting: missing space before ? operator.", "author": "juanluisrp", "createdAt": "2020-08-04T11:45:03Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/AbstractLDAPUserDetailsContextMapper.java", "diffHunk": "@@ -91,13 +96,15 @@ public UserDetails mapUserFromContext(DirContextOperations userCtx,\n                                           String username, Collection<? extends GrantedAuthority> authorities) {\n \n         Profile defaultProfile;\n-        if (mapping.get(\"profile\")[1] != null) {\n+        if ( (mapping.get(\"profile\") != null) && (mapping.get(\"profile\")[1] != null)) {\n             defaultProfile = Profile.valueOf(mapping.get(\"profile\")[1]);\n         } else {\n             defaultProfile = Profile.RegisteredUser;\n         }\n         String defaultGroup = mapping.get(\"privilege\")[1];\n-        LDAPUtils ldapUtils = ApplicationContextHolder.get().getBean(LDAPUtils.class);\n+        //allow proper injection\n+        LDAPUtils ldapUtils = this.ldapUtils != null? this.ldapUtils :", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5MTAzMQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r464991031", "bodyText": "Why is this conditional assignment needed? Use @Autowired or ApplicationContextHolder.get().getBean() but not both.", "author": "juanluisrp", "createdAt": "2020-08-04T11:46:09Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/AbstractLDAPUserDetailsContextMapper.java", "diffHunk": "@@ -91,13 +96,15 @@ public UserDetails mapUserFromContext(DirContextOperations userCtx,\n                                           String username, Collection<? extends GrantedAuthority> authorities) {\n \n         Profile defaultProfile;\n-        if (mapping.get(\"profile\")[1] != null) {\n+        if ( (mapping.get(\"profile\") != null) && (mapping.get(\"profile\")[1] != null)) {\n             defaultProfile = Profile.valueOf(mapping.get(\"profile\")[1]);\n         } else {\n             defaultProfile = Profile.RegisteredUser;\n         }\n         String defaultGroup = mapping.get(\"privilege\")[1];\n-        LDAPUtils ldapUtils = ApplicationContextHolder.get().getBean(LDAPUtils.class);\n+        //allow proper injection\n+        LDAPUtils ldapUtils = this.ldapUtils != null? this.ldapUtils :", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5MTUyMg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r464991522", "bodyText": "Formatting: extra space in ( (.", "author": "juanluisrp", "createdAt": "2020-08-04T11:47:14Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/AbstractLDAPUserDetailsContextMapper.java", "diffHunk": "@@ -226,6 +236,23 @@ private String getUserInfo(Map<String, ArrayList<String>> userInfo,\n         return getUserInfo(userInfo, attributeName, \"\");\n     }\n \n+    //returns null if not available\n+    private String getValue(Map<String, ArrayList<String>> userInfo,String ldapAttributeName) {\n+        if ( (ldapAttributeName == null) || (userInfo == null)) //bad args", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5MTk4Ng==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r464991986", "bodyText": "Formatting: extra space in ( ( and missing one after ==.", "author": "juanluisrp", "createdAt": "2020-08-04T11:48:17Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/AbstractLDAPUserDetailsContextMapper.java", "diffHunk": "@@ -226,6 +236,23 @@ private String getUserInfo(Map<String, ArrayList<String>> userInfo,\n         return getUserInfo(userInfo, attributeName, \"\");\n     }\n \n+    //returns null if not available\n+    private String getValue(Map<String, ArrayList<String>> userInfo,String ldapAttributeName) {\n+        if ( (ldapAttributeName == null) || (userInfo == null)) //bad args\n+            return null;\n+        ArrayList<String> info = userInfo.get(ldapAttributeName);\n+        if ( (info == null) || (info.size() ==0)) //no value supplied", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5MjU5OA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r464992598", "bodyText": "Formatting: missing spaces surrounding == operator.", "author": "juanluisrp", "createdAt": "2020-08-04T11:49:39Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/AbstractLDAPUserDetailsContextMapper.java", "diffHunk": "@@ -226,6 +236,23 @@ private String getUserInfo(Map<String, ArrayList<String>> userInfo,\n         return getUserInfo(userInfo, attributeName, \"\");\n     }\n \n+    //returns null if not available\n+    private String getValue(Map<String, ArrayList<String>> userInfo,String ldapAttributeName) {\n+        if ( (ldapAttributeName == null) || (userInfo == null)) //bad args\n+            return null;\n+        ArrayList<String> info = userInfo.get(ldapAttributeName);\n+        if ( (info == null) || (info.size() ==0)) //no value supplied\n+            return null;\n+        if (info.size()==1) // only one value -- that's it", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5NTUxMQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r464995511", "bodyText": "Since groupName and profile are both String objects, shouldn't be String.equals(String) used here instead of comparing using references?", "author": "juanluisrp", "createdAt": "2020-08-04T11:54:45Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/LDAPRole.java", "diffHunk": "@@ -0,0 +1,77 @@\n+//=============================================================================\n+//===\tCopyright (C) 2001-2012 Food and Agriculture Organization of the\n+//===\tUnited Nations (FAO-UN), United Nations World Food Programme (WFP)\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.Profile;\n+\n+/**\n+ * very simple class that just holds a user's group/profile information.\n+ */\n+public class LDAPRole {\n+\n+    String groupName;\n+    Profile profile;\n+\n+\n+    public LDAPRole(String groupName, Profile profile) {\n+        this.groupName = groupName;\n+        this.profile = profile;\n+    }\n+\n+    public LDAPRole(String groupName, String profileName) {\n+        this.groupName = groupName;\n+        this.profile = Profile.findProfileIgnoreCase(profileName);\n+    }\n+\n+\n+    public String getGroupName() {\n+        return groupName;\n+    }\n+\n+    public void setGroupName(String groupName) {\n+        this.groupName = groupName;\n+    }\n+\n+    public Profile getProfile() {\n+        return profile;\n+    }\n+\n+    public void setProfile(Profile profile) {\n+        this.profile = profile;\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj) {\n+        if (!(obj instanceof LDAPRole))\n+            return false;\n+\n+        return this.getGroupName() == ((LDAPRole) obj).getGroupName() &&\n+            this.getProfile().name() == ((LDAPRole) obj).getProfile().name();", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5Njk4Mw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465296983", "bodyText": "can't this throw a NullPointerExeption if groupName or profile are null?", "author": "juanluisrp", "createdAt": "2020-08-04T20:00:21Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/LDAPRole.java", "diffHunk": "@@ -0,0 +1,77 @@\n+//=============================================================================\n+//===\tCopyright (C) 2001-2012 Food and Agriculture Organization of the\n+//===\tUnited Nations (FAO-UN), United Nations World Food Programme (WFP)\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.Profile;\n+\n+/**\n+ * very simple class that just holds a user's group/profile information.\n+ */\n+public class LDAPRole {\n+\n+    String groupName;\n+    Profile profile;\n+\n+\n+    public LDAPRole(String groupName, Profile profile) {\n+        this.groupName = groupName;\n+        this.profile = profile;\n+    }\n+\n+    public LDAPRole(String groupName, String profileName) {\n+        this.groupName = groupName;\n+        this.profile = Profile.findProfileIgnoreCase(profileName);\n+    }\n+\n+\n+    public String getGroupName() {\n+        return groupName;\n+    }\n+\n+    public void setGroupName(String groupName) {\n+        this.groupName = groupName;\n+    }\n+\n+    public Profile getProfile() {\n+        return profile;\n+    }\n+\n+    public void setProfile(Profile profile) {\n+        this.profile = profile;\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj) {\n+        if (!(obj instanceof LDAPRole))\n+            return false;\n+\n+        return this.getGroupName() == ((LDAPRole) obj).getGroupName() &&\n+            this.getProfile().name() == ((LDAPRole) obj).getProfile().name();\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return this.getGroupName().hashCode() ^ this.getProfile().name().hashCode() ;", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5Nzk0OQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465297949", "bodyText": "Not very informative javadoc. Also adding -- is not needed.", "author": "juanluisrp", "createdAt": "2020-08-04T20:02:12Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverter.java", "diffHunk": "@@ -0,0 +1,49 @@\n+//=============================================================================\n+//===\tCopyright (C) 2001-2012 Food and Agriculture Organization of the\n+//===\tUnited Nations (FAO-UN), United Nations World Food Programme (WFP)\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+\n+import javax.naming.directory.Attributes;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+//given information about a LDAP-Group/User, return the gn-groups/gn-profile associated with that person\n+public interface LDAPRoleConverter {\n+\n+    /**\n+     *\n+     * @param userInfo      -- information about the user\n+     * @param userDetails   -- information about the user", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5ODM3NA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465298374", "bodyText": "Incomplete header.", "author": "juanluisrp", "createdAt": "2020-08-04T20:03:03Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterGroupNameConverter.java", "diffHunk": "@@ -0,0 +1,57 @@\n+//===\tand United Nations Environment Programme (UNEP)", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5ODY3OQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465298679", "bodyText": "Formatting: add a space after the , char.", "author": "juanluisrp", "createdAt": "2020-08-04T20:03:42Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterGroupNameConverter.java", "diffHunk": "@@ -0,0 +1,57 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+\n+import javax.naming.directory.Attributes;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This does a direct conversion from a LDAP group name to a list of LDAPRoles.\n+ * See LDAPRoleConverterGroupNameParser for another example.\n+ *\n+ */\n+public class LDAPRoleConverterGroupNameConverter implements LDAPRoleConverter {\n+    //groupName (from LDAP) to a list of LDAPRoles (GN-Group and GN-Profile)\n+    Map<String,List<LDAPRole>> convertMap;", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5OTUyNA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465299524", "bodyText": "Formatting: Always add curly braces to if sentences, even if its a one liner if statement.\nFormatting: Remove the space in ( (.", "author": "juanluisrp", "createdAt": "2020-08-04T20:05:23Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterGroupNameConverter.java", "diffHunk": "@@ -0,0 +1,57 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+\n+import javax.naming.directory.Attributes;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This does a direct conversion from a LDAP group name to a list of LDAPRoles.\n+ * See LDAPRoleConverterGroupNameParser for another example.\n+ *\n+ */\n+public class LDAPRoleConverterGroupNameConverter implements LDAPRoleConverter {\n+    //groupName (from LDAP) to a list of LDAPRoles (GN-Group and GN-Profile)\n+    Map<String,List<LDAPRole>> convertMap;\n+\n+\n+    //given an LDAP role name, find the list of LDAPRoles that are assigned to them.\n+    @Override\n+    public List<LDAPRole> convert(Map<String, ArrayList<String>> userInfo, LDAPUser userDetails, String ldapGroupName, Attributes ldapGroupAttributes) {\n+        if ( (convertMap == null) || (!convertMap.containsKey(ldapGroupName)))", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMDEyMQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465300121", "bodyText": "Incomplete header.", "author": "juanluisrp", "createdAt": "2020-08-04T20:06:36Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterGroupNameParser.java", "diffHunk": "@@ -0,0 +1,142 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+// @author dblasby geocat", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwNzE0MA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465307140", "bodyText": "Formatting: missing spaces after , characters.", "author": "juanluisrp", "createdAt": "2020-08-04T20:20:25Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/LDAPUserDetailsContextMapperWithProfileSearchEnhanced.java", "diffHunk": "@@ -0,0 +1,212 @@\n+//=============================================================================\n+//===\tCopyright (C) 2001-2012 Food and Agriculture Organization of the\n+//===\tUnited Nations (FAO-UN), United Nations World Food Programme (WFP)\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import jeeves.component.ProfileManager;\n+import org.fao.geonet.constants.Geonet;\n+import org.fao.geonet.domain.LDAPUser;\n+import org.fao.geonet.domain.Profile;\n+import org.fao.geonet.utils.Log;\n+import org.springframework.util.StringUtils;\n+\n+import javax.naming.NamingEnumeration;\n+import javax.naming.NamingException;\n+import javax.naming.directory.*;\n+import java.text.MessageFormat;\n+import java.util.*;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * Get all user information from the LDAP user's attributes excluding profiles and groups which are\n+ * searched in another LDAP location. For profiles and groups, define the search location and the\n+ * extraction pattern.\n+ * <p>\n+ * This search (including subtrees) in the LDAP starting at 'membershipSearchStartObject'\n+ * It will execute the query ldapMembershipQuery.\n+ * for ldapMembershipQuery;\n+ * {0} = username (i.e. what the user types in to login)\n+ * {1} = cn for the ldap user object (short version)  i.e. \"blasby, david\"\n+ * {2} = cn for the ldap user object (full version)   i.e. \"blasby, david,ou=GIS Department,ou=Corporate Users,dc=example,dc=com\"\n+ * ** typically you'll be using {2}\n+\n+ * @author dblasby/francois\n+ */\n+public class LDAPUserDetailsContextMapperWithProfileSearchEnhanced extends AbstractLDAPUserDetailsContextMapper {\n+\n+    //Query used to find group membership\n+    private String ldapMembershipQuery;\n+\n+\n+\n+    //where to start searching in the LDAP\n+    // typically this will be \"\" (search entire directory)\n+    private String membershipSearchStartObject;\n+\n+    //Strategy objects to convert a LDAPRole to GN-role (GN-group and GN-profile)\n+    private List<LDAPRoleConverter> ldapRoleConverters;\n+\n+    public void setLdapRoleConverters(List<LDAPRoleConverter> vals) {\n+        this.ldapRoleConverters = vals;\n+    }\n+\n+    public void setMembershipSearchStartObject(String membershipSearchStartObject) {\n+        this.membershipSearchStartObject = membershipSearchStartObject;\n+    }\n+\n+    public void setLdapMembershipQuery(String ldapMembershipQuery) {\n+        this.ldapMembershipQuery = ldapMembershipQuery;\n+    }\n+\n+\n+\n+    //This will find the shortest \"cn\" attribute given in the object\n+    // typically, there are >1 of these.  I.e. \"blasby, david\" and \"blasby, david,ou=GIS Department,ou=Corporate Users,dc=example,dc=com\"\n+    public String cn_short(Attributes atts) throws NamingException {\n+        Attribute value = atts.get(\"cn\");\n+        List values = Collections.list(value.getAll());\n+        Comparator<String> comparator = (str1, str2) -> str1.length() > str2.length() ? 1 : -1;\n+        String shortest = (String) values.stream().sorted(comparator).findFirst().get();\n+        return shortest;\n+    }\n+\n+    //This will find the longest \"cn\" attribute given in the object\n+    // typically, there are >1 of these.  I.e. \"blasby, david\" and \"blasby, david,ou=GIS Department,ou=Corporate Users,dc=example,dc=com\"\n+    public String cn_short(Map<String, ArrayList<String>> userInfo) {\n+        ArrayList<String> cn = userInfo.get(\"cn\");\n+        if ((cn == null) || (cn.size() == 0))  // bad user!\n+            return null;\n+        Comparator<String> comparator = (str1, str2) -> str1.length() > str2.length() ? 1 : -1;\n+        String shortest = cn.stream().sorted(comparator).findFirst().get();\n+        return shortest;\n+    }\n+\n+    //This will find the longest \"cn\" value given in the map\n+    // typically, there are >1 of these.  I.e. \"blasby, david\" and \"blasby, david,ou=GIS Department,ou=Corporate Users,dc=example,dc=com\"\n+    public String cn_long(Map<String, ArrayList<String>> userInfo) {\n+        ArrayList<String> cn = userInfo.get(\"cn\");\n+        if ((cn == null) || (cn.size() == 0))  // bad user!\n+            return null;\n+        Comparator<String> comparator = (str1, str2) -> str1.length() > str2.length() ? -1 : 1;\n+        String longest = cn.stream().sorted(comparator).findFirst().get();\n+        return longest;\n+    }\n+\n+    //escape a string for the query\n+    //\"blasby\\, david\"  ==> \"blasby\\\\, david\"\n+    //This is required for membership searches in AD\n+    public String escape(String str) {\n+        return str.replace(\"\\\\\", \"\\\\\\\\\");\n+    }\n+\n+    //given a profile name, find the Profile that it matches\n+    //see `profileMapping` for transitions\n+    public Profile getProfile(String pname) {\n+        if ((this.profileMapping != null) && (this.profileMapping.containsKey(pname)))\n+            return this.profileMapping.get(pname);\n+\n+        Profile p = Profile.findProfileIgnoreCase(pname);\n+        return p;\n+    }\n+\n+\n+    //main method to find the user's ldap group memberships\n+    // a) will populate the GN-Group and GN-Profile in userDetails\n+    // b) will look for the \"highest\" Profile given and set that as the user's main profile  -userDetails.getUser().setProfile(highestUserProfile)\n+    protected void setProfilesAndPrivileges(Profile defaultProfile,\n+                                            String defaultGroup, Map<String, ArrayList<String>> userInfo,\n+                                            LDAPUser userDetails) {\n+\n+        if (!StringUtils.isEmpty(ldapMembershipQuery)) {\n+            if (Log.isDebugEnabled(Geonet.LDAP)) {\n+                StringBuffer sb = new StringBuffer(\"Group and profile search:\");\n+                sb.append(\"\\nLDAP Membership Query query: \\t\" + ldapMembershipQuery);\n+                sb.append(\"\\nmembershipSearchStartObject: \\t\" + membershipSearchStartObject);\n+\n+                Log.debug(Geonet.LDAP, sb.toString());\n+            }\n+            // TODO: add more control on values\n+            NamingEnumeration<?> ldapInfoList;\n+            try {\n+                DirContext dc = contextSource.getReadOnlyContext();\n+\n+\n+                String username = escape(userDetails.getUsername());\n+                String cn_short = escape(cn_short(userInfo));\n+                String cn_long = escape(cn_long(userInfo));\n+\n+                String groupsQuery = MessageFormat.format(this.ldapMembershipQuery,\n+                    username, cn_short, cn_long);\n+\n+                SearchControls searchControls = new SearchControls();\n+                searchControls.setSearchScope(SearchControls.SUBTREE_SCOPE); //recursive\n+\n+                ldapInfoList = dc.search(membershipSearchStartObject, groupsQuery, searchControls);\n+\n+                Set<LDAPRole> allRoles = new HashSet<>();\n+\n+                //for each found LDAP-Group\n+                while (ldapInfoList.hasMore()) {\n+                    SearchResult sr = (SearchResult) ldapInfoList.next();\n+                    String ldapGroupName = cn_short(sr.getAttributes());\n+\n+                    //have the converters process the LDAP-Group\n+                    //NOTE: they will return an empty list if they don't know what the role means\n+                    //      allRoles is a set, you can add duplicates to it with no problem...\n+                    for(LDAPRoleConverter converter : this.ldapRoleConverters){\n+                        List<LDAPRole> newRoles = converter.convert(userInfo,userDetails,ldapGroupName,sr.getAttributes());", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxOTQ1NA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465319454", "bodyText": "Shouldn't we do something with this exception? not just swallow it.", "author": "juanluisrp", "createdAt": "2020-08-04T20:44:50Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/ldap/LDAPUserDetailsContextMapperWithProfileSearchEnhanced.java", "diffHunk": "@@ -0,0 +1,212 @@\n+//=============================================================================\n+//===\tCopyright (C) 2001-2012 Food and Agriculture Organization of the\n+//===\tUnited Nations (FAO-UN), United Nations World Food Programme (WFP)\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import jeeves.component.ProfileManager;\n+import org.fao.geonet.constants.Geonet;\n+import org.fao.geonet.domain.LDAPUser;\n+import org.fao.geonet.domain.Profile;\n+import org.fao.geonet.utils.Log;\n+import org.springframework.util.StringUtils;\n+\n+import javax.naming.NamingEnumeration;\n+import javax.naming.NamingException;\n+import javax.naming.directory.*;\n+import java.text.MessageFormat;\n+import java.util.*;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * Get all user information from the LDAP user's attributes excluding profiles and groups which are\n+ * searched in another LDAP location. For profiles and groups, define the search location and the\n+ * extraction pattern.\n+ * <p>\n+ * This search (including subtrees) in the LDAP starting at 'membershipSearchStartObject'\n+ * It will execute the query ldapMembershipQuery.\n+ * for ldapMembershipQuery;\n+ * {0} = username (i.e. what the user types in to login)\n+ * {1} = cn for the ldap user object (short version)  i.e. \"blasby, david\"\n+ * {2} = cn for the ldap user object (full version)   i.e. \"blasby, david,ou=GIS Department,ou=Corporate Users,dc=example,dc=com\"\n+ * ** typically you'll be using {2}\n+\n+ * @author dblasby/francois\n+ */\n+public class LDAPUserDetailsContextMapperWithProfileSearchEnhanced extends AbstractLDAPUserDetailsContextMapper {\n+\n+    //Query used to find group membership\n+    private String ldapMembershipQuery;\n+\n+\n+\n+    //where to start searching in the LDAP\n+    // typically this will be \"\" (search entire directory)\n+    private String membershipSearchStartObject;\n+\n+    //Strategy objects to convert a LDAPRole to GN-role (GN-group and GN-profile)\n+    private List<LDAPRoleConverter> ldapRoleConverters;\n+\n+    public void setLdapRoleConverters(List<LDAPRoleConverter> vals) {\n+        this.ldapRoleConverters = vals;\n+    }\n+\n+    public void setMembershipSearchStartObject(String membershipSearchStartObject) {\n+        this.membershipSearchStartObject = membershipSearchStartObject;\n+    }\n+\n+    public void setLdapMembershipQuery(String ldapMembershipQuery) {\n+        this.ldapMembershipQuery = ldapMembershipQuery;\n+    }\n+\n+\n+\n+    //This will find the shortest \"cn\" attribute given in the object\n+    // typically, there are >1 of these.  I.e. \"blasby, david\" and \"blasby, david,ou=GIS Department,ou=Corporate Users,dc=example,dc=com\"\n+    public String cn_short(Attributes atts) throws NamingException {\n+        Attribute value = atts.get(\"cn\");\n+        List values = Collections.list(value.getAll());\n+        Comparator<String> comparator = (str1, str2) -> str1.length() > str2.length() ? 1 : -1;\n+        String shortest = (String) values.stream().sorted(comparator).findFirst().get();\n+        return shortest;\n+    }\n+\n+    //This will find the longest \"cn\" attribute given in the object\n+    // typically, there are >1 of these.  I.e. \"blasby, david\" and \"blasby, david,ou=GIS Department,ou=Corporate Users,dc=example,dc=com\"\n+    public String cn_short(Map<String, ArrayList<String>> userInfo) {\n+        ArrayList<String> cn = userInfo.get(\"cn\");\n+        if ((cn == null) || (cn.size() == 0))  // bad user!\n+            return null;\n+        Comparator<String> comparator = (str1, str2) -> str1.length() > str2.length() ? 1 : -1;\n+        String shortest = cn.stream().sorted(comparator).findFirst().get();\n+        return shortest;\n+    }\n+\n+    //This will find the longest \"cn\" value given in the map\n+    // typically, there are >1 of these.  I.e. \"blasby, david\" and \"blasby, david,ou=GIS Department,ou=Corporate Users,dc=example,dc=com\"\n+    public String cn_long(Map<String, ArrayList<String>> userInfo) {\n+        ArrayList<String> cn = userInfo.get(\"cn\");\n+        if ((cn == null) || (cn.size() == 0))  // bad user!\n+            return null;\n+        Comparator<String> comparator = (str1, str2) -> str1.length() > str2.length() ? -1 : 1;\n+        String longest = cn.stream().sorted(comparator).findFirst().get();\n+        return longest;\n+    }\n+\n+    //escape a string for the query\n+    //\"blasby\\, david\"  ==> \"blasby\\\\, david\"\n+    //This is required for membership searches in AD\n+    public String escape(String str) {\n+        return str.replace(\"\\\\\", \"\\\\\\\\\");\n+    }\n+\n+    //given a profile name, find the Profile that it matches\n+    //see `profileMapping` for transitions\n+    public Profile getProfile(String pname) {\n+        if ((this.profileMapping != null) && (this.profileMapping.containsKey(pname)))\n+            return this.profileMapping.get(pname);\n+\n+        Profile p = Profile.findProfileIgnoreCase(pname);\n+        return p;\n+    }\n+\n+\n+    //main method to find the user's ldap group memberships\n+    // a) will populate the GN-Group and GN-Profile in userDetails\n+    // b) will look for the \"highest\" Profile given and set that as the user's main profile  -userDetails.getUser().setProfile(highestUserProfile)\n+    protected void setProfilesAndPrivileges(Profile defaultProfile,\n+                                            String defaultGroup, Map<String, ArrayList<String>> userInfo,\n+                                            LDAPUser userDetails) {\n+\n+        if (!StringUtils.isEmpty(ldapMembershipQuery)) {\n+            if (Log.isDebugEnabled(Geonet.LDAP)) {\n+                StringBuffer sb = new StringBuffer(\"Group and profile search:\");\n+                sb.append(\"\\nLDAP Membership Query query: \\t\" + ldapMembershipQuery);\n+                sb.append(\"\\nmembershipSearchStartObject: \\t\" + membershipSearchStartObject);\n+\n+                Log.debug(Geonet.LDAP, sb.toString());\n+            }\n+            // TODO: add more control on values\n+            NamingEnumeration<?> ldapInfoList;\n+            try {\n+                DirContext dc = contextSource.getReadOnlyContext();\n+\n+\n+                String username = escape(userDetails.getUsername());\n+                String cn_short = escape(cn_short(userInfo));\n+                String cn_long = escape(cn_long(userInfo));\n+\n+                String groupsQuery = MessageFormat.format(this.ldapMembershipQuery,\n+                    username, cn_short, cn_long);\n+\n+                SearchControls searchControls = new SearchControls();\n+                searchControls.setSearchScope(SearchControls.SUBTREE_SCOPE); //recursive\n+\n+                ldapInfoList = dc.search(membershipSearchStartObject, groupsQuery, searchControls);\n+\n+                Set<LDAPRole> allRoles = new HashSet<>();\n+\n+                //for each found LDAP-Group\n+                while (ldapInfoList.hasMore()) {\n+                    SearchResult sr = (SearchResult) ldapInfoList.next();\n+                    String ldapGroupName = cn_short(sr.getAttributes());\n+\n+                    //have the converters process the LDAP-Group\n+                    //NOTE: they will return an empty list if they don't know what the role means\n+                    //      allRoles is a set, you can add duplicates to it with no problem...\n+                    for(LDAPRoleConverter converter : this.ldapRoleConverters){\n+                        List<LDAPRole> newRoles = converter.convert(userInfo,userDetails,ldapGroupName,sr.getAttributes());\n+                        if (newRoles != null)\n+                            allRoles.addAll(newRoles);\n+                    }\n+                }\n+\n+                //we have a set of GN-Role, now add them to the user object\n+                for(LDAPRole role: allRoles) {\n+                    userDetails.addPrivilege(role.getGroupName(), role.getProfile()); //add the profile info\n+                }\n+\n+                //highest access is the \"generic\" access for the user\n+                Profile highestUserProfile = ProfileManager.getHighestProfile(userDetails.getPrivileges().values().toArray(new Profile[0]));\n+                if (highestUserProfile != null) {\n+                    if (Log.isDebugEnabled(Geonet.LDAP)) {\n+                        Log.debug(Geonet.LDAP, \"  Highest user profile is \" + highestUserProfile);\n+                    }\n+                    userDetails.getUser().setProfile(highestUserProfile);\n+                }\n+\n+                // If no profile defined, use default profile\n+                if (userDetails.getUser().getProfile() == null) {\n+                    if (Log.isDebugEnabled(Geonet.LDAP)) {\n+                        Log.debug(Geonet.LDAP, \"  No profile defined in LDAP, using default profile \" + defaultProfile);\n+                    }\n+                    userDetails.getUser().setProfile(defaultProfile);\n+                }\n+\n+            } catch (NamingException e) {\n+                Log.error(Geonet.LDAP, \"Failed to extract profiles and groups. Error is: \" + e.getMessage(), e);", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNzk2Nw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r466607967", "bodyText": "This is the behaviour for the other implementations and you're not supposed to throw exceptions here (this is bad design).\nI've added it throwing a runtime exception.", "author": "davidblasby", "createdAt": "2020-08-06T18:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxOTQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxODkyOQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465518929", "bodyText": "Incomplete header.", "author": "juanluisrp", "createdAt": "2020-08-05T07:09:37Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+//===\tand United Nations Environment Programme (UNEP)", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxOTk1MA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465519950", "bodyText": "Formatting: Add spaces after ,.", "author": "juanluisrp", "createdAt": "2020-08-05T07:11:48Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+// @author dblasby geocat\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+import org.fao.geonet.domain.Profile;\n+import org.junit.Test;\n+\n+import java.util.*;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class LDAPRoleConverterTest {\n+\n+    //simple test for parsing \"GCAT_GENERAL_Administrator\"\n+    @Test\n+    public void test_LDAPRoleConverter1() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+        out.setProfileMapping(null);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_Administrator\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMDIwMg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465520202", "bodyText": "Formatting: Add spaces after ,.", "author": "juanluisrp", "createdAt": "2020-08-05T07:12:23Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+// @author dblasby geocat\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+import org.fao.geonet.domain.Profile;\n+import org.junit.Test;\n+\n+import java.util.*;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class LDAPRoleConverterTest {\n+\n+    //simple test for parsing \"GCAT_GENERAL_Administrator\"\n+    @Test\n+    public void test_LDAPRoleConverter1() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+        out.setProfileMapping(null);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_Administrator\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+    }\n+\n+    //tests profile mapping (admin -> Administrator)\n+    @Test\n+    public void test_LDAPRoleConverter2() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+\n+        Map<String,Profile> profileMap = new HashMap<>();\n+        profileMap.put(\"admin\",Profile.Administrator);\n+        profileMap.put(\"editor\",Profile.Editor);\n+\n+        out.setProfileMapping(profileMap);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_admin\",null);\n+        assertEquals(1,result.size());", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMDY1Nw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465520657", "bodyText": "Formatting: Add spaces after ,.", "author": "juanluisrp", "createdAt": "2020-08-05T07:13:21Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+// @author dblasby geocat\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+import org.fao.geonet.domain.Profile;\n+import org.junit.Test;\n+\n+import java.util.*;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class LDAPRoleConverterTest {\n+\n+    //simple test for parsing \"GCAT_GENERAL_Administrator\"\n+    @Test\n+    public void test_LDAPRoleConverter1() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+        out.setProfileMapping(null);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_Administrator\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+    }\n+\n+    //tests profile mapping (admin -> Administrator)\n+    @Test\n+    public void test_LDAPRoleConverter2() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+\n+        Map<String,Profile> profileMap = new HashMap<>();\n+        profileMap.put(\"admin\",Profile.Administrator);\n+        profileMap.put(\"editor\",Profile.Editor);\n+\n+        out.setProfileMapping(profileMap);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_admin\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+    }\n+\n+    //testswhen the LDAP role doesn't match the pattern (shouldn't return anything)\n+    @Test\n+    public void test_LDAPRoleConverter3() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+\n+        Map<String,Profile> profileMap = new HashMap<>();\n+        profileMap.put(\"admin\",Profile.Administrator);\n+        profileMap.put(\"editor\",Profile.Editor);\n+\n+        out.setProfileMapping(profileMap);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"BAD GROUP NAME\",null);\n+        assertEquals(0,result.size());", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMTI4NQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465521285", "bodyText": "Use a more expressive test name.", "author": "juanluisrp", "createdAt": "2020-08-05T07:14:40Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+// @author dblasby geocat\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+import org.fao.geonet.domain.Profile;\n+import org.junit.Test;\n+\n+import java.util.*;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class LDAPRoleConverterTest {\n+\n+    //simple test for parsing \"GCAT_GENERAL_Administrator\"\n+    @Test\n+    public void test_LDAPRoleConverter1() {", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMTQyMQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465521421", "bodyText": "Use a more expressive test name.", "author": "juanluisrp", "createdAt": "2020-08-05T07:14:55Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+// @author dblasby geocat\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+import org.fao.geonet.domain.Profile;\n+import org.junit.Test;\n+\n+import java.util.*;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class LDAPRoleConverterTest {\n+\n+    //simple test for parsing \"GCAT_GENERAL_Administrator\"\n+    @Test\n+    public void test_LDAPRoleConverter1() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+        out.setProfileMapping(null);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_Administrator\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+    }\n+\n+    //tests profile mapping (admin -> Administrator)\n+    @Test\n+    public void test_LDAPRoleConverter2() {", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMjMyMQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465522321", "bodyText": "Use a more expressive test name", "author": "juanluisrp", "createdAt": "2020-08-05T07:16:42Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+// @author dblasby geocat\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+import org.fao.geonet.domain.Profile;\n+import org.junit.Test;\n+\n+import java.util.*;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class LDAPRoleConverterTest {\n+\n+    //simple test for parsing \"GCAT_GENERAL_Administrator\"\n+    @Test\n+    public void test_LDAPRoleConverter1() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+        out.setProfileMapping(null);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_Administrator\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+    }\n+\n+    //tests profile mapping (admin -> Administrator)\n+    @Test\n+    public void test_LDAPRoleConverter2() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+\n+        Map<String,Profile> profileMap = new HashMap<>();\n+        profileMap.put(\"admin\",Profile.Administrator);\n+        profileMap.put(\"editor\",Profile.Editor);\n+\n+        out.setProfileMapping(profileMap);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_admin\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+    }\n+\n+    //testswhen the LDAP role doesn't match the pattern (shouldn't return anything)\n+    @Test\n+    public void test_LDAPRoleConverter3() {", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMjkxNQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465522915", "bodyText": "Use a more expressive test name", "author": "juanluisrp", "createdAt": "2020-08-05T07:17:52Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+// @author dblasby geocat\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+import org.fao.geonet.domain.Profile;\n+import org.junit.Test;\n+\n+import java.util.*;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class LDAPRoleConverterTest {\n+\n+    //simple test for parsing \"GCAT_GENERAL_Administrator\"\n+    @Test\n+    public void test_LDAPRoleConverter1() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+        out.setProfileMapping(null);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_Administrator\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+    }\n+\n+    //tests profile mapping (admin -> Administrator)\n+    @Test\n+    public void test_LDAPRoleConverter2() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+\n+        Map<String,Profile> profileMap = new HashMap<>();\n+        profileMap.put(\"admin\",Profile.Administrator);\n+        profileMap.put(\"editor\",Profile.Editor);\n+\n+        out.setProfileMapping(profileMap);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_admin\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+    }\n+\n+    //testswhen the LDAP role doesn't match the pattern (shouldn't return anything)\n+    @Test\n+    public void test_LDAPRoleConverter3() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+\n+        Map<String,Profile> profileMap = new HashMap<>();\n+        profileMap.put(\"admin\",Profile.Administrator);\n+        profileMap.put(\"editor\",Profile.Editor);\n+\n+        out.setProfileMapping(profileMap);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"BAD GROUP NAME\",null);\n+        assertEquals(0,result.size());\n+    }\n+\n+    //sets up a direct link between an LDAP group and a list of GN-Roles (gn-group and gn-profile)\n+    //also tests when the LDAP role doesn't match, LDAPRoleConverterGroupNameConverter doesn't return anything\n+    @Test\n+    public void test_LDAPRoleConverterGroupNameConverter1(){", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMzA0NA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465523044", "bodyText": "Formatting: Add spaces after ,.", "author": "juanluisrp", "createdAt": "2020-08-05T07:18:10Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPRoleConverterTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+//===\tand United Nations Environment Programme (UNEP)\n+//===\n+//===\tThis program is free software; you can redistribute it and/or modify\n+//===\tit under the terms of the GNU General Public License as published by\n+//===\tthe Free Software Foundation; either version 2 of the License, or (at\n+//===\tyour option) any later version.\n+//===\n+//===\tThis program is distributed in the hope that it will be useful, but\n+//===\tWITHOUT ANY WARRANTY; without even the implied warranty of\n+//===\tMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+//===\tGeneral Public License for more details.\n+//===\n+//===\tYou should have received a copy of the GNU General Public License\n+//===\talong with this program; if not, write to the Free Software\n+//===\tFoundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+//===\n+//===\tContact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+//===\tRome - Italy. email: geonetwork@osgeo.org\n+//==============================================================================\n+// @author dblasby geocat\n+\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.fao.geonet.domain.LDAPUser;\n+import org.fao.geonet.domain.Profile;\n+import org.junit.Test;\n+\n+import java.util.*;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class LDAPRoleConverterTest {\n+\n+    //simple test for parsing \"GCAT_GENERAL_Administrator\"\n+    @Test\n+    public void test_LDAPRoleConverter1() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+        out.setProfileMapping(null);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_Administrator\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+    }\n+\n+    //tests profile mapping (admin -> Administrator)\n+    @Test\n+    public void test_LDAPRoleConverter2() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+\n+        Map<String,Profile> profileMap = new HashMap<>();\n+        profileMap.put(\"admin\",Profile.Administrator);\n+        profileMap.put(\"editor\",Profile.Editor);\n+\n+        out.setProfileMapping(profileMap);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"GCAT_GENERAL_admin\",null);\n+        assertEquals(1,result.size());\n+        assertEquals(\"GENERAL\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+    }\n+\n+    //testswhen the LDAP role doesn't match the pattern (shouldn't return anything)\n+    @Test\n+    public void test_LDAPRoleConverter3() {\n+        LDAPRoleConverterGroupNameParser out = new LDAPRoleConverterGroupNameParser();\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        out.setLdapMembershipQueryParser(\"GCAT_(.*)_(.*)\");\n+        out.setGroupIndexInPattern(1);\n+        out.setProfileIndexInPattern(2);\n+\n+        Map<String,Profile> profileMap = new HashMap<>();\n+        profileMap.put(\"admin\",Profile.Administrator);\n+        profileMap.put(\"editor\",Profile.Editor);\n+\n+        out.setProfileMapping(profileMap);\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"BAD GROUP NAME\",null);\n+        assertEquals(0,result.size());\n+    }\n+\n+    //sets up a direct link between an LDAP group and a list of GN-Roles (gn-group and gn-profile)\n+    //also tests when the LDAP role doesn't match, LDAPRoleConverterGroupNameConverter doesn't return anything\n+    @Test\n+    public void test_LDAPRoleConverterGroupNameConverter1(){\n+        LDAPRoleConverterGroupNameConverter out = new LDAPRoleConverterGroupNameConverter();\n+\n+        Map<String,List<LDAPRole>> map = new HashMap<>();\n+        List<LDAPRole> roles = new ArrayList<LDAPRole>(\n+                                        Arrays.asList( new LDAPRole(\"group1\",\"Administrator\"),\n+                                                       new LDAPRole(\"group2\",\"Editor\")\n+                                        ));\n+        map.put(\"ldap_abc\",roles);\n+\n+        out.setConvertMap(map);\n+\n+        LDAPUser userDetails = new LDAPUser(\"dblasby@example.com\");\n+\n+        List<LDAPRole> result = out.convert(null,userDetails,\"ldap_abc\",null);\n+        assertEquals(2,result.size());\n+        assertEquals(\"group1\", result.get(0).getGroupName());\n+        assertEquals(Profile.Administrator, result.get(0).getProfile());\n+\n+        assertEquals(\"group2\", result.get(1).getGroupName());\n+        assertEquals(Profile.Editor, result.get(1).getProfile());\n+\n+\n+        result = out.convert(null,userDetails,\"BAD_GROUP_NAME\",null);\n+        assertEquals(0,result.size());", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU2NzU1Mw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465567553", "bodyText": "Move these methods to the start of the test class.", "author": "juanluisrp", "createdAt": "2020-08-05T08:39:26Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPUserDetailsContextMapperWithProfileSearchEnhancedTest.java", "diffHunk": "@@ -0,0 +1,439 @@\n+/*\n+ * Copyright (C) 2001-2016 Food and Agriculture Organization of the\n+ * United Nations (FAO-UN), United Nations World Food Programme (WFP)\n+ * and United Nations Environment Programme (UNEP)\n+ *\n+ * This program is free software; you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation; either version 2 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful, but\n+ * WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+ *\n+ * Contact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+ * Rome - Italy. email: geonetwork@osgeo.org\n+ */\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.apache.directory.api.util.FileUtils;\n+import org.apache.directory.server.annotations.CreateLdapServer;\n+import org.apache.directory.server.annotations.CreateTransport;\n+import org.apache.directory.server.core.annotations.ApplyLdifFiles;\n+import org.apache.directory.server.core.annotations.CreateDS;\n+import org.apache.directory.server.core.annotations.CreatePartition;\n+import org.apache.directory.server.core.api.DirectoryService;\n+import org.apache.directory.server.core.factory.DSAnnotationProcessor;\n+import org.apache.directory.server.core.integ.AbstractLdapTestUnit;\n+import org.apache.directory.server.factory.ServerAnnotationProcessor;\n+import org.apache.directory.server.ldap.LdapServer;\n+import org.fao.geonet.ApplicationContextHolder;\n+import org.fao.geonet.domain.*;\n+import org.fao.geonet.repository.GroupRepository;\n+import org.fao.geonet.repository.UserGroupRepository;\n+import org.fao.geonet.repository.UserRepository;\n+import org.fao.geonet.repository.specification.UserGroupSpecs;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.ConfigurableApplicationContext;\n+import org.springframework.ldap.core.*;\n+import org.springframework.security.authentication.BadCredentialsException;\n+import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.GrantedAuthority;\n+import org.springframework.security.core.userdetails.UserDetails;\n+import org.springframework.security.ldap.DefaultSpringSecurityContextSource;\n+import org.springframework.security.ldap.LdapUsernameToDnMapper;\n+import org.springframework.security.ldap.LdapUtils;\n+import org.springframework.security.ldap.authentication.LdapAuthenticationProvider;\n+import org.springframework.security.ldap.search.FilterBasedLdapUserSearch;\n+import org.springframework.test.annotation.DirtiesContext;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import javax.naming.Context;\n+import javax.naming.NameClassPair;\n+import javax.naming.NamingEnumeration;\n+import javax.naming.NamingException;\n+import javax.naming.directory.DirContext;\n+import javax.naming.directory.InitialDirContext;\n+import javax.naming.directory.SearchControls;\n+import javax.naming.directory.SearchResult;\n+import java.util.Collections;\n+import java.util.Hashtable;\n+import java.util.List;\n+\n+import static org.junit.Assert.*;\n+\n+\n+// ====================================================================================\n+//  SEE THE DATA.LDIF FILE FOR THE LDAP LAYOUT\n+//\n+//   (it has comments at the top showing the tree)\n+// ====================================================================================\n+\n+//Normally, you would use an org.apache.directory.server.core.integ.FrameworkRunner to run LDAP tests\n+// however, that means you cannot use the SPRING runner, which makes life a bit more difficult.\n+// So, we added setupServer/shutdown() server methods that will start/stop the LDAP server in the same manner.\n+// This allows SPRING tests (with the spring runner) to run with an LDAP server!\n+@CreateLdapServer(\n+    transports = {@CreateTransport(port = 3333, protocol = \"LDAP\", address = \"localhost\")},\n+    allowAnonymousAccess = false\n+)\n+@CreateDS(\n+    name = \"myDS\",\n+    partitions = {@CreatePartition(name = \"test\", suffix = LDAPUserDetailsContextMapperWithProfileSearchEnhancedTest.ldapSearchBase)}\n+)\n+@ApplyLdifFiles({\"org/fao/geonet/kernel/security/ldap/data.ldif\"})\n+//run with spring\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(locations = {\n+    \"classpath:org/fao/geonet/kernel/security/ldap/LDAPUserDetailsContextMapperWithProfileSearchEnhancedTest-context.xml\"})\n+@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_CLASS)\n+public class LDAPUserDetailsContextMapperWithProfileSearchEnhancedTest extends AbstractLdapTestUnit {\n+\n+    @Autowired\n+    private ConfigurableApplicationContext _appContext;\n+\n+    @Autowired\n+    private UserRepository userRepository;\n+\n+    @Autowired\n+    private UserGroupRepository userGroupRepository;\n+\n+    @Autowired\n+    private GroupRepository groupRepository;\n+\n+    @Autowired\n+    DefaultSpringSecurityContextSource contextSource;\n+\n+    @Autowired\n+    LdapUsernameToDnMapper usernameMapper;\n+\n+    @Autowired\n+    LdapUserDetailsManager ldapUserDetailsService;\n+\n+    @Autowired\n+    LDAPUserDetailsContextMapperWithProfileSearchEnhanced ldapUserContextMapper;\n+\n+    @Autowired\n+    LdapAuthenticationProvider ldapAuthProvider;\n+\n+    @Autowired\n+    FilterBasedLdapUserSearch ldapUserSearch;\n+\n+    @Autowired\n+    LDAPRoleConverterGroupNameParser ldapRoleConverterGroupNameParser;\n+\n+    //very simple test\n+    // this will find the DN by searching by username\n+    @Test\n+    public void test_searchingLdapUsernameToDnMapper() {\n+        DistinguishedName name = usernameMapper.buildDn(\"dblasby@example.com\");\n+        assertEquals(\"cn=blasby\\\\, david,ou=GIS Department,ou=Corporate Users\", name.toString());\n+\n+\n+        name = usernameMapper.buildDn(\"jgee@example.com\");\n+        assertEquals(\"cn=gee\\\\, jody,ou=Project Admin,ou=Corporate Users\", name.toString());\n+    }\n+\n+\n+    //trivial test - make sure that the we can access the LDAP server and do a query via the contextSource bean\n+    @Test\n+    public void test_contextSource() throws NamingException {\n+        DirContext ctx = contextSource.getReadOnlyContext();\n+        List<SearchResult> results = queryLDAP(\"(objectClass=*)\", ctx, null, null);\n+        assertTrue(results.size() > 8);\n+    }\n+\n+    //trivial test to make sure ldapUserSearch is working (finds users)\n+    @Test\n+    public void test_ldapUserSearch() {\n+        DirContextOperations result = ldapUserSearch.searchForUser(\"dblasby@example.com\");\n+        assertNotNull(result);\n+        assertEquals(\"cn=blasby\\\\, david,ou=GIS Department,ou=Corporate Users\", result.getDn().toString());\n+    }\n+\n+    //test the ldapUserDetailsService bean by looking for a user\n+    //This bean also imports the LDAP user into geonetwork (i.e. inside UserRepo)\n+    @Test\n+    public void test_ldapUserDetailsService() throws NamingException {\n+        boolean orig_importPrivilegesFromLdap = ldapUserContextMapper.isImportPrivilegesFromLdap();\n+        try {\n+            ldapUserContextMapper.setImportPrivilegesFromLdap(false); // we don't want to do this for this test case - this is just about the basics\n+            UserDetails details = ldapUserDetailsService.loadUserByUsername(\"dblasby@example.com\");\n+            assertNotNull(details);\n+\n+            User user = userRepository.findOneByUsername(\"dblasby@example.com\");\n+            assertNotNull(user);\n+            assertEquals(\"blasby\", user.getSurname());\n+        } finally {\n+            ldapUserContextMapper.setImportPrivilegesFromLdap(orig_importPrivilegesFromLdap); //reset\n+        }\n+    }\n+\n+\n+    //this is the main test - will set group/profiles for the user (dblasby)\n+    @Test\n+    @Transactional\n+    public void test_ldapUserDetailsService_groups_and_profiles_dblasby() throws NamingException {\n+\n+        //make sure its already in the repository, or nothing will happen\n+        Group group = new Group().setName(\"GENERAL\");\n+        group = groupRepository.save(group);\n+\n+\n+        UserDetails details = ldapUserDetailsService.loadUserByUsername(\"dblasby@example.com\");\n+        assertNotNull(details);\n+        assertEquals(3, details.getAuthorities().size());\n+        assertEquals(Profile.Guest.name(), details.getAuthorities().toArray(new GrantedAuthority[0])[0].getAuthority());\n+        assertEquals(Profile.Editor.name(), details.getAuthorities().toArray(new GrantedAuthority[0])[1].getAuthority());\n+        assertEquals(Profile.RegisteredUser.name(), details.getAuthorities().toArray(new GrantedAuthority[0])[2].getAuthority());\n+\n+\n+        LDAPUser user1 = (LDAPUser) details;\n+        assertEquals(1, user1.getPrivileges().size());\n+        assertTrue(user1.getPrivileges().containsKey(\"GENERAL\"));\n+        assertEquals(1, user1.getPrivileges().get(\"GENERAL\").toArray().length);\n+        assertEquals(Profile.Editor, user1.getPrivileges().get(\"GENERAL\").toArray()[0]);\n+\n+\n+        User user = userRepository.findOneByUsername(\"dblasby@example.com\");\n+        assertNotNull(user);\n+        assertEquals(\"blasby\", user.getSurname());\n+        assertEquals(Profile.Editor, user.getProfile());\n+\n+        List<UserGroup> ug = userGroupRepository.findAll(UserGroupSpecs.hasUserId(user.getId()));\n+        assertNotNull(ug);\n+        assertEquals(1, ug.size());\n+        assertEquals(\"GENERAL\", ug.get(0).getGroup().getName());\n+    }\n+\n+    //this is the main test - will set group/profiles for the user (admin)\n+    @Test\n+    @Transactional\n+    public void test_ldapUserDetailsService_groups_and_profiles_admin() throws NamingException {\n+\n+        //make sure its already in the repository, or nothing will happen\n+        Group group = new Group().setName(\"GENERAL\");\n+        group = groupRepository.save(group);\n+\n+\n+        UserDetails details = ldapUserDetailsService.loadUserByUsername(\"admin@example.com\");\n+        assertNotNull(details);\n+\n+        LDAPUser user1 = (LDAPUser) details;\n+        assertEquals(1, user1.getPrivileges().size());\n+        assertTrue(user1.getPrivileges().containsKey(\"GENERAL\"));\n+        assertEquals(1, user1.getPrivileges().get(\"GENERAL\").toArray().length);\n+        assertEquals(Profile.Administrator, user1.getPrivileges().get(\"GENERAL\").toArray()[0]);\n+\n+\n+        User user = userRepository.findOneByUsername(\"admin@example.com\");\n+        assertNotNull(user);\n+        assertEquals(\"admin\", user.getSurname());\n+        assertEquals(Profile.Administrator, user.getProfile());\n+\n+        List<UserGroup> ug = userGroupRepository.findAll(UserGroupSpecs.hasUserId(user.getId()));\n+        assertNotNull(ug);\n+        assertEquals(1, ug.size());\n+        assertEquals(\"GENERAL\", ug.get(0).getGroup().getName());\n+    }\n+\n+    //this is the main test - will set group/profiles for the user (jody)\n+    @Test\n+    @Transactional\n+    public void test_ldapUserDetailsService_groups_and_profiles_jody() throws NamingException {\n+\n+        //make sure its already in the repository, or nothing will happen\n+        Group group = new Group().setName(\"GENERAL\");\n+        group = groupRepository.save(group);\n+\n+\n+        UserDetails details = ldapUserDetailsService.loadUserByUsername(\"jgee@example.com\");\n+        assertNotNull(details);\n+\n+        LDAPUser user1 = (LDAPUser) details;\n+        assertEquals(0, user1.getPrivileges().size());\n+\n+        User user = userRepository.findOneByUsername(\"jgee@example.com\");\n+        assertNotNull(user);\n+        assertEquals(\"gee\", user.getSurname());\n+        assertEquals(Profile.RegisteredUser, user.getProfile());\n+\n+        List<UserGroup> ug = userGroupRepository.findAll(UserGroupSpecs.hasUserId(user.getId()));\n+        assertNotNull(ug);\n+        assertEquals(0, ug.size());\n+    }\n+\n+\n+    @Test\n+    @Transactional\n+    public void test_ldapAuthProvider() {\n+        UsernamePasswordAuthenticationToken userpass = new UsernamePasswordAuthenticationToken(\"dblasby@example.com\", \"blasby1\", null);\n+\n+        Authentication result = ldapAuthProvider.authenticate(userpass);\n+        assertNotNull(result);\n+        assertTrue(result.isAuthenticated());\n+    }\n+\n+    @Test(expected = BadCredentialsException.class)\n+    public void test_ldapAuthProvider_badPass() {\n+        UsernamePasswordAuthenticationToken userpass = new UsernamePasswordAuthenticationToken(\"dblasby@example.com\", \"BAD_PASSWORD\", null);\n+\n+        //will throw because the password is wrong\n+        Authentication result = ldapAuthProvider.authenticate(userpass);\n+    }\n+\n+\n+    //=========================================================================================\n+\n+    public final static String ldapSearchBase = \"dc=example,dc=com\";\n+\n+\n+    DirectoryService LDAPservice = null;\n+    LdapServer ldapServer = null;\n+\n+    public void setupLDAP() throws Exception {\n+        CreateLdapServer classLdapServerBuilder = this.getClass().getAnnotation(CreateLdapServer.class);\n+        CreateDS dsBuilder = this.getClass().getAnnotation(CreateDS.class);\n+        LDAPservice = DSAnnotationProcessor.createDS(dsBuilder);\n+        ApplyLdifFiles applyLdifFiles = this.getClass().getAnnotation(ApplyLdifFiles.class);\n+        DSAnnotationProcessor.injectLdifFiles(applyLdifFiles.clazz(), LDAPservice, applyLdifFiles.value());\n+\n+        CreateLdapServer createLdapServer = getClass().getAnnotation(CreateLdapServer.class);\n+        ldapServer = ServerAnnotationProcessor.instantiateLdapServer(createLdapServer, LDAPservice);\n+        ldapServer.start();\n+    }\n+\n+    public void shutdownLDAP() throws Exception {\n+        ldapServer.stop();\n+        LDAPservice.shutdown();\n+        FileUtils.deleteDirectory(LDAPservice.getInstanceLayout().getInstanceDirectory());\n+    }\n+\n+    @After\n+    public void after() throws Exception {\n+        shutdownLDAP();\n+    }\n+\n+    //gets the spring context\n+    @Before\n+    public void before() throws Exception {\n+        setupLDAP();\n+        ApplicationContextHolder.set(this._appContext); // this is for code using antipattern - ApplicationContextHolder.get().getBean(...)\n+\n+        userRepository.deleteAll();\n+        groupRepository.deleteAll();\n+        userGroupRepository.deleteAll();\n+    }", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0NzYxMQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r465647611", "bodyText": "Since you are always using the same LDAP configuration for all test why not start and stop the LDAP server only once using @BeforeClass and @AfterClass to call setupLDAP() and shutdownLDAP() methods?\nIn my machine that reduces the run time of the tests from  1m 17s to 800ms", "author": "juanluisrp", "createdAt": "2020-08-05T11:08:02Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPUserDetailsContextMapperWithProfileSearchEnhancedTest.java", "diffHunk": "@@ -0,0 +1,439 @@\n+/*\n+ * Copyright (C) 2001-2016 Food and Agriculture Organization of the\n+ * United Nations (FAO-UN), United Nations World Food Programme (WFP)\n+ * and United Nations Environment Programme (UNEP)\n+ *\n+ * This program is free software; you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation; either version 2 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful, but\n+ * WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+ *\n+ * Contact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+ * Rome - Italy. email: geonetwork@osgeo.org\n+ */\n+package org.fao.geonet.kernel.security.ldap;\n+\n+import org.apache.directory.api.util.FileUtils;\n+import org.apache.directory.server.annotations.CreateLdapServer;\n+import org.apache.directory.server.annotations.CreateTransport;\n+import org.apache.directory.server.core.annotations.ApplyLdifFiles;\n+import org.apache.directory.server.core.annotations.CreateDS;\n+import org.apache.directory.server.core.annotations.CreatePartition;\n+import org.apache.directory.server.core.api.DirectoryService;\n+import org.apache.directory.server.core.factory.DSAnnotationProcessor;\n+import org.apache.directory.server.core.integ.AbstractLdapTestUnit;\n+import org.apache.directory.server.factory.ServerAnnotationProcessor;\n+import org.apache.directory.server.ldap.LdapServer;\n+import org.fao.geonet.ApplicationContextHolder;\n+import org.fao.geonet.domain.*;\n+import org.fao.geonet.repository.GroupRepository;\n+import org.fao.geonet.repository.UserGroupRepository;\n+import org.fao.geonet.repository.UserRepository;\n+import org.fao.geonet.repository.specification.UserGroupSpecs;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.ConfigurableApplicationContext;\n+import org.springframework.ldap.core.*;\n+import org.springframework.security.authentication.BadCredentialsException;\n+import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.GrantedAuthority;\n+import org.springframework.security.core.userdetails.UserDetails;\n+import org.springframework.security.ldap.DefaultSpringSecurityContextSource;\n+import org.springframework.security.ldap.LdapUsernameToDnMapper;\n+import org.springframework.security.ldap.LdapUtils;\n+import org.springframework.security.ldap.authentication.LdapAuthenticationProvider;\n+import org.springframework.security.ldap.search.FilterBasedLdapUserSearch;\n+import org.springframework.test.annotation.DirtiesContext;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import javax.naming.Context;\n+import javax.naming.NameClassPair;\n+import javax.naming.NamingEnumeration;\n+import javax.naming.NamingException;\n+import javax.naming.directory.DirContext;\n+import javax.naming.directory.InitialDirContext;\n+import javax.naming.directory.SearchControls;\n+import javax.naming.directory.SearchResult;\n+import java.util.Collections;\n+import java.util.Hashtable;\n+import java.util.List;\n+\n+import static org.junit.Assert.*;\n+\n+\n+// ====================================================================================\n+//  SEE THE DATA.LDIF FILE FOR THE LDAP LAYOUT\n+//\n+//   (it has comments at the top showing the tree)\n+// ====================================================================================\n+\n+//Normally, you would use an org.apache.directory.server.core.integ.FrameworkRunner to run LDAP tests\n+// however, that means you cannot use the SPRING runner, which makes life a bit more difficult.\n+// So, we added setupServer/shutdown() server methods that will start/stop the LDAP server in the same manner.\n+// This allows SPRING tests (with the spring runner) to run with an LDAP server!\n+@CreateLdapServer(\n+    transports = {@CreateTransport(port = 3333, protocol = \"LDAP\", address = \"localhost\")},\n+    allowAnonymousAccess = false\n+)\n+@CreateDS(\n+    name = \"myDS\",\n+    partitions = {@CreatePartition(name = \"test\", suffix = LDAPUserDetailsContextMapperWithProfileSearchEnhancedTest.ldapSearchBase)}\n+)\n+@ApplyLdifFiles({\"org/fao/geonet/kernel/security/ldap/data.ldif\"})\n+//run with spring\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(locations = {\n+    \"classpath:org/fao/geonet/kernel/security/ldap/LDAPUserDetailsContextMapperWithProfileSearchEnhancedTest-context.xml\"})\n+@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_CLASS)\n+public class LDAPUserDetailsContextMapperWithProfileSearchEnhancedTest extends AbstractLdapTestUnit {\n+\n+    @Autowired\n+    private ConfigurableApplicationContext _appContext;\n+\n+    @Autowired\n+    private UserRepository userRepository;\n+\n+    @Autowired\n+    private UserGroupRepository userGroupRepository;\n+\n+    @Autowired\n+    private GroupRepository groupRepository;\n+\n+    @Autowired\n+    DefaultSpringSecurityContextSource contextSource;\n+\n+    @Autowired\n+    LdapUsernameToDnMapper usernameMapper;\n+\n+    @Autowired\n+    LdapUserDetailsManager ldapUserDetailsService;\n+\n+    @Autowired\n+    LDAPUserDetailsContextMapperWithProfileSearchEnhanced ldapUserContextMapper;\n+\n+    @Autowired\n+    LdapAuthenticationProvider ldapAuthProvider;\n+\n+    @Autowired\n+    FilterBasedLdapUserSearch ldapUserSearch;\n+\n+    @Autowired\n+    LDAPRoleConverterGroupNameParser ldapRoleConverterGroupNameParser;\n+\n+    //very simple test\n+    // this will find the DN by searching by username\n+    @Test\n+    public void test_searchingLdapUsernameToDnMapper() {\n+        DistinguishedName name = usernameMapper.buildDn(\"dblasby@example.com\");\n+        assertEquals(\"cn=blasby\\\\, david,ou=GIS Department,ou=Corporate Users\", name.toString());\n+\n+\n+        name = usernameMapper.buildDn(\"jgee@example.com\");\n+        assertEquals(\"cn=gee\\\\, jody,ou=Project Admin,ou=Corporate Users\", name.toString());\n+    }\n+\n+\n+    //trivial test - make sure that the we can access the LDAP server and do a query via the contextSource bean\n+    @Test\n+    public void test_contextSource() throws NamingException {\n+        DirContext ctx = contextSource.getReadOnlyContext();\n+        List<SearchResult> results = queryLDAP(\"(objectClass=*)\", ctx, null, null);\n+        assertTrue(results.size() > 8);\n+    }\n+\n+    //trivial test to make sure ldapUserSearch is working (finds users)\n+    @Test\n+    public void test_ldapUserSearch() {\n+        DirContextOperations result = ldapUserSearch.searchForUser(\"dblasby@example.com\");\n+        assertNotNull(result);\n+        assertEquals(\"cn=blasby\\\\, david,ou=GIS Department,ou=Corporate Users\", result.getDn().toString());\n+    }\n+\n+    //test the ldapUserDetailsService bean by looking for a user\n+    //This bean also imports the LDAP user into geonetwork (i.e. inside UserRepo)\n+    @Test\n+    public void test_ldapUserDetailsService() throws NamingException {\n+        boolean orig_importPrivilegesFromLdap = ldapUserContextMapper.isImportPrivilegesFromLdap();\n+        try {\n+            ldapUserContextMapper.setImportPrivilegesFromLdap(false); // we don't want to do this for this test case - this is just about the basics\n+            UserDetails details = ldapUserDetailsService.loadUserByUsername(\"dblasby@example.com\");\n+            assertNotNull(details);\n+\n+            User user = userRepository.findOneByUsername(\"dblasby@example.com\");\n+            assertNotNull(user);\n+            assertEquals(\"blasby\", user.getSurname());\n+        } finally {\n+            ldapUserContextMapper.setImportPrivilegesFromLdap(orig_importPrivilegesFromLdap); //reset\n+        }\n+    }\n+\n+\n+    //this is the main test - will set group/profiles for the user (dblasby)\n+    @Test\n+    @Transactional\n+    public void test_ldapUserDetailsService_groups_and_profiles_dblasby() throws NamingException {\n+\n+        //make sure its already in the repository, or nothing will happen\n+        Group group = new Group().setName(\"GENERAL\");\n+        group = groupRepository.save(group);\n+\n+\n+        UserDetails details = ldapUserDetailsService.loadUserByUsername(\"dblasby@example.com\");\n+        assertNotNull(details);\n+        assertEquals(3, details.getAuthorities().size());\n+        assertEquals(Profile.Guest.name(), details.getAuthorities().toArray(new GrantedAuthority[0])[0].getAuthority());\n+        assertEquals(Profile.Editor.name(), details.getAuthorities().toArray(new GrantedAuthority[0])[1].getAuthority());\n+        assertEquals(Profile.RegisteredUser.name(), details.getAuthorities().toArray(new GrantedAuthority[0])[2].getAuthority());\n+\n+\n+        LDAPUser user1 = (LDAPUser) details;\n+        assertEquals(1, user1.getPrivileges().size());\n+        assertTrue(user1.getPrivileges().containsKey(\"GENERAL\"));\n+        assertEquals(1, user1.getPrivileges().get(\"GENERAL\").toArray().length);\n+        assertEquals(Profile.Editor, user1.getPrivileges().get(\"GENERAL\").toArray()[0]);\n+\n+\n+        User user = userRepository.findOneByUsername(\"dblasby@example.com\");\n+        assertNotNull(user);\n+        assertEquals(\"blasby\", user.getSurname());\n+        assertEquals(Profile.Editor, user.getProfile());\n+\n+        List<UserGroup> ug = userGroupRepository.findAll(UserGroupSpecs.hasUserId(user.getId()));\n+        assertNotNull(ug);\n+        assertEquals(1, ug.size());\n+        assertEquals(\"GENERAL\", ug.get(0).getGroup().getName());\n+    }\n+\n+    //this is the main test - will set group/profiles for the user (admin)\n+    @Test\n+    @Transactional\n+    public void test_ldapUserDetailsService_groups_and_profiles_admin() throws NamingException {\n+\n+        //make sure its already in the repository, or nothing will happen\n+        Group group = new Group().setName(\"GENERAL\");\n+        group = groupRepository.save(group);\n+\n+\n+        UserDetails details = ldapUserDetailsService.loadUserByUsername(\"admin@example.com\");\n+        assertNotNull(details);\n+\n+        LDAPUser user1 = (LDAPUser) details;\n+        assertEquals(1, user1.getPrivileges().size());\n+        assertTrue(user1.getPrivileges().containsKey(\"GENERAL\"));\n+        assertEquals(1, user1.getPrivileges().get(\"GENERAL\").toArray().length);\n+        assertEquals(Profile.Administrator, user1.getPrivileges().get(\"GENERAL\").toArray()[0]);\n+\n+\n+        User user = userRepository.findOneByUsername(\"admin@example.com\");\n+        assertNotNull(user);\n+        assertEquals(\"admin\", user.getSurname());\n+        assertEquals(Profile.Administrator, user.getProfile());\n+\n+        List<UserGroup> ug = userGroupRepository.findAll(UserGroupSpecs.hasUserId(user.getId()));\n+        assertNotNull(ug);\n+        assertEquals(1, ug.size());\n+        assertEquals(\"GENERAL\", ug.get(0).getGroup().getName());\n+    }\n+\n+    //this is the main test - will set group/profiles for the user (jody)\n+    @Test\n+    @Transactional\n+    public void test_ldapUserDetailsService_groups_and_profiles_jody() throws NamingException {\n+\n+        //make sure its already in the repository, or nothing will happen\n+        Group group = new Group().setName(\"GENERAL\");\n+        group = groupRepository.save(group);\n+\n+\n+        UserDetails details = ldapUserDetailsService.loadUserByUsername(\"jgee@example.com\");\n+        assertNotNull(details);\n+\n+        LDAPUser user1 = (LDAPUser) details;\n+        assertEquals(0, user1.getPrivileges().size());\n+\n+        User user = userRepository.findOneByUsername(\"jgee@example.com\");\n+        assertNotNull(user);\n+        assertEquals(\"gee\", user.getSurname());\n+        assertEquals(Profile.RegisteredUser, user.getProfile());\n+\n+        List<UserGroup> ug = userGroupRepository.findAll(UserGroupSpecs.hasUserId(user.getId()));\n+        assertNotNull(ug);\n+        assertEquals(0, ug.size());\n+    }\n+\n+\n+    @Test\n+    @Transactional\n+    public void test_ldapAuthProvider() {\n+        UsernamePasswordAuthenticationToken userpass = new UsernamePasswordAuthenticationToken(\"dblasby@example.com\", \"blasby1\", null);\n+\n+        Authentication result = ldapAuthProvider.authenticate(userpass);\n+        assertNotNull(result);\n+        assertTrue(result.isAuthenticated());\n+    }\n+\n+    @Test(expected = BadCredentialsException.class)\n+    public void test_ldapAuthProvider_badPass() {\n+        UsernamePasswordAuthenticationToken userpass = new UsernamePasswordAuthenticationToken(\"dblasby@example.com\", \"BAD_PASSWORD\", null);\n+\n+        //will throw because the password is wrong\n+        Authentication result = ldapAuthProvider.authenticate(userpass);\n+    }\n+\n+\n+    //=========================================================================================\n+\n+    public final static String ldapSearchBase = \"dc=example,dc=com\";\n+\n+\n+    DirectoryService LDAPservice = null;\n+    LdapServer ldapServer = null;\n+\n+    public void setupLDAP() throws Exception {\n+        CreateLdapServer classLdapServerBuilder = this.getClass().getAnnotation(CreateLdapServer.class);\n+        CreateDS dsBuilder = this.getClass().getAnnotation(CreateDS.class);\n+        LDAPservice = DSAnnotationProcessor.createDS(dsBuilder);\n+        ApplyLdifFiles applyLdifFiles = this.getClass().getAnnotation(ApplyLdifFiles.class);\n+        DSAnnotationProcessor.injectLdifFiles(applyLdifFiles.clazz(), LDAPservice, applyLdifFiles.value());\n+\n+        CreateLdapServer createLdapServer = getClass().getAnnotation(CreateLdapServer.class);\n+        ldapServer = ServerAnnotationProcessor.instantiateLdapServer(createLdapServer, LDAPservice);\n+        ldapServer.start();\n+    }\n+\n+    public void shutdownLDAP() throws Exception {\n+        ldapServer.stop();\n+        LDAPservice.shutdown();\n+        FileUtils.deleteDirectory(LDAPservice.getInstanceLayout().getInstanceDirectory());\n+    }\n+\n+    @After\n+    public void after() throws Exception {\n+        shutdownLDAP();\n+    }\n+\n+    //gets the spring context\n+    @Before\n+    public void before() throws Exception {\n+        setupLDAP();", "originalCommit": "97d78858a37e8ecbd0093a22f7f508da4e39b6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ee8619c87b0c765629275a2f925155184d385976", "url": "https://github.com/geonetwork/core-geonetwork/commit/ee8619c87b0c765629275a2f925155184d385976", "message": "changes from juan's review - mostly formating", "committedDate": "2020-08-06T19:47:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzExNDA4OA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r467114088", "bodyText": "This change seems to be the cause of the test failure, by by moving this to beforeclass and after class (rather than before and after test) the apache directory is still running, and using its own eccache.\nApparently each JVM can only have one eccache, and both hibernate and apache directory server want to make use of the technology.\nReference:\n\nCacheService", "author": "jodygarnett", "createdAt": "2020-08-07T15:32:39Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/ldap/LDAPUserDetailsContextMapperWithProfileSearchEnhancedTest.java", "diffHunk": "@@ -135,6 +133,29 @@\n     @Autowired\n     LDAPRoleConverterGroupNameParser ldapRoleConverterGroupNameParser;\n \n+\n+    //=------------------------------------------------------------------\n+\n+    @AfterClass\n+    public static void afterClass() throws Exception {\n+        shutdownLDAP();\n+    }\n+\n+    @BeforeClass\n+    public static void beforeClass() throws Exception {\n+        setupLDAP();", "originalCommit": "ee8619c87b0c765629275a2f925155184d385976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzExNTkyMg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r467115922", "bodyText": "One \"fix\" is to ugprade to ApacheDS 2.0.0.AM26 which replaces ecache with Caffeine.\n\nWe also have changed the Cache system we were using (ehcache) to use the more efficient and lighter Caffeine.", "author": "jodygarnett", "createdAt": "2020-08-07T15:36:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzExNDA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE0MzcwMw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r467143703", "bodyText": "We are trying this out, but requires some changes to newer maven and so on ...", "author": "jodygarnett", "createdAt": "2020-08-07T16:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzExNDA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIwOTIyNQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4878#discussion_r467209225", "bodyText": "Reverted to previous way of setting up / down the ldap server.\nAnd run  CacheManager.getInstance().shutdown() in @AfterClass to fix the problem with multiple chache managers in shibboleth tests.", "author": "juanluisrp", "createdAt": "2020-08-07T18:42:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzExNDA4OA=="}], "type": "inlineReview"}, {"oid": "d1b458a8d4b79c1778364f2d3f710615e21dcc9c", "url": "https://github.com/geonetwork/core-geonetwork/commit/d1b458a8d4b79c1778364f2d3f710615e21dcc9c", "message": "rollback changes for @BeforeClass and @AfterClass - its causing issues...", "committedDate": "2020-08-07T18:14:01Z", "type": "commit"}, {"oid": "d1b458a8d4b79c1778364f2d3f710615e21dcc9c", "url": "https://github.com/geonetwork/core-geonetwork/commit/d1b458a8d4b79c1778364f2d3f710615e21dcc9c", "message": "rollback changes for @BeforeClass and @AfterClass - its causing issues...", "committedDate": "2020-08-07T18:14:01Z", "type": "forcePushed"}]}