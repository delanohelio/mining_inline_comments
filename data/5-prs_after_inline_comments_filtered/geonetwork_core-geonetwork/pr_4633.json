{"pr_number": 4633, "pr_title": "Shibboleth improvements", "pr_createdAt": "2020-04-24T08:12:34Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4633", "timeline": [{"oid": "6234e15104c728d3d2c531873984f9436cfe44b0", "url": "https://github.com/geonetwork/core-geonetwork/commit/6234e15104c728d3d2c531873984f9436cfe44b0", "message": "In Shibboleth authentication, allow to login (or not) using other methods (BA, form,...). Configurable using a property", "committedDate": "2019-05-03T14:29:07Z", "type": "commit"}, {"oid": "fa8983faacbc7682348aa117f31df90a6255cc1b", "url": "https://github.com/geonetwork/core-geonetwork/commit/fa8983faacbc7682348aa117f31df90a6255cc1b", "message": "Adding a shared profile/group header to have the list on the same header", "committedDate": "2019-05-06T09:53:26Z", "type": "commit"}, {"oid": "a22aa11de52c2276364785edbec101709848ad01", "url": "https://github.com/geonetwork/core-geonetwork/commit/a22aa11de52c2276364785edbec101709848ad01", "message": "Merge branch 'master' of https://github.com/geonetwork/core-geonetwork into shibboleth_improvements", "committedDate": "2020-04-24T06:22:18Z", "type": "commit"}, {"oid": "03f5de4425a86e27de3e98487e0a6a4280f0ecf0", "url": "https://github.com/geonetwork/core-geonetwork/commit/03f5de4425a86e27de3e98487e0a6a4280f0ecf0", "message": "Shibboleth changes:\n- Add support for organisation header (Shib-EP-organisation)\n- Give precedence to header with group/roles (Shib-EP-GroupsRoles) over over individual headers for each items (Shib-EP-Groups, Shib-EP-Entitlement) if all are provided.\n- Fix unit tests", "committedDate": "2020-04-24T07:47:58Z", "type": "commit"}, {"oid": "cc02a61a7769e47ef297a9e7b097fb7db82afc85", "url": "https://github.com/geonetwork/core-geonetwork/commit/cc02a61a7769e47ef297a9e7b097fb7db82afc85", "message": "Shibboleth configuration - remove non existing multiNodeAuthenticationFilter reference", "committedDate": "2020-04-24T08:00:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MjU5Ng==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414442596", "bodyText": "typo", "author": "fxprunayre", "createdAt": "2020-04-24T09:44:51Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtilsTest.java", "diffHunk": "@@ -4,7 +4,7 @@\n  * and United Nations Environment Programme (UNEP)\n  *\n  * This program is free software; you can redistribute it and/or modify\n- * it under the terms of the GNU General Public License as published by\n+ * it under the terms of thgroupLengthNotMatchProfileLengthe GNU General Public License as published by", "originalCommit": "cc02a61a7769e47ef297a9e7b097fb7db82afc85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "url": "https://github.com/geonetwork/core-geonetwork/commit/ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "message": "Fix typo in file header comments", "committedDate": "2020-04-24T09:52:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4ODQ4OQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414488489", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:02:38Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtils.java", "diffHunk": "@@ -95,20 +98,47 @@ protected UserDetails setupUser(ServletRequest request, ShibbolethUserConfigurat\n \t\tString username = getHeader(req, config.getUsernameKey(), \"\");\n \t\tString surname = getHeader(req, config.getSurnameKey(), \"\");\n \t\tString firstname = getHeader(req, config.getFirstnameKey(), \"\");\n+        String organisation = getHeader(req, config.getOrganisationKey(), \"\");", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU1NTUxNg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r415555516", "bodyText": "In the IDE looks fine, but showing whitespace chars, the file has a mix of spaces/tabs, fixing it to replace with spaces.", "author": "josegar74", "createdAt": "2020-04-27T06:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4ODQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MDM4OA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414490388", "bodyText": "You can init this with groups.length size.", "author": "juanluisrp", "createdAt": "2020-04-24T11:06:08Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtils.java", "diffHunk": "@@ -95,20 +98,47 @@ protected UserDetails setupUser(ServletRequest request, ShibbolethUserConfigurat\n \t\tString username = getHeader(req, config.getUsernameKey(), \"\");\n \t\tString surname = getHeader(req, config.getSurnameKey(), \"\");\n \t\tString firstname = getHeader(req, config.getFirstnameKey(), \"\");\n+        String organisation = getHeader(req, config.getOrganisationKey(), \"\");\n \t\tString email = getHeader(req, config.getEmailKey(), \"\");\n \t\tString arraySeparator = config.getArraySeparator();\n-\n-\t\tString profile_header = getHeader(req, config.getProfileKey(), Profile.Guest.name());\n-\t\tString[] profiles = new String[0];\n-\t\tif (!StringUtils.isEmpty(profile_header)) {\n-\t\t\tprofiles = profile_header.split(arraySeparator);\n-\t\t}\n-\n-\t\tString group_header = getHeader(req, config.getGroupKey(), config.getDefaultGroup());\n-\t\tString[] groups = new String[0];\n-\t\tif (!StringUtils.isEmpty(group_header)) {\n-\t\t\tgroups = group_header.split(arraySeparator);\n-\t\t}\n+\t\tString roleGroupSeparator = config.getRoleGroupSeparator();\n+\n+        // RoleGroupKey header format: sample,UserAdmin;sample,Editor\n+        // It has precedence over individual ProfileKey and GroupKey headers if all are provided.\n+        //      - ProfileKey header format: UserAdmin;Editor\n+        //      - GroupKey header format: sample;sample\n+        String roleGroup_header = getHeader(req, config.getRoleGroupKey(), \"\");\n+        String[] roleGroups = new String[0];\n+        if (!StringUtils.isEmpty(roleGroup_header)) {\n+            roleGroups = roleGroup_header.split(arraySeparator);\n+        } else {\n+            String profile_header = getHeader(req, config.getProfileKey(), Profile.Guest.name());\n+            String[] profiles = new String[0];\n+            if (!StringUtils.isEmpty(profile_header)) {\n+                profiles = profile_header.split(arraySeparator);\n+            }\n+\n+            String group_header = getHeader(req, config.getGroupKey(), config.getDefaultGroup());\n+            String[] groups = new String[0];\n+            if (!StringUtils.isEmpty(group_header)) {\n+                groups = group_header.split(arraySeparator);\n+            }\n+\n+            List<String> roleGroupsList = new ArrayList<>();", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MDc0Mg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414490742", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:06:44Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtils.java", "diffHunk": "@@ -141,16 +172,18 @@ protected UserDetails setupUser(ServletRequest request, ShibbolethUserConfigurat\n \t\t\t\tuser.setUsername(username);\n \t\t\t\tuser.setSurname(surname);\n \t\t\t\tuser.setName(firstname);\n+                user.setOrganisation(organisation);", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MDkzMQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414490931", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:07:02Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtils.java", "diffHunk": "@@ -165,6 +198,7 @@ protected UserDetails setupUser(ServletRequest request, ShibbolethUserConfigurat\n \t\t\t\tif (ldapUserDetails == null) {\n \t\t\t\t\tldapUserDetails = new LDAPUser(username);\n \t\t\t\t\tldapUserDetails.getUser().setName(firstname).setSurname(surname);\n+                    ldapUserDetails.getUser().setOrganisation(organisation);", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MTM3NA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414491374", "bodyText": "formatting: should be for (...", "author": "juanluisrp", "createdAt": "2020-04-24T11:07:53Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtils.java", "diffHunk": "@@ -95,20 +98,47 @@ protected UserDetails setupUser(ServletRequest request, ShibbolethUserConfigurat\n \t\tString username = getHeader(req, config.getUsernameKey(), \"\");\n \t\tString surname = getHeader(req, config.getSurnameKey(), \"\");\n \t\tString firstname = getHeader(req, config.getFirstnameKey(), \"\");\n+        String organisation = getHeader(req, config.getOrganisationKey(), \"\");\n \t\tString email = getHeader(req, config.getEmailKey(), \"\");\n \t\tString arraySeparator = config.getArraySeparator();\n-\n-\t\tString profile_header = getHeader(req, config.getProfileKey(), Profile.Guest.name());\n-\t\tString[] profiles = new String[0];\n-\t\tif (!StringUtils.isEmpty(profile_header)) {\n-\t\t\tprofiles = profile_header.split(arraySeparator);\n-\t\t}\n-\n-\t\tString group_header = getHeader(req, config.getGroupKey(), config.getDefaultGroup());\n-\t\tString[] groups = new String[0];\n-\t\tif (!StringUtils.isEmpty(group_header)) {\n-\t\t\tgroups = group_header.split(arraySeparator);\n-\t\t}\n+\t\tString roleGroupSeparator = config.getRoleGroupSeparator();\n+\n+        // RoleGroupKey header format: sample,UserAdmin;sample,Editor\n+        // It has precedence over individual ProfileKey and GroupKey headers if all are provided.\n+        //      - ProfileKey header format: UserAdmin;Editor\n+        //      - GroupKey header format: sample;sample\n+        String roleGroup_header = getHeader(req, config.getRoleGroupKey(), \"\");\n+        String[] roleGroups = new String[0];\n+        if (!StringUtils.isEmpty(roleGroup_header)) {\n+            roleGroups = roleGroup_header.split(arraySeparator);\n+        } else {\n+            String profile_header = getHeader(req, config.getProfileKey(), Profile.Guest.name());\n+            String[] profiles = new String[0];\n+            if (!StringUtils.isEmpty(profile_header)) {\n+                profiles = profile_header.split(arraySeparator);\n+            }\n+\n+            String group_header = getHeader(req, config.getGroupKey(), config.getDefaultGroup());\n+            String[] groups = new String[0];\n+            if (!StringUtils.isEmpty(group_header)) {\n+                groups = group_header.split(arraySeparator);\n+            }\n+\n+            List<String> roleGroupsList = new ArrayList<>();\n+            for(int i = 0; i < groups.length; i++) {", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5Mjg2OA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414492868", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:10:39Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtils.java", "diffHunk": "@@ -251,7 +293,8 @@ private void assignProfile(String[] profiles, User user) {\n \t\tprivate String username;\n \t\tprivate String name;\n \t\tprivate String surname;\n-\t\tprivate String profile;\n+\t\tprivate String organisation;\n+        private String profile;", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5Mjk5OQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414492999", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:10:53Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtils.java", "diffHunk": "@@ -261,6 +304,7 @@ static MinimalUser create(ServletRequest request, ShibbolethUserConfiguration co\n \t\t\tString username = getHeader(req, config.getUsernameKey(), \"\");\n \t\t\tString surname = getHeader(req, config.getSurnameKey(), \"\");\n \t\t\tString firstname = getHeader(req, config.getFirstnameKey(), \"\");\n+            String organisation = getHeader(req, config.getOrganisationKey(), \"\");", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5NDA3NA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414494074", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:12:45Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtilsTest.java", "diffHunk": "@@ -80,7 +81,9 @@ public void setUp() {\n \t\tconfig.setSurnameKey(\"SURNAME_KEY\");\n \t\tconfig.setUpdateGroup(true);\n \t\tconfig.setUpdateProfile(true);\n-\t\tconfig.setUsernameKey(\"USERNAME_KEY\");\n+        config.setUsernameKey(\"USERNAME_KEY\");\n+\t\tconfig.setOrganisationKey(\"ORGANISATION_KEY\");\n+        config.setRoleGroupSeparator(\",\");", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5NDE3NQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414494175", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:12:54Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtilsTest.java", "diffHunk": "@@ -106,12 +109,13 @@ public void twoConsecutiveLogins() throws Exception {\n \t\tassertNull(\"User already exists\", user);\n \n \t\tString group = groupname + \"1\";\n-\t\tString profile = Profile.UserAdmin.name() + config.getArraySeparator() + Profile.Administrator.name();\n+\t\tString groups = group + config.getArraySeparator() + group;\n+        String profile = Profile.UserAdmin.name() + config.getArraySeparator() + Profile.Administrator.name();", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5NDI3Mw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414494273", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:13:04Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtilsTest.java", "diffHunk": "@@ -129,11 +133,12 @@ public void twoConsecutiveLogins() throws Exception {\n \n \t\t// Second round, same user different authorization\n \t\tgroup = groupname + \"3\";\n-\t\tprofile = Profile.Guest.name() + config.getArraySeparator() + Profile.Editor.name();\n+        groups = group + config.getArraySeparator() + group;\n+        profile = Profile.Guest.name() + config.getArraySeparator() + Profile.Editor.name();", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5NDQxNg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414494416", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:13:18Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtilsTest.java", "diffHunk": "@@ -160,12 +165,13 @@ public void twoConsecutiveLoginsNoAuthorization() throws Exception {\n \t\tassertNull(\"User already exists\", user);\n \n \t\tString group = groupname + \"1\";\n+        String groups = group + config.getArraySeparator() + group ;", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5NDY1NQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414494655", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:13:45Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtilsTest.java", "diffHunk": "@@ -183,10 +189,12 @@ public void twoConsecutiveLoginsNoAuthorization() throws Exception {\n \n \t\t// Second round, same user different authorization but the original\n \t\t// authorization should be kept (no updateProfile, updateGroups)\n+        String groupNew = groupname + \"3\";\n+        String groupsgroupNew = groupNew + config.getArraySeparator() + groupNew ;", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5NDcyNg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4633#discussion_r414494726", "bodyText": "Indentation", "author": "juanluisrp", "createdAt": "2020-04-24T11:13:52Z", "path": "core/src/test/java/org/fao/geonet/kernel/security/shibboleth/ShibbolethUserUtilsTest.java", "diffHunk": "@@ -221,6 +229,7 @@ public void groupLengthNotMatchProfileLength() throws Exception {\n \t\trequest.addHeader(this.config.getProfileKey(), profile);\n \t\trequest.addHeader(this.config.getSurnameKey(), surname);\n \t\trequest.addHeader(this.config.getUsernameKey(), username);\n+        request.addHeader(this.config.getOrganisationKey(), organisation);", "originalCommit": "ea3b60d68195aefcb270f5dc4ebcc7a282a068db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e1405a1f40d2c652ef447a61560462fb280f1720", "url": "https://github.com/geonetwork/core-geonetwork/commit/e1405a1f40d2c652ef447a61560462fb280f1720", "message": "Fix indentation issues and code improvements", "committedDate": "2020-04-27T06:52:05Z", "type": "commit"}]}