{"pr_number": 1449, "pr_title": "HelixClusterVerifier verify() with default waitTillVerify time -- part one", "pr_createdAt": "2020-10-07T04:10:53Z", "pr_url": "https://github.com/apache/helix/pull/1449", "timeline": [{"oid": "104e456d21647e9f2bb64adf9b746a2db259b802", "url": "https://github.com/apache/helix/commit/104e456d21647e9f2bb64adf9b746a2db259b802", "message": "fix #1448 part\n\nHelixClusterVerifier verify() and related method may return\npre-maturely. The reason is that the verify the converging stable\ncondition too early before controller has a chance to make\nchange. Basically the previous stable state is mistaken as the\nexpected next stable state.\n\nWe fix this issue by adding waitTillVerify() timeout in\nconstruction time of verifier.", "committedDate": "2020-10-07T03:49:02Z", "type": "commit"}, {"oid": "acdaf01bd39e8b4a22dbca7d18be9ad4ced4396c", "url": "https://github.com/apache/helix/commit/acdaf01bd39e8b4a22dbca7d18be9ad4ced4396c", "message": "some more.", "committedDate": "2020-10-07T04:06:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI0NDcwNg==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501244706", "bodyText": "Does this number change mean what we previously tested was wrong? How to justify the number change?", "author": "zhangmeng916", "createdAt": "2020-10-07T19:03:52Z", "path": "helix-core/src/test/java/org/apache/helix/controller/changedetector/TestResourceChangeDetector.java", "diffHunk": "@@ -438,7 +441,7 @@ public void testResetSnapshots() {\n     Assert.assertEquals(\n         changeDetector.getAdditionsByType(ChangeType.IDEAL_STATE).size() + changeDetector\n             .getChangesByType(ChangeType.IDEAL_STATE).size() + changeDetector\n-            .getRemovalsByType(ChangeType.IDEAL_STATE).size(), 2);\n+            .getRemovalsByType(ChangeType.IDEAL_STATE).size(), 1);", "originalCommit": "acdaf01bd39e8b4a22dbca7d18be9ad4ced4396c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI4MDMwNQ==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501280305", "bodyText": "see line 418, 419\n      // remove newly added resource/ideastate\n      _gSetupTool.getClusterManagementTool().dropResource(CLUSTER_NAME, resourceName);\n\nThe newly added resource in the previous test is not really valid. (Confirmed with JJ before.) Or they would break this test. So in this diff, it is removed.  Accordingly the number here needs to be adjusted too.", "author": "kaisun2000", "createdAt": "2020-10-07T20:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI0NDcwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI0NzYxNA==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501247614", "bodyText": "Just want to make sure, besides waiting for some time before verifying, the verify by polling function is same as what we previously did.", "author": "zhangmeng916", "createdAt": "2020-10-07T19:09:25Z", "path": "helix-core/src/test/java/org/apache/helix/integration/TestDisableCustomCodeRunner.java", "diffHunk": "@@ -209,9 +214,7 @@ public void test() throws Exception {\n \n     // Re-enable custom-code runner\n     admin.enableResource(clusterName, customCodeRunnerResource, true);\n-    result = ClusterStateVerifier.verifyByZkCallback(\n-        new ClusterStateVerifier.BestPossAndExtViewZkVerifier(ZK_ADDR, clusterName));\n-    Assert.assertTrue(result);\n+    Assert.assertTrue(verifier.verifyByPolling());", "originalCommit": "acdaf01bd39e8b4a22dbca7d18be9ad4ced4396c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI4MjIwMA==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501282200", "bodyText": "The new one BestPossibleExternalViewVerifier replaced the deprecated one ClusterStateVerifier and BestPossAndExtViewZkVerifier", "author": "kaisun2000", "createdAt": "2020-10-07T20:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI0NzYxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI0Nzg0OQ==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501247849", "bodyText": "Remove this line.", "author": "zhangmeng916", "createdAt": "2020-10-07T19:09:54Z", "path": "helix-core/src/test/java/org/apache/helix/integration/TestEnableCompression.java", "diffHunk": "@@ -111,10 +111,14 @@ public void testEnableCompressionResource() throws Exception {\n     }\n \n     BestPossibleExternalViewVerifier verifier =\n-        new BestPossibleExternalViewVerifier.Builder(clusterName).setZkAddr(ZK_ADDR)\n-            .setExpectLiveInstances(expectedLiveInstances).setResources(expectedResources).build();\n-    boolean result = verifier.verify(120000L);\n-    Assert.assertTrue(result);\n+        new BestPossibleExternalViewVerifier.Builder(clusterName).setZkClient(_gZkClient)\n+            .setExpectLiveInstances(expectedLiveInstances).setResources(expectedResources)\n+            .setWaitTillVerify(TestHelper.DEFAULT_REBALANCE_PROCESSING_WAIT_TIME)\n+            .build();\n+\n+    System.out.println(\"before TestEnableCompression verify by polling\");", "originalCommit": "acdaf01bd39e8b4a22dbca7d18be9ad4ced4396c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI4NTc5OQ==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501285799", "bodyText": "removed,", "author": "kaisun2000", "createdAt": "2020-10-07T20:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI0Nzg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI0ODUzNw==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501248537", "bodyText": "Can we define the number somewhere instead of using a math expression?", "author": "zhangmeng916", "createdAt": "2020-10-07T19:11:10Z", "path": "helix-core/src/test/java/org/apache/helix/integration/TestEnableCompression.java", "diffHunk": "@@ -111,10 +111,14 @@ public void testEnableCompressionResource() throws Exception {\n     }\n \n     BestPossibleExternalViewVerifier verifier =\n-        new BestPossibleExternalViewVerifier.Builder(clusterName).setZkAddr(ZK_ADDR)\n-            .setExpectLiveInstances(expectedLiveInstances).setResources(expectedResources).build();\n-    boolean result = verifier.verify(120000L);\n-    Assert.assertTrue(result);\n+        new BestPossibleExternalViewVerifier.Builder(clusterName).setZkClient(_gZkClient)\n+            .setExpectLiveInstances(expectedLiveInstances).setResources(expectedResources)\n+            .setWaitTillVerify(TestHelper.DEFAULT_REBALANCE_PROCESSING_WAIT_TIME)\n+            .build();\n+\n+    System.out.println(\"before TestEnableCompression verify by polling\");\n+    boolean reuslt = verifier.verifyByPolling(20 * 60 * 1000, 2000);", "originalCommit": "acdaf01bd39e8b4a22dbca7d18be9ad4ced4396c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI1OTQ3Nw==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501259477", "bodyText": "Is previous verification moved to somewhere else?", "author": "zhangmeng916", "createdAt": "2020-10-07T19:31:38Z", "path": "helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestSemiAutoRebalance.java", "diffHunk": "@@ -92,33 +95,11 @@ public void beforeClass() throws InterruptedException {\n     _controller = new ClusterControllerManager(ZK_ADDR, CLUSTER_NAME, controllerName);\n     _controller.syncStart();\n \n-    Thread.sleep(1000);\n-\n-    // verify ideal state and external view\n-    IdealState idealState = _accessor.getProperty(_keyBuilder.idealStates(DB_NAME));\n-    Assert.assertNotNull(idealState);\n-    Assert.assertEquals(idealState.getNumPartitions(), PARTITION_NUMBER);\n-    for (String partition : idealState.getPartitionSet()) {\n-      List<String> preferenceList = idealState.getPreferenceList(partition);\n-      Assert.assertNotNull(preferenceList);\n-      Assert.assertEquals(preferenceList.size(), REPLICA_NUMBER);\n-    }\n-\n-    ExternalView externalView = _accessor.getProperty(_keyBuilder.externalView(DB_NAME));\n-    Assert.assertNotNull(externalView);\n-    Assert.assertEquals(externalView.getPartitionSet().size(), PARTITION_NUMBER);\n-    for (String partition : externalView.getPartitionSet()) {\n-      Map<String, String> stateMap = externalView.getStateMap(partition);\n-      Assert.assertEquals(stateMap.size(), REPLICA_NUMBER);\n-\n-      int masters = 0;\n-      for (String state : stateMap.values()) {\n-        if (state.equals(MasterSlaveSMD.States.MASTER.name())) {\n-          ++masters;\n-        }\n-      }\n-      Assert.assertEquals(masters, 1);\n-    }\n+    ZkHelixClusterVerifier verifier = new BestPossibleExternalViewVerifier.Builder(CLUSTER_NAME)", "originalCommit": "acdaf01bd39e8b4a22dbca7d18be9ad4ced4396c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI4Njk4NA==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501286984", "bodyText": "replaced by line 102. The previous way is really too old. Older than deprecated ClusterVerifier and it does not work sometimes.", "author": "kaisun2000", "createdAt": "2020-10-07T20:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI1OTQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI1OTgyMg==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501259822", "bodyText": "Please change Db2 to a better name.", "author": "zhangmeng916", "createdAt": "2020-10-07T19:32:10Z", "path": "helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalance.java", "diffHunk": "@@ -164,9 +169,19 @@ public void testAutoRebalance() throws Exception {\n     // kill 1 node\n     _participants[0].syncStop();\n \n-    boolean result = ClusterStateVerifier\n-        .verifyByZkCallback(new ExternalViewBalancedVerifier(_gZkClient, CLUSTER_NAME, TEST_DB));\n-    Assert.assertTrue(result);\n+    ZkHelixClusterVerifier verifierTestDb = new BestPossibleExternalViewVerifier.Builder(CLUSTER_NAME)\n+        .setResources(new HashSet<>(Collections.singleton(TEST_DB)))\n+        .setZkClient(_gZkClient)\n+        .setWaitTillVerify(TestHelper.DEFAULT_REBALANCE_PROCESSING_WAIT_TIME)\n+        .build();\n+    Assert.assertTrue(verifierTestDb.verifyByPolling());\n+\n+    ZkHelixClusterVerifier verifierDb2 = new BestPossibleExternalViewVerifier.Builder(CLUSTER_NAME)", "originalCommit": "acdaf01bd39e8b4a22dbca7d18be9ad4ced4396c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI4ODYwNA==", "url": "https://github.com/apache/helix/pull/1449#discussion_r501288604", "bodyText": "Changed to \"verifierClusterDb2\" as the purpose it to validate cluster Db2", "author": "kaisun2000", "createdAt": "2020-10-07T20:26:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI1OTgyMg=="}], "type": "inlineReview"}, {"oid": "08064b4b323a84d6eaa3f749a6d3bfd83f72889f", "url": "https://github.com/apache/helix/commit/08064b4b323a84d6eaa3f749a6d3bfd83f72889f", "message": "some updates based on Meng's feedback.", "committedDate": "2020-10-07T20:27:40Z", "type": "commit"}]}