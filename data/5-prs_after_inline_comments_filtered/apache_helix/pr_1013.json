{"pr_number": 1013, "pr_title": "Add timeout for stoppable post request", "pr_createdAt": "2020-05-15T18:47:18Z", "pr_url": "https://github.com/apache/helix/pull/1013", "timeline": [{"oid": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "url": "https://github.com/apache/helix/commit/0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "message": "Add timeout for stoppable post request\n\nIn this commit, a http timeout has been added for the POST requests\nwhich is mainly used for REST's stoppable check.", "committedDate": "2020-05-15T16:59:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTQ2MA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426055460", "bodyText": "Is this strictly for Helix REST? In that case, should we try to put this in a PropertyKey constant file in the helix-rest module?", "author": "narendly", "createdAt": "2020-05-15T21:28:38Z", "path": "helix-common/src/main/java/org/apache/helix/SystemPropertyKeys.java", "diffHunk": "@@ -78,4 +78,7 @@\n   // System Property Metadata Store Directory Server endpoint key\n   public static final String MSDS_SERVER_ENDPOINT_KEY =\n       MetadataStoreRoutingConstants.MSDS_SERVER_ENDPOINT_KEY;\n+\n+  // System property for request timeout\n+  public static final String HTTP_REQUEST_TIMEOUT = \"http.request.timeout\";", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIyNjI3MA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426226270", "bodyText": "+1. There are other places like MSDS that also have timeout config. This should be narrow down to helix rest or even stoppable.", "author": "huizhilu", "createdAt": "2020-05-17T07:07:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTQ2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3MDE3NA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427570174", "bodyText": "Done. Added a file called RestSystemPropertyKeys and added this key to that file.", "author": "alirezazamani", "createdAt": "2020-05-19T20:10:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTY4Mg==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426055682", "bodyText": "For timeout values, we usually use long type.\n60 * 1000L;", "author": "narendly", "createdAt": "2020-05-15T21:29:15Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/client/CustomRestClientFactory.java", "diffHunk": "@@ -32,10 +36,13 @@\n  */\n public class CustomRestClientFactory {\n   private static final Logger LOG = LoggerFactory.getLogger(CustomRestClientFactory.class);\n+  private static final int DEFAULT_HTTP_REQUEST_TIMEOUT = 60 * 1000;", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3MDM5Mw==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427570393", "bodyText": "I noticed that as well. But since the setSocketTimeout and setConnectionRequestTimeout methods are getting int as input, I prefer to keep them as int. If not we need to have additional type casting.", "author": "alirezazamani", "createdAt": "2020-05-19T20:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4NzE2Mg==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427587162", "bodyText": "Interesting. In that case, could we leave a comment? That way, the intention is clear, and as the writer of this PR, you can justify using an int.", "author": "narendly", "createdAt": "2020-05-19T20:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5MzU5Nw==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428293597", "bodyText": "Sure. Added a comments.", "author": "alirezazamani", "createdAt": "2020-05-20T20:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjIzNA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426056234", "bodyText": "Do we want to set the socket and connect timeout as well? Those two seem unrelated to the problem you're solving. I am not saying we shouldn't necessarily, but we should understand the implications of setting such configs.\nAlso it would be good to add a line of comment describing what you're doing here.", "author": "narendly", "createdAt": "2020-05-15T21:30:43Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/client/CustomRestClientFactory.java", "diffHunk": "@@ -44,14 +51,17 @@ public static CustomRestClient get() {\n         if (INSTANCE == null) {\n           try {\n             HttpClient httpClient;\n+            RequestConfig config = RequestConfig.custom().setConnectTimeout(_httpRequestTimeout)\n+                .setConnectionRequestTimeout(_httpRequestTimeout)\n+                .setSocketTimeout(_httpRequestTimeout).build();", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3MDQ1OA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427570458", "bodyText": "I think we prefer to have a timeout for any reason and not be blocked to query SN. That is why I used both of them as same value. Also I noticed that we do same for other classes such as HttpRoutingDataReader. I do not have strong preferences about this. I feel we should reduce the amount of configs as much as possible.", "author": "alirezazamani", "createdAt": "2020-05-19T20:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjY3MQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426056671", "bodyText": ":\"back to its original value\" -> where is the original value set?", "author": "narendly", "createdAt": "2020-05-15T21:32:03Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/client/TestCustomRestClient.java", "diffHunk": "@@ -145,6 +150,19 @@ public void testPostRequestFormat() throws IOException {\n     Assert.assertEquals(json.get(\"data\").asText(), \"{}\");\n   }\n \n+  @Test(expectedExceptions = ConnectTimeoutException.class)\n+  public void testPostRequestSmallTimeout() throws IOException {\n+    // Set 1 ms to cause timeout for requests\n+    System.setProperty(SystemPropertyKeys.HTTP_REQUEST_TIMEOUT, \"1\");\n+    // a popular echo server that echos all the inputs\n+    final String echoServer = \"http://httpbin.org/post\";\n+    CustomRestClient _customRestClient = MockCustomRestClientFactory.get();\n+    _customRestClient.getInstanceStoppableCheck(echoServer, Collections.emptyMap());\n+\n+    // Reset the HTTP_REQUEST_TIMEOUT property back to its original value\n+    System.setProperty(SystemPropertyKeys.HTTP_REQUEST_TIMEOUT, \"60000\");", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0NjQ5MA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427646490", "bodyText": "Fixed. Thanks.", "author": "alirezazamani", "createdAt": "2020-05-19T22:57:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjcyNg==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426056726", "bodyText": "Use long", "author": "narendly", "createdAt": "2020-05-15T21:32:13Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/client/TestCustomRestClient.java", "diffHunk": "@@ -161,4 +179,35 @@ protected JsonNode getJsonObject(HttpResponse httpResponse) throws IOException {\n       return new ObjectMapper().readTree(_jsonResponse);\n     }\n   }\n+\n+  /**\n+   * This MockCustomRestClientFactory is necessary to have for testing because once an INSTANCE is\n+   * initialized in CustomRestClientFactory while running \"mvn test\" , it will no re-initialize the\n+   * INSTANCE with new HelixProperty. Hence this class makes sure that new CustomRestClient will be\n+   * created with the timeout set to the new value.\n+   */\n+  private static class MockCustomRestClientFactory extends CustomRestClientFactory {\n+    private static final int DEFAULT_HTTP_REQUEST_TIMEOUT = 60 * 1000;", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3MTE2MQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427571161", "bodyText": "Please see my answer above. If you strongly feel we should do long, I can do it. But I think this way the code will be cleaner.", "author": "alirezazamani", "createdAt": "2020-05-19T20:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4ODExNw==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427588117", "bodyText": "in that case, using an int is fine. But can we avoid creating yet another constant here? I believe we already define it elsewhere.", "author": "narendly", "createdAt": "2020-05-19T20:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5MzQ0Nw==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428293447", "bodyText": "I added comments about it. I removed the default constant and directly uses the value in getSystemPropertyAsInt to avoid creating new constants. I found some other default values in for http request for MSDS related code. However, I am not sure if that is a good idea to have one default for everything. Anyway, please have a look and see if this makes sense.", "author": "alirezazamani", "createdAt": "2020-05-20T20:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjkwOA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426056908", "bodyText": "Please fix typos.", "author": "narendly", "createdAt": "2020-05-15T21:32:40Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/client/TestCustomRestClient.java", "diffHunk": "@@ -161,4 +179,35 @@ protected JsonNode getJsonObject(HttpResponse httpResponse) throws IOException {\n       return new ObjectMapper().readTree(_jsonResponse);\n     }\n   }\n+\n+  /**\n+   * This MockCustomRestClientFactory is necessary to have for testing because once an INSTANCE is\n+   * initialized in CustomRestClientFactory while running \"mvn test\" , it will no re-initialize the", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0NjQyMw==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427646423", "bodyText": "Removed. Thanks. I realize this class can be removed and not needed.", "author": "alirezazamani", "createdAt": "2020-05-19T22:57:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIyNjQxMQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426226411", "bodyText": "Could combine DEFAULT_HTTP_REQUEST_TIMEOUT and this, right? And also this var is static final, would be better to name it a constant?\nBack from your test, if we don't make this a constant but a local var in get(), we could avoid the MockCustomRestClientFactory by resetting the instance using reflection.", "author": "huizhilu", "createdAt": "2020-05-17T07:09:04Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/client/CustomRestClientFactory.java", "diffHunk": "@@ -32,10 +36,13 @@\n  */\n public class CustomRestClientFactory {\n   private static final Logger LOG = LoggerFactory.getLogger(CustomRestClientFactory.class);\n+  private static final int DEFAULT_HTTP_REQUEST_TIMEOUT = 60 * 1000;\n+  private static final int _httpRequestTimeout = HelixUtil.getSystemPropertyAsInt(", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0NTIxOQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427645219", "bodyText": "I combined the Default and getSystemProperty. Thanks.", "author": "alirezazamani", "createdAt": "2020-05-19T22:53:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIyNjQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIyNzczMA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426227730", "bodyText": "What's the purpose of logging and throwing exception?\nBy checking the calling stack, I don't think it is necessary. ConnectTimeoutException also extends IOException which is already caught. The upper method getHealthStatusFromRest catches this exception and logs. If you log and throw here, there would be two error messages which are confusing and redundant. Eg, in the test you write, we would see the error log in our test output if we set logging level to print errors. And it is quite confusing.", "author": "huizhilu", "createdAt": "2020-05-17T07:24:50Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/client/CustomRestClientImpl.java", "diffHunk": "@@ -130,6 +131,11 @@ protected HttpResponse post(String url, Map<String, String> payloads) throws IOE\n       LOG.info(\"Executing request: {}, headers: {}, entity: {}\", postRequest.getRequestLine(),\n           postRequest.getAllHeaders(), postRequest.getEntity());\n       return _httpClient.execute(postRequest);\n+    } catch (ConnectTimeoutException e) {\n+      LOG.error(\n+          \"Failed to perform customized health check due to ConnectTimeoutException for endpoint {}.\",\n+          url, e);\n+      throw e;", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0NTU3MQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427645571", "bodyText": "Removed the log and exception as it will be catched (IOException) by upper methods. Thanks.", "author": "alirezazamani", "createdAt": "2020-05-19T22:54:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIyNzczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIzMzY4NA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426233684", "bodyText": "This mock class implements the almost the same logic of the parent class. The cons are:\n\nduplicate code\ndifficult to maintain. if the parent class changes its logic, it is not easy to find this mock class and change this logic. If this child class is not changed, the test is actually testing the child class, not the logic in parent class.\n\nThere is a trick to avoid this duplicate and unnecessary mock class. We could use Java reflection to change the class's internal state, so the singleton would be re-initialized. And to be able to make the new instance use the new system property, the system property variable needs to be in a local one in get().\n// reset the singleton instance.\nField instance = Parent.class.getDeclaredField(\"INSTANCE\");\ninstance.setAccessible(true);\ninstance.set(null, null);", "author": "huizhilu", "createdAt": "2020-05-17T08:34:42Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/client/TestCustomRestClient.java", "diffHunk": "@@ -161,4 +179,35 @@ protected JsonNode getJsonObject(HttpResponse httpResponse) throws IOException {\n       return new ObjectMapper().readTree(_jsonResponse);\n     }\n   }\n+\n+  /**\n+   * This MockCustomRestClientFactory is necessary to have for testing because once an INSTANCE is\n+   * initialized in CustomRestClientFactory while running \"mvn test\" , it will no re-initialize the\n+   * INSTANCE with new HelixProperty. Hence this class makes sure that new CustomRestClient will be\n+   * created with the timeout set to the new value.\n+   */\n+  private static class MockCustomRestClientFactory extends CustomRestClientFactory {", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0NTY1Ng==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427645656", "bodyText": "Very good suggestion. Addressed. Thanks.", "author": "alirezazamani", "createdAt": "2020-05-19T22:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIzMzY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIzNDkyOQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426234929", "bodyText": "It seems we should also change this to make it volatile so it is safe for double lock checking. But we should do it in another PR. Reference: #1014", "author": "huizhilu", "createdAt": "2020-05-17T08:47:16Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/client/CustomRestClientFactory.java", "diffHunk": "@@ -32,10 +36,13 @@\n  */\n public class CustomRestClientFactory {\n   private static final Logger LOG = LoggerFactory.getLogger(CustomRestClientFactory.class);\n+  private static final int DEFAULT_HTTP_REQUEST_TIMEOUT = 60 * 1000;\n+  private static final int _httpRequestTimeout = HelixUtil.getSystemPropertyAsInt(\n+      SystemPropertyKeys.HTTP_REQUEST_TIMEOUT, DEFAULT_HTTP_REQUEST_TIMEOUT);\n \n   private static CustomRestClient INSTANCE = null;", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0NTg1NQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r427645855", "bodyText": "Yeah it can be in another PR. Thanks for mentioning it here.", "author": "alirezazamani", "createdAt": "2020-05-19T22:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIzNDkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI4NjA2NQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426286065", "bodyText": "This is unnecessary as the exception is thrown from post(). I suggest using try...catch so it is easier to know which code is tested. With expectedExceptions, it is not easy to know which line of code is expected to throw the exception as this method has multiple lines and API calls. If calling _customRestClient.getInstanceStoppableCheck, it is more like an integration test not a unit test. And as you state in the method name testPostRequestSmallTimeout, it is supposed to be testing the post(), right?", "author": "huizhilu", "createdAt": "2020-05-17T17:37:31Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/client/TestCustomRestClient.java", "diffHunk": "@@ -145,6 +150,19 @@ public void testPostRequestFormat() throws IOException {\n     Assert.assertEquals(json.get(\"data\").asText(), \"{}\");\n   }\n \n+  @Test(expectedExceptions = ConnectTimeoutException.class)\n+  public void testPostRequestSmallTimeout() throws IOException {\n+    // Set 1 ms to cause timeout for requests\n+    System.setProperty(SystemPropertyKeys.HTTP_REQUEST_TIMEOUT, \"1\");\n+    // a popular echo server that echos all the inputs\n+    final String echoServer = \"http://httpbin.org/post\";\n+    CustomRestClient _customRestClient = MockCustomRestClientFactory.get();\n+    _customRestClient.getInstanceStoppableCheck(echoServer, Collections.emptyMap());", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE1MzQ2Ng==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428153466", "bodyText": "Basically wanted to check getInstanceStoppableCheck. I will change the Test's name. And I will change it to try catch.", "author": "alirezazamani", "createdAt": "2020-05-20T16:37:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI4NjA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5MTE2MQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r426291161", "bodyText": "I don't think it is a good idea to connect to an external host/service for testing. What if my testing machine doesn't have network? Are we still going to get the expected exception? The answer is no. Instead, something else like UnknownHostException would be thrown. And this test does not achieve the purpose.\nIn a unit test, and in this case, I would not want to actually connect to a real REST server. Connecting to a real server is technically more an integration test. Though we have a local server started in AbstractTestClass, I would suggest mocking the timeout scenario for this unit test instead of connecting to a real server.", "author": "huizhilu", "createdAt": "2020-05-17T18:36:50Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/client/TestCustomRestClient.java", "diffHunk": "@@ -145,6 +150,19 @@ public void testPostRequestFormat() throws IOException {\n     Assert.assertEquals(json.get(\"data\").asText(), \"{}\");\n   }\n \n+  @Test(expectedExceptions = ConnectTimeoutException.class)\n+  public void testPostRequestSmallTimeout() throws IOException {\n+    // Set 1 ms to cause timeout for requests\n+    System.setProperty(SystemPropertyKeys.HTTP_REQUEST_TIMEOUT, \"1\");\n+    // a popular echo server that echos all the inputs\n+    final String echoServer = \"http://httpbin.org/post\";", "originalCommit": "0620c0ab0263d7ebb942d052aa2a3a32880e6c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5MDkxNw==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428290917", "bodyText": "I changed the real server. Now, I am using non-routable internal address which causes the ConnectTimeoutException for http requests.", "author": "alirezazamani", "createdAt": "2020-05-20T20:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5MTE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5ODYwNQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428298605", "bodyText": "I just realize that 127.0.0.0 gets timeout exception in mac only and not the Linux. So I changed it back to the external source for now. I added todo for this series of test to add mock rest server sometime in the future.", "author": "alirezazamani", "createdAt": "2020-05-20T20:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5MTE2MQ=="}], "type": "inlineReview"}, {"oid": "c4cf79206ced79a87f4c04890cd7fac6e59fcb4f", "url": "https://github.com/apache/helix/commit/c4cf79206ced79a87f4c04890cd7fac6e59fcb4f", "message": "Address the comments", "committedDate": "2020-05-20T20:29:39Z", "type": "commit"}, {"oid": "7ba2633e3dacc50b941cdc64632b5773ea054f13", "url": "https://github.com/apache/helix/commit/7ba2633e3dacc50b941cdc64632b5773ea054f13", "message": "change the server", "committedDate": "2020-05-20T20:45:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxNzQyOQ==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428317429", "bodyText": "Let's put this number to some constant file or at least to be a variable", "author": "junkaixue", "createdAt": "2020-05-20T21:28:17Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/client/CustomRestClientFactory.java", "diffHunk": "@@ -32,26 +37,32 @@\n  */\n public class CustomRestClientFactory {\n   private static final Logger LOG = LoggerFactory.getLogger(CustomRestClientFactory.class);\n-\n   private static CustomRestClient INSTANCE = null;\n \n-  private CustomRestClientFactory() {\n+  protected CustomRestClientFactory() {\n   }\n \n   public static CustomRestClient get() {\n     if (INSTANCE == null) {\n       synchronized (CustomRestClientFactory.class) {\n         if (INSTANCE == null) {\n           try {\n+            // Here int has been used for timeout value because setConnectTimeout,\n+            // setConnectionRequestTimeout and setSocketTimeout are getting int as input\n+            final int httpRequestTimeout =\n+                HelixUtil.getSystemPropertyAsInt(RestSystemPropertyKeys.HTTP_TIMEOUT_MS, 60 * 1000);", "originalCommit": "7ba2633e3dacc50b941cdc64632b5773ea054f13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzMTk3Nw==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428331977", "bodyText": "Sure. Moved to constant file.", "author": "alirezazamani", "createdAt": "2020-05-20T21:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxNzQyOQ=="}], "type": "inlineReview"}, {"oid": "a3c191f2224124ee4ee1ef34375c59ec6bf8ed68", "url": "https://github.com/apache/helix/commit/a3c191f2224124ee4ee1ef34375c59ec6bf8ed68", "message": "Move default to constant files", "committedDate": "2020-05-20T21:58:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTE1Ng==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428421156", "bodyText": "Why is this reset to a hard coded timeout? What if the timeout is changed, you setting it here 60000 would break the original value. The correct way should be to backup the original property and set it back here.", "author": "huizhilu", "createdAt": "2020-05-21T03:09:42Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/client/TestCustomRestClient.java", "diffHunk": "@@ -145,6 +148,35 @@ public void testPostRequestFormat() throws IOException {\n     Assert.assertEquals(json.get(\"data\").asText(), \"{}\");\n   }\n \n+  @Test\n+  public void testGetInstanceStoppableCheckSmallTimeout() throws Exception {\n+    // Reset the INSTANCE in CustomRestClientFactory to create new one with new TimeOut\n+    Field instance = CustomRestClientFactory.class.getDeclaredField(\"INSTANCE\");\n+    instance.setAccessible(true);\n+    instance.set(null, null);\n+\n+    // Set 1 ms to cause timeout for http requests\n+    System.setProperty(RestSystemPropertyKeys.HTTP_TIMEOUT_MS, \"1\");\n+    // a popular echo server that echos all the inputs\n+    // TODO: add a mock rest server\n+    final String echoServer = \"http://httpbin.org/post\";\n+    CustomRestClient _customRestClient = CustomRestClientFactory.get();\n+    boolean timeoutExceptionHappened = false;\n+    try {\n+      _customRestClient.getInstanceStoppableCheck(echoServer, Collections.emptyMap());\n+    } catch (ConnectTimeoutException e) {\n+      // Since the timeout is so small, we are expecting to get ConnectTimeoutException\n+      timeoutExceptionHappened = true;\n+    }\n+    // Reset the HTTP_REQUEST_TIMEOUT property back to the default value\n+    System.setProperty(RestSystemPropertyKeys.HTTP_TIMEOUT_MS, \"60000\");", "originalCommit": "a3c191f2224124ee4ee1ef34375c59ec6bf8ed68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMzQwOA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428423408", "bodyText": "Should use try finally to recover the state. Otherwise if this test throws exception before recovering, later tests may be failing.", "author": "huizhilu", "createdAt": "2020-05-21T03:19:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTE1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3Nzg0Mg==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428777842", "bodyText": "Removed this test.", "author": "alirezazamani", "createdAt": "2020-05-21T16:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTk2Ng==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428421966", "bodyText": "I am not sure if I am convinced by this. What if it is fast enough to complete the request in 1 ms? It may not happen, but theoretically it could. This is relying on possibility of timeout..", "author": "huizhilu", "createdAt": "2020-05-21T03:13:03Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/client/TestCustomRestClient.java", "diffHunk": "@@ -145,6 +148,35 @@ public void testPostRequestFormat() throws IOException {\n     Assert.assertEquals(json.get(\"data\").asText(), \"{}\");\n   }\n \n+  @Test\n+  public void testGetInstanceStoppableCheckSmallTimeout() throws Exception {\n+    // Reset the INSTANCE in CustomRestClientFactory to create new one with new TimeOut\n+    Field instance = CustomRestClientFactory.class.getDeclaredField(\"INSTANCE\");\n+    instance.setAccessible(true);\n+    instance.set(null, null);\n+\n+    // Set 1 ms to cause timeout for http requests\n+    System.setProperty(RestSystemPropertyKeys.HTTP_TIMEOUT_MS, \"1\");\n+    // a popular echo server that echos all the inputs\n+    // TODO: add a mock rest server\n+    final String echoServer = \"http://httpbin.org/post\";\n+    CustomRestClient _customRestClient = CustomRestClientFactory.get();\n+    boolean timeoutExceptionHappened = false;\n+    try {\n+      _customRestClient.getInstanceStoppableCheck(echoServer, Collections.emptyMap());\n+    } catch (ConnectTimeoutException e) {\n+      // Since the timeout is so small, we are expecting to get ConnectTimeoutException", "originalCommit": "a3c191f2224124ee4ee1ef34375c59ec6bf8ed68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3NzY1OA==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428777658", "bodyText": "Changed the test completely. It is using mock now.", "author": "alirezazamani", "createdAt": "2020-05-21T16:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMjU1Ng==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428422556", "bodyText": "Is this changed? Like I said in previous thread, The property name is too generic. If this is set, it indicates that all http in helix should be using the config. However this is not the case. Should be narrowed down to helix rest or even stoppable.", "author": "huizhilu", "createdAt": "2020-05-21T03:15:38Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/common/RestSystemPropertyKeys.java", "diffHunk": "@@ -0,0 +1,6 @@\n+package org.apache.helix.rest.common;\n+\n+public class RestSystemPropertyKeys {\n+  // System property for request timeout\n+  public static final String HTTP_TIMEOUT_MS = \"http.timeout.ms\";", "originalCommit": "a3c191f2224124ee4ee1ef34375c59ec6bf8ed68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3NzM5Nw==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428777397", "bodyText": "Changed it to REST_HTTP_TIMEOUT_MS.", "author": "alirezazamani", "createdAt": "2020-05-21T16:45:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMjU1Ng=="}], "type": "inlineReview"}, {"oid": "0cd4c668ffd0856cf5fe2501cd2ca14400eed5ce", "url": "https://github.com/apache/helix/commit/0cd4c668ffd0856cf5fe2501cd2ca14400eed5ce", "message": "Change the test to Mock", "committedDate": "2020-05-21T16:40:19Z", "type": "forcePushed"}, {"oid": "ebc976e15d62108f082b4a5f1c691cde19588fa1", "url": "https://github.com/apache/helix/commit/ebc976e15d62108f082b4a5f1c691cde19588fa1", "message": "Change the test to Mock", "committedDate": "2020-05-21T16:48:11Z", "type": "forcePushed"}, {"oid": "fb1a374dc1e9325f91b9741e7fc8afafb0993a20", "url": "https://github.com/apache/helix/commit/fb1a374dc1e9325f91b9741e7fc8afafb0993a20", "message": "Change the test to Mock", "committedDate": "2020-05-21T16:53:44Z", "type": "commit"}, {"oid": "fb1a374dc1e9325f91b9741e7fc8afafb0993a20", "url": "https://github.com/apache/helix/commit/fb1a374dc1e9325f91b9741e7fc8afafb0993a20", "message": "Change the test to Mock", "committedDate": "2020-05-21T16:53:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkyODEyMw==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428928123", "bodyText": "This mix of styling (snake_case and camelCase) isn't java style", "author": "huizhilu", "createdAt": "2020-05-21T21:33:13Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/client/TestCustomRestClient.java", "diffHunk": "@@ -145,6 +146,28 @@ public void testPostRequestFormat() throws IOException {\n     Assert.assertEquals(json.get(\"data\").asText(), \"{}\");\n   }\n \n+  @Test\n+  public void testGetPartitionStoppableCheck_when_timeout() throws IOException {", "originalCommit": "fb1a374dc1e9325f91b9741e7fc8afafb0993a20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzMTIyMw==", "url": "https://github.com/apache/helix/pull/1013#discussion_r428931223", "bodyText": "Please remove this unused import", "author": "huizhilu", "createdAt": "2020-05-21T21:39:39Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/client/CustomRestClientImpl.java", "diffHunk": "@@ -33,6 +33,7 @@\n import org.apache.http.client.ClientProtocolException;\n import org.apache.http.client.HttpClient;\n import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.conn.ConnectTimeoutException;", "originalCommit": "fb1a374dc1e9325f91b9741e7fc8afafb0993a20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bd36481b94edc103795001f7ec128bf743cd2991", "url": "https://github.com/apache/helix/commit/bd36481b94edc103795001f7ec128bf743cd2991", "message": "Final fixes", "committedDate": "2020-05-21T21:48:40Z", "type": "commit"}]}