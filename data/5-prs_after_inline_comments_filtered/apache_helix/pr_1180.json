{"pr_number": 1180, "pr_title": "Remove race condition in TestTaskSchedulingTwoCurrentStates", "pr_createdAt": "2020-07-27T22:08:55Z", "pr_url": "https://github.com/apache/helix/pull/1180", "timeline": [{"oid": "ce97a4bf15c4d518739b3a3a8637e7a7ec588f4d", "url": "https://github.com/apache/helix/commit/ce97a4bf15c4d518739b3a3a8637e7a7ec588f4d", "message": "Stabilize TestTaskSchedulingTwoCurrentStates\n\nIn this commit, TestTaskSchedulingTwoCurrentStates is stabulized by\ncreating SEMI-AUTO resource and update the preferenceList to avoid\nrace condition that happens when test and controller update the\npreferenceList at the same time.", "committedDate": "2020-07-27T16:26:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NjM2NA==", "url": "https://github.com/apache/helix/pull/1180#discussion_r461796364", "bodyText": "Is it possible the old way of using WorkflowGenerator.DEFAULT_TGT_DB would have conflict, if multiple test using the same \"WorkflowGenerator.DEFAULT_TGT_DB\"?", "author": "kaisun2000", "createdAt": "2020-07-28T18:46:41Z", "path": "helix-core/src/test/java/org/apache/helix/integration/task/TestTaskSchedulingTwoCurrentStates.java", "diffHunk": "@@ -65,7 +60,7 @@\n  * sent when there are two CurrentStates.\n  */\n public class TestTaskSchedulingTwoCurrentStates extends TaskTestBase {\n-  private static final String DATABASE = WorkflowGenerator.DEFAULT_TGT_DB;", "originalCommit": "ce97a4bf15c4d518739b3a3a8637e7a7ec588f4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5OTg5NA==", "url": "https://github.com/apache/helix/pull/1180#discussion_r461799894", "bodyText": "The main reason is that in before class method, \"TestDB\" is created as Full-Auto and in this test we are trying to change it to Semi-Auto which causes race condition between controller and test updating IdealState. So if want to have Semi-Auto resource, we need to create it separately (with different name) and leverage it in this test.", "author": "alirezazamani", "createdAt": "2020-07-28T18:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NjM2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwODgxNg==", "url": "https://github.com/apache/helix/pull/1180#discussion_r461808816", "bodyText": "I think the better way to fix it is not call super.beforeClass() in line 72/77. This way, we won't create the cluster/full auto etc and participant that we need to stop immediately.\nInstead, just creates cluster, controller and participant in this before test. What is your take?", "author": "kaisun2000", "createdAt": "2020-07-28T19:08:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NjM2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkxMzI3Nw==", "url": "https://github.com/apache/helix/pull/1180#discussion_r461913277", "bodyText": "Your point is somehow valid. But I still think this is better option because this way we are saving many duplicated code which will be hard to maintain and most of the code is written in the parent class. Instead of that, as what I proposed in this PR, we can separate the DATABASE name and create new one which includes this class name and will be unique. We have same behavior for most of the Task Framework related test and workflow names have been derived from class name. This way the tests is easier to maintain and more understandable.", "author": "alirezazamani", "createdAt": "2020-07-28T22:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NjM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgxMTgyNw==", "url": "https://github.com/apache/helix/pull/1180#discussion_r461811827", "bodyText": "Another thing is that for all the resources created in\n@BeforeClass\n  public void beforeClass() throws Exception {\n\nWe should tear them down. The participant threads, the controller thread should be stopped with syncStop. Maybe we should also clean up the cluster path etc in Zookeeper.", "author": "kaisun2000", "createdAt": "2020-07-28T19:14:24Z", "path": "helix-core/src/test/java/org/apache/helix/integration/task/TestTaskSchedulingTwoCurrentStates.java", "diffHunk": "@@ -65,7 +60,7 @@\n  * sent when there are two CurrentStates.\n  */\n public class TestTaskSchedulingTwoCurrentStates extends TaskTestBase {\n-  private static final String DATABASE = WorkflowGenerator.DEFAULT_TGT_DB;\n+  private static final String DATABASE = \"TestDB_\" + TestHelper.getTestClassName();", "originalCommit": "ce97a4bf15c4d518739b3a3a8637e7a7ec588f4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkxNDM4Mg==", "url": "https://github.com/apache/helix/pull/1180#discussion_r461914382", "bodyText": "Ok I added afterclass which basically calling super.afterclass and we are cleaning up the environment. Thanks for the feedback.", "author": "alirezazamani", "createdAt": "2020-07-28T22:03:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgxMTgyNw=="}], "type": "inlineReview"}, {"oid": "77125582ffb84053d7fd8ff7921876377292b262", "url": "https://github.com/apache/helix/commit/77125582ffb84053d7fd8ff7921876377292b262", "message": "Add afterClass", "committedDate": "2020-07-28T22:04:31Z", "type": "commit"}]}