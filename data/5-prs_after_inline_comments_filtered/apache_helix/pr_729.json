{"pr_number": 729, "pr_title": "Implement Helix API for updating customized state", "pr_createdAt": "2020-02-06T17:43:25Z", "pr_url": "https://github.com/apache/helix/pull/729", "timeline": [{"oid": "916b5c6a2136a9d4569d28ff42615453db3e0e5f", "url": "https://github.com/apache/helix/commit/916b5c6a2136a9d4569d28ff42615453db3e0e5f", "message": "Implement Helix API for updating customized state", "committedDate": "2020-02-06T19:29:14Z", "type": "forcePushed"}, {"oid": "737d708104997ce8eaa6e3d8686e76b20d845c31", "url": "https://github.com/apache/helix/commit/737d708104997ce8eaa6e3d8686e76b20d845c31", "message": "Implement Helix API for updating customized state", "committedDate": "2020-02-06T19:58:06Z", "type": "forcePushed"}, {"oid": "d16415b743f71e226a0a91bf79f2275d03165003", "url": "https://github.com/apache/helix/commit/d16415b743f71e226a0a91bf79f2275d03165003", "message": "Implement Helix API for updating customized state", "committedDate": "2020-02-06T20:23:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA1OTkzMw==", "url": "https://github.com/apache/helix/pull/729#discussion_r376059933", "bodyText": "You can use _record.getLongField(CustomizedStateProperty.CURRENT_STATE.name(), NON_EXIST), while NON_EXIST = -1L as variable", "author": "junkaixue", "createdAt": "2020-02-06T20:18:24Z", "path": "helix-core/src/main/java/org/apache/helix/model/CustomizedState.java", "diffHunk": "@@ -0,0 +1,156 @@\n+package org.apache.helix.model;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+import org.apache.helix.HelixProperty;\n+import org.apache.helix.ZNRecord;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * Customized states of partitions in a resource for an instance.\n+ */\n+public class CustomizedState extends HelixProperty {\n+  private static Logger LOG = LoggerFactory.getLogger(CustomizedState.class);\n+\n+  /**\n+   * Lookup keys for the customized state\n+   */\n+  public enum CustomizedStateProperty {\n+    PREVIOUS_STATE,\n+    CURRENT_STATE,\n+    START_TIME,\n+    END_TIME\n+  }\n+\n+  /**\n+   * Instantiate a customized state with a resource\n+   * @param resourceName name identifying the resource\n+   */\n+  public CustomizedState(String resourceName) {\n+    super(resourceName);\n+  }\n+\n+  /**\n+   * Instantiate a customized state with a pre-populated ZNRecord\n+   * @param record a ZNRecord corresponding to the customized state\n+   */\n+  public CustomizedState(ZNRecord record) {\n+    super(record);\n+  }\n+\n+  /**\n+   * Get the name of the resource\n+   * @return String resource identifier\n+   */\n+  public String getResourceName() {\n+    return _record.getId();\n+  }\n+\n+  /**\n+   * Get the partitions on this instance and the state that each partition is currently in.\n+   * @return (partition, state) pairs\n+   */\n+  public Map<String, String> getPartitionStateMap() {\n+    Map<String, String> map = new HashMap<String, String>();\n+    Map<String, Map<String, String>> mapFields = _record.getMapFields();\n+    for (String partitionName : mapFields.keySet()) {\n+      Map<String, String> tempMap = mapFields.get(partitionName);\n+      if (tempMap != null) {\n+        map.put(partitionName, tempMap.get(CustomizedStateProperty.CURRENT_STATE.name()));\n+      }\n+    }\n+    return map;\n+  }\n+\n+  /**\n+   * Get the state of a partition on this instance\n+   * @param partitionName the name of the partition\n+   * @return the state, or null if the partition is not present\n+   */\n+  public String getState(String partitionName) {\n+    return getProperty(partitionName, CustomizedStateProperty.CURRENT_STATE);\n+  }\n+\n+  public long getStartTime(String partitionName) {\n+    String startTime = getProperty(partitionName, CustomizedStateProperty.START_TIME);", "originalCommit": "737d708104997ce8eaa6e3d8686e76b20d845c31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA2Mjk3Mw==", "url": "https://github.com/apache/helix/pull/729#discussion_r376062973", "bodyText": "Same as following.", "author": "junkaixue", "createdAt": "2020-02-06T20:25:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA1OTkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA2MTg1OA==", "url": "https://github.com/apache/helix/pull/729#discussion_r376061858", "bodyText": "Better to have partitionStateMap with arguments CURRENTSTATE or PREVIOUS STATE. Will be flexible enough for future retrieving other states information.", "author": "junkaixue", "createdAt": "2020-02-06T20:22:36Z", "path": "helix-core/src/main/java/org/apache/helix/model/CustomizedState.java", "diffHunk": "@@ -0,0 +1,156 @@\n+package org.apache.helix.model;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+import org.apache.helix.HelixProperty;\n+import org.apache.helix.ZNRecord;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * Customized states of partitions in a resource for an instance.\n+ */\n+public class CustomizedState extends HelixProperty {\n+  private static Logger LOG = LoggerFactory.getLogger(CustomizedState.class);\n+\n+  /**\n+   * Lookup keys for the customized state\n+   */\n+  public enum CustomizedStateProperty {\n+    PREVIOUS_STATE,\n+    CURRENT_STATE,\n+    START_TIME,\n+    END_TIME\n+  }\n+\n+  /**\n+   * Instantiate a customized state with a resource\n+   * @param resourceName name identifying the resource\n+   */\n+  public CustomizedState(String resourceName) {\n+    super(resourceName);\n+  }\n+\n+  /**\n+   * Instantiate a customized state with a pre-populated ZNRecord\n+   * @param record a ZNRecord corresponding to the customized state\n+   */\n+  public CustomizedState(ZNRecord record) {\n+    super(record);\n+  }\n+\n+  /**\n+   * Get the name of the resource\n+   * @return String resource identifier\n+   */\n+  public String getResourceName() {\n+    return _record.getId();\n+  }\n+\n+  /**\n+   * Get the partitions on this instance and the state that each partition is currently in.\n+   * @return (partition, state) pairs\n+   */\n+  public Map<String, String> getPartitionStateMap() {", "originalCommit": "737d708104997ce8eaa6e3d8686e76b20d845c31", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA2Mjg1Ng==", "url": "https://github.com/apache/helix/pull/729#discussion_r376062856", "bodyText": "From code perspective, we need to check it. But when we push data to ZK, it is better to remove non-reported entries to save spaces.", "author": "junkaixue", "createdAt": "2020-02-06T20:24:52Z", "path": "helix-core/src/main/java/org/apache/helix/model/CustomizedState.java", "diffHunk": "@@ -0,0 +1,156 @@\n+package org.apache.helix.model;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+import org.apache.helix.HelixProperty;\n+import org.apache.helix.ZNRecord;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * Customized states of partitions in a resource for an instance.\n+ */\n+public class CustomizedState extends HelixProperty {\n+  private static Logger LOG = LoggerFactory.getLogger(CustomizedState.class);\n+\n+  /**\n+   * Lookup keys for the customized state\n+   */\n+  public enum CustomizedStateProperty {\n+    PREVIOUS_STATE,\n+    CURRENT_STATE,\n+    START_TIME,\n+    END_TIME\n+  }\n+\n+  /**\n+   * Instantiate a customized state with a resource\n+   * @param resourceName name identifying the resource\n+   */\n+  public CustomizedState(String resourceName) {\n+    super(resourceName);\n+  }\n+\n+  /**\n+   * Instantiate a customized state with a pre-populated ZNRecord\n+   * @param record a ZNRecord corresponding to the customized state\n+   */\n+  public CustomizedState(ZNRecord record) {\n+    super(record);\n+  }\n+\n+  /**\n+   * Get the name of the resource\n+   * @return String resource identifier\n+   */\n+  public String getResourceName() {\n+    return _record.getId();\n+  }\n+\n+  /**\n+   * Get the partitions on this instance and the state that each partition is currently in.\n+   * @return (partition, state) pairs\n+   */\n+  public Map<String, String> getPartitionStateMap() {\n+    Map<String, String> map = new HashMap<String, String>();\n+    Map<String, Map<String, String>> mapFields = _record.getMapFields();\n+    for (String partitionName : mapFields.keySet()) {\n+      Map<String, String> tempMap = mapFields.get(partitionName);\n+      if (tempMap != null) {", "originalCommit": "d16415b743f71e226a0a91bf79f2275d03165003", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA5NTQ1Ng==", "url": "https://github.com/apache/helix/pull/729#discussion_r376095456", "bodyText": "Yeah, this data is only used for validation, and will not be written to zk.", "author": "zhangmeng916", "createdAt": "2020-02-06T21:36:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA2Mjg1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY1NTU0OA==", "url": "https://github.com/apache/helix/pull/729#discussion_r376655548", "bodyText": "You probably don't need this since you build the path using instanceCustomizedState", "author": "mgao0", "createdAt": "2020-02-07T23:32:34Z", "path": "helix-core/src/main/java/org/apache/helix/PropertyPathBuilder.java", "diffHunk": "@@ -112,6 +115,12 @@\n         \"/{clusterName}/INSTANCES/{instanceName}/CURRENTSTATES/{sessionId}/{resourceName}\");\n     addEntry(PropertyType.CURRENTSTATES, 5,\n         \"/{clusterName}/INSTANCES/{instanceName}/CURRENTSTATES/{sessionId}/{resourceName}/{bucketName}\");\n+    addEntry(PropertyType.CUSTOMIZEDSTATES, 2,", "originalCommit": "4b653edaf7154e5ee0895082fa814e7ef24435f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgzMzc4Ng==", "url": "https://github.com/apache/helix/pull/729#discussion_r377833786", "bodyText": "Actually this one is not deprecated. It's used in initialization. If I remove this one, the path is not created.", "author": "zhangmeng916", "createdAt": "2020-02-11T18:58:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY1NTU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY1Nzc4MA==", "url": "https://github.com/apache/helix/pull/729#discussion_r376657780", "bodyText": "mapFields.putIfAbsent() should do the same thing but simpler", "author": "mgao0", "createdAt": "2020-02-07T23:42:57Z", "path": "helix-core/src/main/java/org/apache/helix/model/CustomizedState.java", "diffHunk": "@@ -0,0 +1,155 @@\n+package org.apache.helix.model;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+import org.apache.helix.HelixProperty;\n+import org.apache.helix.ZNRecord;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * Customized states of partitions in a resource for an instance.\n+ */\n+public class CustomizedState extends HelixProperty {\n+  private static Logger LOG = LoggerFactory.getLogger(CustomizedState.class);\n+  private static long NON_EXIST = -1L;\n+\n+  /**\n+   * Lookup keys for the customized state\n+   */\n+  public enum CustomizedStateProperty {\n+    PREVIOUS_STATE,\n+    CURRENT_STATE,\n+    START_TIME,\n+    END_TIME\n+  }\n+\n+  /**\n+   * Instantiate a customized state with a resource\n+   * @param resourceName name identifying the resource\n+   */\n+  public CustomizedState(String resourceName) {\n+    super(resourceName);\n+  }\n+\n+  /**\n+   * Instantiate a customized state with a pre-populated ZNRecord\n+   * @param record a ZNRecord corresponding to the customized state\n+   */\n+  public CustomizedState(ZNRecord record) {\n+    super(record);\n+  }\n+\n+  /**\n+   * Get the name of the resource\n+   * @return String resource identifier\n+   */\n+  public String getResourceName() {\n+    return _record.getId();\n+  }\n+\n+  /**\n+   * Get the partitions on this instance and the specified property that each partition is currently having.\n+   * @return (partition, property) pairs\n+   */\n+  public Map<String, String> getPartitionStateMap(CustomizedStateProperty property) {\n+    Map<String, String> map = new HashMap<String, String>();\n+    Map<String, Map<String, String>> mapFields = _record.getMapFields();\n+    for (String partitionName : mapFields.keySet()) {\n+      Map<String, String> tempMap = mapFields.get(partitionName);\n+      if (tempMap != null) {\n+        map.put(partitionName, tempMap.get(property.name()));\n+      }\n+    }\n+    return map;\n+  }\n+\n+  /**\n+   * Get the state of a partition on this instance\n+   * @param partitionName the name of the partition\n+   * @return the state, or null if the partition is not present\n+   */\n+  public String getState(String partitionName) {\n+    return getProperty(partitionName, CustomizedStateProperty.CURRENT_STATE);\n+  }\n+\n+  public long getStartTime(String partitionName) {\n+    return _record.getLongField(CustomizedStateProperty.START_TIME.name(), NON_EXIST);\n+  }\n+\n+  public long getEndTime(String partitionName) {\n+    return _record.getLongField(CustomizedStateProperty.END_TIME.name(), NON_EXIST);\n+  }\n+\n+  public String getPreviousState(String partitionName) {\n+    return getProperty(partitionName, CustomizedStateProperty.PREVIOUS_STATE);\n+  }\n+\n+  private String getProperty(String partitionName, CustomizedStateProperty property) {\n+    Map<String, String> mapField = _record.getMapField(partitionName);\n+    if (mapField != null) {\n+      return mapField.get(property.name());\n+    }\n+    return null;\n+  }\n+\n+  /**\n+   * Set the state that a partition is currently in on this instance\n+   * @param partitionName the name of the partition\n+   * @param state the state of the partition\n+   */\n+  public void setState(String partitionName, String state) {\n+    setProperty(partitionName, CustomizedStateProperty.CURRENT_STATE, state);\n+  }\n+\n+  public void setStartTime(String partitionName, long startTime) {\n+    setProperty(partitionName, CustomizedStateProperty.START_TIME, String.valueOf(startTime));\n+  }\n+\n+  public void setEndTime(String partitionName, long endTime) {\n+    setProperty(partitionName, CustomizedStateProperty.END_TIME, String.valueOf(endTime));\n+  }\n+\n+  public void setPreviousState(String partitionName, String state) {\n+    setProperty(partitionName, CustomizedStateProperty.PREVIOUS_STATE, state);\n+  }\n+\n+  private void setProperty(String partitionName, CustomizedStateProperty property, String value) {\n+    Map<String, Map<String, String>> mapFields = _record.getMapFields();\n+    if (mapFields.get(partitionName) == null) {", "originalCommit": "4b653edaf7154e5ee0895082fa814e7ef24435f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0MTIwOA==", "url": "https://github.com/apache/helix/pull/729#discussion_r377241208", "bodyText": "This will override other partition's data, right?  You need to read existing ZNRecord back, merge your changes and update to ZK.", "author": "lei-xia", "createdAt": "2020-02-10T18:34:14Z", "path": "helix-core/src/main/java/org/apache/helix/customizedstate/CustomizedStateProvider.java", "diffHunk": "@@ -0,0 +1,88 @@\n+package org.apache.helix.customizedstate;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.apache.helix.HelixDataAccessor;\n+import org.apache.helix.HelixException;\n+import org.apache.helix.HelixManager;\n+import org.apache.helix.PropertyKey;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.model.CustomizedState;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Class for Helix customers to operate on customized state\n+ */\n+public class CustomizedStateProvider {\n+  private static final Logger LOG = LoggerFactory.getLogger(CustomizedStateProvider.class);\n+  private final HelixManager _helixManager;\n+  String _instanceName;\n+\n+  public CustomizedStateProvider(HelixManager helixManager, String instanceName) {\n+    _helixManager = helixManager;\n+    _instanceName = instanceName;\n+  }\n+\n+  /**\n+   * Update the customized state based on the resource name and partition name\n+   */\n+  public synchronized void updateCustomizedState(String customizedStateName, String resourceName,\n+      String partitionName, Map<String, String> customizedState) {\n+    HelixDataAccessor accessor = _helixManager.getHelixDataAccessor();\n+    PropertyKey.Builder keyBuilder = accessor.keyBuilder();\n+    PropertyKey propertyKey =\n+        keyBuilder.customizedState(_instanceName, customizedStateName, resourceName);\n+    ZNRecord record = new ZNRecord(resourceName);\n+    Map<String, Map<String, String>> mapFields = new HashMap<>();\n+    mapFields.put(partitionName, customizedState);\n+    record.setMapFields(mapFields);", "originalCommit": "08d0b7f2c25e0b065f7604a84a172daa912f1266", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0MTcyMg==", "url": "https://github.com/apache/helix/pull/729#discussion_r377241722", "bodyText": "Also, if I have 5 fields in my customized state map, but here I will like just to update 1 of them, do I need to specified other 4 fields again in this map? Your implementation seems requiring so.", "author": "lei-xia", "createdAt": "2020-02-10T18:35:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0MTIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI1NjYxMw==", "url": "https://github.com/apache/helix/pull/729#discussion_r377256613", "bodyText": "Using update actually will not override other partition's data. I tested in the unit test. It will only override the same key's.\nFor the fields update, I was actually thinking about it. The implementation right now only support full update. I can add partial update. It's be useful if there're many fields that actually do not change.", "author": "zhangmeng916", "createdAt": "2020-02-10T19:03:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0MTIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2NjA0Ng==", "url": "https://github.com/apache/helix/pull/729#discussion_r379066046", "bodyText": "Remove else clause.", "author": "junkaixue", "createdAt": "2020-02-13T19:18:11Z", "path": "helix-core/src/main/java/org/apache/helix/customizedstate/CustomizedStateProviderFactory.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.apache.helix.customizedstate;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import org.apache.helix.HelixException;\n+import org.apache.helix.HelixManager;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Singleton factory that build customized state provider.\n+ */\n+public class CustomizedStateProviderFactory {\n+  private static Logger LOG = LoggerFactory.getLogger(CustomizedStateProvider.class);\n+  private final HashMap<String, CustomizedStateProvider> _customizedStateProviderMap =\n+      new HashMap<>();\n+  private HelixManager _helixManager;\n+\n+  protected CustomizedStateProviderFactory() {\n+  }\n+\n+  private static class SingletonHelper {\n+    private static final CustomizedStateProviderFactory INSTANCE =\n+        new CustomizedStateProviderFactory();\n+  }\n+\n+  public static CustomizedStateProviderFactory getInstance() {\n+    return SingletonHelper.INSTANCE;\n+  }\n+\n+  public CustomizedStateProvider buildCustomizedStateProvider(String instanceName) {\n+    if (_helixManager == null) {\n+      throw new HelixException(\"Helix Manager has not been set yet.\");\n+    } else {\n+      return buildCustomizedStateProvider(_helixManager, instanceName);\n+    }", "originalCommit": "7fb938800a2dc7cefdfbe32d0d35b2b5c7d5f043", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2NjIwOA==", "url": "https://github.com/apache/helix/pull/729#discussion_r379066208", "bodyText": "Same here. Remove else clause.", "author": "junkaixue", "createdAt": "2020-02-13T19:18:31Z", "path": "helix-core/src/main/java/org/apache/helix/customizedstate/CustomizedStateProviderFactory.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.apache.helix.customizedstate;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import org.apache.helix.HelixException;\n+import org.apache.helix.HelixManager;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Singleton factory that build customized state provider.\n+ */\n+public class CustomizedStateProviderFactory {\n+  private static Logger LOG = LoggerFactory.getLogger(CustomizedStateProvider.class);\n+  private final HashMap<String, CustomizedStateProvider> _customizedStateProviderMap =\n+      new HashMap<>();\n+  private HelixManager _helixManager;\n+\n+  protected CustomizedStateProviderFactory() {\n+  }\n+\n+  private static class SingletonHelper {\n+    private static final CustomizedStateProviderFactory INSTANCE =\n+        new CustomizedStateProviderFactory();\n+  }\n+\n+  public static CustomizedStateProviderFactory getInstance() {\n+    return SingletonHelper.INSTANCE;\n+  }\n+\n+  public CustomizedStateProvider buildCustomizedStateProvider(String instanceName) {\n+    if (_helixManager == null) {\n+      throw new HelixException(\"Helix Manager has not been set yet.\");\n+    } else {\n+      return buildCustomizedStateProvider(_helixManager, instanceName);\n+    }\n+  }\n+\n+  /**\n+   * Build a customized state provider based on the specified input. If the instance already has a\n+   * provider, return it. Otherwise, build a new one and put it in the map.\n+   * @param helixManager The helix manager that belongs to the instance\n+   * @param instanceName The name of the instance\n+   * @return CustomizedStateProvider\n+   */\n+  public CustomizedStateProvider buildCustomizedStateProvider(HelixManager helixManager,\n+      String instanceName) {\n+    synchronized (_customizedStateProviderMap) {\n+      if (_customizedStateProviderMap.get(instanceName) != null) {\n+        return _customizedStateProviderMap.get(instanceName);\n+      } else {", "originalCommit": "7fb938800a2dc7cefdfbe32d0d35b2b5c7d5f043", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f3291cb42d624085ac989603dba05965d30f6bb5", "url": "https://github.com/apache/helix/commit/f3291cb42d624085ac989603dba05965d30f6bb5", "message": "Implement Helix API for updating customized state", "committedDate": "2020-02-24T21:50:14Z", "type": "commit"}, {"oid": "bc8c877fbf6e6c47029ae48cea6554bee42918b5", "url": "https://github.com/apache/helix/commit/bc8c877fbf6e6c47029ae48cea6554bee42918b5", "message": "fix comment", "committedDate": "2020-02-24T21:50:14Z", "type": "commit"}, {"oid": "499ffe499facaa2279767b9f9dd1384a0a78c2b4", "url": "https://github.com/apache/helix/commit/499ffe499facaa2279767b9f9dd1384a0a78c2b4", "message": "add Helix customized state provider factory", "committedDate": "2020-02-24T21:50:14Z", "type": "commit"}, {"oid": "55c6b9bc6eda3f6804ae10e8442a762b480a7013", "url": "https://github.com/apache/helix/commit/55c6b9bc6eda3f6804ae10e8442a762b480a7013", "message": "fix comment", "committedDate": "2020-02-24T21:50:14Z", "type": "commit"}, {"oid": "506aef2d07bcaa2d9d30a258f5ce06084b487a3c", "url": "https://github.com/apache/helix/commit/506aef2d07bcaa2d9d30a258f5ce06084b487a3c", "message": "add delete operation", "committedDate": "2020-02-24T21:50:14Z", "type": "commit"}, {"oid": "fd1a7f0cc9ba08052276ceee3ca91baf2c7b0e46", "url": "https://github.com/apache/helix/commit/fd1a7f0cc9ba08052276ceee3ca91baf2c7b0e46", "message": "add partial update", "committedDate": "2020-02-24T21:50:14Z", "type": "commit"}, {"oid": "df40d429c1bc4663903f7d204c3175ff47d5b0e8", "url": "https://github.com/apache/helix/commit/df40d429c1bc4663903f7d204c3175ff47d5b0e8", "message": "add one more function", "committedDate": "2020-02-24T21:50:14Z", "type": "commit"}, {"oid": "df40d429c1bc4663903f7d204c3175ff47d5b0e8", "url": "https://github.com/apache/helix/commit/df40d429c1bc4663903f7d204c3175ff47d5b0e8", "message": "add one more function", "committedDate": "2020-02-24T21:50:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAzMjU3Nw==", "url": "https://github.com/apache/helix/pull/729#discussion_r384032577", "bodyText": "You set start time and end time into map fields, but this getLongField gets information from simple fields right?", "author": "mgao0", "createdAt": "2020-02-25T18:02:52Z", "path": "helix-core/src/main/java/org/apache/helix/model/CustomizedState.java", "diffHunk": "@@ -0,0 +1,153 @@\n+package org.apache.helix.model;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+import org.apache.helix.HelixProperty;\n+import org.apache.helix.ZNRecord;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * Customized states of partitions in a resource for an instance.\n+ */\n+public class CustomizedState extends HelixProperty {\n+  private static Logger LOG = LoggerFactory.getLogger(CustomizedState.class);\n+  private static long NON_EXIST = -1L;\n+\n+  /**\n+   * Lookup keys for the customized state\n+   */\n+  public enum CustomizedStateProperty {\n+    PREVIOUS_STATE,\n+    CURRENT_STATE,\n+    START_TIME,\n+    END_TIME\n+  }\n+\n+  /**\n+   * Instantiate a customized state with a resource\n+   * @param resourceName name identifying the resource\n+   */\n+  public CustomizedState(String resourceName) {\n+    super(resourceName);\n+  }\n+\n+  /**\n+   * Instantiate a customized state with a pre-populated ZNRecord\n+   * @param record a ZNRecord corresponding to the customized state\n+   */\n+  public CustomizedState(ZNRecord record) {\n+    super(record);\n+  }\n+\n+  /**\n+   * Get the name of the resource\n+   * @return String resource identifier\n+   */\n+  public String getResourceName() {\n+    return _record.getId();\n+  }\n+\n+  /**\n+   * Get the partitions on this instance and the specified property that each partition is currently having.\n+   * @return (partition, property) pairs\n+   */\n+  public Map<String, String> getPartitionStateMap(CustomizedStateProperty property) {\n+    Map<String, String> map = new HashMap<String, String>();\n+    Map<String, Map<String, String>> mapFields = _record.getMapFields();\n+    for (String partitionName : mapFields.keySet()) {\n+      Map<String, String> tempMap = mapFields.get(partitionName);\n+      if (tempMap != null) {\n+        map.put(partitionName, tempMap.get(property.name()));\n+      }\n+    }\n+    return map;\n+  }\n+\n+  /**\n+   * Get the state of a partition on this instance\n+   * @param partitionName the name of the partition\n+   * @return the state, or null if the partition is not present\n+   */\n+  public String getState(String partitionName) {\n+    return getProperty(partitionName, CustomizedStateProperty.CURRENT_STATE);\n+  }\n+\n+  public long getStartTime(String partitionName) {", "originalCommit": "df40d429c1bc4663903f7d204c3175ff47d5b0e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3MTc5MA==", "url": "https://github.com/apache/helix/pull/729#discussion_r384071790", "bodyText": "Good catch. I accidentally changed this to be wrong during a previous cleanup. Updated.", "author": "zhangmeng916", "createdAt": "2020-02-25T19:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAzMjU3Nw=="}], "type": "inlineReview"}, {"oid": "6d6079c21a471a282ee3e724a7083f09b9947a91", "url": "https://github.com/apache/helix/commit/6d6079c21a471a282ee3e724a7083f09b9947a91", "message": "fix", "committedDate": "2020-02-25T19:17:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE0OTI1Mg==", "url": "https://github.com/apache/helix/pull/729#discussion_r384149252", "bodyText": "Are we sure this is required path? That's not a good idea to add this. If we add this and existing product uses Helix library for participant will have check failure since Instance is already created.", "author": "junkaixue", "createdAt": "2020-02-25T21:53:48Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKUtil.java", "diffHunk": "@@ -139,6 +139,7 @@ public static boolean isInstanceSetup(HelixZkClient zkclient, String clusterName\n       requiredPaths.add(PropertyPathBuilder.instanceConfig(clusterName, instanceName));\n       requiredPaths.add(PropertyPathBuilder.instanceMessage(clusterName, instanceName));\n       requiredPaths.add(PropertyPathBuilder.instanceCurrentState(clusterName, instanceName));\n+      requiredPaths.add(PropertyPathBuilder.instanceCustomizedState(clusterName, instanceName));", "originalCommit": "6d6079c21a471a282ee3e724a7083f09b9947a91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE4NTY1NA==", "url": "https://github.com/apache/helix/pull/729#discussion_r384185654", "bodyText": "nit: remove one of the dots in \". . \"", "author": "alirezazamani", "createdAt": "2020-02-25T23:17:57Z", "path": "helix-core/src/main/java/org/apache/helix/customizedstate/CustomizedStateProvider.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package org.apache.helix.customizedstate;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.I0Itec.zkclient.DataUpdater;\n+import org.apache.helix.HelixDataAccessor;\n+import org.apache.helix.HelixException;\n+import org.apache.helix.HelixManager;\n+import org.apache.helix.PropertyKey;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.model.CustomizedState;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Class for Helix customers to operate on customized state\n+ */\n+public class CustomizedStateProvider {\n+  private static final Logger LOG = LoggerFactory.getLogger(CustomizedStateProvider.class);\n+  private final HelixManager _helixManager;\n+  private final HelixDataAccessor _helixDataAccessor;\n+  private String _instanceName;\n+\n+  public CustomizedStateProvider(HelixManager helixManager, String instanceName) {\n+    _helixManager = helixManager;\n+    _instanceName = instanceName;\n+    _helixDataAccessor = _helixManager.getHelixDataAccessor();\n+  }\n+\n+  /**\n+   * Update a specific customized state based on the resource name and partition name. The\n+   * customized state is input as a single string\n+   */\n+  public synchronized void updateCustomizedState(String customizedStateName, String resourceName,\n+      String partitionName, String customizedState) {\n+    Map<String, String> customizedStateMap = new HashMap<>();\n+    customizedStateMap.put(CustomizedState.CustomizedStateProperty.CURRENT_STATE.name(), customizedState);\n+    updateCustomizedState(customizedStateName, resourceName, partitionName, customizedStateMap);\n+  }\n+\n+  /**\n+   * Update a specific customized state based on the resource name and partition name. . The", "originalCommit": "6d6079c21a471a282ee3e724a7083f09b9947a91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3ff5f71d8e2a4cb527f8f952852080a805cefc03", "url": "https://github.com/apache/helix/commit/3ff5f71d8e2a4cb527f8f952852080a805cefc03", "message": "remove customized state from required path", "committedDate": "2020-02-26T00:52:46Z", "type": "commit"}, {"oid": "cfdaaa2288f700d879b0fe50e726c4f9a7625fbb", "url": "https://github.com/apache/helix/commit/cfdaaa2288f700d879b0fe50e726c4f9a7625fbb", "message": "minor fix", "committedDate": "2020-02-26T00:54:11Z", "type": "commit"}]}