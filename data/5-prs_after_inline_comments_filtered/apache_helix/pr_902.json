{"pr_number": 902, "pr_title": "Fix setRoutingData boolean handling; fix leader forwarding url construction", "pr_createdAt": "2020-03-18T00:55:53Z", "pr_url": "https://github.com/apache/helix/pull/902", "timeline": [{"oid": "1a06c046bc5c52c1c109bd76a9c5256c9394fed6", "url": "https://github.com/apache/helix/commit/1a06c046bc5c52c1c109bd76a9c5256c9394fed6", "message": "Bug fixees", "committedDate": "2020-03-17T23:00:51Z", "type": "commit"}, {"oid": "6a8cce482598020222e685a87a5bb71bb232d5fa", "url": "https://github.com/apache/helix/commit/6a8cce482598020222e685a87a5bb71bb232d5fa", "message": "Modify the way url prefixes work", "committedDate": "2020-03-18T00:35:32Z", "type": "commit"}, {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f", "url": "https://github.com/apache/helix/commit/605d2a8e365c5a683efb5e4ef6a90b3f04cf408f", "message": "Work with the new port keys", "committedDate": "2020-03-18T00:43:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1MjAyNg==", "url": "https://github.com/apache/helix/pull/902#discussion_r394052026", "bodyText": "http://webreference.com/html/tutorial2/2.html\nUsually port is an optional concept in a URL. Let's not throw an exception. If it's null or empty, we simply don't append it.", "author": "narendly", "createdAt": "2020-03-18T00:59:14Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataWriter.java", "diffHunk": "@@ -87,16 +87,18 @@ public ZkRoutingDataWriter(String namespace, String zkAddress) {\n \n     // Get the hostname (REST endpoint) from System property\n     String hostName = System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY);\n+    String port = System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_PORT_KEY);\n     if (hostName == null || hostName.isEmpty()) {\n       throw new IllegalStateException(\n-          \"Unable to get the hostname of this server instance. System.getProperty fails to fetch \"\n+          \"Unable to get the hostname of this server instance or the hostname is empty. System.getProperty fails to fetch \"\n               + MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY + \".\");\n     }\n-    // remove trailing slash\n-    if (hostName.charAt(hostName.length() - 1) == '/') {\n-      hostName = hostName.substring(0, hostName.length() - 1);\n+    if (port == null || port.isEmpty()) {\n+      throw new IllegalStateException(\n+          \"Unable to get the port of this server instance or the port is empty. System.getProperty fails to fetch \"\n+              + MetadataStoreRoutingConstants.MSDS_SERVER_PORT_KEY + \".\");", "originalCommit": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTMzOQ==", "url": "https://github.com/apache/helix/pull/902#discussion_r394055339", "bodyText": "Resolved offline.", "author": "NealSun96", "createdAt": "2020-03-18T01:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1MjAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NDM0MA==", "url": "https://github.com/apache/helix/pull/902#discussion_r394054340", "bodyText": "Using a vanilla hostname would be enough here. Let's create a ZNRecord with two simple fields added: hostname and port?", "author": "narendly", "createdAt": "2020-03-18T01:09:14Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataWriter.java", "diffHunk": "@@ -87,16 +87,18 @@ public ZkRoutingDataWriter(String namespace, String zkAddress) {\n \n     // Get the hostname (REST endpoint) from System property\n     String hostName = System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY);\n+    String port = System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_PORT_KEY);\n     if (hostName == null || hostName.isEmpty()) {\n       throw new IllegalStateException(\n-          \"Unable to get the hostname of this server instance. System.getProperty fails to fetch \"\n+          \"Unable to get the hostname of this server instance or the hostname is empty. System.getProperty fails to fetch \"\n               + MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY + \".\");\n     }\n-    // remove trailing slash\n-    if (hostName.charAt(hostName.length() - 1) == '/') {\n-      hostName = hostName.substring(0, hostName.length() - 1);\n+    if (port == null || port.isEmpty()) {\n+      throw new IllegalStateException(\n+          \"Unable to get the port of this server instance or the port is empty. System.getProperty fails to fetch \"\n+              + MetadataStoreRoutingConstants.MSDS_SERVER_PORT_KEY + \".\");\n     }\n-    _myHostName = HttpConstants.HTTP_PROTOCOL_PREFIX + hostName;\n+    _myHostName = HttpConstants.HTTP_PROTOCOL_PREFIX + hostName + \":\" + port;\n     ZNRecord myServerInfo = new ZNRecord(_myHostName);", "originalCommit": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA3MjM3MA==", "url": "https://github.com/apache/helix/pull/902#discussion_r394072370", "bodyText": "updated with a znode with 3 fields, as we discussed.", "author": "NealSun96", "createdAt": "2020-03-18T02:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NDM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTI4Ng==", "url": "https://github.com/apache/helix/pull/902#discussion_r394055286", "bodyText": "Add some JavaDoc explaining what you're doing with examples please? This is one of the things that when you look back at it 6 months from now, you'll have to do some digging around to understand what youre doing. Having a comment with an example would help :)", "author": "narendly", "createdAt": "2020-03-18T01:13:19Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataWriter.java", "diffHunk": "@@ -344,6 +346,11 @@ protected boolean deleteZkShardingKey(String realm, String shardingKey) {\n   private String constructUrlSuffix(String... urlParams) {\n     List<String> allUrlParameters = new ArrayList<>(\n         Arrays.asList(MetadataStoreRoutingConstants.MSDS_NAMESPACES_URL_PREFIX, \"/\", _namespace));\n+    String contextUrlPrefix =\n+        System.getProperty(MetadataStoreRoutingConstants.MSDS_CONTEXT_URL_PREFIX_KEY);\n+    if (contextUrlPrefix != null && !contextUrlPrefix.isEmpty()) {\n+      allUrlParameters.add(0, contextUrlPrefix);\n+    }", "originalCommit": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTQ2Nw==", "url": "https://github.com/apache/helix/pull/902#discussion_r394055467", "bodyText": "Sure thing.", "author": "NealSun96", "createdAt": "2020-03-18T01:14:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTM5NQ==", "url": "https://github.com/apache/helix/pull/902#discussion_r394055395", "bodyText": "Why was this change needed?", "author": "narendly", "createdAt": "2020-03-18T01:13:47Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/metadatastore/MetadataStoreDirectoryAccessor.java", "diffHunk": "@@ -235,7 +235,9 @@ public Response setRoutingData(String jsonContent) {\n       Map<String, List<String>> routingData =\n           OBJECT_MAPPER.readValue(jsonContent, new TypeReference<HashMap<String, List<String>>>() {\n           });\n-      _metadataStoreDirectory.setNamespaceRoutingData(_namespace, routingData);\n+      if (!_metadataStoreDirectory.setNamespaceRoutingData(_namespace, routingData)) {\n+        return serverError();\n+      }", "originalCommit": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTU1NQ==", "url": "https://github.com/apache/helix/pull/902#discussion_r394055555", "bodyText": "One of the issues I found out: SetRoutingData does not respect the return value of the underlying function.", "author": "NealSun96", "createdAt": "2020-03-18T01:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTU3Mw==", "url": "https://github.com/apache/helix/pull/902#discussion_r394055573", "bodyText": "Do these not need to be cleared after the test?", "author": "narendly", "createdAt": "2020-03-18T01:14:36Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestMSDAccessorLeaderElection.java", "diffHunk": "@@ -99,7 +99,9 @@ public void beforeClass() throws Exception {\n \n     // Set the new uri to be used in leader election\n     System.setProperty(MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY,\n-        getBaseUri().getHost() + \":\" + newPort);\n+        getBaseUri().getHost());\n+    System\n+        .setProperty(MetadataStoreRoutingConstants.MSDS_SERVER_PORT_KEY, Integer.toString(newPort));", "originalCommit": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NjU4NQ==", "url": "https://github.com/apache/helix/pull/902#discussion_r394056585", "bodyText": "Nope, the test base it extends clears up the system properties. These 2 lines are overwriting the old properties set by the test base, and the test base cleans up after itself.", "author": "NealSun96", "createdAt": "2020-03-18T01:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTU3Mw=="}], "type": "inlineReview"}, {"oid": "1c06980a9a9fcadbedd4162724bf0d2e6bda7056", "url": "https://github.com/apache/helix/commit/1c06980a9a9fcadbedd4162724bf0d2e6bda7056", "message": "LeaderElection node contains more info", "committedDate": "2020-03-18T01:53:52Z", "type": "commit"}, {"oid": "50c7601d1f8cf34d355bb5152f11d3eb577afbe9", "url": "https://github.com/apache/helix/commit/50c7601d1f8cf34d355bb5152f11d3eb577afbe9", "message": "Signature modify", "committedDate": "2020-03-18T02:08:45Z", "type": "commit"}, {"oid": "70018701baddb1f8088f7bbd2705845261d37769", "url": "https://github.com/apache/helix/commit/70018701baddb1f8088f7bbd2705845261d37769", "message": "Fix related test case", "committedDate": "2020-03-18T02:21:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExODA5Mg==", "url": "https://github.com/apache/helix/pull/902#discussion_r394118092", "bodyText": "Why is leader's host name removed? This was very useful information in debugging.", "author": "narendly", "createdAt": "2020-03-18T05:47:09Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataWriter.java", "diffHunk": "@@ -391,8 +422,8 @@ protected boolean sendRequestToLeader(HttpUriRequest request, int expectedRespon\n       }\n     } catch (IOException e) {\n       LOG.error(\n-          \"The forwarded request to leader raised an exception. Uri: {} Current hostname: {} Leader hostname: {}\",\n-          request.getURI(), _myHostName, leaderHostName, e);\n+          \"The forwarded request to leader raised an exception. Uri: {} Current hostname: {} \",\n+          request.getURI(), _myHostName, e);", "originalCommit": "70018701baddb1f8088f7bbd2705845261d37769", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ1MTE2MA==", "url": "https://github.com/apache/helix/pull/902#discussion_r394451160", "bodyText": "Because the leader endpoint is already included in request.getURI(). Logging an extra copy is redundant.", "author": "NealSun96", "createdAt": "2020-03-18T15:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExODA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExODUyMg==", "url": "https://github.com/apache/helix/pull/902#discussion_r394118522", "bodyText": "\"Host name is not set or is empty\" would be better.", "author": "narendly", "createdAt": "2020-03-18T05:48:44Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataWriter.java", "diffHunk": "@@ -89,15 +94,27 @@ public ZkRoutingDataWriter(String namespace, String zkAddress) {\n     String hostName = System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY);\n     if (hostName == null || hostName.isEmpty()) {\n       throw new IllegalStateException(\n-          \"Unable to get the hostname of this server instance. System.getProperty fails to fetch \"\n+          \"Unable to get the hostname of this server instance or the hostname is empty. System.getProperty fails to fetch \"", "originalCommit": "70018701baddb1f8088f7bbd2705845261d37769", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ1MTQ3MQ==", "url": "https://github.com/apache/helix/pull/902#discussion_r394451471", "bodyText": "Ok.", "author": "NealSun96", "createdAt": "2020-03-18T15:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExODUyMg=="}], "type": "inlineReview"}, {"oid": "66e9ec316577688b7ae06c29e9f30d51662b6c3f", "url": "https://github.com/apache/helix/commit/66e9ec316577688b7ae06c29e9f30d51662b6c3f", "message": "Exception message nit", "committedDate": "2020-03-18T15:53:07Z", "type": "commit"}]}