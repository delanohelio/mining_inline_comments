{"pr_number": 705, "pr_title": "Add workflow context garbage collection ", "pr_createdAt": "2020-01-24T00:03:17Z", "pr_url": "https://github.com/apache/helix/pull/705", "timeline": [{"oid": "034cdaf551f316716019d17aa2f1bf7e3a8c6280", "url": "https://github.com/apache/helix/commit/034cdaf551f316716019d17aa2f1bf7e3a8c6280", "message": "The workflow garbage collection is added\n\nThe workflow garbage collection is added which scans all the workflow context,\nand delete them if workflow config does not exists.\nTest is added which checks the functionality of workflow garbage collection.", "committedDate": "2020-01-24T00:05:05Z", "type": "forcePushed"}, {"oid": "6ae41a96394af3ef6213d7d64727f44b434a5639", "url": "https://github.com/apache/helix/commit/6ae41a96394af3ef6213d7d64727f44b434a5639", "message": "The workflow garbage collection is added\n\nThe workflow garbage collection is added which scans all the workflow context,\nand delete them if workflow config does not exists.\nTest is added which checks the functionality of workflow garbage collection.", "committedDate": "2020-01-24T00:33:54Z", "type": "commit"}, {"oid": "6ae41a96394af3ef6213d7d64727f44b434a5639", "url": "https://github.com/apache/helix/commit/6ae41a96394af3ef6213d7d64727f44b434a5639", "message": "The workflow garbage collection is added\n\nThe workflow garbage collection is added which scans all the workflow context,\nand delete them if workflow config does not exists.\nTest is added which checks the functionality of workflow garbage collection.", "committedDate": "2020-01-24T00:33:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTM1MA==", "url": "https://github.com/apache/helix/pull/705#discussion_r370501350", "bodyText": "existed -> existing", "author": "narendly", "createdAt": "2020-01-24T07:28:04Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1036,6 +1037,46 @@ public static void purgeExpiredJobs(String workflow, WorkflowConfig workflowConf\n     setNextJobPurgeTime(workflow, currentTime, purgeInterval, rebalanceScheduler, manager);\n   }\n \n+  /**\n+   * The function that loops through the all existed workflow contexts and removes IdealState and", "originalCommit": "6ae41a96394af3ef6213d7d64727f44b434a5639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2Mzg5Ng==", "url": "https://github.com/apache/helix/pull/705#discussion_r371063896", "bodyText": "Fixed.", "author": "alirezazamani", "createdAt": "2020-01-27T04:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTM4MQ==", "url": "https://github.com/apache/helix/pull/705#discussion_r370501381", "bodyText": "\"workflow context of the workflow whose workflow config does not exist\"", "author": "narendly", "createdAt": "2020-01-24T07:28:12Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1036,6 +1037,46 @@ public static void purgeExpiredJobs(String workflow, WorkflowConfig workflowConf\n     setNextJobPurgeTime(workflow, currentTime, purgeInterval, rebalanceScheduler, manager);\n   }\n \n+  /**\n+   * The function that loops through the all existed workflow contexts and removes IdealState and\n+   * Workflow Context if Workflow Config is missing.", "originalCommit": "6ae41a96394af3ef6213d7d64727f44b434a5639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2Mzk2Mg==", "url": "https://github.com/apache/helix/pull/705#discussion_r371063962", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-01-27T04:51:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQyNA==", "url": "https://github.com/apache/helix/pull/705#discussion_r370501424", "bodyText": "Here we are doing a loop based on workflow contexts. Could there be cases where IdealStates exist but contexts/configs do not?", "author": "narendly", "createdAt": "2020-01-24T07:28:21Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1036,6 +1037,46 @@ public static void purgeExpiredJobs(String workflow, WorkflowConfig workflowConf\n     setNextJobPurgeTime(workflow, currentTime, purgeInterval, rebalanceScheduler, manager);\n   }\n \n+  /**\n+   * The function that loops through the all existed workflow contexts and removes IdealState and\n+   * Workflow Context if Workflow Config is missing.\n+   * @param dataProvider\n+   * @param manager\n+   */\n+  public static void workflowGarbageCollection(WorkflowControllerDataProvider dataProvider,", "originalCommit": "6ae41a96394af3ef6213d7d64727f44b434a5639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2NDcwMQ==", "url": "https://github.com/apache/helix/pull/705#discussion_r371064701", "bodyText": "Since controller attempts to delete the workflow context after the successful deletion of the workflow config and IdealState, there is no need to consider cases where IS existed without contexts/configs.", "author": "alirezazamani", "createdAt": "2020-01-27T04:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4MjMzNw==", "url": "https://github.com/apache/helix/pull/705#discussion_r373682337", "bodyText": "How could be sure that both WorkflowConfig and IS were deleted successfully? Is it possible that only config was removed and IS didn't get removed?", "author": "narendly", "createdAt": "2020-01-31T20:58:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMjM3OQ==", "url": "https://github.com/apache/helix/pull/705#discussion_r373732379", "bodyText": "Let's consider two scenarios:\n\n\nCase 1 where workflow config has been deleted but workflow context and IS have not been removed. In this case this PR addresses this scenario and deletes both of them. Note that in this PR context won't be removed unless IS is removed. If IS has not been successfully removed, we will try to delete it again in next pipeline.\n\n\nCase 2 where workflow config and context have been removed and IS has not been removed. I am arguing that this is not possible since context is always the last one that controller removes.", "author": "alirezazamani", "createdAt": "2020-01-31T23:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQ2NA==", "url": "https://github.com/apache/helix/pull/705#discussion_r370501464", "bodyText": "is existed -> exists", "author": "narendly", "createdAt": "2020-01-24T07:28:30Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1036,6 +1037,46 @@ public static void purgeExpiredJobs(String workflow, WorkflowConfig workflowConf\n     setNextJobPurgeTime(workflow, currentTime, purgeInterval, rebalanceScheduler, manager);\n   }\n \n+  /**\n+   * The function that loops through the all existed workflow contexts and removes IdealState and\n+   * Workflow Context if Workflow Config is missing.\n+   * @param dataProvider\n+   * @param manager\n+   */\n+  public static void workflowGarbageCollection(WorkflowControllerDataProvider dataProvider,\n+      final HelixManager manager) {\n+    // Garbage collections for conditions where workflow context is existed but config is missing.", "originalCommit": "6ae41a96394af3ef6213d7d64727f44b434a5639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2NDgyNA==", "url": "https://github.com/apache/helix/pull/705#discussion_r371064824", "bodyText": "fixed.", "author": "alirezazamani", "createdAt": "2020-01-27T04:59:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQ5OQ==", "url": "https://github.com/apache/helix/pull/705#discussion_r370501499", "bodyText": "When you do this, you'd want to take a snapshot of the entries because this might cause a ConcurrentModificationException.", "author": "narendly", "createdAt": "2020-01-24T07:28:38Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1036,6 +1037,46 @@ public static void purgeExpiredJobs(String workflow, WorkflowConfig workflowConf\n     setNextJobPurgeTime(workflow, currentTime, purgeInterval, rebalanceScheduler, manager);\n   }\n \n+  /**\n+   * The function that loops through the all existed workflow contexts and removes IdealState and\n+   * Workflow Context if Workflow Config is missing.\n+   * @param dataProvider\n+   * @param manager\n+   */\n+  public static void workflowGarbageCollection(WorkflowControllerDataProvider dataProvider,\n+      final HelixManager manager) {\n+    // Garbage collections for conditions where workflow context is existed but config is missing.\n+    Map<String, ZNRecord> contexts = dataProvider.getContexts();\n+    for (Map.Entry<String, ZNRecord> entry : contexts.entrySet()) {", "originalCommit": "6ae41a96394af3ef6213d7d64727f44b434a5639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2NDkzNQ==", "url": "https://github.com/apache/helix/pull/705#discussion_r371064935", "bodyText": "Very good point. Fixed. Thanks.", "author": "alirezazamani", "createdAt": "2020-01-27T04:59:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQ5OQ=="}], "type": "inlineReview"}, {"oid": "d46f0f326a4970c3d2ec985b5aa0f99d9a1bdcc8", "url": "https://github.com/apache/helix/commit/d46f0f326a4970c3d2ec985b5aa0f99d9a1bdcc8", "message": "Address reviewer comments", "committedDate": "2020-01-25T03:11:19Z", "type": "commit"}]}