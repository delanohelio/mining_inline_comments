{"pr_number": 917, "pr_title": "minor fix for customized view aggregation", "pr_createdAt": "2020-03-27T05:40:04Z", "pr_url": "https://github.com/apache/helix/pull/917", "timeline": [{"oid": "2a0b3270216bf6c7cac29755b8e454fa1b537218", "url": "https://github.com/apache/helix/commit/2a0b3270216bf6c7cac29755b8e454fa1b537218", "message": "minor fix for customized view", "committedDate": "2020-03-27T22:02:17Z", "type": "forcePushed"}, {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "url": "https://github.com/apache/helix/commit/00dfffc34e8656cc181d02ec7b87495b7917ada2", "message": "minor fix for customized view", "committedDate": "2020-03-27T22:05:39Z", "type": "commit"}, {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "url": "https://github.com/apache/helix/commit/00dfffc34e8656cc181d02ec7b87495b7917ada2", "message": "minor fix for customized view", "committedDate": "2020-03-27T22:05:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MTA3Mg==", "url": "https://github.com/apache/helix/pull/917#discussion_r399561072", "bodyText": "More comments about the content of the map, please.", "author": "jiajunwang", "createdAt": "2020-03-27T22:10:29Z", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -139,7 +139,7 @@\n   final AtomicReference<Map<String, LiveInstance>> _lastSeenInstances;\n   final AtomicReference<Map<String, LiveInstance>> _lastSeenSessions;\n \n-  final AtomicReference<Set<String>> _lastSeenCustomizedStateTypes;\n+  final AtomicReference<Map<String, Set<String>>> _lastSeenCustomizedStateTypesMap;", "originalCommit": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MTI2OA==", "url": "https://github.com/apache/helix/pull/917#discussion_r399561268", "bodyText": "nit Collections.emtpySet()", "author": "jiajunwang", "createdAt": "2020-03-27T22:11:06Z", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -828,8 +828,14 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n     }\n \n     // TODO: remove the synchronization here once we move this update into dataCache.\n-    synchronized (_lastSeenCustomizedStateTypes) {\n-      Set<String> lastSeenCustomizedStateTypes = _lastSeenCustomizedStateTypes.get();\n+    synchronized (_lastSeenCustomizedStateTypesMap) {\n+      Map<String, Set<String>> lastSeenCustomizedStateTypesMap =\n+          _lastSeenCustomizedStateTypesMap.get();\n+      Set<String> lastSeenCustomizedStateTypes = new HashSet<>();", "originalCommit": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MTY3Ng==", "url": "https://github.com/apache/helix/pull/917#discussion_r399561676", "bodyText": "lastSeenCustomizedStateTypes won't be null, right?", "author": "jiajunwang", "createdAt": "2020-03-27T22:12:35Z", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -828,8 +828,14 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n     }\n \n     // TODO: remove the synchronization here once we move this update into dataCache.\n-    synchronized (_lastSeenCustomizedStateTypes) {\n-      Set<String> lastSeenCustomizedStateTypes = _lastSeenCustomizedStateTypes.get();\n+    synchronized (_lastSeenCustomizedStateTypesMap) {\n+      Map<String, Set<String>> lastSeenCustomizedStateTypesMap =\n+          _lastSeenCustomizedStateTypesMap.get();\n+      Set<String> lastSeenCustomizedStateTypes = new HashSet<>();\n+      if (lastSeenCustomizedStateTypesMap != null && lastSeenCustomizedStateTypesMap\n+          .containsKey(instanceName)) {\n+        lastSeenCustomizedStateTypes = lastSeenCustomizedStateTypesMap.get(instanceName);\n+      }\n       for (String customizedState : customizedStateTypes) {\n         try {\n           if (lastSeenCustomizedStateTypes == null || !lastSeenCustomizedStateTypes", "originalCommit": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MTc1MA==", "url": "https://github.com/apache/helix/pull/917#discussion_r399561750", "bodyText": "Same here, do we really need to check this?", "author": "jiajunwang", "createdAt": "2020-03-27T22:12:52Z", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -844,14 +850,24 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n         }\n       }\n \n-      for (String previousCustomizedState : lastSeenCustomizedStateTypes) {\n-        if (!customizedStateTypes.contains(previousCustomizedState)) {\n-          manager.removeListener(keyBuilder.customizedStates(instanceName, previousCustomizedState),\n-              this);\n+      if (lastSeenCustomizedStateTypes != null) {", "originalCommit": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxODkxNg==", "url": "https://github.com/apache/helix/pull/917#discussion_r399618916", "bodyText": "Did you mean to remove this check or not?", "author": "jiajunwang", "createdAt": "2020-03-28T04:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MTc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MzE0Ng==", "url": "https://github.com/apache/helix/pull/917#discussion_r399563146", "bodyText": "This does not look right. If the config types have been changed just before the refresh with fewer items, we won't remove the extra types, right?", "author": "jiajunwang", "createdAt": "2020-03-27T22:17:25Z", "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java", "diffHunk": "@@ -197,18 +197,17 @@ private void refreshTargetExternalViews(final HelixDataAccessor accessor) {\n   public void refreshCustomizedViewMap(final HelixDataAccessor accessor) {\n     // As we are not listening on customized view change, customized view will be\n     // refreshed once during the cache's first refresh() call, or when full refresh is required\n-    List<String> newStateTypes = accessor.getChildNames(accessor.keyBuilder().customizedViews());\n     if (_propertyDataChangedMap.get(HelixConstants.ChangeType.CUSTOMIZED_VIEW).getAndSet(false)) {\n-      for (String stateType : newStateTypes) {\n+      for (String stateType : _aggregationEnabledTypes) {", "originalCommit": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3MDA1NQ==", "url": "https://github.com/apache/helix/pull/917#discussion_r399570055", "bodyText": "In refresh logic, the refresh of customized state config (aggregationEnableTypes) happened before customized view. If we read stale aggregationEnabledTypes, it means that the event of customized state config change has not been processed yet. And it should be fine we do not remove stale types, right?", "author": "zhangmeng916", "createdAt": "2020-03-27T22:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MzE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxODgwNA==", "url": "https://github.com/apache/helix/pull/917#discussion_r399618804", "bodyText": "I think I misread. This is for the in-memory cache not for the znodes.", "author": "jiajunwang", "createdAt": "2020-03-28T04:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MzE0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MzY3Mw==", "url": "https://github.com/apache/helix/pull/917#discussion_r399563673", "bodyText": "The previous change is a good catch. But I don't think we need this converting if we just make removeCustomizedViewTypes receives a set.", "author": "jiajunwang", "createdAt": "2020-03-27T22:19:00Z", "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java", "diffHunk": "@@ -197,18 +197,17 @@ private void refreshTargetExternalViews(final HelixDataAccessor accessor) {\n   public void refreshCustomizedViewMap(final HelixDataAccessor accessor) {\n     // As we are not listening on customized view change, customized view will be\n     // refreshed once during the cache's first refresh() call, or when full refresh is required\n-    List<String> newStateTypes = accessor.getChildNames(accessor.keyBuilder().customizedViews());\n     if (_propertyDataChangedMap.get(HelixConstants.ChangeType.CUSTOMIZED_VIEW).getAndSet(false)) {\n-      for (String stateType : newStateTypes) {\n+      for (String stateType : _aggregationEnabledTypes) {\n         if (!_customizedViewCacheMap.containsKey(stateType)) {\n           CustomizedViewCache newCustomizedViewCache =\n               new CustomizedViewCache(getClusterName(), stateType);\n           _customizedViewCacheMap.put(stateType, newCustomizedViewCache);\n         }\n         _customizedViewCacheMap.get(stateType).refresh(accessor);\n       }\n-      Set<String> previousCachedStateTypes = _customizedViewCacheMap.keySet();\n-      previousCachedStateTypes.removeAll(newStateTypes);\n+      Set<String> previousCachedStateTypes = new HashSet<>(_customizedViewCacheMap.keySet());\n+      previousCachedStateTypes.removeAll(_aggregationEnabledTypes);\n       logger.info(\"Remove customizedView for state: \" + previousCachedStateTypes);\n       removeCustomizedViewTypes(new ArrayList<>(previousCachedStateTypes));", "originalCommit": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2NDI2OQ==", "url": "https://github.com/apache/helix/pull/917#discussion_r399564269", "bodyText": "Why? This list is a local variable, right?", "author": "jiajunwang", "createdAt": "2020-03-27T22:21:06Z", "path": "helix-core/src/main/java/org/apache/helix/controller/stages/CustomizedViewAggregationStage.java", "diffHunk": "@@ -119,6 +117,7 @@ public void execute(final ClusterEvent event) throws Exception {\n               \"Failed to calculate customized view for resource \" + resource.getResourceName(), ex);\n         }\n       }\n+      updatedCustomizedViews.clear();", "originalCommit": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3MTMyMw==", "url": "https://github.com/apache/helix/pull/917#discussion_r399571323", "bodyText": "It's a variable defined outside state type for loop. If we do not clear it, it actually contains resource -> customized view mapping for all state types. When we update ZK, there's problem as we are updating state by state.\nBut I actually found this change is ugly, so I just moved the list inside the loop.", "author": "zhangmeng916", "createdAt": "2020-03-27T22:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2NDI2OQ=="}], "type": "inlineReview"}, {"oid": "86bba3da7c9d84bbd677bdb522acb4ac6d9d4b98", "url": "https://github.com/apache/helix/commit/86bba3da7c9d84bbd677bdb522acb4ac6d9d4b98", "message": "ix comment", "committedDate": "2020-03-27T22:56:33Z", "type": "forcePushed"}, {"oid": "bdb0997aabdeaa5b20cf9353175f353db4fac10f", "url": "https://github.com/apache/helix/commit/bdb0997aabdeaa5b20cf9353175f353db4fac10f", "message": "fix comment", "committedDate": "2020-03-27T22:57:03Z", "type": "commit"}, {"oid": "bdb0997aabdeaa5b20cf9353175f353db4fac10f", "url": "https://github.com/apache/helix/commit/bdb0997aabdeaa5b20cf9353175f353db4fac10f", "message": "fix comment", "committedDate": "2020-03-27T22:57:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxOTAzOQ==", "url": "https://github.com/apache/helix/pull/917#discussion_r399619039", "bodyText": "nit, since I am confused again while reviewing the code related to this field, shall we rename it to _lastSeenCustomizedStateTypesRef Or _lastSeenCustomizedStateTypesMapRef?", "author": "jiajunwang", "createdAt": "2020-03-28T04:44:09Z", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -139,7 +139,9 @@\n   final AtomicReference<Map<String, LiveInstance>> _lastSeenInstances;\n   final AtomicReference<Map<String, LiveInstance>> _lastSeenSessions;\n \n-  final AtomicReference<Set<String>> _lastSeenCustomizedStateTypes;\n+  // map that stores the mapping between instance and the customized state types available on that\n+  //instance\n+  final AtomicReference<Map<String, Set<String>>> _lastSeenCustomizedStateTypesMap;", "originalCommit": "bdb0997aabdeaa5b20cf9353175f353db4fac10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxOTIxMw==", "url": "https://github.com/apache/helix/pull/917#discussion_r399619213", "bodyText": "nit, if addCustomizedStateChangeListener already logs inside, we don't need this info log. Please confirm.", "author": "jiajunwang", "createdAt": "2020-03-28T04:47:30Z", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -828,12 +830,17 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n     }\n \n     // TODO: remove the synchronization here once we move this update into dataCache.\n-    synchronized (_lastSeenCustomizedStateTypes) {\n-      Set<String> lastSeenCustomizedStateTypes = _lastSeenCustomizedStateTypes.get();\n+    synchronized (_lastSeenCustomizedStateTypesMap) {\n+      Map<String, Set<String>> lastSeenCustomizedStateTypesMap =\n+          _lastSeenCustomizedStateTypesMap.get();\n+      Set<String> lastSeenCustomizedStateTypes = Collections.emptySet();\n+      if (lastSeenCustomizedStateTypesMap != null && lastSeenCustomizedStateTypesMap\n+          .containsKey(instanceName)) {\n+        lastSeenCustomizedStateTypes = lastSeenCustomizedStateTypesMap.get(instanceName);\n+      }\n       for (String customizedState : customizedStateTypes) {\n         try {\n-          if (lastSeenCustomizedStateTypes == null || !lastSeenCustomizedStateTypes\n-              .contains(customizedState)) {\n+          if (!lastSeenCustomizedStateTypes.contains(customizedState)) {\n             manager.addCustomizedStateChangeListener(this, instanceName, customizedState);\n             logger.info(", "originalCommit": "bdb0997aabdeaa5b20cf9353175f353db4fac10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyNTkwNg==", "url": "https://github.com/apache/helix/pull/917#discussion_r399625906", "bodyText": "In ZkHelixManager, there's log for addListener, but in the controller, all the operations of adding listeners have this log, so I think it's better to keep consistent.", "author": "zhangmeng916", "createdAt": "2020-03-28T06:13:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxOTIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyOTEzMg==", "url": "https://github.com/apache/helix/pull/917#discussion_r399629132", "bodyText": "The only additional information we get by printing this log is manager.getInstanceName(), I guess. I don't have a strong preference. But do whatever the other similar code does might cause redundant code. Please only keep this log if you think the extra helixmanager name can help us to debug in the future.", "author": "jiajunwang", "createdAt": "2020-03-28T06:56:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxOTIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5ODEyOQ==", "url": "https://github.com/apache/helix/pull/917#discussion_r399698129", "bodyText": "I think it can still provide some information, so keep it for now.", "author": "zhangmeng916", "createdAt": "2020-03-28T19:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxOTIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxOTUxMg==", "url": "https://github.com/apache/helix/pull/917#discussion_r399619512", "bodyText": "Might help to simplify the code.\nMap<String, Set> lastSeenCustomizedStateTypesMap =\n_lastSeenCustomizedStateTypesMap.get();\nif (null == lastSeenCustomizedStateTypesMap) {\nlastSeenCustomizedStateTypesMap = new HashMap();\n// lazy init the AtomicReference\n_lastSeenCustomizedStateTypesMapRef.set(lastSeenCustomizedStateTypesMap);\n}\nif (!lastSeenCustomizedStateTypesMap.containsKey(instanceName)) {\nlastSeenCustomizedStateTypesMap.put(instanceName, Collections.emptySet());\n}\nSet lastSeenCustomizedStateTypes = lastSeenCustomizedStateTypesMap.get(instanceName);\nThen you don't need to check null later.", "author": "jiajunwang", "createdAt": "2020-03-28T04:51:32Z", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -828,12 +830,17 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n     }\n \n     // TODO: remove the synchronization here once we move this update into dataCache.\n-    synchronized (_lastSeenCustomizedStateTypes) {\n-      Set<String> lastSeenCustomizedStateTypes = _lastSeenCustomizedStateTypes.get();\n+    synchronized (_lastSeenCustomizedStateTypesMap) {\n+      Map<String, Set<String>> lastSeenCustomizedStateTypesMap =\n+          _lastSeenCustomizedStateTypesMap.get();\n+      Set<String> lastSeenCustomizedStateTypes = Collections.emptySet();\n+      if (lastSeenCustomizedStateTypesMap != null && lastSeenCustomizedStateTypesMap", "originalCommit": "bdb0997aabdeaa5b20cf9353175f353db4fac10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "36d3ea1682493ad2676f9cbde08269729f87e8cd", "url": "https://github.com/apache/helix/commit/36d3ea1682493ad2676f9cbde08269729f87e8cd", "message": "fix comment", "committedDate": "2020-03-28T06:42:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyOTM4Nw==", "url": "https://github.com/apache/helix/pull/917#discussion_r399629387", "bodyText": "Are you trying to do the following logic?\n// Update the last seen types cache\nlastSeenCustomizedStateTypes.clear()\nlastSeenCustomizedStateTypes.addAll(customizedStateTypes)", "author": "jiajunwang", "createdAt": "2020-03-28T06:59:45Z", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -851,7 +865,7 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n         }\n       }\n \n-      _lastSeenCustomizedStateTypes.set(new HashSet<>(customizedStateTypes));\n+      lastSeenCustomizedStateTypes = new HashSet<>(customizedStateTypes);", "originalCommit": "36d3ea1682493ad2676f9cbde08269729f87e8cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYzMjAzMA==", "url": "https://github.com/apache/helix/pull/917#discussion_r399632030", "bodyText": "Yeah, messed it up.", "author": "zhangmeng916", "createdAt": "2020-03-28T07:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyOTM4Nw=="}], "type": "inlineReview"}, {"oid": "eca1b3909755491f85d9d90121615c5d91f51af1", "url": "https://github.com/apache/helix/commit/eca1b3909755491f85d9d90121615c5d91f51af1", "message": "fix wrong set", "committedDate": "2020-03-29T00:45:33Z", "type": "commit"}, {"oid": "eca1b3909755491f85d9d90121615c5d91f51af1", "url": "https://github.com/apache/helix/commit/eca1b3909755491f85d9d90121615c5d91f51af1", "message": "fix wrong set", "committedDate": "2020-03-29T00:45:33Z", "type": "forcePushed"}]}