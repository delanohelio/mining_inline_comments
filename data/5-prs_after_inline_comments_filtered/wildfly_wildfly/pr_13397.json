{"pr_number": 13397, "pr_title": "[WFLY-12342] Add server probes for readiness health check", "pr_createdAt": "2020-07-06T15:07:23Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13397", "timeline": [{"oid": "561daac5de34fc672f955a70c37b91e822437bd5", "url": "https://github.com/wildfly/wildfly/commit/561daac5de34fc672f955a70c37b91e822437bd5", "message": "[WFLY-12342] Add server probes for readiness health check\n\n* Separate handling of the server readiness checks from the deployment\n  checks to ensure that the server should not report UP until readiness\n  checks from the deployment have been installed and called.\n* Change the semantic of empty-readiness-check-status and\n  empty-readiness-checks-status so that they only deal with empty\n  *deployment* checks.\n* Add special handling of the MicroProfile Health TCK by disabling the\n  server readiness checks when the TCK is run as it assumes that there\n  will be only checks installed by the TCK itself.\n\n JIRA: https://issues.jboss.org/browse/WFLY-12342\n\nSigned-off-by: Jeff Mesnil <jmesnil@redhat.com>", "committedDate": "2020-07-07T11:23:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk2NTYyNg==", "url": "https://github.com/wildfly/wildfly/pull/13397#discussion_r482965626", "bodyText": "So it basically disable all three checks. Can we remove _TCK_part so it does not look like some workaround flag. Then we can also advertise that as feature compatibility flag. If for some reason new behaviour  make problem to someone.", "author": "mchoma", "createdAt": "2020-09-03T13:11:25Z", "path": "microprofile/health-smallrye/src/main/java/org/wildfly/extension/microprofile/health/HealthReporterService.java", "diffHunk": "@@ -40,30 +51,52 @@\n public class HealthReporterService implements Service<HealthReporter> {\n \n     private static HealthReporter healthReporter;\n+    private final Supplier<ModelControllerClientFactory> modelControllerClientFactory;\n+    private final Supplier<Executor> managementExecutor;\n     private String emptyLivenessChecksStatus;\n     private String emptyReadinessChecksStatus;\n+    private LocalModelControllerClient modelControllerClient;\n \n     static void install(OperationContext context, String emptyLivenessChecksStatus, String emptyReadinessChecksStatus) {\n-        context.getCapabilityServiceTarget()\n-                .addCapability(RuntimeCapability.Builder.of(HEALTH_REPORTER_CAPABILITY, SmallRyeHealthReporter.class).build())\n-                .setInstance(new HealthReporterService(emptyLivenessChecksStatus, emptyReadinessChecksStatus))\n+\n+        CapabilityServiceBuilder<?> serviceBuilder = context.getCapabilityServiceTarget()\n+                .addCapability(RuntimeCapability.Builder.of(HEALTH_REPORTER_CAPABILITY, SmallRyeHealthReporter.class).build());\n+\n+        Supplier<ModelControllerClientFactory> modelControllerClientFactory = serviceBuilder.requires(context.getCapabilityServiceName(CLIENT_FACTORY_CAPABILITY, ModelControllerClientFactory.class));\n+        Supplier<Executor> managementExecutor = serviceBuilder.requires(context.getCapabilityServiceName(MANAGEMENT_EXECUTOR, Executor.class));\n+\n+        serviceBuilder.setInstance(new HealthReporterService(modelControllerClientFactory, managementExecutor, emptyLivenessChecksStatus, emptyReadinessChecksStatus))\n                 .install();\n     }\n \n-    private HealthReporterService(String emptyLivenessChecksStatus, String emptyReadinessChecksStatus) {\n+    private HealthReporterService(Supplier<ModelControllerClientFactory> modelControllerClientFactory,\n+                                  Supplier<Executor> managementExecutor,\n+                                  String emptyLivenessChecksStatus, String emptyReadinessChecksStatus) {\n+        this.modelControllerClientFactory = modelControllerClientFactory;\n+        this.managementExecutor = managementExecutor;\n         this.emptyLivenessChecksStatus = emptyLivenessChecksStatus;\n         this.emptyReadinessChecksStatus = emptyReadinessChecksStatus;\n     }\n \n     @Override\n     public void start(StartContext context) {\n         healthReporter = new HealthReporter(emptyLivenessChecksStatus, emptyReadinessChecksStatus);\n+\n+        modelControllerClient = modelControllerClientFactory.get().createClient(managementExecutor.get());\n+\n+        if (System.getProperty(\"__MP_HEALTH_TCK_DISABLE_SERVER_CHECKS\") == null) {", "originalCommit": "561daac5de34fc672f955a70c37b91e822437bd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk5NjY3MA==", "url": "https://github.com/wildfly/wildfly/pull/13397#discussion_r482996670", "bodyText": "that's a good point, I should replace that code by a proper call to MP Config and check the mp.health.disable-default-procedures config property instead", "author": "jmesnil", "createdAt": "2020-09-03T13:55:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk2NTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA3MTc0OQ==", "url": "https://github.com/wildfly/wildfly/pull/13397#discussion_r483071749", "bodyText": "fixed", "author": "jmesnil", "createdAt": "2020-09-03T15:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk2NTYyNg=="}], "type": "inlineReview"}, {"oid": "3aecb5c1bfb1d71483d91653992b8c794588d7c7", "url": "https://github.com/wildfly/wildfly/commit/3aecb5c1bfb1d71483d91653992b8c794588d7c7", "message": "[WFLY-12342] Add server probes for readiness health check\n\nAdd 3 healthcheck probes to determine the readiness of the server:\n\n* server-state returns UP when the server is \"running\"\n* boot-errors returns UP if there were no boot-errors\n* deployments-status returns UP if all deployments status are OK\n\nJIRA: https://issues.jboss.org/browse/WFLY-12342", "committedDate": "2020-09-03T14:55:07Z", "type": "commit"}, {"oid": "20f575e0969cf888c6b1344ada198afdc234fedd", "url": "https://github.com/wildfly/wildfly/commit/20f575e0969cf888c6b1344ada198afdc234fedd", "message": "[WFLY-12342] Add server probes for readiness health check\n\n* Separate handling of the server readiness checks from the deployment\n  checks to ensure that the server should not report UP until readiness\n  checks from the deployment have been installed and called.\n* Change the semantic of empty-readiness-check-status and\n  empty-readiness-checks-status so that they only deal with empty\n  *deployment* checks.\n* Support the `mp.health.disable-default-procedures` config property to\n  disable any vendor procedures. When the TCK is run as it assumes that\n  there will be only checks installed by the TCK itself.\n\n JIRA: https://issues.jboss.org/browse/WFLY-12342\n\nSigned-off-by: Jeff Mesnil <jmesnil@redhat.com>", "committedDate": "2020-09-03T15:31:57Z", "type": "forcePushed"}, {"oid": "4ffd63d58cc2679ffdfe18b0a7d33dc56316edf1", "url": "https://github.com/wildfly/wildfly/commit/4ffd63d58cc2679ffdfe18b0a7d33dc56316edf1", "message": "[WFLY-12342] Add server probes for readiness health check\n\n* Separate handling of the server readiness checks from the deployment\n  checks to ensure that the server should not report UP until readiness\n  checks from the deployment have been installed and called.\n* Change the semantic of empty-readiness-check-status and\n  empty-readiness-checks-status so that they only deal with empty\n  *deployment* checks.\n* Support the `mp.health.disable-default-procedures` config property to\n  disable any vendor procedures. When the TCK is run as it assumes that\n  there will be only checks installed by the TCK itself.\n* Updated subsystem documentation\n\n JIRA: https://issues.jboss.org/browse/WFLY-12342\n\nSigned-off-by: Jeff Mesnil <jmesnil@redhat.com>", "committedDate": "2020-09-09T15:50:42Z", "type": "forcePushed"}, {"oid": "bb25e9aa793f2c19658af1444872bcf313fab057", "url": "https://github.com/wildfly/wildfly/commit/bb25e9aa793f2c19658af1444872bcf313fab057", "message": "[WFLY-12342] Add server probes for readiness health check\n\n* Separate handling of the server readiness checks from the deployment\n  checks to ensure that the server should not report UP until readiness\n  checks from the deployment have been installed and called.\n* Change the semantic of empty-readiness-check-status and\n  empty-readiness-checks-status so that they only deal with empty\n  *deployment* checks.\n* Support the `mp.health.disable-default-procedures` config property to\n  disable any vendor procedures. When the TCK is run as it assumes that\n  there will be only checks installed by the TCK itself.\n* Updated subsystem documentation\n\n JIRA: https://issues.jboss.org/browse/WFLY-12342\n\nSigned-off-by: Jeff Mesnil <jmesnil@redhat.com>", "committedDate": "2020-09-09T15:53:16Z", "type": "forcePushed"}, {"oid": "f5bd3daebce865c3215a65454cc2f6dde9cca124", "url": "https://github.com/wildfly/wildfly/commit/f5bd3daebce865c3215a65454cc2f6dde9cca124", "message": "[WFLY-12342] Add server probes for readiness health check\n\n* Separate handling of the server readiness checks from the deployment\n  checks to ensure that the server should not report UP until readiness\n  checks from the deployment have been installed and called.\n* Change the semantic of empty-readiness-check-status and\n  empty-readiness-checks-status so that they only deal with empty\n  *deployment* checks.\n* Support the `mp.health.disable-default-procedures` config property to\n  disable any vendor procedures. When the TCK is run as it assumes that\n  there will be only checks installed by the TCK itself.\n* Updated subsystem documentation\n\n JIRA: https://issues.jboss.org/browse/WFLY-12342\n\nSigned-off-by: Jeff Mesnil <jmesnil@redhat.com>", "committedDate": "2020-09-09T19:54:11Z", "type": "forcePushed"}, {"oid": "a58f01471c133475305deb23e37885776a573d29", "url": "https://github.com/wildfly/wildfly/commit/a58f01471c133475305deb23e37885776a573d29", "message": "[WFLY-12342] Add server probes for readiness health check\n\n* Separate handling of the server readiness checks from the deployment\n  checks to ensure that the server should not report UP until readiness\n  checks from the deployment have been installed and called.\n* Change the semantic of empty-readiness-check-status and\n  empty-readiness-checks-status so that they only deal with empty\n  *deployment* checks.\n* Support the `mp.health.disable-default-procedures` config property to\n  disable any vendor procedures. When the TCK is run as it assumes that\n  there will be only checks installed by the TCK itself.\n* Updated subsystem documentation\n\n JIRA: https://issues.jboss.org/browse/WFLY-12342\n\nSigned-off-by: Jeff Mesnil <jmesnil@redhat.com>", "committedDate": "2020-09-10T07:33:30Z", "type": "forcePushed"}, {"oid": "e43b08aae6d1d68cb4ce50fd7a7e7402e0632075", "url": "https://github.com/wildfly/wildfly/commit/e43b08aae6d1d68cb4ce50fd7a7e7402e0632075", "message": "[WFLY-12342] Add server probes for readiness health check\n\n* Separate handling of the server readiness checks from the deployment\n  checks to ensure that the server should not report UP until readiness\n  checks from the deployment have been installed and called.\n* Change the semantic of empty-readiness-check-status and\n  empty-readiness-checks-status so that they only deal with empty\n  *deployment* checks.\n* Support the `mp.health.disable-default-procedures` config property to\n  disable any vendor procedures. When the TCK is run as it assumes that\n  there will be only checks installed by the TCK itself.\n* Updated subsystem documentation\n\n JIRA: https://issues.jboss.org/browse/WFLY-12342\n\nSigned-off-by: Jeff Mesnil <jmesnil@redhat.com>", "committedDate": "2020-09-10T08:58:55Z", "type": "commit"}, {"oid": "e43b08aae6d1d68cb4ce50fd7a7e7402e0632075", "url": "https://github.com/wildfly/wildfly/commit/e43b08aae6d1d68cb4ce50fd7a7e7402e0632075", "message": "[WFLY-12342] Add server probes for readiness health check\n\n* Separate handling of the server readiness checks from the deployment\n  checks to ensure that the server should not report UP until readiness\n  checks from the deployment have been installed and called.\n* Change the semantic of empty-readiness-check-status and\n  empty-readiness-checks-status so that they only deal with empty\n  *deployment* checks.\n* Support the `mp.health.disable-default-procedures` config property to\n  disable any vendor procedures. When the TCK is run as it assumes that\n  there will be only checks installed by the TCK itself.\n* Updated subsystem documentation\n\n JIRA: https://issues.jboss.org/browse/WFLY-12342\n\nSigned-off-by: Jeff Mesnil <jmesnil@redhat.com>", "committedDate": "2020-09-10T08:58:55Z", "type": "forcePushed"}]}