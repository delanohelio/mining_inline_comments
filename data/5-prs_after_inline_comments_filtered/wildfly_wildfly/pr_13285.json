{"pr_number": 13285, "pr_title": "[WFLY-13386] Hung process instances and associated server.log WARN \"Failed to reinstate timer 'kie-server.kie-server.EJBTimerScheduler' \"", "pr_createdAt": "2020-05-13T10:55:28Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13285", "timeline": [{"oid": "0556d0432842295a8edfdb3ffe7cabd9cebbafe1", "url": "https://github.com/wildfly/wildfly/commit/0556d0432842295a8edfdb3ffe7cabd9cebbafe1", "message": "[WFLY-13386] Hung process instances and associated server.log WARN \"Failed to reinstate timer 'kie-server.kie-server.EJBTimerScheduler' \"\n\nIf activate the refresh task in the database persistence there are at least\ntwo threads compiting for registering a timer.\n\nThe refresh task is executing at the same time a new time is being registered\nif this happens the same timer will be try to registered by ejb and refresh task\n\nthis is due the fact the ejb action register in the database in its own tx (outside ejb tx)\nthe refresh task tries to load from its own tx\n\nso if this order happens\n1 ejb thread register the timer in the database\n2 refresh task thread  load the timer from the dabase\n3 ejb thred registers the timer in the dmr\n4 refresh task thread register the timer in the dmr (fail as duplicated)", "committedDate": "2020-05-14T06:04:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0MzI0Mg==", "url": "https://github.com/wildfly/wildfly/pull/13285#discussion_r425543242", "bodyText": "timers is already declared as a synchronized map. We may want to switch to a regular HashMap and guard all access to it to avoid double synchronize it.", "author": "chengfang", "createdAt": "2020-05-15T03:16:26Z", "path": "ejb3/src/main/java/org/jboss/as/ejb3/timerservice/TimerServiceImpl.java", "diffHunk": "@@ -1133,12 +1128,23 @@ public TimerServiceResource getResource() {\n         return resource;\n     }\n \n-    private void registerTimerResource(final String timerId) {\n-        this.resource.timerCreated(timerId);\n+    private boolean registerTimerResource(final TimerImpl timer) {\n+        synchronized (this.timers) {\n+            if (this.timers.containsKey(timer.getId())) {", "originalCommit": "0556d0432842295a8edfdb3ffe7cabd9cebbafe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU4ODc4Mw==", "url": "https://github.com/wildfly/wildfly/pull/13285#discussion_r425588783", "bodyText": "done", "author": "elguardian", "createdAt": "2020-05-15T06:18:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0MzI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NDg5Mg==", "url": "https://github.com/wildfly/wildfly/pull/13285#discussion_r425544892", "bodyText": "If the timer id already exists in the internal cache timers, why do we put the timer to timers again? It looks harmless though.", "author": "chengfang", "createdAt": "2020-05-15T03:23:34Z", "path": "ejb3/src/main/java/org/jboss/as/ejb3/timerservice/TimerServiceImpl.java", "diffHunk": "@@ -1133,12 +1128,23 @@ public TimerServiceResource getResource() {\n         return resource;\n     }\n \n-    private void registerTimerResource(final String timerId) {\n-        this.resource.timerCreated(timerId);\n+    private boolean registerTimerResource(final TimerImpl timer) {\n+        synchronized (this.timers) {\n+            if (this.timers.containsKey(timer.getId())) {\n+                this.timers.put(timer.getId(), timer);", "originalCommit": "0556d0432842295a8edfdb3ffe7cabd9cebbafe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU4OTA4OA==", "url": "https://github.com/wildfly/wildfly/pull/13285#discussion_r425589088", "bodyText": "ok. removed", "author": "elguardian", "createdAt": "2020-05-15T06:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NDg5Mg=="}], "type": "inlineReview"}, {"oid": "48d6e86d7519806f6e5c8ec2237e52c8f28652a6", "url": "https://github.com/wildfly/wildfly/commit/48d6e86d7519806f6e5c8ec2237e52c8f28652a6", "message": "[WFLY-13386] Hung process instances and associated server.log WARN \"Failed to reinstate timer 'kie-server.kie-server.EJBTimerScheduler' \"\n\nIf activate the refresh task in the database persistence there are at least\ntwo threads compiting for registering a timer.\n\nThe refresh task is executing at the same time a new time is being registered\nif this happens the same timer will be try to registered by ejb and refresh task\n\nthis is due the fact the ejb action register in the database in its own tx (outside ejb tx)\nthe refresh task tries to load from its own tx\n\nso if this order happens\n1 ejb thread register the timer in the database\n2 refresh task thread  load the timer from the dabase\n3 ejb thred registers the timer in the dmr\n4 refresh task thread register the timer in the dmr (fail as duplicated)", "committedDate": "2020-05-15T06:17:39Z", "type": "commit"}, {"oid": "48d6e86d7519806f6e5c8ec2237e52c8f28652a6", "url": "https://github.com/wildfly/wildfly/commit/48d6e86d7519806f6e5c8ec2237e52c8f28652a6", "message": "[WFLY-13386] Hung process instances and associated server.log WARN \"Failed to reinstate timer 'kie-server.kie-server.EJBTimerScheduler' \"\n\nIf activate the refresh task in the database persistence there are at least\ntwo threads compiting for registering a timer.\n\nThe refresh task is executing at the same time a new time is being registered\nif this happens the same timer will be try to registered by ejb and refresh task\n\nthis is due the fact the ejb action register in the database in its own tx (outside ejb tx)\nthe refresh task tries to load from its own tx\n\nso if this order happens\n1 ejb thread register the timer in the database\n2 refresh task thread  load the timer from the dabase\n3 ejb thred registers the timer in the dmr\n4 refresh task thread register the timer in the dmr (fail as duplicated)", "committedDate": "2020-05-15T06:17:39Z", "type": "forcePushed"}]}