{"pr_number": 13812, "pr_title": "[WFLY-14210] Bump the jaxrs subsystems model version. Reject attribut\u2026", "pr_createdAt": "2020-12-11T00:38:13Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13812", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE4MzgzNg==", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r541183836", "bodyText": "Since you went down the refactoring path I'm going to punish you. ;)\nj/k -- cleanup is good.\nThis class should no longer implement XMLElementWriter as it is never used as such.", "author": "bstansberry", "createdAt": "2020-12-11T19:15:37Z", "path": "jaxrs/src/main/java/org/jboss/as/jaxrs/JaxrsSubsystemParser_1_0.java", "diffHunk": "@@ -56,6 +58,6 @@ public void readElement(final XMLExtendedStreamReader reader, final List<ModelNo\n        */\n       @Override\n       public void writeContent(final XMLExtendedStreamWriter streamWriter, final SubsystemMarshallingContext context) throws XMLStreamException {\n-          context.startSubsystemElement(JaxrsExtension.NAMESPACE_1_0, true);\n+          context.startSubsystemElement(NAMESPACE, true);", "originalCommit": "4be4fe3b8699184af128c4631ec4c80ac511f27c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NDMzMA==", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r542464330", "bodyText": "Ah good call. I'll fix that as well. It's a quick change.", "author": "jamezp", "createdAt": "2020-12-14T15:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE4MzgzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIwNjU5OQ==", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r541206599", "bodyText": "Something feels off here.\nAIUI we've actually had a \"3.0\" (imagine some air quotes) since WF 19, and it looks like we've had a proper 2.0 since some time in 2017. And now you're officially creating a proper 3.0.\nWe need transformation for hosts using 1.0 no matter what. We need the missing 3.0 -> 2.0 transformation unless the admin disabled it. If the admin disabled 3.0 -> 2.0 with the system property, then we must do 3.0 -> 1.0.\nMaybe rename registerTransformers_2_0_0 to registerTransformersFrom_3_0_0 and then make sure it's invoked no matter what. What differs is the target version provided to chainedBuilder.createBuilder.\nBTW I think names like registerTransformersFrom_3_0_0 are better in general. When I review these classes I usually waste time trying to figure out what these version # in these methods represents -- source or target.", "author": "bstansberry", "createdAt": "2020-12-11T19:39:28Z", "path": "jaxrs/src/main/java/org/jboss/as/jaxrs/JaxrsTransformers.java", "diffHunk": "@@ -45,12 +56,22 @@ public String getSubsystemName() {\n \n     @Override\n     public void registerTransformers(SubsystemTransformerRegistration subsystemRegistration) {\n-        registerTransformers_2_0_0(subsystemRegistration);\n+        if (!isByPassTransformers()) {\n+            ChainedTransformationDescriptionBuilder chainedBuilder =\n+                    TransformationDescriptionBuilder.Factory.createChainedSubystemInstance(subsystemRegistration.getCurrentSubsystemVersion());\n+\n+            //Differences between 3.0.0 and 2.0.0\n+            ResourceTransformationDescriptionBuilder builder200 =\n+                    chainedBuilder.createBuilder(subsystemRegistration.getCurrentSubsystemVersion(), MODEL_VERSION_2_0_0);\n+            registerTransformers_2_0_0(builder200);\n+\n+            //Create chained transformers.\n+            chainedBuilder.buildAndRegister(subsystemRegistration, new ModelVersion[] {MODEL_VERSION_2_0_0, MODEL_VERSION_1_0_0});\n+        }", "originalCommit": "4be4fe3b8699184af128c4631ec4c80ac511f27c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NTkxMw==", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r542465913", "bodyText": "Okay that makes sense to me. Something felt off to me as well and for some reason I was just not seeing it :) Now that you point it out it's fairly obvious though.", "author": "jamezp", "createdAt": "2020-12-14T15:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIwNjU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjUyNzY4MA==", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r542527680", "bodyText": "Updated. I think I've got it right. For some reason I confuse myself with transformers all the time :)", "author": "jamezp", "createdAt": "2020-12-14T16:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIwNjU5OQ=="}], "type": "inlineReview"}, {"oid": "6c2904c8ab9bc3c2b95af33d01a29def9c58871f", "url": "https://github.com/wildfly/wildfly/commit/6c2904c8ab9bc3c2b95af33d01a29def9c58871f", "message": "[WFLY-14210] Bump the jaxrs subsystems model version. Reject attributes against the 1.0.0 and 2.0.0 model versions. Model version 2.0.0 was incorrectly used in WildFly 19, 20 and 21. An added system property was added to allow the transformers to be bypassed.\n\nhttps://issues.redhat.com/browse/WFLY-14210", "committedDate": "2020-12-14T16:34:13Z", "type": "forcePushed"}, {"oid": "6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c", "url": "https://github.com/wildfly/wildfly/commit/6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c", "message": "[WFLY-14210] Bump the jaxrs subsystems model version. Reject attributes against the 1.0.0 and 2.0.0 model versions. Model version 2.0.0 was incorrectly used in WildFly 19, 20 and 21. An added system property was added to allow the transformers to be bypassed.\n\nhttps://issues.redhat.com/browse/WFLY-14210", "committedDate": "2020-12-14T16:36:22Z", "type": "commit"}, {"oid": "6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c", "url": "https://github.com/wildfly/wildfly/commit/6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c", "message": "[WFLY-14210] Bump the jaxrs subsystems model version. Reject attributes against the 1.0.0 and 2.0.0 model versions. Model version 2.0.0 was incorrectly used in WildFly 19, 20 and 21. An added system property was added to allow the transformers to be bypassed.\n\nhttps://issues.redhat.com/browse/WFLY-14210", "committedDate": "2020-12-14T16:36:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU0NjA0MQ==", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r542546041", "bodyText": "@kabir All of the above LGTM but can you confirm?", "author": "bstansberry", "createdAt": "2020-12-14T16:58:44Z", "path": "jaxrs/src/main/java/org/jboss/as/jaxrs/JaxrsTransformers.java", "diffHunk": "@@ -45,12 +56,29 @@ public String getSubsystemName() {\n \n     @Override\n     public void registerTransformers(SubsystemTransformerRegistration subsystemRegistration) {\n-        registerTransformers_2_0_0(subsystemRegistration);\n+        final ModelVersion[] modelVersions;\n+        final ModelVersion target;\n+        if (isByPassTransformers()) {\n+            target = MODEL_VERSION_1_0_0;\n+            modelVersions = new ModelVersion[] {MODEL_VERSION_1_0_0};\n+        } else {\n+            target = MODEL_VERSION_2_0_0;\n+            modelVersions = new ModelVersion[] {MODEL_VERSION_2_0_0, MODEL_VERSION_1_0_0};\n+        }\n+        ChainedTransformationDescriptionBuilder chainedBuilder =\n+                TransformationDescriptionBuilder.Factory.createChainedSubystemInstance(subsystemRegistration.getCurrentSubsystemVersion());\n+\n+        // Differences between 3.0.0 and 2.0.0\n+        ResourceTransformationDescriptionBuilder builder300 =\n+                chainedBuilder.createBuilder(subsystemRegistration.getCurrentSubsystemVersion(), target);\n+        registerTransformers_3_0_0(builder300);\n+\n+        // Create chained transformers.\n+        chainedBuilder.buildAndRegister(subsystemRegistration, modelVersions);", "originalCommit": "6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4Mjk3NQ==", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r542682975", "bodyText": "@bstansberry @jamezp Although I don't totally get the isBypassTransformers stuff I think it looks fine.\nIt seems we only care about transforming one version delta (CURRENT to 1.0.0; or CURRENT to 2.0.0) and we account for that in the builder.\nThen the registration process seems to take that into account. If tests pass both with and without org.wildfly.jaxrs.unsupported.bypass.2.0.0.transformer it should be ok", "author": "kabir", "createdAt": "2020-12-14T19:29:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU0NjA0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgzNjcxNQ==", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r542836715", "bodyText": "@kabir The test actually fails if the property is set, but that should be expected. The reason for the property is to allow WildFly 19, 20 and 21 servers to not reject those attributes in a mixed domain. I doubt it will be used much TBH, but it seemed like we should have a way to bypass it just in case.", "author": "jamezp", "createdAt": "2020-12-14T21:53:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU0NjA0MQ=="}], "type": "inlineReview"}]}