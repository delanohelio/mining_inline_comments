{"pr_number": 13419, "pr_title": "[WFLY-13435] / [WFLY-13509] / [WFLY-13434] / [WFLY-13319] DUP Refactoring for SecurityDomain resolution.", "pr_createdAt": "2020-07-22T09:30:07Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13419", "timeline": [{"oid": "fb482ba3e9b5553fc831aa24230767db40a0251b", "url": "https://github.com/wildfly/wildfly/commit/fb482ba3e9b5553fc831aa24230767db40a0251b", "message": "[WFLY-13435] Move security domain name resolution before UndertowDeploymentProcessor.\n\nIdeally we would pull this all the way to Phase.PARSE but interaction with WS DUPs mean we need to wait until they have performed their own security domain resolution.", "committedDate": "2020-06-08T09:10:23Z", "type": "commit"}, {"oid": "11c66705a3a621b13b1aa2779a4a58a8d72e8284", "url": "https://github.com/wildfly/wildfly/commit/11c66705a3a621b13b1aa2779a4a58a8d72e8284", "message": "[WFLY-13435] Re-advertise the SecurityDomain as an alias to the ApplicationSecurityDomain service so a ServiceName can be advertised.\n\nFor virtual security domains obtain the ServiceName from the SecurityMetaDat attachment instead of generating again.", "committedDate": "2020-06-08T10:14:21Z", "type": "commit"}, {"oid": "6b86d39c1c3ec35d81881073625de7487cc44279", "url": "https://github.com/wildfly/wildfly/commit/6b86d39c1c3ec35d81881073625de7487cc44279", "message": "[WFLY-13509] Convert the ApplicationSecurityDomain resource to use the new MSC APIs.", "committedDate": "2020-06-08T10:14:21Z", "type": "commit"}, {"oid": "15e0f3db06d52efb30d3695c0fac707d1d10f7b3", "url": "https://github.com/wildfly/wildfly/commit/15e0f3db06d52efb30d3695c0fac707d1d10f7b3", "message": "[WFLY-13434] Also expose SecurityDomain from ApplicationSecurityDomain so we can re-use it.", "committedDate": "2020-06-08T10:14:21Z", "type": "commit"}, {"oid": "c8c48dd26f77688117bda1d45d31307e69fc8d2f", "url": "https://github.com/wildfly/wildfly/commit/c8c48dd26f77688117bda1d45d31307e69fc8d2f", "message": "[WFLY-13434] Adjust EJB deployment to make use of pre-defined security domain and advertise the name of any security domain selected during the EJB deployment process.", "committedDate": "2020-07-23T15:47:42Z", "type": "commit"}, {"oid": "521293d4554c7f1fe5f89a555ea4906f2149e93e", "url": "https://github.com/wildfly/wildfly/commit/521293d4554c7f1fe5f89a555ea4906f2149e93e", "message": "[WFLY-13319] Add a test case to test EJB integration with MicroProfile JWT.", "committedDate": "2020-07-23T15:47:42Z", "type": "commit"}, {"oid": "521293d4554c7f1fe5f89a555ea4906f2149e93e", "url": "https://github.com/wildfly/wildfly/commit/521293d4554c7f1fe5f89a555ea4906f2149e93e", "message": "[WFLY-13319] Add a test case to test EJB integration with MicroProfile JWT.", "committedDate": "2020-07-23T15:47:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk2OTYwNg==", "url": "https://github.com/wildfly/wildfly/pull/13419#discussion_r463969606", "bodyText": "Nit: you don't need the null check any more as the line above ensures it's false.", "author": "bstansberry", "createdAt": "2020-08-01T14:57:29Z", "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/EJBSecurityDomainService.java", "diffHunk": "@@ -36,39 +41,81 @@\n import org.jboss.msc.service.StartException;\n import org.jboss.msc.service.StopContext;\n import org.jboss.msc.value.InjectedValue;\n+import org.wildfly.security.auth.server.SecurityDomain;\n+import org.wildfly.security.manager.WildFlySecurityManager;\n \n /**\n  * A service that sets up the security domain mapping for an EJB deployment.\n  *\n+ * This service is reponsible for deployment level actions such as registering a deployment with the resolved\n+ * application-security-domain mapping or associating the {@code SecurityDomain} with the deployment's {@code ClassLoader}.\n+ * Defined {@code ComponentConfigurator} instances will then provide the component specific installation.\n+ *\n  * @author <a href=\"mailto:fjuma@redhat.com\">Farah</a>\n  */\n public class EJBSecurityDomainService implements Service<Void> {\n     public static final ServiceName SERVICE_NAME = ServiceName.of(\"ejb3\", \"security-domain\");\n \n     private final InjectedValue<ApplicationSecurityDomain> applicationSecurityDomain = new InjectedValue<>();\n+    private final InjectedValue<SecurityDomain> securityDomain = new InjectedValue<>();\n+\n     private final DeploymentUnit deploymentUnit;\n-    private Registration registration;\n+\n+    private volatile Runnable cleanUpTask;\n \n     public EJBSecurityDomainService(final DeploymentUnit deploymentUnit) {\n         this.deploymentUnit = deploymentUnit;\n     }\n \n     @Override\n     public synchronized void start(StartContext context) throws StartException {\n-        ApplicationSecurityDomain applicationSecurityDomain = getApplicationSecurityDomain();\n-        BiFunction<String, ClassLoader, Registration> securityFunction = applicationSecurityDomain != null ? applicationSecurityDomain.getSecurityFunction() : null;\n-        if (securityFunction != null) {\n-            final String deploymentName = deploymentUnit.getParent() == null ? deploymentUnit.getName() : deploymentUnit.getParent().getName() + \".\" + deploymentUnit.getName();\n-            final Module module = deploymentUnit.getAttachment(Attachments.MODULE);\n-            final ClassLoader classLoader = module.getClassLoader();\n-            registration = securityFunction.apply(deploymentName, classLoader);\n+        final String deploymentName = deploymentUnit.getParent() == null ? deploymentUnit.getName()\n+                : deploymentUnit.getParent().getName() + \".\" + deploymentUnit.getName();\n+        final Module module = deploymentUnit.getAttachment(Attachments.MODULE);\n+        final ClassLoader classLoader = module.getClassLoader();\n+\n+        ApplicationSecurityDomain applicationSecurityDomain = this.applicationSecurityDomain.getOptionalValue();\n+        if (applicationSecurityDomain != null) {\n+            BiFunction<String, ClassLoader, Registration> securityFunction = applicationSecurityDomain != null ? applicationSecurityDomain.getSecurityFunction() : null;", "originalCommit": "521293d4554c7f1fe5f89a555ea4906f2149e93e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI1ODQ3MQ==", "url": "https://github.com/wildfly/wildfly/pull/13419#discussion_r464258471", "bodyText": "True, I can clean that - there was an intermediate bug during development where that prior line didn't exist.", "author": "darranl", "createdAt": "2020-08-03T08:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk2OTYwNg=="}], "type": "inlineReview"}, {"oid": "01ca145144ba7ba8ec9c090ecf0f829c93611cd1", "url": "https://github.com/wildfly/wildfly/commit/01ca145144ba7ba8ec9c090ecf0f829c93611cd1", "message": "[WFLY-13434] Combine SecurityDomain resolution with capability refactoring under WFLY-13433.", "committedDate": "2020-08-03T14:34:47Z", "type": "commit"}]}