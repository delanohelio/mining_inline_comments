{"pr_number": 13752, "pr_title": "[WFLY-14114] JDBC: deregister all drivers on undeployment", "pr_createdAt": "2020-11-30T11:46:33Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13752", "timeline": [{"oid": "3ca182d18ff51959de84d463d9288fc733def06c", "url": "https://github.com/wildfly/wildfly/commit/3ca182d18ff51959de84d463d9288fc733def06c", "message": "[WFLY-14114] JDBC: deregister all drivers on undeployment", "committedDate": "2020-11-30T16:28:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5Mjg3Mw==", "url": "https://github.com/wildfly/wildfly/pull/13752#discussion_r534092873", "bodyText": "There is an agreed contract that all deployment phases and all processor ids are defined in Phase object.\nFurther more someone in the future might define the same DU processor ID in WildFly Core and it would collide. Please keep the contract.", "author": "ropalka", "createdAt": "2020-12-02T11:24:14Z", "path": "connector/src/main/java/org/jboss/as/connector/deployers/ra/RaDeploymentActivator.java", "diffHunk": "@@ -104,6 +108,7 @@ public void activateProcessors(final DeploymentProcessorTarget updateContext) {\n         updateContext.addDeploymentProcessor(ResourceAdaptersExtension.SUBSYSTEM_NAME, Phase.PARSE, Phase.PARSE_RESOURCE_DEF_ANNOTATION_ADMINISTERED_OBJECT,\n                 new AdministeredObjectDefinitionAnnotationProcessor());\n         updateContext.addDeploymentProcessor(ResourceAdaptersExtension.SUBSYSTEM_NAME, Phase.DEPENDENCIES, Phase.DEPENDENCIES_RAR_CONFIG, new RarDependencyProcessor(appclient));\n+        updateContext.addDeploymentProcessor(ResourceAdaptersExtension.SUBSYSTEM_NAME, Phase.CONFIGURE_MODULE, CONFIGURE_JDBC_DRIVER_MANAGER_ADAPTER, new DriverManagerAdapterProcessor());", "originalCommit": "3ca182d18ff51959de84d463d9288fc733def06c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5MzIyMQ==", "url": "https://github.com/wildfly/wildfly/pull/13752#discussion_r534093221", "bodyText": "Remove this and wait for WildFly Core upgrade.", "author": "ropalka", "createdAt": "2020-12-02T11:24:50Z", "path": "connector/src/main/java/org/jboss/as/connector/deployers/ra/RaDeploymentActivator.java", "diffHunk": "@@ -55,6 +56,9 @@\n  * @author <a href=\"mailto:stefano.maestri@redhat.com\">Stefano Maestri</a>\n  */\n public class RaDeploymentActivator {\n+\n+    public static final int CONFIGURE_JDBC_DRIVER_MANAGER_ADAPTER = 0x0180;", "originalCommit": "3ca182d18ff51959de84d463d9288fc733def06c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDEyMTM2Mw==", "url": "https://github.com/wildfly/wildfly/pull/13752#discussion_r534121363", "bodyText": "+1 in my recent DUP refactorings I have found a number of cases where the IDs used in WildFly don't get passed back to WildFly Core where we say we will come back to it later.\nPlease get a PR raised against WildFly Core and we should be able to get it merged quickly.", "author": "darranl", "createdAt": "2020-12-02T12:14:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5MzIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDEwNDg4Ng==", "url": "https://github.com/wildfly/wildfly/pull/13752#discussion_r534104886", "bodyText": "calling is.close() might produce exception. Please define:\nprivate static void safeClose(final Closeable c) {\n    if (c != null) try { c.close(); } catch (Throwable ignored) {};\n}\n\nand use it instead of InputStream.close() method", "author": "ropalka", "createdAt": "2020-12-02T11:45:40Z", "path": "connector/src/main/java/org/jboss/as/connector/deployers/ds/processors/DriverManagerAdapterProcessor.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2020, Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags. See the copyright.txt file in the\n+ * distribution for a full listing of individual contributors.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.jboss.as.connector.deployers.ds.processors;\n+\n+import org.jboss.as.connector._drivermanager.DriverManagerAdapter;\n+import org.jboss.as.server.deployment.Attachments;\n+import org.jboss.as.server.deployment.DeploymentPhaseContext;\n+import org.jboss.as.server.deployment.DeploymentUnit;\n+import org.jboss.as.server.deployment.DeploymentUnitProcessingException;\n+import org.jboss.as.server.deployment.DeploymentUnitProcessor;\n+import org.jboss.as.server.deployment.module.ModuleSpecification;\n+import org.jboss.modules.AbstractResourceLoader;\n+import org.jboss.modules.ClassSpec;\n+import org.jboss.modules.ResourceLoaderSpec;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+/**\n+ * @author <a href=\"mailto:tadamski@redhat.com\">Tomasz Adamski</a>\n+ * <p>\n+ * https://issues.redhat.com/browse/WFLY-14114\n+ * <p>\n+ * This is a hack that allows us to get access to {@link java.sql.Driver} registered by the driver code. Those objects are created by the\n+ * driver code and registered in {@link java.sql.DriverManager}. Driver objects are not guaranteed to be deregistered which leads to leaks.\n+ * {@link java.sql.DriverManager} allows for obtaining the list of drivers, and deregistering a driver but only in a give classloading context.\n+ * As a result, connector module can not neither list or deregister drivers from a deployed driver module.\n+ * <p>\n+ * To work this around, this hack modifies driver's module by injecting {@link DriverManagerAdapter} class to it. Because @{@link DriverManagerAdapter}\n+ * is loaded by driver module it allows to obtain and deregister the drivers.\n+ */\n+\n+public class DriverManagerAdapterProcessor implements DeploymentUnitProcessor {\n+\n+    @Override\n+    public void deploy(final DeploymentPhaseContext phaseContext) throws DeploymentUnitProcessingException {\n+            final DeploymentUnit deploymentUnit = phaseContext.getDeploymentUnit();\n+            final ModuleSpecification moduleSpecification = deploymentUnit.getAttachment(Attachments.MODULE_SPECIFICATION);\n+            final DriverAdapterResourceLoader resourceLoader = new DriverAdapterResourceLoader();\n+            moduleSpecification.addResourceLoader(ResourceLoaderSpec.createResourceLoaderSpec(resourceLoader));\n+    }\n+\n+    static class DriverAdapterResourceLoader extends AbstractResourceLoader {\n+        @Override\n+        public ClassSpec getClassSpec(final String fileName) throws IOException {\n+            InputStream is = this.getClass().getClassLoader().getResourceAsStream(fileName);\n+            if (is == null) {\n+                return null;\n+            }\n+            final byte[] bytes = readAllBytesFromStream(is);\n+            final ClassSpec spec = new ClassSpec();\n+            spec.setBytes(bytes);\n+            return spec;\n+        }\n+\n+        @Override\n+        public Collection<String> getPaths() {\n+            return Collections.singletonList(DriverManagerAdapter.class.getPackage().getName().replace('.','/'));\n+        }\n+\n+        private static byte[] readAllBytesFromStream(final InputStream is) throws IOException {\n+            ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+            try {\n+                final byte[] buffer = new byte[1024];\n+                int read = 0;\n+                while ((read = is.read(buffer)) != -1) {\n+                    bos.write(buffer, 0, read);\n+                }\n+                return bos.toByteArray();\n+            } finally {\n+                is.close();", "originalCommit": "3ca182d18ff51959de84d463d9288fc733def06c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "14ff2150e2825f86a0373a0aadb5961a4690dd85", "url": "https://github.com/wildfly/wildfly/commit/14ff2150e2825f86a0373a0aadb5961a4690dd85", "message": "[WFLY-14114] JDBC: deregister all drivers on undeployment", "committedDate": "2020-12-02T12:34:35Z", "type": "forcePushed"}, {"oid": "533c4399421928f16093dd42891b2c3c72b1def6", "url": "https://github.com/wildfly/wildfly/commit/533c4399421928f16093dd42891b2c3c72b1def6", "message": "[WFLY-14114] JDBC: deregister all drivers on undeployment", "committedDate": "2020-12-07T10:58:36Z", "type": "commit"}, {"oid": "533c4399421928f16093dd42891b2c3c72b1def6", "url": "https://github.com/wildfly/wildfly/commit/533c4399421928f16093dd42891b2c3c72b1def6", "message": "[WFLY-14114] JDBC: deregister all drivers on undeployment", "committedDate": "2020-12-07T10:58:36Z", "type": "forcePushed"}]}