{"pr_number": 12900, "pr_title": "WFLY-12958 Calling Asynchronous EJB will use the propagated caller tr\u2026", "pr_createdAt": "2020-01-11T02:32:53Z", "pr_url": "https://github.com/wildfly/wildfly/pull/12900", "timeline": [{"oid": "11b737517a4e8e240f9b84b6955d9c0959cd1384", "url": "https://github.com/wildfly/wildfly/commit/11b737517a4e8e240f9b84b6955d9c0959cd1384", "message": "WFLY-12958 Calling Asynchronous EJB will use the propagated caller transaction which is not according to the specification", "committedDate": "2020-01-11T02:27:05Z", "type": "commit"}, {"oid": "b5d8eda3ae6ff639de57b22fa168996e74608719", "url": "https://github.com/wildfly/wildfly/commit/b5d8eda3ae6ff639de57b22fa168996e74608719", "message": "WFLY-12958 For Asynchronous EJB methods treat transaction attribute REQUIRED as REQUIRES_NEW since the caller's transaction context is not propagated.", "committedDate": "2020-01-12T03:39:35Z", "type": "commit"}, {"oid": "707801c3ceaae6709987ab07b23778fb0efcaf01", "url": "https://github.com/wildfly/wildfly/commit/707801c3ceaae6709987ab07b23778fb0efcaf01", "message": "WFLY-12958 add test to verify transaction attribute REQUIRED for async method.", "committedDate": "2020-01-13T21:17:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI0NTYwOQ==", "url": "https://github.com/wildfly/wildfly/pull/12900#discussion_r366245609", "bodyText": "How did we get to the point of having a tx here during an async invocation?", "author": "wolfc", "createdAt": "2020-01-14T09:59:51Z", "path": "ejb3/src/main/java/org/jboss/as/ejb3/tx/CMTTxInterceptor.java", "diffHunk": "@@ -141,6 +144,15 @@ public Object processInvocation(InterceptorContext invocation) throws Exception\n                 case NOT_SUPPORTED:\n                     return notSupported(invocation, component);\n                 case REQUIRED:\n+                    final ComponentView view = invocation.getPrivateData(ComponentView.class);\n+                    if (view != null && view.isAsynchronous(method)) {\n+                        // EJB 3.2 4.5.3 Transactions\n+                        // The client\u2019s transaction context does not propagate with an asynchronous method invocation. From the\n+                        // Bean Provider\u2019s point of view, there is never a transaction context flowing in from the client. This\n+                        // means, for example, that the semantics of the REQUIRED transaction attribute on an asynchronous\n+                        // method are exactly the same as REQUIRES_NEW.\n+                        return requiresNew(invocation, component, timeoutInSeconds);", "originalCommit": "707801c3ceaae6709987ab07b23778fb0efcaf01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQzNzE5Nw==", "url": "https://github.com/wildfly/wildfly/pull/12900#discussion_r366437197", "bodyText": "Not sure why, it could be some missed check during earlier part of invocation chain. I'll look into it.", "author": "chengfang", "createdAt": "2020-01-14T16:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI0NTYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI0NjI2Mg==", "url": "https://github.com/wildfly/wildfly/pull/12900#discussion_r366246262", "bodyText": "You hold the Future, so better use it.", "author": "wolfc", "createdAt": "2020-01-14T10:01:03Z", "path": "testsuite/integration/multinode/src/test/java/org/jboss/as/test/multinode/transaction/async/ClientBean.java", "diffHunk": "@@ -84,10 +84,28 @@ public void callToStatusByTransactionmanager() throws Exception {\n         final TransactionalRemote remote = getRemote(TransactionalStatusByManager.class);\n         userTransaction.begin();\n         try {\n-            Assert.assertEquals(\"No transaction expected as async call does not pass txn context\",\n+            assertEquals(\"No transaction expected as async call does not pass txn context\",\n                     (Integer) Status.STATUS_NO_TRANSACTION, remote.transactionStatus().get());\n         } finally {\n             userTransaction.rollback();\n         }\n     }\n+\n+    /**\n+     * Verifies async method invocation with REQUIRED transaction attribute.\n+     * The client transaction context should not be propagated to the invoked async method.\n+     * The invoked async method should execute in a new, separate transaction context.\n+     */\n+    public void callToRequired() throws Exception {\n+        final TransactionalRemote remote = getRemote(TransactionalStatusByManager.class);\n+        userTransaction.begin();\n+\n+        // asyncWithRequired() will throw RuntimeException and cause its transaction to rollback.\n+        // But it has no bearing on the transaction here, which should be able to commit okay.\n+        remote.asyncWithRequired();\n+\n+        // wait a bit for the transaction in asyncWithRequired method to rollback\n+        Thread.sleep(1000);", "originalCommit": "707801c3ceaae6709987ab07b23778fb0efcaf01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQzNjExNQ==", "url": "https://github.com/wildfly/wildfly/pull/12900#discussion_r366436115", "bodyText": "asyncWithRequired method returns void since it just throws a RuntimeException with no need to return a value. We could add a return value and use get() instead of sleep().", "author": "chengfang", "createdAt": "2020-01-14T16:21:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI0NjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUwNDE5NQ==", "url": "https://github.com/wildfly/wildfly/pull/12900#discussion_r366504195", "bodyText": "Get instead of sleep would definitely be preferred as sleep could be racy.", "author": "jamezp", "createdAt": "2020-01-14T18:35:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI0NjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcxOTUyMQ==", "url": "https://github.com/wildfly/wildfly/pull/12900#discussion_r366719521", "bodyText": "If it did return void, then we have another issue. It should be throwing an ExecutionException.\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ExecutionException.html", "author": "wolfc", "createdAt": "2020-01-15T06:59:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI0NjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0NzkxMw==", "url": "https://github.com/wildfly/wildfly/pull/12900#discussion_r366847913", "bodyText": "When it returns void, I think it should just be a fire-and-forget on the client side, and whatever happened in the target method is not visible to the client at all.  The ExecutionException is available via the get() method when the method returns a Future.", "author": "chengfang", "createdAt": "2020-01-15T12:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI0NjI2Mg=="}], "type": "inlineReview"}]}