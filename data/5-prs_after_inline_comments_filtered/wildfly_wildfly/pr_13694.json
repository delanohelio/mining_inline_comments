{"pr_number": 13694, "pr_title": "[WFLY-14034] FIx Health checks when RBAC is enabled", "pr_createdAt": "2020-11-09T09:31:42Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13694", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3MDQ4Nw==", "url": "https://github.com/wildfly/wildfly/pull/13694#discussion_r519670487", "bodyText": "I haven't got time today to check into the code but I suspect this will be triggering a permissions check here.\nThe normal reaction to that would be \"I must add a doProvileged\" but I think this code is correct as the complete call stack will be initiated from the management endpoint.\nBut assuming my two assumptions are true it may be worth adding a comment so no one helpfully adds a \"missing doPrivileged\" at a later point.", "author": "darranl", "createdAt": "2020-11-09T09:38:13Z", "path": "microprofile/health-smallrye/src/main/java/org/wildfly/extension/microprofile/health/HealthReporterService.java", "diffHunk": "@@ -85,7 +85,7 @@ public void start(StartContext context) {\n         final boolean defaultServerProceduresDisabled = ConfigProvider.getConfig().getOptionalValue(\"mp.health.disable-default-procedures\", Boolean.class).orElse(false);\n         healthReporter = new HealthReporter(emptyLivenessChecksStatus, emptyReadinessChecksStatus, defaultServerProceduresDisabled);\n \n-        modelControllerClient = modelControllerClientFactory.get().createClient(managementExecutor.get());\n+        modelControllerClient = modelControllerClientFactory.get().createSuperUserClient(managementExecutor.get(), true);", "originalCommit": "3ab1c3d01650c66321a2e6fae7e1d78d7335dfe2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3NTU4OA==", "url": "https://github.com/wildfly/wildfly/pull/13694#discussion_r519675588", "bodyText": "@darranl I've added a comment based on your remark.\nI've manually tested that if RBAC is enabled, this code works (when security-enabled is false).\nWhen security-enabled is true, the authentication fails when the HTTP endpoint is accessed and this code is not invoked.", "author": "jmesnil", "createdAt": "2020-11-09T09:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3MDQ4Nw=="}], "type": "inlineReview"}, {"oid": "a02dbb04a8e3802c7d44e00258a643b49415b9c6", "url": "https://github.com/wildfly/wildfly/commit/a02dbb04a8e3802c7d44e00258a643b49415b9c6", "message": "[WFLY-14034] FIx Health checks when RBAC is enabled\n\nCreate a LocalModelControllerClient by calling createSuperUserClient so\nthat the server readiness checks can be performed even when RBAC is\nenabled.\nThis local client is used only by server checks hard-coded in the\nServerReadinessProbes probes.\n\nJIRA: https://issues.redhat.com/browse/WFLY-14034\n\nSigned-off-by: Jeff Mesnil <jmesnil@redhat.com>", "committedDate": "2020-11-09T09:43:56Z", "type": "commit"}, {"oid": "a02dbb04a8e3802c7d44e00258a643b49415b9c6", "url": "https://github.com/wildfly/wildfly/commit/a02dbb04a8e3802c7d44e00258a643b49415b9c6", "message": "[WFLY-14034] FIx Health checks when RBAC is enabled\n\nCreate a LocalModelControllerClient by calling createSuperUserClient so\nthat the server readiness checks can be performed even when RBAC is\nenabled.\nThis local client is used only by server checks hard-coded in the\nServerReadinessProbes probes.\n\nJIRA: https://issues.redhat.com/browse/WFLY-14034\n\nSigned-off-by: Jeff Mesnil <jmesnil@redhat.com>", "committedDate": "2020-11-09T09:43:56Z", "type": "forcePushed"}]}