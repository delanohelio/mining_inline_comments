{"pr_number": 13471, "pr_title": "WFLY-13736 Force weld restart more eagerly", "pr_createdAt": "2020-08-07T22:24:20Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13471", "timeline": [{"oid": "e1282e10107221ecdcab9a84d552914cfc269d0a", "url": "https://github.com/wildfly/wildfly/commit/e1282e10107221ecdcab9a84d552914cfc269d0a", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB", "committedDate": "2021-01-27T05:35:23Z", "type": "forcePushed"}, {"oid": "e6b30f4dd69b23a162686e64f9fb0f8d1f89b097", "url": "https://github.com/wildfly/wildfly/commit/e6b30f4dd69b23a162686e64f9fb0f8d1f89b097", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB", "committedDate": "2021-01-28T01:00:04Z", "type": "forcePushed"}, {"oid": "9ce61a12ceb336f4633ceda1b76cc994034f21af", "url": "https://github.com/wildfly/wildfly/commit/9ce61a12ceb336f4633ceda1b76cc994034f21af", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB", "committedDate": "2021-01-28T04:20:33Z", "type": "forcePushed"}, {"oid": "4648457c7867f762448a2ced6e492837d97241e2", "url": "https://github.com/wildfly/wildfly/commit/4648457c7867f762448a2ced6e492837d97241e2", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB", "committedDate": "2021-01-28T05:53:32Z", "type": "forcePushed"}, {"oid": "5b590b5522c0c9c2977486f6fa4299591b4dff48", "url": "https://github.com/wildfly/wildfly/commit/5b590b5522c0c9c2977486f6fa4299591b4dff48", "message": "WFLY-13736 Force weld restart more eagerly\n\nThe avoids a situation where services that depend on the bootstrap\nservice will attempt to start and will fail as the service is no\nlonger usable", "committedDate": "2021-01-28T21:08:09Z", "type": "commit"}, {"oid": "9d5f0a390c23c1c9c330bc4ea4d2175ccd1527e4", "url": "https://github.com/wildfly/wildfly/commit/9d5f0a390c23c1c9c330bc4ea4d2175ccd1527e4", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB", "committedDate": "2021-01-28T21:08:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODMwNzUwOQ==", "url": "https://github.com/wildfly/wildfly/pull/13471#discussion_r568307509", "bodyText": "@stuartwdouglas Can this result in listenerDone not completing and fakeStabilityService leaking?", "author": "bstansberry", "createdAt": "2021-02-02T04:02:51Z", "path": "weld/subsystem/src/main/java/org/jboss/as/weld/WeldBootstrapService.java", "diffHunk": "@@ -236,8 +305,91 @@ public boolean isStarted() {\n         return started;\n     }\n \n-    void setStarted(boolean started) {\n-        this.started = started;\n+    void startServiceShutdown() {\n+        //the start service has been shutdown, which means either we are being shutdown/undeployed\n+        //or we are going to need to bounce the whole deployment\n+        this.started = false;\n+        if (controller.getServiceContainer().isShutdown()) {\n+            //container is being shutdown, no action required\n+            return;\n+        }\n+        ServiceController<?> deploymentController = controller.getServiceContainer().getService(deploymentServiceName);\n+        if (deploymentController.getMode() != ServiceController.Mode.ACTIVE) {\n+            //deployment is not active, no action required\n+            return;\n+        }\n+        //add a listener to tentatively 'bounce' this service\n+        //if the service does actually restart then this will trigger a full deployment restart\n+        //we do it this way as we don't have visibility into MSC in the general sense\n+        //so we don't really know if this service is supposed to go away\n+        //this 'potential bounce' is hard to do in a non-racey manner\n+        //we need to add the listener first, but the listener may be invoked before the CAS to never\n+        CompletableFuture<Boolean> attemptingBounce = new CompletableFuture();\n+\n+        try {\n+            CompletableFuture<Boolean> listenerDone = new CompletableFuture<>();\n+            LifecycleListener listener = new LifecycleListener() {\n+                @Override\n+                public void handleEvent(final ServiceController<?> controller, final LifecycleEvent event) {\n+                    try {\n+                        try {\n+                            if (controller.getServiceContainer().isShutdown() || !attemptingBounce.get()) {\n+                                controller.removeListener(this);\n+                                return;\n+                            }\n+                        } catch (InterruptedException | ExecutionException e) {\n+                            throw new RuntimeException(e);\n+                        }\n+                        if (deploymentController.getMode() != ServiceController.Mode.ACTIVE ||\n+                                controller.getMode() == ServiceController.Mode.REMOVE) {\n+                            return;\n+                        }\n+                        if (event == LifecycleEvent.DOWN) {\n+                            controller.removeListener(this);\n+                            do {\n+                                if (controller.getMode() != ServiceController.Mode.NEVER) {\n+                                    return;\n+                                }\n+                            } while (!controller.compareAndSetMode(ServiceController.Mode.NEVER, ServiceController.Mode.ACTIVE));\n+                        }\n+                    } finally {\n+                        listenerDone.complete(true);\n+                    }\n+                }\n+            };\n+            //\n+            controller.getServiceContainer().addService(controller.getName().append(\"fakeStabilityService\")).setInstance(new Service() {\n+                @Override\n+                public void start(StartContext context) throws StartException {\n+                    context.asynchronous();\n+                    listenerDone.handle(new BiFunction<Boolean, Throwable, Object>() {\n+                        @Override\n+                        public Object apply(Boolean aBoolean, Throwable throwable) {\n+                            context.getController().setMode(ServiceController.Mode.REMOVE);\n+                            context.complete();\n+                            return null;\n+                        }\n+                    });\n+                }\n+\n+                @Override\n+                public void stop(StopContext context) {\n+\n+                }\n+            }).install();\n+            controller.addListener(listener);\n+            if (!controller.compareAndSetMode(ServiceController.Mode.ACTIVE, ServiceController.Mode.NEVER)) {\n+                controller.removeListener(listener);", "originalCommit": "9d5f0a390c23c1c9c330bc4ea4d2175ccd1527e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODMxMTAxNw==", "url": "https://github.com/wildfly/wildfly/pull/13471#discussion_r568311017", "bodyText": "Yes, fixed.\nThis whole thing is a horrible hack.", "author": "stuartwdouglas", "createdAt": "2021-02-02T04:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODMwNzUwOQ=="}], "type": "inlineReview"}, {"oid": "64b82e1a0bdb187f5f354fc06cd6d8fa319cdada", "url": "https://github.com/wildfly/wildfly/commit/64b82e1a0bdb187f5f354fc06cd6d8fa319cdada", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB", "committedDate": "2021-02-02T04:07:53Z", "type": "commit"}, {"oid": "64b82e1a0bdb187f5f354fc06cd6d8fa319cdada", "url": "https://github.com/wildfly/wildfly/commit/64b82e1a0bdb187f5f354fc06cd6d8fa319cdada", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB", "committedDate": "2021-02-02T04:07:53Z", "type": "forcePushed"}]}