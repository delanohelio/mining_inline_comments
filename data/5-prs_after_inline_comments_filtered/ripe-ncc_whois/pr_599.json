{"pr_number": 599, "pr_title": "abusec contact  only for ripe sources", "pr_createdAt": "2020-01-28T08:53:39Z", "pr_url": "https://github.com/RIPE-NCC/whois/pull/599", "timeline": [{"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "url": "https://github.com/RIPE-NCC/whois/commit/534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "message": "abusec contact  only for ripe sources", "committedDate": "2020-01-27T15:34:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTYzOA==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380131638", "bodyText": "I suggest using the built-in wrapper java.util.Collections.unmodifiableSet() instead of guava", "author": "eshryane", "createdAt": "2020-02-17T11:35:54Z", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -1,5 +1,6 @@\n package net.ripe.db.whois.query.planner;\n \n+import com.google.common.collect.ImmutableSet;", "originalCommit": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0MzE1MQ==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r385043151", "bodyText": "Collections.unmodifiableSet() still can be changed as its a view that's why i usually prefer immutable set", "author": "maggarwal13", "createdAt": "2020-02-27T10:36:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY5ODY0OQ==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r385698649", "bodyText": "A view is fine, if you don't have any other references to the actual set (i.e. wrap creating the Set in a method, and return the view). We shouldn't have multiple ways to do the same thing in the code. But here it's not a big deal.", "author": "eshryane", "createdAt": "2020-02-28T13:37:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTk4NQ==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380131985", "bodyText": "Return generic Set<> in method signature (the immutable property is a detail)", "author": "eshryane", "createdAt": "2020-02-17T11:36:38Z", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {", "originalCommit": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMjQ4MQ==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380132481", "bodyText": "whois.source is mandatory (although it could be empty it's unlikely!), no need for a check.", "author": "eshryane", "createdAt": "2020-02-17T11:37:54Z", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {\n+        ImmutableSet.Builder<CIString> sourceBuilder  = new ImmutableSet.Builder<>();\n+\n+        if(StringUtils.isNotEmpty(mainSource)) {", "originalCommit": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMjczMg==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380132732", "bodyText": "I'd just automatically add a GRS source as mainsource + \"GRS\", no need to check if one is configured", "author": "eshryane", "createdAt": "2020-02-17T11:38:30Z", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {\n+        ImmutableSet.Builder<CIString> sourceBuilder  = new ImmutableSet.Builder<>();\n+\n+        if(StringUtils.isNotEmpty(mainSource)) {\n+            sourceBuilder.add(CIString.ciString(mainSource));\n+        }\n+\n+        if(StringUtils.isNotEmpty(nonAuthSource)) {\n+            sourceBuilder.add(CIString.ciString(nonAuthSource));\n+        }\n+\n+        final String matchingGrs = mainSource+ \"-GRS\";", "originalCommit": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMzA1MA==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380133050", "bodyText": "I'd call this property \"mainSources\" as it's not necessarily called \"ripe\"", "author": "eshryane", "createdAt": "2020-02-17T11:39:15Z", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -34,9 +38,13 @@\n     private final Ipv6Tree ipv6Tree;\n     private final Maintainers maintainers;\n     private final AbuseValidationStatusDao abuseValidationStatusDao;\n+    private final ImmutableSet<CIString> ripeSources;", "originalCommit": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMzI0MQ==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380133241", "bodyText": "Also rename method to \"getMainSources...\"", "author": "eshryane", "createdAt": "2020-02-17T11:39:41Z", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {", "originalCommit": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMzQzMw==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380133433", "bodyText": "Good pattern (return early)!", "author": "eshryane", "createdAt": "2020-02-17T11:40:11Z", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -106,6 +134,10 @@ private boolean isLir(@Nullable final RpslObject rpslObject) {\n     @CheckForNull\n     @Nullable\n     public RpslObject getAbuseContactRole(final RpslObject rpslObject) {\n+        if(!ripeSources.contains(rpslObject.getValueForAttribute(AttributeType.SOURCE))) {", "originalCommit": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNDU1Ng==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380134556", "bodyText": "Don't make reference to \"RIPE\" as the source, but something like 'NON-TEST' or 'INVALID'", "author": "eshryane", "createdAt": "2020-02-17T11:42:54Z", "path": "whois-query/src/test/java/net/ripe/db/whois/query/integration/AbuseCTestIntegration.java", "diffHunk": "@@ -239,4 +240,66 @@ public void brief_query_shows_abusemailbox_twice() {\n         final String briefResponse = TelnetWhoisClient.queryLocalhost(QueryServer.port, \"-b 193.0.0.0\");\n         assertThat(briefResponse, not(containsString(\"notshown@abuse.net\")));\n     }\n+    @Test\n+    public void should_not_lookup_abuseC_if_rpsl_source_do_not_match() {\n+\n+        databaseHelper.updateObject(RpslObject.parse( \"inetnum:       173.0.0.0 - 173.255.255.255\\n\" +", "originalCommit": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNDY4OA==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380134688", "bodyText": "Use Set", "author": "eshryane", "createdAt": "2020-02-17T11:43:11Z", "path": "whois-query/src/test/java/net/ripe/db/whois/query/planner/AbuseCFinderTest.java", "diffHunk": "@@ -1,6 +1,7 @@\n package net.ripe.db.whois.query.planner;\n \n \n+import com.google.common.collect.ImmutableSet;", "originalCommit": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY5OTAwNg==", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r385699006", "bodyText": "As above, not a big deal.", "author": "eshryane", "createdAt": "2020-02-28T13:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNDY4OA=="}], "type": "inlineReview"}, {"oid": "aab12a42da6333a1cb7d8e64ee85031b8345b397", "url": "https://github.com/RIPE-NCC/whois/commit/aab12a42da6333a1cb7d8e64ee85031b8345b397", "message": "implement Ed suggestions", "committedDate": "2020-02-27T10:44:03Z", "type": "commit"}, {"oid": "8c19d1b6a47be992a4fb3ed6d052bc5474ec3563", "url": "https://github.com/RIPE-NCC/whois/commit/8c19d1b6a47be992a4fb3ed6d052bc5474ec3563", "message": "Merge branch 'master' into abuseC_only_ripe_source", "committedDate": "2020-02-27T12:14:33Z", "type": "commit"}, {"oid": "bfabb85f49e2b71fee1f8145a8014a37ebfbd985", "url": "https://github.com/RIPE-NCC/whois/commit/bfabb85f49e2b71fee1f8145a8014a37ebfbd985", "message": "fix junit test cases", "committedDate": "2020-02-27T13:58:50Z", "type": "commit"}]}