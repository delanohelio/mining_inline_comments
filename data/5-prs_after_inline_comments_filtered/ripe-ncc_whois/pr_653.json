{"pr_number": 653, "pr_title": "Aws ripe profile", "pr_createdAt": "2020-08-21T08:52:51Z", "pr_url": "https://github.com/RIPE-NCC/whois/pull/653", "timeline": [{"oid": "850c8732972e3c2685b92f00c547a8eade7c1b99", "url": "https://github.com/RIPE-NCC/whois/commit/850c8732972e3c2685b92f00c547a8eade7c1b99", "message": "use aws profile and ripe profile", "committedDate": "2020-08-20T13:08:53Z", "type": "commit"}, {"oid": "286e58106d36c65e5029745717270a47e4eb9bdc", "url": "https://github.com/RIPE-NCC/whois/commit/286e58106d36c65e5029745717270a47e4eb9bdc", "message": "add todo", "committedDate": "2020-08-20T13:22:47Z", "type": "commit"}, {"oid": "4569499f1572b0df45462e745185bd8b24323e7b", "url": "https://github.com/RIPE-NCC/whois/commit/4569499f1572b0df45462e745185bd8b24323e7b", "message": "remove propertysource for aws profile", "committedDate": "2020-08-24T14:35:59Z", "type": "commit"}, {"oid": "8fb6b7294ec8d7060185434697133f829e848aaa", "url": "https://github.com/RIPE-NCC/whois/commit/8fb6b7294ec8d7060185434697133f829e848aaa", "message": "Merge branch 'aws' into aws_ripe_profile", "committedDate": "2020-08-25T11:46:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM5ODc4Mg==", "url": "https://github.com/RIPE-NCC/whois/pull/653#discussion_r476398782", "bodyText": "Should be provided as a environment variable (hopefully automatically).", "author": "sbusk", "createdAt": "2020-08-25T12:10:28Z", "path": "whois-commons/src/main/java/net/ripe/db/whois/common/WhoisAWSPropertyResolver.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package net.ripe.db.whois.common;\n+\n+import com.amazonaws.services.simplesystemsmanagement.AWSSimpleSystemsManagement;\n+import com.amazonaws.services.simplesystemsmanagement.AWSSimpleSystemsManagementClient;\n+import com.amazonaws.services.simplesystemsmanagement.model.GetParametersByPathRequest;\n+import com.amazonaws.services.simplesystemsmanagement.model.GetParametersByPathResult;\n+import com.amazonaws.services.simplesystemsmanagement.model.Parameter;\n+import net.ripe.db.whois.common.profiles.WhoisProfile;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.context.annotation.PropertySource;\n+import org.springframework.context.support.PropertySourcesPlaceholderConfigurer;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.stream.Collectors;\n+\n+@Configuration\n+@Profile(WhoisProfile.AWS_DEPLOYED)\n+@PropertySource(value = \"classpath:version.properties\", ignoreResourceNotFound = true)\n+public class WhoisAWSPropertyResolver {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(WhoisAWSPropertyResolver.class);\n+\n+    //TODO: get region to deploy from gitlab", "originalCommit": "4569499f1572b0df45462e745185bd8b24323e7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM5OTI2Nw==", "url": "https://github.com/RIPE-NCC/whois/pull/653#discussion_r476399267", "bodyText": "If encryption is only ever true, why pass it as an argument?", "author": "sbusk", "createdAt": "2020-08-25T12:11:26Z", "path": "whois-commons/src/main/java/net/ripe/db/whois/common/WhoisAWSPropertyResolver.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package net.ripe.db.whois.common;\n+\n+import com.amazonaws.services.simplesystemsmanagement.AWSSimpleSystemsManagement;\n+import com.amazonaws.services.simplesystemsmanagement.AWSSimpleSystemsManagementClient;\n+import com.amazonaws.services.simplesystemsmanagement.model.GetParametersByPathRequest;\n+import com.amazonaws.services.simplesystemsmanagement.model.GetParametersByPathResult;\n+import com.amazonaws.services.simplesystemsmanagement.model.Parameter;\n+import net.ripe.db.whois.common.profiles.WhoisProfile;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.context.annotation.PropertySource;\n+import org.springframework.context.support.PropertySourcesPlaceholderConfigurer;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.stream.Collectors;\n+\n+@Configuration\n+@Profile(WhoisProfile.AWS_DEPLOYED)\n+@PropertySource(value = \"classpath:version.properties\", ignoreResourceNotFound = true)\n+public class WhoisAWSPropertyResolver {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(WhoisAWSPropertyResolver.class);\n+\n+    //TODO: get region to deploy from gitlab\n+    private static final String REGION = \"eu-central-1\";\n+\n+    @Bean\n+    public static PropertySourcesPlaceholderConfigurer properties(){\n+        LOGGER.info(\"AWS profile : using ssm parameter store \");\n+\n+        Properties properties = new Properties();\n+        properties.putAll( getParametersByEnvAndApp(\"/whois/\", true));\n+\n+        PropertySourcesPlaceholderConfigurer propertySourceConfig = new PropertySourcesPlaceholderConfigurer();\n+        propertySourceConfig.setProperties(properties);\n+\n+        return propertySourceConfig;\n+    }\n+\n+    public static Map<String, Object> getParametersByEnvAndApp(final String path, final boolean encryption) {", "originalCommit": "4569499f1572b0df45462e745185bd8b24323e7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQwMDMwMg==", "url": "https://github.com/RIPE-NCC/whois/pull/653#discussion_r476400302", "bodyText": "ok, I will make it default true always, as it needs to decrypt the passwords", "author": "maggarwal13", "createdAt": "2020-08-25T12:13:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM5OTI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM5OTYwMw==", "url": "https://github.com/RIPE-NCC/whois/pull/653#discussion_r476399603", "bodyText": "Nitpicking here but .withPath(...) should be on next line.", "author": "sbusk", "createdAt": "2020-08-25T12:11:56Z", "path": "whois-commons/src/main/java/net/ripe/db/whois/common/WhoisAWSPropertyResolver.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package net.ripe.db.whois.common;\n+\n+import com.amazonaws.services.simplesystemsmanagement.AWSSimpleSystemsManagement;\n+import com.amazonaws.services.simplesystemsmanagement.AWSSimpleSystemsManagementClient;\n+import com.amazonaws.services.simplesystemsmanagement.model.GetParametersByPathRequest;\n+import com.amazonaws.services.simplesystemsmanagement.model.GetParametersByPathResult;\n+import com.amazonaws.services.simplesystemsmanagement.model.Parameter;\n+import net.ripe.db.whois.common.profiles.WhoisProfile;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.context.annotation.PropertySource;\n+import org.springframework.context.support.PropertySourcesPlaceholderConfigurer;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.stream.Collectors;\n+\n+@Configuration\n+@Profile(WhoisProfile.AWS_DEPLOYED)\n+@PropertySource(value = \"classpath:version.properties\", ignoreResourceNotFound = true)\n+public class WhoisAWSPropertyResolver {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(WhoisAWSPropertyResolver.class);\n+\n+    //TODO: get region to deploy from gitlab\n+    private static final String REGION = \"eu-central-1\";\n+\n+    @Bean\n+    public static PropertySourcesPlaceholderConfigurer properties(){\n+        LOGGER.info(\"AWS profile : using ssm parameter store \");\n+\n+        Properties properties = new Properties();\n+        properties.putAll( getParametersByEnvAndApp(\"/whois/\", true));\n+\n+        PropertySourcesPlaceholderConfigurer propertySourceConfig = new PropertySourcesPlaceholderConfigurer();\n+        propertySourceConfig.setProperties(properties);\n+\n+        return propertySourceConfig;\n+    }\n+\n+    public static Map<String, Object> getParametersByEnvAndApp(final String path, final boolean encryption) {\n+        final AWSSimpleSystemsManagement awsSimpleSystemsManagement = AWSSimpleSystemsManagementClient.builder()\n+                .withRegion(REGION).build();\n+\n+        final GetParametersByPathRequest getParametersByPathRequest = new GetParametersByPathRequest().withPath(path)", "originalCommit": "4569499f1572b0df45462e745185bd8b24323e7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3a59f7a56b5c3e4ba7d2b5e50d68d5c6925da382", "url": "https://github.com/RIPE-NCC/whois/commit/3a59f7a56b5c3e4ba7d2b5e50d68d5c6925da382", "message": "basic refactoring", "committedDate": "2020-08-25T12:19:02Z", "type": "commit"}, {"oid": "a270fa8c73d9d863a4d0375de80e12ce7822b1a9", "url": "https://github.com/RIPE-NCC/whois/commit/a270fa8c73d9d863a4d0375de80e12ce7822b1a9", "message": "remove hard coded spring profile", "committedDate": "2020-08-25T12:28:42Z", "type": "commit"}, {"oid": "90cca63402343aff083db47b1576e5fc08e12c89", "url": "https://github.com/RIPE-NCC/whois/commit/90cca63402343aff083db47b1576e5fc08e12c89", "message": "use env variable for aws region", "committedDate": "2020-08-27T11:22:04Z", "type": "commit"}]}