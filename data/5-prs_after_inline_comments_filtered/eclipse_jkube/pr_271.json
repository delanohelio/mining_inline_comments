{"pr_number": 271, "pr_title": "Fix #246: Dockerfile custom interpolation is broken", "pr_createdAt": "2020-07-01T12:51:38Z", "pr_url": "https://github.com/eclipse/jkube/pull/271", "timeline": [{"oid": "41ffcb39f1238b82b630cd559d066f937846859e", "url": "https://github.com/eclipse/jkube/commit/41ffcb39f1238b82b630cd559d066f937846859e", "message": "Fix #246: Dockerfile custom interpolation is broken", "committedDate": "2020-07-03T07:04:22Z", "type": "forcePushed"}, {"oid": "fb35e862a199039147960e8797f4fdb6e40527af", "url": "https://github.com/eclipse/jkube/commit/fb35e862a199039147960e8797f4fdb6e40527af", "message": "Fix #246: Dockerfile custom interpolation is broken", "committedDate": "2020-07-03T14:14:56Z", "type": "forcePushed"}, {"oid": "e6e7d05d177636e11d51405535c841424f239af8", "url": "https://github.com/eclipse/jkube/commit/e6e7d05d177636e11d51405535c841424f239af8", "message": "Fix #246: Dockerfile custom interpolation is broken", "committedDate": "2020-07-07T11:21:52Z", "type": "forcePushed"}, {"oid": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5", "url": "https://github.com/eclipse/jkube/commit/dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5", "message": "Fix #246: Dockerfile custom interpolation is broken", "committedDate": "2020-07-07T11:35:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgwMzQ5NA==", "url": "https://github.com/eclipse/jkube/pull/271#discussion_r450803494", "bodyText": "No longer used, since we have `public static String interpolate(File dockerFile, Properties properties, String filter) throws IOException {, please remove (test too)", "author": "manusa", "createdAt": "2020-07-07T11:45:53Z", "path": "jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/DockerFileUtil.java", "diffHunk": "@@ -103,15 +102,36 @@ private DockerFileUtil() {}\n      *\n      * @param dockerFile docker file to interpolate.\n      * @param properties properties to interpolate in the provided dockerFile.\n+     * @param filter filter for parsing properties from Dockerfile\n+     * @return The interpolated contents of the file.\n+     * @throws IOException if there's a problem while performin IO operations.\n+     */\n+    public static String interpolate(File dockerFile, Properties properties, String filter) throws IOException {\n+        StringBuilder ret = new StringBuilder();\n+        try (BufferedReader reader = new BufferedReader(new FileReader(dockerFile))) {\n+            String line;\n+            while ((line = reader.readLine()) != null) {\n+                ret.append(JKubeDockerfileInterpolator.interpolate(line, properties, filter)).append(System.lineSeparator());\n+            }\n+        }\n+        return ret.toString();\n+    }\n+\n+     /**\n+     * Interpolate a docker file with the given properties and filter\n+     *\n+     * @param dockerFile docker file to interpolate.\n+     * @param properties properties to interpolate in the provided dockerFile.\n+      * @param customInterpolationParams additional delimiters for interpolation\n      * @return The interpolated contents of the file.\n      * @throws IOException if there's a problem while performin IO operations.\n      */\n-    public static String interpolate(File dockerFile, Properties properties) throws IOException {\n+    public static String interpolate(File dockerFile, Properties properties, Map<String, String> customInterpolationParams) throws IOException {\n         StringBuilder ret = new StringBuilder();\n         try (BufferedReader reader = new BufferedReader(new FileReader(dockerFile))) {\n             String line;\n             while ((line = reader.readLine()) != null) {\n-                ret.append(JKubeDockerfileInterpolator.interpolate(line, properties)).append(System.lineSeparator());\n+                ret.append(JKubeDockerfileInterpolator.interpolate(line, properties, customInterpolationParams)).append(System.lineSeparator());", "originalCommit": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgwMzgxOQ==", "url": "https://github.com/eclipse/jkube/pull/271#discussion_r450803819", "bodyText": "Unused code, please remove", "author": "manusa", "createdAt": "2020-07-07T11:46:29Z", "path": "jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/JKubeDockerfileInterpolator.java", "diffHunk": "@@ -13,37 +13,197 @@\n  */\n package org.eclipse.jkube.kit.build.service.docker.helper;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Properties;\n \n public class JKubeDockerfileInterpolator {\n-    private static Map<String, String> delimiters;\n-    static {\n-        delimiters = new HashMap<>();\n-        delimiters.put(\"@\", \"@\");\n-        delimiters.put(\"${\", \"}\");\n-    }\n \n     private JKubeDockerfileInterpolator() { }\n \n-    public static String interpolate(String line, Properties properties) {\n+    public static String interpolate(String line, Map<String, String> context, String filter) {\n+        return interpolate(line, context, getExpressionMarkersFromFilter(filter));\n+    }", "originalCommit": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgwNDkyNA==", "url": "https://github.com/eclipse/jkube/pull/271#discussion_r450804924", "bodyText": "Unused code, please remove.\nIf you created either of these unused methods to comply with tests, just update the tests to provide the necessary input parameters for the functions.", "author": "manusa", "createdAt": "2020-07-07T11:48:45Z", "path": "jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/JKubeDockerfileInterpolator.java", "diffHunk": "@@ -13,37 +13,197 @@\n  */\n package org.eclipse.jkube.kit.build.service.docker.helper;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Properties;\n \n public class JKubeDockerfileInterpolator {\n-    private static Map<String, String> delimiters;\n-    static {\n-        delimiters = new HashMap<>();\n-        delimiters.put(\"@\", \"@\");\n-        delimiters.put(\"${\", \"}\");\n-    }\n \n     private JKubeDockerfileInterpolator() { }\n \n-    public static String interpolate(String line, Properties properties) {\n+    public static String interpolate(String line, Map<String, String> context, String filter) {\n+        return interpolate(line, context, getExpressionMarkersFromFilter(filter));\n+    }\n+\n+    public static String interpolate(String line, Properties properties, String filter) {\n+        return interpolate(line, properties, getExpressionMarkersFromFilter(filter));\n+    }\n+\n+    /**\n+     * Replace properties in a string\n+     *\n+     * @param line              string provided with parameters\n+     * @param context           properties provided as hashmap\n+     * @param expressionMarkers additional markers to use for parameterized expressions\n+     * @return string with properties parameters replaced\n+     */\n+    public static String interpolate(String line, Map<String, String> context, Map<String, String> expressionMarkers) {\n+        Properties p = new Properties();\n+        context.forEach(p::put);\n+        return checkForPropertiesInLine(line, p, expressionMarkers, null);\n+    }", "originalCommit": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4133324a729441e318aa576812aef23009aeb2ac", "url": "https://github.com/eclipse/jkube/commit/4133324a729441e318aa576812aef23009aeb2ac", "message": "Fix #246: Dockerfile custom interpolation is broken", "committedDate": "2020-07-07T13:34:12Z", "type": "commit"}, {"oid": "4133324a729441e318aa576812aef23009aeb2ac", "url": "https://github.com/eclipse/jkube/commit/4133324a729441e318aa576812aef23009aeb2ac", "message": "Fix #246: Dockerfile custom interpolation is broken", "committedDate": "2020-07-07T13:34:12Z", "type": "forcePushed"}]}