{"pr_number": 5657, "pr_title": "Fix some edge cases in the smeltercrafter & improve the postbox", "pr_createdAt": "2020-08-26T15:04:16Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5657", "timeline": [{"oid": "52e5e4cb3b42080f5926802597b5a76b264662a6", "url": "https://github.com/ldtteam/minecolonies/commit/52e5e4cb3b42080f5926802597b5a76b264662a6", "message": "Add return of transferred count", "committedDate": "2020-08-26T14:23:05Z", "type": "commit"}, {"oid": "552bcd783581fc50825f5aed194eee5bb3eaa104", "url": "https://github.com/ldtteam/minecolonies/commit/552bcd783581fc50825f5aed194eee5bb3eaa104", "message": "Fix postbox to not break requests into stacks", "committedDate": "2020-08-26T14:23:45Z", "type": "commit"}, {"oid": "9b6456f8ca30b0da173afaea6e468f263ac1da63", "url": "https://github.com/ldtteam/minecolonies/commit/9b6456f8ca30b0da173afaea6e468f263ac1da63", "message": "Improve Smeltercraftrer", "committedDate": "2020-08-26T14:24:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NDM2OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5657#discussion_r477374369", "bodyText": "@return missing", "author": "Raycoms", "createdAt": "2020-08-26T15:06:49Z", "path": "src/api/java/com/minecolonies/api/util/InventoryUtils.java", "diffHunk": "@@ -1808,7 +1808,7 @@ public static int transferXOfFirstSlotInItemHandlerWithIntoNextFreeSlotInItemHan\n      * @param targetHandler               the target.\n      * @param slot                        the slot to put it in.\n      */\n-    public static void transferXOfFirstSlotInItemHandlerWithIntoInItemHandler(", "originalCommit": "9b6456f8ca30b0da173afaea6e468f263ac1da63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4NDE1NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5657#discussion_r477384155", "bodyText": "fixed.", "author": "Mekle001", "createdAt": "2020-08-26T15:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NDM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NDgxMg==", "url": "https://github.com/ldtteam/minecolonies/pull/5657#discussion_r477374812", "bodyText": "seems a bit too much whitespace. You can also delete the uncommented directly. We got git for that =D", "author": "Raycoms", "createdAt": "2020-08-26T15:07:26Z", "path": "src/main/java/com/minecolonies/coremod/client/gui/WindowPostBox.java", "diffHunk": "@@ -110,12 +110,17 @@ private void requestClicked(final Button button)\n             }\n         }\n \n+\n+        Network.getNetwork().sendToServer(new PostBoxRequestMessage(buildingView, stack.copy(), qty, deliverAvailable));", "originalCommit": "9b6456f8ca30b0da173afaea6e468f263ac1da63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4NDAzMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5657#discussion_r477384031", "bodyText": "Yeah, Missed that in my cleanup pass.", "author": "Mekle001", "createdAt": "2020-08-26T15:19:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NDgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NjAwNw==", "url": "https://github.com/ldtteam/minecolonies/pull/5657#discussion_r477376007", "bodyText": "formatting seems off here.", "author": "Raycoms", "createdAt": "2020-08-26T15:09:04Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/basic/AbstractEntityAIRequestSmelter.java", "diffHunk": "@@ -478,11 +492,18 @@ private IAIState fillUpFurnace()\n                                 return getState();\n                             }\n                             worker.getCitizenItemHandler().hitBlockWithToolInHand(walkTo);\n-                            job.setProgress(job.getProgress() + toTransfer);\n-                            InventoryUtils.transferXOfFirstSlotInItemHandlerWithIntoInItemHandler(\n-                            worker.getInventoryCitizen(), smeltable, toTransfer,\n-                            new InvWrapper(furnace), SMELTABLE_SLOT);\n-                        }\n+                            int transferred = InventoryUtils.transferXOfFirstSlotInItemHandlerWithIntoInItemHandler(\n+                                worker.getInventoryCitizen(), smeltable, toTransfer,\n+                                new InvWrapper(furnace), SMELTABLE_SLOT);\n+                            // It's possible we have less in the stack than we want to transfer, so transfer what we can, and try one more time. \n+                            if (transferred < toTransfer)\n+                            {\n+                                transferred += InventoryUtils.transferXOfFirstSlotInItemHandlerWithIntoInItemHandler(\n+                                    worker.getInventoryCitizen(), smeltable, toTransfer - transferred,\n+                                    new InvWrapper(furnace), SMELTABLE_SLOT);\n+                            }\n+                            job.setProgress(job.getProgress() + transferred);", "originalCommit": "9b6456f8ca30b0da173afaea6e468f263ac1da63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NjIyMw==", "url": "https://github.com/ldtteam/minecolonies/pull/5657#discussion_r477376223", "bodyText": "How can this fail and need to be executed twice?", "author": "Raycoms", "createdAt": "2020-08-26T15:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NjAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3ODg5Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/5657#discussion_r477378893", "bodyText": "You want to transfer 20, the first slot it finds has 8, the rest are in the second slot. It only works with one slot, so the first request is for 20 on the slot with 8. You need to a follow request on the slot with 12 to complete it.", "author": "Mekle001", "createdAt": "2020-08-26T15:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NjAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4MTQ1NA==", "url": "https://github.com/ldtteam/minecolonies/pull/5657#discussion_r477381454", "bodyText": "Then we should probably use a better one.", "author": "Raycoms", "createdAt": "2020-08-26T15:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NjAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4NDQ4OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5657#discussion_r477384489", "bodyText": "Ok, that's more consistent formatting now.", "author": "Mekle001", "createdAt": "2020-08-26T15:20:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NjAwNw=="}], "type": "inlineReview"}, {"oid": "f68f65c17b094e1233f42e3ce89c5ff56f0aeca4", "url": "https://github.com/ldtteam/minecolonies/commit/f68f65c17b094e1233f42e3ce89c5ff56f0aeca4", "message": "Cleanup whitespace/comments", "committedDate": "2020-08-26T15:09:16Z", "type": "commit"}, {"oid": "79382c376f276ad51dbfe281f304e7aceb564007", "url": "https://github.com/ldtteam/minecolonies/commit/79382c376f276ad51dbfe281f304e7aceb564007", "message": "Review feedback", "committedDate": "2020-08-26T15:19:27Z", "type": "commit"}, {"oid": "5122a7b56086ca475073471e18efb245ad94fc59", "url": "https://github.com/ldtteam/minecolonies/commit/5122a7b56086ca475073471e18efb245ad94fc59", "message": "Make the transfer a loop rather than 2 pass", "committedDate": "2020-08-26T15:47:26Z", "type": "commit"}, {"oid": "d22761bccf5aa2c4077a89ffa7b43293e4d99691", "url": "https://github.com/ldtteam/minecolonies/commit/d22761bccf5aa2c4077a89ffa7b43293e4d99691", "message": "Fix", "committedDate": "2020-08-26T15:48:30Z", "type": "commit"}, {"oid": "37d403a7ee8a3abd8b71bb8780f9b938365e5385", "url": "https://github.com/ldtteam/minecolonies/commit/37d403a7ee8a3abd8b71bb8780f9b938365e5385", "message": "Move code to InventoryUtils", "committedDate": "2020-08-26T16:29:09Z", "type": "commit"}]}