{"pr_number": 6059, "pr_title": "Add builder manual mode", "pr_createdAt": "2020-11-10T14:40:46Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/6059", "timeline": [{"oid": "31e87f386452b43b5e55aa70db8a265887f05c57", "url": "https://github.com/ldtteam/minecolonies/commit/31e87f386452b43b5e55aa70db8a265887f05c57", "message": "Add builder manual mode\n\nBuilders in manual mode don't automatically select build orders, but\ninstead wait and let the player choose one for them.", "committedDate": "2020-11-10T14:35:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODI0Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520678243", "bodyText": "require propper formatting here", "author": "Raycoms", "createdAt": "2020-11-10T16:02:31Z", "path": "src/main/java/com/minecolonies/coremod/client/gui/WindowHutBuilder.java", "diffHunk": "@@ -81,8 +91,19 @@ public WindowHutBuilder(final BuildingBuilder.View building, final boolean needG\n     {\n         super(building, Constants.MOD_ID + HUT_BUILDER_RESOURCE_SUFFIX);\n         pullResourcesFromHut();\n+\n         registerButton(RESOURCE_ADD, this::transferItems);\n+        registerButton(BUTTON_MANUAL_MODE, this::manualModeClicked);\n+        registerButton(WORK_ORDER_SELECT, this::selectWorkOrder);\n+\n         this.needGuide = needGuide;\n+\n+        Button buttonManualMode = findPaneOfTypeByID(BUTTON_MANUAL_MODE, Button.class);\n+        if (building.getManualMode()) {\n+            buttonManualMode.setLabel(LanguageHandler.format(TranslationConstants.COM_MINECOLONIES_COREMOD_GUI_BUILDER_MANUAL));\n+        } else {", "originalCommit": "31e87f386452b43b5e55aa70db8a265887f05c57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODYzOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520678639", "bodyText": "else on next line", "author": "Raycoms", "createdAt": "2020-11-10T16:03:02Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingBuilder.java", "diffHunk": "@@ -116,18 +125,50 @@ public void registerBlockPosition(@NotNull final Block block, @NotNull final Blo\n     public void deserializeNBT(final CompoundNBT compound)\n     {\n         super.deserializeNBT(compound);\n-        this.purgedMobsToday = compound.getBoolean(TAG_PURGE_MOBS);\n+        this.purgedMobsToday = compound.getBoolean(TAG_PURGED_MOBS);\n+        this.manualMode = compound.getBoolean(TAG_MANUAL_JOB_SELECTION);\n     }\n \n     @Override\n     public CompoundNBT serializeNBT()\n     {\n         final CompoundNBT compound = super.serializeNBT();\n-        compound.putBoolean(TAG_PURGE_MOBS, this.purgedMobsToday);\n+        compound.putBoolean(TAG_PURGED_MOBS, this.purgedMobsToday);\n+        compound.putBoolean(TAG_MANUAL_JOB_SELECTION, manualMode);\n \n         return compound;\n     }\n \n+    @Override\n+    public void serializeToView(PacketBuffer buf)\n+    {\n+        super.serializeToView(buf);\n+        buf.writeBoolean(manualMode);\n+\n+        if (manualMode && !getMainCitizen().getJob(JobBuilder.class).hasWorkOrder())\n+        {\n+            final List<WorkOrderBuildDecoration> list = new ArrayList<>();\n+            list.addAll(getColony().getWorkManager().getOrderedList(WorkOrderBuildRemoval.class, getPosition()));\n+            // WorkOrderBuildDecoration is the superclass of BuildBuilding and thus returns both\n+            list.addAll(getColony().getWorkManager().getOrderedList(WorkOrderBuildDecoration.class, getPosition()));\n+\n+            list.removeIf(order -> order instanceof WorkOrderBuildMiner);\n+            list.removeIf(order -> order.isClaimed());\n+            list.removeIf(order -> order instanceof WorkOrderBuild && !(order instanceof WorkOrderBuildRemoval) &&\n+                  !((WorkOrderBuild) order).canBuild(getMainCitizen()));\n+\n+            buf.writeInt(list.size());\n+\n+            for (WorkOrderBuildDecoration order : list)\n+            {\n+                order.serializeViewNetworkData(buf);\n+            }\n+        } else if (manualMode)", "originalCommit": "31e87f386452b43b5e55aa70db8a265887f05c57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520678808", "bodyText": "bracket on next line", "author": "Raycoms", "createdAt": "2020-11-10T16:03:15Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingBuilder.java", "diffHunk": "@@ -247,6 +308,38 @@ public void searchWorkOrder()\n         }\n     }\n \n+    /**\n+     * Sets the work order with the given id as the work order for this buildings citizen.\n+     * \n+     * @param orderId the id of the work order to select.\n+     */\n+    public void setWorkOrder(int orderId)\n+    {\n+        final ICitizenData citizen = getMainCitizen();\n+        if (citizen == null)\n+        {\n+            return;\n+        }\n+\n+        if (citizen.getJob(JobBuilder.class).hasWorkOrder()) {", "originalCommit": "31e87f386452b43b5e55aa70db8a265887f05c57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY5MDk2OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520690969", "bodyText": "should probably cancel the active workorder here, if its not the same as the new one. As I think the player would expect to be able to directly switch to the workorder right away, not waiting for current to finish", "author": "someaddons", "createdAt": "2020-11-10T16:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY5MzgwMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520693801", "bodyText": "gotta make sure to reset all the data then too regarding the workorder (else the AI will get messy)", "author": "Raycoms", "createdAt": "2020-11-10T16:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY5ODAzMg==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520698032", "bodyText": "ye atm it only listens to workerorder.cancel, maybe we cancel the workorder and make a new one with similar content?", "author": "someaddons", "createdAt": "2020-11-10T16:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNDI2NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520704265", "bodyText": "Currently the gui for selecting a work order doesn't show while one is already selected, this is just to prevent spam clicking from causing issues.\nI also did never run into issues without this, but i wanted to make sure.", "author": "ToMe25", "createdAt": "2020-11-10T16:36:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNzQ4OA==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520707488", "bodyText": "sounds good for me then", "author": "Raycoms", "createdAt": "2020-11-10T16:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMTIwOA==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520731208", "bodyText": "so if you toggle manual while he is building sth just nothing happens?\nI think the main part where ppl do use this is when \"Oh Builder X took task Y, but I wanted him to do Z\"", "author": "someaddons", "createdAt": "2020-11-10T17:14:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMjg5OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520732899", "bodyText": "Are you able to add text to state \"just finishing this job gov'ner\" so players don't get concerned when they try to change task", "author": "Aduis1210", "createdAt": "2020-11-10T17:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczNDA3NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520734075", "bodyText": "Yeah, on switching to manual we could print a message with \"Succesfully switched, iwll just finish the current task\"", "author": "Raycoms", "createdAt": "2020-11-10T17:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgyNTk0MA==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520825940", "bodyText": "Is just a chat message ok, or should the citizen somehow say that in his gui?\nAlso should he tell that to all players in the colony, or just the player switching it?", "author": "ToMe25", "createdAt": "2020-11-10T19:38:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgyOTAzMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520829031", "bodyText": "chat message is fine, just for the switching player", "author": "Raycoms", "createdAt": "2020-11-10T19:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzMTUzNw==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520831537", "bodyText": "OK, i will add that tomorrow", "author": "ToMe25", "createdAt": "2020-11-10T19:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMzY1MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r521313651", "bodyText": "I added a message saying BUILDER NAME: Succesfully switched to manual mode, i will just finish the current task. for this.\nThe text of the message isn't great, but i don't know how to make it better without making it significantly longer.", "author": "ToMe25", "createdAt": "2020-11-11T12:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMyNDU0MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r521324541", "bodyText": "@ravenbuilder934", "author": "Raycoms", "createdAt": "2020-11-11T12:29:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3ODk2Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520678967", "bodyText": "bracket next line", "author": "Raycoms", "createdAt": "2020-11-10T16:03:27Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingBuilder.java", "diffHunk": "@@ -285,5 +388,55 @@ public Window getWindow()\n         {\n             return new WindowHutBuilder(this);\n         }\n+\n+        /**\n+         * Checks whether this builder should only accept build orders specifically created for that builder.\n+         * \n+         * @return true if so.\n+         */\n+        public boolean getManualMode()\n+        {\n+            return manualMode;\n+        }\n+\n+        /**\n+         * Sets whether this builder should only accept build orders specifically created for that builder.\n+         * \n+         * @param manualMode true if so.\n+         */\n+        public void setManualMode(boolean manualMode)\n+        {\n+            Network.getNetwork().sendToServer(new BuilderSetManualModeMessage(this, manualMode));\n+            this.manualMode = manualMode;\n+        }\n+\n+        /**\n+         * Gets the available work orders to choose from.\n+         * \n+         * @return the available work orders to choose from.\n+         */\n+        public List<WorkOrderView> getBuildOrders() {", "originalCommit": "31e87f386452b43b5e55aa70db8a265887f05c57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3OTMwMg==", "url": "https://github.com/ldtteam/minecolonies/pull/6059#discussion_r520679302", "bodyText": "formatting", "author": "Raycoms", "createdAt": "2020-11-10T16:03:57Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/builder/EntityAIStructureBuilder.java", "diffHunk": "@@ -201,6 +201,9 @@ private boolean checkForWorkOrder()\n     {\n         if (!job.hasWorkOrder())\n         {\n+            if (getOwnBuilding().getManualMode()) {", "originalCommit": "31e87f386452b43b5e55aa70db8a265887f05c57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "67d90d11a331d0715ce375262055c5263e537412", "url": "https://github.com/ldtteam/minecolonies/commit/67d90d11a331d0715ce375262055c5263e537412", "message": "formatting", "committedDate": "2020-11-10T16:40:02Z", "type": "commit"}, {"oid": "78cbb6d20f122e4a8823bc06001786ee4a59f3a9", "url": "https://github.com/ldtteam/minecolonies/commit/78cbb6d20f122e4a8823bc06001786ee4a59f3a9", "message": "Add a chat message for when switching a builder to manual mode", "committedDate": "2020-11-11T12:07:03Z", "type": "commit"}, {"oid": "978abbcbc6a609a0a40d7445551147ceefeee04c", "url": "https://github.com/ldtteam/minecolonies/commit/978abbcbc6a609a0a40d7445551147ceefeee04c", "message": "Update src/main/resources/assets/minecolonies/lang/en_us.json\n\nCo-authored-by: ravenbuilder934 <sabrinajamie@outlook.com>", "committedDate": "2020-11-11T14:15:04Z", "type": "commit"}, {"oid": "2b6064601ec1de678c042f8b0850d117e2cc2e20", "url": "https://github.com/ldtteam/minecolonies/commit/2b6064601ec1de678c042f8b0850d117e2cc2e20", "message": "Merge branch 'version/1.15' into manual_builder", "committedDate": "2020-11-11T14:29:16Z", "type": "commit"}, {"oid": "a0a7e48a84ba211acbf604a98c38db4c4bc75e82", "url": "https://github.com/ldtteam/minecolonies/commit/a0a7e48a84ba211acbf604a98c38db4c4bc75e82", "message": "Add manual mode building finished messages", "committedDate": "2020-11-11T18:54:03Z", "type": "commit"}, {"oid": "e3eb38824e1aa04ff51b01800f1cc6e17464ec22", "url": "https://github.com/ldtteam/minecolonies/commit/e3eb38824e1aa04ff51b01800f1cc6e17464ec22", "message": "Update src/main/resources/assets/minecolonies/lang/en_us.json\n\nCo-authored-by: ravenbuilder934 <sabrinajamie@outlook.com>", "committedDate": "2020-11-11T18:57:43Z", "type": "commit"}, {"oid": "271542070fb595f71e059d1f6f77a14c9db9fffe", "url": "https://github.com/ldtteam/minecolonies/commit/271542070fb595f71e059d1f6f77a14c9db9fffe", "message": "Update src/main/resources/assets/minecolonies/lang/en_us.json\n\nCo-authored-by: ravenbuilder934 <sabrinajamie@outlook.com>", "committedDate": "2020-11-11T18:58:40Z", "type": "commit"}, {"oid": "4589223c4670dffdffce150b3ff0f04e9cee8a8c", "url": "https://github.com/ldtteam/minecolonies/commit/4589223c4670dffdffce150b3ff0f04e9cee8a8c", "message": "Merge branch 'version/1.15' into manual_builder", "committedDate": "2020-11-15T12:31:25Z", "type": "commit"}]}