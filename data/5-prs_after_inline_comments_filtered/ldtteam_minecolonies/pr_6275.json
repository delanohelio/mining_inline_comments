{"pr_number": 6275, "pr_title": "Harvest warts and shroomlights, bonemeal fungi", "pr_createdAt": "2020-12-20T15:04:00Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/6275", "timeline": [{"oid": "3cb0023f923c22cd81e22e4d61dca54abf9c8796", "url": "https://github.com/ldtteam/minecolonies/commit/3cb0023f923c22cd81e22e4d61dca54abf9c8796", "message": "Make lumberjack able to place fungi", "committedDate": "2020-12-09T09:55:51Z", "type": "commit"}, {"oid": "34ab12e37c1cbd54e175bbae2dee03e0cbfa008f", "url": "https://github.com/ldtteam/minecolonies/commit/34ab12e37c1cbd54e175bbae2dee03e0cbfa008f", "message": "Give fungus to lumberjack to replant", "committedDate": "2020-12-09T11:00:40Z", "type": "commit"}, {"oid": "fd609f743ee7134b0b4eb52f6a6c46d8e94414db", "url": "https://github.com/ldtteam/minecolonies/commit/fd609f743ee7134b0b4eb52f6a6c46d8e94414db", "message": "Revert \"Give fungus to lumberjack to replant\"\n\nThis reverts commit 34ab12e37c1cbd54e175bbae2dee03e0cbfa008f.", "committedDate": "2020-12-09T11:11:53Z", "type": "commit"}, {"oid": "f2a46e7f3f639d78c3429d39e255796241e50d21", "url": "https://github.com/ldtteam/minecolonies/commit/f2a46e7f3f639d78c3429d39e255796241e50d21", "message": "Enable lumberjack to harvest wart blocks and shroomlights; add fungi to wart loot tables", "committedDate": "2020-12-12T19:27:46Z", "type": "commit"}, {"oid": "b4fbfbbe1a841f0c9c9b73e9b361bbdea5b54c74", "url": "https://github.com/ldtteam/minecolonies/commit/b4fbfbbe1a841f0c9c9b73e9b361bbdea5b54c74", "message": "Merge branch 'version/1.16.3' of https://github.com/ldtteam/minecolonies into feature/lumberjack_nether", "committedDate": "2020-12-12T20:20:12Z", "type": "commit"}, {"oid": "7f7a1161cc5607cc9b0e0333bf45faa59cd9a57d", "url": "https://github.com/ldtteam/minecolonies/commit/7f7a1161cc5607cc9b0e0333bf45faa59cd9a57d", "message": "Merge branch 'version/1.16.3' of https://github.com/ldtteam/minecolonies into feature/lumberjack_nether", "committedDate": "2020-12-15T11:51:29Z", "type": "commit"}, {"oid": "663fb2168bd6dc35ea7fd694d49527329f1e122e", "url": "https://github.com/ldtteam/minecolonies/commit/663fb2168bd6dc35ea7fd694d49527329f1e122e", "message": "Bugfix", "committedDate": "2020-12-15T19:39:05Z", "type": "commit"}, {"oid": "cd9e4eeaf5338fee0351637afc2a380539183344", "url": "https://github.com/ldtteam/minecolonies/commit/cd9e4eeaf5338fee0351637afc2a380539183344", "message": "Add files via upload\n\nadd test world", "committedDate": "2020-12-15T19:50:44Z", "type": "commit"}, {"oid": "5e9deed23cc5f613240e846f6d9b5b741a59b350", "url": "https://github.com/ldtteam/minecolonies/commit/5e9deed23cc5f613240e846f6d9b5b741a59b350", "message": "Merge branch 'version/1.16.3' of https://github.com/ldtteam/minecolonies into feature/lumberjack_nether", "committedDate": "2020-12-20T14:42:57Z", "type": "commit"}, {"oid": "43b82f13dddad1a4c7964ba014100df4c048b871", "url": "https://github.com/ldtteam/minecolonies/commit/43b82f13dddad1a4c7964ba014100df4c048b871", "message": "few changes to wart harvesting; bonemeal fungi", "committedDate": "2020-12-20T14:45:19Z", "type": "commit"}, {"oid": "36f263d10bd2aa6d2c86045c0cdad70919423e33", "url": "https://github.com/ldtteam/minecolonies/commit/36f263d10bd2aa6d2c86045c0cdad70919423e33", "message": "Merge branch 'feature/lumberjack_nether' of https://github.com/vroni92/minecolonies into feature/lumberjack_nether", "committedDate": "2020-12-20T14:58:48Z", "type": "commit"}, {"oid": "a9b4cfdc7fe976ba3aceb67dfa980b5eac7c5a60", "url": "https://github.com/ldtteam/minecolonies/commit/a9b4cfdc7fe976ba3aceb67dfa980b5eac7c5a60", "message": "Move drops modification from loot table to lumberjack class", "committedDate": "2020-12-20T17:48:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2Nzg2OA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r546667868", "bodyText": "I think you want to move the whole nether tree list and possibly the bonemealing into the lumberjack building itself, as its to simulate natural growth which takes place anytime and not just when the AI is active, and you can save the positions list there so it persists during reloads", "author": "someaddons", "createdAt": "2020-12-21T12:00:37Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/lumberjack/EntityAIWorkLumberjack.java", "diffHunk": "@@ -164,6 +179,11 @@\n      */\n     private PathResult pathToTree;\n \n+    /**\n+     * A list of all planted nether trees\n+     */\n+    private final List<BlockPos> netherTrees = new ArrayList<>();", "originalCommit": "a9b4cfdc7fe976ba3aceb67dfa980b5eac7c5a60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY4NTE2NA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r546685164", "bodyText": "could even use the slow world tick in the lumberjack building for this.", "author": "Raycoms", "createdAt": "2020-12-21T12:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2Nzg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY4Njg1Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r546686852", "bodyText": "ye thats what I was thinking", "author": "someaddons", "createdAt": "2020-12-21T12:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2Nzg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY4NzE2Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r546687166", "bodyText": "also make it a Set then you dont need to worry about duplicated positions", "author": "someaddons", "createdAt": "2020-12-21T12:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2Nzg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2ODIyNg==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r546668226", "bodyText": "avoid using new Random, instead use the colonies or world's random instance. Creating a new is kinda heavy", "author": "someaddons", "createdAt": "2020-12-21T12:01:32Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/lumberjack/EntityAIWorkLumberjack.java", "diffHunk": "@@ -521,9 +542,83 @@ else if (job.getTree().hasLeaves() && job.getTree().isSlimeTree())\n             }\n             job.getTree().pollNextLeaf();\n         }\n+        else if (job.getTree().hasLeaves() && job.getTree().isNetherTree())\n+        {\n+            final BlockPos leaf = job.getTree().peekNextLeaf();\n+            if (!mineBlock(leaf, workFrom))\n+            {\n+                return getState();\n+            }\n+            job.getTree().pollNextLeaf();\n+        }\n         return getState();\n     }\n \n+    /**\n+     * Bonemeal fungi in netherTrees\n+     */\n+\n+    private IAIState bonemealFungi()\n+    {\n+        for (final BlockPos pos : getNetherTrees())\n+        {\n+            final BlockState blockState = world.getBlockState(pos);\n+            final Block block = blockState.getBlock();\n+            if (block == Blocks.CRIMSON_FUNGUS || block == Blocks.WARPED_FUNGUS)\n+            {\n+                final int threshold = worker.getCitizenData().getCitizenSkillHandler().getLevel(getOwnBuilding().getPrimarySkill()) * FUNGI_MODIFIER;\n+                final int rand = new Random().nextInt(100);", "originalCommit": "a9b4cfdc7fe976ba3aceb67dfa980b5eac7c5a60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2ODI5MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r546668291", "bodyText": "avoid new random here too", "author": "someaddons", "createdAt": "2020-12-21T12:01:44Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/lumberjack/EntityAIWorkLumberjack.java", "diffHunk": "@@ -521,9 +542,83 @@ else if (job.getTree().hasLeaves() && job.getTree().isSlimeTree())\n             }\n             job.getTree().pollNextLeaf();\n         }\n+        else if (job.getTree().hasLeaves() && job.getTree().isNetherTree())\n+        {\n+            final BlockPos leaf = job.getTree().peekNextLeaf();\n+            if (!mineBlock(leaf, workFrom))\n+            {\n+                return getState();\n+            }\n+            job.getTree().pollNextLeaf();\n+        }\n         return getState();\n     }\n \n+    /**\n+     * Bonemeal fungi in netherTrees\n+     */\n+\n+    private IAIState bonemealFungi()\n+    {\n+        for (final BlockPos pos : getNetherTrees())\n+        {\n+            final BlockState blockState = world.getBlockState(pos);\n+            final Block block = blockState.getBlock();\n+            if (block == Blocks.CRIMSON_FUNGUS || block == Blocks.WARPED_FUNGUS)\n+            {\n+                final int threshold = worker.getCitizenData().getCitizenSkillHandler().getLevel(getOwnBuilding().getPrimarySkill()) * FUNGI_MODIFIER;\n+                final int rand = new Random().nextInt(100);\n+                if (rand < threshold)\n+                {\n+                    final IGrowable growable = (IGrowable) block;\n+                    if (growable.canGrow(world, pos, blockState, world.isRemote)) {\n+                        if (!world.isRemote) {\n+                            if (growable.canUseBonemeal(world, world.rand, pos, blockState)) {\n+                                growable.grow((ServerWorld) world, world.rand, pos, blockState);\n+                            }\n+                        }\n+                    }\n+                }\n+\n+            }\n+            else\n+            {\n+                removeNetherTree(pos);\n+            }\n+        }\n+        return null;\n+    }\n+\n+    /**\n+     * Drop fungus instead of wart block\n+     *\n+     * @param drops the drops.\n+     * @return the list of additional drops.\n+     */\n+    @Override\n+    protected List<ItemStack> increaseBlockDrops(final List<ItemStack> drops)\n+    {\n+        final List<ItemStack> newDrops = new ArrayList<>();\n+        for (final ItemStack stack : drops)\n+        {\n+            boolean modified = false;\n+            if (new Random().nextInt(10) > 8) {", "originalCommit": "a9b4cfdc7fe976ba3aceb67dfa980b5eac7c5a60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2ODY2NA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r546668664", "bodyText": "and I think an 20% chance is a bit much maybe? think it should be similar to what vanilla's sapling chances from leaves, those are 5%", "author": "someaddons", "createdAt": "2020-12-21T12:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2ODI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY4NDMxOA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r546684318", "bodyText": "there is a worker.getRandom() or getRand()", "author": "Raycoms", "createdAt": "2020-12-21T12:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2ODI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2OTc0MA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r546669740", "bodyText": "Here we want to check first if the position is actually loaded, use the WorldUtil function for that", "author": "someaddons", "createdAt": "2020-12-21T12:05:32Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/lumberjack/EntityAIWorkLumberjack.java", "diffHunk": "@@ -521,9 +542,83 @@ else if (job.getTree().hasLeaves() && job.getTree().isSlimeTree())\n             }\n             job.getTree().pollNextLeaf();\n         }\n+        else if (job.getTree().hasLeaves() && job.getTree().isNetherTree())\n+        {\n+            final BlockPos leaf = job.getTree().peekNextLeaf();\n+            if (!mineBlock(leaf, workFrom))\n+            {\n+                return getState();\n+            }\n+            job.getTree().pollNextLeaf();\n+        }\n         return getState();\n     }\n \n+    /**\n+     * Bonemeal fungi in netherTrees\n+     */\n+\n+    private IAIState bonemealFungi()\n+    {\n+        for (final BlockPos pos : getNetherTrees())\n+        {\n+            final BlockState blockState = world.getBlockState(pos);", "originalCommit": "a9b4cfdc7fe976ba3aceb67dfa980b5eac7c5a60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "url": "https://github.com/ldtteam/minecolonies/commit/f47f54f951cab387a27e97bbb7eddc08b1e8b377", "message": "move fungi bonemealing to lumberjack building and persist positions", "committedDate": "2020-12-23T16:03:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyOTQ5NA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548129494", "bodyText": "Do we still need this then?", "author": "Raycoms", "createdAt": "2020-12-23T18:42:45Z", "path": "src/api/java/com/minecolonies/api/util/BlockPosUtil.java", "diffHunk": "@@ -415,7 +415,8 @@ public static TileEntity getTileEntity(@NotNull final World world, @NotNull fina\n         return world.getBlockState(coords).getDrops(new LootContext.Builder((ServerWorld) world)\n                                                       .withLuck(fortune)\n                                                       .withParameter(LootParameters.field_237457_g_, entity.getPositionVec())\n-                                                      .withParameter(LootParameters.TOOL, stack));\n+                                                      .withParameter(LootParameters.TOOL, stack)\n+                                                      .withNullableParameter(LootParameters.THIS_ENTITY, entity));\n     }", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMDI4Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548130287", "bodyText": "Ah, no, we don't. I can remove it.", "author": "vroni92", "createdAt": "2020-12-23T18:43:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyOTQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMDI5Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548130292", "bodyText": "needs javadoc", "author": "Raycoms", "createdAt": "2020-12-23T18:43:48Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -378,6 +420,78 @@ public void removeCitizen(final ICitizenData citizen)\n         super.removeCitizen(citizen);\n     }\n \n+    /**\n+     * Bonemeal fungi in netherTrees\n+     */\n+\n+    private void bonemealFungi()\n+    {\n+        for (final BlockPos pos : getNetherTrees())\n+        {\n+            final World world = colony.getWorld();\n+            if (WorldUtil.isBlockLoaded(world, pos))\n+            {\n+                BlockState blockState = world.getBlockState(pos);\n+                Block block = blockState.getBlock();\n+                if (block == Blocks.CRIMSON_FUNGUS || block == Blocks.WARPED_FUNGUS)\n+                {\n+                    int threshold = getMainCitizen().getCitizenSkillHandler().getLevel(getPrimarySkill()) * FUNGI_MODIFIER;\n+                    final int rand = world.getRandom().nextInt(100);\n+                    if (rand < threshold)\n+                    {\n+                        final IGrowable growable = (IGrowable) block;\n+                        if (growable.canGrow(world, pos, blockState, world.isRemote)) {\n+                            if (!world.isRemote) {\n+                                if(growable.canUseBonemeal(world, world.rand, pos, blockState)) {\n+                                    growable.grow((ServerWorld) world, world.rand, pos, blockState);\n+                                }\n+                            }\n+                        }\n+                    }\n+                    blockState = world.getBlockState(pos);\n+                    block = blockState.getBlock();\n+\n+                }\n+                else\n+                {\n+                    removeNetherTree(pos);\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Returns a list of the registered nether tree to grow.\n+     * @return a copy of the list\n+     */\n+\n+    public HashSet<BlockPos> getNetherTrees()\n+    {\n+        return new HashSet<>(netherTrees);\n+    }\n+\n+    /**\n+     * Removes a position from the nether trees\n+     * @param pos the position\n+     */\n+\n+    public void removeNetherTree(BlockPos pos)\n+    {\n+        netherTrees.remove(pos);\n+    }\n+\n+    public void addNetherTree(BlockPos pos)", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMDM3OA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548130378", "bodyText": "empty space", "author": "Raycoms", "createdAt": "2020-12-23T18:43:54Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -378,6 +420,78 @@ public void removeCitizen(final ICitizenData citizen)\n         super.removeCitizen(citizen);\n     }\n \n+    /**\n+     * Bonemeal fungi in netherTrees\n+     */\n+\n+    private void bonemealFungi()\n+    {\n+        for (final BlockPos pos : getNetherTrees())\n+        {\n+            final World world = colony.getWorld();\n+            if (WorldUtil.isBlockLoaded(world, pos))\n+            {\n+                BlockState blockState = world.getBlockState(pos);\n+                Block block = blockState.getBlock();\n+                if (block == Blocks.CRIMSON_FUNGUS || block == Blocks.WARPED_FUNGUS)\n+                {\n+                    int threshold = getMainCitizen().getCitizenSkillHandler().getLevel(getPrimarySkill()) * FUNGI_MODIFIER;\n+                    final int rand = world.getRandom().nextInt(100);\n+                    if (rand < threshold)\n+                    {\n+                        final IGrowable growable = (IGrowable) block;\n+                        if (growable.canGrow(world, pos, blockState, world.isRemote)) {\n+                            if (!world.isRemote) {\n+                                if(growable.canUseBonemeal(world, world.rand, pos, blockState)) {\n+                                    growable.grow((ServerWorld) world, world.rand, pos, blockState);\n+                                }\n+                            }\n+                        }\n+                    }\n+                    blockState = world.getBlockState(pos);\n+                    block = blockState.getBlock();\n+\n+                }\n+                else\n+                {\n+                    removeNetherTree(pos);\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Returns a list of the registered nether tree to grow.\n+     * @return a copy of the list\n+     */\n+\n+    public HashSet<BlockPos> getNetherTrees()\n+    {\n+        return new HashSet<>(netherTrees);\n+    }\n+\n+    /**\n+     * Removes a position from the nether trees\n+     * @param pos the position\n+     */\n+", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMDg4NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548130885", "bodyText": "Check how we write blockPos to nbt in some other buildings, there are tag lists that are much easier to use than this construct", "author": "Raycoms", "createdAt": "2020-12-23T18:44:32Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -225,6 +246,20 @@ public void deserializeNBT(final CompoundNBT compound)\n         {\n             endRestriction = null;\n         }\n+\n+        int i = 0;\n+        while (true)", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE0MjYyNA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548142624", "bodyText": "BlockPosUtil", "author": "someaddons", "createdAt": "2020-12-23T18:58:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMDg4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMDk4OA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548130988", "bodyText": "same for this", "author": "Raycoms", "createdAt": "2020-12-23T18:44:39Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -244,6 +279,13 @@ public CompoundNBT serializeNBT()\n             compound.put(TAG_RESTRICT_END, NBTUtil.writeBlockPos(endRestriction));\n         }\n \n+        int i = 0;\n+        for (final BlockPos pos : getNetherTrees())\n+        {", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMTMyOA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548131328", "bodyText": "since the get returns a hashset we should probably iterate directly here", "author": "Raycoms", "createdAt": "2020-12-23T18:45:08Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -378,6 +420,78 @@ public void removeCitizen(final ICitizenData citizen)\n         super.removeCitizen(citizen);\n     }\n \n+    /**\n+     * Bonemeal fungi in netherTrees\n+     */\n+\n+    private void bonemealFungi()\n+    {\n+        for (final BlockPos pos : getNetherTrees())", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMjI0MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548132241", "bodyText": "why this?", "author": "Raycoms", "createdAt": "2020-12-23T18:46:23Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -378,6 +420,78 @@ public void removeCitizen(final ICitizenData citizen)\n         super.removeCitizen(citizen);\n     }\n \n+    /**\n+     * Bonemeal fungi in netherTrees\n+     */\n+\n+    private void bonemealFungi()\n+    {\n+        for (final BlockPos pos : getNetherTrees())\n+        {\n+            final World world = colony.getWorld();\n+            if (WorldUtil.isBlockLoaded(world, pos))\n+            {\n+                BlockState blockState = world.getBlockState(pos);\n+                Block block = blockState.getBlock();\n+                if (block == Blocks.CRIMSON_FUNGUS || block == Blocks.WARPED_FUNGUS)\n+                {\n+                    int threshold = getMainCitizen().getCitizenSkillHandler().getLevel(getPrimarySkill()) * FUNGI_MODIFIER;\n+                    final int rand = world.getRandom().nextInt(100);\n+                    if (rand < threshold)\n+                    {\n+                        final IGrowable growable = (IGrowable) block;\n+                        if (growable.canGrow(world, pos, blockState, world.isRemote)) {\n+                            if (!world.isRemote) {\n+                                if(growable.canUseBonemeal(world, world.rand, pos, blockState)) {\n+                                    growable.grow((ServerWorld) world, world.rand, pos, blockState);\n+                                }\n+                            }\n+                        }\n+                    }\n+                    blockState = world.getBlockState(pos);", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMjM2Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548132366", "bodyText": "bracket formatting", "author": "Raycoms", "createdAt": "2020-12-23T18:46:32Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -378,6 +420,78 @@ public void removeCitizen(final ICitizenData citizen)\n         super.removeCitizen(citizen);\n     }\n \n+    /**\n+     * Bonemeal fungi in netherTrees\n+     */\n+\n+    private void bonemealFungi()\n+    {\n+        for (final BlockPos pos : getNetherTrees())\n+        {\n+            final World world = colony.getWorld();\n+            if (WorldUtil.isBlockLoaded(world, pos))\n+            {\n+                BlockState blockState = world.getBlockState(pos);\n+                Block block = blockState.getBlock();\n+                if (block == Blocks.CRIMSON_FUNGUS || block == Blocks.WARPED_FUNGUS)\n+                {\n+                    int threshold = getMainCitizen().getCitizenSkillHandler().getLevel(getPrimarySkill()) * FUNGI_MODIFIER;\n+                    final int rand = world.getRandom().nextInt(100);\n+                    if (rand < threshold)\n+                    {\n+                        final IGrowable growable = (IGrowable) block;\n+                        if (growable.canGrow(world, pos, blockState, world.isRemote)) {", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMzAzMA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548133030", "bodyText": "I think the javadoc has to be more precise to what this method does (also move it down by one).\nBesides that, I think we should grow at most 1 tree per tick here (such that we don't grow all at the same time)", "author": "Raycoms", "createdAt": "2020-12-23T18:47:16Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -378,6 +420,78 @@ public void removeCitizen(final ICitizenData citizen)\n         super.removeCitizen(citizen);\n     }\n \n+    /**\n+     * Bonemeal fungi in netherTrees\n+     */\n+\n+    private void bonemealFungi()", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMzUxOA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548133518", "bodyText": "so, on grow, probably do a return;", "author": "Raycoms", "createdAt": "2020-12-23T18:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMzAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzNzE0Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548137146", "bodyText": "That one is a bit annoying probably, but I feel we should have a curve here. Like, there should always be a 10% chance to grow the tree. With increasing level it should then get to 100%, instead of very low chance early on and 100% after level 50", "author": "Raycoms", "createdAt": "2020-12-23T18:52:20Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -378,6 +420,78 @@ public void removeCitizen(final ICitizenData citizen)\n         super.removeCitizen(citizen);\n     }\n \n+    /**\n+     * Bonemeal fungi in netherTrees\n+     */\n+\n+    private void bonemealFungi()\n+    {\n+        for (final BlockPos pos : getNetherTrees())\n+        {\n+            final World world = colony.getWorld();\n+            if (WorldUtil.isBlockLoaded(world, pos))\n+            {\n+                BlockState blockState = world.getBlockState(pos);\n+                Block block = blockState.getBlock();\n+                if (block == Blocks.CRIMSON_FUNGUS || block == Blocks.WARPED_FUNGUS)\n+                {\n+                    int threshold = getMainCitizen().getCitizenSkillHandler().getLevel(getPrimarySkill()) * FUNGI_MODIFIER;", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE0MzY3Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548143676", "bodyText": "this will also error when there is no citizen for this building, check if we have a citizen first", "author": "someaddons", "createdAt": "2020-12-23T19:00:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzNzE0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzNzYwNA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548137604", "bodyText": "bracket formatting is off", "author": "Raycoms", "createdAt": "2020-12-23T18:52:54Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/lumberjack/EntityAIWorkLumberjack.java", "diffHunk": "@@ -521,9 +530,48 @@ else if (job.getTree().hasLeaves() && job.getTree().isSlimeTree())\n             }\n             job.getTree().pollNextLeaf();\n         }\n+        else if (job.getTree().hasLeaves() && job.getTree().isNetherTree())\n+        {\n+            final BlockPos leaf = job.getTree().peekNextLeaf();\n+            if (!mineBlock(leaf, workFrom))\n+            {\n+                return getState();\n+            }\n+            job.getTree().pollNextLeaf();\n+        }\n         return getState();\n     }\n \n+    /**\n+     * Drop fungus instead of wart block\n+     *\n+     * @param drops the drops.\n+     * @return the list of additional drops.\n+     */\n+    @Override\n+    protected List<ItemStack> increaseBlockDrops(final List<ItemStack> drops)\n+    {\n+        final List<ItemStack> newDrops = new ArrayList<>();\n+        for (final ItemStack stack : drops)\n+        {\n+            boolean modified = false;\n+            if (world.getRandom().nextInt(100) > 95) {", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzOTA0MA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548139040", "bodyText": "this could be a if (newDrops.isEmpty()) return drops; else return newDrops;", "author": "Raycoms", "createdAt": "2020-12-23T18:54:41Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/lumberjack/EntityAIWorkLumberjack.java", "diffHunk": "@@ -521,9 +530,48 @@ else if (job.getTree().hasLeaves() && job.getTree().isSlimeTree())\n             }\n             job.getTree().pollNextLeaf();\n         }\n+        else if (job.getTree().hasLeaves() && job.getTree().isNetherTree())\n+        {\n+            final BlockPos leaf = job.getTree().peekNextLeaf();\n+            if (!mineBlock(leaf, workFrom))\n+            {\n+                return getState();\n+            }\n+            job.getTree().pollNextLeaf();\n+        }\n         return getState();\n     }\n \n+    /**\n+     * Drop fungus instead of wart block\n+     *\n+     * @param drops the drops.\n+     * @return the list of additional drops.\n+     */\n+    @Override\n+    protected List<ItemStack> increaseBlockDrops(final List<ItemStack> drops)\n+    {\n+        final List<ItemStack> newDrops = new ArrayList<>();\n+        for (final ItemStack stack : drops)\n+        {\n+            boolean modified = false;\n+            if (world.getRandom().nextInt(100) > 95) {\n+                if (stack.getItem() == Items.NETHER_WART_BLOCK) {\n+                    newDrops.add(new ItemStack(Items.CRIMSON_FUNGUS, 1));\n+                    modified = true;\n+                } else if (stack.getItem() == Items.WARPED_WART_BLOCK) {\n+                    newDrops.add(new ItemStack(Items.WARPED_FUNGUS, 1));\n+                    modified = true;\n+                }\n+            }\n+            if (!modified)", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzOTcxOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r548139719", "bodyText": "I'm pretty sure we write this tree to NBT somewhere too, so we have to write this boolean too.", "author": "Raycoms", "createdAt": "2020-12-23T18:55:24Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/lumberjack/Tree.java", "diffHunk": "@@ -121,6 +121,11 @@\n      */\n     private boolean dynamicTree = false;\n \n+    /**\n+     * If the tree is a Nether Tree\n+     */\n+    private boolean netherTree = false;", "originalCommit": "f47f54f951cab387a27e97bbb7eddc08b1e8b377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0f57a4225ef7a331f1bdbee85aa7e77e480e8b7e", "url": "https://github.com/ldtteam/minecolonies/commit/0f57a4225ef7a331f1bdbee85aa7e77e480e8b7e", "message": "Adjust to review", "committedDate": "2020-12-29T13:06:45Z", "type": "commit"}, {"oid": "90576fa737a782bdee1c9206a920db6b4a5bb95d", "url": "https://github.com/ldtteam/minecolonies/commit/90576fa737a782bdee1c9206a920db6b4a5bb95d", "message": "Merge branch 'version/1.16.3' of https://github.com/ldtteam/minecolonies into feature/lumberjack_nether", "committedDate": "2020-12-29T13:07:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg4MTY1OA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r549881658", "bodyText": "unused/wrong import here", "author": "someaddons", "createdAt": "2020-12-29T23:04:54Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -1,5 +1,6 @@\n package com.minecolonies.coremod.colony.buildings.workerbuildings;\n \n+import com.ibm.icu.impl.CollectionSet;", "originalCommit": "90576fa737a782bdee1c9206a920db6b4a5bb95d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg4MTgxMA==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r549881810", "bodyText": "make it a Set type instead", "author": "someaddons", "createdAt": "2020-12-29T23:05:34Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -89,6 +101,16 @@\n      */\n     private static final String LUMBERJACK = \"lumberjack\";\n \n+    /**\n+     * A list of all planted nether trees\n+     */\n+    private final HashSet<BlockPos> netherTrees = new HashSet<>();", "originalCommit": "90576fa737a782bdee1c9206a920db6b4a5bb95d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg4MjE0MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r549882141", "bodyText": "use the base Set type here aswell", "author": "someaddons", "createdAt": "2020-12-29T23:06:58Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -378,6 +413,95 @@ public void removeCitizen(final ICitizenData citizen)\n         super.removeCitizen(citizen);\n     }\n \n+    /**\n+     * Returns early if no worker is assigned\n+     * Iterates over the nether tree position list\n+     * If position is a fungus, grows it depending on worker's level\n+     * If the block has changed, removes the position from the list and returns early\n+     * If the position is not a fungus, removes the position from the list\n+     *\n+     */\n+    private void bonemealFungi()\n+    {\n+        if (getMainCitizen() == null)\n+        {\n+            return;\n+        }\n+        final int modifier = Math.max(0, Math.min(FUNGI_MODIFIER, 100));\n+        for (final BlockPos pos : netherTrees)\n+        {\n+            final World world = colony.getWorld();\n+            if (WorldUtil.isBlockLoaded(world, pos))\n+            {\n+                BlockState blockState = world.getBlockState(pos);\n+                Block block = blockState.getBlock();\n+                if (block == Blocks.CRIMSON_FUNGUS || block == Blocks.WARPED_FUNGUS)\n+                {\n+                    int threshold = modifier + (int) Math.ceil(getMainCitizen().getCitizenSkillHandler().getLevel(getPrimarySkill())*(1-((float) modifier/100)));\n+                    final int rand = world.getRandom().nextInt(100);\n+                    if (rand < threshold)\n+                    {\n+                        final IGrowable growable = (IGrowable) block;\n+                        if (growable.canGrow(world, pos, blockState, world.isRemote)) {\n+                            if (!world.isRemote) {\n+                                if(growable.canUseBonemeal(world, world.rand, pos, blockState))\n+                                {\n+                                    growable.grow((ServerWorld) world, world.rand, pos, blockState);\n+                                }\n+                            }\n+                        }\n+                    }\n+                    blockState = world.getBlockState(pos);\n+                    block = blockState.getBlock();\n+                    if (!(block == Blocks.CRIMSON_FUNGUS || block == Blocks.WARPED_FUNGUS))\n+                    {\n+                        removeNetherTree(pos);\n+                        return;\n+                    }\n+\n+                }\n+                else\n+                {\n+                    removeNetherTree(pos);\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Returns a list of the registered nether trees to grow.\n+     * @return a copy of the list\n+     */\n+    public HashSet<BlockPos> getNetherTrees()", "originalCommit": "90576fa737a782bdee1c9206a920db6b4a5bb95d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg4MjQwNw==", "url": "https://github.com/ldtteam/minecolonies/pull/6275#discussion_r549882407", "bodyText": "here we can early return, then we don't need the code below", "author": "Raycoms", "createdAt": "2020-12-29T23:08:20Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingLumberjack.java", "diffHunk": "@@ -378,6 +413,95 @@ public void removeCitizen(final ICitizenData citizen)\n         super.removeCitizen(citizen);\n     }\n \n+    /**\n+     * Returns early if no worker is assigned\n+     * Iterates over the nether tree position list\n+     * If position is a fungus, grows it depending on worker's level\n+     * If the block has changed, removes the position from the list and returns early\n+     * If the position is not a fungus, removes the position from the list\n+     *\n+     */\n+    private void bonemealFungi()\n+    {\n+        if (getMainCitizen() == null)\n+        {\n+            return;\n+        }\n+        final int modifier = Math.max(0, Math.min(FUNGI_MODIFIER, 100));\n+        for (final BlockPos pos : netherTrees)\n+        {\n+            final World world = colony.getWorld();\n+            if (WorldUtil.isBlockLoaded(world, pos))\n+            {\n+                BlockState blockState = world.getBlockState(pos);\n+                Block block = blockState.getBlock();\n+                if (block == Blocks.CRIMSON_FUNGUS || block == Blocks.WARPED_FUNGUS)\n+                {\n+                    int threshold = modifier + (int) Math.ceil(getMainCitizen().getCitizenSkillHandler().getLevel(getPrimarySkill())*(1-((float) modifier/100)));\n+                    final int rand = world.getRandom().nextInt(100);\n+                    if (rand < threshold)\n+                    {\n+                        final IGrowable growable = (IGrowable) block;\n+                        if (growable.canGrow(world, pos, blockState, world.isRemote)) {\n+                            if (!world.isRemote) {\n+                                if(growable.canUseBonemeal(world, world.rand, pos, blockState))\n+                                {\n+                                    growable.grow((ServerWorld) world, world.rand, pos, blockState);", "originalCommit": "90576fa737a782bdee1c9206a920db6b4a5bb95d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e25f846f2c1f1463c19e44ee57d04a4fe8ea4a0f", "url": "https://github.com/ldtteam/minecolonies/commit/e25f846f2c1f1463c19e44ee57d04a4fe8ea4a0f", "message": "Adjust to review", "committedDate": "2020-12-30T10:03:41Z", "type": "commit"}]}