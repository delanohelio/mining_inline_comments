{"pr_number": 4759, "pr_title": "Fix Stock View sometimes not showing all items", "pr_createdAt": "2020-04-25T19:50:18Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/4759", "timeline": [{"oid": "8f36e80b58f27fd2f038cdf83efdf12e7bf277c4", "url": "https://github.com/ldtteam/minecolonies/commit/8f36e80b58f27fd2f038cdf83efdf12e7bf277c4", "message": "Fix Stock View sometimes not showing all items", "committedDate": "2020-04-25T19:47:22Z", "type": "commit"}, {"oid": "d65914ac9905bfc9493df769e69798f8bb13b6b8", "url": "https://github.com/ldtteam/minecolonies/commit/d65914ac9905bfc9493df769e69798f8bb13b6b8", "message": "Fix formatting", "committedDate": "2020-04-25T19:49:40Z", "type": "commit"}, {"oid": "b53e68731433cc4cbd6b87801efbdb8305b3c093", "url": "https://github.com/ldtteam/minecolonies/commit/b53e68731433cc4cbd6b87801efbdb8305b3c093", "message": "Merge branch 'version/1.15' into fix/4758", "committedDate": "2020-04-25T19:54:27Z", "type": "commit"}, {"oid": "84fa0aaf06052529fb9c664f27a6f715c3b2bb2b", "url": "https://github.com/ldtteam/minecolonies/commit/84fa0aaf06052529fb9c664f27a6f715c3b2bb2b", "message": "Move the fix to TileEntityRack", "committedDate": "2020-04-25T20:20:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNzkyNg==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415137926", "bodyText": "int amount = ItemStackUtils.getSize(stack);\nif (content.containsKey(storage))\n{\namount += content.remove(storage);\n}\ncontent.put(storage, amount);\n\nWhy isn't this enough?", "author": "Raycoms", "createdAt": "2020-04-25T20:29:55Z", "path": "src/api/java/com/minecolonies/api/tileentities/TileEntityRack.java", "diffHunk": "@@ -225,12 +225,14 @@ public void updateItemStorage()\n                 continue;\n             }\n \n-            final ItemStorage storage = new ItemStorage(stack.copy());\n+            final ItemStack stackCopy = stack.copy();\n+            final ItemStorage storage = new ItemStorage(stackCopy);\n             int amount = ItemStackUtils.getSize(stack);\n             if (content.containsKey(storage))\n             {\n                 amount += content.remove(storage);\n             }\n+            stackCopy.setCount(amount);\n             content.put(storage, amount);\n         }", "originalCommit": "84fa0aaf06052529fb9c664f27a6f715c3b2bb2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzODI5Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415138293", "bodyText": "because this only uses the stack, not the amount.\nboth in the current, and my changed version.", "author": "ToMe25", "createdAt": "2020-04-25T20:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzODMxNg==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415138316", "bodyText": "that should work normally", "author": "lexustec", "createdAt": "2020-04-25T20:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzODc2OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415138769", "bodyText": "it gets the amount from the stack and adds it to the amount in the map. That should be enough", "author": "Raycoms", "createdAt": "2020-04-25T20:34:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzOTI5Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415139297", "bodyText": "Should i change it back to how it was in the second commit then? that didn't change TileEntityRack at all.", "author": "ToMe25", "createdAt": "2020-04-25T20:37:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzOTU0Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415139547", "bodyText": "none of this should be necessary of the above.", "author": "Raycoms", "createdAt": "2020-04-25T20:39:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0MzkyMA==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415143920", "bodyText": "does that mean you prefer leaving this alone like it was, and just changing the WindowHutAllInventory?", "author": "ToMe25", "createdAt": "2020-04-25T21:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0NDM4MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415144381", "bodyText": "The above code is correct. It should not be the cause of any issue.", "author": "Raycoms", "createdAt": "2020-04-25T21:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0NDk3Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415144973", "bodyText": "ok i changed it back.", "author": "ToMe25", "createdAt": "2020-04-25T21:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNzkyNg=="}], "type": "inlineReview"}, {"oid": "867a0ad8b5f1431e1a244fbcd8c0a88e63bf3dc6", "url": "https://github.com/ldtteam/minecolonies/commit/867a0ad8b5f1431e1a244fbcd8c0a88e63bf3dc6", "message": "Move the fix back to WindowHutAllInventory\n\nas that seems to be the prefered solution.", "committedDate": "2020-04-25T21:08:50Z", "type": "commit"}, {"oid": "3f60f2e9d059d2f00f6d923b273936db8c7faba9", "url": "https://github.com/ldtteam/minecolonies/commit/3f60f2e9d059d2f00f6d923b273936db8c7faba9", "message": "oops, formatting again", "committedDate": "2020-04-25T21:09:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0NDk5NA==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415144994", "bodyText": "This does not work officially, and even though it works in the current Mc version it is not officially supported. As such please change this to use itemstorage instances or use the proposed change by @Raycoms.", "author": "OrionDevelopment", "createdAt": "2020-04-25T21:10:51Z", "path": "src/main/java/com/minecolonies/coremod/client/gui/WindowHutAllInventory.java", "diffHunk": "@@ -147,7 +147,9 @@ private void updateResources()\n \n                 for (final Map.Entry<ItemStorage, Integer> entry : storage.entrySet())\n                 {\n-                    items.add(new ItemStorage(entry.getKey().getItemStack(), entry.getValue(), false).getItemStack());\n+                \tItemStack stack = entry.getKey().getItemStack().copy();", "originalCommit": "867a0ad8b5f1431e1a244fbcd8c0a88e63bf3dc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0NTMzOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415145339", "bodyText": "should i just change the items list to use ItemStorage instead of ItemStack then?", "author": "ToMe25", "createdAt": "2020-04-25T21:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0NDk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0ODk1Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415148957", "bodyText": "I did get rid of it now.", "author": "ToMe25", "createdAt": "2020-04-25T21:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0NDk5NA=="}], "type": "inlineReview"}, {"oid": "b9c73b0d03a2a62de6e8c2e6fb898a1248ca58dc", "url": "https://github.com/ldtteam/minecolonies/commit/b9c73b0d03a2a62de6e8c2e6fb898a1248ca58dc", "message": "Update this to no longer misuse ItemStacks", "committedDate": "2020-04-25T21:17:59Z", "type": "commit"}, {"oid": "88ab8f2181756b1fdf8dd38e8ffa6878780c3378", "url": "https://github.com/ldtteam/minecolonies/commit/88ab8f2181756b1fdf8dd38e8ffa6878780c3378", "message": "Remove ItemStorage List", "committedDate": "2020-04-25T21:22:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0OTE2NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415149165", "bodyText": "Yes better, and make this a Map<ItemStorage, Integer> and increment the quantity in the. And keep ItemStorage the same", "author": "Raycoms", "createdAt": "2020-04-25T21:36:04Z", "path": "src/main/java/com/minecolonies/coremod/client/gui/WindowHutAllInventory.java", "diffHunk": "@@ -135,7 +135,7 @@ private void updateResources()\n     {\n         final List<BlockPos> containerList = building.getContainerList();\n \n-        final List<ItemStack> items = new ArrayList<>();\n+        final Map<ItemStorage, ItemStorage> storedItems = new HashMap<>();\n         final World world = building.getColony().getWorld();", "originalCommit": "88ab8f2181756b1fdf8dd38e8ffa6878780c3378", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MTkxOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415151919", "bodyText": "Did that.", "author": "ToMe25", "createdAt": "2020-04-25T21:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0OTE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0OTc5MA==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415149790", "bodyText": "this should not be necessary.", "author": "Raycoms", "createdAt": "2020-04-25T21:40:05Z", "path": "src/api/java/com/minecolonies/api/tileentities/TileEntityRack.java", "diffHunk": "@@ -231,6 +231,7 @@ public void updateItemStorage()\n             {\n                 amount += content.remove(storage);\n             }\n+            storage.setAmount(amount);\n             content.put(storage, amount);", "originalCommit": "88ab8f2181756b1fdf8dd38e8ffa6878780c3378", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MDA3Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415150073", "bodyText": "ok i will remove it.", "author": "ToMe25", "createdAt": "2020-04-25T21:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0OTc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MTkwMA==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415151900", "bodyText": "I removed it.", "author": "ToMe25", "createdAt": "2020-04-25T21:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0OTc5MA=="}], "type": "inlineReview"}, {"oid": "2c5286655568afbc7698903b01346915b2af8012", "url": "https://github.com/ldtteam/minecolonies/commit/2c5286655568afbc7698903b01346915b2af8012", "message": "Change storedItems to Map<ItemStorage, Integer>", "committedDate": "2020-04-25T21:51:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MTg4MA==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415151880", "bodyText": "Is like this OK, or do i have to find another way to set the amount of the ItemStorage?", "author": "ToMe25", "createdAt": "2020-04-25T21:52:12Z", "path": "src/main/java/com/minecolonies/coremod/client/gui/WindowHutAllInventory.java", "diffHunk": "@@ -158,29 +165,25 @@ else if (rack instanceof ChestTileEntity)\n                     final ItemStack stack = ((ChestTileEntity) rack).getStackInSlot(slot);\n                     if (!ItemStackUtils.isEmpty(stack))\n                     {\n-                        items.add(stack.copy());\n+                        ItemStorage currentStorage = new ItemStorage(stack.copy());\n+                        if (storedItems.containsKey(currentStorage))\n+                        {\n+                            storedItems.put(currentStorage, storedItems.get(currentStorage) + stack.getCount());\n+                        }\n+                        else\n+                        {\n+                        \tstoredItems.put(currentStorage, stack.getCount());\n+                        }\n                     }\n                 }\n             }\n         }\n \n-        final Map<ItemStorage, ItemStorage> storedItems = new HashMap<>();\n-        for (final ItemStack currentItem : items)\n-        {\n-            final ItemStorage currentStorage = new ItemStorage(currentItem, currentItem.getCount(), false);\n-\n-            if (storedItems.containsKey(currentStorage))\n-            {\n-                final ItemStorage existing = storedItems.get(currentStorage);\n-                existing.setAmount(existing.getAmount() + currentStorage.getAmount());\n-            }\n-            else\n-            {\n-                storedItems.put(currentStorage, currentStorage);\n-            }\n-        }\n-\n-        final List<ItemStorage> filterItems = new ArrayList<>(storedItems.keySet());\n+        final List<ItemStorage> filterItems = new ArrayList<>();\n+        storedItems.forEach((storage, amount) -> {\n+            storage.setAmount(amount);\n+            filterItems.add(storage);\n+        });", "originalCommit": "2c5286655568afbc7698903b01346915b2af8012", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MjUwMw==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415152503", "bodyText": "Should be fine like this.\nDid you test this?", "author": "Raycoms", "createdAt": "2020-04-25T21:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MTg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MjU4Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415152583", "bodyText": "Yes i did.", "author": "ToMe25", "createdAt": "2020-04-25T21:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MTg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1Mjg0Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415152847", "bodyText": "If you want to suggest any more changes, i will look at it tomorrow, today its late enough :)", "author": "ToMe25", "createdAt": "2020-04-25T21:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MTg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1OTAyOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415159029", "bodyText": "Looks fine for me now. Does this solve all the issues there were before?\nCan you add an additional check to query the rack from the position of the building itself (it's not include din the list of containers, so it needs an additional line to add the stacks from it.", "author": "Raycoms", "createdAt": "2020-04-25T22:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MTg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTIzODA3MA==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415238070", "bodyText": "\"Does this solve all the issues there were before?\" idk, i don't know about many issues with this view, i just made this to fix the linked issue.\n\"Can you add an additional check to query the rack from the position of the building itself\" I can do that, but i think lexustec said he is working on that, so i wouldn't put that in here.", "author": "ToMe25", "createdAt": "2020-04-26T07:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MTg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI0OTAxMw==", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415249013", "bodyText": "\"Can you add an additional check to query the rack from the position of the building itself\"\nI have a working version for the warehouse now, i will test it with some other buildings, and than hopefully push it.", "author": "ToMe25", "createdAt": "2020-04-26T08:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MTg4MA=="}], "type": "inlineReview"}, {"oid": "8050bca9f8f0077a29845be3064811b44d1b54f8", "url": "https://github.com/ldtteam/minecolonies/commit/8050bca9f8f0077a29845be3064811b44d1b54f8", "message": "Add the hut block inventory to the stock view\n\nafter some more conversation with luxustec i now made a working version\nof this.", "committedDate": "2020-04-26T08:13:02Z", "type": "commit"}, {"oid": "8988840d1a1d99822fdb0e5bb7d407fcd0a513d8", "url": "https://github.com/ldtteam/minecolonies/commit/8988840d1a1d99822fdb0e5bb7d407fcd0a513d8", "message": "Remove unnecessary import\n\nalso rename storage map to rackStorage", "committedDate": "2020-04-26T08:17:26Z", "type": "commit"}, {"oid": "207ae1929139ab0424e8df4f53bf691eee31ad5e", "url": "https://github.com/ldtteam/minecolonies/commit/207ae1929139ab0424e8df4f53bf691eee31ad5e", "message": "Merge branch 'version/1.15' into fix/4758", "committedDate": "2020-04-26T08:49:13Z", "type": "commit"}, {"oid": "57fbdd425df7e7af61f2859429701bac05f2f47d", "url": "https://github.com/ldtteam/minecolonies/commit/57fbdd425df7e7af61f2859429701bac05f2f47d", "message": "Merge branch 'version/1.15' into fix/4758", "committedDate": "2020-04-26T08:51:58Z", "type": "commit"}, {"oid": "0a2be45cb7f9c150225c34848d43039859516286", "url": "https://github.com/ldtteam/minecolonies/commit/0a2be45cb7f9c150225c34848d43039859516286", "message": "Merge branch 'version/1.15' into fix/4758", "committedDate": "2020-04-27T08:48:41Z", "type": "commit"}, {"oid": "333bef6e3fd771fe5259b39baac4661cd01eeeb6", "url": "https://github.com/ldtteam/minecolonies/commit/333bef6e3fd771fe5259b39baac4661cd01eeeb6", "message": "Merge branch 'version/1.15' of https://github.com/ldtteam/minecolonies into fix/4758", "committedDate": "2020-04-27T08:49:05Z", "type": "commit"}, {"oid": "4637a25d457a1812a25d955b978aaf82f1c0f6fa", "url": "https://github.com/ldtteam/minecolonies/commit/4637a25d457a1812a25d955b978aaf82f1c0f6fa", "message": "Merge branch 'version/1.15' into fix/4758", "committedDate": "2020-04-27T08:49:22Z", "type": "commit"}, {"oid": "0596f3cc9d88d2df0deaffe4d36d84d8ab2a15ed", "url": "https://github.com/ldtteam/minecolonies/commit/0596f3cc9d88d2df0deaffe4d36d84d8ab2a15ed", "message": "Merge branch 'version/1.15' of https://github.com/ldtteam/minecolonies into fix/4758", "committedDate": "2020-04-27T08:49:35Z", "type": "commit"}, {"oid": "fd9a62af88faa3095aea2f9929c4aa6e9a2852a8", "url": "https://github.com/ldtteam/minecolonies/commit/fd9a62af88faa3095aea2f9929c4aa6e9a2852a8", "message": "Merge branch 'fix/4758' of https://github.com/ToMe25/minecolonies into fix/4758", "committedDate": "2020-04-27T08:50:36Z", "type": "commit"}, {"oid": "97430ae99a6a6ab4f5d36dd362cdf3e7425934c6", "url": "https://github.com/ldtteam/minecolonies/commit/97430ae99a6a6ab4f5d36dd362cdf3e7425934c6", "message": "Change chest handling to use LockableTileEntity instead of\nChestTileEntity", "committedDate": "2020-04-27T09:37:29Z", "type": "commit"}, {"oid": "81c438be03527b3b19078d1914a039fa5a0a6a9f", "url": "https://github.com/ldtteam/minecolonies/commit/81c438be03527b3b19078d1914a039fa5a0a6a9f", "message": "Remove chest support as it wasn't working anyways", "committedDate": "2020-04-27T11:29:44Z", "type": "commit"}, {"oid": "53c235370bf4e7efba2a568290a66ebc571647cb", "url": "https://github.com/ldtteam/minecolonies/commit/53c235370bf4e7efba2a568290a66ebc571647cb", "message": "oops, imports", "committedDate": "2020-04-27T11:33:09Z", "type": "commit"}, {"oid": "440bdb14d714076f85982319e8dd777a885fb654", "url": "https://github.com/ldtteam/minecolonies/commit/440bdb14d714076f85982319e8dd777a885fb654", "message": "Merge branch 'version/1.15' into fix/4758", "committedDate": "2020-04-29T08:31:42Z", "type": "commit"}]}