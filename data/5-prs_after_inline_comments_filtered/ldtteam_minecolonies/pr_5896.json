{"pr_number": 5896, "pr_title": "Feature/immutable storage", "pr_createdAt": "2020-10-09T08:34:19Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5896", "timeline": [{"oid": "b59a0c237ef722f038844386f2207bd9f0ca5b20", "url": "https://github.com/ldtteam/minecolonies/commit/b59a0c237ef722f038844386f2207bd9f0ca5b20", "message": "adjust", "committedDate": "2020-10-06T22:31:56Z", "type": "commit"}, {"oid": "c898861587b1dd75b030043d6fd59c3af35eed25", "url": "https://github.com/ldtteam/minecolonies/commit/c898861587b1dd75b030043d6fd59c3af35eed25", "message": "Add an Immutable Itemstorage version", "committedDate": "2020-10-06T22:32:00Z", "type": "commit"}, {"oid": "4cfadee92f5a951829a4caddaa348d1548ff0797", "url": "https://github.com/ldtteam/minecolonies/commit/4cfadee92f5a951829a4caddaa348d1548ff0797", "message": "remove the copy here", "committedDate": "2020-10-07T14:34:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxMTQ4Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/5896#discussion_r502311486", "bodyText": "So question, could we make this throw an exception in dev, but simply log an error in prod?\njust so we don't get crashes at least during prod if it's somehow missed in dev.\notherwise looks great", "author": "Asherslab", "createdAt": "2020-10-09T09:40:47Z", "path": "src/api/java/com/minecolonies/api/crafting/ImmutableItemStorage.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.minecolonies.api.crafting;\n+\n+import net.minecraft.item.ItemStack;\n+import org.jetbrains.annotations.NotNull;\n+\n+/**\n+ * Immutable ItemStorage version.\n+ */\n+public class ImmutableItemStorage extends ItemStorage\n+{\n+    /**\n+     * Creates an instance of the storage.\n+     *\n+     * @param storage the mutable itemstorage to create it from.\n+     */\n+    public ImmutableItemStorage(@NotNull final ItemStorage storage)\n+    {\n+        super(storage.getItemStack(), storage.ignoreDamageValue(), storage.ignoreNBT());\n+        super.setAmount(storage.getAmount());\n+    }\n+\n+    @Override\n+    public void setAmount(final int amount)\n+    {\n+        throw new UnsupportedOperationException(\"Immutable instance of ItemStorage can't set value!\");", "originalCommit": "4cfadee92f5a951829a4caddaa348d1548ff0797", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5OTY2MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5896#discussion_r502399661", "bodyText": "I actually do want it to crash \"for now\". If this here happens there would've been data corruption and just logging could potentially result in infinite loops and stackoverflow.", "author": "Raycoms", "createdAt": "2020-10-09T12:42:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxMTQ4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ5OTkzMw==", "url": "https://github.com/ldtteam/minecolonies/pull/5896#discussion_r502499933", "bodyText": "To be clear, this is 'corruption' is in-memory only, at least in the scenarios we've seen so far, since it's been on non-persisted ItemStorages. Correct?", "author": "Mekle001", "createdAt": "2020-10-09T15:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxMTQ4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwMjg5Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/5896#discussion_r502502893", "bodyText": "Yes, the problem is that if we don't increase the count here, but loop over this and use the count in a loop, this would be an infinite loop. I want to prevent that chance.", "author": "Raycoms", "createdAt": "2020-10-09T15:18:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxMTQ4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwMzk1OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5896#discussion_r502503959", "bodyText": "Understood, and agreed.", "author": "Mekle001", "createdAt": "2020-10-09T15:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxMTQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MzcyOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5896#discussion_r502383729", "bodyText": "its nice that the setamount can now be immutable, but wasnt the most common problem that the internal stack got modified? which we still can do with this version. should we maybe make an ItemStack wrapper for that case?", "author": "someaddons", "createdAt": "2020-10-09T12:11:37Z", "path": "src/api/java/com/minecolonies/api/crafting/ImmutableItemStorage.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.minecolonies.api.crafting;\n+\n+import net.minecraft.item.ItemStack;\n+import org.jetbrains.annotations.NotNull;\n+\n+/**\n+ * Immutable ItemStorage version.\n+ */\n+public class ImmutableItemStorage extends ItemStorage", "originalCommit": "4cfadee92f5a951829a4caddaa348d1548ff0797", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5NTY5NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5896#discussion_r502395695", "bodyText": "The actual problems I fixed were that the count of this storage were changed. I did check into ItemStack wrappers, but then thought that would become an overkill. It's because on creating a new ItemStack we gotta copy the old one, which needs to go in the constructor of the itemStack which itself calls the capability events which can be very slow if mods mess it up.", "author": "Raycoms", "createdAt": "2020-10-09T12:34:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MzcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ5ODk4MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5896#discussion_r502498981", "bodyText": "I know we'd talked about possibly doing some corruption checks on the retrieval of the item stack from the ItemStorage. It should be as simple as checking that if the amount is less than maxstack, the count == amount, etc..\nAt least then we'd have early warning that the internal stack was getting modified when it shouldn't be.", "author": "Mekle001", "createdAt": "2020-10-09T15:12:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MzcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwMzY0NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5896#discussion_r502503645", "bodyText": "I was thinking about easy ways to detecting it, but couldn't find any easy way that couldn't break in valid cases.", "author": "Raycoms", "createdAt": "2020-10-09T15:19:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MzcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwMTQzMg==", "url": "https://github.com/ldtteam/minecolonies/pull/5896#discussion_r502501432", "bodyText": "I get why you're doing this, and overall I love this change. I'm not looking forward to the merge conflict with my version that adds multiple outputs and predetermined secondary outputs based asking the IRecipe for them, etc.", "author": "Mekle001", "createdAt": "2020-10-09T15:16:07Z", "path": "src/api/java/com/minecolonies/api/crafting/RecipeStorage.java", "diffHunk": "@@ -137,22 +149,23 @@ public boolean canFullFillRecipe(final int qty, @NotNull final IItemHandler... i\n         final int neededMultiplier = CraftingUtils.calculateMaxCraftingCount(qty, this);\n         final List<ItemStorage> items = getCleanedInput();\n \n-        for (final ItemStorage stack : items)\n+        for (final ItemStorage storage : items)\n         {\n+            final ItemStack stack = storage.getItemStack();", "originalCommit": "4cfadee92f5a951829a4caddaa348d1548ff0797", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}