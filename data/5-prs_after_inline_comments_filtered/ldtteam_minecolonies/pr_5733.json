{"pr_number": 5733, "pr_title": "Delivery fixes", "pr_createdAt": "2020-09-07T15:32:30Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5733", "timeline": [{"oid": "8b7082e6ca3d0795b16d2c547172d53c8a50e393", "url": "https://github.com/ldtteam/minecolonies/commit/8b7082e6ca3d0795b16d2c547172d53c8a50e393", "message": "Delivery fixed", "committedDate": "2020-09-06T19:59:11Z", "type": "commit"}, {"oid": "2b761bef7ee4e7cb80abe0845d0cd5c90c4317ce", "url": "https://github.com/ldtteam/minecolonies/commit/2b761bef7ee4e7cb80abe0845d0cd5c90c4317ce", "message": "some cleanup", "committedDate": "2020-09-07T07:49:03Z", "type": "commit"}, {"oid": "91b8ab74baa4d532413bb7e6f54c1742306119e5", "url": "https://github.com/ldtteam/minecolonies/commit/91b8ab74baa4d532413bb7e6f54c1742306119e5", "message": "Improve smelter crafters + some rack insurances", "committedDate": "2020-09-07T15:31:40Z", "type": "commit"}, {"oid": "a6ec92440a3884b6adae44275c8bd2135669385f", "url": "https://github.com/ldtteam/minecolonies/commit/a6ec92440a3884b6adae44275c8bd2135669385f", "message": "Merge branch 'version/1.15' into delivery-fixes", "committedDate": "2020-09-07T15:32:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ5NzkzMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5733#discussion_r484497931", "bodyText": "stack.isItemEqual is gonna ignore nbt not sure if thats desired", "author": "someaddons", "createdAt": "2020-09-07T15:40:11Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/basic/AbstractEntityAIRequestSmelter.java", "diffHunk": "@@ -83,12 +80,37 @@ protected int getActionsDoneUntilDumping()\n     }\n \n     @Override\n-    protected int getExtendedOutputCount(final ItemStack primaryOutput)\n+    protected int getExtendedCount(final ItemStack stack)\n     {\n-        if(currentRecipeStorage != null && currentRecipeStorage.getIntermediate() == Blocks.FURNACE)\n+        if (currentRecipeStorage != null && currentRecipeStorage.getIntermediate() == Blocks.FURNACE)\n         {\n-            return job.getProgress();\n+            int count = 0;\n+            for (final BlockPos pos : getOwnBuilding().getFurnaces())\n+            {\n+                if (WorldUtil.isBlockLoaded(world, pos))\n+                {\n+                    final TileEntity entity = world.getTileEntity(pos);\n+                    if (entity instanceof FurnaceTileEntity)\n+                    {\n+                        final FurnaceTileEntity furnace = (FurnaceTileEntity) entity;\n+\n+                        final ItemStack smeltableSlot = furnace.getStackInSlot(SMELTABLE_SLOT);\n+                        final ItemStack resultSlot = furnace.getStackInSlot(RESULT_SLOT);\n+                        if (stack.isItemEqual(smeltableSlot))", "originalCommit": "a6ec92440a3884b6adae44275c8bd2135669385f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ5OTMyOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5733#discussion_r484499329", "bodyText": "are there nbt smelts?", "author": "Raycoms", "createdAt": "2020-09-07T15:43:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ5NzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwMDcyMg==", "url": "https://github.com/ldtteam/minecolonies/pull/5733#discussion_r484500722", "bodyText": "guess can happen with mods", "author": "someaddons", "createdAt": "2020-09-07T15:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ5NzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwMDgyMw==", "url": "https://github.com/ldtteam/minecolonies/pull/5733#discussion_r484500823", "bodyText": "Not that I'm aware of, at least in vanilla. I suspect it's possible in modded, and that is likely the way we want to go for the cook's dough.", "author": "Mekle001", "createdAt": "2020-09-07T15:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ5NzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwMTQ0MA==", "url": "https://github.com/ldtteam/minecolonies/pull/5733#discussion_r484501440", "bodyText": "just use our ItemStackUtils instead of vanilla all the time :D", "author": "someaddons", "createdAt": "2020-09-07T15:49:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ5NzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwODI1Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/5733#discussion_r484508257", "bodyText": "done", "author": "Raycoms", "createdAt": "2020-09-07T16:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ5NzkzMQ=="}], "type": "inlineReview"}, {"oid": "ebe28bc3365d67d5af304c183fa62feff23c8f71", "url": "https://github.com/ldtteam/minecolonies/commit/ebe28bc3365d67d5af304c183fa62feff23c8f71", "message": "aligned compare method", "committedDate": "2020-09-07T15:56:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNjE4OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5733#discussion_r484506189", "bodyText": "Should this be resultInCitizenInv?", "author": "Mekle001", "createdAt": "2020-09-07T16:01:45Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/basic/AbstractEntityAIRequestSmelter.java", "diffHunk": "@@ -438,92 +435,96 @@ private IAIState fillUpFurnace()\n \n         final int burningCount = countOfBurningFurnaces();\n         final TileEntity entity = world.getTileEntity(walkTo);\n-        if (entity instanceof FurnaceTileEntity)\n+        if (entity instanceof FurnaceTileEntity && currentRecipeStorage != null)\n         {\n             final FurnaceTileEntity furnace = (FurnaceTileEntity) entity;\n             final List<ItemStack> possibleFuels = getOwnBuilding().getAllowedFuel();\n \n+            possibleFuels.removeIf(stack -> stack.isItemEqual(currentRecipeStorage.getPrimaryOutput()));\n+            // There is always only one input.\n+            possibleFuels.removeIf(stack -> stack.isItemEqual(currentRecipeStorage.getCleanedInput().get(0).getItemStack()));\n+\n             //Stoke the furnaces\n-            if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(), item -> FurnaceTileEntity.isFuel(item) && possibleFuels.stream().anyMatch(candidate -> item.isItemEqual(candidate)))\n+            if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(), item -> FurnaceTileEntity.isFuel(item) && possibleFuels.stream().anyMatch(item::isItemEqual))\n                   && (hasSmeltableInFurnaceAndNoFuel(furnace) || hasNeitherFuelNorSmeltAble(furnace)))\n             {\n                 InventoryUtils.transferXOfFirstSlotInItemHandlerWithIntoInItemHandler(\n-                  worker.getInventoryCitizen(), item -> FurnaceTileEntity.isFuel(item) && possibleFuels.stream().anyMatch(candidate -> item.isItemEqual(candidate)), STACKSIZE,\n+                  worker.getInventoryCitizen(), item -> FurnaceTileEntity.isFuel(item) && possibleFuels.stream().anyMatch(item::isItemEqual), STACKSIZE,\n                   new InvWrapper(furnace), FUEL_SLOT);\n             }\n \n-            if(currentRecipeStorage != null)\n+            final int maxFurnaces = getMaxUsableFurnaces();\n+            final Predicate<ItemStack> smeltable = stack -> currentRecipeStorage.getCleanedInput().get(0).getItemStack().isItemEqual(stack);\n+            final int smeltableInFurnaces = getExtendedCount(currentRecipeStorage.getCleanedInput().get(0).getItemStack());\n+            final int resultInFurnaces = getExtendedCount(currentRecipeStorage.getPrimaryOutput());\n+            final int resultInPlayerInv = InventoryUtils.getItemCountInItemHandler(worker.getInventoryCitizen(), stack -> stack.isItemEqual(currentRecipeStorage.getPrimaryOutput()));", "originalCommit": "a6ec92440a3884b6adae44275c8bd2135669385f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNjc0Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/5733#discussion_r484506746", "bodyText": "ye", "author": "Raycoms", "createdAt": "2020-09-07T16:03:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNjE4OQ=="}], "type": "inlineReview"}, {"oid": "e4844e0e89809153855883e8beaa3b22410d5fbe", "url": "https://github.com/ldtteam/minecolonies/commit/e4844e0e89809153855883e8beaa3b22410d5fbe", "message": "fix naming", "committedDate": "2020-09-07T16:03:49Z", "type": "commit"}, {"oid": "abdb0a729a426154d93a5ef1633c608fc91fb76a", "url": "https://github.com/ldtteam/minecolonies/commit/abdb0a729a426154d93a5ef1633c608fc91fb76a", "message": "Merge remote-tracking branch 'origin/delivery-fixes' into delivery-fixes", "committedDate": "2020-09-07T16:03:54Z", "type": "commit"}]}