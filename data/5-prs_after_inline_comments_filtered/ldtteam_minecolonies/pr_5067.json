{"pr_number": 5067, "pr_title": "Replaces randomized deliveryman gathering with targeted pickup-requests", "pr_createdAt": "2020-05-24T15:52:01Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5067", "timeline": [{"oid": "95d237f8ab317d6cafb47c73ec873d41448c5da1", "url": "https://github.com/ldtteam/minecolonies/commit/95d237f8ab317d6cafb47c73ec873d41448c5da1", "message": "PROTOTYPE! DO NOT MERGE! Started work on dman request refactoring", "committedDate": "2020-05-21T19:24:41Z", "type": "commit"}, {"oid": "09551b45471e78a0e83c7af70f5752423ff3929f", "url": "https://github.com/ldtteam/minecolonies/commit/09551b45471e78a0e83c7af70f5752423ff3929f", "message": "PROTOTYPE! DO NOT MERGE! Mainly reworked Deliveryman AI", "committedDate": "2020-05-21T23:58:36Z", "type": "commit"}, {"oid": "ee8f836baf67d5e8345ea088c96942bc268190ef", "url": "https://github.com/ldtteam/minecolonies/commit/ee8f836baf67d5e8345ea088c96942bc268190ef", "message": "Prepared deliveryman for new pickup system", "committedDate": "2020-05-22T17:43:43Z", "type": "commit"}, {"oid": "4a34ee1fb881332e4d39248bb72495788aa0f723", "url": "https://github.com/ldtteam/minecolonies/commit/4a34ee1fb881332e4d39248bb72495788aa0f723", "message": "Made workers create a pickup request after dump.", "committedDate": "2020-05-22T19:15:21Z", "type": "commit"}, {"oid": "4603247b5bee04ff36ba43e5bea03b7273e0f9cc", "url": "https://github.com/ldtteam/minecolonies/commit/4603247b5bee04ff36ba43e5bea03b7273e0f9cc", "message": "Aligned code with reality", "committedDate": "2020-05-22T21:27:06Z", "type": "commit"}, {"oid": "94939217b33cccd4a1c934787f70c6826dc28069", "url": "https://github.com/ldtteam/minecolonies/commit/94939217b33cccd4a1c934787f70c6826dc28069", "message": "Almost completed prototype. Deliveryman can now pickup on-demand", "committedDate": "2020-05-22T23:07:27Z", "type": "commit"}, {"oid": "3202fa4812b58248fc22ca394e71b768e6da84f9", "url": "https://github.com/ldtteam/minecolonies/commit/3202fa4812b58248fc22ca394e71b768e6da84f9", "message": "Added info text on force pickup", "committedDate": "2020-05-23T19:15:46Z", "type": "commit"}, {"oid": "d8d5706dd20ad0f870a00c3d7d7092a558460f0a", "url": "https://github.com/ldtteam/minecolonies/commit/d8d5706dd20ad0f870a00c3d7d7092a558460f0a", "message": "Improved overall stability of the dman", "committedDate": "2020-05-23T23:25:58Z", "type": "commit"}, {"oid": "11cd22e03bf6e4f0df7e1ec86c26edbca3a1dd5f", "url": "https://github.com/ldtteam/minecolonies/commit/11cd22e03bf6e4f0df7e1ec86c26edbca3a1dd5f", "message": "Adapted delays a bit, and don't request a pickup when another request is already active.", "committedDate": "2020-05-24T00:02:50Z", "type": "commit"}, {"oid": "e2511aa580136c0526e642a6d152ddf0af31ee67", "url": "https://github.com/ldtteam/minecolonies/commit/e2511aa580136c0526e642a6d152ddf0af31ee67", "message": "Updated RS version", "committedDate": "2020-05-24T08:56:01Z", "type": "commit"}, {"oid": "3bff523867e61ac49cced9927b7616584f46111f", "url": "https://github.com/ldtteam/minecolonies/commit/3bff523867e61ac49cced9927b7616584f46111f", "message": "Merge remote-tracking branch 'upstream/version/1.15' into feature/wip-request-pickup", "committedDate": "2020-05-24T08:56:44Z", "type": "commit"}, {"oid": "c2f58392cc7d4d3c9bf7e171230b00dc44af0822", "url": "https://github.com/ldtteam/minecolonies/commit/c2f58392cc7d4d3c9bf7e171230b00dc44af0822", "message": "Made it so that the builder also doesn't keep requesting pickups.", "committedDate": "2020-05-24T14:10:34Z", "type": "commit"}, {"oid": "4a19b255cafc070a7c75d263f4ff6db25757e7e2", "url": "https://github.com/ldtteam/minecolonies/commit/4a19b255cafc070a7c75d263f4ff6db25757e7e2", "message": "Streamlined delays", "committedDate": "2020-05-24T15:05:53Z", "type": "commit"}, {"oid": "5c619830b632f8886c07316ef8448287c5e7e274", "url": "https://github.com/ldtteam/minecolonies/commit/5c619830b632f8886c07316ef8448287c5e7e274", "message": "Removed unnecessary imports", "committedDate": "2020-05-24T15:45:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1MDg2OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r429650869", "bodyText": "Ahh nice, that's what you mean with this, yes, this works fine", "author": "Raycoms", "createdAt": "2020-05-24T16:01:30Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/basic/AbstractEntityAICrafting.java", "diffHunk": "@@ -355,4 +356,10 @@ private int getRequiredProgressForMakingRawMaterial()\n     {\n         return PROGRESS_MULTIPLIER / Math.min(worker.getCitizenData().getJobModifier() + 1, MAX_LEVEL) * HITTING_TIME;\n     }\n+\n+    @Override\n+    public boolean isAfterDumpPickupAllowed()\n+    {\n+        return currentRequest == null;\n+    }", "originalCommit": "5c619830b632f8886c07316ef8448287c5e7e274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1df41d6bb78b072ca6a70b3249ade20c08dc9090", "url": "https://github.com/ldtteam/minecolonies/commit/1df41d6bb78b072ca6a70b3249ade20c08dc9090", "message": "Added a (somewhat lazy) protection against pickup-request spam while inventory is full", "committedDate": "2020-05-24T17:41:31Z", "type": "commit"}, {"oid": "ead3609d3fce423bf0e3b5d1fb71d2c650162e54", "url": "https://github.com/ldtteam/minecolonies/commit/ead3609d3fce423bf0e3b5d1fb71d2c650162e54", "message": "Added missing comment for isPickupLockEnabled", "committedDate": "2020-05-24T17:46:41Z", "type": "commit"}, {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b", "url": "https://github.com/ldtteam/minecolonies/commit/b0d717897751eb0bb341b407f70c564a2da2bf6b", "message": "Use built-in-function instead of isPickupLockEnabled to avoid multiple pickup-requests at once.", "committedDate": "2020-05-24T21:05:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0NzE0MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r429747141", "bodyText": "Sadly this will never work.\nThe Delivery can not, and will never, have control over execution order of its tasks.\nThe RS handles ordering and as such the DMan should never alter them, since this might mess up request-trees, if one order gets executed before another. Yes you might have it working now, but this is fragile and the RS handles this internally already.", "author": "OrionDevelopment", "createdAt": "2020-05-25T06:09:53Z", "path": "src/api/java/com/minecolonies/api/colony/requestsystem/requestable/deliveryman/AbstractDeliverymanRequestable.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.minecolonies.api.colony.requestsystem.requestable.deliveryman;\n+\n+public abstract class AbstractDeliverymanRequestable implements IDeliverymanRequestable\n+{\n+    ////// --------------------------- NBTConstants --------------------------- \\\\\\\\\\\\\n+    protected static final String NBT_PRIORITY = \"Priority\";\n+    ////// --------------------------- NBTConstants --------------------------- \\\\\\\\\\\\\n+\n+    public static final int MAX_DELIVERYMAN_STANDARD_PRIORITY = 10;\n+    public static final int MAX_DELIVERYMAN_AGING_PRIORITY    = 11;\n+    public static final int MAX_DELIVERYMAN_PLAYER_PRIORITY   = 12;\n+\n+    protected int priority = 0;\n+\n+    protected AbstractDeliverymanRequestable(final int priority)\n+    {\n+        this.priority = priority;\n+    }\n+\n+    @Override\n+    public int getPriority()\n+    {\n+        return priority;\n+    }\n+\n+    @Override\n+    public void incrementPriorityDueToAging()\n+    {\n+        // The priority set by by the aging mechanism can actually exceed the maximum priority that requesters can choose.\n+        // Worst case, the priority queue turns into a FIFO queue for really old requests, with new maximum-priority requests having to wait.\n+        priority = Math.min(MAX_DELIVERYMAN_AGING_PRIORITY, priority + 1);", "originalCommit": "b0d717897751eb0bb341b407f70c564a2da2bf6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0MzI2NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430043265", "bodyText": "missing javadoc", "author": "someaddons", "createdAt": "2020-05-25T18:35:45Z", "path": "src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/PickupRequestResolver.java", "diffHunk": "@@ -0,0 +1,172 @@\n+package com.minecolonies.coremod.colony.requestsystem.resolvers;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.reflect.TypeToken;\n+import com.minecolonies.api.colony.ICitizenData;\n+import com.minecolonies.api.colony.requestsystem.location.ILocation;\n+import com.minecolonies.api.colony.requestsystem.manager.IRequestManager;\n+import com.minecolonies.api.colony.requestsystem.request.IRequest;\n+import com.minecolonies.api.colony.requestsystem.requestable.deliveryman.Pickup;\n+import com.minecolonies.api.colony.requestsystem.token.IToken;\n+import com.minecolonies.api.util.BlockPosUtil;\n+import com.minecolonies.api.util.Log;\n+import com.minecolonies.api.util.constant.TranslationConstants;\n+import com.minecolonies.api.util.constant.TypeConstants;\n+import com.minecolonies.coremod.colony.Colony;\n+import com.minecolonies.coremod.colony.jobs.JobDeliveryman;\n+import com.minecolonies.coremod.colony.requestsystem.resolvers.core.AbstractRequestResolver;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.text.ITextComponent;\n+import net.minecraft.util.text.TranslationTextComponent;\n+import org.jetbrains.annotations.NotNull;\n+import org.jetbrains.annotations.Nullable;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+\n+public class PickupRequestResolver extends AbstractRequestResolver<Pickup>", "originalCommit": "b0d717897751eb0bb341b407f70c564a2da2bf6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3NzkwOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430077909", "bodyText": "Fixed in b2b9ff1. Also added the an equivalent comment to DeliveryRequestResolver.", "author": "JiaYow", "createdAt": "2020-05-25T21:25:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0MzI2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0MzgzMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430043831", "bodyText": "How frequently is this called? might want to use a normal loop instead of streams", "author": "someaddons", "createdAt": "2020-05-25T18:38:23Z", "path": "src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/PickupRequestResolver.java", "diffHunk": "@@ -0,0 +1,172 @@\n+package com.minecolonies.coremod.colony.requestsystem.resolvers;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.reflect.TypeToken;\n+import com.minecolonies.api.colony.ICitizenData;\n+import com.minecolonies.api.colony.requestsystem.location.ILocation;\n+import com.minecolonies.api.colony.requestsystem.manager.IRequestManager;\n+import com.minecolonies.api.colony.requestsystem.request.IRequest;\n+import com.minecolonies.api.colony.requestsystem.requestable.deliveryman.Pickup;\n+import com.minecolonies.api.colony.requestsystem.token.IToken;\n+import com.minecolonies.api.util.BlockPosUtil;\n+import com.minecolonies.api.util.Log;\n+import com.minecolonies.api.util.constant.TranslationConstants;\n+import com.minecolonies.api.util.constant.TypeConstants;\n+import com.minecolonies.coremod.colony.Colony;\n+import com.minecolonies.coremod.colony.jobs.JobDeliveryman;\n+import com.minecolonies.coremod.colony.requestsystem.resolvers.core.AbstractRequestResolver;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.text.ITextComponent;\n+import net.minecraft.util.text.TranslationTextComponent;\n+import org.jetbrains.annotations.NotNull;\n+import org.jetbrains.annotations.Nullable;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+\n+public class PickupRequestResolver extends AbstractRequestResolver<Pickup>\n+{\n+    public PickupRequestResolver(\n+      @NotNull final ILocation location,\n+      @NotNull final IToken<?> token)\n+    {\n+        super(location, token);\n+    }\n+\n+    @Override\n+    public TypeToken<? extends Pickup> getRequestType()\n+    {\n+        return TypeConstants.PICKUP;\n+    }\n+\n+    @Override\n+    public boolean canResolveRequest(@NotNull final IRequestManager manager, final IRequest<? extends Pickup> requestToCheck)\n+    {\n+        if (manager.getColony().getWorld().isRemote)\n+        {\n+            return false;\n+        }\n+\n+        final Colony colony = (Colony) manager.getColony();\n+        final ICitizenData freeDeliveryMan = colony.getCitizenManager().getCitizens()", "originalCommit": "b0d717897751eb0bb341b407f70c564a2da2bf6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NTU0MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430065541", "bodyText": "This is Orion's code. I'm not touching that xD\n\n  \n    \n      minecolonies/src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/DeliveryRequestResolver.java\n    \n    \n         Line 51\n      in\n      3004c9f\n    \n    \n    \n    \n\n        \n          \n           .stream()", "author": "JiaYow", "createdAt": "2020-05-25T20:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0MzgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NTc5MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430065791", "bodyText": "hehe xD", "author": "someaddons", "createdAt": "2020-05-25T20:21:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0MzgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NjE5OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430066199", "bodyText": "We can make a PR once going through all .stream calls and calculating if its worth having a stream there or if the overhead would be really high.", "author": "Raycoms", "createdAt": "2020-05-25T20:23:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0MzgzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0NDgyMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430044821", "bodyText": "missing javadoc in this class too", "author": "someaddons", "createdAt": "2020-05-25T18:42:57Z", "path": "src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/factory/PickupRequestResolverFactory.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.minecolonies.coremod.colony.requestsystem.resolvers.factory;\n+\n+import com.google.common.reflect.TypeToken;\n+import com.minecolonies.api.colony.requestsystem.factory.IFactoryController;\n+import com.minecolonies.api.colony.requestsystem.location.ILocation;\n+import com.minecolonies.api.colony.requestsystem.resolver.IRequestResolverFactory;\n+import com.minecolonies.api.colony.requestsystem.token.IToken;\n+import com.minecolonies.api.util.constant.TypeConstants;\n+import com.minecolonies.coremod.colony.requestsystem.resolvers.PickupRequestResolver;\n+import net.minecraft.nbt.CompoundNBT;\n+import org.jetbrains.annotations.NotNull;\n+\n+public class PickupRequestResolverFactory implements IRequestResolverFactory<PickupRequestResolver>", "originalCommit": "b0d717897751eb0bb341b407f70c564a2da2bf6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3Nzc3Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430077776", "bodyText": "Fixed in b2b9ff1.", "author": "JiaYow", "createdAt": "2020-05-25T21:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0NDgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0NzYwMA==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430047600", "bodyText": "outdated todo? its using ((IBuildingWorker) targetBuilding)::isItemStackInRequest", "author": "someaddons", "createdAt": "2020-05-25T18:54:51Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/deliveryman/EntityAIWorkDeliveryman.java", "diffHunk": "@@ -521,70 +355,74 @@ else if (buildingToDeliver == null)\n             extracted = true;\n             final ItemStack insertionResultStack;\n \n-            if (iTileEntityColonyBuilding.getBuilding() instanceof AbstractBuildingWorker)\n+            // TODO: Please only push items into the target that were actually requested.", "originalCommit": "b0d717897751eb0bb341b407f70c564a2da2bf6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1NzE4Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430057186", "bodyText": "I love how we all fall into that particular pit. No, isItemStackInRequest doesn't filter the items. It prevents those items from being replaced by forceItemStackToItemHandler (which would happen if the inventory was full).", "author": "JiaYow", "createdAt": "2020-05-25T19:41:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0NzYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1NzMxOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430057319", "bodyText": "oh lol :D", "author": "someaddons", "createdAt": "2020-05-25T19:42:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0NzYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NTU3OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430065579", "bodyText": "It's like those exclude predicates in vanilla to get entities", "author": "Raycoms", "createdAt": "2020-05-25T20:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0NzYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430048762", "bodyText": "think you want to use an ItemStackUtils comparing function for this since afaik requests are also nbt sensitive", "author": "someaddons", "createdAt": "2020-05-25T19:00:10Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/deliveryman/EntityAIWorkDeliveryman.java", "diffHunk": "@@ -596,50 +434,33 @@ else if (buildingToDeliver instanceof TileEntityColonyBuilding)\n      */\n     private IAIState prepareDelivery()\n     {\n-        final IBuildingWorker ownBuilding = getOwnBuilding();\n-        if (ownBuilding instanceof BuildingDeliveryman)\n+        final IRequest<? extends IRequestable> currentTask = job.getCurrentTask();\n+        final IRequestable request = currentTask.getRequest();\n+        if (!(request instanceof Delivery))\n         {\n-            final IRequest<? extends Delivery> request = job.getCurrentTask();\n-            if (request != null)\n-            {\n-                if (job.isReturning())\n-                {\n-                    return DUMPING;\n-                }\n-                ((IBuildingDeliveryman) ownBuilding).setBuildingToDeliver(request.getRequest().getTarget());\n-                if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(),\n-                  itemStack -> request.getRequest().getStack().isItemEqualIgnoreDurability(itemStack)))\n-                {\n-                    return DELIVERY;\n-                }\n+            // The current task has changed since the Decision-state.\n+            // Restart.\n+            return START_WORKING;\n+        }\n \n-                return gatherItems(request);\n-            }\n+        final Delivery delivery = (Delivery) request;\n+        if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(),\n+          itemStack -> delivery.getStack().isItemEqualIgnoreDurability(itemStack)))", "originalCommit": "b0d717897751eb0bb341b407f70c564a2da2bf6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1NzY2OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430057669", "bodyText": "Blame @Raycoms. I only changed the formatting here, not the logic. Ray, what do you think?", "author": "JiaYow", "createdAt": "2020-05-25T19:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1Nzk5MA==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430057990", "bodyText": "interesting, maybe thats one of the things throwing the dman off", "author": "someaddons", "createdAt": "2020-05-25T19:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NTc1OA==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430065758", "bodyText": "Since he got the exact delivery from the RS, just equals should be fine here yes. Maybe having one that matches with ignore durability but doesn't match the normal way here, is really throwing him off.", "author": "Raycoms", "createdAt": "2020-05-25T20:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NTc4Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430065786", "bodyText": "isItemEqual I mean.", "author": "Raycoms", "createdAt": "2020-05-25T20:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE1NzI2MA==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430157260", "bodyText": "He need to check for nbt and meta equal. Item Equality is not enough at this stage.", "author": "OrionDevelopment", "createdAt": "2020-05-26T05:04:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzMzY3NA==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430233674", "bodyText": "Yes, isItemEqual does check that. While isItemEqualIgnoreDurability checks less.", "author": "Raycoms", "createdAt": "2020-05-26T08:13:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQwMzY5Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430403696", "bodyText": "Okey yeah then it needs to be isItemEqual", "author": "OrionDevelopment", "createdAt": "2020-05-26T13:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxNzQzNg==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430617436", "bodyText": "Changed in 51e3213.", "author": "JiaYow", "createdAt": "2020-05-26T18:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM1NTkzMA==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r431355930", "bodyText": "Okay, tried it one more time with aac342d.\nIt now uses ItemStackUtils.compareItemStacksIgnoreStackSize, same as gatherIfInTileEntity.", "author": "JiaYow", "createdAt": "2020-05-27T18:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1MDA2Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430050066", "bodyText": "javadoc here too please :D", "author": "someaddons", "createdAt": "2020-05-25T19:06:23Z", "path": "src/main/java/com/minecolonies/coremod/network/messages/server/colony/building/ForcePickupMessage.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package com.minecolonies.coremod.network.messages.server.colony.building;\n+\n+import com.minecolonies.api.colony.IColony;\n+import com.minecolonies.api.colony.buildings.IBuilding;\n+import com.minecolonies.api.colony.buildings.views.IBuildingView;\n+import com.minecolonies.api.colony.requestsystem.requestable.deliveryman.Pickup;\n+import com.minecolonies.coremod.network.messages.server.AbstractBuildingServerMessage;\n+import net.minecraft.network.PacketBuffer;\n+import net.minecraftforge.fml.network.NetworkEvent;\n+import org.jetbrains.annotations.NotNull;\n+\n+import static com.minecolonies.api.colony.requestsystem.requestable.deliveryman.AbstractDeliverymanRequestable.MAX_DELIVERYMAN_PLAYER_PRIORITY;\n+\n+public class ForcePickupMessage extends AbstractBuildingServerMessage<IBuilding>", "originalCommit": "b0d717897751eb0bb341b407f70c564a2da2bf6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3NzY4MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430077681", "bodyText": "Fixed in b2b9ff1.", "author": "JiaYow", "createdAt": "2020-05-25T21:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1MDA2Ng=="}], "type": "inlineReview"}, {"oid": "deccf790812e9606dee0df91d3dccf2effba469a", "url": "https://github.com/ldtteam/minecolonies/commit/deccf790812e9606dee0df91d3dccf2effba469a", "message": "Fixed the stash, made it so that only one pickup request can be active per building, reduced pickup delay to 2 ticks (gathering larger buildings took too long)", "committedDate": "2020-05-25T19:22:32Z", "type": "commit"}, {"oid": "b2b9ff1f114a99ded4bef9716d967d5d29ca2d43", "url": "https://github.com/ldtteam/minecolonies/commit/b2b9ff1f114a99ded4bef9716d967d5d29ca2d43", "message": "Added Javadoc", "committedDate": "2020-05-25T19:54:57Z", "type": "commit"}, {"oid": "2d821950bc74740f327fd6ff826234e4cbac44e2", "url": "https://github.com/ldtteam/minecolonies/commit/2d821950bc74740f327fd6ff826234e4cbac44e2", "message": "Merge branch 'up/version/1.15' into feature/request-pickup\n\nConflicts:\n\tsrc/api/java/com/minecolonies/api/util/constant/TranslationConstants.java\n\tsrc/main/java/com/minecolonies/coremod/entity/ai/citizen/builder/EntityAIStructureBuilder.java\n\tsrc/main/java/com/minecolonies/coremod/entity/ai/citizen/deliveryman/EntityAIWorkDeliveryman.java", "committedDate": "2020-05-25T20:11:21Z", "type": "commit"}, {"oid": "844cd2eae24618e468941dc99511ebb1fcebc494", "url": "https://github.com/ldtteam/minecolonies/commit/844cd2eae24618e468941dc99511ebb1fcebc494", "message": "Merge branch 'up/version/1.15' into feature/request-pickup", "committedDate": "2020-05-25T20:24:43Z", "type": "commit"}, {"oid": "2ea2300ee1ebcee339fc8eccbfb63d8fff1f5ad6", "url": "https://github.com/ldtteam/minecolonies/commit/2ea2300ee1ebcee339fc8eccbfb63d8fff1f5ad6", "message": "Merge branch 'up/version/1.15' into feature/request-pickup", "committedDate": "2020-05-25T20:55:11Z", "type": "commit"}, {"oid": "4cd0e424a710039d30c24bfd11d5661641dcae34", "url": "https://github.com/ldtteam/minecolonies/commit/4cd0e424a710039d30c24bfd11d5661641dcae34", "message": "Caught possible nullpointer exception.", "committedDate": "2020-05-25T22:07:16Z", "type": "commit"}, {"oid": "51e3213491c7a0abc6f765647e87095be07cf004", "url": "https://github.com/ldtteam/minecolonies/commit/51e3213491c7a0abc6f765647e87095be07cf004", "message": "Changed the dman's item comparator to be nbt-sensitive, since the RS will tell the dman *exactly* what to pick up.", "committedDate": "2020-05-26T18:22:49Z", "type": "commit"}, {"oid": "aac342d565ef17f85ec20696949296eb6e01780c", "url": "https://github.com/ldtteam/minecolonies/commit/aac342d565ef17f85ec20696949296eb6e01780c", "message": "Another attempt to get the item comparison during prepareDelivery() right, using ItemStackUtils this time.", "committedDate": "2020-05-27T18:28:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM1NjE2Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r431356167", "bodyText": "Looks fine, @OrionDevelopment let's merge this?", "author": "Raycoms", "createdAt": "2020-05-27T18:29:44Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/deliveryman/EntityAIWorkDeliveryman.java", "diffHunk": "@@ -450,7 +450,7 @@ private IAIState prepareDelivery()\n \n         final Delivery delivery = (Delivery) currentTask.getRequest();\n         if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(),\n-          itemStack -> delivery.getStack().isItemEqual(itemStack)))\n+          itemStack -> ItemStackUtils.compareItemStacksIgnoreStackSize(delivery.getStack(), itemStack)))", "originalCommit": "aac342d565ef17f85ec20696949296eb6e01780c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "99d22886eda746e50131ec8a473ff393fa0ed2fb", "url": "https://github.com/ldtteam/minecolonies/commit/99d22886eda746e50131ec8a473ff393fa0ed2fb", "message": "Merge branch 'version/1.15' into feature/request-pickup", "committedDate": "2020-05-28T19:21:33Z", "type": "commit"}]}