{"pr_number": 6160, "pr_title": "#5218 Support more varied fishing rods.  Also improves fisher mainhand equips.", "pr_createdAt": "2020-11-26T22:18:34Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/6160", "timeline": [{"oid": "ad682a544e883bafc5f9648c8e1805dd9c78073f", "url": "https://github.com/ldtteam/minecolonies/commit/ad682a544e883bafc5f9648c8e1805dd9c78073f", "message": "Changed most tests for fishing rods from == Items.FishingRod to instanceof FishingRodItem.  This allows fishers to use Aquaculture Fishing Rods, and should allow support for most other modded fishing rods (or any other item that implements FishingRodItem, like the XercaMod GrabHook).\n\nAlso converted the fishing rod's getMiningLevel logic to test against durability and enchantment levels, instead of allowing any usage from any completed hut level.  In a vanilla+minecolonies setup, this basically just requires higher hut tiers for enchanted fishing rods.  With Aquaculture, Wood or Gold for Tier 1, Iron for Tier 2, and Diamond/Neptunium requiring T3 or higher, with an extra hut tier required per enchantment level (using the same rules as other huts).  A Neptunium Rod with Luck/Lure III thus only works at T5 Fishing Huts.  This is based on durability, so it should support most common approaches for fishing rods, and falls back to T1 if someone makes an invulnerable rod.\n\nFinally, fishers who can't find a compatible fishing rod will swap to an air block, and changes method to check rods so that equipped rod will swap if it doesn't match the intended fishing rod.  This is a little more computationally expensive than the previous approach, but will avoid issue where fisher would appear to be holding a rod they no longer possessed in inventory.  May not solve issue if fisher is fired and then rod is pulled from their inventory.", "committedDate": "2020-11-26T21:35:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI1MjI1NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r531252255", "bodyText": "Isn't there a registry where we could get that dynamically? Like maybe getting another tool and comparing the durability to make this more dynamic?", "author": "Raycoms", "createdAt": "2020-11-26T23:26:27Z", "path": "src/api/java/com/minecolonies/api/util/ItemStackUtils.java", "diffHunk": "@@ -312,6 +314,20 @@ else if (ToolType.HELMET.equals(toolType)\n                 return getArmorLevel(ArmorItem.getArmorMaterial());\n             }\n         }\n+        else if (stack.getItem() instanceof FishingRodItem)\n+        {\n+            if(stack.getItem().isDamageable())\n+            {\n+                if(stack.getMaxDamage() < DURABILITY_MAX_WOOD_OR_GOLD)", "originalCommit": "ad682a544e883bafc5f9648c8e1805dd9c78073f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM3OTExOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r531379119", "bodyText": "Because Fishing Rods are used much slower than other tools, Aquaculture gives them lower max durability: an Aquaculture Diamond Fishing Rod's max durability is 450 to the 1561 of vanilla's Diamond Pick/Axe/Shovel/Sword, and even a Neptunum Fishing Rod only goes to 1000.  The disparity is less extreme for iron, but at 125 the Aquaculture Iron Fishing Rod has lower durability than a vanilla Stone Pickaxe's 131.\nThermal Foundation's custom fishing rods more closely match their vanilla equivalents, but even they are a little off (TF Iron Fishing Rods at 255 and not 250, for example, which is conveniently just the wrong direction for munging it with greater or less than signs). I picked 400 so that steel and invar fishing rods (https://teamcofh.com/docs/1.12/thermal-foundation/fishing-rods/) would require a higher tier hut, for example, but that is admittedly a magic number.\nComparing to multiples of the vanilla fishing rod would better handle situations where someone just buffs the vanilla one, but net.minecraft.Items.FISHING_ROD.getMaxDurability() is deprecated and I'm not sure there's a way to get a generic ItemStack.FISHING_ROD.  net.minecraft.item.ItemTier would normally be great, but vanilla fishing rods don't use it to determine their uses, nor match its pattern.\nI suppose using ItemTier's getMaxUses, adjusting it, and leaving a comment about the offsets is probably the best option.\nEDIT: cleaned up code, swapped to ItemTier.Material.getMaxUses and an offset.  ThermalFoundation Silver is a stupid place to set the line from T1 to T2 since it hasn't even been ported to 1.16 yet, but they ended up in dungeon loot tables enough in 1.12 that it's probably better than most alternative points.  Also set a check against vanilla rods to always set them to T1 + enchantment value, just in case someone them ultra-durable without adding any other rod types.", "author": "gattsuru", "createdAt": "2020-11-27T04:40:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI1MjI1NQ=="}], "type": "inlineReview"}, {"oid": "1c8408fcfee5c4b832ed552ef53c87fe599cbb86", "url": "https://github.com/ldtteam/minecolonies/commit/1c8408fcfee5c4b832ed552ef53c87fe599cbb86", "message": "Removes hard-coded durability constants, changes ItemStackUtils to use net.minecraft.items.ItemTier.getMaxUses to estimate fishing rod tier levels.  Still requires an offset, but less of a magic number.\n\nAlso moves the calculations out of getMiningLevel into a proper function, and cleans up a trailing comment left from the last commit.", "committedDate": "2020-11-27T05:17:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1ODMxMA==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532058310", "bodyText": "We always add braces, even on those ifs", "author": "Raycoms", "createdAt": "2020-11-28T16:32:02Z", "path": "src/api/java/com/minecolonies/api/util/ItemStackUtils.java", "diffHunk": "@@ -479,6 +483,33 @@ else if (damageReductionAmount <= ArmorMaterial.DIAMOND.getDamageReductionAmount\n         return 5;\n     }\n \n+    /**\n+     * Estimates the fishing rod tier from available durability and enchantment status.\n+     * @param itemStack the tool to check.\n+     * @return equivalent tool level.\n+     */\n+    private static int getFishingRodLevel(final ItemStack itemStack)\n+    {\n+        if(itemStack.getItem() == Items.FISHING_ROD)\n+            return (1 + getMaxEnchantmentLevel(itemStack));\n+        if(!itemStack.isDamageable())", "originalCommit": "1c8408fcfee5c4b832ed552ef53c87fe599cbb86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4e873add3be97ed82e7118a232f76af1706aa0bc", "url": "https://github.com/ldtteam/minecolonies/commit/4e873add3be97ed82e7118a232f76af1706aa0bc", "message": "Cleanup for compliance with bracket style and method comment rules.", "committedDate": "2020-11-28T17:01:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwMjA3Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532102077", "bodyText": "How sure are we this is a good idea.\nI would say if th rod is not damageable it is a max hut level feature.", "author": "OrionDevelopment", "createdAt": "2020-11-28T20:17:38Z", "path": "src/api/java/com/minecolonies/api/util/ItemStackUtils.java", "diffHunk": "@@ -479,6 +483,42 @@ else if (damageReductionAmount <= ArmorMaterial.DIAMOND.getDamageReductionAmount\n         return 5;\n     }\n \n+    /**\n+     * Estimates the fishing rod tier from available durability and enchantment status.\n+     *\n+     * @param itemStack the tool to check.\n+     * @return equivalent tool level.\n+     */\n+    private static int getFishingRodLevel(final ItemStack itemStack)\n+    {\n+        if (itemStack.getItem() == Items.FISHING_ROD)\n+        {\n+            return (1 + getMaxEnchantmentLevel(itemStack));\n+        }\n+        if (!itemStack.isDamageable())\n+        {\n+            return 1;", "originalCommit": "4e873add3be97ed82e7118a232f76af1706aa0bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwMzU5Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532103593", "bodyText": "Fair.  I was thinking more for situations where it's the only craftable rod, but a) that should be done as an override to the vanilla one, b) an extreme edge case, and c) probably wouldn't be a bad place to make the fishing hut a higher-tier only choice anyway.", "author": "gattsuru", "createdAt": "2020-11-28T20:33:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwMjA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwMjEyMw==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532102123", "bodyText": "These hardcored constants should be configurable from the config", "author": "OrionDevelopment", "createdAt": "2020-11-28T20:18:18Z", "path": "src/api/java/com/minecolonies/api/util/ItemStackUtils.java", "diffHunk": "@@ -479,6 +483,42 @@ else if (damageReductionAmount <= ArmorMaterial.DIAMOND.getDamageReductionAmount\n         return 5;\n     }\n \n+    /**\n+     * Estimates the fishing rod tier from available durability and enchantment status.\n+     *\n+     * @param itemStack the tool to check.\n+     * @return equivalent tool level.\n+     */\n+    private static int getFishingRodLevel(final ItemStack itemStack)\n+    {\n+        if (itemStack.getItem() == Items.FISHING_ROD)\n+        {\n+            return (1 + getMaxEnchantmentLevel(itemStack));\n+        }\n+        if (!itemStack.isDamageable())\n+        {\n+            return 1;\n+        }\n+        /**\n+         *  Because fishing rods don't follow ItemTier values, these numbers require an offset.\n+         *  Wood + 6 is required to allow T1 huts to use up to vanilla fishing rods equivalents.\n+         *  Wood + 22 allows T1 huts to use up to ThermalFoundation Silver fishing rods.\n+         *  Iron + 6 allows T2 huts to use up to ThermalFoundation Iron fishing rods or Aquaculture Iron,\n+         *  while still requiring T3 for ThermalFoundation advanced alloys, Aquaculture Neptunium,\n+         *  or Aquaculture diamond rods.\n+         * */\n+        final int rodDurability = itemStack.getMaxDamage();\n+        if (rodDurability <= (ItemTier.WOOD.getMaxUses() + 22))", "originalCommit": "4e873add3be97ed82e7118a232f76af1706aa0bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjExNTEwNA==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532115104", "bodyText": "Ok.  Added them to the server-specific config as fishingRodDurabilityAdjustT1 and fishingRodDurabilityAdjustT2.  Hopefully MinecoloniesAPIProxy.getInstance().getConfig().getServer() is a reasonable way to get to that; I'm not sure the performance ramifications of the different access methods, but didn't break across a few attempts.", "author": "gattsuru", "createdAt": "2020-11-28T22:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwMjEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjE3MjMzNQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532172335", "bodyText": "This is fine.", "author": "OrionDevelopment", "createdAt": "2020-11-29T08:08:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwMjEyMw=="}], "type": "inlineReview"}, {"oid": "718af5bb41980d2570ae8234f9ba3fa601995f7e", "url": "https://github.com/ldtteam/minecolonies/commit/718af5bb41980d2570ae8234f9ba3fa601995f7e", "message": "Added a configuration option for T1 and T2 fishing rod limits, along with reasonably generous ranges.  Hoping MinecoloniesAPIProxy.getInstance().getConfig().getServer() is the right approach.\n\nSwitched unbreakable fishing rods to require T5 huts.\n\nAdded comments for those configuration options to the en_us.json.  Also fixed some unrelated comments and translations in en_us.json, where either case, typo, or absence were issue.", "committedDate": "2020-11-28T22:40:34Z", "type": "commit"}, {"oid": "ce0415e79191df48711a55da8d5975d84d75bcdc", "url": "https://github.com/ldtteam/minecolonies/commit/ce0415e79191df48711a55da8d5975d84d75bcdc", "message": "And added a typo last time, so the fix.", "committedDate": "2020-11-28T22:44:51Z", "type": "commit"}, {"oid": "9bfb811ed913ff30508f88f0773feaf85093b7a4", "url": "https://github.com/ldtteam/minecolonies/commit/9bfb811ed913ff30508f88f0773feaf85093b7a4", "message": "Reinsert training end-of-line, for posix compliance.", "committedDate": "2020-11-29T03:07:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIxODYxNw==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532218617", "bodyText": "negative values?", "author": "Raycoms", "createdAt": "2020-11-29T14:38:12Z", "path": "src/api/java/com/minecolonies/api/configuration/ServerConfiguration.java", "diffHunk": "@@ -955,6 +957,9 @@ protected ServerConfiguration(final ForgeConfigSpec.Builder builder)\n \n         dynamicTreeHarvestSize = defineInteger(builder, \"dynamictreeharvestsize\", 5, 1, 5);\n \n+        fishingRodDurabilityAdjustT2 = defineInteger(builder, \"fishingroddurabilityadjustt2\", 6, -249, 250000);\n+        fishingRodDurabilityAdjustT1 = defineInteger(builder, \"fishingroddurabilityadjustt1\", 22, -58, 250000);", "originalCommit": "9bfb811ed913ff30508f88f0773feaf85093b7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIyMDg2MA==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532220860", "bodyText": "Comparing them to them ItemTier.WOOD.getMaxUses() and ItemTier.IRON.getMaxUses() for non-fishing tool.  The limits are set such that it won't go less than zero uses as the minimum acceptable use count for a tier.  Such a comparison wouldn't cause harm or a crash, it just wouldn't make sense, since items shouldn't have negative maxUses.\nI don't think it's a common use case, but if someone disabled the vanilla fishing rod, had a rod at durability 30, and another at 50, and only wanted the dur-30 rod to be usable by T1 huts, they'd use an adjustT1 value between -10 and -29.", "author": "gattsuru", "createdAt": "2020-11-29T14:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIxODYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIyMTE3OA==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532221178", "bodyText": "Couldn't it potentially go below 0 for rods with less durability than the vanilla ones?", "author": "Raycoms", "createdAt": "2020-11-29T14:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIxODYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIyMjkzMw==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532222933", "bodyText": "The application logic applies the adjustments to the ItemTiers.WOOD and ItemTier.IRON enums, rather than to the instance of the ItemStack for the tool being tested:\n\n(rodDurability <= (ItemTier.WOOD.getMaxUses() + MinecoloniesAPIProxy.getInstance().getConfig().getServer().fishingRodDurabilityAdjustT1.get())\n\n\n(rodDurability <= (ItemTier.IRON.getMaxUses() + MinecoloniesAPIProxy.getInstance().getConfig().getServer().fishingRodDurabilityAdjustT2.get()))\n\nTo go below zero, another mod would have to overwrite the ItemTiers, but those are defined in Forge and don't have setters (and I don't think they can be accessed by the datapack system?).  And it still wouldn't break anything, just make it so the hut could only use vanilla rods.", "author": "gattsuru", "createdAt": "2020-11-29T15:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIxODYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIyMzUyOA==", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532223528", "bodyText": "okay, sounds good", "author": "Raycoms", "createdAt": "2020-11-29T15:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIxODYxNw=="}], "type": "inlineReview"}]}