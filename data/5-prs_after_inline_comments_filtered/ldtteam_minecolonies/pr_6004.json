{"pr_number": 6004, "pr_title": "Fix a few performance issues", "pr_createdAt": "2020-10-29T09:04:16Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/6004", "timeline": [{"oid": "f5f7db5ae8ec3c95d6226ba23d472d0b18f63dea", "url": "https://github.com/ldtteam/minecolonies/commit/f5f7db5ae8ec3c95d6226ba23d472d0b18f63dea", "message": "Fix a few performance issues", "committedDate": "2020-10-29T08:38:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwNTc1Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514105753", "bodyText": "I guess loading the inv from NBT loads things nicely too? Not sure armor slots should be dealt with as free slots? We practically only use armor slots for rendering.", "author": "Raycoms", "createdAt": "2020-10-29T09:10:41Z", "path": "src/api/java/com/minecolonies/api/inventory/InventoryCitizen.java", "diffHunk": "@@ -41,6 +41,11 @@\n      */\n     private static final int ARMOR_SIZE = 5;\n \n+    /**\n+     * Amount of free slots\n+     */\n+    private int freeSlots = DEFAULT_INV_SIZE + ARMOR_SIZE;\n+", "originalCommit": "f5f7db5ae8ec3c95d6226ba23d472d0b18f63dea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEyNjU3MA==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514126570", "bodyText": "ye checked it and entities now have their own seperate equipment/hands inventory, so removed this legacy code", "author": "someaddons", "createdAt": "2020-10-29T09:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwNTc1Mw=="}], "type": "inlineReview"}, {"oid": "9be230cce5694bb6010ce0bf39ae3b7ad3d52c16", "url": "https://github.com/ldtteam/minecolonies/commit/9be230cce5694bb6010ce0bf39ae3b7ad3d52c16", "message": "Remove armor inventory leftovers", "committedDate": "2020-10-29T09:41:32Z", "type": "commit"}, {"oid": "674b0b8f1b7a06f56fa55ca97e0d10b70327e297", "url": "https://github.com/ldtteam/minecolonies/commit/674b0b8f1b7a06f56fa55ca97e0d10b70327e297", "message": "Fix loading, fix racks", "committedDate": "2020-10-29T10:38:35Z", "type": "commit"}, {"oid": "465f591e1257ca1fd3f42666308ba9e9305863fc", "url": "https://github.com/ldtteam/minecolonies/commit/465f591e1257ca1fd3f42666308ba9e9305863fc", "message": "remove duplicate isempty function", "committedDate": "2020-10-29T10:42:25Z", "type": "commit"}, {"oid": "f1658a68ed89b3532fc1dfd0c429a36ee7832328", "url": "https://github.com/ldtteam/minecolonies/commit/f1658a68ed89b3532fc1dfd0c429a36ee7832328", "message": "fix possible npe when no TE is found in world", "committedDate": "2020-10-29T11:15:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514476793", "bodyText": "Can we use the supplier pattern that Ray put together here, and use TICKS_SECOND if there is a current recipe set? The AI goes back to START_WORKING constantly during actual processing, so a 5 second delay will be fairly noticeable between actions.", "author": "Mekle001", "createdAt": "2020-10-29T18:27:00Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/basic/AbstractEntityAIUsesFurnace.java", "diffHunk": "@@ -64,7 +64,7 @@ protected AbstractEntityAIUsesFurnace(@NotNull final J job)\n         super(job);\n         super.registerTargets(\n           new AITarget(IDLE, START_WORKING, STANDARD_DELAY),\n-          new AITarget(START_WORKING, this::startWorking, TICKS_SECOND),\n+          new AITarget(START_WORKING, this::startWorking, 100),", "originalCommit": "f1658a68ed89b3532fc1dfd0c429a36ee7832328", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3OTM5Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514479397", "bodyText": "We could potentially have the supplier check both currentRecipe and the count of current furnaces burning. If we have no recipe, or burning furnaces, this could slow down quite a bit.", "author": "Mekle001", "createdAt": "2020-10-29T18:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4MTA4Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514481083", "bodyText": "What is the smeltercrafting doing that needs a higher update rate than every 5s?", "author": "someaddons", "createdAt": "2020-10-29T18:33:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4Mjk2Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514482967", "bodyText": "This is going to hit between picking up results for each furnace. So, with 5 furnaces you're looking at almost 30 seconds to retrieve results from all of them.", "author": "Mekle001", "createdAt": "2020-10-29T18:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4MzIzMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514483231", "bodyText": "That is just one example where we go back to START_WORKING in the AI. Most actions do.", "author": "Mekle001", "createdAt": "2020-10-29T18:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4MzU5NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514483595", "bodyText": "Not considering probably walking to the furnace too.", "author": "Raycoms", "createdAt": "2020-10-29T18:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4MzczNQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514483735", "bodyText": "Might be better to use a setDelay here then instead?", "author": "Raycoms", "createdAt": "2020-10-29T18:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4NDc3Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514484772", "bodyText": "Walking depends on the schematic, there are quite a few where there is little to no walking during pickup. SetDelay could work, but you added the provider support for just such an occasion to get away from the SetDelays.", "author": "Mekle001", "createdAt": "2020-10-29T18:40:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4NTI3Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514485272", "bodyText": "he barly does any actions besides waiting for the furnace and sometimes taking out stuff, his action are good if they take some time then he seems less idle all day. Its supposed to be a human-like those aren't instant robot-like doing all tasks at once", "author": "someaddons", "createdAt": "2020-10-29T18:41:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4NjM5NA==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514486394", "bodyText": "Maybe a better question is, why is this call causing lag?", "author": "Raycoms", "createdAt": "2020-10-29T18:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4Njc4Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514486783", "bodyText": "I'm not disagreeing, @someaddons. There will be delays in what I'm proposing, more than there are today. She's going to be slower to pick up new jobs, and to react to furnaces finishing. All I'm hoping for is that once she starts to work, she doesn't take breaks every step.", "author": "Mekle001", "createdAt": "2020-10-29T18:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4ODAxOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514488019", "bodyText": "Heck, if we go to a provider, we can slow down this check by a LOT. As in, if we have a recipe and things are burning, then 20-30 seconds. If we just have a recipe, 1 second, if we have no recipe, 10-15 seconds.", "author": "Mekle001", "createdAt": "2020-10-29T18:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4OTY3OA==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514489678", "bodyText": "tbh I do not see delays between actions as breaks, to me its when the worker is \"working\" on sth that he takes some time. The reason why its relatively laggy are inventory searches", "author": "someaddons", "createdAt": "2020-10-29T18:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5MTAwMg==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514491002", "bodyText": "I think the #1 solution should be not reducing the tick rate. But simply adding to the startWorking method, after the walkToBuilding a check if there is request in the queue and if not, directly exit and not do the 100 checks we do.", "author": "Raycoms", "createdAt": "2020-10-29T18:51:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5MTcxNw==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514491717", "bodyText": "sure you can redesign it if you want, but it is not necessary because a 5s wait is totally fine", "author": "someaddons", "createdAt": "2020-10-29T18:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5MzEyMg==", "url": "https://github.com/ldtteam/minecolonies/pull/6004#discussion_r514493122", "bodyText": "The reason why its relatively laggy are inventory searches\nUgh, why didn't you say so? that's an easy fix =P", "author": "Raycoms", "createdAt": "2020-10-29T18:54:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc5Mw=="}], "type": "inlineReview"}, {"oid": "f7bcdeb767486e31bc02f7d816684ed310a48e50", "url": "https://github.com/ldtteam/minecolonies/commit/f7bcdeb767486e31bc02f7d816684ed310a48e50", "message": "Use the fast method", "committedDate": "2020-10-29T18:58:48Z", "type": "commit"}, {"oid": "7cb736b13291df3ed190c7fbbe90c5f8b9dd571e", "url": "https://github.com/ldtteam/minecolonies/commit/7cb736b13291df3ed190c7fbbe90c5f8b9dd571e", "message": "avoid doing actions too frequently unnecessarily", "committedDate": "2020-10-29T19:07:40Z", "type": "commit"}, {"oid": "d72a4b5d01f3bbd297651514cb901855170b7933", "url": "https://github.com/ldtteam/minecolonies/commit/d72a4b5d01f3bbd297651514cb901855170b7933", "message": "Merge remote-tracking branch 'remotes/origin/version/1.15' into performanceimpr\n\n# Conflicts:\n#\tsrc/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/MovementHandler.java", "committedDate": "2020-11-01T09:07:35Z", "type": "commit"}, {"oid": "bbf78113d2dcdbd4175398fd0c2e67e57a2dba16", "url": "https://github.com/ldtteam/minecolonies/commit/bbf78113d2dcdbd4175398fd0c2e67e57a2dba16", "message": "ray is unreasonable", "committedDate": "2020-11-01T12:29:36Z", "type": "commit"}]}