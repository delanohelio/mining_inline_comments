{"pr_number": 4331, "pr_title": "Rework raiders and fix raider issues.", "pr_createdAt": "2020-02-13T12:23:24Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/4331", "timeline": [{"oid": "d8b39eda7af38395370713f542598cef5677bc2d", "url": "https://github.com/ldtteam/minecolonies/commit/d8b39eda7af38395370713f542598cef5677bc2d", "message": "Rework raiders and fix raider issues.", "committedDate": "2020-02-13T12:14:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzMTg3Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r378831872", "bodyText": "formatting seems off here", "author": "Raycoms", "createdAt": "2020-02-13T12:33:05Z", "path": "src/api/java/com/minecolonies/api/colony/colonyEvents/IColonyEvent.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package com.minecolonies.api.colony.colonyEvents;\n+\n+import com.minecolonies.api.colony.IColony;\n+import net.minecraft.entity.Entity;\n+import net.minecraft.entity.EntityLiving;\n+import net.minecraft.nbt.NBTTagCompound;\n+import net.minecraft.tileentity.TileEntity;\n+import net.minecraft.util.ResourceLocation;\n+import net.minecraft.util.math.BlockPos;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Interface for colony event types.\n+ */\n+public interface IColonyEvent\n+{\n+    void setSpawnPoint(BlockPos spawnPoint);\n+\n+    /**\n+     * The position the event starts at\n+     *\n+     * @return\n+     */\n+    public BlockPos getStartPos();\n+\n+    /**\n+     * The list of entities related to this event\n+     *\n+     * @return\n+     */\n+    default public List<Entity> getEntities()\n+    {\n+        return new ArrayList<>();\n+    }\n+\n+    /**\n+     * Returns the events current status\n+     *\n+     * @return\n+     */\n+    public EventStatus getStatus();\n+\n+    /**\n+     * Sets the current event status\n+     *\n+     * @return\n+     */\n+    public void setStatus(final EventStatus status);\n+\n+    /**\n+     * Returns this events ID.\n+     *\n+     * @return\n+     */\n+    public int getID();\n+\n+    /**\n+     * The event type's id\n+     *\n+     * @return\n+     */\n+    public ResourceLocation getEventTypeID();\n+\n+    /**\n+     * Sets the colony\n+     *\n+     * @param colony\n+     */\n+    public void setColony(@NotNull final IColony colony);\n+\n+    /**\n+     * Writes the event to NBT\n+     *\n+     * @param compound\n+     * @return\n+     */\n+    public NBTTagCompound writeToNBT(final NBTTagCompound compound);\n+\n+    /**\n+     * Reads the events values from NBT\n+     *\n+     * @param compound\n+     */\n+    public void readFromNBT(final NBTTagCompound compound);\n+\n+    default public void registerEntity(final Entity entity) {}\n+\n+    ;\n+\n+    default public void unregisterEntity(final Entity entity) {}\n+\n+    ;\n+", "originalCommit": "d8b39eda7af38395370713f542598cef5677bc2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2OTEyMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r379069121", "bodyText": "just slightly xD", "author": "someaddons", "createdAt": "2020-02-13T19:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzMTg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzMjU1OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r378832559", "bodyText": "not areSpiesEnabled ?", "author": "Raycoms", "createdAt": "2020-02-13T12:34:38Z", "path": "src/api/java/com/minecolonies/api/colony/IColonyView.java", "diffHunk": "@@ -463,4 +454,6 @@\n      * @return the list.\n      */\n     List<CompactColonyReference> getFeuds();\n+\n+    boolean isSpiesEnabled();", "originalCommit": "d8b39eda7af38395370713f542598cef5677bc2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3MDIyNw==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r379070227", "bodyText": "ye", "author": "someaddons", "createdAt": "2020-02-13T19:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzMjU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzMjk1NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r378832955", "bodyText": "We had null here on purpose to avoid them changing dimensions, is that wrong?", "author": "Raycoms", "createdAt": "2020-02-13T12:35:33Z", "path": "src/api/java/com/minecolonies/api/entity/citizen/AbstractEntityCitizen.java", "diffHunk": "@@ -115,10 +115,9 @@ public int getTicksExisted()\n      * @param dimensionIn dimension to travel to.\n      */\n     @Override\n-    @Nullable\n-    public Entity changeDimension(final int dimensionIn)\n+    public Entity changeDimension(int dimensionIn, net.minecraftforge.common.util.ITeleporter teleporter)\n     {\n-        return null;\n+        return this;\n     }", "originalCommit": "d8b39eda7af38395370713f542598cef5677bc2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3MTIxNw==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r379071217", "bodyText": "ah no don't think so, only wanted to change the overwrite to the right method", "author": "someaddons", "createdAt": "2020-02-13T19:27:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzMjk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzMzIzNg==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r378833236", "bodyText": "jdoc, what is this?", "author": "Raycoms", "createdAt": "2020-02-13T12:36:06Z", "path": "src/api/java/com/minecolonies/api/entity/mobs/AbstractEntityMinecoloniesMob.java", "diffHunk": "@@ -75,6 +71,18 @@\n      */\n     private int ladderCounter = 0;\n \n+    /**\n+     * The raids event id.\n+     */\n+    private int eventID = 0;\n+\n+    /**\n+     * Whether this entity is registered with the colony yet.\n+     */\n+    private boolean isRegistered = false;\n+\n+    private int invulTime = 2 * 20;", "originalCommit": "d8b39eda7af38395370713f542598cef5677bc2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzMzU3MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r378833571", "bodyText": "Good idea", "author": "Raycoms", "createdAt": "2020-02-13T12:36:44Z", "path": "src/api/java/com/minecolonies/api/entity/mobs/AbstractEntityMinecoloniesMob.java", "diffHunk": "@@ -329,7 +366,14 @@ public IColony getColony()\n      */\n     public void registerWithColony()\n     {\n-        getColony();\n+        if (colony == null || eventID == 0)", "originalCommit": "d8b39eda7af38395370713f542598cef5677bc2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3MjU1OA==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r379072558", "bodyText": "ye all raiders now have to know their colony and eventID and are removed otherwise. The events gonna take care to spawn a new one if needed for the event", "author": "someaddons", "createdAt": "2020-02-13T19:29:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzMzU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzNDcwNA==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r378834704", "bodyText": "lang entry?", "author": "Raycoms", "createdAt": "2020-02-13T12:39:20Z", "path": "src/main/java/com/minecolonies/coremod/client/gui/WindowsBarracksSpies.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package com.minecolonies.coremod.client.gui;\n+\n+import com.minecolonies.api.colony.buildings.views.IBuildingView;\n+import com.minecolonies.api.tileentities.TileEntityRack;\n+import com.minecolonies.api.util.InventoryUtils;\n+import com.minecolonies.api.util.constant.Constants;\n+import com.minecolonies.blockout.controls.*;\n+import com.minecolonies.blockout.views.Window;\n+import com.minecolonies.coremod.MineColonies;\n+import com.minecolonies.coremod.network.messages.HireSpiesMessage;\n+import net.minecraft.client.Minecraft;\n+import net.minecraft.init.Items;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraftforge.items.IItemHandler;\n+import net.minecraftforge.items.wrapper.InvWrapper;\n+\n+/**\n+ * UI for hiring spies on the barracks\n+ */\n+public class WindowsBarracksSpies extends Window implements ButtonHandler\n+{\n+    /**\n+     * The xml file for this gui\n+     */\n+    private static final String SPIES_GUI_XML = \":gui/windowBarracksSpies.xml\";\n+\n+    /**\n+     * The cancel button id\n+     */\n+    private static final String BUTTON_CANCEL = \"cancel\";\n+\n+    /**\n+     * The hire spies button id\n+     */\n+    private static final String BUTTON_HIRE = \"hireSpies\";\n+\n+    /**\n+     * The spies button icon id\n+     */\n+    private static final String SPIES_BUTTON_ICON = \"hireSpiesIcon\";\n+\n+    /**\n+     * The gold amount label id\n+     */\n+    private static final String GOLD_COST_LABEL = \"amount\";\n+\n+    /**\n+     * Text element id\n+     */\n+    private static final String TEXT_ID = \"text\";\n+\n+    private static final int GOLD_COST = 5;\n+\n+    /**\n+     * The client side colony data\n+     */\n+    private final IBuildingView buildingView;\n+\n+    /**\n+     * The buildings position.\n+     */\n+    private final BlockPos buildingPos;\n+\n+    public WindowsBarracksSpies(final IBuildingView buildingView, final BlockPos buildingPos)\n+    {\n+        super(Constants.MOD_ID + SPIES_GUI_XML);\n+        this.buildingView = buildingView;\n+        this.buildingPos = buildingPos;\n+\n+        findPaneOfTypeByID(SPIES_BUTTON_ICON, ItemIcon.class).setItem(Items.GOLD_INGOT.getDefaultInstance());\n+        findPaneOfTypeByID(GOLD_COST_LABEL, Label.class).setLabelText(\"x5\");\n+\n+        final IItemHandler rackInv = ((TileEntityRack) buildingView.getColony().getWorld().getTileEntity(buildingPos)).getInventory();\n+        final IItemHandler playerInv = new InvWrapper(Minecraft.getMinecraft().player.inventory);\n+        int goldCount = InventoryUtils.getItemCountInItemHandler(playerInv, Items.GOLD_INGOT, 0);\n+        goldCount += InventoryUtils.getItemCountInItemHandler(rackInv, Items.GOLD_INGOT, 0);\n+\n+        if (!buildingView.getColony().isRaiding() || goldCount < GOLD_COST || buildingView.getColony().isSpiesEnabled())\n+        {\n+            findPaneOfTypeByID(BUTTON_HIRE, ButtonImage.class).disable();\n+        }\n+        findPaneOfTypeByID(TEXT_ID, Text.class).setTextContent(\n+          \"During raids you can hire spies here, to infiltrate the enemy lines. Those then let you know enemy positions although they demand some gold as payment. Put the gold into the barracks inventory to automatically pay them.\");\n+    }", "originalCommit": "d8b39eda7af38395370713f542598cef5677bc2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3MzQ5MA==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r379073490", "bodyText": "ye missing^^", "author": "someaddons", "createdAt": "2020-02-13T19:31:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzNDcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzNTExOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r378835119", "bodyText": "isUnderRaid, isBeingRaided might be more understandable", "author": "Raycoms", "createdAt": "2020-02-13T12:40:11Z", "path": "src/main/java/com/minecolonies/coremod/colony/ColonyView.java", "diffHunk": "@@ -149,9 +149,9 @@\n     private IRequestManager requestManager;\n \n     /**\n-     * The number of raiders in the horde.\n+     * Wether the colony is raided\n      */\n-    private int horde;\n+    private boolean isRaided;", "originalCommit": "d8b39eda7af38395370713f542598cef5677bc2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzNjE0NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r378836145", "bodyText": "why in this one here we just remove it from all and in the other ones we do it in the instanceof check?", "author": "Raycoms", "createdAt": "2020-02-13T12:42:22Z", "path": "src/main/java/com/minecolonies/coremod/colony/colonyEvents/raidEvents/babarianEvent/BarbarianRaidEvent.java", "diffHunk": "@@ -0,0 +1,399 @@\n+package com.minecolonies.coremod.colony.colonyEvents.raidEvents.babarianEvent;\n+\n+import com.minecolonies.api.colony.IColony;\n+import com.minecolonies.api.colony.colonyEvents.EventStatus;\n+import com.minecolonies.api.colony.colonyEvents.IColonyEvent;\n+import com.minecolonies.api.entity.mobs.AbstractEntityMinecoloniesMob;\n+import com.minecolonies.api.entity.mobs.RaiderMobUtils;\n+import com.minecolonies.api.util.BlockPosUtil;\n+import com.minecolonies.api.util.LanguageHandler;\n+import com.minecolonies.api.util.Tuple;\n+import com.minecolonies.api.util.constant.Constants;\n+import com.minecolonies.coremod.colony.ColonyState;\n+import com.minecolonies.coremod.colony.colonyEvents.raidEvents.pirateEvent.IRaidEvent;\n+import com.minecolonies.coremod.colony.colonyEvents.raidEvents.pirateEvent.PirateEventUtils;\n+import com.minecolonies.coremod.entity.mobs.barbarians.EntityArcherBarbarian;\n+import com.minecolonies.coremod.entity.mobs.barbarians.EntityBarbarian;\n+import com.minecolonies.coremod.entity.mobs.barbarians.EntityChiefBarbarian;\n+import net.minecraft.entity.Entity;\n+import net.minecraft.entity.EntityLiving;\n+import net.minecraft.entity.EntityLivingBase;\n+import net.minecraft.init.MobEffects;\n+import net.minecraft.nbt.NBTTagCompound;\n+import net.minecraft.potion.PotionEffect;\n+import net.minecraft.util.ResourceLocation;\n+import net.minecraft.util.math.BlockPos;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.util.*;\n+\n+import static com.minecolonies.api.colony.colonyEvents.NBTTags.*;\n+import static com.minecolonies.api.util.constant.ColonyConstants.*;\n+import static com.minecolonies.api.util.constant.TranslationConstants.*;\n+import static com.minecolonies.coremod.colony.colonyEvents.raidEvents.pirateEvent.PirateRaidEvent.TAG_DAYS_LEFT;\n+\n+public class BarbarianRaidEvent implements IColonyEvent, IRaidEvent\n+{\n+    /**\n+     * This raids event id, registry entries use res locations as ids.\n+     */\n+    public static final ResourceLocation BABARIAN_RAID_EVENT_TYPE_ID = new ResourceLocation(Constants.MOD_ID, \"babarian_raid\");\n+\n+    /**\n+     * The max distance a babarian is allowed to spawn from the original spawn position\n+     */\n+    public static int MAX_SPAWN_DEVIATION = 300;\n+\n+    /**\n+     * The max distance to search for a loaded blockpos on a respawn try\n+     */\n+    public static int MAX_RESPAWN_DEVIATION = 5 * 16;\n+\n+    /**\n+     * The minimum distance to the colony center where mobs are allowed to spawn\n+     */\n+    public static int MIN_CENTER_DISTANCE = 200;\n+\n+    /**\n+     * The amount of babarians overall\n+     */\n+    private BarbarianHorde horde;\n+\n+    /**\n+     * The references to living raiders left\n+     */\n+    private Map<Entity, UUID> barbarians = new WeakHashMap<>();\n+    private Map<Entity, UUID> archers    = new WeakHashMap<>();\n+    private Map<Entity, UUID> chiefs     = new WeakHashMap<>();\n+\n+    /**\n+     * List of respawns to do\n+     */\n+    private List<Tuple<ResourceLocation, BlockPos>> respawns = new ArrayList<>();\n+\n+    /**\n+     * The related colony\n+     */\n+    private IColony colony;\n+\n+    /**\n+     * The events id\n+     */\n+    private int id;\n+\n+    /**\n+     * The events starting spawnpoint\n+     */\n+    private BlockPos spawnPoint;\n+\n+    /**\n+     * Status of the event\n+     */\n+    private EventStatus status = EventStatus.STARTING;\n+\n+    /**\n+     * Days the event can last, to make sure it eventually despawns.\n+     */\n+    private int daysToGo = 3;\n+\n+    public BarbarianRaidEvent(IColony colony)\n+    {\n+        this.colony = colony;\n+        id = colony.getEventManager().getAndTakeNextEventID();\n+    }\n+\n+    @Override\n+    public void setSpawnPoint(final BlockPos spawnPoint)\n+    {\n+        this.spawnPoint = spawnPoint;\n+    }\n+\n+    @Override\n+    public BlockPos getStartPos()\n+    {\n+        return spawnPoint;\n+    }\n+\n+    @Override\n+    public List<Entity> getEntities()\n+    {\n+        List<Entity> entities = new ArrayList<>();\n+        entities.addAll(archers.keySet());\n+        entities.addAll(chiefs.keySet());\n+        entities.addAll(barbarians.keySet());\n+        return entities;\n+    }\n+\n+    @Override\n+    public EventStatus getStatus()\n+    {\n+        return status;\n+    }\n+\n+    @Override\n+    public void setStatus(final EventStatus status)\n+    {\n+        this.status = status;\n+    }\n+\n+    @Override\n+    public int getID()\n+    {\n+        return id;\n+    }\n+\n+    @Override\n+    public ResourceLocation getEventTypeID()\n+    {\n+        return BABARIAN_RAID_EVENT_TYPE_ID;\n+    }\n+\n+    @Override\n+    public void setColony(@NotNull final IColony colony)\n+    {\n+        this.colony = colony;\n+    }\n+\n+    @Override\n+    public void registerEntity(final Entity entity)\n+    {\n+        if (!(entity instanceof AbstractEntityMinecoloniesMob))\n+        {\n+            entity.setDead();\n+            return;\n+        }\n+\n+        if (entity instanceof EntityChiefBarbarian && chiefs.keySet().size() < horde.numberOfBosses)\n+        {\n+            chiefs.put(entity, entity.getUniqueID());\n+            return;\n+        }\n+\n+        if (entity instanceof EntityArcherBarbarian && archers.keySet().size() < horde.numberOfArchers)\n+        {\n+            archers.put(entity, entity.getUniqueID());\n+            return;\n+        }\n+\n+        if (entity instanceof EntityBarbarian && barbarians.keySet().size() < horde.numberOfRaiders)\n+        {\n+            barbarians.put(entity, entity.getUniqueID());\n+            return;\n+        }\n+\n+        entity.setDead();\n+    }\n+\n+    /**\n+     * Called when an entity is removed\n+     *\n+     * @param entity\n+     */\n+    @Override\n+    public void unregisterEntity(final Entity entity)\n+    {\n+        if (!(archers.containsKey(entity) || chiefs.containsKey(entity) || barbarians.containsKey(entity)) || status != EventStatus.PROGRESSING\n+              || colony.getState() != ColonyState.ACTIVE)\n+        {\n+            return;\n+        }\n+\n+        archers.remove(entity);\n+        chiefs.remove(entity);", "originalCommit": "d8b39eda7af38395370713f542598cef5677bc2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3NTIzOA==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r379075238", "bodyText": "ye here its only needed to remove the entity from the list, while the other cases have special type-dependent logic, like reducing archer count, or when adding to only add to the right list", "author": "someaddons", "createdAt": "2020-02-13T19:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzNjE0NQ=="}], "type": "inlineReview"}, {"oid": "3514f4b66f51f8984d3b2ceb6c6ac89993cbbe8d", "url": "https://github.com/ldtteam/minecolonies/commit/3514f4b66f51f8984d3b2ceb6c6ac89993cbbe8d", "message": "cleanup", "committedDate": "2020-02-14T16:54:10Z", "type": "commit"}, {"oid": "4d1e8f98bd7d170abb4135837fb5a5513d45b34f", "url": "https://github.com/ldtteam/minecolonies/commit/4d1e8f98bd7d170abb4135837fb5a5513d45b34f", "message": "rebalance raid sizes and improve stuck handling", "committedDate": "2020-02-20T18:17:39Z", "type": "commit"}, {"oid": "561452a7c46f42dd2082b33b8ac8cd4f09e7a43c", "url": "https://github.com/ldtteam/minecolonies/commit/561452a7c46f42dd2082b33b8ac8cd4f09e7a43c", "message": "Merge remote-tracking branch 'remotes/origin/version/1.12' into raiderFix112\n\n# Conflicts:\n#\tbuild.properties", "committedDate": "2020-02-21T22:57:26Z", "type": "commit"}, {"oid": "e7f51510743627558e7c885f5a991b61a327ad0d", "url": "https://github.com/ldtteam/minecolonies/commit/e7f51510743627558e7c885f5a991b61a327ad0d", "message": "fix pathing error", "committedDate": "2020-02-21T23:39:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk5MDU3Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r382990577", "bodyText": "those are still off, the semicolons", "author": "Raycoms", "createdAt": "2020-02-23T10:17:14Z", "path": "src/api/java/com/minecolonies/api/colony/colonyEvents/IColonyEvent.java", "diffHunk": "@@ -0,0 +1,146 @@\n+package com.minecolonies.api.colony.colonyEvents;\n+\n+import com.minecolonies.api.colony.IColony;\n+import net.minecraft.entity.Entity;\n+import net.minecraft.entity.EntityLiving;\n+import net.minecraft.nbt.NBTTagCompound;\n+import net.minecraft.tileentity.TileEntity;\n+import net.minecraft.util.ResourceLocation;\n+import net.minecraft.util.math.BlockPos;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Interface for colony event types.\n+ */\n+public interface IColonyEvent\n+{\n+    void setSpawnPoint(BlockPos spawnPoint);\n+\n+    /**\n+     * The position the event starts at\n+     *\n+     * @return\n+     */\n+    public BlockPos getStartPos();\n+\n+    /**\n+     * The list of entities related to this event\n+     *\n+     * @return\n+     */\n+    default public List<Entity> getEntities()\n+    {\n+        return new ArrayList<>();\n+    }\n+\n+    /**\n+     * Returns the events current status\n+     *\n+     * @return\n+     */\n+    public EventStatus getStatus();\n+\n+    /**\n+     * Sets the current event status\n+     *\n+     * @return\n+     */\n+    public void setStatus(final EventStatus status);\n+\n+    /**\n+     * Returns this events ID.\n+     *\n+     * @return\n+     */\n+    public int getID();\n+\n+    /**\n+     * The event type's id\n+     *\n+     * @return\n+     */\n+    public ResourceLocation getEventTypeID();\n+\n+    /**\n+     * Sets the colony\n+     *\n+     * @param colony\n+     */\n+    public void setColony(@NotNull final IColony colony);\n+\n+    /**\n+     * Writes the event to NBT\n+     *\n+     * @param compound\n+     * @return\n+     */\n+    public NBTTagCompound writeToNBT(final NBTTagCompound compound);\n+\n+    /**\n+     * Reads the events values from NBT\n+     *\n+     * @param compound\n+     */\n+    public void readFromNBT(final NBTTagCompound compound);\n+\n+    /**\n+     * Called to register an entity with this event\n+     *\n+     * @param entity\n+     */\n+    default public void registerEntity(final Entity entity) {}\n+\n+    ;", "originalCommit": "4d1e8f98bd7d170abb4135837fb5a5513d45b34f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk5MTEyMA==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r382991120", "bodyText": "Can't we import the ITeleporter for this?", "author": "Raycoms", "createdAt": "2020-02-23T10:25:42Z", "path": "src/api/java/com/minecolonies/api/entity/citizen/AbstractEntityCitizen.java", "diffHunk": "@@ -115,8 +115,7 @@ public int getTicksExisted()\n      * @param dimensionIn dimension to travel to.\n      */\n     @Override\n-    @Nullable\n-    public Entity changeDimension(final int dimensionIn)\n+    public Entity changeDimension(int dimensionIn, net.minecraftforge.common.util.ITeleporter teleporter)", "originalCommit": "4d1e8f98bd7d170abb4135837fb5a5513d45b34f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk5MzM3NA==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r382993374", "bodyText": "ye we can, just had that copied", "author": "someaddons", "createdAt": "2020-02-23T10:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk5MTEyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk5MTMzMg==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r382991332", "bodyText": "formatting here too", "author": "Raycoms", "createdAt": "2020-02-23T10:28:36Z", "path": "src/main/java/com/minecolonies/coremod/colony/colonyEvents/raidEvents/babarianEvent/BarbarianRaidEvent.java", "diffHunk": "@@ -0,0 +1,426 @@\n+package com.minecolonies.coremod.colony.colonyEvents.raidEvents.babarianEvent;\n+\n+import com.minecolonies.api.colony.IColony;\n+import com.minecolonies.api.colony.colonyEvents.EventStatus;\n+import com.minecolonies.api.colony.colonyEvents.IColonyEvent;\n+import com.minecolonies.api.colony.colonyEvents.IRaidEvent;\n+import com.minecolonies.api.entity.mobs.AbstractEntityMinecoloniesMob;\n+import com.minecolonies.api.entity.mobs.RaiderMobUtils;\n+import com.minecolonies.api.util.BlockPosUtil;\n+import com.minecolonies.api.util.LanguageHandler;\n+import com.minecolonies.api.util.Log;\n+import com.minecolonies.api.util.Tuple;\n+import com.minecolonies.api.util.constant.Constants;\n+import com.minecolonies.coremod.colony.ColonyState;\n+import com.minecolonies.coremod.colony.colonyEvents.raidEvents.pirateEvent.PirateEventUtils;\n+import com.minecolonies.coremod.entity.mobs.barbarians.EntityArcherBarbarian;\n+import com.minecolonies.coremod.entity.mobs.barbarians.EntityBarbarian;\n+import com.minecolonies.coremod.entity.mobs.barbarians.EntityChiefBarbarian;\n+import net.minecraft.entity.Entity;\n+import net.minecraft.entity.EntityLiving;\n+import net.minecraft.entity.EntityLivingBase;\n+import net.minecraft.init.MobEffects;\n+import net.minecraft.nbt.NBTTagCompound;\n+import net.minecraft.potion.PotionEffect;\n+import net.minecraft.util.ResourceLocation;\n+import net.minecraft.util.math.BlockPos;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.util.*;\n+\n+import static com.minecolonies.api.colony.colonyEvents.NBTTags.*;\n+import static com.minecolonies.api.util.constant.ColonyConstants.*;\n+import static com.minecolonies.api.util.constant.TranslationConstants.*;\n+import static com.minecolonies.coremod.colony.colonyEvents.raidEvents.pirateEvent.PirateRaidEvent.TAG_DAYS_LEFT;\n+\n+/**\n+ * Barbarian raid event for the colony, triggers a horde of barbarians which spawn and attack the colony.\n+ */\n+public class BarbarianRaidEvent implements IColonyEvent, IRaidEvent\n+{\n+    /**\n+     * This raids event id, registry entries use res locations as ids.\n+     */\n+    public static final ResourceLocation BABARIAN_RAID_EVENT_TYPE_ID = new ResourceLocation(Constants.MOD_ID, \"babarian_raid\");\n+\n+    /**\n+     * The max distance a babarian is allowed to spawn from the original spawn position\n+     */\n+    public static int MAX_SPAWN_DEVIATION = 300;\n+\n+    /**\n+     * The max distance to search for a loaded blockpos on a respawn try\n+     */\n+    public static int MAX_RESPAWN_DEVIATION = 5 * 16;\n+\n+    /**\n+     * The minimum distance to the colony center where mobs are allowed to spawn\n+     */\n+    public static int MIN_CENTER_DISTANCE = 100;\n+\n+    /**\n+     * The amount of babarians overall\n+     */\n+    private BarbarianHorde horde;\n+\n+    /**\n+     * The references to living raiders left\n+     */\n+    private Map<Entity, UUID> barbarians = new WeakHashMap<>();\n+    private Map<Entity, UUID> archers    = new WeakHashMap<>();\n+    private Map<Entity, UUID> chiefs     = new WeakHashMap<>();\n+\n+    /**\n+     * List of respawns to do\n+     */\n+    private List<Tuple<ResourceLocation, BlockPos>> respawns = new ArrayList<>();\n+\n+    /**\n+     * The related colony\n+     */\n+    private IColony colony;\n+\n+    /**\n+     * The events id\n+     */\n+    private int id;\n+\n+    /**\n+     * The events starting spawnpoint\n+     */\n+    private BlockPos spawnPoint;\n+\n+    /**\n+     * Status of the event\n+     */\n+    private EventStatus status = EventStatus.STARTING;\n+\n+    /**\n+     * Days the event can last, to make sure it eventually despawns.\n+     */\n+    private int daysToGo = 3;\n+\n+    public BarbarianRaidEvent(IColony colony)\n+    {\n+        this.colony = colony;\n+        id = colony.getEventManager().getAndTakeNextEventID();\n+    }\n+\n+    @Override\n+    public void setSpawnPoint(final BlockPos spawnPoint)\n+    {\n+        this.spawnPoint = spawnPoint;\n+    }\n+\n+    @Override\n+    public BlockPos getStartPos()\n+    {\n+        return spawnPoint;\n+    }\n+\n+    @Override\n+    public List<Entity> getEntities()\n+    {\n+        List<Entity> entities = new ArrayList<>();\n+        entities.addAll(archers.keySet());\n+        entities.addAll(chiefs.keySet());\n+        entities.addAll(barbarians.keySet());\n+        return entities;\n+    }\n+\n+    @Override\n+    public EventStatus getStatus()\n+    {\n+        return status;\n+    }\n+\n+    @Override\n+    public void setStatus(final EventStatus status)\n+    {\n+        this.status = status;\n+    }\n+\n+    @Override\n+    public int getID()\n+    {\n+        return id;\n+    }\n+\n+    @Override\n+    public ResourceLocation getEventTypeID()\n+    {\n+        return BABARIAN_RAID_EVENT_TYPE_ID;\n+    }\n+\n+    @Override\n+    public void setColony(@NotNull final IColony colony)\n+    {\n+        this.colony = colony;\n+    }\n+\n+    @Override\n+    public void registerEntity(final Entity entity)\n+    {\n+        if (!(entity instanceof AbstractEntityMinecoloniesMob) || !entity.isEntityAlive())\n+        {\n+            entity.setDead();\n+            return;\n+        }\n+\n+        if (entity instanceof EntityChiefBarbarian && chiefs.keySet().size() < horde.numberOfBosses)\n+        {\n+            chiefs.put(entity, entity.getUniqueID());\n+            return;\n+        }\n+\n+        if (entity instanceof EntityArcherBarbarian && archers.keySet().size() < horde.numberOfArchers)\n+        {\n+            archers.put(entity, entity.getUniqueID());\n+            return;\n+        }\n+\n+        if (entity instanceof EntityBarbarian && barbarians.keySet().size() < horde.numberOfRaiders)\n+        {\n+            barbarians.put(entity, entity.getUniqueID());\n+            return;\n+        }\n+\n+        entity.setDead();\n+    }\n+\n+    /**\n+     * Called when an entity is removed\n+     *\n+     * @param entity\n+     */\n+    @Override\n+    public void unregisterEntity(final Entity entity)\n+    {\n+        if (!(archers.containsKey(entity) || chiefs.containsKey(entity) || barbarians.containsKey(entity)) || status != EventStatus.PROGRESSING\n+              || colony.getState() != ColonyState.ACTIVE)\n+        {\n+            return;\n+        }\n+\n+        archers.remove(entity);\n+        chiefs.remove(entity);\n+        barbarians.remove(entity);\n+\n+        // Respawn as a new entity in a loaded chunk, if not too close.\n+        final ResourceLocation entityID = net.minecraftforge.fml.common.registry.EntityRegistry.getEntry(entity.getClass()).getRegistryName();\n+        respawns.add(new Tuple<>(entityID, entity.getPosition()));\n+    }\n+\n+    @Override\n+    public void onEntityDeath(final EntityLiving entity)\n+    {\n+        if (!(entity instanceof AbstractEntityMinecoloniesMob))\n+        {\n+            return;\n+        }\n+\n+        if (entity.isDead)\n+        {\n+            Log.getLogger().warn(\"THROWS TANTRUM!\");\n+        }\n+\n+        if (entity instanceof EntityChiefBarbarian)\n+        {\n+            chiefs.remove(entity);\n+            horde.numberOfBosses--;\n+        }\n+\n+        if (entity instanceof EntityArcherBarbarian)\n+        {\n+            archers.remove(entity);\n+            horde.numberOfArchers--;\n+        }\n+\n+        if (entity instanceof EntityBarbarian)\n+        {\n+            barbarians.remove(entity);\n+            horde.numberOfRaiders--;\n+        }\n+\n+        horde.hordeSize--;\n+\n+        if (horde.hordeSize == 0)\n+        {\n+            status = EventStatus.DONE;\n+        }\n+\n+        sendHordeMessage();\n+    }\n+\n+    @Override\n+    public void onStart()\n+    {\n+        final BlockPos spawnPos = PirateEventUtils.getLoadedPositionTowardsCenter(spawnPoint, colony, MAX_SPAWN_DEVIATION, spawnPoint, MIN_CENTER_DISTANCE, 10);\n+        if (spawnPos == null)\n+        {\n+            status = EventStatus.CANCELED;\n+            return;\n+        }\n+\n+        status = EventStatus.PROGRESSING;\n+        RaiderMobUtils.spawn(BARBARIAN, horde.numberOfRaiders, spawnPos, colony.getWorld(), colony, id);\n+        RaiderMobUtils.spawn(CHIEF, horde.numberOfBosses, spawnPos, colony.getWorld(), colony, id);\n+        RaiderMobUtils.spawn(ARCHER, horde.numberOfArchers, spawnPos, colony.getWorld(), colony, id);\n+\n+        LanguageHandler.sendPlayersMessage(\n+          colony.getImportantMessageEntityPlayers(),\n+          RAID_EVENT_MESSAGE + horde.getMessageID(), colony.getName(), BlockPosUtil.calcDirection(colony.getCenter(), spawnPoint));\n+    }\n+\n+    @Override\n+    public void onUpdate()\n+    {\n+        if (horde.hordeSize == 0)\n+        {\n+            status = EventStatus.DONE;\n+        }\n+\n+        if (!respawns.isEmpty())\n+        {\n+            for (final Tuple<ResourceLocation, BlockPos> entry : respawns)\n+            {\n+                final BlockPos spawnPos = PirateEventUtils.getLoadedPositionTowardsCenter(entry.getSecond(), colony, MAX_RESPAWN_DEVIATION, spawnPoint, MIN_CENTER_DISTANCE, 10);\n+                if (spawnPos != null)\n+                {\n+                    RaiderMobUtils.spawn(entry.getFirst(), 1, spawnPos, colony.getWorld(), colony, id);\n+                }\n+            }\n+            respawns.clear();\n+            return;\n+        }\n+\n+        if (chiefs.size() + archers.size() + barbarians.size() < horde.numberOfBosses + horde.numberOfRaiders + horde.numberOfArchers)\n+        {\n+            final BlockPos spawnPos = PirateEventUtils.getLoadedPositionTowardsCenter(spawnPoint, colony, MAX_RESPAWN_DEVIATION, spawnPoint, MIN_CENTER_DISTANCE, 10);\n+            if (spawnPos != null)\n+            {\n+                RaiderMobUtils.spawn(CHIEF, horde.numberOfBosses - chiefs.size(), spawnPos, colony.getWorld(), colony, id);\n+                RaiderMobUtils.spawn(ARCHER, horde.numberOfArchers - archers.size(), spawnPos, colony.getWorld(), colony, id);\n+                RaiderMobUtils.spawn(BARBARIAN, horde.numberOfRaiders - barbarians.size(), spawnPos, colony.getWorld(), colony, id);\n+            }\n+        }\n+\n+\n+            for (final Entity entity : getEntities())", "originalCommit": "4d1e8f98bd7d170abb4135837fb5a5513d45b34f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk5NTU2NA==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r382995564", "bodyText": "oh and the debug logs are still in, those arent needed", "author": "someaddons", "createdAt": "2020-02-23T11:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk5MTMzMg=="}], "type": "inlineReview"}, {"oid": "f6c2c039bf89993478270b156d4640dc63731ddc", "url": "https://github.com/ldtteam/minecolonies/commit/f6c2c039bf89993478270b156d4640dc63731ddc", "message": "Finish walking AI and some cleanup", "committedDate": "2020-02-25T22:26:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MDYwMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r386090601", "bodyText": "IColonyEvent is named a bit weirdly, especially since you force it to have a spawnpoint.\nMaybe think of something that more allines with your goals.", "author": "OrionDevelopment", "createdAt": "2020-03-01T09:11:03Z", "path": "src/api/java/com/minecolonies/api/colony/colonyEvents/IColonyEvent.java", "diffHunk": "@@ -0,0 +1,142 @@\n+package com.minecolonies.api.colony.colonyEvents;\n+\n+import com.minecolonies.api.colony.IColony;\n+import net.minecraft.entity.Entity;\n+import net.minecraft.entity.EntityLiving;\n+import net.minecraft.nbt.NBTTagCompound;\n+import net.minecraft.tileentity.TileEntity;\n+import net.minecraft.util.ResourceLocation;\n+import net.minecraft.util.math.BlockPos;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Interface for colony event types.\n+ */\n+public interface IColonyEvent", "originalCommit": "f6c2c039bf89993478270b156d4640dc63731ddc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MDY3MA==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r386090670", "bodyText": "Something like IColonyEntitySpawnEvent or IColonyGroupSpawnEvent possibly with some abstraction into an IColonySpawnEvent and IColonyEvent", "author": "OrionDevelopment", "createdAt": "2020-03-01T09:12:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MDYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MDc5MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r386090791", "bodyText": "Also you might want to have an interface that describes an event that spawns a structure.\nSo that raid events are both spawning and have structure handling.\nThis makes expanding this system easier in the future -> Think of camps of traiders that spawn outside the city walls to trade with etc.", "author": "OrionDevelopment", "createdAt": "2020-03-01T09:13:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MDYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MTg2Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r386091866", "bodyText": "ye you're right indeed, colony event doesnt necessarily need entities, splitting it makes sense. An interface for spawning structures alongside an event should be useful too", "author": "someaddons", "createdAt": "2020-03-01T09:28:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MDYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEyMDQxOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4331#discussion_r386120419", "bodyText": "I've seperated them into Colony/Spawn/entitySpawn/raid/structureSpawn types now, think that should fit it", "author": "someaddons", "createdAt": "2020-03-01T16:16:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MDYwMQ=="}], "type": "inlineReview"}, {"oid": "f091c23d1fab2fe8dc7e1bb07f2c4b4dc0aba9e9", "url": "https://github.com/ldtteam/minecolonies/commit/f091c23d1fab2fe8dc7e1bb07f2c4b4dc0aba9e9", "message": "Abstract Interfaces further\nRemove structure backup file after loading backup\nMourning now has lower priority than sleeping/hiding\nImproved raider unstuck a bit further", "committedDate": "2020-03-01T15:21:40Z", "type": "commit"}, {"oid": "78304f6f6e86701f698c9551995f3704f403323a", "url": "https://github.com/ldtteam/minecolonies/commit/78304f6f6e86701f698c9551995f3704f403323a", "message": "Merge remote-tracking branch 'remotes/origin/version/1.12' into raiderFix112\n\n# Conflicts:\n#\tbuild.properties", "committedDate": "2020-03-01T15:22:21Z", "type": "commit"}]}