{"pr_number": 5241, "pr_title": "Improve scarecrow", "pr_createdAt": "2020-06-17T05:37:20Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5241", "timeline": [{"oid": "c666cff8d0b84fa66c40f3c0663197cd6c81ef7f", "url": "https://github.com/ldtteam/minecolonies/commit/c666cff8d0b84fa66c40f3c0663197cd6c81ef7f", "message": "Fix scarecrow placement condition\n\nEnsure the upper block of the scarecrow has a clear space to be placed in", "committedDate": "2020-06-17T06:04:22Z", "type": "forcePushed"}, {"oid": "d57a626bb38cfe6359af542eaff9161c855762df", "url": "https://github.com/ldtteam/minecolonies/commit/d57a626bb38cfe6359af542eaff9161c855762df", "message": "Add upper half of scarecrow\n\nAdd a double block blockstate to introduce a secondary UPPER scarecrow block\nUpdate place, destroy, and activate logic in scarecrow block to consider halves\nUpdate the tile entity placement and field container to only use the LOWER half", "committedDate": "2020-06-17T06:36:59Z", "type": "commit"}, {"oid": "0c4db1cda6b15b63cb364a15c53fe043296bdfc9", "url": "https://github.com/ldtteam/minecolonies/commit/0c4db1cda6b15b63cb364a15c53fe043296bdfc9", "message": "Fix scarecrow inventory\n\nReplace the IItemHandler with the less glitchy IInventory\nSimplify shift-click transfer function\nAdd Slot anonymous extension for validating seeds", "committedDate": "2020-06-17T06:37:29Z", "type": "commit"}, {"oid": "85ffb559190c4b6356e1d89df403c25894ad4558", "url": "https://github.com/ldtteam/minecolonies/commit/85ffb559190c4b6356e1d89df403c25894ad4558", "message": "Adjust scarecrow hitbox and initial rotation\n\nModify placement rotation to face the player\nMake both halves of scarecrow block reflect the same hitbox", "committedDate": "2020-06-17T06:37:37Z", "type": "commit"}, {"oid": "e2213fe19736a93963b7419770c820940161c734", "url": "https://github.com/ldtteam/minecolonies/commit/e2213fe19736a93963b7419770c820940161c734", "message": "Change scarecrow held item model\n\nSet scarecrow held item to be generated as an item with rotation, not a built-in", "committedDate": "2020-06-17T06:37:47Z", "type": "commit"}, {"oid": "e4f9f2c19547d1183e68ee73d904be721bc16165", "url": "https://github.com/ldtteam/minecolonies/commit/e4f9f2c19547d1183e68ee73d904be721bc16165", "message": "Adjust scarecrow held item texture", "committedDate": "2020-06-17T06:37:52Z", "type": "commit"}, {"oid": "eb1844dee84e2ef757b4a405d6ad6b9f4cace74a", "url": "https://github.com/ldtteam/minecolonies/commit/eb1844dee84e2ef757b4a405d6ad6b9f4cace74a", "message": "Fix scarecrow placement condition\n\nEnsure the upper block of the scarecrow has a clear space to be placed in", "committedDate": "2020-06-17T06:37:58Z", "type": "commit"}, {"oid": "eb1844dee84e2ef757b4a405d6ad6b9f4cace74a", "url": "https://github.com/ldtteam/minecolonies/commit/eb1844dee84e2ef757b4a405d6ad6b9f4cace74a", "message": "Fix scarecrow placement condition\n\nEnsure the upper block of the scarecrow has a clear space to be placed in", "committedDate": "2020-06-17T06:37:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyNTgwMg==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443125802", "bodyText": "As far as I know we should not be using IInventory anymore and instead use IItemhandlers.", "author": "Raycoms", "createdAt": "2020-06-20T12:03:24Z", "path": "src/main/java/com/minecolonies/coremod/tileentities/ScarecrowTileEntity.java", "diffHunk": "@@ -119,87 +117,16 @@\n     /**\n      * Inventory of the field.\n      */\n-    private final IItemHandlerModifiable inventory = new IItemHandlerModifiable() {", "originalCommit": "eb1844dee84e2ef757b4a405d6ad6b9f4cace74a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxODAyNg==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443318026", "bodyText": "Ah, true true. There was still one of the functions causing a glitch in the implementation that was there before. I believe it is fixed now. Not quite sure which part was causing it still.", "author": "ShadowProtocol", "createdAt": "2020-06-22T05:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyNTgwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyNTgyNQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443125825", "bodyText": "formatting\n{\n}\n(All over the PR)", "author": "Raycoms", "createdAt": "2020-06-20T12:03:50Z", "path": "src/main/java/com/minecolonies/coremod/blocks/BlockScarecrow.java", "diffHunk": "@@ -135,17 +167,27 @@ public void onExplosionDestroy(final World worldIn, final BlockPos pos, final Ex\n     @Override\n     public void onBlockHarvested(final World worldIn, @NotNull final BlockPos pos, final BlockState state, @NotNull final PlayerEntity player)\n     {\n+        DoubleBlockHalf half = state.get(HALF);\n+        BlockPos otherpos = half == DoubleBlockHalf.LOWER? pos.up() : pos.down();\n+        BlockState otherstate = worldIn.getBlockState(otherpos);\n+\n+        // just double check the other block is also the scarecrow and not the same half,\n+        // then destroy it (make it air)\n+        if (otherstate.getBlock() == this && otherstate.get(HALF) != half) {", "originalCommit": "eb1844dee84e2ef757b4a405d6ad6b9f4cace74a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyNTg0NA==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443125844", "bodyText": "@OverRide", "author": "Raycoms", "createdAt": "2020-06-20T12:04:13Z", "path": "src/main/java/com/minecolonies/coremod/blocks/BlockScarecrow.java", "diffHunk": "@@ -101,8 +114,23 @@ public ActionResultType onBlockActivated(\n     @Override\n     public BlockState getStateForPlacement(final BlockItemUseContext context)\n     {\n-        @NotNull final Direction Direction = (context.getPlayer() == null) ? NORTH : fromAngle(context.getPlayer().rotationYaw);\n-        return this.getDefaultState().with(FACING, Direction);\n+        @NotNull final Direction Direction = (context.getPlayer() == null) ? NORTH : fromAngle(context.getPlayer().rotationYaw + 180);\n+\n+        if (context.getPos().getY() < 255 && context.getWorld().getBlockState(context.getPos().up()).isReplaceable(context)) {\n+            return this.getDefaultState().with(FACING, Direction).with(HALF, DoubleBlockHalf.LOWER);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    public boolean isValidPosition(BlockState state, IWorldReader worldIn, BlockPos pos) {", "originalCommit": "eb1844dee84e2ef757b4a405d6ad6b9f4cace74a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4e264ab77f2255179083408a4a77104ddf63fb5", "url": "https://github.com/ldtteam/minecolonies/commit/d4e264ab77f2255179083408a4a77104ddf63fb5", "message": "Use ItemStackHandler in scarecrow tile entity\n\nSwitch IInventory for Forge IItemHandler's default implementation ItemStackHandler\nFix brace formatting\nAdd Override annotations", "committedDate": "2020-06-22T04:24:24Z", "type": "commit"}, {"oid": "c2529786d8e4251f64fc4a3e200e3cf30a43cab1", "url": "https://github.com/ldtteam/minecolonies/commit/c2529786d8e4251f64fc4a3e200e3cf30a43cab1", "message": "Fix placement glitch with scarecrow\n\nFix other interactions like block placement from starting when the scarecrow is interacted with", "committedDate": "2020-06-22T04:52:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNzAxNA==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443317014", "bodyText": "formatting", "author": "Asherslab", "createdAt": "2020-06-22T04:57:14Z", "path": "src/api/java/com/minecolonies/api/inventory/container/ContainerField.java", "diffHunk": "@@ -87,28 +97,28 @@ public ContainerField(final int windowId, final PlayerInventory playerInventory,\n \n     @NotNull\n     @Override\n-    public ItemStack transferStackInSlot(@NotNull final PlayerEntity playerIn, final int slotIndex)\n+    public ItemStack transferStackInSlot(@NotNull final PlayerEntity playerIn, final int index)\n     {\n-        if (slotIndex == 0)\n-        {\n-            playerIn.inventory.addItemStackToInventory(inventory.getStackInSlot(0));\n-            inventory.insertItem(0, ItemStackUtils.EMPTY, false);\n-        }\n-        else if (inventory.getStackInSlot(0) == ItemStackUtils.EMPTY || ItemStackUtils.getSize(inventory.getStackInSlot(0)) == 0)\n+        ItemStack transfer = ItemStack.EMPTY;\n+        Slot slot = this.inventorySlots.get(index);\n+\n+        if (slot == null || !slot.getHasStack()) return transfer;\n+\n+        transfer = slot.getStack();\n+\n+        if (index == 0)\n         {\n-            final int playerIndex = slotIndex < MAX_INVENTORY_INDEX ? (slotIndex + INVENTORY_BAR_SIZE) : (slotIndex - MAX_INVENTORY_INDEX);\n-            if (playerIn.inventory.getStackInSlot(playerIndex) != ItemStackUtils.EMPTY)\n+            if (!mergeItemStack(transfer, 1, 37, true)) {\n+                return ItemStack.EMPTY;\n+            }\n+        } else {", "originalCommit": "c2529786d8e4251f64fc4a3e200e3cf30a43cab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNzIyNw==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443317227", "bodyText": "formatting", "author": "Asherslab", "createdAt": "2020-06-22T04:58:10Z", "path": "src/main/java/com/minecolonies/coremod/blocks/BlockScarecrow.java", "diffHunk": "@@ -87,22 +95,49 @@ public ActionResultType onBlockActivated(\n         //If the world is server, open the inventory of the field.\n         if (!worldIn.isRemote)\n         {\n-            final TileEntity entity = worldIn.getTileEntity(pos);\n+            // Get the entity of the bottom half\n+            DoubleBlockHalf half = state.get(HALF);\n+            final TileEntity entity = worldIn.getTileEntity(\n+                half == DoubleBlockHalf.UPPER? pos.down() : pos\n+            );\n+\n             if (entity instanceof ScarecrowTileEntity)\n             {\n                 NetworkHooks.openGui((ServerPlayerEntity) player, (ScarecrowTileEntity) entity, pos);\n-                return ActionResultType.SUCCESS;\n+            } else {", "originalCommit": "c2529786d8e4251f64fc4a3e200e3cf30a43cab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNzI1NA==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443317254", "bodyText": "formatting", "author": "Asherslab", "createdAt": "2020-06-22T04:58:19Z", "path": "src/main/java/com/minecolonies/coremod/blocks/BlockScarecrow.java", "diffHunk": "@@ -87,22 +95,49 @@ public ActionResultType onBlockActivated(\n         //If the world is server, open the inventory of the field.\n         if (!worldIn.isRemote)\n         {\n-            final TileEntity entity = worldIn.getTileEntity(pos);\n+            // Get the entity of the bottom half\n+            DoubleBlockHalf half = state.get(HALF);\n+            final TileEntity entity = worldIn.getTileEntity(\n+                half == DoubleBlockHalf.UPPER? pos.down() : pos\n+            );\n+\n             if (entity instanceof ScarecrowTileEntity)\n             {\n                 NetworkHooks.openGui((ServerPlayerEntity) player, (ScarecrowTileEntity) entity, pos);\n-                return ActionResultType.SUCCESS;\n+            } else {\n+                return ActionResultType.FAIL;\n             }\n         }\n-        return ActionResultType.FAIL;\n+\n+        // This must succeed in Remote to stop more right click interactions like placing blocks\n+        return ActionResultType.SUCCESS;\n     }\n \n     @javax.annotation.Nullable\n     @Override\n     public BlockState getStateForPlacement(final BlockItemUseContext context)\n     {\n-        @NotNull final Direction Direction = (context.getPlayer() == null) ? NORTH : fromAngle(context.getPlayer().rotationYaw);\n-        return this.getDefaultState().with(FACING, Direction);\n+        @NotNull final Direction Direction = (context.getPlayer() == null) ? NORTH : fromAngle(context.getPlayer().rotationYaw + 180);\n+\n+        if (context.getPos().getY() < 255 && context.getWorld().getBlockState(context.getPos().up()).isReplaceable(context))\n+        {\n+            return this.getDefaultState().with(FACING, Direction).with(HALF, DoubleBlockHalf.LOWER);\n+        } else {", "originalCommit": "c2529786d8e4251f64fc4a3e200e3cf30a43cab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNzI5Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443317297", "bodyText": "formatting", "author": "Asherslab", "createdAt": "2020-06-22T04:58:31Z", "path": "src/main/java/com/minecolonies/coremod/blocks/BlockScarecrow.java", "diffHunk": "@@ -87,22 +95,49 @@ public ActionResultType onBlockActivated(\n         //If the world is server, open the inventory of the field.\n         if (!worldIn.isRemote)\n         {\n-            final TileEntity entity = worldIn.getTileEntity(pos);\n+            // Get the entity of the bottom half\n+            DoubleBlockHalf half = state.get(HALF);\n+            final TileEntity entity = worldIn.getTileEntity(\n+                half == DoubleBlockHalf.UPPER? pos.down() : pos\n+            );\n+\n             if (entity instanceof ScarecrowTileEntity)\n             {\n                 NetworkHooks.openGui((ServerPlayerEntity) player, (ScarecrowTileEntity) entity, pos);\n-                return ActionResultType.SUCCESS;\n+            } else {\n+                return ActionResultType.FAIL;\n             }\n         }\n-        return ActionResultType.FAIL;\n+\n+        // This must succeed in Remote to stop more right click interactions like placing blocks\n+        return ActionResultType.SUCCESS;\n     }\n \n     @javax.annotation.Nullable\n     @Override\n     public BlockState getStateForPlacement(final BlockItemUseContext context)\n     {\n-        @NotNull final Direction Direction = (context.getPlayer() == null) ? NORTH : fromAngle(context.getPlayer().rotationYaw);\n-        return this.getDefaultState().with(FACING, Direction);\n+        @NotNull final Direction Direction = (context.getPlayer() == null) ? NORTH : fromAngle(context.getPlayer().rotationYaw + 180);\n+\n+        if (context.getPos().getY() < 255 && context.getWorld().getBlockState(context.getPos().up()).isReplaceable(context))\n+        {\n+            return this.getDefaultState().with(FACING, Direction).with(HALF, DoubleBlockHalf.LOWER);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public boolean isValidPosition(BlockState state, IWorldReader worldIn, BlockPos pos)\n+    {\n+        BlockPos blockpos = pos.down();\n+        BlockState blockstate = worldIn.getBlockState(blockpos);\n+        if (state.get(HALF) == DoubleBlockHalf.LOWER)\n+        {\n+            return blockstate.isSolidSide(worldIn, blockpos, Direction.UP);\n+        } else {", "originalCommit": "c2529786d8e4251f64fc4a3e200e3cf30a43cab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNzU1Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443317557", "bodyText": "formatting (space between LOWER and ? in ternaries)", "author": "Asherslab", "createdAt": "2020-06-22T04:59:50Z", "path": "src/main/java/com/minecolonies/coremod/blocks/BlockScarecrow.java", "diffHunk": "@@ -135,17 +176,28 @@ public void onExplosionDestroy(final World worldIn, final BlockPos pos, final Ex\n     @Override\n     public void onBlockHarvested(final World worldIn, @NotNull final BlockPos pos, final BlockState state, @NotNull final PlayerEntity player)\n     {\n+        DoubleBlockHalf half = state.get(HALF);\n+        BlockPos otherpos = half == DoubleBlockHalf.LOWER? pos.up() : pos.down();", "originalCommit": "c2529786d8e4251f64fc4a3e200e3cf30a43cab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNzY2MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443317661", "bodyText": "please remove code don't comment it out", "author": "Asherslab", "createdAt": "2020-06-22T05:00:20Z", "path": "src/main/java/com/minecolonies/coremod/blocks/BlockScarecrow.java", "diffHunk": "@@ -135,17 +176,28 @@ public void onExplosionDestroy(final World worldIn, final BlockPos pos, final Ex\n     @Override\n     public void onBlockHarvested(final World worldIn, @NotNull final BlockPos pos, final BlockState state, @NotNull final PlayerEntity player)\n     {\n+        DoubleBlockHalf half = state.get(HALF);\n+        BlockPos otherpos = half == DoubleBlockHalf.LOWER? pos.up() : pos.down();\n+        BlockState otherstate = worldIn.getBlockState(otherpos);\n+\n+        // just double check the other block is also the scarecrow and not the same half,\n+        // then destroy it (make it air)\n+        if (otherstate.getBlock() == this && otherstate.get(HALF) != half)\n+        {\n+            worldIn.setBlockState(otherpos, Blocks.AIR.getDefaultState(), 35);\n+        }\n+\n         notifyColonyAboutDestruction(worldIn, pos);\n         super.onBlockHarvested(worldIn, pos, state, player);\n     }\n-\n+/*\n     @Override", "originalCommit": "c2529786d8e4251f64fc4a3e200e3cf30a43cab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxODA4NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5241#discussion_r443318085", "bodyText": "usage of ItemStackUtils version is preferred for easier future porting (reason it was made in the first place)", "author": "Asherslab", "createdAt": "2020-06-22T05:02:29Z", "path": "src/main/java/com/minecolonies/coremod/tileentities/ScarecrowTileEntity.java", "diffHunk": "@@ -578,7 +518,7 @@ public void read(final CompoundNBT compound)\n             final ItemStack stack = ItemStack.read(inventoryCompound);\n             if (ItemStackUtils.getSize(stack) <= 0)\n             {\n-                inventory.setStackInSlot(i, ItemStackUtils.EMPTY);\n+                inventory.setStackInSlot(i, ItemStack.EMPTY);", "originalCommit": "c2529786d8e4251f64fc4a3e200e3cf30a43cab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8e4d4725e54470cd376bb05bb52ba2afd4327841", "url": "https://github.com/ldtteam/minecolonies/commit/8e4d4725e54470cd376bb05bb52ba2afd4327841", "message": "Fix formatting\n\nRestore uses of ItemStackUtils.Empty\nExpand else statements and ternary statements", "committedDate": "2020-06-22T05:21:00Z", "type": "commit"}, {"oid": "5beb30877ed6521c30bd3670c3fef3398a2865cd", "url": "https://github.com/ldtteam/minecolonies/commit/5beb30877ed6521c30bd3670c3fef3398a2865cd", "message": "Merge branch 'version/1.15' into feature/scarecrow", "committedDate": "2020-06-22T12:19:46Z", "type": "commit"}]}