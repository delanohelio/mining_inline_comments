{"pr_number": 4385, "pr_title": "Inventoryutils issues", "pr_createdAt": "2020-03-01T17:36:26Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/4385", "timeline": [{"oid": "8c2fe1fb7e37a915640f439094d9c11461cfd5e2", "url": "https://github.com/ldtteam/minecolonies/commit/8c2fe1fb7e37a915640f439094d9c11461cfd5e2", "message": "Fixes a multitude of inventory issues, from dupes to lost stacks.", "committedDate": "2020-03-01T17:32:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEyNTk0OA==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386125948", "bodyText": "and if we were able to insert a partial stack first and then the rest?\nThis should have worked fine up to now.", "author": "Raycoms", "createdAt": "2020-03-01T17:38:16Z", "path": "src/api/java/com/minecolonies/api/util/InventoryUtils.java", "diffHunk": "@@ -874,14 +874,27 @@ public static boolean addItemStackToItemHandler(@NotNull final IItemHandler item\n                 slot = itemHandler.getSlots() == 0 ? -1 : 0;\n                 while (!ItemStackUtils.isEmpty(resultStack) && slot != -1 && slot != itemHandler.getSlots())\n                 {\n-                    resultStack = itemHandler.insertItem(slot, resultStack, false);\n+                    resultStack = itemHandler.insertItem(slot, resultStack, true);\n                     if (!ItemStackUtils.isEmpty(resultStack))\n                     {\n                         slot++;\n                     }\n+                    // result empty, we can insert the whole stack", "originalCommit": "8c2fe1fb7e37a915640f439094d9c11461cfd5e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEyNjI2Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386126262", "bodyText": "resultStack is the remainder already for the partial insert, which gets re-used in the loop till its empty or the loop failed. So when its empty we can fit the whole. But can probably simplify this a lot later.\nThe issue with this was that the return value lost information,  doing a partial insert combined with true/false return either leads to some information loss, or to having to modify the stack parameters size and hoping there is followup logic which is really hacky. So this is now all or nothing", "author": "someaddons", "createdAt": "2020-03-01T17:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEyNTk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDQ4MA==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386220480", "bodyText": "This is flawed logic. There are inventories from which you can't extract and not insert.", "author": "OrionDevelopment", "createdAt": "2020-03-02T06:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEyNTk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyOTk0Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386229942", "bodyText": "you're saying there are inventories which take a not-empty stack into insert and then return an empty stack without beeing able to insert it?", "author": "someaddons", "createdAt": "2020-03-02T07:26:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEyNTk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMxMjk1Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386312956", "bodyText": "Yes", "author": "OrionDevelopment", "createdAt": "2020-03-02T10:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEyNTk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMyNzY4Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386327682", "bodyText": "hm but I think if insert with simulate works then insert without simulate should work aswell?", "author": "someaddons", "createdAt": "2020-03-02T11:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEyNTk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386220971", "bodyText": "You are violating the IITemHandler contract here!\nAlways simulate first before performing any operation", "author": "OrionDevelopment", "createdAt": "2020-03-02T06:52:20Z", "path": "src/api/java/com/minecolonies/api/util/InventoryUtils.java", "diffHunk": "@@ -1473,7 +1486,7 @@ public static boolean transferItemStackIntoNextFreeSlotInItemHandler(\n                                                                            final int sourceIndex,\n                                                                            @NotNull final IItemHandler targetHandler)\n     {\n-        ItemStack sourceStack = sourceHandler.extractItem(sourceIndex, Integer.MAX_VALUE, true);\n+        ItemStack sourceStack = sourceHandler.extractItem(sourceIndex, Integer.MAX_VALUE, false);", "originalCommit": "8c2fe1fb7e37a915640f439094d9c11461cfd5e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIzMDIwMw==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386230203", "bodyText": "where do I find that IITemHandler contract? in the documentation I only see that input stacks are not to be modified, thats all", "author": "someaddons", "createdAt": "2020-03-02T07:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMxMzM2Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386313366", "bodyText": "It is not really a contract.\nIt is the general rule that was setup when they where defined:\nFirst test if you actually can modify the inventory\nThen actually the modification when you are happy with it.", "author": "OrionDevelopment", "createdAt": "2020-03-02T10:34:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMyNzE3Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386327177", "bodyText": "ah I see, so for that we always want to do extract simulate -> insert simulate -> extract real -> insert real?", "author": "someaddons", "createdAt": "2020-03-02T11:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMyODIxMA==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386328210", "bodyText": "btw I saw that forge(or maybe vanilla?) does insert simulate -> set stack for inventories", "author": "someaddons", "createdAt": "2020-03-02T11:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMzNzU5NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386337595", "bodyText": "Both work really.\nImportant is that you do a simulate first.\nSet stack just overrides.\nForge does it in vanilla cause insert simulate -> set stack basically is the same.", "author": "OrionDevelopment", "createdAt": "2020-03-02T11:25:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMzNzg4Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386337887", "bodyText": "Personally I would create something like an Inventory interaction handler\nWhich records somehow the interactions thgat you want to do.\nTHen returns the simulated results, and allows you to tell it to commit the change.", "author": "OrionDevelopment", "createdAt": "2020-03-02T11:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMzODcyNA==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386338724", "bodyText": "ye that would be nice to have, kinda like DB transactions", "author": "someaddons", "createdAt": "2020-03-02T11:28:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMzOTM3Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386339372", "bodyText": "Yes exactly.\nSomething that has the exact same signatures as IItemHandler (Except maybe the simulate flag) or something.", "author": "OrionDevelopment", "createdAt": "2020-03-02T11:29:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM0MDYwOA==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386340608", "bodyText": "Shouldn't we able to code this in a utility function somehow?", "author": "Raycoms", "createdAt": "2020-03-02T11:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM0MTQwNg==", "url": "https://github.com/ldtteam/minecolonies/pull/4385#discussion_r386341406", "bodyText": "ye should be doable, although I'd leave that for the rework, since this was just supposed to be bugfixes", "author": "someaddons", "createdAt": "2020-03-02T11:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIyMDk3MQ=="}], "type": "inlineReview"}, {"oid": "092678b5c07bd9c33d40fc7e710df115fc3c3c97", "url": "https://github.com/ldtteam/minecolonies/commit/092678b5c07bd9c33d40fc7e710df115fc3c3c97", "message": "update to simulate first", "committedDate": "2020-03-02T11:58:42Z", "type": "commit"}, {"oid": "e7cb2280eef3d6da0e2677190dda881a5816c85f", "url": "https://github.com/ldtteam/minecolonies/commit/e7cb2280eef3d6da0e2677190dda881a5816c85f", "message": "Merge branch 'version/1.15' into inventoryFixes115", "committedDate": "2020-03-07T19:49:27Z", "type": "commit"}]}