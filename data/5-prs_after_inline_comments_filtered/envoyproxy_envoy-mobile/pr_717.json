{"pr_number": 717, "pr_title": "stats: flush stats based on application lifecycle", "pr_createdAt": "2020-03-02T19:51:55Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/717", "timeline": [{"oid": "b43541e308e25ab5b782d5eafeabe5771869edbd", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b43541e308e25ab5b782d5eafeabe5771869edbd", "message": "core: expose functionality for flushing stats manually\n\nAdds functionality built on top of the upstream Envoy changes in https://github.com/envoyproxy/envoy/pull/10097 which will allow the bridging layers to manually flush stats based on lifecycle changes in the mobile application.\n\nFollow-up PRs will call these functions from Java/Objective-C.\n\nPart of https://github.com/lyft/envoy-mobile/issues/573.\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-02-27T22:01:57Z", "type": "commit"}, {"oid": "0db7a6ece740a5f1f7413d69a779948ea14da207", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0db7a6ece740a5f1f7413d69a779948ea14da207", "message": "must be called on main\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-02-27T22:47:02Z", "type": "commit"}, {"oid": "f2720babe88717df8d11b86bd461d1e0ae51ae4b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/f2720babe88717df8d11b86bd461d1e0ae51ae4b", "message": "CR\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-02-28T01:05:46Z", "type": "commit"}, {"oid": "08dba3419c662ba04346ade92e212dad0e63fcb5", "url": "https://github.com/envoyproxy/envoy-mobile/commit/08dba3419c662ba04346ade92e212dad0e63fcb5", "message": "Merge remote-tracking branch 'origin/master' into expose-flush\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-02T18:15:40Z", "type": "commit"}, {"oid": "6a2aede13bdb119423697042cbd4cc573ed8bb95", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6a2aede13bdb119423697042cbd4cc573ed8bb95", "message": "wip\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-02T19:50:27Z", "type": "commit"}, {"oid": "a88d4eed1b77bc56bec97b71a8fc1685888e724f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a88d4eed1b77bc56bec97b71a8fc1685888e724f", "message": "more wip\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-02T23:07:55Z", "type": "commit"}, {"oid": "2999f6e1204da0258dabbf140244e45c6a889a48", "url": "https://github.com/envoyproxy/envoy-mobile/commit/2999f6e1204da0258dabbf140244e45c6a889a48", "message": "fixes\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T01:43:51Z", "type": "forcePushed"}, {"oid": "e86eceb7c7262bc927a8ac0701ad4eedd6536348", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e86eceb7c7262bc927a8ac0701ad4eedd6536348", "message": "stats: emit stats for retries (#718)\n\nAdding the following stats to the allow-list based on [these Envoy docs](https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats):\r\n\r\n- `upstream_rq_retry`\r\n- `upstream_rq_retry_overflow`\r\n- `upstream_rq_retry_success`\r\n\r\nAlso re-alphabetized the stats list.\r\n\r\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T01:45:50Z", "type": "commit"}, {"oid": "99fb286691af18f570f486cafc0fef80d873ad3e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/99fb286691af18f570f486cafc0fef80d873ad3e", "message": "core: expose functionality for flushing stats manually (#707)\n\nAdds functionality built on top of the upstream Envoy changes in https://github.com/envoyproxy/envoy/pull/10097 which will allow the bridging layers to manually flush stats based on lifecycle changes in the mobile application.\n\nNote: Stats must be flushed from the main Envoy thread, as validated by the following assertion failure that occurs when attempting to flush from another thread:\n\n```\n[2020-02-27 14:38:43.181][4716580][critical][assert] [external/envoy/source/common/thread_local/thread_local_impl.cc:190] assert failure: std::this_thread::get_id() == main_thread_id_.\n```\n\nFollow-up PRs will call these functions from Java/Objective-C.\n\nPart of https://github.com/lyft/envoy-mobile/issues/573.\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T01:45:57Z", "type": "commit"}, {"oid": "b61a235afdaabf1c2acce01d377f0658c16aede0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b61a235afdaabf1c2acce01d377f0658c16aede0", "message": "alan's references\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T01:45:58Z", "type": "commit"}, {"oid": "50f7aaf921e1e8912ebb83b01714483189fa9cd0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/50f7aaf921e1e8912ebb83b01714483189fa9cd0", "message": "more work\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T01:45:58Z", "type": "commit"}, {"oid": "50f7aaf921e1e8912ebb83b01714483189fa9cd0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/50f7aaf921e1e8912ebb83b01714483189fa9cd0", "message": "more work\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T01:45:58Z", "type": "forcePushed"}, {"oid": "d1246b6859db174b6b2f9b60618459146d477ac3", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d1246b6859db174b6b2f9b60618459146d477ac3", "message": "Merge remote-tracking branch 'origin/master' into flush-platform\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T01:46:28Z", "type": "commit"}, {"oid": "0624f1644fb50d2d42ff083ba443042db5484589", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0624f1644fb50d2d42ff083ba443042db5484589", "message": "fixes\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T01:47:18Z", "type": "commit"}, {"oid": "1b221fab984c0099dc0597a734f9fb9f46baa420", "url": "https://github.com/envoyproxy/envoy-mobile/commit/1b221fab984c0099dc0597a734f9fb9f46baa420", "message": "more updates\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T02:01:30Z", "type": "commit"}, {"oid": "b6adbccaba2dbdcbc5d4e80136b6e31950a40214", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b6adbccaba2dbdcbc5d4e80136b6e31950a40214", "message": "android examples\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T02:10:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwNDc0Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/717#discussion_r386804742", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public EnvoyHTTPStream startStream(EnvoyHTTPCallbacks callbacks) {\n          \n          \n            \n              @Overrides\n          \n          \n            \n              public EnvoyHTTPStream startStream(EnvoyHTTPCallbacks callbacks) {", "author": "buildbreaker", "createdAt": "2020-03-03T05:22:06Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/AndroidEngineImpl.java", "diffHunk": "@@ -1,12 +1,35 @@\n package io.envoyproxy.envoymobile.engine;\n \n import android.content.Context;\n+import io.envoyproxy.envoymobile.engine.types.EnvoyHTTPCallbacks;\n \n-public class AndroidEngineImpl extends EnvoyEngineImpl {\n+public class AndroidEngineImpl implements AndroidEnvoyEngine {\n+  private final EnvoyEngine envoyEngine;\n \n   public AndroidEngineImpl(Context context) {\n-    super();\n+    envoyEngine = new EnvoyEngineImpl();\n     AndroidJniLibrary.load(context);\n     AndroidNetworkMonitor.load(context);\n   }\n+\n+  public EnvoyHTTPStream startStream(EnvoyHTTPCallbacks callbacks) {", "originalCommit": "b6adbccaba2dbdcbc5d4e80136b6e31950a40214", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwNDc3Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/717#discussion_r386804777", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public int runWithConfig(String configurationYAML, String logLevel) {\n          \n          \n            \n              @Overrides\n          \n          \n            \n              public int runWithConfig(String configurationYAML, String logLevel) {", "author": "buildbreaker", "createdAt": "2020-03-03T05:22:16Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/AndroidEngineImpl.java", "diffHunk": "@@ -1,12 +1,35 @@\n package io.envoyproxy.envoymobile.engine;\n \n import android.content.Context;\n+import io.envoyproxy.envoymobile.engine.types.EnvoyHTTPCallbacks;\n \n-public class AndroidEngineImpl extends EnvoyEngineImpl {\n+public class AndroidEngineImpl implements AndroidEnvoyEngine {\n+  private final EnvoyEngine envoyEngine;\n \n   public AndroidEngineImpl(Context context) {\n-    super();\n+    envoyEngine = new EnvoyEngineImpl();\n     AndroidJniLibrary.load(context);\n     AndroidNetworkMonitor.load(context);\n   }\n+\n+  public EnvoyHTTPStream startStream(EnvoyHTTPCallbacks callbacks) {\n+    return envoyEngine.startStream(callbacks);\n+  }\n+\n+  public int runWithConfig(String configurationYAML, String logLevel) {", "originalCommit": "b6adbccaba2dbdcbc5d4e80136b6e31950a40214", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwNDgwNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/717#discussion_r386804805", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public int runWithConfig(EnvoyConfiguration envoyConfiguration, String logLevel) {\n          \n          \n            \n              @Overrides\n          \n          \n            \n              public int runWithConfig(EnvoyConfiguration envoyConfiguration, String logLevel) {", "author": "buildbreaker", "createdAt": "2020-03-03T05:22:25Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/AndroidEngineImpl.java", "diffHunk": "@@ -1,12 +1,35 @@\n package io.envoyproxy.envoymobile.engine;\n \n import android.content.Context;\n+import io.envoyproxy.envoymobile.engine.types.EnvoyHTTPCallbacks;\n \n-public class AndroidEngineImpl extends EnvoyEngineImpl {\n+public class AndroidEngineImpl implements AndroidEnvoyEngine {\n+  private final EnvoyEngine envoyEngine;\n \n   public AndroidEngineImpl(Context context) {\n-    super();\n+    envoyEngine = new EnvoyEngineImpl();\n     AndroidJniLibrary.load(context);\n     AndroidNetworkMonitor.load(context);\n   }\n+\n+  public EnvoyHTTPStream startStream(EnvoyHTTPCallbacks callbacks) {\n+    return envoyEngine.startStream(callbacks);\n+  }\n+\n+  public int runWithConfig(String configurationYAML, String logLevel) {\n+    return envoyEngine.runWithConfig(configurationYAML, logLevel);\n+  }\n+\n+  public int runWithConfig(EnvoyConfiguration envoyConfiguration, String logLevel) {", "originalCommit": "b6adbccaba2dbdcbc5d4e80136b6e31950a40214", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwNDg1OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/717#discussion_r386804859", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public int runWithConfig(AndroidEnvoyConfiguration envoyConfiguration, String logLevel) {\n          \n          \n            \n              @Overrides\n          \n          \n            \n              public int runWithConfig(AndroidEnvoyConfiguration envoyConfiguration, String logLevel) {", "author": "buildbreaker", "createdAt": "2020-03-03T05:22:41Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/AndroidEngineImpl.java", "diffHunk": "@@ -1,12 +1,35 @@\n package io.envoyproxy.envoymobile.engine;\n \n import android.content.Context;\n+import io.envoyproxy.envoymobile.engine.types.EnvoyHTTPCallbacks;\n \n-public class AndroidEngineImpl extends EnvoyEngineImpl {\n+public class AndroidEngineImpl implements AndroidEnvoyEngine {\n+  private final EnvoyEngine envoyEngine;\n \n   public AndroidEngineImpl(Context context) {\n-    super();\n+    envoyEngine = new EnvoyEngineImpl();\n     AndroidJniLibrary.load(context);\n     AndroidNetworkMonitor.load(context);\n   }\n+\n+  public EnvoyHTTPStream startStream(EnvoyHTTPCallbacks callbacks) {\n+    return envoyEngine.startStream(callbacks);\n+  }\n+\n+  public int runWithConfig(String configurationYAML, String logLevel) {\n+    return envoyEngine.runWithConfig(configurationYAML, logLevel);\n+  }\n+\n+  public int runWithConfig(EnvoyConfiguration envoyConfiguration, String logLevel) {\n+    return envoyEngine.runWithConfig(envoyConfiguration, logLevel);\n+  }\n+\n+  public int runWithConfig(AndroidEnvoyConfiguration envoyConfiguration, String logLevel) {", "originalCommit": "b6adbccaba2dbdcbc5d4e80136b6e31950a40214", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4627c855099e3ac7474020580ec94cabca08aea7", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4627c855099e3ac7474020580ec94cabca08aea7", "message": "wip\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T06:22:42Z", "type": "commit"}, {"oid": "995c2061eb99340da51e409b1911dd97f20646b4", "url": "https://github.com/envoyproxy/envoy-mobile/commit/995c2061eb99340da51e409b1911dd97f20646b4", "message": "revert builder\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>", "committedDate": "2020-03-03T06:46:11Z", "type": "commit"}, {"oid": "995c2061eb99340da51e409b1911dd97f20646b4", "url": "https://github.com/envoyproxy/envoy-mobile/commit/995c2061eb99340da51e409b1911dd97f20646b4", "message": "revert builder\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>", "committedDate": "2020-03-03T06:46:11Z", "type": "forcePushed"}, {"oid": "84ce03ee718e220ab9a8d534703f05900a6d8a31", "url": "https://github.com/envoyproxy/envoy-mobile/commit/84ce03ee718e220ab9a8d534703f05900a6d8a31", "message": "undo builder changes for now\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T06:56:15Z", "type": "commit"}, {"oid": "ea20975764872c6deb4ade853df9a3348bbd64cf", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ea20975764872c6deb4ade853df9a3348bbd64cf", "message": "cleanup\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T07:08:50Z", "type": "commit"}, {"oid": "808194b5c316d38f417be01ad9b50c57b17ab224", "url": "https://github.com/envoyproxy/envoy-mobile/commit/808194b5c316d38f417be01ad9b50c57b17ab224", "message": "fixup\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T07:11:22Z", "type": "commit"}, {"oid": "f6dc1ba56233adfb578427e52ff562a5f6b9434b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/f6dc1ba56233adfb578427e52ff562a5f6b9434b", "message": "fixup\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T07:23:03Z", "type": "commit"}, {"oid": "6781063f50a545aac1ae888909b4fc02b4c53a7c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6781063f50a545aac1ae888909b4fc02b4c53a7c", "message": "fixup\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-03-03T07:56:22Z", "type": "commit"}]}