{"pr_number": 1288, "pr_title": "GG-21923 Fix nodes not joining baseline topology after enabling auto adjust", "pr_createdAt": "2020-07-07T14:26:51Z", "pr_url": "https://github.com/gridgain/gridgain/pull/1288", "timeline": [{"oid": "a4bc96442a8e48232856718d6d042686e3c855a6", "url": "https://github.com/gridgain/gridgain/commit/a4bc96442a8e48232856718d6d042686e3c855a6", "message": "GG-21923 Fix nodes not joining baseline topology after enabling auto adjust", "committedDate": "2020-07-07T14:25:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0MzAxOQ==", "url": "https://github.com/gridgain/gridgain/pull/1288#discussion_r452143019", "bodyText": "I believe it is better not to add second method here. You can rename onEvent -> triggerBaselineUpdate and class ChangeTopologyWatcher to something like BaselineTopologyUpdater.\nAnd then registration of events(EVT_NODE_FAILED, EVT_NODE_LEFT, EVT_NODE_JOINED) should be modified according to using triggerBaselineUpdate(long topologyVersion)", "author": "akalash", "createdAt": "2020-07-09T11:15:07Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/baseline/autoadjust/ChangeTopologyWatcher.java", "diffHunk": "@@ -99,17 +99,26 @@ public ChangeTopologyWatcher(GridKernalContext ctx) {\n         if (discoEvt.eventNode().isClient() || discoEvt.eventNode().isDaemon())\n             return;\n \n-        synchronized (this) {\n-            lastBaselineData = lastBaselineData.next(discoEvt.topologyVersion());\n+        triggerBaselineUpdate(discoEvt.topologyVersion());\n+    }\n \n-            if (isLocalNodeCoordinator(discoveryMgr)) {\n-                exchangeManager.affinityReadyFuture(new AffinityTopologyVersion(discoEvt.topologyVersion()))\n+    /**\n+     * Schedule update of the baseline topology\n+     * @param topologyVersion version of topology\n+     */\n+    public synchronized void triggerBaselineUpdate(long topologyVersion) {", "originalCommit": "a4bc96442a8e48232856718d6d042686e3c855a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "193221c835c8ec47d70dc1c156d4c31294224988", "url": "https://github.com/gridgain/gridgain/commit/193221c835c8ec47d70dc1c156d4c31294224988", "message": "GG-21923 Review fix", "committedDate": "2020-07-13T08:26:50Z", "type": "commit"}, {"oid": "d74ffa235f597805a7fcaf91d113085ce7342f64", "url": "https://github.com/gridgain/gridgain/commit/d74ffa235f597805a7fcaf91d113085ce7342f64", "message": "GG-21923 Review fix", "committedDate": "2020-07-13T08:30:02Z", "type": "commit"}, {"oid": "deea9cdcfc006f59d928afa42ad3b37f5a1c96e7", "url": "https://github.com/gridgain/gridgain/commit/deea9cdcfc006f59d928afa42ad3b37f5a1c96e7", "message": "GG-21923 Fix test", "committedDate": "2020-07-14T12:31:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MjU5OQ==", "url": "https://github.com/gridgain/gridgain/pull/1288#discussion_r455092599", "bodyText": "You can add awaitPartitionMapExchange() after startGrid(1); then you can check ignite0.cluster().nodes().size() without waitForCondition. Also you must check  that currentBaselineTopology().size() equal to 1 before auto-adjust enabled.", "author": "akalash", "createdAt": "2020-07-15T14:25:03Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cluster/BaselineAutoAdjustTest.java", "diffHunk": "@@ -585,6 +586,39 @@ public void shouldJoinFailedBecauseCoordinatorIsInMemoryNodeAndEnabledAutoAdjust\n         }\n     }\n \n+    /**\n+     * Test that node joins baseline topology after enabling auto adjust.\n+     *\n+     * Description:\n+     * Start first node and set baseline auto adjust timeout to 100ms. Disable auto adjust and activate cluster.\n+     * Start another node and wait until it joins cluster. Enable auto adjust and check that node is in\n+     * baseline topology.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    public void testJoinBltExistingNode() throws Exception {\n+        IgniteEx ignite0 = startGrid(0);\n+\n+        ignite0.cluster().baselineAutoAdjustTimeout(100);\n+\n+        ignite0.cluster().baselineAutoAdjustEnabled(false);\n+\n+        ignite0.cluster().active(true);\n+\n+        startGrid(1);\n+\n+        assertTrue(GridTestUtils.waitForCondition(() -> {", "originalCommit": "deea9cdcfc006f59d928afa42ad3b37f5a1c96e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5NDkyNQ==", "url": "https://github.com/gridgain/gridgain/pull/1288#discussion_r455094925", "bodyText": "Do you add separate 'if' consciously or by mistake? ('if' which is above has the same return value)", "author": "akalash", "createdAt": "2020-07-15T14:27:55Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/baseline/autoadjust/BaselineTopologyUpdater.java", "diffHunk": "@@ -152,6 +150,9 @@ public BaselineAutoAdjustStatus getStatus() {\n             if (lastBaselineData.isAdjusted())\n                 return BaselineAutoAdjustStatus.notScheduled();\n \n+            if (baselineAutoAdjustScheduler.isExecutionExpired(lastBaselineData))", "originalCommit": "deea9cdcfc006f59d928afa42ad3b37f5a1c96e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5952db48b6ed0b21011f2dcb81ffa9329a75a234", "url": "https://github.com/gridgain/gridgain/commit/5952db48b6ed0b21011f2dcb81ffa9329a75a234", "message": "GG-21923 Fix test", "committedDate": "2020-07-16T08:19:39Z", "type": "commit"}]}