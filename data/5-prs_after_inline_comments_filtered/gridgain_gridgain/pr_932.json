{"pr_number": 932, "pr_title": "GG-23822: FIRSTVALUE and LASTVALUE aggregate functions", "pr_createdAt": "2020-02-18T08:34:30Z", "pr_url": "https://github.com/gridgain/gridgain/pull/932", "timeline": [{"oid": "b2920dcb3358b60d7fa1f5a2f79a3b83438e15d3", "url": "https://github.com/gridgain/gridgain/commit/b2920dcb3358b60d7fa1f5a2f79a3b83438e15d3", "message": "GG-23822 FIRSTVALUE and LASTVALUE aggregate functions", "committedDate": "2020-02-12T20:09:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyMjc3Ng==", "url": "https://github.com/gridgain/gridgain/pull/932#discussion_r380522776", "bodyText": "Objects.requireNonNull(fName);\nObjects.requireNonNull(cls);", "author": "AMashenkov", "createdAt": "2020-02-18T08:35:58Z", "path": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java", "diffHunk": "@@ -3157,4 +3162,38 @@ public LongRunningQueryManager longRunningQueries() {\n \n         return idx == null ? 0 : idx.size();\n     }\n+\n+    /**\n+     * Register predefined custom aggregate functions.\n+     *\n+     * @throws IgniteCheckedException If failed.\n+     */\n+    private void registerAggregateFunctions() throws IgniteCheckedException {\n+        registerAggregateFunction(GridFirstValueFunction.NAME, GridFirstValueFunction.class);\n+        registerAggregateFunction(GridLastValueFunction.NAME, GridLastValueFunction.class);\n+    }\n+\n+    /**\n+     * Register custom aggregate function.\n+     *\n+     * @param fnName SQL function name.\n+     * @param cls Function implementation class.\n+     * @throws IgniteCheckedException If failed.\n+     */\n+    public void registerAggregateFunction(String fnName,\n+        Class<? extends AggregateFunction> cls) throws IgniteCheckedException {\n+        if (fnName == null)", "originalCommit": "b2920dcb3358b60d7fa1f5a2f79a3b83438e15d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyMzA0OQ==", "url": "https://github.com/gridgain/gridgain/pull/932#discussion_r380523049", "bodyText": "@param comparator", "author": "AMashenkov", "createdAt": "2020-02-18T08:36:34Z", "path": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/sql/GridAggregateOrderedFunction.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.query.h2.sql;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.util.Comparator;\n+import org.h2.api.AggregateFunction;\n+\n+/**\n+ *  SQL aggregate function to select the first or last value in the sorted group.\n+ */\n+public class GridAggregateOrderedFunction implements AggregateFunction {\n+    /** */\n+    protected Object[] currentVal;\n+\n+    /** Ascending order. */\n+    protected boolean asc;\n+\n+    /** Nulls-last comparator. */\n+    protected Comparator<? super Comparable> comparator;\n+\n+    /**\n+     * @param asc ascending order.", "originalCommit": "b2920dcb3358b60d7fa1f5a2f79a3b83438e15d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUzOTYzNQ==", "url": "https://github.com/gridgain/gridgain/pull/932#discussion_r380539635", "bodyText": "Fixed", "author": "pvinokurov", "createdAt": "2020-02-18T09:09:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyMzA0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNTU1Ng==", "url": "https://github.com/gridgain/gridgain/pull/932#discussion_r380525556", "bodyText": "Why UNKNOWN_FUNCTION is used as a type for user aggregate functions?", "author": "AMashenkov", "createdAt": "2020-02-18T08:42:03Z", "path": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/sql/GridSqlQuerySplitter.java", "diffHunk": "@@ -1860,6 +1860,9 @@ private void splitAggregate(\n \n                 break;\n \n+            case UNKNOWN_FUNCTION:", "originalCommit": "b2920dcb3358b60d7fa1f5a2f79a3b83438e15d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU2MDgzOQ==", "url": "https://github.com/gridgain/gridgain/pull/932#discussion_r380560839", "bodyText": "UNKNOWN_FUNCTION is used for custom functions.\nThe idea is to use UNKNOWN_FUNCTION for all custom functions including aggregate.\n@tledkov-gridgain, Does it make sense?", "author": "pvinokurov", "createdAt": "2020-02-18T09:46:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNTU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU3NjA5Mg==", "url": "https://github.com/gridgain/gridgain/pull/932#discussion_r380576092", "bodyText": "Can this break non-aggregate functions?\nDo we have a test for non-collocated case using non-aggregate custom functions?", "author": "AMashenkov", "createdAt": "2020-02-18T10:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNTU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcxMjUzMA==", "url": "https://github.com/gridgain/gridgain/pull/932#discussion_r380712530", "bodyText": "It can't break non-aggregate functions since they don't participate in map/reduce scenario.", "author": "pvinokurov", "createdAt": "2020-02-18T14:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNTU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc4NzM2NQ==", "url": "https://github.com/gridgain/gridgain/pull/932#discussion_r380787365", "bodyText": "There is test IgniteCacheAbstractQuerySelfTest#testUserDefinedFunction for custom functions", "author": "pvinokurov", "createdAt": "2020-02-18T16:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNTU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNjI5Mw==", "url": "https://github.com/gridgain/gridgain/pull/932#discussion_r380526293", "bodyText": "Let's rename \"lists\" -> \"rows\"", "author": "AMashenkov", "createdAt": "2020-02-18T08:43:36Z", "path": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/IgniteSqlCustomAggregationTest.java", "diffHunk": "@@ -0,0 +1,348 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.query;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import java.util.stream.Collectors;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.cache.CacheMode;\n+import org.apache.ignite.cache.affinity.AffinityKeyMapped;\n+import org.apache.ignite.cache.query.SqlFieldsQuery;\n+import org.apache.ignite.cache.query.annotations.QuerySqlField;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.processors.cache.index.AbstractIndexingCommonTest;\n+import org.apache.ignite.internal.processors.query.h2.IgniteH2Indexing;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.h2.api.AggregateFunction;\n+import org.h2.jdbc.JdbcSQLSyntaxErrorException;\n+import org.junit.Test;\n+\n+/**\n+ * Tests for registration custom aggregation functions.\n+ */\n+public class IgniteSqlCustomAggregationTest extends AbstractIndexingCommonTest {\n+    /** */\n+    private static final String CACHE_NAME = \"cache\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        CacheConfiguration<PersonKey, Person> cacheCfg = new CacheConfiguration<PersonKey, Person>(CACHE_NAME)\n+            .setIndexedTypes(PersonKey.class, Person.class)\n+            .setCacheMode(CacheMode.PARTITIONED)\n+            .setBackups(0);\n+\n+        cfg.setCacheConfiguration(cacheCfg);\n+\n+        return cfg;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        super.beforeTest();\n+\n+        startGrids(3);\n+        startClientGrid(3);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        super.afterTest();\n+\n+        stopAllGrids(false);\n+    }\n+\n+    /**\n+     * @throws Exception If error.\n+     */\n+    @Test\n+    public void testAggregateFunctionsCollocated() throws Exception {\n+        IgniteEx ignite = grid(3);\n+\n+        IgniteCache<PersonKey, Person> cache = ignite.cache(CACHE_NAME);\n+\n+        loadCacheWithoutNullValues(cache);\n+\n+        List<List<?>> lists = cache.query(new SqlFieldsQuery(", "originalCommit": "b2920dcb3358b60d7fa1f5a2f79a3b83438e15d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5aeef82ab41b385fc90d1fbaf73fdaecda105c49", "url": "https://github.com/gridgain/gridgain/commit/5aeef82ab41b385fc90d1fbaf73fdaecda105c49", "message": "GG-23822 review fixes", "committedDate": "2020-02-18T09:47:46Z", "type": "commit"}, {"oid": "e0a938bf755c8736bcf76fa68fb6e3fb42fe0b68", "url": "https://github.com/gridgain/gridgain/commit/e0a938bf755c8736bcf76fa68fb6e3fb42fe0b68", "message": "GG-23822 Review fixes", "committedDate": "2020-03-03T04:35:08Z", "type": "commit"}]}