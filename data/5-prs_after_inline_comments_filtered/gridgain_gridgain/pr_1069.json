{"pr_number": 1069, "pr_title": "GG-14830", "pr_createdAt": "2020-04-14T15:32:55Z", "pr_url": "https://github.com/gridgain/gridgain/pull/1069", "timeline": [{"oid": "75414682c396cccf9c360c8a3f58a4392f0fc735", "url": "https://github.com/gridgain/gridgain/commit/75414682c396cccf9c360c8a3f58a4392f0fc735", "message": "GG-14830\n - Add test for checking that temporary checkpoint files are getting deleted on startup", "committedDate": "2020-04-14T15:27:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1NDg2OA==", "url": "https://github.com/gridgain/gridgain/pull/1069#discussion_r410254868", "bodyText": "Do you really need this setting?", "author": "alievmirza", "createdAt": "2020-04-17T14:19:56Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/checkpoint/CheckpointTempFilesCleanupOnStartupTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.db.checkpoint;\n+\n+import java.io.File;\n+import java.util.UUID;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.events.EventType;\n+import org.apache.ignite.failure.StopNodeFailureHandler;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.processors.cache.persistence.file.FilePageStoreManager.DFLT_STORE_DIR;\n+\n+/**\n+ *\n+ */\n+public class CheckpointTempFilesCleanupOnStartupTest extends GridCommonAbstractTest {\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        super.beforeTest();\n+\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+\n+        super.afterTest();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setConsistentId(igniteInstanceName);\n+\n+        DataStorageConfiguration storageCfg = new DataStorageConfiguration();\n+\n+        storageCfg.getDefaultDataRegionConfiguration()\n+            .setPersistenceEnabled(true);\n+\n+        cfg.setDataStorageConfiguration(storageCfg);\n+\n+        cfg.setFailureHandler(new StopNodeFailureHandler());", "originalCommit": "75414682c396cccf9c360c8a3f58a4392f0fc735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1NDkxMQ==", "url": "https://github.com/gridgain/gridgain/pull/1069#discussion_r410254911", "bodyText": "Please add comment that describes the test", "author": "alievmirza", "createdAt": "2020-04-17T14:19:59Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/checkpoint/CheckpointTempFilesCleanupOnStartupTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.db.checkpoint;\n+\n+import java.io.File;\n+import java.util.UUID;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.events.EventType;\n+import org.apache.ignite.failure.StopNodeFailureHandler;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.processors.cache.persistence.file.FilePageStoreManager.DFLT_STORE_DIR;\n+\n+/**\n+ *", "originalCommit": "75414682c396cccf9c360c8a3f58a4392f0fc735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1NTI4Mg==", "url": "https://github.com/gridgain/gridgain/pull/1069#discussion_r410255282", "bodyText": "The same as previous, do you really need this setting?", "author": "alievmirza", "createdAt": "2020-04-17T14:20:29Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/checkpoint/CheckpointTempFilesCleanupOnStartupTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.db.checkpoint;\n+\n+import java.io.File;\n+import java.util.UUID;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.events.EventType;\n+import org.apache.ignite.failure.StopNodeFailureHandler;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.processors.cache.persistence.file.FilePageStoreManager.DFLT_STORE_DIR;\n+\n+/**\n+ *\n+ */\n+public class CheckpointTempFilesCleanupOnStartupTest extends GridCommonAbstractTest {\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        super.beforeTest();\n+\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+\n+        super.afterTest();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setConsistentId(igniteInstanceName);\n+\n+        DataStorageConfiguration storageCfg = new DataStorageConfiguration();\n+\n+        storageCfg.getDefaultDataRegionConfiguration()\n+            .setPersistenceEnabled(true);\n+\n+        cfg.setDataStorageConfiguration(storageCfg);\n+\n+        cfg.setFailureHandler(new StopNodeFailureHandler());\n+\n+        cfg.setIncludeEventTypes(EventType.EVTS_ALL);", "originalCommit": "75414682c396cccf9c360c8a3f58a4392f0fc735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1NTg5NA==", "url": "https://github.com/gridgain/gridgain/pull/1069#discussion_r410255894", "bodyText": "missed space after comma", "author": "alievmirza", "createdAt": "2020-04-17T14:21:27Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/checkpoint/CheckpointTempFilesCleanupOnStartupTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.db.checkpoint;\n+\n+import java.io.File;\n+import java.util.UUID;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.events.EventType;\n+import org.apache.ignite.failure.StopNodeFailureHandler;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.processors.cache.persistence.file.FilePageStoreManager.DFLT_STORE_DIR;\n+\n+/**\n+ *\n+ */\n+public class CheckpointTempFilesCleanupOnStartupTest extends GridCommonAbstractTest {\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        super.beforeTest();\n+\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+\n+        super.afterTest();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setConsistentId(igniteInstanceName);\n+\n+        DataStorageConfiguration storageCfg = new DataStorageConfiguration();\n+\n+        storageCfg.getDefaultDataRegionConfiguration()\n+            .setPersistenceEnabled(true);\n+\n+        cfg.setDataStorageConfiguration(storageCfg);\n+\n+        cfg.setFailureHandler(new StopNodeFailureHandler());\n+\n+        cfg.setIncludeEventTypes(EventType.EVTS_ALL);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Test that tmp checkpoints are getting deleted on startup\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testRestartWithTmpCheckpoint() throws Exception {\n+        File dbDir = U.resolveWorkDirectory(U.defaultWorkDirectory(), DFLT_STORE_DIR, false);\n+\n+        String nodeId = UUID.randomUUID().toString();\n+\n+        File nodeDir = new File(new File(dbDir.getAbsolutePath(),U.maskForFileName(nodeId)), \"cp\");", "originalCommit": "75414682c396cccf9c360c8a3f58a4392f0fc735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2Mzc4NQ==", "url": "https://github.com/gridgain/gridgain/pull/1069#discussion_r410263785", "bodyText": "Where did this filename come from? Is this just a random name?", "author": "alievmirza", "createdAt": "2020-04-17T14:33:23Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/checkpoint/CheckpointTempFilesCleanupOnStartupTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.db.checkpoint;\n+\n+import java.io.File;\n+import java.util.UUID;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.events.EventType;\n+import org.apache.ignite.failure.StopNodeFailureHandler;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.processors.cache.persistence.file.FilePageStoreManager.DFLT_STORE_DIR;\n+\n+/**\n+ *\n+ */\n+public class CheckpointTempFilesCleanupOnStartupTest extends GridCommonAbstractTest {\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        super.beforeTest();\n+\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+\n+        super.afterTest();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setConsistentId(igniteInstanceName);\n+\n+        DataStorageConfiguration storageCfg = new DataStorageConfiguration();\n+\n+        storageCfg.getDefaultDataRegionConfiguration()\n+            .setPersistenceEnabled(true);\n+\n+        cfg.setDataStorageConfiguration(storageCfg);\n+\n+        cfg.setFailureHandler(new StopNodeFailureHandler());\n+\n+        cfg.setIncludeEventTypes(EventType.EVTS_ALL);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Test that tmp checkpoints are getting deleted on startup\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testRestartWithTmpCheckpoint() throws Exception {\n+        File dbDir = U.resolveWorkDirectory(U.defaultWorkDirectory(), DFLT_STORE_DIR, false);\n+\n+        String nodeId = UUID.randomUUID().toString();\n+\n+        File nodeDir = new File(new File(dbDir.getAbsolutePath(),U.maskForFileName(nodeId)), \"cp\");\n+\n+        nodeDir.mkdirs();\n+\n+        File tmpFileLeftAfterCrash = new File(nodeDir, \"1586870171036-d346c814-aa03-4d66-bf1e-2951a04268f9-END.bin.tmp\");", "originalCommit": "75414682c396cccf9c360c8a3f58a4392f0fc735", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI4OTM2Nw==", "url": "https://github.com/gridgain/gridgain/pull/1069#discussion_r410289367", "bodyText": "The filename came from the issue's stacktrace and has no real meaning", "author": "SammyVimes", "createdAt": "2020-04-17T15:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2Mzc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2NTY2Nw==", "url": "https://github.com/gridgain/gridgain/pull/1069#discussion_r410265667", "bodyText": "Remove redundant empty line.", "author": "alievmirza", "createdAt": "2020-04-17T14:36:21Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/checkpoint/CheckpointTempFilesCleanupOnStartupTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.db.checkpoint;\n+\n+import java.io.File;\n+import java.util.UUID;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.events.EventType;\n+import org.apache.ignite.failure.StopNodeFailureHandler;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.processors.cache.persistence.file.FilePageStoreManager.DFLT_STORE_DIR;\n+", "originalCommit": "75414682c396cccf9c360c8a3f58a4392f0fc735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "419f2e47e7bb889c6f26363f31ca7c9a9a77c9ee", "url": "https://github.com/gridgain/gridgain/commit/419f2e47e7bb889c6f26363f31ca7c9a9a77c9ee", "message": " - fix review issues", "committedDate": "2020-04-17T15:15:46Z", "type": "commit"}, {"oid": "ef3a8d242f9e5a748657f32cb00c1632c97c5ca1", "url": "https://github.com/gridgain/gridgain/commit/ef3a8d242f9e5a748657f32cb00c1632c97c5ca1", "message": " - fix review issues", "committedDate": "2020-04-17T16:18:10Z", "type": "commit"}]}