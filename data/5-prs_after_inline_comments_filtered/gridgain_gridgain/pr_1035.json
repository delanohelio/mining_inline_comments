{"pr_number": 1035, "pr_title": "GG-28445 .NET: Use platform Near Cache for local ScanQuery", "pr_createdAt": "2020-04-06T20:03:37Z", "pr_url": "https://github.com/gridgain/gridgain/pull/1035", "timeline": [{"oid": "1b1ddfa67285fe2a6daa18d278d0b27c31a636a5", "url": "https://github.com/gridgain/gridgain/commit/1b1ddfa67285fe2a6daa18d278d0b27c31a636a5", "message": "Implementing near query cursor", "committedDate": "2020-04-04T21:02:38Z", "type": "commit"}, {"oid": "d256f9a4b5593fec2b8843452c60bd510d60f4dd", "url": "https://github.com/gridgain/gridgain/commit/d256f9a4b5593fec2b8843452c60bd510d60f4dd", "message": "Implementing near query cursor", "committedDate": "2020-04-04T21:10:15Z", "type": "commit"}, {"oid": "67837eb854f57284ea5bba22cc162d05b908c9db", "url": "https://github.com/gridgain/gridgain/commit/67837eb854f57284ea5bba22cc162d05b908c9db", "message": "Implementing near query cursor", "committedDate": "2020-04-04T21:17:45Z", "type": "commit"}, {"oid": "2a83025d0345643498cb219067813751dbc699a1", "url": "https://github.com/gridgain/gridgain/commit/2a83025d0345643498cb219067813751dbc699a1", "message": "Add partition reservation", "committedDate": "2020-04-04T21:40:50Z", "type": "commit"}, {"oid": "d88b331144b4ddb977eb83110c3502c1ad290298", "url": "https://github.com/gridgain/gridgain/commit/d88b331144b4ddb977eb83110c3502c1ad290298", "message": "Merge remote-tracking branch 'ggce/8.7-master' into gg-28445\n\n# Conflicts:\n#\tmodules/core/src/main/java/org/apache/ignite/internal/processors/platform/cache/PlatformCache.java", "committedDate": "2020-04-05T15:20:41Z", "type": "commit"}, {"oid": "5a0df704d10681903dab62201933209975fc1a03", "url": "https://github.com/gridgain/gridgain/commit/5a0df704d10681903dab62201933209975fc1a03", "message": "Partition reservation", "committedDate": "2020-04-05T15:27:34Z", "type": "commit"}, {"oid": "693cec46e22f62ca1707f1538e7ea7a20ddc25af", "url": "https://github.com/gridgain/gridgain/commit/693cec46e22f62ca1707f1538e7ea7a20ddc25af", "message": "ScanNear implemented", "committedDate": "2020-04-05T15:30:22Z", "type": "commit"}, {"oid": "ec3074423c26dd42172082b8ab3da9125d68f328", "url": "https://github.com/gridgain/gridgain/commit/ec3074423c26dd42172082b8ab3da9125d68f328", "message": "Refactor dispose logic", "committedDate": "2020-04-05T16:43:27Z", "type": "commit"}, {"oid": "e2423b0b5cd2402256881136e418c9296196fd30", "url": "https://github.com/gridgain/gridgain/commit/e2423b0b5cd2402256881136e418c9296196fd30", "message": "Refactor dispose logic", "committedDate": "2020-04-05T17:14:10Z", "type": "commit"}, {"oid": "877ed28b472d8eed2b5232dde813f82ce4e7cdca", "url": "https://github.com/gridgain/gridgain/commit/877ed28b472d8eed2b5232dde813f82ce4e7cdca", "message": "Refactor dispose logic", "committedDate": "2020-04-05T17:15:49Z", "type": "commit"}, {"oid": "062b26f6c7930a0249973abce625dd05b5cb8c05", "url": "https://github.com/gridgain/gridgain/commit/062b26f6c7930a0249973abce625dd05b5cb8c05", "message": "Fix tests", "committedDate": "2020-04-05T17:17:07Z", "type": "commit"}, {"oid": "82b417540a97e6a6e648052e03b5bbb0afdc0ede", "url": "https://github.com/gridgain/gridgain/commit/82b417540a97e6a6e648052e03b5bbb0afdc0ede", "message": "Adding tests", "committedDate": "2020-04-05T18:50:39Z", "type": "commit"}, {"oid": "cca067a9a45a37c0e24e5f9117a2fa5ca9c7ed52", "url": "https://github.com/gridgain/gridgain/commit/cca067a9a45a37c0e24e5f9117a2fa5ca9c7ed52", "message": "Adding tests", "committedDate": "2020-04-05T19:03:40Z", "type": "commit"}, {"oid": "859efdd8c44d413fcddcc902633e19151e432da3", "url": "https://github.com/gridgain/gridgain/commit/859efdd8c44d413fcddcc902633e19151e432da3", "message": "Adding tests", "committedDate": "2020-04-05T19:16:26Z", "type": "commit"}, {"oid": "b82e39aff74b82db5ed31601396e9dece80fbaec", "url": "https://github.com/gridgain/gridgain/commit/b82e39aff74b82db5ed31601396e9dece80fbaec", "message": "Adding tests", "committedDate": "2020-04-05T19:17:33Z", "type": "commit"}, {"oid": "bc805188096c9984a70eb82b92eb0a1688ba2bc4", "url": "https://github.com/gridgain/gridgain/commit/bc805188096c9984a70eb82b92eb0a1688ba2bc4", "message": "cleanup", "committedDate": "2020-04-06T09:39:27Z", "type": "commit"}, {"oid": "2ca044945762542248021953f78bc9b8ce1dbaae", "url": "https://github.com/gridgain/gridgain/commit/2ca044945762542248021953f78bc9b8ce1dbaae", "message": "Add TestLocalScanQueryWithTypeMismatchUsesKeysAndValuesFromNearCache", "committedDate": "2020-04-06T09:44:47Z", "type": "commit"}, {"oid": "418388584be5d2c47f6665efbfc140f724c6d5ce", "url": "https://github.com/gridgain/gridgain/commit/418388584be5d2c47f6665efbfc140f724c6d5ce", "message": "cleanup", "committedDate": "2020-04-06T09:48:15Z", "type": "commit"}, {"oid": "566fc1676d55c13994e3673f19b04c0e96e13512", "url": "https://github.com/gridgain/gridgain/commit/566fc1676d55c13994e3673f19b04c0e96e13512", "message": "cleanup", "committedDate": "2020-04-06T10:12:48Z", "type": "commit"}, {"oid": "4e898d03b3eb05f4bbdcabbb76fcbffcbacf7579", "url": "https://github.com/gridgain/gridgain/commit/4e898d03b3eb05f4bbdcabbb76fcbffcbacf7579", "message": "Add TestLocalScanQueryFromClientNode", "committedDate": "2020-04-06T10:23:58Z", "type": "commit"}, {"oid": "5fd90150b5238537896ac76c0a7598d3524d2a14", "url": "https://github.com/gridgain/gridgain/commit/5fd90150b5238537896ac76c0a7598d3524d2a14", "message": "Add PlatformIsPartitionReservedTask", "committedDate": "2020-04-06T15:15:05Z", "type": "commit"}, {"oid": "636150165b47f3c249cb5f2af7848824d691538e", "url": "https://github.com/gridgain/gridgain/commit/636150165b47f3c249cb5f2af7848824d691538e", "message": "Add TestLocalScanQueryWithPartitionReservesPartitionAndReleasesItOnDispose", "committedDate": "2020-04-06T15:34:14Z", "type": "commit"}, {"oid": "9fb1ff2d3376f94feba06aedd1291a280aecdbc4", "url": "https://github.com/gridgain/gridgain/commit/9fb1ff2d3376f94feba06aedd1291a280aecdbc4", "message": "Fix TestLocalScanQueryWithPartitionReservesPartitionAndReleasesItOnDispose", "committedDate": "2020-04-06T15:57:43Z", "type": "commit"}, {"oid": "d3c445a43db7d40857c7901d918d4d07d09b5b4c", "url": "https://github.com/gridgain/gridgain/commit/d3c445a43db7d40857c7901d918d4d07d09b5b4c", "message": "TODOs", "committedDate": "2020-04-06T15:58:36Z", "type": "commit"}, {"oid": "e8ed8bf3e1e9c0f400819c4e1867b7cef02827f0", "url": "https://github.com/gridgain/gridgain/commit/e8ed8bf3e1e9c0f400819c4e1867b7cef02827f0", "message": "Cleanup", "committedDate": "2020-04-06T18:53:05Z", "type": "commit"}, {"oid": "9f94570280aca553c7e3e8c13864e676651b64b1", "url": "https://github.com/gridgain/gridgain/commit/9f94570280aca553c7e3e8c13864e676651b64b1", "message": "Improve XMLDoc", "committedDate": "2020-04-06T19:17:11Z", "type": "commit"}, {"oid": "64ef130905819f819272b5d4b8e7bab5aeb4e1bf", "url": "https://github.com/gridgain/gridgain/commit/64ef130905819f819272b5d4b8e7bab5aeb4e1bf", "message": "cleanup", "committedDate": "2020-04-06T19:22:23Z", "type": "commit"}, {"oid": "441055e22550e98cedbcdd1939e5426fae0632e0", "url": "https://github.com/gridgain/gridgain/commit/441055e22550e98cedbcdd1939e5426fae0632e0", "message": "Fix xmldoc", "committedDate": "2020-04-06T19:28:48Z", "type": "commit"}, {"oid": "67836ff607ead363552e1695fedb7d4ed3b26c36", "url": "https://github.com/gridgain/gridgain/commit/67836ff607ead363552e1695fedb7d4ed3b26c36", "message": "Adding tests", "committedDate": "2020-04-06T19:39:25Z", "type": "commit"}, {"oid": "76d395395d78803f4663fb4df72aec969e946476", "url": "https://github.com/gridgain/gridgain/commit/76d395395d78803f4663fb4df72aec969e946476", "message": "Adding tests", "committedDate": "2020-04-06T19:41:19Z", "type": "commit"}, {"oid": "577fe61ab258bb4e9f778ee2372c4d886b82bc33", "url": "https://github.com/gridgain/gridgain/commit/577fe61ab258bb4e9f778ee2372c4d886b82bc33", "message": "Fix csproj", "committedDate": "2020-04-06T19:42:53Z", "type": "commit"}, {"oid": "fa1342579bf16dc98d4e2ec4a87bda492f4c04f6", "url": "https://github.com/gridgain/gridgain/commit/fa1342579bf16dc98d4e2ec4a87bda492f4c04f6", "message": "Add partition validation and TestLocalScanQueryWithInvalidPartitionId", "committedDate": "2020-04-06T19:50:35Z", "type": "commit"}, {"oid": "106e4b72a22625498ea076bb83800341033e1d4a", "url": "https://github.com/gridgain/gridgain/commit/106e4b72a22625498ea076bb83800341033e1d4a", "message": "Tests done", "committedDate": "2020-04-06T19:55:18Z", "type": "commit"}, {"oid": "75a39e09ab45fdfbc17cf4bd1dc59843300b2d6c", "url": "https://github.com/gridgain/gridgain/commit/75a39e09ab45fdfbc17cf4bd1dc59843300b2d6c", "message": "cleanup", "committedDate": "2020-04-06T19:56:24Z", "type": "commit"}, {"oid": "0398b53c40c152cf81f8a802ad5d6f5f1b70b5f1", "url": "https://github.com/gridgain/gridgain/commit/0398b53c40c152cf81f8a802ad5d6f5f1b70b5f1", "message": "cleanup", "committedDate": "2020-04-06T20:05:36Z", "type": "commit"}, {"oid": "afbb7be3c6170eda643045dd13dc30b9086062c8", "url": "https://github.com/gridgain/gridgain/commit/afbb7be3c6170eda643045dd13dc30b9086062c8", "message": "cleanup", "committedDate": "2020-04-06T20:06:24Z", "type": "commit"}, {"oid": "53e2871cda4d5f72c10145bb304f966ec42195da", "url": "https://github.com/gridgain/gridgain/commit/53e2871cda4d5f72c10145bb304f966ec42195da", "message": "cleanup", "committedDate": "2020-04-06T20:07:49Z", "type": "commit"}, {"oid": "ffcdf733c6b1585b31fc322f56d44a816ef7a59f", "url": "https://github.com/gridgain/gridgain/commit/ffcdf733c6b1585b31fc322f56d44a816ef7a59f", "message": "Restrict local scan optimization: enable only when Partition is specified", "committedDate": "2020-04-08T12:31:32Z", "type": "commit"}, {"oid": "6a4b7c5dd3db7c6463f7d58d04d3fe35f8ba1bde", "url": "https://github.com/gridgain/gridgain/commit/6a4b7c5dd3db7c6463f7d58d04d3fe35f8ba1bde", "message": "fix tests", "committedDate": "2020-04-08T12:34:20Z", "type": "commit"}, {"oid": "55cfdb90ce4703a1cd2fa3b70cbb8e19e217f736", "url": "https://github.com/gridgain/gridgain/commit/55cfdb90ce4703a1cd2fa3b70cbb8e19e217f736", "message": "cleanup", "committedDate": "2020-04-08T12:34:51Z", "type": "commit"}, {"oid": "3fc15b2a033fa2a074fc7cb639baae69a18c0732", "url": "https://github.com/gridgain/gridgain/commit/3fc15b2a033fa2a074fc7cb639baae69a18c0732", "message": "Merge remote-tracking branch 'ggce/8.7-master' into gg-28445", "committedDate": "2020-04-08T12:55:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUyMjU1OA==", "url": "https://github.com/gridgain/gridgain/pull/1035#discussion_r405522558", "bodyText": "This could actually happen if cache was just created and it has no partition for a ready topology version. I've got such exception when dealt with Partition Awareness. Need to handle properly without assertion. Also, I'm not sure, whether null is returned or exception is thrown in this case.", "author": "isapego", "createdAt": "2020-04-08T13:25:41Z", "path": "modules/core/src/test/java/org/apache/ignite/platform/PlatformIsPartitionReservedTask.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.platform;\n+\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.compute.ComputeJob;\n+import org.apache.ignite.compute.ComputeJobAdapter;\n+import org.apache.ignite.compute.ComputeJobResult;\n+import org.apache.ignite.compute.ComputeTaskAdapter;\n+import org.apache.ignite.internal.GridKernalContext;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.processors.cache.distributed.dht.topology.GridDhtLocalPartition;\n+import org.apache.ignite.internal.processors.cache.distributed.dht.topology.GridDhtPartitionTopology;\n+import org.apache.ignite.resources.IgniteInstanceResource;\n+import org.jetbrains.annotations.NotNull;\n+import org.jetbrains.annotations.Nullable;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Task to get Java thread names.\n+ */\n+public class PlatformIsPartitionReservedTask extends ComputeTaskAdapter<Object[], Boolean> {\n+    /** {@inheritDoc} */\n+    @NotNull @Override public Map<? extends ComputeJob, ClusterNode> map(List<ClusterNode> subgrid,\n+        @Nullable Object[] arg) {\n+        //noinspection OptionalGetWithoutIsPresent\n+        ClusterNode localNode = subgrid.stream().filter(ClusterNode::isLocal).findFirst().get();\n+\n+        return Collections.singletonMap(\n+                new PlatformIsPartitionReservedJob((String)arg[0], (Integer)arg[1]), localNode);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Nullable @Override public Boolean reduce(List<ComputeJobResult> results) {\n+        return results.get(0).getData();\n+    }\n+\n+    /**\n+     * Job.\n+     */\n+    private static class PlatformIsPartitionReservedJob extends ComputeJobAdapter {\n+        /** */\n+        private final String cacheName;\n+\n+        /** */\n+        private final int part;\n+\n+        /** */\n+        @SuppressWarnings(\"unused\")\n+        @IgniteInstanceResource\n+        private Ignite ignite;\n+\n+        /**\n+         * Constructor.\n+         *\n+         * @param cacheName Cache name.\n+         * @param part Partition.\n+         */\n+        public PlatformIsPartitionReservedJob(String cacheName, Integer part) {\n+            this.cacheName = cacheName;\n+            this.part = part;\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Nullable @Override public Boolean execute() {\n+            GridKernalContext ctx = ((IgniteEx) ignite).context();\n+\n+            GridDhtPartitionTopology top = ctx.cache().cache(cacheName).context().topology();\n+\n+            GridDhtLocalPartition locPart = top.localPartition(part, top.readyTopologyVersion(), false);\n+\n+            assert locPart != null;", "originalCommit": "3fc15b2a033fa2a074fc7cb639baae69a18c0732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5MDczMA==", "url": "https://github.com/gridgain/gridgain/pull/1035#discussion_r405690730", "bodyText": "Note that this is test code. Are you worried about flaky tests?", "author": "ptupitsyn", "createdAt": "2020-04-08T17:25:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUyMjU1OA=="}], "type": "inlineReview"}, {"oid": "95de31f6ab45f146696b74b263dbb2b7bada3b29", "url": "https://github.com/gridgain/gridgain/commit/95de31f6ab45f146696b74b263dbb2b7bada3b29", "message": "Cleanup", "committedDate": "2020-04-08T18:27:47Z", "type": "commit"}]}