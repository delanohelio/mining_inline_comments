{"pr_number": 1302, "pr_title": "GG-28800  [IGNITE-2890] .NET: Add CacheConfiguration.NodeFilter", "pr_createdAt": "2020-07-13T08:22:44Z", "pr_url": "https://github.com/gridgain/gridgain/pull/1302", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUzNzkxOA==", "url": "https://github.com/gridgain/gridgain/pull/1302#discussion_r453537918", "bodyText": "This id is already present in the base class", "author": "ptupitsyn", "createdAt": "2020-07-13T10:02:04Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/cluster/PlatformClusterNodeFilterImpl.java", "diffHunk": "@@ -29,10 +33,12 @@\n /**\n  * Interop cluster node filter.\n  */\n-public class PlatformClusterNodeFilterImpl extends PlatformAbstractPredicate implements PlatformClusterNodeFilter {\n+public class PlatformClusterNodeFilterImpl extends PlatformAbstractPredicate implements PlatformClusterNodeFilter, Binarylizable {\n     /** */\n     private static final long serialVersionUID = 0L;\n \n+    private int handleId = -1;", "originalCommit": "f7033f0f859801c46f23e8984cdac6d033c6a7c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUzODk5OA==", "url": "https://github.com/gridgain/gridgain/pull/1302#discussion_r453538998", "bodyText": "This likely breaks rolling upgrades compatibility, and I'm not sure if we need to override at all.", "author": "ptupitsyn", "createdAt": "2020-07-13T10:03:40Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/cluster/PlatformClusterNodeFilterImpl.java", "diffHunk": "@@ -80,4 +114,14 @@ public void setIgniteInstance(Ignite ignite) {\n     public Object getInternalPredicate() {\n         return pred;\n     }\n+\n+    @Override\n+    public void writeBinary(BinaryWriter writer) throws BinaryObjectException {", "originalCommit": "f7033f0f859801c46f23e8984cdac6d033c6a7c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzNzczMQ==", "url": "https://github.com/gridgain/gridgain/pull/1302#discussion_r453637731", "bodyText": "Unfortunately, the whole change is breaking RU and the C++ platform.\nI think this is kind of expected if you are dealing with cache configuration changes?", "author": "ashapkin", "createdAt": "2020-07-13T13:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUzODk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1MDc2Mg==", "url": "https://github.com/gridgain/gridgain/pull/1302#discussion_r453650762", "bodyText": "It is fine to say that \"if you use this new feature, RU will break\". But here we break RU for Service Node Filters, because we change the format.\nAnd this format change looks unnecessary to me, we can remove those overrides.", "author": "ptupitsyn", "createdAt": "2020-07-13T13:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUzODk5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUzOTI0Ng==", "url": "https://github.com/gridgain/gridgain/pull/1302#discussion_r453539246", "bodyText": "Can we call ctx.createClusterNodeFilter instead?", "author": "ptupitsyn", "createdAt": "2020-07-13T10:04:06Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/utils/PlatformConfigurationUtils.java", "diffHunk": "@@ -227,6 +231,16 @@ public static CacheConfiguration readCacheConfiguration(BinaryRawReaderEx in) {\n         ccfg.setAffinity(readAffinityFunction(in));\n         ccfg.setExpiryPolicyFactory(readExpiryPolicyFactory(in));\n \n+        if (in.readBoolean())\n+            ccfg.setNodeFilter(readAttributeNodeFilter(in));\n+        else {\n+            Object nativeFilter = in.readObjectDetached();\n+            if (nativeFilter != null) {\n+                PlatformClusterNodeFilterImpl filter = new PlatformClusterNodeFilterImpl(nativeFilter, ctx);", "originalCommit": "f7033f0f859801c46f23e8984cdac6d033c6a7c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU0MDQ0MQ==", "url": "https://github.com/gridgain/gridgain/pull/1302#discussion_r453540441", "bodyText": "We should throw a descriptive exception instead. Using .NET node filter in mixed cluster is not supported. Silently ignoring this will lead to unexpected behavior.", "author": "ptupitsyn", "createdAt": "2020-07-13T10:06:09Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/cluster/PlatformClusterNodeFilterImpl.java", "diffHunk": "@@ -48,21 +54,49 @@ public PlatformClusterNodeFilterImpl() {\n      */\n     public PlatformClusterNodeFilterImpl(Object pred, PlatformContext ctx) {\n         super(pred, 0, ctx);\n+\n+        init();\n     }\n \n-    /** {@inheritDoc} */\n-    @Override public boolean apply(ClusterNode clusterNode) {\n+    /* Initializes the cluster node filter */\n+    public void init(){\n         try (PlatformMemory mem = ctx.memory().allocate()) {\n             PlatformOutputStream out = mem.output();\n \n             BinaryRawWriterEx writer = ctx.writer(out);\n \n             writer.writeObject(pred);\n+            out.synchronize();\n+\n+            handleId = ctx.gateway().clusterNodeFilterCreate(mem.pointer());\n+        }\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public boolean apply(ClusterNode clusterNode)  {\n+\n+        if(ctx == null){\n+            return false;", "originalCommit": "f7033f0f859801c46f23e8984cdac6d033c6a7c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "322f31708e93995804b0dd28594181078c0c12ff", "url": "https://github.com/gridgain/gridgain/commit/322f31708e93995804b0dd28594181078c0c12ff", "message": "AttibuteNodeFilter implementation", "committedDate": "2020-08-23T22:38:19Z", "type": "commit"}, {"oid": "322f31708e93995804b0dd28594181078c0c12ff", "url": "https://github.com/gridgain/gridgain/commit/322f31708e93995804b0dd28594181078c0c12ff", "message": "AttibuteNodeFilter implementation", "committedDate": "2020-08-23T22:38:19Z", "type": "forcePushed"}, {"oid": "7fb17f7ff77169471a8e76a90dc57764f2bb68f9", "url": "https://github.com/gridgain/gridgain/commit/7fb17f7ff77169471a8e76a90dc57764f2bb68f9", "message": "Xsd", "committedDate": "2020-08-23T23:54:53Z", "type": "commit"}, {"oid": "61af126dae78e0aa6d84d607584ebb51d094bdd6", "url": "https://github.com/gridgain/gridgain/commit/61af126dae78e0aa6d84d607584ebb51d094bdd6", "message": "Fixes", "committedDate": "2020-09-20T17:18:21Z", "type": "commit"}, {"oid": "b5641b30e74c1fd1d6fd720038ac7e5ce9f983f8", "url": "https://github.com/gridgain/gridgain/commit/b5641b30e74c1fd1d6fd720038ac7e5ce9f983f8", "message": "Merge remote-tracking branch 'gridgain-ce/master' into gg-28800", "committedDate": "2020-09-20T17:34:40Z", "type": "commit"}, {"oid": "42c93b5bc5f79e74cf30e7e8e91e15ab8cbe2c83", "url": "https://github.com/gridgain/gridgain/commit/42c93b5bc5f79e74cf30e7e8e91e15ab8cbe2c83", "message": "TC fixes", "committedDate": "2020-09-23T22:43:40Z", "type": "commit"}, {"oid": "51c80cd9bd310089df30c707aa1c05df949c75d3", "url": "https://github.com/gridgain/gridgain/commit/51c80cd9bd310089df30c707aa1c05df949c75d3", "message": "Fix line separator", "committedDate": "2020-09-24T09:14:17Z", "type": "commit"}, {"oid": "3f279bd1a7cb1075c268794bb5bc559dcdaa9704", "url": "https://github.com/gridgain/gridgain/commit/3f279bd1a7cb1075c268794bb5bc559dcdaa9704", "message": "Fix tests", "committedDate": "2020-09-24T11:24:51Z", "type": "commit"}, {"oid": "8c334080f5833d720d5ba74a6cfc85ef8e5cad79", "url": "https://github.com/gridgain/gridgain/commit/8c334080f5833d720d5ba74a6cfc85ef8e5cad79", "message": "Fix xml docs", "committedDate": "2020-10-07T16:38:10Z", "type": "commit"}, {"oid": "a420f635a2e258c2c01daa2fe0b962f3cd760b1b", "url": "https://github.com/gridgain/gridgain/commit/a420f635a2e258c2c01daa2fe0b962f3cd760b1b", "message": "Merge remote-tracking branch 'gridgain-ce/master' into gg-28800", "committedDate": "2020-10-08T10:39:43Z", "type": "commit"}, {"oid": "e0e3cc07a2e99f5239047bac12e7df1e806cd96f", "url": "https://github.com/gridgain/gridgain/commit/e0e3cc07a2e99f5239047bac12e7df1e806cd96f", "message": "Merge remote-tracking branch 'gridgain-ce/master' into gg-28800", "committedDate": "2020-10-08T20:37:19Z", "type": "commit"}]}