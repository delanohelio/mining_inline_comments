{"pr_number": 5036, "pr_title": "[TL] Persist Schema Version in Sqlite", "pr_createdAt": "2020-10-15T13:07:34Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5036", "timeline": [{"oid": "2d858022a5e40c0c771ca8619a17b4f3c2188aea", "url": "https://github.com/palantir/atlasdb/commit/2d858022a5e40c0c771ca8619a17b4f3c2188aea", "message": "Persist timelock schema version", "committedDate": "2020-10-15T12:48:15Z", "type": "commit"}, {"oid": "f3a611ebd581f96399aa72f48b7d9feb3ac63dfa", "url": "https://github.com/palantir/atlasdb/commit/f3a611ebd581f96399aa72f48b7d9feb3ac63dfa", "message": "they see me rollin", "committedDate": "2020-10-15T12:53:59Z", "type": "commit"}, {"oid": "6ebdf110b9e5bd078174640be10960ae63ddd7ef", "url": "https://github.com/palantir/atlasdb/commit/6ebdf110b9e5bd078174640be10960ae63ddd7ef", "message": "add warning", "committedDate": "2020-10-15T13:06:20Z", "type": "commit"}, {"oid": "ad885a55fa34d00d305cd25142eb8305d1b58da5", "url": "https://github.com/palantir/atlasdb/commit/ad885a55fa34d00d305cd25142eb8305d1b58da5", "message": "Add generated changelog entries", "committedDate": "2020-10-15T13:06:20Z", "type": "commit"}, {"oid": "aa5790d92fee4be5e821c57482c0a7e5fd3f340b", "url": "https://github.com/palantir/atlasdb/commit/aa5790d92fee4be5e821c57482c0a7e5fd3f340b", "message": "Throw if schema version mismatch", "committedDate": "2020-10-16T10:45:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU0OTAxNg==", "url": "https://github.com/palantir/atlasdb/pull/5036#discussion_r508549016", "bodyText": "Doesn't this need to be before all the setting up of PaxosResources etc.? Isn't this currently where the migration happens?", "author": "jkozlowski", "createdAt": "2020-10-20T14:18:21Z", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java", "diffHunk": "@@ -124,6 +126,13 @@ public static TimeLockAgent create(MetricsManager metricsManager,\n                 metricsManager,\n                 Suppliers.compose(TimeLockRuntimeConfiguration::paxos, runtime::get));\n \n+        // Upgrading the schema version should generally happen AFTER any migration has finished running. Keep this in\n+        // mind for any potential live migrations\n+        PersistedSchemaVersion persistedSchemaVersion = PersistedSchemaVersion\n+                .create(installationContext.sqliteDataSource());\n+        persistedSchemaVersion.upgradeVersion(SCHEMA_VERSION);\n+        verifySchemaVersion(persistedSchemaVersion);", "originalCommit": "aa5790d92fee4be5e821c57482c0a7e5fd3f340b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "676459b4d31f393e1b8239d2652c161f6e58305d", "url": "https://github.com/palantir/atlasdb/commit/676459b4d31f393e1b8239d2652c161f6e58305d", "message": "Merge with develop, move the check to before the migration", "committedDate": "2020-10-21T13:21:51Z", "type": "commit"}, {"oid": "702462ffd3733f401b9b576c007f2fc5be1b0080", "url": "https://github.com/palantir/atlasdb/commit/702462ffd3733f401b9b576c007f2fc5be1b0080", "message": "spotless", "committedDate": "2020-10-21T14:10:11Z", "type": "commit"}]}