{"pr_number": 4853, "pr_title": "Error rates", "pr_createdAt": "2020-06-22T18:42:45Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4853", "timeline": [{"oid": "aee9118c70dd19e938e28b6f3e866dd7c110aab4", "url": "https://github.com/palantir/atlasdb/commit/aee9118c70dd19e938e28b6f3e866dd7c110aab4", "message": "commit rough work", "committedDate": "2020-06-22T18:17:07Z", "type": "commit"}, {"oid": "b5c65807d030e23738aeda96b240db4de8f5015a", "url": "https://github.com/palantir/atlasdb/commit/b5c65807d030e23738aeda96b240db4de8f5015a", "message": "scheme update to record errors", "committedDate": "2020-06-22T18:25:19Z", "type": "commit"}, {"oid": "160cbe84df7fffe3e5b07616aef3ed4fd00c52f4", "url": "https://github.com/palantir/atlasdb/commit/160cbe84df7fffe3e5b07616aef3ed4fd00c52f4", "message": "record errors", "committedDate": "2020-06-22T18:27:24Z", "type": "commit"}, {"oid": "ae8c0bca543dd54a72d543a7811b2f08b027dbf4", "url": "https://github.com/palantir/atlasdb/commit/ae8c0bca543dd54a72d543a7811b2f08b027dbf4", "message": "typo", "committedDate": "2020-06-22T18:28:15Z", "type": "commit"}, {"oid": "4e1a907cac52b46869f1ee06857164e231b07be8", "url": "https://github.com/palantir/atlasdb/commit/4e1a907cac52b46869f1ee06857164e231b07be8", "message": "Update conjureTimeLockFeedback model", "committedDate": "2020-06-22T18:35:24Z", "type": "commit"}, {"oid": "67c5e7996a118c61f15e8a11f7ab107ff7888dd6", "url": "https://github.com/palantir/atlasdb/commit/67c5e7996a118c61f15e8a11f7ab107ff7888dd6", "message": "tests", "committedDate": "2020-06-22T20:06:15Z", "type": "commit"}, {"oid": "cb28671d18c01c914046cb5759883848b14f8e26", "url": "https://github.com/palantir/atlasdb/commit/cb28671d18c01c914046cb5759883848b14f8e26", "message": "indent", "committedDate": "2020-06-22T20:12:20Z", "type": "commit"}, {"oid": "17fed0c4f71c8a8b07c095def8b97dfe522f8529", "url": "https://github.com/palantir/atlasdb/commit/17fed0c4f71c8a8b07c095def8b97dfe522f8529", "message": "Address comment", "committedDate": "2020-06-23T10:20:55Z", "type": "commit"}, {"oid": "0c604ca9f9b991efc319eef739d7eff588061bbe", "url": "https://github.com/palantir/atlasdb/commit/0c604ca9f9b991efc319eef739d7eff588061bbe", "message": "Modify tests", "committedDate": "2020-06-23T10:27:30Z", "type": "commit"}, {"oid": "2c4d9bac8909035d52618361ab44e08954727c27", "url": "https://github.com/palantir/atlasdb/commit/2c4d9bac8909035d52618361ab44e08954727c27", "message": "Update product dependency", "committedDate": "2020-06-23T10:43:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNjgzNw==", "url": "https://github.com/palantir/atlasdb/pull/4853#discussion_r444136837", "bodyText": "nit - Missed this in round 1: I'd suggest verifying that the exception thrown by the timelock service is the exception that's also thrown out of the Dialogue adapting service.", "author": "jeremyk-91", "createdAt": "2020-06-23T10:54:32Z", "path": "timelock-impl/src/test/java/com/palantir/atlasdb/timelock/adjudicate/FeedbackMetricsTest.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.adjudicate;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mock;\n+\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockServiceBlocking;\n+import com.palantir.atlasdb.util.MetricsManagers;\n+import com.palantir.lock.client.ConjureTimelockServiceBlockingMetrics;\n+import com.palantir.lock.client.DialogueAdaptingConjureTimelockService;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+public class FeedbackMetricsTest {\n+    private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer test\");\n+    private static final String NAMESPACE = \"test\";\n+    private ConjureTimelockServiceBlockingMetrics metrics;\n+    private ConjureTimelockServiceBlocking conjureTimelockServiceBlocking = mock(ConjureTimelockServiceBlocking.class);\n+    private DialogueAdaptingConjureTimelockService service;\n+\n+    @Mock private LeaderTime leaderTime;\n+    @Mock private ConjureStartTransactionsRequest request;\n+    @Mock private ConjureStartTransactionsResponse conjureStartTransactionsResponse;\n+\n+    @Before\n+    public void cleanMetrics() {\n+        metrics = ConjureTimelockServiceBlockingMetrics.of(\n+                        MetricsManagers.createForTests().getTaggedRegistry());\n+        service = new DialogueAdaptingConjureTimelockService(conjureTimelockServiceBlocking, metrics);\n+    }\n+\n+    @Test\n+    public void leaderTimeMetricsAreRecordedOnSuccess() {\n+        when(conjureTimelockServiceBlocking.leaderTime(AUTH_HEADER, NAMESPACE)).thenReturn(leaderTime);\n+        service.leaderTime(AUTH_HEADER, NAMESPACE);\n+        assertThat(metrics.leaderTime().getCount()).isEqualTo(1L);\n+        assertThat(metrics.leaderTime().getSnapshot().get99thPercentile()).isNotZero();\n+        assertThat(metrics.leaderTimeErrors().getCount()).isEqualTo(0);\n+    }\n+\n+    @Test\n+    public void leaderTimeErrorMetricsAreRecordedOnException() {\n+        when(conjureTimelockServiceBlocking.leaderTime(AUTH_HEADER, NAMESPACE)).thenThrow(new RuntimeException());\n+        try {\n+            service.leaderTime(AUTH_HEADER, NAMESPACE);\n+        } catch (RuntimeException e) {\n+            // no op", "originalCommit": "2c4d9bac8909035d52618361ab44e08954727c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "278d6b6d8cfa169a42bf09a356faa61773bb0494", "url": "https://github.com/palantir/atlasdb/commit/278d6b6d8cfa169a42bf09a356faa61773bb0494", "message": "Fix errors", "committedDate": "2020-06-23T11:01:40Z", "type": "commit"}, {"oid": "dde8fcf62c26747b9fea929f7acbbc438f39bbfc", "url": "https://github.com/palantir/atlasdb/commit/dde8fcf62c26747b9fea929f7acbbc438f39bbfc", "message": "Merge branch 'error_rates' of github.com:palantir/atlasdb into error_rates", "committedDate": "2020-06-23T11:01:54Z", "type": "commit"}]}