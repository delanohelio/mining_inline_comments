{"pr_number": 4680, "pr_title": "[PDS-114184] Increase transaction read timeout in CLI to 8 hours", "pr_createdAt": "2020-03-27T09:58:49Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4680", "timeline": [{"oid": "75ead3aeebf4248c0eaa04fc1acefb0295e0420b", "url": "https://github.com/palantir/atlasdb/commit/75ead3aeebf4248c0eaa04fc1acefb0295e0420b", "message": "override transaction timeout millis in CLI", "committedDate": "2020-03-27T09:37:29Z", "type": "commit"}, {"oid": "718de56a0aca7a947dd303f93048705a51f4d165", "url": "https://github.com/palantir/atlasdb/commit/718de56a0aca7a947dd303f93048705a51f4d165", "message": "Add generated changelog entries", "committedDate": "2020-03-27T09:37:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NTYxNQ==", "url": "https://github.com/palantir/atlasdb/pull/4680#discussion_r399175615", "bodyText": "Why is it hard to make the verification step use multiple transactions, same as migration.", "author": "jkozlowski", "createdAt": "2020-03-27T10:41:56Z", "path": "atlasdb-cli/src/main/java/com/palantir/atlasdb/cli/command/KvsMigrationCommand.java", "diffHunk": "@@ -40,6 +41,7 @@\n @Command(name = \"migrate\", description = \"Migrate your data from one key value service to another.\")\n public class KvsMigrationCommand implements Callable<Integer> {\n     private static final OutputPrinter printer = new OutputPrinter(LoggerFactory.getLogger(KvsMigrationCommand.class));\n+    private static final int TRANSACTION_READ_TIMEOUT_MILLIS_OVERRIDE = 8 * 60 * 60 * 1000;", "originalCommit": "718de56a0aca7a947dd303f93048705a51f4d165", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE4Nzc0Mg==", "url": "https://github.com/palantir/atlasdb/pull/4680#discussion_r399187742", "bodyText": "#4681", "author": "Jolyon-S", "createdAt": "2020-03-27T11:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NTYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIzMjY1Nw==", "url": "https://github.com/palantir/atlasdb/pull/4680#discussion_r399232657", "bodyText": "If we're going to do it this way, we should probably also disable retries in the validator; if you hit a problem after a couple hours it doesn't really buy you much to retry, becuase nobody will sit there for that long.", "author": "jkozlowski", "createdAt": "2020-03-27T12:35:41Z", "path": "atlasdb-cli/src/main/java/com/palantir/atlasdb/cli/command/KvsMigrationCommand.java", "diffHunk": "@@ -150,21 +152,29 @@ private AtlasDbConfig makeOfflineIfNecessary(AtlasDbConfig atlasDbConfig) {\n     }\n \n     public AtlasDbServices connectFromServices() throws IOException {\n-        AtlasDbConfig fromConfig = AtlasDbConfigs.load(fromConfigFile, configRoot, AtlasDbConfig.class);\n+        AtlasDbConfig fromConfig = overrideTransactionTimeoutMillis(\n+                AtlasDbConfigs.load(fromConfigFile, configRoot, AtlasDbConfig.class));\n         ServicesConfigModule scm = ServicesConfigModule.create(\n                 makeOfflineIfNecessary(fromConfig), AtlasDbRuntimeConfig.withSweepDisabled());\n         return DaggerAtlasDbServices.builder().servicesConfigModule(scm).build();\n     }\n \n     public AtlasDbServices connectToServices() throws IOException {\n-        AtlasDbConfig toConfig = toConfigFile != null\n-                ? AtlasDbConfigs.load(toConfigFile, configRoot, AtlasDbConfig.class)\n-                : AtlasDbConfigs.loadFromString(inlineConfig, null, AtlasDbConfig.class);\n+        AtlasDbConfig toConfig = overrideTransactionTimeoutMillis(\n+                toConfigFile != null\n+                        ? AtlasDbConfigs.load(toConfigFile, configRoot, AtlasDbConfig.class)\n+                        : AtlasDbConfigs.loadFromString(inlineConfig, null, AtlasDbConfig.class));\n         ServicesConfigModule scm = ServicesConfigModule.create(\n                 makeOfflineIfNecessary(toConfig), AtlasDbRuntimeConfig.withSweepDisabled());\n         return DaggerAtlasDbServices.builder().servicesConfigModule(scm).build();\n     }\n \n+    private AtlasDbConfig overrideTransactionTimeoutMillis(AtlasDbConfig config) {\n+        return ImmutableAtlasDbConfig.builder().from(config)\n+                .transactionReadTimeoutMillis(TRANSACTION_READ_TIMEOUT_MILLIS_OVERRIDE)", "originalCommit": "718de56a0aca7a947dd303f93048705a51f4d165", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c6c49e986b11df46a496bd61ab304a95c0ac5f3", "url": "https://github.com/palantir/atlasdb/commit/4c6c49e986b11df46a496bd61ab304a95c0ac5f3", "message": "use non-retriable txns", "committedDate": "2020-03-27T13:11:35Z", "type": "commit"}, {"oid": "91fb37933a7181663534bb67861d50b097d36e55", "url": "https://github.com/palantir/atlasdb/commit/91fb37933a7181663534bb67861d50b097d36e55", "message": "remove accidental character", "committedDate": "2020-03-27T13:12:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2OTA1MQ==", "url": "https://github.com/palantir/atlasdb/pull/4680#discussion_r399269051", "bodyText": "Put a comment why you don't want retryes", "author": "jkozlowski", "createdAt": "2020-03-27T13:36:54Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/schema/KeyValueServiceValidator.java", "diffHunk": "@@ -115,7 +115,7 @@ private void validateTables(Set<TableReference> tables) {\n     private void validateTable(final TableReference table) {\n         final int limit = getBatchSize(table);\n         // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationFromTransactionManager.runTaskWithRetry(\n+        validationFromTransactionManager.runTaskThrowOnConflict(", "originalCommit": "91fb37933a7181663534bb67861d50b097d36e55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f7cb13139eec1bca3cb4aadb34856756f720d204", "url": "https://github.com/palantir/atlasdb/commit/f7cb13139eec1bca3cb4aadb34856756f720d204", "message": "update timeout", "committedDate": "2020-03-27T13:39:00Z", "type": "commit"}, {"oid": "c5bec3396300afb88e7efd53d3220dd3c6a7b564", "url": "https://github.com/palantir/atlasdb/commit/c5bec3396300afb88e7efd53d3220dd3c6a7b564", "message": "Add generated changelog entries", "committedDate": "2020-03-27T13:39:00Z", "type": "commit"}, {"oid": "0314b5b6008908fea7040f471546bdd37d36a353", "url": "https://github.com/palantir/atlasdb/commit/0314b5b6008908fea7040f471546bdd37d36a353", "message": "temp remove changelog", "committedDate": "2020-03-27T13:40:02Z", "type": "commit"}, {"oid": "9b597027385ca821da062ec780b1e04f94ff85b8", "url": "https://github.com/palantir/atlasdb/commit/9b597027385ca821da062ec780b1e04f94ff85b8", "message": "update changelog", "committedDate": "2020-03-27T13:40:40Z", "type": "commit"}]}