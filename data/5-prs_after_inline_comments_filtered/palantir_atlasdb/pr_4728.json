{"pr_number": 4728, "pr_title": "Get all namespaces", "pr_createdAt": "2020-04-22T14:53:11Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4728", "timeline": [{"oid": "3412e8849d3520461dfd6d15bf2c28bf363b4e86", "url": "https://github.com/palantir/atlasdb/commit/3412e8849d3520461dfd6d15bf2c28bf363b4e86", "message": "Resource and loader", "committedDate": "2020-04-22T14:46:28Z", "type": "commit"}, {"oid": "6247e844c9230c05a26e451cd8afe665c97b5bc9", "url": "https://github.com/palantir/atlasdb/commit/6247e844c9230c05a26e451cd8afe665c97b5bc9", "message": "Wiring creation", "committedDate": "2020-04-22T14:46:48Z", "type": "commit"}, {"oid": "e932cc4d1d40e7db68e0989abbd1431fa9a5dcdb", "url": "https://github.com/palantir/atlasdb/commit/e932cc4d1d40e7db68e0989abbd1431fa9a5dcdb", "message": "Fix", "committedDate": "2020-04-22T18:33:49Z", "type": "commit"}, {"oid": "bf037884589aa918b1fd92aa182180d2a4945ef2", "url": "https://github.com/palantir/atlasdb/commit/bf037884589aa918b1fd92aa182180d2a4945ef2", "message": "Null check", "committedDate": "2020-04-22T18:42:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYyODUyOA==", "url": "https://github.com/palantir/atlasdb/pull/4728#discussion_r413628528", "bodyText": "Let's make this static, no reason to get the logger on every call", "author": "jeremyk-91", "createdAt": "2020-04-23T08:43:37Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.management;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.slf4j.LoggerFactory;\n+\n+import com.palantir.atlasdb.timelock.paxos.PaxosUseCase;\n+import com.palantir.logsafe.SafeArg;\n+\n+final class DiskNamespaceLoader {\n+    private final Path rootDataDirectory;\n+\n+    DiskNamespaceLoader(Path rootDataDirectory) {\n+        this.rootDataDirectory = rootDataDirectory;\n+    }\n+\n+    Set<String> getNamespaces() {\n+        return Arrays.stream(PaxosUseCase.values())\n+                .filter(useCase -> useCase != PaxosUseCase.LEADER_FOR_ALL_CLIENTS)\n+                .map(useCase -> useCase.logDirectoryRelativeToDataDirectory(rootDataDirectory))\n+                .flatMap(DiskNamespaceLoader::getNamespacesFromUseCaseResolvedDirectory)\n+                .collect(Collectors.toSet());\n+    }\n+\n+    private static Stream<String> getNamespacesFromUseCaseResolvedDirectory(Path logDirectory) {\n+        File[] directories = logDirectory.toFile().listFiles(File::isDirectory);\n+        if (directories == null) {\n+            LoggerFactory.getLogger(DiskNamespaceLoader.class)", "originalCommit": "bf037884589aa918b1fd92aa182180d2a4945ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYyOTg0NQ==", "url": "https://github.com/palantir/atlasdb/pull/4728#discussion_r413629845", "bodyText": "I'd suggest we write this as:\n\nif logDirectory does not exist, return Stream.of() without complaints, or maybe an INFO log\nif it does and we get null, log error and throw: this is a strange state", "author": "jeremyk-91", "createdAt": "2020-04-23T08:45:24Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.management;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.slf4j.LoggerFactory;\n+\n+import com.palantir.atlasdb.timelock.paxos.PaxosUseCase;\n+import com.palantir.logsafe.SafeArg;\n+\n+final class DiskNamespaceLoader {\n+    private final Path rootDataDirectory;\n+\n+    DiskNamespaceLoader(Path rootDataDirectory) {\n+        this.rootDataDirectory = rootDataDirectory;\n+    }\n+\n+    Set<String> getNamespaces() {\n+        return Arrays.stream(PaxosUseCase.values())\n+                .filter(useCase -> useCase != PaxosUseCase.LEADER_FOR_ALL_CLIENTS)\n+                .map(useCase -> useCase.logDirectoryRelativeToDataDirectory(rootDataDirectory))\n+                .flatMap(DiskNamespaceLoader::getNamespacesFromUseCaseResolvedDirectory)\n+                .collect(Collectors.toSet());\n+    }\n+\n+    private static Stream<String> getNamespacesFromUseCaseResolvedDirectory(Path logDirectory) {\n+        File[] directories = logDirectory.toFile().listFiles(File::isDirectory);\n+        if (directories == null) {\n+            LoggerFactory.getLogger(DiskNamespaceLoader.class)\n+                    .error(\"Could not get file for the directory {}\", SafeArg.of(\"dirName\", logDirectory));\n+            return Stream.of();\n+        }", "originalCommit": "bf037884589aa918b1fd92aa182180d2a4945ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e0f71f1a82cf5cf63c587b3bf91ebe1149eec1e", "url": "https://github.com/palantir/atlasdb/commit/9e0f71f1a82cf5cf63c587b3bf91ebe1149eec1e", "message": "Address comments", "committedDate": "2020-04-24T09:05:34Z", "type": "commit"}, {"oid": "bbedca424e98e5ef8ee9bc1ade6a4f809dbf83f7", "url": "https://github.com/palantir/atlasdb/commit/bbedca424e98e5ef8ee9bc1ade6a4f809dbf83f7", "message": "Address comments - I", "committedDate": "2020-04-24T13:32:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg0MzU4Nw==", "url": "https://github.com/palantir/atlasdb/pull/4728#discussion_r415843587", "bodyText": "nit: We normally use log rather than logger", "author": "jeremyk-91", "createdAt": "2020-04-27T14:08:00Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.management;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.palantir.atlasdb.timelock.paxos.PaxosUseCase;\n+import com.palantir.logsafe.SafeArg;\n+\n+final class DiskNamespaceLoader {\n+    private static final Logger logger = LoggerFactory.getLogger(DiskNamespaceLoader.class);", "originalCommit": "bbedca424e98e5ef8ee9bc1ade6a4f809dbf83f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg0NTAyNA==", "url": "https://github.com/palantir/atlasdb/pull/4728#discussion_r415845024", "bodyText": "Probably should add an INFO log (we skipped log directory {}).", "author": "jeremyk-91", "createdAt": "2020-04-27T14:09:42Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.management;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.palantir.atlasdb.timelock.paxos.PaxosUseCase;\n+import com.palantir.logsafe.SafeArg;\n+\n+final class DiskNamespaceLoader {\n+    private static final Logger logger = LoggerFactory.getLogger(DiskNamespaceLoader.class);\n+    private final Path rootDataDirectory;\n+\n+    DiskNamespaceLoader(Path rootDataDirectory) {\n+        this.rootDataDirectory = rootDataDirectory;\n+    }\n+\n+    Set<String> getNamespaces() {\n+        return Arrays.stream(PaxosUseCase.values())\n+                .filter(useCase -> useCase != PaxosUseCase.LEADER_FOR_ALL_CLIENTS)\n+                .map(useCase -> useCase.logDirectoryRelativeToDataDirectory(rootDataDirectory))\n+                .flatMap(DiskNamespaceLoader::getNamespacesFromUseCaseResolvedDirectory)\n+                .collect(Collectors.toSet());\n+    }\n+\n+    private static Stream<String> getNamespacesFromUseCaseResolvedDirectory(Path logDirectory) {\n+        if (Files.notExists(logDirectory)) {\n+            return Stream.of();", "originalCommit": "bbedca424e98e5ef8ee9bc1ade6a4f809dbf83f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7224fd5ae3297f7be86ddcd5f5a043396a3a3899", "url": "https://github.com/palantir/atlasdb/commit/7224fd5ae3297f7be86ddcd5f5a043396a3a3899", "message": "Address comments", "committedDate": "2020-04-27T14:13:14Z", "type": "commit"}]}