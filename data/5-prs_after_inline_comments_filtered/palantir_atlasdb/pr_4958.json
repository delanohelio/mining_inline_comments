{"pr_number": 4958, "pr_title": "[LW] Fixes, 2: Stop time travelling", "pr_createdAt": "2020-08-21T09:17:04Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4958", "timeline": [{"oid": "be3844b9d969fd94191ffd77569249d8bc17c188", "url": "https://github.com/palantir/atlasdb/commit/be3844b9d969fd94191ffd77569249d8bc17c188", "message": "stop time travelling", "committedDate": "2020-08-21T09:11:01Z", "type": "commit"}, {"oid": "ad7330d5e22a51094546cfdf619b33f8d4b475cc", "url": "https://github.com/palantir/atlasdb/commit/ad7330d5e22a51094546cfdf619b33f8d4b475cc", "message": "Add generated changelog entries", "committedDate": "2020-08-21T09:11:01Z", "type": "commit"}, {"oid": "3ca61736440369dcd43aaeab584d9c34f94aa3f4", "url": "https://github.com/palantir/atlasdb/commit/3ca61736440369dcd43aaeab584d9c34f94aa3f4", "message": "make test a bit tighter", "committedDate": "2020-08-21T09:17:54Z", "type": "commit"}, {"oid": "afba760e72f4bb440a6eb0c139cb80c1d6c5a513", "url": "https://github.com/palantir/atlasdb/commit/afba760e72f4bb440a6eb0c139cb80c1d6c5a513", "message": "Merge branch 'time-travel-is-dangerous' of github.com:palantir/atlasdb into time-travel-is-dangerous", "committedDate": "2020-08-21T09:18:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU3NjgyNw==", "url": "https://github.com/palantir/atlasdb/pull/4958#discussion_r474576827", "bodyText": "This is a little funky, but the alternative I had in mind to avoid the optional nesting has its own messy implementation detail leaking around:\nStream.of(() -> maybeStartVersion, this::getFirstKey)\n        .map(Supplier::get)\n        .filter(version -> version <= endVersion)\n        .findFirst();", "author": "jeremyk-91", "createdAt": "2020-08-21T09:31:14Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/VersionedEventStore.java", "diffHunk": "@@ -35,10 +35,14 @@\n     private final NavigableMap<Long, LockWatchEvent> eventMap = new TreeMap<>();\n \n     Collection<LockWatchEvent> getEventsBetweenVersionsInclusive(Optional<Long> maybeStartVersion, long endVersion) {\n-        return ImmutableSet.copyOf(maybeStartVersion.map(\n-                startVersion -> getValuesBetweenInclusive(endVersion, startVersion))\n-                .orElseGet(() -> getFirstKey().map(firstKey -> getValuesBetweenInclusive(endVersion, firstKey))\n-                        .orElseGet(ImmutableList::of)));\n+        Optional<Long> startVersion = maybeStartVersion\n+                .map(Optional::of)\n+                .orElseGet(this::getFirstKey)\n+                .filter(version -> version <= endVersion);", "originalCommit": "afba760e72f4bb440a6eb0c139cb80c1d6c5a513", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e6b7f0ed9a2e256385c294dd22d2b6a4f9f9d10a", "url": "https://github.com/palantir/atlasdb/commit/e6b7f0ed9a2e256385c294dd22d2b6a4f9f9d10a", "message": "fix nits", "committedDate": "2020-08-21T09:34:48Z", "type": "commit"}, {"oid": "15694b518583f9ef1464287ba607730c5d975e2c", "url": "https://github.com/palantir/atlasdb/commit/15694b518583f9ef1464287ba607730c5d975e2c", "message": "I need to stop adding imports", "committedDate": "2020-08-21T09:50:09Z", "type": "commit"}]}