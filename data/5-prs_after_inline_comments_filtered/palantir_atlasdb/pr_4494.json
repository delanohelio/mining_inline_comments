{"pr_number": 4494, "pr_title": "[Timelock Partitioning] Part 44f: More metrics fixes", "pr_createdAt": "2020-01-08T15:30:12Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4494", "timeline": [{"oid": "67ef389ef3fa5e00adb8bee4acc204933d8c5125", "url": "https://github.com/palantir/atlasdb/commit/67ef389ef3fa5e00adb8bee4acc204933d8c5125", "message": "Failing test.", "committedDate": "2020-01-08T15:16:52Z", "type": "commit"}, {"oid": "a2cca669d751f58986b81cb4676a6a54fa46affb", "url": "https://github.com/palantir/atlasdb/commit/a2cca669d751f58986b81cb4676a6a54fa46affb", "message": "Fix for failing metrics.", "committedDate": "2020-01-08T15:18:42Z", "type": "commit"}, {"oid": "a115759ae2f23469b024abf3c45adf2e8002a570", "url": "https://github.com/palantir/atlasdb/commit/a115759ae2f23469b024abf3c45adf2e8002a570", "message": "Add generated changelog entries", "committedDate": "2020-01-08T15:18:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyNzUwNA==", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364727504", "bodyText": "TaggedMetricRegistries are nice because of the:\nvoid addMetrics(String safeTagName, String safeTagValue, TaggedMetricSet metrics)\n\nMethod, which basically allows for establishing metric hierarchies. Using this, this class would not have to deal with tags at all, because it would be passed a TaggedMetricRegistry that is scoped to the exact thing it needs, and ALL metrics created underneath it would be tagged correctly.", "author": "jkozlowski", "createdAt": "2020-01-09T13:06:41Z", "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -48,8 +48,11 @@\n     private final Meter leaderPingReturnedFalse;\n     private final Object[] contextArgs;\n \n-    LeadershipEvents(TaggedMetricRegistry metrics, List<SafeArg<String>> contextArgs) {\n-        Map<String, String> safeTags = safeTags(contextArgs);\n+    LeadershipEvents(\n+            TaggedMetricRegistry metrics,", "originalCommit": "a115759ae2f23469b024abf3c45adf2e8002a570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyOTA4Mg==", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364729082", "bodyText": "Deregistration in the TimelockLeadershipMetrics should also hopefully become just a simple removal of the scoped TaggedMetricSet, so that code should be less error prone.", "author": "jkozlowski", "createdAt": "2020-01-09T13:10:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyNzUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDczOTExNQ==", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364739115", "bodyText": "so I'm using that above, I didn't do another level for reasons unbeknownst to me, perhaps I was worried about perf of multi level hierarchies, but I can give it a try.", "author": "felixdesouza", "createdAt": "2020-01-09T13:33:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyNzUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc1OTAwMQ==", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364759001", "bodyText": "If it's not performant enough, we should fix this in the library and not workaround here.", "author": "jkozlowski", "createdAt": "2020-01-09T14:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyNzUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDczMTczMQ==", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364731731", "bodyText": "This logging also feels rather cumbersome: it would be great to use MDC for this. The only problem is we can't assume anything about the logging framework, safe vs unsafe arg handling... :(", "author": "jkozlowski", "createdAt": "2020-01-09T13:16:35Z", "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -58,7 +61,7 @@\n         leaderPingFailure = metrics.meter(withName(\"leadership.ping-leader.failure\", safeTags));\n         leaderPingTimeout = metrics.meter(withName(\"leadership.ping-leader.timeout\", safeTags));\n         leaderPingReturnedFalse = metrics.meter(withName(\"leadership.ping-leader.returned-false\", safeTags));\n-        this.contextArgs = contextArgs.toArray(new Object[0]);\n+        this.contextArgs = safeLoggingArgs.toArray(new Object[0]);\n     }\n \n     void proposedLeadershipFor(long round) {", "originalCommit": "a115759ae2f23469b024abf3c45adf2e8002a570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDczNzg3OQ==", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364737879", "bodyText": "yeah, it would", "author": "felixdesouza", "createdAt": "2020-01-09T13:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDczMTczMQ=="}], "type": "inlineReview"}]}