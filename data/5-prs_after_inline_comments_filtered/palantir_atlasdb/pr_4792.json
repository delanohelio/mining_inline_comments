{"pr_number": 4792, "pr_title": "[Dialogue] Part 8: Legacy Lock Service Locks", "pr_createdAt": "2020-05-20T18:06:26Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4792", "timeline": [{"oid": "f84c08c188c44c2db5fc005b296bc2892a1a6b46", "url": "https://github.com/palantir/atlasdb/commit/f84c08c188c44c2db5fc005b296bc2892a1a6b46", "message": "conjurize lock", "committedDate": "2020-05-19T19:52:50Z", "type": "commit"}, {"oid": "e45494fd878455b41899709fa63b01ebb5ee09d1", "url": "https://github.com/palantir/atlasdb/commit/e45494fd878455b41899709fa63b01ebb5ee09d1", "message": "Gradle", "committedDate": "2020-05-19T21:04:33Z", "type": "commit"}, {"oid": "00f258242935e25093bbf7838f58651030142a8d", "url": "https://github.com/palantir/atlasdb/commit/00f258242935e25093bbf7838f58651030142a8d", "message": "New resource", "committedDate": "2020-05-19T21:04:42Z", "type": "commit"}, {"oid": "ca1b12ebadb49c303fccb7036ee0c83fb11b7642", "url": "https://github.com/palantir/atlasdb/commit/ca1b12ebadb49c303fccb7036ee0c83fb11b7642", "message": "Git out of here", "committedDate": "2020-05-19T21:05:08Z", "type": "commit"}, {"oid": "d8811b164db51e0e1325e618c2477d45487231fd", "url": "https://github.com/palantir/atlasdb/commit/d8811b164db51e0e1325e618c2477d45487231fd", "message": "test", "committedDate": "2020-05-19T21:28:20Z", "type": "commit"}, {"oid": "e97410458a4379482f6f46325cc4f309f89e9425", "url": "https://github.com/palantir/atlasdb/commit/e97410458a4379482f6f46325cc4f309f89e9425", "message": "JAXRS is tough", "committedDate": "2020-05-19T21:43:14Z", "type": "commit"}, {"oid": "78ecc2642c7b94a0b0bb2a845a311456bfad8111", "url": "https://github.com/palantir/atlasdb/commit/78ecc2642c7b94a0b0bb2a845a311456bfad8111", "message": "Add generated changelog entries", "committedDate": "2020-05-19T21:43:09Z", "type": "commit"}, {"oid": "e2781f509fd3b5581349006bf66f4e9da41802b8", "url": "https://github.com/palantir/atlasdb/commit/e2781f509fd3b5581349006bf66f4e9da41802b8", "message": "first version", "committedDate": "2020-05-20T17:30:10Z", "type": "commit"}, {"oid": "58e0419e02db95d04bf857775749a5dbb1e3e783", "url": "https://github.com/palantir/atlasdb/commit/58e0419e02db95d04bf857775749a5dbb1e3e783", "message": "Add integ test", "committedDate": "2020-05-20T17:36:46Z", "type": "commit"}, {"oid": "69d7d60d83f210e81c507be0f2f74f4572e02863", "url": "https://github.com/palantir/atlasdb/commit/69d7d60d83f210e81c507be0f2f74f4572e02863", "message": "Integ tests", "committedDate": "2020-05-20T17:37:36Z", "type": "commit"}, {"oid": "5c9c90c01c0bd9952595741dc7663bd88f7e34f0", "url": "https://github.com/palantir/atlasdb/commit/5c9c90c01c0bd9952595741dc7663bd88f7e34f0", "message": "simplify and add better test", "committedDate": "2020-05-20T18:03:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxMDExNw==", "url": "https://github.com/palantir/atlasdb/pull/4792#discussion_r430310117", "bodyText": "as(\"legacy impl can unlock a lock taken by conjure impl\")", "author": "gmaretic", "createdAt": "2020-05-26T10:24:08Z", "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java", "diffHunk": "@@ -362,6 +365,41 @@ public void directLegacyAndConjureLockServicesInteractCorrectly() throws Interru\n                 .isFalse();\n     }\n \n+    @Test\n+    public void lockAcquiredByConjureLockServiceIsAlsoAcquiredInLegacy() throws InterruptedException {\n+        com.palantir.lock.LockRequest lockRequest = com.palantir.lock.LockRequest.builder(\n+                ImmutableSortedMap.<LockDescriptor, LockMode>naturalOrder()\n+                        .put(StringLockDescriptor.of(\"lock\"), LockMode.WRITE)\n+                        .build())\n+                .doNotBlock()\n+                .build();\n+        String anonymousId = LockClient.ANONYMOUS.getClientId();\n+        ConjureLockV1Request conjureLockRequest = ConjureLockV1Request.builder()\n+                .lockClient(anonymousId)\n+                .lockRequest(lockRequest)\n+                .build();\n+\n+        HeldLocksToken token = client.conjureLegacyLockService().lockAndGetHeldLocks(\n+                AuthHeader.valueOf(\"Bearer unused\"),\n+                client.namespace(),\n+                conjureLockRequest)\n+                .orElseThrow(() -> new RuntimeException(\"We should have been able to get the lock\"));\n+\n+        assertThat(client.legacyLockService().lockAndGetHeldLocks(anonymousId, lockRequest))\n+                .as(\"if the conjure impl has taken a lock, the legacy impl mustn't be able to take it\")\n+                .isNull();\n+        assertThat(client.legacyLockService().unlock(token.getLockRefreshToken())).isTrue();", "originalCommit": "5c9c90c01c0bd9952595741dc7663bd88f7e34f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxMDMzNQ==", "url": "https://github.com/palantir/atlasdb/pull/4792#discussion_r430310335", "bodyText": "not unlocked by conjure impl", "author": "gmaretic", "createdAt": "2020-05-26T10:24:35Z", "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java", "diffHunk": "@@ -362,6 +365,41 @@ public void directLegacyAndConjureLockServicesInteractCorrectly() throws Interru\n                 .isFalse();\n     }\n \n+    @Test\n+    public void lockAcquiredByConjureLockServiceIsAlsoAcquiredInLegacy() throws InterruptedException {\n+        com.palantir.lock.LockRequest lockRequest = com.palantir.lock.LockRequest.builder(\n+                ImmutableSortedMap.<LockDescriptor, LockMode>naturalOrder()\n+                        .put(StringLockDescriptor.of(\"lock\"), LockMode.WRITE)\n+                        .build())\n+                .doNotBlock()\n+                .build();\n+        String anonymousId = LockClient.ANONYMOUS.getClientId();\n+        ConjureLockV1Request conjureLockRequest = ConjureLockV1Request.builder()\n+                .lockClient(anonymousId)\n+                .lockRequest(lockRequest)\n+                .build();\n+\n+        HeldLocksToken token = client.conjureLegacyLockService().lockAndGetHeldLocks(\n+                AuthHeader.valueOf(\"Bearer unused\"),\n+                client.namespace(),\n+                conjureLockRequest)\n+                .orElseThrow(() -> new RuntimeException(\"We should have been able to get the lock\"));\n+\n+        assertThat(client.legacyLockService().lockAndGetHeldLocks(anonymousId, lockRequest))\n+                .as(\"if the conjure impl has taken a lock, the legacy impl mustn't be able to take it\")\n+                .isNull();\n+        assertThat(client.legacyLockService().unlock(token.getLockRefreshToken())).isTrue();\n+        assertThat(client.legacyLockService().lockAndGetHeldLocks(anonymousId, lockRequest))\n+                .as(\"a lock once unlocked by conjure impl can be acquired by legacy impl\")", "originalCommit": "5c9c90c01c0bd9952595741dc7663bd88f7e34f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQyMzI0Mw==", "url": "https://github.com/palantir/atlasdb/pull/4792#discussion_r430423243", "bodyText": "oops \ud83d\udd2a yeah, lock taken by conjure impl that was unlocked, can now be acquired by legacy impl", "author": "jeremyk-91", "createdAt": "2020-05-26T13:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxMDMzNQ=="}], "type": "inlineReview"}, {"oid": "0260b6e17cda19f2db8ffcb233d32c38a414a694", "url": "https://github.com/palantir/atlasdb/commit/0260b6e17cda19f2db8ffcb233d32c38a414a694", "message": "CR feedback", "committedDate": "2020-05-28T20:21:31Z", "type": "commit"}, {"oid": "787bd291755f36234e613242d3d96b66ac1f3bad", "url": "https://github.com/palantir/atlasdb/commit/787bd291755f36234e613242d3d96b66ac1f3bad", "message": "first version", "committedDate": "2020-05-28T20:22:30Z", "type": "commit"}, {"oid": "7d925155a5e74342414feac73a167a93bb7ad70f", "url": "https://github.com/palantir/atlasdb/commit/7d925155a5e74342414feac73a167a93bb7ad70f", "message": "Add integ test", "committedDate": "2020-05-28T20:22:30Z", "type": "commit"}, {"oid": "e36238684804f4a4282925232546df03130fe319", "url": "https://github.com/palantir/atlasdb/commit/e36238684804f4a4282925232546df03130fe319", "message": "Integ tests", "committedDate": "2020-05-28T20:22:30Z", "type": "commit"}, {"oid": "d79c275debac8222b64defd2aaa735300fc9e584", "url": "https://github.com/palantir/atlasdb/commit/d79c275debac8222b64defd2aaa735300fc9e584", "message": "simplify and add better test", "committedDate": "2020-05-28T20:22:30Z", "type": "commit"}, {"oid": "d79c275debac8222b64defd2aaa735300fc9e584", "url": "https://github.com/palantir/atlasdb/commit/d79c275debac8222b64defd2aaa735300fc9e584", "message": "simplify and add better test", "committedDate": "2020-05-28T20:22:30Z", "type": "forcePushed"}, {"oid": "813ff4060701c5d7ad4be29e3a3bf202a8351022", "url": "https://github.com/palantir/atlasdb/commit/813ff4060701c5d7ad4be29e3a3bf202a8351022", "message": "CR: fix misleading line", "committedDate": "2020-05-28T20:24:39Z", "type": "commit"}, {"oid": "d20c84baa1aceedf4ba641252e2a8a0071d499b9", "url": "https://github.com/palantir/atlasdb/commit/d20c84baa1aceedf4ba641252e2a8a0071d499b9", "message": "Merge branch 'jkong/dialogue-for-locks' of github.com:palantir/atlasdb into jkong/dialogue-for-locks", "committedDate": "2020-06-03T16:53:23Z", "type": "commit"}, {"oid": "94ebaca9954fab2e6fd1ec0c0197877735c88c5f", "url": "https://github.com/palantir/atlasdb/commit/94ebaca9954fab2e6fd1ec0c0197877735c88c5f", "message": "Merge branch 'develop' into jkong/dialogue-for-locks", "committedDate": "2020-06-03T16:55:23Z", "type": "commit"}, {"oid": "eb5d9abda4bb456d1105baa084999b642fcef2a0", "url": "https://github.com/palantir/atlasdb/commit/eb5d9abda4bb456d1105baa084999b642fcef2a0", "message": "CR", "committedDate": "2020-06-03T16:56:46Z", "type": "commit"}, {"oid": "0f6256fc83965e4d2ddb95256bbe67235b2c4b90", "url": "https://github.com/palantir/atlasdb/commit/0f6256fc83965e4d2ddb95256bbe67235b2c4b90", "message": "bad merge", "committedDate": "2020-06-03T17:56:30Z", "type": "commit"}, {"oid": "ecc94c7f3dd3b4ede5e7587db438a8886338b4ae", "url": "https://github.com/palantir/atlasdb/commit/ecc94c7f3dd3b4ede5e7587db438a8886338b4ae", "message": "Merge badness", "committedDate": "2020-06-03T18:42:51Z", "type": "commit"}]}