{"pr_number": 4832, "pr_title": "Adjudication 1", "pr_createdAt": "2020-06-11T13:14:37Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4832", "timeline": [{"oid": "049c89328e75b2e183b81de51f95aa672e5b78bf", "url": "https://github.com/palantir/atlasdb/commit/049c89328e75b2e183b81de51f95aa672e5b78bf", "message": "timeLock metrics | poc", "committedDate": "2020-06-11T09:30:45Z", "type": "commit"}, {"oid": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b", "url": "https://github.com/palantir/atlasdb/commit/62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b", "message": "remove redundant code", "committedDate": "2020-06-11T09:35:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4MTg0Nw==", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r438781847", "bodyText": "this is the correct place!", "author": "jeremyk-91", "createdAt": "2020-06-11T13:31:00Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java", "diffHunk": "@@ -101,7 +104,8 @@ ConjureTimelockService getConjureTimelockService() {\n                         taggedMetricRegistry,\n                         ConjureTimelockServiceBlocking.class,\n                         service))\n-                .map(DialogueAdaptingConjureTimelockService::new);\n+                .map(instrumentedService -> new DialogueAdaptingConjureTimelockService(instrumentedService,\n+                        conjureTimelockServiceBlockingMetrics));", "originalCommit": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4MjE4Nw==", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r438782187", "bodyText": "Should we also instrument leaderTime?", "author": "jeremyk-91", "createdAt": "2020-06-11T13:31:27Z", "path": "lock-api/src/main/java/com/palantir/lock/client/DialogueAdaptingConjureTimelockService.java", "diffHunk": "@@ -36,15 +39,23 @@\n \n public class DialogueAdaptingConjureTimelockService implements ConjureTimelockService {\n     private final ConjureTimelockServiceBlocking dialogueDelegate;\n+    private final ConjureTimelockServiceBlockingMetrics conjureTimelockServiceBlockingMetrics;\n \n-    public DialogueAdaptingConjureTimelockService(ConjureTimelockServiceBlocking dialogueDelegate) {\n+    public DialogueAdaptingConjureTimelockService(ConjureTimelockServiceBlocking dialogueDelegate,\n+            ConjureTimelockServiceBlockingMetrics conjureTimelockServiceBlockingMetrics) {\n         this.dialogueDelegate = dialogueDelegate;\n+        this.conjureTimelockServiceBlockingMetrics = conjureTimelockServiceBlockingMetrics;\n     }\n \n     @Override\n     public ConjureStartTransactionsResponse startTransactions(AuthHeader authHeader, String namespace,\n             ConjureStartTransactionsRequest request) {\n-        return dialogueDelegate.startTransactions(authHeader, namespace, request);\n+        long timeCreated = System.currentTimeMillis();\n+        ConjureStartTransactionsResponse response = dialogueDelegate.startTransactions(authHeader, namespace, request);\n+        long microsSinceCreation = TimeUnit.MILLISECONDS.toMicros(System.currentTimeMillis() - timeCreated);\n+        this.conjureTimelockServiceBlockingMetrics.startTransactions().update(microsSinceCreation,\n+                TimeUnit.MICROSECONDS);\n+        return response;\n     }\n \n     @Override", "originalCommit": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4MjUxMA==", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r438782510", "bodyText": "What happens if a request takes 3.7 ms?\nI'd suggest we use Instant.now() instead \ud83d\ude04", "author": "jeremyk-91", "createdAt": "2020-06-11T13:31:48Z", "path": "lock-api/src/main/java/com/palantir/lock/client/DialogueAdaptingConjureTimelockService.java", "diffHunk": "@@ -36,15 +39,23 @@\n \n public class DialogueAdaptingConjureTimelockService implements ConjureTimelockService {\n     private final ConjureTimelockServiceBlocking dialogueDelegate;\n+    private final ConjureTimelockServiceBlockingMetrics conjureTimelockServiceBlockingMetrics;\n \n-    public DialogueAdaptingConjureTimelockService(ConjureTimelockServiceBlocking dialogueDelegate) {\n+    public DialogueAdaptingConjureTimelockService(ConjureTimelockServiceBlocking dialogueDelegate,\n+            ConjureTimelockServiceBlockingMetrics conjureTimelockServiceBlockingMetrics) {\n         this.dialogueDelegate = dialogueDelegate;\n+        this.conjureTimelockServiceBlockingMetrics = conjureTimelockServiceBlockingMetrics;\n     }\n \n     @Override\n     public ConjureStartTransactionsResponse startTransactions(AuthHeader authHeader, String namespace,\n             ConjureStartTransactionsRequest request) {\n-        return dialogueDelegate.startTransactions(authHeader, namespace, request);\n+        long timeCreated = System.currentTimeMillis();", "originalCommit": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e2787894c74f6ed9589dc81a5b18b5a7c1914ca1", "url": "https://github.com/palantir/atlasdb/commit/e2787894c74f6ed9589dc81a5b18b5a7c1914ca1", "message": "Address comments - 1", "committedDate": "2020-06-11T22:17:34Z", "type": "commit"}, {"oid": "8baa4219e9ac82c2a7687811242b6ed4b9fa4509", "url": "https://github.com/palantir/atlasdb/commit/8baa4219e9ac82c2a7687811242b6ed4b9fa4509", "message": "try with resource", "committedDate": "2020-06-11T22:29:32Z", "type": "commit"}, {"oid": "8baa4219e9ac82c2a7687811242b6ed4b9fa4509", "url": "https://github.com/palantir/atlasdb/commit/8baa4219e9ac82c2a7687811242b6ed4b9fa4509", "message": "try with resource", "committedDate": "2020-06-11T22:29:32Z", "type": "forcePushed"}, {"oid": "a312af1bc14de5a668ec806c4747b565d6874a75", "url": "https://github.com/palantir/atlasdb/commit/a312af1bc14de5a668ec806c4747b565d6874a75", "message": "remove redundant imports", "committedDate": "2020-06-11T22:31:49Z", "type": "commit"}, {"oid": "e2a89cf798e3ba2453cc7b38266e218ec47c78ac", "url": "https://github.com/palantir/atlasdb/commit/e2a89cf798e3ba2453cc7b38266e218ec47c78ac", "message": "refactor", "committedDate": "2020-06-11T22:35:46Z", "type": "commit"}, {"oid": "627106fec6f5fc34e3686c5b704798d6528fb1dd", "url": "https://github.com/palantir/atlasdb/commit/627106fec6f5fc34e3686c5b704798d6528fb1dd", "message": "Merge branch 'develop' into adjudication_1", "committedDate": "2020-06-12T09:11:58Z", "type": "commit"}, {"oid": "e747b93cbad3185054f09370e3d1ff81a2b94215", "url": "https://github.com/palantir/atlasdb/commit/e747b93cbad3185054f09370e3d1ff81a2b94215", "message": "Add generated changelog entries", "committedDate": "2020-06-12T09:11:58Z", "type": "commit"}, {"oid": "47963d67251084a493ff4d7a1b68e1f8caa93708", "url": "https://github.com/palantir/atlasdb/commit/47963d67251084a493ff4d7a1b68e1f8caa93708", "message": "liscence config update", "committedDate": "2020-06-12T10:34:49Z", "type": "commit"}, {"oid": "b69f13eb3be18bb3ef2f465501503759f0ebda11", "url": "https://github.com/palantir/atlasdb/commit/b69f13eb3be18bb3ef2f465501503759f0ebda11", "message": "Merge branch 'adjudication_1' of github.com:palantir/atlasdb into adjudication_1", "committedDate": "2020-06-12T10:35:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTMzNDU1Mg==", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r439334552", "bodyText": "nit: We don't normally use this when referring to fields (outside of assigning them in a constructor, or if they are needed e.g. when referencing things from a parent class outside of an inner class).", "author": "jeremyk-91", "createdAt": "2020-06-12T10:19:55Z", "path": "lock-api/src/main/java/com/palantir/lock/client/DialogueAdaptingConjureTimelockService.java", "diffHunk": "@@ -85,4 +90,10 @@ public GetCommitTimestampsResponse getCommitTimestamps(AuthHeader authHeader, St\n             GetCommitTimestampsRequest request) {\n         return dialogueDelegate.getCommitTimestamps(authHeader, namespace, request);\n     }\n+\n+    private <T> T executeInTimerContext(Supplier<T> supplier) {\n+        try (Timer.Context timer = this.conjureTimelockServiceBlockingMetrics.startTransactions().time()) {", "originalCommit": "e747b93cbad3185054f09370e3d1ff81a2b94215", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0ddc6fc01545ba2cbc536841995815c650e00d34", "url": "https://github.com/palantir/atlasdb/commit/0ddc6fc01545ba2cbc536841995815c650e00d34", "message": "Address comments", "committedDate": "2020-06-12T11:49:03Z", "type": "commit"}, {"oid": "9f0ee612f564f1e49d8da818c6eb681098f960cd", "url": "https://github.com/palantir/atlasdb/commit/9f0ee612f564f1e49d8da818c6eb681098f960cd", "message": "build fix", "committedDate": "2020-06-12T12:00:51Z", "type": "commit"}]}