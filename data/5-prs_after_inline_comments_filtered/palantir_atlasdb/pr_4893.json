{"pr_number": 4893, "pr_title": "[PD$-110002] Part 11: Top-N Tables | Toplist Delta Filtering Controller", "pr_createdAt": "2020-07-09T09:47:48Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4893", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE2NDg1Nw==", "url": "https://github.com/palantir/atlasdb/pull/4893#discussion_r452164857", "bodyText": "Register filter before registering metric? Would it matter?", "author": "sudiksha27", "createdAt": "2020-07-09T11:59:46Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/metrics/ToplistDeltaFilteringTableLevelMetricsController.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.transaction.impl.metrics;\n+\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+import com.codahale.metrics.CachedGauge;\n+import com.codahale.metrics.Clock;\n+import com.codahale.metrics.Counter;\n+import com.codahale.metrics.Gauge;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Maps;\n+import com.palantir.atlasdb.keyvalue.api.TableReference;\n+import com.palantir.atlasdb.metrics.MetricPublicationFilter;\n+import com.palantir.atlasdb.util.MetricsManager;\n+import com.palantir.atlasdb.util.TopNMetricPublicationController;\n+\n+/**\n+ * Makes publication decisions for a given metric, as follows: for a given String identifier, filters out all but the\n+ * highest {@code maximumNumberOfTables} values. In the event of ties (e.g. a top-list of 10 where the 10th and 11th\n+ * highest values are equal), all tying values are published.\n+ *\n+ * This controller makes decisions based on deltas (in an attempt to be able to detect load spikes) measured over the\n+ * last {@code REFRESH_INTERVAL} period.\n+ */\n+public final class ToplistDeltaFilteringTableLevelMetricsController implements TableLevelMetricsController {\n+    private static final int DEFAULT_MAX_TABLES_TO_PUBLISH_METRICS = 10;\n+    private static final String CONTROLLER_GENERATED = \"controllerGenerated\";\n+    private static final String TRUE = \"true\";\n+\n+    @VisibleForTesting\n+    static final Duration REFRESH_INTERVAL = Duration.ofSeconds(30);\n+\n+    private final Map<String, TopNMetricPublicationController<Long>> metricNameToPublicationController;\n+    private final MetricsManager metricsManager;\n+    private final int maximumNumberOfTables;\n+    private final Clock clock;\n+\n+    @VisibleForTesting\n+    ToplistDeltaFilteringTableLevelMetricsController(\n+            MetricsManager metricsManager,\n+            int maximumNumberOfTables,\n+            Clock clock) {\n+        this.metricNameToPublicationController = Maps.newConcurrentMap();\n+        this.metricsManager = metricsManager;\n+        this.maximumNumberOfTables = maximumNumberOfTables;\n+        this.clock = clock;\n+    }\n+\n+    public static TableLevelMetricsController create(MetricsManager metricsManager) {\n+        return new ToplistDeltaFilteringTableLevelMetricsController(\n+                metricsManager,\n+                DEFAULT_MAX_TABLES_TO_PUBLISH_METRICS,\n+                Clock.defaultClock());\n+    }\n+\n+    @Override\n+    public <T> Counter createAndRegisterCounter(Class<T> clazz, String metricName, TableReference tableReference) {\n+        Counter counter = metricsManager.registerOrGetTaggedCounter(\n+                clazz,\n+                metricName,\n+                getTagsForTableReference(tableReference));\n+        metricsManager.addMetricFilter(\n+                clazz,\n+                metricName,\n+                getTagsForTableReference(tableReference),\n+                MetricPublicationFilter.NEVER_PUBLISH);\n+", "originalCommit": "71f3e5cbcefa162a21ca43d0c3188264ae2c5bec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQyOTEwNg==", "url": "https://github.com/palantir/atlasdb/pull/4893#discussion_r452429106", "bodyText": "This is a well spotted bug: there would otherwise be a race condition between metric publication and the background metrics task. Will do - thanks!", "author": "jeremyk-91", "createdAt": "2020-07-09T19:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE2NDg1Nw=="}], "type": "inlineReview"}, {"oid": "b96c6b62a09a2388c019261556d5fca47d7c0e46", "url": "https://github.com/palantir/atlasdb/commit/b96c6b62a09a2388c019261556d5fca47d7c0e46", "message": "Controller", "committedDate": "2020-07-16T10:28:18Z", "type": "commit"}, {"oid": "138a4313ad5799192ce9bfbe26e5224bf130b1b5", "url": "https://github.com/palantir/atlasdb/commit/138a4313ad5799192ce9bfbe26e5224bf130b1b5", "message": "Controller test", "committedDate": "2020-07-16T10:29:11Z", "type": "commit"}, {"oid": "9dd352a63e011883e77e5e48913f6760005aa75e", "url": "https://github.com/palantir/atlasdb/commit/9dd352a63e011883e77e5e48913f6760005aa75e", "message": "Delta gauge and tests", "committedDate": "2020-07-16T10:29:18Z", "type": "commit"}, {"oid": "7120bfcbeab9b0bd3a9cea82e03997f3a4b0acbe", "url": "https://github.com/palantir/atlasdb/commit/7120bfcbeab9b0bd3a9cea82e03997f3a4b0acbe", "message": "Toplist Delta", "committedDate": "2020-07-16T10:29:32Z", "type": "commit"}, {"oid": "959e672636c501bf8f467333437e9d116612291d", "url": "https://github.com/palantir/atlasdb/commit/959e672636c501bf8f467333437e9d116612291d", "message": "baseline", "committedDate": "2020-07-16T10:29:32Z", "type": "commit"}, {"oid": "36d29a665a768ddc20ec68d81008adfabb17a88b", "url": "https://github.com/palantir/atlasdb/commit/36d29a665a768ddc20ec68d81008adfabb17a88b", "message": "Register filter before creating", "committedDate": "2020-07-16T10:29:32Z", "type": "commit"}, {"oid": "36d29a665a768ddc20ec68d81008adfabb17a88b", "url": "https://github.com/palantir/atlasdb/commit/36d29a665a768ddc20ec68d81008adfabb17a88b", "message": "Register filter before creating", "committedDate": "2020-07-16T10:29:32Z", "type": "forcePushed"}, {"oid": "e32c6ed7c549b7d715bcddc2dbb509e6e6a3e730", "url": "https://github.com/palantir/atlasdb/commit/e32c6ed7c549b7d715bcddc2dbb509e6e6a3e730", "message": "Remove unusable test", "committedDate": "2020-07-16T12:32:20Z", "type": "commit"}]}