{"pr_number": 4831, "pr_title": "[PDS-119588] Relax Cassandra Schema Version Check", "pr_createdAt": "2020-06-10T19:24:10Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4831", "timeline": [{"oid": "a372ed62bf5b3fe51ad6786e1aab4f2ff02c3ddc", "url": "https://github.com/palantir/atlasdb/commit/a372ed62bf5b3fe51ad6786e1aab4f2ff02c3ddc", "message": "checkpoint", "committedDate": "2020-06-10T16:00:00Z", "type": "commit"}, {"oid": "48afbf644e184c003924bef04dc7ffb3a9fa1005", "url": "https://github.com/palantir/atlasdb/commit/48afbf644e184c003924bef04dc7ffb3a9fa1005", "message": "Remove quorum check", "committedDate": "2020-06-10T18:47:00Z", "type": "commit"}, {"oid": "481e0ce48eb17efc4bc7355aa4b62cba96c35261", "url": "https://github.com/palantir/atlasdb/commit/481e0ce48eb17efc4bc7355aa4b62cba96c35261", "message": "docs", "committedDate": "2020-06-10T18:52:23Z", "type": "commit"}, {"oid": "ce65e6423800bd5844467defc7283dcfe6c2f97f", "url": "https://github.com/palantir/atlasdb/commit/ce65e6423800bd5844467defc7283dcfe6c2f97f", "message": "Test updates", "committedDate": "2020-06-10T19:09:35Z", "type": "commit"}, {"oid": "44cdd512c73db8afebec8b97ae34d14dd4d1fe75", "url": "https://github.com/palantir/atlasdb/commit/44cdd512c73db8afebec8b97ae34d14dd4d1fe75", "message": "Add generated changelog entries", "committedDate": "2020-06-10T19:09:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYzNTk0Mw==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438635943", "bodyText": "Why do we return false if no nodes are reachable? I mean, should the case where there is no reachable part be handled differently?", "author": "sudiksha27", "createdAt": "2020-06-11T08:47:19Z", "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraKeyValueServices.java", "diffHunk": "@@ -137,18 +136,8 @@ static void runWithWaitingForSchemas(\n         waitForSchemaVersions(config, client, \"after \" + unsafeSchemaChangeDescription);\n     }\n \n-    static boolean uniqueSchemaWithQuorumAgreementAndOtherNodesUnreachable(\n-            CassandraKeyValueServiceConfig config,\n-            Map<String, List<String>> versions) {\n-        List<String> reachableSchemas = getDistinctReachableSchemas(versions);\n-        if (reachableSchemas.size() > 1) {\n-            return false;\n-        }\n-\n-        int numberOfServers = config.servers().numberOfThriftHosts();\n-        int numberOfVisibleNodes = getNumberOfReachableNodes(versions);\n-\n-        return numberOfVisibleNodes >= ((numberOfServers / 2) + 1);\n+    static boolean reachablePartOfClusterHasConsistentSchemaVersions(Map<String, List<String>> versions) {\n+        return getDistinctReachableSchemas(versions).size() == 1;", "originalCommit": "44cdd512c73db8afebec8b97ae34d14dd4d1fe75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc2NjgwOA==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438766808", "bodyText": "it probably doesn't matter what we return in that case? expectation being your schema mutation will fail because there is no online node for it to succeed against.", "author": "tpetracca", "createdAt": "2020-06-11T13:06:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYzNTk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NzI2Mw==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438477263", "bodyText": "I'm not sure I totally understand this test (even before this change). Why would the returned map be missing nodes?", "author": "tpetracca", "createdAt": "2020-06-11T00:24:51Z", "path": "atlasdb-cassandra/src/test/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraKeyValueServicesSchemaConsensusTest.java", "diffHunk": "@@ -85,16 +85,16 @@ public void waitThrowsForAllUnreachableSchemaVersion() throws TException {\n     }\n \n     @Test\n-    public void waitThrowsForFewerThanQuorumOnSameVersion() throws TException {\n+    public void waitSucceedsOnMinorityOnSameVersion() throws TException {", "originalCommit": "44cdd512c73db8afebec8b97ae34d14dd4d1fe75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5NDMxMA==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438894310", "bodyText": "I think it was feared that bootstrapping might mean we don't know about some of the nodes in the cluster (if the coordinator for some reason doesn't know about these yet).", "author": "jeremyk-91", "createdAt": "2020-06-11T15:53:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NzI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0ODMzMA==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438948330", "bodyText": "I've renamed the test to waitSucceedsWithClusterHavingDownsizedAtRuntime, since now that's what the test should be testing in practice", "author": "jeremyk-91", "createdAt": "2020-06-11T17:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NzI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NzM4Mw==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438477383", "bodyText": "\ud83d\udc4d", "author": "tpetracca", "createdAt": "2020-06-11T00:25:14Z", "path": "atlasdb-cassandra/src/test/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraKeyValueServicesSchemaConsensusTest.java", "diffHunk": "@@ -85,16 +85,16 @@ public void waitThrowsForAllUnreachableSchemaVersion() throws TException {\n     }\n \n     @Test\n-    public void waitThrowsForFewerThanQuorumOnSameVersion() throws TException {\n+    public void waitSucceedsOnMinorityOnSameVersion() throws TException {\n         when(client.describe_schema_versions()).thenReturn(ImmutableMap.of(VERSION_1, REST_OF_NODES));\n-        assertWaitForSchemaVersionsThrowsAndContainsConfigNodesInformation();\n+        assertWaitForSchemaVersionsDoesNotThrow();\n     }\n \n     @Test\n-    public void waitThrowsForQuorumOfUnreachableNodes() throws TException {\n+    public void waitSucceedsOnMinorityOnSameVersionAndRestUnreachable() throws TException {", "originalCommit": "44cdd512c73db8afebec8b97ae34d14dd4d1fe75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5MzQ4NQ==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438893485", "bodyText": "(Note: Changed to fails now, going along with the discussion on the later comment.)", "author": "jeremyk-91", "createdAt": "2020-06-11T15:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NzM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc3MTMzNw==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438771337", "bodyText": "maybe change the wording to \"must only be used on KVS initialization to generate the initial connection(s) to the cluster\"?", "author": "tpetracca", "createdAt": "2020-06-11T13:13:55Z", "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/cassandra/CassandraKeyValueServiceConfig.java", "diffHunk": "@@ -48,6 +48,13 @@\n \n     String TYPE = \"cassandra\";\n \n+    /**\n+     * These are only the initial 'contact points' that will be used in connecting with the cluster. AtlasDB will\n+     * subsequently discover additional hosts in the cluster. (This is true for both Thrift and CQL endpoints.)\n+     *\n+     * This value, or values derived from it (e.g. the number of Thrift hosts) MUST NOT be used to ascertain the", "originalCommit": "44cdd512c73db8afebec8b97ae34d14dd4d1fe75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5MDUyOA==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438790528", "bodyText": "Tf we haven't already I think we should audit use of this method across the codebase and ensure it aligns with the expectations of this javadoc. The method below we've altered in this PR, even after these changes actually calls this method when it should not (even if it is only for logging purposes, it is still incorrect).", "author": "tpetracca", "createdAt": "2020-06-11T13:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc3MTMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkxODM1OA==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438918358", "bodyText": "Yep, changed. I did do this audit actually, though agree that the log message makes more sense when it actually uses the servers discovered in the cluster.", "author": "jeremyk-91", "createdAt": "2020-06-11T16:31:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc3MTMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc3NjUxNw==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438776517", "bodyText": "we should delete the CassandraKeyValueServiceConfig config from this method's signature and remove its usage across the entirety fo the method", "author": "tpetracca", "createdAt": "2020-06-11T13:22:36Z", "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraKeyValueServices.java", "diffHunk": "@@ -88,19 +88,18 @@ static void waitForSchemaVersions(\n         long sleepTime = INITIAL_SLEEP_TIME;\n         Map<String, List<String>> versions;\n         do {\n-            // This only returns the schema versions of nodes that the client knows exist. In particular, if a node we\n-            // shook hands with goes down, it will have schema version UNREACHABLE; however, if we never shook hands\n-            // with a node, there will simply be no entry for it in the map. Hence the check for the number of nodes.\n+            // This may only include some of the nodes if the coordinator hasn't shaken hands with someone; however,\n+            // this existed largely as a defense against performance issues with concurrent schema modifications.\n             versions = client.describe_schema_versions();\n-            if (uniqueSchemaWithQuorumAgreementAndOtherNodesUnreachable(config, versions)) {", "originalCommit": "44cdd512c73db8afebec8b97ae34d14dd4d1fe75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkzMDMxMw==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438930313", "bodyText": "It's still used for the blocking interval, though I've changed that to passing in an int.", "author": "jeremyk-91", "createdAt": "2020-06-11T16:51:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc3NjUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4ODU4Ng==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438788586", "bodyText": "As far as I know this state is impossible to be in provided you have a quorum nodes, and therefore I don't believe is a legitimate concern.\nThe primary goal of this method in my opinion (and we should directly document this in the javadoc is):\n\nbackoff doing schema mutations if the cluster is known to be in disagreement currently\n\nI think this is just sensible and a natural thing to do, but admit given recent (read: when we did all the rescue restore optimization work) schema optimization work in our fork that this is less of a concern\n\n\ndon't do a schema mutation if it can potentially result in \"split-brain\" (from the schema's point of view) in the future\n\nThe code as written in this PR allows for the case that we 1 out of 3 nodes are online, we push a schema mutation to that node. That node goes down, two other nodes come online, a schema mutation is pushed to those two nodes (whether by us or by another atlasdb client). The original node comes online, the nodes are in disagreement. While cassandra in theory should handle this case fine, the more divergent the schemas get the harder it will be for it to rectify them. Additionally there is the nuance/complexity around each different version of the schema having matching new pieces (like same keyspace/table name), but with a different cf_id. While I believe we've resolved this via deterministic cf_ids its worth pointing out that for that case, we would treat the situation as an outage and require manual intervention. We can prevent all the risks of the \"split-brain\" case here, by ensuring we only apply changes when we believe a majority of nodes are going to receive. From a maintain \"HA\" perspective this should be fine: see my next bullet.\n\n\nschema mutations are HA\n\nWe want to make sure critical path operations in AtlasDb are HA. We believe modifying a schema to be one of those things and thus it should be HA. That being said the rest of the critical path operations in AtlasDb, even when HA, have limitations to their availability. The most obvious of which are basic reads/writes to cassandra: they require quorum. Given the way we deploy cassandra (network topology aware RF=3), at any given moment [in the best case] if we have more than a third of the nodes of the cluster offline we have lost availability and can no longer read/write. Because of this I do not view being able to do a schema mutation where less than 2/3 of the nodes of the cluster are online as necessary.", "author": "tpetracca", "createdAt": "2020-06-11T13:38:14Z", "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraKeyValueServices.java", "diffHunk": "@@ -88,19 +88,18 @@ static void waitForSchemaVersions(\n         long sleepTime = INITIAL_SLEEP_TIME;\n         Map<String, List<String>> versions;\n         do {\n-            // This only returns the schema versions of nodes that the client knows exist. In particular, if a node we\n-            // shook hands with goes down, it will have schema version UNREACHABLE; however, if we never shook hands\n-            // with a node, there will simply be no entry for it in the map. Hence the check for the number of nodes.\n+            // This may only include some of the nodes if the coordinator hasn't shaken hands with someone; however,", "originalCommit": "44cdd512c73db8afebec8b97ae34d14dd4d1fe75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwNjM0MA==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438806340", "bodyText": "Given my statements above, even if there was a fear that describe_schema_versions() might not return a node that is freshly bootstrapping/about-to-bootstrap (which we only have at most 1 of at a time), we could set the requirement to simple-majority i.e. floor(N/2)+1 rather than quorum (which is actually hard to accurately calculate in terms of raw numbers but is a stricter requirement to meet than simple-majority).", "author": "tpetracca", "createdAt": "2020-06-11T13:56:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4ODU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5MjMyNw==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438892327", "bodyText": "Yep, I'll change this to require a simple-majority. I'll push that first, and then look at the docs/reorganisation of the code here.", "author": "jeremyk-91", "createdAt": "2020-06-11T15:51:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4ODU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0NTM0MQ==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438945341", "bodyText": "(Added the docs now.)", "author": "jeremyk-91", "createdAt": "2020-06-11T17:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4ODU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5Mjg5MQ==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438792891", "bodyText": "all of the error message stuff below should talk about the cluster as being in terms of node returned in the describe_schema_versions() call above (regardless of if they're unreachable or not). none of it should use config.servers() as that isn't correct and also just isn't even how the checks of the rest of the method are done anymore.", "author": "tpetracca", "createdAt": "2020-06-11T13:42:50Z", "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraKeyValueServices.java", "diffHunk": "@@ -88,19 +88,18 @@ static void waitForSchemaVersions(\n         long sleepTime = INITIAL_SLEEP_TIME;\n         Map<String, List<String>> versions;\n         do {\n-            // This only returns the schema versions of nodes that the client knows exist. In particular, if a node we\n-            // shook hands with goes down, it will have schema version UNREACHABLE; however, if we never shook hands\n-            // with a node, there will simply be no entry for it in the map. Hence the check for the number of nodes.\n+            // This may only include some of the nodes if the coordinator hasn't shaken hands with someone; however,\n+            // this existed largely as a defense against performance issues with concurrent schema modifications.\n             versions = client.describe_schema_versions();\n-            if (uniqueSchemaWithQuorumAgreementAndOtherNodesUnreachable(config, versions)) {\n+            if (reachablePartOfClusterHasConsistentSchemaVersions(versions)) {\n                 return;\n             }\n             sleepTime = sleepAndGetNextBackoffTime(sleepTime);\n         } while (System.currentTimeMillis() < start + config.schemaMutationTimeoutMillis());\n \n         StringBuilder schemaVersions = new StringBuilder();\n         for (Entry<String, List<String>> version : versions.entrySet()) {\n-            schemaVersions = addNodeInformation(schemaVersions,\n+            addNodeInformation(schemaVersions,\n                     String.format(\"%nAt schema version %s:\", version.getKey()),\n                     version.getValue());\n         }", "originalCommit": "44cdd512c73db8afebec8b97ae34d14dd4d1fe75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkyNTgzNw==", "url": "https://github.com/palantir/atlasdb/pull/4831#discussion_r438925837", "bodyText": "Yep, now updated to refer to the output returned from the describe_schema_versions call", "author": "jeremyk-91", "createdAt": "2020-06-11T16:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5Mjg5MQ=="}], "type": "inlineReview"}, {"oid": "860c5603bc8e8fde0913c47c46fcbc5f3bb1d971", "url": "https://github.com/palantir/atlasdb/commit/860c5603bc8e8fde0913c47c46fcbc5f3bb1d971", "message": "Fail on a quorum of unreachables", "committedDate": "2020-06-11T15:52:18Z", "type": "commit"}, {"oid": "5be4ae540589372e3dc9fdbf1501a918045b5d5c", "url": "https://github.com/palantir/atlasdb/commit/5be4ae540589372e3dc9fdbf1501a918045b5d5c", "message": "Update tests", "committedDate": "2020-06-11T16:25:00Z", "type": "commit"}, {"oid": "ec1b83f08c3a53536de763cfce4d98078613b1ea", "url": "https://github.com/palantir/atlasdb/commit/ec1b83f08c3a53536de763cfce4d98078613b1ea", "message": "Don't pass config directly into waitForSchemaVersions", "committedDate": "2020-06-11T16:51:26Z", "type": "commit"}, {"oid": "3c4b84804b8d334e4f755f271486b557383e4671", "url": "https://github.com/palantir/atlasdb/commit/3c4b84804b8d334e4f755f271486b557383e4671", "message": "waitForSchemaVersions docs", "committedDate": "2020-06-11T17:19:00Z", "type": "commit"}, {"oid": "3edd34f539b1c4e75ef21e134f74e3c14fc6dcb8", "url": "https://github.com/palantir/atlasdb/commit/3edd34f539b1c4e75ef21e134f74e3c14fc6dcb8", "message": "Add generated changelog entries", "committedDate": "2020-06-11T17:19:00Z", "type": "commit"}, {"oid": "c799442df7dae05f82718cc11421d68cd5b335f4", "url": "https://github.com/palantir/atlasdb/commit/c799442df7dae05f82718cc11421d68cd5b335f4", "message": "Remove suspect test", "committedDate": "2020-06-11T17:22:15Z", "type": "commit"}, {"oid": "37fe7f5777d8f63a3118f66f3f3fa39102704aff", "url": "https://github.com/palantir/atlasdb/commit/37fe7f5777d8f63a3118f66f3f3fa39102704aff", "message": "Merge branch 'jkong/cassandra' of github.com:palantir/atlasdb into jkong/cassandra", "committedDate": "2020-06-11T17:22:30Z", "type": "commit"}, {"oid": "a7443d081095ff382239e9db7339c0db1fd9544b", "url": "https://github.com/palantir/atlasdb/commit/a7443d081095ff382239e9db7339c0db1fd9544b", "message": "rename test", "committedDate": "2020-06-11T17:23:43Z", "type": "commit"}, {"oid": "046a2aecb947cb182e8bf6eddf13c0eb9c88fada", "url": "https://github.com/palantir/atlasdb/commit/046a2aecb947cb182e8bf6eddf13c0eb9c88fada", "message": "imports", "committedDate": "2020-06-12T15:41:54Z", "type": "commit"}]}