{"pr_number": 4836, "pr_title": "[PD$-110002] Part 1: Targeted Sweep Metrics, Configurable By Strategy", "pr_createdAt": "2020-06-15T17:03:27Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4836", "timeline": [{"oid": "812aa230acb64533e12d4f2900dcb3fd78932ea6", "url": "https://github.com/palantir/atlasdb/commit/812aa230acb64533e12d4f2900dcb3fd78932ea6", "message": "transactionsReadFromDb", "committedDate": "2020-06-12T16:00:42Z", "type": "commit"}, {"oid": "e67624128278d1dd4bdbb850a0114f6d23ce937b", "url": "https://github.com/palantir/atlasdb/commit/e67624128278d1dd4bdbb850a0114f6d23ce937b", "message": "Pass in which metrics to use", "committedDate": "2020-06-15T16:09:06Z", "type": "commit"}, {"oid": "915ccd7c7c7a40178ff08cbb037c7fee9a0b6b56", "url": "https://github.com/palantir/atlasdb/commit/915ccd7c7c7a40178ff08cbb037c7fee9a0b6b56", "message": "Fix tests", "committedDate": "2020-06-15T16:27:44Z", "type": "commit"}, {"oid": "9db6f15ad0eb4a7f7610b204f5f73c2af0bd9963", "url": "https://github.com/palantir/atlasdb/commit/9db6f15ad0eb4a7f7610b204f5f73c2af0bd9963", "message": "configurability", "committedDate": "2020-06-15T16:35:17Z", "type": "commit"}, {"oid": "ed2d5e35f4792ac4f7fffdf9a21aafd2f660cc8c", "url": "https://github.com/palantir/atlasdb/commit/ed2d5e35f4792ac4f7fffdf9a21aafd2f660cc8c", "message": "Tests", "committedDate": "2020-06-15T16:51:35Z", "type": "commit"}, {"oid": "baea9a5cbd1bc6ee46b13ddc05ef40f310c67f29", "url": "https://github.com/palantir/atlasdb/commit/baea9a5cbd1bc6ee46b13ddc05ef40f310c67f29", "message": "bits and bobs", "committedDate": "2020-06-15T17:05:08Z", "type": "commit"}, {"oid": "bef637fd3c57b1f3304333b1c52895dc488a9f5c", "url": "https://github.com/palantir/atlasdb/commit/bef637fd3c57b1f3304333b1c52895dc488a9f5c", "message": "Add generated changelog entries", "committedDate": "2020-06-15T17:05:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1MzkwOQ==", "url": "https://github.com/palantir/atlasdb/pull/4836#discussion_r440853909", "bodyText": "Why did we switch to counter?", "author": "sudiksha27", "createdAt": "2020-06-16T13:35:00Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -2234,7 +2234,7 @@ private String getStartTimestampAsClientDescription(TransactionConfig currentTra\n             logLargeNumberOfTransactions(tableRef, gets);\n         }\n \n-        getHistogram(AtlasDbMetricNames.NUMBER_OF_TRANSACTIONS_READ_FROM_DB, tableRef).update(gets.size());\n+        getCounter(AtlasDbMetricNames.NUMBER_OF_TRANSACTIONS_READ_FROM_DB, tableRef).inc(gets.size());\n ", "originalCommit": "bef637fd3c57b1f3304333b1c52895dc488a9f5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkxMTg0NA==", "url": "https://github.com/palantir/atlasdb/pull/4836#discussion_r440911844", "bodyText": "Good catch! This was supposed to be in #4838, not here. I'll remove this", "author": "jeremyk-91", "createdAt": "2020-06-16T14:50:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1MzkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5OTQ1MQ==", "url": "https://github.com/palantir/atlasdb/pull/4836#discussion_r440899451", "bodyText": "\ud83d\udc4d", "author": "sudiksha27", "createdAt": "2020-06-16T14:34:16Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/sweep/metrics/TargetedSweepMetrics.java", "diffHunk": "@@ -76,49 +100,65 @@ private static long getMillisForTimestampBoundedAtOneWeek(KeyValueService kvs, l\n     }\n \n     public void updateEnqueuedWrites(ShardAndStrategy shardStrategy, long writes) {\n-        getMetrics(shardStrategy).updateEnqueuedWrites(writes);\n+        updateMetricsIfPresent(shardStrategy, metrics -> metrics.updateEnqueuedWrites(writes));\n     }\n \n-    public void updateEntriesRead(ShardAndStrategy shardStrategy, long writes) {\n-        getMetrics(shardStrategy).updateEntriesRead(writes);\n+    public void updateEntriesRead(ShardAndStrategy shardStrategy, long reads) {\n+        updateMetricsIfPresent(shardStrategy, metrics -> metrics.updateEntriesRead(reads));\n     }\n \n     public void updateNumberOfTombstones(ShardAndStrategy shardStrategy, long tombstones) {\n-        getMetrics(shardStrategy).updateNumberOfTombstones(tombstones);\n+        updateMetricsIfPresent(shardStrategy, metrics -> metrics.updateNumberOfTombstones(tombstones));\n     }\n \n     public void updateAbortedWritesDeleted(ShardAndStrategy shardStrategy, long deletes) {\n-        getMetrics(shardStrategy).updateAbortedWritesDeleted(deletes);\n+        updateMetricsIfPresent(shardStrategy, metrics -> metrics.updateAbortedWritesDeleted(deletes));\n     }\n \n     public void updateSweepTimestamp(ShardAndStrategy shardStrategy, long value) {\n-        getMetrics(shardStrategy).updateSweepTimestamp(value);\n+        updateMetricsIfPresent(shardStrategy, metrics -> metrics.updateSweepTimestamp(value));\n     }\n \n     public void updateProgressForShard(ShardAndStrategy shardStrategy, long lastSweptTs) {\n-        getMetrics(shardStrategy).updateProgressForShard(shardStrategy.shard(), lastSweptTs);\n+        updateMetricsIfPresent(\n+                shardStrategy, metrics -> metrics.updateProgressForShard(shardStrategy.shard(), lastSweptTs));\n     }\n \n     public void registerOccurrenceOf(ShardAndStrategy shardStrategy, SweepOutcome outcome) {\n-        registerOccurrenceOf(shardStrategy.strategy(), outcome);\n+        updateMetricsIfPresent(shardStrategy, metrics -> metrics.registerOccurrenceOf(outcome));\n     }\n \n     public void registerOccurrenceOf(SweeperStrategy strategy, SweepOutcome outcome) {\n-        getMetrics(strategy).registerOccurrenceOf(outcome);\n+        updateMetricsIfPresent(strategy, metrics -> metrics.registerOccurrenceOf(outcome));\n     }\n \n     public void registerEntriesReadInBatch(ShardAndStrategy shardStrategy, long batchSize) {\n-        getMetrics(shardStrategy).registerEntriesReadInBatch(batchSize);\n+        updateMetricsIfPresent(shardStrategy, metrics -> metrics.registerEntriesReadInBatch(batchSize));\n     }\n \n-    private MetricsForStrategy getMetrics(ShardAndStrategy shardStrategy) {\n-        return getMetrics(shardStrategy.strategy());\n+    private void updateMetricsIfPresent(ShardAndStrategy shardStrategy, Consumer<MetricsForStrategy> update) {\n+        updateMetricsIfPresent(shardStrategy.strategy(), update);\n+    }\n+\n+    private void updateMetricsIfPresent(SweeperStrategy strategy, Consumer<MetricsForStrategy> update) {\n+        Optional.ofNullable(getMetrics(strategy)).ifPresent(update);\n     }", "originalCommit": "bef637fd3c57b1f3304333b1c52895dc488a9f5c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ec9e335f44faf0affb0d7544dbf28d33e0016b1", "url": "https://github.com/palantir/atlasdb/commit/1ec9e335f44faf0affb0d7544dbf28d33e0016b1", "message": "bad separation", "committedDate": "2020-06-16T14:50:57Z", "type": "commit"}, {"oid": "f4fc63718b0166a9663ff16328f002b12a4e8465", "url": "https://github.com/palantir/atlasdb/commit/f4fc63718b0166a9663ff16328f002b12a4e8465", "message": "histos", "committedDate": "2020-06-16T14:55:30Z", "type": "commit"}]}