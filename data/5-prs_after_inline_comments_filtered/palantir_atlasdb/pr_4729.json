{"pr_number": 4729, "pr_title": "[PaxosLog] Use JDBI and add namespacing", "pr_createdAt": "2020-04-22T15:59:52Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4729", "timeline": [{"oid": "93c165dda003aedd212a3e6fbc6e26e075dbea87", "url": "https://github.com/palantir/atlasdb/commit/93c165dda003aedd212a3e6fbc6e26e075dbea87", "message": "Use JDBI", "committedDate": "2020-04-22T15:53:59Z", "type": "commit"}, {"oid": "2dadde4e2d42e9f5c256e783ab06b2a4fd3407b4", "url": "https://github.com/palantir/atlasdb/commit/2dadde4e2d42e9f5c256e783ab06b2a4fd3407b4", "message": "Package private", "committedDate": "2020-04-22T15:59:19Z", "type": "commit"}, {"oid": "521a3eec0ba99a626c2e899e44336d60e07234cb", "url": "https://github.com/palantir/atlasdb/commit/521a3eec0ba99a626c2e899e44336d60e07234cb", "message": "Prevent test connection from closing so we don't need to have funky factory in production code", "committedDate": "2020-04-23T11:28:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc3ODg0OQ==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r413778849", "bodyText": "We talked offline so I know why this is needed, but probably best to document that.", "author": "jeremyk-91", "createdAt": "2020-04-23T12:37:21Z", "path": "leader-election-impl/src/test/java/com/palantir/paxos/SqlitePaxosStateLogTest.java", "diffHunk": "@@ -102,4 +127,34 @@ private static PaxosValue valueForRound(long round) {\n         ThreadLocalRandom.current().nextBytes(bytes);\n         return new PaxosValue(\"someLeader\", round, bytes);\n     }\n+\n+    private static Supplier<Connection> createReusableMemoizedConnection() {\n+        Supplier<Connection> baseConnectionSupplier = SqliteConnections.createDatabaseForTest();\n+        Supplier<Connection> nonClosingConnectionSupplier = bypassCloseOnConnection(baseConnectionSupplier);\n+        return Suppliers.memoize(nonClosingConnectionSupplier::get);\n+    }\n+\n+    private static Supplier<Connection> bypassCloseOnConnection(Supplier<Connection> connectionSupplier) {\n+        return Suppliers.compose(conn ->\n+                        (Connection) Proxy.newProxyInstance(Connection.class.getClassLoader(),\n+                                new Class<?>[] {Connection.class},\n+                                new CloseIgnoringInvocationHandler(conn)),\n+                connectionSupplier::get);\n+    }\n+\n+    private static final class CloseIgnoringInvocationHandler extends AbstractInvocationHandler {", "originalCommit": "521a3eec0ba99a626c2e899e44336d60e07234cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc3OTE3Mw==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r413779173", "bodyText": "nit: standardise x vs dao", "author": "jeremyk-91", "createdAt": "2020-04-23T12:37:54Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -16,105 +16,89 @@\n \n package com.palantir.paxos;\n \n-import java.io.IOException;\n import java.sql.Connection;\n-import java.sql.PreparedStatement;\n-import java.sql.ResultSet;\n-import java.sql.SQLException;\n-import java.util.Optional;\n+import java.util.OptionalLong;\n+import java.util.function.Function;\n import java.util.function.Supplier;\n \n-import com.google.common.io.ByteStreams;\n-import com.palantir.common.base.Throwables;\n+import org.jdbi.v3.core.Jdbi;\n+import org.jdbi.v3.sqlobject.SingleValue;\n+import org.jdbi.v3.sqlobject.SqlObjectPlugin;\n+import org.jdbi.v3.sqlobject.customizer.Bind;\n+import org.jdbi.v3.sqlobject.customizer.Define;\n+import org.jdbi.v3.sqlobject.statement.SqlQuery;\n+import org.jdbi.v3.sqlobject.statement.SqlUpdate;\n+\n import com.palantir.common.persist.Persistable;\n \n public final class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n-    private final Supplier<Connection> connectionSupplier;\n+    private final String namespace;\n+    private final Jdbi jdbi;\n \n-    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {\n-        this.connectionSupplier = connectionSupplier;\n+    private SqlitePaxosStateLog(String namespace, Jdbi jdbi) {\n+        this.namespace = namespace;\n+        this.jdbi = jdbi;\n     }\n \n-    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(Supplier<Connection> conn) {\n-        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(conn);\n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> create(String namespace,\n+            Supplier<Connection> connectionSupplier) {\n+        Jdbi jdbi = Jdbi.create(connectionSupplier::get).installPlugin(new SqlObjectPlugin());\n+        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(namespace, jdbi);\n         log.initialize();\n         return log;\n     }\n \n     private void initialize() {\n-        executeVoid(\"CREATE TABLE IF NOT EXISTS paxosLog (seq BIGINT, val BLOB, CONSTRAINT pk_dual PRIMARY KEY (seq))\");\n+        execute(dao -> dao.createTable(namespace));\n     }\n \n     @Override\n     public void writeRound(long seq, V round) {\n-        try {\n-            PreparedStatement preparedStatement = connectionSupplier.get().prepareStatement(\n-                    \"INSERT OR REPLACE INTO paxosLog (seq, val) VALUES (?, ?)\");\n-            preparedStatement.setLong(1, seq);\n-            preparedStatement.setBytes(2, round.persistToBytes());\n-            preparedStatement.execute();\n-        } catch (SQLException e) {\n-            throw Throwables.rewrapAndThrowUncheckedException(e);\n-        }\n+        execute(dao -> dao.writeRound(namespace, seq, round.persistToBytes()));\n     }\n \n     @Override\n     public byte[] readRound(long seq) {\n-        return executeStatement(String.format(\"SELECT val FROM paxosLog WHERE seq = %s\", seq))\n-                .map(SqlitePaxosStateLog::getByteArrayUnchecked)\n-                .orElse(null);\n+        return execute(dao -> dao.readRound(namespace, seq));\n     }\n \n     @Override\n     public long getLeastLogEntry() {\n-        return executeStatement(\"SELECT MIN(seq) FROM paxosLog\")\n-                .map(SqlitePaxosStateLog::getLongResultUnchecked)\n-                .orElse(PaxosAcceptor.NO_LOG_ENTRY);\n+        return execute(x -> x.getLeastLogEntry(namespace)).orElse(PaxosAcceptor.NO_LOG_ENTRY);\n     }\n \n     @Override\n     public long getGreatestLogEntry() {\n-        return executeStatement(\"SELECT MAX(seq) FROM paxosLog\")\n-                .map(SqlitePaxosStateLog::getLongResultUnchecked)\n-                .orElse(PaxosAcceptor.NO_LOG_ENTRY);\n+        return execute(x -> x.getGreatestLogEntry(namespace)).orElse(PaxosAcceptor.NO_LOG_ENTRY);", "originalCommit": "521a3eec0ba99a626c2e899e44336d60e07234cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b88059c5da41ac7d6d1f7657e564786298ca8c80", "url": "https://github.com/palantir/atlasdb/commit/b88059c5da41ac7d6d1f7657e564786298ca8c80", "message": "Address CR", "committedDate": "2020-04-23T15:35:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4NTI4NQ==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r414485285", "bodyText": "Is there a validation/parsing of the namespace somewhere in timelock? I wonder what restrictions sqllite places on table names.", "author": "jkozlowski", "createdAt": "2020-04-24T10:56:32Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -16,105 +16,89 @@\n \n package com.palantir.paxos;\n \n-import java.io.IOException;\n import java.sql.Connection;\n-import java.sql.PreparedStatement;\n-import java.sql.ResultSet;\n-import java.sql.SQLException;\n-import java.util.Optional;\n+import java.util.OptionalLong;\n+import java.util.function.Function;\n import java.util.function.Supplier;\n \n-import com.google.common.io.ByteStreams;\n-import com.palantir.common.base.Throwables;\n+import org.jdbi.v3.core.Jdbi;\n+import org.jdbi.v3.sqlobject.SingleValue;\n+import org.jdbi.v3.sqlobject.SqlObjectPlugin;\n+import org.jdbi.v3.sqlobject.customizer.Bind;\n+import org.jdbi.v3.sqlobject.customizer.Define;\n+import org.jdbi.v3.sqlobject.statement.SqlQuery;\n+import org.jdbi.v3.sqlobject.statement.SqlUpdate;\n+\n import com.palantir.common.persist.Persistable;\n \n public final class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n-    private final Supplier<Connection> connectionSupplier;\n+    private final String namespace;", "originalCommit": "b88059c5da41ac7d6d1f7657e564786298ca8c80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU0NjMzMg==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r414546332", "bodyText": "Yeah, we have to pass in a valid namespace which we take care of elsewhere", "author": "gmaretic", "createdAt": "2020-04-24T12:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4NTI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3OTU0NQ==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r414579545", "bodyText": "What about sqlite restrictions? are all namespaces valid for sqlite tables?", "author": "jkozlowski", "createdAt": "2020-04-24T13:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4NTI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYwNTQyNQ==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r414605425", "bodyText": "Can we have a Namespace wrapper type? so that the validation done is clear here?", "author": "jkozlowski", "createdAt": "2020-04-24T14:09:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4NTI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4NTUyNg==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r414485526", "bodyText": "Do we need some sort of try-catch here in case log.initialize fails later?", "author": "jkozlowski", "createdAt": "2020-04-24T10:57:00Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -16,105 +16,89 @@\n \n package com.palantir.paxos;\n \n-import java.io.IOException;\n import java.sql.Connection;\n-import java.sql.PreparedStatement;\n-import java.sql.ResultSet;\n-import java.sql.SQLException;\n-import java.util.Optional;\n+import java.util.OptionalLong;\n+import java.util.function.Function;\n import java.util.function.Supplier;\n \n-import com.google.common.io.ByteStreams;\n-import com.palantir.common.base.Throwables;\n+import org.jdbi.v3.core.Jdbi;\n+import org.jdbi.v3.sqlobject.SingleValue;\n+import org.jdbi.v3.sqlobject.SqlObjectPlugin;\n+import org.jdbi.v3.sqlobject.customizer.Bind;\n+import org.jdbi.v3.sqlobject.customizer.Define;\n+import org.jdbi.v3.sqlobject.statement.SqlQuery;\n+import org.jdbi.v3.sqlobject.statement.SqlUpdate;\n+\n import com.palantir.common.persist.Persistable;\n \n public final class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n-    private final Supplier<Connection> connectionSupplier;\n+    private final String namespace;\n+    private final Jdbi jdbi;\n \n-    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {\n-        this.connectionSupplier = connectionSupplier;\n+    private SqlitePaxosStateLog(String namespace, Jdbi jdbi) {\n+        this.namespace = namespace;\n+        this.jdbi = jdbi;\n     }\n \n-    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(Supplier<Connection> conn) {\n-        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(conn);\n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> create(String namespace,\n+            Supplier<Connection> connectionSupplier) {\n+        Jdbi jdbi = Jdbi.create(connectionSupplier::get).installPlugin(new SqlObjectPlugin());", "originalCommit": "b88059c5da41ac7d6d1f7657e564786298ca8c80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUzOTcxMA==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r414539710", "bodyText": "No, this does not take up any resources that need to be cleaned up later", "author": "gmaretic", "createdAt": "2020-04-24T12:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4NTUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MDE3Mg==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r414490172", "bodyText": "Is there no way to amend this behavior? How about SQLiteDataSource, does that do it better? And then also SQLiteConnectionPoolDataSource,", "author": "jkozlowski", "createdAt": "2020-04-24T11:05:46Z", "path": "leader-election-impl/src/test/java/com/palantir/paxos/SqlitePaxosStateLogTest.java", "diffHunk": "@@ -102,4 +127,39 @@ private static PaxosValue valueForRound(long round) {\n         ThreadLocalRandom.current().nextBytes(bytes);\n         return new PaxosValue(\"someLeader\", round, bytes);\n     }\n+\n+    private static Supplier<Connection> createReusableMemoizedConnection() {\n+        Supplier<Connection> baseConnectionSupplier = SqliteConnections.createDatabaseForTest();\n+        Supplier<Connection> nonClosingConnectionSupplier = bypassCloseOnConnection(baseConnectionSupplier);\n+        return Suppliers.memoize(nonClosingConnectionSupplier::get);\n+    }\n+\n+    private static Supplier<Connection> bypassCloseOnConnection(Supplier<Connection> connectionSupplier) {\n+        return Suppliers.compose(conn ->\n+                        (Connection) Proxy.newProxyInstance(Connection.class.getClassLoader(),\n+                                new Class<?>[] {Connection.class},\n+                                new CloseIgnoringInvocationHandler(conn)),\n+                connectionSupplier::get);\n+    }\n+\n+    /**\n+     * JDBI closes the connection after executing a query. This is desired behaviour, but does not play nicely with in", "originalCommit": "b88059c5da41ac7d6d1f7657e564786298ca8c80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUwNDQ5MQ==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r414504491", "bodyText": "Or how about we use the disk in tests too? Shouldn't really be a problem I suspect? We can give it temp directories", "author": "jkozlowski", "createdAt": "2020-04-24T11:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MDE3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU0NTk5Mw==", "url": "https://github.com/palantir/atlasdb/pull/4729#discussion_r414545993", "bodyText": "OK, we use disk", "author": "gmaretic", "createdAt": "2020-04-24T12:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MDE3Mg=="}], "type": "inlineReview"}, {"oid": "1df5ae87882aa8f1c7245d29a5431b3d4687d4e2", "url": "https://github.com/palantir/atlasdb/commit/1df5ae87882aa8f1c7245d29a5431b3d4687d4e2", "message": "CR", "committedDate": "2020-04-24T12:45:45Z", "type": "commit"}]}