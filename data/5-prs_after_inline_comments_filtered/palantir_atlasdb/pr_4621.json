{"pr_number": 4621, "pr_title": "Improve observability of DisruptorAutobatcher.", "pr_createdAt": "2020-03-02T11:39:54Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4621", "timeline": [{"oid": "71eeb7a5ff69a546d2bb81e5c39ead22cc8adf94", "url": "https://github.com/palantir/atlasdb/commit/71eeb7a5ff69a546d2bb81e5c39ead22cc8adf94", "message": "Autobatchers can now take safe tags.", "committedDate": "2020-03-02T11:29:36Z", "type": "commit"}, {"oid": "6b935a02b481894d0d36b75da73642a2e7f6b9bc", "url": "https://github.com/palantir/atlasdb/commit/6b935a02b481894d0d36b75da73642a2e7f6b9bc", "message": "Add simple test.", "committedDate": "2020-03-02T11:37:57Z", "type": "commit"}, {"oid": "383bbc93e9dafe4cf02307a0e1b124efea974f32", "url": "https://github.com/palantir/atlasdb/commit/383bbc93e9dafe4cf02307a0e1b124efea974f32", "message": "Bump tracing", "committedDate": "2020-03-02T11:47:29Z", "type": "commit"}, {"oid": "92cace570284da36bb5887e026d54d97f89533a1", "url": "https://github.com/palantir/atlasdb/commit/92cace570284da36bb5887e026d54d97f89533a1", "message": "Add ability to trace autobatchers.", "committedDate": "2020-03-02T11:50:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQxNDE4NA==", "url": "https://github.com/palantir/atlasdb/pull/4621#discussion_r386414184", "bodyText": "I think it would be interesting to test this to make sure that this handler does the right thing (i.e. same behaviour as before except it has the new trace).", "author": "Jolyon-S", "createdAt": "2020-03-02T14:11:38Z", "path": "atlasdb-autobatch/src/main/java/com/palantir/atlasdb/autobatch/Autobatchers.java", "diffHunk": "@@ -98,12 +103,33 @@ private AutobatcherBuilder(Function<Integer, EventHandler<BatchElement<I, O>>> h\n             return this;\n         }\n \n+        public AutobatcherBuilder<I, O> safeTag(String key, String value) {\n+            this.safeTags.put(key, value);\n+            return this;\n+        }\n+\n+        public AutobatcherBuilder<I, O> observability(Observability observabilityParam) {\n+            this.observability = observabilityParam;\n+            return this;\n+        }\n+\n         public DisruptorAutobatcher<I, O> build() {\n             Preconditions.checkArgument(purpose != null, \"purpose must be provided\");\n             EventHandler<BatchElement<I, O>> handler = this.handlerFactory.apply(DEFAULT_BUFFER_SIZE);\n \n+            EventHandler<BatchElement<I, O>> tracingHandler = (event, sequence, endOfBatch) -> {", "originalCommit": "92cace570284da36bb5887e026d54d97f89533a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ0MjM4OQ==", "url": "https://github.com/palantir/atlasdb/pull/4621#discussion_r386442389", "bodyText": "addressed, see new commit.", "author": "felixdesouza", "createdAt": "2020-03-02T14:58:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQxNDE4NA=="}], "type": "inlineReview"}, {"oid": "789db58a653fd9fb22f729e52590e9c465530d8c", "url": "https://github.com/palantir/atlasdb/commit/789db58a653fd9fb22f729e52590e9c465530d8c", "message": "Separate out `TracingEventHandler` and add tests for it.", "committedDate": "2020-03-02T14:57:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ0Njg2OQ==", "url": "https://github.com/palantir/atlasdb/pull/4621#discussion_r386446869", "bodyText": "Could you also add a pass-through test to assert that tracingHandler.onEvent(x,y,z) calls the correct delegate handler?", "author": "Jolyon-S", "createdAt": "2020-03-02T15:05:35Z", "path": "atlasdb-autobatch/src/test/java/com/palantir/atlasdb/autobatch/TracingEventHandlerTest.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.autobatch;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.util.List;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExternalResource;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.util.concurrent.SettableFuture;\n+import com.lmax.disruptor.EventHandler;\n+import com.palantir.tracing.Observability;\n+import com.palantir.tracing.Tracer;\n+import com.palantir.tracing.api.Span;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class TracingEventHandlerTest {\n+\n+    @Rule\n+    public TraceCapturingRule traceRule = new TraceCapturingRule();\n+\n+    @Mock\n+    private EventHandler<BatchElement<Integer, Long>> delegate;\n+\n+    @Test\n+    public void nonFlushesDoNotHaveTraces() throws Exception {\n+        TracingEventHandler<Integer, Long> tracingHandler =\n+                new TracingEventHandler<>(delegate, \"test\", Observability.SAMPLE);\n+\n+        tracingHandler.onEvent(new TestBatchElement(), 45, false);", "originalCommit": "789db58a653fd9fb22f729e52590e9c465530d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ0NzQxMg==", "url": "https://github.com/palantir/atlasdb/pull/4621#discussion_r386447412", "bodyText": "I'll leave the addition of this test at your discretion.", "author": "Jolyon-S", "createdAt": "2020-03-02T15:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ0Njg2OQ=="}], "type": "inlineReview"}, {"oid": "74cd57933d2d663139c0ea8e45de5f70e5a8427b", "url": "https://github.com/palantir/atlasdb/commit/74cd57933d2d663139c0ea8e45de5f70e5a8427b", "message": "Amend current tests to verify that we call the delegate.", "committedDate": "2020-03-02T15:09:54Z", "type": "commit"}, {"oid": "fbd981281c8a4fe1f77d3e90b7c401decbdc4a13", "url": "https://github.com/palantir/atlasdb/commit/fbd981281c8a4fe1f77d3e90b7c401decbdc4a13", "message": "Fix up checkstyle.", "committedDate": "2020-03-02T16:13:47Z", "type": "commit"}]}