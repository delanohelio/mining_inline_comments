{"pr_number": 5025, "pr_title": "[DB TimeLock] 3B.2 - DbTimeLockSingleLeaderPaxosSuite", "pr_createdAt": "2020-10-12T21:32:41Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5025", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1MTEyMA==", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503751120", "bodyText": "I wonder if this the best we can do design wise, I feel like having these layers makes code a bit harder to read.", "author": "sudiksha27", "createdAt": "2020-10-13T08:10:10Z", "path": "timelock-server/src/testCommon/java/com/palantir/atlasdb/timelock/TestableTimelockServerConfiguration.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import org.immutables.value.Value;\n+\n+@Value.Immutable\n+public interface TestableTimelockServerConfiguration {\n+    TemplateVariables templateVariables();\n+\n+    @Value.Default\n+    default boolean needsPostgresDatabase() {\n+        return false;\n+    }\n+}", "originalCommit": "a1ee1ad4bebdb294aa25da807449c5054b8dce07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc5OTY2OA==", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503799668", "bodyText": "What alternatives do you have in mind? The main ones I'm aware of are:\n\npassing a boolean and/or context directly into the testable timelock cluster (also OK with that, though it seems the property of whether you need a postgres is dependent on an individual server's config)\nhaving a template variable that is the yml-serialized form of the database bound persistence (don't like this; the freemarker templates don't natively support structured formats other than xml and html I think)", "author": "jeremyk-91", "createdAt": "2020-10-13T09:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1MTEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MjExMg==", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503872112", "bodyText": "I see, what you have now is fine.", "author": "sudiksha27", "createdAt": "2020-10-13T11:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1MTEyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1OTU5Nw==", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503759597", "bodyText": "I did not understand the comment, could you please elaborate on that.", "author": "sudiksha27", "createdAt": "2020-10-13T08:22:45Z", "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java", "diffHunk": "@@ -469,6 +470,7 @@ private static void assertNumberOfThreadsReasonable(int startingThreads, int thr\n \n     private void abandonLeadershipPaxosModeAgnosticTestIfRunElsewhere() {\n         Assume.assumeTrue(cluster == FIRST_CLUSTER);\n+        Assume.assumeFalse(cluster.isDbTimelock()); // We will never test only DB timelock when releasing.\n     }", "originalCommit": "a1ee1ad4bebdb294aa25da807449c5054b8dce07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgwMDM4MQ==", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503800381", "bodyText": "There are some slow tests that aren't dependent on timestamp bound persistence (check where this is called), and so this skips them when running in a db timelock environment. This is only safe if we are sure it is tested elsewhere (which it is, because we will never test only db timelock when releasing).", "author": "jeremyk-91", "createdAt": "2020-10-13T09:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1OTU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3Mjk5NQ==", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503872995", "bodyText": "Makes sense", "author": "sudiksha27", "createdAt": "2020-10-13T11:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1OTU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2NDAwOQ==", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503764009", "bodyText": "It may be worth extracting out a utility method that takes templateVariables and needsPG as parameters? There is similar code in TestableTimelockCluster.", "author": "sudiksha27", "createdAt": "2020-10-13T08:28:59Z", "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/suite/DbTimeLockSingleLeaderPaxosSuite.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.suite;\n+\n+import static com.palantir.atlasdb.timelock.TemplateVariables.generateThreeNodeTimelockCluster;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+\n+import org.junit.Rule;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import org.junit.runners.Suite;\n+\n+import com.github.peterwippermann.junit4.parameterizedsuite.ParameterizedSuite;\n+import com.google.common.collect.ImmutableSet;\n+import com.palantir.atlasdb.timelock.ImmutableTestableTimelockServerConfiguration;\n+import com.palantir.atlasdb.timelock.MultiNodePaxosTimeLockServerIntegrationTest;\n+import com.palantir.atlasdb.timelock.TemplateVariables;\n+import com.palantir.atlasdb.timelock.TestableTimelockCluster;\n+import com.palantir.atlasdb.timelock.TestableTimelockServerConfiguration;\n+import com.palantir.timelock.config.PaxosInstallConfiguration;\n+\n+@RunWith(ParameterizedSuite.class)\n+@Suite.SuiteClasses(MultiNodePaxosTimeLockServerIntegrationTest.class)\n+public class DbTimeLockSingleLeaderPaxosSuite {\n+    private static final Iterable<TemplateVariables> TEMPLATE_VARIABLES = generateThreeNodeTimelockCluster(\n+            9086,\n+            builder -> builder.clientPaxosBuilder(builder.clientPaxosBuilder()\n+                    .isUseBatchPaxosTimestamp(false)\n+                    .isBatchSingleLeader(true))\n+                    .leaderMode(PaxosInstallConfiguration.PaxosLeaderMode.SINGLE_LEADER));\n+    private static final List<TestableTimelockServerConfiguration> TESTABLE_CONFIGURATIONS = StreamSupport.stream(\n+            TEMPLATE_VARIABLES.spliterator(), false)\n+            .map(variables -> ImmutableTestableTimelockServerConfiguration.builder()\n+                    .templateVariables(variables)\n+                    .needsPostgresDatabase(true)\n+                    .build())\n+            .collect(Collectors.toList());", "originalCommit": "a1ee1ad4bebdb294aa25da807449c5054b8dce07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgwMDUxNA==", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503800514", "bodyText": "Sure, can do", "author": "jeremyk-91", "createdAt": "2020-10-13T09:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2NDAwOQ=="}], "type": "inlineReview"}, {"oid": "02b4d69b2f41c9ce57f8ba8b43a91ea0f30e5aa2", "url": "https://github.com/palantir/atlasdb/commit/02b4d69b2f41c9ce57f8ba8b43a91ea0f30e5aa2", "message": "baseline", "committedDate": "2020-10-13T14:42:05Z", "type": "forcePushed"}, {"oid": "a3b1d3aec0e6231a2202b39ed718e2c057fb7f25", "url": "https://github.com/palantir/atlasdb/commit/a3b1d3aec0e6231a2202b39ed718e2c057fb7f25", "message": " blah39g40 3v1j24 g213", "committedDate": "2020-10-14T13:54:54Z", "type": "commit"}, {"oid": "4b7468894c3164fc4c9ddf825392c51dd466fa00", "url": "https://github.com/palantir/atlasdb/commit/4b7468894c3164fc4c9ddf825392c51dd466fa00", "message": "Reset to batched timestamp paxos", "committedDate": "2020-10-14T13:54:54Z", "type": "commit"}, {"oid": "67d16f67828a1112da030df0bb1419f9b6d87317", "url": "https://github.com/palantir/atlasdb/commit/67d16f67828a1112da030df0bb1419f9b6d87317", "message": "meep", "committedDate": "2020-10-14T13:54:54Z", "type": "commit"}, {"oid": "c6a3570952ef65b02c27d09cf9189de1e3e3dc3f", "url": "https://github.com/palantir/atlasdb/commit/c6a3570952ef65b02c27d09cf9189de1e3e3dc3f", "message": "baslein", "committedDate": "2020-10-14T13:54:54Z", "type": "commit"}, {"oid": "6872e91a61aa0b9d7659d657e3a025fe4d8daaa2", "url": "https://github.com/palantir/atlasdb/commit/6872e91a61aa0b9d7659d657e3a025fe4d8daaa2", "message": "Immutables switch", "committedDate": "2020-10-14T13:54:54Z", "type": "commit"}, {"oid": "9e53173d6ebb34e8463a0d2ecb30128524e0d49f", "url": "https://github.com/palantir/atlasdb/commit/9e53173d6ebb34e8463a0d2ecb30128524e0d49f", "message": "baseline", "committedDate": "2020-10-14T13:54:54Z", "type": "commit"}, {"oid": "4faa8e894997cfd6866c6df5c4b8ce6b920d7d48", "url": "https://github.com/palantir/atlasdb/commit/4faa8e894997cfd6866c6df5c4b8ce6b920d7d48", "message": "fix", "committedDate": "2020-10-14T13:55:05Z", "type": "commit"}, {"oid": "4faa8e894997cfd6866c6df5c4b8ce6b920d7d48", "url": "https://github.com/palantir/atlasdb/commit/4faa8e894997cfd6866c6df5c4b8ce6b920d7d48", "message": "fix", "committedDate": "2020-10-14T13:55:05Z", "type": "forcePushed"}]}