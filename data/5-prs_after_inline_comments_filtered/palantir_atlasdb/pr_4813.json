{"pr_number": 4813, "pr_title": "[PaxosStateLog] Migrate", "pr_createdAt": "2020-05-28T22:40:36Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4813", "timeline": [{"oid": "1e2f439b65aaad106ea7faa95450067d77627468", "url": "https://github.com/palantir/atlasdb/commit/1e2f439b65aaad106ea7faa95450067d77627468", "message": "Run migration eagerly", "committedDate": "2020-05-21T15:14:39Z", "type": "commit"}, {"oid": "45b1555bdb9d8ade325d4bb79820d01c6f3c1d17", "url": "https://github.com/palantir/atlasdb/commit/45b1555bdb9d8ade325d4bb79820d01c6f3c1d17", "message": "Merge with develop", "committedDate": "2020-05-28T15:34:14Z", "type": "commit"}, {"oid": "2708df366750a35429a18ff4def8e8db6b102f4a", "url": "https://github.com/palantir/atlasdb/commit/2708df366750a35429a18ff4def8e8db6b102f4a", "message": "Wire everything and improve integration tests", "committedDate": "2020-05-28T22:28:05Z", "type": "commit"}, {"oid": "fb84ddace59993cad7fc1f41e84cb1fa5a072bff", "url": "https://github.com/palantir/atlasdb/commit/fb84ddace59993cad7fc1f41e84cb1fa5a072bff", "message": "Remove now unused verifying paxos state log", "committedDate": "2020-05-28T22:39:12Z", "type": "commit"}, {"oid": "d8411a33d291e608425c46d0637c6ccd764c16eb", "url": "https://github.com/palantir/atlasdb/commit/d8411a33d291e608425c46d0637c6ccd764c16eb", "message": "Add generated changelog entries", "committedDate": "2020-05-28T22:39:12Z", "type": "commit"}, {"oid": "49a18d7403c127df48ff7f610a40c5558e0ef8cf", "url": "https://github.com/palantir/atlasdb/commit/49a18d7403c127df48ff7f610a40c5558e0ef8cf", "message": "Bleh", "committedDate": "2020-05-28T23:11:31Z", "type": "commit"}, {"oid": "10a70456269f1732c719983c238e8e12490da007", "url": "https://github.com/palantir/atlasdb/commit/10a70456269f1732c719983c238e8e12490da007", "message": "Merge branch 'psl/blocking-migration' of github.com:palantir/atlasdb into psl/blocking-migration", "committedDate": "2020-05-28T23:11:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMxNDIyNQ==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432314225", "bodyText": "OK. We'll need a piece that blocks startup until this is called for all namespaces (but I guess you've handled that elsewhere)", "author": "jeremyk-91", "createdAt": "2020-05-29T07:50:08Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/SplittingPaxosStateLog.java", "diffHunk": "@@ -62,12 +67,47 @@ private SplittingPaxosStateLog(PaxosStateLog<V> legacyLog,\n         return new SplittingPaxosStateLog<>(\n                 parameters.legacyLog(),\n                 parameters.currentLog(),\n-                parameters.markLegacyWrite(),\n-                parameters.markLegacyRead(),\n+                parameters.legacyOperationMarkers().markLegacyWrite(),\n+                parameters.legacyOperationMarkers().markLegacyRead(),\n                 parameters.cutoffInclusive(),\n                 new AtomicLong(parameters.legacyLog().getLeastLogEntry()));\n     }\n \n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> createWithMigration(\n+            PaxosStorageParameters params,\n+            Persistable.Hydrator<V> hydrator,\n+            LegacyOperationMarkers legacyOperationMarkers,\n+            OptionalLong migrateFrom) {\n+        String logDirectory = params.fileBasedLogDirectory()\n+                .orElseThrow(() -> new SafeIllegalStateException(\"We currently need to have file-based storage\"));\n+        NamespaceAndUseCase namespaceUseCase = params.namespaceAndUseCase();\n+\n+        PaxosStateLogMigrator.MigrationContext<V> migrationContext = ImmutableMigrationContext.<V>builder()\n+                .sourceLog(new PaxosStateLogImpl<>(logDirectory))\n+                .destinationLog(SqlitePaxosStateLog.create(namespaceUseCase, params.sqliteDataSource()))\n+                .hydrator(hydrator)\n+                .migrationState(SqlitePaxosStateLogMigrationState.create(namespaceUseCase, params.sqliteDataSource()))\n+                .migrateFrom(migrateFrom)\n+                .build();\n+\n+        Instant start = Instant.now();\n+        log.info(\"Starting migration for namespace and use case {}.\",\n+                SafeArg.of(\"namespaceAndUseCase\", params.namespaceAndUseCase()));\n+        long cutoff = PaxosStateLogMigrator.migrateAndReturnCutoff(migrationContext);\n+        log.info(\"Migration for namespace and use case {} took {}.\",\n+                SafeArg.of(\"namespaceAndUseCase\", params.namespaceAndUseCase()),\n+                SafeArg.of(\"duration\", Duration.between(start, Instant.now())));\n+\n+        SplittingParameters<V> splittingParameters = ImmutableSplittingParameters.<V>builder()\n+                .legacyLog(migrationContext.sourceLog())\n+                .currentLog(migrationContext.destinationLog())\n+                .cutoffInclusive(cutoff)\n+                .legacyOperationMarkers(legacyOperationMarkers)\n+                .build();\n+\n+        return SplittingPaxosStateLog.create(splittingParameters);", "originalCommit": "10a70456269f1732c719983c238e8e12490da007", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1MzMwNg==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432353306", "bodyText": "\ud83d\udc4d", "author": "gmaretic", "createdAt": "2020-05-29T09:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMxNDIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMxNTY0NQ==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432315645", "bodyText": "So this always creates the splitting log upfront, and does the migration in the creation of that (but we remember the state, so we won't be copying the data more than once).", "author": "jeremyk-91", "createdAt": "2020-05-29T07:53:04Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/LocalPaxosComponents.java", "diffHunk": "@@ -72,6 +82,23 @@\n         this.canCreateNewClients = canCreateNewClients;\n     }\n \n+    public static LocalPaxosComponents createWithBlockingMigration(\n+            TimelockPaxosMetrics metrics,\n+            PaxosUseCase paxosUseCase,\n+            Path legacyLogDirectory,\n+            DataSource sqliteDataSource,\n+            UUID leaderUuid,\n+            boolean canCreateNewClients) {\n+        LocalPaxosComponents components = new LocalPaxosComponents(metrics, paxosUseCase, legacyLogDirectory,\n+                sqliteDataSource, leaderUuid, canCreateNewClients);\n+\n+        Path legacyClientDir = paxosUseCase.logDirectoryRelativeToDataDirectory(legacyLogDirectory);\n+        PersistentNamespaceLoader namespaceLoader = new DiskNamespaceLoader(legacyClientDir);\n+        namespaceLoader.getAllPersistedNamespaces().forEach(components::getOrCreateComponents);\n+        components.getOrCreateComponents(PaxosUseCase.PSEUDO_LEADERSHIP_CLIENT);\n+        return components;", "originalCommit": "10a70456269f1732c719983c238e8e12490da007", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1MzE4Mw==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432353183", "bodyText": "Yup", "author": "gmaretic", "createdAt": "2020-05-29T09:04:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMxNTY0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMxOTAzNw==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432319037", "bodyText": "This migrates at least the greatest learned value locally right?", "author": "jeremyk-91", "createdAt": "2020-05-29T07:59:45Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosLearnerImpl.java", "diffHunk": "@@ -51,17 +51,11 @@ private static PaxosLearner newLearner(PaxosStateLog<PaxosValue> log, PaxosKnowl\n         return new PaxosLearnerImpl(state, log, eventRecorder);\n     }\n \n-    public static PaxosLearner newFileSystemLearner(PaxosStorageParameters params,\n+    public static PaxosLearner newSplittingLearner(PaxosStorageParameters params,\n+            SplittingPaxosStateLog.LegacyOperationMarkers legacyOperationMarkers,\n             PaxosKnowledgeEventRecorder event) {\n-        String logDirectory = params.fileBasedLogDirectory()\n-                .orElseThrow(() -> new SafeIllegalStateException(\"We currently need to have file-based storage\"));\n-        return newLearner(logDirectory, event);\n-    }\n-\n-    public static PaxosLearner newVerifyingLearner(PaxosStorageParameters params,\n-            PaxosKnowledgeEventRecorder event) {\n-        PaxosStateLog<PaxosValue> log = VerifyingPaxosStateLog\n-                .createWithoutMigration(params, PaxosValue.BYTES_HYDRATOR);\n+        PaxosStateLog<PaxosValue> log = SplittingPaxosStateLog\n+                .createWithMigration(params, PaxosValue.BYTES_HYDRATOR, legacyOperationMarkers, OptionalLong.empty());", "originalCommit": "10a70456269f1732c719983c238e8e12490da007", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1Mzc4NQ==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432353785", "bodyText": "Yes, if we migrate without giving the bound, it will call greatest log value and migrate from that minus buffer", "author": "gmaretic", "createdAt": "2020-05-29T09:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMxOTAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ1NjIxMg==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432456212", "bodyText": "note: This is not broken out by client, but it's fine", "author": "jeremyk-91", "createdAt": "2020-05-29T12:42:00Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/LocalPaxosComponents.java", "diffHunk": "@@ -123,6 +153,23 @@ private Components createComponents(Client client) {\n                 .build();\n     }\n \n+    private SplittingPaxosStateLog.LegacyOperationMarkers createMetrics(Class<?> forClass) {\n+        return ImmutableLegacyOperationMarkers.builder()\n+                .markLegacyRead(getReadCounter(forClass)::inc)\n+                .markLegacyWrite(getWriteCounter(forClass)::inc)\n+                .build();\n+    }\n+\n+    @VisibleForTesting\n+    Counter getReadCounter(Class<?> forClass) {\n+        return metrics.asMetricsManager().registerOrGetCounter(forClass, AtlasDbMetricNames.LEGACY_READ);\n+    }\n+\n+    @VisibleForTesting\n+    Counter getWriteCounter(Class<?> forClass) {\n+        return metrics.asMetricsManager().registerOrGetCounter(forClass, AtlasDbMetricNames.LEGACY_WRITE);\n+    }", "originalCommit": "10a70456269f1732c719983c238e8e12490da007", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ1NzA0MA==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432457040", "bodyText": "nit: This is basically a no-op", "author": "jeremyk-91", "createdAt": "2020-05-29T12:43:39Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/LocalPaxosComponents.java", "diffHunk": "@@ -72,6 +82,23 @@\n         this.canCreateNewClients = canCreateNewClients;\n     }\n \n+    public static LocalPaxosComponents createWithBlockingMigration(\n+            TimelockPaxosMetrics metrics,\n+            PaxosUseCase paxosUseCase,\n+            Path legacyLogDirectory,\n+            DataSource sqliteDataSource,\n+            UUID leaderUuid,\n+            boolean canCreateNewClients) {\n+        LocalPaxosComponents components = new LocalPaxosComponents(metrics, paxosUseCase, legacyLogDirectory,\n+                sqliteDataSource, leaderUuid, canCreateNewClients);\n+\n+        Path legacyClientDir = paxosUseCase.logDirectoryRelativeToDataDirectory(legacyLogDirectory);\n+        PersistentNamespaceLoader namespaceLoader = new DiskNamespaceLoader(legacyClientDir);\n+        namespaceLoader.getAllPersistedNamespaces().forEach(components::getOrCreateComponents);\n+        components.getOrCreateComponents(PaxosUseCase.PSEUDO_LEADERSHIP_CLIENT);", "originalCommit": "10a70456269f1732c719983c238e8e12490da007", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ1NzkyNQ==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432457925", "bodyText": "This is fine. I would suggest we replace this with a static factory called createFileBacked(...) or something like that for readability", "author": "jeremyk-91", "createdAt": "2020-05-29T12:45:26Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/SplittingPaxosStateLog.java", "diffHunk": "@@ -62,12 +67,47 @@ private SplittingPaxosStateLog(PaxosStateLog<V> legacyLog,\n         return new SplittingPaxosStateLog<>(\n                 parameters.legacyLog(),\n                 parameters.currentLog(),\n-                parameters.markLegacyWrite(),\n-                parameters.markLegacyRead(),\n+                parameters.legacyOperationMarkers().markLegacyWrite(),\n+                parameters.legacyOperationMarkers().markLegacyRead(),\n                 parameters.cutoffInclusive(),\n                 new AtomicLong(parameters.legacyLog().getLeastLogEntry()));\n     }\n \n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> createWithMigration(\n+            PaxosStorageParameters params,\n+            Persistable.Hydrator<V> hydrator,\n+            LegacyOperationMarkers legacyOperationMarkers,\n+            OptionalLong migrateFrom) {\n+        String logDirectory = params.fileBasedLogDirectory()\n+                .orElseThrow(() -> new SafeIllegalStateException(\"We currently need to have file-based storage\"));\n+        NamespaceAndUseCase namespaceUseCase = params.namespaceAndUseCase();\n+\n+        PaxosStateLogMigrator.MigrationContext<V> migrationContext = ImmutableMigrationContext.<V>builder()\n+                .sourceLog(new PaxosStateLogImpl<>(logDirectory))", "originalCommit": "10a70456269f1732c719983c238e8e12490da007", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ1ODAzMg==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432458032", "bodyText": "non-blocking", "author": "jeremyk-91", "createdAt": "2020-05-29T12:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ1NzkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ2MDE0MA==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432460140", "bodyText": "note: Let's add some logging in this class?", "author": "jeremyk-91", "createdAt": "2020-05-29T12:49:47Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java", "diffHunk": "@@ -37,10 +37,9 @@\n public final class PaxosStateLogMigrator<V extends Persistable & Versionable> {\n     private static final Logger log = LoggerFactory.getLogger(PaxosStateLogMigrator.class);\n \n+    public static final int SAFETY_BUFFER = 50;\n     @VisibleForTesting\n     static final int BATCH_SIZE = 10_000;\n-    @VisibleForTesting\n-    static final int SAFETY_BUFFER = 50;\n \n     private final PaxosStateLog<V> sourceLog;", "originalCommit": "10a70456269f1732c719983c238e8e12490da007", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2233751870cd0c1506ca4493f4921a83e9599ffb", "url": "https://github.com/palantir/atlasdb/commit/2233751870cd0c1506ca4493f4921a83e9599ffb", "message": "Address CR and increase TimelockAgent schema version", "committedDate": "2020-05-29T13:13:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ3OTg1OQ==", "url": "https://github.com/palantir/atlasdb/pull/4813#discussion_r432479859", "bodyText": "and this is safe because healthchecks are not reported until HTTP endpoints are opened, so we won't ever report a 2 until we start", "author": "jeremyk-91", "createdAt": "2020-05-29T13:24:34Z", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java", "diffHunk": "@@ -65,7 +65,7 @@\n \n @SuppressWarnings(\"checkstyle:FinalClass\") // This is mocked internally\n public class TimeLockAgent {\n-    private static final Long SCHEMA_VERSION = 1L;\n+    private static final Long SCHEMA_VERSION = 2L;", "originalCommit": "2233751870cd0c1506ca4493f4921a83e9599ffb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dd8840016086d0907dfcff0637663675067ab104", "url": "https://github.com/palantir/atlasdb/commit/dd8840016086d0907dfcff0637663675067ab104", "message": "Style", "committedDate": "2020-05-29T13:24:45Z", "type": "commit"}]}