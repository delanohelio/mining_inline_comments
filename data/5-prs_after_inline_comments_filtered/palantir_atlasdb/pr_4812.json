{"pr_number": 4812, "pr_title": "[Dialogue] Part 11: Lock V1 Client Uses >99% Pure Dialogue", "pr_createdAt": "2020-05-28T22:12:29Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4812", "timeline": [{"oid": "f84c08c188c44c2db5fc005b296bc2892a1a6b46", "url": "https://github.com/palantir/atlasdb/commit/f84c08c188c44c2db5fc005b296bc2892a1a6b46", "message": "conjurize lock", "committedDate": "2020-05-19T19:52:50Z", "type": "commit"}, {"oid": "e45494fd878455b41899709fa63b01ebb5ee09d1", "url": "https://github.com/palantir/atlasdb/commit/e45494fd878455b41899709fa63b01ebb5ee09d1", "message": "Gradle", "committedDate": "2020-05-19T21:04:33Z", "type": "commit"}, {"oid": "00f258242935e25093bbf7838f58651030142a8d", "url": "https://github.com/palantir/atlasdb/commit/00f258242935e25093bbf7838f58651030142a8d", "message": "New resource", "committedDate": "2020-05-19T21:04:42Z", "type": "commit"}, {"oid": "ca1b12ebadb49c303fccb7036ee0c83fb11b7642", "url": "https://github.com/palantir/atlasdb/commit/ca1b12ebadb49c303fccb7036ee0c83fb11b7642", "message": "Git out of here", "committedDate": "2020-05-19T21:05:08Z", "type": "commit"}, {"oid": "d8811b164db51e0e1325e618c2477d45487231fd", "url": "https://github.com/palantir/atlasdb/commit/d8811b164db51e0e1325e618c2477d45487231fd", "message": "test", "committedDate": "2020-05-19T21:28:20Z", "type": "commit"}, {"oid": "e97410458a4379482f6f46325cc4f309f89e9425", "url": "https://github.com/palantir/atlasdb/commit/e97410458a4379482f6f46325cc4f309f89e9425", "message": "JAXRS is tough", "committedDate": "2020-05-19T21:43:14Z", "type": "commit"}, {"oid": "78ecc2642c7b94a0b0bb2a845a311456bfad8111", "url": "https://github.com/palantir/atlasdb/commit/78ecc2642c7b94a0b0bb2a845a311456bfad8111", "message": "Add generated changelog entries", "committedDate": "2020-05-19T21:43:09Z", "type": "commit"}, {"oid": "0260b6e17cda19f2db8ffcb233d32c38a414a694", "url": "https://github.com/palantir/atlasdb/commit/0260b6e17cda19f2db8ffcb233d32c38a414a694", "message": "CR feedback", "committedDate": "2020-05-28T20:21:31Z", "type": "commit"}, {"oid": "787bd291755f36234e613242d3d96b66ac1f3bad", "url": "https://github.com/palantir/atlasdb/commit/787bd291755f36234e613242d3d96b66ac1f3bad", "message": "first version", "committedDate": "2020-05-28T20:22:30Z", "type": "commit"}, {"oid": "7d925155a5e74342414feac73a167a93bb7ad70f", "url": "https://github.com/palantir/atlasdb/commit/7d925155a5e74342414feac73a167a93bb7ad70f", "message": "Add integ test", "committedDate": "2020-05-28T20:22:30Z", "type": "commit"}, {"oid": "e36238684804f4a4282925232546df03130fe319", "url": "https://github.com/palantir/atlasdb/commit/e36238684804f4a4282925232546df03130fe319", "message": "Integ tests", "committedDate": "2020-05-28T20:22:30Z", "type": "commit"}, {"oid": "d79c275debac8222b64defd2aaa735300fc9e584", "url": "https://github.com/palantir/atlasdb/commit/d79c275debac8222b64defd2aaa735300fc9e584", "message": "simplify and add better test", "committedDate": "2020-05-28T20:22:30Z", "type": "commit"}, {"oid": "813ff4060701c5d7ad4be29e3a3bf202a8351022", "url": "https://github.com/palantir/atlasdb/commit/813ff4060701c5d7ad4be29e3a3bf202a8351022", "message": "CR: fix misleading line", "committedDate": "2020-05-28T20:24:39Z", "type": "commit"}, {"oid": "ed687d6242a8f3f3de907eccf52a5ef3a55ced93", "url": "https://github.com/palantir/atlasdb/commit/ed687d6242a8f3f3de907eccf52a5ef3a55ced93", "message": "[Dialogue] Part 9: Shims for Lesser Used Services: AtlasDB -> TimeLock (#4794)\n\n* Shims\r\n\r\n* Dialogue shim factory\r\n\r\n* More descriptive builders\r\n\r\n* Imports\r\n\r\n* Add generated changelog entries", "committedDate": "2020-05-28T20:38:43Z", "type": "commit"}, {"oid": "82817c00bcfea1932d8f851a81e57702f87132d3", "url": "https://github.com/palantir/atlasdb/commit/82817c00bcfea1932d8f851a81e57702f87132d3", "message": "Dependency setup", "committedDate": "2020-05-28T20:39:01Z", "type": "commit"}, {"oid": "9084f9551dc61620eb83e44de6c3f4a72cb7d7e1", "url": "https://github.com/palantir/atlasdb/commit/9084f9551dc61620eb83e44de6c3f4a72cb7d7e1", "message": "Dialogue composing client", "committedDate": "2020-05-28T21:08:34Z", "type": "commit"}, {"oid": "1374dabd57161e06185e6a11cca534813b7efea8", "url": "https://github.com/palantir/atlasdb/commit/1374dabd57161e06185e6a11cca534813b7efea8", "message": "Checkstyles", "committedDate": "2020-05-28T21:46:20Z", "type": "commit"}, {"oid": "cb4617cc89e650cd182db01a8edfbfe130a1456d", "url": "https://github.com/palantir/atlasdb/commit/cb4617cc89e650cd182db01a8edfbfe130a1456d", "message": "Change ETE test to leverage the Dialogue endpoints", "committedDate": "2020-05-28T21:55:04Z", "type": "commit"}, {"oid": "7ddc0a0f92ab76bffa66f21627ef9330c6da913e", "url": "https://github.com/palantir/atlasdb/commit/7ddc0a0f92ab76bffa66f21627ef9330c6da913e", "message": "I actually kind of like this api", "committedDate": "2020-05-28T22:04:51Z", "type": "commit"}, {"oid": "fa407879a13ceaa71f20da1c358022d4b363180f", "url": "https://github.com/palantir/atlasdb/commit/fa407879a13ceaa71f20da1c358022d4b363180f", "message": "Tests", "committedDate": "2020-05-28T22:10:23Z", "type": "commit"}, {"oid": "8e441c30681bda636f2e2ca9aea5f1305652c381", "url": "https://github.com/palantir/atlasdb/commit/8e441c30681bda636f2e2ca9aea5f1305652c381", "message": "checkstyle", "committedDate": "2020-05-29T07:46:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQwOTAxOQ==", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r432409019", "bodyText": "This is cool, but I'd name it composeWith or combineWith", "author": "gmaretic", "createdAt": "2020-05-29T10:57:01Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java", "diffHunk": "@@ -100,6 +108,52 @@ ConjureTimelockService getConjureTimelockService() {\n         return new TimeoutSensitiveConjureTimelockService(shortAndLongTimeoutServices);\n     }\n \n+    TimestampManagementRpcClient getTimestampManagementRpcClient() {\n+        return createDialogueProxyWithShortTimeout(TimestampManagementRpcClient.class);\n+    }\n+\n+    LockRpcClient getLockRpcClient() {\n+        ConjureLockV1ServiceBlocking shortTimeoutDialogueService\n+                = dialogueClientFactory.get(ConjureLockV1ServiceBlocking.class, TIMELOCK_SHORT_TIMEOUT);\n+        ConjureLockV1ServiceBlocking longTimeoutDialogueService\n+                = dialogueClientFactory.get(ConjureLockV1ServiceBlocking.class, TIMELOCK_LONG_TIMEOUT);\n+\n+        ShortAndLongTimeoutServices<LockRpcClient> legacyRpcClients\n+                = ImmutableShortAndLongTimeoutServices.<LockRpcClient>builder()\n+                .shortTimeout(createDialogueProxyWithShortTimeout(LockRpcClient.class))\n+                .longTimeout(createDialogueProxyWithLongTimeout(LockRpcClient.class))\n+                .build();\n+\n+        return new TimeoutSensitiveLockRpcClient(\n+                ImmutableShortAndLongTimeoutServices.<ConjureLockV1ServiceBlocking>builder()\n+                        .shortTimeout(shortTimeoutDialogueService)\n+                        .longTimeout(longTimeoutDialogueService)\n+                        .build()\n+                        .map(proxy -> FastFailoverProxy.newProxyInstance(\n+                                ConjureLockV1ServiceBlocking.class, () -> proxy))\n+                        .map(service -> AtlasDbMetrics.instrumentWithTaggedMetrics(\n+                                taggedMetricRegistry,\n+                                ConjureLockV1ServiceBlocking.class,\n+                                service))\n+                        .zipWith(legacyRpcClients, DialogueComposingLockRpcClient::new));", "originalCommit": "8e441c30681bda636f2e2ca9aea5f1305652c381", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQxMTIzMg==", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r432411232", "bodyText": "\ud83c\udf89", "author": "gmaretic", "createdAt": "2020-05-29T11:01:54Z", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/timelock/ShortAndLongTimeoutServicesTest.java", "diffHunk": "@@ -57,4 +58,38 @@ public void mapOperatesOnCorrespondingElements() {\n         assertThat(strings.shortTimeout()).isEqualTo(\"1\");\n         assertThat(strings.longTimeout()).isEqualTo(\"3\");\n     }\n+\n+    @Test\n+    public void zipWithZipsCorrectElements() {", "originalCommit": "8e441c30681bda636f2e2ca9aea5f1305652c381", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQxMzY0OA==", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r432413648", "bodyText": "This is a behaviour change, but it should be fine for existing tests. I guess this was done to reuse existing tests to test the pure dialogue methods?", "author": "gmaretic", "createdAt": "2020-05-29T11:07:34Z", "path": "atlasdb-ete-tests/src/main/java/com/palantir/atlasdb/lock/SimpleLockResource.java", "diffHunk": "@@ -60,9 +61,9 @@ public boolean lockUsingLegacyLockApi(int numLocks, int descriptorSize) {\n                 .builder(generateDescriptorMap(numLocks, descriptorSize))\n                 .build();\n         try {\n-            LockRefreshToken response = transactionManager.getLockService().lock(\"test\", request);\n+            HeldLocksToken response = transactionManager.getLockService().lockAndGetHeldLocks(\"test\", request);", "originalCommit": "8e441c30681bda636f2e2ca9aea5f1305652c381", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTExMTk2MA==", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r435111960", "bodyText": "Yep, this now goes through the Dialogue methods as you say. This is only in the ETE server, as well", "author": "jeremyk-91", "createdAt": "2020-06-04T09:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQxMzY0OA=="}], "type": "inlineReview"}, {"oid": "f9127a553684baf845865dbb51d2fe97ea41991b", "url": "https://github.com/palantir/atlasdb/commit/f9127a553684baf845865dbb51d2fe97ea41991b", "message": "Merge branch 'develop' into jkong/pure-dialogue-lock-client", "committedDate": "2020-06-04T09:21:10Z", "type": "commit"}, {"oid": "8e77685009914faba7467a872f22a202b2f97198", "url": "https://github.com/palantir/atlasdb/commit/8e77685009914faba7467a872f22a202b2f97198", "message": "Fix bad merge", "committedDate": "2020-06-04T09:31:45Z", "type": "commit"}]}