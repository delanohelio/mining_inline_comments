{"pr_number": 5169, "pr_title": "Excavator: Upgrades Baseline to the latest version", "pr_createdAt": "2020-12-22T00:04:55Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5169", "timeline": [{"oid": "4c08e41007e020b055fd59668cd0677c267b7e31", "url": "https://github.com/palantir/atlasdb/commit/4c08e41007e020b055fd59668cd0677c267b7e31", "message": "Excavator: Upgrades Baseline to the latest version", "committedDate": "2020-12-29T01:54:42Z", "type": "forcePushed"}, {"oid": "961acaea71d505f1386e03fac7e27603bce71434", "url": "https://github.com/palantir/atlasdb/commit/961acaea71d505f1386e03fac7e27603bce71434", "message": "Excavator: Upgrades Baseline to the latest version", "committedDate": "2021-01-05T02:51:04Z", "type": "forcePushed"}, {"oid": "7b382854bb59d78c245cb91c84dfd815f71ab5a3", "url": "https://github.com/palantir/atlasdb/commit/7b382854bb59d78c245cb91c84dfd815f71ab5a3", "message": "Excavator: Upgrades Baseline to the latest version", "committedDate": "2021-01-05T15:07:46Z", "type": "forcePushed"}, {"oid": "18590428a0698f1b8b23eddc8d8aef2710b243f2", "url": "https://github.com/palantir/atlasdb/commit/18590428a0698f1b8b23eddc8d8aef2710b243f2", "message": "Excavator: Upgrades Baseline to the latest version", "committedDate": "2021-01-05T22:48:19Z", "type": "forcePushed"}, {"oid": "b60ffa596fafc602921f77d372e62bbffcfc6489", "url": "https://github.com/palantir/atlasdb/commit/b60ffa596fafc602921f77d372e62bbffcfc6489", "message": "Excavator: Upgrades Baseline to the latest version", "committedDate": "2021-01-06T13:23:01Z", "type": "commit"}, {"oid": "b60ffa596fafc602921f77d372e62bbffcfc6489", "url": "https://github.com/palantir/atlasdb/commit/b60ffa596fafc602921f77d372e62bbffcfc6489", "message": "Excavator: Upgrades Baseline to the latest version", "committedDate": "2021-01-06T13:23:01Z", "type": "forcePushed"}, {"oid": "ba6a9eb4c8e61afaa9b4978eae99c06faac57e31", "url": "https://github.com/palantir/atlasdb/commit/ba6a9eb4c8e61afaa9b4978eae99c06faac57e31", "message": "Fix ClassInitializationDeadlock - 1", "committedDate": "2021-01-06T13:37:59Z", "type": "commit"}, {"oid": "cfbafabbc17fbb8554170599f53c9936a5e77369", "url": "https://github.com/palantir/atlasdb/commit/cfbafabbc17fbb8554170599f53c9936a5e77369", "message": "ClassInitializationDeadlock fixes - 2", "committedDate": "2021-01-07T08:34:16Z", "type": "commit"}, {"oid": "86507d85388053e033a8c2004db0c6d7bce5fb42", "url": "https://github.com/palantir/atlasdb/commit/86507d85388053e033a8c2004db0c6d7bce5fb42", "message": "ClassInitializationDeadlock fixes - 3", "committedDate": "2021-01-07T08:42:01Z", "type": "commit"}, {"oid": "8455973726c61f78dd5e99a285d887f34f6a0e5a", "url": "https://github.com/palantir/atlasdb/commit/8455973726c61f78dd5e99a285d887f34f6a0e5a", "message": "ClassInitializationDeadlock fixes - 4", "committedDate": "2021-01-07T08:45:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4NTI4Mg==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553185282", "bodyText": "The immutable is used outside of package", "author": "sudiksha27", "createdAt": "2021-01-07T08:48:50Z", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/factory/TransactionManagerConsistencyResult.java", "diffHunk": "@@ -23,7 +23,9 @@\n  * determine that it is safe (or, at least, not obviously unsafe) to service requests.\n  */\n @Value.Immutable\n+@SuppressWarnings(\"ClassInitializationDeadlock\")\n public interface TransactionManagerConsistencyResult {", "originalCommit": "8455973726c61f78dd5e99a285d887f34f6a0e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4NjIxMw==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553186213", "bodyText": "The immutable is used outside this package.", "author": "sudiksha27", "createdAt": "2021-01-07T08:50:36Z", "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/stream/StreamStorePersistenceConfiguration.java", "diffHunk": "@@ -23,10 +23,11 @@\n @JsonSerialize(as = ImmutableStreamStorePersistenceConfiguration.class)\n @JsonDeserialize(as = ImmutableStreamStorePersistenceConfiguration.class)\n @Value.Immutable\n+@SuppressWarnings(\"ClassInitializationDeadlock\")\n public interface StreamStorePersistenceConfiguration {", "originalCommit": "8455973726c61f78dd5e99a285d887f34f6a0e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4Njg5Mg==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553186892", "bodyText": "This constant is only used for testing.", "author": "sudiksha27", "createdAt": "2021-01-07T08:51:54Z", "path": "atlasdb-conjure/src/main/java/com/palantir/atlasdb/http/v2/ClientOptions.java", "diffHunk": "@@ -32,14 +32,6 @@\n \n @Value.Immutable\n public abstract class ClientOptions {\n-    static final ClientOptions FAST_RETRYING_FOR_TEST = ImmutableClientOptions.builder()\n-            .connectTimeout(Duration.ofMillis(100))\n-            .readTimeout(Duration.ofSeconds(65))\n-            .backoffSlotSize(Duration.ofMillis(5))\n-            .failedUrlCooldown(Duration.ofMillis(1))\n-            .maxNumRetries(5)\n-            .clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n-            .build();\n ", "originalCommit": "8455973726c61f78dd5e99a285d887f34f6a0e5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI1NTMwOQ==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553255309", "bodyText": "I will assume that you verified this via a search on github? If so, great!", "author": "Jolyon-S", "createdAt": "2021-01-07T10:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4Njg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI2ODMwOA==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553268308", "bodyText": "I verified there are. no usages on internal github.", "author": "sudiksha27", "createdAt": "2021-01-07T11:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4Njg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE5MTg1OA==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553191858", "bodyText": "Instead of breaking the interface contract by moving the constant, we are setting the impl visibility to PACKAGE (this is done to avoid initializing the immutable first) and suppressing the error.", "author": "sudiksha27", "createdAt": "2021-01-07T09:00:55Z", "path": "atlasdb-dbkvs/src/main/java/com/palantir/atlasdb/keyvalue/dbkvs/impl/Token.java", "diffHunk": "@@ -19,6 +19,8 @@\n import org.immutables.value.Value;\n \n @Value.Immutable\n+@Value.Style(visibility = Value.Style.ImplementationVisibility.PACKAGE)\n+@SuppressWarnings(\"ClassInitializationDeadlock\")\n abstract class Token {\n     @Nullable", "originalCommit": "8455973726c61f78dd5e99a285d887f34f6a0e5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI1NjY5Mw==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553256693", "bodyText": "To clarify, is it the case that:\n\nsetting the implementation visibility prevents the actual issue of initialisation deadlock?\nthe check is not smart enough to determine this, and so it requires the warning to be suppressed?\nwe cannot do this elsewhere because in other cases, the impl cannot be made package private? (In other words, why did we go with this solution here but not elsewhere, and vice versa?)", "author": "Jolyon-S", "createdAt": "2021-01-07T10:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE5MTg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI3MDc4Ng==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553270786", "bodyText": "setting the implementation visibility only helps avoid external usages which could potentially cause a deadlock and within the package we have to be sensible while using the immutable.\nThe check is still right in this case to break, which is why we suppress it.\nThis cannot be done in the cases where the subclass has usages in other packages. In those cases we move out the constants to a separate util. To have a separate a util only for a constant seems a but janky which is why we have take the first approach if possible.", "author": "sudiksha27", "createdAt": "2021-01-07T11:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE5MTg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzkzNjA1NQ==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553936055", "bodyText": "If we try to initialise ImmutableClass before Class, that will require us to initialise Class, but because of the static constant, that requires an initialisation of ImmutableClass and this deadlocks because there is a lock on ImmutableClass.\nIf you ensure that Class gets initialised first, then everything works fine, so by making access to ImmutableClass package private (to prevent external badness) and exposing a builder on the Class interface to be used instead of the ImmutableClass builder directly, we can avoid this issue", "author": "gmaretic", "createdAt": "2021-01-08T13:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE5MTg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NDcyOQ==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r554084729", "bodyText": "Package private may still be accessed externally. I considered special casing in the errorprone rule, but it would require additional validation that nothing accesses package-private generated immutables outside of the defining class, which we've seen more frequently than one would hope.", "author": "carterkozak", "createdAt": "2021-01-08T17:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE5MTg1OA=="}], "type": "inlineReview"}, {"oid": "98cf1975bf71bf83700bf23251b65babfa709174", "url": "https://github.com/palantir/atlasdb/commit/98cf1975bf71bf83700bf23251b65babfa709174", "message": "Immutable annotations", "committedDate": "2021-01-07T09:23:34Z", "type": "commit"}, {"oid": "da4a26904eb75f50863d5dc4b0a8c87ed96198a4", "url": "https://github.com/palantir/atlasdb/commit/da4a26904eb75f50863d5dc4b0a8c87ed96198a4", "message": "Fix build", "committedDate": "2021-01-07T10:10:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzIzMzM5Ng==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553233396", "bodyText": "The CassandraKeyValueServiceInstrumentation is being used in tests in a different package and can not be made package private, would appreciate alternative ideas for fixing the ClassInitDeadlock issue here.", "author": "sudiksha27", "createdAt": "2021-01-07T10:13:45Z", "path": "atlasdb-perf/src/main/java/com/palantir/atlasdb/performance/backend/KeyValueServiceInstrumentation.java", "diffHunk": "@@ -23,6 +23,7 @@\n import java.util.Set;\n import java.util.TreeMap;\n \n+@SuppressWarnings(\"ClassInitializationDeadlock\")\n public abstract class KeyValueServiceInstrumentation {", "originalCommit": "da4a26904eb75f50863d5dc4b0a8c87ed96198a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzkyOTk0Mg==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553929942", "bodyText": "You can still make the generated code package private, and provide a builder in this class to avoid the issue outside of the package", "author": "gmaretic", "createdAt": "2021-01-08T13:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzIzMzM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQyNTExMQ==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r564425111", "bodyText": "This is only used in benchmarking, and not worth the effort to clean it up", "author": "gmaretic", "createdAt": "2021-01-26T11:00:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzIzMzM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI1NDk3OA==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553254978", "bodyText": "nit: unnecessary diff?", "author": "Jolyon-S", "createdAt": "2021-01-07T10:54:16Z", "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/stream/StreamStorePersistenceConfiguration.java", "diffHunk": "@@ -23,10 +23,11 @@\n @JsonSerialize(as = ImmutableStreamStorePersistenceConfiguration.class)\n @JsonDeserialize(as = ImmutableStreamStorePersistenceConfiguration.class)\n @Value.Immutable\n+@SuppressWarnings(\"ClassInitializationDeadlock\")\n public interface StreamStorePersistenceConfiguration {\n+    @Deprecated\n     StreamStorePersistenceConfiguration DEFAULT_CONFIG =\n             ImmutableStreamStorePersistenceConfiguration.builder().build();\n-", "originalCommit": "da4a26904eb75f50863d5dc4b0a8c87ed96198a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI1NzIzOA==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553257238", "bodyText": "Is this breaking?", "author": "Jolyon-S", "createdAt": "2021-01-07T10:58:27Z", "path": "atlasdb-perf/src/main/java/com/palantir/atlasdb/performance/backend/PostgresKeyValueServiceInstrumentation.java", "diffHunk": "@@ -22,7 +22,7 @@\n import com.palantir.nexus.db.pool.config.ImmutablePostgresConnectionConfig;\n import java.net.InetSocketAddress;\n \n-public class PostgresKeyValueServiceInstrumentation extends KeyValueServiceInstrumentation {\n+class PostgresKeyValueServiceInstrumentation extends KeyValueServiceInstrumentation {", "originalCommit": "da4a26904eb75f50863d5dc4b0a8c87ed96198a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI1NzUxOQ==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553257519", "bodyText": "nit: order is not consistent with the order of annotations on some of the other classes", "author": "Jolyon-S", "createdAt": "2021-01-07T10:59:03Z", "path": "lock-api/src/main/java/com/palantir/lock/LockServerOptions.java", "diffHunk": "@@ -35,6 +35,8 @@\n  */\n @JsonDeserialize(builder = LockServerOptions.SerializationProxy.class)\n @Value.Immutable\n+@Value.Style(visibility = Value.Style.ImplementationVisibility.PACKAGE)\n+@SuppressWarnings(\"ClassInitializationDeadlock\")", "originalCommit": "da4a26904eb75f50863d5dc4b0a8c87ed96198a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c695a342e51f7c46f3ece6480fdb17cc0b45c300", "url": "https://github.com/palantir/atlasdb/commit/c695a342e51f7c46f3ece6480fdb17cc0b45c300", "message": "Address comments - 1", "committedDate": "2021-01-07T11:19:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzkzMTU1OA==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553931558", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            @SuppressWarnings(\"ClassInitializationDeadlock\")\n          \n          \n            \n            @SuppressWarnings(\"ClassInitializationDeadlock\")\n          \n          \n            \n            @Value.Style(visibility = Value.Style.ImplementationVisibility.PACKAGE)", "author": "gmaretic", "createdAt": "2021-01-08T13:04:09Z", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/factory/TransactionManagerConsistencyResult.java", "diffHunk": "@@ -23,7 +23,9 @@\n  * determine that it is safe (or, at least, not obviously unsafe) to service requests.\n  */\n @Value.Immutable\n+@SuppressWarnings(\"ClassInitializationDeadlock\")", "originalCommit": "c695a342e51f7c46f3ece6480fdb17cc0b45c300", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzkzMTgwNQ==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553931805", "bodyText": "And add a builder if necessary for outside use, the idea is not to expose the generated immutable", "author": "gmaretic", "createdAt": "2021-01-08T13:04:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzkzMTU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA1MDgzMg==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r554050832", "bodyText": "Curious why suppress an error-prone check for potential class initialization deadlock (see palantir/gradle-baseline#1598 that @carterkozak just added )? I'm assuming this is a fairly common pattern in many uses of immutables where there's either some constant defined as the empty object or similar. Do we need to consider pulling these types of constants out to a separate class (e.g. TransactionManagerConsistencyResults) or lazy initialization get of a memoized supplier?", "author": "schlosna", "createdAt": "2021-01-08T16:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzkzMTU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzkzMTg3Mw==", "url": "https://github.com/palantir/atlasdb/pull/5169#discussion_r553931873", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            @SuppressWarnings(\"ClassInitializationDeadlock\")\n          \n          \n            \n            @SuppressWarnings(\"ClassInitializationDeadlock\")\n          \n          \n            \n            @Value.Style(visibility = Value.Style.ImplementationVisibility.PACKAGE)", "author": "gmaretic", "createdAt": "2021-01-08T13:04:54Z", "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/stream/StreamStorePersistenceConfiguration.java", "diffHunk": "@@ -23,7 +23,9 @@\n @JsonSerialize(as = ImmutableStreamStorePersistenceConfiguration.class)\n @JsonDeserialize(as = ImmutableStreamStorePersistenceConfiguration.class)\n @Value.Immutable\n+@SuppressWarnings(\"ClassInitializationDeadlock\")", "originalCommit": "c695a342e51f7c46f3ece6480fdb17cc0b45c300", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0a5c83907e0600caf1e1393634deb7f2064479a7", "url": "https://github.com/palantir/atlasdb/commit/0a5c83907e0600caf1e1393634deb7f2064479a7", "message": "Instrument batcher", "committedDate": "2021-01-11T14:58:29Z", "type": "commit"}, {"oid": "44902a3c258b82b31297f478f9dd2564a996be89", "url": "https://github.com/palantir/atlasdb/commit/44902a3c258b82b31297f478f9dd2564a996be89", "message": "Revert \"Instrument batcher\"\n\nThis reverts commit 0a5c83907e0600caf1e1393634deb7f2064479a7.", "committedDate": "2021-01-11T15:00:23Z", "type": "commit"}, {"oid": "262661e661a9ad742f70e7df554551d1784e8dc1", "url": "https://github.com/palantir/atlasdb/commit/262661e661a9ad742f70e7df554551d1784e8dc1", "message": "Extract INITIAL Token", "committedDate": "2021-01-18T13:51:17Z", "type": "commit"}, {"oid": "2340d1219b2b6a06e911efc2df20cdf12c7af898", "url": "https://github.com/palantir/atlasdb/commit/2340d1219b2b6a06e911efc2df20cdf12c7af898", "message": "Extract out constants", "committedDate": "2021-01-20T20:10:25Z", "type": "commit"}, {"oid": "346f1f9ac17a3eea89760002a9261b7bc704fd8f", "url": "https://github.com/palantir/atlasdb/commit/346f1f9ac17a3eea89760002a9261b7bc704fd8f", "message": "Fix build", "committedDate": "2021-01-21T14:27:16Z", "type": "commit"}]}