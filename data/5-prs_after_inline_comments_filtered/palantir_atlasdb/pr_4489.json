{"pr_number": 4489, "pr_title": "AsyncPuncherTest no longer leaks ScheduledExecutorServices", "pr_createdAt": "2020-01-07T15:53:47Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4489", "timeline": [{"oid": "1daf85f1dfd47d631d4a878251c3190371dd1d57", "url": "https://github.com/palantir/atlasdb/commit/1daf85f1dfd47d631d4a878251c3190371dd1d57", "message": "AsyncPuncherTest no longer leaks ScheduledExecutorServices\n\nPreviosuly a remaining task continued to execute and produce a\nstack trace every millisecond for the remainder of the suite.", "committedDate": "2020-01-07T15:49:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgxNjMzMA==", "url": "https://github.com/palantir/atlasdb/pull/4489#discussion_r363816330", "bodyText": "Previously this mutated state, orphaning the original asyncPuncher", "author": "carterkozak", "createdAt": "2020-01-07T15:54:06Z", "path": "atlasdb-tests-shared/src/test/java/com/palantir/atlasdb/cleaner/AsyncPuncherTest.java", "diffHunk": "@@ -41,25 +40,18 @@\n         throw new IllegalStateException(\"bla\");\n     };\n \n-    private AsyncPuncher asyncPuncher;\n     private TimestampService timestampService;\n \n     @Before\n     public void setup() {\n         timestampService = new InMemoryTimestampService();\n-        setupPuncher(THROWING_BACKUP_TIMESTAMP_SUPPLIER);\n     }\n \n-    private void setupPuncher(LongSupplier backupTimestampSupplier) {\n+    private AsyncPuncher setupPuncher(LongSupplier backupTimestampSupplier) {\n         PuncherStore puncherStore = InMemoryPuncherStore.create();\n         Clock clock = new SystemClock();\n         Puncher puncher = SimplePuncher.create(puncherStore, clock, Suppliers.ofInstance(TRANSACTION_TIMEOUT));\n-        asyncPuncher = AsyncPuncher.create(puncher, ASYNC_PUNCHER_INTERVAL, backupTimestampSupplier);", "originalCommit": "1daf85f1dfd47d631d4a878251c3190371dd1d57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgxNjU0Mg==", "url": "https://github.com/palantir/atlasdb/pull/4489#discussion_r363816542", "bodyText": "\ud83c\udf36\ufe0f \ud83c\udf36\ufe0f when it was called here", "author": "carterkozak", "createdAt": "2020-01-07T15:54:32Z", "path": "atlasdb-tests-shared/src/test/java/com/palantir/atlasdb/cleaner/AsyncPuncherTest.java", "diffHunk": "@@ -82,34 +74,48 @@ public void delegatesInitializationCheck() {\n     @Test\n     public void testPuncherDurability() throws Exception {\n         long stored = timestampService.getFreshTimestamp();\n-        asyncPuncher.punch(stored);\n-        checkExpectedValue(asyncPuncher, stored);\n+        AsyncPuncher asyncPuncher = setupPuncher(THROWING_BACKUP_TIMESTAMP_SUPPLIER);\n+        try {\n+            asyncPuncher.punch(stored);\n+            checkExpectedValue(asyncPuncher, stored);\n+        } finally {\n+            asyncPuncher.shutdown();\n+        }\n     }\n \n \n     @Test\n     public void testPuncherTimestampLessThanFreshTimestamp() throws Exception {\n         long stored = timestampService.getFreshTimestamp();\n-        asyncPuncher.punch(stored);\n-        long retrieved = Long.MIN_VALUE;\n-        for (int i = 0; i < MAX_INTERVALS_TO_WAIT && retrieved < stored; i++) {\n-            Thread.sleep(ASYNC_PUNCHER_INTERVAL);\n-            retrieved = asyncPuncher.getTimestampSupplier().get();\n+        AsyncPuncher asyncPuncher = setupPuncher(THROWING_BACKUP_TIMESTAMP_SUPPLIER);\n+        try {\n+            asyncPuncher.punch(stored);\n+            long retrieved = Long.MIN_VALUE;\n+            for (int i = 0; i < MAX_INTERVALS_TO_WAIT && retrieved < stored; i++) {\n+                Thread.sleep(ASYNC_PUNCHER_INTERVAL);\n+                retrieved = asyncPuncher.getTimestampSupplier().get();\n+            }\n+            long freshTimestamp = timestampService.getFreshTimestamp();\n+            assertThat(retrieved).isLessThan(freshTimestamp);\n+        } finally {\n+            asyncPuncher.shutdown();\n         }\n-        long freshTimestamp = timestampService.getFreshTimestamp();\n-        assertThat(retrieved).isLessThan(freshTimestamp);\n     }\n \n     @Test\n     public void punchesBackupTimestampWhenNothingWasPunched() throws Exception {\n-        setupPuncher(timestampService::getFreshTimestamp);", "originalCommit": "1daf85f1dfd47d631d4a878251c3190371dd1d57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgyMDY3MA==", "url": "https://github.com/palantir/atlasdb/pull/4489#discussion_r363820670", "bodyText": "I suppose this will spam bla: No timestamp was found and attempting to get a fresh timestamp to punch failed.", "author": "jeremyk-91", "createdAt": "2020-01-07T16:02:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgxNjU0Mg=="}], "type": "inlineReview"}]}