{"pr_number": 4954, "pr_title": "Don't Register Duplicate Metrics", "pr_createdAt": "2020-08-18T19:50:46Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4954", "timeline": [{"oid": "62aa5aacb9bd47d70b31c52d17146531248e10b5", "url": "https://github.com/palantir/atlasdb/commit/62aa5aacb9bd47d70b31c52d17146531248e10b5", "message": "proxies", "committedDate": "2020-08-18T19:45:45Z", "type": "commit"}, {"oid": "c20b84d6c9fa53544bd9ac0800e4f76b45a69d7b", "url": "https://github.com/palantir/atlasdb/commit/c20b84d6c9fa53544bd9ac0800e4f76b45a69d7b", "message": "Fix", "committedDate": "2020-08-18T19:47:09Z", "type": "commit"}, {"oid": "99aa35e93ba02e3503ffb6d6b587ee24de33ff5c", "url": "https://github.com/palantir/atlasdb/commit/99aa35e93ba02e3503ffb6d6b587ee24de33ff5c", "message": "Add generated changelog entries", "committedDate": "2020-08-18T19:47:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2MjY1MA==", "url": "https://github.com/palantir/atlasdb/pull/4954#discussion_r472862650", "bodyText": "nit: close bracket (that was opened on the line above)", "author": "Jolyon-S", "createdAt": "2020-08-19T08:40:44Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -1187,23 +1188,16 @@ private static LockAndTimestampServices createRawLeaderServices(\n                 leaderConfig,\n                 userAgent);\n         LeaderElectionService leader = localPaxosServices.leaderElectionService();\n-        LockService localLock = ServiceCreator.instrumentService(\n-                metricsManager.getRegistry(),\n-                AwaitingLeadershipProxy.newProxyInstance(LockService.class, lock::get, leader),\n-                LockService.class);\n+        LockService localLock = AwaitingLeadershipProxy.newProxyInstance(LockService.class, lock::get, leader);\n \n         ManagedTimestampService managedTimestampProxy =\n                 AwaitingLeadershipProxy.newProxyInstance(ManagedTimestampService.class, time::get, leader);\n \n-        TimestampService localTime = ServiceCreator.instrumentService(\n-                metricsManager.getRegistry(),\n-                managedTimestampProxy,\n-                TimestampService.class);\n+        // These facades are necessary because of the semantics of the JAX-RS algorithm (in particular, accepting\n+        // just the managed timestamp service will *not* work.", "originalCommit": "99aa35e93ba02e3503ffb6d6b587ee24de33ff5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2NjExMQ==", "url": "https://github.com/palantir/atlasdb/pull/4954#discussion_r472866111", "bodyText": "good spot!", "author": "jeremyk-91", "createdAt": "2020-08-19T08:46:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2MjY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2Mzk3OA==", "url": "https://github.com/palantir/atlasdb/pull/4954#discussion_r472863978", "bodyText": "You've removed two tests, but added none - are there any tests we can add to have confidence that this fix is correct?", "author": "Jolyon-S", "createdAt": "2020-08-19T08:42:53Z", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java", "diffHunk": "@@ -612,15 +612,6 @@ private TransactionManagers withLockImmutableTsOnReadOnlyTransaction(boolean opt\n                 .build();\n     }\n \n-    @Test\n-    public void metricsAreReportedExactlyOnceWhenUsingLocalService() throws IOException {", "originalCommit": "99aa35e93ba02e3503ffb6d6b587ee24de33ff5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2NDkzMw==", "url": "https://github.com/palantir/atlasdb/pull/4954#discussion_r472864933", "bodyText": "I see you've said\n\nExisting tests should suffice for correctness.\nRemoval of metrics is verified by removing the test involved\n\nbut I'm not 100% on the second point - removing the tests just removes the check that there are metrics, but surely it doesn't actively check that no metrics are registered? That's what we want here, right?", "author": "Jolyon-S", "createdAt": "2020-08-19T08:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2Mzk3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2NjMxOQ==", "url": "https://github.com/palantir/atlasdb/pull/4954#discussion_r472866319", "bodyText": "Fair enough, yep I'll replace that with a check that they are not registered.", "author": "jeremyk-91", "createdAt": "2020-08-19T08:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2Mzk3OA=="}], "type": "inlineReview"}, {"oid": "1db085ebffb97a1cae1a3378142e6fa10cf5d790", "url": "https://github.com/palantir/atlasdb/commit/1db085ebffb97a1cae1a3378142e6fa10cf5d790", "message": "CR comments", "committedDate": "2020-08-19T08:56:45Z", "type": "commit"}, {"oid": "c8afb8cccd42194c333d551a4e0fb34d655a4ae7", "url": "https://github.com/palantir/atlasdb/commit/c8afb8cccd42194c333d551a4e0fb34d655a4ae7", "message": "Merge branch 'jkong/duplicate-final' of github.com:palantir/atlasdb into jkong/duplicate-final", "committedDate": "2020-08-19T08:56:56Z", "type": "commit"}]}