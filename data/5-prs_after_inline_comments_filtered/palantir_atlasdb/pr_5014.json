{"pr_number": 5014, "pr_title": "[DB TimeLock] 1D - Agent Wiring", "pr_createdAt": "2020-10-02T00:33:22Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5014", "timeline": [{"oid": "2c2f08c8e34e529fc653037172db2e7db19be849", "url": "https://github.com/palantir/atlasdb/commit/2c2f08c8e34e529fc653037172db2e7db19be849", "message": "bleh", "committedDate": "2020-10-01T22:10:55Z", "type": "commit"}, {"oid": "5272f03a48917e0871dbe2afc765d787b142423d", "url": "https://github.com/palantir/atlasdb/commit/5272f03a48917e0871dbe2afc765d787b142423d", "message": "fbuo2ch1902w rbguohcbfuch81", "committedDate": "2020-10-01T23:09:39Z", "type": "commit"}, {"oid": "7c7ba2e0a0e7d9216ac9a39ef2a8f61f1bee2d83", "url": "https://github.com/palantir/atlasdb/commit/7c7ba2e0a0e7d9216ac9a39ef2a8f61f1bee2d83", "message": "Creation Params", "committedDate": "2020-10-01T23:09:45Z", "type": "commit"}, {"oid": "2af61a91257657ed74eee980e0811b835b86dad8", "url": "https://github.com/palantir/atlasdb/commit/2af61a91257657ed74eee980e0811b835b86dad8", "message": "fix", "committedDate": "2020-10-01T23:18:59Z", "type": "commit"}, {"oid": "7858b2f19c99964f2fc570a7d54dc25f4f44539a", "url": "https://github.com/palantir/atlasdb/commit/7858b2f19c99964f2fc570a7d54dc25f4f44539a", "message": "fix", "committedDate": "2020-10-01T23:22:23Z", "type": "commit"}, {"oid": "00998816bfccaae4a06378f709906ab241186423", "url": "https://github.com/palantir/atlasdb/commit/00998816bfccaae4a06378f709906ab241186423", "message": "more fixes", "committedDate": "2020-10-01T23:33:00Z", "type": "commit"}, {"oid": "5493891f42c3a6e439a78988dc3b4528a1343254", "url": "https://github.com/palantir/atlasdb/commit/5493891f42c3a6e439a78988dc3b4528a1343254", "message": " g4j029uv39 8h2y1u 2u49j30", "committedDate": "2020-10-01T23:37:41Z", "type": "commit"}, {"oid": "175476149ec07b1c974c3118c40a41d49384230a", "url": "https://github.com/palantir/atlasdb/commit/175476149ec07b1c974c3118c40a41d49384230a", "message": "baseli rn12g4303 j4r3", "committedDate": "2020-10-01T23:49:46Z", "type": "commit"}, {"oid": "bbca332246f3e9dea8852fc0ac6b690f418973cd", "url": "https://github.com/palantir/atlasdb/commit/bbca332246f3e9dea8852fc0ac6b690f418973cd", "message": " 13h0r4", "committedDate": "2020-10-01T23:54:32Z", "type": "commit"}, {"oid": "7fe12b22156e8e8db1211c6315e21796cbe7c0f0", "url": "https://github.com/palantir/atlasdb/commit/7fe12b22156e8e8db1211c6315e21796cbe7c0f0", "message": "some tests", "committedDate": "2020-10-02T00:31:44Z", "type": "commit"}, {"oid": "5846ea622994eb934ef9dfa819bb2e74b3193b6e", "url": "https://github.com/palantir/atlasdb/commit/5846ea622994eb934ef9dfa819bb2e74b3193b6e", "message": "Derive4j to the rescue", "committedDate": "2020-10-13T10:26:30Z", "type": "commit"}, {"oid": "ca7ae7493ea0838e112b829a80ab1c7c7c3f1944", "url": "https://github.com/palantir/atlasdb/commit/ca7ae7493ea0838e112b829a80ab1c7c7c3f1944", "message": "Clean up", "committedDate": "2020-10-13T10:46:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0MTkxNg==", "url": "https://github.com/palantir/atlasdb/pull/5014#discussion_r503841916", "bodyText": "Note: these indicate that the methods should be generated", "author": "gmaretic", "createdAt": "2020-10-13T10:29:31Z", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/config/DbTimestampCreationSetting.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.config;\n+\n+import java.util.Optional;\n+\n+import org.derive4j.Data;\n+\n+import com.palantir.atlasdb.keyvalue.api.TableReference;\n+import com.palantir.atlasdb.keyvalue.api.TimestampSeries;\n+\n+@Data\n+public abstract class DbTimestampCreationSetting {\n+    public interface Cases<R> {\n+        R multipleSeries(Optional<TableReference> tableReference, TimestampSeries series);\n+        R singleSeries(Optional<TableReference> tableReference);\n+    }\n+\n+    public abstract <R> R match(Cases<R> cases);\n+\n+    @Override", "originalCommit": "5846ea622994eb934ef9dfa819bb2e74b3193b6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkyOTIzNA==", "url": "https://github.com/palantir/atlasdb/pull/5014#discussion_r503929234", "bodyText": "interesting - I guess you wouldn't want them if you aren't testing or putting them in sets, though it does feel a bit awkward that these aren't by default", "author": "jeremyk-91", "createdAt": "2020-10-13T12:59:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0MTkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0OTAzMA==", "url": "https://github.com/palantir/atlasdb/pull/5014#discussion_r503849030", "bodyText": "Is it safe to just switch here?", "author": "gmaretic", "createdAt": "2020-10-13T10:42:11Z", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/DbBoundTimestampCreator.java", "diffHunk": "@@ -49,15 +52,18 @@ public DbBoundTimestampCreator(KeyValueServiceConfig kvsConfig) {\n                 Optional::empty,\n                 Optional.of(leaderConfig),\n                 Optional.empty(),\n-                Optional.of(AtlasDbConstants.LEGACY_TIMELOCK_TIMESTAMP_TABLE),\n+                Optional.of(getTimestampCreationParameters(client)),\n                 AtlasDbConstants.DEFAULT_INITIALIZE_ASYNC,\n                 AtlasDbFactory.THROWING_FRESH_TIMESTAMP_SOURCE);\n \n         TimestampService timestampService = atlasFactory.getManagedTimestampService();\n-        Preconditions.checkArgument(timestampService instanceof TimestampManagementService,\n-                \"The timestamp service is not a managed timestamp service.\");\n \n         return () -> new DelegatingManagedTimestampService(timestampService,\n                 (TimestampManagementService) timestampService);\n     }\n+\n+    @VisibleForTesting\n+    static DbTimestampCreationSetting getTimestampCreationParameters(Client client) {\n+        return DbTimestampCreationSettings.multipleSeries(Optional.empty(), TimestampSeries.of(client.value()));", "originalCommit": "5846ea622994eb934ef9dfa819bb2e74b3193b6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkyOTU2NA==", "url": "https://github.com/palantir/atlasdb/pull/5014#discussion_r503929564", "bodyText": "Yes. This isn't currently used in production anywhere. (This is a good flag though, it would be a fun P0 if it was actually used!)", "author": "jeremyk-91", "createdAt": "2020-10-13T12:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0OTAzMA=="}], "type": "inlineReview"}]}