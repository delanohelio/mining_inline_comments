{"pr_number": 4905, "pr_title": "Make all logging HikariCPConnectionManager SLS", "pr_createdAt": "2020-07-20T09:00:04Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4905", "timeline": [{"oid": "79ba0ccf86fb8547273a330ce55647209fcf341b", "url": "https://github.com/palantir/atlasdb/commit/79ba0ccf86fb8547273a330ce55647209fcf341b", "message": "SLS logging the rest", "committedDate": "2020-07-20T08:56:46Z", "type": "commit"}, {"oid": "464c4082c4043702d1f34700301b03318149d160", "url": "https://github.com/palantir/atlasdb/commit/464c4082c4043702d1f34700301b03318149d160", "message": "Add generated changelog entries", "committedDate": "2020-07-20T08:56:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMjgxMw==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457202813", "bodyText": "I think these all become unsafe anyway, but it's good hygiene.", "author": "jkozlowski", "createdAt": "2020-07-20T09:07:59Z", "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/HikariCPConnectionManager.java", "diffHunk": "@@ -237,7 +237,7 @@ public synchronized void close() {\n                     if (log.isDebugEnabled()) {\n                         log.debug(\n                                 \"Closing connection pool: {}\",\n-                                connConfig,\n+                                UnsafeArg.of(\"connConfig\", connConfig),", "originalCommit": "464c4082c4043702d1f34700301b03318149d160", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMjkyNw==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457202927", "bodyText": "Remove the '{}'", "author": "jkozlowski", "createdAt": "2020-07-20T09:08:12Z", "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/HikariCPConnectionManager.java", "diffHunk": "@@ -237,7 +237,7 @@ public synchronized void close() {\n                     if (log.isDebugEnabled()) {\n                         log.debug(\n                                 \"Closing connection pool: {}\",", "originalCommit": "464c4082c4043702d1f34700301b03318149d160", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxMTQ5MA==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457211490", "bodyText": "Done", "author": "Jolyon-S", "createdAt": "2020-07-20T09:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMjkyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMzAxOA==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457203018", "bodyText": "Ditto", "author": "jkozlowski", "createdAt": "2020-07-20T09:08:20Z", "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/HikariCPConnectionManager.java", "diffHunk": "@@ -282,7 +282,8 @@ private State normalState() throws SQLException {\n     private HikariDataSource getDataSourcePool() {\n         // Print a stack trace whenever we initialize a pool\n         if (log.isDebugEnabled()) {\n-            log.debug(\"Initializing connection pool: {}\", connConfig,\n+            log.debug(\"Initializing connection pool: {}\",", "originalCommit": "464c4082c4043702d1f34700301b03318149d160", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxMTcxOQ==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457211719", "bodyText": "Done", "author": "Jolyon-S", "createdAt": "2020-07-20T09:20:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMzAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMzMxMw==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457203313", "bodyText": "Check if this has hostnames, cause I don't think these are allowed?", "author": "jkozlowski", "createdAt": "2020-07-20T09:08:45Z", "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/HikariCPConnectionManager.java", "diffHunk": "@@ -304,7 +305,9 @@ private HikariDataSource getDataSourcePool() {\n             }\n         } catch (PoolInitializationException e) {\n             log.error(\"[{}] Failed to initialize hikari data source: {}\",\n-                    connConfig.getConnectionPoolName(), connConfig.getUrl(), e);\n+                    SafeArg.of(\"connectionPoolName\", connConfig.getConnectionPoolName()),", "originalCommit": "464c4082c4043702d1f34700301b03318149d160", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwNDgyNQ==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457204825", "bodyText": "Yeah, so internal spec says that managed hosts are safe. But I'm not convinced that this will always be the case here e.g. if this is running with Oracle (would this be running on Oracle?), so I'd prefer we keep unsafe until we're told otherwise.", "author": "jkozlowski", "createdAt": "2020-07-20T09:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMzMxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxNTE4MQ==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457215181", "bodyText": "In the previous PR to add some safe logging, this was added as Safe in other places, so I was following suit.\ngetConnectionPoolName is constructed as getConnectionPoolIdentifier()-getConnId(), where the former is db-pool and the latter is atlas as defaults. Obviously these can be overridden in the config, but I'd assume those two fields, given that they are just config (and not passwords or anything of that calibre either) would be fine, but maybe not.", "author": "Jolyon-S", "createdAt": "2020-07-20T09:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMzMxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxNTk2OQ==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457215969", "bodyText": "ok", "author": "jkozlowski", "createdAt": "2020-07-20T09:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMzMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMzQ4OQ==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457203489", "bodyText": "Remove placeholders", "author": "jkozlowski", "createdAt": "2020-07-20T09:08:59Z", "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/HikariCPConnectionManager.java", "diffHunk": "@@ -304,7 +305,9 @@ private HikariDataSource getDataSourcePool() {\n             }\n         } catch (PoolInitializationException e) {\n             log.error(\"[{}] Failed to initialize hikari data source: {}\",", "originalCommit": "464c4082c4043702d1f34700301b03318149d160", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxMTkyMA==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457211920", "bodyText": "Done", "author": "Jolyon-S", "createdAt": "2020-07-20T09:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMzQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIwMzY1MA==", "url": "https://github.com/palantir/atlasdb/pull/4905#discussion_r457203650", "bodyText": "Same here, check conection pool what it contains", "author": "jkozlowski", "createdAt": "2020-07-20T09:09:14Z", "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/HikariCPConnectionManager.java", "diffHunk": "@@ -345,7 +348,9 @@ private HikariPoolMXBean initPoolMbeans() {\n         try {\n             poolName = new ObjectName(\"com.zaxxer.hikari:type=Pool (\" + connConfig.getConnectionPoolName() + \")\");\n         } catch (MalformedObjectNameException e) {\n-            log.error(\"Unable to setup mBean monitoring for pool {}.\", connConfig.getConnectionPoolName(), e);\n+            log.error(\"Unable to setup mBean monitoring for pool {}.\",\n+                    SafeArg.of(\"connectionPoolName\", connConfig.getConnectionPoolName()),", "originalCommit": "464c4082c4043702d1f34700301b03318149d160", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "47ba4124bd2d2724edca1721faf844fe49ef8da8", "url": "https://github.com/palantir/atlasdb/commit/47ba4124bd2d2724edca1721faf844fe49ef8da8", "message": "PR comments", "committedDate": "2020-07-20T09:27:08Z", "type": "commit"}, {"oid": "6b4133178d52fdff565bb2ab71f71c30387189dc", "url": "https://github.com/palantir/atlasdb/commit/6b4133178d52fdff565bb2ab71f71c30387189dc", "message": "Merge branch 'safe-log-rest-hikari' of github.com:palantir/atlasdb into safe-log-rest-hikari", "committedDate": "2020-07-20T09:27:24Z", "type": "commit"}]}