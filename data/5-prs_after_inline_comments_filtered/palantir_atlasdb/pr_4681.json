{"pr_number": 4681, "pr_title": "[PDS-114184] Make Atlas CLI Validate Step Use Many Transactions", "pr_createdAt": "2020-03-27T11:04:56Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4681", "timeline": [{"oid": "196cb6a207d0505c780cd6da129e57539ed28e0b", "url": "https://github.com/palantir/atlasdb/commit/196cb6a207d0505c780cd6da129e57539ed28e0b", "message": "use many txns to validate instead", "committedDate": "2020-03-27T11:02:00Z", "type": "commit"}, {"oid": "92589ffbfb68052efaccd25bdd5b21468d2c85a9", "url": "https://github.com/palantir/atlasdb/commit/92589ffbfb68052efaccd25bdd5b21468d2c85a9", "message": "Add generated changelog entries", "committedDate": "2020-03-27T11:02:00Z", "type": "commit"}, {"oid": "5428dd5f269dc99d66afe76618c387fced56965b", "url": "https://github.com/palantir/atlasdb/commit/5428dd5f269dc99d66afe76618c387fced56965b", "message": "wrap in runtime exception", "committedDate": "2020-03-27T11:34:41Z", "type": "commit"}, {"oid": "d3591f775af7e396175d5ff89bd3cc97d3ac88a4", "url": "https://github.com/palantir/atlasdb/commit/d3591f775af7e396175d5ff89bd3cc97d3ac88a4", "message": "Merge branch 'validateManyTxns' of github.com:palantir/atlasdb into validateManyTxns", "committedDate": "2020-03-27T11:34:52Z", "type": "commit"}, {"oid": "5a2bd102d0a0d52ea3b89322ddba5b711540379c", "url": "https://github.com/palantir/atlasdb/commit/5a2bd102d0a0d52ea3b89322ddba5b711540379c", "message": "remove unnecessary diff", "committedDate": "2020-03-27T11:37:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxODQyMg==", "url": "https://github.com/palantir/atlasdb/pull/4681#discussion_r399218422", "bodyText": "Do you need this try-catch?", "author": "jkozlowski", "createdAt": "2020-03-27T12:07:38Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/schema/KeyValueServiceValidator.java", "diffHunk": "@@ -114,31 +113,27 @@ private void validateTables(Set<TableReference> tables) {\n \n     private void validateTable(final TableReference table) {\n         final int limit = getBatchSize(table);\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationFromTransactionManager.runTaskWithRetry(\n-                (TransactionTask<Map<Cell, byte[]>, RuntimeException>) t1 -> {\n-                    validateTable(table, limit, t1);\n-                    return null;\n-                });\n+        byte[] nextRowName = new byte[0];\n+        while (nextRowName != null) {\n+            nextRowName = validateNextRow(table, limit, nextRowName);\n+        }\n         KeyValueServiceMigratorUtils\n                 .processMessage(messageProcessor, \"Validated \" + table, KvsMigrationMessageLevel.INFO);\n     }\n \n-    private void validateTable(final TableReference table, final int limit, final Transaction t1) {\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationToTransactionManager.runTaskWithRetry(\n-                (TransactionTask<Map<Cell, byte[]>, RuntimeException>) t2 -> {\n-                    validateTable(table, limit, t1, t2);\n-                    return null;\n-                });\n-    }\n-\n-    private void validateTable(TableReference table, int limit, Transaction t1, Transaction t2) {\n-        RangeRequest.Builder builder = RangeRequest.builder().batchHint(limit);\n-        byte[] nextRowName = new byte[0];\n-        while (nextRowName != null) {\n-            RangeRequest range = builder.startRowInclusive(nextRowName).build();\n-            nextRowName = validateAndGetNextRowName(table, limit, t1, t2, range);\n+    private byte[] validateNextRow(TableReference table, int limit, byte[] nextRowName) {\n+        try {\n+            return validationFromTransactionManager.runTaskWithRetry(t1 ->\n+                    validationToTransactionManager.runTaskWithRetry(t2 -> {\n+                                RangeRequest range = RangeRequest.builder()\n+                                        .batchHint(limit)\n+                                        .startRowInclusive(nextRowName)\n+                                        .build();\n+                                return validateAndGetNextRowName(table, limit, t1, t2, range);\n+                            }\n+                    ));\n+        } catch (Exception e) {", "originalCommit": "5a2bd102d0a0d52ea3b89322ddba5b711540379c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MDI1NA==", "url": "https://github.com/palantir/atlasdb/pull/4681#discussion_r399250254", "bodyText": "gradle complains if I don't", "author": "Jolyon-S", "createdAt": "2020-03-27T13:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxODQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxODgwOA==", "url": "https://github.com/palantir/atlasdb/pull/4681#discussion_r399218808", "bodyText": "Can you keep this comment, it's pretty important.", "author": "jkozlowski", "createdAt": "2020-03-27T12:08:20Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/schema/KeyValueServiceValidator.java", "diffHunk": "@@ -114,31 +113,27 @@ private void validateTables(Set<TableReference> tables) {\n \n     private void validateTable(final TableReference table) {\n         final int limit = getBatchSize(table);\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH", "originalCommit": "5a2bd102d0a0d52ea3b89322ddba5b711540379c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxOTQ3Mg==", "url": "https://github.com/palantir/atlasdb/pull/4681#discussion_r399219472", "bodyText": "Feels like creating this range should belong in validateAndGetNextRowName", "author": "jkozlowski", "createdAt": "2020-03-27T12:09:38Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/schema/KeyValueServiceValidator.java", "diffHunk": "@@ -114,31 +113,27 @@ private void validateTables(Set<TableReference> tables) {\n \n     private void validateTable(final TableReference table) {\n         final int limit = getBatchSize(table);\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationFromTransactionManager.runTaskWithRetry(\n-                (TransactionTask<Map<Cell, byte[]>, RuntimeException>) t1 -> {\n-                    validateTable(table, limit, t1);\n-                    return null;\n-                });\n+        byte[] nextRowName = new byte[0];\n+        while (nextRowName != null) {\n+            nextRowName = validateNextRow(table, limit, nextRowName);\n+        }\n         KeyValueServiceMigratorUtils\n                 .processMessage(messageProcessor, \"Validated \" + table, KvsMigrationMessageLevel.INFO);\n     }\n \n-    private void validateTable(final TableReference table, final int limit, final Transaction t1) {\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationToTransactionManager.runTaskWithRetry(\n-                (TransactionTask<Map<Cell, byte[]>, RuntimeException>) t2 -> {\n-                    validateTable(table, limit, t1, t2);\n-                    return null;\n-                });\n-    }\n-\n-    private void validateTable(TableReference table, int limit, Transaction t1, Transaction t2) {\n-        RangeRequest.Builder builder = RangeRequest.builder().batchHint(limit);\n-        byte[] nextRowName = new byte[0];\n-        while (nextRowName != null) {\n-            RangeRequest range = builder.startRowInclusive(nextRowName).build();\n-            nextRowName = validateAndGetNextRowName(table, limit, t1, t2, range);\n+    private byte[] validateNextRow(TableReference table, int limit, byte[] nextRowName) {\n+        try {\n+            return validationFromTransactionManager.runTaskWithRetry(t1 ->\n+                    validationToTransactionManager.runTaskWithRetry(t2 -> {\n+                                RangeRequest range = RangeRequest.builder()", "originalCommit": "5a2bd102d0a0d52ea3b89322ddba5b711540379c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxOTk2OQ==", "url": "https://github.com/palantir/atlasdb/pull/4681#discussion_r399219969", "bodyText": "Actually, it's probably fine.", "author": "jkozlowski", "createdAt": "2020-03-27T12:10:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxOTQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMTkyOA==", "url": "https://github.com/palantir/atlasdb/pull/4681#discussion_r399221928", "bodyText": "This change means that with default batch size, we'll do a transaction each 100 rows, so it will be probably quite slow, but probably fine.", "author": "jkozlowski", "createdAt": "2020-03-27T12:14:32Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/schema/KeyValueServiceValidator.java", "diffHunk": "@@ -114,31 +113,27 @@ private void validateTables(Set<TableReference> tables) {\n \n     private void validateTable(final TableReference table) {\n         final int limit = getBatchSize(table);\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationFromTransactionManager.runTaskWithRetry(\n-                (TransactionTask<Map<Cell, byte[]>, RuntimeException>) t1 -> {\n-                    validateTable(table, limit, t1);\n-                    return null;\n-                });\n+        byte[] nextRowName = new byte[0];\n+        while (nextRowName != null) {\n+            nextRowName = validateNextRow(table, limit, nextRowName);\n+        }\n         KeyValueServiceMigratorUtils\n                 .processMessage(messageProcessor, \"Validated \" + table, KvsMigrationMessageLevel.INFO);\n     }\n \n-    private void validateTable(final TableReference table, final int limit, final Transaction t1) {\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationToTransactionManager.runTaskWithRetry(\n-                (TransactionTask<Map<Cell, byte[]>, RuntimeException>) t2 -> {\n-                    validateTable(table, limit, t1, t2);\n-                    return null;\n-                });\n-    }\n-\n-    private void validateTable(TableReference table, int limit, Transaction t1, Transaction t2) {\n-        RangeRequest.Builder builder = RangeRequest.builder().batchHint(limit);\n-        byte[] nextRowName = new byte[0];\n-        while (nextRowName != null) {\n-            RangeRequest range = builder.startRowInclusive(nextRowName).build();\n-            nextRowName = validateAndGetNextRowName(table, limit, t1, t2, range);\n+    private byte[] validateNextRow(TableReference table, int limit, byte[] nextRowName) {\n+        try {\n+            return validationFromTransactionManager.runTaskWithRetry(t1 ->", "originalCommit": "5a2bd102d0a0d52ea3b89322ddba5b711540379c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4MzE1Mw==", "url": "https://github.com/palantir/atlasdb/pull/4681#discussion_r453583153", "bodyText": "This should be fine, most people override this anyway. And it's run with embedded timelock usually, so overhead should be minimal.", "author": "jkozlowski", "createdAt": "2020-07-13T11:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMTkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxOTY4OQ==", "url": "https://github.com/palantir/atlasdb/pull/4681#discussion_r399219689", "bodyText": "Please retain the comment on why this is runTaskWithRetry: it's non-obvious.", "author": "jeremyk-91", "createdAt": "2020-03-27T12:10:01Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/schema/KeyValueServiceValidator.java", "diffHunk": "@@ -114,31 +113,27 @@ private void validateTables(Set<TableReference> tables) {\n \n     private void validateTable(final TableReference table) {\n         final int limit = getBatchSize(table);\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationFromTransactionManager.runTaskWithRetry(\n-                (TransactionTask<Map<Cell, byte[]>, RuntimeException>) t1 -> {\n-                    validateTable(table, limit, t1);\n-                    return null;\n-                });\n+        byte[] nextRowName = new byte[0];\n+        while (nextRowName != null) {\n+            nextRowName = validateNextRow(table, limit, nextRowName);\n+        }\n         KeyValueServiceMigratorUtils\n                 .processMessage(messageProcessor, \"Validated \" + table, KvsMigrationMessageLevel.INFO);\n     }\n \n-    private void validateTable(final TableReference table, final int limit, final Transaction t1) {\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationToTransactionManager.runTaskWithRetry(\n-                (TransactionTask<Map<Cell, byte[]>, RuntimeException>) t2 -> {\n-                    validateTable(table, limit, t1, t2);\n-                    return null;\n-                });\n-    }\n-\n-    private void validateTable(TableReference table, int limit, Transaction t1, Transaction t2) {\n-        RangeRequest.Builder builder = RangeRequest.builder().batchHint(limit);\n-        byte[] nextRowName = new byte[0];\n-        while (nextRowName != null) {\n-            RangeRequest range = builder.startRowInclusive(nextRowName).build();\n-            nextRowName = validateAndGetNextRowName(table, limit, t1, t2, range);\n+    private byte[] validateNextRow(TableReference table, int limit, byte[] nextRowName) {\n+        try {\n+            return validationFromTransactionManager.runTaskWithRetry(t1 ->", "originalCommit": "5a2bd102d0a0d52ea3b89322ddba5b711540379c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxOTg5NQ==", "url": "https://github.com/palantir/atlasdb/pull/4681#discussion_r399219895", "bodyText": "nit: validateNextBatchOfRows / startRow for the param?", "author": "jeremyk-91", "createdAt": "2020-03-27T12:10:26Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/schema/KeyValueServiceValidator.java", "diffHunk": "@@ -114,31 +113,27 @@ private void validateTables(Set<TableReference> tables) {\n \n     private void validateTable(final TableReference table) {\n         final int limit = getBatchSize(table);\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationFromTransactionManager.runTaskWithRetry(\n-                (TransactionTask<Map<Cell, byte[]>, RuntimeException>) t1 -> {\n-                    validateTable(table, limit, t1);\n-                    return null;\n-                });\n+        byte[] nextRowName = new byte[0];\n+        while (nextRowName != null) {\n+            nextRowName = validateNextRow(table, limit, nextRowName);\n+        }\n         KeyValueServiceMigratorUtils\n                 .processMessage(messageProcessor, \"Validated \" + table, KvsMigrationMessageLevel.INFO);\n     }\n \n-    private void validateTable(final TableReference table, final int limit, final Transaction t1) {\n-        // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationToTransactionManager.runTaskWithRetry(\n-                (TransactionTask<Map<Cell, byte[]>, RuntimeException>) t2 -> {\n-                    validateTable(table, limit, t1, t2);\n-                    return null;\n-                });\n-    }\n-\n-    private void validateTable(TableReference table, int limit, Transaction t1, Transaction t2) {\n-        RangeRequest.Builder builder = RangeRequest.builder().batchHint(limit);\n-        byte[] nextRowName = new byte[0];\n-        while (nextRowName != null) {\n-            RangeRequest range = builder.startRowInclusive(nextRowName).build();\n-            nextRowName = validateAndGetNextRowName(table, limit, t1, t2, range);\n+    private byte[] validateNextRow(TableReference table, int limit, byte[] nextRowName) {", "originalCommit": "5a2bd102d0a0d52ea3b89322ddba5b711540379c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e70c3ee59c22b657103541ee8ce8965293e463c3", "url": "https://github.com/palantir/atlasdb/commit/e70c3ee59c22b657103541ee8ce8965293e463c3", "message": "Merge branch 'develop' into validateManyTxns\n\n# Conflicts:\n#\tatlasdb-impl-shared/src/main/java/com/palantir/atlasdb/schema/KeyValueServiceValidator.java", "committedDate": "2020-07-13T11:43:59Z", "type": "commit"}, {"oid": "cc8a6d29c2b44d2811cb66cb17748a9d79364692", "url": "https://github.com/palantir/atlasdb/commit/cc8a6d29c2b44d2811cb66cb17748a9d79364692", "message": "merge in develop and action comments", "committedDate": "2020-07-13T11:45:30Z", "type": "commit"}, {"oid": "c3124b9608a3bf8b8cbed9acd304b133e330e543", "url": "https://github.com/palantir/atlasdb/commit/c3124b9608a3bf8b8cbed9acd304b133e330e543", "message": "Merge branch 'develop' into validateManyTxns", "committedDate": "2020-07-20T10:23:45Z", "type": "commit"}, {"oid": "9d475c773e5b6a149d9c3c3ab687abcc004ca796", "url": "https://github.com/palantir/atlasdb/commit/9d475c773e5b6a149d9c3c3ab687abcc004ca796", "message": "fix checkstyle", "committedDate": "2020-07-28T11:55:23Z", "type": "commit"}]}