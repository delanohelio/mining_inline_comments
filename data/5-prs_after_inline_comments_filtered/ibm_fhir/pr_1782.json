{"pr_number": 1782, "pr_title": "fix: version history is case sensitive, and fails when customers chan\u2026", "pr_createdAt": "2020-12-03T13:48:00Z", "pr_url": "https://github.com/IBM/FHIR/pull/1782", "timeline": [{"oid": "8bf9ddc286424e68d2cfb03eb6d40d7d81532de8", "url": "https://github.com/IBM/FHIR/commit/8bf9ddc286424e68d2cfb03eb6d40d7d81532de8", "message": "fix: version history is case sensitive, and fails when customers change the case sensisitivity of their schema names\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-12-03T13:47:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTE3NQ==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535241175", "bodyText": "Going forward this would always ensure the schemaname is uppercase in the VHS table", "author": "prb112", "createdAt": "2020-12-03T13:48:59Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/version/VersionHistoryService.java", "diffHunk": "@@ -126,7 +126,7 @@ public void insertVersionHistoriesInTx(Collection<TypeNameVersion> versionHistor\n      * @param version\n      */\n     public void insertVersionHistoryInTx(String objectSchema, String objectType, String objectName, int version) {\n-        AddVersionDAO dao = new AddVersionDAO(adminSchemaName, objectSchema, objectType, objectName, version);\n+        AddVersionDAO dao = new AddVersionDAO(adminSchemaName, objectSchema.toUpperCase(), objectType, objectName, version);", "originalCommit": "8bf9ddc286424e68d2cfb03eb6d40d7d81532de8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTM0Mw==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535241343", "bodyText": "Make sure we are forcing any incoming applies to be uppercase", "author": "prb112", "createdAt": "2020-12-03T13:49:14Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/version/VersionHistoryService.java", "diffHunk": "@@ -204,7 +204,7 @@ public void addVersion(String objectSchema, String objectType, String objectName\n \n     @Override\n     public boolean applies(String objectSchema, String objectType, String objectName, int changeVersion) {\n-        String key = objectSchema + \":\" + objectType + \":\" + objectName;\n+        String key = objectSchema.toUpperCase() + \":\" + objectType + \":\" + objectName;", "originalCommit": "8bf9ddc286424e68d2cfb03eb6d40d7d81532de8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTU0Mw==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535241543", "bodyText": "I threw this in as uppercase for consistency", "author": "prb112", "createdAt": "2020-12-03T13:49:31Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/version/GetLatestVersionDAO.java", "diffHunk": "@@ -59,7 +59,7 @@ public GetLatestVersionDAO(String adminSchemaName, String schemaName) {\n             ps.setString(2, schemaName);\n             ResultSet rs = ps.executeQuery();\n             while (rs.next()) {\n-                String schema = rs.getString(1);\n+                String schema = rs.getString(1).toUpperCase();", "originalCommit": "8bf9ddc286424e68d2cfb03eb6d40d7d81532de8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM2MDM3Mw==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535360373", "bodyText": "Performance note: using WHERE UPPER(my_col) = ... can have performance implications because it often means that you can't use an index (on my_col). But in this case, it's unlikely to have a significant impact, because the row counts are relatively low.", "author": "punktilious", "createdAt": "2020-12-03T15:56:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM2NjU4Mw==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535366583", "bodyText": "good point.", "author": "prb112", "createdAt": "2020-12-03T16:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTcwMw==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535241703", "bodyText": "I wrapped this in ucase for backwards compatiblity", "author": "prb112", "createdAt": "2020-12-03T13:49:44Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/version/GetLatestVersionDAO.java", "diffHunk": "@@ -50,7 +50,7 @@ public GetLatestVersionDAO(String adminSchemaName, String schemaName) {\n         final String cols = DataDefinitionUtil.join(SchemaConstants.SCHEMA_NAME, SchemaConstants.OBJECT_TYPE, SchemaConstants.OBJECT_NAME);\n         final String sql = \"SELECT \" + cols\n                 + \", max(\" + SchemaConstants.VERSION + \") FROM \" + tbl\n-                + \" WHERE \" + SchemaConstants.SCHEMA_NAME + \" IN (?, ?) \"\n+                + \" WHERE UCASE(\" + SchemaConstants.SCHEMA_NAME + \") IN (UCASE(?), UCASE(?)) \"", "originalCommit": "8bf9ddc286424e68d2cfb03eb6d40d7d81532de8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1NTU4OA==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535255588", "bodyText": "swapped to  UPPER", "author": "prb112", "createdAt": "2020-12-03T14:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1NTgyMg==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535255822", "bodyText": "I don't think you should UCASE(?) the args like that...because it suggests you don't know what case the args are. We should be making sure the args are upper-case before that (because it's probably important for equals and HashMap lookups in other places). The first place I'd force case is when we parse the CLI argument in Main.", "author": "punktilious", "createdAt": "2020-12-03T14:09:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI2Mjg2OA==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535262868", "bodyText": "OK -  I sort of agree, However there is an inconsistency across versions I'd like too account for,  also schema names in postgres tend  to be lowercase versus uppercase  in db2.", "author": "prb112", "createdAt": "2020-12-03T14:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM1MTQ3Nw==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535351477", "bodyText": "I was thinking normalizing casing here was critical for backwards compatibility.  If there is an existing version history service value thats been saved as lowercase, we need the new uppercase schema name to match it, right?", "author": "lmsurpre", "createdAt": "2020-12-03T15:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM2NjE5NQ==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535366195", "bodyText": "Correct, I do that when we process the result sets down further on in", "author": "prb112", "createdAt": "2020-12-03T16:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MTcwMw=="}], "type": "inlineReview"}, {"oid": "26cad98be093c512954df38ec1fcc1a6b218eaa9", "url": "https://github.com/IBM/FHIR/commit/26cad98be093c512954df38ec1fcc1a6b218eaa9", "message": "fix: ucase is changed to upper\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-12-03T14:07:05Z", "type": "commit"}, {"oid": "c2193720060c03214cfab6924175a7a0b7854894", "url": "https://github.com/IBM/FHIR/commit/c2193720060c03214cfab6924175a7a0b7854894", "message": "fix: schema issue\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-12-03T15:20:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyNTI3NQ==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535325275", "bodyText": "I removed it as it was never used", "author": "prb112", "createdAt": "2020-12-03T15:21:47Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -146,11 +138,6 @@\n     private boolean dropJavaBatchSchema = false;\n     private boolean grantJavaBatchSchema = false;\n \n-    // By default, the dryRun option is OFF, and FALSE\n-    // When overridden, it simulates the actions.\n-    @SuppressWarnings(\"unused\")\n-    private boolean dryRun = false;\n-", "originalCommit": "c2193720060c03214cfab6924175a7a0b7854894", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQxMjM1NA==", "url": "https://github.com/IBM/FHIR/pull/1782#discussion_r535412354", "bodyText": "sounds good, though I'd still like to add it back in at some point!", "author": "lmsurpre", "createdAt": "2020-12-03T16:58:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyNTI3NQ=="}], "type": "inlineReview"}, {"oid": "6833eb59b53e0764547500c9329ecddf6e9ca700", "url": "https://github.com/IBM/FHIR/commit/6833eb59b53e0764547500c9329ecddf6e9ca700", "message": "Merge branch 'master' into fix-sp-fun", "committedDate": "2020-12-03T15:28:06Z", "type": "commit"}]}