{"pr_number": 740, "pr_title": "issue #675 enable tenant/datastore support for searchalltest", "pr_createdAt": "2020-02-28T17:49:30Z", "pr_url": "https://github.com/IBM/FHIR/pull/740", "timeline": [{"oid": "fcbae4827dd133b2fa183556cd1c536870737406", "url": "https://github.com/IBM/FHIR/commit/fcbae4827dd133b2fa183556cd1c536870737406", "message": "issue #675 enable tenant/datastore support for searchalltest\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-02-28T17:48:11Z", "type": "commit"}, {"oid": "f94d6226704e48cb15ad96f17776e447546bae94", "url": "https://github.com/IBM/FHIR/commit/f94d6226704e48cb15ad96f17776e447546bae94", "message": "#issue #675 tool for breaking huge COS ndjson files\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-03-03T14:58:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA3OTQ5MQ==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387079491", "bodyText": "date\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * (C) Copyright IBM Corp. 2019\n          \n          \n            \n             * (C) Copyright IBM Corp. 2019, 2020", "author": "prb112", "createdAt": "2020-03-03T15:02:38Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulktools/Main.java", "diffHunk": "@@ -0,0 +1,278 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019", "originalCommit": "f94d6226704e48cb15ad96f17776e447546bae94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NDY4MQ==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387084681", "bodyText": "ha, good catch. will change", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA3OTQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNTUyNw==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387115527", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA3OTQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MTA4OA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387081088", "bodyText": "it's not really an override? it's a specific implementation", "author": "prb112", "createdAt": "2020-03-03T15:05:02Z", "path": "fhir-client/src/main/java/com/ibm/fhir/client/impl/FHIRClientImpl.java", "diffHunk": "@@ -767,15 +768,16 @@ protected synchronized Client getClient() throws Exception {\n             // Add a hostname verifier if we're using an ssl transport.\n             if (usingSSLTransport() && !isHostnameVerificationEnabled()) {\n                 cb = cb.hostnameVerifier(new HostnameVerifier() {\n+                    @Override", "originalCommit": "f94d6226704e48cb15ad96f17776e447546bae94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4ODgzMA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387088830", "bodyText": "en... interesting... this was not added by me, let me try to remove it and see", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:16:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MTA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MDYwMA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387090600", "bodyText": "can not be removed, it's always be added back automatically. and the function is abstract, so seems have to override.", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MTA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MTU4Ng==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387081586", "bodyText": "addRequestHeaders - where does this come from what does it do?", "author": "prb112", "createdAt": "2020-03-03T15:05:43Z", "path": "fhir-client/src/main/java/com/ibm/fhir/client/impl/FHIRClientImpl.java", "diffHunk": "@@ -452,10 +452,11 @@ public FHIRResponse searchAll(FHIRParameters parameters, boolean isPost, FHIRReq\n         } else {\n             endpoint = endpoint.path(\"_search\");\n             builder = endpoint.request(getDefaultMimeType());\n+            builder = addRequestHeaders(builder, headers);", "originalCommit": "f94d6226704e48cb15ad96f17776e447546bae94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NTU1MA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387085550", "bodyText": "this is used for adding the tenant and datastore headers.", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MTU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4ODYzNA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387088634", "bodyText": "Should the test be renamed to indicate that it is testing a different tenant?", "author": "prb112", "createdAt": "2020-03-03T15:15:58Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/SearchAllTest.java", "diffHunk": "@@ -390,7 +407,10 @@ public void testCreatePatientAndObservationWithUniqueTag() throws Exception {\n                         .build();\n \n         Entity<Patient> entity = Entity.entity(patient, FHIRMediaType.APPLICATION_FHIR_JSON);\n-        Response response = target.path(\"Patient\").request().post(entity, Response.class);\n+        Response response = target.path(\"Patient\").request()", "originalCommit": "f94d6226704e48cb15ad96f17776e447546bae94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4ODk2OA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387088968", "bodyText": "maybe event a comment explaining what is happening", "author": "prb112", "createdAt": "2020-03-03T15:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4ODYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MjUzOA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387092538", "bodyText": "I wanted to just enable it for tenant specific test, but I don't want to change the default behavior - testing the default ds of the default tenant.    I just want to change the tenant in my local to do some simple performance tests against my test tenants.", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:21:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4ODYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5Mjk5NA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387092994", "bodyText": "good point, let me add comments", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4ODYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNTMyMA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387115320", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4ODYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MjkyNw==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387092927", "bodyText": "I don't think this is necessary... Let it naturally fall out.", "author": "prb112", "createdAt": "2020-03-03T15:22:06Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulktools/Main.java", "diffHunk": "@@ -0,0 +1,278 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package com.ibm.fhir.bulktools;\n+\n+import java.io.BufferedReader;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+import com.ibm.cloud.objectstorage.services.s3.AmazonS3;\n+import com.ibm.cloud.objectstorage.services.s3.model.GetObjectRequest;\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.cloud.objectstorage.services.s3.model.S3Object;\n+import com.ibm.cloud.objectstorage.services.s3.model.S3ObjectInputStream;\n+import com.ibm.fhir.bulkcommon.BulkDataUtils;\n+import com.ibm.fhir.bulkcommon.Constants;\n+\n+/**\n+ * Tool to break large COS file into multiple ones.\n+ */\n+public class Main {\n+    private static final Logger logger = Logger.getLogger(Main.class.getName());\n+\n+    // number of nanoseconds in a second\n+    private static final double NANOS = 1e9;\n+\n+    /**\n+     * The IBM COS API key or S3 access key.\n+     */\n+    private static String cosApiKey;\n+\n+    /**\n+     * The IBM COS service instance id or S3 secret key.\n+     */\n+    private static String cosSrvinstId;\n+\n+    /**\n+     * The IBM COS or S3 End point URL.\n+     */\n+    private static String cosEndpintUrl;\n+\n+    /**\n+     * The IBM COS or S3 location.\n+     */\n+    private static String cosLocation;\n+\n+    /**\n+     * The IBM COS or S3 bucket name to import from.\n+     */\n+    private static String cosBucketName;\n+\n+    /**\n+     * If use IBM credential.\n+     */\n+    private static String cosCredentialIbm;\n+\n+    /**\n+     * The COS file to break.\n+     */\n+    private static String cosFile2Break;\n+\n+    /**\n+     * The number of files to break into.\n+     */\n+    private static int numberOfFiles;\n+\n+    /**\n+     * Parse the command line arguments\n+     *   --cosApiKey\n+     *   --cosSrvinstId\n+     *   --cosEndpintUrl\n+     *   --cosLocation\n+     *   --cosBucketName\n+     *   --cosCredentialIbm\n+     *   --cosFile2Break\n+     *   --numberOfFiles\n+     * @param args\n+     */\n+    public void parseArgs(String[] args) {\n+        // really simple args, so nothing fancy needed here\n+        for (int i=0; i<args.length; i++) {\n+            String arg = args[i];\n+            switch (arg) {\n+            case \"--cosApiKey\":\n+                if (++i < args.length) {\n+                    cosApiKey = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosApiKey argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosSrvinstId\":\n+                if (++i < args.length) {\n+                    cosSrvinstId = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosSrvinstId argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosEndpintUrl\":\n+                if (++i < args.length) {\n+                    cosEndpintUrl = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosEndpintUrl argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosLocation\":\n+                if (++i < args.length) {\n+                    cosLocation = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosLocation argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosBucketName\":\n+                if (++i < args.length) {\n+                    cosBucketName = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosBucketName argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosCredentialIbm\":\n+                if (++i < args.length) {\n+                    cosCredentialIbm = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosCredentialIbm argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosFile2Break\":\n+                if (++i < args.length) {\n+                    cosFile2Break = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosFile2Break argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--numberOfFiles\":\n+                if (++i < args.length) {\n+                    numberOfFiles = Integer.parseInt(args[i]);\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --numberOfFiles argument at posn: \" + i);\n+                }\n+                break;\n+            default:\n+                throw new IllegalArgumentException(\"Invalid argument: \" + arg);\n+            }\n+        }\n+    }\n+\n+\n+    private int getFhirResourceNumberFromBufferReader(BufferedReader resReader) throws Exception {\n+        int lineRed = 0;\n+        while (true) {\n+                String resLine = resReader.readLine();\n+                lineRed++;\n+                if (resLine == null) {\n+                    System.out.println(\"\\n Count finished!!!!!\");\n+                    break;\n+                } else {\n+                    System.out.print(\".\");\n+                }\n+        }\n+        return lineRed;\n+    }\n+\n+\n+\n+    private void writeFhirResourceFromBufferReader(BufferedReader resReader,  AmazonS3 cosClient, ByteArrayOutputStream bufferStream, int numOfRes4Seg) throws Exception {\n+        int lineRed = 0;\n+        int segNum = 0;\n+        List<PartETag> dataPackTags = new ArrayList<>();\n+        String uploadId = null;\n+        int partNum = 1;\n+        boolean isMore2Read = true;\n+        while (isMore2Read) {\n+                String resLine = resReader.readLine();\n+                lineRed++;\n+                if (resLine == null) {\n+                    System.out.println(\"\\n Read finished!!!!!\");\n+                    isMore2Read = false;\n+                } else {\n+                    System.out.print(\".\");\n+                    bufferStream.write(resLine.getBytes());\n+                    bufferStream.write(Constants.NDJSON_LINESEPERATOR);\n+                }\n+\n+                if (bufferStream.size() > Constants.COS_PART_MINIMALSIZE\n+                        || (segNum < numberOfFiles - 1 && lineRed == numOfRes4Seg)\n+                        || !isMore2Read) {\n+                    String segName = cosFile2Break + \"_seg\" + segNum;\n+                    if (uploadId == null) {\n+                        uploadId = BulkDataUtils.startPartUpload(cosClient, cosBucketName, segName, true);\n+                    }\n+\n+                    if (bufferStream.size() > 0) {\n+                        dataPackTags.add(BulkDataUtils.multiPartUpload(cosClient, cosBucketName, segName,uploadId,\n+                                new ByteArrayInputStream(bufferStream.toByteArray()), bufferStream.size(), partNum++));\n+                        bufferStream.reset();\n+                    }\n+\n+                    if (segNum < numberOfFiles - 1 && lineRed == numOfRes4Seg\n+                            || !isMore2Read) {\n+                        BulkDataUtils.finishMultiPartUpload(cosClient, cosBucketName, segName, uploadId, dataPackTags);\n+                        System.out.println(\"Finished writting for \" + segName);\n+                        lineRed = 0;\n+                        segNum++;\n+                        uploadId = null;\n+                        partNum = 1;\n+                        dataPackTags.clear();\n+                    }\n+                }\n+        }\n+\n+    }\n+\n+\n+    /**\n+     * Main entry\n+     * @param args\n+     */\n+    public static void main(String[] args) {\n+        Main m = new Main();\n+        try {\n+            m.parseArgs(args);\n+\n+            long start = System.nanoTime();\n+            int totalNum = 0;\n+\n+            AmazonS3 cosClient = BulkDataUtils.getCosClient(cosCredentialIbm, cosApiKey, cosSrvinstId, cosEndpintUrl,\n+                    cosLocation);\n+            if (cosClient == null) {\n+                logger.warning(\"Failed to get CosClient!\");\n+                System.exit(1);\n+            }\n+\n+            S3Object item = cosClient.getObject(new GetObjectRequest(cosBucketName, cosFile2Break));\n+            try (S3ObjectInputStream s3InStream = item.getObjectContent();\n+                    BufferedReader resReader = new BufferedReader(new InputStreamReader(s3InStream))) {\n+                   totalNum = m.getFhirResourceNumberFromBufferReader(resReader);\n+               } catch (Exception ioe) {\n+                   logger.warning(\"Error proccesing file \" + cosFile2Break + \" - \" + ioe.getMessage());\n+                   System.exit(1);\n+               }\n+\n+            ByteArrayOutputStream bufferStream = new ByteArrayOutputStream();\n+            int numOfRes4Seg = totalNum/numberOfFiles;\n+\n+            item = cosClient.getObject(new GetObjectRequest(cosBucketName, cosFile2Break));\n+            try (S3ObjectInputStream s3InStream = item.getObjectContent();\n+                    BufferedReader resReader = new BufferedReader(new InputStreamReader(s3InStream))) {\n+                m.writeFhirResourceFromBufferReader(resReader, cosClient, bufferStream, numOfRes4Seg);\n+               } catch (Exception ioe) {\n+                   logger.warning(\"Error proccesing file \" + cosFile2Break + \" - \" + ioe.getMessage());\n+                   System.exit(1);\n+               }\n+\n+            long end = System.nanoTime();\n+            logger.info(String.format(\"Total Resources: %d, Took: %6.3f seconds\", totalNum, (end-start)/NANOS));\n+        }\n+        catch (Exception x) {\n+            logger.log(Level.SEVERE, \"Failed to run\", x);\n+        }\n+        finally {\n+            System.exit(0);", "originalCommit": "f94d6226704e48cb15ad96f17776e447546bae94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5NDYyNA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387094624", "bodyText": "I added this on purpose for running inside eclipse, without this, in my tests, eclipse always shows the app is not finished - very annoying.", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MjkyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MzI1OQ==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387093259", "bodyText": "Use a logger", "author": "prb112", "createdAt": "2020-03-03T15:22:35Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulktools/Main.java", "diffHunk": "@@ -0,0 +1,278 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package com.ibm.fhir.bulktools;\n+\n+import java.io.BufferedReader;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+import com.ibm.cloud.objectstorage.services.s3.AmazonS3;\n+import com.ibm.cloud.objectstorage.services.s3.model.GetObjectRequest;\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.cloud.objectstorage.services.s3.model.S3Object;\n+import com.ibm.cloud.objectstorage.services.s3.model.S3ObjectInputStream;\n+import com.ibm.fhir.bulkcommon.BulkDataUtils;\n+import com.ibm.fhir.bulkcommon.Constants;\n+\n+/**\n+ * Tool to break large COS file into multiple ones.\n+ */\n+public class Main {\n+    private static final Logger logger = Logger.getLogger(Main.class.getName());\n+\n+    // number of nanoseconds in a second\n+    private static final double NANOS = 1e9;\n+\n+    /**\n+     * The IBM COS API key or S3 access key.\n+     */\n+    private static String cosApiKey;\n+\n+    /**\n+     * The IBM COS service instance id or S3 secret key.\n+     */\n+    private static String cosSrvinstId;\n+\n+    /**\n+     * The IBM COS or S3 End point URL.\n+     */\n+    private static String cosEndpintUrl;\n+\n+    /**\n+     * The IBM COS or S3 location.\n+     */\n+    private static String cosLocation;\n+\n+    /**\n+     * The IBM COS or S3 bucket name to import from.\n+     */\n+    private static String cosBucketName;\n+\n+    /**\n+     * If use IBM credential.\n+     */\n+    private static String cosCredentialIbm;\n+\n+    /**\n+     * The COS file to break.\n+     */\n+    private static String cosFile2Break;\n+\n+    /**\n+     * The number of files to break into.\n+     */\n+    private static int numberOfFiles;\n+\n+    /**\n+     * Parse the command line arguments\n+     *   --cosApiKey\n+     *   --cosSrvinstId\n+     *   --cosEndpintUrl\n+     *   --cosLocation\n+     *   --cosBucketName\n+     *   --cosCredentialIbm\n+     *   --cosFile2Break\n+     *   --numberOfFiles\n+     * @param args\n+     */\n+    public void parseArgs(String[] args) {\n+        // really simple args, so nothing fancy needed here\n+        for (int i=0; i<args.length; i++) {\n+            String arg = args[i];\n+            switch (arg) {\n+            case \"--cosApiKey\":\n+                if (++i < args.length) {\n+                    cosApiKey = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosApiKey argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosSrvinstId\":\n+                if (++i < args.length) {\n+                    cosSrvinstId = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosSrvinstId argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosEndpintUrl\":\n+                if (++i < args.length) {\n+                    cosEndpintUrl = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosEndpintUrl argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosLocation\":\n+                if (++i < args.length) {\n+                    cosLocation = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosLocation argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosBucketName\":\n+                if (++i < args.length) {\n+                    cosBucketName = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosBucketName argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosCredentialIbm\":\n+                if (++i < args.length) {\n+                    cosCredentialIbm = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosCredentialIbm argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosFile2Break\":\n+                if (++i < args.length) {\n+                    cosFile2Break = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosFile2Break argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--numberOfFiles\":\n+                if (++i < args.length) {\n+                    numberOfFiles = Integer.parseInt(args[i]);\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --numberOfFiles argument at posn: \" + i);\n+                }\n+                break;\n+            default:\n+                throw new IllegalArgumentException(\"Invalid argument: \" + arg);\n+            }\n+        }\n+    }\n+\n+\n+    private int getFhirResourceNumberFromBufferReader(BufferedReader resReader) throws Exception {\n+        int lineRed = 0;\n+        while (true) {\n+                String resLine = resReader.readLine();\n+                lineRed++;\n+                if (resLine == null) {\n+                    System.out.println(\"\\n Count finished!!!!!\");\n+                    break;\n+                } else {\n+                    System.out.print(\".\");\n+                }\n+        }\n+        return lineRed;\n+    }\n+\n+\n+\n+    private void writeFhirResourceFromBufferReader(BufferedReader resReader,  AmazonS3 cosClient, ByteArrayOutputStream bufferStream, int numOfRes4Seg) throws Exception {\n+        int lineRed = 0;\n+        int segNum = 0;\n+        List<PartETag> dataPackTags = new ArrayList<>();\n+        String uploadId = null;\n+        int partNum = 1;\n+        boolean isMore2Read = true;\n+        while (isMore2Read) {\n+                String resLine = resReader.readLine();\n+                lineRed++;\n+                if (resLine == null) {\n+                    System.out.println(\"\\n Read finished!!!!!\");\n+                    isMore2Read = false;\n+                } else {\n+                    System.out.print(\".\");\n+                    bufferStream.write(resLine.getBytes());\n+                    bufferStream.write(Constants.NDJSON_LINESEPERATOR);\n+                }\n+\n+                if (bufferStream.size() > Constants.COS_PART_MINIMALSIZE\n+                        || (segNum < numberOfFiles - 1 && lineRed == numOfRes4Seg)\n+                        || !isMore2Read) {\n+                    String segName = cosFile2Break + \"_seg\" + segNum;\n+                    if (uploadId == null) {\n+                        uploadId = BulkDataUtils.startPartUpload(cosClient, cosBucketName, segName, true);\n+                    }\n+\n+                    if (bufferStream.size() > 0) {\n+                        dataPackTags.add(BulkDataUtils.multiPartUpload(cosClient, cosBucketName, segName,uploadId,\n+                                new ByteArrayInputStream(bufferStream.toByteArray()), bufferStream.size(), partNum++));\n+                        bufferStream.reset();\n+                    }\n+\n+                    if (segNum < numberOfFiles - 1 && lineRed == numOfRes4Seg\n+                            || !isMore2Read) {\n+                        BulkDataUtils.finishMultiPartUpload(cosClient, cosBucketName, segName, uploadId, dataPackTags);\n+                        System.out.println(\"Finished writting for \" + segName);", "originalCommit": "f94d6226704e48cb15ad96f17776e447546bae94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNTA0NQ==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387115045", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MzI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5NDY4NA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387094684", "bodyText": "There are a lot of System.exits here... .throw an exception, and handle one time.", "author": "prb112", "createdAt": "2020-03-03T15:24:21Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulktools/Main.java", "diffHunk": "@@ -0,0 +1,278 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package com.ibm.fhir.bulktools;\n+\n+import java.io.BufferedReader;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+import com.ibm.cloud.objectstorage.services.s3.AmazonS3;\n+import com.ibm.cloud.objectstorage.services.s3.model.GetObjectRequest;\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.cloud.objectstorage.services.s3.model.S3Object;\n+import com.ibm.cloud.objectstorage.services.s3.model.S3ObjectInputStream;\n+import com.ibm.fhir.bulkcommon.BulkDataUtils;\n+import com.ibm.fhir.bulkcommon.Constants;\n+\n+/**\n+ * Tool to break large COS file into multiple ones.\n+ */\n+public class Main {\n+    private static final Logger logger = Logger.getLogger(Main.class.getName());\n+\n+    // number of nanoseconds in a second\n+    private static final double NANOS = 1e9;\n+\n+    /**\n+     * The IBM COS API key or S3 access key.\n+     */\n+    private static String cosApiKey;\n+\n+    /**\n+     * The IBM COS service instance id or S3 secret key.\n+     */\n+    private static String cosSrvinstId;\n+\n+    /**\n+     * The IBM COS or S3 End point URL.\n+     */\n+    private static String cosEndpintUrl;\n+\n+    /**\n+     * The IBM COS or S3 location.\n+     */\n+    private static String cosLocation;\n+\n+    /**\n+     * The IBM COS or S3 bucket name to import from.\n+     */\n+    private static String cosBucketName;\n+\n+    /**\n+     * If use IBM credential.\n+     */\n+    private static String cosCredentialIbm;\n+\n+    /**\n+     * The COS file to break.\n+     */\n+    private static String cosFile2Break;\n+\n+    /**\n+     * The number of files to break into.\n+     */\n+    private static int numberOfFiles;\n+\n+    /**\n+     * Parse the command line arguments\n+     *   --cosApiKey\n+     *   --cosSrvinstId\n+     *   --cosEndpintUrl\n+     *   --cosLocation\n+     *   --cosBucketName\n+     *   --cosCredentialIbm\n+     *   --cosFile2Break\n+     *   --numberOfFiles\n+     * @param args\n+     */\n+    public void parseArgs(String[] args) {\n+        // really simple args, so nothing fancy needed here\n+        for (int i=0; i<args.length; i++) {\n+            String arg = args[i];\n+            switch (arg) {\n+            case \"--cosApiKey\":\n+                if (++i < args.length) {\n+                    cosApiKey = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosApiKey argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosSrvinstId\":\n+                if (++i < args.length) {\n+                    cosSrvinstId = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosSrvinstId argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosEndpintUrl\":\n+                if (++i < args.length) {\n+                    cosEndpintUrl = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosEndpintUrl argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosLocation\":\n+                if (++i < args.length) {\n+                    cosLocation = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosLocation argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosBucketName\":\n+                if (++i < args.length) {\n+                    cosBucketName = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosBucketName argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosCredentialIbm\":\n+                if (++i < args.length) {\n+                    cosCredentialIbm = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosCredentialIbm argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--cosFile2Break\":\n+                if (++i < args.length) {\n+                    cosFile2Break = args[i];\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --cosFile2Break argument at posn: \" + i);\n+                }\n+                break;\n+            case \"--numberOfFiles\":\n+                if (++i < args.length) {\n+                    numberOfFiles = Integer.parseInt(args[i]);\n+                }\n+                else {\n+                    throw new IllegalArgumentException(\"Missing value for --numberOfFiles argument at posn: \" + i);\n+                }\n+                break;\n+            default:\n+                throw new IllegalArgumentException(\"Invalid argument: \" + arg);\n+            }\n+        }\n+    }\n+\n+\n+    private int getFhirResourceNumberFromBufferReader(BufferedReader resReader) throws Exception {\n+        int lineRed = 0;\n+        while (true) {\n+                String resLine = resReader.readLine();\n+                lineRed++;\n+                if (resLine == null) {\n+                    System.out.println(\"\\n Count finished!!!!!\");\n+                    break;\n+                } else {\n+                    System.out.print(\".\");\n+                }\n+        }\n+        return lineRed;\n+    }\n+\n+\n+\n+    private void writeFhirResourceFromBufferReader(BufferedReader resReader,  AmazonS3 cosClient, ByteArrayOutputStream bufferStream, int numOfRes4Seg) throws Exception {\n+        int lineRed = 0;\n+        int segNum = 0;\n+        List<PartETag> dataPackTags = new ArrayList<>();\n+        String uploadId = null;\n+        int partNum = 1;\n+        boolean isMore2Read = true;\n+        while (isMore2Read) {\n+                String resLine = resReader.readLine();\n+                lineRed++;\n+                if (resLine == null) {\n+                    System.out.println(\"\\n Read finished!!!!!\");\n+                    isMore2Read = false;\n+                } else {\n+                    System.out.print(\".\");\n+                    bufferStream.write(resLine.getBytes());\n+                    bufferStream.write(Constants.NDJSON_LINESEPERATOR);\n+                }\n+\n+                if (bufferStream.size() > Constants.COS_PART_MINIMALSIZE\n+                        || (segNum < numberOfFiles - 1 && lineRed == numOfRes4Seg)\n+                        || !isMore2Read) {\n+                    String segName = cosFile2Break + \"_seg\" + segNum;\n+                    if (uploadId == null) {\n+                        uploadId = BulkDataUtils.startPartUpload(cosClient, cosBucketName, segName, true);\n+                    }\n+\n+                    if (bufferStream.size() > 0) {\n+                        dataPackTags.add(BulkDataUtils.multiPartUpload(cosClient, cosBucketName, segName,uploadId,\n+                                new ByteArrayInputStream(bufferStream.toByteArray()), bufferStream.size(), partNum++));\n+                        bufferStream.reset();\n+                    }\n+\n+                    if (segNum < numberOfFiles - 1 && lineRed == numOfRes4Seg\n+                            || !isMore2Read) {\n+                        BulkDataUtils.finishMultiPartUpload(cosClient, cosBucketName, segName, uploadId, dataPackTags);\n+                        System.out.println(\"Finished writting for \" + segName);\n+                        lineRed = 0;\n+                        segNum++;\n+                        uploadId = null;\n+                        partNum = 1;\n+                        dataPackTags.clear();\n+                    }\n+                }\n+        }\n+\n+    }\n+\n+\n+    /**\n+     * Main entry\n+     * @param args\n+     */\n+    public static void main(String[] args) {\n+        Main m = new Main();\n+        try {\n+            m.parseArgs(args);\n+\n+            long start = System.nanoTime();\n+            int totalNum = 0;\n+\n+            AmazonS3 cosClient = BulkDataUtils.getCosClient(cosCredentialIbm, cosApiKey, cosSrvinstId, cosEndpintUrl,\n+                    cosLocation);\n+            if (cosClient == null) {\n+                logger.warning(\"Failed to get CosClient!\");\n+                System.exit(1);\n+            }\n+\n+            S3Object item = cosClient.getObject(new GetObjectRequest(cosBucketName, cosFile2Break));\n+            try (S3ObjectInputStream s3InStream = item.getObjectContent();\n+                    BufferedReader resReader = new BufferedReader(new InputStreamReader(s3InStream))) {\n+                   totalNum = m.getFhirResourceNumberFromBufferReader(resReader);\n+               } catch (Exception ioe) {\n+                   logger.warning(\"Error proccesing file \" + cosFile2Break + \" - \" + ioe.getMessage());\n+                   System.exit(1);", "originalCommit": "f94d6226704e48cb15ad96f17776e447546bae94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwNDMxMQ==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387104311", "bodyText": "make sense", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5NDY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNDkzOA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387114938", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5NDY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5NTI1NA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387095254", "bodyText": "Elaborate as to why it's being done, and what the case for using it is... recommendation, not a requirement of the review.", "author": "prb112", "createdAt": "2020-03-03T15:25:06Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulktools/Main.java", "diffHunk": "@@ -0,0 +1,278 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package com.ibm.fhir.bulktools;\n+\n+import java.io.BufferedReader;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+import com.ibm.cloud.objectstorage.services.s3.AmazonS3;\n+import com.ibm.cloud.objectstorage.services.s3.model.GetObjectRequest;\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.cloud.objectstorage.services.s3.model.S3Object;\n+import com.ibm.cloud.objectstorage.services.s3.model.S3ObjectInputStream;\n+import com.ibm.fhir.bulkcommon.BulkDataUtils;\n+import com.ibm.fhir.bulkcommon.Constants;\n+\n+/**\n+ * Tool to break large COS file into multiple ones.", "originalCommit": "f94d6226704e48cb15ad96f17776e447546bae94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5OTYyMA==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387099620", "bodyText": "let me add comments", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5NTI1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNDc4Mw==", "url": "https://github.com/IBM/FHIR/pull/740#discussion_r387114783", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-03-03T15:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5NTI1NA=="}], "type": "inlineReview"}, {"oid": "a28f85486b097de8a91c3b4dcda028fe0ebbd2e7", "url": "https://github.com/IBM/FHIR/commit/a28f85486b097de8a91c3b4dcda028fe0ebbd2e7", "message": "issue #675 changes per review comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-03-03T15:53:00Z", "type": "commit"}]}