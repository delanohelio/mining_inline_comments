{"pr_number": 1667, "pr_title": "Add reference target annotations, javadoc, and validation", "pr_createdAt": "2020-11-04T05:38:16Z", "pr_url": "https://github.com/IBM/FHIR/pull/1667", "timeline": [{"oid": "89a8c03fd1de38444bfe20edbe5e7c344cfb0a51", "url": "https://github.com/IBM/FHIR/commit/89a8c03fd1de38444bfe20edbe5e7c344cfb0a51", "message": "Add reference target annotations, javadoc, and validation\n\nPreviously, we only had these for fields of type reference with a max\ncardinality of 1. Now we have these for both repeating fields and for\nchoice types which include references as well.\n\nI think there are many more cases we're missing wrt validation of choice\ntypes and repeating fields of other types, but I was focused mainly on\nReferenceTargets for now (to address\nhttps://github.com/IBM/FHIR/issues/1536 )\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T05:37:48Z", "type": "commit"}, {"oid": "1c9e8318623c8bb5bbe07aa045a761fe3c6326ae", "url": "https://github.com/IBM/FHIR/commit/1c9e8318623c8bb5bbe07aa045a761fe3c6326ae", "message": "issue #1536 - update DataCreatorBase to generate better reference values\n\nThis builds on the previous commit which added ReferenceType annotations\nto the repeating fields.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T07:17:19Z", "type": "commit"}, {"oid": "b03060998010b6549a8b69e4f5c9507d77f77e7c", "url": "https://github.com/IBM/FHIR/commit/b03060998010b6549a8b69e4f5c9507d77f77e7c", "message": "issue #1536 - generate and commit updated examples\n\nThe new checks found a couple more spec examples with invalid content,\nso the expectation for those is updated in the corresponding index rows.\n\nI also noticed that the DataAbsent examples have significant updates as\nwell...presumably from a previous round of edits that were made but\nwhich were never used to generated updated examples yet.\n\nI also snuck in a minor update in CompleteMockDataCreator (for\nreferences with no target profiles).\n\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T13:00:53Z", "type": "commit"}, {"oid": "b03060998010b6549a8b69e4f5c9507d77f77e7c", "url": "https://github.com/IBM/FHIR/commit/b03060998010b6549a8b69e4f5c9507d77f77e7c", "message": "issue #1536 - generate and commit updated examples\n\nThe new checks found a couple more spec examples with invalid content,\nso the expectation for those is updated in the corresponding index rows.\n\nI also noticed that the DataAbsent examples have significant updates as\nwell...presumably from a previous round of edits that were made but\nwhich were never used to generated updated examples yet.\n\nI also snuck in a minor update in CompleteMockDataCreator (for\nreferences with no target profiles).\n\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T13:00:53Z", "type": "forcePushed"}, {"oid": "a6d2440e9b19f112aa9d6693c558ecb83ba4fef2", "url": "https://github.com/IBM/FHIR/commit/a6d2440e9b19f112aa9d6693c558ecb83ba4fef2", "message": "Only omit coded element subfields when it has a required binding\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T16:44:38Z", "type": "commit"}, {"oid": "06bdec1a964ec1c065880828808d8f39ac00220e", "url": "https://github.com/IBM/FHIR/commit/06bdec1a964ec1c065880828808d8f39ac00220e", "message": "Move list and choice type checkReference logic into ValidationSupport\n\nper review feedback\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T17:34:04Z", "type": "forcePushed"}, {"oid": "b7fb158e3e7658b167c76bfc6f83b6a84ec74714", "url": "https://github.com/IBM/FHIR/commit/b7fb158e3e7658b167c76bfc6f83b6a84ec74714", "message": "Move list and choice type checkReference logic into ValidationSupport\n\nper review feedback\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T18:28:38Z", "type": "commit"}, {"oid": "b7fb158e3e7658b167c76bfc6f83b6a84ec74714", "url": "https://github.com/IBM/FHIR/commit/b7fb158e3e7658b167c76bfc6f83b6a84ec74714", "message": "Move list and choice type checkReference logic into ValidationSupport\n\nper review feedback\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T18:28:38Z", "type": "forcePushed"}, {"oid": "1663a43f1d2b8b6a11f59d8175a2ecaee194659f", "url": "https://github.com/IBM/FHIR/commit/1663a43f1d2b8b6a11f59d8175a2ecaee194659f", "message": "Avoid problem case with complete-absent durations\n\nvalidCode implicitly constructs a coding from a quantity and this was\ncausing errors in the complete-absent case\n\nalso adjusted some more expectations in the index files\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T20:54:25Z", "type": "commit"}, {"oid": "1663a43f1d2b8b6a11f59d8175a2ecaee194659f", "url": "https://github.com/IBM/FHIR/commit/1663a43f1d2b8b6a11f59d8175a2ecaee194659f", "message": "Avoid problem case with complete-absent durations\n\nvalidCode implicitly constructs a coding from a quantity and this was\ncausing errors in the complete-absent case\n\nalso adjusted some more expectations in the index files\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T20:54:25Z", "type": "forcePushed"}, {"oid": "b91bdbc32ff29379c011bbb35813027800e76adf", "url": "https://github.com/IBM/FHIR/commit/b91bdbc32ff29379c011bbb35813027800e76adf", "message": "Introduce Xhtml.from(String plainText) helper and add javadoc\n\nThis helper uses the OWASP Encoder (a small java dependency that we were\nalready using in the project, but not from `fhir-model`) to encode plain\ntext strings for use within HTML.\nIn addition to Xhtml javadoc, I also added javadoc for some of the code\nsubtype methods.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T21:11:13Z", "type": "commit"}, {"oid": "fa13b56cb4e617316a427fc658f4da75d55f39bc", "url": "https://github.com/IBM/FHIR/commit/fa13b56cb4e617316a427fc658f4da75d55f39bc", "message": "Merge pull request #1668 from IBM/lee-master\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-04T22:07:11Z", "type": "commit"}, {"oid": "13066b6c28421a130afc8cb6900c35a89038e63e", "url": "https://github.com/IBM/FHIR/commit/13066b6c28421a130afc8cb6900c35a89038e63e", "message": "remove unused COS constants from main constants file\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-05T01:59:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA2NzAzOA==", "url": "https://github.com/IBM/FHIR/pull/1667#discussion_r518067038", "bodyText": "this chunk of code is used above as well (lines 192-198) - might want to move to its own function", "author": "michaelwschroeder", "createdAt": "2020-11-05T13:54:19Z", "path": "fhir-examples-generator/src/main/java/com/ibm/fhir/examples/DataCreatorBase.java", "diffHunk": "@@ -180,23 +186,52 @@ protected Object createArgument(Class<?> owningClass, Method builderMethod, Clas\n                         !PlanDefinition.Action.class.equals(parameterType) &&\n                         !QuestionnaireResponse.Item.class.equals(parameterType)) {\n                     // Otherwise just create a single element\n-                    elementList = Collections.singletonList(createElement((Class<? extends Element>)parameterType, choiceIndicator));\n+                    if (Reference.class.equals(parameterType)){\n+                        // Handling references specially\n+                        String elementName = builderMethod.getParameters()[i].getName();\n+                        Set<String> referenceTargetTypes = ModelSupport.getReferenceTargetTypes(owningClass, elementName);\n+                        if (!referenceTargetTypes.isEmpty()) {\n+                            String[] targetTypes = new String[referenceTargetTypes.size()];\n+                            referenceTargetTypes.toArray(targetTypes);\n+\n+                            // use the \"choiceIndicator\" to pick the reference type\n+                            String targetType = targetTypes[(targetTypes.length - 1) % choiceIndicator];\n+                            elementList = Collections.singletonList(createReference(targetType));\n+                        } else {\n+                            elementList = Collections.singletonList(createElement((Class<? extends Element>)parameterType, choiceIndicator));\n+                        }\n+                    } else {\n+                        elementList = Collections.singletonList(createElement((Class<? extends Element>)parameterType, choiceIndicator));\n+                    }\n                 }\n             }\n             return elementList;\n         } else if (Element.class.equals(parameterType)){\n             // Seeing a parameter of type Element is our clue that we have a choice element\n             String elementName = builderMethod.getParameters()[i].getName();\n             Class<? extends Element> choiceType = null;\n-            \n+\n             Set<Class<?>> choiceElementTypes = ModelSupport.getChoiceElementTypes(owningClass, elementName);\n             if (!choiceElementTypes.isEmpty()) {\n                 @SuppressWarnings(\"unchecked\")\n                 Class<? extends Element>[] choiceTypesArray = new Class[choiceElementTypes.size()];\n                 choiceElementTypes.toArray(choiceTypesArray);\n-                choiceType = (Class<? extends Element>) choiceTypesArray[(choiceTypesArray.length - 1) % choiceIndicator];\n+                choiceType = choiceTypesArray[(choiceTypesArray.length - 1) % choiceIndicator];\n+            }\n+\n+            if (Reference.class.equals(choiceType)){\n+\n+                // Handling references specially\n+                Set<String> referenceTargetTypes = ModelSupport.getReferenceTargetTypes(owningClass, elementName);\n+                if (!referenceTargetTypes.isEmpty()) {\n+                    String[] targetTypes = new String[referenceTargetTypes.size()];\n+                    referenceTargetTypes.toArray(targetTypes);\n+\n+                    // use the \"choiceIndicator\" to pick the reference type\n+                    String targetType = targetTypes[(targetTypes.length - 1) % choiceIndicator];", "originalCommit": "fa13b56cb4e617316a427fc658f4da75d55f39bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM3OTg5Mw==", "url": "https://github.com/IBM/FHIR/pull/1667#discussion_r518379893", "bodyText": "I'm thinking to take a rain-check on this one.  Lots going on and my bar is lower for this example-generator stuff than for core fhir server", "author": "lmsurpre", "createdAt": "2020-11-05T21:29:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA2NzAzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA4NzM5OA==", "url": "https://github.com/IBM/FHIR/pull/1667#discussion_r518087398", "bodyText": "I don't think you need to do this here since you're generating the ValidationSupport.checkReferenceType() call for reference-type choice elements now", "author": "michaelwschroeder", "createdAt": "2020-11-05T14:22:05Z", "path": "fhir-model/src/main/java/com/ibm/fhir/model/util/ValidationSupport.java", "diffHunk": "@@ -285,6 +285,10 @@ public static void checkValue(String value, Pattern pattern) {\n                 List<String> typeNameList = Arrays.stream(types).map(Class::getSimpleName).collect(Collectors.toList());\n                 throw new IllegalStateException(String.format(\"Invalid type: %s for choice element: '%s' must be one of: %s\", elementType.getSimpleName(), elementName, typeNameList.toString()));\n             }\n+            //do other validation here?", "originalCommit": "fa13b56cb4e617316a427fc658f4da75d55f39bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM4MTEzMQ==", "url": "https://github.com/IBM/FHIR/pull/1667#discussion_r518381131", "bodyText": "good call, meant to remove this.\nI actually think there are other validation cases (for both choice types and list types) that we're still missing, but in this PR I was focused on just the referenceType-checking", "author": "lmsurpre", "createdAt": "2020-11-05T21:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA4NzM5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM4MTg4NA==", "url": "https://github.com/IBM/FHIR/pull/1667#discussion_r518381884", "bodyText": "removed", "author": "lmsurpre", "createdAt": "2020-11-05T21:34:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA4NzM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM4MTMwNw==", "url": "https://github.com/IBM/FHIR/pull/1667#discussion_r518381307", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        //do other validation here?\n          \n          \n            \n            //            if (element instanceof Reference) {\n          \n          \n            \n            //                checkReferenceType(element, elementName, ModelSupport.getReferenceTargetTypes(modelClass, elementName));\n          \n          \n            \n            //            }", "author": "lmsurpre", "createdAt": "2020-11-05T21:32:46Z", "path": "fhir-model/src/main/java/com/ibm/fhir/model/util/ValidationSupport.java", "diffHunk": "@@ -285,6 +285,10 @@ public static void checkValue(String value, Pattern pattern) {\n                 List<String> typeNameList = Arrays.stream(types).map(Class::getSimpleName).collect(Collectors.toList());\n                 throw new IllegalStateException(String.format(\"Invalid type: %s for choice element: '%s' must be one of: %s\", elementType.getSimpleName(), elementName, typeNameList.toString()));\n             }\n+            //do other validation here?\n+//            if (element instanceof Reference) {\n+//                checkReferenceType(element, elementName, ModelSupport.getReferenceTargetTypes(modelClass, elementName));\n+//            }", "originalCommit": "fa13b56cb4e617316a427fc658f4da75d55f39bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4a0a7e998e3eec3070bb6aca5cc76645e4ab41c3", "url": "https://github.com/IBM/FHIR/commit/4a0a7e998e3eec3070bb6aca5cc76645e4ab41c3", "message": "remove commented out code\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-05T21:33:29Z", "type": "commit"}, {"oid": "36b65d1ea4582b4024a00bc27ac272b3e5255a18", "url": "https://github.com/IBM/FHIR/commit/36b65d1ea4582b4024a00bc27ac272b3e5255a18", "message": "Merge pull request #1671 from IBM/lee-master\n\nremove unused COS constants from main constants file", "committedDate": "2020-11-06T01:40:00Z", "type": "commit"}]}