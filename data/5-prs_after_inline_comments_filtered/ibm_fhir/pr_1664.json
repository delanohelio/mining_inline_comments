{"pr_number": 1664, "pr_title": "issue #916 static datasource option and make it the default", "pr_createdAt": "2020-11-02T21:11:45Z", "pr_url": "https://github.com/IBM/FHIR/pull/1664", "timeline": [{"oid": "a5b40e535517a45cc540b0ed2d13743a1243cda9", "url": "https://github.com/IBM/FHIR/commit/a5b40e535517a45cc540b0ed2d13743a1243cda9", "message": "issue #916 static datasource option and make it the default\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-02T20:46:01Z", "type": "commit"}, {"oid": "35bad477418a4a689f682f7dd662091dfec36d7d", "url": "https://github.com/IBM/FHIR/commit/35bad477418a4a689f682f7dd662091dfec36d7d", "message": "Merge remote-tracking branch 'origin/master' into robin-proto", "committedDate": "2020-11-02T20:47:08Z", "type": "commit"}, {"oid": "d343e20a0af25d2dcf00d70b247bc87a602350e2", "url": "https://github.com/IBM/FHIR/commit/d343e20a0af25d2dcf00d70b247bc87a602350e2", "message": "issue #916 make proxy datasource the default config and fix jndi naming for bootstrap derby databases\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-03T19:29:37Z", "type": "commit"}, {"oid": "e3509cf04510b7d86be108bc4b64b5b1c8353e64", "url": "https://github.com/IBM/FHIR/commit/e3509cf04510b7d86be108bc4b64b5b1c8353e64", "message": "issue #916 datasource-derby.xml was renamed to datasource-bootstrap.xml\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-03T20:01:16Z", "type": "commit"}, {"oid": "e9e6b5c0f786331ce1091362222360819e9f89b2", "url": "https://github.com/IBM/FHIR/commit/e9e6b5c0f786331ce1091362222360819e9f89b2", "message": "issue #916 updated db2 and postgres test config to match docker-composed environment\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-03T21:28:24Z", "type": "commit"}, {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "url": "https://github.com/IBM/FHIR/commit/ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "message": "issue updated FHIRServerUsersGuide.md with new datasource configuration info\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-04T04:50:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NDM0OQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517394349", "bodyText": "name is kind of wonkey", "author": "prb112", "createdAt": "2020-11-04T14:43:39Z", "path": "fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java", "diffHunk": "@@ -92,6 +92,9 @@\n     public static final String PROPERTY_DATASOURCES = \"fhirServer/persistence/datasources\";\n     public static final String PROPERTY_JDBC_BOOTSTRAP_DB = \"fhirServer/persistence/jdbc/bootstrapDb\";\n     public static final String PROPERTY_JDBC_DATASOURCE_JNDINAME = \"fhirServer/persistence/jdbc/dataSourceJndiName\";\n+    public static final String PROPERTY_JDBC_BOOTSTRAP_DATASOURCE_BASE = \"fhirServer/persistence/jdbc/bootstrapDataSourceBase\";", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzNjY1MA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518836650", "bodyText": "No, it aligns with the existing PROPERTY_JDBC_BOOTSTRAP_DB. Intentional. I have moved it up one line to make this clear.", "author": "punktilious", "createdAt": "2020-11-06T15:45:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NDM0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NTE3Ng==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517395176", "bodyText": "Correct me if I'm wrong, in our next release we can get rid of this.\nAnd start packing in fhir-core, fhir-config in the war.\nif so, I think we should release 4.5.0 soon, and get to 4.5.X soon after", "author": "prb112", "createdAt": "2020-11-04T14:44:44Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/connection/FHIRDbProxyDatasourceConnectionStrategy.java", "diffHunk": "@@ -24,28 +24,29 @@\n \n /**\n  * Hides the logic behind obtaining a JDBC {@link Connection} from the DAO code.\n- * \n- * This strategy is used for configurations using the FHIR proxy datasource, \n+ *\n+ * This strategy is used for configurations using the FHIR proxy datasource,\n  * which supports dynamic configurations of datasources without requiring\n  * the application server to restart.\n- * \n+ *\n  * @implNote Refactored from {@link FHIRDbDAOImpl}. Improves separation of\n  *           concerns by removing connection management code from the DAO\n  *           and injecting it as a strategy instead. This not only simplifies\n  *           things, but also makes it easier to implement new strategies,\n  *           such as using a JEE datasource directly instead of the FHIR\n  *           proxy datasource used here.\n  */\n+@Deprecated\n public class FHIRDbProxyDatasourceConnectionStrategy extends FHIRDbConnectionStrategyBase {", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5MzU2Ng==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517493566", "bodyText": "As we discussed, this strategy is currently the default (so we're not currently forcing users to make a config change). When we get rid of this in a future release, users will be required to change their config if they haven't already. In that future release, yes we can get rid of the shared lib jars, and package everything cleanly inside the WAR.", "author": "punktilious", "createdAt": "2020-11-04T17:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NTE3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NjQ5MQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517396491", "bodyText": "I saw something in the documentation that we make a recommendation on the JNDI name but not required.  I think based on this it's required? correct?", "author": "prb112", "createdAt": "2020-11-04T14:46:33Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/connection/FHIRDbTenantDatasourceConnectionStrategy.java", "diffHunk": "@@ -54,40 +52,45 @@\n \n     // number of nanoseconds in a millisecond\n     private static final long NANOMS = 1000000;\n-    \n-    // JNDI address of the (proxy) datasource\n-    private final String datasourceBaseName = \"jdbc/fhir_\";\n+\n+    // JNDI prefix  of the (proxy) datasource\n+    private static final String DATASOURCE_BASE_NAME = \"jdbc/fhir\";\n \n     // Cache of datasources we've found\n     private final Map<String, DataSource> datasourceMap = new ConcurrentHashMap<>();\n-    \n+\n     // the flavor of the database we are configured to represent\n     private final FHIRDbFlavor flavor;\n \n+    // Should we use read-only datasources for isReadOnly() requests?\n+    private final boolean enableReadOnlyReplicas;\n+\n     /**\n      * Public constructor. The proxy datasource must be present (registered in JNDI)\n      * at server startup.\n      * @throws FHIRPersistenceDBConnectException if the proxy datasource is not configured\n      */\n-    public FHIRDbTenantDatasourceConnectionStrategy(TransactionSynchronizationRegistry trxSyncRegistry, Action newConnectionAction) throws FHIRException {\n+    public FHIRDbTenantDatasourceConnectionStrategy(TransactionSynchronizationRegistry trxSyncRegistry, Action newConnectionAction, boolean enableReadOnlyReplicas) throws FHIRException {\n         super(trxSyncRegistry, newConnectionAction);\n+        this.flavor = createFlavor();\n+        this.enableReadOnlyReplicas = enableReadOnlyReplicas;\n+    }\n \n-        // Find the base JNDI name of the datasource we want to use\n-        try {\n-//            this.datasourceBaseName =\n-//                    FHIRConfiguration.getInstance().loadConfiguration().getStringProperty(\n-//                        FHIRConfiguration.PROPERTY_JDBC_DATASOURCE_JNDINAME, FHIRDbDAO.FHIRDB_JNDI_NAME_DEFAULT);\n-            \n-            if (log.isLoggable(Level.FINE)) {\n-                log.fine(\"Using datasource JNDI name: \" + datasourceBaseName);\n-            }\n-        } catch (Throwable e) {\n-            FHIRException fx = new FHIRPersistenceDBConnectException(\"Failure acquiring datasource\");\n-            log.log(Level.SEVERE, fx.addProbeId(\"Failure to find proxy datasource in FHIR server configuration\"), e);\n-            throw fx;\n+    public static String makeTenantDatasourceJNDIName(String jndiBase, String tenantId, String dsId, boolean readOnly) {\n+        final StringBuilder builder = new StringBuilder();\n+\n+        builder.append(jndiBase);\n+        builder.append(\"_\");\n+        builder.append(tenantId);\n+        builder.append(\"_\");\n+        builder.append(dsId);\n+\n+        if (readOnly) {\n+            // Allow the query to hit read-only replicas if we're supporting that\n+            builder.append(\"_ro\");\n         }\n-        \n-        this.flavor = createFlavor();\n+\n+        return builder.toString();\n     }", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NjkyNA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517396924", "bodyText": "Ignore comment - line 130 answered.", "author": "prb112", "createdAt": "2020-11-04T14:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NjQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NzE1MQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517397151", "bodyText": "makes sense now", "author": "prb112", "createdAt": "2020-11-04T14:47:25Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/connection/FHIRDbTenantDatasourceConnectionStrategy.java", "diffHunk": "@@ -98,43 +101,63 @@ public Connection getConnection() throws FHIRPersistenceDBConnectException {\n         if (log.isLoggable(Level.FINEST)) {\n             log.entering(CLASSNAME, METHODNAME);\n         }\n-        \n+\n         // the dsId/tenantId specific datasource we need to locate\n         DataSource datasource;\n-        \n+\n         // Resources can be routed to different databases using the dsId currently\n         // set on the context.\n         String tenantId = FHIRRequestContext.get().getTenantId();\n         String dsId = FHIRRequestContext.get().getDataStoreId();\n-        \n-        // this is the important bit...how we name our actual datasources\n-        final String datasourceName = datasourceBaseName + tenantId + \"_\" + dsId;\n-        \n+        boolean readOnly = this.enableReadOnlyReplicas && FHIRRequestContext.get().isReadOnly();\n+\n+        // The jndiName may be given explicitly in the fhir-server-config\n+        String jndiName;\n+\n+        final String jndiNameProperty = FHIRConfiguration.PROPERTY_DATASOURCES + \"/\" + dsId + \"/jndiName\";\n+        try {\n+            PropertyGroup fhirConfig = FHIRConfiguration.getInstance().loadConfigurationForTenant(tenantId);\n+            jndiName = fhirConfig.getStringProperty(jndiNameProperty, null);\n+\n+            if (readOnly) {\n+                jndiName = jndiName + \"_ro\";\n+            }\n+        } catch (Exception x) {\n+            log.log(Level.SEVERE, \"Error getting value for tenant/datasource jndiName property: \" + jndiNameProperty, x);\n+            throw new FHIRPersistenceDBConnectException(\"FHIR server configuration error. See server log for details\");\n+        }\n+\n+        if (jndiName == null) {\n+            // Name wasn't provided, so build the name using a standard pattern: jdbc/fhir_<tenantId>_<dsId>[_ro]\n+            jndiName = makeTenantDatasourceJNDIName(DATASOURCE_BASE_NAME, tenantId, dsId, readOnly);\n+        }", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzNzQzMA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518837430", "bodyText": "ok", "author": "punktilious", "createdAt": "2020-11-06T15:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NzE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5OTkxMg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517399912", "bodyText": "so interesting to see how many places this clause is used.", "author": "prb112", "createdAt": "2020-11-04T14:51:13Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -61,7 +61,7 @@\n     protected static final String SELECT_COUNT_ROOT = \"SELECT COUNT(DISTINCT R.RESOURCE_ID) \";\n     protected static final String SYSTEM_LEVEL_SELECT_COUNT_ROOT = \"SELECT SUM(CNT) \";\n     protected static final String SYSTEM_LEVEL_SUBSELECT_COUNT_ROOT = \" SELECT COUNT(DISTINCT LR.LOGICAL_RESOURCE_ID) AS CNT \";\n-    protected static final String WHERE_CLAUSE_ROOT = \"WHERE R.IS_DELETED <> 'Y'\";\n+    protected static final String WHERE_CLAUSE_ROOT = \"WHERE R.IS_DELETED = 'N'\";", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5NjMxNQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517496315", "bodyText": "Yeah, and ideally this flag should also be at the logical_resource level so that we can know the current status without having the extra join to the _resources table.", "author": "punktilious", "createdAt": "2020-11-04T17:04:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5OTkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwODI0Nw==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517408247", "bodyText": "@michaelwschroeder FYI - the <> change, I think you might have already adopted this", "author": "prb112", "createdAt": "2020-11-04T15:02:06Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/JDBCQueryBuilder.java", "diffHunk": "@@ -823,13 +823,13 @@ private void appendInnerSelect(StringBuilder whereClauseSegment, QueryParameter\n \n         whereClauseSegment.append(\" WHERE \");\n \n-        // CR1.RESOURCE_ID = CLR1.CURRENT_RESOURCE_ID AND CR1.IS_DELETED <> 'Y' AND\n+        // CR1.RESOURCE_ID = CLR1.CURRENT_RESOURCE_ID AND CR1.IS_DELETED = 'N' AND\n         // CP1.LOGICAL_RESOURCE_ID = CLR1.LOGICAL_RESOURCE_ID AND\n         whereClauseSegment.append(chainedResourceTableAlias).append(\"RESOURCE_ID = \")\n                 .append(chainedLogicalResourceTableAlias).append(\"CURRENT_RESOURCE_ID\")\n                 .append(AND)\n                 .append(chainedResourceTableAlias)\n-                .append(\"IS_DELETED\").append(\" <> 'Y'\")\n+                .append(\"IS_DELETED\").append(\" = 'N'\")", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NzgwNw==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r519187807", "bodyText": "I've seen Mike has made this change when reviewing his PR.", "author": "punktilious", "createdAt": "2020-11-07T15:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwODI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwOTE4Mg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517409182", "bodyText": "I think we should reference the issue since 4.5.0 doesn't yet exist.", "author": "prb112", "createdAt": "2020-11-04T15:03:21Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -224,8 +224,18 @@ public FHIRPersistenceJDBCImpl(FHIRPersistenceJDBCCache cache) throws Exception\n         // are processed the first time a connection is established to a particular tenant/datasource.\n         this.configProvider = new DefaultFHIRConfigProvider(); // before buildActionChain()\n         this.schemaNameSupplier = new SchemaNameImpl(this);\n-        this.connectionStrategy = new FHIRDbProxyDatasourceConnectionStrategy(trxSynchRegistry, buildActionChain());\n-        this.transactionAdapter = new FHIRUserTransactionAdapter(userTransaction, trxSynchRegistry, cache, TXN_DATA_KEY);        \n+\n+        // Release 4.5.0: Still default to the old proxy datasource configuration so we don't break existing", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzODQ5NQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518838495", "bodyText": "ok", "author": "punktilious", "createdAt": "2020-11-06T15:48:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwOTE4Mg=="}], "type": "inlineReview"}, {"oid": "3a7e9993f8658fdf570af65cd8aac5c4bf65d85a", "url": "https://github.com/IBM/FHIR/commit/3a7e9993f8658fdf570af65cd8aac5c4bf65d85a", "message": "issue #916 addressed review comments, use legacy proxy datasource config for Db2 SITs\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-06T16:24:49Z", "type": "commit"}, {"oid": "2abacfbd47c952bcb3359f7de20fa4bd89469689", "url": "https://github.com/IBM/FHIR/commit/2abacfbd47c952bcb3359f7de20fa4bd89469689", "message": "Merge remote-tracking branch 'origin/master' into robin-proto", "committedDate": "2020-11-06T16:25:43Z", "type": "commit"}, {"oid": "02151f9577ab0fa5e3bcec0d8e21fd582b6940f9", "url": "https://github.com/IBM/FHIR/commit/02151f9577ab0fa5e3bcec0d8e21fd582b6940f9", "message": "issue #916 fixed comment referencing future release\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-06T16:53:11Z", "type": "commit"}, {"oid": "9e91293c46a16dd46e78c189bc52dcb71c47dff1", "url": "https://github.com/IBM/FHIR/commit/9e91293c46a16dd46e78c189bc52dcb71c47dff1", "message": "issue #916 derby bootstrap must default using proxy datasource config\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-06T19:12:55Z", "type": "commit"}, {"oid": "7ed643b4aa0ccff36acd1aee02866156af8f814d", "url": "https://github.com/IBM/FHIR/commit/7ed643b4aa0ccff36acd1aee02866156af8f814d", "message": "issue #916 must keep fhirProxyDataSource defined in server.xml\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-06T19:59:45Z", "type": "commit"}, {"oid": "ec7bab525ba9fd3f218b77ce4cc332f1f36e11e3", "url": "https://github.com/IBM/FHIR/commit/ec7bab525ba9fd3f218b77ce4cc332f1f36e11e3", "message": "issue #916 db2 tests require legacy Derby datasource config for tenant1\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-06T21:06:15Z", "type": "commit"}, {"oid": "642ff7258659f03eab8bfa0f57a7f312a285e43b", "url": "https://github.com/IBM/FHIR/commit/642ff7258659f03eab8bfa0f57a7f312a285e43b", "message": "issue #916 updated FHIRServerUsersGuide per review comments\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-10T05:03:32Z", "type": "commit"}, {"oid": "545c3e0d58b60bde8313e76e09d29c9f19900d8d", "url": "https://github.com/IBM/FHIR/commit/545c3e0d58b60bde8313e76e09d29c9f19900d8d", "message": "issue #916 merged with master\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-10T05:23:29Z", "type": "commit"}]}