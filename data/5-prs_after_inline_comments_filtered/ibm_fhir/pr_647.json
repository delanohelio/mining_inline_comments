{"pr_number": 647, "pr_title": "issue #636 encrypt the internal Javabatch job id used in bulkdata apis", "pr_createdAt": "2020-01-28T20:32:01Z", "pr_url": "https://github.com/IBM/FHIR/pull/647", "timeline": [{"oid": "10978d346c886da846ec669ce64d054d8c74ce48", "url": "https://github.com/IBM/FHIR/commit/10978d346c886da846ec669ce64d054d8c74ce48", "message": "issue #636 initial code drop\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-01-28T20:31:33Z", "type": "commit"}, {"oid": "f0b9c9e922028eb009f4c9f1327c06098ba9560c", "url": "https://github.com/IBM/FHIR/commit/f0b9c9e922028eb009f4c9f1327c06098ba9560c", "message": "issue #636 add the encryption key config to server.xml\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-01-28T20:45:11Z", "type": "commit"}, {"oid": "a6443157ae46f102e45c99a6a99f8d24ec7a3efb", "url": "https://github.com/IBM/FHIR/commit/a6443157ae46f102e45c99a6a99f8d24ec7a3efb", "message": "issue #636 pom change\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-01-28T20:59:44Z", "type": "commit"}, {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be", "url": "https://github.com/IBM/FHIR/commit/c4eda51617704a4f98a28ffc94b5a96ad88de6be", "message": "issue #636 refactor and add uni-test cases\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-01-29T03:55:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODE5Ng==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372648196", "bodyText": "Pull this value from the tenant configuration for bulkdata or pull from the property group.", "author": "prb112", "createdAt": "2020-01-29T21:46:26Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/BulkDataConstants.java", "diffHunk": "@@ -31,6 +36,10 @@\n     public static final String PARAM_GROUP_ID = \"groupId\";\n     public static final String PARAM_JOB = \"job\";\n \n+    // Encryption key used for JavaBatch Job ID\n+    public static final SecretKeySpec BATCHJOBID_ENCRYPTION_KEY =\n+            BulkDataConfigUtil.getBatchJobIdEncryptionKey(FHIRServerUtils.getJNDIValue(\"config/bulkDataBatchJobIdEncryptionKey\", null));", "originalCommit": "c4eda51617704a4f98a28ffc94b5a96ad88de6be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MTc3Nw==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372951777", "bodyText": "I don't think this need to be tenant specific. so I didn't put it into bulkdata.json or any of the per tenant config files. I considered server.xml or server.env, and thought server.xml is the better place to put this tenant independent config.", "author": "albertwang-ibm", "createdAt": "2020-01-30T13:39:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEwODQ5MQ==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r373108491", "bodyText": "changed to use fhir server config.", "author": "albertwang-ibm", "createdAt": "2020-01-30T18:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODE5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODk4Nw==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372648987", "bodyText": "so it will default through to the normal job id?", "author": "prb112", "createdAt": "2020-01-29T21:48:06Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataUtil.java", "diffHunk": "@@ -284,4 +287,37 @@ public static String checkAndValidateJob(Parameters parameters) throws FHIROpera\n \n         throw new FHIROperationException(\"no job identifier is passed\");\n     }\n+\n+\n+    public static String encryptBatchJobId(String strToEncrypt, SecretKeySpec key) {\n+        // Encrypt and UrlEncode the batch job id.\n+        if (key == null) {\n+            return strToEncrypt;\n+        } else {\n+            try\n+            {\n+                Cipher cp = Cipher.getInstance(\"AES/ECB/PKCS5Padding\");\n+                cp.init(Cipher.ENCRYPT_MODE, key);\n+                return java.net.URLEncoder.encode(Base64.getEncoder().encodeToString(cp.doFinal(strToEncrypt.getBytes(\"UTF-8\"))), StandardCharsets.UTF_8.name());\n+            } catch (Exception e) {\n+                return strToEncrypt;", "originalCommit": "c4eda51617704a4f98a28ffc94b5a96ad88de6be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTI1OA==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372649258", "bodyText": "I think we should remove '+' and '=' before URL encoding", "author": "prb112", "createdAt": "2020-01-29T21:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODk4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1NTYzMw==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372955633", "bodyText": "yes, if the encryption key is not configured in server.xml, then the id will not be encrypted.\nen, if remove, how can we bring back the the '+' and '=' before decryption later when receiving the pulling request ...", "author": "albertwang-ibm", "createdAt": "2020-01-30T13:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODk4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEwODcyMA==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r373108720", "bodyText": "changed to use fhir server config.", "author": "albertwang-ibm", "createdAt": "2020-01-30T18:10:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTMzMw==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372649333", "bodyText": "worthy of a comment", "author": "prb112", "createdAt": "2020-01-29T21:48:48Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataUtil.java", "diffHunk": "@@ -284,4 +287,37 @@ public static String checkAndValidateJob(Parameters parameters) throws FHIROpera\n \n         throw new FHIROperationException(\"no job identifier is passed\");\n     }\n+\n+\n+    public static String encryptBatchJobId(String strToEncrypt, SecretKeySpec key) {", "originalCommit": "c4eda51617704a4f98a28ffc94b5a96ad88de6be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1NjEzNQ==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372956135", "bodyText": "let me add, I thought it's straight forward, so I didn't.", "author": "albertwang-ibm", "createdAt": "2020-01-30T13:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTMzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEwODgzOA==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r373108838", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-01-30T18:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTMzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTQ5NA==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372649494", "bodyText": "Worthy of a comment", "author": "prb112", "createdAt": "2020-01-29T21:49:07Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataUtil.java", "diffHunk": "@@ -284,4 +287,37 @@ public static String checkAndValidateJob(Parameters parameters) throws FHIROpera\n \n         throw new FHIROperationException(\"no job identifier is passed\");\n     }\n+\n+\n+    public static String encryptBatchJobId(String strToEncrypt, SecretKeySpec key) {\n+        // Encrypt and UrlEncode the batch job id.\n+        if (key == null) {\n+            return strToEncrypt;\n+        } else {\n+            try\n+            {\n+                Cipher cp = Cipher.getInstance(\"AES/ECB/PKCS5Padding\");\n+                cp.init(Cipher.ENCRYPT_MODE, key);\n+                return java.net.URLEncoder.encode(Base64.getEncoder().encodeToString(cp.doFinal(strToEncrypt.getBytes(\"UTF-8\"))), StandardCharsets.UTF_8.name());\n+            } catch (Exception e) {\n+                return strToEncrypt;\n+            }\n+        }\n+    }\n+\n+    public static String decryptBatchJobId(String strToDecrypt, SecretKeySpec key) {", "originalCommit": "c4eda51617704a4f98a28ffc94b5a96ad88de6be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1NjE3OA==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372956178", "bodyText": "let me add one, I thought it's straight forward, so I didn't.", "author": "albertwang-ibm", "createdAt": "2020-01-30T13:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEwOTA1Mg==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r373109052", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-01-30T18:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDExNQ==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372650115", "bodyText": "is this the lightest weight cipher?  it doesn't need to be strong.", "author": "prb112", "createdAt": "2020-01-29T21:50:22Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataUtil.java", "diffHunk": "@@ -284,4 +287,37 @@ public static String checkAndValidateJob(Parameters parameters) throws FHIROpera\n \n         throw new FHIROperationException(\"no job identifier is passed\");\n     }\n+\n+\n+    public static String encryptBatchJobId(String strToEncrypt, SecretKeySpec key) {\n+        // Encrypt and UrlEncode the batch job id.\n+        if (key == null) {\n+            return strToEncrypt;\n+        } else {\n+            try\n+            {\n+                Cipher cp = Cipher.getInstance(\"AES/ECB/PKCS5Padding\");\n+                cp.init(Cipher.ENCRYPT_MODE, key);\n+                return java.net.URLEncoder.encode(Base64.getEncoder().encodeToString(cp.doFinal(strToEncrypt.getBytes(\"UTF-8\"))), StandardCharsets.UTF_8.name());\n+            } catch (Exception e) {\n+                return strToEncrypt;\n+            }\n+        }\n+    }\n+\n+    public static String decryptBatchJobId(String strToDecrypt, SecretKeySpec key) {\n+        // Decrypt to get the batch job id\n+        if (key == null) {\n+            return strToDecrypt;\n+        } else {\n+            try\n+            {\n+                Cipher cp = Cipher.getInstance(\"AES/ECB/PKCS5PADDING\");", "originalCommit": "c4eda51617704a4f98a28ffc94b5a96ad88de6be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDQxNg==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372650416", "bodyText": "Where is the URL decode? shouldn't this be symmetric, or are you relying on the Liberty runtime to previously decode", "author": "prb112", "createdAt": "2020-01-29T21:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDUyMQ==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372650521", "bodyText": "maybe add a comment", "author": "prb112", "createdAt": "2020-01-29T21:51:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1OTg3NQ==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372959875", "bodyText": "yes, this is lightest weight cipher, and I didn't add salt to it to make the config simpler, otherwise, we will need config for both the key and salt.\nyes, liberty run time or the rest framework did the url decoding automatically, I added decoding in this function before, and found it didn't work, and then through debugging, I found it's already decoded, double decode the encrypted job id caused error, so I removed the url decode from this function.\nYes, will add comment for this.", "author": "albertwang-ibm", "createdAt": "2020-01-30T13:54:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzExMjg5Mw==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r373112893", "bodyText": "great confirmation, I think adding the comment is the only part left?", "author": "prb112", "createdAt": "2020-01-30T18:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEyMDY3Mg==", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r373120672", "bodyText": "added commenats", "author": "albertwang-ibm", "createdAt": "2020-01-30T18:34:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDExNQ=="}], "type": "inlineReview"}, {"oid": "c0d1ae1287df2d5810967cd7b6bec3b2498ec52d", "url": "https://github.com/IBM/FHIR/commit/c0d1ae1287df2d5810967cd7b6bec3b2498ec52d", "message": "issue #636 change to use fhir server config for the encryption key\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-01-30T18:08:54Z", "type": "commit"}, {"oid": "b6768d6973b1cea342c04eb113f6e935e561327c", "url": "https://github.com/IBM/FHIR/commit/b6768d6973b1cea342c04eb113f6e935e561327c", "message": "issue #636 minor format and comment changes\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-01-30T18:33:06Z", "type": "commit"}]}