{"pr_number": 1123, "pr_title": "Improve Bulk and OAuth Support #1110", "pr_createdAt": "2020-05-19T19:49:36Z", "pr_url": "https://github.com/IBM/FHIR/pull/1123", "timeline": [{"oid": "87858a66d8c31d9b3e63af3bdc56e3b073087f4d", "url": "https://github.com/IBM/FHIR/commit/87858a66d8c31d9b3e63af3bdc56e3b073087f4d", "message": "Improve Bulk and OAuth Support #1110\n\n- Add Support for SQL Type SmallInt\n- Add Support for multi-column unique constraints\n- Improve Foreign Key Constraints for self-referenced foreign keys\n(JavaBatch) and update BaseObject to work with FK\n- Improve Foreign Key Constraints for Alternative Targets (columns don't\nmatch)\n- Add Restrictive Grants for OAuth Tables\n- Add Restrictive Grants for Java Batch Tables\n- Add Feature Flag for Grants in Schema / Main\n- Added SchemaPrinter support for OAuth and JBatch\n- Tuned logging for DerbyAdapter (tablespace is now log level fine)\n- Tuned logging for ParametersUtil ( changed warning name-code match to\nlog level fine)\n- Tuned DerbyAdapter warnings\n\nIndirectly fixed...\n- Add postgresql support for grant command of the schema tool #946\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-19T19:47:14Z", "type": "commit"}, {"oid": "5741262170f111556620bfaa64ad85712de3a46f", "url": "https://github.com/IBM/FHIR/commit/5741262170f111556620bfaa64ad85712de3a46f", "message": "Fix for JBatch\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-19T19:51:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3NTcxNA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427575714", "bodyText": "maybe create these up front like we do in FHIRSchemaGenerator.  then, replaced these four lines with:\n.addPrivileges(List<GroupPrivilege>)\n\nin each of the add*Table methods", "author": "lmsurpre", "createdAt": "2020-05-19T20:20:45Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/JavaBatchSchemaGenerator.java", "diffHunk": "@@ -0,0 +1,450 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.schema.control;\n+\n+import static com.ibm.fhir.schema.control.FhirSchemaConstants.PK;\n+\n+import com.ibm.fhir.database.utils.model.Generated;\n+import com.ibm.fhir.database.utils.model.PhysicalDataModel;\n+import com.ibm.fhir.database.utils.model.Privilege;\n+import com.ibm.fhir.database.utils.model.Table;\n+\n+/**\n+ * Encapsulates the generation of the Liberty Java Batch schema artifacts.\n+ * This sql is generated using the Open Liberty tool ddlGen\n+ * <code>wlp/bin/ddlGen generate fhir-server</code>\n+ */\n+public class JavaBatchSchemaGenerator {\n+    public static final Boolean NOT_NULL = Boolean.FALSE;\n+    public static final Boolean NULL = Boolean.TRUE;\n+\n+    public static final String JOBPARAMETER_TABLE = \"JOBPARAMETER\";\n+    public static final String NAME = \"NAME\";\n+    public static final String VALUE = \"VALUE\";\n+    public static final String FK_JOBEXECID = \"FK_JOBEXECID\";\n+    public static final String JP_FKJOBEXECID_IX = \"JP_FKJOBEXECID_IX\";\n+\n+    public static final String JOBEXECUTION_TABLE = \"JOBEXECUTION\";\n+    public static final String JOBEXECID = \"JOBEXECID\";\n+    public static final String ENDTIME = \"ENDTIME\";\n+    public static final String EXECNUM = \"EXECNUM\";\n+    public static final String JOBPARAMETERS = \"JOBPARAMETERS\";\n+    public static final String LOGPATH = \"LOGPATH\";\n+    public static final String RESTURL = \"RESTURL\";\n+    public static final String SERVERID = \"SERVERID\";\n+    public static final String STARTTIME = \"STARTTIME\";\n+\n+    public static final String GROUPASSOCIATION_TABLE = \"GROUPASSOCIATION\";\n+    public static final String FK_JOBINSTANCEID = \"FK_JOBINSTANCEID\";\n+    public static final String GROUPNAMES = \"GROUPNAMES\";\n+\n+    public static final String JOBINSTANCE_TABLE = \"JOBINSTANCE\";\n+    public static final String JOBINSTANCEID = \"JOBINSTANCEID\";\n+    public static final String AMCNAME = \"AMCNAME\";\n+    public static final String BATCHSTATUS = \"BATCHSTATUS\";\n+    public static final String CREATETIME = \"CREATETIME\";\n+    public static final String EXITSTATUS = \"EXITSTATUS\";\n+    public static final String INSTANCESTATE = \"INSTANCESTATE\";\n+    public static final String JOBNAME = \"JOBNAME\";\n+    public static final String JOBXMLNAME = \"JOBXMLNAME\";\n+    public static final String JOBXML = \"JOBXML\";\n+    public static final String NUMEXECS = \"NUMEXECS\";\n+    public static final String RESTARTON = \"RESTARTON\";\n+    public static final String SUBMITTER = \"SUBMITTER\";\n+    public static final String UPDATETIME = \"UPDATETIME\";\n+\n+    public static final String STEPTHREADINSTANCE_TABLE = \"STEPTHREADINSTANCE\";\n+    public static final String PARTNUM = \"PARTNUM\";\n+    public static final String STEPNAME = \"STEPNAME\";\n+    public static final String THREADTYPE = \"THREADTYPE\";\n+    public static final String CHECKPOINTDATA = \"CHECKPOINTDATA\";\n+    public static final String PARTITIONED = \"PARTITIONED\";\n+    public static final String PARTITIONPLANSIZE = \"PARTITIONPLANSIZE\";\n+    public static final String STARTCOUNT  = \"STARTCOUNT\";\n+    public static final String FK_LATEST_STEPEXECID = \"FK_LATEST_STEPEXECID\";\n+\n+    public static final String STEPTHREADEXECUTION_TABLE = \"STEPTHREADEXECUTION\";\n+    public static final String STEPEXECID = \"STEPEXECID\";\n+\n+    public static final String REMOTABLEPARTITION_TABLE = \"REMOTABLEPARTITION_TABLE\";\n+    public static final String INTERNALSTATE = \"INTERNALSTATE\";\n+    public static final String LASTUPDATED = \"LASTUPDATED\";\n+    public static final String FK_JOBEXECUTIONID = \"FK_JOBEXECUTIONID\";\n+    public static final String FK_STEPEXECUTIONID = \"FK_STEPEXECUTIONID\";\n+\n+    public static final String M_COMMIT = \"M_COMMIT\";\n+    public static final String M_FILTER = \"M_FILTER\";\n+    public static final String INTERNALSTATUS = \"INTERNALSTATUS\";\n+    public static final String USERDATA = \"USERDATA\";\n+    public static final String M_PROCESSSKIP = \"M_PROCESSSKIP\";\n+    public static final String M_READ = \"M_READ\";\n+    public static final String M_READSKIP = \"M_READSKIP\";\n+    public static final String M_ROLLBACK = \"M_ROLLBACK\";\n+    public static final String M_WRITE = \"M_WRITE\";\n+    public static final String M_WRITESKIP = \"M_WRITESKIP\";\n+    public static final String ISPARTITIONEDSTEP = \"ISPARTITIONEDSTEP\";\n+    public static final String FK_TOPLVL_STEPEXECID = \"FK_TOPLVL_STEPEXECID\";\n+\n+    // The schema holding all the Java Batch data\n+    private final String schemaName;\n+\n+    /**\n+     * Configures the destination schema for JavaBatch\n+     * @param schemaName\n+     */\n+    public JavaBatchSchemaGenerator(String schemaName) {\n+        this.schemaName = schemaName;\n+    }\n+\n+    /**\n+     * Create the tables needed by the Liberty JBatch databaseStore\n+     * @param model\n+     */\n+    public void buildJavaBatchSchema(PhysicalDataModel model) {\n+        addJobInstanceTable(model);\n+        addJobExecutionTable(model);\n+        addStepThreadExecutionTable(model);\n+        addStepThreadInstanceTable(model);\n+        addRemotablePartitionTable(model);\n+        addGroupAssociationTable(model);\n+        addJobParameterTable(model);\n+    }\n+\n+    /**\n+     * Adds the job table with the following values:\n+     <code>\n+     CREATE TABLE FHIR_BATCH.JOBPARAMETER (\n+         NAME VARCHAR(255), \n+         VALUE VARCHAR(255),\n+         FK_JOBEXECID BIGINT)\n+     CREATE INDEX FHIR_BATCH.JP_FKJOBEXECID_IX ON FHIR_BATCH.JOBPARAMETER (FK_JOBEXECID)\n+     ALTER TABLE FHIR_BATCH.JOBPARAMETER ADD CONSTRAINT JBPRMETERFKJBXECID FOREIGN KEY (FK_JOBEXECID)\n+         REFERENCES FHIR_BATCH.JOBEXECUTION (JOBEXECID)\n+     </code>\n+     * @param model\n+     */\n+    public void addJobParameterTable(PhysicalDataModel model) {\n+        // The default for the value is 255, and chosen to update to 4096\n+        Table parameter = Table.builder(schemaName, JOBPARAMETER_TABLE)\n+                .addVarcharColumn(NAME, 255, NULL) // NAME VARCHAR(255)\n+                .addVarcharColumn(VALUE, 4096, NULL) // VALUE VARCHAR(255) (updated to 4096)\n+                .addBigIntColumn(FK_JOBEXECID, NOT_NULL) // FK_JOBEXECID BIGINT\n+                .addForeignKeyConstraintAltTarget(\"JBPRMETERFKJBXECID\", schemaName, JOBEXECUTION_TABLE, JOBEXECID, FK_JOBEXECID)\n+                .addIndex(\"JP_FKJOBEXECID_IX\", FK_JOBEXECID)\n+                .addPrivilege(FhirSchemaConstants.FHIR_BATCH_GRANT_GROUP, Privilege.SELECT)\n+                .addPrivilege(FhirSchemaConstants.FHIR_BATCH_GRANT_GROUP, Privilege.INSERT)\n+                .addPrivilege(FhirSchemaConstants.FHIR_BATCH_GRANT_GROUP, Privilege.DELETE)\n+                .addPrivilege(FhirSchemaConstants.FHIR_BATCH_GRANT_GROUP, Privilege.UPDATE)", "originalCommit": "5741262170f111556620bfaa64ad85712de3a46f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MzM4Mw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427663383", "bodyText": "done", "author": "prb112", "createdAt": "2020-05-19T23:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3NTcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3NzEwMQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427577101", "bodyText": "Fix spacing", "author": "prb112", "createdAt": "2020-05-19T20:23:22Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/common/CommonDatabaseAdapter.java", "diffHunk": "@@ -318,20 +318,46 @@ public void createForeignKeyConstraint(String constraintName, String schemaName,\n         ddl.append(DataDefinitionUtil.join(cols));\n         ddl.append(\") REFERENCES \");\n         ddl.append(targetName);\n+        if(targetColumnName != null && !targetColumnName.isEmpty()) {", "originalCommit": "5741262170f111556620bfaa64ad85712de3a46f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3NzMxMQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427577311", "bodyText": "Objects.isNull", "author": "prb112", "createdAt": "2020-05-19T20:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3NzEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxODU2OQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427618569", "bodyText": "Fixed", "author": "prb112", "createdAt": "2020-05-19T21:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3NzEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MDQ3Ng==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427580476", "bodyText": "Drop / Fix", "author": "prb112", "createdAt": "2020-05-19T20:29:43Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyAdapter.java", "diffHunk": "@@ -153,12 +149,17 @@ public void dropProcedure(String schemaName, String procedureName) {\n \n     @Override\n     public void createTablespace(String tablespaceName) {\n-        warnOnce(MessageKey.TABLESPACE, \"Create tablespace not supported in Derby\");\n+        logger.fine(\"Create tablespace not supported in Derby\");\n+    }\n+\n+    @Override\n+    public void createTablespace(String tablespaceName, int extentSizeKB) {\n+        logger.fine(\"Create tablespace not supported in Derby\");\n     }\n \n     @Override\n     public void dropTablespace(String tablespaceName) {\n-        warnOnce(MessageKey.TABLESPACE, \"Drop tablespace not supported in Derby\");\n+        logger.fine(\"Create tablespace not supported in Derby\");", "originalCommit": "5741262170f111556620bfaa64ad85712de3a46f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxNzk4MA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427617980", "bodyText": "Fixed", "author": "prb112", "createdAt": "2020-05-19T21:43:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MDQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MzExNQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427583115", "bodyText": "cool so, we support or are going to support upgrading of OAUTH and BATCH tables.", "author": "albertwang-ibm", "createdAt": "2020-05-19T20:34:53Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/DerbyBootstrapper.java", "diffHunk": "@@ -111,7 +113,7 @@ public static void bootstrap(Connection connection, String adminSchemaName, Stri\n         // Current version history for the database. This is used by applyWithHistory\n         // to determine which updates to apply and to record the new changes as they\n         // are applied\n-        VersionHistoryService vhs = new VersionHistoryService(adminSchemaName, dataSchemaName, OAUTH_SCHEMANAME);\n+        VersionHistoryService vhs = new VersionHistoryService(adminSchemaName, dataSchemaName, OAUTH_SCHEMANAME, BATCH_SCHEMANAME);", "originalCommit": "5741262170f111556620bfaa64ad85712de3a46f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxODc0OQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427618749", "bodyText": "Absolutely.", "author": "prb112", "createdAt": "2020-05-19T21:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MzExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MzMyNw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427583327", "bodyText": "2", "author": "prb112", "createdAt": "2020-05-19T20:35:15Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/FhirSchemaConstants.java", "diffHunk": "@@ -10,10 +10,9 @@\n  * Constants related to Schema creation and updating. \n  */\n public class FhirSchemaConstants {\n-\n     // A lower pool size is selected as default to limit the likelihood of contention on the DBMS.\n     // Standard connection/thread pool size\n-    public static final int DEFAULT_POOL_SIZE = 1;\n+    public static final int DEFAULT_POOL_SIZE = 10;", "originalCommit": "5741262170f111556620bfaa64ad85712de3a46f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MDg3OA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427660878", "bodyText": "Went to 1", "author": "prb112", "createdAt": "2020-05-19T23:42:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MzMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4ODk1OA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427588958", "bodyText": "Do we assume the javabatch tables are in the same database as fhir data but with different schema?", "author": "albertwang-ibm", "createdAt": "2020-05-19T20:45:37Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -575,6 +581,12 @@ protected void updateSchema() {\n             oauthSchemaGenerator.buildOAuthSchema(pdm);\n         }\n \n+        // Build/update the Liberty JBatch related tables", "originalCommit": "5741262170f111556620bfaa64ad85712de3a46f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxOTMyOQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427619329", "bodyText": "that's right.  Same database, same schema.\nIf necessary, I can add a separate command to deploy the Batch tables", "author": "prb112", "createdAt": "2020-05-19T21:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4ODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxOTM3MQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427619371", "bodyText": "Thoughts?", "author": "prb112", "createdAt": "2020-05-19T21:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4ODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzMjUxNA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427632514", "bodyText": "so, drop schema will keep the batch tables but only remove the fhirdata tables ...\nI think because we support different databases in the same fhir server, e.g, in CDT env, we configured performance## tenants using fhir-db2-perf1 database, and the others use databases of the other DB2 instances.   so, maybe it's better to use different job database for javabatch, because it's actually shared/used for export/import from/to all the other databases...  in CDT env, we used the same database as fhirdata, I think maybe this is not the best approach.  In my local, I always configure separated database for javabatch job repo...", "author": "albertwang-ibm", "createdAt": "2020-05-19T22:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4ODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzNTg5Mg==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427635892", "bodyText": "I think we'd better to separate the job repo.  but this is not a block for 4.2.2. if necessary, we can just create a issue for future enhancement.", "author": "albertwang-ibm", "createdAt": "2020-05-19T22:26:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4ODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MDA0Ng==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427660046", "bodyText": "I've added --batch-only so you can deploy to a different db.\nIt'll still install in the original main db, I don't think this is bad.\nAt least it can go into a separate db if needed (without the overhead of the rest of the tables)", "author": "prb112", "createdAt": "2020-05-19T23:39:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4ODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcwMTU4Nw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427701587", "bodyText": "haha, just read this one and at least i understand the motivation for the --batch-only flag now", "author": "lmsurpre", "createdAt": "2020-05-20T02:09:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4ODk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MTk1Nw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427591957", "bodyText": "if enable this command for postgresql, can we still use the Db2Adapter?", "author": "albertwang-ibm", "createdAt": "2020-05-19T20:51:09Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -798,7 +814,7 @@ protected void process() {\n      * @param groupName\n      */\n     protected void grantPrivileges(String groupName) {\n-        if (!MULTITENANT_FEATURE_ENABLED.contains(dbType)) {\n+        if (!PRIVILEGES_FEATURE_ENABLED.contains(dbType)) {", "originalCommit": "5741262170f111556620bfaa64ad85712de3a46f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxOTQ5OQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427619499", "bodyText": "Thank you for seeing this, I'll fix", "author": "prb112", "createdAt": "2020-05-19T21:47:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MTk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY1NjU5Ng==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427656596", "bodyText": "I've fixed this.", "author": "prb112", "createdAt": "2020-05-19T23:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MTk1Nw=="}], "type": "inlineReview"}, {"oid": "0a7584c6464f11126973c9042689f1c2dc339d83", "url": "https://github.com/IBM/FHIR/commit/0a7584c6464f11126973c9042689f1c2dc339d83", "message": "Fix for JBatch\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-19T21:41:47Z", "type": "commit"}, {"oid": "510b6b5b55436be46ebc9e9f0d6f1bda8b10283f", "url": "https://github.com/IBM/FHIR/commit/510b6b5b55436be46ebc9e9f0d6f1bda8b10283f", "message": "Fix for JBatch\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-19T21:52:38Z", "type": "commit"}, {"oid": "f253d646f6619cfd379223194680c90be7b0cc1e", "url": "https://github.com/IBM/FHIR/commit/f253d646f6619cfd379223194680c90be7b0cc1e", "message": "Update per PR Review\n\nAdd --batch-only\nConvert to use .addPrivileges(generateGroupPrivilege())\nConverted to FHIR_JBATCH\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-20T00:01:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY5OTUyNA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427699524", "bodyText": "whats the intent of this one?  why not just do it lock-step with the update-schema like we're doing for the OAuth schema?", "author": "lmsurpre", "createdAt": "2020-05-20T02:00:48Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -291,6 +301,9 @@ protected void parseArgs(String[] args) {\n             case \"--dry-run\":\n                 this.dryRun = Boolean.TRUE;\n                 break;\n+            case \"--batch-db-only\":\n+                this.batchOnly = Boolean.TRUE;\n+                break;", "originalCommit": "f253d646f6619cfd379223194680c90be7b0cc1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcwMDI4NA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427700284", "bodyText": "if it really needs to be separate, maybe we should split it into three actions?\n\n--update-schema\n--update-batch-schema\n--update-oauth-schema\n\nLike have those set the createFhirSchema, createOauthSchema, and createJavaBatchSchema flags respectively, then base the update on those flags alone...", "author": "lmsurpre", "createdAt": "2020-05-20T02:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY5OTUyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcwMDk5NA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427700994", "bodyText": "when i did the oauth schema, i was going to do something like that until i decided that the separate actions weren't really needed and so i just did the oauth ones as part of the normal create and update schema actions", "author": "lmsurpre", "createdAt": "2020-05-20T02:06:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY5OTUyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcxMTQ2OA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427711468", "bodyText": "After discuss with @lmsurpre , we agree that both oauth and batch has the same issue. and we'd better allow to use different databases for batch and oauth which is/are shared by the whole service. so the wanted changes are: admin always created with each database; and admin keep info for schemas in the same database, not matter they are fhirbath, oauth or fhirdata; and fhirbatch, oauth or fhirdata schema can be updated seperately.\nFor now, @prb112 Could you please drop the --batch-db-only change from this PR? thanks!", "author": "albertwang-ibm", "createdAt": "2020-05-20T02:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY5OTUyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2NDYyNw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427964627", "bodyText": "I'm not going to drop it - I'm just going to change to match Lee's request.\nI'd rather do this all at once, it's an easyish change", "author": "prb112", "createdAt": "2020-05-20T12:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY5OTUyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk3NTgzOA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r427975838", "bodyText": "sound good! thanks!", "author": "albertwang-ibm", "createdAt": "2020-05-20T12:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY5OTUyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxODc2Mg==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428318762", "bodyText": "Paul added separate actions for\n    --update-schema-fhir SCHEMANAME\n    --update-schema-batch SCHEMANAME\n    --update-schema-oauth SCHEMANAME\n\nwhile preserving the existing behavior of --update-schema.\nI think the updated design manages to walk the fine line of backwards-compatibility while still adding the requested functionality.", "author": "lmsurpre", "createdAt": "2020-05-20T21:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY5OTUyNA=="}], "type": "inlineReview"}, {"oid": "b88da7356848f84d2f45c925215861addfaaf6d5", "url": "https://github.com/IBM/FHIR/commit/b88da7356848f84d2f45c925215861addfaaf6d5", "message": "Add Grant Actions and FHIR Persistence fhir-persistence-schema #1110\n\n- Introduce CommonUtil to aid in simplifying the layout of Main.java\n- Add checkCompatibility to each adapter\n- Cleanup SchemaPrinter to support the new models\n- Move the methods around to logically organize\n- Remove references to old defects\n- Add deprecation flag for tenantKey\n- Reference Constants from DerbyBootstrapper\n- Improve Layout of Main.java\n- Update schema from bulkdata.xml\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-20T20:58:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwNjkyNA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428306924", "bodyText": "maybe better to show the reason like it's not needed anymore or not useful anymore because it's handled in fhirdaoimp..", "author": "albertwang-ibm", "createdAt": "2020-05-20T21:05:23Z", "path": "fhir-config/src/main/java/com/ibm/fhir/config/FHIRRequestContext.java", "diffHunk": "@@ -94,6 +95,7 @@ public void setTenantId(String tenantId) throws FHIRException {\n      * @param base64\n      * @throws FHIRException if the given value is not a valid Base64 string\n      */\n+    @Deprecated", "originalCommit": "b88da7356848f84d2f45c925215861addfaaf6d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMzYwMA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428323600", "bodyText": "I agree and so I just left a suggestion that I believe would address the comment.  Should we add a similar javadoc on the getTenantKey() method as well?", "author": "lmsurpre", "createdAt": "2020-05-20T21:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwNjkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzODU3Mw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428638573", "bodyText": "Picked up the suggestion and applied... I'm going to apply to getTenantKey as well", "author": "prb112", "createdAt": "2020-05-21T13:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwNjkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzOTIxMQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428639211", "bodyText": "Applied in next commit", "author": "prb112", "createdAt": "2020-05-21T13:06:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwNjkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwNzk2MA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428307960", "bodyText": "does -1 mean no limit?", "author": "albertwang-ibm", "createdAt": "2020-05-20T21:07:48Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/api/IConnectionProvider.java", "diffHunk": "@@ -57,4 +56,11 @@\n      * @param key\n      */\n     public void describe(String prefix, StringBuilder cfg, String key);\n-}\n+\n+    /**\n+     * used to control threading size.\n+     */\n+    public default int getPoolSize() {\n+        return -1;", "originalCommit": "b88da7356848f84d2f45c925215861addfaaf6d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NjI3MQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428366271", "bodyText": "it means there is now pool and to signal the downstream code to change.", "author": "prb112", "createdAt": "2020-05-20T23:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwNzk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxNjkxMg==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428316912", "bodyText": "does this always return true?\nthe comments for --checkCompatibility \"checks feature compatibility\" seems a little bit confusing for me...\nI didn't notice this before, could you help to tell what's this used for?", "author": "albertwang-ibm", "createdAt": "2020-05-20T21:27:06Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlAdapter.java", "diffHunk": "@@ -302,4 +304,33 @@ public void createIndex(String schemaName, String tableName, String indexName, S\n         String ddl = DataDefinitionUtil.createIndex(schemaName, tableName, indexName, indexColumns, false);\n         runStatement(ddl);\n     }\n-}\n+\n+    @Override\n+    public boolean checkCompatibility(String adminSchema) {\n+        final String statement = \"SELECT 1\";\n+        boolean result = false;\n+        try (Connection c = connectionProvider.getConnection(); PreparedStatement stmt = c.prepareStatement(statement)) {", "originalCommit": "b88da7356848f84d2f45c925215861addfaaf6d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NjM4MQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428366381", "bodyText": "it's used to check the connectivity to the database.\nreturns an exception if there is an issue.", "author": "prb112", "createdAt": "2020-05-20T23:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxNjkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4NDc0NA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428384744", "bodyText": "ha, interesting,  the function name seems a little bit confusing, I though it's compatible with something ...", "author": "albertwang-ibm", "createdAt": "2020-05-21T00:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxNjkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMTY3Mg==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428321672", "bodyText": "better to change to FHIR_JBATCH", "author": "albertwang-ibm", "createdAt": "2020-05-20T21:36:46Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/derby/DerbyFhirDatabase.java", "diffHunk": "@@ -40,6 +40,7 @@\n     private static final String SCHEMA_NAME = \"FHIRDATA\";\n     private static final String ADMIN_SCHEMA_NAME = \"FHIR_ADMIN\";\n     private static final String OAUTH_SCHEMANAME = \"FHIR_OAUTH\";\n+    private static final String BATCH_SCHEMANAME = \"FHIR_BATCH\";", "originalCommit": "b88da7356848f84d2f45c925215861addfaaf6d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMjQyOQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428322429", "bodyText": "and are those constants common for derby, db2 etc.", "author": "albertwang-ibm", "createdAt": "2020-05-20T21:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMTY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NjU2Mg==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428366562", "bodyText": "thanks for seeing this... I am trying to use JBATCH (good find)", "author": "prb112", "createdAt": "2020-05-20T23:36:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMTY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NjgzOQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428366839", "bodyText": "Fixed in next PR.", "author": "prb112", "createdAt": "2020-05-20T23:37:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMTY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMjM3Nw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428322377", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @throws FHIRException if the given value is not a valid Base64 string\n          \n          \n            \n                 * @throws FHIRException if the given value is not a valid Base64 string\n          \n          \n            \n                 * @deprecated tenantKey should be looked up on-the-fly from the fhir server configuration (e.g. from \n          \n          \n            \n                 *             FHIRDbDAOImpl.getConnection() in fhir-persistence-jdbc)", "author": "lmsurpre", "createdAt": "2020-05-20T21:38:19Z", "path": "fhir-config/src/main/java/com/ibm/fhir/config/FHIRRequestContext.java", "diffHunk": "@@ -94,6 +95,7 @@ public void setTenantId(String tenantId) throws FHIRException {\n      * @param base64\n      * @throws FHIRException if the given value is not a valid Base64 string", "originalCommit": "b88da7356848f84d2f45c925215861addfaaf6d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2Njk3Mw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428366973", "bodyText": "I'm going to leave this here to pick up shortly", "author": "prb112", "createdAt": "2020-05-20T23:38:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMjM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMzg3OQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428323879", "bodyText": "what if we already configured either DB2 or postgresql as job repo? will this still try to bootstrap derby job repo ...", "author": "albertwang-ibm", "createdAt": "2020-05-20T21:41:34Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java", "diffHunk": "@@ -224,6 +224,17 @@ private void bootstrapDerbyDatabases(PropertyGroup fhirConfig) throws Exception\n                 log.info(\"No '\" + datasourceJndiName + \"' dataSource found; skipping OAuth client table bootstrapping\");\n             }\n \n+            try {\n+                // Check the batch database, if the batch database configuration is there, and available.\n+                ds = (DataSource) ctxt.lookup(\"jdbc/fhirbatchDB\");", "originalCommit": "b88da7356848f84d2f45c925215861addfaaf6d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyNDc2OQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428324769", "bodyText": "and the same question for the OAUTH bootstraping...", "author": "albertwang-ibm", "createdAt": "2020-05-20T21:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMzg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NzEzNQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428367135", "bodyText": "only if you have enabled boostrap as true.", "author": "prb112", "createdAt": "2020-05-20T23:38:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMzg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4NjY0MA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428386640", "bodyText": "but our default setting is true, maybe better to check if the configured datasource is derby before bootstrap it ...", "author": "albertwang-ibm", "createdAt": "2020-05-21T00:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMzg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzNDMwMA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428634300", "bodyText": "I follow you. I am just testing my locallized fix (which is in boostrapBatchDb(ds)", "author": "prb112", "createdAt": "2020-05-21T12:56:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMzg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MDg2Mw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428340863", "bodyText": "I'm not a huge fan of this design, but to be consistent with the objectName that actually gets created, we need to remove the _pg from the end of the object name when we apply the grant:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        target.grantProcedureAndFunctionPrivileges(getSchemaName(), getObjectName(), group, toUser);\n          \n          \n            \n                        target.grantProcedureAndFunctionPrivileges(getSchemaName(), getObjectName().replace(\"_pg\",\"\"), group, toUser);", "author": "lmsurpre", "createdAt": "2020-05-20T22:21:04Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/ProcedureDef.java", "diffHunk": "@@ -72,7 +72,7 @@ protected void grantGroupPrivileges(IDatabaseAdapter target, Set<Privilege> grou\n         // Only apply DB Type specific store procedures.\n         if (driveClassName.contains(this.getDbType().value())) {\n             // Remove the postgresql tag \"_pg\" from the end of the object name and create the stored procedure.\n-            target.grantProcedurePrivileges(getSchemaName(), getObjectName(), group, toUser);\n+            target.grantProcedureAndFunctionPrivileges(getSchemaName(), getObjectName(), group, toUser);", "originalCommit": "b88da7356848f84d2f45c925215861addfaaf6d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NzIzMA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428367230", "bodyText": "I'll change this... thanks", "author": "prb112", "createdAt": "2020-05-20T23:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MDg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0MDg3Mg==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428640872", "bodyText": "Fixed in code", "author": "prb112", "createdAt": "2020-05-21T13:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MDg2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MjM0OA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428342348", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // Remove the postgresql tag \"_pg\" from the end of the object name and create the stored procedure.\n          \n          \n            \n                        // Remove the postgresql tag \"_pg\" from the end of the object name and execute the grants for the stored procedure.", "author": "lmsurpre", "createdAt": "2020-05-20T22:25:01Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/ProcedureDef.java", "diffHunk": "@@ -72,7 +72,7 @@ protected void grantGroupPrivileges(IDatabaseAdapter target, Set<Privilege> grou\n         // Only apply DB Type specific store procedures.\n         if (driveClassName.contains(this.getDbType().value())) {\n             // Remove the postgresql tag \"_pg\" from the end of the object name and create the stored procedure.", "originalCommit": "b88da7356848f84d2f45c925215861addfaaf6d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0MTAwMQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428641001", "bodyText": "Changed around and cleaned up", "author": "prb112", "createdAt": "2020-05-21T13:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MjM0OA=="}], "type": "inlineReview"}, {"oid": "fec138e8cc3ef17080703a7fa3e5c2be322356dd", "url": "https://github.com/IBM/FHIR/commit/fec138e8cc3ef17080703a7fa3e5c2be322356dd", "message": "Add Grant Actions and FHIR Persistence fhir-persistence-schema #1110\n\n- Refactor the Grant logic\n- Refactor Procedure and Functions and separate the application\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-21T00:36:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NzY3NQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428397675", "bodyText": "is it ever used anywhere?", "author": "lmsurpre", "createdAt": "2020-05-21T01:33:21Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/FhirSchemaConstants.java", "diffHunk": "@@ -29,6 +28,7 @@\n \n     // Group of privilege grants used for FHIRUSER access\n     public static final String FHIR_USER_GRANT_GROUP = \"fhiruser\";\n+    public static final String FHIR_BATCH_GRANT_GROUP = \"fhirbatch\";", "originalCommit": "fec138e8cc3ef17080703a7fa3e5c2be322356dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU5MzY5Mw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428593693", "bodyText": "no but it should be! great find", "author": "prb112", "createdAt": "2020-05-21T11:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NzY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU5NDY2MQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428594661", "bodyText": "Fixed, it's now used", "author": "prb112", "createdAt": "2020-05-21T11:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NzY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY1MDk5OA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428650998", "bodyText": "It makes me wonder if we should have a FHIR_OAUTH_GRANT_GROUP as well, but I think this PR already has enough in it.\nWe'll need to remember to update the diagrams with this new role (e.g. in the fhir-persistence-schema/docs and update the guides to indicate that the batch user must be in the fhirbatch role for this feature to work).\nPersonally, I might have saved that for a separate PR, but I'm OK with including it here.", "author": "lmsurpre", "createdAt": "2020-05-21T13:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NzY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQwMTcxMw==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428401713", "bodyText": "good catch.  i wonder how that second OAUTH_SCHEMANAME has slipped in there...", "author": "lmsurpre", "createdAt": "2020-05-21T01:49:59Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/DerbyBootstrapper.java", "diffHunk": "@@ -172,7 +174,7 @@ public static void bootstrapOauthDb(DataSource ds) throws Exception {\n                 // to determine which updates to apply and to record the new changes as they\n                 // are applied\n                 VersionHistoryService vhs =\n-                        new VersionHistoryService(ADMIN_SCHEMANAME, OAUTH_SCHEMANAME, OAUTH_SCHEMANAME);\n+                        new VersionHistoryService(ADMIN_SCHEMANAME, OAUTH_SCHEMANAME);", "originalCommit": "fec138e8cc3ef17080703a7fa3e5c2be322356dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f5f62a6e2a736fde3a6b35d9599ca7e384f4e4ed", "url": "https://github.com/IBM/FHIR/commit/f5f62a6e2a736fde3a6b35d9599ca7e384f4e4ed", "message": "Update for conflict\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-21T11:18:51Z", "type": "commit"}, {"oid": "55e0cca82661b33c5463dc1b3d7936a20f29abee", "url": "https://github.com/IBM/FHIR/commit/55e0cca82661b33c5463dc1b3d7936a20f29abee", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\nCo-authored-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-05-21T13:05:08Z", "type": "commit"}, {"oid": "42d7af361135d264ad9be219d36844759405904b", "url": "https://github.com/IBM/FHIR/commit/42d7af361135d264ad9be219d36844759405904b", "message": "issue 1110\n\n- Remove unused import from OldFhirSchemaGenerator\n- Update to FHIR_BATCH_GRANT_GROUP for Batch\n- Boostrap only executes when true and the batch datasource is derby\n- Refactor to support Default String or Default Smallint\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-21T13:07:59Z", "type": "commit"}, {"oid": "ab70258e4151e4f2bcfb20894e67418bdfe015e7", "url": "https://github.com/IBM/FHIR/commit/ab70258e4151e4f2bcfb20894e67418bdfe015e7", "message": "Merge branch 'issue-1110' of github.com:IBM/FHIR into issue-1110", "committedDate": "2020-05-21T13:09:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0NTMxMg==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428645312", "bodyText": "I thought you may want to check the datasource configuration in server.xml, but this also works. thanks!", "author": "albertwang-ibm", "createdAt": "2020-05-21T13:18:42Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/DerbyBootstrapper.java", "diffHunk": "@@ -197,31 +199,48 @@ public static void bootstrapOauthDb(DataSource ds) throws Exception {\n      * @throws SQLException\n      */\n     public static void bootstrapBatchDb(DataSource ds) throws SQLException {\n+        // This is specific to boostrapping where we are not suppose to use the derby db, rather a remote db.\n+        boolean isDerby = false;\n         try (Connection c = ds.getConnection()) {\n-            try {\n-                JdbcTarget target = new JdbcTarget(c);\n-                IDatabaseAdapter adapter = new DerbyAdapter(target);\n-\n-                // Set up the version history service first if it doesn't yet exist\n-                CreateVersionHistory.createTableIfNeeded(ADMIN_SCHEMANAME, adapter);\n-\n-                // Current version history for the database. This is used by applyWithHistory\n-                // to determine which updates to apply and to record the new changes as they\n-                // are applied\n-                VersionHistoryService vhs =\n-                        new VersionHistoryService(ADMIN_SCHEMANAME, BATCH_SCHEMANAME);\n-                vhs.setTarget(adapter);\n-                vhs.init();\n+            try (Statement stmt = c.createStatement();", "originalCommit": "42d7af361135d264ad9be219d36844759405904b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0OTI0NA==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428649244", "bodyText": "yes, that was one approach, I considered - I thought this was easiest :)", "author": "prb112", "createdAt": "2020-05-21T13:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0NTMxMg=="}], "type": "inlineReview"}, {"oid": "57a8455a95a7c35aef4991932b7939ac3589b8f4", "url": "https://github.com/IBM/FHIR/commit/57a8455a95a7c35aef4991932b7939ac3589b8f4", "message": "issue-1110\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-21T13:24:47Z", "type": "commit"}, {"oid": "62a5f6d60a2216d3646461f972f901ddec581ea9", "url": "https://github.com/IBM/FHIR/commit/62a5f6d60a2216d3646461f972f901ddec581ea9", "message": "issue-1110\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-21T13:30:21Z", "type": "commit"}, {"oid": "e7d3157ba7bf1d9e06a0cb3361119d7102b187ba", "url": "https://github.com/IBM/FHIR/commit/e7d3157ba7bf1d9e06a0cb3361119d7102b187ba", "message": "issue-1110\n\n- Fix references to db2\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-21T13:46:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2NDQ5NQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428664495", "bodyText": "I thought to limit the DB differences in the datautil/model layer, so I had added dbtype for the procedures, and then check dbtype before apply the objects.", "author": "albertwang-ibm", "createdAt": "2020-05-21T13:52:17Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -219,7 +219,7 @@ protected void buildCommonModel(PhysicalDataModel pdm, boolean fhirSchema, boole\n             gen.buildSchema(pdm);\n             switch (dbType) {\n             case DB2:\n-                gen.buildDatabaseSpecificArtifactsPostgres(pdm);\n+                gen.buildDatabaseSpecificArtifactsDb2(pdm);", "originalCommit": "e7d3157ba7bf1d9e06a0cb3361119d7102b187ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2NTU5OQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428665599", "bodyText": "I totally agree with this change, just wanted to share my thoughts. :)", "author": "albertwang-ibm", "createdAt": "2020-05-21T13:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2NDQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2ODE1NQ==", "url": "https://github.com/IBM/FHIR/pull/1123#discussion_r428668155", "bodyText": "it worked, I changed it and thought I could get away with doing what you did.  It didn't work so I had to split it out at this layer.", "author": "prb112", "createdAt": "2020-05-21T13:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2NDQ5NQ=="}], "type": "inlineReview"}, {"oid": "8ffd9a3186b79692f76993a1a4ae01d821304881", "url": "https://github.com/IBM/FHIR/commit/8ffd9a3186b79692f76993a1a4ae01d821304881", "message": "issue-1110\n\n- Fix table naming issue\n- Add test for postgres\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-21T15:49:31Z", "type": "commit"}, {"oid": "aa906d62d1aca3e22d4d5f086fc5851f8367df16", "url": "https://github.com/IBM/FHIR/commit/aa906d62d1aca3e22d4d5f086fc5851f8367df16", "message": "issue-1110\n\n- Boolean / SmallInt management for Postgres\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-21T16:26:47Z", "type": "commit"}, {"oid": "7a2cfe6008213650d89011d86a0fcf5115d80387", "url": "https://github.com/IBM/FHIR/commit/7a2cfe6008213650d89011d86a0fcf5115d80387", "message": "issue #1110 - string literal default handling\n\nnow addClobColumn will automatically wrap the defaultVal in single\nquotes (since the framework doesn't do this any more)\n\nalso removed the unused com.ibm.fhir.database.utils.AddColumn\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-05-21T17:54:59Z", "type": "commit"}, {"oid": "6a7e5222b2b7ef9e05ba02e43695e86ac1f09586", "url": "https://github.com/IBM/FHIR/commit/6a7e5222b2b7ef9e05ba02e43695e86ac1f09586", "message": "issue #1110 - fixed message for java batch bootsrapping\n\nit accidentally listed the OAuthDB JNDI name when it should have been\nfor batch\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-05-21T18:04:20Z", "type": "commit"}]}