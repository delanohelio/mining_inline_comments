{"pr_number": 1078, "pr_title": "Add cache support for the capabilites request #734", "pr_createdAt": "2020-05-12T19:17:09Z", "pr_url": "https://github.com/IBM/FHIR/pull/1078", "timeline": [{"oid": "c100d1ddbca32b35f1a48297010ca95e10c3116d", "url": "https://github.com/IBM/FHIR/commit/c100d1ddbca32b35f1a48297010ca95e10c3116d", "message": "Add cache support for the capabilites request #734\n\n- Update cloud.xml to point to the location ( per warning in eclipse)\n- Update Capabilities statement to use a concurrent hash map\n- Cache time is one hour\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-12T19:15:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4MDU3MA==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423980570", "bodyText": "i prefer the style we had before", "author": "lmsurpre", "createdAt": "2020-05-12T19:29:11Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/Capabilities.java", "diffHunk": "@@ -388,26 +404,23 @@ private CapabilityStatement addExtensionElements(CapabilityStatement capabilityS\n             auditLogServiceName = auditLogServiceName.substring(lastDelimeter + 1);\n         }\n \n-        extension = Extension.builder()\n-                .url(EXTENSION_URL + \"/auditLogServiceName\")\n-                .value(string(auditLogServiceName))\n-                .build();\n+        extension =\n+                Extension.builder().url(EXTENSION_URL + \"/auditLogServiceName\").value(string(auditLogServiceName))\n+                        .build();\n         extentions.add(extension);\n \n         PropertyGroup auditLogProperties =\n                 fhirConfig.getPropertyGroup(FHIRConfiguration.PROPERTY_AUDIT_SERVICE_PROPERTIES);\n         String auditLogPropertiesString =\n                 auditLogProperties != null ? auditLogProperties.toString() : \"<not specified>\";\n-        extension = Extension.builder()\n-                .url(EXTENSION_URL + \"/auditLogProperties\")\n-                .value(string(auditLogPropertiesString))\n-                .build();\n+        extension =\n+                Extension.builder().url(EXTENSION_URL + \"/auditLogProperties\").value(string(auditLogPropertiesString))\n+                        .build();\n         extentions.add(extension);\n \n-        extension = Extension.builder()\n-                .url(EXTENSION_URL + \"/persistenceType\")\n-                .value(string(getPersistenceImpl().getClass().getSimpleName()))\n-                .build();\n+        extension =\n+                Extension.builder().url(EXTENSION_URL + \"/persistenceType\")\n+                        .value(string(getPersistenceImpl().getClass().getSimpleName())).build();", "originalCommit": "c100d1ddbca32b35f1a48297010ca95e10c3116d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4MTAwMw==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423981003", "bodyText": "I prefer the style we had before", "author": "lmsurpre", "createdAt": "2020-05-12T19:29:59Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/Capabilities.java", "diffHunk": "@@ -330,56 +346,56 @@ private CapabilityStatement buildCapabilityStatement() throws Exception {\n                 throw new IllegalStateException(\"Operation \" + opDef.getCode().getValue() + \" has no url\");\n             }\n \n-            ops.add(Rest.Resource.Operation.builder()\n-                    .name(opDef.getCode())\n-                    .definition(Canonical.of(opDef.getUrl().getValue(), opDef.getVersion() == null ? null : opDef.getVersion().getValue()))\n-                    .documentation(opDef.getDescription())\n-                    .build());\n+            ops.add(Rest.Resource.Operation.builder().name(opDef.getCode())\n+                    .definition(Canonical.of(opDef.getUrl().getValue(),\n+                            opDef.getVersion() == null ? null : opDef.getVersion().getValue()))\n+                    .documentation(opDef.getDescription()).build());\n         }\n \n         return ops;\n     }\n \n-    private CapabilityStatement addExtensionElements(CapabilityStatement capabilityStatement)\n-        throws Exception {\n+    private CapabilityStatement addExtensionElements(CapabilityStatement capabilityStatement) throws Exception {\n         List<Extension> extentions = new ArrayList<Extension>();\n-        Extension extension = Extension.builder()\n-                .url(EXTENSION_URL + \"/defaultTenantId\")\n-                .value(string(fhirConfig.getStringProperty(FHIRConfiguration.PROPERTY_DEFAULT_TENANT_ID, FHIRConfiguration.DEFAULT_TENANT_ID)))\n-                .build();\n+        Extension extension =\n+                Extension.builder().url(EXTENSION_URL + \"/defaultTenantId\")\n+                        .value(string(fhirConfig.getStringProperty(FHIRConfiguration.PROPERTY_DEFAULT_TENANT_ID,\n+                                FHIRConfiguration.DEFAULT_TENANT_ID)))\n+                        .build();\n         extentions.add(extension);\n \n-        extension = Extension.builder()\n-                .url(EXTENSION_URL + \"/websocketNotificationsEnabled\")\n-                .value(com.ibm.fhir.model.type.Boolean.of(fhirConfig.getBooleanProperty(FHIRConfiguration.PROPERTY_WEBSOCKET_ENABLED, Boolean.FALSE)))\n-                .build();\n+        extension =\n+                Extension.builder().url(EXTENSION_URL + \"/websocketNotificationsEnabled\")\n+                        .value(com.ibm.fhir.model.type.Boolean.of(fhirConfig\n+                                .getBooleanProperty(FHIRConfiguration.PROPERTY_WEBSOCKET_ENABLED, Boolean.FALSE)))\n+                        .build();\n         extentions.add(extension);\n \n-        extension = Extension.builder()\n-                .url(EXTENSION_URL + \"/kafkaNotificationsEnabled\")\n-                .value(com.ibm.fhir.model.type.Boolean.of(fhirConfig.getBooleanProperty(FHIRConfiguration.PROPERTY_KAFKA_ENABLED, Boolean.FALSE)))\n-                .build();\n+        extension =\n+                Extension.builder().url(EXTENSION_URL + \"/kafkaNotificationsEnabled\")\n+                        .value(com.ibm.fhir.model.type.Boolean.of(\n+                                fhirConfig.getBooleanProperty(FHIRConfiguration.PROPERTY_KAFKA_ENABLED, Boolean.FALSE)))\n+                        .build();\n         extentions.add(extension);\n \n-        extension = Extension.builder()\n-                .url(EXTENSION_URL + \"/natsNotificationsEnabled\")\n-                .value(com.ibm.fhir.model.type.Boolean.of(fhirConfig.getBooleanProperty(FHIRConfiguration.PROPERTY_NATS_ENABLED, Boolean.FALSE)))\n-                .build();\n+        extension =\n+                Extension.builder().url(EXTENSION_URL + \"/natsNotificationsEnabled\")\n+                        .value(com.ibm.fhir.model.type.Boolean.of(\n+                                fhirConfig.getBooleanProperty(FHIRConfiguration.PROPERTY_NATS_ENABLED, Boolean.FALSE)))\n+                        .build();", "originalCommit": "c100d1ddbca32b35f1a48297010ca95e10c3116d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4MTY0NQ==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423981645", "bodyText": "I prefer the style we had before", "author": "lmsurpre", "createdAt": "2020-05-12T19:31:11Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/Capabilities.java", "diffHunk": "@@ -285,28 +307,22 @@ private CapabilityStatement buildCapabilityStatement() throws Exception {\n         format.add(Code.of(FHIRMediaType.APPLICATION_FHIR_XML));\n \n         // Finally, create the CapabilityStatement resource itself.\n-        CapabilityStatement conformance = CapabilityStatement.builder()\n-                .status(PublicationStatus.ACTIVE)\n-                .date(DateTime.of(ZonedDateTime.now(ZoneOffset.UTC)))\n-                .kind(CapabilityStatementKind.CAPABILITY)\n-                .fhirVersion(FHIRVersion.VERSION_4_0_1)\n-                .format(format)\n-                .patchFormat(Code.of(FHIRMediaType.APPLICATION_JSON_PATCH),\n-                             Code.of(FHIRMediaType.APPLICATION_FHIR_JSON),\n-                             Code.of(FHIRMediaType.APPLICATION_FHIR_XML))\n-                .version(string(buildInfo.getBuildVersion()))\n-                .name(string(FHIR_SERVER_NAME))\n-                .description(Markdown.of(buildDescription))\n-                .copyright(Markdown.of(FHIR_COPYRIGHT))\n-                .publisher(string(\"IBM Corporation\"))\n-                .software(CapabilityStatement.Software.builder()\n-                          .name(string(FHIR_SERVER_NAME))\n-                          .version(string(buildInfo.getBuildVersion()))\n-                          .id(buildInfo.getBuildId())\n-                          .build())\n-                .rest(rest)\n-                .instantiates(Canonical.of(\"http://www.hl7.org/fhir/bulk-data/CapabilityStatement-bulk-data.html\"))\n-                .build();\n+        CapabilityStatement conformance =\n+                CapabilityStatement.builder().status(PublicationStatus.ACTIVE)\n+                        .date(DateTime.of(ZonedDateTime.now(ZoneOffset.UTC))).kind(CapabilityStatementKind.CAPABILITY)\n+                        .fhirVersion(FHIRVersion.VERSION_4_0_1).format(format)\n+                        .patchFormat(Code.of(FHIRMediaType.APPLICATION_JSON_PATCH),\n+                                Code.of(FHIRMediaType.APPLICATION_FHIR_JSON),\n+                                Code.of(FHIRMediaType.APPLICATION_FHIR_XML))\n+                        .version(string(buildInfo.getBuildVersion())).name(string(FHIR_SERVER_NAME))\n+                        .description(Markdown.of(buildDescription)).copyright(Markdown.of(FHIR_COPYRIGHT))\n+                        .publisher(string(\"IBM Corporation\"))\n+                        .software(CapabilityStatement.Software.builder().name(string(FHIR_SERVER_NAME))\n+                                .version(string(buildInfo.getBuildVersion())).id(buildInfo.getBuildId()).build())\n+                        .rest(rest)\n+                        .instantiates(\n+                                Canonical.of(\"http://www.hl7.org/fhir/bulk-data/CapabilityStatement-bulk-data.html\"))\n+                        .build();\n ", "originalCommit": "c100d1ddbca32b35f1a48297010ca95e10c3116d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4MjE4MQ==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423982181", "bodyText": "i prefer the style we had before", "author": "lmsurpre", "createdAt": "2020-05-12T19:32:09Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/Capabilities.java", "diffHunk": "@@ -245,38 +272,33 @@ private CapabilityStatement buildCapabilityStatement() throws Exception {\n \n         String regURL = regURLTemplate.replaceAll(\"<host>\", actualHost);\n \n-        CapabilityStatement.Rest.Security restSecurity = CapabilityStatement.Rest.Security.builder()\n-                .service(CodeableConcept.builder()\n-                    .coding(Coding.builder()\n-                        .code(Code.of(\"SMART-on-FHIR\"))\n-                        .system(Uri.of(\"http://terminology.hl7.org/CodeSystem/restful-security-service\"))\n-                        .build())\n-                    .text(string(\"OAuth2 using SMART-on-FHIR profile (see http://docs.smarthealthit.org)\"))\n-                    .build())\n-                .extension(Extension.builder()\n-                    .url(\"http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris\")\n-                    .extension(\n-                        Extension.builder().url(\"token\").value(Url.of(tokenURL)).build(),\n-                        Extension.builder().url(\"authorize\").value(Url.of(authURL)).build(),\n-                        Extension.builder().url(\"register\").value(Url.of(regURL)).build())\n-                    .build())\n-                .build();\n-\n-        CapabilityStatement.Rest rest = CapabilityStatement.Rest.builder()\n-                .mode(RestfulCapabilityMode.SERVER)\n-                .security(restSecurity)\n-                .resource(resources)\n-                .interaction(CapabilityStatement.Rest.Interaction.builder()\n-                    .code(transactionMode)\n-                    .build())\n-                .operation(mapOperationDefinitionsToRestOperations(systemOps))\n-                .build();\n+        CapabilityStatement.Rest.Security restSecurity =\n+                CapabilityStatement.Rest.Security.builder()\n+                        .service(CodeableConcept.builder().coding(Coding.builder().code(Code.of(\"SMART-on-FHIR\"))\n+                                .system(Uri.of(\"http://terminology.hl7.org/CodeSystem/restful-security-service\"))\n+                                .build())\n+                                .text(string(\"OAuth2 using SMART-on-FHIR profile (see http://docs.smarthealthit.org)\"))\n+                                .build())\n+                        .extension(Extension.builder()\n+                                .url(\"http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris\")\n+                                .extension(Extension.builder().url(\"token\").value(Url.of(tokenURL)).build(),\n+                                        Extension.builder().url(\"authorize\").value(Url.of(authURL)).build(),\n+                                        Extension.builder().url(\"register\").value(Url.of(regURL)).build())\n+                                .build())\n+                        .build();", "originalCommit": "c100d1ddbca32b35f1a48297010ca95e10c3116d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4MjQ2Ng==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423982466", "bodyText": "i prefer the style we had before", "author": "lmsurpre", "createdAt": "2020-05-12T19:32:39Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/Capabilities.java", "diffHunk": "@@ -200,19 +230,17 @@ private CapabilityStatement buildCapabilityStatement() throws Exception {\n             }\n \n             // Build the ConformanceResource for this resource type.\n-            Rest.Resource cr = Rest.Resource.builder()\n-                    .type(ResourceType.of(resourceType))\n-                    .profile(Canonical.of(\"http://hl7.org/fhir/profiles/\" + resourceTypeName))\n-                    .supportedProfile(FHIRRegistry.getInstance().getProfiles(resourceTypeName))\n-                    .interaction(interactions)\n-                    .operation(ops)\n-                    .conditionalCreate(com.ibm.fhir.model.type.Boolean.of(true))\n-                    .conditionalUpdate(com.ibm.fhir.model.type.Boolean.of(true))\n-                    .updateCreate(com.ibm.fhir.model.type.Boolean.of(isUpdateCreateEnabled()))\n-                    .conditionalDelete(ConditionalDeleteStatus.MULTIPLE)\n-                    .conditionalRead(ConditionalReadStatus.FULL_SUPPORT)\n-                    .searchParam(conformanceSearchParams)\n-                    .build();\n+            Rest.Resource cr =\n+                    Rest.Resource.builder().type(ResourceType.of(resourceType))\n+                            .profile(Canonical.of(\"http://hl7.org/fhir/profiles/\" + resourceTypeName))\n+                            .supportedProfile(FHIRRegistry.getInstance().getProfiles(resourceTypeName))\n+                            .interaction(interactions).operation(ops)\n+                            .conditionalCreate(com.ibm.fhir.model.type.Boolean.of(true))\n+                            .conditionalUpdate(com.ibm.fhir.model.type.Boolean.of(true))\n+                            .updateCreate(com.ibm.fhir.model.type.Boolean.of(isUpdateCreateEnabled()))\n+                            .conditionalDelete(ConditionalDeleteStatus.MULTIPLE)\n+                            .conditionalRead(ConditionalReadStatus.FULL_SUPPORT).searchParam(conformanceSearchParams)\n+                            .build();", "originalCommit": "c100d1ddbca32b35f1a48297010ca95e10c3116d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4Mjg2NQ==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423982865", "bodyText": "i prefer the old style", "author": "lmsurpre", "createdAt": "2020-05-12T19:33:30Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/Capabilities.java", "diffHunk": "@@ -178,15 +210,13 @@ private CapabilityStatement buildCapabilityStatement() throws Exception {\n                 for (SearchParameter searchParameter : searchParameters) {\n                     // The name here is a natural language name, and intentionally not replaced with code.\n                     Rest.Resource.SearchParam.Builder conformanceSearchParamBuilder =\n-                            Rest.Resource.SearchParam.builder()\n-                                .name(searchParameter.getName())\n-                                .type(searchParameter.getType());\n+                            Rest.Resource.SearchParam.builder().name(searchParameter.getName())\n+                                    .type(searchParameter.getType());", "originalCommit": "c100d1ddbca32b35f1a48297010ca95e10c3116d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NTUxOQ==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423985519", "bodyText": "I've always wondered why this method is synchronized.  Definitely orthogonal to your PR, but let me know if you agree it shouldn't be needed...", "author": "lmsurpre", "createdAt": "2020-05-12T19:37:10Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/Capabilities.java", "diffHunk": "@@ -71,54 +74,83 @@\n import com.ibm.fhir.server.util.RestAuditLogger;\n \n @Path(\"/\")\n-@Consumes({ FHIRMediaType.APPLICATION_FHIR_JSON, MediaType.APPLICATION_JSON,\n-        FHIRMediaType.APPLICATION_FHIR_XML, MediaType.APPLICATION_XML })\n-@Produces({ FHIRMediaType.APPLICATION_FHIR_JSON, MediaType.APPLICATION_JSON,\n-        FHIRMediaType.APPLICATION_FHIR_XML, MediaType.APPLICATION_XML })\n+@Consumes({ FHIRMediaType.APPLICATION_FHIR_JSON, MediaType.APPLICATION_JSON, FHIRMediaType.APPLICATION_FHIR_XML,\n+        MediaType.APPLICATION_XML })\n+@Produces({ FHIRMediaType.APPLICATION_FHIR_JSON, MediaType.APPLICATION_JSON, FHIRMediaType.APPLICATION_FHIR_XML,\n+        MediaType.APPLICATION_XML })\n public class Capabilities extends FHIRResource {\n-    private static final Logger log =\n-            java.util.logging.Logger.getLogger(Capabilities.class.getName());\n-\n-    public Capabilities() throws Exception {\n-        super();\n-    }\n+    private static final Logger log = java.util.logging.Logger.getLogger(Capabilities.class.getName());\n \n+    // Constants\n     private static final String FHIR_SERVER_NAME = \"IBM FHIR Server\";\n     private static final String FHIR_COPYRIGHT = \"(C) Copyright IBM Corporation 2016, 2020\";\n     private static final String EXTENSION_URL = \"http://ibm.com/fhir/extension\";\n \n+    // Error Messages\n+    private static final String ERROR_MSG = \"Caught exception while processing 'metadata' request.\";\n+    private static final String ERROR_CONSTRUCTING = \"An error occurred while constructing the Conformance statement.\";\n+\n+    // Capability Statement Cache per Tenant\n+    private static ConcurrentHashMap<String, CapabilityStatement> CAPABILITY_STATEMENT_CACHE_PER_TENANT =\n+            new ConcurrentHashMap<>();\n+\n+    // Constructor\n+    public Capabilities() throws Exception {\n+        super();\n+    }\n+\n     @GET\n     @Path(\"metadata\")\n-    public Response capabilities() throws ClassNotFoundException {\n-        log.entering(this.getClass().getName(), \"metadata()\");\n-        Date startTime = new Date();\n-        String errMsg = \"Caught exception while processing 'metadata' request.\";\n-\n+    public Response capabilities() {\n+        log.entering(this.getClass().getName(), \"capabilities()\");\n         try {\n+            Date startTime = new Date();\n             checkInitComplete();\n-\n-            CapabilityStatement capabilityStatement = getCapabilityStatement();\n+            CapabilityStatement capabilityStatement = getOrCreateCapabilityStatement();\n             RestAuditLogger.logMetadata(httpServletRequest, startTime, new Date(), Response.Status.OK);\n \n             return Response.ok().entity(capabilityStatement).build();\n         } catch (FHIROperationException e) {\n-            log.log(Level.SEVERE, errMsg, e);\n+            log.log(Level.SEVERE, ERROR_MSG, e);\n             return exceptionResponse(e, issueListToStatus(e.getIssues()));\n         } catch (Exception e) {\n-            log.log(Level.SEVERE, errMsg, e);\n+            log.log(Level.SEVERE, ERROR_MSG, e);\n             return exceptionResponse(e, Response.Status.INTERNAL_SERVER_ERROR);\n         } finally {\n-            log.exiting(this.getClass().getName(), \"metadata()\");\n+            log.exiting(this.getClass().getName(), \"capabilities()\");\n+        }\n+    }\n+\n+    /*\n+     * get or create capability statement\n+     */\n+    private CapabilityStatement getOrCreateCapabilityStatement() throws FHIROperationException {\n+        // Get TenantId\n+        FHIRRequestContext ctx = FHIRRequestContext.get();\n+        String tenantId = ctx.getTenantId();\n+        CapabilityStatement statement = CAPABILITY_STATEMENT_CACHE_PER_TENANT.get(tenantId);\n+        if (statement == null) {\n+            statement = getCapabilityStatement();\n+            CAPABILITY_STATEMENT_CACHE_PER_TENANT.put(tenantId, statement);\n+        } else {\n+            // Previously the Conformance Statement was built\n+            // using ZonedDateTime.now(ZoneOffset.UTC)\n+            TemporalAccessor acc = statement.getDate().getValue();\n+            ZonedDateTime cachedTime = ZonedDateTime.from(acc);\n+\n+            if (ZonedDateTime.now().isBefore(cachedTime.plusHours(1))) {\n+                statement = getCapabilityStatement();\n+            }\n         }\n+        return statement;\n     }\n \n     private synchronized CapabilityStatement getCapabilityStatement() throws FHIROperationException {", "originalCommit": "c100d1ddbca32b35f1a48297010ca95e10c3116d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NzA1Mg==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423987052", "bodyText": "I think you are going to want to use the compute method on ConcurrentHashMap", "author": "JohnTimm", "createdAt": "2020-05-12T19:39:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NzM3OQ==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423987379", "bodyText": "and computeIfAbsent for the first one", "author": "JohnTimm", "createdAt": "2020-05-12T19:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NzUyNw==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423987527", "bodyText": "Let me remove. If we find we need to add it back we can.", "author": "prb112", "createdAt": "2020-05-12T19:40:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4ODc1Mg==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423988752", "bodyText": "what about something like:\nCAPABILITY_STATEMENT_CACHE.compute(tenantId, k -> getOrCreateCapabilityStatement());", "author": "JohnTimm", "createdAt": "2020-05-12T19:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4ODk1Mw==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423988953", "bodyText": "compute should be atomic (for ConcurrentHashMap)", "author": "JohnTimm", "createdAt": "2020-05-12T19:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk5MTIyMg==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r423991222", "bodyText": "and compute returns the new value:\nCapabilityStatement capabilityStatement = CAPABILITY_STATEMENT_CACHE.compute(tenantId, k -> getOrCreateCapabilityStatement(tenantId));", "author": "JohnTimm", "createdAt": "2020-05-12T19:47:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyNjM4Nw==", "url": "https://github.com/IBM/FHIR/pull/1078#discussion_r424026387", "bodyText": "Flipped around per conversation", "author": "prb112", "createdAt": "2020-05-12T20:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NTUxOQ=="}], "type": "inlineReview"}, {"oid": "3c2aa513c6efb34406b89c2f7ebca5b29b6ff5e5", "url": "https://github.com/IBM/FHIR/commit/3c2aa513c6efb34406b89c2f7ebca5b29b6ff5e5", "message": "Add cache support for the capabilites request #734\n\n- Update cloud.xml per code review\n- Add example to fhir-server-config-db2.json\n- Update to use compute\n- Made Cache time configurable in fhir/core\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-12T20:07:20Z", "type": "commit"}, {"oid": "2868ff5471ca83245daab6090912feab619d4eba", "url": "https://github.com/IBM/FHIR/commit/2868ff5471ca83245daab6090912feab619d4eba", "message": "Add cache support for the capabilites request #734\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-12T20:51:34Z", "type": "commit"}, {"oid": "a33a7d49faf67b0f0f407cddf662db38763eff8f", "url": "https://github.com/IBM/FHIR/commit/a33a7d49faf67b0f0f407cddf662db38763eff8f", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\nCo-authored-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-05-13T10:46:13Z", "type": "commit"}, {"oid": "fd4d780e0bbf16ec31dc0f57e0a528ae9ec9424c", "url": "https://github.com/IBM/FHIR/commit/fd4d780e0bbf16ec31dc0f57e0a528ae9ec9424c", "message": "Update for Cache-Control\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-13T12:41:52Z", "type": "commit"}]}