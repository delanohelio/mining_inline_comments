{"pr_number": 1209, "pr_title": "issue #1198 performance enhancement for patient/group export", "pr_createdAt": "2020-06-09T19:23:31Z", "pr_url": "https://github.com/IBM/FHIR/pull/1209", "timeline": [{"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e", "url": "https://github.com/IBM/FHIR/commit/e67865eeb1e3aefb1338acf76abbd751d538209e", "message": "issue #1198 performance enhancement for patient/group export\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-09T19:17:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NzE3NQ==", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r437667175", "bodyText": "took me a second to follow this, but looks OK.", "author": "prb112", "createdAt": "2020-06-09T19:28:46Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/patient/ChunkReader.java", "diffHunk": "@@ -154,12 +156,20 @@ protected void fillChunkDataBuffer(List<String> patientIds) throws Exception {\n                 if (!searchCriteria.isEmpty()) {\n                     queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCriteria);\n                 }\n-\n                 queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n \n-                for (String patientId : patientIds) {\n+                List<String> compartmentSearchCriterias = CompartmentUtil.getCompartmentResourceTypeInclusionCriteria(\"Patient\", resourceType.getSimpleName());\n+                if (compartmentSearchCriterias.size() > 1) {\n+                    isDoDuplicationCheck = true;\n+                }\n+\n+                for (String compartmentSearchCriteria: compartmentSearchCriterias) {\n+                    HashMap<String, List<String>> queryTmpParameters = new HashMap<>();\n+                    queryTmpParameters.putAll(queryParameters);\n+\n+                    queryTmpParameters.put(compartmentSearchCriteria, Arrays.asList(new String[] {String.join(\",\", patientIds)}));", "originalCommit": "e67865eeb1e3aefb1338acf76abbd751d538209e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NzUwNQ==", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r437667505", "bodyText": ":)", "author": "albertwang-ibm", "createdAt": "2020-06-09T19:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NzE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MTQ5MA==", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r437681490", "bodyText": "maybe add a TODO with a link to Issue #300 so that we remember to remove this line when we get to that?", "author": "lmsurpre", "createdAt": "2020-06-09T19:56:02Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/patient/ChunkReader.java", "diffHunk": "@@ -133,6 +134,7 @@ protected void fillChunkDataBuffer(List<String> patientIds) throws Exception {\n         FHIRSearchContext searchContext;\n \n         if (chunkData != null) {\n+            patientIds.replaceAll(x -> \"Patient/\" + x);", "originalCommit": "e67865eeb1e3aefb1338acf76abbd751d538209e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAzMDgwMQ==", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r438030801", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-06-10T10:45:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MTQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzY3Mw==", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r437683673", "bodyText": "where is this used?", "author": "lmsurpre", "createdAt": "2020-06-09T19:59:58Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/patient/ChunkReader.java", "diffHunk": "@@ -154,12 +156,20 @@ protected void fillChunkDataBuffer(List<String> patientIds) throws Exception {\n                 if (!searchCriteria.isEmpty()) {\n                     queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCriteria);\n                 }\n-\n                 queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n \n-                for (String patientId : patientIds) {\n+                List<String> compartmentSearchCriterias = CompartmentUtil.getCompartmentResourceTypeInclusionCriteria(\"Patient\", resourceType.getSimpleName());\n+                if (compartmentSearchCriterias.size() > 1) {\n+                    isDoDuplicationCheck = true;", "originalCommit": "e67865eeb1e3aefb1338acf76abbd751d538209e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAzMjAzOA==", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r438032038", "bodyText": "used in following resources loop, because _typeFilters, and compartmentsearchCriterias search results can have duplication, this was why the duplication removing codes was added..", "author": "albertwang-ibm", "createdAt": "2020-06-10T10:47:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4NDAwMA==", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r437684000", "bodyText": "should this be outside the for loop?", "author": "lmsurpre", "createdAt": "2020-06-09T20:00:34Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/patient/ChunkReader.java", "diffHunk": "@@ -154,12 +156,20 @@ protected void fillChunkDataBuffer(List<String> patientIds) throws Exception {\n                 if (!searchCriteria.isEmpty()) {\n                     queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCriteria);\n                 }\n-\n                 queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n \n-                for (String patientId : patientIds) {\n+                List<String> compartmentSearchCriterias = CompartmentUtil.getCompartmentResourceTypeInclusionCriteria(\"Patient\", resourceType.getSimpleName());\n+                if (compartmentSearchCriterias.size() > 1) {\n+                    isDoDuplicationCheck = true;\n+                }\n+\n+                for (String compartmentSearchCriteria: compartmentSearchCriterias) {\n+                    HashMap<String, List<String>> queryTmpParameters = new HashMap<>();\n+                    queryTmpParameters.putAll(queryParameters);", "originalCommit": "e67865eeb1e3aefb1338acf76abbd751d538209e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4NTE4NA==", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r437685184", "bodyText": "never mind, now I see that each compartmentSearchCriteria gets its own search query...i was thinking it was all combined into a single query", "author": "lmsurpre", "createdAt": "2020-06-09T20:02:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4NDAwMA=="}], "type": "inlineReview"}, {"oid": "3754d4bb24969a5287b3ee618a061cfa8599898f", "url": "https://github.com/IBM/FHIR/commit/3754d4bb24969a5287b3ee618a061cfa8599898f", "message": "issue #1198 add link to issue #300\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-10T10:44:54Z", "type": "commit"}]}