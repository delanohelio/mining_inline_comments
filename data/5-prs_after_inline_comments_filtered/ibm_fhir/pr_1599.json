{"pr_number": 1599, "pr_title": "Issue #1594 - fix overwriting of validate warnings in bundle processing", "pr_createdAt": "2020-10-19T20:11:02Z", "pr_url": "https://github.com/IBM/FHIR/pull/1599", "timeline": [{"oid": "7f806a3720a0f5ff8420e494afa580cae1a18528", "url": "https://github.com/IBM/FHIR/commit/7f806a3720a0f5ff8420e494afa580cae1a18528", "message": "Issue #1594 - fix overwriting of validate warnings in bundle processing\n\nSigned-off-by: Mike Schroeder <mschroed@us.ibm.com>", "committedDate": "2020-10-19T20:09:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAzOTY5MQ==", "url": "https://github.com/IBM/FHIR/pull/1599#discussion_r508039691", "bodyText": "Since OperationOutcome overrides equals, I think this is OK.  we're not comparing two pointers necessarily.\nConfirming (I also double checked this)", "author": "prb112", "createdAt": "2020-10-19T20:23:46Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java", "diffHunk": "@@ -2330,7 +2330,19 @@ private String getAbsoluteUri(String baseUri, String relativeUri) {\n             if (HTTPReturnPreference.REPRESENTATION.equals(FHIRRequestContext.get().getReturnPreference())) {\n                 bundleEntryBuilder.resource(resource);\n             } else if (HTTPReturnPreference.OPERATION_OUTCOME.equals(FHIRRequestContext.get().getReturnPreference())) {\n-                bundleEntryBuilder.resource(operationOutcome);\n+                OperationOutcome responseEntryOutcome = (OperationOutcome)responseEntry.getResource();\n+                if (responseEntryOutcome != null && !responseEntryOutcome.equals(FHIRUtil.ALL_OK)) {", "originalCommit": "7f806a3720a0f5ff8420e494afa580cae1a18528", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA0MDg4MQ==", "url": "https://github.com/IBM/FHIR/pull/1599#discussion_r508040881", "bodyText": "slight question here, should ALL_OK still be added along with the warning... Technically it's accepted.", "author": "prb112", "createdAt": "2020-10-19T20:25:51Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java", "diffHunk": "@@ -2330,7 +2330,19 @@ private String getAbsoluteUri(String baseUri, String relativeUri) {\n             if (HTTPReturnPreference.REPRESENTATION.equals(FHIRRequestContext.get().getReturnPreference())) {\n                 bundleEntryBuilder.resource(resource);\n             } else if (HTTPReturnPreference.OPERATION_OUTCOME.equals(FHIRRequestContext.get().getReturnPreference())) {\n-                bundleEntryBuilder.resource(operationOutcome);\n+                OperationOutcome responseEntryOutcome = (OperationOutcome)responseEntry.getResource();\n+                if (responseEntryOutcome != null && !responseEntryOutcome.equals(FHIRUtil.ALL_OK)) {\n+                    if (operationOutcome.equals(FHIRUtil.ALL_OK)) {\n+                        bundleEntryBuilder.resource(responseEntryOutcome);", "originalCommit": "7f806a3720a0f5ff8420e494afa580cae1a18528", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA0ODExNg==", "url": "https://github.com/IBM/FHIR/pull/1599#discussion_r508048116", "bodyText": "the way it's currently working in doCreate and doPatchOrUpdate is that the OperationOutcome is generated by the FHIRUtil.buildOperationOutcome(issues) method, passing in any warnings found during the create or update. In that method, the ALL_OK is only added if there are no warnings. So that's the logic I used - will only return the ALL_OK if there are no warnings.", "author": "michaelwschroeder", "createdAt": "2020-10-19T20:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA0MDg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEyNTE1NA==", "url": "https://github.com/IBM/FHIR/pull/1599#discussion_r508125154", "bodyText": "Works for me,", "author": "prb112", "createdAt": "2020-10-19T23:45:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA0MDg4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA4NDYxMw==", "url": "https://github.com/IBM/FHIR/pull/1599#discussion_r508084613", "bodyText": "Does it matter whether the request was a batch vs a transaction?\nI know for failed transaction requests we send back a single OperationOutcome (vs. sending one-per-resource in batch)...just want to make sure this logic works for both bundle types.", "author": "lmsurpre", "createdAt": "2020-10-19T21:53:04Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java", "diffHunk": "@@ -2330,7 +2330,19 @@ private String getAbsoluteUri(String baseUri, String relativeUri) {\n             if (HTTPReturnPreference.REPRESENTATION.equals(FHIRRequestContext.get().getReturnPreference())) {\n                 bundleEntryBuilder.resource(resource);\n             } else if (HTTPReturnPreference.OPERATION_OUTCOME.equals(FHIRRequestContext.get().getReturnPreference())) {\n-                bundleEntryBuilder.resource(operationOutcome);\n+                OperationOutcome responseEntryOutcome = (OperationOutcome)responseEntry.getResource();\n+                if (responseEntryOutcome != null && !responseEntryOutcome.equals(FHIRUtil.ALL_OK)) {\n+                    if (operationOutcome.equals(FHIRUtil.ALL_OK)) {\n+                        bundleEntryBuilder.resource(responseEntryOutcome);", "originalCommit": "7f806a3720a0f5ff8420e494afa580cae1a18528", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2OTY0NA==", "url": "https://github.com/IBM/FHIR/pull/1599#discussion_r508469644", "bodyText": "Yes, this works for both types. This method will only get called after a successful call to the persistence layer, so the only change is that on a successful request, the OperationOutcome object may now contain warnings that it didn't contain before. In the case of a failed transaction request during validation, that code path is unchanged - it returns all validation warnings/errors for the failed bundle entry only. In the case of a failed transaction request during create or update, that code path is also unchanged from before. An exception is thrown and a bad request code is returned.", "author": "michaelwschroeder", "createdAt": "2020-10-20T12:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA4NDYxMw=="}], "type": "inlineReview"}]}