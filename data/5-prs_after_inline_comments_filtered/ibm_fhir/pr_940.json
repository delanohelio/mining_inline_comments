{"pr_number": 940, "pr_title": "Bulk-Data Import Operation and API #671", "pr_createdAt": "2020-04-17T12:40:38Z", "pr_url": "https://github.com/IBM/FHIR/pull/940", "timeline": [{"oid": "aaeda25c8a47775003839dfb40c63d7f8f5c71ee", "url": "https://github.com/IBM/FHIR/commit/aaeda25c8a47775003839dfb40c63d7f8f5c71ee", "message": "Bulk-Data Import Operation and API #671\n\n- Develop helper code to build the OperationDefinition for $import\n- Update import.json with the generated OperationDefinition\n- Develop helper code to generate tests for $import Parameters object\n- Included $import parameters examples as part of testdata/\n- Introduce BulkDataImportUtil and Refactor ImportOperation\n\t- Refactor the method signature for import\n- Refactor $export-status to $bulkdata-status\n- Updated BulkDataUtil to BulkDataExportUtil\n- Add FHIRConfiguration entry for validBaseUrls\n- Refactor the configuration tests\n- Added importBulkData (import is reserved, otherwise the method would\nbe called import)\n- Refactor PollingLocationResponse to support $import and $export\n\t- increased test coverage to 100% for class covering the various cases\nof use and branches in the model and writers\n- Convert the PollingLocationResponse writer to honor the system wide\npretty printing setting from FHIRConfiguration\n- Increase Test Coverage\n- Add support for custom fields (datasourceinfo is base64 as it is\nserialized into a name-value pair)\n- Update FHIRServerUsersGuide.md (refactor $export and update for\n$import)\n- Add IT for $import - ImportOperationTest\n- Remove unused configuration tests\n- Refactor ExportOperationTest for changes to serialization\n- Update the fhir-server-config.json to include validBaseUrls\n- Add test-import.ndjson for Integration Testing\n- Add defensive programming on the number of inputs\n- Fix issue where ResourceTypes are always split by a space in `request`\n\n- Reference to\nhttps://github.com/smart-on-fhir/bulk-import/blob/master/import.md\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T12:38:33Z", "type": "commit"}, {"oid": "525bc9707659c87e6bcce7488dfedfb443e9de25", "url": "https://github.com/IBM/FHIR/commit/525bc9707659c87e6bcce7488dfedfb443e9de25", "message": "docker cleanup #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T13:05:26Z", "type": "commit"}, {"oid": "17d928b933fc9f89127f62c856190b919d8333fd", "url": "https://github.com/IBM/FHIR/commit/17d928b933fc9f89127f62c856190b919d8333fd", "message": "Merge branch 'master' into issue-671-redo", "committedDate": "2020-04-17T13:32:26Z", "type": "commit"}, {"oid": "0d6d306277a4bab5939967c08152a142f09aaa88", "url": "https://github.com/IBM/FHIR/commit/0d6d306277a4bab5939967c08152a142f09aaa88", "message": "docker cleanup #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T13:38:11Z", "type": "commit"}, {"oid": "98d800f41273a1867e08e73bc059aa1aacfe6ac9", "url": "https://github.com/IBM/FHIR/commit/98d800f41273a1867e08e73bc059aa1aacfe6ac9", "message": "docker cleanup #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T13:53:39Z", "type": "commit"}, {"oid": "a9c994325d28b973f17f9ffcbf6e28f1138688d2", "url": "https://github.com/IBM/FHIR/commit/a9c994325d28b973f17f9ffcbf6e28f1138688d2", "message": "docker cleanup #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T14:00:38Z", "type": "commit"}, {"oid": "0fd1a6c2d40ce5fd4bb9d612f12f7843dc0c7ac5", "url": "https://github.com/IBM/FHIR/commit/0fd1a6c2d40ce5fd4bb9d612f12f7843dc0c7ac5", "message": "docker cleanup #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T14:04:18Z", "type": "commit"}, {"oid": "f00c687f60a7cfa431147af5d9a61c6ecaaea08f", "url": "https://github.com/IBM/FHIR/commit/f00c687f60a7cfa431147af5d9a61c6ecaaea08f", "message": "docker cleanup #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T14:08:05Z", "type": "commit"}, {"oid": "23f91121acfd1c6973a3a9c5b2828114c9ebdfc5", "url": "https://github.com/IBM/FHIR/commit/23f91121acfd1c6973a3a9c5b2828114c9ebdfc5", "message": "docker cleanup #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T14:44:42Z", "type": "commit"}, {"oid": "988b9f237d7cdbf56373b57a0589dbcfe3183150", "url": "https://github.com/IBM/FHIR/commit/988b9f237d7cdbf56373b57a0589dbcfe3183150", "message": "docker cleanup #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T15:25:46Z", "type": "commit"}, {"oid": "d3e498040f24c943690b0c04169af42f15a6e417", "url": "https://github.com/IBM/FHIR/commit/d3e498040f24c943690b0c04169af42f15a6e417", "message": "docker cleanup #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T15:39:12Z", "type": "commit"}, {"oid": "05a61d75f2f4a6812d6f541ca994e3601358cf47", "url": "https://github.com/IBM/FHIR/commit/05a61d75f2f4a6812d6f541ca994e3601358cf47", "message": "docker cleanup #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T16:15:00Z", "type": "commit"}, {"oid": "ee2567030238c49b88af9352b72c924cacf79c65", "url": "https://github.com/IBM/FHIR/commit/ee2567030238c49b88af9352b72c924cacf79c65", "message": "Updates to Refine the Import Operation #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-17T20:21:41Z", "type": "commit"}, {"oid": "edce37272d37c1310e32a19fbd445793e12d5557", "url": "https://github.com/IBM/FHIR/commit/edce37272d37c1310e32a19fbd445793e12d5557", "message": "Merge branch 'master' into issue-671-redo", "committedDate": "2020-04-17T20:22:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0ODM5Mw==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410748393", "bodyText": "not sure if assigning a random id to resource with null id is the right approach.  because assigning random id doesn't help to preserver the relation between resources. so I chose to regard those resource with empty id as invalid resources which will be handled by the exception handler codes automatically.", "author": "albertwang-ibm", "createdAt": "2020-04-18T20:45:02Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkimport/ChunkWriter.java", "diffHunk": "@@ -188,12 +189,18 @@ public void writeItems(List<java.lang.Object> arg0) throws Exception {\n \n             for (Resource fhirResource : fhirResourceList) {\n                 try {\n+                    String id = fhirResource.getId();\n+                    if (id == null) {\n+                        id = UUID.randomUUID().toString();\n+                    }\n+", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyMDUzNg==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411620536", "bodyText": "You have confirmed my thoughts.  I have removed and added a comment.", "author": "prb112", "createdAt": "2020-04-20T19:05:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0ODM5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0ODU3MQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410748571", "bodyText": "need to remove the space.", "author": "albertwang-ibm", "createdAt": "2020-04-18T20:46:55Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkimport/ImportPartitionMapper.java", "diffHunk": "@@ -130,128 +137,137 @@\n     String cosCredentialIbm;\n \n     public ImportPartitionMapper() {\n-\n+        // No Operation\n     }\n \n-\n-    class FhirDataSource\n-    {\n+    class FhirDataSource {\n         private String type;\n         private String url;\n \n         public FhirDataSource(String type, String url) {\n             super();\n             this.type = type;\n-            this.url = url;\n+            this.url  = url;", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyNDAyMg==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411624022", "bodyText": "Fixed", "author": "prb112", "createdAt": "2020-04-20T19:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0ODU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0OTI1MA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410749250", "bodyText": "not sure if any change made to the 2 above function ...", "author": "albertwang-ibm", "createdAt": "2020-04-18T20:52:41Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkimport/ImportPartitionMapper.java", "diffHunk": "@@ -130,128 +137,137 @@\n     String cosCredentialIbm;\n \n     public ImportPartitionMapper() {\n-\n+        // No Operation\n     }\n \n-\n-    class FhirDataSource\n-    {\n+    class FhirDataSource {\n         private String type;\n         private String url;\n \n         public FhirDataSource(String type, String url) {\n             super();\n             this.type = type;\n-            this.url = url;\n+            this.url  = url;\n         }\n \n         public String getType() {\n             return type;\n         }\n+\n         public void setType(String type) {\n             this.type = type;\n         }\n+\n         public String getUrl() {\n             return url;\n         }\n+\n         public void setUrl(String url) {\n             this.url = url;\n         }\n-     };\n-\n-     private List<FhirDataSource> getFhirDataSourcesForObjectStore(String DSTypeInfo, String DSDataLocationInfo) throws Exception {\n-         String nextToken = null;\n-         List<FhirDataSource> fhirDataSources = new ArrayList<>();\n-         // Create a COS/S3 client if it's not created yet.\n-         if (cosClient == null) {\n-             cosClient = BulkDataUtils.getCosClient(cosCredentialIbm, cosApiKeyProperty, cosSrvinstId, cosEndpintUrl, cosLocation);\n-\n-             if (cosClient == null) {\n-                 logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get CosClient!\");\n-                 throw new Exception(\"Failed to get CosClient!!\");\n-             } else {\n-                 logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get CosClient!\");\n-             }\n-         }\n-         if (cosBucketName == null) {\n-             logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get BucketName!\");\n-             return fhirDataSources;\n-         }else {\n-             logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get BucketName!\");\n-         }\n-         cosBucketName = cosBucketName.toLowerCase();\n-         if (!cosClient.doesBucketExistV2(cosBucketName)) {\n-             logger.warning(\"getFhirDataSourcesForObjectStore: Bucket '\" + cosBucketName + \"' not found!\");\n-             BulkDataUtils.listBuckets(cosClient);\n-             return fhirDataSources;\n-         }\n-\n-         ListObjectsV2Result result = null;\n-         do {\n-             if (result != null) {\n-                 nextToken = result.getNextContinuationToken();\n-             }\n-             ListObjectsV2Request request = new ListObjectsV2Request().withBucketName(cosBucketName).withMaxKeys(1000)\n-                     .withContinuationToken(nextToken);\n-             result = cosClient.listObjectsV2(request);\n-             for (S3ObjectSummary objectSummary : result.getObjectSummaries()) {\n-                 boolean isToBeProccessed = false;\n-                 if (DSDataLocationInfo != null && !DSDataLocationInfo.trim().isEmpty()) {\n-                     if (objectSummary.getKey().startsWith(DSDataLocationInfo.trim())) {\n-                         isToBeProccessed = true;\n-                     }\n-                 } else {\n-                     isToBeProccessed = true;\n-                 }\n-                 if (isToBeProccessed) {\n-                     logger.info(\"getFhirDataSourcesForObjectStore: ObjectStorge Object(\" + objectSummary.getKey() + \") - \" + objectSummary.getSize()\n-                             + \" bytes.\");\n-                     if (objectSummary.getSize() > 0) {\n-                         fhirDataSources.add(new FhirDataSource(DSTypeInfo, objectSummary.getKey()));\n-                     }\n-                 }\n-             }\n-         } while (result != null && result.isTruncated());\n-\n-         return fhirDataSources;\n-     }\n-\n-\n-     private List<FhirDataSource> getFhirDataSources(JsonArray dataSourceArray, BulkImportDataSourceStorageType type) throws Exception\n-     {\n-         List<FhirDataSource> fhirDataSources = new ArrayList<>();\n-         for (JsonValue jsonValue : dataSourceArray) {\n-             JsonObject dataSourceInfo = jsonValue.asJsonObject();\n-             String DSTypeInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_TYPE);\n-             String DSDataLocationInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_URL);\n-\n-             switch (type) {\n-             case HTTPS:\n-             case FILE:\n-                 fhirDataSources.add(new FhirDataSource(DSTypeInfo, DSDataLocationInfo));\n-                 break;\n-             case AWSS3:\n-             case IBMCOS:\n-                 fhirDataSources.addAll(getFhirDataSourcesForObjectStore(DSTypeInfo, DSDataLocationInfo));\n-                 break;\n-             default:\n-                 break;\n-             }\n-         }\n-\n-         return fhirDataSources;\n-     }\n \n+        @Override\n+        public String toString() {\n+            return \"FhirDataSource [type=\" + type + \", url=\" + url + \"]\";\n+        }\n+    }\n+\n+    private List<FhirDataSource> getFhirDataSourcesForObjectStore(String dsTypeInfo, String dsDataLocationInfo)\n+            throws Exception {\n+        String nextToken = null;\n+        List<FhirDataSource> fhirDataSources = new ArrayList<>();\n+        // Create a COS/S3 client if it's not created yet.\n+        if (cosClient == null) {\n+            cosClient =\n+                    BulkDataUtils.getCosClient(cosCredentialIbm, cosApiKeyProperty, cosSrvinstId, cosEndpintUrl,\n+                            cosLocation);\n+\n+            if (cosClient == null) {\n+                logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get CosClient!\");\n+                throw new Exception(\"Failed to get CosClient!!\");\n+            } else {\n+                logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get CosClient!\");\n+            }\n+        }\n+        if (cosBucketName == null) {\n+            logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get BucketName!\");\n+            return fhirDataSources;\n+        } else {\n+            logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get BucketName!\");\n+        }\n+        cosBucketName = cosBucketName.toLowerCase();\n+        if (!cosClient.doesBucketExistV2(cosBucketName)) {\n+            logger.warning(\"getFhirDataSourcesForObjectStore: Bucket '\" + cosBucketName + \"' not found!\");\n+            BulkDataUtils.listBuckets(cosClient);\n+            return fhirDataSources;\n+        }\n+\n+        ListObjectsV2Result result = null;\n+        do {\n+            if (result != null) {\n+                nextToken = result.getNextContinuationToken();\n+            }\n+            ListObjectsV2Request request =\n+                    new ListObjectsV2Request().withBucketName(cosBucketName).withMaxKeys(1000)\n+                            .withContinuationToken(nextToken);\n+            result = cosClient.listObjectsV2(request);\n+            for (S3ObjectSummary objectSummary : result.getObjectSummaries()) {\n+                boolean isToBeProccessed = false;\n+                if (dsDataLocationInfo != null && !dsDataLocationInfo.trim().isEmpty()) {\n+                    if (objectSummary.getKey().startsWith(dsDataLocationInfo.trim())) {\n+                        isToBeProccessed = true;\n+                    }\n+                } else {\n+                    isToBeProccessed = true;\n+                }\n+                if (isToBeProccessed) {\n+                    logger.info(\"getFhirDataSourcesForObjectStore: ObjectStorge Object(\" + objectSummary.getKey()\n+                            + \") - \" + objectSummary.getSize() + \" bytes.\");\n+                    if (objectSummary.getSize() > 0) {\n+                        fhirDataSources.add(new FhirDataSource(dsTypeInfo, objectSummary.getKey()));\n+                    }\n+                }\n+            }\n+        } while (result != null && result.isTruncated());\n+\n+        return fhirDataSources;\n+    }\n+\n+    private List<FhirDataSource> getFhirDataSources(JsonArray dataSourceArray, BulkImportDataSourceStorageType type)\n+            throws Exception {\n+        List<FhirDataSource> fhirDataSources = new ArrayList<>();\n+        for (JsonValue jsonValue : dataSourceArray) {\n+            JsonObject dataSourceInfo = jsonValue.asJsonObject();\n+            String dsTypeInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_TYPE);\n+            String dsDataLocationInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_URL);\n+\n+            switch (type) {\n+            case HTTPS:\n+            case FILE:\n+                fhirDataSources.add(new FhirDataSource(dsTypeInfo, dsDataLocationInfo));\n+                break;\n+            case AWSS3:\n+            case IBMCOS:\n+                fhirDataSources.addAll(getFhirDataSourcesForObjectStore(dsTypeInfo, dsDataLocationInfo));\n+                break;\n+            default:\n+                break;\n+            }\n+        }\n+\n+        return fhirDataSources;\n+    }", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyNDYyOQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411624629", "bodyText": "made camelcase, and originally I had moved base64 processing around.\nShould be ok- now, no changes, just formatting and names", "author": "prb112", "createdAt": "2020-04-20T19:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0OTI1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0OTU4MQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410749581", "bodyText": "changing the codes to 3 lines seems a little bit weird for me.", "author": "albertwang-ibm", "createdAt": "2020-04-18T20:55:14Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkimport/ImportPartitionMapper.java", "diffHunk": "@@ -130,128 +137,137 @@\n     String cosCredentialIbm;\n \n     public ImportPartitionMapper() {\n-\n+        // No Operation\n     }\n \n-\n-    class FhirDataSource\n-    {\n+    class FhirDataSource {\n         private String type;\n         private String url;\n \n         public FhirDataSource(String type, String url) {\n             super();\n             this.type = type;\n-            this.url = url;\n+            this.url  = url;\n         }\n \n         public String getType() {\n             return type;\n         }\n+\n         public void setType(String type) {\n             this.type = type;\n         }\n+\n         public String getUrl() {\n             return url;\n         }\n+\n         public void setUrl(String url) {\n             this.url = url;\n         }\n-     };\n-\n-     private List<FhirDataSource> getFhirDataSourcesForObjectStore(String DSTypeInfo, String DSDataLocationInfo) throws Exception {\n-         String nextToken = null;\n-         List<FhirDataSource> fhirDataSources = new ArrayList<>();\n-         // Create a COS/S3 client if it's not created yet.\n-         if (cosClient == null) {\n-             cosClient = BulkDataUtils.getCosClient(cosCredentialIbm, cosApiKeyProperty, cosSrvinstId, cosEndpintUrl, cosLocation);\n-\n-             if (cosClient == null) {\n-                 logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get CosClient!\");\n-                 throw new Exception(\"Failed to get CosClient!!\");\n-             } else {\n-                 logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get CosClient!\");\n-             }\n-         }\n-         if (cosBucketName == null) {\n-             logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get BucketName!\");\n-             return fhirDataSources;\n-         }else {\n-             logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get BucketName!\");\n-         }\n-         cosBucketName = cosBucketName.toLowerCase();\n-         if (!cosClient.doesBucketExistV2(cosBucketName)) {\n-             logger.warning(\"getFhirDataSourcesForObjectStore: Bucket '\" + cosBucketName + \"' not found!\");\n-             BulkDataUtils.listBuckets(cosClient);\n-             return fhirDataSources;\n-         }\n-\n-         ListObjectsV2Result result = null;\n-         do {\n-             if (result != null) {\n-                 nextToken = result.getNextContinuationToken();\n-             }\n-             ListObjectsV2Request request = new ListObjectsV2Request().withBucketName(cosBucketName).withMaxKeys(1000)\n-                     .withContinuationToken(nextToken);\n-             result = cosClient.listObjectsV2(request);\n-             for (S3ObjectSummary objectSummary : result.getObjectSummaries()) {\n-                 boolean isToBeProccessed = false;\n-                 if (DSDataLocationInfo != null && !DSDataLocationInfo.trim().isEmpty()) {\n-                     if (objectSummary.getKey().startsWith(DSDataLocationInfo.trim())) {\n-                         isToBeProccessed = true;\n-                     }\n-                 } else {\n-                     isToBeProccessed = true;\n-                 }\n-                 if (isToBeProccessed) {\n-                     logger.info(\"getFhirDataSourcesForObjectStore: ObjectStorge Object(\" + objectSummary.getKey() + \") - \" + objectSummary.getSize()\n-                             + \" bytes.\");\n-                     if (objectSummary.getSize() > 0) {\n-                         fhirDataSources.add(new FhirDataSource(DSTypeInfo, objectSummary.getKey()));\n-                     }\n-                 }\n-             }\n-         } while (result != null && result.isTruncated());\n-\n-         return fhirDataSources;\n-     }\n-\n-\n-     private List<FhirDataSource> getFhirDataSources(JsonArray dataSourceArray, BulkImportDataSourceStorageType type) throws Exception\n-     {\n-         List<FhirDataSource> fhirDataSources = new ArrayList<>();\n-         for (JsonValue jsonValue : dataSourceArray) {\n-             JsonObject dataSourceInfo = jsonValue.asJsonObject();\n-             String DSTypeInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_TYPE);\n-             String DSDataLocationInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_URL);\n-\n-             switch (type) {\n-             case HTTPS:\n-             case FILE:\n-                 fhirDataSources.add(new FhirDataSource(DSTypeInfo, DSDataLocationInfo));\n-                 break;\n-             case AWSS3:\n-             case IBMCOS:\n-                 fhirDataSources.addAll(getFhirDataSourcesForObjectStore(DSTypeInfo, DSDataLocationInfo));\n-                 break;\n-             default:\n-                 break;\n-             }\n-         }\n-\n-         return fhirDataSources;\n-     }\n \n+        @Override\n+        public String toString() {\n+            return \"FhirDataSource [type=\" + type + \", url=\" + url + \"]\";\n+        }\n+    }\n+\n+    private List<FhirDataSource> getFhirDataSourcesForObjectStore(String dsTypeInfo, String dsDataLocationInfo)\n+            throws Exception {\n+        String nextToken = null;\n+        List<FhirDataSource> fhirDataSources = new ArrayList<>();\n+        // Create a COS/S3 client if it's not created yet.\n+        if (cosClient == null) {\n+            cosClient =\n+                    BulkDataUtils.getCosClient(cosCredentialIbm, cosApiKeyProperty, cosSrvinstId, cosEndpintUrl,\n+                            cosLocation);\n+\n+            if (cosClient == null) {\n+                logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get CosClient!\");\n+                throw new Exception(\"Failed to get CosClient!!\");\n+            } else {\n+                logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get CosClient!\");\n+            }\n+        }\n+        if (cosBucketName == null) {\n+            logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get BucketName!\");\n+            return fhirDataSources;\n+        } else {\n+            logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get BucketName!\");\n+        }\n+        cosBucketName = cosBucketName.toLowerCase();\n+        if (!cosClient.doesBucketExistV2(cosBucketName)) {\n+            logger.warning(\"getFhirDataSourcesForObjectStore: Bucket '\" + cosBucketName + \"' not found!\");\n+            BulkDataUtils.listBuckets(cosClient);\n+            return fhirDataSources;\n+        }\n+\n+        ListObjectsV2Result result = null;\n+        do {\n+            if (result != null) {\n+                nextToken = result.getNextContinuationToken();\n+            }\n+            ListObjectsV2Request request =\n+                    new ListObjectsV2Request().withBucketName(cosBucketName).withMaxKeys(1000)\n+                            .withContinuationToken(nextToken);\n+            result = cosClient.listObjectsV2(request);\n+            for (S3ObjectSummary objectSummary : result.getObjectSummaries()) {\n+                boolean isToBeProccessed = false;\n+                if (dsDataLocationInfo != null && !dsDataLocationInfo.trim().isEmpty()) {\n+                    if (objectSummary.getKey().startsWith(dsDataLocationInfo.trim())) {\n+                        isToBeProccessed = true;\n+                    }\n+                } else {\n+                    isToBeProccessed = true;\n+                }\n+                if (isToBeProccessed) {\n+                    logger.info(\"getFhirDataSourcesForObjectStore: ObjectStorge Object(\" + objectSummary.getKey()\n+                            + \") - \" + objectSummary.getSize() + \" bytes.\");\n+                    if (objectSummary.getSize() > 0) {\n+                        fhirDataSources.add(new FhirDataSource(dsTypeInfo, objectSummary.getKey()));\n+                    }\n+                }\n+            }\n+        } while (result != null && result.isTruncated());\n+\n+        return fhirDataSources;\n+    }\n+\n+    private List<FhirDataSource> getFhirDataSources(JsonArray dataSourceArray, BulkImportDataSourceStorageType type)\n+            throws Exception {\n+        List<FhirDataSource> fhirDataSources = new ArrayList<>();\n+        for (JsonValue jsonValue : dataSourceArray) {\n+            JsonObject dataSourceInfo = jsonValue.asJsonObject();\n+            String dsTypeInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_TYPE);\n+            String dsDataLocationInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_URL);\n+\n+            switch (type) {\n+            case HTTPS:\n+            case FILE:\n+                fhirDataSources.add(new FhirDataSource(dsTypeInfo, dsDataLocationInfo));\n+                break;\n+            case AWSS3:\n+            case IBMCOS:\n+                fhirDataSources.addAll(getFhirDataSourcesForObjectStore(dsTypeInfo, dsDataLocationInfo));\n+                break;\n+            default:\n+                break;\n+            }\n+        }\n+\n+        return fhirDataSources;\n+    }\n \n     @Override\n     public PartitionPlan mapPartitions() throws Exception {\n-        JsonReader reader = Json.createReader(new StringReader(\n-                new String(Base64.getDecoder().decode(dataSourcesInfo), StandardCharsets.UTF_8)));\n+        JsonReader reader =\n+                Json.createReader(new StringReader(\n+                        new String(Base64.getDecoder().decode(dataSourcesInfo), StandardCharsets.UTF_8)));", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyNTQyNg==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411625426", "bodyText": "I removed a logger between them at one point.  I was concerned I had bad data. I figured the Logger was no longer necessary.  The three lines is based on the line wrapping at 120 characters.", "author": "prb112", "createdAt": "2020-04-20T19:13:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0OTU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0OTY2NA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410749664", "bodyText": "because dsType is only used once, so, not really sure if it's good to use a local variable for it.", "author": "albertwang-ibm", "createdAt": "2020-04-18T20:56:12Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkimport/ImportPartitionMapper.java", "diffHunk": "@@ -130,128 +137,137 @@\n     String cosCredentialIbm;\n \n     public ImportPartitionMapper() {\n-\n+        // No Operation\n     }\n \n-\n-    class FhirDataSource\n-    {\n+    class FhirDataSource {\n         private String type;\n         private String url;\n \n         public FhirDataSource(String type, String url) {\n             super();\n             this.type = type;\n-            this.url = url;\n+            this.url  = url;\n         }\n \n         public String getType() {\n             return type;\n         }\n+\n         public void setType(String type) {\n             this.type = type;\n         }\n+\n         public String getUrl() {\n             return url;\n         }\n+\n         public void setUrl(String url) {\n             this.url = url;\n         }\n-     };\n-\n-     private List<FhirDataSource> getFhirDataSourcesForObjectStore(String DSTypeInfo, String DSDataLocationInfo) throws Exception {\n-         String nextToken = null;\n-         List<FhirDataSource> fhirDataSources = new ArrayList<>();\n-         // Create a COS/S3 client if it's not created yet.\n-         if (cosClient == null) {\n-             cosClient = BulkDataUtils.getCosClient(cosCredentialIbm, cosApiKeyProperty, cosSrvinstId, cosEndpintUrl, cosLocation);\n-\n-             if (cosClient == null) {\n-                 logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get CosClient!\");\n-                 throw new Exception(\"Failed to get CosClient!!\");\n-             } else {\n-                 logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get CosClient!\");\n-             }\n-         }\n-         if (cosBucketName == null) {\n-             logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get BucketName!\");\n-             return fhirDataSources;\n-         }else {\n-             logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get BucketName!\");\n-         }\n-         cosBucketName = cosBucketName.toLowerCase();\n-         if (!cosClient.doesBucketExistV2(cosBucketName)) {\n-             logger.warning(\"getFhirDataSourcesForObjectStore: Bucket '\" + cosBucketName + \"' not found!\");\n-             BulkDataUtils.listBuckets(cosClient);\n-             return fhirDataSources;\n-         }\n-\n-         ListObjectsV2Result result = null;\n-         do {\n-             if (result != null) {\n-                 nextToken = result.getNextContinuationToken();\n-             }\n-             ListObjectsV2Request request = new ListObjectsV2Request().withBucketName(cosBucketName).withMaxKeys(1000)\n-                     .withContinuationToken(nextToken);\n-             result = cosClient.listObjectsV2(request);\n-             for (S3ObjectSummary objectSummary : result.getObjectSummaries()) {\n-                 boolean isToBeProccessed = false;\n-                 if (DSDataLocationInfo != null && !DSDataLocationInfo.trim().isEmpty()) {\n-                     if (objectSummary.getKey().startsWith(DSDataLocationInfo.trim())) {\n-                         isToBeProccessed = true;\n-                     }\n-                 } else {\n-                     isToBeProccessed = true;\n-                 }\n-                 if (isToBeProccessed) {\n-                     logger.info(\"getFhirDataSourcesForObjectStore: ObjectStorge Object(\" + objectSummary.getKey() + \") - \" + objectSummary.getSize()\n-                             + \" bytes.\");\n-                     if (objectSummary.getSize() > 0) {\n-                         fhirDataSources.add(new FhirDataSource(DSTypeInfo, objectSummary.getKey()));\n-                     }\n-                 }\n-             }\n-         } while (result != null && result.isTruncated());\n-\n-         return fhirDataSources;\n-     }\n-\n-\n-     private List<FhirDataSource> getFhirDataSources(JsonArray dataSourceArray, BulkImportDataSourceStorageType type) throws Exception\n-     {\n-         List<FhirDataSource> fhirDataSources = new ArrayList<>();\n-         for (JsonValue jsonValue : dataSourceArray) {\n-             JsonObject dataSourceInfo = jsonValue.asJsonObject();\n-             String DSTypeInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_TYPE);\n-             String DSDataLocationInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_URL);\n-\n-             switch (type) {\n-             case HTTPS:\n-             case FILE:\n-                 fhirDataSources.add(new FhirDataSource(DSTypeInfo, DSDataLocationInfo));\n-                 break;\n-             case AWSS3:\n-             case IBMCOS:\n-                 fhirDataSources.addAll(getFhirDataSourcesForObjectStore(DSTypeInfo, DSDataLocationInfo));\n-                 break;\n-             default:\n-                 break;\n-             }\n-         }\n-\n-         return fhirDataSources;\n-     }\n \n+        @Override\n+        public String toString() {\n+            return \"FhirDataSource [type=\" + type + \", url=\" + url + \"]\";\n+        }\n+    }\n+\n+    private List<FhirDataSource> getFhirDataSourcesForObjectStore(String dsTypeInfo, String dsDataLocationInfo)\n+            throws Exception {\n+        String nextToken = null;\n+        List<FhirDataSource> fhirDataSources = new ArrayList<>();\n+        // Create a COS/S3 client if it's not created yet.\n+        if (cosClient == null) {\n+            cosClient =\n+                    BulkDataUtils.getCosClient(cosCredentialIbm, cosApiKeyProperty, cosSrvinstId, cosEndpintUrl,\n+                            cosLocation);\n+\n+            if (cosClient == null) {\n+                logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get CosClient!\");\n+                throw new Exception(\"Failed to get CosClient!!\");\n+            } else {\n+                logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get CosClient!\");\n+            }\n+        }\n+        if (cosBucketName == null) {\n+            logger.warning(\"getFhirDataSourcesForObjectStore: Failed to get BucketName!\");\n+            return fhirDataSources;\n+        } else {\n+            logger.finer(\"getFhirDataSourcesForObjectStore: Succeed get BucketName!\");\n+        }\n+        cosBucketName = cosBucketName.toLowerCase();\n+        if (!cosClient.doesBucketExistV2(cosBucketName)) {\n+            logger.warning(\"getFhirDataSourcesForObjectStore: Bucket '\" + cosBucketName + \"' not found!\");\n+            BulkDataUtils.listBuckets(cosClient);\n+            return fhirDataSources;\n+        }\n+\n+        ListObjectsV2Result result = null;\n+        do {\n+            if (result != null) {\n+                nextToken = result.getNextContinuationToken();\n+            }\n+            ListObjectsV2Request request =\n+                    new ListObjectsV2Request().withBucketName(cosBucketName).withMaxKeys(1000)\n+                            .withContinuationToken(nextToken);\n+            result = cosClient.listObjectsV2(request);\n+            for (S3ObjectSummary objectSummary : result.getObjectSummaries()) {\n+                boolean isToBeProccessed = false;\n+                if (dsDataLocationInfo != null && !dsDataLocationInfo.trim().isEmpty()) {\n+                    if (objectSummary.getKey().startsWith(dsDataLocationInfo.trim())) {\n+                        isToBeProccessed = true;\n+                    }\n+                } else {\n+                    isToBeProccessed = true;\n+                }\n+                if (isToBeProccessed) {\n+                    logger.info(\"getFhirDataSourcesForObjectStore: ObjectStorge Object(\" + objectSummary.getKey()\n+                            + \") - \" + objectSummary.getSize() + \" bytes.\");\n+                    if (objectSummary.getSize() > 0) {\n+                        fhirDataSources.add(new FhirDataSource(dsTypeInfo, objectSummary.getKey()));\n+                    }\n+                }\n+            }\n+        } while (result != null && result.isTruncated());\n+\n+        return fhirDataSources;\n+    }\n+\n+    private List<FhirDataSource> getFhirDataSources(JsonArray dataSourceArray, BulkImportDataSourceStorageType type)\n+            throws Exception {\n+        List<FhirDataSource> fhirDataSources = new ArrayList<>();\n+        for (JsonValue jsonValue : dataSourceArray) {\n+            JsonObject dataSourceInfo = jsonValue.asJsonObject();\n+            String dsTypeInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_TYPE);\n+            String dsDataLocationInfo = dataSourceInfo.getString(Constants.IMPORT_INPUT_RESOURCE_URL);\n+\n+            switch (type) {\n+            case HTTPS:\n+            case FILE:\n+                fhirDataSources.add(new FhirDataSource(dsTypeInfo, dsDataLocationInfo));\n+                break;\n+            case AWSS3:\n+            case IBMCOS:\n+                fhirDataSources.addAll(getFhirDataSourcesForObjectStore(dsTypeInfo, dsDataLocationInfo));\n+                break;\n+            default:\n+                break;\n+            }\n+        }\n+\n+        return fhirDataSources;\n+    }\n \n     @Override\n     public PartitionPlan mapPartitions() throws Exception {\n-        JsonReader reader = Json.createReader(new StringReader(\n-                new String(Base64.getDecoder().decode(dataSourcesInfo), StandardCharsets.UTF_8)));\n+        JsonReader reader =\n+                Json.createReader(new StringReader(\n+                        new String(Base64.getDecoder().decode(dataSourcesInfo), StandardCharsets.UTF_8)));\n         JsonArray dataSourceArray = reader.readArray();\n         reader.close();\n \n-        List<FhirDataSource> fhirDataSources = getFhirDataSources(dataSourceArray, BulkImportDataSourceStorageType.from(dataSourceStorageType));\n-\n+        BulkImportDataSourceStorageType dsType = BulkImportDataSourceStorageType.from(dataSourceStorageType);\n+        List<FhirDataSource> fhirDataSources = getFhirDataSources(dataSourceArray, dsType);", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyNjA0MQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411626041", "bodyText": "I split them as I was debugging and needed to log out.  I can move it back", "author": "prb112", "createdAt": "2020-04-20T19:15:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0OTY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc1MDIwNg==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410750206", "bodyText": "the wrapping seems strange to me, I'm not sure what's the correct pattern, but we do need a unified pattern for this.", "author": "albertwang-ibm", "createdAt": "2020-04-18T21:01:24Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/BulkDataConstants.java", "diffHunk": "@@ -23,6 +23,13 @@\n \n     // Import\n     public static final String INPUT_FORMAT = MEDIA_TYPE_ND_JSON;\n+    public static final List<String> INPUT_FORMATS = Collections.unmodifiableList(Arrays.asList(INPUT_FORMAT));\n+    public static final List<String> STORAGE_TYPES =\n+            Collections", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyNjUyNg==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411626526", "bodyText": "it's at 120 Characters. and based on the tab stop", "author": "prb112", "createdAt": "2020-04-20T19:15:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc1MDIwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc1Mjk2OQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410752969", "bodyText": "what's the meaning of import type here? can not find the definition in spec.\nexport has system, group and patient types, not sure if import type is appropriate for import.", "author": "albertwang-ibm", "createdAt": "2020-04-18T21:26:29Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/ImportOperation.java", "diffHunk": "@@ -43,7 +48,31 @@ protected OperationDefinition buildOperationDefinition() {\n     protected Parameters doInvoke(FHIROperationContext operationContext, Class<? extends Resource> resourceType,\n             String logicalId, String versionId, Parameters parameters, FHIRResourceHelpers resourceHelper)\n             throws FHIROperationException {\n-        String jobId = BulkDataUtil.checkAndValidateJob(parameters);\n-        return BulkDataFactory.getTenantInstance().importBulkData(jobId, parameters, operationContext, resourceHelper);\n+        // Checks the Import Type \n+        checkImportType(operationContext.getType());\n+", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMDQwMg==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411630402", "bodyText": "This is strictly the ResourceType.\nIt's checking that it is a valid Resource Type\nIt's checking this... type (string, required) FHIR resource type", "author": "prb112", "createdAt": "2020-04-20T19:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc1Mjk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc1MzQ4MQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410753481", "bodyText": "is checkAndValidateJob the same for both export and import? if yes, not sure it's in BulkDataExportUtil ...", "author": "albertwang-ibm", "createdAt": "2020-04-18T21:31:09Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/StatusOperation.java", "diffHunk": "@@ -51,13 +51,13 @@ protected Parameters doInvoke(FHIROperationContext operationContext, Class<? ext\n             String method = (String) operationContext.getProperty(FHIROperationContext.PROPNAME_METHOD_TYPE);\n             if (\"DELETE\".equalsIgnoreCase(method)) {\n                 // Assume GET or POST\n-                String job = BulkDataUtil.checkAndValidateJob(parameters);\n+                String job = BulkDataExportUtil.checkAndValidateJob(parameters);", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMDg3OQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411630879", "bodyText": "It's in BulkDataExportUtil.  It's the same code in both, I intentionally left the code there. We could always refactor to a general BulkDataUtil", "author": "prb112", "createdAt": "2020-04-20T19:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc1MzQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc1MzU0MQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410753541", "bodyText": "is checkAndValidateJob the same for both export and import? if yes, not sure it's in BulkDataExportUtil ...", "author": "albertwang-ibm", "createdAt": "2020-04-18T21:31:37Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/StatusOperation.java", "diffHunk": "@@ -51,13 +51,13 @@ protected Parameters doInvoke(FHIROperationContext operationContext, Class<? ext\n             String method = (String) operationContext.getProperty(FHIROperationContext.PROPNAME_METHOD_TYPE);\n             if (\"DELETE\".equalsIgnoreCase(method)) {\n                 // Assume GET or POST\n-                String job = BulkDataUtil.checkAndValidateJob(parameters);\n+                String job = BulkDataExportUtil.checkAndValidateJob(parameters);\n                 // For now, we're going to execute the status update, and check. \n                 // If Base, Export Status (Else Invalid)\n                 return BulkDataFactory.getTenantInstance().delete(job, operationContext);\n             } else {\n                 // Assume GET or POST\n-                String job = BulkDataUtil.checkAndValidateJob(parameters);\n+                String job = BulkDataExportUtil.checkAndValidateJob(parameters);", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc1NTU4MQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410755581", "bodyText": "PUT /ibm/api/batch/jobinstances/job instance id?action=stop\nDELETE /ibm/api/batch/jobinstances/job instance id\n(1) always use jobinstanceId instead of jobexecution id to stop or delete a job.\n(2) if the job is running, deleting it directly will fail, so have to stop it first, and the delete it.\nIn the spec, there is no \"stop\" and then continue the stopped job.   so bulkdata delete = javabatch stop + delete.", "author": "albertwang-ibm", "createdAt": "2020-04-18T21:49:32Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/client/BulkDataClient.java", "diffHunk": "@@ -314,17 +319,16 @@ public PollingLocationResponse status(String job) throws Exception {\n     public void delete(String job) throws Exception {\n         // Example: https://localhost:9443/ibm/api/batch/jobexecutions/9", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc1NTU5Mg==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410755592", "bodyText": "we can not delete a running javabatch job, we have to stop it first and then delete it.", "author": "albertwang-ibm", "createdAt": "2020-04-18T21:49:44Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/client/BulkDataClient.java", "diffHunk": "@@ -334,12 +338,14 @@ public void delete(String job) throws Exception {\n             // The tenant is known, and now we need to query to delete the Job.\n             r = target.request().delete();", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc2MDA2NA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410760064", "bodyText": "did some quick tests, and seems the space is added in the request to javabatch. the defensive codes here is good!", "author": "albertwang-ibm", "createdAt": "2020-04-18T22:22:11Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/client/BulkDataClient.java", "diffHunk": "@@ -373,8 +380,11 @@ private PollingLocationResponse process(BulkExportJobExecutionResponse response)\n         String baseCosUrl = properties.get(BulkDataConfigUtil.JOB_PARAMETERS_ENDPOINT);\n         String bucket = properties.get(BulkDataConfigUtil.JOB_PARAMETERS_BUCKET);\n \n-        // Request\n-        String request = \"$export?_type=\" + resourceTypes;\n+        // Request - somewhere along the way a space is injected", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc2MTAwOQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410761009", "bodyText": "just found it's by line 206\nString resourceType = String.join(\", \", types);", "author": "albertwang-ibm", "createdAt": "2020-04-18T22:28:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc2MDA2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjE4OA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r412376188", "bodyText": "Fixed", "author": "prb112", "createdAt": "2020-04-21T18:04:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc2MDA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc2MzAxMQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410763011", "bodyText": "we have to discuss and pass the import results from the javabatch job via exit status of the job.\nit's a little bit more complicated then the export results, for export, the exit status is very simple as in this example:\nPatient[5000,200],Obervation[5000,400], and the detail export details(including urls and counts) are generated in the export operation side.\nFor import, according to the spec, we have to pass much more info from the import job to the operation codes - e.g, we may have to pass the inputUrl and count together, or we will have to use something like a consistent sequence number for the inputUrl to uniquely identify the inputUrl.  we we will also have to pass the url to the error .ndjson for the inputUrl, or at least with a tag to tell that there is error during the import, and operation code can generate the url which aligns with the error ndjson gernated in the job side.\nMaybe a simple pattern like this to pass the import status from the job to operation:\n[5000,0],[6000,30]\nmeans the first inputUrl all imported successfully with total 5000 resources.\nand the second inputUrl imported 6000 resources, but with 30 import failures.", "author": "albertwang-ibm", "createdAt": "2020-04-18T22:40:58Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/client/BulkDataClient.java", "diffHunk": "@@ -404,6 +414,84 @@ private PollingLocationResponse process(BulkExportJobExecutionResponse response)\n             }\n             result.setOutput(outputList);\n         }\n+\n+        if (\"COMPLETED\".contentEquals(exitStatus) && request.contains(\"$import\")) {\n+            // Currently there is no output", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4NDU3NA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410784574", "bodyText": "because this class is used for both import and export, so seems better to rename the class to something like BulkDataJobExecutionResponse?", "author": "albertwang-ibm", "createdAt": "2020-04-19T01:07:45Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/model/BulkExportJobExecutionResponse.java", "diffHunk": "@@ -326,6 +330,16 @@ public BulkExportJobExecutionResponse build() {\n             response.setJobParameters(jobParameter);\n             return response;\n         }\n+", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM2NTUwOQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r412365509", "bodyText": "JobExecutionResponse is now the name.  I renamed all BulkExportJob", "author": "prb112", "createdAt": "2020-04-21T17:49:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4NDU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4NDg5Mg==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410784892", "bodyText": "because this class is used by both import and export, so seems better to change to something like BulkDataJobInstanceRequest?", "author": "albertwang-ibm", "createdAt": "2020-04-19T01:09:57Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/model/BulkExportJobInstanceRequest.java", "diffHunk": "@@ -172,11 +176,20 @@ public Builder fhirTypeFilters(String fhirTypeFilters) {\n             return this;\n         }\n \n+        public Builder fhirDataSourcesInfo(List<Input> inputs) {", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM2NTgyMQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r412365821", "bodyText": "same change", "author": "prb112", "createdAt": "2020-04-21T17:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4NDg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4NTg0OQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410785849", "bodyText": "too many empty lines in this file, better to remove some of them.", "author": "albertwang-ibm", "createdAt": "2020-04-19T01:17:45Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/model/PollingLocationResponse.java", "diffHunk": "@@ -95,47 +117,111 @@ public void setCount(String count) {\n             this.count = count;\n         }\n \n+        public String getInputUrl() {\n+            return inputUrl;\n+        }\n+\n+        public void setInputUrl(String inputUrl) {\n+            this.inputUrl = inputUrl;\n+        }\n+\n         @Override\n         public String toString() {\n-            return \"{ \\\"type\\\" : \\\"\" + type + \"\\\", \\\"url\\\": \\\"\" + url + \"\\\", \\\"count\\\": \" + count + \"}\";\n+            return \"Output [type=\" + type + \", url=\" + url + \", count=\" + count + \", inputUrl=\" + inputUrl + \"]\";\n         }\n \n-    }\n+        /*\n+         * This is an internal only class not intended to be used out of bulkdata.\n+         * The class serializes the Output into a JSON object.\n+         */\n+        public static class Writer {\n+            private Writer() {\n+                // No Operation\n+            }\n \n-    public String toJsonString() {\n-        StringBuilder builder = new StringBuilder();\n-        builder.append(\"{\");\n-        builder.append(\"\\n\");\n+            public static void generate(JsonGenerator generatorOutput, Output output) throws IOException {\n+                generatorOutput.writeStartObject();\n+                if (output.getType() != null) {\n+                    generatorOutput.write(\"type\", output.getType());\n+                }\n \n-        if (transactionTime != null) {\n-            builder.append(\"\\\"transactionTime\\\": \\\"\");\n-            builder.append(getTransactionTime());\n-            builder.append(\"\\\"\");\n-            builder.append(\",\");\n-        }\n+                if (output.getUrl() != null) {\n+                    generatorOutput.write(\"url\", output.getUrl());\n+                }\n \n-        if (request != null) {\n-            builder.append(\"\\\"request\\\": \\\"\");\n-            builder.append(getRequest());\n-            builder.append(\"\\\"\");\n-            builder.append(\",\");\n-        }\n+                if (output.getCount() != null) {\n+                    generatorOutput.write(\"count\", Long.parseLong(output.getCount()));\n+\n+                }\n \n-        if (requiresAccessToken != null) {\n-            builder.append(\"\\\"requiresAccessToken\\\": \");\n-            builder.append(Boolean.toString(getRequiresAccessToken()));\n-            builder.append(\"\");\n-            builder.append(\",\");\n+                if (output.getInputUrl() != null) {\n+                    generatorOutput.write(\"inputUrl\", output.getInputUrl());\n+\n+                }\n+\n+                generatorOutput.writeEnd();\n+            }\n         }\n+    }\n \n-        builder.append(\"\\\"output\\\" : [\");\n-        if (getOutput() != null) {\n-            builder.append(getOutput().stream().map(s -> s.toString()).collect(Collectors.joining(\",\")));\n+    /*\n+     * This is an internal only class not intended to be used out of bulkdata.\n+     * The class serializes the PollingLocationResponse into a JSON object.\n+     */\n+    public static class Writer {\n+        private Writer() {\n+            // No Operation\n         }\n-        builder.append(\"]\");\n \n-        builder.append(\"\\n\");\n-        builder.append(\"}\");\n-        return builder.toString();\n+        public static String generate(PollingLocationResponse response) throws IOException {\n+            Boolean pretty =\n+                    FHIRConfigHelper.getBooleanProperty(FHIRConfiguration.PROPERTY_DEFAULT_PRETTY_PRINT, false);\n+            final Map<java.lang.String, Object> properties =\n+                    Collections.singletonMap(JsonGenerator.PRETTY_PRINTING, pretty);\n+            final JsonGeneratorFactory factory = Json.createGeneratorFactory(properties);\n+\n+            String o = \"{}\";\n+            try (StringWriter writer = new StringWriter();) {\n+                try (JsonGenerator generator = factory.createGenerator(writer);) {\n+\n+                    generator.writeStartObject();\n+                    if (response.getTransactionTime() != null) {\n+                        generator.write(\"transactionTime\", response.getTransactionTime());\n+                    }\n+\n+                    if (response.getRequest() != null) {\n+                        generator.write(\"request\", response.getRequest());\n+                    }\n+\n+                    if (response.getRequiresAccessToken() != null) {\n+                        generator.write(\"requiresAccessToken\", response.getRequiresAccessToken());\n+                    }\n+\n+                    if (response.getOutput() != null) {\n+                        // outputs the output array.\n+                        generator.writeStartArray(\"output\");\n+                        for (Output output : response.getOutput()) {\n+                            Output.Writer.generate(generator, output);\n+                        }\n+                        generator.writeEnd();\n+                    }\n+\n+                    if (response.getError() != null) {\n+                        // outputs the output array.\n+                        generator.writeStartArray(\"error\");\n+                        for (Output output : response.getError()) {\n+                            Output.Writer.generate(generator, output);\n+                        }\n+                        generator.writeEnd();\n+                    }\n+\n+                    generator.writeEnd();\n+\n+                }\n+", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM2NjI4MQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r412366281", "bodyText": "cleaned up", "author": "prb112", "createdAt": "2020-04-21T17:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4NTg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4NzgzOQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410787839", "bodyText": "Interesting and nice FHIRPath usage here!!", "author": "albertwang-ibm", "createdAt": "2020-04-19T01:31:25Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataImportUtil.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package com.ibm.fhir.operation.bulkdata.util;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+\n+import com.ibm.fhir.config.FHIRConfigHelper;\n+import com.ibm.fhir.config.FHIRConfiguration;\n+import com.ibm.fhir.exception.FHIROperationException;\n+import com.ibm.fhir.model.resource.OperationOutcome;\n+import com.ibm.fhir.model.resource.Parameters;\n+import com.ibm.fhir.model.type.code.IssueType;\n+import com.ibm.fhir.model.util.FHIRUtil;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.operation.bulkdata.BulkDataConstants;\n+import com.ibm.fhir.operation.bulkdata.model.type.Input;\n+import com.ibm.fhir.operation.bulkdata.model.type.StorageDetail;\n+import com.ibm.fhir.path.FHIRPathElementNode;\n+import com.ibm.fhir.path.FHIRPathNode;\n+import com.ibm.fhir.path.evaluator.FHIRPathEvaluator;\n+import com.ibm.fhir.path.evaluator.FHIRPathEvaluator.EvaluationContext;\n+import com.ibm.fhir.path.exception.FHIRPathException;\n+\n+/**\n+ * BulkData Import Util captures common methods\n+ */\n+public class BulkDataImportUtil {\n+    private BulkDataImportUtil() {\n+        // No Operation\n+    }\n+\n+    public static FHIROperationException buildExceptionWithIssue(String msg, IssueType issueType)\n+            throws FHIROperationException {\n+        OperationOutcome.Issue ooi = FHIRUtil.buildOperationOutcomeIssue(msg, issueType);\n+        return new FHIROperationException(msg).withIssue(ooi);\n+    }\n+\n+    public static FHIROperationException buildExceptionWithIssue(String msg, Throwable cause, IssueType issueType)\n+            throws FHIROperationException {\n+        OperationOutcome.Issue ooi = FHIRUtil.buildOperationOutcomeIssue(msg, issueType);\n+        return new FHIROperationException(msg, cause).withIssue(ooi);\n+    }\n+\n+    public static String retrieveInputFormat(Parameters parameters) throws FHIROperationException {\n+        // Parameter: inputFormat (required)\n+        // If there are multiple entries, the processing only takes the first entry.\n+        if (parameters != null) {\n+            for (Parameters.Parameter parameter : parameters.getParameter()) {\n+                if (BulkDataConstants.PARAM_INPUT_FORMAT.equals(parameter.getName().getValue())\n+                        && parameter.getValue() != null\n+                        && parameter.getValue().is(com.ibm.fhir.model.type.String.class)) {\n+                    // If the parameter isn't passed, use application/fhir+ndjson\n+                    // Check the MediaType\n+                    String val = parameter.getValue().as(com.ibm.fhir.model.type.String.class).getValue();\n+                    if (BulkDataConstants.INPUT_FORMATS.contains(val)) {\n+                        return val;\n+                    }\n+                }\n+            }\n+        }\n+\n+        throw buildExceptionWithIssue(\"$import requires 'inputFormat' is not found\", IssueType.INVALID);\n+    }\n+\n+    public static String retrieveInputSource(Parameters parameters) throws FHIROperationException {\n+        // Parameter: inputSource (required)\n+        // If there are multiple entries, the processing only takes the first entry.\n+        if (parameters != null) {\n+            for (Parameters.Parameter parameter : parameters.getParameter()) {\n+                if (BulkDataConstants.PARAM_INPUT_SOURCE.equals(parameter.getName().getValue())\n+                        && parameter.getValue() != null && parameter.getValue().is(com.ibm.fhir.model.type.Uri.class)) {\n+                    // If the parameter isn't passed, use application/fhir+ndjson\n+                    return parameter.getValue().as(com.ibm.fhir.model.type.Uri.class).getValue();\n+                }\n+            }\n+        }\n+\n+        throw buildExceptionWithIssue(\"$import requires 'inputSource' is not found\", IssueType.INVALID);\n+    }\n+\n+    public static List<Input> retrieveInputs(Parameters parameters) throws FHIROperationException {\n+        // Parameter: input (required)\n+        List<Input> inputs = new ArrayList<>();\n+\n+        FHIRPathEvaluator evaluator = FHIRPathEvaluator.evaluator();", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4Nzk2MQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410787961", "bodyText": "should we add 5 as a constant?", "author": "albertwang-ibm", "createdAt": "2020-04-19T01:32:37Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataImportUtil.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package com.ibm.fhir.operation.bulkdata.util;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+\n+import com.ibm.fhir.config.FHIRConfigHelper;\n+import com.ibm.fhir.config.FHIRConfiguration;\n+import com.ibm.fhir.exception.FHIROperationException;\n+import com.ibm.fhir.model.resource.OperationOutcome;\n+import com.ibm.fhir.model.resource.Parameters;\n+import com.ibm.fhir.model.type.code.IssueType;\n+import com.ibm.fhir.model.util.FHIRUtil;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.operation.bulkdata.BulkDataConstants;\n+import com.ibm.fhir.operation.bulkdata.model.type.Input;\n+import com.ibm.fhir.operation.bulkdata.model.type.StorageDetail;\n+import com.ibm.fhir.path.FHIRPathElementNode;\n+import com.ibm.fhir.path.FHIRPathNode;\n+import com.ibm.fhir.path.evaluator.FHIRPathEvaluator;\n+import com.ibm.fhir.path.evaluator.FHIRPathEvaluator.EvaluationContext;\n+import com.ibm.fhir.path.exception.FHIRPathException;\n+\n+/**\n+ * BulkData Import Util captures common methods\n+ */\n+public class BulkDataImportUtil {\n+    private BulkDataImportUtil() {\n+        // No Operation\n+    }\n+\n+    public static FHIROperationException buildExceptionWithIssue(String msg, IssueType issueType)\n+            throws FHIROperationException {\n+        OperationOutcome.Issue ooi = FHIRUtil.buildOperationOutcomeIssue(msg, issueType);\n+        return new FHIROperationException(msg).withIssue(ooi);\n+    }\n+\n+    public static FHIROperationException buildExceptionWithIssue(String msg, Throwable cause, IssueType issueType)\n+            throws FHIROperationException {\n+        OperationOutcome.Issue ooi = FHIRUtil.buildOperationOutcomeIssue(msg, issueType);\n+        return new FHIROperationException(msg, cause).withIssue(ooi);\n+    }\n+\n+    public static String retrieveInputFormat(Parameters parameters) throws FHIROperationException {\n+        // Parameter: inputFormat (required)\n+        // If there are multiple entries, the processing only takes the first entry.\n+        if (parameters != null) {\n+            for (Parameters.Parameter parameter : parameters.getParameter()) {\n+                if (BulkDataConstants.PARAM_INPUT_FORMAT.equals(parameter.getName().getValue())\n+                        && parameter.getValue() != null\n+                        && parameter.getValue().is(com.ibm.fhir.model.type.String.class)) {\n+                    // If the parameter isn't passed, use application/fhir+ndjson\n+                    // Check the MediaType\n+                    String val = parameter.getValue().as(com.ibm.fhir.model.type.String.class).getValue();\n+                    if (BulkDataConstants.INPUT_FORMATS.contains(val)) {\n+                        return val;\n+                    }\n+                }\n+            }\n+        }\n+\n+        throw buildExceptionWithIssue(\"$import requires 'inputFormat' is not found\", IssueType.INVALID);\n+    }\n+\n+    public static String retrieveInputSource(Parameters parameters) throws FHIROperationException {\n+        // Parameter: inputSource (required)\n+        // If there are multiple entries, the processing only takes the first entry.\n+        if (parameters != null) {\n+            for (Parameters.Parameter parameter : parameters.getParameter()) {\n+                if (BulkDataConstants.PARAM_INPUT_SOURCE.equals(parameter.getName().getValue())\n+                        && parameter.getValue() != null && parameter.getValue().is(com.ibm.fhir.model.type.Uri.class)) {\n+                    // If the parameter isn't passed, use application/fhir+ndjson\n+                    return parameter.getValue().as(com.ibm.fhir.model.type.Uri.class).getValue();\n+                }\n+            }\n+        }\n+\n+        throw buildExceptionWithIssue(\"$import requires 'inputSource' is not found\", IssueType.INVALID);\n+    }\n+\n+    public static List<Input> retrieveInputs(Parameters parameters) throws FHIROperationException {\n+        // Parameter: input (required)\n+        List<Input> inputs = new ArrayList<>();\n+\n+        FHIRPathEvaluator evaluator = FHIRPathEvaluator.evaluator();\n+        EvaluationContext evaluationContext = new EvaluationContext(parameters);\n+\n+        try {\n+            Collection<FHIRPathNode> result = evaluator.evaluate(evaluationContext, \"parameter.where(name = 'input')\");\n+\n+            Iterator<FHIRPathNode> iter = result.iterator();\n+            while (iter.hasNext()) {\n+                FHIRPathElementNode node = (FHIRPathElementNode) iter.next();\n+\n+                // Resource Types extracted and Type is verified.\n+                EvaluationContext evaluationContextPartType = new EvaluationContext(node.element());\n+                Collection<FHIRPathNode> resultPartType =\n+                        evaluator.evaluate(evaluationContextPartType, \"part.where(name = 'type').value\");\n+                String type =\n+                        ((FHIRPathElementNode) resultPartType.iterator().next()).element()\n+                                .as(com.ibm.fhir.model.type.String.class).getValue();\n+\n+                // Checks if not valid, and throws exception\n+                if (!ModelSupport.isResourceType(type)) {\n+                    throw buildExceptionWithIssue(\"$import invalid Resource Type 'input'\", IssueType.INVALID);\n+                }\n+\n+                // Resource URL extracted.\n+                EvaluationContext evaluationContextPartUrl = new EvaluationContext(node.element());\n+                Collection<FHIRPathNode> resultPartUrl =\n+                        evaluator.evaluate(evaluationContextPartUrl, \"part.where(name = 'url').value\");\n+                String url =\n+                        ((FHIRPathElementNode) resultPartUrl.iterator().next()).element()\n+                                .as(com.ibm.fhir.model.type.Url.class).getValue();\n+\n+                // Verify Url is allowed\n+                verifyUrlAllowed(url);\n+\n+                // Add to the Inputs List\n+                inputs.add(new Input(type, url));\n+            }\n+        } catch (FHIRPathException e) {\n+            throw buildExceptionWithIssue(\"$import invalid parameters with expression in 'input'\", e,\n+                    IssueType.INVALID);\n+        }\n+\n+        if (inputs.isEmpty()) {\n+            throw buildExceptionWithIssue(\"$import requires 'input' is not found\", IssueType.INVALID);\n+        }\n+\n+        checkAllowedTotalSizeForTenantOrSystem(inputs.size());\n+        return inputs;\n+    }\n+\n+    /**\n+     * check the allowed total size for tenant and system\n+     * \n+     * @param inputSize\n+     * @throws FHIROperationException\n+     */\n+    public static void checkAllowedTotalSizeForTenantOrSystem(Integer inputSize) throws FHIROperationException {\n+        Integer tenantCount =\n+                FHIRConfigHelper.getIntProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_MAX_INPUT_PER_TENANT, 5);", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM2NjU3MA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r412366570", "bodyText": "Yes, adding now", "author": "prb112", "createdAt": "2020-04-21T17:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4Nzk2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4ODk1NA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410788954", "bodyText": "this means e.g, for https input url, user will have to change server config to add the BaseUrl for it first, maybe better to make the check to be configurable, like by default enable, but user can choose to disable the check.", "author": "albertwang-ibm", "createdAt": "2020-04-19T01:39:20Z", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataImportUtil.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package com.ibm.fhir.operation.bulkdata.util;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+\n+import com.ibm.fhir.config.FHIRConfigHelper;\n+import com.ibm.fhir.config.FHIRConfiguration;\n+import com.ibm.fhir.exception.FHIROperationException;\n+import com.ibm.fhir.model.resource.OperationOutcome;\n+import com.ibm.fhir.model.resource.Parameters;\n+import com.ibm.fhir.model.type.code.IssueType;\n+import com.ibm.fhir.model.util.FHIRUtil;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.operation.bulkdata.BulkDataConstants;\n+import com.ibm.fhir.operation.bulkdata.model.type.Input;\n+import com.ibm.fhir.operation.bulkdata.model.type.StorageDetail;\n+import com.ibm.fhir.path.FHIRPathElementNode;\n+import com.ibm.fhir.path.FHIRPathNode;\n+import com.ibm.fhir.path.evaluator.FHIRPathEvaluator;\n+import com.ibm.fhir.path.evaluator.FHIRPathEvaluator.EvaluationContext;\n+import com.ibm.fhir.path.exception.FHIRPathException;\n+\n+/**\n+ * BulkData Import Util captures common methods\n+ */\n+public class BulkDataImportUtil {\n+    private BulkDataImportUtil() {\n+        // No Operation\n+    }\n+\n+    public static FHIROperationException buildExceptionWithIssue(String msg, IssueType issueType)\n+            throws FHIROperationException {\n+        OperationOutcome.Issue ooi = FHIRUtil.buildOperationOutcomeIssue(msg, issueType);\n+        return new FHIROperationException(msg).withIssue(ooi);\n+    }\n+\n+    public static FHIROperationException buildExceptionWithIssue(String msg, Throwable cause, IssueType issueType)\n+            throws FHIROperationException {\n+        OperationOutcome.Issue ooi = FHIRUtil.buildOperationOutcomeIssue(msg, issueType);\n+        return new FHIROperationException(msg, cause).withIssue(ooi);\n+    }\n+\n+    public static String retrieveInputFormat(Parameters parameters) throws FHIROperationException {\n+        // Parameter: inputFormat (required)\n+        // If there are multiple entries, the processing only takes the first entry.\n+        if (parameters != null) {\n+            for (Parameters.Parameter parameter : parameters.getParameter()) {\n+                if (BulkDataConstants.PARAM_INPUT_FORMAT.equals(parameter.getName().getValue())\n+                        && parameter.getValue() != null\n+                        && parameter.getValue().is(com.ibm.fhir.model.type.String.class)) {\n+                    // If the parameter isn't passed, use application/fhir+ndjson\n+                    // Check the MediaType\n+                    String val = parameter.getValue().as(com.ibm.fhir.model.type.String.class).getValue();\n+                    if (BulkDataConstants.INPUT_FORMATS.contains(val)) {\n+                        return val;\n+                    }\n+                }\n+            }\n+        }\n+\n+        throw buildExceptionWithIssue(\"$import requires 'inputFormat' is not found\", IssueType.INVALID);\n+    }\n+\n+    public static String retrieveInputSource(Parameters parameters) throws FHIROperationException {\n+        // Parameter: inputSource (required)\n+        // If there are multiple entries, the processing only takes the first entry.\n+        if (parameters != null) {\n+            for (Parameters.Parameter parameter : parameters.getParameter()) {\n+                if (BulkDataConstants.PARAM_INPUT_SOURCE.equals(parameter.getName().getValue())\n+                        && parameter.getValue() != null && parameter.getValue().is(com.ibm.fhir.model.type.Uri.class)) {\n+                    // If the parameter isn't passed, use application/fhir+ndjson\n+                    return parameter.getValue().as(com.ibm.fhir.model.type.Uri.class).getValue();\n+                }\n+            }\n+        }\n+\n+        throw buildExceptionWithIssue(\"$import requires 'inputSource' is not found\", IssueType.INVALID);\n+    }\n+\n+    public static List<Input> retrieveInputs(Parameters parameters) throws FHIROperationException {\n+        // Parameter: input (required)\n+        List<Input> inputs = new ArrayList<>();\n+\n+        FHIRPathEvaluator evaluator = FHIRPathEvaluator.evaluator();\n+        EvaluationContext evaluationContext = new EvaluationContext(parameters);\n+\n+        try {\n+            Collection<FHIRPathNode> result = evaluator.evaluate(evaluationContext, \"parameter.where(name = 'input')\");\n+\n+            Iterator<FHIRPathNode> iter = result.iterator();\n+            while (iter.hasNext()) {\n+                FHIRPathElementNode node = (FHIRPathElementNode) iter.next();\n+\n+                // Resource Types extracted and Type is verified.\n+                EvaluationContext evaluationContextPartType = new EvaluationContext(node.element());\n+                Collection<FHIRPathNode> resultPartType =\n+                        evaluator.evaluate(evaluationContextPartType, \"part.where(name = 'type').value\");\n+                String type =\n+                        ((FHIRPathElementNode) resultPartType.iterator().next()).element()\n+                                .as(com.ibm.fhir.model.type.String.class).getValue();\n+\n+                // Checks if not valid, and throws exception\n+                if (!ModelSupport.isResourceType(type)) {\n+                    throw buildExceptionWithIssue(\"$import invalid Resource Type 'input'\", IssueType.INVALID);\n+                }\n+\n+                // Resource URL extracted.\n+                EvaluationContext evaluationContextPartUrl = new EvaluationContext(node.element());\n+                Collection<FHIRPathNode> resultPartUrl =\n+                        evaluator.evaluate(evaluationContextPartUrl, \"part.where(name = 'url').value\");\n+                String url =\n+                        ((FHIRPathElementNode) resultPartUrl.iterator().next()).element()\n+                                .as(com.ibm.fhir.model.type.Url.class).getValue();\n+\n+                // Verify Url is allowed\n+                verifyUrlAllowed(url);\n+\n+                // Add to the Inputs List\n+                inputs.add(new Input(type, url));\n+            }\n+        } catch (FHIRPathException e) {\n+            throw buildExceptionWithIssue(\"$import invalid parameters with expression in 'input'\", e,\n+                    IssueType.INVALID);\n+        }\n+\n+        if (inputs.isEmpty()) {\n+            throw buildExceptionWithIssue(\"$import requires 'input' is not found\", IssueType.INVALID);\n+        }\n+\n+        checkAllowedTotalSizeForTenantOrSystem(inputs.size());\n+        return inputs;\n+    }\n+\n+    /**\n+     * check the allowed total size for tenant and system\n+     * \n+     * @param inputSize\n+     * @throws FHIROperationException\n+     */\n+    public static void checkAllowedTotalSizeForTenantOrSystem(Integer inputSize) throws FHIROperationException {\n+        Integer tenantCount =\n+                FHIRConfigHelper.getIntProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_MAX_INPUT_PER_TENANT, 5);\n+        if (tenantCount == null || tenantCount < inputSize) {\n+            throw buildExceptionWithIssue(\n+                    \"$import maximum input per bulkdata import request 'fhirServer/bulkdata/maxInputPerRequest'\",\n+                    IssueType.INVALID);\n+        }\n+    }\n+\n+    /**\n+     * verify url is allowed\n+     * \n+     * @param url\n+     * @throws FHIROperationException\n+     */\n+    public static void verifyUrlAllowed(String url) throws FHIROperationException {\n+        List<String> baseUrls =", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM2ODQyOA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r412368428", "bodyText": "I don't think this is a good defensive practice.  best to have them enter", "author": "prb112", "createdAt": "2020-04-21T17:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4ODk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MTAxMg==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410791012", "bodyText": "The contentEncoding parameter for https storageDetail in the Spec is a little bit strange for me, because per my understanding, this contentencoding info should be in the response header when accessing the https url, so seems doesn't make too much sense to add it to the storageDetail.\nMaybe reasonable for other storage types which don't have such build-in contentencoding info...", "author": "albertwang-ibm", "createdAt": "2020-04-19T01:53:33Z", "path": "fhir-operation-bulkdata/src/test/java/com/ibm/fhir/operation/support/bulkdata/helpers/ImportOperationParametersGenerator.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.operation.support.bulkdata.helpers;\n+\n+import static com.ibm.fhir.model.type.String.string;\n+\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.UUID;\n+\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Parameters;\n+import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.type.Uri;\n+import com.ibm.fhir.model.type.Url;\n+\n+/**\n+ * \n+ */\n+public class ImportOperationParametersGenerator {\n+\n+    public ImportOperationParametersGenerator() {\n+        // No Operation\n+    }\n+\n+    public Parameters generateParameters(String inputFormat, String inputSource, String type, String url,\n+            String storageType)\n+            throws FHIRGeneratorException, IOException {\n+        List<Parameter> parameters = new ArrayList<>();\n+\n+        // Required: inputFormat\n+        parameters.add(Parameter.builder().name(string(\"inputFormat\")).value(string(inputFormat)).build());\n+\n+        // Required: inputSource - where it came from. \n+        parameters.add(Parameter.builder().name(string(\"inputSource\")).value(Uri.uri(inputSource)).build());\n+\n+        // Required: Input Values\n+        Parameter part1 = Parameter.builder().name(string(\"type\")).value(string(type)).build();\n+        Parameter part2 = Parameter.builder().name(string(\"url\")).value(Url.of(url)).build();\n+\n+        // Required: Input\n+        Parameter inputParameter =\n+                Parameter.builder().name(string(\"input\")).part(part1, part2)\n+                        .build();\n+        parameters.add(inputParameter);\n+\n+        inputParameter =\n+                Parameter.builder().name(string(\"input\")).part(part1, part2)\n+                        .build();\n+        parameters.add(inputParameter);\n+\n+        // Optional: Storage Detail\n+        Parameter part5 =\n+                Parameter.builder().name(string(\"contentEncoding\")).value(string(\"gzip\")).build();", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MTI4NA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410791284", "bodyText": "nice and cool generator!", "author": "albertwang-ibm", "createdAt": "2020-04-19T01:56:12Z", "path": "fhir-operation-bulkdata/src/test/java/com/ibm/fhir/operation/support/bulkdata/helpers/ImportOperationDefinitionGenerator.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.operation.support.bulkdata.helpers;\n+\n+import static com.ibm.fhir.model.type.String.string;\n+import static org.testng.Assert.fail;\n+\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.OperationDefinition;\n+import com.ibm.fhir.model.resource.OperationDefinition.Parameter;\n+import com.ibm.fhir.model.type.Code;\n+import com.ibm.fhir.model.type.ContactDetail;\n+import com.ibm.fhir.model.type.ContactPoint;\n+import com.ibm.fhir.model.type.Markdown;\n+import com.ibm.fhir.model.type.Narrative;\n+import com.ibm.fhir.model.type.Uri;\n+import com.ibm.fhir.model.type.Xhtml;\n+import com.ibm.fhir.model.type.code.ContactPointSystem;\n+import com.ibm.fhir.model.type.code.FHIRAllTypes;\n+import com.ibm.fhir.model.type.code.NarrativeStatus;\n+import com.ibm.fhir.model.type.code.OperationKind;\n+import com.ibm.fhir.model.type.code.OperationParameterUse;\n+import com.ibm.fhir.model.type.code.PublicationStatus;\n+\n+/**\n+ * ImportOperationDefGeneratorMain is used to generate the OperationDefinition for the BulkData Import Operation.\n+ */\n+public class ImportOperationDefinitionGenerator {", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MjY5OA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410792698", "bodyText": "too many spaces", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:06:23Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -188,11 +199,11 @@ public void testCreate2Patients() throws Exception {\n         savedPatientId = getLocationLogicalId(response);\n \n         // Next, call the 'read' API to retrieve the new patient and verify it.\n-        response = target.path(\"Patient/\" + savedPatientId).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();\n+        response       = target.path(\"Patient/\" + savedPatientId).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5Mjc1MQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410792751", "bodyText": "one unneeded space", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:07:03Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -188,11 +199,11 @@ public void testCreate2Patients() throws Exception {\n         savedPatientId = getLocationLogicalId(response);\n \n         // Next, call the 'read' API to retrieve the new patient and verify it.\n-        response = target.path(\"Patient/\" + savedPatientId).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();\n+        response       = target.path(\"Patient/\" + savedPatientId).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();\n         assertResponse(response, Response.Status.OK.getStatusCode());\n \n         // Create 2nd Patient.\n-        entity = Entity.entity(patient, FHIRMediaType.APPLICATION_FHIR_JSON);\n+        entity   = Entity.entity(patient, FHIRMediaType.APPLICATION_FHIR_JSON);", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5Mjc4NA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410792784", "bodyText": "too many spaces...", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:07:20Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -204,12 +215,12 @@ public void testCreate2Patients() throws Exception {\n         savedPatientId2 = getLocationLogicalId(response);\n \n         // Next, call the 'read' API to retrieve the new patient and verify it.\n-        response = target.path(\"Patient/\" + savedPatientId2).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();\n+        response        = target.path(\"Patient/\" + savedPatientId2).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5Mjg1Nw==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410792857", "bodyText": "unneeded spaces", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:07:52Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -250,7 +261,7 @@ public void testGroup() throws Exception {\n         savedGroupId = getLocationLogicalId(response);\n \n         // Next, call the 'read' API to retrieve the new group and verify it.\n-        response = target.path(\"Group/\" + savedGroupId).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();\n+        response     = target.path(\"Group/\" + savedGroupId).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MjkwNA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410792904", "bodyText": "space", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:08:10Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -259,16 +270,18 @@ public void testGroup() throws Exception {\n         // (2) Build a new Group with patient2 and the above group only as members.\n         ArrayList<Member> members = new ArrayList<>();\n         group = group.toBuilder().member(members).build();\n-        Member member = Member.builder().entity(Reference.builder()\n-                .reference(com.ibm.fhir.model.type.String.of(\"Patient/\" + savedPatientId2)).build())\n-                .build();\n+        Member member =\n+                Member.builder()\n+                        .entity(Reference.builder()\n+                                .reference(com.ibm.fhir.model.type.String.of(\"Patient/\" + savedPatientId2)).build())\n+                        .build();\n         members.add(member);\n-        member = Member.builder().entity(Reference.builder()\n-                .reference(com.ibm.fhir.model.type.String.of(\"Group/\" + savedGroupId)).build())\n-                .build();\n+        member =\n+                Member.builder().entity(Reference.builder()\n+                        .reference(com.ibm.fhir.model.type.String.of(\"Group/\" + savedGroupId)).build()).build();\n         members.add(member);\n-        group = group.toBuilder().member(members).build();\n-        entity = Entity.entity(group, FHIRMediaType.APPLICATION_FHIR_JSON);\n+        group    = group.toBuilder().member(members).build();", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MjkxOQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410792919", "bodyText": "space", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:08:17Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -259,16 +270,18 @@ public void testGroup() throws Exception {\n         // (2) Build a new Group with patient2 and the above group only as members.\n         ArrayList<Member> members = new ArrayList<>();\n         group = group.toBuilder().member(members).build();\n-        Member member = Member.builder().entity(Reference.builder()\n-                .reference(com.ibm.fhir.model.type.String.of(\"Patient/\" + savedPatientId2)).build())\n-                .build();\n+        Member member =\n+                Member.builder()\n+                        .entity(Reference.builder()\n+                                .reference(com.ibm.fhir.model.type.String.of(\"Patient/\" + savedPatientId2)).build())\n+                        .build();\n         members.add(member);\n-        member = Member.builder().entity(Reference.builder()\n-                .reference(com.ibm.fhir.model.type.String.of(\"Group/\" + savedGroupId)).build())\n-                .build();\n+        member =\n+                Member.builder().entity(Reference.builder()\n+                        .reference(com.ibm.fhir.model.type.String.of(\"Group/\" + savedGroupId)).build()).build();\n         members.add(member);\n-        group = group.toBuilder().member(members).build();\n-        entity = Entity.entity(group, FHIRMediaType.APPLICATION_FHIR_JSON);\n+        group    = group.toBuilder().member(members).build();\n+        entity   = Entity.entity(group, FHIRMediaType.APPLICATION_FHIR_JSON);", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MjkyMw==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410792923", "bodyText": "space", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:08:24Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -280,26 +293,30 @@ public void testGroup() throws Exception {\n         savedGroupId2 = getLocationLogicalId(response);\n \n         // Next, call the 'read' API to retrieve the new group and verify it.\n-        response = target.path(\"Group/\" + savedGroupId2).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();\n+        response      = target.path(\"Group/\" + savedGroupId2).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyNzU2OQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411627569", "bodyText": "fixed, I was playing with save and alignment", "author": "prb112", "createdAt": "2020-04-20T19:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MjkyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MjkzNw==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410792937", "bodyText": "space", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:08:35Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -280,26 +293,30 @@ public void testGroup() throws Exception {\n         savedGroupId2 = getLocationLogicalId(response);\n \n         // Next, call the 'read' API to retrieve the new group and verify it.\n-        response = target.path(\"Group/\" + savedGroupId2).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();\n+        response      = target.path(\"Group/\" + savedGroupId2).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();\n         assertResponse(response, Response.Status.OK.getStatusCode());\n         responseGroup = response.readEntity(Group.class);\n         assertNotNull(responseGroup);\n         assertTrue(responseGroup.getMember().size() == 2);\n \n         // (3) Modify the first group to contain the second group and patient1 only, this creates a circle reference situation.\n         members.clear();\n-        member = Member.builder().entity(Reference.builder()\n-                .reference(com.ibm.fhir.model.type.String.of(\"Patient/\" + savedPatientId)).build())\n-                .build();\n+        member =\n+                Member.builder()\n+                        .entity(Reference.builder()\n+                                .reference(com.ibm.fhir.model.type.String.of(\"Patient/\" + savedPatientId)).build())\n+                        .build();\n         members.add(member);\n-        member = Member.builder().entity(Reference.builder()\n-                .reference(com.ibm.fhir.model.type.String.of(\"Group/\" + savedGroupId2)).build())\n-                .build();\n+        member =\n+                Member.builder()\n+                        .entity(Reference.builder()\n+                                .reference(com.ibm.fhir.model.type.String.of(\"Group/\" + savedGroupId2)).build())\n+                        .build();\n         members.add(member);\n-        group = group.toBuilder().id(savedGroupId).member(members).build();\n+        group    = group.toBuilder().id(savedGroupId).member(members).build();", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODQyMQ==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411628421", "bodyText": "fixed, I was playing with save and alignment", "author": "prb112", "createdAt": "2020-04-20T19:18:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MjkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5Mjk3NA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410792974", "bodyText": "space", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:08:43Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -280,26 +293,30 @@ public void testGroup() throws Exception {\n         savedGroupId2 = getLocationLogicalId(response);\n \n         // Next, call the 'read' API to retrieve the new group and verify it.\n-        response = target.path(\"Group/\" + savedGroupId2).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();\n+        response      = target.path(\"Group/\" + savedGroupId2).request(FHIRMediaType.APPLICATION_FHIR_JSON).get();\n         assertResponse(response, Response.Status.OK.getStatusCode());\n         responseGroup = response.readEntity(Group.class);\n         assertNotNull(responseGroup);\n         assertTrue(responseGroup.getMember().size() == 2);\n \n         // (3) Modify the first group to contain the second group and patient1 only, this creates a circle reference situation.\n         members.clear();\n-        member = Member.builder().entity(Reference.builder()\n-                .reference(com.ibm.fhir.model.type.String.of(\"Patient/\" + savedPatientId)).build())\n-                .build();\n+        member =\n+                Member.builder()\n+                        .entity(Reference.builder()\n+                                .reference(com.ibm.fhir.model.type.String.of(\"Patient/\" + savedPatientId)).build())\n+                        .build();\n         members.add(member);\n-        member = Member.builder().entity(Reference.builder()\n-                .reference(com.ibm.fhir.model.type.String.of(\"Group/\" + savedGroupId2)).build())\n-                .build();\n+        member =\n+                Member.builder()\n+                        .entity(Reference.builder()\n+                                .reference(com.ibm.fhir.model.type.String.of(\"Group/\" + savedGroupId2)).build())\n+                        .build();\n         members.add(member);\n-        group = group.toBuilder().id(savedGroupId).member(members).build();\n+        group    = group.toBuilder().id(savedGroupId).member(members).build();\n \n         // Update the patient and verify the response.\n-        entity = Entity.entity(group, FHIRMediaType.APPLICATION_FHIR_JSON);\n+        entity   = Entity.entity(group, FHIRMediaType.APPLICATION_FHIR_JSON);", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyNzY1NA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411627654", "bodyText": "fixed, I was playing with save and alignment", "author": "prb112", "createdAt": "2020-04-20T19:17:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5Mjk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MzEzMA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410793130", "bodyText": "overall, seems there are many unneeded spaces before \"=\" ...", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:09:45Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -366,42 +385,44 @@ public void testGroupExport() throws Exception {\n     private void checkGroupExportStatus() throws InterruptedException {\n         Response response;\n         do {\n-            response =\n-                doGet(exportStatusUrl, FHIRMediaType.APPLICATION_FHIR_JSON);\n+            response = doGet(exportStatusUrl, FHIRMediaType.APPLICATION_FHIR_JSON);\n             // 202 accept means the request is still under processing\n             // 200 mean export is finished\n-            assertTrue(response.getStatus() == 200 || response.getStatus() == 202);\n+            assertTrue(response.getStatus() == Response.Status.OK.getStatusCode()\n+                    || response.getStatus() == Response.Status.ACCEPTED.getStatusCode());\n             Thread.sleep(5000);\n-        } while (response.getStatus() == 202);\n+        } while (response.getStatus() == Response.Status.ACCEPTED.getStatusCode());\n \n-        assertEquals(response.getStatus(), 200);\n+        assertEquals(response.getStatus(), Response.Status.OK.getStatusCode());\n         // Export finished successfully, we should be about to find the \"output\" part in the message body\n         // which includes all the COS objects download urls.\n         String body = response.readEntity(String.class);\n         assertTrue(body.contains(\"output\"));\n         // Find and try the first download link\n-        String downloadUrl = body.substring(body.lastIndexOf(\"\\\"output\\\" :\"));\n+        String downloadUrl = body.substring(body.lastIndexOf(\"\\\"output\\\":\"));\n         int endIndex = downloadUrl.indexOf(\".ndjson\") + 7;\n         downloadUrl = downloadUrl.substring(downloadUrl.indexOf(\"https\"), endIndex);\n-        System.out.println(\"downloadUrl = \" + downloadUrl);\n+        if (DEBUG) {\n+            System.out.println(\"downloadUrl = \" + downloadUrl);\n+        }\n         WebTarget client = ClientBuilder.newClient().target(downloadUrl);\n         response = client.request().get(Response.class);\n-        assertEquals(response.getStatus(), 200);\n+        assertEquals(response.getStatus(), Response.Status.OK.getStatusCode());\n         // Verify to make sure there are Groups, Condition and Observation in the output\n         // (1) Verify that there is one condition exported\n         assertTrue(body.contains(\"Condition_1.ndjson\"));\n         String conditionStr = body.substring(body.lastIndexOf(\"Condition_1.ndjson\"));\n         conditionStr = conditionStr.substring(0, conditionStr.indexOf(\"}\") + 1);\n-        assertTrue(conditionStr.contains(\"\\\"count\\\": 1}\"));\n+        assertTrue(conditionStr.contains(\"\\\"count\\\": 1\"));\n         // (2) Verify that there is one observation exported\n         assertTrue(body.contains(\"Observation_1.ndjson\"));\n         String observationStr = body.substring(body.lastIndexOf(\"Observation_1.ndjson\"));\n         observationStr = observationStr.substring(0, observationStr.indexOf(\"}\") + 1);\n-        assertTrue(observationStr.contains(\"\\\"count\\\": 1}\"));\n+        assertTrue(observationStr.contains(\"\\\"count\\\": 1\"));\n         // (3) Verify that there are 2 groups exported\n         assertTrue(body.contains(\"Group_1.ndjson\"));\n         String groupStr = body.substring(body.lastIndexOf(\"Group_1.ndjson\"));\n         groupStr = groupStr.substring(0, groupStr.indexOf(\"}\") + 1);\n-        assertTrue(groupStr.contains(\"\\\"count\\\": 2}\"));\n+        assertTrue(groupStr.contains(\"\\\"count\\\": 2\"));\n     }\n-}\n+}", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODEzNA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411628134", "bodyText": "fixed, I was playing with save and alignment", "author": "prb112", "createdAt": "2020-04-20T19:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MzEzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MzI0MA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r410793240", "bodyText": "space", "author": "albertwang-ibm", "createdAt": "2020-04-19T02:10:42Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ImportOperationTest.java", "diffHunk": "@@ -0,0 +1,246 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.server.test;\n+\n+import static com.ibm.fhir.model.type.String.string;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertTrue;\n+import static org.testng.Assert.fail;\n+\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.client.Entity;\n+import javax.ws.rs.client.WebTarget;\n+import javax.ws.rs.core.Response;\n+\n+import org.testng.annotations.Test;\n+\n+import com.ibm.fhir.core.FHIRMediaType;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Parameters;\n+import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n+import com.ibm.fhir.model.type.HumanName;\n+import com.ibm.fhir.model.type.Uri;\n+import com.ibm.fhir.model.type.Url;\n+\n+/**\n+ * These tests exercise the $import operation a bulkdata proposal\n+ * \n+ * <pre>\n+ * curl -k -X POST -u \"fhiruser:change-password\" -H 'Content-Type: application/fhir+json' 'https://localhost:9443/fhir-server/api/v4/$import' -d '{\n+    \"resourceType\": \"Parameters\",\n+    \"id\": \"30321130-5032-49fb-be54-9b8b82b2445a\",\n+    \"parameter\": [\n+        {\n+            \"name\": \"inputFormat\",\n+            \"valueString\": \"application/fhir+ndjson\"\n+        },\n+        {\n+            \"name\": \"inputSource\",\n+            \"valueUri\": \"https://localhost:9443/source-fhir-server\"\n+        },\n+        {\n+            \"name\": \"input\",\n+            \"part\": [\n+                {\n+                    \"name\": \"type\",\n+                    \"valueString\": \"Patient\"\n+                },\n+                {\n+                    \"name\": \"url\",\n+                    \"valueUrl\": \"test-import.ndjson\"\n+                }\n+            ]\n+        },\n+        {\n+            \"name\": \"storageDetail\",\n+            \"valueString\": \"ibm-cos\"\n+        }\n+    ]\n+}'\n+\n+grab content-location\n+\n+curl 'https://localhost:9443/fhir-server/api/v4/$bulkdata-status?job=FvHrLGPv0oKZNyLzBnY5iA%3D%3D' -k -u \"fhiruser:change-password\" -v\n+ * </pre>\n+ */\n+public class ImportOperationTest extends FHIRServerTestBase {\n+    // Test Specific\n+    public static final String TEST_GROUP_NAME = \"import-operation\";\n+    public static final boolean ON = true;\n+    public static final boolean DEBUG = false;\n+\n+    // URLs to call against the instance\n+    public static final String BASE_VALID_URL = \"/$import\";\n+    public static final String BASE_VALID_STATUS_URL = \"/$bulkdata-status\";\n+    public static final String FORMAT = \"application/fhir+ndjson\";\n+\n+    private Parameters generateParameters(String inputFormat, String inputSource, String resourceType, String url)\n+            throws FHIRGeneratorException, IOException {\n+        List<Parameter> parameters = new ArrayList<>();\n+\n+        // Required: inputFormat\n+        parameters.add(Parameter.builder().name(string(\"inputFormat\")).value(string(inputFormat)).build());\n+\n+        // Required: inputSource - where it came from. \n+        parameters.add(Parameter.builder().name(string(\"inputSource\")).value(Uri.uri(inputSource)).build());\n+\n+        // Required: Input Values\n+        Parameter part1 = Parameter.builder().name(string(\"type\")).value(string(resourceType)).build();\n+        Parameter part2 = Parameter.builder().name(string(\"url\")).value(Url.of(url)).build();\n+\n+        // Required: Input (relative to bucket)\n+        Parameter inputParameter = Parameter.builder().name(string(\"input\")).part(part1, part2).build();\n+        parameters.add(inputParameter);\n+\n+        // Optional: Storage Detail\n+        Parameter storageDetailParameter =\n+                Parameter.builder().name(string(\"storageDetail\")).value(string(\"ibm-cos\")).build();\n+        parameters.add(storageDetailParameter);\n+\n+        Parameters.Builder builder = Parameters.builder();\n+        builder.id(UUID.randomUUID().toString());\n+        builder.parameter(parameters);\n+        Parameters ps = builder.build();\n+\n+        try (StringWriter writer = new StringWriter();) {\n+            FHIRGenerator.generator(Format.JSON, true).generate(ps, writer);\n+            if (DEBUG) {\n+                System.out.println(writer.toString());\n+            }\n+        }\n+        return ps;\n+    }\n+\n+    /**\n+     * add query parameter list\n+     */\n+    public WebTarget addQueryParameterList(WebTarget target, String header, List<String> vals) {\n+        if (header != null && vals != null && !vals.isEmpty()) {\n+            target = target.queryParam(header, vals.stream().collect(Collectors.joining(\",\")));\n+        }\n+        return target;\n+    }\n+\n+    /**\n+     * adds the query parameter\n+     */\n+    public WebTarget addQueryParameter(WebTarget target, String header, String val) {\n+        if (header != null && val != null) {\n+            target = target.queryParam(header, val);\n+        }\n+        return target;\n+    }\n+\n+    public Response doGet(String path, String mimeType) {\n+        WebTarget target = getWebTarget();\n+        target = target.path(path);\n+        return target.request(mimeType).get(Response.class);\n+    }\n+\n+    public Response doPost(String path, String inputFormat, String inputSource, String resourceType, String url)\n+            throws FHIRGeneratorException, IOException {\n+        WebTarget target = getWebTarget();\n+        target = target.path(path);\n+        if (DEBUG) {\n+            System.out.println(\"URL -> \" + target.getUri());\n+        }\n+        Parameters parameters = generateParameters(inputFormat, inputSource, resourceType, url);\n+        Entity<Parameters> entity = Entity.entity(parameters, FHIRMediaType.APPLICATION_FHIR_JSON);\n+        return target.request(FHIRMediaType.APPLICATION_FHIR_JSON).post(entity, Response.class);\n+    }\n+\n+    public Response polling(String statusUrl) throws InterruptedException {\n+        int status = 202;\n+        int totalTime = 0;\n+        Response response = null;\n+        while (Response.Status.ACCEPTED.getStatusCode() == status) {\n+            response = doGet(statusUrl, FHIRMediaType.APPLICATION_FHIR_JSON);\n+            // 202 accept means the request is still under processing\n+            // 200 mean export is finished\n+            status   = response.getStatus();", "originalCommit": "edce37272d37c1310e32a19fbd445793e12d5557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODI4MA==", "url": "https://github.com/IBM/FHIR/pull/940#discussion_r411628280", "bodyText": "fixed, I was playing with save and alignment", "author": "prb112", "createdAt": "2020-04-20T19:18:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc5MzI0MA=="}], "type": "inlineReview"}, {"oid": "cb0b0d44c7ca00fc2dd74000702461a450285b68", "url": "https://github.com/IBM/FHIR/commit/cb0b0d44c7ca00fc2dd74000702461a450285b68", "message": "Updates per Code Review #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-20T19:24:21Z", "type": "commit"}, {"oid": "b9631f000515ea730867b57299334fa0a6ef0d00", "url": "https://github.com/IBM/FHIR/commit/b9631f000515ea730867b57299334fa0a6ef0d00", "message": "Merge branch 'master' into issue-671-redo", "committedDate": "2020-04-20T19:25:02Z", "type": "commit"}, {"oid": "4cb4a9800224f03b64110c2e70f0f3e8939f2497", "url": "https://github.com/IBM/FHIR/commit/4cb4a9800224f03b64110c2e70f0f3e8939f2497", "message": "Merge branch 'master' into issue-671-redo", "committedDate": "2020-04-20T21:59:35Z", "type": "commit"}, {"oid": "ac2008c194b435897a53a83ea9f9f0552d552d67", "url": "https://github.com/IBM/FHIR/commit/ac2008c194b435897a53a83ea9f9f0552d552d67", "message": "Code Review Update for #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-21T17:54:46Z", "type": "commit"}, {"oid": "b017dc16a1fe29faab590c5deb90d82f46308596", "url": "https://github.com/IBM/FHIR/commit/b017dc16a1fe29faab590c5deb90d82f46308596", "message": "Code Review Update for #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-21T18:14:55Z", "type": "commit"}, {"oid": "b5f7a55881ff75055b720bfeb8bf2b4e8c154ba4", "url": "https://github.com/IBM/FHIR/commit/b5f7a55881ff75055b720bfeb8bf2b4e8c154ba4", "message": "Code Review #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-21T18:20:02Z", "type": "commit"}, {"oid": "b5f7a55881ff75055b720bfeb8bf2b4e8c154ba4", "url": "https://github.com/IBM/FHIR/commit/b5f7a55881ff75055b720bfeb8bf2b4e8c154ba4", "message": "Code Review #671\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-21T18:20:02Z", "type": "forcePushed"}]}