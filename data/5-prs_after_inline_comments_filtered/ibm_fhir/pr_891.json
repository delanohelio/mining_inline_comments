{"pr_number": 891, "pr_title": "Issue #888 - add support to validate extensible and preferred binding", "pr_createdAt": "2020-04-02T21:10:20Z", "pr_url": "https://github.com/IBM/FHIR/pull/891", "timeline": [{"oid": "559765b0be44fa800e025ac25d66313177be60fe", "url": "https://github.com/IBM/FHIR/commit/559765b0be44fa800e025ac25d66313177be60fe", "message": "Issue #888 - add support to validate extensible and preferred bindings\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-02T18:47:24Z", "type": "commit"}, {"oid": "82161520bc8c185207d19b8cee47f99e113c7213", "url": "https://github.com/IBM/FHIR/commit/82161520bc8c185207d19b8cee47f99e113c7213", "message": "Issue #888 - fixed failing unit tests in fhir-validation\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-02T19:26:56Z", "type": "commit"}, {"oid": "d8d4e59f99e5e56bbc0126b7224f55163543d75a", "url": "https://github.com/IBM/FHIR/commit/d8d4e59f99e5e56bbc0126b7224f55163543d75a", "message": "Issue #888 - fixed constraint generation issue\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-02T20:53:33Z", "type": "commit"}, {"oid": "754bd8971a87d36fb2642a949512e9c19243581f", "url": "https://github.com/IBM/FHIR/commit/754bd8971a87d36fb2642a949512e9c19243581f", "message": "Issue #888 - generate both vocab and value constraints\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-02T21:21:54Z", "type": "commit"}, {"oid": "3b047baabbadbb0968dfeb48e3fcd5094c0f0f38", "url": "https://github.com/IBM/FHIR/commit/3b047baabbadbb0968dfeb48e3fcd5094c0f0f38", "message": "Issue #888 - updates per failing tests\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-03T22:33:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDY2Ng==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r403784666", "bodyText": "Please update the class-level javadoc to indicate that we've added our own flavor of 'memberOf' which allows the caller to pass a binding strength", "author": "lmsurpre", "createdAt": "2020-04-06T01:01:40Z", "path": "fhir-path/src/main/java/com/ibm/fhir/path/function/MemberOfFunction.java", "diffHunk": "@@ -63,7 +67,7 @@ public int getMinArity() {\n \n     @Override\n     public int getMaxArity() {\n-        return 1;\n+        return 2;", "originalCommit": "3b047baabbadbb0968dfeb48e3fcd5094c0f0f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIyMjkwMg==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404222902", "bodyText": "Done", "author": "JohnTimm", "createdAt": "2020-04-06T16:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyMTg3Ng==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404321876", "bodyText": "new class doc looks good", "author": "lmsurpre", "createdAt": "2020-04-06T19:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDg3OQ==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r403784879", "bodyText": "should it be a proper test?", "author": "lmsurpre", "createdAt": "2020-04-06T01:03:17Z", "path": "fhir-ig-mcode/src/test/java/com/ibm/fhir/ig/mcode/test/ConstraintGeneratorTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.ig.mcode.test;\n+\n+import com.ibm.fhir.ig.mcode.MCODEResourceProvider;\n+import com.ibm.fhir.model.annotation.Constraint;\n+import com.ibm.fhir.model.resource.StructureDefinition;\n+import com.ibm.fhir.model.type.Extension;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.profile.ProfileSupport;\n+import com.ibm.fhir.registry.resource.FHIRRegistryResource;\n+import com.ibm.fhir.registry.spi.FHIRRegistryResourceProvider;\n+\n+public class ConstraintGeneratorTest {\n+    public static void main(String[] args) {", "originalCommit": "3b047baabbadbb0968dfeb48e3fcd5094c0f0f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNjkzNQ==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404216935", "bodyText": "This is more of a diagnostic driver to print out the generated constraints for manual inspection. I don't anticipate that we will make this part of the automated unit tests for this module.", "author": "JohnTimm", "createdAt": "2020-04-06T16:15:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NTEzMw==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r403785133", "bodyText": "is it only warnings, or might we expect errors here too?", "author": "lmsurpre", "createdAt": "2020-04-06T01:04:59Z", "path": "fhir-path/src/main/java/com/ibm/fhir/path/evaluator/FHIRPathEvaluator.java", "diffHunk": "@@ -1457,5 +1462,59 @@ public void unsetExternalConstant(String name) {\n         public boolean hasExternalConstant(String name) {\n             return externalConstantMap.containsKey(name);\n         }\n+\n+        /**\n+         * Set the constraint currently under evaluation\n+         *\n+         * @param constraint\n+         *     the constraint currently under evaluation\n+         */\n+        public void setConstraint(Constraint constraint) {\n+            this.constraint = constraint;\n+        }\n+\n+        /**\n+         * Unset the constraint currently under evaluation\n+         */\n+        public void unsetConstraint() {\n+            constraint = null;\n+        }\n+\n+        /**\n+         * Get the constraint currently under evaluation\n+         *\n+         * @return\n+         *     the constraint currently under evaluation if exists, otherwise null\n+         */\n+        public Constraint getConstraint() {\n+            return constraint;\n+        }\n+\n+        /**\n+         * Indicates whether this evaluation context has an associated constraint\n+         *\n+         * @return\n+         *     true if this evaluation context has an associated constraint, otherwise false\n+         */\n+        public boolean hasConstraint() {\n+            return constraint != null;\n+        }\n+\n+        /**\n+         * Get the list of issues that occurred during evaluation\n+         *\n+         * @return\n+         *     the list of issues that occurred during evaluation\n+         */\n+        public List<Issue> getIssues() {\n+            return issues;\n+        }", "originalCommit": "3b047baabbadbb0968dfeb48e3fcd5094c0f0f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNDMwNA==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404214304", "bodyText": "I made it flexible enough to support both.", "author": "JohnTimm", "createdAt": "2020-04-06T16:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NTEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5NDcxOQ==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404294719", "bodyText": "but currently, an error will result in a thrown exception, right?  and presumably an empty list of issues?", "author": "lmsurpre", "createdAt": "2020-04-06T18:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NTEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMDIwMA==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404310200", "bodyText": "Added javadoc to clarify that these are \"supplemental issues\" used to convey additional information to the client.", "author": "JohnTimm", "createdAt": "2020-04-06T18:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NTEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NTQ4NA==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r403785484", "bodyText": "maybe a comment to explain this line?  like why do we only add the vocabulary constraint if the child has no constraints.", "author": "lmsurpre", "createdAt": "2020-04-06T01:07:23Z", "path": "fhir-profile/src/main/java/com/ibm/fhir/profile/ConstraintGenerator.java", "diffHunk": "@@ -161,15 +171,17 @@ private String generate(Node node) {\n         }\n \n         if (hasVocabularyConstraint(elementDefinition)) {\n-            return generateVocabularyConstraint(elementDefinition);\n+            String expr = generateVocabularyConstraint(elementDefinition);\n+            if (node.children.stream().noneMatch(child -> hasConstraint(child))) {", "originalCommit": "3b047baabbadbb0968dfeb48e3fcd5094c0f0f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIyMzAzNA==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404223034", "bodyText": "Added comments to clarify the behavior.", "author": "JohnTimm", "createdAt": "2020-04-06T16:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NTQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NTU3OQ==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r403785579", "bodyText": "will there ALWAYS be another constraint following this and?", "author": "lmsurpre", "createdAt": "2020-04-06T01:07:52Z", "path": "fhir-profile/src/main/java/com/ibm/fhir/profile/ConstraintGenerator.java", "diffHunk": "@@ -161,15 +171,17 @@ private String generate(Node node) {\n         }\n \n         if (hasVocabularyConstraint(elementDefinition)) {\n-            return generateVocabularyConstraint(elementDefinition);\n+            String expr = generateVocabularyConstraint(elementDefinition);\n+            if (node.children.stream().noneMatch(child -> hasConstraint(child))) {\n+                return expr;\n+            }\n+            sb.append(expr).append(\" and \");", "originalCommit": "3b047baabbadbb0968dfeb48e3fcd5094c0f0f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNDc4Mw==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404214783", "bodyText": "if hasConstraint returns true on the check above it, then yes.", "author": "JohnTimm", "createdAt": "2020-04-06T16:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NTU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NTg2NQ==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r403785865", "bodyText": "quite a piece of logic here, maybe a comment to explain?", "author": "lmsurpre", "createdAt": "2020-04-06T01:09:28Z", "path": "fhir-profile/src/main/java/com/ibm/fhir/profile/ConstraintGenerator.java", "diffHunk": "@@ -514,8 +534,12 @@ private boolean hasVocabularyConstraint(ElementDefinition elementDefinition) {\n             String baseValueSet = (baseBinding != null) ? baseBinding.getValueSet().getValue() : null;\n             String strength = binding.getStrength().getValue();\n             String valueSet = binding.getValueSet().getValue();\n-            return (!\"required\".equals(baseStrength) && \"required\".equals(strength))\n-                    || (\"required\".equals(baseStrength) && \"required\".equals(strength) && !valueSetEqualsIgnoreVersion(valueSet, baseValueSet));\n+            return (!\"preferred\".equals(baseStrength) && \"preferred\".equals(strength)) ||\n+                    (\"preferred\".equals(baseStrength) && \"preferred\".equals(strength) && !valueSetEqualsIgnoreVersion(valueSet, baseValueSet)) ||\n+                    (!\"extensible\".equals(baseStrength) && \"extensible\".equals(strength)) ||\n+                    (\"extensible\".equals(baseStrength) && \"extensible\".equals(strength) && !valueSetEqualsIgnoreVersion(valueSet, baseValueSet)) ||\n+                    (!\"required\".equals(baseStrength) && \"required\".equals(strength)) ||\n+                    (\"required\".equals(baseStrength) && \"required\".equals(strength) && !valueSetEqualsIgnoreVersion(valueSet, baseValueSet));", "originalCommit": "3b047baabbadbb0968dfeb48e3fcd5094c0f0f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNDk5Mw==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404214993", "bodyText": "I have simplified this logic in the latest commit. It should be much easier to understand now.", "author": "JohnTimm", "createdAt": "2020-04-06T16:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NTg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NjA5NA==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r403786094", "bodyText": "when is setting the constraint required?  when is it not required?", "author": "lmsurpre", "createdAt": "2020-04-06T01:11:07Z", "path": "fhir-path/src/main/java/com/ibm/fhir/path/evaluator/FHIRPathEvaluator.java", "diffHunk": "@@ -1457,5 +1462,59 @@ public void unsetExternalConstant(String name) {\n         public boolean hasExternalConstant(String name) {\n             return externalConstantMap.containsKey(name);\n         }\n+\n+        /**\n+         * Set the constraint currently under evaluation\n+         *\n+         * @param constraint\n+         *     the constraint currently under evaluation\n+         */\n+        public void setConstraint(Constraint constraint) {", "originalCommit": "3b047baabbadbb0968dfeb48e3fcd5094c0f0f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNjMxOQ==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404216319", "bodyText": "It is driven by the Validator to give the FHIRPathEvaluator and any FHIRPathFunction(s) access to it during evaluation. Thus far, the only function that cares about it is MemberOfFunction.", "author": "JohnTimm", "createdAt": "2020-04-06T16:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NjA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyMTc1Nw==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404321757", "bodyText": "new method doc looks good", "author": "lmsurpre", "createdAt": "2020-04-06T19:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NjA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NjEyMA==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r403786120", "bodyText": "when is unsetting the constraint required? when is it not required?", "author": "lmsurpre", "createdAt": "2020-04-06T01:11:23Z", "path": "fhir-path/src/main/java/com/ibm/fhir/path/evaluator/FHIRPathEvaluator.java", "diffHunk": "@@ -1457,5 +1462,59 @@ public void unsetExternalConstant(String name) {\n         public boolean hasExternalConstant(String name) {\n             return externalConstantMap.containsKey(name);\n         }\n+\n+        /**\n+         * Set the constraint currently under evaluation\n+         *\n+         * @param constraint\n+         *     the constraint currently under evaluation\n+         */\n+        public void setConstraint(Constraint constraint) {\n+            this.constraint = constraint;\n+        }\n+\n+        /**\n+         * Unset the constraint currently under evaluation\n+         */\n+        public void unsetConstraint() {", "originalCommit": "3b047baabbadbb0968dfeb48e3fcd5094c0f0f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNTY2Mg==", "url": "https://github.com/IBM/FHIR/pull/891#discussion_r404215662", "bodyText": "The unset is driven by the Validator (after it has evaluated the current constraint and before it changes to the context constraint).", "author": "JohnTimm", "createdAt": "2020-04-06T16:13:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NjEyMA=="}], "type": "inlineReview"}, {"oid": "e67e3f4d7cca3f2529efe7c6e25230a859533949", "url": "https://github.com/IBM/FHIR/commit/e67e3f4d7cca3f2529efe7c6e25230a859533949", "message": "Issue #888 - added support for string and uri\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-06T16:07:40Z", "type": "commit"}, {"oid": "ea49e3296470c755ec1b43f98b239807850cf2e2", "url": "https://github.com/IBM/FHIR/commit/ea49e3296470c755ec1b43f98b239807850cf2e2", "message": "Issue #888 - added comments per PR feedback\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-06T16:24:02Z", "type": "commit"}, {"oid": "05ac0e5ef6650a425eb625f185c8f509739300e5", "url": "https://github.com/IBM/FHIR/commit/05ac0e5ef6650a425eb625f185c8f509739300e5", "message": "Issue #888 - changes per PR feedback\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-06T17:24:00Z", "type": "commit"}, {"oid": "f972e2d9c01ae760bd291e6d6a56ba838f4ef50b", "url": "https://github.com/IBM/FHIR/commit/f972e2d9c01ae760bd291e6d6a56ba838f4ef50b", "message": "Issue #888 - updated Javadoc per PR feedback\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-06T18:43:19Z", "type": "commit"}, {"oid": "ff56ecfc8f2e3414872e703b7ceaf3434bec51a4", "url": "https://github.com/IBM/FHIR/commit/ff56ecfc8f2e3414872e703b7ceaf3434bec51a4", "message": "Issue #888 - minor wording tweak\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-06T18:46:15Z", "type": "commit"}]}