{"pr_number": 1172, "pr_title": "Update the Dimension API", "pr_createdAt": "2020-11-20T02:48:33Z", "pr_url": "https://github.com/FabricMC/fabric/pull/1172", "timeline": [{"oid": "873fb72c1bf37457b4183a2687ce9e3e99c73bc1", "url": "https://github.com/FabricMC/fabric/commit/873fb72c1bf37457b4183a2687ce9e3e99c73bc1", "message": "Reimplement Dimension API", "committedDate": "2020-11-20T02:41:47Z", "type": "commit"}, {"oid": "bcc059089c3524e33c38b2056549ad21cc92368d", "url": "https://github.com/FabricMC/fabric/commit/bcc059089c3524e33c38b2056549ad21cc92368d", "message": "Forgot to update dimension-api mixins.json", "committedDate": "2020-11-20T02:50:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2MTYzNg==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r527361636", "bodyText": "The code in Entity#moveToWorld will fail teleportation if the target is null.\nI believe we should document that?\nReason for not requiring non-null here is a case such as another mod which may wish to intercept the teleport target via an event in the future.", "author": "i509VCB", "createdAt": "2020-11-20T02:55:48Z", "path": "fabric-dimensions-v1/src/main/java/net/fabricmc/fabric/api/dimension/v1/FabricDimensions.java", "diffHunk": "@@ -37,74 +36,27 @@ private FabricDimensions() {\n \t}\n \n \t/**\n-\t * Teleports an entity to a different dimension, using custom placement logic.\n+\t * Teleports an entity to a different dimension, placing it at the specified destination.\n \t *\n-\t * <p>This method behaves as if:\n-\t * <pre>{@code teleported.changeDimension(destination)}</pre>\n+\t * <p>Using this method will circumvent Vanilla's portal placement code.\n \t *\n-\t * <p>If {@code destination} has a default placer, that placer will be used. If {@code destination} is\n-\t * the nether or the overworld, the default logic is the vanilla path.\n-\t * For any other dimension, the default placement behaviour is undefined.\n-\t * When delegating to a placement logic that uses portals, the entity's {@code lastPortalPosition},\n-\t * {@code lastPortalDirectionVector}, and {@code lastPortalDirection} fields should be updated\n-\t * before calling this method.\n-\t *\n-\t * <p>After calling this method, {@code teleported} may be invalidated. Callers should use\n-\t * the returned entity for any further manipulation.\n+\t * <p>When teleporting to another dimension, the entity may be replaced with a new entity in the target\n+\t * dimension. This is not the case for players, but needs to be accounted for by the caller.\n \t *\n \t * @param teleported  the entity to teleport\n \t * @param destination the dimension the entity will be teleported to\n-\t * @return the teleported entity, or a clone of it\n-\t * @see #teleport(Entity, ServerWorld)\n-\t */\n-\tpublic static <E extends Entity> E teleport(E teleported, ServerWorld destination) {\n-\t\treturn teleport(teleported, destination, null);\n-\t}\n-\n-\t/**\n-\t * Teleports an entity to a different dimension, using custom placement logic.\n-\t *\n-\t * <p>If {@code customPlacement} is {@code null}, this method behaves as if:\n-\t * <pre>{@code teleported.changeDimension(destination)}</pre>\n-\t * The {@code customPlacement} may itself return {@code null}, in which case\n-\t * the default placement logic for that dimension will be run.\n-\t *\n-\t * <p>If {@code destination} has a default placer, that placer will be used. If {@code destination} is\n-\t * the nether or the overworld, the default logic is the vanilla path.\n-\t * For any other dimension, the default placement behaviour is undefined.\n-\t * When delegating to a placement logic that uses portals, the entity's {@code lastPortalPosition},\n-\t * {@code lastPortalDirectionVector}, and {@code lastPortalDirection} fields should be updated\n-\t * before calling this method.\n-\t *\n-\t * <p>After calling this method, {@code teleported} may be invalidated. Callers should use\n-\t * the returned entity for any further manipulation.\n-\t *\n-\t * @param teleported   the entity to teleport\n-\t * @param destination  the dimension the entity will be teleported to\n-\t * @param customPlacer custom placement logic that will run before the default one,\n-\t *                     or {@code null} to use the dimension's default behavior.\n-\t * @param <E>          the type of the teleported entity\n-\t * @return the teleported entity, or a clone of it\n+\t * @param target      where the entity will be placed in the target world.", "originalCommit": "bcc059089c3524e33c38b2056549ad21cc92368d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2MTczNA==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r527361734", "bodyText": "Can you add a Nullable annotation here for the return value as an entity can fail to teleport?", "author": "i509VCB", "createdAt": "2020-11-20T02:56:10Z", "path": "fabric-dimensions-v1/src/main/java/net/fabricmc/fabric/api/dimension/v1/FabricDimensions.java", "diffHunk": "@@ -37,74 +36,27 @@ private FabricDimensions() {\n \t}\n \n \t/**\n-\t * Teleports an entity to a different dimension, using custom placement logic.\n+\t * Teleports an entity to a different dimension, placing it at the specified destination.\n \t *\n-\t * <p>This method behaves as if:\n-\t * <pre>{@code teleported.changeDimension(destination)}</pre>\n+\t * <p>Using this method will circumvent Vanilla's portal placement code.\n \t *\n-\t * <p>If {@code destination} has a default placer, that placer will be used. If {@code destination} is\n-\t * the nether or the overworld, the default logic is the vanilla path.\n-\t * For any other dimension, the default placement behaviour is undefined.\n-\t * When delegating to a placement logic that uses portals, the entity's {@code lastPortalPosition},\n-\t * {@code lastPortalDirectionVector}, and {@code lastPortalDirection} fields should be updated\n-\t * before calling this method.\n-\t *\n-\t * <p>After calling this method, {@code teleported} may be invalidated. Callers should use\n-\t * the returned entity for any further manipulation.\n+\t * <p>When teleporting to another dimension, the entity may be replaced with a new entity in the target\n+\t * dimension. This is not the case for players, but needs to be accounted for by the caller.\n \t *\n \t * @param teleported  the entity to teleport\n \t * @param destination the dimension the entity will be teleported to\n-\t * @return the teleported entity, or a clone of it\n-\t * @see #teleport(Entity, ServerWorld)\n-\t */\n-\tpublic static <E extends Entity> E teleport(E teleported, ServerWorld destination) {\n-\t\treturn teleport(teleported, destination, null);\n-\t}\n-\n-\t/**\n-\t * Teleports an entity to a different dimension, using custom placement logic.\n-\t *\n-\t * <p>If {@code customPlacement} is {@code null}, this method behaves as if:\n-\t * <pre>{@code teleported.changeDimension(destination)}</pre>\n-\t * The {@code customPlacement} may itself return {@code null}, in which case\n-\t * the default placement logic for that dimension will be run.\n-\t *\n-\t * <p>If {@code destination} has a default placer, that placer will be used. If {@code destination} is\n-\t * the nether or the overworld, the default logic is the vanilla path.\n-\t * For any other dimension, the default placement behaviour is undefined.\n-\t * When delegating to a placement logic that uses portals, the entity's {@code lastPortalPosition},\n-\t * {@code lastPortalDirectionVector}, and {@code lastPortalDirection} fields should be updated\n-\t * before calling this method.\n-\t *\n-\t * <p>After calling this method, {@code teleported} may be invalidated. Callers should use\n-\t * the returned entity for any further manipulation.\n-\t *\n-\t * @param teleported   the entity to teleport\n-\t * @param destination  the dimension the entity will be teleported to\n-\t * @param customPlacer custom placement logic that will run before the default one,\n-\t *                     or {@code null} to use the dimension's default behavior.\n-\t * @param <E>          the type of the teleported entity\n-\t * @return the teleported entity, or a clone of it\n+\t * @param target      where the entity will be placed in the target world.\n+\t *                    As in Vanilla, the target's velocity is not applied to players.\n+\t * @param <E>         the type of the teleported entity\n+\t * @return Returns the teleported entity in the target dimension, which may be a new entity or <code>teleported</code>,\n+\t * depending on the entity type.\n \t * @throws IllegalStateException if this method is called on a client entity\n \t * @apiNote this method must be called from the main server thread\n \t */\n-\tpublic static <E extends Entity> E teleport(E teleported, ServerWorld destination, /*Nullable*/ EntityPlacer customPlacer) {\n+\tpublic static <E extends Entity> E teleport(E teleported, ServerWorld destination, TeleportTarget target) {", "originalCommit": "bcc059089c3524e33c38b2056549ad21cc92368d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2MTkyMw==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r527361923", "bodyText": "I believe this should be fine as the method which sets this field will fail unless the method is called on the server thread.", "author": "i509VCB", "createdAt": "2020-11-20T02:56:45Z", "path": "fabric-dimensions-v1/src/main/java/net/fabricmc/fabric/impl/dimension/FabricDimensionInternals.java", "diffHunk": "@@ -16,116 +16,41 @@\n \n package net.fabricmc.fabric.impl.dimension;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-\n import com.google.common.base.Preconditions;\n \n-import net.minecraft.block.pattern.BlockPattern;\n import net.minecraft.entity.Entity;\n import net.minecraft.server.world.ServerWorld;\n-import net.minecraft.util.math.Direction;\n-import net.minecraft.util.registry.RegistryKey;\n-import net.minecraft.world.World;\n+import net.minecraft.world.TeleportTarget;\n \n-import net.fabricmc.fabric.api.dimension.v1.EntityPlacer;\n import net.fabricmc.fabric.api.dimension.v1.FabricDimensions;\n-import net.fabricmc.fabric.mixin.dimension.EntityHooks;\n \n public final class FabricDimensionInternals {\n+\t/**\n+\t * The target passed to the last call to {@link FabricDimensions#teleport(Entity, ServerWorld, TeleportTarget)}.\n+\t */\n+\tprivate static TeleportTarget currentTarget;", "originalCommit": "bcc059089c3524e33c38b2056549ad21cc92368d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2MjY5Nw==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r527362697", "bodyText": "For others wondering, this capture via modify variable is required when discussing with Gimpansor who originally wrote the PR due to Fabric Loader's injection point for mod loading. This should be fine.", "author": "i509VCB", "createdAt": "2020-11-20T02:59:36Z", "path": "fabric-dimensions-v1/src/main/java/net/fabricmc/fabric/mixin/dimension/ServerBugfixMixin.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright (c) 2016, 2017, 2018, 2019 FabricMC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package net.fabricmc.fabric.mixin.dimension;\n+\n+import com.mojang.serialization.Lifecycle;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.ModifyVariable;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import net.minecraft.nbt.Tag;\n+import net.minecraft.resource.DataPackSettings;\n+import net.minecraft.server.Main;\n+import net.minecraft.util.dynamic.RegistryOps;\n+import net.minecraft.util.registry.DynamicRegistryManager;\n+import net.minecraft.world.gen.GeneratorOptions;\n+import net.minecraft.world.level.LevelInfo;\n+import net.minecraft.world.level.LevelProperties;\n+import net.minecraft.world.level.storage.LevelStorage;\n+\n+/**\n+ * This Mixin aims to solve a Minecraft Vanilla bug where datapacks are ignored during creation of the\n+ * initial LevelProperties when a dedicated server creates a completely new level.\n+ *\n+ * <p>This also includes the datapacks of loaded Fabric mods, and results in modded dimensions only\n+ * being available after restarting the server, once the world has been created.\n+ *\n+ * <p>This Mixin aims to solve this problem by saving and loading the level.dat file once, after\n+ * a new set of level properties is created. This will apply the same logic as reloading the\n+ * level.dat after a restart, now including all datapack dimensions.\n+ *\n+ * <p>See https://bugs.mojang.com/browse/MC-195468 for a related bug report.\n+ *\n+ * <p>In 1.17: Retest if this bug still occurs without this Mixin by launching a dedicated server with the\n+ * dimension testmod, and no world directory. If the dimension is available (i.e. in /execute in, or via\n+ * the testmod's commands), then the bug is fixed and this Mixin can be removed.\n+ */\n+@Mixin(value = Main.class, remap = false)\n+public class ServerBugfixMixin {\n+\tprivate static LevelStorage.Session fabric_session;\n+\n+\tprivate static DynamicRegistryManager.Impl fabric_dynamicRegistry;\n+\n+\tprivate static RegistryOps<Tag> fabric_registryOps;\n+\n+\t@ModifyVariable(at = @At(value = \"INVOKE_ASSIGN\", target = \"Lnet/minecraft/util/registry/DynamicRegistryManager;create()Lnet/minecraft/util/registry/DynamicRegistryManager$Impl;\"), method = \"main\", remap = false, allow = 1)", "originalCommit": "bcc059089c3524e33c38b2056549ad21cc92368d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2Mjg1Mw==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r527362853", "bodyText": "Could you throw an @Unique annotation on those three static fields?", "author": "i509VCB", "createdAt": "2020-11-20T03:00:05Z", "path": "fabric-dimensions-v1/src/main/java/net/fabricmc/fabric/mixin/dimension/ServerBugfixMixin.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright (c) 2016, 2017, 2018, 2019 FabricMC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package net.fabricmc.fabric.mixin.dimension;\n+\n+import com.mojang.serialization.Lifecycle;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.ModifyVariable;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import net.minecraft.nbt.Tag;\n+import net.minecraft.resource.DataPackSettings;\n+import net.minecraft.server.Main;\n+import net.minecraft.util.dynamic.RegistryOps;\n+import net.minecraft.util.registry.DynamicRegistryManager;\n+import net.minecraft.world.gen.GeneratorOptions;\n+import net.minecraft.world.level.LevelInfo;\n+import net.minecraft.world.level.LevelProperties;\n+import net.minecraft.world.level.storage.LevelStorage;\n+\n+/**\n+ * This Mixin aims to solve a Minecraft Vanilla bug where datapacks are ignored during creation of the\n+ * initial LevelProperties when a dedicated server creates a completely new level.\n+ *\n+ * <p>This also includes the datapacks of loaded Fabric mods, and results in modded dimensions only\n+ * being available after restarting the server, once the world has been created.\n+ *\n+ * <p>This Mixin aims to solve this problem by saving and loading the level.dat file once, after\n+ * a new set of level properties is created. This will apply the same logic as reloading the\n+ * level.dat after a restart, now including all datapack dimensions.\n+ *\n+ * <p>See https://bugs.mojang.com/browse/MC-195468 for a related bug report.\n+ *\n+ * <p>In 1.17: Retest if this bug still occurs without this Mixin by launching a dedicated server with the\n+ * dimension testmod, and no world directory. If the dimension is available (i.e. in /execute in, or via\n+ * the testmod's commands), then the bug is fixed and this Mixin can be removed.\n+ */\n+@Mixin(value = Main.class, remap = false)\n+public class ServerBugfixMixin {\n+\tprivate static LevelStorage.Session fabric_session;\n+\n+\tprivate static DynamicRegistryManager.Impl fabric_dynamicRegistry;\n+\n+\tprivate static RegistryOps<Tag> fabric_registryOps;", "originalCommit": "bcc059089c3524e33c38b2056549ad21cc92368d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9cab03bf4620186bbfa41d92a1e9cec92daa732b", "url": "https://github.com/FabricMC/fabric/commit/9cab03bf4620186bbfa41d92a1e9cec92daa732b", "message": "Did suggested changes.", "committedDate": "2020-11-20T03:11:21Z", "type": "commit"}, {"oid": "4188f856f4f474d22a5b28b72ee604101640f8fb", "url": "https://github.com/FabricMC/fabric/commit/4188f856f4f474d22a5b28b72ee604101640f8fb", "message": "Move Nullable import.", "committedDate": "2020-11-20T03:15:41Z", "type": "commit"}, {"oid": "d0ae7aff0d12421fa921f478dca76a1c8c07f9fb", "url": "https://github.com/FabricMC/fabric/commit/d0ae7aff0d12421fa921f478dca76a1c8c07f9fb", "message": "Remove unneeded whitespace", "committedDate": "2020-11-20T03:20:08Z", "type": "commit"}, {"oid": "ac427e54ca53a33c45ad1b988c7431b3a33daf99", "url": "https://github.com/FabricMC/fabric/commit/ac427e54ca53a33c45ad1b988c7431b3a33daf99", "message": "Merge pull request #1 from i509VCB/dimdoors/fix_whitespace_dims\n\nDimdoors/fix whitespace dims", "committedDate": "2020-11-20T03:21:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkyNTY4MA==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r527925680", "bodyText": "Just came across this the other day \ud83d\udc4d", "author": "modmuss50", "createdAt": "2020-11-20T19:28:57Z", "path": "fabric-dimensions-v1/src/main/java/net/fabricmc/fabric/mixin/dimension/ServerBugfixMixin.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright (c) 2016, 2017, 2018, 2019 FabricMC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package net.fabricmc.fabric.mixin.dimension;\n+\n+import com.mojang.serialization.Lifecycle;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Unique;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.ModifyVariable;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import net.minecraft.nbt.Tag;\n+import net.minecraft.resource.DataPackSettings;\n+import net.minecraft.server.Main;\n+import net.minecraft.util.dynamic.RegistryOps;\n+import net.minecraft.util.registry.DynamicRegistryManager;\n+import net.minecraft.world.gen.GeneratorOptions;\n+import net.minecraft.world.level.LevelInfo;\n+import net.minecraft.world.level.LevelProperties;\n+import net.minecraft.world.level.storage.LevelStorage;\n+\n+/**\n+ * This Mixin aims to solve a Minecraft Vanilla bug where datapacks are ignored during creation of the\n+ * initial LevelProperties when a dedicated server creates a completely new level.", "originalCommit": "ac427e54ca53a33c45ad1b988c7431b3a33daf99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkyNjQ0MQ==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r527926441", "bodyText": "The testmod should fail hard on first tick if fails to find the modded dim, we now startup a fresh dedicated server when building on GHA. Should be trivial to add", "author": "modmuss50", "createdAt": "2020-11-20T19:30:24Z", "path": "fabric-dimensions-v1/src/main/java/net/fabricmc/fabric/mixin/dimension/ServerBugfixMixin.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright (c) 2016, 2017, 2018, 2019 FabricMC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package net.fabricmc.fabric.mixin.dimension;\n+\n+import com.mojang.serialization.Lifecycle;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Unique;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.ModifyVariable;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import net.minecraft.nbt.Tag;\n+import net.minecraft.resource.DataPackSettings;\n+import net.minecraft.server.Main;\n+import net.minecraft.util.dynamic.RegistryOps;\n+import net.minecraft.util.registry.DynamicRegistryManager;\n+import net.minecraft.world.gen.GeneratorOptions;\n+import net.minecraft.world.level.LevelInfo;\n+import net.minecraft.world.level.LevelProperties;\n+import net.minecraft.world.level.storage.LevelStorage;\n+\n+/**\n+ * This Mixin aims to solve a Minecraft Vanilla bug where datapacks are ignored during creation of the\n+ * initial LevelProperties when a dedicated server creates a completely new level.\n+ *\n+ * <p>This also includes the datapacks of loaded Fabric mods, and results in modded dimensions only\n+ * being available after restarting the server, once the world has been created.\n+ *\n+ * <p>This Mixin aims to solve this problem by saving and loading the level.dat file once, after\n+ * a new set of level properties is created. This will apply the same logic as reloading the\n+ * level.dat after a restart, now including all datapack dimensions.\n+ *\n+ * <p>See https://bugs.mojang.com/browse/MC-195468 for a related bug report.\n+ *\n+ * <p>In 1.17: Retest if this bug still occurs without this Mixin by launching a dedicated server with the\n+ * dimension testmod, and no world directory. If the dimension is available (i.e. in /execute in, or via\n+ * the testmod's commands), then the bug is fixed and this Mixin can be removed.", "originalCommit": "ac427e54ca53a33c45ad1b988c7431b3a33daf99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzNzMwNA==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r528037304", "bodyText": "Waterpicker, for the structure of this I would advise looking at command api for reference.", "author": "i509VCB", "createdAt": "2020-11-21T00:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkyNjQ0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODE4MzM5NA==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r528183394", "bodyText": "I just pushed a potential automatic testmod test thingy.", "author": "Waterpicker", "createdAt": "2020-11-21T11:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkyNjQ0MQ=="}], "type": "inlineReview"}, {"oid": "01e3b371639db01b11f8af20cbc127ad27dd30e7", "url": "https://github.com/FabricMC/fabric/commit/01e3b371639db01b11f8af20cbc127ad27dd30e7", "message": "Added automatic testing testmod feature.", "committedDate": "2020-11-21T11:09:09Z", "type": "commit"}, {"oid": "84ae37ba8e5ad692cb28681fb508260b30b080cc", "url": "https://github.com/FabricMC/fabric/commit/84ae37ba8e5ad692cb28681fb508260b30b080cc", "message": "...Removed unused imports...", "committedDate": "2020-11-21T11:15:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODE4NDAyMQ==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r528184021", "bodyText": "double space between throw and new. Likely to fail checkstyle", "author": "i509VCB", "createdAt": "2020-11-21T11:18:36Z", "path": "fabric-dimensions-v1/src/testmod/java/net/fabricmc/fabric/test/dimension/FabricDimensionTest.java", "diffHunk": "@@ -65,6 +70,37 @@ public void onInitialize() {\n \n \t\tWORLD_KEY = RegistryKey.of(Registry.DIMENSION, new Identifier(\"fabric_dimension\", \"void\"));\n \n+\t\tServerLifecycleEvents.SERVER_STARTED.register(server -> {\n+\t\t\tServerWorld overworld = server.getWorld(World.OVERWORLD);\n+\t\t\tServerWorld world = server.getWorld(WORLD_KEY);\n+\n+\t\t\tif (world == null) {\n+\t\t\t\tthrow new AssertionError(\"Test world doesn't exist.\");\n+\t\t\t}\n+\n+\t\t\tEntity entity = COW.create(overworld);\n+\n+\t\t\tif(!entity.world.getRegistryKey().equals(World.OVERWORLD)) {\n+\t\t\t\tthrow  new AssertionError(\"Entity starting world isn't the overworld\");", "originalCommit": "01e3b371639db01b11f8af20cbc127ad27dd30e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "418f4c806293675efc70ea8d7490ec0f06335aa4", "url": "https://github.com/FabricMC/fabric/commit/418f4c806293675efc70ea8d7490ec0f06335aa4", "message": "And other stuff the auto style system complains about...", "committedDate": "2020-11-21T11:20:15Z", "type": "commit"}, {"oid": "26f3974f8b88456575591350123ed9e41900b85d", "url": "https://github.com/FabricMC/fabric/commit/26f3974f8b88456575591350123ed9e41900b85d", "message": "...", "committedDate": "2020-11-21T11:29:07Z", "type": "commit"}, {"oid": "b819d1a98fbdc9d34957cdbf8871046d5e616a73", "url": "https://github.com/FabricMC/fabric/commit/b819d1a98fbdc9d34957cdbf8871046d5e616a73", "message": "Drop Networking", "committedDate": "2020-11-21T12:49:09Z", "type": "commit"}, {"oid": "97740e6134400f6e1c826400cb9702b66b39653c", "url": "https://github.com/FabricMC/fabric/commit/97740e6134400f6e1c826400cb9702b66b39653c", "message": "Completed suggested changes.", "committedDate": "2020-11-21T16:08:24Z", "type": "commit"}, {"oid": "2290756b6fdb7636fb00d6f606e8eb01dc4445c1", "url": "https://github.com/FabricMC/fabric/commit/2290756b6fdb7636fb00d6f606e8eb01dc4445c1", "message": "Revert \"Completed suggested changes.\"\n\nThis reverts commit 97740e6134400f6e1c826400cb9702b66b39653c.", "committedDate": "2020-11-21T17:36:43Z", "type": "commit"}, {"oid": "f8075f068993ef46055663ad0a7a03ef0a7b93c5", "url": "https://github.com/FabricMC/fabric/commit/f8075f068993ef46055663ad0a7a03ef0a7b93c5", "message": "Did requested changes.", "committedDate": "2020-11-22T04:41:42Z", "type": "commit"}, {"oid": "61ce4c7f35f6e272ce8258c61da4a9bce4222435", "url": "https://github.com/FabricMC/fabric/commit/61ce4c7f35f6e272ce8258c61da4a9bce4222435", "message": "Forgot colon", "committedDate": "2020-11-22T04:45:51Z", "type": "commit"}, {"oid": "cd8f3bda305fbc20ed502137ed0533c1776a9f96", "url": "https://github.com/FabricMC/fabric/commit/cd8f3bda305fbc20ed502137ed0533c1776a9f96", "message": "Turn plural to singular", "committedDate": "2020-11-22T04:58:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODMyMDkwMQ==", "url": "https://github.com/FabricMC/fabric/pull/1172#discussion_r528320901", "bodyText": "I'm not sure if this should really be in the dimensions API, this would rather fit in resource-loader as it doesn't affect only the worldgen but any datapack on world creation as the description states, so in theory this also affects tags, functions and more.", "author": "LambdAurora", "createdAt": "2020-11-22T11:24:07Z", "path": "fabric-dimensions-v1/src/main/java/net/fabricmc/fabric/mixin/dimension/ServerBugfixMixin.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright (c) 2016, 2017, 2018, 2019 FabricMC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package net.fabricmc.fabric.mixin.dimension;\n+\n+import com.mojang.serialization.Lifecycle;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Unique;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.ModifyVariable;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import net.minecraft.nbt.Tag;\n+import net.minecraft.resource.DataPackSettings;\n+import net.minecraft.server.Main;\n+import net.minecraft.util.dynamic.RegistryOps;\n+import net.minecraft.util.registry.DynamicRegistryManager;\n+import net.minecraft.world.gen.GeneratorOptions;\n+import net.minecraft.world.level.LevelInfo;\n+import net.minecraft.world.level.LevelProperties;\n+import net.minecraft.world.level.storage.LevelStorage;\n+\n+/**\n+ * This Mixin aims to solve a Minecraft Vanilla bug where datapacks are ignored during creation of the\n+ * initial LevelProperties when a dedicated server creates a completely new level.\n+ *\n+ * <p>This also includes the datapacks of loaded Fabric mods, and results in modded dimensions only\n+ * being available after restarting the server, once the world has been created.\n+ *\n+ * <p>This Mixin aims to solve this problem by saving and loading the level.dat file once, after\n+ * a new set of level properties is created. This will apply the same logic as reloading the\n+ * level.dat after a restart, now including all datapack dimensions.\n+ *\n+ * <p>See https://bugs.mojang.com/browse/MC-195468 for a related bug report.\n+ *\n+ * <p>In 1.17: Retest if this bug still occurs without this Mixin by launching a dedicated server with the\n+ * dimension testmod, and no world directory. If the dimension is available (i.e. in /execute in, or via\n+ * the testmod's commands), then the bug is fixed and this Mixin can be removed.\n+ */\n+@Mixin(value = Main.class, remap = false)\n+public class ServerBugfixMixin {", "originalCommit": "cd8f3bda305fbc20ed502137ed0533c1776a9f96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}