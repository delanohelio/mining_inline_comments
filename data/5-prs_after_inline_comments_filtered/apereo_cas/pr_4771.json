{"pr_number": 4771, "pr_title": "OIDC/OAuth Revocation improvements part 2", "pr_createdAt": "2020-03-23T19:13:00Z", "pr_url": "https://github.com/apereo/cas/pull/4771", "timeline": [{"oid": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "url": "https://github.com/apereo/cas/commit/fcc81e75d0d81d31b73a7434ce54accb38ca448a", "message": "OIDC/OAuth Revocation improvements part 2\n\n* Revocation is now supported inside the /oauth2.0 url instead of /oidc \nonly\n\n* add support for public clients\n\n* Fix a bug which allow a client to revoke a token from another client\n\n* Refresh token revocation new revoke all Access Token related to the \nRefresh Token submitted", "committedDate": "2020-03-23T18:50:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1ODA2OQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396958069", "bodyText": "Include the client-id in the log message please", "author": "mmoayyed", "createdAt": "2020-03-24T07:54:40Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/validator/token/OAuth20RevocationRequestValidator.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package org.apereo.cas.support.oauth.validator.token;\n+\n+import org.apereo.cas.services.ServicesManager;\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.springframework.core.Ordered;\n+\n+/**\n+ * This is {@link OAuth20RevocationRequestValidator}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@RequiredArgsConstructor\n+@Slf4j\n+@Getter\n+@Setter\n+public class OAuth20RevocationRequestValidator implements OAuth20TokenRequestValidator {\n+    private final ServicesManager servicesManager;\n+\n+    private int order = Ordered.LOWEST_PRECEDENCE;\n+\n+    @Override\n+    public boolean validate(final JEEContext context) {\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = OAuth20Utils.getRegisteredOAuthServiceByClientId(this.servicesManager, clientId);\n+\n+        if (registeredService == null) {\n+            LOGGER.warn(\"Provided client id cannot be matched against a service definition\");", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1ODc4OA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396958788", "bodyText": "Missing \"?\".\nAlso, it's best to describe exactly what a \"public\" client is, since the implementation here does not visibly provide a clue API-wise. Something as simple as, a \"public client is one that does not define a secret\", etc.", "author": "mmoayyed", "createdAt": "2020-03-24T07:56:18Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/OAuth20HandlerInterceptorAdapter.java", "diffHunk": "@@ -48,6 +54,32 @@ public boolean preHandle(final HttpServletRequest request, final HttpServletResp\n         return !isAuthorizationRequest(request, response) || requiresAuthenticationAuthorizeInterceptor.preHandle(request, response, handler);\n     }\n \n+    /**\n+    * Is the client requesting is a OAuth \"public\" client.", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNDEzNg==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397524136", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-03-24T23:32:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1ODc4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1ODg0Nw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396958847", "bodyText": "StringUtils.isNotBlank()", "author": "mmoayyed", "createdAt": "2020-03-24T07:56:26Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/OAuth20HandlerInterceptorAdapter.java", "diffHunk": "@@ -48,6 +54,32 @@ public boolean preHandle(final HttpServletRequest request, final HttpServletResp\n         return !isAuthorizationRequest(request, response) || requiresAuthenticationAuthorizeInterceptor.preHandle(request, response, handler);\n     }\n \n+    /**\n+    * Is the client requesting is a OAuth \"public\" client.\n+    * @param request the request\n+    * @param response the response\n+    * @return the boolean\n+    */\n+    protected boolean clientNeedAuthentication(final HttpServletRequest request, final HttpServletResponse response) {\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(new JEEContext(request, response)).getLeft();\n+        val registeredService = OAuth20Utils.getRegisteredOAuthServiceByClientId(servicesManager, clientId);\n+        if (clientId.isEmpty() || registeredService == null) {\n+            return true;\n+        }\n+        return !StringUtils.isBlank(registeredService.getClientSecret());", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNjg4Ng==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397526886", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-24T23:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1ODg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTE2MQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396959161", "bodyText": "Unnecessary else here.", "author": "mmoayyed", "createdAt": "2020-03-24T07:57:08Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/OAuth20HandlerInterceptorAdapter.java", "diffHunk": "@@ -84,7 +116,11 @@ protected boolean isDeviceTokenRequest(final HttpServletRequest request, final H\n      */\n     protected boolean requestRequiresAuthentication(final HttpServletRequest request, final HttpServletResponse response) {\n         val accessTokenRequest = isAccessTokenRequest(request, response);\n-        if (!accessTokenRequest) {\n+        val revokeTokenRequest = isRevokeTokenRequest(request, response);\n+\n+        if (revokeTokenRequest) {\n+            return clientNeedAuthentication(request, response);\n+        } else if (!accessTokenRequest) {", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNDIxNA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397524214", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-03-24T23:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTE2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTM5OQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396959399", "bodyText": "How and what is the session store created with new JEEContext(request, response)?", "author": "mmoayyed", "createdAt": "2020-03-24T07:57:40Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/OAuth20HandlerInterceptorAdapter.java", "diffHunk": "@@ -48,6 +54,32 @@ public boolean preHandle(final HttpServletRequest request, final HttpServletResp\n         return !isAuthorizationRequest(request, response) || requiresAuthenticationAuthorizeInterceptor.preHandle(request, response, handler);\n     }\n \n+    /**\n+    * Is the client requesting is a OAuth \"public\" client.\n+    * @param request the request\n+    * @param response the response\n+    * @return the boolean\n+    */\n+    protected boolean clientNeedAuthentication(final HttpServletRequest request, final HttpServletResponse response) {\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(new JEEContext(request, response)).getLeft();", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2MTg4OA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397461888", "bodyText": "Need it to get the clientId with client_secret_basic or client_secret_post. I used getClientIdAndClientSecret to avoir duplicated code. Any other way exists ?", "author": "julienhuon", "createdAt": "2020-03-24T21:08:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYzMTk0OQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397631949", "bodyText": "Sorry, let me clarify.\nWhen you use new JEEContext(request, response), there is a session-store used inside a JEEContext by default and that store is not one used or created by CAS. Is the session-store inside JEEContext used anywhere? Should JEEContext use the session-store that is created and used by CAS?\nThe CAS session-store is either one that is based on J2E or one that is distributed based on the ticket-registry, depending on configuration.", "author": "mmoayyed", "createdAt": "2020-03-25T06:27:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgwODY3NQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r399808675", "bodyText": "Ok, got it. Sorry.", "author": "julienhuon", "createdAt": "2020-03-29T14:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTY0OA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396959648", "bodyText": "Add ? at the end of all question-like statements.", "author": "mmoayyed", "createdAt": "2020-03-24T07:58:08Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/OAuth20HandlerInterceptorAdapter.java", "diffHunk": "@@ -48,6 +54,32 @@ public boolean preHandle(final HttpServletRequest request, final HttpServletResp\n         return !isAuthorizationRequest(request, response) || requiresAuthenticationAuthorizeInterceptor.preHandle(request, response, handler);\n     }\n \n+    /**\n+    * Is the client requesting is a OAuth \"public\" client.\n+    * @param request the request\n+    * @param response the response\n+    * @return the boolean\n+    */\n+    protected boolean clientNeedAuthentication(final HttpServletRequest request, final HttpServletResponse response) {\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(new JEEContext(request, response)).getLeft();\n+        val registeredService = OAuth20Utils.getRegisteredOAuthServiceByClientId(servicesManager, clientId);\n+        if (clientId.isEmpty() || registeredService == null) {\n+            return true;\n+        }\n+        return !StringUtils.isBlank(registeredService.getClientSecret());\n+    }\n+\n+    /**\n+     * Is revoke token request request.", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2MjQyNA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397462424", "bodyText": "Even on the methods that I didn't created?", "author": "julienhuon", "createdAt": "2020-03-24T21:09:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDE1Nw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396960157", "bodyText": "doesServiceNeedAuthentication()", "author": "mmoayyed", "createdAt": "2020-03-24T07:59:11Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (isServiceNeedAuthentication(registeredService)) {", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNTI1NQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397525255", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-24T23:35:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDUwMA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396960500", "bodyText": "Not sure what isAsupportedTokenType is?", "author": "mmoayyed", "createdAt": "2020-03-24T07:59:53Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (isServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        if (isAsupportedTokenType(token)) {", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2MzU3OQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397463579", "bodyText": "Either a refreshToken or a AccessToken. Main goal is to avoid to process requests on unsupported token types (code etc...) or on invalid token id.", "author": "julienhuon", "createdAt": "2020-03-24T21:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNTQwNw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397525407", "bodyText": "Or to revoke a OAuth Code etc.", "author": "julienhuon", "createdAt": "2020-03-24T23:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDUwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDkzMw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396960933", "bodyText": "Rename to clientId, and mark method as protected.", "author": "mmoayyed", "createdAt": "2020-03-24T08:00:48Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (isServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        if (isAsupportedTokenType(token)) {\n+            return generateRevocationResponse(token, clientId, response);\n+        }\n+        return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+    }\n+\n+    /**\n+     * Generate revocation token response.\n+     *\n+     * @param token the token to revoke\n+     * @param client the client who requests the revocation\n+     * @param response the response\n+     * @return the model and view\n+     */\n+    private ModelAndView generateRevocationResponse(final String token,\n+                                                    final String client,", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNTQ0OA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397525448", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-24T23:36:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MTMzNQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396961335", "bodyText": "This sort of thing can never pass. Comparing ticket ids by prefixes is generally a malpractice and should be avoided.", "author": "mmoayyed", "createdAt": "2020-03-24T08:01:35Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (isServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        if (isAsupportedTokenType(token)) {\n+            return generateRevocationResponse(token, clientId, response);\n+        }\n+        return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+    }\n+\n+    /**\n+     * Generate revocation token response.\n+     *\n+     * @param token the token to revoke\n+     * @param client the client who requests the revocation\n+     * @param response the response\n+     * @return the model and view\n+     */\n+    private ModelAndView generateRevocationResponse(final String token,\n+                                                    final String client,\n+                                                    final HttpServletResponse response) {\n+\n+        if (token.startsWith(OAuth20RefreshToken.PREFIX)) {", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2MzkwMw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397463903", "bodyText": "Ok, sorry about that.", "author": "julienhuon", "createdAt": "2020-03-24T21:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MTMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNTYzMw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397525633", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-24T23:36:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MTMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MTg0Nw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396961847", "bodyText": "Switch type to OAuth20Token instead.", "author": "mmoayyed", "createdAt": "2020-03-24T08:02:40Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (isServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        if (isAsupportedTokenType(token)) {\n+            return generateRevocationResponse(token, clientId, response);\n+        }\n+        return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+    }\n+\n+    /**\n+     * Generate revocation token response.\n+     *\n+     * @param token the token to revoke\n+     * @param client the client who requests the revocation\n+     * @param response the response\n+     * @return the model and view\n+     */\n+    private ModelAndView generateRevocationResponse(final String token,\n+                                                    final String client,\n+                                                    final HttpServletResponse response) {\n+\n+        if (token.startsWith(OAuth20RefreshToken.PREFIX)) {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20RefreshToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        } else {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20AccessToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        }\n+\n+        val mv = new ModelAndView(new MappingJackson2JsonView());\n+        mv.setStatus(HttpStatus.OK);\n+        return mv;\n+    }\n+\n+    /**\n+     * Revoke the provided Refresh Token and it's related Access Tokens.\n+     *\n+     * @param token the token\n+     * @return the model and view\n+     */\n+    private void revokeToken(final OAuth20RefreshToken token) {\n+        LOGGER.debug(\"Revoking token [{}]\", token);\n+        getOAuthConfigurationContext().getTicketRegistry().deleteTicket(token);\n+\n+        token.getAccessTokens().forEach(item-> {\n+            LOGGER.debug(\"Revoking Access Token [{}] related to Refresh Token [{}]\", item, token);\n+            getOAuthConfigurationContext().getTicketRegistry().deleteTicket(item);\n+        });\n+    }\n+\n+    /**\n+     * Revoke the provided Access Token.\n+     *\n+     * @param token the token\n+     * @return the model and view\n+     */\n+    private void revokeToken(final OAuth20AccessToken token) {", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MTk0Mw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396961943", "bodyText": "Remove log line, Call revokeToken instead in a lambda to avoid duplicate code.", "author": "mmoayyed", "createdAt": "2020-03-24T08:02:53Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (isServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        if (isAsupportedTokenType(token)) {\n+            return generateRevocationResponse(token, clientId, response);\n+        }\n+        return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+    }\n+\n+    /**\n+     * Generate revocation token response.\n+     *\n+     * @param token the token to revoke\n+     * @param client the client who requests the revocation\n+     * @param response the response\n+     * @return the model and view\n+     */\n+    private ModelAndView generateRevocationResponse(final String token,\n+                                                    final String client,\n+                                                    final HttpServletResponse response) {\n+\n+        if (token.startsWith(OAuth20RefreshToken.PREFIX)) {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20RefreshToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        } else {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20AccessToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        }\n+\n+        val mv = new ModelAndView(new MappingJackson2JsonView());\n+        mv.setStatus(HttpStatus.OK);\n+        return mv;\n+    }\n+\n+    /**\n+     * Revoke the provided Refresh Token and it's related Access Tokens.\n+     *\n+     * @param token the token\n+     * @return the model and view\n+     */\n+    private void revokeToken(final OAuth20RefreshToken token) {\n+        LOGGER.debug(\"Revoking token [{}]\", token);\n+        getOAuthConfigurationContext().getTicketRegistry().deleteTicket(token);\n+\n+        token.getAccessTokens().forEach(item-> {\n+            LOGGER.debug(\"Revoking Access Token [{}] related to Refresh Token [{}]\", item, token);\n+            getOAuthConfigurationContext().getTicketRegistry().deleteTicket(item);", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNTgzNw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397525837", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-24T23:37:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MTk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MjMyNQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396962325", "bodyText": "All of this is duplicate code. You should simply fetch OAuth20Token from the registry as the type, and then attempt to cast where necessary to the right type.", "author": "mmoayyed", "createdAt": "2020-03-24T08:03:41Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (isServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        if (isAsupportedTokenType(token)) {\n+            return generateRevocationResponse(token, clientId, response);\n+        }\n+        return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+    }\n+\n+    /**\n+     * Generate revocation token response.\n+     *\n+     * @param token the token to revoke\n+     * @param client the client who requests the revocation\n+     * @param response the response\n+     * @return the model and view\n+     */\n+    private ModelAndView generateRevocationResponse(final String token,\n+                                                    final String client,\n+                                                    final HttpServletResponse response) {\n+\n+        if (token.startsWith(OAuth20RefreshToken.PREFIX)) {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20RefreshToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        } else {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20AccessToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNjcwOQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397526709", "bodyText": "Sorry about that...\nI'm still beginning with Java and still not comfortable with some of it's concepts... Hopefully work on CAS helped me a lot and still does ! :)", "author": "julienhuon", "createdAt": "2020-03-24T23:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MjMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNjc4Nw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397526787", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-24T23:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MjMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MjQzMA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396962430", "bodyText": "cast to refresh-token.", "author": "mmoayyed", "createdAt": "2020-03-24T08:03:54Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (isServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        if (isAsupportedTokenType(token)) {\n+            return generateRevocationResponse(token, clientId, response);\n+        }\n+        return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+    }\n+\n+    /**\n+     * Generate revocation token response.\n+     *\n+     * @param token the token to revoke\n+     * @param client the client who requests the revocation\n+     * @param response the response\n+     * @return the model and view\n+     */\n+    private ModelAndView generateRevocationResponse(final String token,\n+                                                    final String client,\n+                                                    final HttpServletResponse response) {\n+\n+        if (token.startsWith(OAuth20RefreshToken.PREFIX)) {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20RefreshToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        } else {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20AccessToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        }\n+\n+        val mv = new ModelAndView(new MappingJackson2JsonView());\n+        mv.setStatus(HttpStatus.OK);\n+        return mv;\n+    }\n+\n+    /**\n+     * Revoke the provided Refresh Token and it's related Access Tokens.\n+     *\n+     * @param token the token\n+     * @return the model and view\n+     */\n+    private void revokeToken(final OAuth20RefreshToken token) {\n+        LOGGER.debug(\"Revoking token [{}]\", token);\n+        getOAuthConfigurationContext().getTicketRegistry().deleteTicket(token);\n+\n+        token.getAccessTokens().forEach(item-> {", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNDM5Mw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397524393", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-24T23:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MjQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MjczNQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396962735", "bodyText": "Also not a good idea. See above. Metadata about what a ticket can or cannot do or support should be attached to the ticket definition itself, if necessary. (Don't think it is, in this case).", "author": "mmoayyed", "createdAt": "2020-03-24T08:04:36Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (isServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        if (isAsupportedTokenType(token)) {\n+            return generateRevocationResponse(token, clientId, response);\n+        }\n+        return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+    }\n+\n+    /**\n+     * Generate revocation token response.\n+     *\n+     * @param token the token to revoke\n+     * @param client the client who requests the revocation\n+     * @param response the response\n+     * @return the model and view\n+     */\n+    private ModelAndView generateRevocationResponse(final String token,\n+                                                    final String client,\n+                                                    final HttpServletResponse response) {\n+\n+        if (token.startsWith(OAuth20RefreshToken.PREFIX)) {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20RefreshToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        } else {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20AccessToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        }\n+\n+        val mv = new ModelAndView(new MappingJackson2JsonView());\n+        mv.setStatus(HttpStatus.OK);\n+        return mv;\n+    }\n+\n+    /**\n+     * Revoke the provided Refresh Token and it's related Access Tokens.\n+     *\n+     * @param token the token\n+     * @return the model and view\n+     */\n+    private void revokeToken(final OAuth20RefreshToken token) {\n+        LOGGER.debug(\"Revoking token [{}]\", token);\n+        getOAuthConfigurationContext().getTicketRegistry().deleteTicket(token);\n+\n+        token.getAccessTokens().forEach(item-> {\n+            LOGGER.debug(\"Revoking Access Token [{}] related to Refresh Token [{}]\", item, token);\n+            getOAuthConfigurationContext().getTicketRegistry().deleteTicket(item);\n+        });\n+    }\n+\n+    /**\n+     * Revoke the provided Access Token.\n+     *\n+     * @param token the token\n+     * @return the model and view\n+     */\n+    private void revokeToken(final OAuth20AccessToken token) {\n+        LOGGER.debug(\"Revoking token [{}]\", token);\n+        getOAuthConfigurationContext().getTicketRegistry().deleteTicket(token);\n+    }\n+\n+    /**\n+     * Verify if the request related token type is supported.\n+     *\n+     * @param token the token\n+     * @return whether the token type is supported\n+     */\n+    private boolean isAsupportedTokenType(final String token) {\n+        return token.startsWith(OAuth20RefreshToken.PREFIX) || token.startsWith(OAuth20AccessToken.PREFIX);", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNDUzNA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397524534", "bodyText": "removed it.", "author": "julienhuon", "createdAt": "2020-03-24T23:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MjczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MzM2OA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396963368", "bodyText": "Duplicate code? Move to OAuthUtils, etc. And switch to isNotBlank", "author": "mmoayyed", "createdAt": "2020-03-24T08:05:49Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (isServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        if (isAsupportedTokenType(token)) {\n+            return generateRevocationResponse(token, clientId, response);\n+        }\n+        return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+    }\n+\n+    /**\n+     * Generate revocation token response.\n+     *\n+     * @param token the token to revoke\n+     * @param client the client who requests the revocation\n+     * @param response the response\n+     * @return the model and view\n+     */\n+    private ModelAndView generateRevocationResponse(final String token,\n+                                                    final String client,\n+                                                    final HttpServletResponse response) {\n+\n+        if (token.startsWith(OAuth20RefreshToken.PREFIX)) {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20RefreshToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        } else {\n+            val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20AccessToken.class);\n+\n+            if (registryToken == null) {\n+                LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+            } else {\n+                if (!StringUtils.equals(client, registryToken.getClientId())) {\n+                    LOGGER.error(\"Provided token [{}] is not related with the service [{}]\", token, client);\n+                    return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+                }\n+                revokeToken(registryToken);\n+            }\n+        }\n+\n+        val mv = new ModelAndView(new MappingJackson2JsonView());\n+        mv.setStatus(HttpStatus.OK);\n+        return mv;\n+    }\n+\n+    /**\n+     * Revoke the provided Refresh Token and it's related Access Tokens.\n+     *\n+     * @param token the token\n+     * @return the model and view\n+     */\n+    private void revokeToken(final OAuth20RefreshToken token) {\n+        LOGGER.debug(\"Revoking token [{}]\", token);\n+        getOAuthConfigurationContext().getTicketRegistry().deleteTicket(token);\n+\n+        token.getAccessTokens().forEach(item-> {\n+            LOGGER.debug(\"Revoking Access Token [{}] related to Refresh Token [{}]\", item, token);\n+            getOAuthConfigurationContext().getTicketRegistry().deleteTicket(item);\n+        });\n+    }\n+\n+    /**\n+     * Revoke the provided Access Token.\n+     *\n+     * @param token the token\n+     * @return the model and view\n+     */\n+    private void revokeToken(final OAuth20AccessToken token) {\n+        LOGGER.debug(\"Revoking token [{}]\", token);\n+        getOAuthConfigurationContext().getTicketRegistry().deleteTicket(token);\n+    }\n+\n+    /**\n+     * Verify if the request related token type is supported.\n+     *\n+     * @param token the token\n+     * @return whether the token type is supported\n+     */\n+    private boolean isAsupportedTokenType(final String token) {\n+        return token.startsWith(OAuth20RefreshToken.PREFIX) || token.startsWith(OAuth20AccessToken.PREFIX);\n+    }\n+\n+    /**\n+     * Gets registered service by client id.\n+     *\n+     * @param clientId the client id\n+     * @return the registered service by client id\n+     */\n+    private OAuthRegisteredService getRegisteredServiceByClientId(final String clientId) {\n+        return OAuth20Utils.getRegisteredOAuthServiceByClientId(getOAuthConfigurationContext().getServicesManager(), clientId);\n+    }\n+\n+    /**\n+     * Verify if the request related service must be authenticated.\n+     *\n+     * @param registeredService the registered service\n+     * @return whether the service need authentication\n+     */\n+    private boolean isServiceNeedAuthentication(final OAuthRegisteredService registeredService) {\n+        return !StringUtils.isBlank(registeredService.getClientSecret());", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNDY2NQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397524665", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-24T23:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MzM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MzY1NQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396963655", "bodyText": "oauthRevocationController.", "author": "mmoayyed", "createdAt": "2020-03-24T08:06:24Z", "path": "support/cas-server-support-oauth/src/main/java/org/apereo/cas/config/CasOAuth20Configuration.java", "diffHunk": "@@ -529,6 +531,15 @@ public OAuth20UserProfileEndpointController profileController() {\n         return new OAuth20UserProfileEndpointController(context);\n     }\n \n+    @ConditionalOnMissingBean(name = \"revocationController\")\n+    @Bean\n+    public OAuth20RevocationEndpointController revocationController() {", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNDczOQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397524739", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-24T23:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MzY1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2NDMzOQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r396964339", "bodyText": "I dont see any of these changes in the OAuth20 variant?", "author": "mmoayyed", "createdAt": "2020-03-24T08:07:52Z", "path": "support/cas-server-support-oidc-core-api/src/main/java/org/apereo/cas/oidc/web/controllers/token/OidcRevocationEndpointController.java", "diffHunk": "@@ -24,52 +18,17 @@\n  * @author Misagh Moayyed\n  * @since 5.2.0\n  */\n-@Slf4j\n-public class OidcRevocationEndpointController extends BaseOAuth20Controller {\n-    public OidcRevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n-        super(oAuthConfigurationContext);\n-    }\n-\n-    /**\n-     * Handle request for revocation.\n-     *\n-     * @param request  the request\n-     * @param response the response\n-     * @return the jwk set\n-     */\n-    @PostMapping(value = '/' + OidcConstants.BASE_OIDC_URL + '/' + OidcConstants.REVOCATION_URL)\n-    public ResponseEntity<String> handleRequestInternal(final HttpServletRequest request,\n-                                                        final HttpServletResponse response) {\n-        try {\n-            val authExtractor = new BasicAuthExtractor();\n-            val credentialsResult = authExtractor.extract(new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore()));\n-            if (credentialsResult.isEmpty()) {\n-                throw new IllegalArgumentException(\"No credentials are provided to verify revocation of the token\");\n-            }\n+public class OidcRevocationEndpointController extends OAuth20RevocationEndpointController {\n \n-            val credentials = credentialsResult.get();\n-            val registeredService = OAuth20Utils.getRegisteredOAuthServiceByClientId(\n-                getOAuthConfigurationContext().getServicesManager(),\n-                credentials.getUsername());\n-            val service = getOAuthConfigurationContext().getWebApplicationServiceServiceFactory().createService(registeredService.getServiceId());\n-\n-            val audit = AuditableContext.builder()\n-                .service(service)\n-                .registeredService(registeredService)\n-                .build();\n-            val accessResult = getOAuthConfigurationContext().getRegisteredServiceAccessStrategyEnforcer().execute(audit);", "originalCommit": "fcc81e75d0d81d31b73a7434ce54accb38ca448a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2NTEyOA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r397465128", "bodyText": "You're right I forgot the audit, will add it soon.", "author": "julienhuon", "createdAt": "2020-03-24T21:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2NDMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgwNTYxMw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r399805613", "bodyText": "Just added it for public/passwordless clients only because this \"RegisteredServiceAccessStrategyEnforcer\" kind of audit log is already added for confidential clients by the OAuth20ClientIdClientSecretAuthenticator.\nI think we could add a RevocationTokenResponseAuditResourceResolver or something like that in a future evolution ?", "author": "julienhuon", "createdAt": "2020-03-29T14:29:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2NDMzOQ=="}], "type": "inlineReview"}, {"oid": "a3bf9682f632b0bef692771ee38d29158e2593ea", "url": "https://github.com/apereo/cas/commit/a3bf9682f632b0bef692771ee38d29158e2593ea", "message": "add clientId in the log message.", "committedDate": "2020-03-24T21:20:23Z", "type": "commit"}, {"oid": "b72e0db37f3bf872a31b83102e9611213ff25eb3", "url": "https://github.com/apereo/cas/commit/b72e0db37f3bf872a31b83102e9611213ff25eb3", "message": "Style, avoiding duplication & improvements.", "committedDate": "2020-03-24T23:31:36Z", "type": "commit"}, {"oid": "0718dd4808e30990fbb27bc53837b3a3389cdea0", "url": "https://github.com/apereo/cas/commit/0718dd4808e30990fbb27bc53837b3a3389cdea0", "message": "removed unnecessary parenthesis.", "committedDate": "2020-03-24T23:54:58Z", "type": "commit"}, {"oid": "edeade91c20314858a81ba51763ddd6d6cebcba3", "url": "https://github.com/apereo/cas/commit/edeade91c20314858a81ba51763ddd6d6cebcba3", "message": "fix checkstyle", "committedDate": "2020-03-25T06:50:28Z", "type": "commit"}, {"oid": "cc6a83761ee10e7a9fced4b17a21e111c9434c4c", "url": "https://github.com/apereo/cas/commit/cc6a83761ee10e7a9fced4b17a21e111c9434c4c", "message": "Add revocation endpoint unit tests.", "committedDate": "2020-03-28T17:06:18Z", "type": "commit"}, {"oid": "82f84320a751e86d571fff5e3decc98c1ee1055f", "url": "https://github.com/apereo/cas/commit/82f84320a751e86d571fff5e3decc98c1ee1055f", "message": "Add revocation endpoint in OAuth Doc.", "committedDate": "2020-03-28T21:27:23Z", "type": "commit"}, {"oid": "bebf1e022129a50fb565046be04bc81c65e08b54", "url": "https://github.com/apereo/cas/commit/bebf1e022129a50fb565046be04bc81c65e08b54", "message": "Add audit for passwordless clients.", "committedDate": "2020-03-29T14:19:24Z", "type": "commit"}, {"oid": "5640a15dcfc11eff62a3ae8983e0797aa3e635d5", "url": "https://github.com/apereo/cas/commit/5640a15dcfc11eff62a3ae8983e0797aa3e635d5", "message": "Use oAuthSessionStore in HandlerInterceptor.", "committedDate": "2020-03-29T15:32:45Z", "type": "commit"}, {"oid": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "url": "https://github.com/apereo/cas/commit/dd24ba6f6c313099f34a770aa3416c7e3c951606", "message": "fix style OIDC Handler Interceptor.", "committedDate": "2020-03-29T18:23:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5NzcxMA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r399997710", "bodyText": "Move the constant next to all other URLs; Keep a consistent order as much as possible, and help the next reader.", "author": "mmoayyed", "createdAt": "2020-03-30T08:03:25Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/OAuth20Constants.java", "diffHunk": "@@ -345,4 +345,8 @@\n      */\n     String UNAUTHORIZED_CLIENT = \"unauthorized_client\";\n \n+    /**\n+     * The revocation url.\n+     */\n+    String REVOCATION_URL = \"revoke\";", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0OTIzMg==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400349232", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-30T17:00:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5NzcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5ODI1Ng==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r399998256", "bodyText": "If the token is blank you don't need to check/fetch the client-id. Return false immediately, and marginally help with performance.", "author": "mmoayyed", "createdAt": "2020-03-30T08:04:25Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/validator/token/OAuth20RevocationRequestValidator.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package org.apereo.cas.support.oauth.validator.token;\n+\n+import org.apereo.cas.services.ServicesManager;\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.springframework.core.Ordered;\n+\n+/**\n+ * This is {@link OAuth20RevocationRequestValidator}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@RequiredArgsConstructor\n+@Slf4j\n+@Getter\n+@Setter\n+public class OAuth20RevocationRequestValidator implements OAuth20TokenRequestValidator {\n+    private final ServicesManager servicesManager;\n+\n+    private int order = Ordered.LOWEST_PRECEDENCE;\n+\n+    @Override\n+    public boolean validate(final JEEContext context) {\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = OAuth20Utils.getRegisteredOAuthServiceByClientId(this.servicesManager, clientId);\n+\n+        if (registeredService == null) {\n+            LOGGER.warn(\"Provided client id [{}] cannot be matched against a service definition\", clientId);\n+            return false;\n+        }\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean supports(final JEEContext context) {\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0OTM0Mg==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400349342", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-30T17:00:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5ODI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5ODgxOA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r399998818", "bodyText": "If client-id is undefined, return immediately and do not look up the service in registry.", "author": "mmoayyed", "createdAt": "2020-03-30T08:05:26Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/OAuth20HandlerInterceptorAdapter.java", "diffHunk": "@@ -48,6 +56,34 @@ public boolean preHandle(final HttpServletRequest request, final HttpServletResp\n         return !isAuthorizationRequest(request, response) || requiresAuthenticationAuthorizeInterceptor.preHandle(request, response, handler);\n     }\n \n+    /**\n+    * Is the client requesting is a OAuth \"public\" client?\n+    * An OAuth \"public\" client is one that does not define a secret like a mobile application.\n+    *\n+    * @param request the request\n+    * @param response the response\n+    * @return the boolean\n+    */\n+    protected boolean clientNeedAuthentication(final HttpServletRequest request, final HttpServletResponse response) {\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(new JEEContext(request, response, sessionStore)).getLeft();\n+        val registeredService = OAuth20Utils.getRegisteredOAuthServiceByClientId(servicesManager, clientId);", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0OTQ4Ng==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400349486", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-30T17:00:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5ODgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5OTYwOQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r399999609", "bodyText": "This likely should be a warn.", "author": "mmoayyed", "createdAt": "2020-03-30T08:06:52Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,194 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.audit.AuditableContext;\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.OAuth20Token;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (OAuth20Utils.doesServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0OTU1Mg==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400349552", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-30T17:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5OTYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMDEwOQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400000109", "bodyText": "Audit checks should always execute. Don't think you need to put these lines in an else clause.", "author": "mmoayyed", "createdAt": "2020-03-30T08:07:43Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,194 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.audit.AuditableContext;\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.OAuth20Token;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (OAuth20Utils.doesServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        } else {\n+            val service = getOAuthConfigurationContext().getWebApplicationServiceServiceFactory().createService(registeredService.getServiceId());\n+\n+            val audit = AuditableContext.builder()\n+                .service(service)\n+                .registeredService(registeredService)\n+                .build();\n+\n+            val accessResult = getOAuthConfigurationContext().getRegisteredServiceAccessStrategyEnforcer().execute(audit);\n+            if (accessResult.isExecutionFailure()) {\n+                return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+            }", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA1ODU4OQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400058589", "bodyText": "When the request is executed by a confidential client, the exact same audit log is provided by the OAuth20ClientIdClientSecret Authenticator.\nSo I don't think I should remove it form the else. But it's up to you.\nI think we could add a RevocationTokenResponseAuditResourceResolver or something like that in a future evolution ?", "author": "julienhuon", "createdAt": "2020-03-30T09:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMDEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ1Nzg1NQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400457855", "bodyText": "Makes sense, sure.\nAnd yes, sure; RevocationTokenResponseAuditResourceResolver would be a good idea in the next PR.", "author": "mmoayyed", "createdAt": "2020-03-30T20:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMDEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMDU1Ng==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400000556", "bodyText": "Replace all with HttpUtils#createBasicAuthHeaders", "author": "mmoayyed", "createdAt": "2020-03-30T08:08:27Z", "path": "support/cas-server-support-oauth/src/test/java/org/apereo/cas/support/oauth/validator/token/OAuth20RevocationRequestValidatorTests.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package org.apereo.cas.support.oauth.validator.token;\n+\n+import org.apereo.cas.services.RegisteredServiceTestUtils;\n+import org.apereo.cas.services.ServicesManager;\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.OAuth20GrantTypes;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+import org.apereo.cas.ticket.registry.TicketRegistry;\n+import org.apereo.cas.util.CollectionUtils;\n+import org.apereo.cas.util.EncodingUtils;\n+\n+import lombok.val;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.pac4j.core.context.JEEContext;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+import org.springframework.mock.web.MockHttpServletResponse;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+import static org.mockito.Mockito.*;\n+\n+/**\n+ * This is {@link OAuth20RevocationRequestValidatorTests}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Tag(\"OAuth\")\n+public class OAuth20RevocationRequestValidatorTests {\n+    private static final String SUPPORTING_SERVICE_TICKET = \"RT-SUPPORTING\";\n+\n+    private TicketRegistry ticketRegistry;\n+    private OAuth20TokenRequestValidator validator;\n+\n+    private void registerTicket(final String name) {\n+        val oauthCode = mock(OAuth20RefreshToken.class);\n+        when(oauthCode.getId()).thenReturn(name);\n+        when(oauthCode.isExpired()).thenReturn(false);\n+        when(oauthCode.getAuthentication()).thenReturn(RegisteredServiceTestUtils.getAuthentication());\n+        when(ticketRegistry.getTicket(eq(name))).thenReturn(oauthCode);\n+    }\n+\n+    @BeforeEach\n+    public void before() {\n+        val servicesManager = mock(ServicesManager.class);\n+\n+        val supportingService = RequestValidatorTestUtils.getService(\n+            RegisteredServiceTestUtils.CONST_TEST_URL,\n+            RequestValidatorTestUtils.SUPPORTING_CLIENT_ID,\n+            RequestValidatorTestUtils.SUPPORTING_CLIENT_ID,\n+            RequestValidatorTestUtils.SHARED_SECRET,\n+            CollectionUtils.wrapSet(OAuth20GrantTypes.REFRESH_TOKEN));\n+        when(servicesManager.getAllServices()).thenReturn(CollectionUtils.wrapList(supportingService));\n+\n+        this.ticketRegistry = mock(TicketRegistry.class);\n+\n+        registerTicket(SUPPORTING_SERVICE_TICKET);\n+\n+        this.validator = new OAuth20RevocationRequestValidator(servicesManager);\n+    }\n+\n+    @Test\n+    public void verifyOperationClientSecretPost() {\n+        val request = new MockHttpServletRequest();\n+        val response = new MockHttpServletResponse();\n+\n+        request.setParameter(OAuth20Constants.CLIENT_ID, RequestValidatorTestUtils.SUPPORTING_CLIENT_ID);\n+        request.setParameter(OAuth20Constants.CLIENT_SECRET, RequestValidatorTestUtils.SHARED_SECRET);\n+        request.setParameter(OAuth20Constants.TOKEN, SUPPORTING_SERVICE_TICKET);\n+\n+        assertTrue(this.validator.validate(new JEEContext(request, response)));\n+\n+        request.removeAllParameters();\n+        request.setParameter(OAuth20Constants.CLIENT_ID, RequestValidatorTestUtils.SUPPORTING_CLIENT_ID);\n+        request.setParameter(OAuth20Constants.CLIENT_SECRET, RequestValidatorTestUtils.SHARED_SECRET);\n+        assertFalse(this.validator.supports(new JEEContext(request, response)));\n+\n+        request.removeAllParameters();\n+        request.setParameter(OAuth20Constants.CLIENT_ID, RequestValidatorTestUtils.NON_SUPPORTING_CLIENT_ID);\n+        request.setParameter(OAuth20Constants.CLIENT_SECRET, RequestValidatorTestUtils.SHARED_SECRET);\n+        request.setParameter(OAuth20Constants.TOKEN, SUPPORTING_SERVICE_TICKET);\n+        assertFalse(this.validator.validate(new JEEContext(request, response)));\n+    }\n+\n+    @Test\n+    public void verifyOperationClientSecretBasic() {\n+        val request = new MockHttpServletRequest();\n+        val response = new MockHttpServletResponse();\n+\n+        request.addHeader(\"Authorization\",\n+                          \"Basic \" + EncodingUtils.encodeBase64(RequestValidatorTestUtils.SUPPORTING_CLIENT_ID + \":\" + RequestValidatorTestUtils.SHARED_SECRET));\n+        request.setParameter(OAuth20Constants.TOKEN, SUPPORTING_SERVICE_TICKET);\n+        assertTrue(this.validator.validate(new JEEContext(request, response)));\n+\n+\n+        request.removeHeader(\"Authorization\");\n+        request.removeAllParameters();\n+        request.addHeader(\"Authorization\",\n+                          \"Basic \" + EncodingUtils.encodeBase64(RequestValidatorTestUtils.SUPPORTING_CLIENT_ID + \":\" + RequestValidatorTestUtils.SHARED_SECRET));", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1NjcwOA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400356708", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-30T17:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMDU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMTI1NA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400001254", "bodyText": "Fix typo.", "author": "mmoayyed", "createdAt": "2020-03-30T08:09:29Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/OAuth20HandlerInterceptorAdapter.java", "diffHunk": "@@ -48,6 +56,34 @@ public boolean preHandle(final HttpServletRequest request, final HttpServletResp\n         return !isAuthorizationRequest(request, response) || requiresAuthenticationAuthorizeInterceptor.preHandle(request, response, handler);\n     }\n \n+    /**\n+    * Is the client requesting is a OAuth \"public\" client?\n+    * An OAuth \"public\" client is one that does not define a secret like a mobile application.\n+    *\n+    * @param request the request\n+    * @param response the response\n+    * @return the boolean\n+    */\n+    protected boolean clientNeedAuthentication(final HttpServletRequest request, final HttpServletResponse response) {\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(new JEEContext(request, response, sessionStore)).getLeft();\n+        val registeredService = OAuth20Utils.getRegisteredOAuthServiceByClientId(servicesManager, clientId);\n+        if (clientId.isEmpty() || registeredService == null) {\n+            return true;\n+        }\n+        return OAuth20Utils.doesServiceNeedAuthentication(registeredService);\n+    }\n+\n+    /**\n+     * Is revoke token request request?", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1NzU4Ng==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400357586", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-30T17:14:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMTI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMTY3MQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400001671", "bodyText": "Move this call down to around like 128.", "author": "mmoayyed", "createdAt": "2020-03-30T08:10:08Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/OAuth20HandlerInterceptorAdapter.java", "diffHunk": "@@ -84,6 +120,12 @@ protected boolean isDeviceTokenRequest(final HttpServletRequest request, final H\n      */\n     protected boolean requestRequiresAuthentication(final HttpServletRequest request, final HttpServletResponse response) {\n         val accessTokenRequest = isAccessTokenRequest(request, response);", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1OTYxMQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400359611", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-30T17:17:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMTY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMTg1NA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400001854", "bodyText": "This likely should be a warn.", "author": "mmoayyed", "createdAt": "2020-03-30T08:10:29Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,194 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.audit.AuditableContext;\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.OAuth20Token;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0Mjg5NA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400342894", "bodyText": "Are you sure?\nAll the other endpoints are raising an error when the request verification failed. For example:\nAuthorize Endpoint:\nif (!verifyAuthorizeRequest(context) || !isRequestAuthenticated(manager)) {\n            LOGGER.error(\"Authorize request verification failed. Authorization request is missing required parameters, \"\n                + \"or the request is not authenticated and contains no authenticated profile/principal.\");\n            return OAuth20Utils.produceUnauthorizedErrorView();\n        }\n\nAccessToken Endpoint:\n            if (!verifyAccessTokenRequest(request, response)) {\n                throw new IllegalArgumentException(\"Access token validation failed\");\n            }", "author": "julienhuon", "createdAt": "2020-03-30T16:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMTg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ1Njk0OA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400456948", "bodyText": "Sounds good, let's keep things consistent then. Thanks!", "author": "mmoayyed", "createdAt": "2020-03-30T19:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMTg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMjE3MA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400002170", "bodyText": "This likely should be a warn.", "author": "mmoayyed", "createdAt": "2020-03-30T08:11:02Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,194 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.audit.AuditableContext;\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.OAuth20Token;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (OAuth20Utils.doesServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        } else {\n+            val service = getOAuthConfigurationContext().getWebApplicationServiceServiceFactory().createService(registeredService.getServiceId());\n+\n+            val audit = AuditableContext.builder()\n+                .service(service)\n+                .registeredService(registeredService)\n+                .build();\n+\n+            val accessResult = getOAuthConfigurationContext().getRegisteredServiceAccessStrategyEnforcer().execute(audit);\n+            if (accessResult.isExecutionFailure()) {\n+                return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        return generateRevocationResponse(token, clientId, response);\n+    }\n+\n+    /**\n+     * Generate revocation token response.\n+     *\n+     * @param token the token to revoke\n+     * @param clientId the client who requests the revocation\n+     * @param response the response\n+     * @return the model and view\n+     */\n+    protected ModelAndView generateRevocationResponse(final String token,\n+                                                      final String clientId,\n+                                                      final HttpServletResponse response) {\n+\n+        val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20Token.class);\n+\n+        if (registryToken == null) {\n+            LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+        } else if (isRefreshToken(registryToken) || isAccessToken(registryToken)) {\n+            if (!StringUtils.equals(clientId, registryToken.getClientId())) {\n+                LOGGER.error(\"Provided token [{}] has not been issued for the service [{}]\", token, clientId);", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1OTg3Nw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400359877", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-30T17:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMjE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMzIxMA==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400003210", "bodyText": "I think doing calls directly specially with the JPA ticket registry fails with a transaction-required error. Do you think you might be able to verify this?", "author": "mmoayyed", "createdAt": "2020-03-30T08:12:50Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointController.java", "diffHunk": "@@ -0,0 +1,194 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.audit.AuditableContext;\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.services.OAuthRegisteredService;\n+import org.apereo.cas.support.oauth.util.OAuth20Utils;\n+import org.apereo.cas.ticket.OAuth20Token;\n+import org.apereo.cas.ticket.accesstoken.OAuth20AccessToken;\n+import org.apereo.cas.ticket.refreshtoken.OAuth20RefreshToken;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.pac4j.core.context.JEEContext;\n+import org.pac4j.core.profile.CommonProfile;\n+import org.pac4j.core.profile.ProfileManager;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.view.json.MappingJackson2JsonView;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * This is {@link OAuth20RevocationEndpointController}.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Slf4j\n+public class OAuth20RevocationEndpointController extends BaseOAuth20Controller {\n+    public OAuth20RevocationEndpointController(final OAuth20ConfigurationContext oAuthConfigurationContext) {\n+        super(oAuthConfigurationContext);\n+    }\n+\n+    /**\n+     * Handle request for revocation.\n+     *\n+     * @param request  the request\n+     * @param response the response\n+     * @return the response entity\n+     */\n+    @PostMapping(path = '/' + OAuth20Constants.BASE_OAUTH20_URL + '/' + OAuth20Constants.REVOCATION_URL,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    public ModelAndView handleRequest(final HttpServletRequest request,\n+                                      final HttpServletResponse response) {\n+        val context = new JEEContext(request, response, getOAuthConfigurationContext().getSessionStore());\n+\n+        if (!verifyRevocationRequest(context)) {\n+            LOGGER.error(\"Revocation request verification failed. Request is missing required parameters\");\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val manager = new ProfileManager<CommonProfile>(context, context.getSessionStore());\n+        val clientId = OAuth20Utils.getClientIdAndClientSecret(context).getLeft();\n+        val registeredService = getRegisteredServiceByClientId(clientId);\n+\n+        if (OAuth20Utils.doesServiceNeedAuthentication(registeredService)) {\n+            if (manager.get(true).isEmpty()) {\n+                LOGGER.error(\"Service [{}] requests authentication\", clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.ACCESS_DENIED);\n+            }\n+        } else {\n+            val service = getOAuthConfigurationContext().getWebApplicationServiceServiceFactory().createService(registeredService.getServiceId());\n+\n+            val audit = AuditableContext.builder()\n+                .service(service)\n+                .registeredService(registeredService)\n+                .build();\n+\n+            val accessResult = getOAuthConfigurationContext().getRegisteredServiceAccessStrategyEnforcer().execute(audit);\n+            if (accessResult.isExecutionFailure()) {\n+                return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+            }\n+        }\n+        val token = context.getRequestParameter(OAuth20Constants.TOKEN)\n+            .map(String::valueOf).orElse(StringUtils.EMPTY);\n+\n+        return generateRevocationResponse(token, clientId, response);\n+    }\n+\n+    /**\n+     * Generate revocation token response.\n+     *\n+     * @param token the token to revoke\n+     * @param clientId the client who requests the revocation\n+     * @param response the response\n+     * @return the model and view\n+     */\n+    protected ModelAndView generateRevocationResponse(final String token,\n+                                                      final String clientId,\n+                                                      final HttpServletResponse response) {\n+\n+        val registryToken = getOAuthConfigurationContext().getTicketRegistry().getTicket(token, OAuth20Token.class);\n+\n+        if (registryToken == null) {\n+            LOGGER.error(\"Provided token [{}] has not been found in the ticket registry\", token);\n+        } else if (isRefreshToken(registryToken) || isAccessToken(registryToken)) {\n+            if (!StringUtils.equals(clientId, registryToken.getClientId())) {\n+                LOGGER.error(\"Provided token [{}] has not been issued for the service [{}]\", token, clientId);\n+                return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+            }\n+\n+            if (isRefreshToken(registryToken)) {\n+                revokeToken((OAuth20RefreshToken) registryToken);\n+            } else {\n+                revokeToken(registryToken.getId());\n+            }\n+        } else {\n+            LOGGER.error(\"Provided token [{}] is either not a refresh token or not an access token\", token);\n+            return OAuth20Utils.writeError(response, OAuth20Constants.INVALID_REQUEST);\n+        }\n+\n+        val mv = new ModelAndView(new MappingJackson2JsonView());\n+        mv.setStatus(HttpStatus.OK);\n+        return mv;\n+    }\n+\n+    /**\n+     * Revoke the provided Refresh Token and it's related Access Tokens.\n+     *\n+     * @param token the token\n+     * @return the model and view\n+     */\n+    private void revokeToken(final OAuth20RefreshToken token) {\n+        revokeToken(token.getId());\n+\n+        token.getAccessTokens().forEach(item-> {\n+            revokeToken(item);\n+        });\n+    }\n+\n+    /**\n+     * Revoke the provided OAuth Token.\n+     *\n+     * @param token the token\n+     * @return the model and view\n+     */\n+    private void revokeToken(final String token) {\n+        LOGGER.debug(\"Revoking token [{}]\", token);\n+        getOAuthConfigurationContext().getTicketRegistry().deleteTicket(token);\n+    }", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NDE0Nw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400064147", "bodyText": "I didn't tested it with JPA (only with Redis) but it's exactly the same revocation process than the old one.\nWill test it to be sure.", "author": "julienhuon", "createdAt": "2020-03-30T09:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMzIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE4MzE1Ng==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400183156", "bodyText": "OK, thanks. Let's leave it aside for now. I can try to help in this area too.", "author": "mmoayyed", "createdAt": "2020-03-30T13:18:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMzIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNTM1Mw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400005353", "bodyText": "Clean up protected static OAuthRegisteredService getRegisteredService(final String serviceId,                                                                 final String secret, final Set<OAuth20GrantTypes> grantTypes) {} to avoid duplicate code.", "author": "mmoayyed", "createdAt": "2020-03-30T08:16:22Z", "path": "support/cas-server-support-oauth/src/test/java/org/apereo/cas/support/oauth/web/AbstractOAuth20Tests.java", "diffHunk": "@@ -321,6 +321,21 @@ protected static OAuthRegisteredService getRegisteredService(final String servic\n         return registeredServiceImpl;\n     }\n \n+    protected static OAuthRegisteredService getRegisteredService(final String serviceId,", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM2MDYyNQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400360625", "bodyText": "Right. Hope my future PRs will produce you less work...", "author": "julienhuon", "createdAt": "2020-03-30T17:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNTM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNTg1Mw==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400005853", "bodyText": "Make private?", "author": "mmoayyed", "createdAt": "2020-03-30T08:17:17Z", "path": "support/cas-server-support-oauth/src/test/java/org/apereo/cas/support/oauth/web/endpoints/OAuth20RevocationEndpointControllerTests.java", "diffHunk": "@@ -0,0 +1,233 @@\n+package org.apereo.cas.support.oauth.web.endpoints;\n+\n+import org.apereo.cas.support.oauth.OAuth20Constants;\n+import org.apereo.cas.support.oauth.web.AbstractOAuth20Tests;\n+\n+import lombok.val;\n+import org.apache.commons.lang3.StringUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.HttpMethod;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+import org.springframework.mock.web.MockHttpServletResponse;\n+\n+import java.util.HashSet;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+/**\n+ * This class tests the {@link OAuth20RevocationEndpointController} class.\n+ *\n+ * @author Julien Huon\n+ * @since 6.2.0\n+ */\n+@Tag(\"OAuth\")\n+public class OAuth20RevocationEndpointControllerTests extends AbstractOAuth20Tests {\n+\n+    public static final String PUBLIC_CLIENT_ID = \"clientWithoutSecret\";", "originalCommit": "dd24ba6f6c313099f34a770aa3416c7e3c951606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM2MDczOQ==", "url": "https://github.com/apereo/cas/pull/4771#discussion_r400360739", "bodyText": "Done.", "author": "julienhuon", "createdAt": "2020-03-30T17:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNTg1Mw=="}], "type": "inlineReview"}, {"oid": "b9cf10fe83866d6e06eefea930cf2ed94e2c4c38", "url": "https://github.com/apereo/cas/commit/b9cf10fe83866d6e06eefea930cf2ed94e2c4c38", "message": "Improvements, optimisations and fix.", "committedDate": "2020-03-30T17:48:44Z", "type": "commit"}, {"oid": "e21e9489203b2dfd2298621f1061114bff0063c7", "url": "https://github.com/apereo/cas/commit/e21e9489203b2dfd2298621f1061114bff0063c7", "message": "Merge branch 'master' into revokep2", "committedDate": "2020-03-30T21:33:20Z", "type": "commit"}]}