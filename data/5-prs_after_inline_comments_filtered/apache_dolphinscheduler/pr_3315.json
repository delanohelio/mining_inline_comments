{"pr_number": 3315, "pr_title": "add feature : query top n success process instance order by running duration", "pr_createdAt": "2020-07-27T02:55:19Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/3315", "timeline": [{"oid": "6d3c4378e9c850b7abbaebf7a29b49cf5ec48f3e", "url": "https://github.com/apache/dolphinscheduler/commit/6d3c4378e9c850b7abbaebf7a29b49cf5ec48f3e", "message": "add feature : query top n success process instance order by running duration", "committedDate": "2020-07-27T02:50:54Z", "type": "commit"}, {"oid": "05cd5f5bcb85dfbaa8fe350f0c85b92b2576a63a", "url": "https://github.com/apache/dolphinscheduler/commit/05cd5f5bcb85dfbaa8fe350f0c85b92b2576a63a", "message": "add feature : add params check", "committedDate": "2020-07-27T03:25:49Z", "type": "commit"}, {"oid": "8970b544854320deac83f64afdb7c3249d4ac335", "url": "https://github.com/apache/dolphinscheduler/commit/8970b544854320deac83f64afdb7c3249d4ac335", "message": "add feature : remove code smell", "committedDate": "2020-07-27T10:39:58Z", "type": "commit"}, {"oid": "fcb6999dd9d20e5126811bfea4865444d1261bdf", "url": "https://github.com/apache/dolphinscheduler/commit/fcb6999dd9d20e5126811bfea4865444d1261bdf", "message": "add feature : remove code smell", "committedDate": "2020-07-27T11:53:00Z", "type": "commit"}, {"oid": "333add157d16d5667d0d7298091a25f2a24f2d84", "url": "https://github.com/apache/dolphinscheduler/commit/333add157d16d5667d0d7298091a25f2a24f2d84", "message": "add feature : add param check", "committedDate": "2020-07-27T12:04:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg1MDY4Ng==", "url": "https://github.com/apache/dolphinscheduler/pull/3315#discussion_r460850686", "bodyText": "You should improve the handleEscapes method, this is a historical problem.  like this:return inputString.replace(\"%\", \"////%\").replaceAll(\"[\\n|\\r|\\t]\", \"_\");", "author": "CalvinKirs", "createdAt": "2020-07-27T12:22:24Z", "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/controller/ProcessInstanceController.java", "diffHunk": "@@ -204,6 +205,29 @@ public Result queryProcessInstanceById(@ApiIgnore @RequestAttribute(value = Cons\n         return returnDataList(result);\n     }\n \n+    @ApiOperation(value = \"queryTopNLongestRunningProcessInstance\", notes = \"QUERY_TOPN_LONGEST_RUNNING_PROCESS_INSTANCE_NOTES\")\n+    @ApiImplicitParams({\n+            @ApiImplicitParam(name = \"size\", value = \"PROCESS_INSTANCE_SIZE\", dataType = \"Int\", example = \"10\"),\n+            @ApiImplicitParam(name = \"startTime\", value = \"PROCESS_INSTANCE_START_TIME\", dataType = \"String\"),\n+            @ApiImplicitParam(name = \"endTime\", value = \"PROCESS_INSTANCE_END_TIME\", dataType = \"String\"),\n+    })\n+    @GetMapping(value = \"/top-n\")\n+    @ResponseStatus(HttpStatus.OK)\n+    @ApiException(QUERY_PROCESS_INSTANCE_BY_ID_ERROR)\n+    public Result<ProcessInstance> queryTopNLongestRunningProcessInstance(@ApiIgnore @RequestAttribute(value = Constants.SESSION_USER) User loginUser,\n+                                                         @ApiParam(name = \"projectName\", value = \"PROJECT_NAME\", required = true) @PathVariable String projectName,\n+                                                         @RequestParam(\"size\") Integer size,\n+                                                         @RequestParam(value = \"startTime\",required = true) String startTime,\n+                                                         @RequestParam(value = \"endTime\",required = true) String endTime\n+\n+    ){\n+        projectName=projectName.replaceAll(\"[\\n|\\r\\t]\", \"_\");", "originalCommit": "333add157d16d5667d0d7298091a25f2a24f2d84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a5d0557bf30ee757e0c259a4aedc650ac37f4fd4", "url": "https://github.com/apache/dolphinscheduler/commit/a5d0557bf30ee757e0c259a4aedc650ac37f4fd4", "message": "add feature : add param check\nimprove handleEscape method in ParameterUtils.java", "committedDate": "2020-07-27T12:27:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIzODcyMg==", "url": "https://github.com/apache/dolphinscheduler/pull/3315#discussion_r462238722", "bodyText": "Hi,\nIt will be better to add the java docs like[1] here. can you do it?\n[1]", "author": "yangyichao-mango", "createdAt": "2020-07-29T11:48:52Z", "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/controller/ProcessInstanceController.java", "diffHunk": "@@ -204,6 +205,29 @@ public Result queryProcessInstanceById(@ApiIgnore @RequestAttribute(value = Cons\n         return returnDataList(result);\n     }\n \n+    @ApiOperation(value = \"queryTopNLongestRunningProcessInstance\", notes = \"QUERY_TOPN_LONGEST_RUNNING_PROCESS_INSTANCE_NOTES\")", "originalCommit": "a5d0557bf30ee757e0c259a4aedc650ac37f4fd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI1MzQzNg==", "url": "https://github.com/apache/dolphinscheduler/pull/3315#discussion_r462253436", "bodyText": "ok , I will do it in next commit", "author": "RedemptionC", "createdAt": "2020-07-29T12:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIzODcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MDE3MA==", "url": "https://github.com/apache/dolphinscheduler/pull/3315#discussion_r462240170", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Date end=DateUtils.stringToDate(endTime);\n          \n          \n            \n                    Date end = DateUtils.stringToDate(endTime);", "author": "yangyichao-mango", "createdAt": "2020-07-29T11:51:35Z", "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ProcessInstanceService.java", "diffHunk": "@@ -98,6 +98,53 @@\n     @Autowired\n     UsersService usersService;\n \n+    /**\n+     * return top n SUCCESS process instance order by running time which started between startTime and endTime\n+     * @param loginUser\n+     * @param projectName\n+     * @param size\n+     * @param startTime\n+     * @param endTime\n+     * @return\n+     */\n+    public Map<String, Object> queryTopNLongestRunningProcessInstance(User loginUser,String projectName,int size, String startTime, String endTime) {\n+        Map<String, Object> result = new HashMap<>();\n+\n+        Project project = projectMapper.queryByName(projectName);\n+        Map<String, Object> checkResult = projectService.checkProjectAndAuth(loginUser, project, projectName);\n+        Status resultEnum = (Status) checkResult.get(Constants.STATUS);\n+        if (resultEnum != Status.SUCCESS) {\n+            return checkResult;\n+        }\n+\n+        if (0 > size) {\n+            putMsg(result, Status.NEGTIVE_SIZE_NUMBER_ERROR, size);\n+            return result;\n+        }\n+        if (Objects.isNull(startTime)) {\n+            putMsg(result, Status.DATA_IS_NULL, Constants.START_TIME);\n+            return result;\n+        }\n+        Date start=DateUtils.stringToDate(startTime);\n+        if (Objects.isNull(endTime)) {\n+            putMsg(result, Status.DATA_IS_NULL, Constants.END_TIME);\n+            return result;\n+        }\n+        Date end=DateUtils.stringToDate(endTime);", "originalCommit": "a5d0557bf30ee757e0c259a4aedc650ac37f4fd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MDMwNw==", "url": "https://github.com/apache/dolphinscheduler/pull/3315#discussion_r462240307", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Date start=DateUtils.stringToDate(startTime);\n          \n          \n            \n                    Date start = DateUtils.stringToDate(startTime);", "author": "yangyichao-mango", "createdAt": "2020-07-29T11:51:51Z", "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ProcessInstanceService.java", "diffHunk": "@@ -98,6 +98,53 @@\n     @Autowired\n     UsersService usersService;\n \n+    /**\n+     * return top n SUCCESS process instance order by running time which started between startTime and endTime\n+     * @param loginUser\n+     * @param projectName\n+     * @param size\n+     * @param startTime\n+     * @param endTime\n+     * @return\n+     */\n+    public Map<String, Object> queryTopNLongestRunningProcessInstance(User loginUser,String projectName,int size, String startTime, String endTime) {\n+        Map<String, Object> result = new HashMap<>();\n+\n+        Project project = projectMapper.queryByName(projectName);\n+        Map<String, Object> checkResult = projectService.checkProjectAndAuth(loginUser, project, projectName);\n+        Status resultEnum = (Status) checkResult.get(Constants.STATUS);\n+        if (resultEnum != Status.SUCCESS) {\n+            return checkResult;\n+        }\n+\n+        if (0 > size) {\n+            putMsg(result, Status.NEGTIVE_SIZE_NUMBER_ERROR, size);\n+            return result;\n+        }\n+        if (Objects.isNull(startTime)) {\n+            putMsg(result, Status.DATA_IS_NULL, Constants.START_TIME);\n+            return result;\n+        }\n+        Date start=DateUtils.stringToDate(startTime);", "originalCommit": "a5d0557bf30ee757e0c259a4aedc650ac37f4fd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MDQzNQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3315#discussion_r462240435", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public Map<String, Object> queryTopNLongestRunningProcessInstance(User loginUser,String projectName,int size, String startTime, String endTime) {\n          \n          \n            \n                public Map<String, Object> queryTopNLongestRunningProcessInstance(User loginUser, String projectName, int size, String startTime, String endTime) {", "author": "yangyichao-mango", "createdAt": "2020-07-29T11:52:08Z", "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ProcessInstanceService.java", "diffHunk": "@@ -98,6 +98,53 @@\n     @Autowired\n     UsersService usersService;\n \n+    /**\n+     * return top n SUCCESS process instance order by running time which started between startTime and endTime\n+     * @param loginUser\n+     * @param projectName\n+     * @param size\n+     * @param startTime\n+     * @param endTime\n+     * @return\n+     */\n+    public Map<String, Object> queryTopNLongestRunningProcessInstance(User loginUser,String projectName,int size, String startTime, String endTime) {", "originalCommit": "a5d0557bf30ee757e0c259a4aedc650ac37f4fd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MDcyMQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3315#discussion_r462240721", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String START_TIME=\"start time\";\n          \n          \n            \n                public static final String END_TIME=\"end time\";\n          \n          \n            \n                public static final String START_TIME = \"start time\";\n          \n          \n            \n                public static final String END_TIME = \"end time\";", "author": "yangyichao-mango", "createdAt": "2020-07-29T11:52:40Z", "path": "dolphinscheduler-common/src/main/java/org/apache/dolphinscheduler/common/Constants.java", "diffHunk": "@@ -978,6 +978,8 @@ private Constants() {\n     public static final int NORAML_NODE_STATUS = 0;\n     public static final int ABNORMAL_NODE_STATUS = 1;\n \n+    public static final String START_TIME=\"start time\";\n+    public static final String END_TIME=\"end time\";", "originalCommit": "a5d0557bf30ee757e0c259a4aedc650ac37f4fd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MTE5MQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3315#discussion_r462241191", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testQueryTopNLongestRunningProcessInstance(){\n          \n          \n            \n                public void testQueryTopNLongestRunningProcessInstance() {", "author": "yangyichao-mango", "createdAt": "2020-07-29T11:53:38Z", "path": "dolphinscheduler-api/src/test/java/org/apache/dolphinscheduler/api/service/ProcessInstanceServiceTest.java", "diffHunk": "@@ -147,6 +147,40 @@ public void testQueryProcessInstanceList() {\n \n     }\n \n+    @Test\n+    public void testQueryTopNLongestRunningProcessInstance(){", "originalCommit": "a5d0557bf30ee757e0c259a4aedc650ac37f4fd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MTI5MA==", "url": "https://github.com/apache/dolphinscheduler/pull/3315#discussion_r462241290", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(start == null || end == null){\n          \n          \n            \n                    if(start == null || end == null) {", "author": "yangyichao-mango", "createdAt": "2020-07-29T11:53:46Z", "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ProcessInstanceService.java", "diffHunk": "@@ -98,6 +98,53 @@\n     @Autowired\n     UsersService usersService;\n \n+    /**\n+     * return top n SUCCESS process instance order by running time which started between startTime and endTime\n+     * @param loginUser\n+     * @param projectName\n+     * @param size\n+     * @param startTime\n+     * @param endTime\n+     * @return\n+     */\n+    public Map<String, Object> queryTopNLongestRunningProcessInstance(User loginUser,String projectName,int size, String startTime, String endTime) {\n+        Map<String, Object> result = new HashMap<>();\n+\n+        Project project = projectMapper.queryByName(projectName);\n+        Map<String, Object> checkResult = projectService.checkProjectAndAuth(loginUser, project, projectName);\n+        Status resultEnum = (Status) checkResult.get(Constants.STATUS);\n+        if (resultEnum != Status.SUCCESS) {\n+            return checkResult;\n+        }\n+\n+        if (0 > size) {\n+            putMsg(result, Status.NEGTIVE_SIZE_NUMBER_ERROR, size);\n+            return result;\n+        }\n+        if (Objects.isNull(startTime)) {\n+            putMsg(result, Status.DATA_IS_NULL, Constants.START_TIME);\n+            return result;\n+        }\n+        Date start=DateUtils.stringToDate(startTime);\n+        if (Objects.isNull(endTime)) {\n+            putMsg(result, Status.DATA_IS_NULL, Constants.END_TIME);\n+            return result;\n+        }\n+        Date end=DateUtils.stringToDate(endTime);\n+        if(start == null || end == null){", "originalCommit": "a5d0557bf30ee757e0c259a4aedc650ac37f4fd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MTQ5OQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3315#discussion_r462241499", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                ){\n          \n          \n            \n                ) {", "author": "yangyichao-mango", "createdAt": "2020-07-29T11:54:09Z", "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/controller/ProcessInstanceController.java", "diffHunk": "@@ -204,6 +205,29 @@ public Result queryProcessInstanceById(@ApiIgnore @RequestAttribute(value = Cons\n         return returnDataList(result);\n     }\n \n+    @ApiOperation(value = \"queryTopNLongestRunningProcessInstance\", notes = \"QUERY_TOPN_LONGEST_RUNNING_PROCESS_INSTANCE_NOTES\")\n+    @ApiImplicitParams({\n+            @ApiImplicitParam(name = \"size\", value = \"PROCESS_INSTANCE_SIZE\", dataType = \"Int\", example = \"10\"),\n+            @ApiImplicitParam(name = \"startTime\", value = \"PROCESS_INSTANCE_START_TIME\", dataType = \"String\"),\n+            @ApiImplicitParam(name = \"endTime\", value = \"PROCESS_INSTANCE_END_TIME\", dataType = \"String\"),\n+    })\n+    @GetMapping(value = \"/top-n\")\n+    @ResponseStatus(HttpStatus.OK)\n+    @ApiException(QUERY_PROCESS_INSTANCE_BY_ID_ERROR)\n+    public Result<ProcessInstance> queryTopNLongestRunningProcessInstance(@ApiIgnore @RequestAttribute(value = Constants.SESSION_USER) User loginUser,\n+                                                         @ApiParam(name = \"projectName\", value = \"PROJECT_NAME\", required = true) @PathVariable String projectName,\n+                                                         @RequestParam(\"size\") Integer size,\n+                                                         @RequestParam(value = \"startTime\",required = true) String startTime,\n+                                                         @RequestParam(value = \"endTime\",required = true) String endTime\n+\n+    ){", "originalCommit": "a5d0557bf30ee757e0c259a4aedc650ac37f4fd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "372b83b55bd10ab5c8c62224a6df824a14257902", "url": "https://github.com/apache/dolphinscheduler/commit/372b83b55bd10ab5c8c62224a6df824a14257902", "message": "top n : add  java doc and format code", "committedDate": "2020-07-29T12:23:05Z", "type": "commit"}, {"oid": "135ffe4c9973790a239f253a67a8cf0fb04b0582", "url": "https://github.com/apache/dolphinscheduler/commit/135ffe4c9973790a239f253a67a8cf0fb04b0582", "message": "Merge branch 'dev' of https://github.com/apache/incubator-dolphinscheduler into dev", "committedDate": "2020-07-29T12:23:23Z", "type": "commit"}]}