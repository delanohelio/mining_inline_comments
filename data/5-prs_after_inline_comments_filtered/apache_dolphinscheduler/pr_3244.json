{"pr_number": 3244, "pr_title": "[Feature-3134]Refactor to use a shared singleton Curator Zookeeper Client", "pr_createdAt": "2020-07-19T11:25:18Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/3244", "timeline": [{"oid": "6e40e9b196a057222f0cfb6f76bc1173bb9c907f", "url": "https://github.com/apache/dolphinscheduler/commit/6e40e9b196a057222f0cfb6f76bc1173bb9c907f", "message": "Merge pull request #1 from apache/dev\n\nsync official", "committedDate": "2020-03-07T10:02:44Z", "type": "commit"}, {"oid": "a416b254830a13ad2147d24f5930af03746cf77c", "url": "https://github.com/apache/dolphinscheduler/commit/a416b254830a13ad2147d24f5930af03746cf77c", "message": "Merge pull request #2 from apache/dev\n\nsync official", "committedDate": "2020-03-09T04:28:58Z", "type": "commit"}, {"oid": "4ed94ccbf1b0e3edcad2fe37b31ff14c51a0e5c8", "url": "https://github.com/apache/dolphinscheduler/commit/4ed94ccbf1b0e3edcad2fe37b31ff14c51a0e5c8", "message": "Merge pull request #3 from apache/dev\n\nsync official", "committedDate": "2020-07-13T15:11:41Z", "type": "commit"}, {"oid": "52669d42fcc3358df0be64a85a959d8bf9b05684", "url": "https://github.com/apache/dolphinscheduler/commit/52669d42fcc3358df0be64a85a959d8bf9b05684", "message": "Merge pull request #4 from apache/dev\n\nsync official", "committedDate": "2020-07-15T16:12:13Z", "type": "commit"}, {"oid": "2c435f78f880eac014fbfa211cc04e9827e691f3", "url": "https://github.com/apache/dolphinscheduler/commit/2c435f78f880eac014fbfa211cc04e9827e691f3", "message": "Merge pull request #5 from apache/dev\n\nsync official", "committedDate": "2020-07-16T13:17:52Z", "type": "commit"}, {"oid": "bab9a100caedc73a0145bf3498158929d6519904", "url": "https://github.com/apache/dolphinscheduler/commit/bab9a100caedc73a0145bf3498158929d6519904", "message": "Merge pull request #6 from apache/dev\n\nsync official", "committedDate": "2020-07-19T05:49:13Z", "type": "commit"}, {"oid": "d42fa8962c7b85b45510ee0a81b82371e3b0406e", "url": "https://github.com/apache/dolphinscheduler/commit/d42fa8962c7b85b45510ee0a81b82371e3b0406e", "message": "[Feature-3134]Refactor to use a shared singleton Curator Zookeeper Client", "committedDate": "2020-07-19T11:23:30Z", "type": "commit"}, {"oid": "3bab90cc204d39cabcacf56ebd39948fb8431940", "url": "https://github.com/apache/dolphinscheduler/commit/3bab90cc204d39cabcacf56ebd39948fb8431940", "message": "autowire CuratorZookeeperClient to ZookeeperOperator", "committedDate": "2020-07-19T14:07:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk4ODMxMQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3244#discussion_r456988311", "bodyText": "Hi,\nGood job,\nBut why we need to delete the state changed and log for record the master address from MasterRegistry?", "author": "yangyichao-mango", "createdAt": "2020-07-20T01:49:34Z", "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java", "diffHunk": "@@ -83,19 +83,6 @@ public void registry() {\n         String address = NetUtils.getHost();\n         String localNodePath = getMasterPath();\n         zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(localNodePath, \"\");\n-        zookeeperRegistryCenter.getZookeeperCachedOperator().getZkClient().getConnectionStateListenable().addListener(new ConnectionStateListener() {\n-            @Override\n-            public void stateChanged(CuratorFramework client, ConnectionState newState) {\n-                if(newState == ConnectionState.LOST){\n-                    logger.error(\"master : {} connection lost from zookeeper\", address);\n-                } else if(newState == ConnectionState.RECONNECTED){\n-                    logger.info(\"master : {} reconnected to zookeeper\", address);\n-                    zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(localNodePath, \"\");\n-                } else if(newState == ConnectionState.SUSPENDED){\n-                    logger.warn(\"master : {} connection SUSPENDED \", address);\n-                }\n-            }\n-        });", "originalCommit": "3bab90cc204d39cabcacf56ebd39948fb8431940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxMjAwNw==", "url": "https://github.com/apache/dolphinscheduler/pull/3244#discussion_r457012007", "bodyText": "Because the connect state has been listened in the newly added class CuratorZookeeperClient", "author": "tswstarplanet", "createdAt": "2020-07-20T03:22:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk4ODMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAyNDI4Nw==", "url": "https://github.com/apache/dolphinscheduler/pull/3244#discussion_r457024287", "bodyText": "Hi,\nGood job,\nBut why we need to delete the state changed and log for record the master address from MasterRegistry?\n\nActually the CuratorZookeeperClient log will lost the log for record the master address information. And I think the master zk address info is important for user to debug. Is it better to add the address info in CuratorZookeeperClient?", "author": "yangyichao-mango", "createdAt": "2020-07-20T03:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk4ODMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAzOTE3MA==", "url": "https://github.com/apache/dolphinscheduler/pull/3244#discussion_r457039170", "bodyText": "I think you are right. Solved.", "author": "tswstarplanet", "createdAt": "2020-07-20T04:31:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk4ODMxMQ=="}], "type": "inlineReview"}, {"oid": "775afe094f02dfd773ebc2f06475a722b24288ac", "url": "https://github.com/apache/dolphinscheduler/commit/775afe094f02dfd773ebc2f06475a722b24288ac", "message": "[Improvement] Add the issue specifications reference (#3221)", "committedDate": "2020-07-20T04:29:38Z", "type": "commit"}, {"oid": "e67e2e09e616e89f8371794d739a0bdcf2785c82", "url": "https://github.com/apache/dolphinscheduler/commit/e67e2e09e616e89f8371794d739a0bdcf2785c82", "message": "log zookeeper address when the connect state change", "committedDate": "2020-07-20T04:29:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzNDQ1MA==", "url": "https://github.com/apache/dolphinscheduler/pull/3244#discussion_r457834450", "bodyText": "Hi,\nBecause remove the master zk address log from MasterRegistry, please add the master zk address to log, not the zk server info.\n\n\u56e0\u4e3a\u6211\u4eec\u662f\u4ecemasterregistry\u4e2d\u5220\u9664\u4e86master zk\u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u60f3\u8981\u6dfb\u52a0\u5230CuratorZkCLient\u4e2d\u3002\u6240\u4ee5CuratorZkCLient\u65e5\u5fd7\u4fe1\u606f\u5e94\u8be5\u662fmaster zk\u8282\u70b9\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u800c\u4e0d\u662fzk\u5730\u5740\u4fe1\u606f\u3002\nIf you have any question or suggestion, please put forward.", "author": "yangyichao-mango", "createdAt": "2020-07-21T04:50:51Z", "path": "dolphinscheduler-service/src/main/java/org/apache/dolphinscheduler/service/zk/CuratorZookeeperClient.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.dolphinscheduler.service.zk;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.framework.api.ACLProvider;\n+import org.apache.curator.framework.state.ConnectionState;\n+import org.apache.curator.retry.ExponentialBackoffRetry;\n+import org.apache.zookeeper.ZooDefs;\n+import org.apache.zookeeper.data.ACL;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+\n+import static org.apache.dolphinscheduler.common.utils.Preconditions.checkNotNull;\n+\n+/**\n+ * Shared Curator zookeeper client\n+ */\n+@Component\n+public class CuratorZookeeperClient implements InitializingBean {\n+    private final Logger logger = LoggerFactory.getLogger(CuratorZookeeperClient.class);\n+\n+    @Autowired\n+    private ZookeeperConfig zookeeperConfig;\n+\n+    private CuratorFramework zkClient;\n+\n+\n+    @Override\n+    public void afterPropertiesSet() throws Exception {\n+        this.zkClient = buildClient();\n+        initStateLister();\n+    }\n+\n+    private CuratorFramework buildClient() {\n+        logger.info(\"zookeeper registry center init, server lists is: {}.\", zookeeperConfig.getServerList());\n+\n+        CuratorFrameworkFactory.Builder builder = CuratorFrameworkFactory.builder().ensembleProvider(new DefaultEnsembleProvider(checkNotNull(zookeeperConfig.getServerList(),\"zookeeper quorum can't be null\")))\n+                .retryPolicy(new ExponentialBackoffRetry(zookeeperConfig.getBaseSleepTimeMs(), zookeeperConfig.getMaxRetries(), zookeeperConfig.getMaxSleepMs()));\n+\n+        //these has default value\n+        if (0 != zookeeperConfig.getSessionTimeoutMs()) {\n+            builder.sessionTimeoutMs(zookeeperConfig.getSessionTimeoutMs());\n+        }\n+        if (0 != zookeeperConfig.getConnectionTimeoutMs()) {\n+            builder.connectionTimeoutMs(zookeeperConfig.getConnectionTimeoutMs());\n+        }\n+        if (StringUtils.isNotBlank(zookeeperConfig.getDigest())) {\n+            builder.authorization(\"digest\", zookeeperConfig.getDigest().getBytes(StandardCharsets.UTF_8)).aclProvider(new ACLProvider() {\n+\n+                @Override\n+                public List<ACL> getDefaultAcl() {\n+                    return ZooDefs.Ids.CREATOR_ALL_ACL;\n+                }\n+\n+                @Override\n+                public List<ACL> getAclForPath(final String path) {\n+                    return ZooDefs.Ids.CREATOR_ALL_ACL;\n+                }\n+            });\n+        }\n+        zkClient = builder.build();\n+        zkClient.start();\n+        try {\n+            zkClient.blockUntilConnected();\n+        } catch (final Exception ex) {\n+            throw new RuntimeException(ex);\n+        }\n+        return zkClient;\n+    }\n+\n+    public void initStateLister() {\n+        checkNotNull(zkClient);\n+\n+        zkClient.getConnectionStateListenable().addListener((client, newState) -> {", "originalCommit": "e67e2e09e616e89f8371794d739a0bdcf2785c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2Njk3OQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3244#discussion_r457866979", "bodyText": "\u4f60\u597d\uff0c\u539f\u6765\u7684\u65e5\u5fd7\u6253\u5370\u7684\u4e5f\u662fzookeeper\u7684\u5730\u5740\u3002\u53e6\u5916\uff0c\u8fd9\u79cd\u8fde\u63a5\u72b6\u6001\u7684\u76d1\u63a7\uff0c\u5e94\u8be5\u662f\u7528\u4e00\u4e2alistener\u76d1\u542c\u5c31\u53ef\u4ee5\u4e86\uff0c\u91cd\u590d\u7684\u76d1\u542c\u662f\u6ca1\u6709\u610f\u4e49\u7684\u3002", "author": "yangyichao-mango", "createdAt": "2020-07-21T06:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzNDQ1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2ODExMg==", "url": "https://github.com/apache/dolphinscheduler/pull/3244#discussion_r457868112", "bodyText": "\u53c8\u770b\u4e86\u4e00\u4e0b\uff0c\u8fd9\u91cc\u4e0d\u53ea\u662f\u65e5\u5fd7\u7684\u95ee\u9898\uff0c\u800c\u662f\u539f\u6765\u4ee3\u7801\u91cc\u5728Reconnected\u7684\u65f6\u5019\uff0c\u6709\u4e2a\u4fdd\u5b58\u4e34\u65f6\u8282\u70b9\u7684\u64cd\u4f5c\u3002\u90a3\u53ef\u80fd\u786e\u5b9e\u4e0d\u80fd\u7b80\u5355\u5730\u5220\u6389\uff0c\u8fd8\u8981\u518d\u5206\u6790\u4e0b", "author": "tswstarplanet", "createdAt": "2020-07-21T06:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzNDQ1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2OTExNw==", "url": "https://github.com/apache/dolphinscheduler/pull/3244#discussion_r457869117", "bodyText": "\u53c8\u770b\u4e86\u4e00\u4e0b\uff0c\u8fd9\u91cc\u4e0d\u662f\u65e5\u5fd7\u7684\u95ee\u9898\uff0c\u800c\u662f\u539f\u6765\u4ee3\u7801\u91cc\u5728Reconnected\u7684\u65f6\u5019\uff0c\u6709\u4e2a\u4fdd\u5b58\u4e34\u65f6\u8282\u70b9\u7684\u64cd\u4f5c\u3002\u90a3\u53ef\u80fd\u786e\u5b9e\u4e0d\u80fd\u7b80\u5355\u5730\u5220\u6389\uff0c\u8fd8\u8981\u518d\u5206\u6790\u4e0b\n\nI agree with you~", "author": "yangyichao-mango", "createdAt": "2020-07-21T06:37:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzNDQ1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzNDM2Nw==", "url": "https://github.com/apache/dolphinscheduler/pull/3244#discussion_r458534367", "bodyText": "\u5df2\u7ecf\u628a\u5bf9\u8fd9\u4e2a\u7c7b\u7684\u4fee\u6539\u6062\u590d\u4e86", "author": "tswstarplanet", "createdAt": "2020-07-22T04:58:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzNDQ1MA=="}], "type": "inlineReview"}, {"oid": "fa0ad0fd92df8f9aa832ffea4f2ded01509aaa5d", "url": "https://github.com/apache/dolphinscheduler/commit/fa0ad0fd92df8f9aa832ffea4f2ded01509aaa5d", "message": "resume the operation of add connect state listener in MasterRegistry", "committedDate": "2020-07-21T12:32:01Z", "type": "commit"}]}