{"pr_number": 3695, "pr_title": "[Improvement-3690][common] Get the native IP policy problem (\u83b7\u53d6\u672c\u673aip\u7b56\u7565\u95ee\u9898 )", "pr_createdAt": "2020-09-08T06:30:11Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/3695", "timeline": [{"oid": "22b88dbb1acaaac03be2e5cb8ce2b8b900e668b1", "url": "https://github.com/apache/dolphinscheduler/commit/22b88dbb1acaaac03be2e5cb8ce2b8b900e668b1", "message": "Get the Intranet IP", "committedDate": "2020-09-08T06:23:52Z", "type": "commit"}, {"oid": "06fb5ffc34a617377fa3b1bfba7dfe5137e51a67", "url": "https://github.com/apache/dolphinscheduler/commit/06fb5ffc34a617377fa3b1bfba7dfe5137e51a67", "message": "Get the Intranet IP", "committedDate": "2020-09-08T07:10:31Z", "type": "commit"}, {"oid": "9dfc03e21d46c47ed51e3294aa2c5dc21035c603", "url": "https://github.com/apache/dolphinscheduler/commit/9dfc03e21d46c47ed51e3294aa2c5dc21035c603", "message": "fix code smell", "committedDate": "2020-09-08T07:28:20Z", "type": "commit"}, {"oid": "2787d974a262f44fbf8d61af87db22e7d56aef4a", "url": "https://github.com/apache/dolphinscheduler/commit/2787d974a262f44fbf8d61af87db22e7d56aef4a", "message": "fix code smell", "committedDate": "2020-09-09T08:58:43Z", "type": "commit"}, {"oid": "f38ff7eb808c4599cb2a828a357a658130facbff", "url": "https://github.com/apache/dolphinscheduler/commit/f38ff7eb808c4599cb2a828a357a658130facbff", "message": "fix code smell", "committedDate": "2020-09-09T09:14:44Z", "type": "commit"}, {"oid": "9b077199a8909f4498ca808c52960ae56bd6b0f8", "url": "https://github.com/apache/dolphinscheduler/commit/9b077199a8909f4498ca808c52960ae56bd6b0f8", "message": "Merge branch 'github-local/dev' into Improvement/getInnetIp", "committedDate": "2020-09-09T14:11:24Z", "type": "commit"}, {"oid": "3aa6893ca987ec0eb6257687dc79e49723cad5ef", "url": "https://github.com/apache/dolphinscheduler/commit/3aa6893ca987ec0eb6257687dc79e49723cad5ef", "message": "fix code smell", "committedDate": "2020-09-09T14:43:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwMDE3MA==", "url": "https://github.com/apache/dolphinscheduler/pull/3695#discussion_r486300170", "bodyText": "Hi, there may be a little problem here, we need to consider the IPV6 situation,", "author": "CalvinKirs", "createdAt": "2020-09-10T12:35:55Z", "path": "dolphinscheduler-common/src/main/java/org/apache/dolphinscheduler/common/utils/NetUtils.java", "diffHunk": "@@ -227,4 +230,72 @@ private static boolean isSpecifyNetworkInterface(NetworkInterface networkInterfa\n         String preferredNetworkInterface = System.getProperty(DOLPHIN_SCHEDULER_PREFERRED_NETWORK_INTERFACE);\n         return Objects.equals(networkInterface.getDisplayName(), preferredNetworkInterface);\n     }\n+\n+    private static NetworkInterface findAddress(List<NetworkInterface> validNetworkInterfaces) {\n+        if (validNetworkInterfaces.isEmpty()) {\n+            return null;\n+        }\n+        String networkPriority = PropertyUtils.getString(Constants.NETWORK_PRIORITY_STRATEGY, NETWORK_PRIORITY_DEFAULT);\n+        if (NETWORK_PRIORITY_DEFAULT.equalsIgnoreCase(networkPriority)) {\n+            return findAddressByDefaultPolicy(validNetworkInterfaces);\n+        } else if (NETWORK_PRIORITY_INNER.equalsIgnoreCase(networkPriority)) {\n+            return findInnerAddress(validNetworkInterfaces);\n+        } else if (NETWORK_PRIORITY_OUTER.equalsIgnoreCase(networkPriority)) {\n+            return findOuterAddress(validNetworkInterfaces);\n+        } else {\n+            logger.error(\"There is no matching network card acquisition policy!\");\n+            return null;\n+        }\n+    }\n+\n+    private static NetworkInterface findAddressByDefaultPolicy(List<NetworkInterface> validNetworkInterfaces) {\n+        NetworkInterface networkInterface;\n+        networkInterface = findInnerAddress(validNetworkInterfaces);\n+        if (networkInterface == null) {\n+            networkInterface = findOuterAddress(validNetworkInterfaces);\n+            if (networkInterface == null) {\n+                networkInterface = validNetworkInterfaces.get(0);\n+            }\n+        }\n+        return networkInterface;\n+    }\n+\n+    /**\n+     * Get the Intranet IP\n+     *\n+     * @return If no {@link NetworkInterface} is available , return <code>null</code>\n+     */\n+    private static NetworkInterface findInnerAddress(List<NetworkInterface> validNetworkInterfaces) {\n+\n+        NetworkInterface networkInterface = null;\n+        for (NetworkInterface ni : validNetworkInterfaces) {\n+            Enumeration<InetAddress> address = ni.getInetAddresses();\n+            while (address.hasMoreElements()) {\n+                InetAddress ip = address.nextElement();\n+                if (ip.isSiteLocalAddress()\n+                        && !ip.isLoopbackAddress()\n+                        && !ip.getHostAddress().contains(\":\")) {\n+                    networkInterface = ni;\n+                }\n+            }\n+        }\n+        return networkInterface;\n+    }\n+\n+    private static NetworkInterface findOuterAddress(List<NetworkInterface> validNetworkInterfaces) {\n+        NetworkInterface networkInterface = null;\n+        for (NetworkInterface ni : validNetworkInterfaces) {\n+            Enumeration<InetAddress> address = ni.getInetAddresses();\n+            while (address.hasMoreElements()) {\n+                InetAddress ip = address.nextElement();\n+                if (!ip.isSiteLocalAddress()\n+                        && !ip.isLoopbackAddress()\n+                        && !ip.getHostAddress().contains(\":\")) {\n+                    networkInterface = ni;", "originalCommit": "3aa6893ca987ec0eb6257687dc79e49723cad5ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM4Nzc5NA==", "url": "https://github.com/apache/dolphinscheduler/pull/3695#discussion_r486387794", "bodyText": "yes  i will support ipv6  --x:--x:--x:--x:--x:--x:--x:--x,remove  && !ip.getHostAddress().contains(\":\")", "author": "felix-thinkingdata", "createdAt": "2020-09-10T14:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwMDE3MA=="}], "type": "inlineReview"}, {"oid": "d9dce19ab1ff1d399314f54b16229e2099c5b47e", "url": "https://github.com/apache/dolphinscheduler/commit/d9dce19ab1ff1d399314f54b16229e2099c5b47e", "message": "support ipv6  --x:--x:--x:--x:--x:--x:--x:--x", "committedDate": "2020-09-10T14:25:28Z", "type": "commit"}, {"oid": "d6f7f6893e8fb11ae94508efd207a57a3a3c99df", "url": "https://github.com/apache/dolphinscheduler/commit/d6f7f6893e8fb11ae94508efd207a57a3a3c99df", "message": "Update dolphinscheduler-common/src/main/resources/common.properties\n\nCo-authored-by: Yichao Yang <1048262223@qq.com>", "committedDate": "2020-09-12T02:42:04Z", "type": "commit"}]}