{"pr_number": 2088, "pr_title": "Switch to strong references instead of IDs for child parts", "pr_createdAt": "2020-10-01T19:32:26Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/2088", "timeline": [{"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "url": "https://github.com/MegaMek/mekhq/commit/08ab72f94acb7b6296948c563bf55ed99a32b44c", "message": "Switch to strong references instead of IDs for child parts", "committedDate": "2020-10-01T19:27:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MTM4Ng==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498471386", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\tfor(Part p : bestPart.getChildParts()) {\n          \n          \n            \n            \t\t\t\t\tfor (Part p : bestPart.getChildParts()) {", "author": "Windchild292", "createdAt": "2020-10-01T19:35:35Z", "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -332,25 +329,19 @@ public Part findReplacement(boolean refit) {\n \t\t\t\t\tint currentPartArmor = 0;\n \t\t\t\t\tint bestPartQuantity = 0;\n \t\t\t\t\tint currentPartQuantity = 0;\n-\t\t\t\t\tfor(int childId : bestPart.childPartIds) {\n-\t\t\t\t\t\tPart p = campaign.getPart(childId);\n-\t\t\t\t\t\tif(p != null) {\n-\t\t\t\t\t\t\tif(p instanceof BaArmor) {\n-\t\t\t\t\t\t\t\tbestPartArmor = ((BaArmor)p).getAmount();\n-\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\tbestPartQuantity++;\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n+\t\t\t\t\tfor(Part p : bestPart.getChildParts()) {", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MTU1Mg==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498471552", "bodyText": "This looks odd, likely tab vs space issues", "author": "Windchild292", "createdAt": "2020-10-01T19:36:02Z", "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -253,14 +251,13 @@ public void fix() {\n                 }\n                 missingStuff.add(missingBaEquip);\n             }\n-            for(int childId : replacement.getChildPartIds()) {\n-        \t\tPart childPart = campaign.getPart(childId);\n-        \t\tif(childPart instanceof BaArmor && null != origArmor) {\n+            for (Part childPart : replacement.getChildParts()) {\n+        \t\tif (childPart instanceof BaArmor && null != origArmor) {\n         \t\t\tunit.getEntity().setArmor(((BaArmor)childPart).getAmount(), trooper);\n         \t\t\torigArmor.updateConditionFromEntity(false);", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3OTQyMg==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498479422", "bodyText": "Agreed. Because of the //region code used, I cannot use formatting anymore with VSCode or I'll break them. I'll see what I can do to switch the file to spaces without breaking region comments.", "author": "sixlettervariables", "createdAt": "2020-10-01T19:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MTU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3Mjk1Mg==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498472952", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for(Part p : getChildParts()) {\n          \n          \n            \n                    for (Part p : getChildParts()) {", "author": "Windchild292", "createdAt": "2020-10-01T19:38:50Z", "path": "MekHQ/src/mekhq/campaign/parts/BattleArmorSuit.java", "diffHunk": "@@ -267,14 +267,11 @@ public Money getStickerPrice() {\n             cost = cost.plus(50000 * (jumpMP + 1));\n         }\n         cost = cost.plus(25000 * (groundMP-1));\n-        for(int childId : getChildPartIds()) {\n-            Part p = campaign.getPart(childId);\n-            if(null != p) {\n-                if(p instanceof BaArmor) {\n-                    cost = cost.plus(p.getCurrentValue());\n-                } else if (!(p instanceof BattleArmorSuit)) {\n-                    cost = cost.plus(p.getStickerPrice());\n-                }\n+        for(Part p : getChildParts()) {", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MzAzMg==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498473032", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(null == unit && getChildParts().isEmpty()) {\n          \n          \n            \n                    if ((null == unit) && getChildParts().isEmpty()) {", "author": "Windchild292", "createdAt": "2020-10-01T19:39:02Z", "path": "MekHQ/src/mekhq/campaign/parts/BattleArmorSuit.java", "diffHunk": "@@ -234,7 +234,7 @@ else if(jumpType == EntityMovementMode.VTOL) {\n     public Money getStickerPrice() {\n         //if there are no linked parts and the unit is null,\n         //then use the pre-recorded alternate costs\n-        if(null == unit && getChildPartIds().size()==0) {\n+        if(null == unit && getChildParts().isEmpty()) {", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MzE1NA==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498473154", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for(Part p : getChildParts()) {\n          \n          \n            \n                    for (Part p : getChildParts()) {", "author": "Windchild292", "createdAt": "2020-10-01T19:39:19Z", "path": "MekHQ/src/mekhq/campaign/parts/BattleArmorSuit.java", "diffHunk": "@@ -218,12 +219,11 @@ else if(jumpType == EntityMovementMode.VTOL) {\n         }\n         //if there are no linked parts and the unit is null,\n         //then use the pre-recorded extra costs\n-        if(null == unit && getChildPartIds().size()==0) {\n+        if(null == unit && getChildParts().isEmpty()) {\n             tons += alternateTon;\n         }\n-        for(int childId : getChildPartIds()) {\n-            Part p = campaign.getPart(childId);\n-            if(null != p && !(p instanceof BattleArmorSuit)) {\n+        for(Part p : getChildParts()) {", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MzIyMw==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498473223", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(null == unit && getChildParts().isEmpty()) {\n          \n          \n            \n                    if ((null == unit) && getChildParts().isEmpty()) {", "author": "Windchild292", "createdAt": "2020-10-01T19:39:27Z", "path": "MekHQ/src/mekhq/campaign/parts/BattleArmorSuit.java", "diffHunk": "@@ -218,12 +219,11 @@ else if(jumpType == EntityMovementMode.VTOL) {\n         }\n         //if there are no linked parts and the unit is null,\n         //then use the pre-recorded extra costs\n-        if(null == unit && getChildPartIds().size()==0) {\n+        if(null == unit && getChildParts().isEmpty()) {", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MzI3MQ==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498473271", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(null == unit && getChildParts().isEmpty()) {\n          \n          \n            \n                    if ((null == unit) && getChildParts().isEmpty()) {", "author": "Windchild292", "createdAt": "2020-10-01T19:39:36Z", "path": "MekHQ/src/mekhq/campaign/parts/BattleArmorSuit.java", "diffHunk": "@@ -139,7 +140,7 @@ public void setTrooper(int i) {\n     public double getTonnage() {\n         //if there are no linked parts and the unit is null,\n         //then use the pre-recorded alternate costs\n-        if(null == unit && getChildPartIds().size()==0) {\n+        if(null == unit && getChildParts().isEmpty()) {", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MzkyMA==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498473920", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (null == p.getUnit() && !p.hasParentPart()) {\n          \n          \n            \n                    if ((null == p.getUnit()) && !p.hasParentPart()) {", "author": "Windchild292", "createdAt": "2020-10-01T19:40:50Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -1634,7 +1634,7 @@ public void addPart(Part p, int transitDays) {\n             p.setId(-1);\n             return;\n         }\n-        if (null == p.getUnit()) {\n+        if (null == p.getUnit() && !p.hasParentPart()) {", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NTIxMA==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498475210", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    /**\n          \n          \n            \n                     *\n          \n          \n            \n                     */\n          \n          \n            \n                    private static final long serialVersionUID = 1L;\n          \n          \n            \n                    private static final long serialVersionUID = 1L;", "author": "Windchild292", "createdAt": "2020-10-01T19:43:45Z", "path": "MekHQ/src/mekhq/campaign/parts/Part.java", "diffHunk": "@@ -1775,4 +1761,144 @@ public SimpleTechLevel getStaticTechLevel() {\n         }\n         return getTechAdvancement().getStaticTechLevel();\n     }\n+\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (parentPart instanceof PartRef) {\n+            int id = parentPart.getId();\n+            parentPart = knownParts.get(id);\n+            if (parentPart == null) {\n+                MekHQ.getLogger().error(PartRef.class,\n+                    String.format(\"Part %d ('%s') references missing parent part %d\",\n+                        getId(), getName(), id));\n+            }\n+        }\n+\n+        for (int ii = childParts.size() - 1; ii >= 0; --ii) {\n+            Part childPart = childParts.get(ii);\n+            if (childPart instanceof PartRef) {\n+                Part realPart = knownParts.get(childPart.getId());\n+                if (realPart != null) {\n+                    childParts.set(ii, realPart);\n+                } else {\n+                    MekHQ.getLogger().error(PartRef.class,\n+                        String.format(\"Part %d ('%s') references missing child part %d\",\n+                            getId(), getName(), id));\n+                    childParts.remove(ii);\n+                }\n+            }\n+        }\n+    }\n+\n+    public static class PartRef extends Part {\n+        /**\n+         *\n+         */\n+        private static final long serialVersionUID = 1L;", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NTMzNQ==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498475335", "bodyText": "Why 1L instead of an actual serialVersionUID?", "author": "Windchild292", "createdAt": "2020-10-01T19:44:02Z", "path": "MekHQ/src/mekhq/campaign/parts/Part.java", "diffHunk": "@@ -1775,4 +1761,144 @@ public SimpleTechLevel getStaticTechLevel() {\n         }\n         return getTechAdvancement().getStaticTechLevel();\n     }\n+\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (parentPart instanceof PartRef) {\n+            int id = parentPart.getId();\n+            parentPart = knownParts.get(id);\n+            if (parentPart == null) {\n+                MekHQ.getLogger().error(PartRef.class,\n+                    String.format(\"Part %d ('%s') references missing parent part %d\",\n+                        getId(), getName(), id));\n+            }\n+        }\n+\n+        for (int ii = childParts.size() - 1; ii >= 0; --ii) {\n+            Part childPart = childParts.get(ii);\n+            if (childPart instanceof PartRef) {\n+                Part realPart = knownParts.get(childPart.getId());\n+                if (realPart != null) {\n+                    childParts.set(ii, realPart);\n+                } else {\n+                    MekHQ.getLogger().error(PartRef.class,\n+                        String.format(\"Part %d ('%s') references missing child part %d\",\n+                            getId(), getName(), id));\n+                    childParts.remove(ii);\n+                }\n+            }\n+        }\n+    }\n+\n+    public static class PartRef extends Part {\n+        /**\n+         *\n+         */\n+        private static final long serialVersionUID = 1L;", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3OTAyMg==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498479022", "bodyText": "1 is a valid version UID.", "author": "sixlettervariables", "createdAt": "2020-10-01T19:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NTMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NTU0Mw==", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498475543", "bodyText": "Please clear out the TODOs unless they are useful.", "author": "Windchild292", "createdAt": "2020-10-01T19:44:29Z", "path": "MekHQ/src/mekhq/campaign/parts/Part.java", "diffHunk": "@@ -1775,4 +1761,144 @@ public SimpleTechLevel getStaticTechLevel() {\n         }\n         return getTechAdvancement().getStaticTechLevel();\n     }\n+\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (parentPart instanceof PartRef) {\n+            int id = parentPart.getId();\n+            parentPart = knownParts.get(id);\n+            if (parentPart == null) {\n+                MekHQ.getLogger().error(PartRef.class,\n+                    String.format(\"Part %d ('%s') references missing parent part %d\",\n+                        getId(), getName(), id));\n+            }\n+        }\n+\n+        for (int ii = childParts.size() - 1; ii >= 0; --ii) {\n+            Part childPart = childParts.get(ii);\n+            if (childPart instanceof PartRef) {\n+                Part realPart = knownParts.get(childPart.getId());\n+                if (realPart != null) {\n+                    childParts.set(ii, realPart);\n+                } else {\n+                    MekHQ.getLogger().error(PartRef.class,\n+                        String.format(\"Part %d ('%s') references missing child part %d\",\n+                            getId(), getName(), id));\n+                    childParts.remove(ii);\n+                }\n+            }\n+        }\n+    }\n+\n+    public static class PartRef extends Part {", "originalCommit": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7abe6d435e1e53e871244714277f841d8d5d7e6e", "url": "https://github.com/MegaMek/mekhq/commit/7abe6d435e1e53e871244714277f841d8d5d7e6e", "message": "Apply suggestions from code review\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-10-01T19:56:51Z", "type": "commit"}, {"oid": "b14ab027dd7a235b0ca3d0fe8d056b0318829f35", "url": "https://github.com/MegaMek/mekhq/commit/b14ab027dd7a235b0ca3d0fe8d056b0318829f35", "message": "Switch from tabs to spaces", "committedDate": "2020-10-01T20:04:08Z", "type": "commit"}, {"oid": "c8c121e2a6b5c43c22681995832f6a44e882f216", "url": "https://github.com/MegaMek/mekhq/commit/c8c121e2a6b5c43c22681995832f6a44e882f216", "message": "Remove unnecessary comments from Part.PartRef", "committedDate": "2020-10-01T20:05:05Z", "type": "commit"}, {"oid": "5ff7e79cb07db25a5944a44712608c4213d701dc", "url": "https://github.com/MegaMek/mekhq/commit/5ff7e79cb07db25a5944a44712608c4213d701dc", "message": "Don't log a missing part if it wasn't missing", "committedDate": "2020-10-02T18:37:22Z", "type": "commit"}]}