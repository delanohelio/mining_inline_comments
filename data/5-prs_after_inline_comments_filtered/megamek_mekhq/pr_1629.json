{"pr_number": 1629, "pr_title": "850: Bulk Award Assignment", "pr_createdAt": "2020-04-03T22:26:07Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/1629", "timeline": [{"oid": "2d9fa7e051197148739d0e372b51f239c36aa125", "url": "https://github.com/MegaMek/mekhq/commit/2d9fa7e051197148739d0e372b51f239c36aa125", "message": "Adding bulk sort processing", "committedDate": "2020-04-03T17:23:01Z", "type": "commit"}, {"oid": "46422305d760cd30197d48946540dd14dfe31dc3", "url": "https://github.com/MegaMek/mekhq/commit/46422305d760cd30197d48946540dd14dfe31dc3", "message": "Moving xp skills to be properly located, and refactoring how awards are assigned?", "committedDate": "2020-04-03T17:36:25Z", "type": "commit"}, {"oid": "78e239690fcd282c798c629aca96e831d17cae52", "url": "https://github.com/MegaMek/mekhq/commit/78e239690fcd282c798c629aca96e831d17cae52", "message": "Finising refactoring for award removal and assignment", "committedDate": "2020-04-03T17:49:46Z", "type": "commit"}, {"oid": "523ff00f00d41a98b2c1d6b0e292124f7981831e", "url": "https://github.com/MegaMek/mekhq/commit/523ff00f00d41a98b2c1d6b0e292124f7981831e", "message": "Fixing spacing issues", "committedDate": "2020-04-03T17:57:08Z", "type": "commit"}, {"oid": "9bf471c65d8cb2ca5c0381d85e21c2186cbcec9b", "url": "https://github.com/MegaMek/mekhq/commit/9bf471c65d8cb2ca5c0381d85e21c2186cbcec9b", "message": "Maing hasAward(string, string) public", "committedDate": "2020-04-03T18:01:35Z", "type": "commit"}, {"oid": "437d5aa2cffec7e932e158b141cf1cea1ba51e38", "url": "https://github.com/MegaMek/mekhq/commit/437d5aa2cffec7e932e158b141cf1cea1ba51e38", "message": "Adding parsing for removal from multiple personnel", "committedDate": "2020-04-03T18:05:02Z", "type": "commit"}, {"oid": "c835c1df376cf0ddde378d8c0676c3c71b1d791e", "url": "https://github.com/MegaMek/mekhq/commit/c835c1df376cf0ddde378d8c0676c3c71b1d791e", "message": "Adding canBeAwarded for a Person[]", "committedDate": "2020-04-03T19:11:35Z", "type": "commit"}, {"oid": "3ffbbf55e3b4fa9aeaba9a91939b2ccba6fea595", "url": "https://github.com/MegaMek/mekhq/commit/3ffbbf55e3b4fa9aeaba9a91939b2ccba6fea595", "message": "Fixing the date for remove award", "committedDate": "2020-04-03T19:11:51Z", "type": "commit"}, {"oid": "c315bdf3295ff0fca8df1351ee64c6d00c64b1db", "url": "https://github.com/MegaMek/mekhq/commit/c315bdf3295ff0fca8df1351ee64c6d00c64b1db", "message": "Adding a static check to determine if at least one person has an award", "committedDate": "2020-04-03T19:12:29Z", "type": "commit"}, {"oid": "3dc25be2c6f12416038596ab6fc9b7a5e9687f54", "url": "https://github.com/MegaMek/mekhq/commit/3dc25be2c6f12416038596ab6fc9b7a5e9687f54", "message": "Applying changes to bulk remove awards", "committedDate": "2020-04-03T19:17:46Z", "type": "commit"}, {"oid": "a86ca728a85c46cd4c765534d409feaa44bf520b", "url": "https://github.com/MegaMek/mekhq/commit/a86ca728a85c46cd4c765534d409feaa44bf520b", "message": "Switching to comparing caseless", "committedDate": "2020-04-03T20:21:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ5ODkxMw==", "url": "https://github.com/MegaMek/mekhq/pull/1629#discussion_r403498913", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /**\n          \n          \n            \n            \n          \n          \n            \n                /**", "author": "sixlettervariables", "createdAt": "2020-04-04T18:08:06Z", "path": "MekHQ/src/mekhq/campaign/personnel/PersonAwardController.java", "diffHunk": "@@ -138,27 +139,48 @@ public void addAwardFromXml(Award award){\n         MekHQ.triggerEvent(new PersonChangedEvent(person));\n     }\n \n+    public void removeAward(String setName, String awardName, String stringDate) {\n+        if (StringUtil.isNullOrEmpty(stringDate)) {\n+            MekHQ.getLogger().error(getClass(), \"removeAward\",\n+                    \"Attempted to remove award with a null date. Returning without removing the award\");\n+        } else {\n+            removeAward(setName, awardName, stringDate, null);\n+        }\n+    }\n     /**", "originalCommit": "a86ca728a85c46cd4c765534d409feaa44bf520b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ5OTE5OQ==", "url": "https://github.com/MegaMek/mekhq/pull/1629#discussion_r403499199", "bodyText": "This is eventually going to break something as it doesn't follow the invariants. Why not sort by set then name?\nI also don't follow the comment about the \"original copy\".", "author": "sixlettervariables", "createdAt": "2020-04-04T18:10:37Z", "path": "MekHQ/src/mekhq/gui/adapter/PersonnelTableMouseAdapter.java", "diffHunk": "@@ -1836,95 +1845,97 @@ private void maybeShowPopup(MouseEvent e) {\n \n                     popup.add(menu);\n                 }\n+            }\n \n-                JMenu awardMenu = new JMenu(resourceMap.getString(\"award.text\"));\n-                List<String> setNames = AwardsFactory.getInstance().getAllSetNames();\n-                Collections.sort(setNames);\n-                for(String setName : setNames){\n-                    JMenu setAwardMenu = new JMenu(setName);\n-\n-                    List<Award> awardsOfSet = AwardsFactory.getInstance().getAllAwardsForSet(setName);\n-                    Collections.sort(awardsOfSet);\n-\n-                    for (Award award : awardsOfSet) {\n+            //region Awards Menu\n+            JMenu awardMenu = new JMenu(resourceMap.getString(\"award.text\"));\n+            List<String> setNames = AwardsFactory.getInstance().getAllSetNames();\n+            Collections.sort(setNames);\n+            for (String setName : setNames) {\n+                JMenu setAwardMenu = new JMenu(setName);\n \n-                        if(!award.canBeAwarded(person)) continue;\n+                List<Award> awardsOfSet = AwardsFactory.getInstance().getAllAwardsForSet(setName);\n+                Collections.sort(awardsOfSet);\n \n-                        StringBuilder awardMenuItem = new StringBuilder();\n-                        awardMenuItem.append(String.format(\"%s\", award.getName()));\n+                for (Award award : awardsOfSet) {\n+                    if (!award.canBeAwarded(selected)) {\n+                        continue;\n+                    }\n \n-                        if(award.getXPReward() != 0 || award.getEdgeReward() != 0){\n-                            awardMenuItem.append(\" (\");\n+                    StringBuilder awardMenuItem = new StringBuilder();\n+                    awardMenuItem.append(String.format(\"%s\", award.getName()));\n \n-                            if(award.getXPReward() != 0){\n-                                awardMenuItem.append(award.getXPReward()).append(\" XP\");\n-                                if(award.getEdgeReward() != 0)\n-                                    awardMenuItem.append(\" & \");\n-                            }\n+                    if ((award.getXPReward() != 0) || (award.getEdgeReward() != 0)) {\n+                        awardMenuItem.append(\" (\");\n \n-                            if(award.getEdgeReward() != 0){\n-                                awardMenuItem.append(award.getEdgeReward()).append(\" Edge\");\n+                        if (award.getXPReward() != 0) {\n+                            awardMenuItem.append(award.getXPReward()).append(\" XP\");\n+                            if (award.getEdgeReward() != 0) {\n+                                awardMenuItem.append(\" & \");\n                             }\n+                        }\n \n-                            awardMenuItem.append(\")\");\n+                        if (award.getEdgeReward() != 0) {\n+                            awardMenuItem.append(award.getEdgeReward()).append(\" Edge\");\n                         }\n \n-                        menuItem = new JMenuItem(awardMenuItem.toString());\n-                        menuItem.setToolTipText(MultiLineTooltip.splitToolTip(award.getDescription()));\n+                        awardMenuItem.append(\")\");\n+                    }\n \n-                        if(!award.canBeAwarded(person) && !gui.getCampaign().isGM())\n-                            menuItem.setEnabled(false);\n+                    menuItem = new JMenuItem(awardMenuItem.toString());\n+                    menuItem.setToolTipText(MultiLineTooltip.splitToolTip(award.getDescription()));\n+                    menuItem.setActionCommand(makeCommand(CMD_ADD_AWARD, award.getSet(), award.getName()));\n+                    menuItem.addActionListener(this);\n+                    setAwardMenu.add(menuItem);\n+                }\n \n-                        menuItem.setActionCommand(makeCommand(CMD_ADD_AWARD, award.getSet(), award.getName()));\n-                        menuItem.addActionListener(this);\n+                JMenuHelpers.addMenuIfNonEmpty(awardMenu, setAwardMenu, MAX_POPUP_ITEMS);\n+            }\n \n-                        setAwardMenu.add(menuItem);\n-                    }\n-                    if (setAwardMenu.getItemCount() > MAX_POPUP_ITEMS) {\n-                        MenuScroller.setScrollerFor(setAwardMenu, MAX_POPUP_ITEMS);\n-                    }\n-                    awardMenu.add(setAwardMenu);\n+            if (StaticChecks.doAnyHaveAnAward(selected)) {\n+                if (awardMenu.getItemCount() > 0) {\n+                    awardMenu.addSeparator();\n                 }\n-                awardMenu.addSeparator();\n-                JMenu removeAwardMenu = new JMenu(resourceMap.getString(\"removeAward.text\"));\n \n-                if(!person.awardController.hasAwards())\n-                    removeAwardMenu.setEnabled(false);\n+                JMenu removeAwardMenu = new JMenu(resourceMap.getString(\"removeAward.text\"));\n \n-                for(Award award : person.awardController.getAwards()){\n-                    JMenu singleAwardMenu = new JMenu(award.getName());\n-                    for(String date : award.getFormatedDates()){\n-                        JMenuItem specificAwardMenu = new JMenuItem(date);\n-                        specificAwardMenu.setActionCommand(makeCommand(CMD_RMV_AWARD, award.getSet(), award.getName(), date));\n-                        specificAwardMenu.addActionListener(this);\n-                        singleAwardMenu.add(specificAwardMenu);\n+                if (oneSelected) {\n+                    for (Award award : person.awardController.getAwards()) {\n+                        JMenu singleAwardMenu = new JMenu(award.getName());\n+                        for (String date : award.getFormatedDates()) {\n+                            JMenuItem specificAwardMenu = new JMenuItem(date);\n+                            specificAwardMenu.setActionCommand(makeCommand(CMD_RMV_AWARD, award.getSet(), award.getName(), date));\n+                            specificAwardMenu.addActionListener(this);\n+                            singleAwardMenu.add(specificAwardMenu);\n+                        }\n+                        JMenuHelpers.addMenuIfNonEmpty(removeAwardMenu, singleAwardMenu, MAX_POPUP_ITEMS);\n                     }\n-                    removeAwardMenu.add(singleAwardMenu);\n-                }\n-                awardMenu.add(removeAwardMenu);\n-                popup.add(awardMenu);\n-\n-                menu = new JMenu(resourceMap.getString(\"spendXP.text\")); //$NON-NLS-1$\n-                JMenu currentMenu = new JMenu(resourceMap.getString(\"spendOnCurrentSkills.text\")); //$NON-NLS-1$\n-                JMenu newMenu = new JMenu(resourceMap.getString(\"spendOnNewSkills.text\")); //$NON-NLS-1$\n-                for (int i = 0; i < SkillType.getSkillList().length; i++) {\n-                    String type = SkillType.getSkillList()[i];\n-                    int cost = person.hasSkill(type) ? person.getSkill(type).getCostToImprove() : SkillType.getType(type).getCost(0);\n-                    if( cost >= 0 ) {\n-                        String desc = String.format(resourceMap.getString(\"skillDesc.format\"), type, cost); //$NON-NLS-1$\n-                        menuItem = new JMenuItem(desc);\n-                        menuItem.setActionCommand(makeCommand(CMD_IMPROVE, type, String.valueOf(cost)));\n-                        menuItem.addActionListener(this);\n-                        menuItem.setEnabled(person.getXp() >= cost);\n-                        if(person.hasSkill(type)) {\n-                            currentMenu.add(menuItem);\n+                } else {\n+                    Set<Award> awards = new TreeSet<>((a1, a2) -> {\n+                        if (a1.getSet().equalsIgnoreCase(a2.getSet()) && a1.getName().equalsIgnoreCase(a2.getName())) {\n+                            return 0;\n                         } else {\n-                            newMenu.add(menuItem);\n+                            return 1; // This is purposeful, we want to keep the original copy", "originalCommit": "a86ca728a85c46cd4c765534d409feaa44bf520b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ5OTg2MQ==", "url": "https://github.com/MegaMek/mekhq/pull/1629#discussion_r403499861", "bodyText": "What, how... That was fixed \ud83e\udd14\nOh, I forgot to push the last commit \ud83d\ude33", "author": "Windchild292", "createdAt": "2020-04-04T18:16:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ5OTE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzUwMDE5OA==", "url": "https://github.com/MegaMek/mekhq/pull/1629#discussion_r403500198", "bodyText": "Pushed, sorry about that. (it did break something, funnily enough)", "author": "Windchild292", "createdAt": "2020-04-04T18:19:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ5OTE5OQ=="}], "type": "inlineReview"}, {"oid": "6dad5602876ea6704602f83050c48aa180ba749a", "url": "https://github.com/MegaMek/mekhq/commit/6dad5602876ea6704602f83050c48aa180ba749a", "message": "Update MekHQ/src/mekhq/campaign/personnel/PersonAwardController.java\n\nCo-Authored-By: Christopher Watford <christopher.watford@gmail.com>", "committedDate": "2020-04-04T18:12:56Z", "type": "commit"}, {"oid": "1dbf02d58f8b420cc884256df4141132108ce96b", "url": "https://github.com/MegaMek/mekhq/commit/1dbf02d58f8b420cc884256df4141132108ce96b", "message": "Merge remote-tracking branch 'upstream/master' into dev_Windchild_850", "committedDate": "2020-04-04T18:17:02Z", "type": "commit"}, {"oid": "eb8c8ca9b8f51c5025688f38a5e7032cd6761002", "url": "https://github.com/MegaMek/mekhq/commit/eb8c8ca9b8f51c5025688f38a5e7032cd6761002", "message": "Fixing comparison for awards", "committedDate": "2020-04-04T18:18:46Z", "type": "commit"}, {"oid": "841f853f7b0cf27914452a19a26647f1bd979bf1", "url": "https://github.com/MegaMek/mekhq/commit/841f853f7b0cf27914452a19a26647f1bd979bf1", "message": "Fixing merge conflicts", "committedDate": "2020-04-04T18:24:26Z", "type": "commit"}, {"oid": "134963aa1076435264d285e1c2bd3d6e0b22cc17", "url": "https://github.com/MegaMek/mekhq/commit/134963aa1076435264d285e1c2bd3d6e0b22cc17", "message": "Merge remote-tracking branch 'upstream/master' into dev_Windchild_850", "committedDate": "2020-04-20T15:21:14Z", "type": "commit"}, {"oid": "ec9d5ad8203cab931f06bfc51103a121a0972514", "url": "https://github.com/MegaMek/mekhq/commit/ec9d5ad8203cab931f06bfc51103a121a0972514", "message": "Fixing Awards whitespacing", "committedDate": "2020-04-20T15:41:59Z", "type": "commit"}, {"oid": "db12449bd14f2a499a0e1948b1ed8464f7af68c7", "url": "https://github.com/MegaMek/mekhq/commit/db12449bd14f2a499a0e1948b1ed8464f7af68c7", "message": "Fixing person unit testing", "committedDate": "2020-04-20T16:01:59Z", "type": "commit"}, {"oid": "7f888d09e99d20a8b79baa775dd1aa3219cdcee6", "url": "https://github.com/MegaMek/mekhq/commit/7f888d09e99d20a8b79baa775dd1aa3219cdcee6", "message": "Fixing whitespace issue", "committedDate": "2020-04-20T16:15:06Z", "type": "commit"}, {"oid": "3f4046a2a3b9b4ef4d4a8a3069d2e25a4957a1ed", "url": "https://github.com/MegaMek/mekhq/commit/3f4046a2a3b9b4ef4d4a8a3069d2e25a4957a1ed", "message": "Fixing bug with edge disabled, and applying swapover to JMenuHelpers", "committedDate": "2020-04-20T16:38:15Z", "type": "commit"}, {"oid": "3e24b51cd5b8c0333e02835c6e062c853ef09985", "url": "https://github.com/MegaMek/mekhq/commit/3e24b51cd5b8c0333e02835c6e062c853ef09985", "message": "Fixing edge trigger", "committedDate": "2020-04-20T16:39:07Z", "type": "commit"}, {"oid": "3ef4568aec7ba01a68f97a9090d99eabf6c55ba9", "url": "https://github.com/MegaMek/mekhq/commit/3ef4568aec7ba01a68f97a9090d99eabf6c55ba9", "message": "Fixing merge conflicts", "committedDate": "2020-04-29T01:03:24Z", "type": "commit"}]}