{"pr_number": 8719, "pr_title": "Issue #3342: Indentation: Lambda re-implementation", "pr_createdAt": "2020-08-19T21:00:34Z", "pr_url": "https://github.com/checkstyle/checkstyle/pull/8719", "timeline": [{"oid": "59aeefefa1737c9c3d4afcdaf7e3719a96c5e0c2", "url": "https://github.com/checkstyle/checkstyle/commit/59aeefefa1737c9c3d4afcdaf7e3719a96c5e0c2", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-08-20T05:51:00Z", "type": "forcePushed"}, {"oid": "4c9eb9b2e4d9be83db695d7ef2275beab8286f57", "url": "https://github.com/checkstyle/checkstyle/commit/4c9eb9b2e4d9be83db695d7ef2275beab8286f57", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-08-21T15:08:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQwNjMyOA==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r486406328", "bodyText": "isAcceptableIndent", "author": "romani", "createdAt": "2020-09-10T14:50:13Z", "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/indentation/LambdaHandler.java", "diffHunk": "@@ -27,6 +27,12 @@\n  *\n  */\n public class LambdaHandler extends AbstractExpressionHandler {\n+    /**\n+     * Checks whether the lambda is correctly indented, this variable get its value from checking\n+     * the lambda handler's indentation, and it is being used in aligning the lambda's children.\n+     * A true value depicts lambda is correctly aligned without giving any errors.\n+     */\n+    private boolean isIdealIndent;", "originalCommit": "4c9eb9b2e4d9be83db695d7ef2275beab8286f57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwNDAzNQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r487004035", "bodyText": "isAcceptableIndent is already the name of a method. Thus renaming it is creating pmd violation that no same name for method and variable is allowed.\nThough I have changed it to something more accurate about what it actually does.\nThis variable checks if the lamda expression is indented properly, and thus upon yes/no it states its children expected indent.", "author": "Abhishek-kumar09", "createdAt": "2020-09-11T12:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQwNjMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQwNjU0MA==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r486406540", "bodyText": "revert this change", "author": "romani", "createdAt": "2020-09-10T14:50:27Z", "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/indentation/LambdaHandler.java", "diffHunk": "@@ -36,14 +42,22 @@\n      * @param ast the abstract syntax tree\n      * @param parent the parent handler\n      */\n+", "originalCommit": "4c9eb9b2e4d9be83db695d7ef2275beab8286f57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwNDEzNg==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r487004136", "bodyText": "Done", "author": "Abhishek-kumar09", "createdAt": "2020-09-11T12:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQwNjU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQwNzIyMw==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r486407223", "bodyText": "please keep existing cases as is, and create new one is required", "author": "romani", "createdAt": "2020-09-10T14:51:20Z", "path": "src/test/resources/com/puppycrawl/tools/checkstyle/checks/indentation/indentation/InputIndentationCtorCall.java", "diffHunk": "@@ -115,7 +115,7 @@ public Valid(InputIndentationCtorCall obj, float arg) { //indent:4 exp:4\n     public Valid(InputIndentationCtorCall obj, double arg) { //indent:4 exp:4\n       obj. //indent:6 exp:6\n           super( //indent:10 exp:10\n-            x -> arg); //indent:12 exp:12\n+          x -> arg); //indent:10 exp:12,14 warn", "originalCommit": "4c9eb9b2e4d9be83db695d7ef2275beab8286f57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwNDI2Mg==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r487004262", "bodyText": "Done", "author": "Abhishek-kumar09", "createdAt": "2020-09-11T12:14:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQwNzIyMw=="}], "type": "inlineReview"}, {"oid": "5f3c3da3659a94f101232eee120c0667b54f1ca1", "url": "https://github.com/checkstyle/checkstyle/commit/5f3c3da3659a94f101232eee120c0667b54f1ca1", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-09-11T12:02:06Z", "type": "forcePushed"}, {"oid": "90fa8b8b6f4a8fcea8e63f17de5663852e66c67f", "url": "https://github.com/checkstyle/checkstyle/commit/90fa8b8b6f4a8fcea8e63f17de5663852e66c67f", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-09-11T14:19:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMDE3Mw==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r487430173", "bodyText": "This new field isn't final after it is first assigned in the constructor. That means its possible the value can flip after the constructor, and it looks like it can be flipped in multiple areas.\nIs it possible usage of this field in one method can go down the true path and then another method could use it as the false path, and then re-calling the old method we first mentioned will then go down the false path the 2nd time through?\nIf this is possible it would lead to some randomness issues in the check throughout a run.", "author": "rnveach", "createdAt": "2020-09-12T17:22:10Z", "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/indentation/LambdaHandler.java", "diffHunk": "@@ -59,6 +73,7 @@ protected IndentLevel getIndentImpl() {\n \n         DetailAST parent = getMainAst().getParent();\n         if (getParent() instanceof NewHandler) {\n+            isLambdaCorrectlyIndented = false;", "originalCommit": "90fa8b8b6f4a8fcea8e63f17de5663852e66c67f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMjQyMQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r487432421", "bodyText": "@rnveach ,\nThe value of this variable is used only once for suggesting the children's expected indent at line 55\nThis method is generally executed after running all the methods regarding checking the Lambda's indent.\nThe main purpose of this variable is checking if there are indentation error logs for Lamda expression.", "author": "Abhishek-kumar09", "createdAt": "2020-09-12T17:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMDE3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMzI4MQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r488303281", "bodyText": "I looked into my concerns with a custom branch and regression. See #8719 (comment) .\nNo exceptions were thrown that would mean we assigning the field 2 different values. So that alleviates my main concern.\nSo I am marking this resolved.", "author": "rnveach", "createdAt": "2020-09-15T00:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMDE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMTExMg==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r487431112", "bodyText": "Field name also doesn't make sense to me.\nYou set lambda to not be correctly idented when the indent is acceptable... I see other instances where it is set to false just because of the parent and nothing to do with the indentation.", "author": "rnveach", "createdAt": "2020-09-12T17:32:47Z", "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/indentation/LambdaHandler.java", "diffHunk": "@@ -83,7 +98,8 @@ public void checkIndentation() {\n         if (parent.getType() != TokenTypes.SWITCH_RULE\n                 && getLineStart(firstChild) == expandedTabsColumnNo(firstChild)) {\n             final IndentLevel level = getIndent();\n-            if (!level.isAcceptable(expandedTabsColumnNo(firstChild))) {\n+            if (isAcceptableIndent(firstChild, level)) {\n+                isLambdaCorrectlyIndented = false;", "originalCommit": "90fa8b8b6f4a8fcea8e63f17de5663852e66c67f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMTg3OA==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r487431878", "bodyText": "@rnveach  Yes, there is really a blunder in the naming... It is flipping actual logic...\nThe method name should be ifNonAcceptableIndent.", "author": "Abhishek-kumar09", "createdAt": "2020-09-12T17:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMTExMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ0MDUwMw==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r487440503", "bodyText": "changes made.", "author": "Abhishek-kumar09", "createdAt": "2020-09-12T19:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMTExMg=="}], "type": "inlineReview"}, {"oid": "d31e0452d0f3a69be8137ff7ac45fa080b492ecd", "url": "https://github.com/checkstyle/checkstyle/commit/d31e0452d0f3a69be8137ff7ac45fa080b492ecd", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-09-12T19:05:26Z", "type": "forcePushed"}, {"oid": "b50e63de1616ec33a791b9455b08653e0ca3a3e4", "url": "https://github.com/checkstyle/checkstyle/commit/b50e63de1616ec33a791b9455b08653e0ca3a3e4", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-09-12T19:21:29Z", "type": "forcePushed"}, {"oid": "eba9eea03326554277036ee8fa1c467e182421e3", "url": "https://github.com/checkstyle/checkstyle/commit/eba9eea03326554277036ee8fa1c467e182421e3", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-09-12T20:43:35Z", "type": "forcePushed"}, {"oid": "c952304d7d9ee60b9d4dd4fcd00b7a387751ca4f", "url": "https://github.com/checkstyle/checkstyle/commit/c952304d7d9ee60b9d4dd4fcd00b7a387751ca4f", "message": "Issue #8725: Supress Comments checking for Input files of Indentation", "committedDate": "2020-09-13T12:19:01Z", "type": "forcePushed"}, {"oid": "ce4ed2ff72d860b334926bae5053685a3dd18d32", "url": "https://github.com/checkstyle/checkstyle/commit/ce4ed2ff72d860b334926bae5053685a3dd18d32", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-09-13T12:39:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNjExNg==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r488306116", "bodyText": "Minor thing, since expandedTabsColumnNo(firstChild) is used twice, you could save the value to a variable.", "author": "rnveach", "createdAt": "2020-09-15T00:12:13Z", "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/indentation/LambdaHandler.java", "diffHunk": "@@ -92,10 +106,17 @@ public void checkIndentation() {\n         if (getLineStart(getMainAst()) == expandedTabsColumnNo(getMainAst())) {\n             final IndentLevel level =\n                 new IndentLevel(getIndent(), getIndentCheck().getLineWrappingIndentation());\n-            if (!level.isAcceptable(expandedTabsColumnNo(getMainAst()))) {\n+            if (isNonAcceptableIndent(getMainAst(), level)) {\n+                isLambdaCorrectlyIndented = false;\n                 logError(getMainAst(), \"\", expandedTabsColumnNo(getMainAst()), level);\n             }\n         }\n     }\n \n+    private boolean isNonAcceptableIndent(DetailAST firstChild, IndentLevel level) {\n+        return expandedTabsColumnNo(firstChild) < level.getFirstIndentLevel()\n+            || getIndentCheck().isForceStrictCondition()\n+               && !level.isAcceptable(expandedTabsColumnNo(firstChild));", "originalCommit": "ce4ed2ff72d860b334926bae5053685a3dd18d32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MjY4NA==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r488742684", "bodyText": "I have tried to do the same but got unusual error: https://github.com/Abhishek-kumar09/checkstyle/pull/16/files", "author": "Abhishek-kumar09", "createdAt": "2020-09-15T15:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNjExNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA3NDQwMg==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r489074402", "bodyText": "I took a look at the previous changes. The exception isn't fully clear what it was, but I am going to assume you got an NPE because you were trying to use firstChild in areas where it was most likely null.\nThat can't be the case here, since you use it for both sides of the || condition.\nBtw, now that I am looking at this a second time, should the first of the || have the following !getIndentCheck().isForceStrictCondition() ? Force strict should require that exact tab placement, and it can't be anything besides it.", "author": "rnveach", "createdAt": "2020-09-15T23:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNjExNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwMTg0MQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r489301841", "bodyText": "I think this logic is fine.\nThe Indentation is NonAcceptable if:\neither the child is less than the minimum acceptable indent.\nOR\nstrictCondition is true  and the child is not in the acceptable indent.\n\nshould the first of the || have the following !getIndentCheck().isForceStrictCondition()\n\nIf the indent is less than minimum of acceptable indent, then doesnt matter if strict condition is true or false, It should  not be accepted...That's why I think this logic is not required.\n\nForce strict should require that exact tab placement, and it can't be anything besides it.\n\nCurrently It is following all the indent which is a part of accetable indent and nothing more or less that, only discrete acceptable values. I think it is still following the strictlyTrue condition.", "author": "Abhishek-kumar09", "createdAt": "2020-09-16T09:35:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNjExNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM2NjY4MA==", "url": "https://github.com/checkstyle/checkstyle/pull/8719#discussion_r489366680", "bodyText": "@rnveach\nDiff report with force strict condition true: https://abhishek-kumar09.github.io/github-actions-report-fetch/\nIs it good, We can see here that there are more than 1 acceptable indents in some rare cases with true strict condition....\nIf it defeats the purpose of trueForceStrictCondition then I will change it.", "author": "Abhishek-kumar09", "createdAt": "2020-09-16T11:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNjExNg=="}], "type": "inlineReview"}, {"oid": "ee6acff44d7d32542945f1b74ab495777bae8e0c", "url": "https://github.com/checkstyle/checkstyle/commit/ee6acff44d7d32542945f1b74ab495777bae8e0c", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-09-16T09:39:09Z", "type": "forcePushed"}, {"oid": "b251590a828e6bdb9a561b05338d498ebf4ecfe9", "url": "https://github.com/checkstyle/checkstyle/commit/b251590a828e6bdb9a561b05338d498ebf4ecfe9", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-09-25T14:06:32Z", "type": "commit"}, {"oid": "b251590a828e6bdb9a561b05338d498ebf4ecfe9", "url": "https://github.com/checkstyle/checkstyle/commit/b251590a828e6bdb9a561b05338d498ebf4ecfe9", "message": "Issue #3342: Indentation: lambda don't respect lineWrappingIndentation when forceStrictCondition is false", "committedDate": "2020-09-25T14:06:32Z", "type": "forcePushed"}]}