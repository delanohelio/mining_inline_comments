{"pr_number": 3279, "pr_title": "Wip/6.0 Fix HashMap constructor with expected size usage error", "pr_createdAt": "2020-03-01T19:37:27Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3279", "timeline": [{"oid": "242e66dffdec7b86683d8852ccb1053c61a8c74e", "url": "https://github.com/hibernate/hibernate-orm/commit/242e66dffdec7b86683d8852ccb1053c61a8c74e", "message": "fix HashMap constructor with expected size usage error", "committedDate": "2020-03-01T20:28:58Z", "type": "commit"}, {"oid": "242e66dffdec7b86683d8852ccb1053c61a8c74e", "url": "https://github.com/hibernate/hibernate-orm/commit/242e66dffdec7b86683d8852ccb1053c61a8c74e", "message": "fix HashMap constructor with expected size usage error", "committedDate": "2020-03-01T20:28:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzODE5OQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3279#discussion_r386138199", "bodyText": "There is a bug in old implementation. Different than HashMap or HashSet, ConcurrentHashMap will perform sizing computation internally so we don't need to compute on top of that.", "author": "NathanQingyangXu", "createdAt": "2020-03-01T20:31:58Z", "path": "hibernate-core/src/main/java/org/hibernate/internal/util/collections/CollectionHelper.java", "diffHunk": "@@ -175,8 +188,7 @@ public static int determineProperSizing(int numberOfElements) {\n \t * @return The created map.\n \t */\n \tpublic static <K, V> ConcurrentHashMap<K, V> concurrentMap(int expectedNumberOfElements, float loadFactor) {\n-\t\tfinal int size = expectedNumberOfElements + 1 + (int) ( expectedNumberOfElements * loadFactor );\n-\t\treturn new ConcurrentHashMap<>( size, loadFactor );\n+\t\treturn new ConcurrentHashMap<>( expectedNumberOfElements, loadFactor );", "originalCommit": "242e66dffdec7b86683d8852ccb1053c61a8c74e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzODI4Mg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3279#discussion_r386138282", "bodyText": "No need to use the util method in CollectionHelper for ConcurrentHashMap constructor is enough for it will compute the size internally.", "author": "NathanQingyangXu", "createdAt": "2020-03-01T20:33:03Z", "path": "hibernate-core/src/main/java/org/hibernate/metamodel/internal/AbstractEmbeddableRepresentationStrategy.java", "diffHunk": "@@ -37,7 +38,7 @@ public AbstractEmbeddableRepresentationStrategy(\n \t\tthis.embeddableJavaTypeDescriptor = embeddableJavaTypeDescriptor;\n \n \t\tthis.propertyAccesses = new PropertyAccess[ propertySpan ];\n-\t\tthis.attributeNameToPositionMap = CollectionHelper.concurrentMap( propertySpan );\n+\t\tthis.attributeNameToPositionMap = new ConcurrentHashMap<>( propertySpan );", "originalCommit": "242e66dffdec7b86683d8852ccb1053c61a8c74e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}