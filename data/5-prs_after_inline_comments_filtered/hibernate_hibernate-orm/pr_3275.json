{"pr_number": 3275, "pr_title": "Wip/6.0 Fix a double-checked locking implementation imperfection", "pr_createdAt": "2020-03-01T03:28:05Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3275", "timeline": [{"oid": "e09c0e9090f5ed4f716244ca7a2f5b3a09d912ea", "url": "https://github.com/hibernate/hibernate-orm/commit/e09c0e9090f5ed4f716244ca7a2f5b3a09d912ea", "message": "Fix a subtle double-checked locking issue", "committedDate": "2020-03-01T03:24:08Z", "type": "commit"}, {"oid": "e70bab9928c134d1750ffc0a83642c9c64e74a39", "url": "https://github.com/hibernate/hibernate-orm/commit/e70bab9928c134d1750ffc0a83642c9c64e74a39", "message": "Fix a subtle double-checked locking issue", "committedDate": "2020-03-01T03:25:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA3MzQxOA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3275#discussion_r386073418", "bodyText": "Without the above statement, there is no reason to check again at the next statement for localCopy would always be null.", "author": "NathanQingyangXu", "createdAt": "2020-03-01T03:29:20Z", "path": "hibernate-core/src/main/java/org/hibernate/persister/collection/AbstractCollectionPersister.java", "diffHunk": "@@ -744,18 +744,21 @@ protected void logStaticSQL() {\n \t\t}\n \t}\n \n-\tprivate CollectionLoader standardCollectionLoader;\n+\tprivate volatile CollectionLoader standardCollectionLoader;\n \n \t@Override\n \tpublic void initialize(Object key, SharedSessionContractImplementor session) throws HibernateException {\n //\t\tgetAppropriateInitializer( key, session ).initialize( key, session );\n \t\tdetermineLoaderToUse( key, session ).load( key, session );\n \t}\n \n+\t// lazily initialize instance field via 'double-checked locking'\n+\t// see https://en.wikipedia.org/wiki/Double-checked_locking on why 'volatile' and local copy is used\n \tprotected CollectionLoader getStandardCollectionLoader() {\n \t\tCollectionLoader localCopy = standardCollectionLoader;\n \t\tif ( localCopy == null ) {\n \t\t\tsynchronized (this) {\n+\t\t\t\tlocalCopy = standardCollectionLoader;", "originalCommit": "e70bab9928c134d1750ffc0a83642c9c64e74a39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA3MzQzMg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3275#discussion_r386073432", "bodyText": "The volatile keyword is mandatory to benefit from the 'local copy' paradigm later.", "author": "NathanQingyangXu", "createdAt": "2020-03-01T03:30:06Z", "path": "hibernate-core/src/main/java/org/hibernate/persister/collection/AbstractCollectionPersister.java", "diffHunk": "@@ -744,18 +744,21 @@ protected void logStaticSQL() {\n \t\t}\n \t}\n \n-\tprivate CollectionLoader standardCollectionLoader;\n+\tprivate volatile CollectionLoader standardCollectionLoader;", "originalCommit": "e70bab9928c134d1750ffc0a83642c9c64e74a39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}