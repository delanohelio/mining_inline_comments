{"pr_number": 3256, "pr_title": "HHH-13875 : Optional one-to-one does not always join the associated entity table when querying", "pr_createdAt": "2020-02-22T00:23:47Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3256", "timeline": [{"oid": "7e3ae837895c95eb44f2ff362cbc4b2080ed4150", "url": "https://github.com/hibernate/hibernate-orm/commit/7e3ae837895c95eb44f2ff362cbc4b2080ed4150", "message": "HHH-13875 : Added test cases", "committedDate": "2020-02-21T23:24:04Z", "type": "commit"}, {"oid": "20aba6dd9eb1fde7976d7633c9c5304056902cde", "url": "https://github.com/hibernate/hibernate-orm/commit/20aba6dd9eb1fde7976d7633c9c5304056902cde", "message": "HHH-13875 : Optional one-to-one does not always join the associated entity table when querying", "committedDate": "2020-02-21T23:32:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkwNTQ4Ng==", "url": "https://github.com/hibernate/hibernate-orm/pull/3256#discussion_r382905486", "bodyText": "Interesting, I thought entityType.isNullable() would imply !isPropertyEmbeddedInJoinProperties( parentAsDotNode.propertyName ).\nObviously the API of the PropertyMapping gets a little bit vague here. Most code assumes that properties in the PropertyMapping are actually deducible from just the association owners subclass column span, which nullable properties are inherently not. In that sense, it doesn't make sense for the property to be considered here. As far as I remember, this was at least how these were handled at the time I wrote this originally. It might have changed since, or I might just as well have simply overlooked this case.\nAnyways, I expected joinIsNeeded for generateJoin && entityType.isNullable - so nothing worries me here. The tests that the two of us introduced with HHH-12775 and others are also still passing. The tests for this PR are very extensive.  So I am sure this change is fine!", "author": "jwgmeligmeyling", "createdAt": "2020-02-22T11:14:55Z", "path": "hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/DotNode.java", "diffHunk": "@@ -394,11 +394,14 @@ private void dereferenceEntity(\n \n \t\tif ( isDotNode( parent ) ) {\n \t\t\t// our parent is another dot node, meaning we are being further dereferenced.\n-\t\t\t// thus we need to generate a join unless the parent refers to the associated\n-\t\t\t// entity's PK (because 'our' table would know the FK).\n+\t\t\t// thus we need to generate a join unless the association is non-nullable and\n+\t\t\t// parent refers to the associated entity's PK (because 'our' table would know the FK).\n \t\t\tparentAsDotNode = (DotNode) parent;\n \t\t\tproperty = parentAsDotNode.propertyName;\n-\t\t\tjoinIsNeeded = generateJoin && !isPropertyEmbeddedInJoinProperties( parentAsDotNode.propertyName );\n+\t\t\tjoinIsNeeded = generateJoin && (\n+\t\t\t\t\tentityType.isNullable() ||\n+\t\t\t\t\t!isPropertyEmbeddedInJoinProperties( parentAsDotNode.propertyName )", "originalCommit": "20aba6dd9eb1fde7976d7633c9c5304056902cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5NTM0OQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3256#discussion_r383495349", "bodyText": "@gbadner, thanks for your comments. I think the the issue here is that a nullable one-to-one association was not taken into account. When a querying using a path for an optional one-to-one with an implicit join, a join must be included in the query.", "author": "gbadner", "createdAt": "2020-02-24T20:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkwNTQ4Ng=="}], "type": "inlineReview"}]}