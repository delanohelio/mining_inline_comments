{"pr_number": 3481, "pr_title": "HHH-14112 Invalid count SQL for JOINED inheritance and WHERE clause", "pr_createdAt": "2020-07-23T16:14:24Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3481", "timeline": [{"oid": "dce416c23e1a2cabc7d7192df99a76d8785bd00a", "url": "https://github.com/hibernate/hibernate-orm/commit/dce416c23e1a2cabc7d7192df99a76d8785bd00a", "message": "HHH-14112 : Invalid Pagination COUNT query generated with @Inheritance(strategy = InheritanceType.JOINED)", "committedDate": "2020-07-23T16:09:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYxMjMxMg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3481#discussion_r459612312", "bodyText": "@beikov so I have a question for you. It seems the logic fix is to include joins whenever there is where clause, but is there such possibility that the where clause can be found in child entity per se so we don't need to bother joining? Could we tell whether the joining is really necessary?", "author": "NathanQingyangXu", "createdAt": "2020-07-23T17:29:24Z", "path": "hibernate-core/src/main/java/org/hibernate/hql/internal/ast/util/JoinProcessor.java", "diffHunk": "@@ -142,6 +142,14 @@ public static JoinType toHibernateJoinType(int astJoinType) {\n \t\t\tif ( role != null ) {\n \t\t\t\tresult.add( fromElement.getOrigin().getPropertyTableName(role.substring(role.lastIndexOf('.') + 1)) );\n \t\t\t}\n+\t\t\tfinal EntityPersister entityPersister = fromElement.getEntityPersister();\n+\t\t\tif ( entityPersister instanceof AbstractEntityPersister ) {\n+\t\t\t\tAbstractEntityPersister aep = (AbstractEntityPersister) entityPersister;\n+\t\t\t\twhile ( !aep.filterFragment( \"\", Collections.emptyMap() ).isEmpty() && aep.getMappedSuperclass() != null ) {\n+\t\t\t\t\tCollections.addAll( result, aep.getTableNames() );\n+\t\t\t\t\taep = (AbstractEntityPersister) walker.getSessionFactoryHelper().findEntityPersisterByName( aep.getMappedSuperclass() );\n+\t\t\t\t}\n+\t\t\t}", "originalCommit": "dce416c23e1a2cabc7d7192df99a76d8785bd00a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyNjIyMA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3481#discussion_r459626220", "bodyText": "We don't know the structure of the @Where condition, so we can't check if the columns that are used in it are part of a specific table. Apart from that, I am also not sure if we could theoretically skip an intermediate join when e.g. A3 extends A2 extends A1, I guess the join condition to for adding A1 is based on columns of A2, so even if A2 is not used, we could not drop that table join if A1 defines a @Where condition.\nThis is IMO the best we can do", "author": "beikov", "createdAt": "2020-07-23T17:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYxMjMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzNTc2OQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3481#discussion_r459635769", "bodyText": "Thanks for the explanation. Hopefully v6 can be smarter on this.", "author": "NathanQingyangXu", "createdAt": "2020-07-23T18:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYxMjMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0NDE2Ng==", "url": "https://github.com/hibernate/hibernate-orm/pull/3481#discussion_r459644166", "bodyText": "We'd need to parse the SQL the user provides and I'm not sure this can be done perfectly in general, although we seem to do it already somehow because the column is prefixed properly with the table alias, so maybe there might be a way to do it right now also.", "author": "beikov", "createdAt": "2020-07-23T18:25:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYxMjMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0OTk1Mw==", "url": "https://github.com/hibernate/hibernate-orm/pull/3481#discussion_r459649953", "bodyText": "Yeah, that was my concern. We should have finished semantic parsing of filter fragment already.", "author": "NathanQingyangXu", "createdAt": "2020-07-23T18:35:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYxMjMxMg=="}], "type": "inlineReview"}]}