{"pr_number": 243, "pr_title": "Adding RestActions support Create/Update Detector API", "pr_createdAt": "2020-10-10T00:09:19Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243", "timeline": [{"oid": "c380c8ff6925c12f87711ae737d3a8924000adde", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/c380c8ff6925c12f87711ae737d3a8924000adde", "message": "Adding RestActions support for Get Detector API", "committedDate": "2020-10-09T08:48:34Z", "type": "commit"}, {"oid": "1aeb38d6fcf745850c8ab1a839274aacfef38840", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/1aeb38d6fcf745850c8ab1a839274aacfef38840", "message": "Updating JobScheduler version for depedent changes", "committedDate": "2020-10-09T09:20:41Z", "type": "commit"}, {"oid": "41ce6ac25a8f6a2e2e19c579e9976628ac229863", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/41ce6ac25a8f6a2e2e19c579e9976628ac229863", "message": "Avoid import *", "committedDate": "2020-10-09T09:28:31Z", "type": "commit"}, {"oid": "14e6ad7a76b7c3cced6bc06b1d08cd24496454ab", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/14e6ad7a76b7c3cced6bc06b1d08cd24496454ab", "message": "Adding Spotless changes", "committedDate": "2020-10-09T09:35:55Z", "type": "commit"}, {"oid": "a99bebb302522414d502b9c09488351a56fc3cb2", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/a99bebb302522414d502b9c09488351a56fc3cb2", "message": "Adding Writeable implementations", "committedDate": "2020-10-09T18:15:13Z", "type": "commit"}, {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/f8e30571a4efb1e59198d02e7e236d9ed6399f5d", "message": "Adding RestActions support Create Detector API", "committedDate": "2020-10-10T00:06:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUwNzIyOA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503507228", "bodyText": "Add xContentRegistry ? Same problem for other places", "author": "ylwu-amzn", "createdAt": "2020-10-12T20:04:57Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/handler/AnomalyDetectorActionHandler.java", "diffHunk": "@@ -49,47 +49,57 @@\n      * @param clusterService ES cluster service\n      * @param client ES node client\n      * @param detectorId detector identifier\n-     * @param channel ES rest channel\n+     * @param listener Listener to send response\n      * @param function AD function\n      */", "originalCommit": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxMjU3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503512579", "bodyText": "Nice catch.\nSure will fix them.", "author": "saratvemulapalli", "createdAt": "2020-10-12T20:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUwNzIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxNzg2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503517861", "bodyText": "Remove System.out.println, check other places too", "author": "ylwu-amzn", "createdAt": "2020-10-12T20:31:00Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/handler/IndexAnomalyDetectorActionHandler.java", "diffHunk": "@@ -132,11 +141,15 @@ public IndexAnomalyDetectorActionHandler(\n      */\n     public void start() throws IOException {\n         if (!anomalyDetectionIndices.doesAnomalyDetectorIndexExist()) {\n+            System.out.println(\"AnomalyDetector Indices do not exist\");", "originalCommit": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxOTYwMg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503519602", "bodyText": "Sure.. there are other debugging logs as well. Will remove them.", "author": "saratvemulapalli", "createdAt": "2020-10-12T20:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxNzg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyMDMzNg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503520336", "bodyText": "This log is for debugging? If yes, change to debug level or remove it. Same for line 251. Check other places as well", "author": "ylwu-amzn", "createdAt": "2020-10-12T20:37:36Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/handler/IndexAnomalyDetectorActionHandler.java", "diffHunk": "@@ -183,28 +200,35 @@ private void onGetAnomalyDetectorResponse(GetResponse response) throws IOExcepti\n \n     private void createAnomalyDetector() {\n         try {\n+            logger.info(\"#198 Request Method is PUT \");\n             QueryBuilder query = QueryBuilders.matchAllQuery();\n             SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().query(query).size(0).timeout(requestTimeout);\n \n             SearchRequest searchRequest = new SearchRequest(ANOMALY_DETECTORS_INDEX).source(searchSourceBuilder);\n \n-            client.search(searchRequest, ActionListener.wrap(response -> onSearchAdResponse(response), exception -> onFailure(exception)));\n+            client\n+                .search(\n+                    searchRequest,\n+                    ActionListener.wrap(response -> onSearchAdResponse(response), exception -> listener.onFailure(exception))\n+                );\n         } catch (Exception e) {\n-            onFailure(e);\n+            listener.onFailure(e);\n         }\n     }\n \n     private void onSearchAdResponse(SearchResponse response) throws IOException {\n+        logger.info(\"#211 onSearchAdResponse is called \");\n         if (response.getHits().getTotalHits().value >= maxAnomalyDetectors) {\n             String errorMsg = \"Can't create anomaly detector more than \" + maxAnomalyDetectors;\n             logger.error(errorMsg);\n-            onFailure(new IllegalArgumentException(errorMsg));\n+            listener.onFailure(new IllegalArgumentException(errorMsg));\n         } else {\n             searchAdInputIndices(null);\n         }\n     }\n \n     private void searchAdInputIndices(String detectorId) {\n+        logger.info(\"#222 searchAdInputIndices is called \");", "originalCommit": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyNzExNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503527114", "bodyText": "Sure yeah it was for debugging. I removed them : )", "author": "saratvemulapalli", "createdAt": "2020-10-12T20:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyMDMzNg=="}], "type": "inlineReview"}, {"oid": "22ac7b42350be8ec70539c97f8d5e1e77f8089a3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/22ac7b42350be8ec70539c97f8d5e1e77f8089a3", "message": "Adding few comments and removing development logs", "committedDate": "2020-10-12T20:37:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyMjQyNw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503522427", "bodyText": "Change logger name to current class GetAnomalyDetectorTransportAction.class", "author": "ylwu-amzn", "createdAt": "2020-10-12T20:43:06Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/GetAnomalyDetectorTransportAction.java", "diffHunk": "@@ -0,0 +1,232 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.transport;\n+\n+import static com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetector.ANOMALY_DETECTORS_INDEX;\n+import static com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetectorJob.ANOMALY_DETECTOR_JOB_INDEX;\n+import static com.amazon.opendistroforelasticsearch.ad.util.RestHandlerUtils.PROFILE;\n+import static org.elasticsearch.common.xcontent.XContentParserUtils.ensureExpectedToken;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.get.MultiGetItemResponse;\n+import org.elasticsearch.action.get.MultiGetRequest;\n+import org.elasticsearch.action.get.MultiGetResponse;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.HandledTransportAction;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.CheckedConsumer;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestResponse;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.transport.TransportService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.AnomalyDetectorProfileRunner;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetector;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetectorJob;\n+import com.amazon.opendistroforelasticsearch.ad.model.DetectorProfile;\n+import com.amazon.opendistroforelasticsearch.ad.model.ProfileName;\n+import com.amazon.opendistroforelasticsearch.ad.settings.AnomalyDetectorSettings;\n+import com.amazon.opendistroforelasticsearch.ad.util.DiscoveryNodeFilterer;\n+import com.amazon.opendistroforelasticsearch.ad.util.RestHandlerUtils;\n+import com.google.common.collect.Sets;\n+\n+public class GetAnomalyDetectorTransportAction extends HandledTransportAction<GetAnomalyDetectorRequest, GetAnomalyDetectorResponse> {\n+\n+    private static final Logger LOG = LogManager.getLogger(StopDetectorTransportAction.class);", "originalCommit": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyNzU0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503527542", "bodyText": "Nice catch. Sure fixed it.", "author": "saratvemulapalli", "createdAt": "2020-10-12T20:55:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyMjQyNw=="}], "type": "inlineReview"}, {"oid": "39a1f0bd04ccd737703b982e9b8c64b9f155b1a8", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/39a1f0bd04ccd737703b982e9b8c64b9f155b1a8", "message": "Merging master to this branch", "committedDate": "2020-10-12T20:49:05Z", "type": "commit"}, {"oid": "389cee89e16862d7c2eced91f59a20a7d11e741d", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/389cee89e16862d7c2eced91f59a20a7d11e741d", "message": "Merge branch 'master' into fgac-start-api", "committedDate": "2020-10-12T20:52:32Z", "type": "commit"}]}