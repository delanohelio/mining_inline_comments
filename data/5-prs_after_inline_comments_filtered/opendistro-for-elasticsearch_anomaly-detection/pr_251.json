{"pr_number": 251, "pr_title": "Adding User support for Detector and DetectorJob", "pr_createdAt": "2020-10-14T00:47:09Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/251", "timeline": [{"oid": "d0894cb5d658ed20638c6824efecf90003cb50c5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/d0894cb5d658ed20638c6824efecf90003cb50c5", "message": "Adding User support for AD and ADJob", "committedDate": "2020-10-14T00:07:15Z", "type": "commit"}, {"oid": "81093f7f1f2fe6b898e5db4b673fc3608ad8d65f", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/81093f7f1f2fe6b898e5db4b673fc3608ad8d65f", "message": "Rebasing changes from master", "committedDate": "2020-10-14T00:39:48Z", "type": "commit"}, {"oid": "ec266d0c419ce0acd696e84cad8fde89fdbffdc5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/ec266d0c419ce0acd696e84cad8fde89fdbffdc5", "message": "Adding spotless recommended changes", "committedDate": "2020-10-14T01:54:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3MjY4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/251#discussion_r504372682", "bodyText": "Add user field in detector index mapping https://github.com/opendistro-for-elasticsearch/anomaly-detection/blob/master/src/main/resources/mappings/anomaly-detectors.json ?\nSame for detector job.", "author": "ylwu-amzn", "createdAt": "2020-10-14T03:05:03Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -289,6 +308,9 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         if (categoryFields != null) {\n             xContentBuilder.field(CATEGORY_FIELD, categoryFields.toArray());\n         }\n+        if (user != null) {", "originalCommit": "ec266d0c419ce0acd696e84cad8fde89fdbffdc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQyMjEzMA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/251#discussion_r504422130", "bodyText": "Great point sure. Will add.", "author": "saratvemulapalli", "createdAt": "2020-10-14T06:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3MjY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3MzI0NA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/251#discussion_r504373244", "bodyText": "Here we just add User in each detector document. Security plugin will do authorization check for each request based on backend_roles or roles ? Can you share the related code?", "author": "ylwu-amzn", "createdAt": "2020-10-14T03:07:32Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -131,7 +135,8 @@ public AnomalyDetector(\n         Map<String, Object> uiMetadata,\n         Integer schemaVersion,\n         Instant lastUpdateTime,\n-        List<String> categoryFields\n+        List<String> categoryFields,\n+        User user", "originalCommit": "ec266d0c419ce0acd696e84cad8fde89fdbffdc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQyNDI0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/251#discussion_r504424245", "bodyText": "Good question, security plugin will only provide the authorization headers.\nMy next PR will address this. Basically we have to query and filter by roles or backend_roles.\nHere is a code pointer in alerting which does that: opendistro-for-elasticsearch/alerting@44abca1#diff-39bec5249e2b91e055cdb30bb3edcd28ee868ab3676e98652547bcce28eed895R86", "author": "saratvemulapalli", "createdAt": "2020-10-14T06:11:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3MzI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQyNjI2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/251#discussion_r504426266", "bodyText": "Got it, that makes sense.", "author": "ylwu-amzn", "createdAt": "2020-10-14T06:16:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3MzI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3NDQwMw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/251#discussion_r504374403", "bodyText": "For old detector, they have no user field, so they will be open to all users which has AD permission ?\nFor new detector, we will create default user with the creator's user role?", "author": "ylwu-amzn", "createdAt": "2020-10-14T03:12:01Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -260,6 +273,12 @@ public void writeTo(StreamOutput output) throws IOException {\n         output.writeInt(schemaVersion);\n         output.writeInstant(lastUpdateTime);\n         output.writeStringCollection(categoryFields);\n+        if (user != null) {\n+            output.writeBoolean(true); // user exists\n+            user.writeTo(output);\n+        } else {\n+            output.writeBoolean(false); // user does not exist", "originalCommit": "ec266d0c419ce0acd696e84cad8fde89fdbffdc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQyNDc1NA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/251#discussion_r504424754", "bodyText": "Exactly, for existing detectors where User doesn't exist, the filter will not work and users who have all access to rest api's will be able to see those detectors.\nThis is to maintain backward compatibility.", "author": "saratvemulapalli", "createdAt": "2020-10-14T06:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3NDQwMw=="}], "type": "inlineReview"}, {"oid": "010c88c43b52cce58a46630dda89115a1fe05375", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/010c88c43b52cce58a46630dda89115a1fe05375", "message": "Updated AD and ADJob Mappings with User information", "committedDate": "2020-10-14T07:58:07Z", "type": "commit"}]}