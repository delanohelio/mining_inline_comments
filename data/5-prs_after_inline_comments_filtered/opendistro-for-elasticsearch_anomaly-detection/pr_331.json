{"pr_number": 331, "pr_title": "Adding support for Security Test Framework", "pr_createdAt": "2020-12-15T03:37:57Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331", "timeline": [{"oid": "f9cd1ad6acf2f55c0b320f59483521625198ae1c", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/f9cd1ad6acf2f55c0b320f59483521625198ae1c", "message": "Adding support for Security Test Framework", "committedDate": "2020-12-15T03:33:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYzMjE3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r543632175", "bodyText": "minor: we may throw exception or fail the test if isHttps is false but SecureTest is running, just in case of wrong CI set up. Wrong CI set up like testing against SecureTest with isHttp true may get passing test, but actually test is not being run.", "author": "yizheliu-amazon", "createdAt": "2020-12-15T19:37:09Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/rest/SecureADRestIT.java", "diffHunk": "@@ -0,0 +1,243 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.rest;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestClient;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+\n+import com.amazon.opendistroforelasticsearch.ad.AnomalyDetectorRestTestCase;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetector;\n+import com.amazon.opendistroforelasticsearch.commons.rest.SecureRestClientBuilder;\n+\n+public class SecureADRestIT extends AnomalyDetectorRestTestCase {\n+    String aliceUser = \"alice\";\n+    RestClient aliceClient;\n+    String bobUser = \"bob\";\n+    RestClient bobClient;\n+    String catUser = \"cat\";\n+    RestClient catClient;\n+    String dogUser = \"dog\";\n+    RestClient dogClient;\n+\n+    @Before\n+    public void setupSecureTests() throws IOException {\n+        if (!isHttps())\n+            return;\n+        createIndexRole(\"index_all_access\", \"*\");\n+        createUser(aliceUser, aliceUser, new ArrayList<>(Arrays.asList(\"odfe\")));\n+        aliceClient = new SecureRestClientBuilder(getClusterHosts().toArray(new HttpHost[0]), isHttps(), aliceUser, aliceUser)\n+            .setSocketTimeout(60000)\n+            .build();\n+\n+        createUser(bobUser, bobUser, new ArrayList<>(Arrays.asList(\"odfe\")));\n+        bobClient = new SecureRestClientBuilder(getClusterHosts().toArray(new HttpHost[0]), isHttps(), bobUser, bobUser)\n+            .setSocketTimeout(60000)\n+            .build();\n+\n+        createUser(catUser, catUser, new ArrayList<>(Arrays.asList(\"aes\")));\n+        catClient = new SecureRestClientBuilder(getClusterHosts().toArray(new HttpHost[0]), isHttps(), catUser, catUser)\n+            .setSocketTimeout(60000)\n+            .build();\n+\n+        createUser(dogUser, dogUser, new ArrayList<>(Arrays.asList()));\n+        dogClient = new SecureRestClientBuilder(getClusterHosts().toArray(new HttpHost[0]), isHttps(), dogUser, dogUser)\n+            .setSocketTimeout(60000)\n+            .build();\n+\n+        createRoleMapping(\"anomaly_read_access\", new ArrayList<>(Arrays.asList(bobUser)));\n+        createRoleMapping(\"anomaly_full_access\", new ArrayList<>(Arrays.asList(aliceUser, catUser, dogUser)));\n+        createRoleMapping(\"index_all_access\", new ArrayList<>(Arrays.asList(aliceUser, bobUser, catUser, dogUser)));\n+    }\n+\n+    @After\n+    public void deleteUserSetup() throws IOException {\n+        if (!isHttps())\n+            return;\n+        aliceClient.close();\n+        bobClient.close();\n+        catClient.close();\n+        dogClient.close();\n+        deleteUser(aliceUser);\n+        deleteUser(bobUser);\n+        deleteUser(catUser);\n+        deleteUser(dogUser);\n+    }\n+\n+    public void testCreateAnomalyDetectorWithWriteAccess() {\n+        if (!isHttps())\n+            return;\n+        try {\n+            // User Alice has AD full access, should be able to create a detector\n+            AnomalyDetector aliceDetector = createRandomAnomalyDetector(false, false, aliceClient);\n+            Assert.assertNotNull(aliceDetector.getDetectorId());\n+        } catch (IOException e) {\n+            Assert.assertTrue(\"User Alice could not create detector\", false);\n+        }\n+    }\n+\n+    public void testCreateAnomalyDetectorWithReadAccess() {\n+        if (!isHttps())\n+            return;\n+        try {\n+            // User Bob has AD read access, should not be able to create a detector\n+            AnomalyDetector bobDetector = createRandomAnomalyDetector(false, false, bobClient);\n+            Assert.assertNull(bobDetector.getDetectorId());\n+        } catch (IOException e) {\n+            if (!e.getMessage().contains(\"no permissions for [cluster:admin/opendistro/ad/detector/write]\")) {\n+                Assert.assertTrue(false);\n+            }\n+        }\n+    }\n+\n+    public void testStartDetectorWithReadAccess() {\n+        if (!isHttps())\n+            return;\n+        try {\n+            // User Bob has AD read access, should not be able to modify a detector\n+            AnomalyDetector aliceDetector = createRandomAnomalyDetector(false, false, aliceClient);\n+            Assert.assertNotNull(aliceDetector.getDetectorId());\n+            Response response = startAnomalyDetector(aliceDetector.getDetectorId(), bobClient);\n+            Assert.assertEquals(response.getStatusLine().toString(), \"HTTP/1.1 500 Internal Server Error\");\n+        } catch (IOException e) {\n+            if (!e.getMessage().contains(\"no permissions for [cluster:admin/opendistro/ad/detector/jobmanagement]\")) {\n+                Assert.assertTrue(false);\n+            }\n+        }\n+    }\n+\n+    public void testStartDetectorForWriteUser() {\n+        if (!isHttps())", "originalCommit": "f9cd1ad6acf2f55c0b320f59483521625198ae1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYzOTM3MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r543639370", "bodyText": "+1. we can throw exceptions in the @before method, and remove the checks in other places. To make it work, we  might need exclude this test case in the gradle.build", "author": "weicongs-amazon", "createdAt": "2020-12-15T19:48:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYzMjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUyODMxNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r544528314", "bodyText": "Thats a good point, sure. What I can do is exclude this test in build and throw an exception when isHttps is not set in the @before method", "author": "saratvemulapalli", "createdAt": "2020-12-16T18:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYzMjE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0MDc1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r543640759", "bodyText": "not very clear for the goal of this test case.  If the exception is expected, then 121L assert  can't be executed.  If not, then why is this exception is verified?", "author": "weicongs-amazon", "createdAt": "2020-12-15T19:50:29Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/rest/SecureADRestIT.java", "diffHunk": "@@ -0,0 +1,243 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.rest;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestClient;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+\n+import com.amazon.opendistroforelasticsearch.ad.AnomalyDetectorRestTestCase;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetector;\n+import com.amazon.opendistroforelasticsearch.commons.rest.SecureRestClientBuilder;\n+\n+public class SecureADRestIT extends AnomalyDetectorRestTestCase {\n+    String aliceUser = \"alice\";\n+    RestClient aliceClient;\n+    String bobUser = \"bob\";\n+    RestClient bobClient;\n+    String catUser = \"cat\";\n+    RestClient catClient;\n+    String dogUser = \"dog\";\n+    RestClient dogClient;\n+\n+    @Before\n+    public void setupSecureTests() throws IOException {\n+        if (!isHttps())\n+            return;\n+        createIndexRole(\"index_all_access\", \"*\");\n+        createUser(aliceUser, aliceUser, new ArrayList<>(Arrays.asList(\"odfe\")));\n+        aliceClient = new SecureRestClientBuilder(getClusterHosts().toArray(new HttpHost[0]), isHttps(), aliceUser, aliceUser)\n+            .setSocketTimeout(60000)\n+            .build();\n+\n+        createUser(bobUser, bobUser, new ArrayList<>(Arrays.asList(\"odfe\")));\n+        bobClient = new SecureRestClientBuilder(getClusterHosts().toArray(new HttpHost[0]), isHttps(), bobUser, bobUser)\n+            .setSocketTimeout(60000)\n+            .build();\n+\n+        createUser(catUser, catUser, new ArrayList<>(Arrays.asList(\"aes\")));\n+        catClient = new SecureRestClientBuilder(getClusterHosts().toArray(new HttpHost[0]), isHttps(), catUser, catUser)\n+            .setSocketTimeout(60000)\n+            .build();\n+\n+        createUser(dogUser, dogUser, new ArrayList<>(Arrays.asList()));\n+        dogClient = new SecureRestClientBuilder(getClusterHosts().toArray(new HttpHost[0]), isHttps(), dogUser, dogUser)\n+            .setSocketTimeout(60000)\n+            .build();\n+\n+        createRoleMapping(\"anomaly_read_access\", new ArrayList<>(Arrays.asList(bobUser)));\n+        createRoleMapping(\"anomaly_full_access\", new ArrayList<>(Arrays.asList(aliceUser, catUser, dogUser)));\n+        createRoleMapping(\"index_all_access\", new ArrayList<>(Arrays.asList(aliceUser, bobUser, catUser, dogUser)));\n+    }\n+\n+    @After\n+    public void deleteUserSetup() throws IOException {\n+        if (!isHttps())\n+            return;\n+        aliceClient.close();\n+        bobClient.close();\n+        catClient.close();\n+        dogClient.close();\n+        deleteUser(aliceUser);\n+        deleteUser(bobUser);\n+        deleteUser(catUser);\n+        deleteUser(dogUser);\n+    }\n+\n+    public void testCreateAnomalyDetectorWithWriteAccess() {\n+        if (!isHttps())\n+            return;\n+        try {\n+            // User Alice has AD full access, should be able to create a detector\n+            AnomalyDetector aliceDetector = createRandomAnomalyDetector(false, false, aliceClient);\n+            Assert.assertNotNull(aliceDetector.getDetectorId());\n+        } catch (IOException e) {\n+            Assert.assertTrue(\"User Alice could not create detector\", false);\n+        }\n+    }\n+\n+    public void testCreateAnomalyDetectorWithReadAccess() {\n+        if (!isHttps())\n+            return;\n+        try {\n+            // User Bob has AD read access, should not be able to create a detector\n+            AnomalyDetector bobDetector = createRandomAnomalyDetector(false, false, bobClient);\n+            Assert.assertNull(bobDetector.getDetectorId());\n+        } catch (IOException e) {\n+            if (!e.getMessage().contains(\"no permissions for [cluster:admin/opendistro/ad/detector/write]\")) {\n+                Assert.assertTrue(false);\n+            }\n+        }\n+    }\n+\n+    public void testStartDetectorWithReadAccess() {\n+        if (!isHttps())\n+            return;\n+        try {\n+            // User Bob has AD read access, should not be able to modify a detector\n+            AnomalyDetector aliceDetector = createRandomAnomalyDetector(false, false, aliceClient);\n+            Assert.assertNotNull(aliceDetector.getDetectorId());\n+            Response response = startAnomalyDetector(aliceDetector.getDetectorId(), bobClient);\n+            Assert.assertEquals(response.getStatusLine().toString(), \"HTTP/1.1 500 Internal Server Error\");\n+        } catch (IOException e) {\n+            if (!e.getMessage().contains(\"no permissions for [cluster:admin/opendistro/ad/detector/jobmanagement]\")) {\n+                Assert.assertTrue(false);\n+            }", "originalCommit": "f9cd1ad6acf2f55c0b320f59483521625198ae1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0MTI0Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r543641247", "bodyText": "See a couple of similar logic in other test cases.", "author": "weicongs-amazon", "createdAt": "2020-12-15T19:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0MDc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5NTg1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r543795859", "bodyText": "Yeah it should always land up in the exception, the idea was just incase it doesn't we should Assert and make sure it doesnt silently exit. Probably what I can do is is that have an assert without a condition.", "author": "saratvemulapalli", "createdAt": "2020-12-16T00:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0MDc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk1NDg4Mw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r543954883", "bodyText": "then it's better to use expected exception check. Currently the test case will be possibly passed when no exception is thrown", "author": "weicongs-amazon", "createdAt": "2020-12-16T05:00:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0MDc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUyNzIwMw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r544527203", "bodyText": "Thats a good point, sure. I'll make that change.", "author": "saratvemulapalli", "createdAt": "2020-12-16T18:29:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0MDc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgxNjk1Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r543816952", "bodyText": "How to run this secure REST integration test? Should we start a local ES cluster with security plugin installed, then run this IT?", "author": "ylwu-amzn", "createdAt": "2020-12-16T01:48:32Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/rest/SecureADRestIT.java", "diffHunk": "@@ -0,0 +1,243 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.rest;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestClient;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+\n+import com.amazon.opendistroforelasticsearch.ad.AnomalyDetectorRestTestCase;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetector;\n+import com.amazon.opendistroforelasticsearch.commons.rest.SecureRestClientBuilder;\n+\n+public class SecureADRestIT extends AnomalyDetectorRestTestCase {", "originalCommit": "f9cd1ad6acf2f55c0b320f59483521625198ae1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg3MTkzMg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r543871932", "bodyText": "Yeah Correct, have security plugin installed and then run these tests. You can run it using ./gradlew integTest -Dtests.rest.cluster=localhost:9200 -Dtests.cluster=localhost:9200 -Dtests.clustername=\"docker-cluster\" -Dhttps=true -Duser=admin -Dpassword=admin --tests \"com.amazon.opendistroforelasticsearch.ad.rest.SecureADRestIT.*\nThis is also run as part of our CI for every build: https://github.com/opendistro-for-elasticsearch/anomaly-detection/blob/master/.github/workflows/CI.yml#L77", "author": "saratvemulapalli", "createdAt": "2020-12-16T03:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgxNjk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDAyMzMzMw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r544023333", "bodyText": "Cool, can you also add this to README doc?", "author": "ylwu-amzn", "createdAt": "2020-12-16T06:29:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgxNjk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUyNjczNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r544526734", "bodyText": "Thats a good point sure.", "author": "saratvemulapalli", "createdAt": "2020-12-16T18:28:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgxNjk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0MDA5NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/331#discussion_r545340095", "bodyText": "Sent out a PR: #334.", "author": "saratvemulapalli", "createdAt": "2020-12-17T19:16:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgxNjk1Mg=="}], "type": "inlineReview"}, {"oid": "bd4ae091422eba8a420c5789d268998cbd720561", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/bd4ae091422eba8a420c5789d268998cbd720561", "message": "Excluding secure tests when not running against security plugin", "committedDate": "2020-12-17T18:45:15Z", "type": "commit"}, {"oid": "3d645bf5f80b4054e8f53ee6a9270019ebc81eab", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/3d645bf5f80b4054e8f53ee6a9270019ebc81eab", "message": "Updating Delete Detector test to expect exception", "committedDate": "2020-12-17T18:51:15Z", "type": "commit"}]}