{"pr_number": 240, "pr_title": "Verifying multi-entity detectors", "pr_createdAt": "2020-10-07T19:19:11Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240", "timeline": [{"oid": "33ede2ceedda83e461b54f09251c7f55ada68377", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/33ede2ceedda83e461b54f09251c7f55ada68377", "message": "Verifying multi-entity detectors\n\nThis PR adds categorical fields' number and length check. We only support one categorical field, and the categorical field can only be of type keyword and ip.  We also limit the max multi-entity detectors to 10.\n\nTesting done:\n1. added unit tests\n2. did manual testing.", "committedDate": "2020-10-08T16:17:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MzMwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r502183309", "bodyText": "What does this comment mean?", "author": "ylwu-amzn", "createdAt": "2020-10-09T04:30:15Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/handler/IndexAnomalyDetectorActionHandler.java", "diffHunk": "@@ -178,32 +196,130 @@ private void onGetAnomalyDetectorResponse(GetResponse response) throws IOExcepti\n             return;\n         }\n \n-        searchAdInputIndices(detectorId);\n+        validateCategoricalField(detectorId);\n     }\n \n     private void createAnomalyDetector() {\n         try {\n-            QueryBuilder query = QueryBuilders.matchAllQuery();\n-            SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().query(query).size(0).timeout(requestTimeout);\n+            List<String> categoricalFields = anomalyDetector.getCategoryField();\n+            if (categoricalFields != null && categoricalFields.size() > 0) {\n+                QueryBuilder query = QueryBuilders.boolQuery().filter(QueryBuilders.existsQuery(AnomalyDetector.CATEGORY_FIELD));\n \n-            SearchRequest searchRequest = new SearchRequest(ANOMALY_DETECTORS_INDEX).source(searchSourceBuilder);\n+                SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().query(query).size(0).timeout(requestTimeout);\n \n-            client.search(searchRequest, ActionListener.wrap(response -> onSearchAdResponse(response), exception -> onFailure(exception)));\n+                SearchRequest searchRequest = new SearchRequest(ANOMALY_DETECTORS_INDEX).source(searchSourceBuilder);\n+\n+                client\n+                    .search(\n+                        searchRequest,\n+                        ActionListener.wrap(response -> onSearchMultiEntityAdResponse(response), exception -> { onFailure(exception); })\n+                    );\n+            } else {\n+                QueryBuilder query = QueryBuilders.matchAllQuery();\n+                SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().query(query).size(0).timeout(requestTimeout);\n+\n+                SearchRequest searchRequest = new SearchRequest(ANOMALY_DETECTORS_INDEX).source(searchSourceBuilder);\n+\n+                client\n+                    .search(\n+                        searchRequest,\n+                        ActionListener.wrap(response -> onSearchSingleEntityAdResponse(response), exception -> onFailure(exception))\n+                    );\n+            }\n         } catch (Exception e) {\n             onFailure(e);\n         }\n     }\n \n-    private void onSearchAdResponse(SearchResponse response) throws IOException {\n-        if (response.getHits().getTotalHits().value >= maxAnomalyDetectors) {\n-            String errorMsg = \"Can't create anomaly detector more than \" + maxAnomalyDetectors;\n+    private void onSearchSingleEntityAdResponse(SearchResponse response) throws IOException {\n+        if (response.getHits().getTotalHits().value >= maxSingleEntityAnomalyDetectors) {\n+            String errorMsg = EXCEEDED_MAX_SINGLE_ENTITY_DETECTORS_PREFIX_MSG + maxSingleEntityAnomalyDetectors;\n             logger.error(errorMsg);\n             onFailure(new IllegalArgumentException(errorMsg));\n         } else {\n             searchAdInputIndices(null);\n         }\n     }\n \n+    private void onSearchMultiEntityAdResponse(SearchResponse response) throws IOException {\n+        if (response.getHits().getTotalHits().value >= maxMultiEntityAnomalyDetectors) {\n+            String errorMsg = EXCEEDED_MAX_MULTI_ENTITY_DETECTORS_PREFIX_MSG + maxMultiEntityAnomalyDetectors;\n+            logger.error(errorMsg);\n+            onFailure(new IllegalArgumentException(errorMsg));\n+        } else {\n+            validateCategoricalField(null);\n+        }\n+    }\n+\n+    /**\n+     * Precondition: anomalyDetector.getCategoryField() != null.", "originalCommit": "33ede2ceedda83e461b54f09251c7f55ada68377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2ODA1Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503468057", "bodyText": "not true anymore.  Removed.", "author": "kaituo", "createdAt": "2020-10-12T18:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MzMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4Mzk0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r502183942", "bodyText": "1 is magic number, how about we create CATEGORY_FIELD_LIMIT instant and use it at all other places. like IndexAnomalyDetectorActionHandler.java line 269:\nif (categoryField.size() != 1) {", "author": "ylwu-amzn", "createdAt": "2020-10-09T04:33:19Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -105,7 +107,62 @@\n      * @param uiMetadata        metadata used by Kibana\n      * @param schemaVersion     anomaly detector index mapping version\n      * @param lastUpdateTime    detector's last update time\n+     * @param categoryField     a list of partition fields\n      */\n+    public AnomalyDetector(\n+        String detectorId,\n+        Long version,\n+        String name,\n+        String description,\n+        String timeField,\n+        List<String> indices,\n+        List<Feature> features,\n+        QueryBuilder filterQuery,\n+        TimeConfiguration detectionInterval,\n+        TimeConfiguration windowDelay,\n+        Integer shingleSize,\n+        Map<String, Object> uiMetadata,\n+        Integer schemaVersion,\n+        Instant lastUpdateTime,\n+        List<String> categoryField\n+    ) {\n+        if (Strings.isBlank(name)) {\n+            throw new IllegalArgumentException(\"Detector name should be set\");\n+        }\n+        if (timeField == null) {\n+            throw new IllegalArgumentException(\"Time field should be set\");\n+        }\n+        if (indices == null || indices.isEmpty()) {\n+            throw new IllegalArgumentException(\"Indices should be set\");\n+        }\n+        if (detectionInterval == null) {\n+            throw new IllegalArgumentException(\"Detection interval should be set\");\n+        }\n+        if (shingleSize != null && shingleSize < 1) {\n+            throw new IllegalArgumentException(\"Shingle size must be a positive integer\");\n+        }\n+        if (categoryField != null && categoryField.size() > 1) {", "originalCommit": "33ede2ceedda83e461b54f09251c7f55ada68377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyNzAyOA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503427028", "bodyText": "+1 I like the simpler check.", "author": "saratvemulapalli", "createdAt": "2020-10-12T17:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4Mzk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NzcxMg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503467712", "bodyText": "changed", "author": "kaituo", "createdAt": "2020-10-12T18:33:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4Mzk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4NDYxOQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r502184619", "bodyText": "minor: if we plan to support multiple category fields, should we name this as \"categoryFields\" ?", "author": "ylwu-amzn", "createdAt": "2020-10-09T04:36:20Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -87,6 +88,7 @@\n     private final Map<String, Object> uiMetadata;\n     private final Integer schemaVersion;\n     private final Instant lastUpdateTime;\n+    private final List<String> categoryField;", "originalCommit": "33ede2ceedda83e461b54f09251c7f55ada68377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2Njk4Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503466986", "bodyText": "yes, changed", "author": "kaituo", "createdAt": "2020-10-12T18:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4NDYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyNzk3Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503427977", "bodyText": "I see we just use 1 category field today, do we see possible use cases of multiple category fields ?", "author": "saratvemulapalli", "createdAt": "2020-10-12T17:10:28Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -87,6 +88,7 @@\n     private final Map<String, Object> uiMetadata;\n     private final Integer schemaVersion;\n     private final Instant lastUpdateTime;\n+    private final List<String> categoryField;", "originalCommit": "33ede2ceedda83e461b54f09251c7f55ada68377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NzA5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503467092", "bodyText": "yes, maybe in the future", "author": "kaituo", "createdAt": "2020-10-12T18:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyNzk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5NTMyNw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503495327", "bodyText": "Do we plan to write HC detector's result into another index?", "author": "ylwu-amzn", "createdAt": "2020-10-12T19:39:47Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/constant/CommonName.java", "diffHunk": "@@ -22,6 +22,9 @@\n     // index name for anomaly checkpoint of each model. One model one document.\n     public static final String CHECKPOINT_INDEX_NAME = \".opendistro-anomaly-checkpoints\";\n \n+    // The alias of the index in which to write single-entity AD result history", "originalCommit": "febd0a571a2432ff663ab8e4b6bef0c4349edc52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU4OTgxMg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503589812", "bodyText": "not in the plan.  The code would have to change a lot for that to happen.  e.g., depends on there is categorical field or not, job scheduler will save to different places.  Right now, job scheduler does not have access to AnomalyDetector object.", "author": "kaituo", "createdAt": "2020-10-12T23:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5NTMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5Mzk4Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503593986", "bodyText": "Got it, how about remove the \"single-entity\" from the comments?", "author": "ylwu-amzn", "createdAt": "2020-10-12T23:55:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5NTMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwMDk3Mw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503600973", "bodyText": "removed.", "author": "kaituo", "createdAt": "2020-10-13T00:22:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5NTMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5NTU2Mw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503495563", "bodyText": "Should we change to \"category_fields\" ? Same question for line 113, 130, and other places. Suggest to replace by searching all files.", "author": "ylwu-amzn", "createdAt": "2020-10-12T19:40:22Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -72,6 +75,7 @@\n     private static final String SHINGLE_SIZE_FIELD = \"shingle_size\";\n     private static final String LAST_UPDATE_TIME_FIELD = \"last_update_time\";\n     public static final String UI_METADATA_FIELD = \"ui_metadata\";\n+    public static final String CATEGORY_FIELD = \"category_field\";", "originalCommit": "febd0a571a2432ff663ab8e4b6bef0c4349edc52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5NDYyNw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503594627", "bodyText": "Can we do it later?  Both Yizhe and I need to change for this.", "author": "kaituo", "createdAt": "2020-10-12T23:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5NTU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5ODMzNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503598334", "bodyText": "Sure, I'm ok", "author": "ylwu-amzn", "createdAt": "2020-10-13T00:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5NTU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwMTA0Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503601047", "bodyText": "Thanks so much for your consideration.", "author": "kaituo", "createdAt": "2020-10-13T00:23:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5NTU2Mw=="}], "type": "inlineReview"}, {"oid": "462dcc603c6854377254e670bfebfe88a72f3b4d", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/462dcc603c6854377254e670bfebfe88a72f3b4d", "message": "Verifying multi-entity detectors\n\nThis PR adds categorical fields' number and length check. We only support one categorical field, and the categorical field can only be of type keyword and ip.  We also limit the max multi-entity detectors to 10.\n\nTesting done:\n1. added unit tests\n2. did manual testing.", "committedDate": "2020-10-13T21:01:08Z", "type": "commit"}, {"oid": "b2787219e95c709274e1173863a4bb4fcfd39c14", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/b2787219e95c709274e1173863a4bb4fcfd39c14", "message": "Address comments", "committedDate": "2020-10-13T21:01:08Z", "type": "commit"}, {"oid": "99c5a4494213cac58cbc2a0e8e2eaacf467779b0", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/99c5a4494213cac58cbc2a0e8e2eaacf467779b0", "message": "Fix flaky test", "committedDate": "2020-10-13T21:01:08Z", "type": "commit"}, {"oid": "ff37fd3b3ac2065d1bd7f316696290715a2c6c01", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/ff37fd3b3ac2065d1bd7f316696290715a2c6c01", "message": "Merge from Sarat", "committedDate": "2020-10-13T21:01:08Z", "type": "commit"}, {"oid": "ff37fd3b3ac2065d1bd7f316696290715a2c6c01", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/ff37fd3b3ac2065d1bd7f316696290715a2c6c01", "message": "Merge from Sarat", "committedDate": "2020-10-13T21:01:08Z", "type": "forcePushed"}]}