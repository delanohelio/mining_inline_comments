{"pr_number": 286, "pr_title": "Adding new Search Detector Info API ", "pr_createdAt": "2020-10-22T07:08:58Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/286", "timeline": [{"oid": "d8fcc0807769f46120b3d3ec92b5745656a116b7", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/d8fcc0807769f46120b3d3ec92b5745656a116b7", "message": "Adding new Search Info API", "committedDate": "2020-10-22T06:58:41Z", "type": "commit"}, {"oid": "5703091e27b329bd983d469aab0785efcbd6b44c", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/5703091e27b329bd983d469aab0785efcbd6b44c", "message": "Adding Spotless changes", "committedDate": "2020-10-22T07:06:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI0MjU3MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/286#discussion_r510242570", "bodyText": "minor: could condense this into one line: boolean nameExists = searchResponse.getHits().getTotalHits().value > 0", "author": "ohltyler", "createdAt": "2020-10-22T15:12:09Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/SearchAnomalyDetectorInfoTransportAction.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.transport;\n+\n+import static com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetector.ANOMALY_DETECTORS_INDEX;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.HandledTransportAction;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.index.query.QueryBuilders;\n+import org.elasticsearch.index.query.TermsQueryBuilder;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.transport.TransportService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.util.RestHandlerUtils;\n+\n+public class SearchAnomalyDetectorInfoTransportAction extends\n+    HandledTransportAction<SearchAnomalyDetectorInfoRequest, SearchAnomalyDetectorInfoResponse> {\n+    private static final Logger LOG = LogManager.getLogger(SearchAnomalyDetectorInfoTransportAction.class);\n+    private final Client client;\n+    private final ClusterService clusterService;\n+\n+    @Inject\n+    public SearchAnomalyDetectorInfoTransportAction(\n+        TransportService transportService,\n+        ActionFilters actionFilters,\n+        Client client,\n+        ClusterService clusterService\n+    ) {\n+        super(SearchAnomalyDetectorInfoAction.NAME, transportService, actionFilters, SearchAnomalyDetectorInfoRequest::new);\n+        this.client = client;\n+        this.clusterService = clusterService;\n+    }\n+\n+    @Override\n+    protected void doExecute(\n+        Task task,\n+        SearchAnomalyDetectorInfoRequest request,\n+        ActionListener<SearchAnomalyDetectorInfoResponse> listener\n+    ) {\n+        String name = request.getName();\n+        String rawPath = request.getRawPath();\n+        try (ThreadContext.StoredContext context = client.threadPool().getThreadContext().stashContext()) {\n+            SearchRequest searchRequest = new SearchRequest().indices(ANOMALY_DETECTORS_INDEX);\n+            if (rawPath.endsWith(RestHandlerUtils.COUNT)) {\n+                // Count detectors\n+                SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();\n+                searchRequest.source(searchSourceBuilder);\n+                client.search(searchRequest, new ActionListener<SearchResponse>() {\n+\n+                    @Override\n+                    public void onResponse(SearchResponse searchResponse) {\n+                        SearchAnomalyDetectorInfoResponse response = new SearchAnomalyDetectorInfoResponse(\n+                            searchResponse.getHits().getTotalHits().value,\n+                            false\n+                        );\n+                        listener.onResponse(response);\n+                    }\n+\n+                    @Override\n+                    public void onFailure(Exception e) {\n+                        listener.onFailure(e);\n+                    }\n+                });\n+            } else {\n+                // Match name with existing detectors\n+                TermsQueryBuilder query = QueryBuilders.termsQuery(\"name.keyword\", name);\n+                SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().query(query);\n+                searchRequest.source(searchSourceBuilder);\n+                client.search(searchRequest, new ActionListener<SearchResponse>() {\n+\n+                    @Override\n+                    public void onResponse(SearchResponse searchResponse) {\n+                        boolean nameExists = false;\n+                        if (searchResponse.getHits().getTotalHits().value > 0) {\n+                            nameExists = true;\n+                        } else {\n+                            nameExists = false;\n+                        }", "originalCommit": "5703091e27b329bd983d469aab0785efcbd6b44c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI4NzMwNw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/286#discussion_r510287307", "bodyText": "Sure, thats a nice idea.", "author": "saratvemulapalli", "createdAt": "2020-10-22T16:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI0MjU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3NTE5MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/286#discussion_r510475190", "bodyText": "I see you switched NAME and INSTANCE sequence in this PR #284 , why we need to do that? Should we do the same thing here?", "author": "ylwu-amzn", "createdAt": "2020-10-22T21:42:35Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/SearchAnomalyDetectorInfoAction.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.transport;\n+\n+import org.elasticsearch.action.ActionType;\n+\n+public class SearchAnomalyDetectorInfoAction extends ActionType<SearchAnomalyDetectorInfoResponse> {\n+    public static final SearchAnomalyDetectorInfoAction INSTANCE = new SearchAnomalyDetectorInfoAction();", "originalCommit": "5703091e27b329bd983d469aab0785efcbd6b44c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5MTIzNQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/286#discussion_r510491235", "bodyText": "Sure makes sense.\nI''ll rebase my changes and update it.", "author": "saratvemulapalli", "createdAt": "2020-10-22T22:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3NTE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwNjA0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/286#discussion_r510506046", "bodyText": "I just saw the first part of the question, JVM is not smart enough, since INSTANCE depends on ACTION it must be defined first and if defined later string concat does not work. So I had to move it above.", "author": "saratvemulapalli", "createdAt": "2020-10-22T23:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3NTE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3NTgwNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/286#discussion_r510475804", "bodyText": "I see PR #284 merged,  change to use CommonValue.EXTERNAL_ACTION_PREFIX ?", "author": "ylwu-amzn", "createdAt": "2020-10-22T21:44:05Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/SearchAnomalyDetectorInfoAction.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.transport;\n+\n+import org.elasticsearch.action.ActionType;\n+\n+public class SearchAnomalyDetectorInfoAction extends ActionType<SearchAnomalyDetectorInfoResponse> {\n+    public static final SearchAnomalyDetectorInfoAction INSTANCE = new SearchAnomalyDetectorInfoAction();\n+    public static final String NAME = \"cluster:admin/opendistro/ad/detector/info\";", "originalCommit": "5703091e27b329bd983d469aab0785efcbd6b44c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwNjk1Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/286#discussion_r510506952", "bodyText": "Sure, will take care of it.", "author": "saratvemulapalli", "createdAt": "2020-10-22T23:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3NTgwNA=="}], "type": "inlineReview"}, {"oid": "6bee879a480e8d575418664435b38125c67b1f0c", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/6bee879a480e8d575418664435b38125c67b1f0c", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/anomaly-detection", "committedDate": "2020-10-22T22:26:18Z", "type": "commit"}, {"oid": "ed371e431e654faf022665029be60015e0f30e83", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/ed371e431e654faf022665029be60015e0f30e83", "message": "Merge branch 'master' into fgac-info-api", "committedDate": "2020-10-22T22:27:03Z", "type": "commit"}, {"oid": "9ce23c7fe3c6e61a5d3ae554bd38a8aade4621c1", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/9ce23c7fe3c6e61a5d3ae554bd38a8aade4621c1", "message": "Rebasing changes and addressing comments", "committedDate": "2020-10-22T23:07:08Z", "type": "commit"}]}