{"pr_number": 108, "pr_title": "Stats API: moved detector count call outside transport layer and make asynchronous", "pr_createdAt": "2020-05-05T18:58:20Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108", "timeline": [{"oid": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/f10ec35c506aaa7d627cd1346b932817185fbc7c", "message": "moved detector count call outside transport layer", "committedDate": "2020-05-05T17:12:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM5MjM3Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420392376", "bodyText": "Minor. other instanceof ADStatsResponse seems better.", "author": "wnbts", "createdAt": "2020-05-05T20:40:49Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/stats/ADStatsResponse.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.stats;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+import com.amazon.opendistroforelasticsearch.ad.model.Mergeable;\n+import com.amazon.opendistroforelasticsearch.ad.transport.ADStatsNodesResponse;\n+import org.apache.commons.lang.builder.EqualsBuilder;\n+import org.apache.commons.lang.builder.HashCodeBuilder;\n+import org.apache.commons.lang.builder.ToStringBuilder;\n+import org.elasticsearch.common.xcontent.ToXContent;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+\n+/**\n+ * ADStatsResponse contains logic to merge the node stats and cluster stats together and return them to user\n+ */\n+public class ADStatsResponse implements ToXContentObject, Mergeable {\n+    private ADStatsNodesResponse adStatsNodesResponse;\n+    private Map<String, Object> clusterStats;\n+\n+    /**\n+     * Get cluster stats\n+     *\n+     * @return Map of cluster stats\n+     */\n+    public Map<String, Object> getClusterStats() {\n+        return clusterStats;\n+    }\n+\n+    /**\n+     * Set cluster stats\n+     *\n+     * @param clusterStats Map of cluster stats\n+     */\n+    public void setClusterStats(Map<String, Object> clusterStats) {\n+        this.clusterStats = clusterStats;\n+    }\n+\n+    /**\n+     * Get cluster stats\n+     *\n+     * @return ADStatsNodesResponse\n+     */\n+    public ADStatsNodesResponse getADStatsNodesResponse() {\n+        return adStatsNodesResponse;\n+    }\n+\n+    /**\n+     * Sets adStatsNodesResponse\n+     *\n+     * @param adStatsNodesResponse AD Stats Response from Nodes\n+     */\n+    public void setADStatsNodesResponse(ADStatsNodesResponse adStatsNodesResponse) {\n+        this.adStatsNodesResponse = adStatsNodesResponse;\n+    }\n+\n+    /**\n+     * Convert ADStatsResponse to XContent\n+     *\n+     * @param builder XContentBuilder\n+     * @return XContentBuilder\n+     * @throws IOException thrown on invalid input\n+     */\n+    public XContentBuilder toXContent(XContentBuilder builder) throws IOException {\n+        return toXContent(builder, ToXContent.EMPTY_PARAMS);\n+    }\n+\n+    @Override\n+    public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+        XContentBuilder xContentBuilder = builder.startObject();\n+        for (Map.Entry<String, Object> clusterStat : clusterStats.entrySet()) {\n+            builder.field(clusterStat.getKey(), clusterStat.getValue());\n+        }\n+        adStatsNodesResponse.toXContent(xContentBuilder, ToXContent.EMPTY_PARAMS);\n+        return xContentBuilder.endObject();\n+    }\n+\n+    @Override\n+    public void merge(Mergeable other) {\n+        if (this == other || other == null || getClass() != other.getClass()) {", "originalCommit": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3MTM2MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420471360", "bodyText": "Good point will fix", "author": "jmazanec15", "createdAt": "2020-05-05T23:42:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM5MjM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyMzI2MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420523260", "bodyText": "We don't want to use instanceof since this makes a subclass relationship returns true.  We want to have exact same class.", "author": "kaituo", "createdAt": "2020-05-06T03:13:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM5MjM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkxMjgzNw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420912837", "bodyText": "That makes sense, will change back.", "author": "jmazanec15", "createdAt": "2020-05-06T16:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM5MjM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM5Mzk0NA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420393944", "bodyText": "Minor. Some edge cases might be handled more clearly, such as when both have node responses/cluster stats, throw an exception if unexpected.", "author": "wnbts", "createdAt": "2020-05-05T20:43:35Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/stats/ADStatsResponse.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.stats;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+import com.amazon.opendistroforelasticsearch.ad.model.Mergeable;\n+import com.amazon.opendistroforelasticsearch.ad.transport.ADStatsNodesResponse;\n+import org.apache.commons.lang.builder.EqualsBuilder;\n+import org.apache.commons.lang.builder.HashCodeBuilder;\n+import org.apache.commons.lang.builder.ToStringBuilder;\n+import org.elasticsearch.common.xcontent.ToXContent;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+\n+/**\n+ * ADStatsResponse contains logic to merge the node stats and cluster stats together and return them to user\n+ */\n+public class ADStatsResponse implements ToXContentObject, Mergeable {\n+    private ADStatsNodesResponse adStatsNodesResponse;\n+    private Map<String, Object> clusterStats;\n+\n+    /**\n+     * Get cluster stats\n+     *\n+     * @return Map of cluster stats\n+     */\n+    public Map<String, Object> getClusterStats() {\n+        return clusterStats;\n+    }\n+\n+    /**\n+     * Set cluster stats\n+     *\n+     * @param clusterStats Map of cluster stats\n+     */\n+    public void setClusterStats(Map<String, Object> clusterStats) {\n+        this.clusterStats = clusterStats;\n+    }\n+\n+    /**\n+     * Get cluster stats\n+     *\n+     * @return ADStatsNodesResponse\n+     */\n+    public ADStatsNodesResponse getADStatsNodesResponse() {\n+        return adStatsNodesResponse;\n+    }\n+\n+    /**\n+     * Sets adStatsNodesResponse\n+     *\n+     * @param adStatsNodesResponse AD Stats Response from Nodes\n+     */\n+    public void setADStatsNodesResponse(ADStatsNodesResponse adStatsNodesResponse) {\n+        this.adStatsNodesResponse = adStatsNodesResponse;\n+    }\n+\n+    /**\n+     * Convert ADStatsResponse to XContent\n+     *\n+     * @param builder XContentBuilder\n+     * @return XContentBuilder\n+     * @throws IOException thrown on invalid input\n+     */\n+    public XContentBuilder toXContent(XContentBuilder builder) throws IOException {\n+        return toXContent(builder, ToXContent.EMPTY_PARAMS);\n+    }\n+\n+    @Override\n+    public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+        XContentBuilder xContentBuilder = builder.startObject();\n+        for (Map.Entry<String, Object> clusterStat : clusterStats.entrySet()) {\n+            builder.field(clusterStat.getKey(), clusterStat.getValue());\n+        }\n+        adStatsNodesResponse.toXContent(xContentBuilder, ToXContent.EMPTY_PARAMS);\n+        return xContentBuilder.endObject();\n+    }\n+\n+    @Override\n+    public void merge(Mergeable other) {\n+        if (this == other || other == null || getClass() != other.getClass()) {\n+            return;\n+        }\n+\n+        ADStatsResponse otherResponse = (ADStatsResponse) other;\n+\n+        if (otherResponse.adStatsNodesResponse != null) {", "originalCommit": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3MjU4NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420472585", "bodyText": "For this object, the expected behavior if other has both node response and cluster stats is to merge them both into the object.", "author": "jmazanec15", "createdAt": "2020-05-05T23:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM5Mzk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQwMDQ5Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420400497", "bodyText": "Minor. Seems more consistent to use adStats.getClusterStats() as in the for loop.", "author": "wnbts", "createdAt": "2020-05-05T20:55:28Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/RestStatsAnomalyDetectorAction.java", "diffHunk": "@@ -115,4 +131,111 @@ private ADStatsRequest getRequest(RestRequest request) {\n         }\n         return adStatsRequest;\n     }\n+\n+    /**\n+     * Make the 2 requests to get the node and cluster statistics\n+     *\n+     * @param client Client\n+     * @param channel Channel to send response\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void getStats(Client client, RestChannel channel, ADStatsRequest adStatsRequest) {\n+        // Use MultiResponsesDelegateActionListener to execute 2 async requests and create the response once they finish\n+        MultiResponsesDelegateActionListener<ADStatsResponse> delegateListener = new MultiResponsesDelegateActionListener<>(\n+            getRestStatsListener(channel),\n+            2,\n+            \"Unable to return AD Stats\"\n+        );\n+\n+        onGetClusterStats(client, delegateListener, adStatsRequest);\n+        onGetNodeStats(client, delegateListener, adStatsRequest);\n+    }\n+\n+    /**\n+     * Make async request to get the number of detectors in AnomalyDetector.ANOMALY_DETECTORS_INDEX if necessary\n+     * and, onResponse, gather the cluster statistics\n+     *\n+     * @param client Client\n+     * @param listener MultiResponsesDelegateActionListener to be used once both requests complete\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void onGetClusterStats(\n+        Client client,\n+        MultiResponsesDelegateActionListener<ADStatsResponse> listener,\n+        ADStatsRequest adStatsRequest\n+    ) {\n+        ADStatsResponse adStatsResponse = new ADStatsResponse();\n+        if (adStatsRequest.getStatsToBeRetrieved().contains(StatNames.DETECTOR_COUNT.getName())) {\n+            if (clusterService.state().getRoutingTable().hasIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX)) {\n+                IndicesStatsRequest indicesStatsRequest = new IndicesStatsRequest();\n+                client.execute(IndicesStatsAction.INSTANCE, indicesStatsRequest, ActionListener.wrap(indicesStatsResponse -> {\n+                    adStats\n+                        .getStat(StatNames.DETECTOR_COUNT.getName())\n+                        .setValue(indicesStatsResponse.getIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX).getPrimaries().docs.getCount());\n+                    adStatsResponse.setClusterStats(getClusterStats(adStatsRequest));\n+                    listener.onResponse(adStatsResponse);\n+                }, e -> listener.onFailure(new RuntimeException(\"Failed to get AD cluster stats: \" + e))));\n+            } else {\n+                adStats.getStat(StatNames.DETECTOR_COUNT.getName()).setValue(0L);\n+                adStatsResponse.setClusterStats(getClusterStats(adStatsRequest));\n+                listener.onResponse(adStatsResponse);\n+            }\n+        } else {\n+            adStatsResponse.setClusterStats(getClusterStats(adStatsRequest));\n+            listener.onResponse(adStatsResponse);\n+        }\n+    }\n+\n+    /**\n+     * Make async request to get the Anomaly Detection statistics from each node and, onResponse, set the\n+     * ADStatsNodesResponse field of ADStatsResponse\n+     *\n+     * @param client Client\n+     * @param listener MultiResponsesDelegateActionListener to be used once both requests complete\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void onGetNodeStats(\n+        Client client,\n+        MultiResponsesDelegateActionListener<ADStatsResponse> listener,\n+        ADStatsRequest adStatsRequest\n+    ) {\n+        client.execute(ADStatsNodesAction.INSTANCE, adStatsRequest, ActionListener.wrap(adStatsResponse -> {\n+            ADStatsResponse restADStatsResponse = new ADStatsResponse();\n+            restADStatsResponse.setADStatsNodesResponse(adStatsResponse);\n+            listener.onResponse(restADStatsResponse);\n+        }, listener::onFailure));\n+    }\n+\n+    /**\n+     * Collect Cluster Stats into map to be retrieved\n+     *\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     * @return Map containing Cluster Stats\n+     */\n+    private Map<String, Object> getClusterStats(ADStatsRequest adStatsRequest) {\n+        Map<String, Object> clusterStats = new HashMap<>();\n+        Set<String> statsToBeRetrieved = adStatsRequest.getStatsToBeRetrieved();\n+        for (String statName : adStats.getClusterStats().keySet()) {\n+            if (statsToBeRetrieved.contains(statName)) {\n+                clusterStats.put(statName, adStats.getStats().get(statName).getValue());", "originalCommit": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ1Mzg1NA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420453854", "bodyText": "a different way might be iterating the entries using map::entrySet", "author": "wnbts", "createdAt": "2020-05-05T22:52:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQwMDQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NDcyOQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420474729", "bodyText": "Good suggestion", "author": "jmazanec15", "createdAt": "2020-05-05T23:53:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQwMDQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0OTgyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420449825", "bodyText": "minor. should ad_stats_action be renamed to ad_stats_node_action ?", "author": "wnbts", "createdAt": "2020-05-05T22:42:32Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/ADStatsNodesAction.java", "diffHunk": "@@ -18,18 +18,18 @@\n import org.elasticsearch.action.ActionType;\n \n /**\n- * ADStatsAction class\n+ * ADStatsNodesAction class\n  */\n-public class ADStatsAction extends ActionType<ADStatsResponse> {\n+public class ADStatsNodesAction extends ActionType<ADStatsNodesResponse> {\n \n-    public static final ADStatsAction INSTANCE = new ADStatsAction();\n+    public static final ADStatsNodesAction INSTANCE = new ADStatsNodesAction();\n     public static final String NAME = \"cluster:admin/ad_stats_action\";", "originalCommit": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NDc5MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420474790", "bodyText": "Yes it should good catch.", "author": "jmazanec15", "createdAt": "2020-05-05T23:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0OTgyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNDgzOA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420524838", "bodyText": "all of our transport actions are using prefix \"cluster:admin/ad\" like:\n\"cluster:admin/ad/result\"\n\"cluster:admin/ad/cron\"\n\"cluster:admin/ad/model/delete\"\nIt would be good to have the same style.", "author": "kaituo", "createdAt": "2020-05-06T03:21:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0OTgyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkxMjUwMg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420912502", "bodyText": "Good call out. Will update.", "author": "jmazanec15", "createdAt": "2020-05-06T16:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0OTgyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ1MTc2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420451767", "bodyText": "minor. The get methods should be private because they are implementation not contract. Tests are done based on contract not implementation. Because implementation is not client-facing, the full documentation is optional.", "author": "wnbts", "createdAt": "2020-05-05T22:47:13Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/RestStatsAnomalyDetectorAction.java", "diffHunk": "@@ -115,4 +131,111 @@ private ADStatsRequest getRequest(RestRequest request) {\n         }\n         return adStatsRequest;\n     }\n+\n+    /**\n+     * Make the 2 requests to get the node and cluster statistics\n+     *\n+     * @param client Client\n+     * @param channel Channel to send response\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void getStats(Client client, RestChannel channel, ADStatsRequest adStatsRequest) {", "originalCommit": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NTE2OQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420475169", "bodyText": "Good point. I will update them.", "author": "jmazanec15", "createdAt": "2020-05-05T23:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ1MTc2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxODYyOQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420418629", "bodyText": "on is more of a name for listener.  You can change to getClusterStats or sth similar.  Same applies below.", "author": "kaituo", "createdAt": "2020-05-05T21:30:53Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/RestStatsAnomalyDetectorAction.java", "diffHunk": "@@ -115,4 +131,111 @@ private ADStatsRequest getRequest(RestRequest request) {\n         }\n         return adStatsRequest;\n     }\n+\n+    /**\n+     * Make the 2 requests to get the node and cluster statistics\n+     *\n+     * @param client Client\n+     * @param channel Channel to send response\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void getStats(Client client, RestChannel channel, ADStatsRequest adStatsRequest) {\n+        // Use MultiResponsesDelegateActionListener to execute 2 async requests and create the response once they finish\n+        MultiResponsesDelegateActionListener<ADStatsResponse> delegateListener = new MultiResponsesDelegateActionListener<>(\n+            getRestStatsListener(channel),\n+            2,\n+            \"Unable to return AD Stats\"\n+        );\n+\n+        onGetClusterStats(client, delegateListener, adStatsRequest);", "originalCommit": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NjAzOA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420476038", "bodyText": "Good point. Will update both.", "author": "jmazanec15", "createdAt": "2020-05-05T23:57:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxODYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyMzcyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420423725", "bodyText": "You only need docs statistics.  .setDocs(true) seems what you need.", "author": "kaituo", "createdAt": "2020-05-05T21:41:16Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/RestStatsAnomalyDetectorAction.java", "diffHunk": "@@ -115,4 +131,111 @@ private ADStatsRequest getRequest(RestRequest request) {\n         }\n         return adStatsRequest;\n     }\n+\n+    /**\n+     * Make the 2 requests to get the node and cluster statistics\n+     *\n+     * @param client Client\n+     * @param channel Channel to send response\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void getStats(Client client, RestChannel channel, ADStatsRequest adStatsRequest) {\n+        // Use MultiResponsesDelegateActionListener to execute 2 async requests and create the response once they finish\n+        MultiResponsesDelegateActionListener<ADStatsResponse> delegateListener = new MultiResponsesDelegateActionListener<>(\n+            getRestStatsListener(channel),\n+            2,\n+            \"Unable to return AD Stats\"\n+        );\n+\n+        onGetClusterStats(client, delegateListener, adStatsRequest);\n+        onGetNodeStats(client, delegateListener, adStatsRequest);\n+    }\n+\n+    /**\n+     * Make async request to get the number of detectors in AnomalyDetector.ANOMALY_DETECTORS_INDEX if necessary\n+     * and, onResponse, gather the cluster statistics\n+     *\n+     * @param client Client\n+     * @param listener MultiResponsesDelegateActionListener to be used once both requests complete\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void onGetClusterStats(\n+        Client client,\n+        MultiResponsesDelegateActionListener<ADStatsResponse> listener,\n+        ADStatsRequest adStatsRequest\n+    ) {\n+        ADStatsResponse adStatsResponse = new ADStatsResponse();\n+        if (adStatsRequest.getStatsToBeRetrieved().contains(StatNames.DETECTOR_COUNT.getName())) {\n+            if (clusterService.state().getRoutingTable().hasIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX)) {\n+                IndicesStatsRequest indicesStatsRequest = new IndicesStatsRequest();", "originalCommit": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NjM4MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420476380", "bodyText": "Right that is correct. Will update.", "author": "jmazanec15", "createdAt": "2020-05-05T23:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyMzcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyNTA4MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420425080", "bodyText": "new RuntimeException(\"Failed to get AD cluster stats\", e) is more common.", "author": "kaituo", "createdAt": "2020-05-05T21:44:16Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/RestStatsAnomalyDetectorAction.java", "diffHunk": "@@ -115,4 +131,111 @@ private ADStatsRequest getRequest(RestRequest request) {\n         }\n         return adStatsRequest;\n     }\n+\n+    /**\n+     * Make the 2 requests to get the node and cluster statistics\n+     *\n+     * @param client Client\n+     * @param channel Channel to send response\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void getStats(Client client, RestChannel channel, ADStatsRequest adStatsRequest) {\n+        // Use MultiResponsesDelegateActionListener to execute 2 async requests and create the response once they finish\n+        MultiResponsesDelegateActionListener<ADStatsResponse> delegateListener = new MultiResponsesDelegateActionListener<>(\n+            getRestStatsListener(channel),\n+            2,\n+            \"Unable to return AD Stats\"\n+        );\n+\n+        onGetClusterStats(client, delegateListener, adStatsRequest);\n+        onGetNodeStats(client, delegateListener, adStatsRequest);\n+    }\n+\n+    /**\n+     * Make async request to get the number of detectors in AnomalyDetector.ANOMALY_DETECTORS_INDEX if necessary\n+     * and, onResponse, gather the cluster statistics\n+     *\n+     * @param client Client\n+     * @param listener MultiResponsesDelegateActionListener to be used once both requests complete\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void onGetClusterStats(\n+        Client client,\n+        MultiResponsesDelegateActionListener<ADStatsResponse> listener,\n+        ADStatsRequest adStatsRequest\n+    ) {\n+        ADStatsResponse adStatsResponse = new ADStatsResponse();\n+        if (adStatsRequest.getStatsToBeRetrieved().contains(StatNames.DETECTOR_COUNT.getName())) {\n+            if (clusterService.state().getRoutingTable().hasIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX)) {\n+                IndicesStatsRequest indicesStatsRequest = new IndicesStatsRequest();\n+                client.execute(IndicesStatsAction.INSTANCE, indicesStatsRequest, ActionListener.wrap(indicesStatsResponse -> {\n+                    adStats\n+                        .getStat(StatNames.DETECTOR_COUNT.getName())\n+                        .setValue(indicesStatsResponse.getIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX).getPrimaries().docs.getCount());\n+                    adStatsResponse.setClusterStats(getClusterStats(adStatsRequest));\n+                    listener.onResponse(adStatsResponse);\n+                }, e -> listener.onFailure(new RuntimeException(\"Failed to get AD cluster stats: \" + e))));", "originalCommit": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NjY2OA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420476668", "bodyText": "Got it. Will update.", "author": "jmazanec15", "createdAt": "2020-05-05T23:59:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyNTA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MzI3Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420463277", "bodyText": "Since you didn't set a value here, would it be possible that we pick some value set previously?", "author": "kaituo", "createdAt": "2020-05-05T23:17:28Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/RestStatsAnomalyDetectorAction.java", "diffHunk": "@@ -115,4 +131,111 @@ private ADStatsRequest getRequest(RestRequest request) {\n         }\n         return adStatsRequest;\n     }\n+\n+    /**\n+     * Make the 2 requests to get the node and cluster statistics\n+     *\n+     * @param client Client\n+     * @param channel Channel to send response\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void getStats(Client client, RestChannel channel, ADStatsRequest adStatsRequest) {\n+        // Use MultiResponsesDelegateActionListener to execute 2 async requests and create the response once they finish\n+        MultiResponsesDelegateActionListener<ADStatsResponse> delegateListener = new MultiResponsesDelegateActionListener<>(\n+            getRestStatsListener(channel),\n+            2,\n+            \"Unable to return AD Stats\"\n+        );\n+\n+        onGetClusterStats(client, delegateListener, adStatsRequest);\n+        onGetNodeStats(client, delegateListener, adStatsRequest);\n+    }\n+\n+    /**\n+     * Make async request to get the number of detectors in AnomalyDetector.ANOMALY_DETECTORS_INDEX if necessary\n+     * and, onResponse, gather the cluster statistics\n+     *\n+     * @param client Client\n+     * @param listener MultiResponsesDelegateActionListener to be used once both requests complete\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void onGetClusterStats(\n+        Client client,\n+        MultiResponsesDelegateActionListener<ADStatsResponse> listener,\n+        ADStatsRequest adStatsRequest\n+    ) {\n+        ADStatsResponse adStatsResponse = new ADStatsResponse();\n+        if (adStatsRequest.getStatsToBeRetrieved().contains(StatNames.DETECTOR_COUNT.getName())) {\n+            if (clusterService.state().getRoutingTable().hasIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX)) {\n+                IndicesStatsRequest indicesStatsRequest = new IndicesStatsRequest();\n+                client.execute(IndicesStatsAction.INSTANCE, indicesStatsRequest, ActionListener.wrap(indicesStatsResponse -> {\n+                    adStats\n+                        .getStat(StatNames.DETECTOR_COUNT.getName())\n+                        .setValue(indicesStatsResponse.getIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX).getPrimaries().docs.getCount());\n+                    adStatsResponse.setClusterStats(getClusterStats(adStatsRequest));\n+                    listener.onResponse(adStatsResponse);\n+                }, e -> listener.onFailure(new RuntimeException(\"Failed to get AD cluster stats: \" + e))));\n+            } else {\n+                adStats.getStat(StatNames.DETECTOR_COUNT.getName()).setValue(0L);\n+                adStatsResponse.setClusterStats(getClusterStats(adStatsRequest));\n+                listener.onResponse(adStatsResponse);\n+            }\n+        } else {\n+            adStatsResponse.setClusterStats(getClusterStats(adStatsRequest));", "originalCommit": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3Njk5OA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420476998", "bodyText": "This else block is only entered if the user does not want to get the detector count stat. So, it will not be retrieved.", "author": "jmazanec15", "createdAt": "2020-05-06T00:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNDA5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420524091", "bodyText": "Got it.  Is SettableSupplier's value a singleton shared by all of the requests?  Would we have concurrent issue like one thread is writing to it while another is reading it?", "author": "kaituo", "createdAt": "2020-05-06T03:17:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkzNjYxNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420936614", "bodyText": "Yes SettableSupplier's value is a singleton. SettableSupplier uses AtomicLong for thread safety.\nI believe this is the scenario of concern:\n\nasync request(req_1) to get detector count is made (detector count = 3)\ndetector is created (detector count = 4)\nasync request(req_2) to get detector count is made (detector count = 4)\nreq_2 returns and sets detector count to 4\nreq_1 returns and sets detector count to 3\nstats are returned for req_1 with detector count = 3\nstats are returned for req_2 with detector count = 3\n\nI think this is a minor issue for a couple of reasons. (1) On each stats request, the detector count is updated so it will not put the system in a permanent state of inconsistency (2) The scenario above is low probability because detector count is not expected to be that volatile and also stats api calls are not expected to be in that tight of a window.\nA workaround could be to pass the detector count to getClusterStatsMap(ADStatsRequest adStatsRequest) and have a special case for DetectorCount stat. However, I am not sure this is best practice. Do you have any other suggestions?", "author": "jmazanec15", "createdAt": "2020-05-06T16:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTExNTk2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r421115965", "bodyText": "Agree it is a minor issue since document count is only used by humans, right?\nCan you create a github issue for this?", "author": "kaituo", "createdAt": "2020-05-06T21:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEyMDQ4Mw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r421120483", "bodyText": "Yes only humans will read.\n#112", "author": "jmazanec15", "createdAt": "2020-05-06T22:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MzI3Nw=="}], "type": "inlineReview"}, {"oid": "8943661a1a01de7b06f461a805d5dda6fd41d111", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/8943661a1a01de7b06f461a805d5dda6fd41d111", "message": "fixed minor issues with styling", "committedDate": "2020-05-06T00:17:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNDMyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420524325", "bodyText": "Is it always 2?  If customers don't want to get detector count or only want to get detector count, this value should be 1.", "author": "kaituo", "createdAt": "2020-05-06T03:19:07Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/RestStatsAnomalyDetectorAction.java", "diffHunk": "@@ -115,4 +131,111 @@ private ADStatsRequest getRequest(RestRequest request) {\n         }\n         return adStatsRequest;\n     }\n+\n+    /**\n+     * Make the 2 requests to get the node and cluster statistics\n+     *\n+     * @param client Client\n+     * @param channel Channel to send response\n+     * @param adStatsRequest Request containing stats to be retrieved\n+     */\n+    public void getStats(Client client, RestChannel channel, ADStatsRequest adStatsRequest) {\n+        // Use MultiResponsesDelegateActionListener to execute 2 async requests and create the response once they finish\n+        MultiResponsesDelegateActionListener<ADStatsResponse> delegateListener = new MultiResponsesDelegateActionListener<>(\n+            getRestStatsListener(channel),\n+            2,", "originalCommit": "f10ec35c506aaa7d627cd1346b932817185fbc7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkzOTg4OQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/108#discussion_r420939889", "bodyText": "Yes it is always 2. We still call the listeners onResponse method even if the calls are not made. For example, here", "author": "jmazanec15", "createdAt": "2020-05-06T16:49:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNDMyNQ=="}], "type": "inlineReview"}, {"oid": "568dc07c3f404cd53341aca6f2d5a21cee756ab3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/568dc07c3f404cd53341aca6f2d5a21cee756ab3", "message": "minor style fixes", "committedDate": "2020-05-06T17:27:15Z", "type": "commit"}]}