{"pr_number": 54, "pr_title": "Cancel query if given detector already have one", "pr_createdAt": "2020-03-05T23:37:39Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54", "timeline": [{"oid": "33753963184439de58d752366c8d14756a70781a", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/33753963184439de58d752366c8d14756a70781a", "message": "Add daily cron job to clean negative cache", "committedDate": "2020-02-18T22:03:43Z", "type": "commit"}, {"oid": "87badb1b216adba3a6f91573f2d4b471adeae8eb", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/87badb1b216adba3a6f91573f2d4b471adeae8eb", "message": "Adding missing java doc and simplify code.", "committedDate": "2020-02-18T22:22:21Z", "type": "commit"}, {"oid": "4c189712552aa1a218b3df152db6bde43b347bb3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/4c189712552aa1a218b3df152db6bde43b347bb3", "message": "Create CancelQueryUtil to handle query canceling logic", "committedDate": "2020-02-19T16:34:03Z", "type": "commit"}, {"oid": "08dfb54192206f41eadb890dd1e1a7a28098d14c", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/08dfb54192206f41eadb890dd1e1a7a28098d14c", "message": "Add cron job test cases", "committedDate": "2020-02-19T23:00:19Z", "type": "commit"}, {"oid": "8c64199e017d1dbd108e843d7368fa60ea328f0f", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/8c64199e017d1dbd108e843d7368fa60ea328f0f", "message": "Add additional clean", "committedDate": "2020-02-24T23:59:34Z", "type": "commit"}, {"oid": "99e9487c3af27299a90ccab285757e5942b63d5c", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/99e9487c3af27299a90ccab285757e5942b63d5c", "message": "Commit all changes", "committedDate": "2020-02-25T16:49:46Z", "type": "commit"}, {"oid": "df38d00fbdb9dd741c1ec85f9995b9d366faabb7", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/df38d00fbdb9dd741c1ec85f9995b9d366faabb7", "message": "Merge branch 'cron' into cancel_query", "committedDate": "2020-02-25T17:10:14Z", "type": "commit"}, {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/d797543fc24e1c7213ad2053fb255b0b371e6df9", "message": "Cancel long running query if a new request coming for given detector id", "committedDate": "2020-03-05T23:33:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjQ0MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390086441", "bodyText": "Would\n\"if (task.getHeaders().get(Task.X_OPAQUE_ID).equals(CommonName.ANOMALY_DETECTOR + \":\" + detectorId))\"\nimproves performance since you might need do this comparison a lot of times if there are a lot of tasks?\nequals is O(n), while contains can be O(n*m) where m is the string to match and n is the string to search.\nSee the implementation of contains (depends on indexOf):\nhttp://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/lang/String.java#l1740", "author": "kaituo", "createdAt": "2020-03-10T04:12:56Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();\n+        client\n+            .execute(\n+                ListTasksAction.INSTANCE,\n+                listTasksRequest,\n+                ActionListener.wrap(response -> { onListTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"List Tasks failed.\", exception);\n+                    throw new InternalFailure(detectorId, \"Failed to list current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle ListTasksResponse\n+     * @param listTasksResponse ListTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onListTaskResponse(ListTasksResponse listTasksResponse, String detectorId, Logger LOG) {\n+        List<TaskInfo> tasks = listTasksResponse.getTasks();\n+        TaskInfo matchedTask = null;\n+        for (TaskInfo task : tasks) {\n+            if (!task.getHeaders().isEmpty() && task.getHeaders().get(Task.X_OPAQUE_ID) != null) {\n+                if (task.getHeaders().get(Task.X_OPAQUE_ID).contains(detectorId)) {", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEyMDI0OQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391120249", "bodyText": "Thanks for the suggestion, will change it.", "author": "zhanghg08", "createdAt": "2020-03-11T16:57:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MTcxMg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390091712", "bodyText": "Return after cancelling since we don't know when the cancel would actually happen?  We might keep piling up new queries when the previous old queries are not cancelled.\nAlso, we need to send InternalFailure not EndRunException.  EndRunException is used for scenarios when we might need to terminate AD job running soon.", "author": "kaituo", "createdAt": "2020-03-10T04:38:34Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -179,32 +197,36 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n         BiConsumer<Request, ActionListener<Response>> consumer,\n         AnomalyDetector detector\n     ) {\n+\n         try {\n-            // if key already exist, reject the request and throws exception\n-            if (!throttler.insertFilteredQuery(detector.getDetectorId(), request)) {\n-                LOG.error(\"There is one query running for detectorId: {}\", detector.getDetectorId());\n-                throw new EndRunException(detector.getDetectorId(), \"There is one query running on AnomalyDetector\", true);\n+            String detectorId = detector.getDetectorId();\n+            if (!throttler.insertFilteredQuery(detectorId, request)) {\n+                LOG.info(\"There is one query running for detectorId: {}. Trying to cancel the long running query\", detectorId);\n+                cancelRunningQuery(client, detectorId, LOG);", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzNzc1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391137759", "bodyText": "Agree. Return after cancelling will be more safer. Will update.", "author": "zhanghg08", "createdAt": "2020-03-11T17:24:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MTcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5NDc1MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390094751", "bodyText": "You can add some parameters to speed up task search:\n\ngroup_by=parents: so each group you only need to check header once\nactions=*search: since our queries are searches.  We don't care about write or update.", "author": "kaituo", "createdAt": "2020-03-10T04:53:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5NjIxNw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391196217", "bodyText": "Thanks for the advice. For the group_by=parents, it's a little weird. For the api it supports this feature(https://www.elastic.co/guide/en/elasticsearch/reference/current/tasks.html#_task_grouping). However when it comes to java api, it's not supported as far as I see.\nFor actions=*search, I will added it as \"actions=search\" since I can see some child query has something like \"indices:data/read/search[phase/query]\"", "author": "zhanghg08", "createdAt": "2020-03-11T19:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5NDc1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAxMjM5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r392012396", "bodyText": "you meant we need to use \"actions=*search*\", right?  Yes, please do that.  Your current code uses \"*search\".", "author": "kaituo", "createdAt": "2020-03-13T03:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5NDc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5OTUwNg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390099506", "bodyText": "Is there a unit/integration test for the cancel mechanism?  If not, I strongly suggest we add one.\nYou can add an ESIntegTestCase where we\n\ndefine a SearchOperationListener such that index operations are delayed to simulate long running queries;\ncreate a fake plugin to use listener defined in 1)\nadd AD plugin and the fake plugin together\n... automate what you did on manual testing ..", "author": "kaituo", "createdAt": "2020-03-10T05:17:57Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorPlugin.java", "diffHunk": "@@ -199,7 +199,7 @@ private static Void initGson() {\n         Settings settings = environment.settings();", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyNDQwOA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391324408", "bodyText": "This is also one of my concern. I noticed we don't have any unit test for clientUtil and tried to add one but it's too complicated. When manual testing, I use similar listener which will delay the search to make up the long running query. Not sure if that can be done in integration test, I will sync up with you offline.", "author": "zhanghg08", "createdAt": "2020-03-11T23:21:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5OTUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUzNjM1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390536355", "bodyText": "Please add more description about cancel request process", "author": "ylwu-amzn", "createdAt": "2020-03-10T18:48:22Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -162,11 +180,11 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n      * Send a nonblocking request with a timeout and return response. The request will first be put into\n      * the negative cache. Once the request complete, it will be removed from the negative cache.", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5NjUyOQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391196529", "bodyText": "added.", "author": "zhanghg08", "createdAt": "2020-03-11T19:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUzNjM1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUzNzc3Mw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390537773", "bodyText": "Remove empty line", "author": "ylwu-amzn", "createdAt": "2020-03-10T18:50:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -179,32 +197,36 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n         BiConsumer<Request, ActionListener<Response>> consumer,\n         AnomalyDetector detector\n     ) {\n+\n         try {\n-            // if key already exist, reject the request and throws exception\n-            if (!throttler.insertFilteredQuery(detector.getDetectorId(), request)) {\n-                LOG.error(\"There is one query running for detectorId: {}\", detector.getDetectorId());\n-                throw new EndRunException(detector.getDetectorId(), \"There is one query running on AnomalyDetector\", true);\n+            String detectorId = detector.getDetectorId();\n+            if (!throttler.insertFilteredQuery(detectorId, request)) {\n+                LOG.info(\"There is one query running for detectorId: {}. Trying to cancel the long running query\", detectorId);\n+                cancelRunningQuery(client, detectorId, LOG);\n             }\n             AtomicReference<Response> respReference = new AtomicReference<>();\n             final CountDownLatch latch = new CountDownLatch(1);\n \n-            try {\n+            try (ThreadContext.StoredContext context = threadPool.getThreadContext().stashContext()) {\n+                assert context != null;\n+                threadPool.getThreadContext().putHeader(Task.X_OPAQUE_ID, CommonName.ANOMALY_DETECTOR + \":\" + detectorId);\n                 consumer.accept(request, new LatchedActionListener<Response>(ActionListener.wrap(response -> {\n                     // clear negative cache\n-                    throttler.clearFilteredQuery(detector.getDetectorId());\n+                    throttler.clearFilteredQuery(detectorId);\n                     respReference.set(response);\n                 }, exception -> {\n                     // clear negative cache\n-                    throttler.clearFilteredQuery(detector.getDetectorId());\n+                    throttler.clearFilteredQuery(detectorId);\n                     LOG.error(\"Cannot get response for request {}, error: {}\", request, exception);\n                 }), latch));\n             } catch (Exception e) {\n-                LOG.error(\"Failed to process the request for detectorId: {}.\", detector.getDetectorId());\n-                throttler.clearFilteredQuery(detector.getDetectorId());\n+                LOG.error(\"Failed to process the request for detectorId: {}.\", detectorId);\n+                throttler.clearFilteredQuery(detectorId);\n                 throw e;\n             }\n \n             if (!latch.await(requestTimeout.getSeconds(), TimeUnit.SECONDS)) {\n+", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzMzk4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391133987", "bodyText": "done", "author": "zhanghg08", "createdAt": "2020-03-11T17:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUzNzc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0MTc4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390541787", "bodyText": "Is it possible the parent task has parent too? If yes, should we find the root task and kill all?", "author": "ylwu-amzn", "createdAt": "2020-03-10T18:57:19Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();\n+        client\n+            .execute(\n+                ListTasksAction.INSTANCE,\n+                listTasksRequest,\n+                ActionListener.wrap(response -> { onListTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"List Tasks failed.\", exception);\n+                    throw new InternalFailure(detectorId, \"Failed to list current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle ListTasksResponse\n+     * @param listTasksResponse ListTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onListTaskResponse(ListTasksResponse listTasksResponse, String detectorId, Logger LOG) {\n+        List<TaskInfo> tasks = listTasksResponse.getTasks();\n+        TaskInfo matchedTask = null;\n+        for (TaskInfo task : tasks) {\n+            if (!task.getHeaders().isEmpty() && task.getHeaders().get(Task.X_OPAQUE_ID) != null) {\n+                if (task.getHeaders().get(Task.X_OPAQUE_ID).contains(detectorId)) {\n+                    matchedTask = task;\n+                    break;\n+                }\n+            }\n+        }\n+        // case 1: given detectorId is not in current task list\n+        if (matchedTask == null) {\n+            // log and then clear negative cache\n+            LOG.info(\"Couldn't find task for detectorId: {}. Clean this entry from Throttler\", detectorId);\n+            throttler.clearFilteredQuery(detectorId);\n+            return;\n+        }\n+        // case 2: we can find the task for given detectorId\n+        TaskId parentTaskId = matchedTask.getParentTaskId().isSet() ? matchedTask.getParentTaskId() : matchedTask.getTaskId();", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxNzAwMg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391217002", "bodyText": "For our search query, there is only two-level parent-child relationship.", "author": "zhanghg08", "createdAt": "2020-03-11T19:41:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0MTc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0Mzg1Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390543856", "bodyText": "Better to add some retry for these failed tasks. Otherwise, will wait for next detector run to cancel again.", "author": "ylwu-amzn", "createdAt": "2020-03-10T19:00:52Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();\n+        client\n+            .execute(\n+                ListTasksAction.INSTANCE,\n+                listTasksRequest,\n+                ActionListener.wrap(response -> { onListTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"List Tasks failed.\", exception);\n+                    throw new InternalFailure(detectorId, \"Failed to list current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle ListTasksResponse\n+     * @param listTasksResponse ListTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onListTaskResponse(ListTasksResponse listTasksResponse, String detectorId, Logger LOG) {\n+        List<TaskInfo> tasks = listTasksResponse.getTasks();\n+        TaskInfo matchedTask = null;\n+        for (TaskInfo task : tasks) {\n+            if (!task.getHeaders().isEmpty() && task.getHeaders().get(Task.X_OPAQUE_ID) != null) {\n+                if (task.getHeaders().get(Task.X_OPAQUE_ID).contains(detectorId)) {\n+                    matchedTask = task;\n+                    break;\n+                }\n+            }\n+        }\n+        // case 1: given detectorId is not in current task list\n+        if (matchedTask == null) {\n+            // log and then clear negative cache\n+            LOG.info(\"Couldn't find task for detectorId: {}. Clean this entry from Throttler\", detectorId);\n+            throttler.clearFilteredQuery(detectorId);\n+            return;\n+        }\n+        // case 2: we can find the task for given detectorId\n+        TaskId parentTaskId = matchedTask.getParentTaskId().isSet() ? matchedTask.getParentTaskId() : matchedTask.getTaskId();\n+        CancelTasksRequest cancelTaskRequest = new CancelTasksRequest();\n+        cancelTaskRequest.setParentTaskId(parentTaskId);\n+        LOG.info(\"Start to cancel task for parentTaskId: {}\", parentTaskId);\n+        client\n+            .execute(\n+                CancelTasksAction.INSTANCE,\n+                cancelTaskRequest,\n+                ActionListener.wrap(response -> { onCancelTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"Failed to cancel task for detectorId: \" + detectorId, exception);\n+                    throw new InternalFailure(detectorId, \"Failed to cancel current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle CancelTasksResponse\n+     * @param cancelTasksResponse CancelTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onCancelTaskResponse(CancelTasksResponse cancelTasksResponse, String detectorId, Logger LOG) {\n+        List<ElasticsearchException> nodeFailures = cancelTasksResponse.getNodeFailures();\n+        List<TaskOperationFailure> taskFailures = cancelTasksResponse.getTaskFailures();\n+        if (nodeFailures.isEmpty() && taskFailures.isEmpty()) {\n+            LOG.info(\"Cancelling query for detectorId: {} succeeds. Clear entry from Throttler\", detectorId);", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxNzI2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391217261", "bodyText": "Will add a todo comment for now.", "author": "zhanghg08", "createdAt": "2020-03-11T19:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0Mzg1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1NDk2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390554966", "bodyText": "It's possible the cancelRunningQuery in progress or fail when start a new request. If cancelRunningQuery is not time consuming, better to start a new request when we get respond of cancelRunningQuery. If it's heavy action, may need to monitor the cancelation status and retry if failed; so we can terminate unnecessary AD query to protect cluster performance. It's ok to add some todo&comments here and refactor it later if you think the change will be big.", "author": "ylwu-amzn", "createdAt": "2020-03-10T19:20:40Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -179,32 +197,36 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n         BiConsumer<Request, ActionListener<Response>> consumer,\n         AnomalyDetector detector\n     ) {\n+\n         try {\n-            // if key already exist, reject the request and throws exception\n-            if (!throttler.insertFilteredQuery(detector.getDetectorId(), request)) {\n-                LOG.error(\"There is one query running for detectorId: {}\", detector.getDetectorId());\n-                throw new EndRunException(detector.getDetectorId(), \"There is one query running on AnomalyDetector\", true);\n+            String detectorId = detector.getDetectorId();\n+            if (!throttler.insertFilteredQuery(detectorId, request)) {\n+                LOG.info(\"There is one query running for detectorId: {}. Trying to cancel the long running query\", detectorId);\n+                cancelRunningQuery(client, detectorId, LOG);\n             }\n             AtomicReference<Response> respReference = new AtomicReference<>();\n             final CountDownLatch latch = new CountDownLatch(1);\n \n-            try {\n+            try (ThreadContext.StoredContext context = threadPool.getThreadContext().stashContext()) {\n+                assert context != null;\n+                threadPool.getThreadContext().putHeader(Task.X_OPAQUE_ID, CommonName.ANOMALY_DETECTOR + \":\" + detectorId);\n                 consumer.accept(request, new LatchedActionListener<Response>(ActionListener.wrap(response -> {", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxMDAzMw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391310033", "bodyText": "I think this is similar with Kaituo's comments. For safety concern, I will not start new request if we need to cancel the running one, just in case the cancel failed somehow and we keep adding new requests. We can revisit it later.", "author": "zhanghg08", "createdAt": "2020-03-11T22:38:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1NDk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1NzQzNQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390557435", "bodyText": "Just asking, will the X_OPAQUE_ID header be passed to child tasks?", "author": "ylwu-amzn", "createdAt": "2020-03-10T19:25:14Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -179,32 +197,36 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n         BiConsumer<Request, ActionListener<Response>> consumer,\n         AnomalyDetector detector\n     ) {\n+\n         try {\n-            // if key already exist, reject the request and throws exception\n-            if (!throttler.insertFilteredQuery(detector.getDetectorId(), request)) {\n-                LOG.error(\"There is one query running for detectorId: {}\", detector.getDetectorId());\n-                throw new EndRunException(detector.getDetectorId(), \"There is one query running on AnomalyDetector\", true);\n+            String detectorId = detector.getDetectorId();\n+            if (!throttler.insertFilteredQuery(detectorId, request)) {\n+                LOG.info(\"There is one query running for detectorId: {}. Trying to cancel the long running query\", detectorId);\n+                cancelRunningQuery(client, detectorId, LOG);\n             }\n             AtomicReference<Response> respReference = new AtomicReference<>();\n             final CountDownLatch latch = new CountDownLatch(1);\n \n-            try {\n+            try (ThreadContext.StoredContext context = threadPool.getThreadContext().stashContext()) {\n+                assert context != null;\n+                threadPool.getThreadContext().putHeader(Task.X_OPAQUE_ID, CommonName.ANOMALY_DETECTOR + \":\" + detectorId);", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxMDI2Mw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391310263", "bodyText": "Yes, it will. I can see both parent and children tasks have the same header from the manual test.", "author": "zhanghg08", "createdAt": "2020-03-11T22:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1NzQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU2MDg1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390560859", "bodyText": "From line292, if matchedTask.getParentTaskId().isSet() is false, will get matchedTask.getTaskId()  as parentTaskId.  For this case, cancelTaskRequest.setParentTaskId(parentTaskId) will cancel tasks which has parent task id as matchedTask.getTaskId(). Is it possible the matchedTask has no child tasks? If it's possible, will cancelTaskRequest.setParentTaskId(parentTaskId) throw exception or cancel matchedTask ?", "author": "ylwu-amzn", "createdAt": "2020-03-10T19:31:38Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();\n+        client\n+            .execute(\n+                ListTasksAction.INSTANCE,\n+                listTasksRequest,\n+                ActionListener.wrap(response -> { onListTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"List Tasks failed.\", exception);\n+                    throw new InternalFailure(detectorId, \"Failed to list current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle ListTasksResponse\n+     * @param listTasksResponse ListTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onListTaskResponse(ListTasksResponse listTasksResponse, String detectorId, Logger LOG) {\n+        List<TaskInfo> tasks = listTasksResponse.getTasks();\n+        TaskInfo matchedTask = null;\n+        for (TaskInfo task : tasks) {\n+            if (!task.getHeaders().isEmpty() && task.getHeaders().get(Task.X_OPAQUE_ID) != null) {\n+                if (task.getHeaders().get(Task.X_OPAQUE_ID).contains(detectorId)) {\n+                    matchedTask = task;\n+                    break;\n+                }\n+            }\n+        }\n+        // case 1: given detectorId is not in current task list\n+        if (matchedTask == null) {\n+            // log and then clear negative cache\n+            LOG.info(\"Couldn't find task for detectorId: {}. Clean this entry from Throttler\", detectorId);\n+            throttler.clearFilteredQuery(detectorId);\n+            return;\n+        }\n+        // case 2: we can find the task for given detectorId\n+        TaskId parentTaskId = matchedTask.getParentTaskId().isSet() ? matchedTask.getParentTaskId() : matchedTask.getTaskId();\n+        CancelTasksRequest cancelTaskRequest = new CancelTasksRequest();\n+        cancelTaskRequest.setParentTaskId(parentTaskId);", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMzc3Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391323772", "bodyText": "I got your point. To avoid this corner case, I will go through the entire tasks list(previously it will early terminate once found matched). If there is only one task(no parent), we need to setTaskId, otherwise setParentTaskId", "author": "zhanghg08", "createdAt": "2020-03-11T23:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU2MDg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU2NDE5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390564196", "bodyText": "log failures?", "author": "ylwu-amzn", "createdAt": "2020-03-10T19:37:59Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();\n+        client\n+            .execute(\n+                ListTasksAction.INSTANCE,\n+                listTasksRequest,\n+                ActionListener.wrap(response -> { onListTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"List Tasks failed.\", exception);\n+                    throw new InternalFailure(detectorId, \"Failed to list current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle ListTasksResponse\n+     * @param listTasksResponse ListTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onListTaskResponse(ListTasksResponse listTasksResponse, String detectorId, Logger LOG) {\n+        List<TaskInfo> tasks = listTasksResponse.getTasks();\n+        TaskInfo matchedTask = null;\n+        for (TaskInfo task : tasks) {\n+            if (!task.getHeaders().isEmpty() && task.getHeaders().get(Task.X_OPAQUE_ID) != null) {\n+                if (task.getHeaders().get(Task.X_OPAQUE_ID).contains(detectorId)) {\n+                    matchedTask = task;\n+                    break;\n+                }\n+            }\n+        }\n+        // case 1: given detectorId is not in current task list\n+        if (matchedTask == null) {\n+            // log and then clear negative cache\n+            LOG.info(\"Couldn't find task for detectorId: {}. Clean this entry from Throttler\", detectorId);\n+            throttler.clearFilteredQuery(detectorId);\n+            return;\n+        }\n+        // case 2: we can find the task for given detectorId\n+        TaskId parentTaskId = matchedTask.getParentTaskId().isSet() ? matchedTask.getParentTaskId() : matchedTask.getTaskId();\n+        CancelTasksRequest cancelTaskRequest = new CancelTasksRequest();\n+        cancelTaskRequest.setParentTaskId(parentTaskId);\n+        LOG.info(\"Start to cancel task for parentTaskId: {}\", parentTaskId);\n+        client\n+            .execute(\n+                CancelTasksAction.INSTANCE,\n+                cancelTaskRequest,\n+                ActionListener.wrap(response -> { onCancelTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"Failed to cancel task for detectorId: \" + detectorId, exception);\n+                    throw new InternalFailure(detectorId, \"Failed to cancel current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle CancelTasksResponse\n+     * @param cancelTasksResponse CancelTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onCancelTaskResponse(CancelTasksResponse cancelTasksResponse, String detectorId, Logger LOG) {\n+        List<ElasticsearchException> nodeFailures = cancelTasksResponse.getNodeFailures();\n+        List<TaskOperationFailure> taskFailures = cancelTasksResponse.getTaskFailures();\n+        if (nodeFailures.isEmpty() && taskFailures.isEmpty()) {\n+            LOG.info(\"Cancelling query for detectorId: {} succeeds. Clear entry from Throttler\", detectorId);\n+            throttler.clearFilteredQuery(detectorId);\n+            return;\n+        }\n+        throw new InternalFailure(detectorId, \"Failed to cancel current tasks due to node or task failures\");", "originalCommit": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxMzcxMQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r391313711", "bodyText": "added", "author": "zhanghg08", "createdAt": "2020-03-11T22:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU2NDE5Ng=="}], "type": "inlineReview"}, {"oid": "8b9d6992344e31ccede5f9fffd4782ebe1e9a9cb", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/8b9d6992344e31ccede5f9fffd4782ebe1e9a9cb", "message": "Address feedback:\n1. Adding description to throttledTimedRequest\n2. Don't send new request if there is one running query. We only cancel the running one.\n3. Adding logic to deal with single task cancelling(no parent task)\n4. Adding log info/error and removing extra space.", "committedDate": "2020-03-12T21:03:47Z", "type": "commit"}, {"oid": "fd1883bda8007a0c4ecb6499ad28128d59a1cda0", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/fd1883bda8007a0c4ecb6499ad28128d59a1cda0", "message": "1. change listtask filter from \"*search\" to \"*search*\"", "committedDate": "2020-03-13T18:01:57Z", "type": "commit"}, {"oid": "067374169e8cbfad2c682266293d2a9225e2dcb3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/067374169e8cbfad2c682266293d2a9225e2dcb3", "message": "Merge branch 'development' into cancel_query", "committedDate": "2020-03-13T22:27:50Z", "type": "commit"}]}