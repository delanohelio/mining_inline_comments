{"pr_number": 294, "pr_title": "fix no permission when preview detector with detector id", "pr_createdAt": "2020-10-26T04:15:07Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/294", "timeline": [{"oid": "89c905718f8786d6edf0650b8e6ec8dcaaa270cb", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/89c905718f8786d6edf0650b8e6ec8dcaaa270cb", "message": "fix no permission when preview detector with detector id", "committedDate": "2020-10-26T06:26:28Z", "type": "commit"}, {"oid": "89c905718f8786d6edf0650b8e6ec8dcaaa270cb", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/89c905718f8786d6edf0650b8e6ec8dcaaa270cb", "message": "fix no permission when preview detector with detector id", "committedDate": "2020-10-26T06:26:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTc0MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/294#discussion_r512091741", "bodyText": "Do we always throw RestStatus.INTERNAL_SERVER_ERROR or is there any one specific to FGAC permissions errors? I'm just wondering if the frontend will propagate this correctly as a permissions issue.", "author": "ohltyler", "createdAt": "2020-10-26T16:22:29Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/RestExecuteAnomalyDetectorAction.java", "diffHunk": "@@ -168,7 +169,12 @@ private String validateAdExecutionInput(AnomalyDetectorExecutionInput input) {\n     private void preivewAnomalyDetector(NodeClient client, RestChannel channel, AnomalyDetectorExecutionInput input) {\n         if (!StringUtils.isBlank(input.getDetectorId())) {\n             GetRequest getRequest = new GetRequest(AnomalyDetector.ANOMALY_DETECTORS_INDEX).id(input.getDetectorId());\n-            client.get(getRequest, onGetAnomalyDetectorResponse(channel, input));\n+            try (ThreadContext.StoredContext context = client.threadPool().getThreadContext().stashContext()) {\n+                client.get(getRequest, onGetAnomalyDetectorResponse(channel, input));\n+            } catch (Exception e) {\n+                logger.error(\"Fail to get detector for preview\", e);\n+                channel.sendResponse(new BytesRestResponse(RestStatus.INTERNAL_SERVER_ERROR, e.getMessage()));", "originalCommit": "89c905718f8786d6edf0650b8e6ec8dcaaa270cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNTgzOQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/294#discussion_r512115839", "bodyText": "Good catch. This change will run without any user info just like super admin. So if any exception happen, it should not be permission error. For permission error we should return \"RestStatus.FORBIDDEN\".\nIt's hard to test this error as admin can always get detector. Let's tune the error message part later if it really happens.", "author": "ylwu-amzn", "createdAt": "2020-10-26T16:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyMjM3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/294#discussion_r512122375", "bodyText": "I see, makes sense", "author": "ohltyler", "createdAt": "2020-10-26T17:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTc0MQ=="}], "type": "inlineReview"}]}