{"pr_number": 89, "pr_title": "Add stats to track knn request counts", "pr_createdAt": "2020-04-10T21:20:00Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/89", "timeline": [{"oid": "399ee4c2caf87645125795ca7e48d8611b07bf57", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/399ee4c2caf87645125795ca7e48d8611b07bf57", "message": "added stats to track knn request counts", "committedDate": "2020-04-10T21:11:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzODUyMw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/89#discussion_r407938523", "bodyText": "These Exceptions will only include the parsing errors(customer error) which we could ignore. Graphs are indexed part of the KNN80DocValuesConsumer. We may want to keep track of failures for graph creation there", "author": "vamshin", "createdAt": "2020-04-14T07:57:25Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java", "diffHunk": "@@ -230,46 +231,52 @@ public Query termQuery(Object value, QueryShardContext context) {\n \n     @Override\n     public void parse(ParseContext context) throws IOException {\n-        if (!KNNSettings.isKNNPluginEnabled()) {\n-            throw new IllegalStateException(\"KNN plugin is disabled. To enable \" +\n-                                                    \"update knn.plugin.enabled setting to true\");\n-        }\n+        KNNCounter.GRAPH_INDEX_REQUESTS.increment();\n+        try {\n+            if (!KNNSettings.isKNNPluginEnabled()) {\n+                throw new IllegalStateException(\"KNN plugin is disabled. To enable \" +\n+                        \"update knn.plugin.enabled setting to true\");\n+            }\n \n-        context.path().add(simpleName());\n+            context.path().add(simpleName());\n \n-        ArrayList<Float> vector = new ArrayList<>();\n-        XContentParser.Token token = context.parser().currentToken();\n+            ArrayList<Float> vector = new ArrayList<>();\n+            XContentParser.Token token = context.parser().currentToken();\n \n-        if (token == XContentParser.Token.START_ARRAY) {\n-            token = context.parser().nextToken();\n-            while (token != XContentParser.Token.END_ARRAY) {\n-                vector.add(context.parser().floatValue());\n+            if (token == XContentParser.Token.START_ARRAY) {\n                 token = context.parser().nextToken();\n+                while (token != XContentParser.Token.END_ARRAY) {\n+                    vector.add(context.parser().floatValue());\n+                    token = context.parser().nextToken();\n+                }\n+            } else if (token == XContentParser.Token.VALUE_NUMBER) {\n+                vector.add(context.parser().floatValue());\n+                context.parser().nextToken();\n             }\n-        } else if (token == XContentParser.Token.VALUE_NUMBER) {\n-            vector.add(context.parser().floatValue());\n-            context.parser().nextToken();\n-        }\n \n-        if (fieldType().dimension != vector.size()) {\n-            String errorMessage = String.format(\"Vector dimension mismatch. Expected: %d, Given: %d\",\n-                    fieldType().dimension, vector.size());\n-            throw new IllegalArgumentException(errorMessage);\n-        }\n+            if (fieldType().dimension != vector.size()) {\n+                String errorMessage = String.format(\"Vector dimension mismatch. Expected: %d, Given: %d\",\n+                        fieldType().dimension, vector.size());\n+                throw new IllegalArgumentException(errorMessage);\n+            }\n \n-        float[] array = new float[vector.size()];\n-        int i = 0;\n-        for (Float f : vector) {\n-            array[i++] = f;\n-        }\n+            float[] array = new float[vector.size()];\n+            int i = 0;\n+            for (Float f : vector) {\n+                array[i++] = f;\n+            }\n \n-        VectorField point = new VectorField(name(), array, fieldType());\n+            VectorField point = new VectorField(name(), array, fieldType());\n \n-        context.doc().add(point);\n-        if (fieldType().stored()) {\n-            context.doc().add(new StoredField(name(), point.toString()));\n+            context.doc().add(point);\n+            if (fieldType().stored()) {\n+                context.doc().add(new StoredField(name(), point.toString()));\n+            }\n+            context.path().remove();\n+        } catch (Exception ex) {\n+            KNNCounter.GRAPH_INDEX_ERRORS.increment();\n+            throw ex;", "originalCommit": "399ee4c2caf87645125795ca7e48d8611b07bf57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxMTIzMw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/89#discussion_r409711233", "bodyText": "Oh okay that makes sense. Will update.", "author": "jmazanec15", "createdAt": "2020-04-16T17:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzODUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzOTQ5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/89#discussion_r407939496", "bodyText": "just a thought, why not we just rely on load_exception_count metric from cache stats. This seem to track number of exceptions while loading graph which will be invoked during queries?", "author": "vamshin", "createdAt": "2020-04-14T07:58:48Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/v1736/KNNIndex.java", "diffHunk": "@@ -84,6 +85,9 @@ public long getIndexSize() {\n                     }\n             );\n \n+        } catch (Exception ex) {\n+            KNNCounter.GRAPH_QUERY_ERRORS.increment();\n+            throw new RuntimeException(\"Unable to query the index: \" + ex);", "originalCommit": "399ee4c2caf87645125795ca7e48d8611b07bf57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc1MTM5Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/89#discussion_r409751397", "bodyText": "Using load_exception_count would only count exceptions for loading the graph into memory, not the actual query of the graph. Adding the metric here allows us to check if the library query of the graph fails. In your opinion, should this metric track the number of query errors where a query is a call to the ES search API for knn, or for a query where a query is a call to the library function?", "author": "jmazanec15", "createdAt": "2020-04-16T18:07:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzOTQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNjg1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/89#discussion_r413516853", "bodyText": "makes sense. It should track the number of query errors.", "author": "vamshin", "createdAt": "2020-04-23T05:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzOTQ5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0NTc1Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/89#discussion_r407945757", "bodyText": "This might add a little confusion for bulk requests, which could index multiple vectors but still part of same request. If the intention is to count the number of graph requests , probably we could count at KNN80DocValuesConsumer.", "author": "vamshin", "createdAt": "2020-04-14T08:09:31Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java", "diffHunk": "@@ -230,46 +231,52 @@ public Query termQuery(Object value, QueryShardContext context) {\n \n     @Override\n     public void parse(ParseContext context) throws IOException {\n-        if (!KNNSettings.isKNNPluginEnabled()) {\n-            throw new IllegalStateException(\"KNN plugin is disabled. To enable \" +\n-                                                    \"update knn.plugin.enabled setting to true\");\n-        }\n+        KNNCounter.GRAPH_INDEX_REQUESTS.increment();", "originalCommit": "399ee4c2caf87645125795ca7e48d8611b07bf57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc0NDA5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/89#discussion_r409744092", "bodyText": "Yes, the intention of this metric is to count the total number of requests to index graphs. Will move to KNN80DocValuesConsumer", "author": "jmazanec15", "createdAt": "2020-04-16T17:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0NTc1Nw=="}], "type": "inlineReview"}, {"oid": "1a2ccff2a2125837b76a0730f8b0e7abaa6f591b", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1a2ccff2a2125837b76a0730f8b0e7abaa6f591b", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into knn-counters", "committedDate": "2020-04-14T16:40:05Z", "type": "commit"}, {"oid": "308d051c7df412058baa4e6f27f84519556f5cd5", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/308d051c7df412058baa4e6f27f84519556f5cd5", "message": "moved graph index counters to KNN80DocValuesConsumer", "committedDate": "2020-04-16T18:08:24Z", "type": "commit"}, {"oid": "824a8b362b3c8a047d70712da2580549b200592b", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/824a8b362b3c8a047d70712da2580549b200592b", "message": "add counters for knn queries", "committedDate": "2020-04-22T21:46:49Z", "type": "commit"}, {"oid": "beda3965f4c379b288f20e3e9afd8e6e14325900", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/beda3965f4c379b288f20e3e9afd8e6e14325900", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into knn-counters", "committedDate": "2020-04-22T21:46:59Z", "type": "commit"}, {"oid": "06cd43e1d402d7c9ff2625e441305d67902c360a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/06cd43e1d402d7c9ff2625e441305d67902c360a", "message": "move knn query req/err counters", "committedDate": "2020-04-22T22:54:57Z", "type": "commit"}, {"oid": "45cd741dadfa65536667bcd662407a846babbd33", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/45cd741dadfa65536667bcd662407a846babbd33", "message": "remove KNN Query Errors", "committedDate": "2020-04-22T23:00:58Z", "type": "commit"}, {"oid": "69a9c892816322a119b0aa0f4213f1e92a64c601", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/69a9c892816322a119b0aa0f4213f1e92a64c601", "message": "Updated Readme", "committedDate": "2020-04-22T23:08:27Z", "type": "commit"}]}