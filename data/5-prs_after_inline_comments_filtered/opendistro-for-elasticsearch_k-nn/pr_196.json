{"pr_number": 196, "pr_title": "Pre filter support through custom scoring", "pr_createdAt": "2020-08-20T17:49:15Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196", "timeline": [{"oid": "465e1f07d41c910324a6eee0397161234764ff78", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/465e1f07d41c910324a6eee0397161234764ff78", "message": "synced from master", "committedDate": "2020-07-20T20:04:58Z", "type": "commit"}, {"oid": "a744b8ad9f1c707c3860ffe4aec99076fb5ceed4", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/a744b8ad9f1c707c3860ffe4aec99076fb5ceed4", "message": "synced from master", "committedDate": "2020-07-20T20:05:22Z", "type": "commit"}, {"oid": "124b732ad74ffb6fcf6685e0827599507905dcc1", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/124b732ad74ffb6fcf6685e0827599507905dcc1", "message": "vam custom scoring first cut", "committedDate": "2020-07-24T19:30:34Z", "type": "commit"}, {"oid": "e29432b8335642fc4727617c7377115618605a51", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/e29432b8335642fc4727617c7377115618605a51", "message": "Merge branch 'master' of github.com:opendistro-for-elasticsearch/k-NN", "committedDate": "2020-07-24T20:33:41Z", "type": "commit"}, {"oid": "353be33a0a6779d1739bcaec661baa99cfc6e306", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/353be33a0a6779d1739bcaec661baa99cfc6e306", "message": "l2 custom scoring support", "committedDate": "2020-08-20T17:37:02Z", "type": "commit"}, {"oid": "af0dbe68ab309d084c746119696e5704b7eea1ff", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/af0dbe68ab309d084c746119696e5704b7eea1ff", "message": "Merge branch 'master' of github.com:opendistro-for-elasticsearch/k-NN", "committedDate": "2020-08-20T17:37:25Z", "type": "commit"}, {"oid": "4c5b5a72fc6f0e734907ace822fcfc3003ec4e3f", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/4c5b5a72fc6f0e734907ace822fcfc3003ec4e3f", "message": "merged master", "committedDate": "2020-08-20T17:39:11Z", "type": "commit"}, {"oid": "59a71c6ec1909b5cb3f5d8cde15f9fb7d612e367", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/59a71c6ec1909b5cb3f5d8cde15f9fb7d612e367", "message": "merged master", "committedDate": "2020-08-20T17:46:08Z", "type": "commit"}, {"oid": "c3b880dc669147bbb42aa2f265c8e79c48f1c0b8", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/c3b880dc669147bbb42aa2f265c8e79c48f1c0b8", "message": "added class level comments", "committedDate": "2020-08-20T17:53:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5NzQ2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r474297461", "bodyText": "If we do not support Cosine Similarity yet, remove from this PR", "author": "jmazanec15", "createdAt": "2020-08-20T22:02:52Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/util/KNNConstants.java", "diffHunk": "@@ -21,4 +21,6 @@\n     public static final String HNSW_ALGO_EF_CONSTRUCTION = \"efConstruction\";\n     public static final String HNSW_ALGO_EF_SEARCH = \"efSearch\";\n     public static final String HNSW_ALGO_INDEX_THREAD_QTY = \"indexThreadQty\";\n+    public static final String L2 = \"l2\";\n+    public static final String COSINESIMIL = \"cosinesimil\";", "originalCommit": "c3b880dc669147bbb42aa2f265c8e79c48f1c0b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxMTA1MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480411051", "bodyText": "Was adding incrementally in the PR should be available now.", "author": "vamshin", "createdAt": "2020-08-31T21:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5NzQ2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5ODI0MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r474298241", "bodyText": "Where do we check that the input vector has the correct dimensions?", "author": "jmazanec15", "createdAt": "2020-08-20T22:04:55Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/VectorScoreScript.java", "diffHunk": "@@ -0,0 +1,149 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.ArrayList;\n+import java.util.Map;\n+\n+/**\n+ * Vector score script used for adjusting the score based on similarity space\n+ * on a per document basis.\n+ */\n+public class VectorScoreScript extends ScoreScript {\n+\n+    private BinaryDocValues binaryDocValuesReader;\n+    private final float[] inputVector;\n+    private final String similaritySpace;\n+\n+    public float l2Squared(float[] queryVector, float[] inputVector) {\n+        long squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            squaredDistance += Math.pow(queryVector[i]-inputVector[i], 2);\n+        }\n+        return squaredDistance;\n+    }\n+\n+    /**\n+     * This function called for each doc in the segment. We evaluate the score of the vector in the doc\n+     *\n+     * @param explanationHolder A helper to take in an explanation from a script and turn\n+     *                          it into an {@link org.apache.lucene.search.Explanation}\n+     * @return score of the vector to the query vector\n+     */\n+    @Override\n+    public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+        float score = Float.MIN_VALUE;\n+        try {\n+            float[] doc_vector;\n+            BytesRef bytesref = binaryDocValuesReader.binaryValue();\n+            // If there is no vector for the corresponding doc then it should be not considered for nearest\n+            // neighbors.\n+            if (bytesref == null) {\n+                return Float.MIN_VALUE;\n+            }\n+            try (ByteArrayInputStream byteStream = new ByteArrayInputStream(bytesref.bytes, bytesref.offset, bytesref.length);\n+                 ObjectInputStream objectStream = new ObjectInputStream(byteStream)) {\n+                doc_vector = (float[]) objectStream.readObject();\n+            } catch (ClassNotFoundException e) {\n+                throw new RuntimeException(e);\n+            }\n+            if (KNNConstants.L2.equalsIgnoreCase(similaritySpace)) {", "originalCommit": "c3b880dc669147bbb42aa2f265c8e79c48f1c0b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNDE0NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480414144", "bodyText": "Added part of the execute() function", "author": "vamshin", "createdAt": "2020-08-31T21:38:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5ODI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5OTA0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r474299045", "bodyText": "In what case does this happen?", "author": "jmazanec15", "createdAt": "2020-08-20T22:06:51Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/VectorScoreScript.java", "diffHunk": "@@ -0,0 +1,149 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.ArrayList;\n+import java.util.Map;\n+\n+/**\n+ * Vector score script used for adjusting the score based on similarity space\n+ * on a per document basis.\n+ */\n+public class VectorScoreScript extends ScoreScript {\n+\n+    private BinaryDocValues binaryDocValuesReader;\n+    private final float[] inputVector;\n+    private final String similaritySpace;\n+\n+    public float l2Squared(float[] queryVector, float[] inputVector) {\n+        long squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            squaredDistance += Math.pow(queryVector[i]-inputVector[i], 2);\n+        }\n+        return squaredDistance;\n+    }\n+\n+    /**\n+     * This function called for each doc in the segment. We evaluate the score of the vector in the doc\n+     *\n+     * @param explanationHolder A helper to take in an explanation from a script and turn\n+     *                          it into an {@link org.apache.lucene.search.Explanation}\n+     * @return score of the vector to the query vector\n+     */\n+    @Override\n+    public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+        float score = Float.MIN_VALUE;\n+        try {\n+            float[] doc_vector;\n+            BytesRef bytesref = binaryDocValuesReader.binaryValue();\n+            // If there is no vector for the corresponding doc then it should be not considered for nearest", "originalCommit": "c3b880dc669147bbb42aa2f265c8e79c48f1c0b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNDcwNA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480414704", "bodyText": "If for some reason, some documents do not have vector field then we need to handle this case gracefully.\nI am doing some more tests around this.", "author": "vamshin", "createdAt": "2020-08-31T21:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5OTA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk5MjQ4Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r474992483", "bodyText": "minor. typically java developers do constant::equals to avoid npe, like line 29.", "author": "wnbts", "createdAt": "2020-08-21T22:15:23Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringScriptEngine.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.script.ScriptContext;\n+import org.elasticsearch.script.ScriptEngine;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * KNN Custom scoring Engine implementation.\n+ */\n+public class KNNScoringScriptEngine implements ScriptEngine {\n+\n+    public static final String NAME = \"knn\";\n+    private static final String SCRIPT_SOURCE = \"knn_score\";\n+\n+    @Override\n+    public String getType() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public <FactoryType> FactoryType compile(String name, String code, ScriptContext<FactoryType> context, Map<String, String> params) {\n+        if (context.equals(ScoreScript.CONTEXT) == false) {", "originalCommit": "c3b880dc669147bbb42aa2f265c8e79c48f1c0b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNTA4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480415082", "bodyText": "Fixed.", "author": "vamshin", "createdAt": "2020-08-31T21:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk5MjQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk5NTAxNg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r474995016", "bodyText": "question. why is the type not float?", "author": "wnbts", "createdAt": "2020-08-21T22:25:08Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/VectorScoreScript.java", "diffHunk": "@@ -0,0 +1,149 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.ArrayList;\n+import java.util.Map;\n+\n+/**\n+ * Vector score script used for adjusting the score based on similarity space\n+ * on a per document basis.\n+ */\n+public class VectorScoreScript extends ScoreScript {\n+\n+    private BinaryDocValues binaryDocValuesReader;\n+    private final float[] inputVector;\n+    private final String similaritySpace;\n+\n+    public float l2Squared(float[] queryVector, float[] inputVector) {\n+        long squaredDistance = 0;", "originalCommit": "c3b880dc669147bbb42aa2f265c8e79c48f1c0b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNTE2NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480415164", "bodyText": "Should be float. Corrected. thanks", "author": "vamshin", "createdAt": "2020-08-31T21:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk5NTAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwMjgzNw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r475002837", "bodyText": "this implementation might not be the most efficient due to type casting and power.\nfloat diff = queryVector[i] - inputVector[i];\nsquaredDistance += diff * diff;\n\nshould be 2x faster\nfloat diff = queryVector[i] - inputVector[i];\nsquaredDistance = Math.fma(diff, diff, squaredDistance);\n\nshould also be fast but not as much as the one above", "author": "wnbts", "createdAt": "2020-08-21T22:57:09Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/VectorScoreScript.java", "diffHunk": "@@ -0,0 +1,149 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.ArrayList;\n+import java.util.Map;\n+\n+/**\n+ * Vector score script used for adjusting the score based on similarity space\n+ * on a per document basis.\n+ */\n+public class VectorScoreScript extends ScoreScript {\n+\n+    private BinaryDocValues binaryDocValuesReader;\n+    private final float[] inputVector;\n+    private final String similaritySpace;\n+\n+    public float l2Squared(float[] queryVector, float[] inputVector) {\n+        long squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            squaredDistance += Math.pow(queryVector[i]-inputVector[i], 2);", "originalCommit": "c3b880dc669147bbb42aa2f265c8e79c48f1c0b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNTI0NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480415244", "bodyText": "Fixed. thanks", "author": "vamshin", "createdAt": "2020-08-31T21:41:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwMjgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTYzOTI4NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r481639284", "bodyText": "Just out of curiosity, did you performance test the Math.fma computation as compared to the += diff * diff on an Intel CPU? This article implies that fma could be more performant as it can use a special intel instruction set: https://software.seek.intel.com/boosting-java-performance", "author": "NelsonBurton", "createdAt": "2020-09-02T04:03:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwMjgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ0MjI3Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r482442273", "bodyText": "great ask!\nI did test Math.fma and the performance appeared consistently slower than += on intel cpu with avx/avx2. It could be the overhead from underlying extra if, assert, double casting. More test results are always better.\nAlso note that on earlier cpu models, the fma implementation might be even worse. see https://stackoverflow.com/questions/44808081/what-are-the-accuracy-performance-benefits-of-using-math-fma", "author": "wnbts", "createdAt": "2020-09-02T20:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwMjgzNw=="}], "type": "inlineReview"}, {"oid": "d783a5ce155f567dda615045788248ae7a02128a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/d783a5ce155f567dda615045788248ae7a02128a", "message": "fix comments", "committedDate": "2020-08-24T17:27:37Z", "type": "commit"}, {"oid": "6a1689eeb387f8c1b0f492ab5692d53c2329333f", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6a1689eeb387f8c1b0f492ab5692d53c2329333f", "message": "Added cosine simil", "committedDate": "2020-08-28T20:05:19Z", "type": "commit"}, {"oid": "9e270e706e4ec55ccf43e16d8dc8da0be35a674c", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/9e270e706e4ec55ccf43e16d8dc8da0be35a674c", "message": "refactor", "committedDate": "2020-08-28T20:32:47Z", "type": "commit"}, {"oid": "54b112f65684dba6466c814af0a05312fd9de9bd", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/54b112f65684dba6466c814af0a05312fd9de9bd", "message": "optimization for cosine", "committedDate": "2020-08-31T19:59:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwNDYxNg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r475004616", "bodyText": "question. should this case error out?", "author": "wnbts", "createdAt": "2020-08-21T23:05:25Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/VectorScoreScript.java", "diffHunk": "@@ -0,0 +1,149 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.ArrayList;\n+import java.util.Map;\n+\n+/**\n+ * Vector score script used for adjusting the score based on similarity space\n+ * on a per document basis.\n+ */\n+public class VectorScoreScript extends ScoreScript {\n+\n+    private BinaryDocValues binaryDocValuesReader;\n+    private final float[] inputVector;\n+    private final String similaritySpace;\n+\n+    public float l2Squared(float[] queryVector, float[] inputVector) {\n+        long squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            squaredDistance += Math.pow(queryVector[i]-inputVector[i], 2);\n+        }\n+        return squaredDistance;\n+    }\n+\n+    /**\n+     * This function called for each doc in the segment. We evaluate the score of the vector in the doc\n+     *\n+     * @param explanationHolder A helper to take in an explanation from a script and turn\n+     *                          it into an {@link org.apache.lucene.search.Explanation}\n+     * @return score of the vector to the query vector\n+     */\n+    @Override\n+    public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+        float score = Float.MIN_VALUE;\n+        try {\n+            float[] doc_vector;\n+            BytesRef bytesref = binaryDocValuesReader.binaryValue();\n+            // If there is no vector for the corresponding doc then it should be not considered for nearest\n+            // neighbors.\n+            if (bytesref == null) {\n+                return Float.MIN_VALUE;\n+            }\n+            try (ByteArrayInputStream byteStream = new ByteArrayInputStream(bytesref.bytes, bytesref.offset, bytesref.length);\n+                 ObjectInputStream objectStream = new ObjectInputStream(byteStream)) {\n+                doc_vector = (float[]) objectStream.readObject();\n+            } catch (ClassNotFoundException e) {\n+                throw new RuntimeException(e);\n+            }\n+            if (KNNConstants.L2.equalsIgnoreCase(similaritySpace)) {\n+                score = l2Squared(this.inputVector, doc_vector);\n+                score = 1/(1 + score);\n+            }\n+            // Other spaces will be followed up in next pr\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e); // again - Failing in order not to hide potential bugs\n+        }\n+        return score;\n+    }\n+\n+    @Override\n+    public void setDocument(int docId) {\n+        try {\n+            this.binaryDocValuesReader.advanceExact(docId);\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public VectorScoreScript(Map<String, Object> params, String field, String similaritySpace,\n+                             SearchLookup lookup, LeafReaderContext leafContext) {\n+        super(params, lookup, leafContext);\n+        // get query inputVector - convert to primitive\n+        final Object vector = params.get(\"vector\");\n+        this.similaritySpace = similaritySpace;\n+        if(vector != null) {\n+            final ArrayList<Double> tmp = (ArrayList<Double>) vector;\n+            inputVector = new float[tmp.size()];\n+            for (int i = 0; i < inputVector.length; i++) {\n+                inputVector[i] = tmp.get(i).floatValue();\n+            }\n+        } else {\n+            inputVector = null;", "originalCommit": "c3b880dc669147bbb42aa2f265c8e79c48f1c0b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNDExNA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480404114", "bodyText": "since input and outputs are all float, why not using float?", "author": "wnbts", "createdAt": "2020-08-31T21:17:00Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -13,6 +13,25 @@ public static float l2Squared(float[] queryVector, float[] inputVector) {\n         return squaredDistance;\n     }\n \n+    public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, double normQueryVector) {\n+        double dotProduct = 0.0f;\n+        double normInputVector = 0.0f;", "originalCommit": "54b112f65684dba6466c814af0a05312fd9de9bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNjM4NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480416384", "bodyText": "Math.sqrt() function requires double. So doing all the manipulations in double and type cast to float later", "author": "vamshin", "createdAt": "2020-08-31T21:44:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNDExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ2Njk5MA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480466990", "bodyText": "note that every casting, even implicit, takes away resource and gives no gains", "author": "wnbts", "createdAt": "2020-08-31T23:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNDExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTYzMDQ1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r481630453", "bodyText": "Just to add on, I ran some benchmarking on a single i3.4xl of a tight dot product loop, and found the casting back and forth to double slowed down the calculation measurably.", "author": "NelsonBurton", "createdAt": "2020-09-02T03:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNDExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwOTQ1MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r484209451", "bodyText": "Good point. Fixed", "author": "vamshin", "createdAt": "2020-09-07T06:33:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNDExNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNDU1OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480404558", "bodyText": "this check should preferably be avoided for every input vector", "author": "wnbts", "createdAt": "2020-08-31T21:18:05Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -13,6 +13,25 @@ public static float l2Squared(float[] queryVector, float[] inputVector) {\n         return squaredDistance;\n     }\n \n+    public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, double normQueryVector) {\n+        double dotProduct = 0.0f;\n+        double normInputVector = 0.0f;\n+        if (normQueryVector == -1) {", "originalCommit": "54b112f65684dba6466c814af0a05312fd9de9bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNzgwMQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480417801", "bodyText": "This case would not occur from Script. Since this function is part of KNNScoringUtil Util class, wanted to add this check to ensure consumers of this function take care of this value.", "author": "vamshin", "createdAt": "2020-08-31T21:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNDU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ2NzQ0NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480467444", "bodyText": "can this check be moved to be done exactly once at the factory when the script is created?", "author": "wnbts", "createdAt": "2020-08-31T23:18:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNDU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwOTU4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r484209582", "bodyText": "Removed this check as this case does not occur", "author": "vamshin", "createdAt": "2020-09-07T06:33:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNDU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNjMyNg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480406326", "bodyText": "this check can be saved for most vectors by try-catching the unlikely case from the division below", "author": "wnbts", "createdAt": "2020-08-31T21:22:15Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import java.util.ArrayList;\n+\n+public class KNNScoringUtil {\n+\n+    public static float l2Squared(float[] queryVector, float[] inputVector) {\n+        float squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            float diff = queryVector[i]-inputVector[i];\n+            squaredDistance += diff * diff;\n+        }\n+        return squaredDistance;\n+    }\n+\n+    public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, double normQueryVector) {\n+        double dotProduct = 0.0f;\n+        double normInputVector = 0.0f;\n+        if (normQueryVector == -1) {\n+            throw new IllegalStateException(\"Normalized query vector cannot be negative\");\n+        }\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        // Divide by zero check\n+        double normalizedProduct = normQueryVector * normInputVector;\n+        if (normalizedProduct == 0 ) {\n+            return Float.MIN_VALUE;", "originalCommit": "54b112f65684dba6466c814af0a05312fd9de9bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQyMTM1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480421353", "bodyText": "Makes sense. Fixed. Thanks", "author": "vamshin", "createdAt": "2020-08-31T21:56:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNjMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNjkyOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480406928", "bodyText": "the return type should be float", "author": "wnbts", "createdAt": "2020-08-31T21:23:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import java.util.ArrayList;\n+\n+public class KNNScoringUtil {\n+\n+    public static float l2Squared(float[] queryVector, float[] inputVector) {\n+        float squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            float diff = queryVector[i]-inputVector[i];\n+            squaredDistance += diff * diff;\n+        }\n+        return squaredDistance;\n+    }\n+\n+    public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, double normQueryVector) {\n+        double dotProduct = 0.0f;\n+        double normInputVector = 0.0f;\n+        if (normQueryVector == -1) {\n+            throw new IllegalStateException(\"Normalized query vector cannot be negative\");\n+        }\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        // Divide by zero check\n+        double normalizedProduct = normQueryVector * normInputVector;\n+        if (normalizedProduct == 0 ) {\n+            return Float.MIN_VALUE;\n+        }\n+        return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n+    }\n+\n+\n+    public static float cosinesimil(float[] queryVector, float[] inputVector) {\n+        double dotProduct = 0.0f;\n+        double normQueryVector = 0.0f;\n+        double normInputVector = 0.0f;\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normQueryVector += queryVector[i] * queryVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        double normalizedProduct = normQueryVector * normInputVector;\n+        if (normalizedProduct == 0 ) {\n+            return Float.MIN_VALUE;\n+        }\n+        return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static float[] convertVectorToPrimitive(Object vector) {\n+        float[] primitiveVector = null;\n+        if(vector != null) {\n+            final ArrayList<Double> tmp = (ArrayList<Double>) vector;\n+            primitiveVector = new float[tmp.size()];\n+            for (int i = 0; i < primitiveVector.length; i++) {\n+                primitiveVector[i] = tmp.get(i).floatValue();\n+            }\n+        }\n+        return primitiveVector;\n+    }\n+\n+    public static double getVectorMagnitudeSquared(float[] inputVector) {\n+        if (null == inputVector) {\n+            throw new IllegalStateException(\"vector magnitude cannot be evaluated as it is null\");\n+        }\n+        double normInputVector = 0.0f;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        return (float) normInputVector;", "originalCommit": "54b112f65684dba6466c814af0a05312fd9de9bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQyNDAzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480424031", "bodyText": "since this value would be used in Math.sqrt function, wanted to keep it as double.", "author": "vamshin", "createdAt": "2020-08-31T22:03:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNjkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ2ODI1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480468253", "bodyText": "if the return must be double, then the casting to float at line is unnecessary", "author": "wnbts", "createdAt": "2020-08-31T23:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNjkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNzY2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480407662", "bodyText": "this method is not used", "author": "wnbts", "createdAt": "2020-08-31T21:25:19Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNVectorScoreScript.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+\n+/**\n+ * Vector score script used for adjusting the score based on similarity space\n+ * on a per document basis.\n+ */\n+public class KNNVectorScoreScript extends ScoreScript {\n+\n+    private BinaryDocValues binaryDocValuesReader;\n+    private final float[] queryVector;\n+    private final String similaritySpace;\n+    private double queryVectorSquaredMagnitude = -1;\n+\n+    public float l2Squared(float[] queryVector, float[] inputVector) {", "originalCommit": "54b112f65684dba6466c814af0a05312fd9de9bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQyNDE4MA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r480424180", "bodyText": "Correct. Removed.", "author": "vamshin", "createdAt": "2020-08-31T22:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNzY2Mg=="}], "type": "inlineReview"}, {"oid": "311b2a2a57d17dfe1f02f4385c74ba1b06335c83", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/311b2a2a57d17dfe1f02f4385c74ba1b06335c83", "message": "optimization for cosine", "committedDate": "2020-08-31T22:29:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTYzMTkwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r481631909", "bodyText": "Recomputing the query vector of every invocation will add unnecessary computation, as it can be computed once and passed it, like in the function above", "author": "NelsonBurton", "createdAt": "2020-09-02T03:55:14Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+import java.util.ArrayList;\n+\n+public class KNNScoringUtil {\n+    private static Logger logger = LogManager.getLogger(KNNScoringUtil.class);\n+\n+    public static float l2Squared(float[] queryVector, float[] inputVector) {\n+        float squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            float diff = queryVector[i]-inputVector[i];\n+            squaredDistance += diff * diff;\n+        }\n+        return squaredDistance;\n+    }\n+\n+    public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, double normQueryVector) {\n+        double dotProduct = 0.0f;\n+        double normInputVector = 0.0f;\n+        if (normQueryVector == -1) {\n+            throw new IllegalStateException(\"Normalized query vector cannot be negative\");\n+        }\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        double normalizedProduct = normQueryVector * normInputVector;\n+        try {\n+            return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n+        } catch(ArithmeticException ex) {\n+            logger.debug(\"Possibly Division by Zero Exception. Returning min score to put this result to end. \" +\n+                    \"Current normalized product \" + normalizedProduct);\n+            return Float.MIN_VALUE;\n+        }\n+    }\n+\n+    public static float cosinesimil(float[] queryVector, float[] inputVector) {\n+        double dotProduct = 0.0f;\n+        double normQueryVector = 0.0f;\n+        double normInputVector = 0.0f;\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normQueryVector += queryVector[i] * queryVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];", "originalCommit": "311b2a2a57d17dfe1f02f4385c74ba1b06335c83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIxMDA4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r484210081", "bodyText": "I added two versions of calculating cosine similarity score. This is unoptimized version of cosine similarity function which would be exposed to customer to call the function directly.", "author": "vamshin", "createdAt": "2020-09-07T06:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTYzMTkwOQ=="}], "type": "inlineReview"}, {"oid": "bc7976685265402d16d5cec945f07decc407bd86", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/bc7976685265402d16d5cec945f07decc407bd86", "message": "integ tests for custom scoring", "committedDate": "2020-09-03T21:26:29Z", "type": "commit"}, {"oid": "bd1f8f32713570836e7656469493ba0773bd430a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/bd1f8f32713570836e7656469493ba0773bd430a", "message": "integ tests for custom scoring", "committedDate": "2020-09-03T21:27:18Z", "type": "commit"}, {"oid": "b5e33f3b1c05be5770e9ecd0c466c4dc6c5b40c5", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b5e33f3b1c05be5770e9ecd0c466c4dc6c5b40c5", "message": "incorporated comments. Refactored code", "committedDate": "2020-09-07T06:39:57Z", "type": "commit"}, {"oid": "ac06ca37005a710dcabcd41816a80ff2bbff83c7", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ac06ca37005a710dcabcd41816a80ff2bbff83c7", "message": "incorporated comments. Refactored code", "committedDate": "2020-09-07T06:45:44Z", "type": "commit"}, {"oid": "da44b18f46a443dcfc5df966355153cdd25fee93", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/da44b18f46a443dcfc5df966355153cdd25fee93", "message": "incorporated comments. Refactored code", "committedDate": "2020-09-07T06:46:53Z", "type": "commit"}, {"oid": "32483d9d18c6b1d501e9cb35ad5f2c89e6a27186", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/32483d9d18c6b1d501e9cb35ad5f2c89e6a27186", "message": "incorporated comments. Refactored code", "committedDate": "2020-09-07T06:50:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0MjQ2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r485242466", "bodyText": "even this method is not used by the plugin, the implementation can be similar to the optimized version. unnecessary casting from float to double can be removed.", "author": "wnbts", "createdAt": "2020-09-08T23:04:52Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+import java.util.ArrayList;\n+\n+public class KNNScoringUtil {\n+    private static Logger logger = LogManager.getLogger(KNNScoringUtil.class);\n+\n+    public static float l2Squared(float[] queryVector, float[] inputVector) {\n+        float squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            float diff = queryVector[i]-inputVector[i];\n+            squaredDistance += diff * diff;\n+        }\n+        return squaredDistance;\n+    }\n+\n+    public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, float normQueryVector) {\n+        float dotProduct = 0.0f;\n+        float normInputVector = 0.0f;\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        float normalizedProduct = normQueryVector * normInputVector;\n+        try {\n+            return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n+        } catch(ArithmeticException ex) {\n+            logger.debug(\"Possibly Division by Zero Exception. Returning min score to put this result to end. \" +\n+                    \"Current normalized product \" + normalizedProduct);\n+            return Float.MIN_VALUE;\n+        }\n+    }\n+\n+    public static float cosinesimil(float[] queryVector, float[] inputVector) {\n+        double dotProduct = 0.0f;", "originalCommit": "32483d9d18c6b1d501e9cb35ad5f2c89e6a27186", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMTA5NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r487221094", "bodyText": "This method would be used in future part of #213.  Fixed the typecasting issue.", "author": "vamshin", "createdAt": "2020-09-11T18:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0MjQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0NjIwOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r485246208", "bodyText": "minor. an error message is clearer.", "author": "wnbts", "createdAt": "2020-09-08T23:16:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNVectorScoreScript.java", "diffHunk": "@@ -0,0 +1,162 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+\n+/**\n+ * Vector score script used for adjusting the score based on similarity space\n+ * on a per document basis.\n+ *\n+ */\n+public class KNNVectorScoreScript extends ScoreScript {\n+\n+    private BinaryDocValues binaryDocValuesReader;\n+    private final float[] queryVector;\n+    private final String similaritySpace;\n+    private float queryVectorSquaredMagnitude = -1;\n+\n+    /**\n+     * This function called for each doc in the segment. We evaluate the score of the vector in the doc\n+     *\n+     * @param explanationHolder A helper to take in an explanation from a script and turn\n+     *                          it into an {@link org.apache.lucene.search.Explanation}\n+     * @return score of the vector to the query vector\n+     */\n+    @Override\n+    public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+        float score = Float.MIN_VALUE;\n+        try {\n+            float[] doc_vector;\n+            BytesRef bytesref = binaryDocValuesReader.binaryValue();\n+            // If there is no vector for the corresponding doc then it should be not considered for nearest\n+            // neighbors.\n+            if (bytesref == null) {\n+                return Float.MIN_VALUE;\n+            }\n+            try (ByteArrayInputStream byteStream = new ByteArrayInputStream(bytesref.bytes, bytesref.offset, bytesref.length);\n+                 ObjectInputStream objectStream = new ObjectInputStream(byteStream)) {\n+                doc_vector = (float[]) objectStream.readObject();\n+            } catch (ClassNotFoundException e) {\n+                throw new RuntimeException(e);\n+            }\n+\n+            if(doc_vector.length != queryVector.length) {\n+                throw new IllegalStateException(\"[KNN] query vector and field vector dimensions mismatch. \" +\n+                        \"query vector: \" + queryVector.length + \", stored vector: \" + doc_vector.length);\n+            }\n+\n+            if (KNNConstants.L2.equalsIgnoreCase(similaritySpace)) {\n+                score = KNNScoringUtil.l2Squared(this.queryVector, doc_vector);\n+                score = 1/(1 + score);\n+            } else if (KNNConstants.COSINESIMIL.equalsIgnoreCase(similaritySpace)) {\n+                // Scores cannot be negative so add +1 to the cosine score\n+                score = 1 + KNNScoringUtil.cosinesimilOptimized(this.queryVector, doc_vector, this.queryVectorSquaredMagnitude);\n+            }\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+        return score;\n+    }\n+\n+    @Override\n+    public void setDocument(int docId) {\n+        try {\n+            this.binaryDocValuesReader.advanceExact(docId);\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public KNNVectorScoreScript(Map<String, Object> params, String field, float[] queryVector, float queryVectorSquaredMagnitude,\n+                                String similaritySpace, SearchLookup lookup, LeafReaderContext leafContext) {\n+        super(params, lookup, leafContext);\n+        // get query vector - convert to primitive\n+        final Object vector = params.get(\"vector\");\n+        this.similaritySpace = similaritySpace;\n+        this.queryVector = queryVector;\n+        this.queryVectorSquaredMagnitude = queryVectorSquaredMagnitude;\n+        try {\n+            this.binaryDocValuesReader = leafContext.reader().getBinaryDocValues(field);\n+            if(this.binaryDocValuesReader == null) {\n+                throw new IllegalStateException();", "originalCommit": "32483d9d18c6b1d501e9cb35ad5f2c89e6a27186", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMjM5NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r487222394", "bodyText": "Fixed. thanks", "author": "vamshin", "createdAt": "2020-09-11T18:38:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0NjIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0NzE5Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r485247193", "bodyText": "minor. space can also use validation.", "author": "wnbts", "createdAt": "2020-09-08T23:19:52Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNVectorScoreScript.java", "diffHunk": "@@ -0,0 +1,162 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+\n+/**\n+ * Vector score script used for adjusting the score based on similarity space\n+ * on a per document basis.\n+ *\n+ */\n+public class KNNVectorScoreScript extends ScoreScript {\n+\n+    private BinaryDocValues binaryDocValuesReader;\n+    private final float[] queryVector;\n+    private final String similaritySpace;\n+    private float queryVectorSquaredMagnitude = -1;\n+\n+    /**\n+     * This function called for each doc in the segment. We evaluate the score of the vector in the doc\n+     *\n+     * @param explanationHolder A helper to take in an explanation from a script and turn\n+     *                          it into an {@link org.apache.lucene.search.Explanation}\n+     * @return score of the vector to the query vector\n+     */\n+    @Override\n+    public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+        float score = Float.MIN_VALUE;\n+        try {\n+            float[] doc_vector;\n+            BytesRef bytesref = binaryDocValuesReader.binaryValue();\n+            // If there is no vector for the corresponding doc then it should be not considered for nearest\n+            // neighbors.\n+            if (bytesref == null) {\n+                return Float.MIN_VALUE;\n+            }\n+            try (ByteArrayInputStream byteStream = new ByteArrayInputStream(bytesref.bytes, bytesref.offset, bytesref.length);\n+                 ObjectInputStream objectStream = new ObjectInputStream(byteStream)) {\n+                doc_vector = (float[]) objectStream.readObject();\n+            } catch (ClassNotFoundException e) {\n+                throw new RuntimeException(e);\n+            }\n+\n+            if(doc_vector.length != queryVector.length) {\n+                throw new IllegalStateException(\"[KNN] query vector and field vector dimensions mismatch. \" +\n+                        \"query vector: \" + queryVector.length + \", stored vector: \" + doc_vector.length);\n+            }\n+\n+            if (KNNConstants.L2.equalsIgnoreCase(similaritySpace)) {\n+                score = KNNScoringUtil.l2Squared(this.queryVector, doc_vector);\n+                score = 1/(1 + score);\n+            } else if (KNNConstants.COSINESIMIL.equalsIgnoreCase(similaritySpace)) {\n+                // Scores cannot be negative so add +1 to the cosine score\n+                score = 1 + KNNScoringUtil.cosinesimilOptimized(this.queryVector, doc_vector, this.queryVectorSquaredMagnitude);\n+            }\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+        return score;\n+    }\n+\n+    @Override\n+    public void setDocument(int docId) {\n+        try {\n+            this.binaryDocValuesReader.advanceExact(docId);\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public KNNVectorScoreScript(Map<String, Object> params, String field, float[] queryVector, float queryVectorSquaredMagnitude,\n+                                String similaritySpace, SearchLookup lookup, LeafReaderContext leafContext) {\n+        super(params, lookup, leafContext);\n+        // get query vector - convert to primitive\n+        final Object vector = params.get(\"vector\");\n+        this.similaritySpace = similaritySpace;\n+        this.queryVector = queryVector;\n+        this.queryVectorSquaredMagnitude = queryVectorSquaredMagnitude;\n+        try {\n+            this.binaryDocValuesReader = leafContext.reader().getBinaryDocValues(field);\n+            if(this.binaryDocValuesReader == null) {\n+                throw new IllegalStateException();\n+            }\n+        } catch (Exception e) {\n+            throw new IllegalStateException(\"Binary Doc values not enabled for the field \" + field\n+                    + \" Please ensure the field type is knn_vector in mappings for this field\");\n+        }\n+    }\n+\n+    public static class VectorScoreScriptFactory implements ScoreScript.LeafFactory {\n+        private final Map<String, Object> params;\n+        private final SearchLookup lookup;\n+        private final String similaritySpace;\n+        private final String field;\n+        private final float[] qVector;\n+        private float qVectorSquaredMagnitude; // Used for cosine optimization\n+\n+        public VectorScoreScriptFactory(Map<String, Object> params, SearchLookup lookup) {\n+            this.params = params;\n+            this.lookup = lookup;\n+            validateParams(params);\n+\n+            // initialize\n+            this.field = params.get(\"field\").toString();\n+            final Object space = params.get(\"space\");\n+            this.similaritySpace = space != null? (String)space: KNNConstants.L2;\n+            this.qVector = KNNScoringUtil.convertVectorToPrimitive(params.get(\"vector\"));\n+            // Optimization for cosinesimil\n+            if (KNNConstants.COSINESIMIL.equalsIgnoreCase(similaritySpace)) {\n+                // calculate the magnitude\n+                qVectorSquaredMagnitude = KNNScoringUtil.getVectorMagnitudeSquared(qVector);\n+            }\n+        }\n+\n+        private void validateParams(Map<String, Object> params) {", "originalCommit": "32483d9d18c6b1d501e9cb35ad5f2c89e6a27186", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE5MTkwMw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r488191903", "bodyText": "Added Validation for space.", "author": "vamshin", "createdAt": "2020-09-14T20:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0NzE5Mw=="}], "type": "inlineReview"}, {"oid": "1344665c3909cbabbd7a9b68bb208111c11d4c7e", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1344665c3909cbabbd7a9b68bb208111c11d4c7e", "message": "incorporated comments", "committedDate": "2020-09-14T21:13:45Z", "type": "commit"}, {"oid": "f9a66981ccfefbadb8288a99fe810b5f5cb0962b", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f9a66981ccfefbadb8288a99fe810b5f5cb0962b", "message": "added unit tests", "committedDate": "2020-09-14T22:14:25Z", "type": "commit"}, {"oid": "1a87d99c66ab18fb8065decbda36ed135acb5c14", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1a87d99c66ab18fb8065decbda36ed135acb5c14", "message": "added integ tests for cosine simil", "committedDate": "2020-09-15T00:09:53Z", "type": "commit"}, {"oid": "9c3681e6c5fc7bca8b82f802e0bf79cfa249c20e", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/9c3681e6c5fc7bca8b82f802e0bf79cfa249c20e", "message": "Merge branch 'master' into vam-customscore", "committedDate": "2020-09-15T01:35:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgxNTM1NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r488815354", "bodyText": "How about simplify as if (!ScoreScript.CONTEXT.equals(context)) ?\nIs it possible that KNN script will have invalid context ? I see we have validated the script source in line 29. We need line 25 as the script context is possibly wrong?", "author": "ylwu-amzn", "createdAt": "2020-09-15T16:50:36Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringScriptEngine.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.script.ScriptContext;\n+import org.elasticsearch.script.ScriptEngine;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * KNN Custom scoring Engine implementation.\n+ */\n+public class KNNScoringScriptEngine implements ScriptEngine {\n+\n+    public static final String NAME = \"knn\";\n+    public static final String SCRIPT_SOURCE = \"knn_score\";\n+\n+    @Override\n+    public String getType() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public <FactoryType> FactoryType compile(String name, String code, ScriptContext<FactoryType> context, Map<String, String> params) {\n+        if (ScoreScript.CONTEXT.equals(context) == false) {", "originalCommit": "9c3681e6c5fc7bca8b82f802e0bf79cfa249c20e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY3NTA0Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r489675047", "bodyText": "As mentioned in the log message KNN Vector scoring scripts cannot be used for context .\nWill fix if (!ScoreScript.CONTEXT.equals(context))", "author": "vamshin", "createdAt": "2020-09-16T19:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgxNTM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgxODM5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r488818391", "bodyText": "Why return null here? We don't need context for KNN score script?", "author": "ylwu-amzn", "createdAt": "2020-09-15T16:55:38Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringScriptEngine.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.script.ScriptContext;\n+import org.elasticsearch.script.ScriptEngine;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * KNN Custom scoring Engine implementation.\n+ */\n+public class KNNScoringScriptEngine implements ScriptEngine {\n+\n+    public static final String NAME = \"knn\";\n+    public static final String SCRIPT_SOURCE = \"knn_score\";\n+\n+    @Override\n+    public String getType() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public <FactoryType> FactoryType compile(String name, String code, ScriptContext<FactoryType> context, Map<String, String> params) {\n+        if (ScoreScript.CONTEXT.equals(context) == false) {\n+            throw new IllegalArgumentException(getType() + \" KNN Vector scoring scripts cannot be used for context [\" + context.name + \"]\");\n+        }\n+        // we use the script \"source\" as the script identifier\n+        if (!SCRIPT_SOURCE.equals(code)) {\n+            throw new IllegalArgumentException(\"Unknown script name \" + code);\n+        }\n+        ScoreScript.Factory factory = KNNVectorScoreScript.VectorScoreScriptFactory::new;\n+        return context.factoryClazz.cast(factory);\n+    }\n+\n+    @Override\n+    public Set<ScriptContext<?>> getSupportedContexts() {\n+        return null;", "originalCommit": "9c3681e6c5fc7bca8b82f802e0bf79cfa249c20e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY3MDk0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r489670946", "bodyText": "There is no context for KNN score script.", "author": "vamshin", "createdAt": "2020-09-16T18:57:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgxODM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyNTIyOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r488825228", "bodyText": "How about we use if/else to make code cleaner like the method below line47?", "author": "ylwu-amzn", "createdAt": "2020-09-15T17:06:59Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+import java.util.ArrayList;\n+\n+public class KNNScoringUtil {\n+    private static Logger logger = LogManager.getLogger(KNNScoringUtil.class);\n+\n+    public static float l2Squared(float[] queryVector, float[] inputVector) {\n+        float squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            float diff = queryVector[i]-inputVector[i];\n+            squaredDistance += diff * diff;\n+        }\n+        return squaredDistance;\n+    }\n+\n+    public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, float normQueryVector) {\n+        float dotProduct = 0.0f;\n+        float normInputVector = 0.0f;\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        float normalizedProduct = normQueryVector * normInputVector;\n+        try {\n+            return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n+        } catch(ArithmeticException ex) {", "originalCommit": "9c3681e6c5fc7bca8b82f802e0bf79cfa249c20e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY2NjUwNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r489666505", "bodyText": "We would like to avoid additional checks where ever possible to improve performance. So try catch takes care of edge cases.", "author": "vamshin", "createdAt": "2020-09-16T18:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyNTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAwNTI5NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r490005295", "bodyText": "Java will throw ArithmeticException for integer division by zero, but not throw ArithmeticException for float division by zero, check this stack overflow question, will return Infinity for float/0,  so we can't catch ArithmeticException and return Float.MIN_VALUE", "author": "ylwu-amzn", "createdAt": "2020-09-17T06:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyNTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEyOTc1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r491129759", "bodyText": "Good catch. Able to catch this in unit tests. Added if condition to check for division by zero issue. Adding if check could have minor performance impact. Will keep an eye in performance tests", "author": "vamshin", "createdAt": "2020-09-18T18:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyNTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzNjAxNA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r491136014", "bodyText": "Thanks, looks good to me.", "author": "ylwu-amzn", "createdAt": "2020-09-18T18:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyNTIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyNjkwNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r488826905", "bodyText": "Seems this method is mostly the same with the method below. Can we unify them by abstracting the common part?", "author": "ylwu-amzn", "createdAt": "2020-09-15T17:09:56Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+import java.util.ArrayList;\n+\n+public class KNNScoringUtil {\n+    private static Logger logger = LogManager.getLogger(KNNScoringUtil.class);\n+\n+    public static float l2Squared(float[] queryVector, float[] inputVector) {\n+        float squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            float diff = queryVector[i]-inputVector[i];\n+            squaredDistance += diff * diff;\n+        }\n+        return squaredDistance;\n+    }\n+\n+    public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, float normQueryVector) {", "originalCommit": "9c3681e6c5fc7bca8b82f802e0bf79cfa249c20e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY2NzA5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r489667091", "bodyText": "I think it makes sense to keep it this way.  Clean to understand.", "author": "vamshin", "createdAt": "2020-09-16T18:54:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyNjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAxODE5NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r490018195", "bodyText": "If we need to make some change in future, we may need to change both methods. But seems it's not high possible that we will change these two methods as they contain just simple calculation. I'm ok to keep it as is.\nHow about we add some comments to these methods to explain differences and the best use cases ? I think it will help others to understand.", "author": "ylwu-amzn", "createdAt": "2020-09-17T07:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyNjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDczMTY0OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r490731648", "bodyText": "Sure added comments", "author": "vamshin", "createdAt": "2020-09-18T06:35:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyNjkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzMDgwOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r488830808", "bodyText": "Is it possible that tmp.get(i) is null?", "author": "ylwu-amzn", "createdAt": "2020-09-15T17:16:56Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+import java.util.ArrayList;\n+\n+public class KNNScoringUtil {\n+    private static Logger logger = LogManager.getLogger(KNNScoringUtil.class);\n+\n+    public static float l2Squared(float[] queryVector, float[] inputVector) {\n+        float squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            float diff = queryVector[i]-inputVector[i];\n+            squaredDistance += diff * diff;\n+        }\n+        return squaredDistance;\n+    }\n+\n+    public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, float normQueryVector) {\n+        float dotProduct = 0.0f;\n+        float normInputVector = 0.0f;\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        float normalizedProduct = normQueryVector * normInputVector;\n+        try {\n+            return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n+        } catch(ArithmeticException ex) {\n+            logger.debug(\"Possibly Division by Zero Exception. Returning min score to put this result to end. \" +\n+                    \"Current normalized product \" + normalizedProduct);\n+            return Float.MIN_VALUE;\n+        }\n+    }\n+\n+    public static float cosinesimil(float[] queryVector, float[] inputVector) {\n+        float dotProduct = 0.0f;\n+        float normQueryVector = 0.0f;\n+        float normInputVector = 0.0f;\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normQueryVector += queryVector[i] * queryVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        float normalizedProduct = normQueryVector * normInputVector;\n+        if (normalizedProduct == 0 ) {\n+            return Float.MIN_VALUE;\n+        }\n+        return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static float[] convertVectorToPrimitive(Object vector) {\n+        float[] primitiveVector = null;\n+        if(vector != null) {\n+            final ArrayList<Double> tmp = (ArrayList<Double>) vector;\n+            primitiveVector = new float[tmp.size()];\n+            for (int i = 0; i < primitiveVector.length; i++) {\n+                primitiveVector[i] = tmp.get(i).floatValue();", "originalCommit": "9c3681e6c5fc7bca8b82f802e0bf79cfa249c20e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY1NTk5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r489655992", "bodyText": "No. It cannot be null.", "author": "vamshin", "createdAt": "2020-09-16T18:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzMDgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzNjE1Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r488836157", "bodyText": "Why use float while this function returns double?", "author": "ylwu-amzn", "createdAt": "2020-09-15T17:23:29Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNVectorScoreScript.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+\n+/**\n+ * Vector score script used for adjusting the score based on similarity space\n+ * on a per document basis.\n+ *\n+ */\n+public class KNNVectorScoreScript extends ScoreScript {\n+\n+    private BinaryDocValues binaryDocValuesReader;\n+    private final float[] queryVector;\n+    private final String similaritySpace;\n+    private float queryVectorSquaredMagnitude = -1;\n+\n+    /**\n+     * This function called for each doc in the segment. We evaluate the score of the vector in the doc\n+     *\n+     * @param explanationHolder A helper to take in an explanation from a script and turn\n+     *                          it into an {@link org.apache.lucene.search.Explanation}\n+     * @return score of the vector to the query vector\n+     */\n+    @Override\n+    public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+        float score = Float.MIN_VALUE;", "originalCommit": "9c3681e6c5fc7bca8b82f802e0bf79cfa249c20e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY2MzYzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r489663631", "bodyText": "All the scores are computed in Float. To keep it consistent returning Float.MIN.", "author": "vamshin", "createdAt": "2020-09-16T18:50:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzNjE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2ODQzNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r488868435", "bodyText": "From https://en.wikipedia.org/wiki/Cosine_similarity,  seems others generally use 1 - cosine similarity, any special logic here we use 1 + cosine similarity ?\nIf just make the score positive, we can use 1 - cosine similarity as well.", "author": "ylwu-amzn", "createdAt": "2020-09-15T18:12:58Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNVectorScoreScript.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+\n+/**\n+ * Vector score script used for adjusting the score based on similarity space\n+ * on a per document basis.\n+ *\n+ */\n+public class KNNVectorScoreScript extends ScoreScript {\n+\n+    private BinaryDocValues binaryDocValuesReader;\n+    private final float[] queryVector;\n+    private final String similaritySpace;\n+    private float queryVectorSquaredMagnitude = -1;\n+\n+    /**\n+     * This function called for each doc in the segment. We evaluate the score of the vector in the doc\n+     *\n+     * @param explanationHolder A helper to take in an explanation from a script and turn\n+     *                          it into an {@link org.apache.lucene.search.Explanation}\n+     * @return score of the vector to the query vector\n+     */\n+    @Override\n+    public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+        float score = Float.MIN_VALUE;\n+        try {\n+            float[] doc_vector;\n+            BytesRef bytesref = binaryDocValuesReader.binaryValue();\n+            // If there is no vector for the corresponding doc then it should be not considered for nearest\n+            // neighbors.\n+            if (bytesref == null) {\n+                return Float.MIN_VALUE;\n+            }\n+            try (ByteArrayInputStream byteStream = new ByteArrayInputStream(bytesref.bytes, bytesref.offset, bytesref.length);\n+                 ObjectInputStream objectStream = new ObjectInputStream(byteStream)) {\n+                doc_vector = (float[]) objectStream.readObject();\n+            } catch (ClassNotFoundException e) {\n+                throw new RuntimeException(e);\n+            }\n+\n+            if(doc_vector.length != queryVector.length) {\n+                throw new IllegalStateException(\"[KNN] query vector and field vector dimensions mismatch. \" +\n+                        \"query vector: \" + queryVector.length + \", stored vector: \" + doc_vector.length);\n+            }\n+\n+            if (KNNConstants.L2.equalsIgnoreCase(similaritySpace)) {\n+                score = KNNScoringUtil.l2Squared(this.queryVector, doc_vector);\n+                score = 1/(1 + score);\n+            } else if (KNNConstants.COSINESIMIL.equalsIgnoreCase(similaritySpace)) {\n+                // Scores cannot be negative so add +1 to the cosine score\n+                score = 1 + KNNScoringUtil.cosinesimilOptimized(this.queryVector, doc_vector, this.queryVectorSquaredMagnitude);", "originalCommit": "9c3681e6c5fc7bca8b82f802e0bf79cfa249c20e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY2NDQ5Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r489664493", "bodyText": "We cannot use 1 - cosine similarity. This would invert the scores and return wrong results.", "author": "vamshin", "createdAt": "2020-09-16T18:51:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2ODQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwMzExNg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r489703116", "bodyText": "Make sense. So the greater score means it's more relevant?", "author": "ylwu-amzn", "createdAt": "2020-09-16T19:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2ODQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTczMzkwNA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r489733904", "bodyText": "Correct.", "author": "vamshin", "createdAt": "2020-09-16T20:26:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2ODQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAxMzQxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r490013415", "bodyText": "Minor, missing space after if, suggest to format the code.", "author": "ylwu-amzn", "createdAt": "2020-09-17T06:58:32Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+import java.util.ArrayList;\n+\n+public class KNNScoringUtil {\n+    private static Logger logger = LogManager.getLogger(KNNScoringUtil.class);\n+\n+    public static float l2Squared(float[] queryVector, float[] inputVector) {\n+        float squaredDistance = 0;\n+        for (int i = 0; i < inputVector.length; i++) {\n+            float diff = queryVector[i]-inputVector[i];\n+            squaredDistance += diff * diff;\n+        }\n+        return squaredDistance;\n+    }\n+\n+    public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, float normQueryVector) {\n+        float dotProduct = 0.0f;\n+        float normInputVector = 0.0f;\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        float normalizedProduct = normQueryVector * normInputVector;\n+        try {\n+            return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n+        } catch(ArithmeticException ex) {\n+            logger.debug(\"Possibly Division by Zero Exception. Returning min score to put this result to end. \" +\n+                    \"Current normalized product \" + normalizedProduct);\n+            return Float.MIN_VALUE;\n+        }\n+    }\n+\n+    public static float cosinesimil(float[] queryVector, float[] inputVector) {\n+        float dotProduct = 0.0f;\n+        float normQueryVector = 0.0f;\n+        float normInputVector = 0.0f;\n+        for (int i = 0; i < queryVector.length; i++) {\n+            dotProduct += queryVector[i] * inputVector[i];\n+            normQueryVector += queryVector[i] * queryVector[i];\n+            normInputVector += inputVector[i] * inputVector[i];\n+        }\n+        float normalizedProduct = normQueryVector * normInputVector;\n+        if (normalizedProduct == 0 ) {\n+            return Float.MIN_VALUE;\n+        }\n+        return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static float[] convertVectorToPrimitive(Object vector) {\n+        float[] primitiveVector = null;\n+        if(vector != null) {", "originalCommit": "9c3681e6c5fc7bca8b82f802e0bf79cfa249c20e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcyOTMyMA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/196#discussion_r490729320", "bodyText": "Fixed.", "author": "vamshin", "createdAt": "2020-09-18T06:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAxMzQxNQ=="}], "type": "inlineReview"}, {"oid": "26576ff7d0fb7d0cb652c95e76fd6f0d19e42492", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/26576ff7d0fb7d0cb652c95e76fd6f0d19e42492", "message": "Added more tests", "committedDate": "2020-09-18T06:11:58Z", "type": "commit"}, {"oid": "89102487ccbd3ecf4ab7c0b9f2d07cd03f9a9b28", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/89102487ccbd3ecf4ab7c0b9f2d07cd03f9a9b28", "message": "Merge branch 'master' into vam-customscore", "committedDate": "2020-09-18T06:13:25Z", "type": "commit"}, {"oid": "6145095b014843f79812c58273c6327f2e79c138", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6145095b014843f79812c58273c6327f2e79c138", "message": "Added more tests", "committedDate": "2020-09-18T18:34:22Z", "type": "commit"}, {"oid": "b883834f83d3df2556f719c23918f37a33ffeb1e", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b883834f83d3df2556f719c23918f37a33ffeb1e", "message": "Fixed function description", "committedDate": "2020-09-18T18:42:35Z", "type": "commit"}]}