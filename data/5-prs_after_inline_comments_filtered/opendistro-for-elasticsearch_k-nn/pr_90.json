{"pr_number": 90, "pr_title": "FEAT: support cosine similarity", "pr_createdAt": "2020-04-12T23:28:25Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90", "timeline": [{"oid": "99cc16c216eacd95760604ca76e2a009590ec355", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/99cc16c216eacd95760604ca76e2a009590ec355", "message": "MNT: pass in spaceType in jni cpp", "committedDate": "2020-04-12T23:10:49Z", "type": "commit"}, {"oid": "6375d490fcb0f452bb2974470aa0ccacb2b4365a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6375d490fcb0f452bb2974470aa0ccacb2b4365a", "message": "MNT: pass in spaceType in jni java", "committedDate": "2020-04-12T23:11:41Z", "type": "commit"}, {"oid": "28f33f9f9ad1e20d57d1d61a9f09a91fa086d57b", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/28f33f9f9ad1e20d57d1d61a9f09a91fa086d57b", "message": "Regenerate header file", "committedDate": "2020-04-12T23:12:04Z", "type": "commit"}, {"oid": "784e67f496b108b5328277021a1329201890e945", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/784e67f496b108b5328277021a1329201890e945", "message": "Regenerate jnilib", "committedDate": "2020-04-12T23:12:51Z", "type": "commit"}, {"oid": "d29cabdc6be802ebb2eb214db050af82fc558ffd", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/d29cabdc6be802ebb2eb214db050af82fc558ffd", "message": "ADD: spacetype into KNN settings", "committedDate": "2020-04-12T23:13:52Z", "type": "commit"}, {"oid": "bde898cdef86a8659080a40f30202b40ea33c0f3", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/bde898cdef86a8659080a40f30202b40ea33c0f3", "message": "Update vector field mapper", "committedDate": "2020-04-12T23:15:10Z", "type": "commit"}, {"oid": "0bdf53e3a4e27fe3f152e1a437f0046f8a06f6b9", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/0bdf53e3a4e27fe3f152e1a437f0046f8a06f6b9", "message": "Pass in spaceType in consumer", "committedDate": "2020-04-12T23:16:35Z", "type": "commit"}, {"oid": "25cafe96cba19e876d71270f52b3fb986c773ded", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/25cafe96cba19e876d71270f52b3fb986c773ded", "message": "ADD: spaceType param into constant", "committedDate": "2020-04-12T23:17:53Z", "type": "commit"}, {"oid": "2920f5b40cc3b80451c794b1db9d5689bbfae24c", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2920f5b40cc3b80451c794b1db9d5689bbfae24c", "message": "fix loadIndex in cache", "committedDate": "2020-04-12T23:18:43Z", "type": "commit"}, {"oid": "a9388a9cde019b3fcf2ee191e8b418b6c45c0d6a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/a9388a9cde019b3fcf2ee191e8b418b6c45c0d6a", "message": "FIX: existing test cases", "committedDate": "2020-04-12T23:19:13Z", "type": "commit"}, {"oid": "8a58bf6778608d2d6346c141cc30a1dbdc31115d", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/8a58bf6778608d2d6346c141cc30a1dbdc31115d", "message": "Update jni external library", "committedDate": "2020-04-12T23:19:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczMzEzNg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r407733136", "bodyText": "Why switch this?", "author": "jmazanec15", "createdAt": "2020-04-13T21:30:29Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNJNITestsIT.java", "diffHunk": "@@ -31,8 +31,8 @@\n import java.util.Map;\n import java.util.stream.Collectors;\n \n-public class KNNJNITests extends ESTestCase {\n-    private static final Logger logger = LogManager.getLogger(KNNJNITests.class);\n+public class KNNJNITestsIT extends ESTestCase {", "originalCommit": "8a58bf6778608d2d6346c141cc30a1dbdc31115d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgxNjcyMA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r407816720", "bodyText": "Ah. When I ran the test locally on IntelliJ, it fails to detect the integration tests therein due to lack of suffix \"IT\" in the class name. So I switched that for easier debugging. Will change it back but I think it might worth doublecheck if CI also neglects the tests.", "author": "chenqi0805", "createdAt": "2020-04-14T01:44:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczMzEzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1MTYwMQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r408351601", "bodyText": "Tests as opposed to IT signals that it is a unit test. These tests run during ./gradlew build, which is what we use for the PR testing workflow. You can also run them individually with this command:\n./gradlew ':test' --tests \"com.amazon.opendistroforelasticsearch.knn.index.KNNJNITests.testCreateHnswIndex\"\n\nWe consider these unit tests because they are testing an isolated portion of code. Interesting that IntelliJ does not pick them up. Will need to look into it.", "author": "jmazanec15", "createdAt": "2020-04-14T18:35:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczMzEzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMjY0Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r408422643", "bodyText": "Ah. Sorry, I misidentified it as IT.", "author": "chenqi0805", "createdAt": "2020-04-14T20:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczMzEzNg=="}], "type": "inlineReview"}, {"oid": "de8271d874f597249517ac5209cd62436b3cf9b0", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/de8271d874f597249517ac5209cd62436b3cf9b0", "message": "FIX: release jstring and char array", "committedDate": "2020-04-14T03:05:10Z", "type": "commit"}, {"oid": "c49efafaf6321ea87ba9411b01b8635d5ecf7497", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/c49efafaf6321ea87ba9411b01b8635d5ecf7497", "message": "Rename test file and added a consinesimil test", "committedDate": "2020-04-14T03:20:21Z", "type": "commit"}, {"oid": "ce2660f21c33ea0bd979bfc6695cad9bba00499f", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ce2660f21c33ea0bd979bfc6695cad9bba00499f", "message": "update .jnilib", "committedDate": "2020-04-14T03:20:37Z", "type": "commit"}, {"oid": "2c10607999d44e7a2e442382e23e7e04a2086ac7", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2c10607999d44e7a2e442382e23e7e04a2086ac7", "message": "Rename file", "committedDate": "2020-04-14T03:35:38Z", "type": "commit"}, {"oid": "65052c8a73bb594e0ceacb87b46b1445e1772ad3", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/65052c8a73bb594e0ceacb87b46b1445e1772ad3", "message": "Rename file", "committedDate": "2020-04-14T05:04:13Z", "type": "commit"}, {"oid": "3eb7a47d8e5d350eea05d6a280881adc85cb864b", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3eb7a47d8e5d350eea05d6a280881adc85cb864b", "message": "Compile .so", "committedDate": "2020-04-14T05:45:11Z", "type": "commit"}, {"oid": "aa26cfb33ed6c9a5fe7bb029db39854cbad38800", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/aa26cfb33ed6c9a5fe7bb029db39854cbad38800", "message": "Compile .so on linux", "committedDate": "2020-04-14T14:08:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MTU4Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r408341583", "bodyText": "Why is this case insensitive?", "author": "jmazanec15", "createdAt": "2020-04-14T18:18:42Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -367,4 +387,48 @@ public void setClusterService(ClusterService clusterService) {\n         this.clusterService = clusterService;\n     }\n \n+    static class SpaceTypeValidator implements Setting.Validator<String> {\n+\n+        private Set<String> types = SpaceTypes.getValues();\n+\n+        @Override public void validate(String value) {\n+            if (!types.contains(value.toLowerCase())){", "originalCommit": "aa26cfb33ed6c9a5fe7bb029db39854cbad38800", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMzMzMA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r408423330", "bodyText": "I intended to set it case insensitive, e.g. L2, Cosinesimil is also valid string. But I can remove this if not necessary.", "author": "chenqi0805", "createdAt": "2020-04-14T20:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MTU4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4NTg5OQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r409685899", "bodyText": "I think case insensitive is good", "author": "jmazanec15", "createdAt": "2020-04-16T16:22:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MTU4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MzE3Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r408343177", "bodyText": "Could you add test cases to ensure that invalid space names throw the expected exceptions?", "author": "jmazanec15", "createdAt": "2020-04-14T18:21:29Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNJNITests.java", "diffHunk": "@@ -165,7 +214,7 @@ public Void run() {\n         float[] queryVector = {1.0f, 1.0f, 1.0f, 1.0f};\n         String[] algoQueryParams = {\"efSearch=200\"};\n \n-        final KNNIndex index = KNNIndex.loadIndex(indexPath, algoQueryParams);\n+        final KNNIndex index = KNNIndex.loadIndex(indexPath, \"l2\", algoQueryParams);\n         final KNNQueryResult[] results = index.queryIndex(queryVector, 30);\n \n         Map<Integer, Float> scores = Arrays.stream(results).collect(", "originalCommit": "aa26cfb33ed6c9a5fe7bb029db39854cbad38800", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMzQ3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r408423475", "bodyText": "Yes. My initial thought was to add such tests at KNNSettings module b/c that is where I want the input value to be validated and fail fast. Do you think it is also necessary to prevent invalid spaceType into JNI functions?", "author": "chenqi0805", "createdAt": "2020-04-14T20:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU1MDgwMg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r408550802", "bodyText": "Added an integration test in KNNESSettingsIT.", "author": "chenqi0805", "createdAt": "2020-04-15T02:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4ODEzNw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r409688137", "bodyText": "Makes sense thanks", "author": "jmazanec15", "createdAt": "2020-04-16T16:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MzE3Nw=="}], "type": "inlineReview"}, {"oid": "18a84068eccdca5eaa06ae88e27bbb29bdcf785e", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/18a84068eccdca5eaa06ae88e27bbb29bdcf785e", "message": "TST: IT on invalid spaceType settings", "committedDate": "2020-04-15T02:48:14Z", "type": "commit"}, {"oid": "5ebb93023d57c484cc22715a1662ee1fd6518a42", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/5ebb93023d57c484cc22715a1662ee1fd6518a42", "message": "Merge branch 'feat/28-cosine-similarity' of github.com:chenqi0805/k-NN into feat/28-cosine-similarity\n\n* 'feat/28-cosine-similarity' of github.com:chenqi0805/k-NN:\n  Compile .so on linux", "committedDate": "2020-04-15T02:49:53Z", "type": "commit"}, {"oid": "635c7b1e62fbb48e71693f7282d4eb35fc7c9f3a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/635c7b1e62fbb48e71693f7282d4eb35fc7c9f3a", "message": "Unused import", "committedDate": "2020-04-15T02:55:14Z", "type": "commit"}, {"oid": "83e4a90780ed8811393f16bd250dd480ca378c18", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/83e4a90780ed8811393f16bd250dd480ca378c18", "message": "Update README", "committedDate": "2020-04-15T03:15:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzMDc1Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r408630756", "bodyText": "null check on value", "author": "vamshin", "createdAt": "2020-04-15T07:19:27Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -367,4 +387,48 @@ public void setClusterService(ClusterService clusterService) {\n         this.clusterService = clusterService;\n     }\n \n+    static class SpaceTypeValidator implements Setting.Validator<String> {\n+\n+        private Set<String> types = SpaceTypes.getValues();\n+\n+        @Override public void validate(String value) {", "originalCommit": "83e4a90780ed8811393f16bd250dd480ca378c18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3ODgyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r410378825", "bodyText": "@vamshin I put a null check here, but it still fails to guard against null value, i.e. for some reason, if index.knn.space_type == null, it will not go through the validate. Similar bug happens to other parameters, e.g.\nPUT /myindex\n{\n    \"settings\" : {\n        \"index\": {\n            \"knn\": true,\n            \"knn.algo_param.m\": null\n        }\n    }\n}\n\nPUT /myindex/_doc/2?refresh=true\n{\n    \"my_vector1\" : [1.5, 2.5],\n    \"price\":10\n}\n\nPOST /myindex/_search\n{\n    \"size\" : 10,\n    \"query\": {\n        \"knn\": {\n            \"my_vector1\": {\n                \"vector\": [15, 25],\n                \"k\": 2\n            }\n        }\n    }\n}\n\nyields\n{\n  \"took\" : 0,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 0,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  }\n}\n\nHow about we open a separate issue to track this?", "author": "chenqi0805", "createdAt": "2020-04-17T17:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzMDc1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwODI5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r410408296", "bodyText": "Ah got it. I think we can probably ignore this case.", "author": "vamshin", "createdAt": "2020-04-17T18:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzMDc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzMTI0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r408631245", "bodyText": "nit: Move this enum class to a dedicated file", "author": "vamshin", "createdAt": "2020-04-15T07:20:27Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -367,4 +387,48 @@ public void setClusterService(ClusterService clusterService) {\n         this.clusterService = clusterService;\n     }\n \n+    static class SpaceTypeValidator implements Setting.Validator<String> {\n+\n+        private Set<String> types = SpaceTypes.getValues();\n+\n+        @Override public void validate(String value) {\n+            if (!types.contains(value.toLowerCase())){\n+                throw new InvalidParameterException(String.format(\"Unsupported space type: %s\", value));\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Enum contains space types for k-NN similarity search\n+     */\n+    public enum SpaceTypes {", "originalCommit": "83e4a90780ed8811393f16bd250dd480ca378c18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY0MDU2NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/90#discussion_r408640564", "bodyText": "nit: final String spaceType?", "author": "vamshin", "createdAt": "2020-04-15T07:37:50Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/v1736/KNNIndex.java", "diffHunk": "@@ -110,12 +110,13 @@ public void close() {\n      * Loads the knn index to memory for querying the neighbours\n      *\n      * @param indexPath path where the hnsw index is stored\n+     * @param spaceType space type of the index\n      * @param algoParams hnsw algorithm parameters\n      * @return knn index that can be queried for k nearest neighbours\n      */\n-    public static KNNIndex loadIndex(String indexPath, final String[] algoParams) {\n+    public static KNNIndex loadIndex(String indexPath, String spaceType, final String[] algoParams) {", "originalCommit": "83e4a90780ed8811393f16bd250dd480ca378c18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e858038b854cfa0c08f569dc71dc9a22a8624999", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/e858038b854cfa0c08f569dc71dc9a22a8624999", "message": "MNT: null check on spacetype", "committedDate": "2020-04-17T15:36:16Z", "type": "commit"}, {"oid": "6cbfc79d9cb7069e61bdcccffbf1f62a04704cb1", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6cbfc79d9cb7069e61bdcccffbf1f62a04704cb1", "message": "REF: SpaceTypes", "committedDate": "2020-04-17T15:54:19Z", "type": "commit"}, {"oid": "66cbbe84eb505a8911a014f91003cc3c37b4f2f2", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/66cbbe84eb505a8911a014f91003cc3c37b4f2f2", "message": "MNT: arg order in jni", "committedDate": "2020-04-17T16:16:12Z", "type": "commit"}, {"oid": "c852d84d9892aee131bc5e2bf4896ac6e46a863d", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/c852d84d9892aee131bc5e2bf4896ac6e46a863d", "message": "Compile .so", "committedDate": "2020-04-17T16:31:17Z", "type": "commit"}, {"oid": "0394e937f5739e4306f7c733b7d56ca972e8c85e", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/0394e937f5739e4306f7c733b7d56ca972e8c85e", "message": "MNT: update readme on settings and experimental section", "committedDate": "2020-04-26T18:37:32Z", "type": "commit"}]}