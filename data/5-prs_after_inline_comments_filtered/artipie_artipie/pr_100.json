{"pr_number": 100, "pr_title": "#90 - SliceFromConfig class", "pr_createdAt": "2020-04-25T14:43:24Z", "pr_url": "https://github.com/artipie/artipie/pull/100", "timeline": [{"oid": "1e8bdd1c7f21de6b17585f6168bbc55468351129", "url": "https://github.com/artipie/artipie/commit/1e8bdd1c7f21de6b17585f6168bbc55468351129", "message": "#90 - SliceFromConfig class", "committedDate": "2020-04-25T14:42:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODM4NA==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415158384", "bodyText": "@HDouss I dont think we should execute the request here, it should return CompletitionStage", "author": "Vatavuk", "createdAt": "2020-04-25T22:32:42Z", "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+\n+package com.artipie;\n+\n+import com.artipie.composer.http.PhpComposer;\n+import com.artipie.files.FilesSlice;\n+import com.artipie.gem.GemSlice;\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import com.artipie.maven.http.MavenSlice;\n+import com.artipie.npm.Npm;\n+import com.artipie.npm.http.NpmSlice;\n+import com.artipie.rpm.http.RpmSlice;\n+import com.jcabi.log.Logger;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Slice from repo config.\n+ * @since 0.1.4\n+ * @todo #90:30min We still don't have tests for Pie. But now that this class was extracted, we have\n+ *  a more cohesive class that could be tested. Write unit tests for SliceFromConfig class.\n+ */\n+public final class SliceFromConfig implements Slice {\n+\n+    /**\n+     * Repository config.\n+     */\n+    private final RepoConfig config;\n+\n+    /**\n+     * Ctor.\n+     * @param config Repo config\n+     */\n+    public SliceFromConfig(final RepoConfig config) {\n+        this.config = config;\n+    }\n+\n+    @Override\n+    public Response response(final String line, final Iterable<Map.Entry<String, String>> headers,\n+        final Publisher<ByteBuffer> body) {\n+        try {\n+            return SliceFromConfig.build(this.config).response(\n+                line, headers, body\n+            );\n+        } catch (final InterruptedException ex) {\n+            Logger.error(this, \"Interruption when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        } catch (final ExecutionException ex) {\n+            Logger.error(this, \"Exception when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        }\n+    }\n+\n+    /**\n+     * Find a slice implementation for config.\n+     * @param cfg Repository config\n+     * @return Slice\n+     * @throws ExecutionException If error getting the slice\n+     * @throws InterruptedException If error getting the slice\n+     */\n+    private static Slice build(final RepoConfig cfg) throws InterruptedException,\n+        ExecutionException {\n+        return cfg.type().thenCombine(\n+            cfg.storage(),\n+            (type, storage) -> {\n+                final Slice slice;\n+                switch (type) {\n+                    case \"file\":\n+                        slice = new FilesSlice(storage);\n+                        break;\n+                    case \"npm\":\n+                        slice = new NpmSlice(new Npm(storage), storage);\n+                        break;\n+                    case \"gem\":\n+                        slice = new GemSlice(storage);\n+                        break;\n+                    case \"rpm\":\n+                        slice = new RpmSlice(storage);\n+                        break;\n+                    case \"php\":\n+                        try {\n+                            slice = cfg.path().thenApply(\n+                                path -> new PhpComposer(path, storage)\n+                            ).toCompletableFuture().get();", "originalCommit": "1e8bdd1c7f21de6b17585f6168bbc55468351129", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI4OTMxNw==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415289317", "bodyText": "@Vatavuk it is not executing the request, it is resolving config.path and build the slice. This method is returning a slice", "author": "HDouss", "createdAt": "2020-04-26T11:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM2NDY2MA==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415364660", "bodyText": "@HDouss We are fetching yaml content from a repo in an asynchronous manner. The code you've wrote will be synchronous.", "author": "Vatavuk", "createdAt": "2020-04-26T17:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM5NDQ3Mw==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415394473", "bodyText": "@Vatavuk Actually it is not really synchronous. Because all this method is called when the response method of the slice is called. What is really synchronous is the call to the constructor of SliceFromConfig which is much less than the older switch/case logic (that was actually synchronous)", "author": "HDouss", "createdAt": "2020-04-26T20:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwODY3Mg==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415408672", "bodyText": "@HDouss you are right, I didn't catch the execution of the methotd itself", "author": "Vatavuk", "createdAt": "2020-04-26T21:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODY1OA==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415158658", "bodyText": "@HDouss I don't think that this class can implement Slice since it has to build CompletionStage<Slice> in order to be async.", "author": "Vatavuk", "createdAt": "2020-04-25T22:34:20Z", "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+\n+package com.artipie;\n+\n+import com.artipie.composer.http.PhpComposer;\n+import com.artipie.files.FilesSlice;\n+import com.artipie.gem.GemSlice;\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import com.artipie.maven.http.MavenSlice;\n+import com.artipie.npm.Npm;\n+import com.artipie.npm.http.NpmSlice;\n+import com.artipie.rpm.http.RpmSlice;\n+import com.jcabi.log.Logger;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Slice from repo config.\n+ * @since 0.1.4\n+ * @todo #90:30min We still don't have tests for Pie. But now that this class was extracted, we have\n+ *  a more cohesive class that could be tested. Write unit tests for SliceFromConfig class.\n+ */\n+public final class SliceFromConfig implements Slice {", "originalCommit": "1e8bdd1c7f21de6b17585f6168bbc55468351129", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI4OTU1NA==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415289554", "bodyText": "@Vatavuk That's what the puzzle (issue description) tells. Anyway, I defered the slice building and response acting to the response method so it would be async.", "author": "HDouss", "createdAt": "2020-04-26T11:39:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM2NTQ3OQ==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415365479", "bodyText": "@HDouss it is not deferred because of instantiation of php slice which needs to fetch path from the repo. The code for php instantiation executes .toCompletableFuture().get().", "author": "Vatavuk", "createdAt": "2020-04-26T18:01:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM5NDY2Mw==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415394663", "bodyText": "@Vatavuk That still not happen until SliceFromConfig.response is called, which is deferred.", "author": "HDouss", "createdAt": "2020-04-26T20:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODcxMA==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415158710", "bodyText": "@HDouss I believe that we can use Map instead of ugly switch/case.", "author": "Vatavuk", "createdAt": "2020-04-25T22:34:48Z", "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+\n+package com.artipie;\n+\n+import com.artipie.composer.http.PhpComposer;\n+import com.artipie.files.FilesSlice;\n+import com.artipie.gem.GemSlice;\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import com.artipie.maven.http.MavenSlice;\n+import com.artipie.npm.Npm;\n+import com.artipie.npm.http.NpmSlice;\n+import com.artipie.rpm.http.RpmSlice;\n+import com.jcabi.log.Logger;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Slice from repo config.\n+ * @since 0.1.4\n+ * @todo #90:30min We still don't have tests for Pie. But now that this class was extracted, we have\n+ *  a more cohesive class that could be tested. Write unit tests for SliceFromConfig class.\n+ */\n+public final class SliceFromConfig implements Slice {\n+\n+    /**\n+     * Repository config.\n+     */\n+    private final RepoConfig config;\n+\n+    /**\n+     * Ctor.\n+     * @param config Repo config\n+     */\n+    public SliceFromConfig(final RepoConfig config) {\n+        this.config = config;\n+    }\n+\n+    @Override\n+    public Response response(final String line, final Iterable<Map.Entry<String, String>> headers,\n+        final Publisher<ByteBuffer> body) {\n+        try {\n+            return SliceFromConfig.build(this.config).response(\n+                line, headers, body\n+            );\n+        } catch (final InterruptedException ex) {\n+            Logger.error(this, \"Interruption when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        } catch (final ExecutionException ex) {\n+            Logger.error(this, \"Exception when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        }\n+    }\n+\n+    /**\n+     * Find a slice implementation for config.\n+     * @param cfg Repository config\n+     * @return Slice\n+     * @throws ExecutionException If error getting the slice\n+     * @throws InterruptedException If error getting the slice\n+     */\n+    private static Slice build(final RepoConfig cfg) throws InterruptedException,\n+        ExecutionException {\n+        return cfg.type().thenCombine(\n+            cfg.storage(),\n+            (type, storage) -> {\n+                final Slice slice;\n+                switch (type) {", "originalCommit": "1e8bdd1c7f21de6b17585f6168bbc55468351129", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI4OTgwMg==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415289802", "bodyText": "@Vatavuk If we use Map, what could be the values? Classes that we instantiate by reflection afterwards? That would be ugly too...may be uglier.", "author": "HDouss", "createdAt": "2020-04-26T11:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM2NjQ3OA==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415366478", "bodyText": "@HDouss there are no reflections. Simple HashMap\nnew MapOf(\n  new MapEntry(\"file\", (cfg) -> new FilesSlice(storage))),\n  new MapEntry(\"npm\" (cfg) -> new NpmSlice(new Npm(storage), storage))\n  ...\n)\nThe map should probably return CompletionStage instead of Slice so that the code remain async.", "author": "Vatavuk", "createdAt": "2020-04-26T18:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwNDc4OQ==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415404789", "bodyText": "@Vatavuk Thanks for your explanation. Fixed!", "author": "HDouss", "createdAt": "2020-04-26T21:26:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1ODcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1OTAwNg==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415159006", "bodyText": "@HDouss SliceFromConfig should build CompletionStage<Slice> in order to be async and we should remove completedStage here", "author": "Vatavuk", "createdAt": "2020-04-25T22:36:22Z", "path": "src/main/java/com/artipie/Pie.java", "diffHunk": "@@ -101,54 +91,7 @@ public Response response(final String line, final Iterable<Map.Entry<String, Str\n                     storage -> storage.value(new Key.From(String.format(\"%s.yaml\", repo)))\n                 )\n                 .thenApply(content -> new RepoConfig(this.vertx, content))\n-                .thenCompose(Pie::sliceForConfig)\n+                .thenCompose(cfg -> CompletableFuture.completedStage(new SliceFromConfig(cfg)))", "originalCommit": "1e8bdd1c7f21de6b17585f6168bbc55468351129", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI5MDI2MQ==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415290261", "bodyText": "@Vatavuk That what the issue description tell..to implement Slice. Anyway the constructor is too fast, it is even faster than the construction of the CompletionStage<Slice> that was made by Pie::sliceForConfig. The actual logic is defered in the response medthod.", "author": "HDouss", "createdAt": "2020-04-26T11:43:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1OTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM2NzIzMw==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415367233", "bodyText": "@HDouss If you make SliceFromConfig async we don't need completedStage. If you think that SliceFromConfig doesn't need to be async please say why, because this wasn't the original behaviour.", "author": "Vatavuk", "createdAt": "2020-04-26T18:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1OTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM2Nzc3Mw==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415367773", "bodyText": "@HDouss I know that the issue says that we should implement Slice just to make code more reusable, a refactoring. But I don't see how can we do this unless we change the behaviour.", "author": "Vatavuk", "createdAt": "2020-04-26T18:13:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1OTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM2OTIxOA==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415369218", "bodyText": "@g4s8 maybe little help here. The purpose of this feature is to break the class into the smaller chunks. It was written with refactoring on the mind and I believe it should not change any behaviour. That being said this PR instantiates Slice objects synchronously as opposed to before. Is this ok or should we revert?", "author": "Vatavuk", "createdAt": "2020-04-26T18:21:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1OTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM5NTI3MQ==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415395271", "bodyText": "@Vatavuk Please see my replies earlier. It is true that it is a slice, and not a CompletionStage<Slice>, but still what is really synchronous is merely the call to the constructor. And anyway, how to \"make SliceFromConfig async\" without making it a utility class?", "author": "HDouss", "createdAt": "2020-04-26T20:35:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1OTAwNg=="}], "type": "inlineReview"}, {"oid": "0e80ad71cf683d5c7e3b32ac1254c81c7d036262", "url": "https://github.com/artipie/artipie/commit/0e80ad71cf683d5c7e3b32ac1254c81c7d036262", "message": "#90 - CR", "committedDate": "2020-04-26T21:26:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQxMDA4Mw==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415410083", "bodyText": "@HDouss extract this to a private method to make it more readable", "author": "Vatavuk", "createdAt": "2020-04-26T21:57:08Z", "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+\n+package com.artipie;\n+\n+import com.artipie.composer.http.PhpComposer;\n+import com.artipie.files.FilesSlice;\n+import com.artipie.gem.GemSlice;\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import com.artipie.maven.http.MavenSlice;\n+import com.artipie.npm.Npm;\n+import com.artipie.npm.http.NpmSlice;\n+import com.artipie.rpm.http.RpmSlice;\n+import com.jcabi.log.Logger;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import org.cactoos.map.MapEntry;\n+import org.cactoos.map.MapOf;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Slice from repo config.\n+ * @since 0.1.4\n+ * @todo #90:30min We still don't have tests for Pie. But now that this class was extracted, we have\n+ *  a more cohesive class that could be tested. Write unit tests for SliceFromConfig class.\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+public final class SliceFromConfig implements Slice {\n+\n+    /**\n+     * Repository config.\n+     */\n+    private final RepoConfig config;\n+\n+    /**\n+     * Ctor.\n+     * @param config Repo config\n+     */\n+    public SliceFromConfig(final RepoConfig config) {\n+        this.config = config;\n+    }\n+\n+    @Override\n+    public Response response(final String line, final Iterable<Map.Entry<String, String>> headers,\n+        final Publisher<ByteBuffer> body) {\n+        try {\n+            return SliceFromConfig.build(this.config).response(\n+                line, headers, body\n+            );\n+        } catch (final InterruptedException ex) {\n+            Logger.error(this, \"Interruption when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        } catch (final ExecutionException ex) {\n+            Logger.error(this, \"Exception when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        }\n+    }\n+\n+    /**\n+     * Find a slice implementation for config.\n+     * @param cfg Repository config\n+     * @return Slice\n+     * @throws ExecutionException If error getting the slice\n+     * @throws InterruptedException If error getting the slice\n+     */\n+    private static Slice build(final RepoConfig cfg) throws InterruptedException,\n+        ExecutionException {\n+        return cfg.type().thenCombine(\n+            cfg.storage(),\n+            (type, storage) -> {\n+                return new MapOf<String, Function<RepoConfig, Slice>>(\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"file\", config -> new FilesSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"npm\", config -> new NpmSlice(new Npm(storage), storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"gem\", config -> new GemSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"rpm\", config -> new RpmSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"php\",\n+                        config -> {", "originalCommit": "0e80ad71cf683d5c7e3b32ac1254c81c7d036262", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQxMDE1Mg==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415410152", "bodyText": "@HDouss we should check if the type exists in the map and throw exception if it doesnt", "author": "Vatavuk", "createdAt": "2020-04-26T21:57:35Z", "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+\n+package com.artipie;\n+\n+import com.artipie.composer.http.PhpComposer;\n+import com.artipie.files.FilesSlice;\n+import com.artipie.gem.GemSlice;\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import com.artipie.maven.http.MavenSlice;\n+import com.artipie.npm.Npm;\n+import com.artipie.npm.http.NpmSlice;\n+import com.artipie.rpm.http.RpmSlice;\n+import com.jcabi.log.Logger;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import org.cactoos.map.MapEntry;\n+import org.cactoos.map.MapOf;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Slice from repo config.\n+ * @since 0.1.4\n+ * @todo #90:30min We still don't have tests for Pie. But now that this class was extracted, we have\n+ *  a more cohesive class that could be tested. Write unit tests for SliceFromConfig class.\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+public final class SliceFromConfig implements Slice {\n+\n+    /**\n+     * Repository config.\n+     */\n+    private final RepoConfig config;\n+\n+    /**\n+     * Ctor.\n+     * @param config Repo config\n+     */\n+    public SliceFromConfig(final RepoConfig config) {\n+        this.config = config;\n+    }\n+\n+    @Override\n+    public Response response(final String line, final Iterable<Map.Entry<String, String>> headers,\n+        final Publisher<ByteBuffer> body) {\n+        try {\n+            return SliceFromConfig.build(this.config).response(\n+                line, headers, body\n+            );\n+        } catch (final InterruptedException ex) {\n+            Logger.error(this, \"Interruption when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        } catch (final ExecutionException ex) {\n+            Logger.error(this, \"Exception when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        }\n+    }\n+\n+    /**\n+     * Find a slice implementation for config.\n+     * @param cfg Repository config\n+     * @return Slice\n+     * @throws ExecutionException If error getting the slice\n+     * @throws InterruptedException If error getting the slice\n+     */\n+    private static Slice build(final RepoConfig cfg) throws InterruptedException,\n+        ExecutionException {\n+        return cfg.type().thenCombine(\n+            cfg.storage(),\n+            (type, storage) -> {\n+                return new MapOf<String, Function<RepoConfig, Slice>>(\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"file\", config -> new FilesSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"npm\", config -> new NpmSlice(new Npm(storage), storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"gem\", config -> new GemSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"rpm\", config -> new RpmSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"php\",\n+                        config -> {\n+                            try {\n+                                return config.path().thenApply(\n+                                    path -> new PhpComposer(path, storage)\n+                                ).toCompletableFuture().get();\n+                            } catch (final InterruptedException ex) {\n+                                Logger.error(\n+                                    SliceFromConfig.class, \"Interrupted PhpComposer creation\"\n+                                );\n+                                throw new IllegalArgumentException(ex);\n+                            } catch (final ExecutionException ex) {\n+                                Logger.error(\n+                                    SliceFromConfig.class, \"Exception getting PhpComposer\"\n+                                );\n+                                throw new IllegalArgumentException(ex);\n+                            }\n+                        }\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"maven\", config -> new MavenSlice(storage)\n+                    )\n+                ).get(type).apply(cfg);", "originalCommit": "0e80ad71cf683d5c7e3b32ac1254c81c7d036262", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1e86d8e48bc5c478bfe53b3ca26b8879d3f8106d", "url": "https://github.com/artipie/artipie/commit/1e86d8e48bc5c478bfe53b3ca26b8879d3f8106d", "message": "#90 - CR", "committedDate": "2020-04-26T22:16:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU0MjkyMQ==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415542921", "bodyText": "@HDouss why do we have InterruptedException here? Does this method perform any blocking operation? We can't allow thread blocking for Slice implementations.", "author": "g4s8", "createdAt": "2020-04-27T06:26:10Z", "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+\n+package com.artipie;\n+\n+import com.artipie.composer.http.PhpComposer;\n+import com.artipie.files.FilesSlice;\n+import com.artipie.gem.GemSlice;\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import com.artipie.maven.http.MavenSlice;\n+import com.artipie.npm.Npm;\n+import com.artipie.npm.http.NpmSlice;\n+import com.artipie.rpm.http.RpmSlice;\n+import com.jcabi.log.Logger;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import org.cactoos.map.MapEntry;\n+import org.cactoos.map.MapOf;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Slice from repo config.\n+ * @since 0.1.4\n+ * @todo #90:30min We still don't have tests for Pie. But now that this class was extracted, we have\n+ *  a more cohesive class that could be tested. Write unit tests for SliceFromConfig class.\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+public final class SliceFromConfig implements Slice {\n+\n+    /**\n+     * Repository config.\n+     */\n+    private final RepoConfig config;\n+\n+    /**\n+     * Ctor.\n+     * @param config Repo config\n+     */\n+    public SliceFromConfig(final RepoConfig config) {\n+        this.config = config;\n+    }\n+\n+    @Override\n+    public Response response(final String line, final Iterable<Map.Entry<String, String>> headers,\n+        final Publisher<ByteBuffer> body) {\n+        try {\n+            return SliceFromConfig.build(this.config).response(\n+                line, headers, body\n+            );\n+        } catch (final InterruptedException ex) {\n+            Logger.error(this, \"Interruption when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        } catch (final ExecutionException ex) {\n+            Logger.error(this, \"Exception when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        }\n+    }\n+\n+    /**\n+     * Find a slice implementation for config.\n+     * @param cfg Repository config\n+     * @return Slice\n+     * @throws ExecutionException If error getting the slice\n+     * @throws InterruptedException If error getting the slice\n+     * @todo #90:30min This method still needs more refactoring. First, we should extract\n+     *  PhpComposer Slice construction to a private method to make it more readable. And then,\n+     *  we should test if the type exist in the constructed map. If the type does not exist,\n+     *  we should throw an IllegalStateException with the message \"Unsupported repository type '%s'\"\n+     */\n+    private static Slice build(final RepoConfig cfg) throws InterruptedException,", "originalCommit": "1e86d8e48bc5c478bfe53b3ca26b8879d3f8106d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU0MzM4Mg==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415543382", "bodyText": "@HDouss same here: why InterruptedException? Please don't use get() method anywhere except test methods.", "author": "g4s8", "createdAt": "2020-04-27T06:27:10Z", "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+\n+package com.artipie;\n+\n+import com.artipie.composer.http.PhpComposer;\n+import com.artipie.files.FilesSlice;\n+import com.artipie.gem.GemSlice;\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import com.artipie.maven.http.MavenSlice;\n+import com.artipie.npm.Npm;\n+import com.artipie.npm.http.NpmSlice;\n+import com.artipie.rpm.http.RpmSlice;\n+import com.jcabi.log.Logger;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import org.cactoos.map.MapEntry;\n+import org.cactoos.map.MapOf;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Slice from repo config.\n+ * @since 0.1.4\n+ * @todo #90:30min We still don't have tests for Pie. But now that this class was extracted, we have\n+ *  a more cohesive class that could be tested. Write unit tests for SliceFromConfig class.\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+public final class SliceFromConfig implements Slice {\n+\n+    /**\n+     * Repository config.\n+     */\n+    private final RepoConfig config;\n+\n+    /**\n+     * Ctor.\n+     * @param config Repo config\n+     */\n+    public SliceFromConfig(final RepoConfig config) {\n+        this.config = config;\n+    }\n+\n+    @Override\n+    public Response response(final String line, final Iterable<Map.Entry<String, String>> headers,\n+        final Publisher<ByteBuffer> body) {\n+        try {\n+            return SliceFromConfig.build(this.config).response(\n+                line, headers, body\n+            );\n+        } catch (final InterruptedException ex) {\n+            Logger.error(this, \"Interruption when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        } catch (final ExecutionException ex) {\n+            Logger.error(this, \"Exception when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        }\n+    }\n+\n+    /**\n+     * Find a slice implementation for config.\n+     * @param cfg Repository config\n+     * @return Slice\n+     * @throws ExecutionException If error getting the slice\n+     * @throws InterruptedException If error getting the slice\n+     * @todo #90:30min This method still needs more refactoring. First, we should extract\n+     *  PhpComposer Slice construction to a private method to make it more readable. And then,\n+     *  we should test if the type exist in the constructed map. If the type does not exist,\n+     *  we should throw an IllegalStateException with the message \"Unsupported repository type '%s'\"\n+     */\n+    private static Slice build(final RepoConfig cfg) throws InterruptedException,\n+        ExecutionException {\n+        return cfg.type().thenCombine(\n+            cfg.storage(),\n+            (type, storage) -> {\n+                return new MapOf<String, Function<RepoConfig, Slice>>(\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"file\", config -> new FilesSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"npm\", config -> new NpmSlice(new Npm(storage), storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"gem\", config -> new GemSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"rpm\", config -> new RpmSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"php\",\n+                        config -> {\n+                            try {\n+                                return config.path().thenApply(\n+                                    path -> new PhpComposer(path, storage)\n+                                ).toCompletableFuture().get();\n+                            } catch (final InterruptedException ex) {\n+                                Logger.error(", "originalCommit": "1e86d8e48bc5c478bfe53b3ca26b8879d3f8106d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU0MzkyNA==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415543924", "bodyText": "@HDouss we can't block HTTP thread with blocking get() call", "author": "g4s8", "createdAt": "2020-04-27T06:28:26Z", "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+\n+package com.artipie;\n+\n+import com.artipie.composer.http.PhpComposer;\n+import com.artipie.files.FilesSlice;\n+import com.artipie.gem.GemSlice;\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import com.artipie.maven.http.MavenSlice;\n+import com.artipie.npm.Npm;\n+import com.artipie.npm.http.NpmSlice;\n+import com.artipie.rpm.http.RpmSlice;\n+import com.jcabi.log.Logger;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import org.cactoos.map.MapEntry;\n+import org.cactoos.map.MapOf;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Slice from repo config.\n+ * @since 0.1.4\n+ * @todo #90:30min We still don't have tests for Pie. But now that this class was extracted, we have\n+ *  a more cohesive class that could be tested. Write unit tests for SliceFromConfig class.\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+public final class SliceFromConfig implements Slice {\n+\n+    /**\n+     * Repository config.\n+     */\n+    private final RepoConfig config;\n+\n+    /**\n+     * Ctor.\n+     * @param config Repo config\n+     */\n+    public SliceFromConfig(final RepoConfig config) {\n+        this.config = config;\n+    }\n+\n+    @Override\n+    public Response response(final String line, final Iterable<Map.Entry<String, String>> headers,\n+        final Publisher<ByteBuffer> body) {\n+        try {\n+            return SliceFromConfig.build(this.config).response(\n+                line, headers, body\n+            );\n+        } catch (final InterruptedException ex) {\n+            Logger.error(this, \"Interruption when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        } catch (final ExecutionException ex) {\n+            Logger.error(this, \"Exception when getting slice from config\");\n+            throw new IllegalArgumentException(ex);\n+        }\n+    }\n+\n+    /**\n+     * Find a slice implementation for config.\n+     * @param cfg Repository config\n+     * @return Slice\n+     * @throws ExecutionException If error getting the slice\n+     * @throws InterruptedException If error getting the slice\n+     * @todo #90:30min This method still needs more refactoring. First, we should extract\n+     *  PhpComposer Slice construction to a private method to make it more readable. And then,\n+     *  we should test if the type exist in the constructed map. If the type does not exist,\n+     *  we should throw an IllegalStateException with the message \"Unsupported repository type '%s'\"\n+     */\n+    private static Slice build(final RepoConfig cfg) throws InterruptedException,\n+        ExecutionException {\n+        return cfg.type().thenCombine(\n+            cfg.storage(),\n+            (type, storage) -> {\n+                return new MapOf<String, Function<RepoConfig, Slice>>(\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"file\", config -> new FilesSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"npm\", config -> new NpmSlice(new Npm(storage), storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"gem\", config -> new GemSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"rpm\", config -> new RpmSlice(storage)\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"php\",\n+                        config -> {\n+                            try {\n+                                return config.path().thenApply(\n+                                    path -> new PhpComposer(path, storage)\n+                                ).toCompletableFuture().get();\n+                            } catch (final InterruptedException ex) {\n+                                Logger.error(\n+                                    SliceFromConfig.class, \"Interrupted PhpComposer creation\"\n+                                );\n+                                throw new IllegalArgumentException(ex);\n+                            } catch (final ExecutionException ex) {\n+                                Logger.error(\n+                                    SliceFromConfig.class, \"Exception getting PhpComposer\"\n+                                );\n+                                throw new IllegalArgumentException(ex);\n+                            }\n+                        }\n+                    ),\n+                    new MapEntry<String, Function<RepoConfig, Slice>>(\n+                        \"maven\", config -> new MavenSlice(storage)\n+                    )\n+                ).get(type).apply(cfg);\n+            }\n+        ).toCompletableFuture().get();", "originalCommit": "1e86d8e48bc5c478bfe53b3ca26b8879d3f8106d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8f584facefe20405b0a8555adcf1644b3c723b47", "url": "https://github.com/artipie/artipie/commit/8f584facefe20405b0a8555adcf1644b3c723b47", "message": "#90 - CR", "committedDate": "2020-04-27T08:05:33Z", "type": "commit"}, {"oid": "0e5d54077ea6277487f06005fd965ebc5ef90ff0", "url": "https://github.com/artipie/artipie/commit/0e5d54077ea6277487f06005fd965ebc5ef90ff0", "message": "Merge branch 'master' into #90", "committedDate": "2020-04-27T11:26:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczMjU5MQ==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415732591", "bodyText": "@HDouss maybe it would be better to use .thenApply(cng -> new SliceFromConfig(cfg)) here?", "author": "g4s8", "createdAt": "2020-04-27T11:28:32Z", "path": "src/main/java/com/artipie/Pie.java", "diffHunk": "@@ -101,54 +91,7 @@ public Response response(final String line, final Iterable<Map.Entry<String, Str\n                     storage -> storage.value(new Key.From(String.format(\"%s.yaml\", repo)))\n                 )\n                 .thenApply(content -> new RepoConfig(this.vertx, content))\n-                .thenCompose(Pie::sliceForConfig)\n+                .thenCompose(cfg -> CompletableFuture.completedStage(new SliceFromConfig(cfg)))", "originalCommit": "0e5d54077ea6277487f06005fd965ebc5ef90ff0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNzg2Ng==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415737866", "bodyText": "@g4s8 Fixed!", "author": "HDouss", "createdAt": "2020-04-27T11:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczMjU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczODYwNg==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415738606", "bodyText": "@g4s8 I don't see the second minor comment..", "author": "HDouss", "createdAt": "2020-04-27T11:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczMjU5MQ=="}], "type": "inlineReview"}, {"oid": "8935ed7f0529ec0c7d476116bd75c4e7e1b6f83d", "url": "https://github.com/artipie/artipie/commit/8935ed7f0529ec0c7d476116bd75c4e7e1b6f83d", "message": "#90 - CR", "committedDate": "2020-04-27T11:37:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc0MDkyMw==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415740923", "bodyText": "@HDouss instead of creating AsyncSlice instance in response method of Slice on each request you can use Slice.Wrap decorator for wrapping this logic:\nclass SliceFromConfig extends Slice.Wrap {\n  public SliceFromConfig(RepoConfig config) {\n    super(\n      new AsyncSlice(SliceFromConfig.build(config))\n    );\n  }\n}", "author": "g4s8", "createdAt": "2020-04-27T11:42:36Z", "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+\n+package com.artipie;\n+\n+import com.artipie.composer.http.PhpComposer;\n+import com.artipie.files.FilesSlice;\n+import com.artipie.gem.GemSlice;\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import com.artipie.http.async.AsyncSlice;\n+import com.artipie.maven.http.MavenSlice;\n+import com.artipie.npm.Npm;\n+import com.artipie.npm.http.NpmSlice;\n+import com.artipie.rpm.http.RpmSlice;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.function.Function;\n+import org.cactoos.map.MapEntry;\n+import org.cactoos.map.MapOf;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Slice from repo config.\n+ * @since 0.1.4\n+ * @todo #90:30min We still don't have tests for Pie. But now that this class was extracted, we have\n+ *  a more cohesive class that could be tested. Write unit tests for SliceFromConfig class.\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+public final class SliceFromConfig implements Slice {\n+\n+    /**\n+     * Repository config.\n+     */\n+    private final RepoConfig config;\n+\n+    /**\n+     * Ctor.\n+     * @param config Repo config\n+     */\n+    public SliceFromConfig(final RepoConfig config) {\n+        this.config = config;\n+    }\n+\n+    @Override\n+    public Response response(final String line, final Iterable<Map.Entry<String, String>> headers,\n+        final Publisher<ByteBuffer> body) {\n+        return new AsyncSlice(", "originalCommit": "8935ed7f0529ec0c7d476116bd75c4e7e1b6f83d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc4NjMzMg==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r415786332", "bodyText": "@g4s8 I don't think it is a good idea. First, that will make the call to SliceFromConfig.build synchronous with the SliceFromConfig construction, so with Pie.response method. Second, for the requests coming from Pie, it is anyway building a new SliceFromConfig on each request, it is even building a new wrapping AsyncSlice.", "author": "HDouss", "createdAt": "2020-04-27T12:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc0MDkyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQwNTg1OA==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r416405858", "bodyText": "@HDouss but SliceFromConfig.build(config) is returning CompletionStage so it's not synchronous, right? Then actual creating of Slice will be deferred until next request. I didn't get your second point, but you are right: we're building new Slice for each request (we may add some caching later), it's correct.\nThe problem with current implementation is only in the design: you are creating new instance of same level in method, but it can be moved to constructor. Creating new concrete implementation in method increases class coupling, but constructor may accept interface types, so coupling will be low.", "author": "g4s8", "createdAt": "2020-04-28T07:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc0MDkyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQxOTE5NA==", "url": "https://github.com/artipie/artipie/pull/100#discussion_r416419194", "bodyText": "@g4s8 What I meant is that the call to build is synchronous. But you are right, now with the last commit modifications it is not synchronous anymore. The second point is about the usage by Pie. Anyway fixed. Please see last commit.", "author": "HDouss", "createdAt": "2020-04-28T08:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc0MDkyMw=="}], "type": "inlineReview"}, {"oid": "09bd9885ccdab682f80e4d085e4330deed64b8d2", "url": "https://github.com/artipie/artipie/commit/09bd9885ccdab682f80e4d085e4330deed64b8d2", "message": "#90 - CR", "committedDate": "2020-04-28T08:14:29Z", "type": "commit"}, {"oid": "ca1af32598d218cf7a4539f61e95369f4174e521", "url": "https://github.com/artipie/artipie/commit/ca1af32598d218cf7a4539f61e95369f4174e521", "message": "Merge branch 'master' into #90", "committedDate": "2020-04-28T13:43:06Z", "type": "commit"}]}