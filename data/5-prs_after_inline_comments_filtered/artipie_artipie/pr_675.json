{"pr_number": 675, "pr_title": "#602 - Verify install nugetIT", "pr_createdAt": "2020-10-08T12:48:08Z", "pr_url": "https://github.com/artipie/artipie/pull/675", "timeline": [{"oid": "72327ff7ba42f09bcddec7d8beb22ef86551cee8", "url": "https://github.com/artipie/artipie/commit/72327ff7ba42f09bcddec7d8beb22ef86551cee8", "message": "#602 - Verify install for nugetIT", "committedDate": "2020-10-08T12:21:55Z", "type": "commit"}, {"oid": "9a8eaee8b781f6ff224616b8be0104320e6df503", "url": "https://github.com/artipie/artipie/commit/9a8eaee8b781f6ff224616b8be0104320e6df503", "message": "#602 - Disable nuget.org", "committedDate": "2020-10-08T12:40:36Z", "type": "commit"}, {"oid": "ad71f9c92466c1962ba4bf8b5692869c983d46b2", "url": "https://github.com/artipie/artipie/commit/ad71f9c92466c1962ba4bf8b5692869c983d46b2", "message": "#602 - Remove apikey", "committedDate": "2020-10-08T12:52:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxMTE4Mg==", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501711182", "bodyText": "@genryxy this.url field is initialized only after this.config() method call. But it is used inside config() method. Not sure how this test works.", "author": "olegmoz", "createdAt": "2020-10-08T13:16:18Z", "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -69,16 +71,22 @@\n     private GenericContainer<?> cntn;\n \n     /**\n-     * Artipie server port.\n+     * URL 'http://host:port/my-nuget'.\n      */\n-    private int port;\n+    private String url;\n+\n+    /**\n+     * Package name in the temporary directory.\n+     */\n+    private String pckg;\n \n     @BeforeEach\n     void init() throws Exception {\n         final String name = \"my-nuget\";\n         this.server = new ArtipieServer(this.tmp, name, this.config());\n-        this.port = this.server.start();\n-        Testcontainers.exposeHostPorts(this.port);\n+        final int port = this.server.start();\n+        this.url = String.format(\"http://host.testcontainers.internal:%d/my-nuget\", port);", "originalCommit": "ad71f9c92466c1962ba4bf8b5692869c983d46b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcyNzQ4Mg==", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501727482", "bodyText": "@olegmoz it works normal since I'm rewriting file with config after the port number is known", "author": "genryxy", "createdAt": "2020-10-08T13:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxMTE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc0NzE4Nw==", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501747187", "bodyText": "@genryxy that's quite surprising, I'd suggest to generate free port before server starts using this technique:\ntry (ServerSocket socket = new ServerSocket(0)) {\n  int port = socket.getLocalPort();\n}", "author": "olegmoz", "createdAt": "2020-10-08T14:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxMTE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxMjg2OA==", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501712868", "bodyText": "@genryxy value for this field is always \"newtonsoft.json\", so this field should not be mutable. Please replace it with constant", "author": "olegmoz", "createdAt": "2020-10-08T13:18:26Z", "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -69,16 +71,22 @@\n     private GenericContainer<?> cntn;\n \n     /**\n-     * Artipie server port.\n+     * URL 'http://host:port/my-nuget'.\n      */\n-    private int port;\n+    private String url;\n+\n+    /**\n+     * Package name in the temporary directory.\n+     */\n+    private String pckg;", "originalCommit": "ad71f9c92466c1962ba4bf8b5692869c983d46b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxNDA1OQ==", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501714059", "bodyText": "@genryxy I think we may move this warning to class level, as both test methods in this class have @Timeout annotations", "author": "olegmoz", "createdAt": "2020-10-08T13:19:59Z", "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -106,10 +114,28 @@ void shouldPushPackage() throws Exception {\n         );\n     }\n \n-    private void createNugetConfig() throws Exception {\n-        final String url = String.format(\n-            \"http://host.testcontainers.internal:%d/my-nuget\", this.port\n+    // @checkstyle MagicNumberCheck (2 lines)", "originalCommit": "ad71f9c92466c1962ba4bf8b5692869c983d46b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxNjY5Mw==", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501716693", "bodyText": "@genryxy here we specify URL for \"artipie-nuget-test\" alias. But I am not sure we are actually using it anywhere, can't we just remove this <packageSources> section?", "author": "olegmoz", "createdAt": "2020-10-08T13:23:32Z", "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -118,8 +144,14 @@ private void createNugetConfig() throws Exception {\n                 \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\"?>\\n\",\n                 \"<configuration>\",\n                 \"<packageSources>\",\n-                String.format(\"<add key=\\\"%s\\\" value=\\\"%s\\\"/>\", source, url),\n+                String.format(\n+                    \"<add key=\\\"%s\\\" value=\\\"%s\\\"/>\",\n+                    source, String.format(\"%s/index.json\", this.url)\n+                ),", "originalCommit": "ad71f9c92466c1962ba4bf8b5692869c983d46b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcyMDY4Mw==", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501720683", "bodyText": "@genryxy file name you pass to nuget push command does not matter. NuGet repository extracts package name from it's content. So I'd suggest to keep using UUID.randomUUID().toString() for filename same as it was", "author": "olegmoz", "createdAt": "2020-10-08T13:29:00Z", "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -139,15 +169,14 @@ private String exec(final String... command) throws Exception {\n     }\n \n     private String pushPackage() throws Exception {\n-        final String uri = \"http://host.testcontainers.internal:%d/my-nuget/index.json\";\n-        final String pckg = UUID.randomUUID().toString();\n+        this.pckg = \"newtonsoft.json\";\n         Files.write(\n-            this.tmp.resolve(pckg),\n+            this.tmp.resolve(this.pckg),\n             new NewtonJsonResource(\"newtonsoft.json.12.0.3.nupkg\").bytes()\n         );\n         return this.exec(\n-            \"dotnet\", \"nuget\", \"push\", pckg, \"--api-key\", \"this.source\",\n-            \"-s\", String.format(uri, this.port)\n+            \"dotnet\", \"nuget\", \"push\", this.pckg,\n+            \"-s\", String.format(\"%s/index.json\", this.url)", "originalCommit": "ad71f9c92466c1962ba4bf8b5692869c983d46b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ad42bc9c2352e4856150982c4d216cc90e9d9663", "url": "https://github.com/artipie/artipie/commit/ad42bc9c2352e4856150982c4d216cc90e9d9663", "message": "#602 - CR", "committedDate": "2020-10-08T13:52:55Z", "type": "commit"}, {"oid": "8e483efe645b999efbee02b7ad3a5e0b40975ca9", "url": "https://github.com/artipie/artipie/commit/8e483efe645b999efbee02b7ad3a5e0b40975ca9", "message": "#602 - Get free local port", "committedDate": "2020-10-08T14:51:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgwODYwNw==", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501808607", "bodyText": "@genryxy here you are using found free port to put it into config. What I meant is to get the port and start ArtipieServer on it. This way you will have correct port in config from the start and will not need to overwrite config later", "author": "olegmoz", "createdAt": "2020-10-08T15:23:11Z", "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -73,17 +79,19 @@\n     private GenericContainer<?> cntn;\n \n     /**\n-     * URL 'http://host:port/my-nuget'.\n+     * Server port.\n      */\n-    private String url;\n+    private int port;\n \n     @BeforeEach\n     void init() throws Exception {\n         final String name = \"my-nuget\";\n-        this.server = new ArtipieServer(this.tmp, name, this.config());\n-        final int port = this.server.start();\n-        this.url = String.format(\"http://host.testcontainers.internal:%d/my-nuget\", port);\n-        Testcontainers.exposeHostPorts(port);\n+        try (ServerSocket socket = new ServerSocket(0)) {\n+            this.port = socket.getLocalPort();\n+            this.server = new ArtipieServer(this.tmp, name, this.config());\n+        }\n+        this.port = this.server.start();", "originalCommit": "8e483efe645b999efbee02b7ad3a5e0b40975ca9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgxMjc3MQ==", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501812771", "bodyText": "@olegmoz  in this case I need to add new constructor with four params in ArtipieServer? Or is there a better solution that I don't see?", "author": "genryxy", "createdAt": "2020-10-08T15:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgwODYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgyNTc4Mg==", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501825782", "bodyText": "@genryxy ah, I see. Sorry thought there is option to run ArtipieServer on specified port at the moment. Could you please create a puzzle about it? Then we will be good to merge", "author": "olegmoz", "createdAt": "2020-10-08T15:46:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgwODYwNw=="}], "type": "inlineReview"}, {"oid": "9dfa27784a3eed5a3e7511d8d9062c5068060d2c", "url": "https://github.com/artipie/artipie/commit/9dfa27784a3eed5a3e7511d8d9062c5068060d2c", "message": "#602 - Add todo", "committedDate": "2020-10-09T05:58:48Z", "type": "commit"}, {"oid": "2be71084733f53e0f06e28d1dc0c567508062cf9", "url": "https://github.com/artipie/artipie/commit/2be71084733f53e0f06e28d1dc0c567508062cf9", "message": "Merge remote-tracking branch 'upstream/master' into 602-installNugetIT", "committedDate": "2020-10-09T06:01:11Z", "type": "commit"}]}