{"pr_number": 268, "pr_title": "#231 - Added MetricsLogPublisher", "pr_createdAt": "2020-07-07T10:17:24Z", "pr_url": "https://github.com/artipie/artipie/pull/268", "timeline": [{"oid": "d198f4e8a4828eff80946f33bb81b98348783d00", "url": "https://github.com/artipie/artipie/commit/d198f4e8a4828eff80946f33bb81b98348783d00", "message": "#231 - Added MetricsLogPublisher", "committedDate": "2020-07-07T10:17:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc2ODgyMA==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450768820", "bodyText": "@olegmoz why not use Metrics interface instead of concrete class?", "author": "Vatavuk", "createdAt": "2020-07-07T10:35:29Z", "path": "src/main/java/com/artipie/metrics/memory/MetricsLogPublisher.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.jcabi.log.Logger;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Periodic publisher of {@link InMemoryMetrics} to log.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauge publishing in `MetricsLogPublisher`.\n+ *  `InMemoryMetrics` contain gauges along counters.\n+ *  Gauges should be published the same way as counters.\n+ *  Should be done after https://github.com/artipie/artipie/issues/267\n+ */\n+public class MetricsLogPublisher {\n+\n+    /**\n+     * Metrics for publishing.\n+     */\n+    private final InMemoryMetrics metrics;", "originalCommit": "d198f4e8a4828eff80946f33bb81b98348783d00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4MzU3Mw==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450783573", "bodyText": "@Vatavuk that is because Metrics interface is for reporting metrics. Only InMemoryMetrics implementations actualy holds the data, so only it is compatible with publishing to logs.", "author": "olegmoz", "createdAt": "2020-07-07T11:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc2ODgyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc5MTEzNQ==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450791135", "bodyText": "@olegmoz ah ok, it messes with my head that interface doesn't have printers:).", "author": "Vatavuk", "createdAt": "2020-07-07T11:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc2ODgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MDExMg==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450770112", "bodyText": "@olegmoz I think we should consider injecting logger to be able to test this class", "author": "Vatavuk", "createdAt": "2020-07-07T10:38:03Z", "path": "src/main/java/com/artipie/metrics/memory/MetricsLogPublisher.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.jcabi.log.Logger;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Periodic publisher of {@link InMemoryMetrics} to log.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauge publishing in `MetricsLogPublisher`.\n+ *  `InMemoryMetrics` contain gauges along counters.\n+ *  Gauges should be published the same way as counters.\n+ *  Should be done after https://github.com/artipie/artipie/issues/267\n+ */\n+public class MetricsLogPublisher {\n+\n+    /**\n+     * Metrics for publishing.\n+     */\n+    private final InMemoryMetrics metrics;\n+\n+    /**\n+     * Period.\n+     */\n+    private final Duration period;\n+\n+    /**\n+     * Ctor.\n+     *\n+     * @param metrics Metrics for publishing.\n+     * @param period Period.\n+     */\n+    public MetricsLogPublisher(final InMemoryMetrics metrics, final Duration period) {\n+        this.metrics = metrics;\n+        this.period = period;\n+    }\n+\n+    /**\n+     * Start periodic publishing.\n+     */\n+    public void start() {\n+        final long millis = this.period.toMillis();\n+        Executors.newSingleThreadScheduledExecutor().scheduleAtFixedRate(\n+            this::publish,\n+            millis,\n+            millis,\n+            TimeUnit.MILLISECONDS\n+        );\n+    }\n+\n+    /**\n+     * Publish metrics to log.\n+     */\n+    private void publish() {\n+        final Map<String, InMemoryCounter> counters = new TreeMap<>(this.metrics.counters());\n+        final StringBuilder message = new StringBuilder(\"Counters:\");\n+        for (final Map.Entry<String, InMemoryCounter> entry : counters.entrySet()) {\n+            message.append('\\n')\n+                .append(entry.getKey())\n+                .append(\": \")\n+                .append(entry.getValue().value());\n+        }\n+        Logger.info(this.metrics, message.toString());", "originalCommit": "d198f4e8a4828eff80946f33bb81b98348783d00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4NDIzMw==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450784233", "bodyText": "@Vatavuk done", "author": "olegmoz", "createdAt": "2020-07-07T11:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MDExMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc5MTcxOA==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450791718", "bodyText": "@olegmoz I don't see this change", "author": "Vatavuk", "createdAt": "2020-07-07T11:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MDExMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk4OTgxMg==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450989812", "bodyText": "@Vatavuk please see again, I force pushed the branch again. I see the changes in web interface", "author": "olegmoz", "createdAt": "2020-07-07T16:24:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MDExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MTgyNw==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450771827", "bodyText": "@olegmoz I think we shouldn't rely on toString method which will be called in Logger.info(this.metrics...). We should add some convenient log description in the first argument of Logger.info", "author": "Vatavuk", "createdAt": "2020-07-07T10:41:30Z", "path": "src/main/java/com/artipie/metrics/memory/MetricsLogPublisher.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.jcabi.log.Logger;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Periodic publisher of {@link InMemoryMetrics} to log.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauge publishing in `MetricsLogPublisher`.\n+ *  `InMemoryMetrics` contain gauges along counters.\n+ *  Gauges should be published the same way as counters.\n+ *  Should be done after https://github.com/artipie/artipie/issues/267\n+ */\n+public class MetricsLogPublisher {\n+\n+    /**\n+     * Metrics for publishing.\n+     */\n+    private final InMemoryMetrics metrics;\n+\n+    /**\n+     * Period.\n+     */\n+    private final Duration period;\n+\n+    /**\n+     * Ctor.\n+     *\n+     * @param metrics Metrics for publishing.\n+     * @param period Period.\n+     */\n+    public MetricsLogPublisher(final InMemoryMetrics metrics, final Duration period) {\n+        this.metrics = metrics;\n+        this.period = period;\n+    }\n+\n+    /**\n+     * Start periodic publishing.\n+     */\n+    public void start() {\n+        final long millis = this.period.toMillis();\n+        Executors.newSingleThreadScheduledExecutor().scheduleAtFixedRate(\n+            this::publish,\n+            millis,\n+            millis,\n+            TimeUnit.MILLISECONDS\n+        );\n+    }\n+\n+    /**\n+     * Publish metrics to log.\n+     */\n+    private void publish() {\n+        final Map<String, InMemoryCounter> counters = new TreeMap<>(this.metrics.counters());\n+        final StringBuilder message = new StringBuilder(\"Counters:\");\n+        for (final Map.Entry<String, InMemoryCounter> entry : counters.entrySet()) {\n+            message.append('\\n')\n+                .append(entry.getKey())\n+                .append(\": \")\n+                .append(entry.getValue().value());\n+        }\n+        Logger.info(this.metrics, message.toString());", "originalCommit": "d198f4e8a4828eff80946f33bb81b98348783d00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4NDE3Nw==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450784177", "bodyText": "@Vatavuk we are building the message just before publishing, so we are in full control of message content. And it starts with Counters: string to clarify what's published. So I think it's all good.", "author": "olegmoz", "createdAt": "2020-07-07T11:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MTgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgwMDY5NA==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450800694", "bodyText": "@olegmoz There is no overriden toString method on InMemoryMetrics. I propose to use just Logger.info(message.toString()).", "author": "Vatavuk", "createdAt": "2020-07-07T11:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MTgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDkzNzEwMQ==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450937101", "bodyText": "@olegmoz forget about it, this is jcabi logger I though it was slf4j", "author": "Vatavuk", "createdAt": "2020-07-07T15:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MTgyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MTk3Nw==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450771977", "bodyText": "@olegmoz add puzzle for testing this class", "author": "Vatavuk", "createdAt": "2020-07-07T10:41:47Z", "path": "src/main/java/com/artipie/metrics/memory/MetricsLogPublisher.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.jcabi.log.Logger;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Periodic publisher of {@link InMemoryMetrics} to log.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauge publishing in `MetricsLogPublisher`.", "originalCommit": "d198f4e8a4828eff80946f33bb81b98348783d00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4NDMxNg==", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450784316", "bodyText": "@Vatavuk added", "author": "olegmoz", "createdAt": "2020-07-07T11:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MTk3Nw=="}], "type": "inlineReview"}, {"oid": "f4061a60f4977a1a5dd28cae5fd8218ee93976cb", "url": "https://github.com/artipie/artipie/commit/f4061a60f4977a1a5dd28cae5fd8218ee93976cb", "message": "#231 - Changes by review", "committedDate": "2020-07-07T11:06:48Z", "type": "commit"}, {"oid": "a499051dc987674cc752eb5e503df852e9ecc9d3", "url": "https://github.com/artipie/artipie/commit/a499051dc987674cc752eb5e503df852e9ecc9d3", "message": "Merge branch 'master' into 231-metrics-log", "committedDate": "2020-07-07T11:07:13Z", "type": "commit"}, {"oid": "a499051dc987674cc752eb5e503df852e9ecc9d3", "url": "https://github.com/artipie/artipie/commit/a499051dc987674cc752eb5e503df852e9ecc9d3", "message": "Merge branch 'master' into 231-metrics-log", "committedDate": "2020-07-07T11:07:13Z", "type": "forcePushed"}, {"oid": "1ed9bcbfd340aa77365e90d8880c6d3cf95834a4", "url": "https://github.com/artipie/artipie/commit/1ed9bcbfd340aa77365e90d8880c6d3cf95834a4", "message": "Merge branch 'master' into 231-metrics-log", "committedDate": "2020-07-08T07:37:56Z", "type": "commit"}, {"oid": "f01a2e6b3ad4f8456ca9739c833eea0c0ab47e62", "url": "https://github.com/artipie/artipie/commit/f01a2e6b3ad4f8456ca9739c833eea0c0ab47e62", "message": "Merge branch 'master' into 231-metrics-log", "committedDate": "2020-07-08T11:07:03Z", "type": "commit"}, {"oid": "e9e02d65c03cb30aeb3e495ba6871c9e9624813b", "url": "https://github.com/artipie/artipie/commit/e9e02d65c03cb30aeb3e495ba6871c9e9624813b", "message": "Merge branch 'master' into 231-metrics-log", "committedDate": "2020-07-08T11:36:36Z", "type": "commit"}, {"oid": "f874c17028a89b2338c90f14640f9028d042e6a6", "url": "https://github.com/artipie/artipie/commit/f874c17028a89b2338c90f14640f9028d042e6a6", "message": "Merge branch 'master' into 231-metrics-log", "committedDate": "2020-07-08T14:53:02Z", "type": "commit"}]}