{"pr_number": 539, "pr_title": "#507 - refactored ApiChangeUserPassword.java", "pr_createdAt": "2020-09-01T09:41:46Z", "pr_url": "https://github.com/artipie/artipie/pull/539", "timeline": [{"oid": "e9ce2cbbd796e799555d1e6b95f9ddf0f9d6c335", "url": "https://github.com/artipie/artipie/commit/e9ce2cbbd796e799555d1e6b95f9ddf0f9d6c335", "message": "#507 - refactored ApiChangeUserPassword", "committedDate": "2020-09-01T09:40:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0OTMwNA==", "url": "https://github.com/artipie/artipie/pull/539#discussion_r481049304", "bodyText": "@olenagerasimova it seems that pass is stored in plain no matter what PasswordFormat is. It looks like a bug", "author": "olegmoz", "createdAt": "2020-09-01T10:51:17Z", "path": "src/main/java/com/artipie/api/ApiChangeUserPassword.java", "diffHunk": "@@ -87,50 +79,25 @@ public Response response(final String line,\n             throw new IllegalStateException(\"Should match\");\n         }\n         final String user = matcher.group(\"user\");\n-        // @checkstyle LineLengthCheck (100 lines)\n         return new AsyncResponse(\n-            Single.fromCallable(() -> this.settings.meta().yamlMapping(\"credentials\"))\n-                .map(cred -> new KeyFromPath(cred.string(\"path\")))\n-                .flatMapCompletable(\n-                    key ->\n-                        Single.zip(\n-                            new RxStorageWrapper(this.settings.storage())\n-                                .value(key).to(ContentAs.YAML),\n-                            Single.just(body).to(ContentAs.STRING).map(\n-                                encoded -> URLEncodedUtils.parse(encoded, StandardCharsets.UTF_8)\n-                                    .stream()\n-                                    .filter(pair -> pair.getName().equals(\"password\"))\n-                                    .map(NameValuePair::getValue)\n-                                    .findFirst().orElseThrow()\n-                            ),\n-                            (YamlMapping yaml, String pass) -> {\n-                                YamlMappingBuilder result = Yaml.createYamlMappingBuilder();\n-                                final YamlMapping credentials = yaml.yamlMapping(\"credentials\");\n-                                final List<YamlNode> keep = credentials.keys().stream()\n-                                    .filter(node -> !node.asScalar().value().equals(user)).collect(Collectors.toList());\n-                                for (final YamlNode node : keep) {\n-                                    result = result.add(node, credentials.value(node));\n-                                }\n-                                result = result.add(\n-                                    user,\n-                                    Yaml.createYamlMappingBuilder()\n-                                        .add(\"pass\", String.format(\"sha256:%s\", DigestUtils.sha256Hex(pass)))\n-                                        .build()\n-                                );\n-                                return Yaml.createYamlMappingBuilder()\n-                                    .add(\"credentials\", result.build()).build()\n-                                    .toString();\n-                            }\n-                        ).flatMapCompletable(\n-                            yaml -> new RxStorageWrapper(this.settings.storage())\n-                                .save(key, new Content.From(yaml.getBytes(StandardCharsets.UTF_8))))\n+            Single.just(body).to(ContentAs.STRING).map(\n+                encoded -> URLEncodedUtils.parse(encoded, StandardCharsets.UTF_8)\n+                    .stream()\n+                    .filter(pair -> pair.getName().equals(\"password\"))\n+                    .map(NameValuePair::getValue)\n+                    .findFirst().orElseThrow()\n+            ).flatMapCompletable(\n+                pass -> Completable.fromFuture(\n+                    this.settings.credentials().thenCompose(\n+                        cred -> cred.add(user, pass, Credentials.PasswordFormat.SHA256)", "originalCommit": "e9ce2cbbd796e799555d1e6b95f9ddf0f9d6c335", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA2Mzg3NA==", "url": "https://github.com/artipie/artipie/pull/539#discussion_r481063874", "bodyText": "@olegmoz yes, you are right", "author": "olenagerasimova", "createdAt": "2020-09-01T11:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0OTMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0OTY5MQ==", "url": "https://github.com/artipie/artipie/pull/539#discussion_r481049691", "bodyText": "@olenagerasimova there is standard Location header class you may use here", "author": "olegmoz", "createdAt": "2020-09-01T10:52:02Z", "path": "src/main/java/com/artipie/api/ApiChangeUserPassword.java", "diffHunk": "@@ -87,50 +79,25 @@ public Response response(final String line,\n             throw new IllegalStateException(\"Should match\");\n         }\n         final String user = matcher.group(\"user\");\n-        // @checkstyle LineLengthCheck (100 lines)\n         return new AsyncResponse(\n-            Single.fromCallable(() -> this.settings.meta().yamlMapping(\"credentials\"))\n-                .map(cred -> new KeyFromPath(cred.string(\"path\")))\n-                .flatMapCompletable(\n-                    key ->\n-                        Single.zip(\n-                            new RxStorageWrapper(this.settings.storage())\n-                                .value(key).to(ContentAs.YAML),\n-                            Single.just(body).to(ContentAs.STRING).map(\n-                                encoded -> URLEncodedUtils.parse(encoded, StandardCharsets.UTF_8)\n-                                    .stream()\n-                                    .filter(pair -> pair.getName().equals(\"password\"))\n-                                    .map(NameValuePair::getValue)\n-                                    .findFirst().orElseThrow()\n-                            ),\n-                            (YamlMapping yaml, String pass) -> {\n-                                YamlMappingBuilder result = Yaml.createYamlMappingBuilder();\n-                                final YamlMapping credentials = yaml.yamlMapping(\"credentials\");\n-                                final List<YamlNode> keep = credentials.keys().stream()\n-                                    .filter(node -> !node.asScalar().value().equals(user)).collect(Collectors.toList());\n-                                for (final YamlNode node : keep) {\n-                                    result = result.add(node, credentials.value(node));\n-                                }\n-                                result = result.add(\n-                                    user,\n-                                    Yaml.createYamlMappingBuilder()\n-                                        .add(\"pass\", String.format(\"sha256:%s\", DigestUtils.sha256Hex(pass)))\n-                                        .build()\n-                                );\n-                                return Yaml.createYamlMappingBuilder()\n-                                    .add(\"credentials\", result.build()).build()\n-                                    .toString();\n-                            }\n-                        ).flatMapCompletable(\n-                            yaml -> new RxStorageWrapper(this.settings.storage())\n-                                .save(key, new Content.From(yaml.getBytes(StandardCharsets.UTF_8))))\n+            Single.just(body).to(ContentAs.STRING).map(\n+                encoded -> URLEncodedUtils.parse(encoded, StandardCharsets.UTF_8)\n+                    .stream()\n+                    .filter(pair -> pair.getName().equals(\"password\"))\n+                    .map(NameValuePair::getValue)\n+                    .findFirst().orElseThrow()\n+            ).flatMapCompletable(\n+                pass -> Completable.fromFuture(\n+                    this.settings.credentials().thenCompose(\n+                        cred -> cred.add(user, pass, Credentials.PasswordFormat.SHA256)\n+                    ).toCompletableFuture()\n                 )\n-                .toSingleDefault(\n-                    new RsWithHeaders(\n-                        new RsWithStatus(RsStatus.FOUND),\n-                        new Header(\"Location\", String.format(\"/dashboard/%s\", user))\n-                    )\n-                ).to(SingleInterop.get())\n+            ).toSingleDefault(\n+                new RsWithHeaders(\n+                    new RsWithStatus(RsStatus.FOUND),\n+                    new Header(\"Location\", String.format(\"/dashboard/%s\", user))", "originalCommit": "e9ce2cbbd796e799555d1e6b95f9ddf0f9d6c335", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA1MjEzMg==", "url": "https://github.com/artipie/artipie/pull/539#discussion_r481052132", "bodyText": "@olenagerasimova I see that passwords were stored were stored in plain format before these changes, but maybe we should stick to sha256 format by default?", "author": "olegmoz", "createdAt": "2020-09-01T10:56:56Z", "path": "src/main/java/com/artipie/api/artifactory/AddUpdateUserSlice.java", "diffHunk": "@@ -74,8 +75,9 @@ public Response response(final String line, final Iterable<Map.Entry<String, Str\n                         passw -> passw.map(\n                             haspassw -> this.settings.credentials()\n                                 .thenCompose(\n-                                    cred -> cred.add(username, haspassw)\n-                                        .thenApply(ok -> new RsWithStatus(RsStatus.OK)))\n+                                    cred -> cred.add(\n+                                        username, haspassw, Credentials.PasswordFormat.PLAIN", "originalCommit": "e9ce2cbbd796e799555d1e6b95f9ddf0f9d6c335", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e9cb385c5224963acd4c5b02c7f2879fcb54d3b5", "url": "https://github.com/artipie/artipie/commit/e9cb385c5224963acd4c5b02c7f2879fcb54d3b5", "message": "#507 - ApiChangeUserPassword CR", "committedDate": "2020-09-01T11:33:16Z", "type": "commit"}, {"oid": "5d02e948724f7e1b721b10cdee71bec2f8232ca0", "url": "https://github.com/artipie/artipie/commit/5d02e948724f7e1b721b10cdee71bec2f8232ca0", "message": "#507 - ApiChangeUserPasswordTest fixed", "committedDate": "2020-09-01T11:42:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA3NjQyNA==", "url": "https://github.com/artipie/artipie/pull/539#discussion_r481076424", "bodyText": "@olenagerasimova I am sorry, but why did you change format to PLAIN here?", "author": "olegmoz", "createdAt": "2020-09-01T11:45:55Z", "path": "src/main/java/com/artipie/api/ApiChangeUserPassword.java", "diffHunk": "@@ -89,13 +89,13 @@ public Response response(final String line,\n             ).flatMapCompletable(\n                 pass -> Completable.fromFuture(\n                     this.settings.credentials().thenCompose(\n-                        cred -> cred.add(user, pass, Credentials.PasswordFormat.SHA256)\n+                        cred -> cred.add(user, pass, Credentials.PasswordFormat.PLAIN)", "originalCommit": "e9cb385c5224963acd4c5b02c7f2879fcb54d3b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f1bd155a1071797f2638968ac8c94d2bb3353b4c", "url": "https://github.com/artipie/artipie/commit/f1bd155a1071797f2638968ac8c94d2bb3353b4c", "message": "#507 - ApiChangeUserPassword use sha256", "committedDate": "2020-09-01T11:55:07Z", "type": "commit"}, {"oid": "967d0b8f041f8104fcd0f3ce058ecbd3e396d900", "url": "https://github.com/artipie/artipie/commit/967d0b8f041f8104fcd0f3ce058ecbd3e396d900", "message": "Merge branch 'master' into 507-ApiChangeUserPassword", "committedDate": "2020-09-01T12:19:27Z", "type": "commit"}]}