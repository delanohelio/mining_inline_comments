{"pr_number": 984, "pr_title": "Resolves #983: FDBDatabaseRunner should use FDBRecordContextConfig more", "pr_createdAt": "2020-06-30T21:04:26Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/984", "timeline": [{"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/a92d7d1d566a09a2473c61fad7fd378251af89b1", "message": "Resolves #983: FDBDatabaseRunner should use FDBRecordContextConfig more", "committedDate": "2020-07-01T15:24:05Z", "type": "commit"}, {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/a92d7d1d566a09a2473c61fad7fd378251af89b1", "message": "Resolves #983: FDBDatabaseRunner should use FDBRecordContextConfig more", "committedDate": "2020-07-01T15:24:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MjA1Mw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448662053", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                FDBRecordContextConfig.Builder getContextConfigBuilder();\n          \n          \n            \n                @Nonnull\n          \n          \n            \n                FDBRecordContextConfig.Builder getContextConfigBuilder();", "author": "alecgrieser", "createdAt": "2020-07-01T23:11:47Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseRunner.java", "diffHunk": "@@ -69,6 +69,18 @@\n     @Nonnull\n     FDBDatabase getDatabase();\n \n+    /**\n+     * Get the configuration used in record contexts opened by this runner.\n+     * @return configuration to use\n+     */\n+    FDBRecordContextConfig.Builder getContextConfigBuilder();", "originalCommit": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MjY1OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448662659", "bodyText": "I suppose this should have a Javadoc comment along the lines of the other getters in this builder", "author": "alecgrieser", "createdAt": "2020-07-01T23:13:50Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordContextConfig.java", "diffHunk": "@@ -344,7 +354,7 @@ public Builder setTransactionTimeoutMillis(long transactionTimeoutMillis) {\n             return this;\n         }\n \n-        private long getTransactionTimeoutMillis() {\n+        public long getTransactionTimeoutMillis() {", "originalCommit": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3ODYyMw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448678623", "bodyText": "Added", "author": "MMcM", "createdAt": "2020-07-02T00:10:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MjY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDI4OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448664289", "bodyText": "It is a little weird that this sets the default option here... I suppose another approach would be to make the argument to FDBDatabaseRunnerImpl @Nullable and then fill it in with a default builder (like this) if null is provided, and then filling in the defaults is the job of in FDBDatabaseRunnerImpl (or there's a \"default config builder\" method in FDBDatabase and then that does the job of filling in the default values).\nI think all of those things could be changed later, though, without affecting the API.", "author": "alecgrieser", "createdAt": "2020-07-01T23:19:30Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -766,14 +766,23 @@ private Transaction createTransaction(@Nonnull FDBRecordContextConfig config,\n         return transaction;\n     }\n \n+    /**\n+     * Create an {@link FDBDatabaseRunner} for use against this database.\n+     * @param contextConfigBuilder options for contexts opened by the new runner\n+     * @return a new runner\n+     */\n+    @Nonnull\n+    public FDBDatabaseRunner newRunner(@Nonnull FDBRecordContextConfig.Builder contextConfigBuilder) {\n+        return new FDBDatabaseRunnerImpl(this, contextConfigBuilder);\n+    }\n \n     /**\n      * Create an {@link FDBDatabaseRunner} for use against this database.\n      * @return a new runner\n      */\n     @Nonnull\n     public FDBDatabaseRunner newRunner() {\n-        return new FDBDatabaseRunnerImpl(this);\n+        return newRunner(FDBRecordContextConfig.newBuilder().setTransactionTimeoutMillis(factory.getTransactionTimeoutMillis()));", "originalCommit": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3ODk2OA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448678968", "bodyText": "This turns out not to be necessary. The old code has some redundancy that was copied into the new. The default is to get from the factory where the default is to leave it alone from the FDB client's setting. There is no need to read from the factory here.", "author": "MMcM", "createdAt": "2020-07-02T00:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDU1OA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448664558", "bodyText": "It might be worth clarifying that the builder passed in will be the same object used in the runner, so future changes to the state of the argument will also affect the values as seen in the runner (as it's running).", "author": "alecgrieser", "createdAt": "2020-07-01T23:20:25Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -766,14 +766,23 @@ private Transaction createTransaction(@Nonnull FDBRecordContextConfig config,\n         return transaction;\n     }\n \n+    /**\n+     * Create an {@link FDBDatabaseRunner} for use against this database.\n+     * @param contextConfigBuilder options for contexts opened by the new runner", "originalCommit": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3ODk5Mw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448678993", "bodyText": "Added", "author": "MMcM", "createdAt": "2020-07-02T00:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDg3OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448664879", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    FDBDatabaseRunner runner = newRunner();\n          \n          \n            \n                    runner.getContextConfigBuilder().setTimer(timer).setMdcContext(mdcContext);\n          \n          \n            \n                    return runner;\n          \n          \n            \n                    return newRunner(timer, mdcContext, null);\n          \n      \n    \n    \n  \n\nI think. I can make arguments that the other two newRunners should remain as is, but this one seems like it should populate the default value of the other one.", "author": "alecgrieser", "createdAt": "2020-07-01T23:21:30Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -784,7 +793,9 @@ public FDBDatabaseRunner newRunner() {\n      */\n     @Nonnull\n     public FDBDatabaseRunner newRunner(@Nullable FDBStoreTimer timer, @Nullable Map<String, String> mdcContext) {\n-        return new FDBDatabaseRunnerImpl(this, timer, mdcContext);\n+        FDBDatabaseRunner runner = newRunner();\n+        runner.getContextConfigBuilder().setTimer(timer).setMdcContext(mdcContext);\n+        return runner;", "originalCommit": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3OTExNQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448679115", "bodyText": "How so? The default for weakSemantics is null, right?", "author": "MMcM", "createdAt": "2020-07-02T00:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4NTExNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448685114", "bodyText": "Right, sorry. I meant just that this method should call newRunner(FDBStoreTimer, Map, WeakReadSemantics) with a null WeakReadSemantics rather than tweaking the context config builder just so that it fits into the Java pattern for \"methods with default parameters\". But I don't feel strongly about this and could see this staying as is", "author": "alecgrieser", "createdAt": "2020-07-02T00:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4NjM2Mw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448686363", "bodyText": "Oh, I see. I would just as soon deprecate those two methods. But either way, I don't think the one with all the arguments is, in fact, the most general one, like in that pattern. The one with one argument is, so maybe they should be expressed in terms of that?", "author": "MMcM", "createdAt": "2020-07-02T00:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NTU4Ng==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448665586", "bodyText": "It's probably worth clarifying that as the object returned is the same object as (not a copy of) the one used by the runner, if one changes one of the values of the builder, then this will affect the values used when the runner creates new contexts.", "author": "alecgrieser", "createdAt": "2020-07-01T23:23:59Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseRunner.java", "diffHunk": "@@ -69,6 +69,18 @@\n     @Nonnull\n     FDBDatabase getDatabase();\n \n+    /**\n+     * Get the configuration used in record contexts opened by this runner.", "originalCommit": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3OTE0NA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448679144", "bodyText": "Added.", "author": "MMcM", "createdAt": "2020-07-02T00:12:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NTU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NjE1Ng==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448666156", "bodyText": "Looks like get/set transaction timeout millis can be similarly removed", "author": "alecgrieser", "createdAt": "2020-07-01T23:26:02Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/synchronizedsession/SynchronizedSessionRunner.java", "diffHunk": "@@ -206,52 +205,18 @@ public FDBDatabase getDatabase() {\n     }\n \n     @Override\n-    public Executor getExecutor() {\n-        return underlying.getExecutor();\n-    }\n-\n-    @Override\n-    @Nullable\n-    public FDBStoreTimer getTimer() {\n-        return underlying.getTimer();\n-    }\n-\n-    @Override\n-    public void setTimer(@Nullable FDBStoreTimer timer) {\n-        underlying.setTimer(timer);\n-    }\n-\n-    @Override\n-    @Nullable\n-    public Map<String, String> getMdcContext() {\n-        return underlying.getMdcContext();\n+    public FDBRecordContextConfig.Builder getContextConfigBuilder() {\n+        return underlying.getContextConfigBuilder();\n     }\n \n     @Override\n-    public void setMdcContext(@Nullable Map<String, String> mdcContext) {\n-        underlying.setMdcContext(mdcContext);\n+    public void setContextConfigBuilder(final FDBRecordContextConfig.Builder contextConfigBuilder) {\n+        underlying.setContextConfigBuilder(contextConfigBuilder);\n     }\n \n     @Override\n-    @Nullable\n-    public FDBDatabase.WeakReadSemantics getWeakReadSemantics() {\n-        return underlying.getWeakReadSemantics();\n-    }\n-\n-    @Override\n-    public void setWeakReadSemantics(@Nullable FDBDatabase.WeakReadSemantics weakReadSemantics) {\n-        underlying.setWeakReadSemantics(weakReadSemantics);\n-    }\n-\n-    @Nonnull\n-    @Override\n-    public FDBTransactionPriority getPriority() {\n-        return underlying.getPriority();", "originalCommit": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3OTE2Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448679162", "bodyText": "Removed", "author": "MMcM", "createdAt": "2020-07-02T00:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NjE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzQ2MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448667460", "bodyText": "It's a little weird that one might forget to set the default transaction timeout millis here if one isn't careful...I suppose a \"default context config builder\" method on a database (or, I suppose, a static \"default builder\" method on a FDBRecordContextConfig that took an FDBDatabase) as suggested in a different comment might help with that.", "author": "alecgrieser", "createdAt": "2020-07-01T23:30:26Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -766,14 +766,23 @@ private Transaction createTransaction(@Nonnull FDBRecordContextConfig config,\n         return transaction;\n     }\n \n+    /**\n+     * Create an {@link FDBDatabaseRunner} for use against this database.\n+     * @param contextConfigBuilder options for contexts opened by the new runner\n+     * @return a new runner\n+     */\n+    @Nonnull\n+    public FDBDatabaseRunner newRunner(@Nonnull FDBRecordContextConfig.Builder contextConfigBuilder) {\n+        return new FDBDatabaseRunnerImpl(this, contextConfigBuilder);", "originalCommit": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3OTIxNQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448679215", "bodyText": "This is no longer the case.", "author": "MMcM", "createdAt": "2020-07-02T00:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzQ2MA=="}], "type": "inlineReview"}, {"oid": "fdfd33cca3032363b049f3f8fa9935fe34933246", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/fdfd33cca3032363b049f3f8fa9935fe34933246", "message": "Update fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseRunner.java\n\nCo-authored-by: Alec Grieser <alloc@apple.com>", "committedDate": "2020-07-01T23:45:19Z", "type": "commit"}, {"oid": "7f83a95bdbdd8872905e4f246534d2c30a45d789", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/7f83a95bdbdd8872905e4f246534d2c30a45d789", "message": "Simplify timeout defaults", "committedDate": "2020-07-02T00:08:53Z", "type": "commit"}, {"oid": "e032e722c50ae47f516a1399fdd49f089c9615da", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e032e722c50ae47f516a1399fdd49f089c9615da", "message": "Merge branch 'more-context-config' of github.com:MMcM/fdb-record-layer into more-context-config", "committedDate": "2020-07-02T00:09:04Z", "type": "commit"}, {"oid": "a61b8435a30d2b8115d86daf89920eb05a640e86", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/a61b8435a30d2b8115d86daf89920eb05a640e86", "message": "try another way", "committedDate": "2020-07-02T00:41:40Z", "type": "commit"}]}