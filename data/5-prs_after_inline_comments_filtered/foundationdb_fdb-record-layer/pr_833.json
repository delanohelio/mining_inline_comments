{"pr_number": 833, "pr_title": "Resolves #828: RankedSet poorly split for non-random keys ", "pr_createdAt": "2020-02-21T19:52:37Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/833", "timeline": [{"oid": "74722663e678ad3c5da7f2727afb3bf466401deb", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/74722663e678ad3c5da7f2727afb3bf466401deb", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution.", "committedDate": "2020-02-21T19:57:56Z", "type": "forcePushed"}, {"oid": "bf835044155835927488cff2fde4ecb7277ca2ff", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/bf835044155835927488cff2fde4ecb7277ca2ff", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution.", "committedDate": "2020-02-21T19:59:30Z", "type": "forcePushed"}, {"oid": "e2f678b95534aa08a88fb8add37a39f592f71a27", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e2f678b95534aa08a88fb8add37a39f592f71a27", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution.", "committedDate": "2020-02-21T20:15:12Z", "type": "forcePushed"}, {"oid": "33d8ddb960b33736a51df2c8647f39e58e76f1aa", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/33d8ddb960b33736a51df2c8647f39e58e76f1aa", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution.", "committedDate": "2020-02-21T21:02:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MTQwNw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382841407", "bodyText": "While the other lines in this comment are aren't needed any more, I think this first line is still valuable.", "author": "alecgrieser", "createdAt": "2020-02-21T22:44:05Z", "path": "fdb-extensions/src/main/java/com/apple/foundationdb/async/RankedSet.java", "diffHunk": "@@ -143,10 +190,7 @@ public RankedSet(Subspace subspace, Executor executor) {\n      */\n     public CompletableFuture<Boolean> add(TransactionContext tc, byte[] key) {\n         checkKey(key);\n-        // Use the hash of the key, instead a p value and randomLevel. The key is likely Tuple-encoded.", "originalCommit": "33d8ddb960b33736a51df2c8647f39e58e76f1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4NzI2NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382887265", "bodyText": "Hmm, okay. Restored.", "author": "MMcM", "createdAt": "2020-02-22T05:10:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MTQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MjE2MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382842160", "bodyText": "Interesting. I suppose we could loosen this to allow for the rank hash function to change (given that it should be compatible). I'm not opposed to being stricter for now, though perhaps that should be an option at some point.", "author": "alecgrieser", "createdAt": "2020-02-21T22:46:33Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/indexes/RankIndexMaintainerFactory.java", "diffHunk": "@@ -64,15 +65,25 @@ public void validate(@Nonnull MetaDataValidator metaDataValidator) {\n \n             @Override\n             public void validateChangedOptions(@Nonnull Index oldIndex, @Nonnull Set<String> changedOptions) {\n+                // Allow changing from unspecified to the default (or vice versa), but not otherwise.\n                 if (changedOptions.contains(IndexOptions.RANK_NLEVELS)) {\n-                    int oldLevels = RankIndexMaintainer.getNLevels(oldIndex);\n-                    int newLevels = RankIndexMaintainer.getNLevels(index);\n+                    int oldLevels = RankedSetIndexHelper.getNLevels(oldIndex);\n+                    int newLevels = RankedSetIndexHelper.getNLevels(index);\n                     if (oldLevels != newLevels) {\n                         throw new MetaDataException(\"rank levels changed\",\n                                 LogMessageKeys.INDEX_NAME, index.getName());\n                     }\n                     changedOptions.remove(IndexOptions.RANK_NLEVELS);\n                 }\n+                if (changedOptions.contains(IndexOptions.RANK_HASH_FUNCTION)) {\n+                    RankedSet.HashFunction oldFunction = RankedSetIndexHelper.getHashFunction(oldIndex);\n+                    RankedSet.HashFunction newFunction = RankedSetIndexHelper.getHashFunction(index);\n+                    if (!oldFunction.equals(newFunction)) {\n+                        throw new MetaDataException(\"rank hash function changed\",\n+                                LogMessageKeys.INDEX_NAME, index.getName());", "originalCommit": "33d8ddb960b33736a51df2c8647f39e58e76f1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1NTA1Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382855052", "bodyText": "Yes. I thought being conservative during the transition was best.", "author": "MMcM", "createdAt": "2020-02-21T23:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MjE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzA2MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382843060", "bodyText": "I suppose using a registry rather than an enum is more idiomatic (e.g., FunctionKeyExpressions) and allows a user to provide their own implementation. I think that switching to a registry in the future is compatible with this current approach, though, so maybe it's fine as is for now. (Perhaps there should be an Issue about it.)", "author": "alecgrieser", "createdAt": "2020-02-21T22:49:53Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/indexes/RankedSetIndexHelper.java", "diffHunk": "@@ -50,6 +54,54 @@\n public class RankedSetIndexHelper {\n     public static final Tuple COMPARISON_SKIPPED_SCORE = Tuple.from(Comparisons.COMPARISON_SKIPPED_BINDING);\n \n+    public static final RankedSet.HashFunction MURMUR3_HASH_FUNCTION = new GuavaHashFunction(Hashing.murmur3_32());\n+\n+    /**\n+     * Use {@code com.google.common.hash.HashFunction}s as {@code RankedSet.HashFunction}s.\n+     */\n+    public static class GuavaHashFunction implements RankedSet.HashFunction {\n+        @Nonnull\n+        private final HashFunction guava;\n+\n+        public GuavaHashFunction(HashFunction guava) {\n+            this.guava = guava;\n+        }\n+\n+        @Override\n+        public int hash(byte[] key) {\n+            return guava.hashBytes(key).asInt();\n+        }\n+    }\n+\n+    /**\n+     * Known hash functions available as index options.\n+     */\n+    public enum HashFunctionNames {\n+        JDK(RankedSet.JDK_ARRAY_HASH),\n+        CRC(RankedSet.CRC_HASH),\n+        MURMUR3(MURMUR3_HASH_FUNCTION);\n+\n+        private final RankedSet.HashFunction hashFunction;\n+\n+        HashFunctionNames(RankedSet.HashFunction hashFunction) {\n+            this.hashFunction = hashFunction;\n+        }\n+\n+        public RankedSet.HashFunction getHashFunction() {\n+            return hashFunction;\n+        }\n+    }\n+\n+    public static int getNLevels(@Nonnull Index index) {\n+        String nlevelsOption = index.getOption(IndexOptions.RANK_NLEVELS);\n+        return nlevelsOption == null ? RankedSet.DEFAULT_LEVELS : Integer.parseInt(nlevelsOption);\n+    }\n+\n+    public static RankedSet.HashFunction getHashFunction(@Nonnull Index index) {\n+        String hashFunctionOption = index.getOption(IndexOptions.RANK_HASH_FUNCTION);\n+        return hashFunctionOption == null ? RankedSet.DEFAULT_HASH_FUNCTION : HashFunctionNames.valueOf(hashFunctionOption).getHashFunction();", "originalCommit": "33d8ddb960b33736a51df2c8647f39e58e76f1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1NTMzMA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382855330", "bodyText": "Yes. It's also possible that some additional options will require more state.\nFor example, if we wanted one that seeded Murmur3 from, say, the leaderboard time window id instead of always using 0.", "author": "MMcM", "createdAt": "2020-02-21T23:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2NzAzNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382867034", "bodyText": "I didn\u2019t make it extensible, but as a top level regular class it is now maybe a bit more registry like", "author": "MMcM", "createdAt": "2020-02-22T00:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MDk4MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382870980", "bodyText": "Yeah, and even though it's not extensible now, it looks like the kind of thing that could be made a registry if/when needed.", "author": "alecgrieser", "createdAt": "2020-02-22T01:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzA2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzQwOQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382843409", "bodyText": "This kind of feels like a private class, at least until the user can provide their own hash function implementation (instead of using the enum).", "author": "alecgrieser", "createdAt": "2020-02-21T22:51:00Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/indexes/RankedSetIndexHelper.java", "diffHunk": "@@ -50,6 +54,54 @@\n public class RankedSetIndexHelper {\n     public static final Tuple COMPARISON_SKIPPED_SCORE = Tuple.from(Comparisons.COMPARISON_SKIPPED_BINDING);\n \n+    public static final RankedSet.HashFunction MURMUR3_HASH_FUNCTION = new GuavaHashFunction(Hashing.murmur3_32());\n+\n+    /**\n+     * Use {@code com.google.common.hash.HashFunction}s as {@code RankedSet.HashFunction}s.\n+     */\n+    public static class GuavaHashFunction implements RankedSet.HashFunction {", "originalCommit": "33d8ddb960b33736a51df2c8647f39e58e76f1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2NjQ3Nw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382866477", "bodyText": "I moved it out into the replacement for the enum and made it private", "author": "MMcM", "createdAt": "2020-02-22T00:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NTE1Ng==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382845156", "bodyText": "As this enum is in an INTERNAL class, it's technically \"unadvised\" for users to use this, but the alternative is they need their own constants in their code if they want to use the names here. I suppose we could leave it here if we're not \"entirely happy\" with this API (yet?), or move it out.", "author": "alecgrieser", "createdAt": "2020-02-21T22:57:02Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/indexes/RankedSetIndexHelper.java", "diffHunk": "@@ -50,6 +54,54 @@\n public class RankedSetIndexHelper {\n     public static final Tuple COMPARISON_SKIPPED_SCORE = Tuple.from(Comparisons.COMPARISON_SKIPPED_BINDING);\n \n+    public static final RankedSet.HashFunction MURMUR3_HASH_FUNCTION = new GuavaHashFunction(Hashing.murmur3_32());\n+\n+    /**\n+     * Use {@code com.google.common.hash.HashFunction}s as {@code RankedSet.HashFunction}s.\n+     */\n+    public static class GuavaHashFunction implements RankedSet.HashFunction {\n+        @Nonnull\n+        private final HashFunction guava;\n+\n+        public GuavaHashFunction(HashFunction guava) {\n+            this.guava = guava;\n+        }\n+\n+        @Override\n+        public int hash(byte[] key) {\n+            return guava.hashBytes(key).asInt();\n+        }\n+    }\n+\n+    /**\n+     * Known hash functions available as index options.\n+     */\n+    public enum HashFunctionNames {", "originalCommit": "33d8ddb960b33736a51df2c8647f39e58e76f1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2Njc5NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382866795", "bodyText": "I made this top level. Since that meant it should own the other statics and enum init order is fixed, I needed to also make it a regular class.", "author": "MMcM", "createdAt": "2020-02-22T00:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NTE1Ng=="}], "type": "inlineReview"}, {"oid": "e058eeb26aa867b289bc15bf4f6e4f06cb10a0ba", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e058eeb26aa867b289bc15bf4f6e4f06cb10a0ba", "message": "Move enum out to top level as a regular class.", "committedDate": "2020-02-22T00:17:58Z", "type": "forcePushed"}, {"oid": "7a5eee2b371b0ff67d3905c1f9660cef1d4c123e", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/7a5eee2b371b0ff67d3905c1f9660cef1d4c123e", "message": "Move enum out to top level as a regular class.", "committedDate": "2020-02-22T05:05:53Z", "type": "forcePushed"}, {"oid": "3b9308c92b446df845cd7fc108795fcebf8c3569", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/3b9308c92b446df845cd7fc108795fcebf8c3569", "message": "Move enum out to top level as a regular class.", "committedDate": "2020-02-22T05:11:35Z", "type": "forcePushed"}, {"oid": "9514e03b4fb16223fa0aa1be736df807b760c42f", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/9514e03b4fb16223fa0aa1be736df807b760c42f", "message": "Allow RankedSet to have different hash functions.", "committedDate": "2020-02-23T18:38:05Z", "type": "commit"}, {"oid": "75a19880395259eba12c6a285da3d72925bbde9f", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/75a19880395259eba12c6a285da3d72925bbde9f", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution.", "committedDate": "2020-02-23T18:38:57Z", "type": "commit"}, {"oid": "d0440f94cb35b60897b86c35959eafcd3019b77c", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/d0440f94cb35b60897b86c35959eafcd3019b77c", "message": "Move enum out to top level as a regular class.", "committedDate": "2020-02-23T18:38:57Z", "type": "commit"}, {"oid": "d0440f94cb35b60897b86c35959eafcd3019b77c", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/d0440f94cb35b60897b86c35959eafcd3019b77c", "message": "Move enum out to top level as a regular class.", "committedDate": "2020-02-23T18:38:57Z", "type": "forcePushed"}]}