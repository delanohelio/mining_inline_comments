{"pr_number": 1044, "pr_title": "Resolves #1043: Support checking whether or not an index is being built", "pr_createdAt": "2020-10-15T03:33:58Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044", "timeline": [{"oid": "b3bc2ddf8597c705f6252ce4c8c495f26500d5b0", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/b3bc2ddf8597c705f6252ce4c8c495f26500d5b0", "message": "Resolves #1043: Support checking whether or not an index is being built", "committedDate": "2020-10-15T03:58:54Z", "type": "forcePushed"}, {"oid": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "message": "Resolves #1043: Support checking whether or not an index is being built", "committedDate": "2020-10-15T04:19:11Z", "type": "commit"}, {"oid": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "message": "Resolves #1043: Support checking whether or not an index is being built", "committedDate": "2020-10-15T04:19:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2NjQ0MQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505666441", "bodyText": "Bit of a nit, but something about \"any\" doesn't quite seem right here... Maybe checkActive?", "author": "alecgrieser", "createdAt": "2020-10-15T16:09:58Z", "path": "fdb-extensions/src/main/java/com/apple/foundationdb/synchronizedsession/SynchronizedSession.java", "diffHunk": "@@ -216,15 +224,48 @@ public static void endAnySession(@Nonnull Transaction tr, @Nonnull Subspace lock\n         tr.clear(lockSubspace.range());\n     }\n \n-    private CompletableFuture<UUID> getLockSessionId(@Nonnull Transaction tr) {\n-        return tr.get(lockSessionIdSubspaceKey)\n+\n+    /**\n+     * Check if there is any active session on the given lock subspace, so that a new session would not able to be initialized.\n+     * @param tr transaction to use\n+     * @param lockSubspace the lock whose active session needs to be checked\n+     * @return {@code true} if there is any active session, otherwise {@code false}\n+     */\n+    public static CompletableFuture<Boolean> checkAnySession(@Nonnull Transaction tr, @Nonnull Subspace lockSubspace) {", "originalCommit": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzMDQwMA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512430400", "bodyText": "Yeah, I called it checkAnySession because it's a \"parallel narrative\" of the endAnySession  methods above, but now I can see how this name can be misleading.\nHowever, checkActive also sound vague to me because it doesn't say it's about the current session or about all sessions of the lock. I would imagine SynchronizedSession could be refactored to two classes: SynchronizedSessionLock (defined by a lock subspace) and a SynchronizedSession (defined by a lock subspace and a session ID). After that, checkActive should be a good name on SynchronizedSessionLock.\nWhat about checkExistActiveSession?", "author": "nblintao", "createdAt": "2020-10-27T05:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2NjQ0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0NDY4OA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512944688", "bodyText": "Okay, I think that name makes sense. Just a grammar change suggested in a follow up review comment", "author": "alecgrieser", "createdAt": "2020-10-27T18:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2NjQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2ODk0Ng==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505668946", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n          \n          \n            \n                 * Check if the index is being built by any other {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n          \n      \n    \n    \n  \n\nI think it also might make sense to break the parenthetical into its own sentence--something like \"This requires that the synchronized session feature is enabled on all indexers.\" (Probably with an @see or @link to the setUseSyncrhonizedSession method on the OnlineIndexer.Builder.)", "author": "alecgrieser", "createdAt": "2020-10-15T16:13:38Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/OnlineIndexer.java", "diffHunk": "@@ -1119,15 +1119,31 @@ public static void stopOngoingOnlineIndexBuilds(@Nonnull FDBRecordStore recordSt\n         SynchronizedSession.endAnySession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\n     }\n \n-    @VisibleForTesting\n-    CompletableFuture<Void> checkNoOngoingOnlineIndexBuildsAsync() {\n-        return runner\n-                .runAsync(context -> openRecordStore(context).thenApply(store -> indexBuildLockSubspace(store, index)))\n-                .thenCompose(lockSubspace ->\n-                        // It will throw {@link com.apple.foundationdb.synchronizedsession.SynchronizedSessionLockedException}\n-                        // if there are ongoing online index builds.\n-                        runner.startSynchronizedSessionAsync(lockSubspace, leaseLengthMills))\n-                .thenCompose(SynchronizedSessionRunner::endSessionAsync);\n+    /**\n+     * Synchronous/blocking version of {@link #checkAnyOngoingOnlineIndexBuildsAsync()}.\n+     * @return <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public boolean checkAnyOngoingOnlineIndexBuilds() {\n+        return runner.asyncToSync(FDBStoreTimer.Waits.WAIT_CHECK_ONGOING_ONLINE_INDEX_BUILD, checkAnyOngoingOnlineIndexBuildsAsync());\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).", "originalCommit": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY5NDkwNw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505694907", "bodyText": "I think I do mean any OnlineIndexers instead any other OnlineIndexers. Note that these methods are independent of specific OnlineIndexer objects. It returns true to onlineIndexer. checkAnyOngoingOnlineIndexBuildsAsync even if the index is being built by onlineIndexer it self.", "author": "nblintao", "createdAt": "2020-10-15T16:53:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2ODk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY5ODMxMA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505698310", "bodyText": "Oh, interesting. I guess that's true. I guess it's just the \"the\" then that's extraneous, though it may be worth calling that out in the docs (that this \"self conflicts\")", "author": "alecgrieser", "createdAt": "2020-10-15T16:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2ODk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyNDg0Ng==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512424846", "bodyText": "Done.", "author": "nblintao", "createdAt": "2020-10-27T05:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2ODk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2OTE1OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505669159", "bodyText": "Same comments about the docs as on the other method", "author": "alecgrieser", "createdAt": "2020-10-15T16:13:56Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/OnlineIndexer.java", "diffHunk": "@@ -1119,15 +1119,31 @@ public static void stopOngoingOnlineIndexBuilds(@Nonnull FDBRecordStore recordSt\n         SynchronizedSession.endAnySession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\n     }\n \n-    @VisibleForTesting\n-    CompletableFuture<Void> checkNoOngoingOnlineIndexBuildsAsync() {\n-        return runner\n-                .runAsync(context -> openRecordStore(context).thenApply(store -> indexBuildLockSubspace(store, index)))\n-                .thenCompose(lockSubspace ->\n-                        // It will throw {@link com.apple.foundationdb.synchronizedsession.SynchronizedSessionLockedException}\n-                        // if there are ongoing online index builds.\n-                        runner.startSynchronizedSessionAsync(lockSubspace, leaseLengthMills))\n-                .thenCompose(SynchronizedSessionRunner::endSessionAsync);\n+    /**\n+     * Synchronous/blocking version of {@link #checkAnyOngoingOnlineIndexBuildsAsync()}.\n+     * @return <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public boolean checkAnyOngoingOnlineIndexBuilds() {\n+        return runner.asyncToSync(FDBStoreTimer.Waits.WAIT_CHECK_ONGOING_ONLINE_INDEX_BUILD, checkAnyOngoingOnlineIndexBuildsAsync());\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n+     * @return a future that will complete to <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public CompletableFuture<Boolean> checkAnyOngoingOnlineIndexBuildsAsync() {\n+        return runner.runAsync(context -> openRecordStore(context).thenCompose(recordStore ->\n+                checkAnyOngoingOnlineIndexBuildsAsync(recordStore, index)));\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).", "originalCommit": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyNTgxNQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512425815", "bodyText": "Removed the, but I don't I should call out \"self conflict\" here because this is a static method.", "author": "nblintao", "createdAt": "2020-10-27T05:30:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2OTE1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2OTM5OA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505669398", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param index the index whose builds need to be stopped\n          \n          \n            \n                 * @param index the index to check for ongoing index builds", "author": "alecgrieser", "createdAt": "2020-10-15T16:14:19Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/OnlineIndexer.java", "diffHunk": "@@ -1119,15 +1119,31 @@ public static void stopOngoingOnlineIndexBuilds(@Nonnull FDBRecordStore recordSt\n         SynchronizedSession.endAnySession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\n     }\n \n-    @VisibleForTesting\n-    CompletableFuture<Void> checkNoOngoingOnlineIndexBuildsAsync() {\n-        return runner\n-                .runAsync(context -> openRecordStore(context).thenApply(store -> indexBuildLockSubspace(store, index)))\n-                .thenCompose(lockSubspace ->\n-                        // It will throw {@link com.apple.foundationdb.synchronizedsession.SynchronizedSessionLockedException}\n-                        // if there are ongoing online index builds.\n-                        runner.startSynchronizedSessionAsync(lockSubspace, leaseLengthMills))\n-                .thenCompose(SynchronizedSessionRunner::endSessionAsync);\n+    /**\n+     * Synchronous/blocking version of {@link #checkAnyOngoingOnlineIndexBuildsAsync()}.\n+     * @return <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public boolean checkAnyOngoingOnlineIndexBuilds() {\n+        return runner.asyncToSync(FDBStoreTimer.Waits.WAIT_CHECK_ONGOING_ONLINE_INDEX_BUILD, checkAnyOngoingOnlineIndexBuildsAsync());\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n+     * @return a future that will complete to <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public CompletableFuture<Boolean> checkAnyOngoingOnlineIndexBuildsAsync() {\n+        return runner.runAsync(context -> openRecordStore(context).thenCompose(recordStore ->\n+                checkAnyOngoingOnlineIndexBuildsAsync(recordStore, index)));\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n+     * @param recordStore record store whose index builds need to be checked\n+     * @param index the index whose builds need to be stopped", "originalCommit": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyNTEzOA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512425138", "bodyText": "Done.", "author": "nblintao", "createdAt": "2020-10-27T05:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2OTM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0Mzc1Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512943752", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static CompletableFuture<Boolean> checkExistActiveSession(@Nonnull Transaction tr, @Nonnull Subspace lockSubspace) {\n          \n          \n            \n                public static CompletableFuture<Boolean> checkActiveSessionExists(@Nonnull Transaction tr, @Nonnull Subspace lockSubspace) {", "author": "alecgrieser", "createdAt": "2020-10-27T18:46:31Z", "path": "fdb-extensions/src/main/java/com/apple/foundationdb/synchronizedsession/SynchronizedSession.java", "diffHunk": "@@ -216,15 +224,48 @@ public static void endAnySession(@Nonnull Transaction tr, @Nonnull Subspace lock\n         tr.clear(lockSubspace.range());\n     }\n \n-    private CompletableFuture<UUID> getLockSessionId(@Nonnull Transaction tr) {\n-        return tr.get(lockSessionIdSubspaceKey)\n+\n+    /**\n+     * Check if there is any active session on the given lock subspace, so that a new session would not able to be initialized.\n+     * @param tr transaction to use\n+     * @param lockSubspace the lock whose active session needs to be checked\n+     * @return {@code true} if there is any active session, otherwise {@code false}\n+     */\n+    public static CompletableFuture<Boolean> checkExistActiveSession(@Nonnull Transaction tr, @Nonnull Subspace lockSubspace) {", "originalCommit": "60899100c9830e70399fa45b3406a57578c0ce47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3Mzk3NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r513073975", "bodyText": "Done.", "author": "nblintao", "createdAt": "2020-10-27T22:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0Mzc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0Mzg1NA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512943854", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return SynchronizedSession.checkExistActiveSession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\n          \n          \n            \n                    return SynchronizedSession.checkActiveSessionExists(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));", "author": "alecgrieser", "createdAt": "2020-10-27T18:46:42Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/OnlineIndexer.java", "diffHunk": "@@ -1119,15 +1119,32 @@ public static void stopOngoingOnlineIndexBuilds(@Nonnull FDBRecordStore recordSt\n         SynchronizedSession.endAnySession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\n     }\n \n-    @VisibleForTesting\n-    CompletableFuture<Void> checkNoOngoingOnlineIndexBuildsAsync() {\n-        return runner\n-                .runAsync(context -> openRecordStore(context).thenApply(store -> indexBuildLockSubspace(store, index)))\n-                .thenCompose(lockSubspace ->\n-                        // It will throw {@link com.apple.foundationdb.synchronizedsession.SynchronizedSessionLockedException}\n-                        // if there are ongoing online index builds.\n-                        runner.startSynchronizedSessionAsync(lockSubspace, leaseLengthMills))\n-                .thenCompose(SynchronizedSessionRunner::endSessionAsync);\n+    /**\n+     * Synchronous/blocking version of {@link #checkAnyOngoingOnlineIndexBuildsAsync()}.\n+     * @return <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public boolean checkAnyOngoingOnlineIndexBuilds() {\n+        return runner.asyncToSync(FDBStoreTimer.Waits.WAIT_CHECK_ONGOING_ONLINE_INDEX_BUILD, checkAnyOngoingOnlineIndexBuildsAsync());\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s),\n+     * including <i>this</i> {@link OnlineIndexer}.\n+     * @return a future that will complete to <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public CompletableFuture<Boolean> checkAnyOngoingOnlineIndexBuildsAsync() {\n+        return runner.runAsync(context -> openRecordStore(context).thenCompose(recordStore ->\n+                checkAnyOngoingOnlineIndexBuildsAsync(recordStore, index)));\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n+     * @param recordStore record store whose index builds need to be checked\n+     * @param index the index to check for ongoing index builds\n+     * @return a future that will complete to <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public static CompletableFuture<Boolean> checkAnyOngoingOnlineIndexBuildsAsync(@Nonnull FDBRecordStore recordStore, @Nonnull Index index) {\n+        return SynchronizedSession.checkExistActiveSession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));", "originalCommit": "60899100c9830e70399fa45b3406a57578c0ce47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3NDAwMQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r513074001", "bodyText": "Done.", "author": "nblintao", "createdAt": "2020-10-27T22:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0Mzg1NA=="}], "type": "inlineReview"}, {"oid": "71edb374b7597951f96c600c94b3226afeab44cf", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/71edb374b7597951f96c600c94b3226afeab44cf", "message": "Fix API name and JavaDoc in SynchronizedSession", "committedDate": "2020-10-27T22:37:42Z", "type": "commit"}, {"oid": "71edb374b7597951f96c600c94b3226afeab44cf", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/71edb374b7597951f96c600c94b3226afeab44cf", "message": "Fix API name and JavaDoc in SynchronizedSession", "committedDate": "2020-10-27T22:37:42Z", "type": "forcePushed"}]}