{"pr_number": 929, "pr_title": "Resolves #928: support edge ordering in planner graphs", "pr_createdAt": "2020-05-05T04:53:07Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/929", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE0NzQxNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423147414", "bodyText": "I think this needs some explanation for why a PlannerExpression might want to \"rewrite\" its graph. I think I understand why (namely, to be able to replace higher-order structures with simpler/more insightful representations), but it took me a long time to understand this.\nOne thing I'm still not sure about: why is this done by having the PlannerExpression do the rewriting, rather than having some \"rules\" that do the rewriting (in line with the design of the rule-based planner itself)? I think the answer is \"to avoid doing instanceof checking in some utility class\", but I wanted to double-check.", "author": "nschiefer", "createdAt": "2020-05-11T16:01:53Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/InternalPlannerGraphRewritable.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * InternalPlannerGraphRewritable.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+\n+/**\n+ * Interface to allow {@link PlannerExpression}s to rewrite their own\n+ * internal graph representation.", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MjIwMg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423842202", "bodyText": "Done.", "author": "normen662", "createdAt": "2020-05-12T15:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE0NzQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4Nzg5Ng==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423287896", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // If the current node had children that explicitly encode an order we do the following:\n          \n          \n            \n                        // We create a sub-block and set rank=same, rankDir=LR in order to have all children be rendered\n          \n          \n            \n                        // on the same level but left to right -- this is especially important for showing join-orders\n          \n          \n            \n                        // left-to-right.\n          \n          \n            \n                        // If the current node had children that explicitly encode an order we do the following:\n          \n          \n            \n                        // We create a sub-block and set rank=same, rankDir=LR in order to have all children be rendered\n          \n          \n            \n                        // on the same level but left to right.\n          \n          \n            \n                        // This is especially important for showing join-orders left-to-right.", "author": "nschiefer", "createdAt": "2020-05-11T20:06:13Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/DotExporter.java", "diffHunk": "@@ -138,22 +140,93 @@ protected void renderGraphAttributes(final PrintWriter out, final Map<String, St\n     }\n \n     @Override\n-    protected void renderNode(final PrintWriter out, final N node, final Map<String, String> attributes) {\n-        out.print(INDENT);\n-        out.print(getVertexID(node));\n+    protected void renderNodes(final ExporterContext context) {\n+        final ImmutableNetwork<N, E> network = context.getNetwork();\n+        final PrintWriter out = context.getPrintWriter();\n+\n+        super.renderNodes(context);\n \n-        renderAttributes(out, attributes);\n+        // Go through the vertex set a second time to render dependsOn information\n+        // vertex set\n+        for (final N n : network.nodes()) {\n+            // If the current node had children that explicitly encode an order we do the following:\n+            // We create a sub-block and set rank=same, rankDir=LR in order to have all children be rendered\n+            // on the same level but left to right -- this is especially important for showing join-orders\n+            // left-to-right.", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ1NjQzNQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423456435", "bodyText": "Done.", "author": "normen662", "createdAt": "2020-05-12T04:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4Nzg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4ODc4OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423288789", "bodyText": "If we keep this general block of code, I think this is more in line with our style guide:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            for (; index < orderedChildrenEdges.size(); index ++) {\n          \n          \n            \n                                final E currentEdge = orderedChildrenEdges.get(index);\n          \n          \n            \n                                if (!dependsOn.contains(currentEdge)) {\n          \n          \n            \n                                    break;\n          \n          \n            \n                                }\n          \n          \n            \n                            }\n          \n          \n            \n                            while (index < orderedChildrenEdges.size()) {\n          \n          \n            \n                                final E currentEdge = orderedChildrenEdges.get(index);\n          \n          \n            \n                                if (!dependsOn.contains(currentEdge)) {\n          \n          \n            \n                                    break;\n          \n          \n            \n                                }\n          \n          \n            \n                                index++;\n          \n          \n            \n                            }", "author": "nschiefer", "createdAt": "2020-05-11T20:08:02Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/DotExporter.java", "diffHunk": "@@ -138,22 +140,93 @@ protected void renderGraphAttributes(final PrintWriter out, final Map<String, St\n     }\n \n     @Override\n-    protected void renderNode(final PrintWriter out, final N node, final Map<String, String> attributes) {\n-        out.print(INDENT);\n-        out.print(getVertexID(node));\n+    protected void renderNodes(final ExporterContext context) {\n+        final ImmutableNetwork<N, E> network = context.getNetwork();\n+        final PrintWriter out = context.getPrintWriter();\n+\n+        super.renderNodes(context);\n \n-        renderAttributes(out, attributes);\n+        // Go through the vertex set a second time to render dependsOn information\n+        // vertex set\n+        for (final N n : network.nodes()) {\n+            // If the current node had children that explicitly encode an order we do the following:\n+            // We create a sub-block and set rank=same, rankDir=LR in order to have all children be rendered\n+            // on the same level but left to right -- this is especially important for showing join-orders\n+            // left-to-right.\n+\n+            final Set<E> childrenEdges = network.inEdges(n);\n+\n+            // We sort the childrenEdges topologically insertion sort-style O(N^2).\n+            final List<E> orderedChildrenEdges = new ArrayList<>(childrenEdges.size());\n+\n+            boolean needsInvisibleEdges = false;\n+            for (final E toBeInsertedEdge : childrenEdges) {\n+                final Set<? extends PlannerGraph.AbstractEdge> dependsOn = toBeInsertedEdge.getDependsOn();\n+\n+                if (!dependsOn.isEmpty()) {\n+                    needsInvisibleEdges = true;\n+                }\n+\n+                int index = 0;\n+                for (; index < orderedChildrenEdges.size(); index ++) {\n+                    final E currentEdge = orderedChildrenEdges.get(index);\n+                    if (!dependsOn.contains(currentEdge)) {\n+                        break;\n+                    }\n+                }", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ1Njk5NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423456995", "bodyText": "Done.", "author": "normen662", "createdAt": "2020-05-12T04:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4ODc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5MTE4OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423291189", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Specific builder for explain planner graoh building.\n          \n          \n            \n                 * Specific builder for explain planner graph building.", "author": "nschiefer", "createdAt": "2020-05-11T20:12:40Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/ExplainPlannerGraph.java", "diffHunk": "@@ -0,0 +1,203 @@\n+/*\n+ * ExplainPlannerGraph.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.escape.Escaper;\n+import com.google.common.graph.Network;\n+import com.google.common.html.HtmlEscapers;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Lightweight class to save some boilerplate.\n+ */\n+@SuppressWarnings(\"UnstableApiUsage\")\n+public class ExplainPlannerGraph extends PlannerGraph<ExplainPlannerGraph.Node, ExplainPlannerGraph.Edge> {\n+    /**\n+     * Specific builder for explain planner graoh building.", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ1NzEzOQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423457139", "bodyText": "Fixed.", "author": "normen662", "createdAt": "2020-05-12T04:37:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5MTE4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5MjE5Nw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423292197", "bodyText": "Likewise, I think that this needs some more explanation.", "author": "nschiefer", "createdAt": "2020-05-11T20:14:39Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/ExplainPlannerGraphRewritable.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * InternalPlannerGraphRewritable.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+\n+/**\n+ * Interface to allow {@link PlannerExpression}s to rewrite their own\n+ * explain graph representation.", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MjUzNg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423842536", "bodyText": "Done.", "author": "normen662", "createdAt": "2020-05-12T15:49:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5MjE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5Mjc2OA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423292768", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        i ++;\n          \n          \n            \n                        i++;", "author": "nschiefer", "createdAt": "2020-05-11T20:15:41Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/GraphExporter.java", "diffHunk": "@@ -177,67 +208,120 @@ protected String getVertexID(final N node) {\n     /**\n      * Render the header. To be implemented by subclass.\n      *\n-     * @param out the writer\n+     * @param context the context\n      * @param graph the graph\n      */\n-    protected abstract void renderHeader(PrintWriter out, ImmutableNetwork<N, E> graph);\n+    protected abstract void renderHeader(ExporterContext context, ImmutableNetwork<N, E> graph);\n \n     /**\n      * Render the global graph attributes. To be implemented by subclass.\n      *\n-     * @param out the writer\n+     * @param context the context\n      * @param attributes the attributes of the graph\n      */\n-    protected abstract void renderGraphAttributes(PrintWriter out,\n-                                                  Map<String, String> attributes);\n+    protected abstract void renderGraphAttributes(ExporterContext context,\n+                                                  Map<String, Object> attributes);\n+\n+    /**\n+     * Render all nodes in the given network.\n+     *\n+     * @param context the context\n+     */\n+    protected void renderNodes(final ExporterContext context) {\n+        final ImmutableNetwork<N, E> network = context.getNetwork();\n+\n+        // vertex set\n+        for (final N n : network.nodes()) {\n+            renderNode(context,\n+                    n,\n+                    vertexAttributeProvider.apply(n));\n+        }\n+    }\n \n     /**\n      * Render a node. To be implemented by subclass.\n      *\n-     * @param out the writer\n+     * @param context the context\n      * @param node the node to be rendered\n      * @param attributes the attributes of the node\n      */\n-    protected abstract void renderNode(PrintWriter out,\n+    protected abstract void renderNode(ExporterContext context,\n                                        N node,\n-                                       Map<String, String> attributes);\n+                                       Map<String, Object> attributes);\n+\n+    /**\n+     * Render all edges in a given network.\n+     * @param context the context to use\n+     */\n+    protected void renderEdges(final ExporterContext context) {\n+        final ImmutableNetwork<N, E> network = context.getNetwork();\n+\n+        // edge set\n+        for (final E e : network.edges()) {\n+            final EndpointPair<N> endpointPair = network.incidentNodes(e);\n+            final N u = endpointPair.nodeU();\n+            final N v = endpointPair.nodeV();\n+            renderEdge(context,\n+                    network.isDirected(),\n+                    u,\n+                    v,\n+                    edgeAttributeProvider.apply(e));\n+        }\n+    }\n \n     /**\n      * Render an edge. To be implemented by subclass.\n      *\n-     * @param out the writer\n+     * @param context the context\n      * @param isDirected true iff edge is directed\n-     * @param edge the edge to be rendered\n      * @param source the source node of the edge\n      * @param target the target node of the edge\n      * @param attributes the attributes of the edge\n      */\n-    protected abstract void renderEdge(PrintWriter out,\n+    protected abstract void renderEdge(ExporterContext context,\n                                        boolean isDirected,\n-                                       E edge,\n                                        N source,\n                                        N target,\n-                                       Map<String, String> attributes);\n+                                       Map<String, Object> attributes);\n+    \n+    /**\n+     * Render all sub clusters in a given network.\n+     * @param context the context to use\n+     */\n+    protected void renderClusters(final ExporterContext context) {\n+        final ImmutableNetwork<N, E> network = context.getNetwork();\n+        // render clusters\n+        final Map<N, Set<N>> clusterMap = clusterProvider.apply(network);\n+        int i = 1;\n+        for (final Entry<N, Set<N>> cluster : clusterMap.entrySet()) {\n+            renderCluster(context,\n+                    String.valueOf(i),\n+                    cluster.getKey(),\n+                    cluster.getValue(),\n+                    clusterAttributeProvider.apply(cluster.getKey()));\n+            i ++;", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ1NzQ4MQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423457481", "bodyText": "Wait, unary operators have no space in between?", "author": "normen662", "createdAt": "2020-05-12T04:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5Mjc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5NDc3NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423294775", "bodyText": "I think that this needs a detailed Javadoc explaining what it does (and especially what childGraphs is). In particular, this is important because the interface shows up in so many RecordQueryPlan implementations.", "author": "nschiefer", "createdAt": "2020-05-11T20:19:25Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/InternalPlannerGraphRewritable.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * InternalPlannerGraphRewritable.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+\n+/**\n+ * Interface to allow {@link PlannerExpression}s to rewrite their own\n+ * internal graph representation.\n+ */\n+public interface InternalPlannerGraphRewritable {\n+    @Nonnull\n+    InternalPlannerGraph rewriteInternalPlannerGraph(@Nonnull List<InternalPlannerGraph> childGraphs);", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5NTkzNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423295934", "bodyText": "I think that these implementations are quite hard to read without a lot of derails about how the InternalPlannerGraph-related classes work. For each of them, perhaps a brief Javadoc can summarize the \"intent\" (e.g., \"Display an IN-join plan in the style of nested loop join...\")?", "author": "nschiefer", "createdAt": "2020-05-11T20:21:36Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/plans/RecordQueryInParameterJoinPlan.java", "diffHunk": "@@ -105,4 +111,37 @@ public void logPlanStructure(StoreTimer timer) {\n         timer.increment(FDBStoreTimer.Counts.PLAN_IN_PARAMETER);\n         getInner().logPlanStructure(timer);\n     }\n+\n+    @Nonnull\n+    @Override\n+    public InternalPlannerGraph rewriteInternalPlannerGraph(@Nonnull List<InternalPlannerGraph> childGraphs) {", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5NjU5MQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423296591", "bodyText": "The amount of code duplication between rewriteInternalPlannerGraph() and rewriteExplainPlannerGraph() is quite unfortunate. I assume it's tricky to make this better because of the type system? Unless we can think of a fundamental reason to change it, we should open an issue about cleaning this up (but I won't block the merge on resolving this).\nThis close relationship seems to hold for (almost?) all of the implementations of these methods, which does suggest that something is awry with our abstractions.", "author": "nschiefer", "createdAt": "2020-05-11T20:22:55Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/plans/RecordQueryInParameterJoinPlan.java", "diffHunk": "@@ -105,4 +111,37 @@ public void logPlanStructure(StoreTimer timer) {\n         timer.increment(FDBStoreTimer.Counts.PLAN_IN_PARAMETER);\n         getInner().logPlanStructure(timer);\n     }\n+\n+    @Nonnull\n+    @Override\n+    public InternalPlannerGraph rewriteInternalPlannerGraph(@Nonnull List<InternalPlannerGraph> childGraphs) {\n+        final InternalPlannerGraph.Node root =\n+                new InternalPlannerGraph.Node(this,\n+                        getClass().getSimpleName());\n+        final InternalPlannerGraph graphForInner = Iterables.getOnlyElement(childGraphs);\n+        final InternalPlannerGraph.SourceNode explodeNode = new InternalPlannerGraph.SourceNode(\"Explode\", externalBinding);\n+        final InternalPlannerGraph.Edge fromExplodeEdge = new InternalPlannerGraph.Edge();\n+        return InternalPlannerGraph.builder(root)\n+                .addGraph(graphForInner)\n+                .addNode(explodeNode)\n+                .addEdge(explodeNode, root, fromExplodeEdge)\n+                .addEdge(graphForInner.getRoot(), root, new InternalPlannerGraph.Edge(ImmutableSet.of(fromExplodeEdge)))\n+                .build();\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public ExplainPlannerGraph rewriteExplainPlannerGraph(@Nonnull List<ExplainPlannerGraph> childGraphs) {", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ1ODMzNQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423458335", "bodyText": "I have redesigned this for better code reuse in a way that we can allow for a specific deviation from the common path if explain is different than internal show. If they are the same both use cases now do use the same node and edge hierarchy and can therefore reuse large amounts of code. I am happier with the that than to keep classes strictly separated but also duplicated.", "author": "normen662", "createdAt": "2020-05-12T04:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5NjU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5Nzg4Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423297882", "bodyText": "The rewrites with fancy string interpolation stuff are the ones that make me saddest about the code duplication.", "author": "nschiefer", "createdAt": "2020-05-11T20:25:18Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/plans/RecordQueryTypeFilterPlan.java", "diffHunk": "@@ -165,4 +171,35 @@ public void logPlanStructure(StoreTimer timer) {\n     public int getComplexity() {\n         return 1 + getInner().getComplexity();\n     }\n+\n+    @Nonnull\n+    @Override\n+    public InternalPlannerGraph rewriteInternalPlannerGraph(@Nonnull List<InternalPlannerGraph> childGraphs) {\n+        final InternalPlannerGraph.Node root =\n+                new InternalPlannerGraph.Node(this,\n+                        getClass().getSimpleName(),\n+                        \"[\" + String.join(\" v \", recordTypes) + \"]\");\n+        final InternalPlannerGraph graphForInner =\n+                Iterables.getOnlyElement(childGraphs);\n+        return InternalPlannerGraph.builder(root)\n+                .addGraph(graphForInner)\n+                .addEdge(graphForInner.getRoot(), root, new InternalPlannerGraph.GroupExpressionRefEdge())\n+                .build();\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public ExplainPlannerGraph rewriteExplainPlannerGraph(@Nonnull List<ExplainPlannerGraph> childGraphs) {\n+        final ExplainPlannerGraph.Node root =\n+                new ExplainPlannerGraph.Node(this,\n+                        getClass().getSimpleName(),\n+                        \"[\" + String.join(\" v \", recordTypes) + \"]\");", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ1ODQ3MQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423458471", "bodyText": "see above -- no reason to be sad anymore", "author": "normen662", "createdAt": "2020-05-12T04:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5Nzg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5ODIyMw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423298223", "bodyText": "I think that \"invisible edges\" are the ones that we add to enforce the ordering convention (e.g., for join order), but I think this is complicated enough that we'll struggle to maintain it without a comment here.", "author": "nschiefer", "createdAt": "2020-05-11T20:25:58Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/DotExporter.java", "diffHunk": "@@ -138,22 +140,93 @@ protected void renderGraphAttributes(final PrintWriter out, final Map<String, St\n     }\n \n     @Override\n-    protected void renderNode(final PrintWriter out, final N node, final Map<String, String> attributes) {\n-        out.print(INDENT);\n-        out.print(getVertexID(node));\n+    protected void renderNodes(final ExporterContext context) {\n+        final ImmutableNetwork<N, E> network = context.getNetwork();\n+        final PrintWriter out = context.getPrintWriter();\n+\n+        super.renderNodes(context);\n \n-        renderAttributes(out, attributes);\n+        // Go through the vertex set a second time to render dependsOn information\n+        // vertex set\n+        for (final N n : network.nodes()) {\n+            // If the current node had children that explicitly encode an order we do the following:\n+            // We create a sub-block and set rank=same, rankDir=LR in order to have all children be rendered\n+            // on the same level but left to right -- this is especially important for showing join-orders\n+            // left-to-right.\n+\n+            final Set<E> childrenEdges = network.inEdges(n);\n+\n+            // We sort the childrenEdges topologically insertion sort-style O(N^2).\n+            final List<E> orderedChildrenEdges = new ArrayList<>(childrenEdges.size());\n+\n+            boolean needsInvisibleEdges = false;\n+            for (final E toBeInsertedEdge : childrenEdges) {\n+                final Set<? extends PlannerGraph.AbstractEdge> dependsOn = toBeInsertedEdge.getDependsOn();\n+\n+                if (!dependsOn.isEmpty()) {\n+                    needsInvisibleEdges = true;\n+                }\n+\n+                int index = 0;\n+                for (; index < orderedChildrenEdges.size(); index ++) {\n+                    final E currentEdge = orderedChildrenEdges.get(index);\n+                    if (!dependsOn.contains(currentEdge)) {\n+                        break;\n+                    }\n+                }\n+                orderedChildrenEdges.add(index, toBeInsertedEdge);\n+            }\n \n+            if (needsInvisibleEdges) {", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwMjMzOQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423302339", "bodyText": "Probably worth including this explanation from the PR description:\n\ndot exports use dependsOn() by adding an invisible edge (not to the graph; just to the dot export) between children of a node. It also adds the visual constraint to layout children from left to right", "author": "nschiefer", "createdAt": "2020-05-11T20:33:30Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/DotExporter.java", "diffHunk": "@@ -138,22 +140,93 @@ protected void renderGraphAttributes(final PrintWriter out, final Map<String, St\n     }\n \n     @Override\n-    protected void renderNode(final PrintWriter out, final N node, final Map<String, String> attributes) {\n-        out.print(INDENT);\n-        out.print(getVertexID(node));\n+    protected void renderNodes(final ExporterContext context) {\n+        final ImmutableNetwork<N, E> network = context.getNetwork();\n+        final PrintWriter out = context.getPrintWriter();\n+\n+        super.renderNodes(context);\n \n-        renderAttributes(out, attributes);\n+        // Go through the vertex set a second time to render dependsOn information\n+        // vertex set", "originalCommit": "e8dda000ec7f1b50387df2a611fc45197e33504c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/0da92a01028a896d068cff0b12d802a13b1c4f6a", "message": "Resolves #928: support edge ordering in planner graphs", "committedDate": "2020-05-12T16:38:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzMzAxNg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423933016", "bodyText": "Adjusting to match Javadoc conventions:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param renderSingleGroups -- instruct the explain graph to not render group references with just one member\n          \n          \n            \n                 * @param renderSingleGroups whether to render group references with just one member", "author": "nschiefer", "createdAt": "2020-05-12T18:07:26Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/PlannerExpression.java", "diffHunk": "@@ -113,24 +113,12 @@\n      * This is needed for graph integration into IntelliJ as IntelliJ only ever evaluates selfish methods. Add this\n      * method as a custom renderer for the type {@link PlannerExpression}. During debugging you can then for instance\n      * click show() on an instance and enjoy the query graph it represents rendered in your standard browser.\n-     *\n+     * @param renderSingleGroups -- instruct the explain graph to not render group references with just one member", "originalCommit": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTM2Mw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r424049363", "bodyText": "Done.", "author": "normen662", "createdAt": "2020-05-12T21:39:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzMzAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzNDg2NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423934865", "bodyText": "While we're adding comments, let's say something about what an Attribute is. Perhaps along the lines of:\nA tag object that annotates a {@link AbstractPlannerGraph.AbstractNode} or an {@link \n\nAbstractPlannerGraph.AbstractEdge}, providing additional information to a {@link GraphExporter}.", "author": "nschiefer", "createdAt": "2020-05-12T18:10:39Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/explain/Attribute.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Attribute.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp.explain;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n+/**\n+ * Basic class for all attributes of {@link AbstractPlannerGraph.AbstractNode}\n+ * as well as {@link AbstractPlannerGraph.AbstractEdge}.", "originalCommit": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1MDEzNQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r424050135", "bodyText": "Done.", "author": "normen662", "createdAt": "2020-05-12T21:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzNDg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzNTg3MQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423935871", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns if this method is semantic of it contains visual cues of other non-semantic information.\n          \n          \n            \n                 *\n          \n          \n            \n                 * @return indicator if attribute is semantic.\n          \n          \n            \n                 * Return whether this method is semantic or if it contains visual cues of other non-semantic information.\n          \n          \n            \n                 *\n          \n          \n            \n                 * @return {@code true} if the attribute is semantic, {@code false} otherwise.", "author": "nschiefer", "createdAt": "2020-05-12T18:12:23Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/explain/Attribute.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Attribute.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp.explain;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n+/**\n+ * Basic class for all attributes of {@link AbstractPlannerGraph.AbstractNode}\n+ * as well as {@link AbstractPlannerGraph.AbstractEdge}.\n+ */\n+public abstract class Attribute {\n+    @Nonnull\n+    private final Object reference;\n+\n+    protected Attribute(final Object reference) {\n+        this.reference = reference;\n+    }\n+\n+    /**\n+     * Returns if this method is semantic of it contains visual cues of other non-semantic information.\n+     *\n+     * @return indicator if attribute is semantic.", "originalCommit": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzNjIxOQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423936219", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * This method returns the underlying object this attribute refers to.\n          \n          \n            \n                 * Return the underlying object this attribute refers to.", "author": "nschiefer", "createdAt": "2020-05-12T18:12:57Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/explain/Attribute.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Attribute.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp.explain;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n+/**\n+ * Basic class for all attributes of {@link AbstractPlannerGraph.AbstractNode}\n+ * as well as {@link AbstractPlannerGraph.AbstractEdge}.\n+ */\n+public abstract class Attribute {\n+    @Nonnull\n+    private final Object reference;\n+\n+    protected Attribute(final Object reference) {\n+        this.reference = reference;\n+    }\n+\n+    /**\n+     * Returns if this method is semantic of it contains visual cues of other non-semantic information.\n+     *\n+     * @return indicator if attribute is semantic.\n+     */\n+    public abstract boolean isSemanticAttribute();\n+\n+    /**\n+     * This method returns the underlying object this attribute refers to.", "originalCommit": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzNzQ0Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423937442", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * we compute the {@link PlannerGraphProperty} for explain purposes.\n          \n          \n            \n             * we compute the {@link PlannerGraphProperty} when explaining a plan to an end-user.", "author": "nschiefer", "createdAt": "2020-05-12T18:15:00Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/explain/ExplainPlannerGraphRewritable.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * ExplainPlannerGraphRewritable.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp.explain;\n+\n+import com.apple.foundationdb.record.query.plan.temp.PlannerExpression;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+\n+/**\n+ * Interface to allow {@link PlannerExpression}s to rewrite their own\n+ * explain graph representation.\n+ *\n+ * This particular class allows {@link PlannerExpression}s to specify how a {@link PlannerGraph} is modified when\n+ * we compute the {@link PlannerGraphProperty} for explain purposes.", "originalCommit": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1MDc3Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r424050772", "bodyText": "Done.", "author": "normen662", "createdAt": "2020-05-12T21:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzNzQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzOTIwNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423939204", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Interface to allow {@link PlannerExpression}s to rewrite their own\n          \n          \n            \n             * internal graph representation. Please see {@link PlannerGraphRewritable} for a more comprehensive explanation.\n          \n          \n            \n             *\n          \n          \n            \n             * This particular class allows {@link PlannerExpression}s to specify how a {@link PlannerGraph} is modified when\n          \n          \n            \n             * we compute the {@link PlannerGraphProperty} for internal show.\n          \n          \n            \n             * Interface to allow {@link PlannerExpression}s to rewrite their own internal graph representation.\n          \n          \n            \n             *\n          \n          \n            \n             * This particular class allows {@link PlannerExpression}s to specify how a {@link PlannerGraph} is modified when\n          \n          \n            \n             * we compute the {@link PlannerGraphProperty} for developers working on the query planner.\n          \n          \n            \n             * @see PlannerGraphRewritable for a more comprehensive explanation of graph rewriting", "author": "nschiefer", "createdAt": "2020-05-12T18:17:43Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/explain/InternalPlannerGraphRewritable.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * InternalPlannerGraphRewritable.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp.explain;\n+\n+import com.apple.foundationdb.record.query.plan.temp.PlannerExpression;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+\n+/**\n+ * Interface to allow {@link PlannerExpression}s to rewrite their own\n+ * internal graph representation. Please see {@link PlannerGraphRewritable} for a more comprehensive explanation.\n+ *\n+ * This particular class allows {@link PlannerExpression}s to specify how a {@link PlannerGraph} is modified when\n+ * we compute the {@link PlannerGraphProperty} for internal show.", "originalCommit": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1MTk1OA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r424051958", "bodyText": "Done.", "author": "normen662", "createdAt": "2020-05-12T21:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzOTIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzOTcyNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423939724", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * highly operator-specific, therefore, the rewrite is no part of the visitor or some other common logic.\n          \n          \n            \n             * highly operator-specific, therefore, the rewrite is not part of the visitor or some other common logic.", "author": "nschiefer", "createdAt": "2020-05-12T18:18:33Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/explain/PlannerGraphRewritable.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * PlannerGraphRewritable.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp.explain;\n+\n+import com.apple.foundationdb.record.query.plan.temp.PlannerExpression;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+\n+/**\n+ * Interface to allow {@link PlannerExpression}s to rewrite their own\n+ * graph representation.\n+ *\n+ * This interface allows a {@link PlannerExpression} to create/modify low level planner graph structures while\n+ * a planner graph is created through an expression walk in {@link PlannerGraphProperty}. Such a rewrite can be useful\n+ * if the standard representation is confusing, misleading or just too complicated. For instance,\n+ * {@link com.apple.foundationdb.record.query.plan.plans.RecordQueryPlanWithIndex} additionally creates a separate\n+ * node underneath the actual plan operator to show the index as a record producer. The nature of the rewrite is\n+ * highly operator-specific, therefore, the rewrite is no part of the visitor or some other common logic.", "originalCommit": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1MjIxMA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r424052210", "bodyText": "Fixed.", "author": "normen662", "createdAt": "2020-05-12T21:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzOTcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzOTgzMg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423939832", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * if the standard representation is confusing, misleading or just too complicated. For instance,\n          \n          \n            \n             * if the standard representation is confusing, misleading, or just too complicated. For instance,", "author": "nschiefer", "createdAt": "2020-05-12T18:18:45Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/explain/PlannerGraphRewritable.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * PlannerGraphRewritable.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp.explain;\n+\n+import com.apple.foundationdb.record.query.plan.temp.PlannerExpression;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+\n+/**\n+ * Interface to allow {@link PlannerExpression}s to rewrite their own\n+ * graph representation.\n+ *\n+ * This interface allows a {@link PlannerExpression} to create/modify low level planner graph structures while\n+ * a planner graph is created through an expression walk in {@link PlannerGraphProperty}. Such a rewrite can be useful\n+ * if the standard representation is confusing, misleading or just too complicated. For instance,", "originalCommit": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1MjQxMQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r424052411", "bodyText": "Fixed.", "author": "normen662", "createdAt": "2020-05-12T21:46:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzOTgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk0MDAwMA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423940000", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Implementors of this interface will be asked to rewrite the planner graph for both internal show as well as\n          \n          \n            \n             * Implementors of this interface should rewrite the planner graph for both internal show as well as", "author": "nschiefer", "createdAt": "2020-05-12T18:19:03Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/explain/PlannerGraphRewritable.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * PlannerGraphRewritable.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.query.plan.temp.explain;\n+\n+import com.apple.foundationdb.record.query.plan.temp.PlannerExpression;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+\n+/**\n+ * Interface to allow {@link PlannerExpression}s to rewrite their own\n+ * graph representation.\n+ *\n+ * This interface allows a {@link PlannerExpression} to create/modify low level planner graph structures while\n+ * a planner graph is created through an expression walk in {@link PlannerGraphProperty}. Such a rewrite can be useful\n+ * if the standard representation is confusing, misleading or just too complicated. For instance,\n+ * {@link com.apple.foundationdb.record.query.plan.plans.RecordQueryPlanWithIndex} additionally creates a separate\n+ * node underneath the actual plan operator to show the index as a record producer. The nature of the rewrite is\n+ * highly operator-specific, therefore, the rewrite is no part of the visitor or some other common logic.\n+ * Expressions that decide to implement this interface must then implement {@link #rewritePlannerGraph} to do the\n+ * actual rewrite.\n+ *\n+ * Implementors of this interface will be asked to rewrite the planner graph for both internal show as well as", "originalCommit": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1MjY5NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r424052695", "bodyText": "Fixed.", "author": "normen662", "createdAt": "2020-05-12T21:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk0MDAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk0MDc2MQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r423940761", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This package implements visual explain.\n          \n          \n            \n             * This package implements a visualization of a {@link RelationalExpression} as a graph for both internal debugging purposes and for consumption by end-users.", "author": "nschiefer", "createdAt": "2020-05-12T18:20:17Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/temp/explain/package-info.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * package-info.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/**\n+ * This package implements visual explain.", "originalCommit": "0da92a01028a896d068cff0b12d802a13b1c4f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1MzA1OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/929#discussion_r424053059", "bodyText": "Fixed.", "author": "normen662", "createdAt": "2020-05-12T21:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk0MDc2MQ=="}], "type": "inlineReview"}, {"oid": "0f10491b8db2d2f25c4013875c50e820cb184102", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/0f10491b8db2d2f25c4013875c50e820cb184102", "message": "Resolves #928: support edge ordering in planner graphs", "committedDate": "2020-05-12T22:12:50Z", "type": "commit"}, {"oid": "0f10491b8db2d2f25c4013875c50e820cb184102", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/0f10491b8db2d2f25c4013875c50e820cb184102", "message": "Resolves #928: support edge ordering in planner graphs", "committedDate": "2020-05-12T22:12:50Z", "type": "forcePushed"}, {"oid": "815983b613db74b40322cbea3cca73779f607c43", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/815983b613db74b40322cbea3cca73779f607c43", "message": "Fix a few typos.", "committedDate": "2020-05-12T22:18:42Z", "type": "commit"}]}