{"pr_number": 961, "pr_title": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "pr_createdAt": "2020-06-11T21:21:50Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/961", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwMzIzNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439103234", "bodyText": "This method is only called if one wants to add a conflict range over all records, so it should essentially never be called. I'm surprised it's showing up in your profiling. Maybe it doesn't hurt to also optimize it in this way.", "author": "alecgrieser", "createdAt": "2020-06-11T22:21:31Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2771,6 +2781,10 @@ public Range getUnbuiltRange() {\n      * Add a read conflict key for all records.\n      */\n     private void addRecordsReadConflict() {\n+        if (recordsReadConflict) {\n+            return;\n+        }\n+        recordsReadConflict = true;", "originalCommit": "40e40a9966f8b9e8fad2d79749a3cb51dca32c3c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNDQxNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439104414", "bodyText": "Should this be using a ConcurrentHashMap? I think multiple threads can access it at once. Because it's safe to set this multiple times for the same index, having this throw away the full hash map in certain race conditions seems fine, but I'm still worried about messing up internal state in the hash map if there are multiple accessors.", "author": "alecgrieser", "createdAt": "2020-06-11T22:25:04Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2784,6 +2798,14 @@ private void addIndexStateReadConflict(@Nonnull String indexName) {\n         if (!getRecordMetaData().hasIndex(indexName)) {\n             throw new MetaDataException(\"Index \" + indexName + \" does not exist in meta-data.\");\n         }\n+        if (indexStateReadConflicts == null) {\n+            indexStateReadConflicts = new HashSet<>(8);", "originalCommit": "40e40a9966f8b9e8fad2d79749a3cb51dca32c3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNzc1Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439107752", "bodyText": "Yeah, I debated.  I will modify.", "author": "jleach4", "createdAt": "2020-06-11T22:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNDQxNA=="}], "type": "inlineReview"}, {"oid": "d5f592ec0bd25aadb02fd712ab7f7faad544b66f", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/d5f592ec0bd25aadb02fd712ab7f7faad544b66f", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T22:51:29Z", "type": "forcePushed"}, {"oid": "fe1bb2230563c0e386b78790542fb6548b3f5b4f", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/fe1bb2230563c0e386b78790542fb6548b3f5b4f", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T22:58:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNTk3Nw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439115977", "bodyText": "Is there a reason this doesn't just set it to a ConcurrentHashMap in the constructor? We'll need to access this whenever we access an index, which will be essentially most things that interact with the store, so it seems like just initializing this in the constructor would be simpler and not much more expensive?", "author": "alecgrieser", "createdAt": "2020-06-11T23:00:11Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2784,6 +2798,14 @@ private void addIndexStateReadConflict(@Nonnull String indexName) {\n         if (!getRecordMetaData().hasIndex(indexName)) {\n             throw new MetaDataException(\"Index \" + indexName + \" does not exist in meta-data.\");\n         }\n+        if (indexStateReadConflicts == null) {\n+            indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);", "originalCommit": "fe1bb2230563c0e386b78790542fb6548b3f5b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNjQ1NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439116455", "bodyText": "Sure, let me fix.", "author": "jleach4", "createdAt": "2020-06-11T23:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNTk3Nw=="}], "type": "inlineReview"}, {"oid": "4ff53285192f0c6d24dcd1d15a379129e3345f2b", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/4ff53285192f0c6d24dcd1d15a379129e3345f2b", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T23:02:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODA1MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118050", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                @Nonnull", "author": "alecgrieser", "createdAt": "2020-06-11T23:06:49Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull\n+    private boolean recordsReadConflict;\n+\n+    @Nonnull\n+    private boolean storeStateReadConflict;\n+\n+    @Nullable", "originalCommit": "4ff53285192f0c6d24dcd1d15a379129e3345f2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODE3NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118175", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nonnull", "author": "alecgrieser", "createdAt": "2020-06-11T23:07:13Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull", "originalCommit": "4ff53285192f0c6d24dcd1d15a379129e3345f2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODIxOA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118218", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nonnull", "author": "alecgrieser", "createdAt": "2020-06-11T23:07:20Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull\n+    private boolean recordsReadConflict;\n+\n+    @Nonnull", "originalCommit": "4ff53285192f0c6d24dcd1d15a379129e3345f2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODI2MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118260", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Set<String> indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);\n          \n          \n            \n                private final Set<String> indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);", "author": "alecgrieser", "createdAt": "2020-06-11T23:07:29Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull\n+    private boolean recordsReadConflict;\n+\n+    @Nonnull\n+    private boolean storeStateReadConflict;\n+\n+    @Nullable\n+    private Set<String> indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);", "originalCommit": "4ff53285192f0c6d24dcd1d15a379129e3345f2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "20d78bdc5bf61dd0c849efd0fe6d7fb3fa387c4c", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/20d78bdc5bf61dd0c849efd0fe6d7fb3fa387c4c", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T23:31:26Z", "type": "forcePushed"}, {"oid": "5231ac92a01ecfbcb17e8bcb57a4572d73b9d083", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/5231ac92a01ecfbcb17e8bcb57a4572d73b9d083", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T23:32:21Z", "type": "commit"}, {"oid": "5231ac92a01ecfbcb17e8bcb57a4572d73b9d083", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/5231ac92a01ecfbcb17e8bcb57a4572d73b9d083", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T23:32:21Z", "type": "forcePushed"}]}