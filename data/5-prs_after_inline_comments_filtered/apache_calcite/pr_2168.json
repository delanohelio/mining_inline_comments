{"pr_number": 2168, "pr_title": "[CALCITE-4275] EnumerableMergeJoin#create does not set EnumerableConvention in the trait set", "pr_createdAt": "2020-09-24T10:51:28Z", "pr_url": "https://github.com/apache/calcite/pull/2168", "timeline": [{"oid": "f2111125c0a3c0b3b98cda73fd58cb11164b29cf", "url": "https://github.com/apache/calcite/commit/f2111125c0a3c0b3b98cda73fd58cb11164b29cf", "message": "[CALCITE-4275] EnumerableMergeJoin#create does not set EnumerableConvention in the trait set", "committedDate": "2020-09-24T10:59:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MjUzNg==", "url": "https://github.com/apache/calcite/pull/2168#discussion_r494282536", "bodyText": "Should this check be moved to EnumerableMergeJoin constructor?", "author": "vlsi", "createdAt": "2020-09-24T12:38:11Z", "path": "core/src/test/java/org/apache/calcite/test/RelMetadataTest.java", "diffHunk": "@@ -1618,20 +1619,23 @@ private void checkCollation(RelOptCluster cluster, RelOptTable empTable,\n     final EnumerableMergeJoin join;\n     join = EnumerableMergeJoin.create(project, deptSort,\n         rexBuilder.makeLiteral(true), leftKeys, rightKeys, JoinRelType.INNER);\n+    assertThat(join.getTraitSet().getConvention(), equalTo(EnumerableConvention.INSTANCE));", "originalCommit": "f2111125c0a3c0b3b98cda73fd58cb11164b29cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4NzU2Nw==", "url": "https://github.com/apache/calcite/pull/2168#discussion_r494287567", "bodyText": "Other similar operators (e.g. EnumerableHashJoin, EnumerableNestedLoopJoin, EnumerableBatchNestedLoopJoin) don't have this check in their constructors. In fact, it is not recommended to call these constructors directly (unless you know what you are doing) and they are not public, so I am ok with their current behavior of \"trusting\" the RelTraitSet parameter.\nOn the contrary, EnumerableMergeJoin#create method is public (as the other create methods in the other join operators), so it is its responsibility to create a valid traitSet bafore calling EnumerableMergeJoin's constructor.", "author": "rubenada", "createdAt": "2020-09-24T12:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4OTA2OQ==", "url": "https://github.com/apache/calcite/pull/2168#discussion_r494289069", "bodyText": "See \n  \n    \n      calcite/core/src/main/java/org/apache/calcite/adapter/enumerable/EnumerableCalc.java\n    \n    \n         Line 77\n      in\n      978bb7e\n    \n    \n    \n    \n\n        \n          \n           assert getConvention() instanceof EnumerableConvention; \n        \n    \n  \n\n and other assertions of that kind: https://github.com/apache/calcite/search?q=%22getConvention%28%29+instanceof+EnumerableConvention%22", "author": "vlsi", "createdAt": "2020-09-24T12:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwMzUwMw==", "url": "https://github.com/apache/calcite/pull/2168#discussion_r494303503", "bodyText": "Ok, I'm not against having the assertion in the constructor. I'll add it.", "author": "rubenada", "createdAt": "2020-09-24T13:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwNDg4NQ==", "url": "https://github.com/apache/calcite/pull/2168#discussion_r494304885", "bodyText": "Great. Then the assertion in the test won't be needed", "author": "vlsi", "createdAt": "2020-09-24T13:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwNjg0OA==", "url": "https://github.com/apache/calcite/pull/2168#discussion_r494306848", "bodyText": "I'd prefer to keep it in the unit test, so that we can detect any potential regression in the future.\nAlso, I like the idea of systematically adding a new test scenario every time we encounter an issue.", "author": "rubenada", "createdAt": "2020-09-24T13:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxOTA3MA==", "url": "https://github.com/apache/calcite/pull/2168#discussion_r494319070", "bodyText": "Assertion added to EnumerableMergeJoin's constructor.", "author": "rubenada", "createdAt": "2020-09-24T13:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0OTU5MQ==", "url": "https://github.com/apache/calcite/pull/2168#discussion_r494349591", "bodyText": "I think we do not need to duplicate logic though.\nFor instance, if the method receives String, then we don't need to add a test that tries to pass Integer there.\nThe assertion in the constructor covers all the possible ways to create EnumerableMergeJoin, so it is more-or-less enough from my point of view.", "author": "vlsi", "createdAt": "2020-09-24T14:07:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2Mzg0OQ==", "url": "https://github.com/apache/calcite/pull/2168#discussion_r494363849", "bodyText": "Ok, I don't mind removing the check from the test. I just want this fix merged before next release.", "author": "rubenada", "createdAt": "2020-09-24T14:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2OTgxMg==", "url": "https://github.com/apache/calcite/pull/2168#discussion_r494369812", "bodyText": "Done.", "author": "rubenada", "createdAt": "2020-09-24T14:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MjUzNg=="}], "type": "inlineReview"}, {"oid": "28fcdb80f4ba61f0e471a8c8673d114a734f002c", "url": "https://github.com/apache/calcite/commit/28fcdb80f4ba61f0e471a8c8673d114a734f002c", "message": "[CALCITE-4275] EnumerableMergeJoin#create does not set EnumerableConvention in the trait set", "committedDate": "2020-09-24T13:17:49Z", "type": "forcePushed"}, {"oid": "25e3b1cad2151710fee794533a67223767fbebbd", "url": "https://github.com/apache/calcite/commit/25e3b1cad2151710fee794533a67223767fbebbd", "message": "[CALCITE-4275] EnumerableMergeJoin#create does not set EnumerableConvention in the trait set", "committedDate": "2020-09-24T14:33:01Z", "type": "commit"}, {"oid": "25e3b1cad2151710fee794533a67223767fbebbd", "url": "https://github.com/apache/calcite/commit/25e3b1cad2151710fee794533a67223767fbebbd", "message": "[CALCITE-4275] EnumerableMergeJoin#create does not set EnumerableConvention in the trait set", "committedDate": "2020-09-24T14:33:01Z", "type": "forcePushed"}]}