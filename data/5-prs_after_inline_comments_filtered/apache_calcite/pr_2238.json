{"pr_number": 2238, "pr_title": "[CALCITE-4364] `a IN (1, 2) AND a = 1` should be simplified to `a = 1`", "pr_createdAt": "2020-10-30T11:19:41Z", "pr_url": "https://github.com/apache/calcite/pull/2238", "timeline": [{"oid": "ba956b3f40a1728df67ea411f1192a0486dfccd5", "url": "https://github.com/apache/calcite/commit/ba956b3f40a1728df67ea411f1192a0486dfccd5", "message": "[CALCITE-4364] `a in (1, 2) and a = 1` should be simplified to `a=1`", "committedDate": "2020-11-02T07:09:20Z", "type": "forcePushed"}, {"oid": "306544af0108b196d26e36eadb9c9d1161c87d20", "url": "https://github.com/apache/calcite/commit/306544af0108b196d26e36eadb9c9d1161c87d20", "message": "[CALCITE-4364] `a in (1, 2) and a = 1` should be simplified to `a=1`", "committedDate": "2020-11-02T07:13:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyODE1OQ==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r516228159", "bodyText": "s/Checks/Returns/; \"Checks\" often means that the method will throw if the check fails, whereas \"Returns\" is unambiguous.\nPut the criteria in the javadoc, and describe the purpose of newTermsCnt.\nI wouldn't abbreviate count to cnt. Save to characters, but convert a word into a non-word.", "author": "julianhyde", "createdAt": "2020-11-02T20:13:35Z", "path": "core/src/main/java/org/apache/calcite/rex/RexSimplify.java", "diffHunk": "@@ -2710,6 +2710,16 @@ private boolean accept1(RexNode e, SqlKind kind,\n       }\n     }\n \n+    /** Checks whether it is worth to fix and convert to {@code SEARCH} calls. */", "originalCommit": "306544af0108b196d26e36eadb9c9d1161c87d20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMjg2NQ==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r516232865", "bodyText": "Streams are cool but they are very expensive.\nProbably we are in some hot path here.\nIs it worth to use a simple loop?", "author": "eolivelli", "createdAt": "2020-11-02T20:23:07Z", "path": "core/src/main/java/org/apache/calcite/rex/RexSimplify.java", "diffHunk": "@@ -2710,6 +2710,16 @@ private boolean accept1(RexNode e, SqlKind kind,\n       }\n     }\n \n+    /** Checks whether it is worth to fix and convert to {@code SEARCH} calls. */\n+    boolean needToFix(int newTermsCnt) {\n+      // Fix and converts to SEARCH if:\n+      // 1. A Sarg has complexity greater than 1;\n+      // 2. The terms are reduced as simpler Sarg points.\n+      return map.values().stream().anyMatch(b -> b.complexity() > 1)", "originalCommit": "306544af0108b196d26e36eadb9c9d1161c87d20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNzg3Nw==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r516407877", "bodyText": "+1 for this suggestion.\nBy using a simple loop, we can combine the two stream expressions?\nIn addition, checking condition newTermsCnt == 1 is cheap, can we move it forward?", "author": "liyafan82", "createdAt": "2020-11-03T03:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMjg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNDM3Mg==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r517834372", "bodyText": "Sorry i found that it is hard to keep the decision branches in just one for loop and make the logic clear and clean. So i would not follow that.", "author": "danny0405", "createdAt": "2020-11-05T07:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMjg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0NjY4Mg==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r516246682", "bodyText": "What if we always convert to sarg format? Are there drawbacks?", "author": "vlsi", "createdAt": "2020-11-02T20:51:23Z", "path": "core/src/main/java/org/apache/calcite/rex/RexSimplify.java", "diffHunk": "@@ -1330,7 +1330,7 @@ RexNode simplifyAnd(RexCall e, RexUnknownAs unknownAs) {\n \n     final SargCollector sargCollector = new SargCollector(rexBuilder, true);\n     operands.forEach(t -> sargCollector.accept(t, terms));\n-    if (sargCollector.map.values().stream().anyMatch(b -> b.complexity() > 1)) {\n+    if (sargCollector.needToFix(terms.size())) {", "originalCommit": "306544af0108b196d26e36eadb9c9d1161c87d20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNzc2OA==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r516407768", "bodyText": "The drawback is there are many unnecessary plan change.", "author": "danny0405", "createdAt": "2020-11-03T03:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0NjY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc0MzAxOQ==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r516743019", "bodyText": "What do you mean unnecessary plan change?\nDo you mean plan changes when compared with 1.25 or 1.26?\nI guess 1.26 is not really viable (since there are significant issues with Sarg), so I would skip 1.26 from consideration with regard to plan changes.", "author": "vlsi", "createdAt": "2020-11-03T15:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0NjY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NjU1MQ==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r517056551", "bodyText": "For example, a simple $0=1 would be converted to Sarg which is meaningless.", "author": "danny0405", "createdAt": "2020-11-04T01:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0NjY4Mg=="}], "type": "inlineReview"}, {"oid": "eec59546357c771ce4b2836f32895fb51aad08c4", "url": "https://github.com/apache/calcite/commit/eec59546357c771ce4b2836f32895fb51aad08c4", "message": "[CALCITE-4364] `a in (1, 2) and a = 1` should be simplified to `a=1`", "committedDate": "2020-11-03T03:05:18Z", "type": "forcePushed"}, {"oid": "d5f20ffff275811d36f579256e9bfcc18db52b20", "url": "https://github.com/apache/calcite/commit/d5f20ffff275811d36f579256e9bfcc18db52b20", "message": "[CALCITE-4364] `a in (1, 2) and a = 1` should be simplified to `a=1`", "committedDate": "2020-11-03T03:07:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwODIwOQ==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r516408209", "bodyText": "Maybe we need another test case:\ndeptno in (20, 10) and deptno = 30\n==> false?", "author": "liyafan82", "createdAt": "2020-11-03T03:18:18Z", "path": "core/src/test/java/org/apache/calcite/rex/RexProgramTest.java", "diffHunk": "@@ -1774,6 +1770,17 @@ private void checkExponentialCnf(int n) {\n     checkSimplify2(e, \"SEARCH(?0.int0, Sarg[10])\", \"=(?0.int0, 10)\");\n   }\n \n+  @Test void testSimplifyInAnd() {", "originalCommit": "d5f20ffff275811d36f579256e9bfcc18db52b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6954d69dd8a333e54f679abb8dd841251a114678", "url": "https://github.com/apache/calcite/commit/6954d69dd8a333e54f679abb8dd841251a114678", "message": "[CALCITE-4364] `a in (1, 2) and a = 1` should be simplified to `a=1`", "committedDate": "2020-11-03T06:00:16Z", "type": "forcePushed"}, {"oid": "c1ff54ffa7ec2d05cf58ad24a156d7a79bbbebbd", "url": "https://github.com/apache/calcite/commit/c1ff54ffa7ec2d05cf58ad24a156d7a79bbbebbd", "message": "[CALCITE-4364] `a in (1, 2) and a = 1` should be simplified to `a=1`", "committedDate": "2020-11-03T06:57:25Z", "type": "forcePushed"}, {"oid": "4c5ca3165ead471656fa8c3f401132cba469f6bb", "url": "https://github.com/apache/calcite/commit/4c5ca3165ead471656fa8c3f401132cba469f6bb", "message": "[CALCITE-4364] `a IN (1, 2) AND a = 1` should be simplified to `a = 1`", "committedDate": "2020-11-03T06:58:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMxMzU4Mg==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r517313582", "bodyText": "I find deptno > 0 or deptno in (20, 10) can' t be simplified as deptno > 0", "author": "godfreyhe", "createdAt": "2020-11-04T12:38:19Z", "path": "core/src/test/java/org/apache/calcite/rex/RexProgramTest.java", "diffHunk": "@@ -1774,6 +1770,27 @@ private void checkExponentialCnf(int n) {\n     checkSimplify2(e, \"SEARCH(?0.int0, Sarg[10])\", \"=(?0.int0, 10)\");\n   }\n \n+  @Test void testSimplifyInAnd() {\n+    // deptno in (20, 10) and deptno = 10\n+    //   ==>\n+    // deptno = 10\n+    checkSimplify2(\n+        and(\n+            in(vInt(), literal(20), literal(10)),\n+            eq(vInt(), literal(10))),\n+        \"SEARCH(?0.int0, Sarg[10])\",\n+        \"=(?0.int0, 10)\");\n+\n+    // deptno in (20, 10) and deptno = 30\n+    //   ==>\n+    // false\n+    checkSimplify(\n+        and(\n+        in(vInt(), literal(20), literal(10)),\n+        eq(vInt(), literal(30))),\n+        \"false\");\n+  }\n+", "originalCommit": "4c5ca3165ead471656fa8c3f401132cba469f6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzMTQ2Mw==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r517831463", "bodyText": "Thanks, i have updated the test case.", "author": "danny0405", "createdAt": "2020-11-05T07:08:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMxMzU4Mg=="}], "type": "inlineReview"}, {"oid": "061ba0acc3a47ba8cfeba6256f4c1353697e1270", "url": "https://github.com/apache/calcite/commit/061ba0acc3a47ba8cfeba6256f4c1353697e1270", "message": "[CALCITE-4364]  should be simplified to", "committedDate": "2020-11-05T07:01:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NTI4OA==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r517845288", "bodyText": "An improvement change.", "author": "danny0405", "createdAt": "2020-11-05T07:41:45Z", "path": "core/src/test/java/org/apache/calcite/rex/RexProgramTest.java", "diffHunk": "@@ -1475,11 +1476,11 @@ private void checkExponentialCnf(int n) {\n             ne(aRef, literal4)),\n         \"<>(?0.a, 4)\");\n \n-    // \"b <> 1 or b = 1\" cannot be simplified, because b might be null\n+    // \"b <> 1 or b = 1\" ==> \"b is not null\" with unknown as false\n     final RexNode neOrEq =\n         or(ne(bRef, literal(1)),\n             eq(bRef, literal(1)));\n-    checkSimplifyFilter(neOrEq, \"OR(<>(?0.b, 1), =(?0.b, 1))\");\n+    checkSimplifyFilter(neOrEq, \"SEARCH(?0.b, Sarg[NOT NULL])\");", "originalCommit": "061ba0acc3a47ba8cfeba6256f4c1353697e1270", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NTQwOQ==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r517845409", "bodyText": "An improvement change.", "author": "danny0405", "createdAt": "2020-11-05T07:41:57Z", "path": "core/src/test/java/org/apache/calcite/rex/RexProgramTest.java", "diffHunk": "@@ -1846,7 +1880,7 @@ private void checkExponentialCnf(int n) {\n                 and(\n                     ge(vInt(), literal(1)),\n                     le(vInt(), literal(1))))),\n-        \"AND(=(?0.int2, 2), OR(=(?0.int3, 3), AND(>=(?0.int0, 1), <=(?0.int0, 1))))\",\n+        \"AND(=(?0.int2, 2), OR(=(?0.int3, 3), SEARCH(?0.int0, Sarg[1])))\",\n         \"AND(=(?0.int2, 2), OR(=(?0.int3, 3), =(?0.int0, 1)))\");", "originalCommit": "061ba0acc3a47ba8cfeba6256f4c1353697e1270", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2d3554fa4cc467ba4bb8c4982c2bf234f9254ded", "url": "https://github.com/apache/calcite/commit/2d3554fa4cc467ba4bb8c4982c2bf234f9254ded", "message": "[CALCITE-4364] `a IN (1, 2) AND a = 1` should be simplified to `a = 1`", "committedDate": "2020-11-05T08:33:37Z", "type": "forcePushed"}, {"oid": "8158ca3e5ef4f6401ae75cf671d43e59fa1a4ac1", "url": "https://github.com/apache/calcite/commit/8158ca3e5ef4f6401ae75cf671d43e59fa1a4ac1", "message": "[CALCITE-4364] `a IN (1, 2) AND a = 1` should be simplified to `a = 1`", "committedDate": "2020-11-06T03:39:37Z", "type": "forcePushed"}, {"oid": "d36d91a6c09b4fddc7694b16c4554e9b1cce2999", "url": "https://github.com/apache/calcite/commit/d36d91a6c09b4fddc7694b16c4554e9b1cce2999", "message": "[CALCITE-4364] `a IN (1, 2) AND a = 1` should be simplified to `a = 1`", "committedDate": "2020-11-06T06:33:42Z", "type": "forcePushed"}, {"oid": "74ec77a6639b15a54c695ff4ee3a84dc9c61d8c6", "url": "https://github.com/apache/calcite/commit/74ec77a6639b15a54c695ff4ee3a84dc9c61d8c6", "message": "[CALCITE-4364] `a IN (1, 2) AND a = 1` should be simplified to `a = 1`", "committedDate": "2020-11-06T06:38:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzOTQ4Ng==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r520039486", "bodyText": "Will throw if ranges.isEmpty() because you iterate before you check size. Add a test where this is called on an empty range set.", "author": "julianhyde", "createdAt": "2020-11-09T18:50:29Z", "path": "core/src/main/java/org/apache/calcite/util/RangeSets.java", "diffHunk": "@@ -128,6 +129,14 @@ private RangeSets() {}\n         && !range.isEmpty();\n   }\n \n+  /** Returns whether a range set is a single open interval. */\n+  public static <C extends Comparable<C>> boolean isOpenInterval(RangeSet<C> rangeSet) {\n+    final Set<Range<C>> ranges = rangeSet.asRanges();\n+    final Range<C> range = ranges.iterator().next();\n+    return ranges.size() == 1", "originalCommit": "74ec77a6639b15a54c695ff4ee3a84dc9c61d8c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3NjkzMg==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r520276932", "bodyText": "Agree, have added the tests.", "author": "danny0405", "createdAt": "2020-11-10T04:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzOTQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MTE0NA==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r520041144", "bodyText": "There is no objective definition of 'simple'. I would claim that 'x <> 5' is simple, and so is 'x IS NOT NULL'. You might disagree.\nSo, this method doesn't belong on Sarg. It belongs in whichever piece of code needs a particular definition of 'simple'.", "author": "julianhyde", "createdAt": "2020-11-09T18:53:13Z", "path": "core/src/main/java/org/apache/calcite/util/Sarg.java", "diffHunk": "@@ -170,6 +170,14 @@ public boolean isComplementedPoints() {\n             .allMatch(RangeSets::isPoint);\n   }\n \n+  /**\n+   * Returns whether this Sarg can be expanded to more simple form, e.g.\n+   * the IN call or single comparison.\n+   */\n+  public boolean isSimple() {", "originalCommit": "74ec77a6639b15a54c695ff4ee3a84dc9c61d8c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MzUyOA==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r520043528", "bodyText": "Do you think we should flatten those ANDs in AND(AND(>($0, 0), <($0, 10)), IS NOT NULL($1))? I know it might be difficult to achieve efficiently.", "author": "julianhyde", "createdAt": "2020-11-09T18:57:02Z", "path": "core/src/test/java/org/apache/calcite/rex/RexProgramTest.java", "diffHunk": "@@ -1687,10 +1687,8 @@ private void checkExponentialCnf(int n) {\n         isNotNull(bRef));\n     // [CALCITE-4352] causes \"and b is not null\" to disappear from the expanded\n     // form.\n-    final String simplified = \"AND(SEARCH($0, Sarg[(0..10)]),\"\n-        + \" SEARCH($1, Sarg[NOT NULL]))\";\n-    final String expanded =\n-        \"AND(AND(>($0, 0), <($0, 10)), IS NOT NULL($1))\";\n+    final String simplified = \"AND(SEARCH($0, Sarg[(0..10)]), IS NOT NULL($1))\";\n+    final String expanded = \"AND(AND(>($0, 0), <($0, 10)), IS NOT NULL($1))\";\n     checkSimplify(expr, simplified)", "originalCommit": "74ec77a6639b15a54c695ff4ee3a84dc9c61d8c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3NjM1OQ==", "url": "https://github.com/apache/calcite/pull/2238#discussion_r520276359", "bodyText": "I agree, have promoted it in the new commit.", "author": "danny0405", "createdAt": "2020-11-10T04:18:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MzUyOA=="}], "type": "inlineReview"}, {"oid": "117c44e470e02dc45a73c8d1aeb9248ac0fa8a23", "url": "https://github.com/apache/calcite/commit/117c44e470e02dc45a73c8d1aeb9248ac0fa8a23", "message": "[CALCITE-4364] `a IN (1, 2) AND a = 1` should be simplified to `a = 1`", "committedDate": "2020-11-12T04:08:15Z", "type": "commit"}, {"oid": "117c44e470e02dc45a73c8d1aeb9248ac0fa8a23", "url": "https://github.com/apache/calcite/commit/117c44e470e02dc45a73c8d1aeb9248ac0fa8a23", "message": "[CALCITE-4364] `a IN (1, 2) AND a = 1` should be simplified to `a = 1`", "committedDate": "2020-11-12T04:08:15Z", "type": "forcePushed"}]}