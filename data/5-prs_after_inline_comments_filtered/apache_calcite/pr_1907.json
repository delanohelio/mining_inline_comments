{"pr_number": 1907, "pr_title": "[CALCITE-3909] RelMdMinRowCount doesn't take into account UNION DISTINCT", "pr_createdAt": "2020-04-10T11:59:23Z", "pr_url": "https://github.com/apache/calcite/pull/1907", "timeline": [{"oid": "90f80217df580cc62b8807bcc5c2c821323f9f43", "url": "https://github.com/apache/calcite/commit/90f80217df580cc62b8807bcc5c2c821323f9f43", "message": "[CALCITE-3909] RelMdMinRowCount doesn't take into account UNION DISTINCT", "committedDate": "2020-04-10T12:05:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk3MDEwMg==", "url": "https://github.com/apache/calcite/pull/1907#discussion_r406970102", "bodyText": "@chunweilei  If I understand correctly this is basically trying to find the input with least number of rows, and that number is being used as minimum row count. If so then this looks wrong, because minimum number of rows for UNION DISTINCT will be 1 since the input with least number of rows can have all duplicates in which case only one row will be returned.", "author": "vineetgarg02", "createdAt": "2020-04-10T22:34:18Z", "path": "core/src/main/java/org/apache/calcite/rel/metadata/RelMdMinRowCount.java", "diffHunk": "@@ -54,14 +54,31 @@\n   }\n \n   public Double getMinRowCount(Union rel, RelMetadataQuery mq) {\n-    double rowCount = 0.0;\n-    for (RelNode input : rel.getInputs()) {\n-      Double partialRowCount = mq.getMinRowCount(input);\n-      if (partialRowCount != null) {\n-        rowCount += partialRowCount;\n+    if (rel.all) {\n+      double rowCount = 0.0;\n+      for (RelNode input : rel.getInputs()) {\n+        Double partialRowCount = mq.getMinRowCount(input);\n+        if (partialRowCount != null) {\n+          rowCount += partialRowCount;\n+        }\n+      }\n+      return rowCount;\n+    } else {\n+      boolean valid = false;\n+      double rowCount = Double.POSITIVE_INFINITY;\n+      for (RelNode input : rel.getInputs()) {\n+        Double partialRowCount = mq.getMinRowCount(input);\n+        if (partialRowCount != null && rowCount > partialRowCount) {\n+          rowCount = partialRowCount;", "originalCommit": "90f80217df580cc62b8807bcc5c2c821323f9f43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzAwNDI1NQ==", "url": "https://github.com/apache/calcite/pull/1907#discussion_r407004255", "bodyText": "Good point! PR was updated.", "author": "chunweilei", "createdAt": "2020-04-11T02:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk3MDEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk3MDUwOA==", "url": "https://github.com/apache/calcite/pull/1907#discussion_r406970508", "bodyText": "select x from values ('a', 'a') UNION DISTINCT select x from values ('a', 'a') should produce one row right?", "author": "vineetgarg02", "createdAt": "2020-04-10T22:36:07Z", "path": "core/src/test/java/org/apache/calcite/test/RelMetadataTest.java", "diffHunk": "@@ -614,6 +614,13 @@ private void checkExchangeRowCount(RelNode rel, double expected, double expected\n     checkRowCount(sql, EMP_SIZE + DEPT_SIZE, 0D, 140D);\n   }\n \n+  @Test void testRowCountUnionDistinct() {\n+    final String sql = \"select x from (values 'a', 'b') as t(x)\\n\"", "originalCommit": "90f80217df580cc62b8807bcc5c2c821323f9f43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzAxMzQyNg==", "url": "https://github.com/apache/calcite/pull/1907#discussion_r407013426", "bodyText": "return min(rowCount, 1d);", "author": "hsyuan", "createdAt": "2020-04-11T03:56:22Z", "path": "core/src/main/java/org/apache/calcite/rel/metadata/RelMdMinRowCount.java", "diffHunk": "@@ -61,7 +61,16 @@ public Double getMinRowCount(Union rel, RelMetadataQuery mq) {\n         rowCount += partialRowCount;\n       }\n     }\n-    return rowCount;\n+\n+    if (rel.all) {\n+      return rowCount;\n+    } else {\n+      if (rowCount < 1) {\n+        return rowCount;\n+      } else {\n+        return 1d;\n+      }", "originalCommit": "7b80d79f8c05e5f3f71bb6aea1c7b440fa54060b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d2511690445c4771108f06a0376c4c627b9c9f70", "url": "https://github.com/apache/calcite/commit/d2511690445c4771108f06a0376c4c627b9c9f70", "message": "[CALCITE-3909] RelMdMinRowCount doesn't take into account UNION DISTINCT", "committedDate": "2020-04-12T03:09:02Z", "type": "commit"}, {"oid": "d2511690445c4771108f06a0376c4c627b9c9f70", "url": "https://github.com/apache/calcite/commit/d2511690445c4771108f06a0376c4c627b9c9f70", "message": "[CALCITE-3909] RelMdMinRowCount doesn't take into account UNION DISTINCT", "committedDate": "2020-04-12T03:09:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMwMDg1Mg==", "url": "https://github.com/apache/calcite/pull/1907#discussion_r407300852", "bodyText": "Maybe there is a potential improvement here: if rel.all == false, and once we find the current value of rowCount greater than 1d, we can stop the loop early and directly return 1d.\nIt also makes the code less readable, so I am not sure if it is worth it.", "author": "liyafan82", "createdAt": "2020-04-13T03:32:39Z", "path": "core/src/main/java/org/apache/calcite/rel/metadata/RelMdMinRowCount.java", "diffHunk": "@@ -61,7 +61,12 @@ public Double getMinRowCount(Union rel, RelMetadataQuery mq) {\n         rowCount += partialRowCount;\n       }\n     }\n-    return rowCount;\n+\n+    if (rel.all) {\n+      return rowCount;\n+    } else {\n+      return Math.min(rowCount, 1d);\n+    }", "originalCommit": "d2511690445c4771108f06a0376c4c627b9c9f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMxODAzMA==", "url": "https://github.com/apache/calcite/pull/1907#discussion_r407318030", "bodyText": "Considering there would not be a huge overhead, I prefer it more readable.", "author": "chunweilei", "createdAt": "2020-04-13T04:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMwMDg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQzNjAzMw==", "url": "https://github.com/apache/calcite/pull/1907#discussion_r407436033", "bodyText": "Sounds reasonable.", "author": "liyafan82", "createdAt": "2020-04-13T11:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMwMDg1Mg=="}], "type": "inlineReview"}]}