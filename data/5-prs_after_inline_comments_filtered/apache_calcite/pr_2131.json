{"pr_number": 2131, "pr_title": "[CALCITE-4208] Improve metadata row count for Join", "pr_createdAt": "2020-09-02T08:48:03Z", "pr_url": "https://github.com/apache/calcite/pull/2131", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5NDgxOQ==", "url": "https://github.com/apache/calcite/pull/2131#discussion_r482294819", "bodyText": "(1D - selectivity) * left/right to estimate the number of row,null tuple makes sense (although it relies on a good estimation on selectivity, which usually is a hard engineering problem :-))", "author": "amaliujia", "createdAt": "2020-09-02T18:41:59Z", "path": "core/src/main/java/org/apache/calcite/rel/metadata/RelMdUtil.java", "diffHunk": "@@ -731,19 +734,22 @@ public static Double getJoinRowCount(RelMetadataQuery mq, Join join,\n         return max;\n       }\n     }\n-    double product = left * right;\n-\n-    return product * mq.getSelectivity(join, condition);\n-  }\n \n-  /** Returns an estimate of the number of rows returned by a semi-join. */\n-  public static Double getSemiJoinRowCount(RelMetadataQuery mq, RelNode left,\n-      RelNode right, JoinRelType joinType, RexNode condition) {\n-    final Double leftCount = mq.getRowCount(left);\n-    if (leftCount == null) {\n-      return null;\n+    double product = left * right;\n+    double selectivity = mq.getSelectivity(join, condition);\n+    double innerRowCount = product * selectivity;\n+    switch (join.getJoinType()) {\n+    case INNER:\n+      return innerRowCount;\n+    case LEFT:\n+      return left * (1D - selectivity) + innerRowCount;\n+    case RIGHT:\n+      return right * (1D - selectivity) + innerRowCount;", "originalCommit": "e815159c5592b54831d25d16b0066131305b9c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc1NzE2Mw==", "url": "https://github.com/apache/calcite/pull/2131#discussion_r482757163", "bodyText": "I agree. IMHO the proposed formula is far from perfect and depends on how good (or bad) is the selectivity estimation, but I think it is a bit better than the current formula.", "author": "rubenada", "createdAt": "2020-09-03T07:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5NDgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc1OTU4MA==", "url": "https://github.com/apache/calcite/pull/2131#discussion_r482759580", "bodyText": "agreed. I think your change indeed is better.", "author": "amaliujia", "createdAt": "2020-09-03T07:18:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5NDgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5NjcxOA==", "url": "https://github.com/apache/calcite/pull/2131#discussion_r482296718", "bodyText": "From the name of I am thinking this test intended to test empty join right? (now it is changed to test left join empty?", "author": "amaliujia", "createdAt": "2020-09-02T18:44:06Z", "path": "core/src/test/java/org/apache/calcite/test/RelMetadataTest.java", "diffHunk": "@@ -596,11 +596,11 @@ private void checkExchangeRowCount(RelNode rel, double expected, double expected\n   }\n \n   @Test void testRowCountRightJoinEmptyFinite() {\n-    final String sql = \"select * from (select * from emp limit 0) as emp\\n\"\n-        + \"right join (select * from dept limit 4) as dept\\n\"\n+    final String sql = \"select * from (select * from emp limit 4) as emp\\n\"\n+        + \"right join (select * from dept limit 0) as dept\\n\"\n         + \"on emp.deptno = dept.deptno\";\n     checkRowCount(sql, 1D, // 0, rounded up to row count's minimum 1\n-        0D, 4D); // 1 * 4\n+        0D, 0D); // 0 * 4", "originalCommit": "e815159c5592b54831d25d16b0066131305b9c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3MjIyNg==", "url": "https://github.com/apache/calcite/pull/2131#discussion_r482772226", "bodyText": "You're right, I have reviewed the test and added more cases", "author": "rubenada", "createdAt": "2020-09-03T07:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5NjcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2MDY1Mw==", "url": "https://github.com/apache/calcite/pull/2131#discussion_r482760653", "bodyText": "This would fail with NPE in case selectivity is null", "author": "vlsi", "createdAt": "2020-09-03T07:20:52Z", "path": "core/src/main/java/org/apache/calcite/rel/metadata/RelMdUtil.java", "diffHunk": "@@ -713,9 +714,11 @@ public static Double getJoinRowCount(RelMetadataQuery mq, Join join,\n       // semijoin filter and pass it to getSelectivity\n       RexNode semiJoinSelectivity =\n           RelMdUtil.makeSemiJoinSelectivityRexNode(mq, join);\n-\n+      Double selectivity = mq.getSelectivity(join.getLeft(), semiJoinSelectivity);\n       return NumberUtil.multiply(\n-          mq.getSelectivity(join.getLeft(), semiJoinSelectivity),\n+          join.getJoinType() == JoinRelType.SEMI\n+              ? selectivity\n+              : 1D - selectivity, // ANTI join", "originalCommit": "e815159c5592b54831d25d16b0066131305b9c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3MjI5NA==", "url": "https://github.com/apache/calcite/pull/2131#discussion_r482772294", "bodyText": "Fixed.", "author": "rubenada", "createdAt": "2020-09-03T07:41:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2MDY1Mw=="}], "type": "inlineReview"}, {"oid": "529c143229893c0072a89d897de43abd6823f66d", "url": "https://github.com/apache/calcite/commit/529c143229893c0072a89d897de43abd6823f66d", "message": "[CALCITE-4208] Improve metadata row count for Join", "committedDate": "2020-09-04T07:40:54Z", "type": "commit"}, {"oid": "529c143229893c0072a89d897de43abd6823f66d", "url": "https://github.com/apache/calcite/commit/529c143229893c0072a89d897de43abd6823f66d", "message": "[CALCITE-4208] Improve metadata row count for Join", "committedDate": "2020-09-04T07:40:54Z", "type": "forcePushed"}]}