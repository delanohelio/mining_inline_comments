{"pr_number": 1981, "pr_title": "[CALCITE-4000] Support OFFSET parameter in TUMBLE/HOP table functions\u2026", "pr_createdAt": "2020-05-16T04:19:44Z", "pr_url": "https://github.com/apache/calcite/pull/1981", "timeline": [{"oid": "19c9056ebe89cd50519cca2600c98069375d5385", "url": "https://github.com/apache/calcite/commit/19c9056ebe89cd50519cca2600c98069375d5385", "message": "[CALCITE-4000] Support OFFSET parameter in TUMBLE/HOP table functions (Rui Wang).", "committedDate": "2020-05-21T17:41:34Z", "type": "forcePushed"}, {"oid": "367558c72ab5ed93bf6d5bc4fbbddd0645372f33", "url": "https://github.com/apache/calcite/commit/367558c72ab5ed93bf6d5bc4fbbddd0645372f33", "message": "[CALCITE-4000] Support OFFSET parameter in TUMBLE/HOP table functions (Rui Wang).", "committedDate": "2020-06-25T20:30:13Z", "type": "forcePushed"}, {"oid": "0420edd93c6180f187ab838990bcb3c383777b83", "url": "https://github.com/apache/calcite/commit/0420edd93c6180f187ab838990bcb3c383777b83", "message": "[CALCITE-4000] Support OFFSET parameter in TUMBLE/HOP table functions (Rui Wang).", "committedDate": "2020-07-07T05:10:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ2OTYwOA==", "url": "https://github.com/apache/calcite/pull/1981#discussion_r453469608", "bodyText": "Can we simpilfy this logic as below? It may be more intuitive.\n// handle the optional offset parameter, use 0 as default when ...\nfinal Expression xxxExpression = call.getOperands().size() > 2 \n    ? translator.translate(call.getOperands().get(2))\n    : Expressions.constant(0, long.class);\ntranslatedOperands.add(xxxExpression);", "author": "DonnyZone", "createdAt": "2020-07-13T07:12:39Z", "path": "core/src/main/java/org/apache/calcite/adapter/enumerable/RexImpTable.java", "diffHunk": "@@ -3406,9 +3406,23 @@ abstract Expression implementSafe(RexToLixTranslator translator,\n       translatedOperands.add(wmColExpr);\n       translatedOperands.add(intervalExpression);\n \n-      return Expressions.call(BuiltInMethod.TUMBLING.method, inputEnumerable,\n-          EnumUtils.tumblingWindowSelector(inputPhysType, outputPhysType,\n-              translatedOperands.get(0), translatedOperands.get(1)));\n+      // handle the optional offset parameter.\n+      if (call.getOperands().size() > 2) {\n+        translatedOperands.add(translator.translate(call.getOperands().get(2)));\n+      } else {\n+        // use 0 for the default value when offset parameter is not set.", "originalCommit": "0420edd93c6180f187ab838990bcb3c383777b83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg4NjU1Mw==", "url": "https://github.com/apache/calcite/pull/1981#discussion_r453886553", "bodyText": "Done", "author": "amaliujia", "createdAt": "2020-07-13T19:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ2OTYwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ3MzAwMQ==", "url": "https://github.com/apache/calcite/pull/1981#discussion_r453473001", "bodyText": "Also here", "author": "DonnyZone", "createdAt": "2020-07-13T08:13:00Z", "path": "core/src/main/java/org/apache/calcite/adapter/enumerable/RexImpTable.java", "diffHunk": "@@ -3426,13 +3440,24 @@ abstract Expression implementSafe(RexToLixTranslator translator,\n       translatedOperands.add(slidingInterval);\n       translatedOperands.add(windowSize);\n \n-      return Expressions.call(BuiltInMethod.HOPPING.method,\n+\n+      // handle the optional offset parameter.\n+      if (call.getOperands().size() > 3) {\n+        translatedOperands.add(translator.translate(call.getOperands().get(3)));\n+      } else {\n+        // use 0 for the default value when offset parameter is missing.", "originalCommit": "0420edd93c6180f187ab838990bcb3c383777b83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg4NjUwOA==", "url": "https://github.com/apache/calcite/pull/1981#discussion_r453886508", "bodyText": "+1", "author": "amaliujia", "createdAt": "2020-07-13T19:38:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ3MzAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ3MzY0Nw==", "url": "https://github.com/apache/calcite/pull/1981#discussion_r453473647", "bodyText": "\"...a window size and an offset and return...\" -> \"a window size and an offset, and return\"", "author": "DonnyZone", "createdAt": "2020-07-13T08:14:59Z", "path": "core/src/main/java/org/apache/calcite/adapter/enumerable/EnumUtils.java", "diffHunk": "@@ -786,28 +787,29 @@ static Expression tumblingWindowSelector(\n     final Expression wmColExprToLong = EnumUtils.convert(wmColExpr, long.class);\n     final Expression shiftExpr = Expressions.constant(1, long.class);\n \n-    // Find the fixed window for a timestamp given a window size and return the window start.\n-    // Fixed windows counts from timestamp 0.\n-    // wmMillis / intervalMillis * intervalMillis\n-    expressions.add(\n-        Expressions.multiply(\n-            Expressions.divide(\n+    // Find the fixed window for a timestamp given a window size and an offset and return the", "originalCommit": "0420edd93c6180f187ab838990bcb3c383777b83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg4NjQ2OA==", "url": "https://github.com/apache/calcite/pull/1981#discussion_r453886468", "bodyText": "Done.", "author": "amaliujia", "createdAt": "2020-07-13T19:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ3MzY0Nw=="}], "type": "inlineReview"}, {"oid": "542ea9a71b5e801006ef1b084d73ecc0f89eade2", "url": "https://github.com/apache/calcite/commit/542ea9a71b5e801006ef1b084d73ecc0f89eade2", "message": "[CALCITE-4000] Support OFFSET parameter in TUMBLE/HOP table functions (Rui Wang)", "committedDate": "2020-07-13T19:34:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyNDQwMA==", "url": "https://github.com/apache/calcite/pull/1981#discussion_r454924400", "bodyText": "Is there any special reason we must use a list here to keep the translatedOperands ?", "author": "danny0405", "createdAt": "2020-07-15T09:39:50Z", "path": "core/src/main/java/org/apache/calcite/adapter/enumerable/RexImpTable.java", "diffHunk": "@@ -3406,9 +3406,22 @@ abstract Expression implementSafe(RexToLixTranslator translator,\n       translatedOperands.add(wmColExpr);\n       translatedOperands.add(intervalExpression);\n \n-      return Expressions.call(BuiltInMethod.TUMBLING.method, inputEnumerable,\n-          EnumUtils.tumblingWindowSelector(inputPhysType, outputPhysType,\n-              translatedOperands.get(0), translatedOperands.get(1)));\n+      // handle the optional offset parameter. Use 0 for the default value when offset\n+      // parameter is not set.\n+      final Expression offsetExpr = call.getOperands().size() > 2\n+          ? translator.translate(call.getOperands().get(2))\n+          : Expressions.constant(0, long.class);\n+      translatedOperands.add(offsetExpr);\n+\n+      return Expressions.call(\n+          BuiltInMethod.TUMBLING.method,\n+          inputEnumerable,\n+          EnumUtils.tumblingWindowSelector(\n+              inputPhysType,\n+              outputPhysType,\n+              translatedOperands.get(0),", "originalCommit": "542ea9a71b5e801006ef1b084d73ecc0f89eade2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIwNjQwNg==", "url": "https://github.com/apache/calcite/pull/1981#discussion_r455206406", "bodyText": "Ah I think translatedOperands might be easy to read. For example, it can be mapped to function signature. When I write such code, I tend to map parameters to offsets. WatermarkCol expression is the first parameter, then others. Maybe not everyone thinks in this way.\nI guess you are thinking why not directly use expressions? Either is fine to me.", "author": "amaliujia", "createdAt": "2020-07-15T17:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyNDQwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIyMDc2Mw==", "url": "https://github.com/apache/calcite/pull/1981#discussion_r455220763", "bodyText": "OK I have updated to remove the list for all three functions.", "author": "amaliujia", "createdAt": "2020-07-15T17:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyNDQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyOTIyMQ==", "url": "https://github.com/apache/calcite/pull/1981#discussion_r454929221", "bodyText": "wmMillis  -> wmColExprToLong", "author": "danny0405", "createdAt": "2020-07-15T09:47:57Z", "path": "core/src/main/java/org/apache/calcite/adapter/enumerable/EnumUtils.java", "diffHunk": "@@ -786,28 +787,29 @@ static Expression tumblingWindowSelector(\n     final Expression wmColExprToLong = EnumUtils.convert(wmColExpr, long.class);\n     final Expression shiftExpr = Expressions.constant(1, long.class);\n \n-    // Find the fixed window for a timestamp given a window size and return the window start.\n-    // Fixed windows counts from timestamp 0.\n-    // wmMillis / intervalMillis * intervalMillis\n-    expressions.add(\n-        Expressions.multiply(\n-            Expressions.divide(\n+    // Find the fixed window for a timestamp given a window size and an offset, and return the\n+    // window start.\n+    // wmMillis - (wmColExprToLong + windowSizeMillis - offsetMillis) % windowSizeMillis\n+    Expression windowStartExpr = Expressions.subtract(", "originalCommit": "542ea9a71b5e801006ef1b084d73ecc0f89eade2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "971513d406a0148ab739e16da6a9dfe5db4952be", "url": "https://github.com/apache/calcite/commit/971513d406a0148ab739e16da6a9dfe5db4952be", "message": "[CALCITE-4000] Support OFFSET parameter in TUMBLE/HOP table functions (Rui Wang)", "committedDate": "2020-07-15T18:49:05Z", "type": "forcePushed"}, {"oid": "4b41b1e617b53cccd768f6adbc829dba066a725e", "url": "https://github.com/apache/calcite/commit/4b41b1e617b53cccd768f6adbc829dba066a725e", "message": "[CALCITE-4000] Support OFFSET parameter in TUMBLE/HOP table functions. (Rui Wang)", "committedDate": "2020-07-15T21:54:30Z", "type": "forcePushed"}, {"oid": "5e3ebad2fca397cbed6a83736ed0dd18377b113e", "url": "https://github.com/apache/calcite/commit/5e3ebad2fca397cbed6a83736ed0dd18377b113e", "message": "[CALCITE-4000] Support OFFSET parameter in TUMBLE/HOP table functions (Rui Wang)", "committedDate": "2020-07-15T22:16:55Z", "type": "commit"}, {"oid": "5e3ebad2fca397cbed6a83736ed0dd18377b113e", "url": "https://github.com/apache/calcite/commit/5e3ebad2fca397cbed6a83736ed0dd18377b113e", "message": "[CALCITE-4000] Support OFFSET parameter in TUMBLE/HOP table functions (Rui Wang)", "committedDate": "2020-07-15T22:16:55Z", "type": "forcePushed"}]}