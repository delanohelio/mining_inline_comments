{"pr_number": 1462, "pr_title": "Gradle plugins to run Linkage Checker for Configurations", "pr_createdAt": "2020-06-10T16:36:13Z", "pr_url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462", "timeline": [{"oid": "4b69057c90c22331e86902f4c83a51e2c59537f9", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/4b69057c90c22331e86902f4c83a51e2c59537f9", "message": "Ignore gradle files created by IDE", "committedDate": "2020-06-10T16:01:54Z", "type": "commit"}, {"oid": "df3986a2abc6db1db8b9cc6d38fb996df878d806", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/df3986a2abc6db1db8b9cc6d38fb996df878d806", "message": "Example project to detect dependency conflicts", "committedDate": "2020-06-10T16:02:24Z", "type": "commit"}, {"oid": "f9c23273797b3b2354709af82e4918aecf22ad10", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/f9c23273797b3b2354709af82e4918aecf22ad10", "message": "Task to run Linkage Checker with dependencies", "committedDate": "2020-06-10T16:09:50Z", "type": "commit"}, {"oid": "ff40fb538d1a158f10fce6877069840c31822761", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/ff40fb538d1a158f10fce6877069840c31822761", "message": "message", "committedDate": "2020-06-10T16:26:19Z", "type": "commit"}, {"oid": "c9d4367c072c13b632ab73c456631a0669efa204", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/c9d4367c072c13b632ab73c456631a0669efa204", "message": "Merge remote-tracking branch 'origin/master' into gradle_linkage_checker", "committedDate": "2020-06-10T16:43:27Z", "type": "commit"}, {"oid": "e8855b8c4ded4dbfd1b3a868ea9d55c295d98b4b", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/e8855b8c4ded4dbfd1b3a868ea9d55c295d98b4b", "message": "TODO for reportOnlyReachable", "committedDate": "2020-06-10T16:47:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3Mzg0NA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438273844", "bodyText": "rewrite without continue", "author": "elharo", "createdAt": "2020-06-10T16:57:21Z", "path": "gradle-plugin/src/main/java/com/google/cloud/tools/dependencies/gradle/LinkageCheckTask.java", "diffHunk": "@@ -16,27 +16,109 @@\n \n package com.google.cloud.tools.dependencies.gradle;\n \n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.SymbolProblem;\n import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n import java.io.IOException;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n import org.gradle.api.DefaultTask;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.ModuleVersionIdentifier;\n+import org.gradle.api.artifacts.ResolvedArtifact;\n+import org.gradle.api.logging.Logger;\n import org.gradle.api.tasks.TaskAction;\n \n /**\n  * Task to run Linkage Checker for the dependencies of the Gradle project.\n  */\n public class LinkageCheckTask extends DefaultTask {\n+\n+  Logger logger;\n+\n   @TaskAction\n   public void run() throws IOException {\n+    logger = getLogger();\n+\n     LinkageCheckerPluginExtension extension =\n         getProject().getExtensions().findByType(LinkageCheckerPluginExtension.class);\n     if (extension == null) {\n       extension = new LinkageCheckerPluginExtension();\n     }\n \n-    // TODO(suztomo): run linkage checker for the dependencies of the Gradle project.\n-    String message = extension.getMessage();\n-    LinkageChecker linkageChecker = LinkageChecker.create(ImmutableList.of());\n-    System.out.println(\"Hello from \" + linkageChecker + \": \" + message);\n+    Project project = getProject();\n+    ImmutableSet.Builder<Configuration> configurationsBuilder = ImmutableSet.builder();\n+    if (extension.getConfigurations().isEmpty()) {\n+      // Should this default to runtime?\n+      logger.trace(\"No configuration specified, defaulting to all configurations\");\n+      for (Configuration configuration : project.getConfigurations()) {\n+        if (configuration.isCanBeResolved()) {\n+          configurationsBuilder.add(configuration);\n+        }\n+      }\n+    } else {\n+      for (String configurationName : extension.getConfigurations()) {\n+        Configuration configuration = project.getConfigurations().getByName(configurationName);\n+        if (configuration.isCanBeResolved()) {\n+          configurationsBuilder.add(configuration);\n+        }\n+      }\n+    }\n+\n+    ImmutableSet<Configuration> configurations = configurationsBuilder.build();\n+\n+    boolean foundError = false;\n+    for (Configuration configuration : configurations) {\n+      logger.info(\"Checking {}\", configuration);\n+      ImmutableList.Builder<ClassPathEntry> classPathBuilder = ImmutableList.builder();\n+\n+      // TODO(suztomo): Should this include optional dependencies?\n+      //  Once we decide what to do with the optional dependencies, let's revisit this logic.\n+      for (ResolvedArtifact resolvedArtifact :\n+          configuration.getResolvedConfiguration().getResolvedArtifacts()) {\n+        ModuleVersionIdentifier moduleVersionId = resolvedArtifact.getModuleVersion().getId();\n+        DefaultArtifact artifact =\n+            new DefaultArtifact(\n+                moduleVersionId.getGroup(),\n+                moduleVersionId.getName(),\n+                null,\n+                null,\n+                moduleVersionId.getVersion(),\n+                null,\n+                resolvedArtifact.getFile());\n+        classPathBuilder.add(new ClassPathEntry(artifact));\n+      }\n+\n+      ImmutableList<ClassPathEntry> classPath = classPathBuilder.build();\n+      if (classPath.isEmpty()) {\n+        // No artifact for this configuration", "originalCommit": "e8855b8c4ded4dbfd1b3a868ea9d55c295d98b4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI4ODYzNw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438288637", "bodyText": "Done.", "author": "suztomo", "createdAt": "2020-06-10T17:22:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3Mzg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3NDM2Mw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438274363", "bodyText": "There are three placeholders but only two placefillers", "author": "elharo", "createdAt": "2020-06-10T16:58:05Z", "path": "gradle-plugin/src/main/java/com/google/cloud/tools/dependencies/gradle/LinkageCheckTask.java", "diffHunk": "@@ -16,27 +16,109 @@\n \n package com.google.cloud.tools.dependencies.gradle;\n \n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.SymbolProblem;\n import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n import java.io.IOException;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n import org.gradle.api.DefaultTask;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.ModuleVersionIdentifier;\n+import org.gradle.api.artifacts.ResolvedArtifact;\n+import org.gradle.api.logging.Logger;\n import org.gradle.api.tasks.TaskAction;\n \n /**\n  * Task to run Linkage Checker for the dependencies of the Gradle project.\n  */\n public class LinkageCheckTask extends DefaultTask {\n+\n+  Logger logger;\n+\n   @TaskAction\n   public void run() throws IOException {\n+    logger = getLogger();\n+\n     LinkageCheckerPluginExtension extension =\n         getProject().getExtensions().findByType(LinkageCheckerPluginExtension.class);\n     if (extension == null) {\n       extension = new LinkageCheckerPluginExtension();\n     }\n \n-    // TODO(suztomo): run linkage checker for the dependencies of the Gradle project.\n-    String message = extension.getMessage();\n-    LinkageChecker linkageChecker = LinkageChecker.create(ImmutableList.of());\n-    System.out.println(\"Hello from \" + linkageChecker + \": \" + message);\n+    Project project = getProject();\n+    ImmutableSet.Builder<Configuration> configurationsBuilder = ImmutableSet.builder();\n+    if (extension.getConfigurations().isEmpty()) {\n+      // Should this default to runtime?\n+      logger.trace(\"No configuration specified, defaulting to all configurations\");\n+      for (Configuration configuration : project.getConfigurations()) {\n+        if (configuration.isCanBeResolved()) {\n+          configurationsBuilder.add(configuration);\n+        }\n+      }\n+    } else {\n+      for (String configurationName : extension.getConfigurations()) {\n+        Configuration configuration = project.getConfigurations().getByName(configurationName);\n+        if (configuration.isCanBeResolved()) {\n+          configurationsBuilder.add(configuration);\n+        }\n+      }\n+    }\n+\n+    ImmutableSet<Configuration> configurations = configurationsBuilder.build();\n+\n+    boolean foundError = false;\n+    for (Configuration configuration : configurations) {\n+      logger.info(\"Checking {}\", configuration);\n+      ImmutableList.Builder<ClassPathEntry> classPathBuilder = ImmutableList.builder();\n+\n+      // TODO(suztomo): Should this include optional dependencies?\n+      //  Once we decide what to do with the optional dependencies, let's revisit this logic.\n+      for (ResolvedArtifact resolvedArtifact :\n+          configuration.getResolvedConfiguration().getResolvedArtifacts()) {\n+        ModuleVersionIdentifier moduleVersionId = resolvedArtifact.getModuleVersion().getId();\n+        DefaultArtifact artifact =\n+            new DefaultArtifact(\n+                moduleVersionId.getGroup(),\n+                moduleVersionId.getName(),\n+                null,\n+                null,\n+                moduleVersionId.getVersion(),\n+                null,\n+                resolvedArtifact.getFile());\n+        classPathBuilder.add(new ClassPathEntry(artifact));\n+      }\n+\n+      ImmutableList<ClassPathEntry> classPath = classPathBuilder.build();\n+      if (classPath.isEmpty()) {\n+        // No artifact for this configuration\n+        continue;\n+      }\n+      // TODO(suztomo): Specify entry points if reportOnlyReachable is true.\n+      LinkageChecker linkageChecker = LinkageChecker.create(classPath);\n+\n+      ImmutableSetMultimap<SymbolProblem, ClassFile> symbolProblems =\n+          linkageChecker.findSymbolProblems();\n+\n+      int errorCount = symbolProblems.keySet().size();\n+\n+      // TODO(suztomo): Show the dependency paths to the problematic artifacts.\n+      logger.error(\n+          \"Linkage Checker rule found {} error{}. Linkage error report:\\n{}\",", "originalCommit": "e8855b8c4ded4dbfd1b3a868ea9d55c295d98b4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI4NzkyMA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438287920", "bodyText": "The 3 lines below are the 3 placefillers for the three {}.", "author": "suztomo", "createdAt": "2020-06-10T17:21:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3NDM2Mw=="}], "type": "inlineReview"}, {"oid": "8ca393f5be30e5eeec168eb74477835b7f044fc2", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/8ca393f5be30e5eeec168eb74477835b7f044fc2", "message": "removed continue", "committedDate": "2020-06-10T17:22:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0NzI2Ng==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438347266", "bodyText": "Linkage", "author": "elharo", "createdAt": "2020-06-10T19:06:14Z", "path": "gradle-plugin/src/main/java/com/google/cloud/tools/dependencies/gradle/LinkageCheckerPluginExtension.java", "diffHunk": "@@ -16,20 +16,33 @@\n \n package com.google.cloud.tools.dependencies.gradle;\n \n+import com.google.common.collect.ImmutableSet;\n+import java.util.List;\n+\n /**\n  * Properties to control the behavior of the Linakge Checker plugin.", "originalCommit": "8ca393f5be30e5eeec168eb74477835b7f044fc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQxNDQxOQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438414419", "bodyText": "Fixed", "author": "suztomo", "createdAt": "2020-06-10T21:19:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0NzI2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0Nzk5MQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438347991", "bodyText": "does this log if errorCount is zero?", "author": "elharo", "createdAt": "2020-06-10T19:07:34Z", "path": "gradle-plugin/src/main/java/com/google/cloud/tools/dependencies/gradle/LinkageCheckTask.java", "diffHunk": "@@ -16,27 +16,107 @@\n \n package com.google.cloud.tools.dependencies.gradle;\n \n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.SymbolProblem;\n import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n import java.io.IOException;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n import org.gradle.api.DefaultTask;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.ModuleVersionIdentifier;\n+import org.gradle.api.artifacts.ResolvedArtifact;\n+import org.gradle.api.logging.Logger;\n import org.gradle.api.tasks.TaskAction;\n \n /**\n  * Task to run Linkage Checker for the dependencies of the Gradle project.\n  */\n public class LinkageCheckTask extends DefaultTask {\n+\n+  Logger logger;\n+\n   @TaskAction\n   public void run() throws IOException {\n+    logger = getLogger();\n+\n     LinkageCheckerPluginExtension extension =\n         getProject().getExtensions().findByType(LinkageCheckerPluginExtension.class);\n     if (extension == null) {\n       extension = new LinkageCheckerPluginExtension();\n     }\n \n-    // TODO(suztomo): run linkage checker for the dependencies of the Gradle project.\n-    String message = extension.getMessage();\n-    LinkageChecker linkageChecker = LinkageChecker.create(ImmutableList.of());\n-    System.out.println(\"Hello from \" + linkageChecker + \": \" + message);\n+    Project project = getProject();\n+    ImmutableSet.Builder<Configuration> configurationsBuilder = ImmutableSet.builder();\n+    if (extension.getConfigurations().isEmpty()) {\n+      // Should this default to runtime?\n+      logger.trace(\"No configuration specified, defaulting to all configurations\");\n+      for (Configuration configuration : project.getConfigurations()) {\n+        if (configuration.isCanBeResolved()) {\n+          configurationsBuilder.add(configuration);\n+        }\n+      }\n+    } else {\n+      for (String configurationName : extension.getConfigurations()) {\n+        Configuration configuration = project.getConfigurations().getByName(configurationName);\n+        if (configuration.isCanBeResolved()) {\n+          configurationsBuilder.add(configuration);\n+        }\n+      }\n+    }\n+\n+    ImmutableSet<Configuration> configurations = configurationsBuilder.build();\n+\n+    boolean foundError = false;\n+    for (Configuration configuration : configurations) {\n+      logger.info(\"Checking {}\", configuration);\n+      ImmutableList.Builder<ClassPathEntry> classPathBuilder = ImmutableList.builder();\n+\n+      // TODO(suztomo): Should this include optional dependencies?\n+      //  Once we decide what to do with the optional dependencies, let's revisit this logic.\n+      for (ResolvedArtifact resolvedArtifact :\n+          configuration.getResolvedConfiguration().getResolvedArtifacts()) {\n+        ModuleVersionIdentifier moduleVersionId = resolvedArtifact.getModuleVersion().getId();\n+        DefaultArtifact artifact =\n+            new DefaultArtifact(\n+                moduleVersionId.getGroup(),\n+                moduleVersionId.getName(),\n+                null,\n+                null,\n+                moduleVersionId.getVersion(),\n+                null,\n+                resolvedArtifact.getFile());\n+        classPathBuilder.add(new ClassPathEntry(artifact));\n+      }\n+\n+      ImmutableList<ClassPathEntry> classPath = classPathBuilder.build();\n+      if (!classPath.isEmpty()) {\n+        // TODO(suztomo): Specify entry points if reportOnlyReachable is true.\n+        LinkageChecker linkageChecker = LinkageChecker.create(classPath);\n+\n+        ImmutableSetMultimap<SymbolProblem, ClassFile> symbolProblems =\n+            linkageChecker.findSymbolProblems();\n+\n+        int errorCount = symbolProblems.keySet().size();\n+\n+        // TODO(suztomo): Show the dependency paths to the problematic artifacts.\n+        logger.error(", "originalCommit": "8ca393f5be30e5eeec168eb74477835b7f044fc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQxNDU1NA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438414554", "bodyText": "Good catch. Fixed.", "author": "suztomo", "createdAt": "2020-06-10T21:19:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0Nzk5MQ=="}], "type": "inlineReview"}, {"oid": "07ddad343913030c1b28ae995fdbc6a21b0b7fc2", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/07ddad343913030c1b28ae995fdbc6a21b0b7fc2", "message": "Merge remote-tracking branch 'origin/master' into gradle_linkage_checker", "committedDate": "2020-06-10T21:17:10Z", "type": "commit"}, {"oid": "9b5fc217ef92700d7420d4a9a99b00bedbc0e449", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/9b5fc217ef92700d7420d4a9a99b00bedbc0e449", "message": "Error message only when there are errors", "committedDate": "2020-06-10T21:17:21Z", "type": "commit"}, {"oid": "d2cb7797082860863c41b2063ecb732e3c2dcda9", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/d2cb7797082860863c41b2063ecb732e3c2dcda9", "message": "Fixed typo", "committedDate": "2020-06-10T21:19:17Z", "type": "commit"}, {"oid": "e30fef0bcb89ac588adce4ede15c79c912f7e596", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/e30fef0bcb89ac588adce4ede15c79c912f7e596", "message": "Extracted findLinkageErrors", "committedDate": "2020-06-10T21:25:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQxOTMzMg==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438419332", "bodyText": "Memo: accessing the logger field is the reason why this method is not a static method, while I see making this static does not provide advantage.", "author": "suztomo", "createdAt": "2020-06-10T21:30:18Z", "path": "gradle-plugin/src/main/java/com/google/cloud/tools/dependencies/gradle/LinkageCheckTask.java", "diffHunk": "@@ -16,27 +16,115 @@\n \n package com.google.cloud.tools.dependencies.gradle;\n \n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.SymbolProblem;\n import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n import java.io.IOException;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n import org.gradle.api.DefaultTask;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.ModuleVersionIdentifier;\n+import org.gradle.api.artifacts.ResolvedArtifact;\n+import org.gradle.api.logging.Logger;\n import org.gradle.api.tasks.TaskAction;\n \n /**\n  * Task to run Linkage Checker for the dependencies of the Gradle project.\n  */\n public class LinkageCheckTask extends DefaultTask {\n+\n+  Logger logger;\n+\n   @TaskAction\n   public void run() throws IOException {\n+    logger = getLogger();\n+\n     LinkageCheckerPluginExtension extension =\n         getProject().getExtensions().findByType(LinkageCheckerPluginExtension.class);\n     if (extension == null) {\n       extension = new LinkageCheckerPluginExtension();\n     }\n \n-    // TODO(suztomo): run linkage checker for the dependencies of the Gradle project.\n-    String message = extension.getMessage();\n-    LinkageChecker linkageChecker = LinkageChecker.create(ImmutableList.of());\n-    System.out.println(\"Hello from \" + linkageChecker + \": \" + message);\n+    Project project = getProject();\n+    ImmutableSet.Builder<Configuration> configurationsBuilder = ImmutableSet.builder();\n+    if (extension.getConfigurations().isEmpty()) {\n+      // Should this default to runtime?\n+      logger.trace(\"No configuration specified, defaulting to all configurations\");\n+      for (Configuration configuration : project.getConfigurations()) {\n+        if (configuration.isCanBeResolved()) {\n+          configurationsBuilder.add(configuration);\n+        }\n+      }\n+    } else {\n+      for (String configurationName : extension.getConfigurations()) {\n+        Configuration configuration = project.getConfigurations().getByName(configurationName);\n+        if (configuration.isCanBeResolved()) {\n+          configurationsBuilder.add(configuration);\n+        }\n+      }\n+    }\n+\n+    ImmutableSet<Configuration> configurations = configurationsBuilder.build();\n+\n+    boolean foundError = false;\n+    for (Configuration configuration : configurations) {\n+      foundError |= findLinkageErrors(configuration);\n+    }\n+\n+    if (foundError) {\n+      throw new GradleException(\n+          \"Linkage Checker found errors in configurations. See above for the details.\");\n+    }\n+  }\n+\n+  /** Returns true iff {@code configuration}'s artifacts contain linkage errors. */\n+  private boolean findLinkageErrors(Configuration configuration) throws IOException {\n+    ImmutableList.Builder<ClassPathEntry> classPathBuilder = ImmutableList.builder();\n+\n+    // TODO(suztomo): Should this include optional dependencies?\n+    //  Once we decide what to do with the optional dependencies, let's revisit this logic.\n+    for (ResolvedArtifact resolvedArtifact :\n+        configuration.getResolvedConfiguration().getResolvedArtifacts()) {\n+      ModuleVersionIdentifier moduleVersionId = resolvedArtifact.getModuleVersion().getId();\n+      DefaultArtifact artifact =\n+          new DefaultArtifact(\n+              moduleVersionId.getGroup(),\n+              moduleVersionId.getName(),\n+              null,\n+              null,\n+              moduleVersionId.getVersion(),\n+              null,\n+              resolvedArtifact.getFile());\n+      classPathBuilder.add(new ClassPathEntry(artifact));\n+    }\n+\n+    ImmutableList<ClassPathEntry> classPath = classPathBuilder.build();\n+    if (!classPath.isEmpty()) {\n+      // TODO(suztomo): Specify entry points if reportOnlyReachable is true.\n+      LinkageChecker linkageChecker = LinkageChecker.create(classPath);\n+\n+      ImmutableSetMultimap<SymbolProblem, ClassFile> symbolProblems =\n+          linkageChecker.findSymbolProblems();\n+\n+      int errorCount = symbolProblems.keySet().size();\n+\n+      // TODO(suztomo): Show the dependency paths to the problematic artifacts.\n+      if (errorCount > 0) {\n+        logger.error(", "originalCommit": "e30fef0bcb89ac588adce4ede15c79c912f7e596", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0MjIzNQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438442235", "bodyText": "private", "author": "elharo", "createdAt": "2020-06-10T22:28:34Z", "path": "gradle-plugin/src/main/java/com/google/cloud/tools/dependencies/gradle/LinkageCheckTask.java", "diffHunk": "@@ -16,27 +16,115 @@\n \n package com.google.cloud.tools.dependencies.gradle;\n \n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.SymbolProblem;\n import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n import java.io.IOException;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n import org.gradle.api.DefaultTask;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.ModuleVersionIdentifier;\n+import org.gradle.api.artifacts.ResolvedArtifact;\n+import org.gradle.api.logging.Logger;\n import org.gradle.api.tasks.TaskAction;\n \n /**\n  * Task to run Linkage Checker for the dependencies of the Gradle project.\n  */\n public class LinkageCheckTask extends DefaultTask {\n+\n+  Logger logger;", "originalCommit": "e30fef0bcb89ac588adce4ede15c79c912f7e596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0NzY1OQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438447659", "bodyText": "Removed the field.", "author": "suztomo", "createdAt": "2020-06-10T22:44:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0MjIzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0MjQ0MA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438442440", "bodyText": "why do we have a logger field at all? Can we just call getLogger when we need it?", "author": "elharo", "createdAt": "2020-06-10T22:29:07Z", "path": "gradle-plugin/src/main/java/com/google/cloud/tools/dependencies/gradle/LinkageCheckTask.java", "diffHunk": "@@ -16,27 +16,115 @@\n \n package com.google.cloud.tools.dependencies.gradle;\n \n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.SymbolProblem;\n import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n import java.io.IOException;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n import org.gradle.api.DefaultTask;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.ModuleVersionIdentifier;\n+import org.gradle.api.artifacts.ResolvedArtifact;\n+import org.gradle.api.logging.Logger;\n import org.gradle.api.tasks.TaskAction;\n \n /**\n  * Task to run Linkage Checker for the dependencies of the Gradle project.\n  */\n public class LinkageCheckTask extends DefaultTask {\n+\n+  Logger logger;\n+\n   @TaskAction\n   public void run() throws IOException {\n+    logger = getLogger();", "originalCommit": "e30fef0bcb89ac588adce4ede15c79c912f7e596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0NzcyMw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438447723", "bodyText": "That's a nice idea. Removed the logger field.", "author": "suztomo", "createdAt": "2020-06-10T22:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0MjQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0MzExNg==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438443116", "bodyText": "I'm not sure I've ever actually seen this operator used before. Bitwise assignment equal is strange. Consider simply\nif (findLinkageErrors(...))\n  foundError = true;\n}", "author": "elharo", "createdAt": "2020-06-10T22:30:54Z", "path": "gradle-plugin/src/main/java/com/google/cloud/tools/dependencies/gradle/LinkageCheckTask.java", "diffHunk": "@@ -16,27 +16,115 @@\n \n package com.google.cloud.tools.dependencies.gradle;\n \n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.SymbolProblem;\n import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n import java.io.IOException;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n import org.gradle.api.DefaultTask;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.ModuleVersionIdentifier;\n+import org.gradle.api.artifacts.ResolvedArtifact;\n+import org.gradle.api.logging.Logger;\n import org.gradle.api.tasks.TaskAction;\n \n /**\n  * Task to run Linkage Checker for the dependencies of the Gradle project.\n  */\n public class LinkageCheckTask extends DefaultTask {\n+\n+  Logger logger;\n+\n   @TaskAction\n   public void run() throws IOException {\n+    logger = getLogger();\n+\n     LinkageCheckerPluginExtension extension =\n         getProject().getExtensions().findByType(LinkageCheckerPluginExtension.class);\n     if (extension == null) {\n       extension = new LinkageCheckerPluginExtension();\n     }\n \n-    // TODO(suztomo): run linkage checker for the dependencies of the Gradle project.\n-    String message = extension.getMessage();\n-    LinkageChecker linkageChecker = LinkageChecker.create(ImmutableList.of());\n-    System.out.println(\"Hello from \" + linkageChecker + \": \" + message);\n+    Project project = getProject();\n+    ImmutableSet.Builder<Configuration> configurationsBuilder = ImmutableSet.builder();\n+    if (extension.getConfigurations().isEmpty()) {\n+      // Should this default to runtime?\n+      logger.trace(\"No configuration specified, defaulting to all configurations\");\n+      for (Configuration configuration : project.getConfigurations()) {\n+        if (configuration.isCanBeResolved()) {\n+          configurationsBuilder.add(configuration);\n+        }\n+      }\n+    } else {\n+      for (String configurationName : extension.getConfigurations()) {\n+        Configuration configuration = project.getConfigurations().getByName(configurationName);\n+        if (configuration.isCanBeResolved()) {\n+          configurationsBuilder.add(configuration);\n+        }\n+      }\n+    }\n+\n+    ImmutableSet<Configuration> configurations = configurationsBuilder.build();\n+\n+    boolean foundError = false;\n+    for (Configuration configuration : configurations) {\n+      foundError |= findLinkageErrors(configuration);", "originalCommit": "e30fef0bcb89ac588adce4ede15c79c912f7e596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0ODI3MQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1462#discussion_r438448271", "bodyText": "Updated.", "author": "suztomo", "createdAt": "2020-06-10T22:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0MzExNg=="}], "type": "inlineReview"}, {"oid": "09655a4172b54dbc7c0b3360a754dbca8baad9dd", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/09655a4172b54dbc7c0b3360a754dbca8baad9dd", "message": "Removed logger field", "committedDate": "2020-06-10T22:43:56Z", "type": "commit"}]}