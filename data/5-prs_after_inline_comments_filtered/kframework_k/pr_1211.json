{"pr_number": 1211, "pr_title": "LLVM backend unparser changes in K frontend", "pr_createdAt": "2020-04-10T18:58:41Z", "pr_url": "https://github.com/kframework/k/pull/1211", "timeline": [{"oid": "e6fce2508466d8810a4e248a8e35dc3117fa4150", "url": "https://github.com/kframework/k/commit/e6fce2508466d8810a4e248a8e35dc3117fa4150", "message": "change imp script to call llvm backend unparser", "committedDate": "2020-04-10T18:55:59Z", "type": "commit"}, {"oid": "b28fb91f5f6da4569a0f936af090df4555c5d5f4", "url": "https://github.com/kframework/k/commit/b28fb91f5f6da4569a0f936af090df4555c5d5f4", "message": "main method to assist with generating code for llvm backend unparser for\ncolors", "committedDate": "2020-04-10T18:56:12Z", "type": "commit"}, {"oid": "f8f5dee1d3a0c3649ff549ecf9a093d20e206e4a", "url": "https://github.com/kframework/k/commit/f8f5dee1d3a0c3649ff549ecf9a093d20e206e4a", "message": "make Formatter.defaultFormat public", "committedDate": "2020-04-10T18:56:30Z", "type": "commit"}, {"oid": "24508d5d249daf69d01b6453c254696530868d56", "url": "https://github.com/kframework/k/commit/24508d5d249daf69d01b6453c254696530868d56", "message": "emit formatting data in the format the backend expects", "committedDate": "2020-04-10T18:56:50Z", "type": "commit"}, {"oid": "8ea5ff29459acd3ab7e65e5b30a167ffb65824a9", "url": "https://github.com/kframework/k/commit/8ea5ff29459acd3ab7e65e5b30a167ffb65824a9", "message": "Merge branch 'master' into unparse3", "committedDate": "2020-04-13T18:57:46Z", "type": "commit"}, {"oid": "0aa426412cd276fadd5b06147f8b3f8320d7a015", "url": "https://github.com/kframework/k/commit/0aa426412cd276fadd5b06147f8b3f8320d7a015", "message": "Merge branch 'master' into unparse3", "committedDate": "2020-04-14T17:23:42Z", "type": "commit"}, {"oid": "95c880d19e537e93dabbd8ca67ec58a071e7971a", "url": "https://github.com/kframework/k/commit/95c880d19e537e93dabbd8ca67ec58a071e7971a", "message": "add llvm tools to k debian package", "committedDate": "2020-04-14T17:24:45Z", "type": "commit"}, {"oid": "f19475b5ffb55b0aba0ed788521b06526c529405", "url": "https://github.com/kframework/k/commit/f19475b5ffb55b0aba0ed788521b06526c529405", "message": "fix path", "committedDate": "2020-04-14T18:10:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwMzIzOA==", "url": "https://github.com/kframework/k/pull/1211#discussion_r408703238", "bodyText": "This isn't really about symbol translation directly, and may confuse future developers about where the logic for symbol translation ends and writing the extra files begins. You could consider separating out the new functionality into a function writeSymbolUnparsingInformation (or something similar) and just call that method here, to make the distinction clearer.\nYour call.", "author": "ehildenb", "createdAt": "2020-04-15T09:24:24Z", "path": "kernel/src/main/java/org/kframework/backend/kore/ModuleToKORE.java", "diffHunk": "@@ -350,7 +381,47 @@ private void translateSymbols(Map<String, Boolean> attributes, SetMultimap<KLabe\n             sb.append(\") : \");\n             convert(prod.sort(), prod, sb);\n             sb.append(\" \");\n-            convert(attributes, addKoreAttributes(prod, functionRules, impurities, overloads), sb, null, null);\n+            Att koreAtt = addKoreAttributes(prod, functionRules, impurities, overloads);\n+            convert(attributes, koreAtt, sb, null, null);\n+            if (koreAtt.contains(\"format\")) {\n+              formats.append(\"Lbl\");\n+              convert(prod.klabel().get().name(), formats);\n+              formats.append('\\n');\n+              formats.append(koreAtt.get(\"format\"));\n+              formats.append('\\n');\n+            }\n+            if (koreAtt.contains(\"color\")) {\n+              colors.append(\"Lbl\");\n+              convert(prod.klabel().get().name(), colors);\n+              colors.append('\\n');\n+              for (int i = 0; i < prod.items().size(); i++) {\n+                if (prod.items().apply(i) instanceof Terminal) {\n+                  colors.append(koreAtt.get(\"color\"));\n+                  colors.append('\\n');\n+                }\n+              }", "originalCommit": "f19475b5ffb55b0aba0ed788521b06526c529405", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwMzM0Mg==", "url": "https://github.com/kframework/k/pull/1211#discussion_r408703342", "bodyText": "Similarly here.", "author": "ehildenb", "createdAt": "2020-04-15T09:24:34Z", "path": "kernel/src/main/java/org/kframework/backend/kore/ModuleToKORE.java", "diffHunk": "@@ -1357,6 +1428,23 @@ private Att addKoreAttributes(Production prod, SetMultimap<KLabel, Rule> functio\n         if (isMacro) {\n             att = att.add(\"macro\");\n         }\n+        String format = att.getOptional(\"format\").orElse(Formatter.defaultFormat(prod.items().size()));\n+        int nt = 1;\n+        boolean hasFormat = true;\n+        for (int i = 0; i < prod.items().size(); i++) {\n+          if (prod.items().apply(i) instanceof NonTerminal) {\n+            format = format.replace(\"%\" + (i+1), \"%\" + (nt++));\n+          } else if (prod.items().apply(i) instanceof Terminal) {\n+            format = format.replace(\"%\" + (i+1), \"%c\" + ((Terminal)prod.items().apply(i)).value() + \"%r\");\n+          } else {\n+            hasFormat = false;\n+          }\n+        }\n+        if (hasFormat) {\n+          att = att.add(\"format\", format);\n+        } else {\n+          att = att.remove(\"format\");", "originalCommit": "f19475b5ffb55b0aba0ed788521b06526c529405", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "15aa0be22c9c0c9b3ad95d2ede1d1e7ddbc952a3", "url": "https://github.com/kframework/k/commit/15aa0be22c9c0c9b3ad95d2ede1d1e7ddbc952a3", "message": "factor out methods for updating unparsing data", "committedDate": "2020-04-15T13:55:13Z", "type": "commit"}, {"oid": "a35044fae5ab00f808a9fde1d747861a3ac4e970", "url": "https://github.com/kframework/k/commit/a35044fae5ab00f808a9fde1d747861a3ac4e970", "message": "fix bug in generation of colors text file", "committedDate": "2020-04-15T14:45:34Z", "type": "commit"}, {"oid": "7c7d5c7362498390f30db31f84508522a41add8b", "url": "https://github.com/kframework/k/commit/7c7d5c7362498390f30db31f84508522a41add8b", "message": "make `colors` attribute consistent with kprint", "committedDate": "2020-04-15T14:45:48Z", "type": "commit"}, {"oid": "de4ac568bec2dd842bf3485b3a9733c6d430fa64", "url": "https://github.com/kframework/k/commit/de4ac568bec2dd842bf3485b3a9733c6d430fa64", "message": "add documentation", "committedDate": "2020-04-15T14:46:07Z", "type": "commit"}, {"oid": "262eca1701f4f380ca20b783ea2b6ca248412733", "url": "https://github.com/kframework/k/commit/262eca1701f4f380ca20b783ea2b6ca248412733", "message": "Merge branch 'master' into unparse3", "committedDate": "2020-04-15T18:22:28Z", "type": "commit"}]}