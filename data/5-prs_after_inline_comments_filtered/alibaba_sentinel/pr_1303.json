{"pr_number": 1303, "pr_title": "Improve the logs when the heartbeat response indicates failure", "pr_createdAt": "2020-02-24T10:22:54Z", "pr_url": "https://github.com/alibaba/Sentinel/pull/1303", "timeline": [{"oid": "11dba5e01a3c76583ae9fabeb93567a9a7c1817c", "url": "https://github.com/alibaba/Sentinel/commit/11dba5e01a3c76583ae9fabeb93567a9a7c1817c", "message": "com.alibaba.csp.sentinel.node.StatisticNode#curThreadNum\nusing the LongAdder rather than AtomicInteger to Provides better performance", "committedDate": "2019-05-09T06:54:31Z", "type": "commit"}, {"oid": "362f326974e310308b135438e96b4d2052679447", "url": "https://github.com/alibaba/Sentinel/commit/362f326974e310308b135438e96b4d2052679447", "message": "reformat the code according to Alibaba Java Coding Guideline", "committedDate": "2019-05-11T13:39:54Z", "type": "commit"}, {"oid": "50d2a5ab8a02b05b9f427eab64812118b8b11eb2", "url": "https://github.com/alibaba/Sentinel/commit/50d2a5ab8a02b05b9f427eab64812118b8b11eb2", "message": "reformat the code according to Alibaba Java Coding Guideline", "committedDate": "2019-05-11T14:01:55Z", "type": "commit"}, {"oid": "509ecf290d6f8ebfb7c14ba0342b03bbd5dcc026", "url": "https://github.com/alibaba/Sentinel/commit/509ecf290d6f8ebfb7c14ba0342b03bbd5dcc026", "message": "Merge pull request #1 from alibaba/master\n\nmerge master", "committedDate": "2019-05-25T04:27:44Z", "type": "commit"}, {"oid": "01bda6bfb30b0d27f28ac78a7b37e4eacb575971", "url": "https://github.com/alibaba/Sentinel/commit/01bda6bfb30b0d27f28ac78a7b37e4eacb575971", "message": "Remove the one redundant space....", "committedDate": "2019-05-28T08:28:10Z", "type": "commit"}, {"oid": "ce717e954f0f860101ed185803aad85bf6f9ca3e", "url": "https://github.com/alibaba/Sentinel/commit/ce717e954f0f860101ed185803aad85bf6f9ca3e", "message": "fix issue 62 : Support customized log directory and configuration properties directory", "committedDate": "2019-05-31T11:27:32Z", "type": "commit"}, {"oid": "b8e66b8a8679eda21ec199e3847ba2c68e2a9c61", "url": "https://github.com/alibaba/Sentinel/commit/b8e66b8a8679eda21ec199e3847ba2c68e2a9c61", "message": "use System.getProperty to get the property", "committedDate": "2019-05-31T11:40:30Z", "type": "commit"}, {"oid": "5c6600d374eea984a11b29806486e7c4759f3268", "url": "https://github.com/alibaba/Sentinel/commit/5c6600d374eea984a11b29806486e7c4759f3268", "message": "Merge pull request #2 from alibaba/master\n\nmerge online", "committedDate": "2019-06-14T02:21:59Z", "type": "commit"}, {"oid": "99991547fde3c4fefe152fef396fe955212b6456", "url": "https://github.com/alibaba/Sentinel/commit/99991547fde3c4fefe152fef396fe955212b6456", "message": "merge master latest code", "committedDate": "2019-06-14T02:32:26Z", "type": "commit"}, {"oid": "8f9339b5b3a0544fd36bf1a942fecf8f1f007999", "url": "https://github.com/alibaba/Sentinel/commit/8f9339b5b3a0544fd36bf1a942fecf8f1f007999", "message": "using SentinelConfigLocator to load sentinel-core config, LogConfigLocator to load log config", "committedDate": "2019-06-19T09:45:06Z", "type": "commit"}, {"oid": "2f485b4a8509616dba83fe003241ff0bbd3a859b", "url": "https://github.com/alibaba/Sentinel/commit/2f485b4a8509616dba83fe003241ff0bbd3a859b", "message": "Merge pull request #3 from alibaba/master\n\nmerge onlie", "committedDate": "2019-06-19T09:46:16Z", "type": "commit"}, {"oid": "c6dd24dcc26c57ee09c50fb7d520b38a23a2fa95", "url": "https://github.com/alibaba/Sentinel/commit/c6dd24dcc26c57ee09c50fb7d520b38a23a2fa95", "message": "merge remote master", "committedDate": "2019-06-19T10:28:28Z", "type": "commit"}, {"oid": "810d40ad98a62efb69e783840bd3e8ae761c9e3c", "url": "https://github.com/alibaba/Sentinel/commit/810d40ad98a62efb69e783840bd3e8ae761c9e3c", "message": "fix typo", "committedDate": "2019-06-19T10:34:24Z", "type": "commit"}, {"oid": "3f98b626a0293b3159a5f23a5fb069194507af15", "url": "https://github.com/alibaba/Sentinel/commit/3f98b626a0293b3159a5f23a5fb069194507af15", "message": "add null judge", "committedDate": "2019-06-19T10:44:33Z", "type": "commit"}, {"oid": "23244e9f88d915f856b0d59080124e2db4b1c5cd", "url": "https://github.com/alibaba/Sentinel/commit/23244e9f88d915f856b0d59080124e2db4b1c5cd", "message": "Reorganize the code", "committedDate": "2019-06-20T10:26:06Z", "type": "commit"}, {"oid": "bd8a481d84654a5773bc346dc72ddc7ae7587024", "url": "https://github.com/alibaba/Sentinel/commit/bd8a481d84654a5773bc346dc72ddc7ae7587024", "message": "Reorganize the code", "committedDate": "2019-06-20T11:27:02Z", "type": "commit"}, {"oid": "e6bbf7998617d482e6b6be7574ffa8b2a0a22569", "url": "https://github.com/alibaba/Sentinel/commit/e6bbf7998617d482e6b6be7574ffa8b2a0a22569", "message": "add config test cases", "committedDate": "2019-06-25T09:02:10Z", "type": "commit"}, {"oid": "c91b963039edcf2358d11d781e378783e8ced774", "url": "https://github.com/alibaba/Sentinel/commit/c91b963039edcf2358d11d781e378783e8ced774", "message": "ConfigUtil.loadPropertiesFromFile when file not exist return null", "committedDate": "2019-06-25T11:02:57Z", "type": "commit"}, {"oid": "d401c2fe0f1fb7c860d2674712dde11dbcd264b0", "url": "https://github.com/alibaba/Sentinel/commit/d401c2fe0f1fb7c860d2674712dde11dbcd264b0", "message": "rename classname and method name", "committedDate": "2019-06-27T11:38:39Z", "type": "commit"}, {"oid": "85173a546873127564fcb6b233c481d1ae6bd6ea", "url": "https://github.com/alibaba/Sentinel/commit/85173a546873127564fcb6b233c481d1ae6bd6ea", "message": "rename classname and method name", "committedDate": "2019-06-27T11:43:29Z", "type": "commit"}, {"oid": "4510234aa476337a052624be731b5149a7d5dfcd", "url": "https://github.com/alibaba/Sentinel/commit/4510234aa476337a052624be731b5149a7d5dfcd", "message": "using  File.separator  to replace  \"/\"", "committedDate": "2019-06-27T11:57:42Z", "type": "commit"}, {"oid": "c068eddaeba4e968557dd79f1590b0aaa11f3e6b", "url": "https://github.com/alibaba/Sentinel/commit/c068eddaeba4e968557dd79f1590b0aaa11f3e6b", "message": "support retrieve properties from classpath file", "committedDate": "2019-06-27T13:32:13Z", "type": "commit"}, {"oid": "9af06c99318e46af9727f0fe16a440f669b4eb95", "url": "https://github.com/alibaba/Sentinel/commit/9af06c99318e46af9727f0fe16a440f669b4eb95", "message": "support retrieve properties from classpath file", "committedDate": "2019-06-27T13:40:37Z", "type": "commit"}, {"oid": "014cda3489223e54e7bf490ef733edae14bfff2c", "url": "https://github.com/alibaba/Sentinel/commit/014cda3489223e54e7bf490ef733edae14bfff2c", "message": "add feature support : retrieve properties from relative file", "committedDate": "2019-07-01T08:39:24Z", "type": "commit"}, {"oid": "a899dc6b434aac6328bee0f7fb86ea0586065b29", "url": "https://github.com/alibaba/Sentinel/commit/a899dc6b434aac6328bee0f7fb86ea0586065b29", "message": "reformat code", "committedDate": "2019-07-01T09:33:42Z", "type": "commit"}, {"oid": "419d97fb9f1fa0669f56d376b5a155323aef8424", "url": "https://github.com/alibaba/Sentinel/commit/419d97fb9f1fa0669f56d376b5a155323aef8424", "message": "Merge pull request #4 from alibaba/master\n\nmerge online", "committedDate": "2019-07-01T09:42:06Z", "type": "commit"}, {"oid": "80f283e3222c70e66ab582aabf7f47c9f3fc1b94", "url": "https://github.com/alibaba/Sentinel/commit/80f283e3222c70e66ab582aabf7f47c9f3fc1b94", "message": "Merge remote-tracking branch 'remotes/origin/master' into 20190531-fix-issue62", "committedDate": "2019-07-01T09:43:13Z", "type": "commit"}, {"oid": "14a1d5b5599016f1f601a45cf51d5830ea35059f", "url": "https://github.com/alibaba/Sentinel/commit/14a1d5b5599016f1f601a45cf51d5830ea35059f", "message": "Revert \"rename classname and method name\"\n\nThis reverts commit d401c2fe", "committedDate": "2019-07-05T14:49:27Z", "type": "commit"}, {"oid": "ea18020610dfb0099e6f07ea5a630ab90b908ff0", "url": "https://github.com/alibaba/Sentinel/commit/ea18020610dfb0099e6f07ea5a630ab90b908ff0", "message": "add copy right doc", "committedDate": "2019-07-05T14:58:47Z", "type": "commit"}, {"oid": "c562474480fb7fa7d1e941edab3f1a97bb3f0bff", "url": "https://github.com/alibaba/Sentinel/commit/c562474480fb7fa7d1e941edab3f1a97bb3f0bff", "message": "reset commit", "committedDate": "2019-07-06T01:37:20Z", "type": "commit"}, {"oid": "c71759fadfa9275e568a88f118b6eb7dc7981790", "url": "https://github.com/alibaba/Sentinel/commit/c71759fadfa9275e568a88f118b6eb7dc7981790", "message": "remove unused code", "committedDate": "2019-07-06T04:10:50Z", "type": "commit"}, {"oid": "d387b47f131c7c7d724788236d1ed6f9657174c6", "url": "https://github.com/alibaba/Sentinel/commit/d387b47f131c7c7d724788236d1ed6f9657174c6", "message": "merge alibaba master", "committedDate": "2019-07-10T06:56:37Z", "type": "commit"}, {"oid": "56d5df032b574e48ca5de2a635170d2ed8fbe629", "url": "https://github.com/alibaba/Sentinel/commit/56d5df032b574e48ca5de2a635170d2ed8fbe629", "message": "Merge pull request #6 from alibaba/master\n\nmerge online", "committedDate": "2019-07-24T03:01:19Z", "type": "commit"}, {"oid": "22cafd2454881988180a23dfde582f3a1c74ed0c", "url": "https://github.com/alibaba/Sentinel/commit/22cafd2454881988180a23dfde582f3a1c74ed0c", "message": "Merge pull request #7 from alibaba/master\n\nmerge remote master", "committedDate": "2019-08-22T07:28:26Z", "type": "commit"}, {"oid": "7a0c6b7b11b128134845e4daaa50f7267b21a1ea", "url": "https://github.com/alibaba/Sentinel/commit/7a0c6b7b11b128134845e4daaa50f7267b21a1ea", "message": "Merge pull request #8 from alibaba/master\n\nmerge online", "committedDate": "2019-09-10T02:36:30Z", "type": "commit"}, {"oid": "7a4391d098ee2420bbbf1b974ff9d97f410de5d9", "url": "https://github.com/alibaba/Sentinel/commit/7a4391d098ee2420bbbf1b974ff9d97f410de5d9", "message": "Improve the logs when the heartbeat response indicates failure (#1194)", "committedDate": "2020-02-24T10:21:09Z", "type": "commit"}, {"oid": "654d73a973ad5ddc09d6e2f1a5cdca4ed8a16b48", "url": "https://github.com/alibaba/Sentinel/commit/654d73a973ad5ddc09d6e2f1a5cdca4ed8a16b48", "message": "Merge branch 'master' into log-heartbeat-response", "committedDate": "2020-02-24T10:30:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMwOTY4OA==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r383309688", "bodyText": "Maybe it's not necessary to log here, as we also checked and warned in the constructor of the HeartbeatSender impls.", "author": "sczyh30", "createdAt": "2020-02-24T14:51:46Z", "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -104,7 +106,8 @@ public HttpHeartbeatSender() {\n \n     @Override\n     public boolean sendHeartbeat() throws Exception {\n-        if (StringUtil.isEmpty(consoleHost)) {\n+        if (StringUtil.isEmpty(consoleHost) || invalidPort(consolePort)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat for invalid args consoleHost:{0} consolePort:{1}\", consoleHost, consolePort);", "originalCommit": "654d73a973ad5ddc09d6e2f1a5cdca4ed8a16b48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3b0f07deed406be8e45e16d68c1783078d010e89", "url": "https://github.com/alibaba/Sentinel/commit/3b0f07deed406be8e45e16d68c1783078d010e89", "message": "Merge pull request #9 from alibaba/master\n\nMerge remote master", "committedDate": "2020-02-24T14:59:33Z", "type": "commit"}, {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e", "url": "https://github.com/alibaba/Sentinel/commit/f3a32dd08c28bd49ae5a3ba6282266d76fb4536e", "message": "HttpHeartbeatSender remove duplicate host port check", "committedDate": "2020-02-24T15:13:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r383347686", "bodyText": "Here we may need use placeholder for log: RecordLog.warn(\"xxx{},{}\", arg1,arg2);.\nOr just concat all message string.\nBesides, I found that SimpleHttpResponse#toString may throws NPE, when body is null,\nIn SimpleHttpResponse#108L, maybe need add checking logic.", "author": "cdfive", "createdAt": "2020-02-24T15:51:40Z", "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "originalCommit": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3NzEzMw==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r383377133", "bodyText": "Yes. Maybe just logging the response status code is enough?", "author": "sczyh30", "createdAt": "2020-02-24T16:37:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMjM0Mg==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r383612342", "bodyText": "emm. I check  the response Headers. It is a supplement of the server version\u3001location \u3001name, may be it is not necessary to print.", "author": "linlinisme", "createdAt": "2020-02-25T01:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQzNDg4NQ==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r384434885", "bodyText": "How about else branch, do we need to add some log?  The NPE remains in SimpleHttpResponse#getBodyAsString() at line 108, when body is null it throws.", "author": "cdfive", "createdAt": "2020-02-26T11:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4Nzk4Mg==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r384887982", "bodyText": "emm..  it seems there more than one point need to handle the NPE\n1.com.alibaba.csp.sentinel.transport.heartbeat.client.SimpleHttpResponseParser#parse\n2.com.alibaba.csp.sentinel.transport.heartbeat.client.SimpleHttpResponse#parseCharset\n3.com.alibaba.csp.sentinel.transport.heartbeat.client.SimpleHttpResponse#getBodyAsString\u3001 return new String(body, charset);", "author": "linlinisme", "createdAt": "2020-02-27T02:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE3ODM2Ng==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r386178366", "bodyText": "any suggestion?", "author": "linlinisme", "createdAt": "2020-03-02T02:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIwMjU2Nw==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r386202567", "bodyText": "I think that 3 need to check.To verify it, we can throw Exception in MachineRegistryController#receiveHeartBeat of dashboard, and call SimpleHttpResponse#toString().", "author": "cdfive", "createdAt": "2020-03-02T05:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIxNTgwMQ==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r386215801", "bodyText": "I think that 3 need to check.To verify it, we can throw Exception in MachineRegistryController#receiveHeartBeat of dashboard, and call SimpleHttpResponse#toString().\n\nIt still will return http 200 ok response code, even though  throw ex.  It seems SimpleHttpResponseParser  don't check the response data, which may  need to be checked. How about we open another issue to discuss ?", "author": "linlinisme", "createdAt": "2020-03-02T06:30:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ2NTY3NQ==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r386465675", "bodyText": "I think that 3 need to check.To verify it, we can throw Exception in MachineRegistryController#receiveHeartBeat of dashboard, and call SimpleHttpResponse#toString().\n\nIt still will return http 200 ok response code, even though throw ex. It seems SimpleHttpResponseParser don't check the response data, which may need to be checked. How about we open another issue to discuss ?\n\nYeah, we could open another issue to discuss how to improve it :)", "author": "sczyh30", "createdAt": "2020-03-02T15:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1NDU4Nw==", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r386754587", "bodyText": "Yes, one issue one PR is clean and consistent.\n\nIt still will return http 200 ok response code, even though throw ex. It seems SimpleHttpResponseParser don't check the response data\nI got http 500 and the SimpleHttpResponseParser checked the response.\n\nAdd this in MachineRegistryController#receiveHeartBeat\nif (true) {\n    throw new RuntimeException(\"test\");\n}\nThen add in SimpleHttpHeartbeatSender#sendHeartbeat\ntry {\n    System.out.println(response);\n} catch (Exception e) {\n    e.printStackTrace();\n}\nThen the response code 500 got, and NPE occured.", "author": "cdfive", "createdAt": "2020-03-03T01:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}], "type": "inlineReview"}, {"oid": "d39d090c559051051fa953800531c53943ce0852", "url": "https://github.com/alibaba/Sentinel/commit/d39d090c559051051fa953800531c53943ce0852", "message": "simply HeartBeatSender log and fix SimpleHttpResponse.toString() NPE problem", "committedDate": "2020-02-25T01:44:20Z", "type": "commit"}]}