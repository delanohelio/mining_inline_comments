{"pr_number": 1896, "pr_title": "Support HTTPS url for -Dcsp.sentinel.dashboard.server attribute", "pr_createdAt": "2020-12-14T03:30:25Z", "pr_url": "https://github.com/alibaba/Sentinel/pull/1896", "timeline": [{"oid": "ce2b0bbafeb6360970887d29b4e162f21af1f5f0", "url": "https://github.com/alibaba/Sentinel/commit/ce2b0bbafeb6360970887d29b4e162f21af1f5f0", "message": "Support HTTPS url for -Dcsp.sentinel.dashboard.server attribute", "committedDate": "2020-12-14T03:03:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEyOTQ2NQ==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542129465", "bodyText": "Please fix up the indents.", "author": "jasonjoo2010", "createdAt": "2020-12-14T05:54:29Z", "path": "sentinel-transport/sentinel-transport-common/src/main/java/com/alibaba/csp/sentinel/transport/config/TransportConfig.java", "diffHunk": "@@ -92,11 +95,17 @@ public static Long getHeartbeatIntervalMs() {\n                 continue;\n             }\n             ipPortStr = ipPortStr.trim();\n-            if (ipPortStr.startsWith(\"http://\")) {\n-                ipPortStr = ipPortStr.substring(7);\n-            }\n-            int index = ipPortStr.indexOf(\":\");\n-            int port = 80;\n+\t\t\tint port = 80;", "originalCommit": "ce2b0bbafeb6360970887d29b4e162f21af1f5f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE0MTMxNg==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542141316", "bodyText": "It's strange, it looks good in my IDE. Let me check.", "author": "polarbear567", "createdAt": "2020-12-14T06:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEyOTQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE0NDIzMA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542144230", "bodyText": "It's strange, it looks good in my IDE. Let me check.\n\nYes, it depends on your editor's preference settings.\nMaybe you have the setting using TAB instead of SPACE and setting the width of the TAB to 4 spaces' width.\nSentinel and some other projects use the style of plain spaces with an indent of 4 spaces.", "author": "jasonjoo2010", "createdAt": "2020-12-14T06:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEyOTQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2MDkxNg==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542160916", "bodyText": "It's strange, it looks good in my IDE. Let me check.\n\nYes, it depends on your editor's preference settings.\nMaybe you have the setting using TAB instead of SPACE and setting the width of the TAB to 4 spaces' width.\nSentinel and some other projects use the style of plain spaces with an indent of 4 spaces.\n\nGreat!", "author": "polarbear567", "createdAt": "2020-12-14T07:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEyOTQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTA0MA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542131040", "bodyText": "I suggest using an enum type to make it easy to compare.\nAnd the protocol should not be a global state but be a kind of state in the addr-port pairs.", "author": "jasonjoo2010", "createdAt": "2020-12-14T05:59:21Z", "path": "sentinel-transport/sentinel-transport-common/src/main/java/com/alibaba/csp/sentinel/transport/config/TransportConfig.java", "diffHunk": "@@ -40,6 +41,8 @@\n \n     private static int runtimePort = -1;\n \n+\tprivate static String protocol = \"http\";", "originalCommit": "ce2b0bbafeb6360970887d29b4e162f21af1f5f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2MDg5MA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542160890", "bodyText": "I suggest using an enum type to make it easy to compare.\nAnd the protocol should not be a global state but be a kind of state in the addr-port pairs.\n\nIn fact, I've thought about creating a new class similar to Tuple2, but it can have three elements. Do you mean it's still stored in Tuple2 in the form of Tuple2.of(protocol + host, port)?", "author": "polarbear567", "createdAt": "2020-12-14T07:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE3NTk0Mg==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542175942", "bodyText": "I suggest using an enum type to make it easy to compare.\nAnd the protocol should not be a global state but be a kind of state in the addr-port pairs.\n\nIn fact, I've thought about creating a new class similar to Tuple2, but it can have three elements. Do you mean it's still stored in Tuple2 in the form of Tuple2.of(protocol + host, port)?\n\nElements grow a new type like Endpoint can be introduced so that the Tuple can be replaced. A Tuple3 type maybe looks more complicated now.", "author": "jasonjoo2010", "createdAt": "2020-12-14T07:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE5NTcxNA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542195714", "bodyText": "I suggest using an enum type to make it easy to compare.\nAnd the protocol should not be a global state but be a kind of state in the addr-port pairs.\n\nIn fact, I've thought about creating a new class similar to Tuple2, but it can have three elements. Do you mean it's still stored in Tuple2 in the form of Tuple2.of(protocol + host, port)?\n\nElements grow a new type like Endpoint can be introduced so that the Tuple can be replaced. A Tuple3 type maybe looks more complicated now.\n\nAs far as I know, Java can't implement tuples of different lengths in a class unless it's identified by length in a class. I don't know if it's right. If you agree, I'll implement a simple tuple3 as a temporary solution.", "author": "polarbear567", "createdAt": "2020-12-14T08:30:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwMTQxNw==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542201417", "bodyText": "I suggest using an enum type to make it easy to compare.\nAnd the protocol should not be a global state but be a kind of state in the addr-port pairs.\n\nIn fact, I've thought about creating a new class similar to Tuple2, but it can have three elements. Do you mean it's still stored in Tuple2 in the form of Tuple2.of(protocol + host, port)?\n\nElements grow a new type like Endpoint can be introduced so that the Tuple can be replaced. A Tuple3 type maybe looks more complicated now.\n\nAs far as I know, Java can't implement tuples of different lengths in a class unless it's identified by length in a class. I don't know if it's right. If you agree, I'll implement a simple tuple3 as a temporary solution.\n\nTo be clear, I would show it by examples to make sure we are on the same road:\nThe old approach\nTuple2<addr, port>   -> fixed to HTTP protocol\n1st approach to improve it\nTuple3<protocol, addr, port> -> A new type Tuple3 is introduced.\n2nd approach\nEndpoint -> A new type Endpoint is introduced as the details below:\npublic class Endpoint {\n    private PROTOCOL protocol;\n    private String address;\n    private int port;\n    // getters and setters\n}", "author": "jasonjoo2010", "createdAt": "2020-12-14T08:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNDcwMA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542204700", "bodyText": "I suggest using an enum type to make it easy to compare.\nAnd the protocol should not be a global state but be a kind of state in the addr-port pairs.\n\nIn fact, I've thought about creating a new class similar to Tuple2, but it can have three elements. Do you mean it's still stored in Tuple2 in the form of Tuple2.of(protocol + host, port)?\n\nElements grow a new type like Endpoint can be introduced so that the Tuple can be replaced. A Tuple3 type maybe looks more complicated now.\n\nAs far as I know, Java can't implement tuples of different lengths in a class unless it's identified by length in a class. I don't know if it's right. If you agree, I'll implement a simple tuple3 as a temporary solution.\n\nTo be clear, I would show it by examples to make sure we are on the same road:\nThe old approach:\nTuple2<addr, port> -> fixed to HTTP protocol\n1st approach to improve it:\nTuple3<protocol, addr, port> -> A new type Tuple3 is introduced.\n2nd approach:\nEndpoint -> A new type Endpoint is introduced as the details below:\npublic class Endpoint {\n    private PROTOCOL protocol;\n    private String address;\n    private int port;\n    // getters and setters\n}\n\nI prefer the second approach.", "author": "polarbear567", "createdAt": "2020-12-14T08:44:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNjkzNw==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542206937", "bodyText": "I prefer the second approach.\n\nYes, I think we have reached the same point now. And another suggestion on the design of arguments of different implementations is based on the decision here.\nAnd I totally agree with you here.\ud83d\ude00", "author": "jasonjoo2010", "createdAt": "2020-12-14T08:48:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTQwMw==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542131403", "bodyText": "Here an \"ELSE\" should be introduced as a different condition branch.", "author": "jasonjoo2010", "createdAt": "2020-12-14T06:00:19Z", "path": "sentinel-transport/sentinel-transport-common/src/main/java/com/alibaba/csp/sentinel/transport/config/TransportConfig.java", "diffHunk": "@@ -92,11 +95,17 @@ public static Long getHeartbeatIntervalMs() {\n                 continue;\n             }\n             ipPortStr = ipPortStr.trim();\n-            if (ipPortStr.startsWith(\"http://\")) {\n-                ipPortStr = ipPortStr.substring(7);\n-            }\n-            int index = ipPortStr.indexOf(\":\");\n-            int port = 80;\n+\t\t\tint port = 80;\n+\t\t\tif (ipPortStr.startsWith(\"http://\")) {\n+\t\t\t\tipPortStr = ipPortStr.substring(7);\n+\t\t\t\tport = 80;\n+\t\t\t}\n+\t\t\tif (ipPortStr.startsWith(\"https://\")) {", "originalCommit": "ce2b0bbafeb6360970887d29b4e162f21af1f5f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMjAxNw==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542132017", "bodyText": "If a new type was introduced it's highly recommended to pass it into query implementations directly.", "author": "jasonjoo2010", "createdAt": "2020-12-14T06:02:07Z", "path": "sentinel-transport/sentinel-transport-simple-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/SimpleHttpHeartbeatSender.java", "diffHunk": "@@ -69,7 +70,7 @@ public boolean sendHeartbeat() throws Exception {\n         }\n \n         InetSocketAddress addr = new InetSocketAddress(addrInfo.r1, addrInfo.r2);\n-        SimpleHttpRequest request = new SimpleHttpRequest(addr, TransportConfig.getHeartbeatApiPath());", "originalCommit": "ce2b0bbafeb6360970887d29b4e162f21af1f5f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2NDM2OQ==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542164369", "bodyText": "If a new type was introduced it's highly recommended to pass it into query implementations directly.\n\nI'm sorry, I didn't get your point here. Could you give me a hint?", "author": "polarbear567", "createdAt": "2020-12-14T07:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMjAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE3NjgxNg==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542176816", "bodyText": "If a new type was introduced it's highly recommended to pass it into query implementations directly.\n\nI'm sorry, I didn't get your point here. Could you give me a hint?\n\nIt's related to the previous design (Tuple3/class Endpoint{}). If a new class was introduced there's no need to split it into three separated arguments I think.", "author": "jasonjoo2010", "createdAt": "2020-12-14T07:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMjAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNjAwMg==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542206002", "bodyText": "If a new type was introduced it's highly recommended to pass it into query implementations directly.\n\nI'm sorry, I didn't get your point here. Could you give me a hint?\n\nIt's related to the previous design (Tuple3/class Endpoint{}). If a new class was introduced there's no need to split it into three separated arguments I think.\n\nAfter using Endpoint, I will modify it here and directly pass in Endpoint in the constructor of SimpleHttpRequest to replace protocol and socketAddress", "author": "polarbear567", "createdAt": "2020-12-14T08:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMjAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxNDE1MA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542214150", "bodyText": "After using Endpoint, I will modify it here and directly pass in Endpoint in the constructor of SimpleHttpRequest to replace protocol and socketAddress\n\nYes, that's it.\nMeanwhile, it won't be a backward compatible change and we don't have the perfect one exactly.", "author": "jasonjoo2010", "createdAt": "2020-12-14T08:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMjAxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMzcwMg==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542133702", "bodyText": "Maybe it doesn't make any sense here?", "author": "jasonjoo2010", "createdAt": "2020-12-14T06:07:12Z", "path": "sentinel-transport/sentinel-transport-simple-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/client/SimpleHttpClient.java", "diffHunk": "@@ -77,57 +90,73 @@ public SimpleHttpResponse post(SimpleHttpRequest request) throws IOException {\n         if (request == null) {\n             return null;\n         }\n-        return request(request.getSocketAddress(),\n+        return request(request.getProtocol(), request.getSocketAddress(),\n             RequestMethod.POST, request.getRequestPath(),\n             request.getParams(), request.getCharset(),\n             request.getSoTimeout());\n     }\n \n+\tprivate SimpleHttpResponse request(String protocol, InetSocketAddress socketAddress,\n+\t\t\t\t\t\t\t\t\t   RequestMethod type, String requestPath,\n+\t\t\t\t\t\t\t\t\t   Map<String, String> paramsMap, Charset charset, int soTimeout)\n+\t\t\tthrows IOException {\n+\t\tSocket socket = null;\n+\t\tBufferedWriter writer;\n+\t\ttry {\n+\t\t\tif (StringUtil.equals(protocol, \"http\")) {\n+\t\t\t\tsocket = new Socket();\n+\t\t\t} else if (StringUtil.equals(protocol, \"https\")){\n+\t\t\t\tsslSocketFactory = getSSLSocketFactory();\n+\t\t\t\tif (sslSocketFactory != null) {\n+\t\t\t\t\tsocket = sslSocketFactory.createSocket();\n+\t\t\t\t} else {\n+\t\t\t\t\tsocket = new Socket();", "originalCommit": "ce2b0bbafeb6360970887d29b4e162f21af1f5f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2Mzk1Mg==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542163952", "bodyText": "Maybe it doesn't make any sense here?\n\nYes, actually, it doesn't work here. It's just used to prevent NPE, but it won't happen in theory. I'll delete it.", "author": "polarbear567", "createdAt": "2020-12-14T07:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMzcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzNDU4OA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542134588", "bodyText": "The All-In-One approach makes the class a little ambiguous.\nSuggest abstracting the socket creation into different implementations outside.", "author": "jasonjoo2010", "createdAt": "2020-12-14T06:10:02Z", "path": "sentinel-transport/sentinel-transport-simple-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/client/SimpleHttpClient.java", "diffHunk": "@@ -184,6 +213,50 @@ private String encodeRequestParams(Map<String, String> paramsMap, Charset charse\n         }\n     }\n \n+\tprivate X509TrustManager getX509TrustManager() {\n+\t\tif (x509TrustManager == null) {\n+\t\t\tx509TrustManager = new X509TrustManager() {\n+\t\t\t\tpublic boolean isServerTrusted(X509Certificate[] certs) {\n+\t\t\t\t\treturn true;\n+\t\t\t\t}\n+\n+\t\t\t\tpublic boolean isClientTrusted(X509Certificate[] certs) {\n+\t\t\t\t\treturn true;\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic void checkServerTrusted(X509Certificate[] certs, String authType)\n+\t\t\t\t\t\tthrows CertificateException {\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic void checkClientTrusted(X509Certificate[] certs, String authType)\n+\t\t\t\t\t\tthrows CertificateException {\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic X509Certificate[] getAcceptedIssuers() {\n+\t\t\t\t\treturn null;\n+\t\t\t\t}\n+\t\t\t};\n+\t\t}\n+\t\treturn x509TrustManager;\n+\t}\n+\n+\tprivate SSLSocketFactory getSSLSocketFactory() {", "originalCommit": "ce2b0bbafeb6360970887d29b4e162f21af1f5f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f64d511e8f204a11c3388d6cce8fa873a8d22d40", "url": "https://github.com/alibaba/Sentinel/commit/f64d511e8f204a11c3388d6cce8fa873a8d22d40", "message": "fix and optimize", "committedDate": "2020-12-14T10:03:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3MTgwNA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542471804", "bodyText": "\ud83d\ude05Is it better to put them in transport-common instead of the core package?\nOr are there other pieces of code outside the transport module depending on them?", "author": "jasonjoo2010", "createdAt": "2020-12-14T15:26:01Z", "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/function/Endpoint.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.alibaba.csp.sentinel.util.function;", "originalCommit": "f64d511e8f204a11c3388d6cce8fa873a8d22d40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3NDY0MA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542474640", "bodyText": "And please function makes little sense here. I believe you really can figure out a good naming\ud83d\udcaa", "author": "jasonjoo2010", "createdAt": "2020-12-14T15:29:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3MTgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk5NDU2Mw==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542994563", "bodyText": "It's my mistake, I'll move them to com.alibaba.csp.sentinel.transport.endpoint.", "author": "polarbear567", "createdAt": "2020-12-15T02:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3MTgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3NjMzNg==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542476336", "bodyText": "It's strange to put such a piece of code here but I won't consist on it. It looks like no harm.", "author": "jasonjoo2010", "createdAt": "2020-12-14T15:31:30Z", "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/function/Endpoint.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.alibaba.csp.sentinel.util.function;\n+\n+import java.net.InetSocketAddress;\n+\n+/**\n+ * @author Leo Li\n+ */\n+public class Endpoint {\n+    private Protocol protocol;\n+\n+    private String host;\n+\n+    private int port;\n+\n+    public Endpoint(Protocol protocol, String host, int port) {\n+        this.protocol = protocol;\n+        this.host = host;\n+        this.port = port;\n+    }\n+\n+    public Protocol getProtocol() {\n+        return protocol;\n+    }\n+\n+    public void setProtocol(Protocol protocol) {\n+        this.protocol = protocol;\n+    }\n+\n+    public String getHost() {\n+        return host;\n+    }\n+\n+    public void setHost(String host) {\n+        this.host = host;\n+    }\n+\n+    public int getPort() {\n+        return port;\n+    }\n+\n+    public void setPort(int port) {\n+        this.port = port;\n+    }\n+\n+    public InetSocketAddress getInetSocketAddress() {", "originalCommit": "f64d511e8f204a11c3388d6cce8fa873a8d22d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ4NTM1NA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542485354", "bodyText": "There is a small tweak here.\nIt would be better to make sslSocketFactory initialized only if necessary.", "author": "jasonjoo2010", "createdAt": "2020-12-14T15:42:20Z", "path": "sentinel-transport/sentinel-transport-simple-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/client/SocketFactory.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package com.alibaba.csp.sentinel.transport.heartbeat.client;\n+\n+import java.io.IOException;\n+import java.net.Socket;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.SSLSocketFactory;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.X509TrustManager;\n+\n+import com.alibaba.csp.sentinel.log.RecordLog;\n+import com.alibaba.csp.sentinel.util.function.Protocol;\n+\n+/**\n+ * @author Leo Li\n+ */\n+public class SocketFactory {\n+    private static X509TrustManager x509TrustManager;\n+    private static SSLContext sslContext;\n+    private static SSLSocketFactory sslSocketFactory;\n+\n+    static {\n+        try {\n+            x509TrustManager = new X509TrustManager() {\n+                public boolean isServerTrusted(X509Certificate[] certs) {\n+                    return true;\n+                }\n+\n+                public boolean isClientTrusted(X509Certificate[] certs) {\n+                    return true;\n+                }\n+\n+                @Override\n+                public void checkServerTrusted(X509Certificate[] certs, String authType)\n+                        throws CertificateException {\n+                }\n+\n+                @Override\n+                public void checkClientTrusted(X509Certificate[] certs, String authType)\n+                        throws CertificateException {\n+                }\n+\n+                @Override\n+                public X509Certificate[] getAcceptedIssuers() {\n+                    return null;\n+                }\n+            };\n+\n+            sslContext = SSLContext.getInstance(\"TLS\");\n+            sslContext.init(null, new TrustManager[] { x509TrustManager }, null);\n+            sslSocketFactory = sslContext.getSocketFactory();\n+        } catch (Exception e) {\n+            RecordLog.error(\"get ssl socket factory error\", e);\n+        }\n+    }\n+\n+    public static Socket getSocket(Protocol protocol) throws IOException {\n+        return protocol == Protocol.HTTP ? new Socket() : sslSocketFactory.createSocket();", "originalCommit": "f64d511e8f204a11c3388d6cce8fa873a8d22d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ4ODI2NA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r542488264", "bodyText": "Maybe HTTPS support is not implemented in netty-http module.", "author": "jasonjoo2010", "createdAt": "2020-12-14T15:45:55Z", "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -59,14 +59,14 @@\n \n     public HttpHeartbeatSender() {\n         this.client = HttpClients.createDefault();\n-        List<Tuple2<String, Integer>> dashboardList = TransportConfig.getConsoleServerList();\n+        List<Endpoint> dashboardList = TransportConfig.getConsoleServerList();\n         if (dashboardList == null || dashboardList.isEmpty()) {\n             RecordLog.info(\"[NettyHttpHeartbeatSender] No dashboard server available\");\n             consoleHost = null;\n             consolePort = -1;\n         } else {\n-            consoleHost = dashboardList.get(0).r1;\n-            consolePort = dashboardList.get(0).r2;\n+            consoleHost = dashboardList.get(0).getHost();\n+            consolePort = dashboardList.get(0).getPort();", "originalCommit": "f64d511e8f204a11c3388d6cce8fa873a8d22d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3fb45d4802d5e7bbe27e2164ded88f4bccb544ac", "url": "https://github.com/alibaba/Sentinel/commit/3fb45d4802d5e7bbe27e2164ded88f4bccb544ac", "message": "optimize and support https for netty http", "committedDate": "2020-12-15T05:48:56Z", "type": "commit"}, {"oid": "ad8d0af86693d2779f0a5b43c92a10b58d1daff3", "url": "https://github.com/alibaba/Sentinel/commit/ad8d0af86693d2779f0a5b43c92a10b58d1daff3", "message": "fix test error", "committedDate": "2020-12-15T06:17:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NDE4MA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r543074180", "bodyText": "What's the difference between the wrapped form and Class.varible form?", "author": "jasonjoo2010", "createdAt": "2020-12-15T06:14:03Z", "path": "sentinel-transport/sentinel-transport-simple-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/client/SocketFactory.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.alibaba.csp.sentinel.transport.heartbeat.client;\n+\n+import java.io.IOException;\n+import java.net.Socket;\n+\n+import javax.net.ssl.SSLSocketFactory;\n+\n+import com.alibaba.csp.sentinel.transport.endpoint.Protocol;\n+import com.alibaba.csp.sentinel.transport.ssl.SslFactory;\n+\n+/**\n+ * @author Leo Li\n+ */\n+public class SocketFactory {\n+\n+    private static class SSLSocketFactoryInstance {\n+        private static final SSLSocketFactory SSL_SOCKET_FACTORY = SslFactory.getSslConnectionSocketFactory().getSocketFactory();\n+    }\n+\n+    public static Socket getSocket(Protocol protocol) throws IOException {\n+        return protocol == Protocol.HTTP ? new Socket() : getSslSocketFactory().createSocket();", "originalCommit": "3fb45d4802d5e7bbe27e2164ded88f4bccb544ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NTMyOQ==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r543075329", "bodyText": "I just wrote a small piece testing code and didn't find any different.", "author": "jasonjoo2010", "createdAt": "2020-12-15T06:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NDE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5OTU0Nw==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r543099547", "bodyText": "What's the difference between the wrapped form and Class.varible form?\n\nThis delays init, and threads are safe. Originally written directly in the static block of the class, now it is changed to the inner class.", "author": "polarbear567", "createdAt": "2020-12-15T07:13:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NDE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzEwMzgzNg==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r543103836", "bodyText": "This delays init, and threads are safe. Originally written directly in the static block of the class, now it is changed to the inner class.\n\nYeah, I know. I'm just curious whether it's different to use SSLSocketFactoryInstance.SSL_SOCKET_FACTORY simply instead of getSslSocketFactory()?\nMy testing code is for these two approaches.", "author": "jasonjoo2010", "createdAt": "2020-12-15T07:21:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NDE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzExMjAxNA==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r543112014", "bodyText": "This delays init, and threads are safe. Originally written directly in the static block of the class, now it is changed to the inner class.\n\nYeah, I know. I'm just curious whether it's different to use SSLSocketFactoryInstance.SSL_SOCKET_FACTORY simply instead of getSslSocketFactory()?\nMy testing code is for these two approaches.\n\nOh, it doesn't make any difference, it's a \"copy\" issue\ud83d\ude04", "author": "polarbear567", "createdAt": "2020-12-15T07:37:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NDE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NzQ5Mw==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r543077493", "bodyText": "\ud83e\udd12Do you forget to remove the useless main?", "author": "jasonjoo2010", "createdAt": "2020-12-15T06:22:29Z", "path": "sentinel-transport/sentinel-transport-common/src/main/java/com/alibaba/csp/sentinel/transport/endpoint/Protocol.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package com.alibaba.csp.sentinel.transport.endpoint;\n+\n+/**\n+ * @author Leo Li\n+ */\n+public enum Protocol {\n+    HTTP(\"http\"),\n+    HTTPS(\"https\");\n+\n+    private String protocol;\n+\n+    Protocol(String protocol) {\n+        this.protocol = protocol;\n+    }\n+\n+    public String getProtocol() {\n+        return protocol;\n+    }\n+\n+    public static void main(String[] args) {", "originalCommit": "3fb45d4802d5e7bbe27e2164ded88f4bccb544ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4NTY4Mw==", "url": "https://github.com/alibaba/Sentinel/pull/1896#discussion_r543085683", "bodyText": "Hi @sczyh30\nIs bypass certificate verifying acceptable?\nI don't insist on it.", "author": "jasonjoo2010", "createdAt": "2020-12-15T06:42:46Z", "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/client/HttpClientsFactory.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package com.alibaba.csp.sentinel.transport.heartbeat.client;\n+\n+import com.alibaba.csp.sentinel.transport.endpoint.Protocol;\n+import com.alibaba.csp.sentinel.transport.ssl.SslFactory;\n+import org.apache.http.conn.ssl.NoopHostnameVerifier;\n+import org.apache.http.conn.ssl.SSLConnectionSocketFactory;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+\n+/**\n+ * @author Leo Li\n+ */\n+public class HttpClientsFactory {\n+\n+    private static class SslConnectionSocketFactoryInstance {\n+        private static final SSLConnectionSocketFactory SSL_CONNECTION_SOCKET_FACTORY = new SSLConnectionSocketFactory(SslFactory.getSslConnectionSocketFactory(), NoopHostnameVerifier.INSTANCE);", "originalCommit": "ad8d0af86693d2779f0a5b43c92a10b58d1daff3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "35a9e4d26f24f8971590ab69db3326a544d5a157", "url": "https://github.com/alibaba/Sentinel/commit/35a9e4d26f24f8971590ab69db3326a544d5a157", "message": "optimize", "committedDate": "2020-12-15T07:47:24Z", "type": "commit"}]}