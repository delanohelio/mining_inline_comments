{"pr_number": 1455, "pr_title": "Add Apache HttpClient integration", "pr_createdAt": "2020-05-06T02:19:38Z", "pr_url": "https://github.com/alibaba/Sentinel/pull/1455", "timeline": [{"oid": "1fa15da598abb6688a9c75ebe9f4f89cc77bedff", "url": "https://github.com/alibaba/Sentinel/commit/1fa15da598abb6688a9c75ebe9f4f89cc77bedff", "message": "wip", "committedDate": "2020-05-06T02:17:08Z", "type": "commit"}, {"oid": "1022fbe5b1ca015fd5cb0a4f46e708606bdb3866", "url": "https://github.com/alibaba/Sentinel/commit/1022fbe5b1ca015fd5cb0a4f46e708606bdb3866", "message": "Merge branch 'zhaoyuguang_24' into zhaoyuguang_019", "committedDate": "2020-05-29T07:24:00Z", "type": "commit"}, {"oid": "acb80f7a583d0475078528564aa1c8645895f2d8", "url": "https://github.com/alibaba/Sentinel/commit/acb80f7a583d0475078528564aa1c8645895f2d8", "message": "fix", "committedDate": "2020-05-29T10:15:33Z", "type": "commit"}, {"oid": "4501ae832d7677def1d504fdb630d8a7c2cd2e82", "url": "https://github.com/alibaba/Sentinel/commit/4501ae832d7677def1d504fdb630d8a7c2cd2e82", "message": "add md", "committedDate": "2020-05-29T10:24:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUwOTMxNg==", "url": "https://github.com/alibaba/Sentinel/pull/1455#discussion_r438509316", "bodyText": "In my opinion both parameter #1 and #2 has been wrapped in parameter #3 they are unnecessary.", "author": "jasonjoo2010", "createdAt": "2020-06-11T02:33:09Z", "path": "sentinel-adapter/sentinel-apache-httpclient-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/apache/httpclient/extractor/ApacheHttpClientResourceExtractor.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 1999-2020 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.apache.httpclient.extractor;\n+\n+import org.apache.http.client.methods.HttpRequestWrapper;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+public interface ApacheHttpClientResourceExtractor {\n+\n+    String extractor(String method, String uri, HttpRequestWrapper request);", "originalCommit": "4501ae832d7677def1d504fdb630d8a7c2cd2e82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2MDg2NA==", "url": "https://github.com/alibaba/Sentinel/pull/1455#discussion_r451960864", "bodyText": "The first & two parameters are removed", "author": "zhaoyuguang", "createdAt": "2020-07-09T04:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUwOTMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMTg2MQ==", "url": "https://github.com/alibaba/Sentinel/pull/1455#discussion_r438511861", "bodyText": "The design for additional configuration is quite straightforward. We can't have different configurations between different clients in this design.\nAdapters should follow the ways what they are adapted to follow. HttpClient way is that we can do kinds of decoration, configurations of sockets / interpreters / connection manager / etc. , before we generate the client instance while the client will focus on executing requests. So we should follow this design instead of global shared configuration. It should be extended as new methods of SentinelApacheHttpClientBuilder.", "author": "jasonjoo2010", "createdAt": "2020-06-11T02:44:11Z", "path": "sentinel-adapter/sentinel-apache-httpclient-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/apache/httpclient/config/SentinelApacheHttpClientConfig.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 1999-2020 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.apache.httpclient.config;\n+\n+import com.alibaba.csp.sentinel.adapter.apache.httpclient.extractor.ApacheHttpClientResourceExtractor;\n+import com.alibaba.csp.sentinel.adapter.apache.httpclient.extractor.DefaultApacheHttpClientResourceExtractor;\n+import com.alibaba.csp.sentinel.adapter.apache.httpclient.fallback.ApacheHttpClientFallback;\n+import com.alibaba.csp.sentinel.adapter.apache.httpclient.fallback.DefaultApacheHttpClientFallback;\n+import com.alibaba.csp.sentinel.util.AssertUtil;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+public final class SentinelApacheHttpClientConfig {", "originalCommit": "4501ae832d7677def1d504fdb630d8a7c2cd2e82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2MDk0MA==", "url": "https://github.com/alibaba/Sentinel/pull/1455#discussion_r451960940", "bodyText": "Converted to an internal property of the Builder", "author": "zhaoyuguang", "createdAt": "2020-07-09T04:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMTg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMjA1MQ==", "url": "https://github.com/alibaba/Sentinel/pull/1455#discussion_r438512051", "bodyText": "And surely we will not need the default ones if we implement it as per instance configuration.", "author": "jasonjoo2010", "createdAt": "2020-06-11T02:45:05Z", "path": "sentinel-adapter/sentinel-apache-httpclient-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/apache/httpclient/config/SentinelApacheHttpClientConfig.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 1999-2020 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.apache.httpclient.config;\n+\n+import com.alibaba.csp.sentinel.adapter.apache.httpclient.extractor.ApacheHttpClientResourceExtractor;\n+import com.alibaba.csp.sentinel.adapter.apache.httpclient.extractor.DefaultApacheHttpClientResourceExtractor;\n+import com.alibaba.csp.sentinel.adapter.apache.httpclient.fallback.ApacheHttpClientFallback;\n+import com.alibaba.csp.sentinel.adapter.apache.httpclient.fallback.DefaultApacheHttpClientFallback;\n+import com.alibaba.csp.sentinel.util.AssertUtil;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+public final class SentinelApacheHttpClientConfig {\n+\n+    private static volatile String prefix = \"httpclient:\";\n+    private static volatile ApacheHttpClientResourceExtractor extractor = new DefaultApacheHttpClientResourceExtractor();\n+    private static volatile ApacheHttpClientFallback fallback = new DefaultApacheHttpClientFallback();", "originalCommit": "4501ae832d7677def1d504fdb630d8a7c2cd2e82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NTY5OQ==", "url": "https://github.com/alibaba/Sentinel/pull/1455#discussion_r451985699", "bodyText": "Converted to an internal property of the Builder", "author": "zhaoyuguang", "createdAt": "2020-07-09T06:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMjA1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMzM1Nw==", "url": "https://github.com/alibaba/Sentinel/pull/1455#discussion_r438513357", "bodyText": "As the default implementation i can't quite agree with including METHOD in resource name.\nPlease go for advices from other reviewers, too.", "author": "jasonjoo2010", "createdAt": "2020-06-11T02:50:16Z", "path": "sentinel-adapter/sentinel-apache-httpclient-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/apache/httpclient/extractor/DefaultApacheHttpClientResourceExtractor.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Copyright 1999-2020 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.apache.httpclient.extractor;\n+\n+import org.apache.http.client.methods.HttpRequestWrapper;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+public class DefaultApacheHttpClientResourceExtractor implements ApacheHttpClientResourceExtractor {\n+\n+    @Override\n+    public String extractor(String method, String uri, HttpRequestWrapper request) {\n+        return method + \":\" + uri;", "originalCommit": "4501ae832d7677def1d504fdb630d8a7c2cd2e82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NTQ3Mw==", "url": "https://github.com/alibaba/Sentinel/pull/1455#discussion_r451985473", "bodyText": "method  has remove", "author": "zhaoyuguang", "createdAt": "2020-07-09T06:12:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMzM1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMzk3NA==", "url": "https://github.com/alibaba/Sentinel/pull/1455#discussion_r438513974", "bodyText": "I suggest that Exception propagation can be implemented in the customized chain directly.", "author": "jasonjoo2010", "createdAt": "2020-06-11T02:52:43Z", "path": "sentinel-adapter/sentinel-apache-httpclient-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/apache/httpclient/fallback/DefaultApacheHttpClientFallback.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 1999-2020 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.apache.httpclient.fallback;\n+\n+import com.alibaba.csp.sentinel.slots.block.BlockException;\n+import com.alibaba.csp.sentinel.slots.block.SentinelRpcException;\n+import org.apache.http.HttpException;\n+import org.apache.http.HttpRequest;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpRequestWrapper;\n+import org.apache.http.protocol.HttpContext;\n+\n+import java.io.IOException;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+public class DefaultApacheHttpClientFallback implements ApacheHttpClientFallback {\n+\n+    @Override\n+    public CloseableHttpResponse handle(HttpRequestWrapper request, BlockException e) {\n+        // Just wrap and throw the exception.\n+        throw new SentinelRpcException(e);", "originalCommit": "4501ae832d7677def1d504fdb630d8a7c2cd2e82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "068dcd83dc51a5cc5e629d69a0cf5d2e42988dd8", "url": "https://github.com/alibaba/Sentinel/commit/068dcd83dc51a5cc5e629d69a0cf5d2e42988dd8", "message": "fix", "committedDate": "2020-07-09T04:05:29Z", "type": "commit"}, {"oid": "24f09bf0b0efa5eb52da15ffed61a5cdd04ccf65", "url": "https://github.com/alibaba/Sentinel/commit/24f09bf0b0efa5eb52da15ffed61a5cdd04ccf65", "message": "fix md", "committedDate": "2020-07-09T04:52:43Z", "type": "commit"}]}