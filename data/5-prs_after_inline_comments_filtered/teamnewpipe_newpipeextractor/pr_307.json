{"pr_number": 307, "pr_title": "[PeerTube] playlist support", "pr_createdAt": "2020-04-09T16:05:32Z", "pr_url": "https://github.com/TeamNewPipe/NewPipeExtractor/pull/307", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1Mzg5Mg==", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/pull/307#discussion_r406353892", "bodyText": "When getInitialPage() is called, fetchPage() should always already have been called, so no need to call it here. You also shouldn't fetch the initial page in onFetchPage() yet, but only in getInitialPage() and getNextPageUrl() if it hasn't been fetched yet.\nI see that something similar is done in some other services though, but that should also be changed, and imho we should just remove getNextPageUrl().", "author": "wb9688", "createdAt": "2020-04-09T17:14:24Z", "path": "extractor/src/main/java/org/schabi/newpipe/extractor/services/peertube/extractors/PeertubePlaylistExtractor.java", "diffHunk": "@@ -1,85 +1,117 @@\n package org.schabi.newpipe.extractor.services.peertube.extractors;\n \n+import com.grack.nanojson.JsonArray;\n+import com.grack.nanojson.JsonObject;\n+import com.grack.nanojson.JsonParser;\n+import com.grack.nanojson.JsonParserException;\n import org.schabi.newpipe.extractor.StreamingService;\n import org.schabi.newpipe.extractor.downloader.Downloader;\n+import org.schabi.newpipe.extractor.downloader.Response;\n import org.schabi.newpipe.extractor.exceptions.ExtractionException;\n import org.schabi.newpipe.extractor.exceptions.ParsingException;\n import org.schabi.newpipe.extractor.linkhandler.ListLinkHandler;\n import org.schabi.newpipe.extractor.playlist.PlaylistExtractor;\n+import org.schabi.newpipe.extractor.services.peertube.PeertubeParsingHelper;\n import org.schabi.newpipe.extractor.stream.StreamInfoItem;\n+import org.schabi.newpipe.extractor.stream.StreamInfoItemsCollector;\n+import org.schabi.newpipe.extractor.utils.JsonUtils;\n \n+import javax.annotation.Nonnull;\n import java.io.IOException;\n \n+import static org.schabi.newpipe.extractor.services.peertube.PeertubeParsingHelper.*;\n+\n public class PeertubePlaylistExtractor extends PlaylistExtractor {\n \n+    private JsonObject playlistInfo;\n+    private JsonObject playlistVideos;\n+\n+    private InfoItemsPage<StreamInfoItem> initPage;\n+    private long total;\n+\n     public PeertubePlaylistExtractor(StreamingService service, ListLinkHandler linkHandler) {\n         super(service, linkHandler);\n-        // TODO Auto-generated constructor stub\n     }\n \n     @Override\n     public String getThumbnailUrl() throws ParsingException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        return getBaseUrl() + playlistInfo.getString(\"thumbnailPath\");\n     }\n \n     @Override\n     public String getBannerUrl() throws ParsingException {\n-        // TODO Auto-generated method stub\n         return null;\n     }\n \n     @Override\n     public String getUploaderUrl() throws ParsingException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        return playlistInfo.getObject(\"ownerAccount\").getString(\"url\");\n     }\n \n     @Override\n     public String getUploaderName() throws ParsingException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        return playlistInfo.getObject(\"ownerAccount\").getString(\"displayName\");\n     }\n \n     @Override\n     public String getUploaderAvatarUrl() throws ParsingException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        return getBaseUrl() + playlistInfo.getObject(\"ownerAccount\").getObject(\"avatar\").getString(\"path\");\n     }\n \n     @Override\n     public long getStreamCount() throws ParsingException {\n-        // TODO Auto-generated method stub\n-        return 0;\n+        return playlistInfo.getNumber(\"videosLength\").longValue();\n     }\n \n+    @Nonnull\n     @Override\n     public InfoItemsPage<StreamInfoItem> getInitialPage() throws IOException, ExtractionException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        super.fetchPage();", "originalCommit": "d20d9148633128e36b6d9bb099d8ed1943414e02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fcb3f25bccb7ba1223908276f3b7998a7255010c", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/commit/fcb3f25bccb7ba1223908276f3b7998a7255010c", "message": "[PeerTube] playlist support & refactoring", "committedDate": "2020-04-10T17:54:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0ODgzNw==", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/pull/307#discussion_r407048837", "bodyText": "maybe use /playlist/ ? that way it would not filter /videos/watch/696969playlist696969", "author": "yausername", "createdAt": "2020-04-11T10:50:28Z", "path": "extractor/src/main/java/org/schabi/newpipe/extractor/services/peertube/linkHandler/PeertubeStreamLinkHandlerFactory.java", "diffHunk": "@@ -37,6 +37,12 @@ public String getId(String url) throws ParsingException, IllegalArgumentExceptio\n \n     @Override\n     public boolean onAcceptUrl(final String url) throws FoundAdException {\n-        return url.contains(\"/videos/\");\n+        if (url.contains(\"playlist\")) return false;", "originalCommit": "fcb3f25bccb7ba1223908276f3b7998a7255010c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "982b28df5f0ac32aafce4c3766bb92798a23da40", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/commit/982b28df5f0ac32aafce4c3766bb92798a23da40", "message": "address yausername change", "committedDate": "2020-04-11T13:04:10Z", "type": "forcePushed"}, {"oid": "061720d137f3ca2cfa628f4ff699db3388d7ed5e", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/commit/061720d137f3ca2cfa628f4ff699db3388d7ed5e", "message": "address yausername change", "committedDate": "2020-05-05T13:26:48Z", "type": "forcePushed"}, {"oid": "5bab9d9fc00cc36d4efc0170efa417db91e4eb51", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/commit/5bab9d9fc00cc36d4efc0170efa417db91e4eb51", "message": "[PeerTube] playlist support & refactoring", "committedDate": "2020-05-08T22:52:04Z", "type": "commit"}, {"oid": "cf99107745a86c0f4f65a405e9eb7ebbe7673d38", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/commit/cf99107745a86c0f4f65a405e9eb7ebbe7673d38", "message": "address yausername change", "committedDate": "2020-05-08T22:52:04Z", "type": "commit"}, {"oid": "1a6e92ebf6e1ba2db6076cf06660991b8972cf8f", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/commit/1a6e92ebf6e1ba2db6076cf06660991b8972cf8f", "message": "add getSubChannel Name, Url and AvatarUrl for playlists", "committedDate": "2020-05-09T07:52:24Z", "type": "commit"}, {"oid": "7cae95bf09ddc59ec77b3a905a23278318ef15f7", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/commit/7cae95bf09ddc59ec77b3a905a23278318ef15f7", "message": "add tests for subchannel stuff in playlists", "committedDate": "2020-05-09T08:15:35Z", "type": "commit"}, {"oid": "7cae95bf09ddc59ec77b3a905a23278318ef15f7", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/commit/7cae95bf09ddc59ec77b3a905a23278318ef15f7", "message": "add tests for subchannel stuff in playlists", "committedDate": "2020-05-09T08:15:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA3OTM5Mg==", "url": "https://github.com/TeamNewPipe/NewPipeExtractor/pull/307#discussion_r423079392", "bodyText": "This shouldn't happen like this, however it's not worth fixing it until my next page PR (where you could just make it a normal variable in the function), especially as it's done like this in the other PeerTube ListExtractors as well.", "author": "wb9688", "createdAt": "2020-05-11T14:26:51Z", "path": "extractor/src/main/java/org/schabi/newpipe/extractor/services/peertube/extractors/PeertubePlaylistExtractor.java", "diffHunk": "@@ -1,85 +1,135 @@\n package org.schabi.newpipe.extractor.services.peertube.extractors;\n \n+import com.grack.nanojson.JsonArray;\n+import com.grack.nanojson.JsonObject;\n+import com.grack.nanojson.JsonParser;\n+import com.grack.nanojson.JsonParserException;\n import org.schabi.newpipe.extractor.StreamingService;\n import org.schabi.newpipe.extractor.downloader.Downloader;\n+import org.schabi.newpipe.extractor.downloader.Response;\n import org.schabi.newpipe.extractor.exceptions.ExtractionException;\n import org.schabi.newpipe.extractor.exceptions.ParsingException;\n import org.schabi.newpipe.extractor.linkhandler.ListLinkHandler;\n import org.schabi.newpipe.extractor.playlist.PlaylistExtractor;\n+import org.schabi.newpipe.extractor.services.peertube.PeertubeParsingHelper;\n import org.schabi.newpipe.extractor.stream.StreamInfoItem;\n+import org.schabi.newpipe.extractor.stream.StreamInfoItemsCollector;\n+import org.schabi.newpipe.extractor.utils.JsonUtils;\n \n+import javax.annotation.Nonnull;\n import java.io.IOException;\n \n+import static org.schabi.newpipe.extractor.services.peertube.PeertubeParsingHelper.*;\n+\n public class PeertubePlaylistExtractor extends PlaylistExtractor {\n \n+    private JsonObject playlistInfo;\n+    private JsonObject playlistVideos;\n+    private String initialPageUrl;\n+\n+    private long total;\n+\n     public PeertubePlaylistExtractor(StreamingService service, ListLinkHandler linkHandler) {\n         super(service, linkHandler);\n-        // TODO Auto-generated constructor stub\n     }\n \n     @Override\n     public String getThumbnailUrl() throws ParsingException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        return getBaseUrl() + playlistInfo.getString(\"thumbnailPath\");\n     }\n \n     @Override\n     public String getBannerUrl() throws ParsingException {\n-        // TODO Auto-generated method stub\n         return null;\n     }\n \n     @Override\n     public String getUploaderUrl() throws ParsingException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        return playlistInfo.getObject(\"ownerAccount\").getString(\"url\");\n     }\n \n     @Override\n     public String getUploaderName() throws ParsingException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        return playlistInfo.getObject(\"ownerAccount\").getString(\"displayName\");\n     }\n \n     @Override\n     public String getUploaderAvatarUrl() throws ParsingException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        return getBaseUrl() + playlistInfo.getObject(\"ownerAccount\").getObject(\"avatar\").getString(\"path\");\n     }\n \n     @Override\n     public long getStreamCount() throws ParsingException {\n-        // TODO Auto-generated method stub\n-        return 0;\n+        return playlistInfo.getNumber(\"videosLength\").longValue();\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public String getSubChannelName() throws ParsingException {\n+        return playlistInfo.getObject(\"videoChannel\").getString(\"displayName\");\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public String getSubChannelUrl() throws ParsingException {\n+        return playlistInfo.getObject(\"videoChannel\").getString(\"url\");\n     }\n \n+    @Nonnull\n+    @Override\n+    public String getSubChannelAvatarUrl() throws ParsingException {\n+        return getBaseUrl() + playlistInfo.getObject(\"videoChannel\").getObject(\"avatar\").getString(\"path\");\n+    }\n+\n+    @Nonnull\n     @Override\n     public InfoItemsPage<StreamInfoItem> getInitialPage() throws IOException, ExtractionException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        return getPage(initialPageUrl);\n     }\n \n     @Override\n     public String getNextPageUrl() throws IOException, ExtractionException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        return PeertubeParsingHelper.getNextPageUrl(initialPageUrl, total);\n     }\n \n     @Override\n     public InfoItemsPage<StreamInfoItem> getPage(String pageUrl) throws IOException, ExtractionException {\n-        // TODO Auto-generated method stub\n-        return null;\n+        Response response = getDownloader().get(pageUrl);\n+        try {\n+            playlistVideos = JsonParser.object().from(response.responseBody());\n+        } catch (JsonParserException jpe) {\n+            throw new ExtractionException(\"Could not parse json\", jpe);\n+        }\n+        PeertubeParsingHelper.validate(playlistVideos);\n+\n+        this.total = JsonUtils.getNumber(playlistVideos, \"total\").longValue();", "originalCommit": "7cae95bf09ddc59ec77b3a905a23278318ef15f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}