{"pr_number": 1543, "pr_title": "[IOTDB-811] fix upgrading mlog many times when upgrading system.properties crashed", "pr_createdAt": "2020-07-23T01:32:35Z", "pr_url": "https://github.com/apache/iotdb/pull/1543", "timeline": [{"oid": "46115d079e07edbd9927078b289e1dae08ab2ad0", "url": "https://github.com/apache/iotdb/commit/46115d079e07edbd9927078b289e1dae08ab2ad0", "message": "fix upgrading mlog many times", "committedDate": "2020-07-23T01:31:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE4MTMwNA==", "url": "https://github.com/apache/iotdb/pull/1543#discussion_r459181304", "bodyText": "It suddenly occurs to me that mlog is a system file but FSFactoryProducer.getFSFactory() is for data files (like tsfile)... This may result in the problem that when upgrading 0.9 version tsfiles, HDFS cannot find mlog because it is actually stored in local.\nSorry I forgot and ignored it in the PR #1540 yesterday... \ud83d\ude23\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  FSFactoryProducer.getFSFactory().moveFile(tmpMLogFile, mlogFile);\n          \n          \n            \n                  FileUtils.moveFile(tmpMLogFile, mlogFile);", "author": "samperson1997", "createdAt": "2020-07-23T02:15:24Z", "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfigCheck.java", "diffHunk": "@@ -191,6 +191,18 @@ public void checkConfig() throws IOException {\n       checkUnClosedTsFileV1();\n       MLogWriter.upgradeMLog(SCHEMA_DIR, MetadataConstant.METADATA_LOG);\n       upgradePropertiesFile();\n+\n+      // upgrade mlog finished, delete old mlog file\n+      File mlogFile = SystemFileFactory.INSTANCE.getFile(SCHEMA_DIR + File.separator\n+          + MetadataConstant.METADATA_LOG);\n+      File tmpMLogFile = SystemFileFactory.INSTANCE.getFile(mlogFile.getAbsolutePath()\n+          + \".tmp\");\n+\n+      if (!mlogFile.delete()) {\n+        throw new IOException(\"Deleting \" + mlogFile + \"failed.\");\n+      }\n+      // rename tmpLogFile to mlog\n+      FSFactoryProducer.getFSFactory().moveFile(tmpMLogFile, mlogFile);", "originalCommit": "46115d079e07edbd9927078b289e1dae08ab2ad0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "667f4535e236a793188811a2dbbcdd44b63c2105", "url": "https://github.com/apache/iotdb/commit/667f4535e236a793188811a2dbbcdd44b63c2105", "message": "Update server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfigCheck.java\n\nCo-authored-by: Zesong Sun <szs19@mails.tsinghua.edu.cn>", "committedDate": "2020-07-23T02:41:27Z", "type": "commit"}]}