{"pr_number": 2029, "pr_title": "[IOTDB-825] aggregation by natural month", "pr_createdAt": "2020-11-12T03:59:48Z", "pr_url": "https://github.com/apache/iotdb/pull/2029", "timeline": [{"oid": "c3063f35b0b6a307ac3d1e8176ea451de529f40d", "url": "https://github.com/apache/iotdb/commit/c3063f35b0b6a307ac3d1e8176ea451de529f40d", "message": "group by natural month", "committedDate": "2020-11-12T06:40:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3NDYzOQ==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r521874639", "bodyText": "Hi, what is this import for?", "author": "HTHou", "createdAt": "2020-11-12T06:52:41Z", "path": "server/src/test/java/org/apache/iotdb/db/query/executor/GroupByEngineDataSetTest.java", "diffHunk": "@@ -19,9 +19,16 @@\n package org.apache.iotdb.db.query.executor;\n \n \n+import com.sun.xml.internal.ws.api.message.saaj.SaajStaxWriter;", "originalCommit": "c3063f35b0b6a307ac3d1e8176ea451de529f40d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3ODMzOA==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r521878338", "bodyText": "removed. thank you!", "author": "haimeiguo", "createdAt": "2020-11-12T07:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3NDYzOQ=="}], "type": "inlineReview"}, {"oid": "6048bab5676d234de8293bf13662a01cc9385bff", "url": "https://github.com/apache/iotdb/commit/6048bab5676d234de8293bf13662a01cc9385bff", "message": "group by natural month", "committedDate": "2020-11-12T07:02:06Z", "type": "forcePushed"}, {"oid": "a29df2301ae6c4e6cc8b579a0ab1a6a598237a1a", "url": "https://github.com/apache/iotdb/commit/a29df2301ae6c4e6cc8b579a0ab1a6a598237a1a", "message": "edit sql reference doc", "committedDate": "2020-11-17T04:05:16Z", "type": "forcePushed"}, {"oid": "b277867cef5777c71823c53b87702136d42913eb", "url": "https://github.com/apache/iotdb/commit/b277867cef5777c71823c53b87702136d42913eb", "message": "edit sql reference doc", "committedDate": "2020-11-17T06:30:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkwNTIzMA==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r524905230", "bodyText": "define the number to a const variable", "author": "mychaow", "createdAt": "2020-11-17T06:10:40Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/groupby/GroupByEngineDataSet.java", "diffHunk": "@@ -70,36 +77,69 @@ public GroupByEngineDataSet(QueryContext context, GroupByTimePlan groupByTimePla\n       long intervalNum = (long) Math.ceil(queryRange / (double) slidingStep);\n       curStartTime = slidingStep * (intervalNum - 1) + startTime;\n     }\n-    curEndTime = Math.min(curStartTime + interval, endTime);\n+\n+    //if is group by months interval and sliding step are calculated in ms by * 30 * 86400_000L\n+    //now converting them back to integer months\n+    if (isIntervalByMonth) {\n+      interval = interval / 30 / 86400_000L;", "originalCommit": "a29df2301ae6c4e6cc8b579a0ab1a6a598237a1a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkxMzM2Mg==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r524913362", "bodyText": "Please add some comments about the implement. You could list some example to explain it.", "author": "mychaow", "createdAt": "2020-11-17T06:35:16Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/groupby/GroupByEngineDataSet.java", "diffHunk": "@@ -70,36 +77,69 @@ public GroupByEngineDataSet(QueryContext context, GroupByTimePlan groupByTimePla\n       long intervalNum = (long) Math.ceil(queryRange / (double) slidingStep);\n       curStartTime = slidingStep * (intervalNum - 1) + startTime;\n     }\n-    curEndTime = Math.min(curStartTime + interval, endTime);\n+\n+    //if is group by months interval and sliding step are calculated in ms by * 30 * 86400_000L\n+    //now converting them back to integer months\n+    if (isIntervalByMonth) {\n+      interval = interval / 30 / 86400_000L;\n+      curEndTime = Math.min(curStartTime + calcIntervalByMonth(interval, curStartTime), endTime);", "originalCommit": "b277867cef5777c71823c53b87702136d42913eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2MTg4MA==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r524961880", "bodyText": "added. Thank you!", "author": "haimeiguo", "createdAt": "2020-11-17T08:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkxMzM2Mg=="}], "type": "inlineReview"}, {"oid": "6635167799a704cdc9b61c7131a63a014f8a033f", "url": "https://github.com/apache/iotdb/commit/6635167799a704cdc9b61c7131a63a014f8a033f", "message": "edit sql reference doc", "committedDate": "2020-11-17T08:16:10Z", "type": "forcePushed"}, {"oid": "faa9a275de22d1eacb3e6a96662558d1d76c67c2", "url": "https://github.com/apache/iotdb/commit/faa9a275de22d1eacb3e6a96662558d1d76c67c2", "message": "edit sql reference doc", "committedDate": "2020-11-17T11:56:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcxNTE4Mg==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r526715182", "bodyText": "I think the logic here should be moved to the enterGroupByTimeClause() function, because only group by time query has the two attributes: isIntervalByMonth and isSlidingStepByMonth .\nAnd if so, isParsingSlidingStep is useless.", "author": "JackieTien97", "createdAt": "2020-11-19T09:32:15Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/LogicalGenerator.java", "diffHunk": "@@ -1411,6 +1418,16 @@ private Long parseDuration(String durationStr) {\n           i++;\n           unit += durationStr.charAt(i);\n         }\n+        if (unit.toLowerCase().equals(\"mo\")) {\n+          //interval is by month, sliding step by default equals to interval\n+          if (!isParsingSlidingStep) {\n+            queryOp.setIntervalByMonth(true);\n+          }\n+          queryOp.setSlidingStepByMonth(true);\n+        } else if (isParsingSlidingStep) {\n+          //parsing sliding step value, and unit is not by month\n+          queryOp.setSlidingStepByMonth(false);\n+        }", "originalCommit": "faa9a275de22d1eacb3e6a96662558d1d76c67c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNzg0Ng==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r528527846", "bodyText": "Hi, thank you for your review.\nIn parseDuration clause, it converts the interval and sliding step in milliseconds, also determines the unit for natural month aggregation. If I put the parsing \"mo\" in enterGroupByTimeClause(). i think it will be redoing the same thing.", "author": "haimeiguo", "createdAt": "2020-11-23T08:17:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcxNTE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcxNjI3OQ==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r526716279", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private final long msToMonth = 30 * 86400_000L;\n          \n          \n            \n              private static final long MS_T0_MONTH = 30 * 86400_000L;", "author": "JackieTien97", "createdAt": "2020-11-19T09:33:50Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/groupby/GroupByEngineDataSet.java", "diffHunk": "@@ -43,6 +45,10 @@\n   protected boolean hasCachedTimeInterval;\n \n   protected boolean leftCRightO;\n+  private boolean isIntervalByMonth = false;\n+  private boolean isSlidingStepByMonth = false;\n+  protected int intervalTimes;\n+  private final long msToMonth = 30 * 86400_000L;", "originalCommit": "faa9a275de22d1eacb3e6a96662558d1d76c67c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ5MDY5Mg==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r527490692", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private final long msToMonth = 30 * 86400_000L;\n          \n          \n            \n              private static final long MS_TO_MONTH = 30 * 86400_000L;\n          \n      \n    \n    \n  \n\n\ud83d\ude02", "author": "HTHou", "createdAt": "2020-11-20T07:33:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcxNjI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjczMzc2Nw==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r526733767", "bodyText": "I think you can directly return the calendar.getTimeInMillis() instead of the delta to curStartTime, because it seems that you still add the curStartTime each time you call the calcIntervalByMonth function.\nAnd in this function, it's better to use calendar.setTimeInMillis(curStartTime); instead of startTime, if so the attribute intervalTimes can be deleted.", "author": "JackieTien97", "createdAt": "2020-11-19T09:59:15Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/groupby/GroupByEngineDataSet.java", "diffHunk": "@@ -70,36 +78,72 @@ public GroupByEngineDataSet(QueryContext context, GroupByTimePlan groupByTimePla\n       long intervalNum = (long) Math.ceil(queryRange / (double) slidingStep);\n       curStartTime = slidingStep * (intervalNum - 1) + startTime;\n     }\n-    curEndTime = Math.min(curStartTime + interval, endTime);\n+\n+\n+    if (isIntervalByMonth) {\n+      //if is group by months interval and sliding step are calculated in ms by * 30 * 86400_000L\n+      //now converting them back to integer months\n+      interval = interval / msToMonth;\n+      //calculate interval length by natural month based on curStartTime\n+      //ie. startTIme = 1/31, interval = 1mo, curEndTime will be set to 2/29\n+      curEndTime = Math.min(curStartTime + calcIntervalByMonth(interval, curStartTime), endTime);\n+    } else {\n+      curEndTime = Math.min(curStartTime + interval, endTime);\n+    }\n+    if (isSlidingStepByMonth) {\n+      slidingStep = slidingStep / msToMonth;\n+    }\n     this.hasCachedTimeInterval = true;\n   }\n \n   @Override\n   protected boolean hasNextWithoutConstraint() {\n+    long curSlidingStep = slidingStep;\n+    long curInterval = interval;\n     // has cached\n     if (hasCachedTimeInterval) {\n       return true;\n     }\n \n+    intervalTimes++;\n+    //group by natural month, given startTime recalculate interval and sliding step\n+    if (isIntervalByMonth) {\n+      curInterval = calcIntervalByMonth(intervalTimes * slidingStep + interval, startTime);\n+    }\n+    if (isSlidingStepByMonth) {\n+      curSlidingStep = calcIntervalByMonth(slidingStep * intervalTimes, curStartTime);\n+    }\n+\n     // check if the next interval out of range\n     if (ascending) {\n-      curStartTime += slidingStep;\n+      curStartTime += curSlidingStep;\n       //This is an open interval , [0-100)\n       if (curStartTime >= endTime) {\n         return false;\n       }\n     } else {\n-      curStartTime -= slidingStep;\n+      curStartTime -= curSlidingStep;\n       if (curStartTime < startTime) {\n         return false;\n       }\n     }\n \n     hasCachedTimeInterval = true;\n-    curEndTime = Math.min(curStartTime + interval, endTime);\n+    if (isIntervalByMonth) {\n+      curEndTime = Math.min(startTime + curInterval, endTime);\n+    } else {\n+      curEndTime = Math.min(curStartTime + curInterval, endTime);\n+    }\n     return true;\n   }\n \n+  public long calcIntervalByMonth(long numMonths, long curStartTime) {\n+    Calendar calendar = Calendar.getInstance();\n+    calendar.setTimeInMillis(startTime);\n+    calendar.add(Calendar.MONTH, (int) (numMonths));\n+    return calendar.getTimeInMillis() - curStartTime;\n+  }\n+", "originalCommit": "faa9a275de22d1eacb3e6a96662558d1d76c67c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzNTMyNA==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r528535324", "bodyText": "Hi, the calendar is set to the original startTime and uses intervalTImes to calendar.add() in case of dates = 29, 30, 31\nie.\nwhen add one month to 1/31, curStartTime increments to 2/29\nif then set calendar to curStartTime = 2/29, then increments one month, we get curStartTime = 3/29, which is not what we intended. What we want is 1/31, 2/29, 3/30, 4/31 ....\nso I used intervalTimes each time calculating the interval and set calendar to original startTime and add intervalTimes months to startTime to avoid edge cases.", "author": "haimeiguo", "createdAt": "2020-11-23T08:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjczMzc2Nw=="}], "type": "inlineReview"}, {"oid": "a828c187672f4da233949e64e3f98fe4603b5c2d", "url": "https://github.com/apache/iotdb/commit/a828c187672f4da233949e64e3f98fe4603b5c2d", "message": "group by descending", "committedDate": "2020-11-27T03:47:33Z", "type": "forcePushed"}, {"oid": "b010445a9fdd263d8869d24de2e3f8e2b512ce4b", "url": "https://github.com/apache/iotdb/commit/b010445a9fdd263d8869d24de2e3f8e2b512ce4b", "message": "group by descending", "committedDate": "2020-11-27T08:04:12Z", "type": "forcePushed"}, {"oid": "6794be549cb49095c9149e688b4ef56c1e29fe21", "url": "https://github.com/apache/iotdb/commit/6794be549cb49095c9149e688b4ef56c1e29fe21", "message": "user guide aggregation by month", "committedDate": "2020-12-08T06:59:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA5Nzk5NQ==", "url": "https://github.com/apache/iotdb/pull/2029#discussion_r538097995", "bodyText": "I just wonder how to set the curStartTime... pls add a Javadoc for this function and the intervalTimes", "author": "qiaojialin", "createdAt": "2020-12-08T07:32:13Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/groupby/GroupByEngineDataSet.java", "diffHunk": "@@ -68,38 +80,81 @@ public GroupByEngineDataSet(QueryContext context, GroupByTimePlan groupByTimePla\n       long queryRange = endTime - startTime;\n       // calculate the total interval number\n       long intervalNum = (long) Math.ceil(queryRange / (double) slidingStep);\n-      curStartTime = slidingStep * (intervalNum - 1) + startTime;\n+      if (isSlidingStepByMonth) {\n+        intervalTimes = (int) intervalNum - 1;\n+        curStartTime = startTime + calcIntervalByMonth(intervalTimes * slidingStep / MS_TO_MONTH, startTime);\n+      } else {\n+        curStartTime = slidingStep * (intervalNum - 1) + startTime;\n+      }\n+    }\n+\n+    if (isSlidingStepByMonth) {\n+      slidingStep = slidingStep / MS_TO_MONTH;\n+    }\n+\n+    if (isIntervalByMonth) {\n+      //calculate interval length by natural month based on curStartTime\n+      //ie. startTIme = 1/31, interval = 1mo, curEndTime will be set to 2/29\n+      curEndTime = Math.min(startTime + calcIntervalByMonth(interval + slidingStep * intervalTimes, startTime), endTime);\n+    } else {\n+      curEndTime = Math.min(curStartTime + interval, endTime);\n     }\n-    curEndTime = Math.min(curStartTime + interval, endTime);\n+\n     this.hasCachedTimeInterval = true;\n   }\n \n   @Override\n   protected boolean hasNextWithoutConstraint() {\n+    long curSlidingStep = slidingStep;\n+    long curInterval = interval;\n     // has cached\n     if (hasCachedTimeInterval) {\n       return true;\n     }\n \n+    intervalTimes += ascending ? 1 : -1;\n+    //group by natural month, given startTime recalculate interval and sliding step\n+    if (isIntervalByMonth) {\n+      curInterval = calcIntervalByMonth(intervalTimes * slidingStep + interval, startTime);\n+    }\n+    if (isSlidingStepByMonth) {\n+      curSlidingStep = calcIntervalByMonth(slidingStep * intervalTimes, curStartTime);\n+    }\n+\n     // check if the next interval out of range\n     if (ascending) {\n-      curStartTime += slidingStep;\n+      curStartTime += curSlidingStep;\n       //This is an open interval , [0-100)\n       if (curStartTime >= endTime) {\n         return false;\n       }\n     } else {\n-      curStartTime -= slidingStep;\n+      if (isSlidingStepByMonth) {\n+        curStartTime = startTime + calcIntervalByMonth(slidingStep * intervalTimes, startTime);\n+      } else {\n+        curStartTime -= curSlidingStep;\n+      }\n       if (curStartTime < startTime) {\n         return false;\n       }\n     }\n \n     hasCachedTimeInterval = true;\n-    curEndTime = Math.min(curStartTime + interval, endTime);\n+    if (isIntervalByMonth) {\n+      curEndTime = Math.min(startTime + curInterval, endTime);\n+    } else {\n+      curEndTime = Math.min(curStartTime + curInterval, endTime);\n+    }\n     return true;\n   }\n \n+  public long calcIntervalByMonth(long numMonths, long curStartTime) {", "originalCommit": "6794be549cb49095c9149e688b4ef56c1e29fe21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "884445b1691e1433089c04af0c456236ebcfb6ae", "url": "https://github.com/apache/iotdb/commit/884445b1691e1433089c04af0c456236ebcfb6ae", "message": "group by natural month", "committedDate": "2020-12-14T07:18:54Z", "type": "commit"}, {"oid": "d624ee8e96d1f785b58057c3b2fed55c96f89f8b", "url": "https://github.com/apache/iotdb/commit/d624ee8e96d1f785b58057c3b2fed55c96f89f8b", "message": "edit sql reference doc", "committedDate": "2020-12-14T07:18:55Z", "type": "commit"}, {"oid": "f37bcd8038b7efdab11e64b56386a1711341dcf3", "url": "https://github.com/apache/iotdb/commit/f37bcd8038b7efdab11e64b56386a1711341dcf3", "message": "group by descending", "committedDate": "2020-12-14T07:20:37Z", "type": "commit"}, {"oid": "33efa4a98bad9fe2b8248edc445920ee210b97a1", "url": "https://github.com/apache/iotdb/commit/33efa4a98bad9fe2b8248edc445920ee210b97a1", "message": "user guide aggregation by month", "committedDate": "2020-12-14T07:20:42Z", "type": "commit"}, {"oid": "f6b24236d32b359df3fb88a9650123dbe54c929c", "url": "https://github.com/apache/iotdb/commit/f6b24236d32b359df3fb88a9650123dbe54c929c", "message": "calc interval, docs", "committedDate": "2020-12-14T07:41:42Z", "type": "forcePushed"}, {"oid": "3d4bf59a03c69601311dea1ea1a6e96ecdbc3f84", "url": "https://github.com/apache/iotdb/commit/3d4bf59a03c69601311dea1ea1a6e96ecdbc3f84", "message": "calc interval, docs", "committedDate": "2020-12-14T07:45:52Z", "type": "forcePushed"}, {"oid": "9f4f3de724850f746a586c173ef329b83bddc9ca", "url": "https://github.com/apache/iotdb/commit/9f4f3de724850f746a586c173ef329b83bddc9ca", "message": "calc interval, docs", "committedDate": "2020-12-14T07:47:36Z", "type": "commit"}, {"oid": "9f4f3de724850f746a586c173ef329b83bddc9ca", "url": "https://github.com/apache/iotdb/commit/9f4f3de724850f746a586c173ef329b83bddc9ca", "message": "calc interval, docs", "committedDate": "2020-12-14T07:47:36Z", "type": "forcePushed"}]}