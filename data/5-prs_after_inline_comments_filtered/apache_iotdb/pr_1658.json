{"pr_number": 1658, "pr_title": "[IOTDB-839] Make Tablet api more friendly", "pr_createdAt": "2020-08-28T09:51:22Z", "pr_url": "https://github.com/apache/iotdb/pull/1658", "timeline": [{"oid": "dc403d30faa565a02c16c92386516b5fcbea849e", "url": "https://github.com/apache/iotdb/commit/dc403d30faa565a02c16c92386516b5fcbea849e", "message": "IOTDB-839:Make Tablet api more friendly", "committedDate": "2020-08-28T09:44:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA2MTQ1NA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479061454", "bodyText": "It's not a good way to get the index, measurements maybe very large. You should store the measurementSchema as a map", "author": "mychaow", "createdAt": "2020-08-28T10:02:51Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -81,6 +82,43 @@ public Tablet(String deviceId, List<MeasurementSchema> timeseries) {\n     this(deviceId, timeseries, DEFAULT_SIZE);\n   }\n \n+  public void addTimestamp(int rowIndex, long timestamp) {\n+    timestamps[rowIndex - 1] = timestamp;\n+  }\n+\n+  public void addValue(MeasurementSchema measurementSchema, int rowIndex, Object value) {\n+\n+    int indexOfValue = schemas.indexOf(measurementSchema);", "originalCommit": "dc403d30faa565a02c16c92386516b5fcbea849e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA2NDkwMw==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479064903", "bodyText": "what is the meaning of this line?", "author": "mychaow", "createdAt": "2020-08-28T10:05:39Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -81,6 +82,43 @@ public Tablet(String deviceId, List<MeasurementSchema> timeseries) {\n     this(deviceId, timeseries, DEFAULT_SIZE);\n   }\n \n+  public void addTimestamp(int rowIndex, long timestamp) {\n+    timestamps[rowIndex - 1] = timestamp;\n+  }\n+\n+  public void addValue(MeasurementSchema measurementSchema, int rowIndex, Object value) {\n+\n+    int indexOfValue = schemas.indexOf(measurementSchema);\n+    if (measurementSchema.getType() == INT64) {\n+      long[] sensor = (long[]) values[indexOfValue];\n+      sensor[rowIndex - 1] = (long) value;\n+      values[indexOfValue] = sensor;", "originalCommit": "dc403d30faa565a02c16c92386516b5fcbea849e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA2NjMyOA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479066328", "bodyText": "rowIndex maybe starts with 0?", "author": "mychaow", "createdAt": "2020-08-28T10:06:48Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -81,6 +82,43 @@ public Tablet(String deviceId, List<MeasurementSchema> timeseries) {\n     this(deviceId, timeseries, DEFAULT_SIZE);\n   }\n \n+  public void addTimestamp(int rowIndex, long timestamp) {", "originalCommit": "dc403d30faa565a02c16c92386516b5fcbea849e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "178558ae0841033a5c3ab6a1d51f6dbce35e3caf", "url": "https://github.com/apache/iotdb/commit/178558ae0841033a5c3ab6a1d51f6dbce35e3caf", "message": "IOTDB-839:Add map in tablet to record measurement -> index", "committedDate": "2020-08-28T12:43:03Z", "type": "commit"}, {"oid": "ba862eff4807c7647835734846968c7692d5b61b", "url": "https://github.com/apache/iotdb/commit/ba862eff4807c7647835734846968c7692d5b61b", "message": "IOTDB-839:Add map in tablet to record measurement -> index", "committedDate": "2020-08-28T12:51:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5NjQ5Ng==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479596496", "bodyText": "switch (measurementSchema.getType())", "author": "qiaojialin", "createdAt": "2020-08-29T02:32:22Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -95,12 +103,48 @@ public Tablet(String deviceId, List<MeasurementSchema> schemas, int maxRowNumber\n     this.deviceId = deviceId;\n     this.schemas = schemas;\n     this.maxRowNumber = maxRowNumber;\n+    mschemawithindex=new HashMap<>();\n+\n+    for(int i=0;i<schemas.size();i++){\n+      mschemawithindex.put(schemas.get(i),i);\n+    }\n \n     createColumns();\n \n     reset();\n   }\n \n+  public void addTimestamp(int rowIndex, long timestamp) {\n+    timestamps[rowIndex] = timestamp;\n+  }\n+\n+  public void addValue(MeasurementSchema measurementSchema, int rowIndex, Object value) {\n+    int indexOfValue =mschemawithindex.get(measurementSchema);\n+\n+    if (measurementSchema.getType() == INT64) {", "originalCommit": "ba862eff4807c7647835734846968c7692d5b61b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYxNzI4Mg==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479617282", "bodyText": "Thank you. I'll improve it", "author": "yanhongwangg", "createdAt": "2020-08-29T06:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5NjQ5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5Njg3Ng==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479596876", "bodyText": "There is a java-google-style.xml under the root folder, import it as the default code style and format the code.\nIt should be something like this:\nfor(int i = 0; i < schemas.size(); i++){", "author": "qiaojialin", "createdAt": "2020-08-29T02:37:15Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -95,12 +103,48 @@ public Tablet(String deviceId, List<MeasurementSchema> schemas, int maxRowNumber\n     this.deviceId = deviceId;\n     this.schemas = schemas;\n     this.maxRowNumber = maxRowNumber;\n+    mschemawithindex=new HashMap<>();\n+\n+    for(int i=0;i<schemas.size();i++){", "originalCommit": "ba862eff4807c7647835734846968c7692d5b61b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYxNzY3Mg==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479617672", "bodyText": "copy that,thank you", "author": "yanhongwangg", "createdAt": "2020-08-29T07:01:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5Njg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5NzEwNg==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479597106", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void addValue(MeasurementSchema measurementSchema, int rowIndex, Object value) {\n          \n          \n            \n              public void addValue(String measurement, int rowIndex, Object value) {\n          \n      \n    \n    \n  \n\nUsing measurement id may be more friendly to users.", "author": "qiaojialin", "createdAt": "2020-08-29T02:40:19Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -95,12 +103,48 @@ public Tablet(String deviceId, List<MeasurementSchema> schemas, int maxRowNumber\n     this.deviceId = deviceId;\n     this.schemas = schemas;\n     this.maxRowNumber = maxRowNumber;\n+    mschemawithindex=new HashMap<>();\n+\n+    for(int i=0;i<schemas.size();i++){\n+      mschemawithindex.put(schemas.get(i),i);\n+    }\n \n     createColumns();\n \n     reset();\n   }\n \n+  public void addTimestamp(int rowIndex, long timestamp) {\n+    timestamps[rowIndex] = timestamp;\n+  }\n+\n+  public void addValue(MeasurementSchema measurementSchema, int rowIndex, Object value) {", "originalCommit": "ba862eff4807c7647835734846968c7692d5b61b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYxNzcwNA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479617704", "bodyText": "copy that,thank you", "author": "yanhongwangg", "createdAt": "2020-08-29T07:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5NzEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5OTgwNA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479599804", "bodyText": "You should not delete the previous example, user also can use the previous way to add data.  You should add new code to show how to use.", "author": "mychaow", "createdAt": "2020-08-29T03:11:56Z", "path": "example/session/src/main/java/org/apache/iotdb/SessionExample.java", "diffHunk": "@@ -247,15 +247,11 @@ private static void insertTablet() throws IoTDBConnectionException, StatementExe\n \n     Tablet tablet = new Tablet(\"root.sg1.d1\", schemaList, 100);\n \n-    long[] timestamps = tablet.timestamps;", "originalCommit": "ba862eff4807c7647835734846968c7692d5b61b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYxNzg4Mg==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479617882", "bodyText": "copy that,thank you", "author": "yanhongwangg", "createdAt": "2020-08-29T07:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5OTgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5OTk4MA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479599980", "bodyText": "It's not nesscessary to cast to long. You have done cast in the addValue.", "author": "mychaow", "createdAt": "2020-08-29T03:13:48Z", "path": "example/session/src/main/java/org/apache/iotdb/SessionExample.java", "diffHunk": "@@ -247,15 +247,11 @@ private static void insertTablet() throws IoTDBConnectionException, StatementExe\n \n     Tablet tablet = new Tablet(\"root.sg1.d1\", schemaList, 100);\n \n-    long[] timestamps = tablet.timestamps;\n-    Object[] values = tablet.values;\n-\n     for (long time = 0; time < 100; time++) {\n-      int row = tablet.rowSize++;\n-      timestamps[row] = time;\n-      for (int i = 0; i < 3; i++) {\n-        long[] sensor = (long[]) values[i];\n-        sensor[row] = i;\n+      int rowIndex = tablet.rowSize++;\n+      tablet.addTimestamp(rowIndex, time);\n+      for (int s = 0; s < 3; s++) {\n+        tablet.addValue(schemaList.get(s), rowIndex, (long) s);", "originalCommit": "ba862eff4807c7647835734846968c7692d5b61b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYxNzc0Nw==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479617747", "bodyText": "copy that,thank you", "author": "yanhongwangg", "createdAt": "2020-08-29T07:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5OTk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwMDI2Nw==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479600267", "bodyText": "same with the previous comment", "author": "mychaow", "createdAt": "2020-08-29T03:16:59Z", "path": "session/src/test/java/org/apache/iotdb/session/IoTDBSessionIT.java", "diffHunk": "@@ -812,15 +811,11 @@ private void insertTabletTest1(String deviceId)\n \n     Tablet tablet = new Tablet(deviceId, schemaList, 100);\n \n-    long[] timestamps = tablet.timestamps;\n-    Object[] values = tablet.values;\n-\n     for (long time = 0; time < 100; time++) {\n-      int row = tablet.rowSize++;\n-      timestamps[row] = time;\n-      for (int i = 0; i < 3; i++) {\n-        long[] sensor = (long[]) values[i];\n-        sensor[row] = i;\n+      int rowIndex = tablet.rowSize++;\n+      tablet.addTimestamp(rowIndex, time);\n+      for (int s = 0; s < 3; s++) {\n+        tablet.addValue(schemaList.get(s), rowIndex, (long) s);", "originalCommit": "ba862eff4807c7647835734846968c7692d5b61b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYxNzc2Mg==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479617762", "bodyText": "copy that,thank you", "author": "yanhongwangg", "createdAt": "2020-08-29T07:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwMDI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwMDQ3Ng==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479600476", "bodyText": "code should be\nfor (int i = 0; i < schemas.size(); i++) {}.  It's not wasteful to add blank in the code.", "author": "mychaow", "createdAt": "2020-08-29T03:19:53Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -95,12 +103,48 @@ public Tablet(String deviceId, List<MeasurementSchema> schemas, int maxRowNumber\n     this.deviceId = deviceId;\n     this.schemas = schemas;\n     this.maxRowNumber = maxRowNumber;\n+    mschemawithindex=new HashMap<>();\n+\n+    for(int i=0;i<schemas.size();i++){", "originalCommit": "ba862eff4807c7647835734846968c7692d5b61b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYxNzc3Mg==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479617772", "bodyText": "copy that,thank you", "author": "yanhongwangg", "createdAt": "2020-08-29T07:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwMDQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwMDUwOA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479600508", "bodyText": "add blank", "author": "mychaow", "createdAt": "2020-08-29T03:20:11Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -95,12 +103,48 @@ public Tablet(String deviceId, List<MeasurementSchema> schemas, int maxRowNumber\n     this.deviceId = deviceId;\n     this.schemas = schemas;\n     this.maxRowNumber = maxRowNumber;\n+    mschemawithindex=new HashMap<>();\n+\n+    for(int i=0;i<schemas.size();i++){\n+      mschemawithindex.put(schemas.get(i),i);\n+    }\n \n     createColumns();\n \n     reset();\n   }\n \n+  public void addTimestamp(int rowIndex, long timestamp) {\n+    timestamps[rowIndex] = timestamp;\n+  }\n+\n+  public void addValue(MeasurementSchema measurementSchema, int rowIndex, Object value) {\n+    int indexOfValue =mschemawithindex.get(measurementSchema);", "originalCommit": "ba862eff4807c7647835734846968c7692d5b61b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYxNzc4NQ==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479617785", "bodyText": "copy that,thank you", "author": "yanhongwangg", "createdAt": "2020-08-29T07:02:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwMDUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwMjg2MA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479602860", "bodyText": "I think it's better to separate the rowIndex, the time column, and the value column, which would clearer to users.", "author": "neuyilan", "createdAt": "2020-08-29T03:48:01Z", "path": "example/session/src/main/java/org/apache/iotdb/SessionExample.java", "diffHunk": "@@ -247,15 +247,11 @@ private static void insertTablet() throws IoTDBConnectionException, StatementExe\n \n     Tablet tablet = new Tablet(\"root.sg1.d1\", schemaList, 100);\n \n-    long[] timestamps = tablet.timestamps;\n-    Object[] values = tablet.values;\n-\n     for (long time = 0; time < 100; time++) {\n-      int row = tablet.rowSize++;\n-      timestamps[row] = time;\n-      for (int i = 0; i < 3; i++) {\n-        long[] sensor = (long[]) values[i];\n-        sensor[row] = i;\n+      int rowIndex = tablet.rowSize++;\n+      tablet.addTimestamp(rowIndex, time);\n+      for (int s = 0; s < 3; s++) {", "originalCommit": "ba862eff4807c7647835734846968c7692d5b61b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYxNzgyNw==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479617827", "bodyText": "copy that,thank you", "author": "yanhongwangg", "createdAt": "2020-08-29T07:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwMjg2MA=="}], "type": "inlineReview"}, {"oid": "4f55869ade6e5d8823c0fd0ab01cbc87d15e9ee4", "url": "https://github.com/apache/iotdb/commit/4f55869ade6e5d8823c0fd0ab01cbc87d15e9ee4", "message": "IOTDB-839:Modify map in tablet to record measurementId -> index and code style", "committedDate": "2020-08-29T09:54:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYzNDY1Mg==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479634652", "bodyText": "value always is initialize to be 0", "author": "mychaow", "createdAt": "2020-08-29T10:20:09Z", "path": "session/src/test/java/org/apache/iotdb/session/IoTDBSessionIT.java", "diffHunk": "@@ -1087,15 +1086,13 @@ private void insertTabletTest2(String deviceId)\n \n     Tablet tablet = new Tablet(deviceId, schemaList, 256);\n \n-    long[] timestamps = tablet.timestamps;\n-    Object[] values = tablet.values;\n-\n     for (long time = 0; time < 1000; time++) {\n-      int row = tablet.rowSize++;\n-      timestamps[row] = time;\n-      for (int i = 0; i < 3; i++) {\n-        long[] sensor = (long[]) values[i];\n-        sensor[row] = i;\n+      int rowIndex = tablet.rowSize++;\n+      tablet.addTimestamp(rowIndex, time);\n+      for (int s = 0; s < 3; s++) {\n+        long value = 0;", "originalCommit": "4f55869ade6e5d8823c0fd0ab01cbc87d15e9ee4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY0MDE1MQ==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479640151", "bodyText": "I added it after the loop", "author": "yanhongwangg", "createdAt": "2020-08-29T11:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYzNDY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYzNDczMA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479634730", "bodyText": "same with previous", "author": "mychaow", "createdAt": "2020-08-29T10:21:08Z", "path": "session/src/test/java/org/apache/iotdb/session/IoTDBSessionIT.java", "diffHunk": "@@ -1119,15 +1116,13 @@ private void insertTabletTest3(String deviceId)\n \n     Tablet tablet = new Tablet(deviceId, schemaList, 200);\n \n-    long[] timestamps = tablet.timestamps;\n-    Object[] values = tablet.values;\n-\n     for (long time = 500; time < 1500; time++) {\n-      int row = tablet.rowSize++;\n-      timestamps[row] = time;\n-      for (int i = 0; i < 3; i++) {\n-        long[] sensor = (long[]) values[i];\n-        sensor[row] = i;\n+      int rowIndex = tablet.rowSize++;\n+      tablet.addTimestamp(rowIndex, time);\n+      for (int s = 0; s < 3; s++) {\n+        long value = 0;", "originalCommit": "4f55869ade6e5d8823c0fd0ab01cbc87d15e9ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYzNTM1NQ==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479635355", "bodyText": "It's too ugly to create so many new variable names.\nyou could use {} in every case", "author": "mychaow", "createdAt": "2020-08-29T10:29:20Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -95,12 +102,56 @@ public Tablet(String deviceId, List<MeasurementSchema> schemas, int maxRowNumber\n     this.deviceId = deviceId;\n     this.schemas = schemas;\n     this.maxRowNumber = maxRowNumber;\n+    mschemawithindex = new HashMap<>();\n+\n+    for (int i = 0; i < schemas.size(); i++) {\n+      mschemawithindex.put(schemas.get(i).getMeasurementId(), i);\n+    }\n \n     createColumns();\n \n     reset();\n   }\n \n+  public void addTimestamp(int rowIndex, long timestamp) {\n+    timestamps[rowIndex] = timestamp;\n+  }\n+\n+  public void addValue(String measurementId, int rowIndex, Object value) {\n+    int indexOfValue = mschemawithindex.get(measurementId);\n+    MeasurementSchema measurementSchema = schemas.get(indexOfValue);\n+\n+    switch (measurementSchema.getType()) {\n+      case TEXT:\n+        Binary[] sensort = (Binary[]) values[indexOfValue];", "originalCommit": "4f55869ade6e5d8823c0fd0ab01cbc87d15e9ee4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYzNTcxOQ==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479635719", "bodyText": "ok, i will improve that", "author": "yanhongwangg", "createdAt": "2020-08-29T10:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYzNTM1NQ=="}], "type": "inlineReview"}, {"oid": "4d43e7649cfc7cfae34b7708f96026c020b241ef", "url": "https://github.com/apache/iotdb/commit/4d43e7649cfc7cfae34b7708f96026c020b241ef", "message": "modify case to case{} in order to declare less variables", "committedDate": "2020-08-29T11:42:49Z", "type": "commit"}, {"oid": "ac36f614b3386087358e6e6b0de98fb7241f1064", "url": "https://github.com/apache/iotdb/commit/ac36f614b3386087358e6e6b0de98fb7241f1064", "message": "Put long value = 0 outside the loop", "committedDate": "2020-08-29T12:23:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY0NjAyNA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479646024", "bodyText": "mschemawithindex should be camel-case name, like mSchemaWithIndex.", "author": "mychaow", "createdAt": "2020-08-29T12:43:55Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -52,6 +54,11 @@\n    */\n   private List<MeasurementSchema> schemas;\n \n+  /**\n+   * measurementId->indexOf(measurementSchema)\n+   */\n+  private Map<String, Integer> mschemawithindex;", "originalCommit": "ac36f614b3386087358e6e6b0de98fb7241f1064", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY0NjcyOQ==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479646729", "bodyText": "copy that.", "author": "yanhongwangg", "createdAt": "2020-08-29T12:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY0NjAyNA=="}], "type": "inlineReview"}, {"oid": "eee90347ba1a47a9001ffb518c7c13ab393aea74", "url": "https://github.com/apache/iotdb/commit/eee90347ba1a47a9001ffb518c7c13ab393aea74", "message": "modify mschemawithindex to mSchemaWithIndex", "committedDate": "2020-08-29T12:54:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1NzMwNg==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479857306", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Map<String, Integer> mSchemaWithIndex;\n          \n          \n            \n              private Map<String, Integer> measurementIndex;", "author": "qiaojialin", "createdAt": "2020-08-31T02:28:24Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java", "diffHunk": "@@ -52,6 +54,11 @@\n    */\n   private List<MeasurementSchema> schemas;\n \n+  /**\n+   * measurementId->indexOf(measurementSchema)\n+   */\n+  private Map<String, Integer> mSchemaWithIndex;", "originalCommit": "eee90347ba1a47a9001ffb518c7c13ab393aea74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkyOTIzMQ==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479929231", "bodyText": "thanks,i will improve that", "author": "yanhongwangg", "createdAt": "2020-08-31T06:48:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1NzMwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg3MDgzNA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479870834", "bodyText": "this test lacks an assert. You can do a select count(*) query and assert", "author": "qiaojialin", "createdAt": "2020-08-31T03:35:14Z", "path": "session/src/test/java/org/apache/iotdb/session/IoTDBSessionIT.java", "diffHunk": "@@ -622,6 +622,17 @@ public void TestSessionInterfacesWithDisabledWAL()\n       tablet.rowSize++;\n     }\n \n+    for (int time = 101; time <= 200; time++) {\n+      int rowIndex = time - 1;\n+      tablet.addTimestamp(rowIndex, time);\n+      long value = 0;\n+      for (int s = 0; s < 3; s++) {\n+        tablet.addValue(schemaList.get(s).getMeasurementId(), rowIndex, value);\n+        value++;\n+      }\n+      tablet.rowSize++;\n+    }\n+", "originalCommit": "eee90347ba1a47a9001ffb518c7c13ab393aea74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkyOTc2MA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479929760", "bodyText": "i will fix it in PR IOTDB-856:Clear up the IoTDBSessionIT", "author": "yanhongwangg", "createdAt": "2020-08-31T06:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg3MDgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg3NTM1MA==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479875350", "bodyText": "It's not intuitive where 14000 comes from.\nI feel that the IoTDBSessionIT is out of control gradually...\nIt's time to remove duplicated methods such as insertTabletTest1-2-3.\nBesides, there are some commented lines in test(), it should be cleaned.\nI create a jira issue:  https://issues.apache.org/jira/browse/IOTDB-856.\nBetter to fix it in this PR.", "author": "qiaojialin", "createdAt": "2020-08-31T03:57:28Z", "path": "session/src/test/java/org/apache/iotdb/session/IoTDBSessionIT.java", "diffHunk": "@@ -1203,7 +1289,7 @@ private void queryForBatch() throws ClassNotFoundException, SQLException {\n       }\n       Assert.assertEquals(standard, resultStr.toString());\n       // d1 and d2 will align\n-      Assert.assertEquals(7000, count);\n+      Assert.assertEquals(14000, count);", "originalCommit": "eee90347ba1a47a9001ffb518c7c13ab393aea74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzMDAxMw==", "url": "https://github.com/apache/iotdb/pull/1658#discussion_r479930013", "bodyText": "ok,i will fix it in that PR", "author": "yanhongwangg", "createdAt": "2020-08-31T06:50:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg3NTM1MA=="}], "type": "inlineReview"}, {"oid": "d74f5a345e9b247abcba9a9f625582c27b1807d5", "url": "https://github.com/apache/iotdb/commit/d74f5a345e9b247abcba9a9f625582c27b1807d5", "message": "Update tsfile/src/main/java/org/apache/iotdb/tsfile/write/record/Tablet.java\n\nCo-authored-by: Jialin Qiao <qjl16@mails.tsinghua.edu.cn>", "committedDate": "2020-08-31T06:50:24Z", "type": "commit"}, {"oid": "670020ef840e691c501106277e2f3a4244ac0356", "url": "https://github.com/apache/iotdb/commit/670020ef840e691c501106277e2f3a4244ac0356", "message": "Update Tablet.java", "committedDate": "2020-08-31T06:56:11Z", "type": "commit"}]}