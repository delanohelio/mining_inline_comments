{"pr_number": 929, "pr_title": "[IOTDB-565] MQTT Protocol Support", "pr_createdAt": "2020-03-21T04:32:43Z", "pr_url": "https://github.com/apache/iotdb/pull/929", "timeline": [{"oid": "d74e6cbb325f5fbdac7e019356eb953dcad6a427", "url": "https://github.com/apache/iotdb/commit/d74e6cbb325f5fbdac7e019356eb953dcad6a427", "message": "[IOTDB-503] Add checkTimeseriesExists for session", "committedDate": "2020-02-18T14:17:18Z", "type": "commit"}, {"oid": "2f12978cc65cfc47f659b837e174d535fe2f53af", "url": "https://github.com/apache/iotdb/commit/2f12978cc65cfc47f659b837e174d535fe2f53af", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-22T11:29:01Z", "type": "commit"}, {"oid": "a043dd09832768619700448a4397f471f1349e00", "url": "https://github.com/apache/iotdb/commit/a043dd09832768619700448a4397f471f1349e00", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-26T03:55:01Z", "type": "commit"}, {"oid": "b858456ebae948b63bb3e2b4f3168bd1df0539f0", "url": "https://github.com/apache/iotdb/commit/b858456ebae948b63bb3e2b4f3168bd1df0539f0", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-03-08T02:50:18Z", "type": "commit"}, {"oid": "66297ab36796c3fd3c0d9862f525c6656035744e", "url": "https://github.com/apache/iotdb/commit/66297ab36796c3fd3c0d9862f525c6656035744e", "message": "[IOTDB-565] MQTT Protocol Support", "committedDate": "2020-03-21T04:28:06Z", "type": "commit"}, {"oid": "82ee854cb397ac37095721f3f4d825c92665b53f", "url": "https://github.com/apache/iotdb/commit/82ee854cb397ac37095721f3f4d825c92665b53f", "message": "[IOTDB-565] upgrade fastjson to latest version", "committedDate": "2020-03-21T12:39:43Z", "type": "commit"}, {"oid": "ee06c96f99c35b6b53edef84d7f2ea67b955a511", "url": "https://github.com/apache/iotdb/commit/ee06c96f99c35b6b53edef84d7f2ea67b955a511", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-03-22T08:56:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA4MDYyMA==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r396080620", "bodyText": "Hi, the IoTDBSessionException is replaced by StatementExecuteException and IoTDBConnectionException", "author": "qiaojialin", "createdAt": "2020-03-22T11:06:26Z", "path": "mqtt/src/main/java/org/apache/iotdb/mqtt/PublishHandler.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.mqtt;\n+\n+import io.moquette.interception.AbstractInterceptHandler;\n+import io.moquette.interception.messages.InterceptPublishMessage;\n+import io.netty.buffer.ByteBuf;\n+import io.netty.handler.codec.mqtt.MqttQoS;\n+import org.apache.iotdb.service.rpc.thrift.TSStatus;\n+import org.apache.iotdb.session.IoTDBSessionException;\n+import org.apache.iotdb.session.Session;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * PublishHandler handle the messages from MQTT clients.\n+ */\n+public class PublishHandler extends AbstractInterceptHandler {\n+    private static final Logger LOG = LoggerFactory.getLogger(PublishHandler.class);\n+\n+    private Session session;\n+    private PayloadFormatter payloadFormat;\n+    static boolean testing = false;\n+\n+    public PublishHandler(MQTTBrokerConfig config) {\n+        payloadFormat = PayloadFormatManager.getPayloadFormat(config.getPayloadFormatter());\n+        initSession(config);\n+    }\n+\n+    public void initSession(MQTTBrokerConfig config) {\n+        if (testing) {\n+            return;\n+        }\n+        session = new Session(config.getIotDBHost(), config.getIotDBPort(),\n+                config.getIotDBUsername(), config.getIotDBPassword());\n+        try {\n+            session.open();\n+        } catch (IoTDBSessionException e) {", "originalCommit": "82ee854cb397ac37095721f3f4d825c92665b53f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA4NzIxOQ==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r396087219", "bodyText": "Updated.", "author": "vesense", "createdAt": "2020-03-22T12:20:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA4MDYyMA=="}], "type": "inlineReview"}, {"oid": "3e71f8bcf5001258b4d1da926bbebc215de033a1", "url": "https://github.com/apache/iotdb/commit/3e71f8bcf5001258b4d1da926bbebc215de033a1", "message": "Merge branch 'master' into mqtt_protocol", "committedDate": "2020-03-22T11:42:43Z", "type": "commit"}, {"oid": "3c8c304e68fb631fc54f60031e4171eada112856", "url": "https://github.com/apache/iotdb/commit/3c8c304e68fb631fc54f60031e4171eada112856", "message": "[IOTDB-565] minor fixes", "committedDate": "2020-03-22T12:18:12Z", "type": "commit"}, {"oid": "90a5d3846e48f46af9e2a4a26d02b416f39a042d", "url": "https://github.com/apache/iotdb/commit/90a5d3846e48f46af9e2a4a26d02b416f39a042d", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-04-02T09:06:58Z", "type": "commit"}, {"oid": "e75a1ec7607f1486ffd2e5b1e6fb1dca730bbfe7", "url": "https://github.com/apache/iotdb/commit/e75a1ec7607f1486ffd2e5b1e6fb1dca730bbfe7", "message": "Merge branch 'master' into mqtt_protocol\n\n# Conflicts:\n#\ttsfile/src/test/java/org/apache/iotdb/tsfile/utils/TsFileGeneratorForTest.java", "committedDate": "2020-04-02T09:14:44Z", "type": "commit"}, {"oid": "943240286399b6f2b2705cb5002040b6d843c8ae", "url": "https://github.com/apache/iotdb/commit/943240286399b6f2b2705cb5002040b6d843c8ae", "message": "[IOTDB-565] MQTT Protocol Support Refactor", "committedDate": "2020-04-03T11:55:09Z", "type": "commit"}, {"oid": "621a57a85b85526a76934d7fc3c7e4f39923a802", "url": "https://github.com/apache/iotdb/commit/621a57a85b85526a76934d7fc3c7e4f39923a802", "message": "[IOTDB-565] minor fix", "committedDate": "2020-04-04T08:21:59Z", "type": "commit"}, {"oid": "1b5ea3fad0dd252dda7c7c87163ab4f9a1f2a8c6", "url": "https://github.com/apache/iotdb/commit/1b5ea3fad0dd252dda7c7c87163ab4f9a1f2a8c6", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-04-04T08:30:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU4NDc3NA==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r403584774", "bodyText": "Hi,  \"read only\" -> \"write only\"", "author": "jixuan1989", "createdAt": "2020-04-04T23:59:39Z", "path": "server/src/main/java/org/apache/iotdb/db/mqtt/PublishHandler.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.db.mqtt;\n+\n+import io.moquette.interception.AbstractInterceptHandler;\n+import io.moquette.interception.messages.InterceptPublishMessage;\n+import io.netty.buffer.ByteBuf;\n+import io.netty.handler.codec.mqtt.MqttQoS;\n+import org.apache.iotdb.db.conf.IoTDBConfig;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.exception.query.QueryProcessException;\n+import org.apache.iotdb.db.qp.executor.IPlanExecutor;\n+import org.apache.iotdb.db.qp.executor.PlanExecutor;\n+import org.apache.iotdb.db.qp.physical.PhysicalPlan;\n+import org.apache.iotdb.db.qp.physical.crud.InsertPlan;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * PublishHandler handle the messages from MQTT clients.\n+ */\n+public class PublishHandler extends AbstractInterceptHandler {\n+    private static final Logger LOG = LoggerFactory.getLogger(PublishHandler.class);\n+\n+    private IPlanExecutor executor;\n+    private PayloadFormatter payloadFormat;\n+\n+    public PublishHandler(IoTDBConfig config) {\n+        this.payloadFormat = PayloadFormatManager.getPayloadFormat(config.getMqttPayloadFormatter());\n+        try {\n+            this.executor = new PlanExecutor();\n+        } catch (QueryProcessException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    protected PublishHandler(IPlanExecutor executor, PayloadFormatter payloadFormat) {\n+        this.executor = executor;\n+        this.payloadFormat = payloadFormat;\n+    }\n+\n+    @Override\n+    public String getID() {\n+        return \"iotdb-mqtt-broker-listener\";\n+    }\n+\n+    @Override\n+    public void onPublish(InterceptPublishMessage msg) {\n+        String clientId = msg.getClientID();\n+        ByteBuf payload = msg.getPayload();\n+        String topic = msg.getTopicName();\n+        String username = msg.getUsername();\n+        MqttQoS qos = msg.getQos();\n+\n+        LOG.debug(\"Receive publish message. clientId: {}, username: {}, qos: {}, topic: {}, payload: {}\",\n+                clientId, username, qos, topic, payload);\n+\n+        Message event = payloadFormat.format(payload);\n+        if (event == null) {\n+            return;\n+        }\n+\n+        InsertPlan plan = new InsertPlan();\n+        plan.setDeviceId(event.getDevice());\n+        plan.setTime(event.getTimestamp());\n+        plan.setMeasurements(event.getMeasurements().toArray(new String[event.getMeasurements().size()]));\n+        plan.setValues(event.getValues().toArray(new String[event.getValues().size()]));\n+\n+        boolean status;\n+        try {\n+            status = executeNonQuery(plan);\n+        } catch (QueryProcessException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        LOG.debug(\"event process result: {}\", status);\n+    }\n+\n+    private boolean executeNonQuery(PhysicalPlan plan) throws QueryProcessException {\n+        if (IoTDBDescriptor.getInstance().getConfig().isReadOnly()) {\n+            throw new QueryProcessException(\n+                    \"Current system mode is read-only, does not support non-query operation\");", "originalCommit": "621a57a85b85526a76934d7fc3c7e4f39923a802", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY0NTY1Mg==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r403645652", "bodyText": "why?", "author": "vesense", "createdAt": "2020-04-05T04:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU4NDc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5NjU1NA==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r403696554", "bodyText": "read-only is right :)", "author": "qiaojialin", "createdAt": "2020-04-05T12:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU4NDc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc5MjA1MQ==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r403792051", "bodyText": "my fault..", "author": "jixuan1989", "createdAt": "2020-04-06T01:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU4NDc3NA=="}], "type": "inlineReview"}, {"oid": "fcb50cb9412bb6f785b68383867f84caddb02e02", "url": "https://github.com/apache/iotdb/commit/fcb50cb9412bb6f785b68383867f84caddb02e02", "message": "[IOTDB-565] Address review comments", "committedDate": "2020-04-05T09:14:36Z", "type": "commit"}, {"oid": "78dd9091bc406825d9390d0b3be653633e57eccb", "url": "https://github.com/apache/iotdb/commit/78dd9091bc406825d9390d0b3be653633e57eccb", "message": "[IOTDB-565] Address review comments", "committedDate": "2020-04-05T09:22:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5OTU1Nw==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r403699557", "bodyText": "I remove this line and test the performance of the insertion on my laptop,  I find that the connection.publish() cost about 1 second, is there any rate-limiting\uff1f", "author": "qiaojialin", "createdAt": "2020-04-05T13:06:56Z", "path": "example/mqtt/src/main/java/org/apache/iotdb/mqtt/MQTTClient.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.mqtt;\n+\n+import org.fusesource.mqtt.client.BlockingConnection;\n+import org.fusesource.mqtt.client.MQTT;\n+import org.fusesource.mqtt.client.QoS;\n+\n+import java.util.Random;\n+\n+public class MQTTClient {\n+    public static void main(String[] args) throws Exception {\n+        MQTT mqtt = new MQTT();\n+        mqtt.setHost(\"127.0.0.1\", 1883);\n+        mqtt.setUserName(\"root\");\n+        mqtt.setPassword(\"root\");\n+\n+        BlockingConnection connection = mqtt.blockingConnection();\n+        connection.connect();\n+\n+        Random random = new Random();\n+        for (int i = 0; i < 10; i++) {\n+            String payload = String.format(\"{\\n\" +\n+                    \"\\\"device\\\":\\\"root.sg.d1\\\",\\n\" +\n+                    \"\\\"timestamp\\\":%d,\\n\" +\n+                    \"\\\"measurements\\\":[\\\"s1\\\"],\\n\" +\n+                    \"\\\"values\\\":[%f]\\n\" +\n+                    \"}\", System.currentTimeMillis(), random.nextDouble());\n+\n+            connection.publish(\"root.sg.d1.s1\", payload.getBytes(), QoS.AT_LEAST_ONCE, false);\n+\n+            Thread.sleep(1000);", "originalCommit": "78dd9091bc406825d9390d0b3be653633e57eccb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc5MzgyOA==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r403793828", "bodyText": "Look forward to the new progress.", "author": "jixuan1989", "createdAt": "2020-04-06T01:56:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgwNDQ0OQ==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r403804449", "bodyText": "This is a known PUBACK flush issue for moquette when the QoS is AT_LEAST_ONCE and EXACTLY_ONCE, this issue has fixed but not released. moquette-io/moquette#515\nDon't worry, I have fixed that when used in the  IoTDB MQTT service, just try again.", "author": "vesense", "createdAt": "2020-04-06T02:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk2NjQyOA==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r403966428", "bodyText": "Hi, thank! It performs right now. In this case, could the \"Thread.sleep(1000)\" in MQTTClient be deleted?", "author": "qiaojialin", "createdAt": "2020-04-06T09:53:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2ODQ2OQ==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r404068469", "bodyText": "OK", "author": "vesense", "createdAt": "2020-04-06T12:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA3MTY5NA==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r404071694", "bodyText": "done.", "author": "vesense", "createdAt": "2020-04-06T13:01:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5OTU1Nw=="}], "type": "inlineReview"}, {"oid": "ef8980bffa30aba7e4158668588b363ddc9dee84", "url": "https://github.com/apache/iotdb/commit/ef8980bffa30aba7e4158668588b363ddc9dee84", "message": "[IOTDB-565] Address review comments", "committedDate": "2020-04-06T02:50:11Z", "type": "commit"}, {"oid": "54c55780722b36f0e2285ae70fae8bbfb004b151", "url": "https://github.com/apache/iotdb/commit/54c55780722b36f0e2285ae70fae8bbfb004b151", "message": "[IOTDB-565] Address review comments", "committedDate": "2020-04-06T13:00:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEyMzM3OQ==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r404123379", "bodyText": "Hi, as the source code is not written by us, we'd better to claim it in our LICENSE file. You can get an example at the tail of our current LICENSE file.\nAnd do not forget to remove it from the license file once you delete this class.", "author": "jixuan1989", "createdAt": "2020-04-06T14:13:16Z", "path": "server/src/main/java/io/moquette/broker/MQTTConnection.java", "diffHunk": "@@ -0,0 +1,503 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.moquette.broker;\n+\n+import io.moquette.broker.subscriptions.Topic;\n+import io.moquette.broker.security.IAuthenticator;\n+import io.netty.buffer.ByteBuf;\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelPipeline;\n+import io.netty.handler.codec.mqtt.*;\n+import io.netty.handler.timeout.IdleStateHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.net.InetSocketAddress;\n+import java.nio.charset.StandardCharsets;\n+import java.util.*;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import static io.netty.channel.ChannelFutureListener.CLOSE_ON_FAILURE;\n+import static io.netty.channel.ChannelFutureListener.FIRE_EXCEPTION_ON_FAILURE;\n+import static io.netty.handler.codec.mqtt.MqttConnectReturnCode.*;\n+import static io.netty.handler.codec.mqtt.MqttMessageIdVariableHeader.from;\n+import static io.netty.handler.codec.mqtt.MqttQoS.*;\n+\n+// NOTE:\n+// override the MQTTConnection class in the moquette 0.12.1 jar to fix the PUBACK flush issue\n+// https://github.com/moquette-io/moquette/pull/454\n+// when moquette fixed version released, we can remove this.\n+final class MQTTConnection {", "originalCommit": "54c55780722b36f0e2285ae70fae8bbfb004b151", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3NDI2Ng==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r404474266", "bodyText": "OK", "author": "vesense", "createdAt": "2020-04-07T00:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEyMzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3NjMxMA==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r404476310", "bodyText": "done.", "author": "vesense", "createdAt": "2020-04-07T01:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEyMzM3OQ=="}], "type": "inlineReview"}, {"oid": "20b169efcec2186c636b7cdc82f5100ccb441399", "url": "https://github.com/apache/iotdb/commit/20b169efcec2186c636b7cdc82f5100ccb441399", "message": "[IOTDB-565] Address review comments", "committedDate": "2020-04-07T01:00:15Z", "type": "commit"}, {"oid": "b1d29716cbe04d56c49d368601978e710bbe96fb", "url": "https://github.com/apache/iotdb/commit/b1d29716cbe04d56c49d368601978e710bbe96fb", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-04-07T01:28:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUxNjQzMw==", "url": "https://github.com/apache/iotdb/pull/929#discussion_r404516433", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String JSON_KEY_DEVICE = \"device\";\n          \n          \n            \n                public static final String JSON_KEY_TIMESTAMP = \"timestamp\";\n          \n          \n            \n                public static final String JSON_KEY_TIMESTAMPS = \"timestamps\";\n          \n          \n            \n                public static final String JSON_KEY_MEASUREMENTS = \"measurements\";\n          \n          \n            \n                public static final String JSON_KEY_VALUES = \"values\";\n          \n          \n            \n                private static final String JSON_KEY_DEVICE = \"device\";\n          \n          \n            \n                private static final String JSON_KEY_TIMESTAMP = \"timestamp\";\n          \n          \n            \n                private static final String JSON_KEY_TIMESTAMPS = \"timestamps\";\n          \n          \n            \n                private static final String JSON_KEY_MEASUREMENTS = \"measurements\";\n          \n          \n            \n                private static final String JSON_KEY_VALUES = \"values\";", "author": "qiaojialin", "createdAt": "2020-04-07T03:37:55Z", "path": "server/src/main/java/org/apache/iotdb/db/mqtt/JSONPayloadFormatter.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.db.mqtt;\n+\n+import com.alibaba.fastjson.JSON;\n+import com.alibaba.fastjson.JSONArray;\n+import com.alibaba.fastjson.JSONObject;\n+import com.google.common.collect.Lists;\n+import io.netty.buffer.ByteBuf;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The JSON payload formatter.\n+ * two json format supported:\n+ * {\n+ *     \"device\":\"root.sg.d1\",\n+ *     \"timestamp\":1586076045524,\n+ *     \"measurements\":[\"s1\",\"s2\"],\n+ *     \"values\":[0.530635,0.530635]\n+ * }\n+ *\n+ * {\n+ *     \"device\":\"root.sg.d1\",\n+ *     \"timestamps\":[1586076045524,1586076065526],\n+ *     \"measurements\":[\"s1\",\"s2\"],\n+ *     \"values\":[[0.530635,0.530635], [0.530655,0.530695]]\n+ * }\n+ */\n+public class JSONPayloadFormatter implements PayloadFormatter {\n+    public static final String JSON_KEY_DEVICE = \"device\";\n+    public static final String JSON_KEY_TIMESTAMP = \"timestamp\";\n+    public static final String JSON_KEY_TIMESTAMPS = \"timestamps\";\n+    public static final String JSON_KEY_MEASUREMENTS = \"measurements\";\n+    public static final String JSON_KEY_VALUES = \"values\";", "originalCommit": "20b169efcec2186c636b7cdc82f5100ccb441399", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c3c788b1b1236ed05101c5b1ea5eb533fa865427", "url": "https://github.com/apache/iotdb/commit/c3c788b1b1236ed05101c5b1ea5eb533fa865427", "message": "Update server/src/main/java/org/apache/iotdb/db/mqtt/JSONPayloadFormatter.java\n\nCo-Authored-By: Jialin Qiao <qjl16@mails.tsinghua.edu.cn>", "committedDate": "2020-04-07T05:13:04Z", "type": "commit"}, {"oid": "43e3b6a2a09e6820f89324e321d9560451510921", "url": "https://github.com/apache/iotdb/commit/43e3b6a2a09e6820f89324e321d9560451510921", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-04-07T06:46:42Z", "type": "commit"}, {"oid": "85ca5c2707db5dfa9960b4dd8bb602c8d492a392", "url": "https://github.com/apache/iotdb/commit/85ca5c2707db5dfa9960b4dd8bb602c8d492a392", "message": "Merge branch 'master' into mqtt_protocol", "committedDate": "2020-04-07T07:07:18Z", "type": "commit"}, {"oid": "b1e918a469ee454a86b5c8aa7d8170aa1d0cf1b5", "url": "https://github.com/apache/iotdb/commit/b1e918a469ee454a86b5c8aa7d8170aa1d0cf1b5", "message": "[IOTDB-565] Fix ci error", "committedDate": "2020-04-08T02:02:36Z", "type": "commit"}, {"oid": "cb7879022b4d8bf2f9c7ca61e0e155cf0ebbb7d0", "url": "https://github.com/apache/iotdb/commit/cb7879022b4d8bf2f9c7ca61e0e155cf0ebbb7d0", "message": "[IOTDB-565] Fix ci error", "committedDate": "2020-04-08T03:26:33Z", "type": "commit"}, {"oid": "f3a4492fc5bfabc83e8f463b73edf85335f16026", "url": "https://github.com/apache/iotdb/commit/f3a4492fc5bfabc83e8f463b73edf85335f16026", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-04-08T03:30:55Z", "type": "commit"}, {"oid": "5c4b559ac006550be396b5a57e0b821ce74a4bc1", "url": "https://github.com/apache/iotdb/commit/5c4b559ac006550be396b5a57e0b821ce74a4bc1", "message": "Merge branch 'master' into mqtt_protocol", "committedDate": "2020-04-08T03:31:39Z", "type": "commit"}, {"oid": "849a61fdc022b00d7f277865919da2f546e3fbda", "url": "https://github.com/apache/iotdb/commit/849a61fdc022b00d7f277865919da2f546e3fbda", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-04-08T10:07:57Z", "type": "commit"}, {"oid": "9792e43fd092b52f999ca0cea49eb4885a9a5a7c", "url": "https://github.com/apache/iotdb/commit/9792e43fd092b52f999ca0cea49eb4885a9a5a7c", "message": "Merge branch 'master' into mqtt_protocol", "committedDate": "2020-04-08T10:08:48Z", "type": "commit"}, {"oid": "db73c9a006c3a4fe73ae5f368db7c6caab1d829d", "url": "https://github.com/apache/iotdb/commit/db73c9a006c3a4fe73ae5f368db7c6caab1d829d", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-04-08T12:42:02Z", "type": "commit"}, {"oid": "6053a2aa4299188abecfd092364f42ab13ec969d", "url": "https://github.com/apache/iotdb/commit/6053a2aa4299188abecfd092364f42ab13ec969d", "message": "Merge branch 'master' into mqtt_protocol\n\n# Conflicts:\n#\texample/flink/README.md\n#\texample/flink/pom.xml", "committedDate": "2020-04-08T12:54:10Z", "type": "commit"}]}