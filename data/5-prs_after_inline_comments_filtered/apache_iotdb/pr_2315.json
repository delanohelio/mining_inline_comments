{"pr_number": 2315, "pr_title": "[IOTDB-1069] restrict the flushing memtable number to avoid OOM when mem_control is disabled", "pr_createdAt": "2020-12-23T08:14:48Z", "pr_url": "https://github.com/apache/iotdb/pull/2315", "timeline": [{"oid": "f62136f3363db8469fdfce3e7348545186db58a1", "url": "https://github.com/apache/iotdb/commit/f62136f3363db8469fdfce3e7348545186db58a1", "message": "restrict flushing memtable number", "committedDate": "2020-12-23T08:00:58Z", "type": "commit"}, {"oid": "07df497cbf34cedf124f595eb77a62b2698f7363", "url": "https://github.com/apache/iotdb/commit/07df497cbf34cedf124f595eb77a62b2698f7363", "message": "restrict flushing memtable number", "committedDate": "2020-12-23T08:25:11Z", "type": "commit"}, {"oid": "4999691988258a889002eb2fe535e3091a752bbc", "url": "https://github.com/apache/iotdb/commit/4999691988258a889002eb2fe535e3091a752bbc", "message": "fix code smells", "committedDate": "2020-12-23T08:42:06Z", "type": "commit"}, {"oid": "000ba5a54acc3a770bc0f9592fd7c4c7f4123542", "url": "https://github.com/apache/iotdb/commit/000ba5a54acc3a770bc0f9592fd7c4c7f4123542", "message": "fix flushing memtable size", "committedDate": "2020-12-24T05:04:12Z", "type": "commit"}, {"oid": "2d314b79577e20ffd7ed3d53b34d58ba20857c64", "url": "https://github.com/apache/iotdb/commit/2d314b79577e20ffd7ed3d53b34d58ba20857c64", "message": "fix code smell", "committedDate": "2020-12-24T06:09:54Z", "type": "commit"}, {"oid": "a86fcfbb663e89a425694fc58c0d23fb4001e30a", "url": "https://github.com/apache/iotdb/commit/a86fcfbb663e89a425694fc58c0d23fb4001e30a", "message": "fix synchronized", "committedDate": "2020-12-24T06:27:42Z", "type": "commit"}, {"oid": "c4d2c5d02027fe1a6fcd17aa6c0ac7b605657911", "url": "https://github.com/apache/iotdb/commit/c4d2c5d02027fe1a6fcd17aa6c0ac7b605657911", "message": "change 1000 to 100", "committedDate": "2020-12-25T00:58:37Z", "type": "commit"}, {"oid": "1a3e48195fd804d2057747e5884e13cbe111e646", "url": "https://github.com/apache/iotdb/commit/1a3e48195fd804d2057747e5884e13cbe111e646", "message": "add max memtable number", "committedDate": "2020-12-25T06:04:12Z", "type": "commit"}, {"oid": "6ebc3272dac83ad25052545369de515b2474c1d5", "url": "https://github.com/apache/iotdb/commit/6ebc3272dac83ad25052545369de515b2474c1d5", "message": "change max memtable number to 0", "committedDate": "2020-12-25T08:43:05Z", "type": "commit"}, {"oid": "e113ff9fb4f752349b977ae84482ec58ba0b3a12", "url": "https://github.com/apache/iotdb/commit/e113ff9fb4f752349b977ae84482ec58ba0b3a12", "message": "add synchronized", "committedDate": "2020-12-25T09:09:38Z", "type": "commit"}, {"oid": "e8b6411fd9d382807faa6bb8f393d8c9c5f3a7b4", "url": "https://github.com/apache/iotdb/commit/e8b6411fd9d382807faa6bb8f393d8c9c5f3a7b4", "message": "add memtable manager", "committedDate": "2020-12-25T15:11:34Z", "type": "commit"}, {"oid": "4fc710bd67bcf47b2199717559d27a7fefa7f4f3", "url": "https://github.com/apache/iotdb/commit/4fc710bd67bcf47b2199717559d27a7fefa7f4f3", "message": "fix name", "committedDate": "2020-12-26T07:18:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA3MDE3Ng==", "url": "https://github.com/apache/iotdb/pull/2315#discussion_r549070176", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // wait until the size of flushingMemTables is less than 2\n          \n          \n            \n                  // wait until the total number of memtable is less than the system capacity", "author": "qiaojialin", "createdAt": "2020-12-27T06:01:36Z", "path": "server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.rescon;\n+\n+import org.apache.iotdb.db.conf.IoTDBConfig;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.memtable.IMemTable;\n+import org.apache.iotdb.db.engine.memtable.PrimitiveMemTable;\n+import org.apache.iotdb.db.engine.storagegroup.TsFileResource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+public class MemTableManager {\n+\n+  private static final IoTDBConfig CONFIG = IoTDBDescriptor.getInstance().getConfig();\n+\n+  private static final Logger logger = LoggerFactory.getLogger(MemTableManager.class);\n+\n+  private static final int WAIT_TIME = 100;\n+  public static final int MEMTABLE_NUM_FOR_EACH_PARTITION = 4;\n+  private int currentMemtableNumber = 0;\n+\n+  private MemTableManager() {\n+  }\n+\n+  public static MemTableManager getInstance() {\n+    return InstanceHolder.INSTANCE;\n+  }\n+\n+  /**\n+   * Called when memory control is disabled\n+   */\n+  public synchronized IMemTable getAvailableMemTable(TsFileResource tsFileResource) {\n+    if (!reachMaxMemtableNumber()) {\n+      currentMemtableNumber++;\n+      return new PrimitiveMemTable();\n+    } else {\n+      // wait until the size of flushingMemTables is less than 2", "originalCommit": "4fc710bd67bcf47b2199717559d27a7fefa7f4f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "102df092a6134e44976ab4a43b5bf9ed7db2ecc6", "url": "https://github.com/apache/iotdb/commit/102df092a6134e44976ab4a43b5bf9ed7db2ecc6", "message": "Update server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java", "committedDate": "2020-12-27T06:01:43Z", "type": "commit"}, {"oid": "3fac3a19d5cd8115ae233f2bf0123da3c98139a5", "url": "https://github.com/apache/iotdb/commit/3fac3a19d5cd8115ae233f2bf0123da3c98139a5", "message": "fix wait", "committedDate": "2020-12-27T06:58:28Z", "type": "commit"}, {"oid": "52bcdef9fc775023a97ccd5ce74034d727c7fa22", "url": "https://github.com/apache/iotdb/commit/52bcdef9fc775023a97ccd5ce74034d727c7fa22", "message": "code smell", "committedDate": "2020-12-27T07:06:19Z", "type": "commit"}, {"oid": "1032423db1f178d9f5ab2e990f128923c7b08f63", "url": "https://github.com/apache/iotdb/commit/1032423db1f178d9f5ab2e990f128923c7b08f63", "message": "fix review", "committedDate": "2020-12-28T09:15:14Z", "type": "commit"}, {"oid": "2c0c1193a64846651ce03c9e5f755afb3e5f7f1f", "url": "https://github.com/apache/iotdb/commit/2c0c1193a64846651ce03c9e5f755afb3e5f7f1f", "message": "fix concurrent", "committedDate": "2020-12-29T06:46:42Z", "type": "commit"}]}