{"pr_number": 1400, "pr_title": "[IOTDB-627]Support range deletion for timeseries", "pr_createdAt": "2020-06-21T16:29:11Z", "pr_url": "https://github.com/apache/iotdb/pull/1400", "timeline": [{"oid": "938fcb331297867a3564e9ec0906e60dfb25c954", "url": "https://github.com/apache/iotdb/commit/938fcb331297867a3564e9ec0906e60dfb25c954", "message": "Add range deletion syntax", "committedDate": "2020-06-17T09:45:10Z", "type": "commit"}, {"oid": "a052539c62259d1237d04da98e5c7d4a6cd686d9", "url": "https://github.com/apache/iotdb/commit/a052539c62259d1237d04da98e5c7d4a6cd686d9", "message": "Incrementally add range delete interface for query and storage hierarchy", "committedDate": "2020-06-19T08:41:22Z", "type": "commit"}, {"oid": "5dcd3288939db8d17189c94b59a82b395928c3f6", "url": "https://github.com/apache/iotdb/commit/5dcd3288939db8d17189c94b59a82b395928c3f6", "message": "Enable range delete in queries", "committedDate": "2020-06-21T16:14:08Z", "type": "commit"}, {"oid": "2e9b17d4133a9dc6c29ad95d7a611b0fbd424a0c", "url": "https://github.com/apache/iotdb/commit/2e9b17d4133a9dc6c29ad95d7a611b0fbd424a0c", "message": "resolve conflics with master", "committedDate": "2020-06-21T16:21:57Z", "type": "commit"}, {"oid": "50bcde2cf5de9c75d8aec39c59e30726ab180c3b", "url": "https://github.com/apache/iotdb/commit/50bcde2cf5de9c75d8aec39c59e30726ab180c3b", "message": "Add range delete in TVList and fix test cases", "committedDate": "2020-06-22T15:41:28Z", "type": "commit"}, {"oid": "72a827a973b81838cdb9d648390b0ccfc759f5b8", "url": "https://github.com/apache/iotdb/commit/72a827a973b81838cdb9d648390b0ccfc759f5b8", "message": "Fix compilation issue on CI", "committedDate": "2020-06-23T01:12:59Z", "type": "commit"}, {"oid": "2bf862bffc2849b39f14469651d3190119df5693", "url": "https://github.com/apache/iotdb/commit/2bf862bffc2849b39f14469651d3190119df5693", "message": "Fix bug for test cases", "committedDate": "2020-06-23T03:04:10Z", "type": "commit"}, {"oid": "1533a1204d0e0d4b0c5473e85fbca0d6ef55e6c9", "url": "https://github.com/apache/iotdb/commit/1533a1204d0e0d4b0c5473e85fbca0d6ef55e6c9", "message": "Modify session delete API and remove unused code", "committedDate": "2020-06-23T04:05:26Z", "type": "commit"}, {"oid": "304f7820fb68dfc658e03422cd242b5d99d29004", "url": "https://github.com/apache/iotdb/commit/304f7820fb68dfc658e03422cd242b5d99d29004", "message": "Fix test case", "committedDate": "2020-06-23T05:11:06Z", "type": "commit"}, {"oid": "3c395144a4c138dc6d189405e7f2ee6d0572a042", "url": "https://github.com/apache/iotdb/commit/3c395144a4c138dc6d189405e7f2ee6d0572a042", "message": "Fix test case error", "committedDate": "2020-06-23T05:57:09Z", "type": "commit"}, {"oid": "c8f0aed727237494c7e5066f52c79965be119e41", "url": "https://github.com/apache/iotdb/commit/c8f0aed727237494c7e5066f52c79965be119e41", "message": "Update docs and remove some code", "committedDate": "2020-06-23T06:37:55Z", "type": "commit"}, {"oid": "fc0bf399ba929763e82af501969d507d4bc8b44c", "url": "https://github.com/apache/iotdb/commit/fc0bf399ba929763e82af501969d507d4bc8b44c", "message": "Support older version mods files", "committedDate": "2020-06-23T09:26:44Z", "type": "commit"}, {"oid": "c28acdb0b439ea2c950464398aa6aeda33550572", "url": "https://github.com/apache/iotdb/commit/c28acdb0b439ea2c950464398aa6aeda33550572", "message": "Delete last cache if necessary", "committedDate": "2020-06-24T02:11:39Z", "type": "commit"}, {"oid": "28d44de20594d9e4b1ef188222e2bb4d47409815", "url": "https://github.com/apache/iotdb/commit/28d44de20594d9e4b1ef188222e2bb4d47409815", "message": "Merge remote-tracking branch 'upstream/master' into range_delete", "committedDate": "2020-06-24T02:12:01Z", "type": "commit"}, {"oid": "746c0b3c9087cfed454acb399977755711814eeb", "url": "https://github.com/apache/iotdb/commit/746c0b3c9087cfed454acb399977755711814eeb", "message": "Fix delete last bug", "committedDate": "2020-06-24T03:14:16Z", "type": "commit"}, {"oid": "9795915def5bb871801807ccbeab038e3f330b7d", "url": "https://github.com/apache/iotdb/commit/9795915def5bb871801807ccbeab038e3f330b7d", "message": "Fix test result", "committedDate": "2020-06-24T06:08:48Z", "type": "commit"}, {"oid": "4667afb556ba8027469fddf1bdf4b7aefef75e75", "url": "https://github.com/apache/iotdb/commit/4667afb556ba8027469fddf1bdf4b7aefef75e75", "message": "Documentation updates", "committedDate": "2020-06-24T08:08:28Z", "type": "commit"}, {"oid": "135302307ae30ea367c61c90d63627d95a32fd58", "url": "https://github.com/apache/iotdb/commit/135302307ae30ea367c61c90d63627d95a32fd58", "message": "Test case update", "committedDate": "2020-06-24T08:30:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc1ODI4MQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r446758281", "bodyText": "if (modification instanceof Deletion)", "author": "jixuan1989", "createdAt": "2020-06-29T03:56:05Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/memtable/AbstractMemTable.java", "diffHunk": "@@ -203,38 +204,38 @@ public ReadOnlyMemChunk query(String deviceId, String measurement, TSDataType da\n     if (!checkPath(deviceId, measurement)) {\n       return null;\n     }\n-    long undeletedTime = findUndeletedTime(deviceId, measurement, timeLowerBound);\n+    List<Pair<Long, Long>> deletionList = findUndeletedTime(deviceId, measurement, timeLowerBound);\n     IWritableMemChunk memChunk = memTableMap.get(deviceId).get(measurement);\n     TVList chunkCopy = memChunk.getTVList().clone();\n \n-    chunkCopy.setTimeOffset(undeletedTime);\n+    chunkCopy.setDeletionList(deletionList);\n     return new ReadOnlyMemChunk(measurement, dataType, encoding, chunkCopy, props, getVersion());\n   }\n \n \n-  private long findUndeletedTime(String deviceId, String measurement, long timeLowerBound) {\n-    long undeletedTime = Long.MIN_VALUE;\n+  private List<Pair<Long, Long>> findUndeletedTime(String deviceId, String measurement,\n+      long timeLowerBound) {\n+    List<Pair<Long, Long>> deletionList = new ArrayList<>();\n     for (Modification modification : modifications) {\n-      if (modification instanceof Deletion) {\n-        Deletion deletion = (Deletion) modification;\n-        if (deletion.getDevice().equals(deviceId) && deletion.getMeasurement().equals(measurement)\n-            && deletion.getTimestamp() > undeletedTime) {\n-          undeletedTime = deletion.getTimestamp();\n-        }\n+      Deletion deletion = (Deletion) modification;", "originalCommit": "135302307ae30ea367c61c90d63627d95a32fd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM1Njg1NA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r447356854", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-06-30T01:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc1ODI4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc1ODc1Mg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r446758752", "bodyText": "the method name should be changed.", "author": "jixuan1989", "createdAt": "2020-06-29T03:57:31Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/memtable/AbstractMemTable.java", "diffHunk": "@@ -203,38 +204,38 @@ public ReadOnlyMemChunk query(String deviceId, String measurement, TSDataType da\n     if (!checkPath(deviceId, measurement)) {\n       return null;\n     }\n-    long undeletedTime = findUndeletedTime(deviceId, measurement, timeLowerBound);\n+    List<Pair<Long, Long>> deletionList = findUndeletedTime(deviceId, measurement, timeLowerBound);\n     IWritableMemChunk memChunk = memTableMap.get(deviceId).get(measurement);\n     TVList chunkCopy = memChunk.getTVList().clone();\n \n-    chunkCopy.setTimeOffset(undeletedTime);\n+    chunkCopy.setDeletionList(deletionList);\n     return new ReadOnlyMemChunk(measurement, dataType, encoding, chunkCopy, props, getVersion());\n   }\n \n \n-  private long findUndeletedTime(String deviceId, String measurement, long timeLowerBound) {\n-    long undeletedTime = Long.MIN_VALUE;\n+  private List<Pair<Long, Long>> findUndeletedTime(String deviceId, String measurement,", "originalCommit": "135302307ae30ea367c61c90d63627d95a32fd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM1Njg5Mg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r447356892", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-06-30T01:39:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc1ODc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc1OTMyMQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r446759321", "bodyText": "!=5 first, then !=4", "author": "jixuan1989", "createdAt": "2020-06-29T04:00:28Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/modification/io/LocalTextModificationAccessor.java", "diffHunk": "@@ -124,28 +124,42 @@ private static Modification decodeModification(String src) throws IOException {\n   private static String encodeDeletion(Deletion del) {\n     return del.getType().toString() + SEPARATOR + del.getPathString()\n         + SEPARATOR + del.getVersionNum() + SEPARATOR\n-        + del.getTimestamp();\n+        + del.getStartTime() + SEPARATOR + del.getEndTime();\n   }\n \n   private static Deletion decodeDeletion(String[] fields) throws IOException {\n-    if (fields.length != 4) {\n+    if (fields.length != 4 && fields.length != 5) {", "originalCommit": "135302307ae30ea367c61c90d63627d95a32fd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM1NjkxNg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r447356916", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-06-30T01:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc1OTMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3OTc1OQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r446779759", "bodyText": ".filter( x -> x instanceof Deletion)", "author": "jixuan1989", "createdAt": "2020-06-29T05:27:55Z", "path": "server/src/main/java/org/apache/iotdb/db/utils/QueryUtils.java", "diffHunk": "@@ -45,46 +49,52 @@ private QueryUtils() {\n    */\n   public static void modifyChunkMetaData(List<ChunkMetadata> chunkMetaData,\n                                          List<Modification> modifications) {\n-    int modIndex = 0;\n+    List<Modification> sortedModifications = sortModifications(modifications);\n \n     for (int metaIndex = 0; metaIndex < chunkMetaData.size(); metaIndex++) {\n       ChunkMetadata metaData = chunkMetaData.get(metaIndex);\n-      for (int j = modIndex; j < modifications.size(); j++) {\n-        // iterate each modification to find the max deletion time\n-        Modification modification = modifications.get(j);\n+      for (Modification modification : sortedModifications) {\n         if (modification.getVersionNum() > metaData.getVersion()) {\n-          // this modification is after the Chunk, try modifying the chunk\n-          // if this modification succeeds, update modIndex so in the next loop the previous\n-          // modifications will not be examined\n-          modIndex = doModifyChunkMetaData(modification, metaData)? j : modIndex;\n-        } else {\n-          // skip old modifications for next metadata\n-          modIndex++;\n+          doModifyChunkMetaData(modification, metaData);\n         }\n       }\n     }\n     // remove chunks that are completely deleted\n     chunkMetaData.removeIf(metaData -> {\n-      if (metaData.getDeletedAt() >= metaData.getEndTime()) {\n-        return true;\n-      } else {\n-        if (metaData.getDeletedAt() >= metaData.getStartTime()) {\n+      long lower = metaData.getStartTime();\n+      long upper = metaData.getEndTime();\n+      for (Pair<Long, Long> range : metaData.getDeleteRangeList()) {\n+        if (upper < range.left) {\n+          break;\n+        }\n+        if (range.left <= lower && lower <= range.right) {\n+          metaData.setModified(true);\n+          if (upper <= range.right) {\n+            return true;\n+          }\n+          lower = range.right;\n+        } else if (lower < range.left) {\n           metaData.setModified(true);\n+          break;\n         }\n-        return false;\n       }\n+      return false;\n     });\n   }\n \n-  private static boolean doModifyChunkMetaData(Modification modification, ChunkMetadata metaData) {\n+  private static LinkedList<Modification> sortModifications(List<Modification> modifications) {\n+    return modifications.stream()\n+        .sorted(", "originalCommit": "135302307ae30ea367c61c90d63627d95a32fd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM1Njk1Mw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r447356953", "bodyText": "Added", "author": "wshao08", "createdAt": "2020-06-30T01:39:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3OTc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4MTI5Mg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r446781292", "bodyText": "Deletion operation is rare.\nPut new ArrayList() to delete(), add check whether the list == null before using it.", "author": "jixuan1989", "createdAt": "2020-06-29T05:33:11Z", "path": "server/src/main/java/org/apache/iotdb/db/utils/datastructure/TVList.java", "diffHunk": "@@ -46,7 +47,7 @@\n   /**\n    * this field is effective only in the Tvlist in a RealOnlyMemChunk.\n    */\n-  private long timeOffset = Long.MIN_VALUE;\n+  private List<Pair<Long, Long>> deletionList = new ArrayList<>();", "originalCommit": "135302307ae30ea367c61c90d63627d95a32fd58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4NTI5MQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r446785291", "bodyText": "similar, deleteRangeList usually be null.", "author": "jixuan1989", "createdAt": "2020-06-29T05:46:58Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/page/PageReader.java", "diffHunk": "@@ -61,9 +64,9 @@\n   private Filter filter;\n \n   /**\n-   * Data whose timestamp <= deletedAt should be considered deleted(not be returned).\n+   * A list of deleted intervals.\n    */\n-  private long deletedAt = Long.MIN_VALUE;\n+  private List<Pair<Long, Long>> deleteRangeList = new ArrayList<>();", "originalCommit": "135302307ae30ea367c61c90d63627d95a32fd58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "862a3eec2c2b41ea103989d7f0c4916fbb6737f1", "url": "https://github.com/apache/iotdb/commit/862a3eec2c2b41ea103989d7f0c4916fbb6737f1", "message": "Correct PR review issue", "committedDate": "2020-06-29T08:46:23Z", "type": "commit"}, {"oid": "0efc1c05739e63c989c192e13f6beff0d44bcac4", "url": "https://github.com/apache/iotdb/commit/0efc1c05739e63c989c192e13f6beff0d44bcac4", "message": "Add old/new hybrid deletion tests", "committedDate": "2020-06-29T10:22:36Z", "type": "commit"}, {"oid": "56d0996609cba9d613a48735bef1c8b5515b672d", "url": "https://github.com/apache/iotdb/commit/56d0996609cba9d613a48735bef1c8b5515b672d", "message": "fix test", "committedDate": "2020-06-29T12:26:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA2NDUxMw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r447064513", "bodyText": "em... if so, you still generate many ArrayList instances ...\nIf you do not want to check whether the list is null, use Collections.emptyList instead", "author": "jixuan1989", "createdAt": "2020-06-29T15:36:43Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/ChunkMetadata.java", "diffHunk": "@@ -171,12 +174,22 @@ public void setVersion(long version) {\n     this.version = version;\n   }\n \n-  public long getDeletedAt() {\n-    return deletedAt;\n+  public List<Pair<Long, Long>> getDeleteRangeList() {\n+    if (deleteRangeList == null) {", "originalCommit": "56d0996609cba9d613a48735bef1c8b5515b672d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM3NzI2OQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r447377269", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-06-30T02:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA2NDUxMw=="}], "type": "inlineReview"}, {"oid": "697e3a05a0db67f27f18c26066105cc9348d309c", "url": "https://github.com/apache/iotdb/commit/697e3a05a0db67f27f18c26066105cc9348d309c", "message": "Fix PR review and use deleteInterval rather than deleteRange  as the name", "committedDate": "2020-06-30T02:46:22Z", "type": "commit"}, {"oid": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "url": "https://github.com/apache/iotdb/commit/35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "message": "Merge remote-tracking branch 'upstream/master' into range_delete", "committedDate": "2020-07-01T06:53:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg1NjM5Nw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448856397", "bodyText": "I wonder why LinkedList is preferred.", "author": "jt2594838", "createdAt": "2020-07-02T09:02:06Z", "path": "server/src/main/java/org/apache/iotdb/db/utils/QueryUtils.java", "diffHunk": "@@ -45,46 +49,52 @@ private QueryUtils() {\n    */\n   public static void modifyChunkMetaData(List<ChunkMetadata> chunkMetaData,\n                                          List<Modification> modifications) {\n-    int modIndex = 0;\n+    List<Modification> sortedModifications = sortModifications(modifications);\n \n     for (int metaIndex = 0; metaIndex < chunkMetaData.size(); metaIndex++) {\n       ChunkMetadata metaData = chunkMetaData.get(metaIndex);\n-      for (int j = modIndex; j < modifications.size(); j++) {\n-        // iterate each modification to find the max deletion time\n-        Modification modification = modifications.get(j);\n+      for (Modification modification : sortedModifications) {\n         if (modification.getVersionNum() > metaData.getVersion()) {\n-          // this modification is after the Chunk, try modifying the chunk\n-          // if this modification succeeds, update modIndex so in the next loop the previous\n-          // modifications will not be examined\n-          modIndex = doModifyChunkMetaData(modification, metaData)? j : modIndex;\n-        } else {\n-          // skip old modifications for next metadata\n-          modIndex++;\n+          doModifyChunkMetaData(modification, metaData);\n         }\n       }\n     }\n     // remove chunks that are completely deleted\n     chunkMetaData.removeIf(metaData -> {\n-      if (metaData.getDeletedAt() >= metaData.getEndTime()) {\n-        return true;\n-      } else {\n-        if (metaData.getDeletedAt() >= metaData.getStartTime()) {\n-          metaData.setModified(true);\n+      long lower = metaData.getStartTime();\n+      long upper = metaData.getEndTime();\n+      if (metaData.getDeleteIntervalList() != null) {\n+        for (Pair<Long, Long> range : metaData.getDeleteIntervalList()) {\n+          if (upper < range.left) {\n+            break;\n+          }\n+          if (range.left <= lower && lower <= range.right) {\n+            metaData.setModified(true);\n+            if (upper <= range.right) {\n+              return true;\n+            }\n+            lower = range.right;\n+          } else if (lower < range.left) {\n+            metaData.setModified(true);\n+            break;\n+          }\n         }\n-        return false;\n       }\n+      return false;\n     });\n   }\n \n-  private static boolean doModifyChunkMetaData(Modification modification, ChunkMetadata metaData) {\n+  private static LinkedList<Modification> sortModifications(List<Modification> modifications) {\n+    return modifications.stream().filter(x -> x instanceof Deletion)\n+        .sorted(Comparator.comparingLong(mods -> ((Deletion) mods).getStartTime()))\n+        .collect(Collectors.toCollection(LinkedList::new));\n+  }", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2MTAzMg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448861032", "bodyText": "I think it is not necessary to start from the first of the deletions at each call of isPointDeleted(), as this method is called with ordered timestamps, if one timestamp is after the range of one deletion, all remaining timestamps will either.", "author": "jt2594838", "createdAt": "2020-07-02T09:09:56Z", "path": "server/src/main/java/org/apache/iotdb/db/utils/datastructure/TVList.java", "diffHunk": "@@ -531,6 +530,17 @@ public boolean hasNextTimeValuePair() {\n       return hasCachedPair;\n     }\n \n+    private boolean isPointDeleted(long timestamp) {\n+      if (deletionList != null) {\n+        for (Pair<Long, Long> del : deletionList) {\n+          if (del.left <= timestamp && timestamp <= del.right) {\n+            return true;\n+          }\n+        }", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzkzMA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r450587930", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-07T03:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2MTAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2MTU1Mg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448861552", "bodyText": "Please mind the format.", "author": "jt2594838", "createdAt": "2020-07-02T09:10:50Z", "path": "server/src/test/java/org/apache/iotdb/db/engine/merge/MergeTaskTest.java", "diffHunk": "@@ -218,7 +218,7 @@ public void testPartialMerge3() throws Exception {\n   public void mergeWithDeletionTest() throws Exception {\n     try {\n       seqResources.get(0).getModFile().write(new Deletion(new Path(deviceIds[0],\n-          measurementSchemas[0].getMeasurementId()), 10000, 49));\n+          measurementSchemas[0].getMeasurementId()), 10000, 0,49));", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4Nzk0Mw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r450587943", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-07T03:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2MTU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2MzAzNA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448863034", "bodyText": "It may simply be changed to a call of deleteData(paths, Long.MIN_VALUE, endtime).", "author": "jt2594838", "createdAt": "2020-07-02T09:13:21Z", "path": "session/src/main/java/org/apache/iotdb/session/Session.java", "diffHunk": "@@ -747,14 +747,37 @@ public void deleteData(String path, long time)\n    * delete data <= time in multiple timeseries\n    *\n    * @param paths data in which time series to delete\n-   * @param time  data with time stamp less than or equal to time will be deleted\n+   * @param endTime data with time stamp less than or equal to time will be deleted\n    */\n-  public void deleteData(List<String> paths, long time)\n+  public void deleteData(List<String> paths, long endTime)\n       throws IoTDBConnectionException, StatementExecutionException {\n     TSDeleteDataReq request = new TSDeleteDataReq();\n     request.setSessionId(sessionId);\n     request.setPaths(paths);\n-    request.setTimestamp(time);\n+    request.setStartTime(Long.MIN_VALUE);\n+    request.setEndTime(endTime);\n+", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4Nzk3OQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r450587979", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-07T03:12:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2MzAzNA=="}], "type": "inlineReview"}, {"oid": "41033e9a117eace9cf64466a5bb5845552632cec", "url": "https://github.com/apache/iotdb/commit/41033e9a117eace9cf64466a5bb5845552632cec", "message": "Set merge deletion version to 1", "committedDate": "2020-07-02T10:06:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgyNjMyNw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448826327", "bodyText": "Don't we need to add a [-infinity, lowerBound] into deletionList?", "author": "qiaojialin", "createdAt": "2020-07-02T08:12:41Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/memtable/AbstractMemTable.java", "diffHunk": "@@ -203,38 +204,40 @@ public ReadOnlyMemChunk query(String deviceId, String measurement, TSDataType da\n     if (!checkPath(deviceId, measurement)) {\n       return null;\n     }\n-    long undeletedTime = findUndeletedTime(deviceId, measurement, timeLowerBound);\n+    List<Pair<Long, Long>> deletionList = constructDeletionList(deviceId, measurement, timeLowerBound);\n     IWritableMemChunk memChunk = memTableMap.get(deviceId).get(measurement);\n     TVList chunkCopy = memChunk.getTVList().clone();\n \n-    chunkCopy.setTimeOffset(undeletedTime);\n+    chunkCopy.setDeletionList(deletionList);\n     return new ReadOnlyMemChunk(measurement, dataType, encoding, chunkCopy, props, getVersion());\n   }\n \n \n-  private long findUndeletedTime(String deviceId, String measurement, long timeLowerBound) {\n-    long undeletedTime = Long.MIN_VALUE;\n+  private List<Pair<Long, Long>> constructDeletionList(String deviceId, String measurement,\n+      long timeLowerBound) {\n+    List<Pair<Long, Long>> deletionList = new ArrayList<>();\n     for (Modification modification : modifications) {\n       if (modification instanceof Deletion) {\n         Deletion deletion = (Deletion) modification;\n         if (deletion.getDevice().equals(deviceId) && deletion.getMeasurement().equals(measurement)\n-            && deletion.getTimestamp() > undeletedTime) {\n-          undeletedTime = deletion.getTimestamp();\n+            && deletion.getEndTime() > timeLowerBound) {\n+          long lowerBound = Math.max(deletion.getStartTime(), timeLowerBound);\n+          deletionList.add(new Pair<>(lowerBound, deletion.getEndTime()));", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNDc1Mw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451304753", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-08T06:10:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgyNjMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgzNTM3OA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448835378", "bodyText": "this.startTime = Long.MIN_VALUE;", "author": "qiaojialin", "createdAt": "2020-07-02T08:28:29Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/modification/Deletion.java", "diffHunk": "@@ -28,21 +28,36 @@\n public class Deletion extends Modification {\n \n   /**\n-   * data whose timestamp <= this field are to be deleted.\n+   * data within the interval [startTime, endTime] are to be deleted.\n    */\n-  private long timestamp;\n+  private long startTime;\n+  private long endTime;\n \n-  public Deletion(Path path, long versionNum, long timestamp) {\n+  public Deletion(Path path, long versionNum, long endTime) {\n     super(Type.DELETION, path, versionNum);\n-    this.timestamp = timestamp;\n+    this.endTime = endTime;", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNDc4OA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451304788", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-08T06:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgzNTM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg0MjI4MA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448842280", "bodyText": "You can combine the two parsing and put the whole deletion line into IOException", "author": "qiaojialin", "createdAt": "2020-07-02T08:39:27Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/modification/io/LocalTextModificationAccessor.java", "diffHunk": "@@ -124,28 +124,42 @@ private static Modification decodeModification(String src) throws IOException {\n   private static String encodeDeletion(Deletion del) {\n     return del.getType().toString() + SEPARATOR + del.getPathString()\n         + SEPARATOR + del.getVersionNum() + SEPARATOR\n-        + del.getTimestamp();\n+        + del.getStartTime() + SEPARATOR + del.getEndTime();\n   }\n \n   private static Deletion decodeDeletion(String[] fields) throws IOException {\n-    if (fields.length != 4) {\n+    if (fields.length != 5 && fields.length != 4) {\n       throw new IOException(\"Incorrect deletion fields number: \" + fields.length);\n     }\n \n     String path = fields[1];\n     long versionNum;\n-    long timestamp;\n+    long startTimestamp = Long.MIN_VALUE;\n+    long endTimestamp;\n     try {\n       versionNum = Long.parseLong(fields[2]);\n     } catch (NumberFormatException e) {\n       throw new IOException(\"Invalid version number: \" + fields[2]);\n     }\n-    try {\n-      timestamp = Long.parseLong(fields[3]);\n-    } catch (NumberFormatException e) {\n-      throw new IOException(\"Invalid timestamp: \" + fields[3]);\n+    if (fields.length == 4) {\n+      try {\n+        endTimestamp = Long.parseLong(fields[3]);\n+      } catch (NumberFormatException e) {\n+        throw new IOException(\"Invalid timestamp: \" + fields[3]);\n+      }\n+    } else {\n+      try {\n+        startTimestamp = Long.parseLong(fields[3]);\n+      } catch (NumberFormatException e) {\n+        throw new IOException(\"Invalid timestamp: \" + fields[3]);\n+      }\n+      try {\n+        endTimestamp = Long.parseLong(fields[4]);\n+      } catch (NumberFormatException e) {\n+        throw new IOException(\"Invalid timestamp: \" + fields[4]);\n+      }", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNDg2Nw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451304867", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-08T06:10:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg0MjI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2OTIwNQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448869205", "bodyText": "It's better to remove this constructor, it may misleading others that this means delete time = deleteTime.", "author": "qiaojialin", "createdAt": "2020-07-02T09:24:01Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/DeletePlan.java", "diffHunk": "@@ -45,7 +46,22 @@ public DeletePlan() {\n    */\n   public DeletePlan(long deleteTime, Path path) {\n     super(false, Operator.OperatorType.DELETE);\n-    this.deleteTime = deleteTime;\n+    this.deleteStartTime = Long.MIN_VALUE;\n+    this.deleteEndTime = deleteTime;\n+    this.paths.add(path);\n+  }", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2OTg3NQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448869875", "bodyText": "also delete this", "author": "qiaojialin", "createdAt": "2020-07-02T09:24:59Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/DeletePlan.java", "diffHunk": "@@ -57,16 +73,39 @@ public DeletePlan(long deleteTime, Path path) {\n    */\n   public DeletePlan(long deleteTime, List<Path> paths) {\n     super(false, Operator.OperatorType.DELETE);\n-    this.deleteTime = deleteTime;\n+    this.deleteStartTime = Long.MIN_VALUE;\n+    this.deleteEndTime = deleteTime;\n+    this.paths = paths;\n+  }", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNDkzNg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451304936", "bodyText": "Done", "author": "wshao08", "createdAt": "2020-07-08T06:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2OTg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg3Nzk0OA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448877948", "bodyText": "add more check for BinaryOperator, it must be a AndOperator and the  lower bound must <= the upper bound", "author": "qiaojialin", "createdAt": "2020-07-02T09:38:43Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/LogicalGenerator.java", "diffHunk": "@@ -1550,18 +1552,52 @@ long parseTimeFormat(String timestampStr) throws SQLParserException {\n    *\n    * @param operator delete logical plan\n    */\n-  private long parseDeleteTimeFilter(DeleteDataOperator operator) {\n+  private Pair<Long, Long> parseDeleteTimeRange(DeleteDataOperator operator) {\n     FilterOperator filterOperator = operator.getFilterOperator();\n-    if (filterOperator.getTokenIntType() != SQLConstant.LESSTHAN\n-        && filterOperator.getTokenIntType() != SQLConstant.LESSTHANOREQUALTO) {\n+    if (!filterOperator.isLeaf() && filterOperator.getTokenIntType() != SQLConstant.KW_AND) {\n       throw new SQLParserException(\n-          \"For delete command, where clause must be like : time < XXX or time <= XXX\");\n+          \"For delete command, where clause can only contain atomic expressions like : \"\n+              + \"time > XXX, time <= XXX, or And with two atomic expressions\");\n     }\n+\n+    if (filterOperator.isLeaf()) {\n+      return calcOperatorRange(filterOperator);\n+    }\n+\n+    List<FilterOperator> children = filterOperator.getChildren();\n+    FilterOperator lOperator = children.get(0);", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg4NjA4Mg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448886082", "bodyText": "This should be sortAndMerge\nSuppose we have [1,10], [5,12], [15,20], [16,21]\nIt's better to merge them to [1,12] and [15,21]", "author": "qiaojialin", "createdAt": "2020-07-02T09:52:33Z", "path": "server/src/main/java/org/apache/iotdb/db/utils/QueryUtils.java", "diffHunk": "@@ -45,46 +49,52 @@ private QueryUtils() {\n    */\n   public static void modifyChunkMetaData(List<ChunkMetadata> chunkMetaData,\n                                          List<Modification> modifications) {\n-    int modIndex = 0;\n+    List<Modification> sortedModifications = sortModifications(modifications);\n \n     for (int metaIndex = 0; metaIndex < chunkMetaData.size(); metaIndex++) {\n       ChunkMetadata metaData = chunkMetaData.get(metaIndex);\n-      for (int j = modIndex; j < modifications.size(); j++) {\n-        // iterate each modification to find the max deletion time\n-        Modification modification = modifications.get(j);\n+      for (Modification modification : sortedModifications) {\n         if (modification.getVersionNum() > metaData.getVersion()) {\n-          // this modification is after the Chunk, try modifying the chunk\n-          // if this modification succeeds, update modIndex so in the next loop the previous\n-          // modifications will not be examined\n-          modIndex = doModifyChunkMetaData(modification, metaData)? j : modIndex;\n-        } else {\n-          // skip old modifications for next metadata\n-          modIndex++;\n+          doModifyChunkMetaData(modification, metaData);\n         }\n       }\n     }\n     // remove chunks that are completely deleted\n     chunkMetaData.removeIf(metaData -> {\n-      if (metaData.getDeletedAt() >= metaData.getEndTime()) {\n-        return true;\n-      } else {\n-        if (metaData.getDeletedAt() >= metaData.getStartTime()) {\n-          metaData.setModified(true);\n+      long lower = metaData.getStartTime();\n+      long upper = metaData.getEndTime();\n+      if (metaData.getDeleteIntervalList() != null) {\n+        for (Pair<Long, Long> range : metaData.getDeleteIntervalList()) {\n+          if (upper < range.left) {\n+            break;\n+          }\n+          if (range.left <= lower && lower <= range.right) {\n+            metaData.setModified(true);\n+            if (upper <= range.right) {\n+              return true;\n+            }\n+            lower = range.right;\n+          } else if (lower < range.left) {\n+            metaData.setModified(true);\n+            break;\n+          }\n         }\n-        return false;\n       }\n+      return false;\n     });\n   }\n \n-  private static boolean doModifyChunkMetaData(Modification modification, ChunkMetadata metaData) {\n+  private static LinkedList<Modification> sortModifications(List<Modification> modifications) {", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNjM3Ng==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451306376", "bodyText": "Change to sort and merge intervals when added into ChunkMetadata", "author": "wshao08", "createdAt": "2020-07-08T06:15:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg4NjA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5Mjk4NQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448892985", "bodyText": "you record the deletion pair in the TVList, when iterating the TVList, it's better to sortAndMerge all deletions.\nWhen calling the Ite, the TVList should be sorted already, you can store the deletions inside the Ite and record and index of current checked deletion. Then you could use a more efficient way to check which point is deleted.", "author": "qiaojialin", "createdAt": "2020-07-02T10:04:50Z", "path": "server/src/main/java/org/apache/iotdb/db/utils/datastructure/TVList.java", "diffHunk": "@@ -519,7 +518,7 @@ public boolean hasNextTimeValuePair() {\n \n       while (cur < size) {\n         long time = getTime(cur);\n-        if (time < getTimeOffset() || (cur + 1 < size() && (time == getTime(cur + 1)))) {\n+        if (isPointDeleted(time) || (cur + 1 < size() && (time == getTime(cur + 1)))) {", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNjQ3NQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451306475", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-08T06:15:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5Mjk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5NjQ1MQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448896451", "bodyText": "if the page is totally deleted, this page is not satisfied, return false.", "author": "qiaojialin", "createdAt": "2020-07-02T10:11:20Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/chunk/ChunkReader.java", "diffHunk": "@@ -131,10 +132,25 @@ private void skipBytesInStreamByLength(long length) {\n   }\n \n   public boolean pageSatisfied(PageHeader pageHeader) {\n-    if (pageHeader.getEndTime() <= deletedAt) {\n-      return false;\n-    } else if (pageHeader.getStartTime() <= deletedAt) {\n-      pageHeader.setModified(true);\n+    long lower = pageHeader.getStartTime();\n+    long upper = pageHeader.getEndTime();\n+    // deleteIntervalList is sorted in terms of startTime\n+    if (deleteIntervalList != null) {\n+      for (Pair<Long, Long> range : deleteIntervalList) {\n+        if (upper < range.left) {\n+          break;\n+        }\n+        if (range.left <= lower && lower <= range.right) {\n+          pageHeader.setModified(true);\n+          if (upper <= range.right) {\n+            return true;", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNTA2Mg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451305062", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-08T06:11:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5NjQ1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5NjkzMQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448896931", "bodyText": "remove this", "author": "qiaojialin", "createdAt": "2020-07-02T10:12:17Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/chunk/ChunkReaderByTimestamp.java", "diffHunk": "@@ -35,7 +35,10 @@ public ChunkReaderByTimestamp(Chunk chunk) throws IOException {\n   public boolean pageSatisfied(PageHeader pageHeader) {\n     long maxTimestamp = pageHeader.getEndTime();\n     // if maxTimestamp > currentTimestamp, this page should NOT be skipped\n-    return maxTimestamp >= currentTimestamp && maxTimestamp > deletedAt;\n+    // return maxTimestamp >= currentTimestamp && super.pageSatisfied(pageHeader);", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNTA5MA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451305090", "bodyText": "Done", "author": "wshao08", "createdAt": "2020-07-08T06:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5NjkzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5NzY1Mg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r448897652", "bodyText": "also, the Deletions should be sortAndMerge, then optimize this check", "author": "qiaojialin", "createdAt": "2020-07-02T10:13:41Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/page/PageReader.java", "diffHunk": "@@ -159,12 +161,23 @@ public void setFilter(Filter filter) {\n     this.filter = filter;\n   }\n \n-  public void setDeletedAt(long deletedAt) {\n-    this.deletedAt = deletedAt;\n+  public void setDeleteIntervalList(List<Pair<Long, Long>> list) {\n+    this.deleteIntervalList = list;\n   }\n \n   @Override\n   public boolean isModified() {\n     return pageHeader.isModified();\n   }\n+\n+  private boolean isDeleted(long timestamp) {", "originalCommit": "35de2ba3ae213e0a79793d10d0e6404aa9a49b65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d5b905556a5f0bec501586434e806ab0d02ea440", "url": "https://github.com/apache/iotdb/commit/d5b905556a5f0bec501586434e806ab0d02ea440", "message": "Add more restrictions to range delete syntax and fix minor issues", "committedDate": "2020-07-03T08:21:32Z", "type": "commit"}, {"oid": "dcd4aac52094b79e64d7b6be0dc4a76fdbc038ec", "url": "https://github.com/apache/iotdb/commit/dcd4aac52094b79e64d7b6be0dc4a76fdbc038ec", "message": "Merge remote-tracking branch 'upstream/master' into range_delete", "committedDate": "2020-07-03T08:21:56Z", "type": "commit"}, {"oid": "906a6ae2d91313b70efb7caf3ee8eb0d14908342", "url": "https://github.com/apache/iotdb/commit/906a6ae2d91313b70efb7caf3ee8eb0d14908342", "message": "Fix test issue", "committedDate": "2020-07-03T09:13:31Z", "type": "commit"}, {"oid": "a3f0c4ce8ca7256d9367e411b09cfd9566b6bf1b", "url": "https://github.com/apache/iotdb/commit/a3f0c4ce8ca7256d9367e411b09cfd9566b6bf1b", "message": "Sort and merge modifications and use cursor when traversing delete list", "committedDate": "2020-07-07T02:57:21Z", "type": "commit"}, {"oid": "95527600b63810cd9a997bb3602e9d88a2abcd57", "url": "https://github.com/apache/iotdb/commit/95527600b63810cd9a997bb3602e9d88a2abcd57", "message": "Merge remote-tracking branch 'upstream/master' into range_delete", "committedDate": "2020-07-07T02:57:38Z", "type": "commit"}, {"oid": "6c411cdca7af2d21f3fda8a8a9f9b21f83f17cbc", "url": "https://github.com/apache/iotdb/commit/6c411cdca7af2d21f3fda8a8a9f9b21f83f17cbc", "message": "Fix test issue", "committedDate": "2020-07-07T03:31:06Z", "type": "commit"}, {"oid": "a1b7ff080a011880e824dbb812fbb7ca36480189", "url": "https://github.com/apache/iotdb/commit/a1b7ff080a011880e824dbb812fbb7ca36480189", "message": "Fix regression test cases", "committedDate": "2020-07-07T09:05:08Z", "type": "commit"}, {"oid": "2eb6de6c7f3215e92834df7ab54fa1a4ea8d940a", "url": "https://github.com/apache/iotdb/commit/2eb6de6c7f3215e92834df7ab54fa1a4ea8d940a", "message": "Fix minor issues", "committedDate": "2020-07-07T09:49:30Z", "type": "commit"}, {"oid": "a2366834c2aae6540455a2c4c77239edfe417bb4", "url": "https://github.com/apache/iotdb/commit/a2366834c2aae6540455a2c4c77239edfe417bb4", "message": "Fix test errors", "committedDate": "2020-07-07T10:45:44Z", "type": "commit"}, {"oid": "4f85ecac71d96cb7f6e3448a6169859b82f5eabd", "url": "https://github.com/apache/iotdb/commit/4f85ecac71d96cb7f6e3448a6169859b82f5eabd", "message": "Fix TimeRange method bug", "committedDate": "2020-07-08T03:02:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxMDI3NQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451310275", "bodyText": "Why is this commented?", "author": "samperson1997", "createdAt": "2020-07-08T06:26:01Z", "path": "server/src/test/java/org/apache/iotdb/db/qp/plan/LogicalPlanSmallTest.java", "diffHunk": "@@ -237,5 +239,100 @@ public void testChineseCharacter() {\n     Assert.assertEquals(paths, ((QueryOperator) operator).getSelectedPaths());\n   }\n \n+  @Test\n+  public void testRangeDelete() {\n+    String sql1 = \"delete from root.d1.s1 where time>=1 and time < 3\";\n+    Operator op = parseDriver.parse(sql1, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    Assert.assertEquals(DeleteDataOperator.class, op.getClass());\n+    ArrayList<Path> paths = new ArrayList<>();\n+    paths.add(new Path(\"root.d1.s1\"));\n+    Assert.assertEquals(paths, ((DeleteDataOperator) op).getSelectedPaths());\n+    Assert.assertEquals(1, ((DeleteDataOperator) op).getStartTime());\n+    Assert.assertEquals(2, ((DeleteDataOperator) op).getEndTime());\n+\n+    String sql2 = \"delete from root.d1.s1 where time>=1\";\n+    op = parseDriver.parse(sql2, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    Assert.assertEquals(paths, ((DeleteDataOperator) op).getSelectedPaths());\n+    Assert.assertEquals(1, ((DeleteDataOperator) op).getStartTime());\n+    Assert.assertEquals(Long.MAX_VALUE, ((DeleteDataOperator) op).getEndTime());\n+\n+    String sql3 = \"delete from root.d1.s1 where time>1\";\n+    op = parseDriver.parse(sql3, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    Assert.assertEquals(paths, ((DeleteDataOperator) op).getSelectedPaths());\n+    Assert.assertEquals(2, ((DeleteDataOperator) op).getStartTime());\n+    Assert.assertEquals(Long.MAX_VALUE, ((DeleteDataOperator) op).getEndTime());\n+\n+    String sql4 = \"delete from root.d1.s1 where time <= 1\";\n+    op = parseDriver.parse(sql4, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    Assert.assertEquals(paths, ((DeleteDataOperator) op).getSelectedPaths());\n+    Assert.assertEquals(Long.MIN_VALUE, ((DeleteDataOperator) op).getStartTime());\n+    Assert.assertEquals(1, ((DeleteDataOperator) op).getEndTime());\n+\n+    String sql5 = \"delete from root.d1.s1 where time<1\";\n+    op = parseDriver.parse(sql5, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    Assert.assertEquals(paths, ((DeleteDataOperator) op).getSelectedPaths());\n+    Assert.assertEquals(Long.MIN_VALUE, ((DeleteDataOperator) op).getStartTime());\n+    Assert.assertEquals(0, ((DeleteDataOperator) op).getEndTime());\n+\n+    String sql6 = \"delete from root.d1.s1 where time = 3\";\n+    op = parseDriver.parse(sql6, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    Assert.assertEquals(paths, ((DeleteDataOperator) op).getSelectedPaths());\n+    Assert.assertEquals(3, ((DeleteDataOperator) op).getStartTime());\n+    Assert.assertEquals(3, ((DeleteDataOperator) op).getEndTime());\n \n+    String sql7 = \"delete from root.d1.s1 where time = 1 and time < -1\";\n+    String errorMsg = null;\n+    try {\n+      op = parseDriver.parse(sql7, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    } catch (RuntimeException e) {\n+      errorMsg = e.getMessage();\n+    }\n+    Assert.assertEquals(errorMsg, \"Invalid delete range: [1, -2]\");\n+\n+    String sql8 = \"delete from root.d1.s1 where time > 5 and time <= 0\";\n+    try {\n+      op = parseDriver.parse(sql8, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    } catch (RuntimeException e) {\n+      errorMsg = e.getMessage();\n+    }\n+    Assert.assertEquals(errorMsg, \"Invalid delete range: [6, 0]\");\n+  }\n+\n+  @Test\n+  public void testErrorDeleteRange() {\n+    String sql = \"delete from root.d1.s1 where time>=1 and time < 3 or time >1\";\n+    String errorMsg = null;\n+    try {\n+      parseDriver.parse(sql, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    } catch (SQLParserException e) {\n+      errorMsg = e.getMessage();\n+    }\n+    Assert.assertEquals(\n+        \"For delete command, where clause can only contain atomic expressions like : \"\n+            + \"time > XXX, time <= XXX, or And with two atomic expressions\",\n+        errorMsg);\n+\n+    sql = \"delete from root.d1.s1 where time>=1 or time < 3\";\n+    errorMsg = null;\n+    try {\n+      parseDriver.parse(sql, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    } catch (SQLParserException e) {\n+      errorMsg = e.getMessage();\n+    }\n+    Assert.assertEquals(\n+        \"For delete command, where clause can only contain atomic expressions like : \"\n+            + \"time > XXX, time <= XXX, or And with two atomic expressions\",\n+        errorMsg);\n+\n+    /*\n+    sql = \"delete from root.d1.s1 where time<=1 and time > 3\";\n+    errorMsg = null;\n+    try {\n+      parseDriver.parse(sql, IoTDBDescriptor.getInstance().getConfig().getZoneID());\n+    } catch (SQLParserException e) {\n+      errorMsg = e.getMessage();\n+    }\n+    Assert.assertEquals(\"Unreachable deleted time interval\", errorMsg);\n+     */", "originalCommit": "4f85ecac71d96cb7f6e3448a6169859b82f5eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzMDQyOA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451430428", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-08T10:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxMDI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxNDMyOA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451314328", "bodyText": "I think it's better to add the deleteInterval in string and hash code. What do you think?", "author": "samperson1997", "createdAt": "2020-07-08T06:36:05Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/ChunkMetadata.java", "diffHunk": "@@ -91,8 +94,8 @@ public ChunkMetadata(String measurementUid, TSDataType tsDataType, long fileOffs\n \n   @Override\n   public String toString() {\n-    return String.format(\"measurementId: %s, datatype: %s, version: %d, deletedAt: %d, \"\n-        + \"Statistics: %s\", measurementUid, tsDataType, version, deletedAt, statistics);\n+    return String.format(\"measurementId: %s, datatype: %s, version: %d, \"", "originalCommit": "4f85ecac71d96cb7f6e3448a6169859b82f5eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzMDYxNw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451430617", "bodyText": "Yes, added in toString and hash", "author": "wshao08", "createdAt": "2020-07-08T10:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxNDMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxNDg4OQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451314889", "bodyText": "I think deleteInterval should be compared as well", "author": "samperson1997", "createdAt": "2020-07-08T06:37:35Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/ChunkMetadata.java", "diffHunk": "@@ -198,15 +222,14 @@ public boolean equals(Object o) {\n     ChunkMetadata that = (ChunkMetadata) o;\n     return offsetOfChunkHeader == that.offsetOfChunkHeader &&\n         version == that.version &&\n-        deletedAt == that.deletedAt &&", "originalCommit": "4f85ecac71d96cb7f6e3448a6169859b82f5eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzMDY4Nw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451430687", "bodyText": "Added", "author": "wshao08", "createdAt": "2020-07-08T10:06:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxNDg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMyNTkzOQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451325939", "bodyText": "Could you please recheck the logic? deleteCursor will not be changed after calling this method, since you didn't return it... When you call this method, deleteCursor keeps value 0.", "author": "samperson1997", "createdAt": "2020-07-08T07:04:11Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/page/PageReader.java", "diffHunk": "@@ -159,12 +162,25 @@ public void setFilter(Filter filter) {\n     this.filter = filter;\n   }\n \n-  public void setDeletedAt(long deletedAt) {\n-    this.deletedAt = deletedAt;\n+  public void setDeleteIntervalList(List<TimeRange> list) {\n+    this.deleteIntervalList = list;\n   }\n \n   @Override\n   public boolean isModified() {\n     return pageHeader.isModified();\n   }\n+\n+  private boolean isDeleted(long timestamp, int deleteCursor) {", "originalCommit": "4f85ecac71d96cb7f6e3448a6169859b82f5eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzMDg2NA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451430864", "bodyText": "Fixed, thanks!", "author": "wshao08", "createdAt": "2020-07-08T10:06:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMyNTkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMzMTcyMg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451331722", "bodyText": "Format this line to 3 lines : D", "author": "samperson1997", "createdAt": "2020-07-08T07:16:28Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/common/TimeRange.java", "diffHunk": "@@ -103,6 +103,8 @@ public boolean contains(long min, long max) {\n     return this.min <= min && this.max >= max;\n   }\n \n+  public boolean contains(long time) {return this.min <= time && time <= this.max;}", "originalCommit": "4f85ecac71d96cb7f6e3448a6169859b82f5eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzMDM1Nw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451430357", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-08T10:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMzMTcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMzNTk1Mg==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451335952", "bodyText": "Why 1?", "author": "samperson1997", "createdAt": "2020-07-08T07:24:44Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -1350,14 +1353,13 @@ public void delete(String deviceId, String measurementId, long timestamp) throws\n         return;\n       }\n \n-      // time partition to divide storage group\n-      long timePartitionId = StorageEngine.getTimePartition(timestamp);\n       // write log to impacted working TsFileProcessors\n-      logDeletion(timestamp, deviceId, measurementId, timePartitionId);\n+      logDeletion(startTime, endTime, deviceId, measurementId);\n+      // delete Last cache record if necessary\n+      tryToDeleteLastCache(deviceId, measurementId, startTime, endTime);\n \n       Path fullPath = new Path(deviceId, measurementId);\n-      Deletion deletion = new Deletion(fullPath,\n-          getVersionControllerByTimePartitionId(timePartitionId).nextVersion(), timestamp);\n+      Deletion deletion = new Deletion(fullPath, 1, startTime, endTime);", "originalCommit": "4f85ecac71d96cb7f6e3448a6169859b82f5eabd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0MzM2Nw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451343367", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  statement.execute(\"DELETE FROM root.vehicle.d0.s0  WHERE time <= 300\");\n          \n          \n            \n                  statement.execute(\"DELETE FROM root.vehicle.d0.s0 WHERE time <= 300\");", "author": "samperson1997", "createdAt": "2020-07-08T07:38:08Z", "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBDeletionIT.java", "diffHunk": "@@ -164,6 +164,43 @@ public void testDelAfterFlush() throws SQLException {\n     }\n   }\n \n+  @Test\n+  public void testRangeDelete() throws SQLException {\n+    prepareData();\n+    try (Connection connection = DriverManager\n+        .getConnection(Config.IOTDB_URL_PREFIX + \"127.0.0.1:6667/\", \"root\",\n+            \"root\");\n+        Statement statement = connection.createStatement()) {\n+\n+      statement.execute(\"DELETE FROM root.vehicle.d0.s0  WHERE time <= 300\");", "originalCommit": "4f85ecac71d96cb7f6e3448a6169859b82f5eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzMDI2NA==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451430264", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-08T10:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0MzM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM1MDk2NQ==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451350965", "bodyText": "Remove unused import", "author": "samperson1997", "createdAt": "2020-07-08T07:52:01Z", "path": "server/src/main/java/org/apache/iotdb/db/utils/QueryUtils.java", "diffHunk": "@@ -19,6 +19,9 @@\n \n package org.apache.iotdb.db.utils;\n \n+import java.util.Comparator;\n+import java.util.LinkedList;\n+import java.util.stream.Collectors;", "originalCommit": "4f85ecac71d96cb7f6e3448a6169859b82f5eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzMDIxNw==", "url": "https://github.com/apache/iotdb/pull/1400#discussion_r451430217", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-07-08T10:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM1MDk2NQ=="}], "type": "inlineReview"}, {"oid": "256f37de959f961c56a7491d1a5caf33b642944c", "url": "https://github.com/apache/iotdb/commit/256f37de959f961c56a7491d1a5caf33b642944c", "message": "Fix review issues and add tests", "committedDate": "2020-07-08T09:39:43Z", "type": "commit"}, {"oid": "a7eb9d6374d5d7c7d5ed9572d3ff21da77dd071b", "url": "https://github.com/apache/iotdb/commit/a7eb9d6374d5d7c7d5ed9572d3ff21da77dd071b", "message": "Update docs and error message", "committedDate": "2020-07-08T10:04:38Z", "type": "commit"}, {"oid": "8d79894f77b782e552ad672f8ffd5c1009745450", "url": "https://github.com/apache/iotdb/commit/8d79894f77b782e552ad672f8ffd5c1009745450", "message": "update rpc-changelist.md", "committedDate": "2020-07-08T10:05:15Z", "type": "commit"}, {"oid": "75dd93094408bfafb1fba263866e6ca182a8a54d", "url": "https://github.com/apache/iotdb/commit/75dd93094408bfafb1fba263866e6ca182a8a54d", "message": "Add PageReader delete test case", "committedDate": "2020-07-08T10:45:32Z", "type": "commit"}, {"oid": "53d564a79048edd814654a8886465ec35190d286", "url": "https://github.com/apache/iotdb/commit/53d564a79048edd814654a8886465ec35190d286", "message": "Fix test errors", "committedDate": "2020-07-08T10:53:28Z", "type": "commit"}]}