{"pr_number": 1326, "pr_title": "premerge for the distributed version", "pr_createdAt": "2020-06-08T08:45:01Z", "pr_url": "https://github.com/apache/iotdb/pull/1326", "timeline": [{"oid": "78f8d9bfc17c2483da08b59b59708ebe1f2a86c1", "url": "https://github.com/apache/iotdb/commit/78f8d9bfc17c2483da08b59b59708ebe1f2a86c1", "message": "next premerge for the distributed version", "committedDate": "2020-06-08T08:43:57Z", "type": "commit"}, {"oid": "389c3f1a0d506906855b4e3487928dee24e559ed", "url": "https://github.com/apache/iotdb/commit/389c3f1a0d506906855b4e3487928dee24e559ed", "message": "fix by self-review", "committedDate": "2020-06-08T09:10:05Z", "type": "commit"}, {"oid": "297ab12d0dddfcb26cfb9a64b68fecc72d419a56", "url": "https://github.com/apache/iotdb/commit/297ab12d0dddfcb26cfb9a64b68fecc72d419a56", "message": "Merge branch 'master' into cluster_premerge2\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n#\tserver/src/main/java/org/apache/iotdb/db/query/executor/LastQueryExecutor.java", "committedDate": "2020-06-10T09:05:19Z", "type": "commit"}, {"oid": "91d5222ca5f64be9e363c009c00f823d7bcf2515", "url": "https://github.com/apache/iotdb/commit/91d5222ca5f64be9e363c009c00f823d7bcf2515", "message": "Merge branch 'master' into cluster_premerge2", "committedDate": "2020-06-11T02:36:59Z", "type": "commit"}, {"oid": "58d18dca0c62f50296b1fa1939eddc4389f9a0af", "url": "https://github.com/apache/iotdb/commit/58d18dca0c62f50296b1fa1939eddc4389f9a0af", "message": "Merge branch 'master' into cluster_premerge2", "committedDate": "2020-06-12T03:11:40Z", "type": "commit"}, {"oid": "f2b4a97a3670b86563392f9327b5e909025a3a71", "url": "https://github.com/apache/iotdb/commit/f2b4a97a3670b86563392f9327b5e909025a3a71", "message": "Merge branch 'master' into cluster_premerge2\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "committedDate": "2020-06-17T07:51:51Z", "type": "commit"}, {"oid": "7a4efd7c1841cb5e44a0a224b4c8484f999bad37", "url": "https://github.com/apache/iotdb/commit/7a4efd7c1841cb5e44a0a224b4c8484f999bad37", "message": "Merge branch 'master' into cluster_premerge2\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n#\tserver/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "committedDate": "2020-06-18T02:09:11Z", "type": "commit"}, {"oid": "0c8c700943d6a0b15ae504efce9f1ef3a31b59ad", "url": "https://github.com/apache/iotdb/commit/0c8c700943d6a0b15ae504efce9f1ef3a31b59ad", "message": "Merge branch 'master' into cluster_premerge2\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/qp/physical/crud/InsertTabletPlan.java", "committedDate": "2020-06-22T02:34:49Z", "type": "commit"}, {"oid": "304c8938e59206a4563fcb35dd1246ef0c03e6c0", "url": "https://github.com/apache/iotdb/commit/304c8938e59206a4563fcb35dd1246ef0c03e6c0", "message": "Merge branch 'master' into cluster_premerge2\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n#\tserver/src/main/java/org/apache/iotdb/db/qp/physical/crud/InsertTabletPlan.java", "committedDate": "2020-06-28T02:34:36Z", "type": "commit"}, {"oid": "8c1795e2ef1df8f5b3ee02f69346994ada98c726", "url": "https://github.com/apache/iotdb/commit/8c1795e2ef1df8f5b3ee02f69346994ada98c726", "message": "fix vunerability and remove duplication", "committedDate": "2020-06-28T03:43:54Z", "type": "commit"}, {"oid": "c95abfeb73d93b991fa7fa8ff2cf71ec9376577a", "url": "https://github.com/apache/iotdb/commit/c95abfeb73d93b991fa7fa8ff2cf71ec9376577a", "message": "Merge branch 'master' into cluster_premerge2", "committedDate": "2020-06-28T08:59:30Z", "type": "commit"}, {"oid": "37c8f5a227fe77171b92bb3d2e12a292a096c53d", "url": "https://github.com/apache/iotdb/commit/37c8f5a227fe77171b92bb3d2e12a292a096c53d", "message": "add sync thread interruption", "committedDate": "2020-06-29T01:58:20Z", "type": "commit"}, {"oid": "436a52409f76a6fc44001192a2b7703a0efd41b5", "url": "https://github.com/apache/iotdb/commit/436a52409f76a6fc44001192a2b7703a0efd41b5", "message": "Merge branch 'master' into cluster_premerge2\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/engine/StorageEngine.java\n#\tserver/src/main/java/org/apache/iotdb/db/query/executor/QueryRouter.java", "committedDate": "2020-06-29T08:09:51Z", "type": "commit"}, {"oid": "ed8ebef2e6865d82e0dc45ea5b08ded9e4a634c7", "url": "https://github.com/apache/iotdb/commit/ed8ebef2e6865d82e0dc45ea5b08ded9e4a634c7", "message": "Merge branch 'master' into cluster_premerge2", "committedDate": "2020-06-30T02:34:50Z", "type": "commit"}, {"oid": "332d51b5b8dba3596eae3516dda0d279288ed6fd", "url": "https://github.com/apache/iotdb/commit/332d51b5b8dba3596eae3516dda0d279288ed6fd", "message": "fix variable name", "committedDate": "2020-06-30T08:52:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc0MTcyMA==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r446741720", "bodyText": "remove this?", "author": "qiaojialin", "createdAt": "2020-06-29T02:36:29Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/version/VersionController.java", "diffHunk": "@@ -19,6 +19,8 @@\n \n package org.apache.iotdb.db.engine.version;\n \n+import java.io.IOException;\n+", "originalCommit": "37c8f5a227fe77171b92bb3d2e12a292a096c53d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMTA2Mw==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448211063", "bodyText": "removed", "author": "jt2594838", "createdAt": "2020-07-01T08:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc0MTcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NjM0Ng==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448076346", "bodyText": "what does the previous code do?", "author": "qiaojialin", "createdAt": "2020-07-01T02:09:55Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/version/SimpleFileVersionController.java", "diffHunk": "@@ -144,7 +142,9 @@ private void restore() throws IOException {\n     } else {\n       versionFile = SystemFileFactory.INSTANCE.getFile(directory, FILE_PREFIX + \"0\");\n       prevVersion = 0;\n-      new FileOutputStream(versionFile).close();\n+      if (!versionFile.createNewFile()) {\n+        logger.warn(\"Cannot create new version file {}\", versionFile);\n+      }", "originalCommit": "332d51b5b8dba3596eae3516dda0d279288ed6fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMTI1Mg==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448211252", "bodyText": "create an empty file", "author": "jt2594838", "createdAt": "2020-07-01T08:43:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NjM0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NjQ3Nw==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448076477", "bodyText": "remove", "author": "qiaojialin", "createdAt": "2020-07-01T02:10:26Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1133,9 +1138,15 @@ public MNode getDeviceNode(String path) throws MetadataException {\n   }\n \n   /**\n+<<<<<<< HEAD\n+   * To reduce the String number in memory, \n+   * use the deviceId from MManager instead of the deviceId read from disk\n+   * \n+=======", "originalCommit": "332d51b5b8dba3596eae3516dda0d279288ed6fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMzE5NA==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448213194", "bodyText": "removed", "author": "jt2594838", "createdAt": "2020-07-01T08:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NjQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NjUxMg==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448076512", "bodyText": "remove", "author": "qiaojialin", "createdAt": "2020-07-01T02:10:35Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1133,9 +1138,15 @@ public MNode getDeviceNode(String path) throws MetadataException {\n   }\n \n   /**\n+<<<<<<< HEAD\n+   * To reduce the String number in memory, \n+   * use the deviceId from MManager instead of the deviceId read from disk\n+   * \n+=======\n    * To reduce the String number in memory, use the deviceId from MManager instead of the deviceId\n    * read from disk\n    *\n+>>>>>>> master", "originalCommit": "332d51b5b8dba3596eae3516dda0d279288ed6fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NzcwNA==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448077704", "bodyText": "Could we reuse the MeasurementSchema?", "author": "qiaojialin", "createdAt": "2020-07-01T02:15:19Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/schema/TimeseriesSchema.java", "diffHunk": "@@ -0,0 +1,265 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iotdb.tsfile.write.schema;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.io.Serializable;\n+import java.nio.ByteBuffer;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import org.apache.iotdb.tsfile.common.conf.TSFileDescriptor;\n+import org.apache.iotdb.tsfile.encoding.encoder.Encoder;\n+import org.apache.iotdb.tsfile.encoding.encoder.TSEncodingBuilder;\n+import org.apache.iotdb.tsfile.file.metadata.enums.CompressionType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSEncoding;\n+import org.apache.iotdb.tsfile.utils.ReadWriteIOUtils;\n+import org.apache.iotdb.tsfile.utils.StringContainer;\n+\n+/**\n+ * TimeseriesSchema is like MeasurementSchema, but instead of measurementId, it stores the full\n+ * path.\n+ */\n+public class TimeseriesSchema implements Comparable<TimeseriesSchema>, Serializable {", "originalCommit": "332d51b5b8dba3596eae3516dda0d279288ed6fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDAxMQ==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448214011", "bodyText": "No, the judgement is made based on a specific class, and reusing that would make the two usages too confusing.", "author": "jt2594838", "createdAt": "2020-07-01T08:48:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NzcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3ODA0Ng==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448078046", "bodyText": "add some javadoc, give an example of str", "author": "qiaojialin", "createdAt": "2020-07-01T02:16:39Z", "path": "server/src/main/java/org/apache/iotdb/db/utils/SerializeUtils.java", "diffHunk": "@@ -494,4 +494,21 @@ public static ByteBuffer serializeLongs(long[] longs) {\n     }\n     return ret;\n   }\n+\n+  public static Node stringToNode(String str) {", "originalCommit": "332d51b5b8dba3596eae3516dda0d279288ed6fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNTAyMA==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448215020", "bodyText": "added", "author": "jt2594838", "createdAt": "2020-07-01T08:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3ODA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4ODc0Ng==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448188746", "bodyText": "Extract -1 to a constant?", "author": "qiaojialin", "createdAt": "2020-07-01T08:04:36Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/InsertPlan.java", "diffHunk": "@@ -301,9 +296,14 @@ public void serialize(DataOutputStream stream) throws IOException {\n \n   private void putValues(DataOutputStream outputStream) throws QueryProcessException, IOException {\n     for (int i = 0; i < values.length; i++) {\n-      if (types[i] == null) {\n+      // types are not determined, the situation mainly occurs when the plan uses string values\n+      // and is forwarded to other nodes\n+      if (types == null || types[i] == null) {\n+        ReadWriteIOUtils.write((short) -1, outputStream);", "originalCommit": "332d51b5b8dba3596eae3516dda0d279288ed6fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNjAwOA==", "url": "https://github.com/apache/iotdb/pull/1326#discussion_r448216008", "bodyText": "done", "author": "jt2594838", "createdAt": "2020-07-01T08:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4ODc0Ng=="}], "type": "inlineReview"}, {"oid": "f7b7bdcc167b581dfc5668677ae16abf6204dd42", "url": "https://github.com/apache/iotdb/commit/f7b7bdcc167b581dfc5668677ae16abf6204dd42", "message": "fix review", "committedDate": "2020-07-01T08:52:44Z", "type": "commit"}, {"oid": "2de26fe2b76178343613663296f33f506b1e6d30", "url": "https://github.com/apache/iotdb/commit/2de26fe2b76178343613663296f33f506b1e6d30", "message": "Merge branch 'master' into cluster_premerge2\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java\n#\tserver/src/main/java/org/apache/iotdb/db/qp/physical/crud/InsertPlan.java\n#\tserver/src/main/java/org/apache/iotdb/db/qp/physical/crud/InsertTabletPlan.java\n#\tserver/src/test/java/org/apache/iotdb/db/tools/WalCheckerTest.java", "committedDate": "2020-07-01T13:09:24Z", "type": "commit"}, {"oid": "03634d75651e38dcb39fa64cfee1d6b7c926d4af", "url": "https://github.com/apache/iotdb/commit/03634d75651e38dcb39fa64cfee1d6b7c926d4af", "message": "Merge branch 'master' into cluster_premerge2", "committedDate": "2020-07-02T02:24:44Z", "type": "commit"}, {"oid": "55d7fdcf5de68128393c3c930fb9e39314c305d0", "url": "https://github.com/apache/iotdb/commit/55d7fdcf5de68128393c3c930fb9e39314c305d0", "message": "fix dead wait in SyncServerManager and add retry", "committedDate": "2020-07-02T08:40:51Z", "type": "commit"}, {"oid": "6f8e68ddb67214d886f31c6f731a1ad35d837668", "url": "https://github.com/apache/iotdb/commit/6f8e68ddb67214d886f31c6f731a1ad35d837668", "message": "Merge branch 'master' into cluster_premerge2", "committedDate": "2020-07-03T01:53:29Z", "type": "commit"}, {"oid": "beb9c6f94425d8bd01cec6de904e9f61c4335f37", "url": "https://github.com/apache/iotdb/commit/beb9c6f94425d8bd01cec6de904e9f61c4335f37", "message": "fix method name", "committedDate": "2020-07-03T02:06:06Z", "type": "commit"}, {"oid": "ddd67904e0a5f69002ba4bee5be401ddca5fb2ec", "url": "https://github.com/apache/iotdb/commit/ddd67904e0a5f69002ba4bee5be401ddca5fb2ec", "message": "Merge branch 'master' into cluster_premerge2\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/sync/receiver/SyncServerManager.java", "committedDate": "2020-07-06T02:04:45Z", "type": "commit"}]}