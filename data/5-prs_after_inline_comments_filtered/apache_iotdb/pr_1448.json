{"pr_number": 1448, "pr_title": "[IOTDB-716] add lZ4 compress method", "pr_createdAt": "2020-07-01T11:53:51Z", "pr_url": "https://github.com/apache/iotdb/pull/1448", "timeline": [{"oid": "ce841efcec562edcd80c30fbf8361f892be0dbf0", "url": "https://github.com/apache/iotdb/commit/ce841efcec562edcd80c30fbf8361f892be0dbf0", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-05T02:16:06Z", "type": "commit"}, {"oid": "c82abe4d67253a889a4dedbe18bf28bd9b62b921", "url": "https://github.com/apache/iotdb/commit/c82abe4d67253a889a4dedbe18bf28bd9b62b921", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-11T01:32:18Z", "type": "commit"}, {"oid": "202e7fa8b36d8487e6a7b1f9b641786608c2891b", "url": "https://github.com/apache/iotdb/commit/202e7fa8b36d8487e6a7b1f9b641786608c2891b", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-17T01:19:37Z", "type": "commit"}, {"oid": "610082b233713e76f2a8067724cb7dc3de60938e", "url": "https://github.com/apache/iotdb/commit/610082b233713e76f2a8067724cb7dc3de60938e", "message": "add time partition when recovery", "committedDate": "2020-02-17T02:20:25Z", "type": "commit"}, {"oid": "829e6a883704bdbe0e6dcc34a6b3cdca4fd83ce4", "url": "https://github.com/apache/iotdb/commit/829e6a883704bdbe0e6dcc34a6b3cdca4fd83ce4", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-19T11:55:08Z", "type": "commit"}, {"oid": "890566ed46eef36c6b2be09fc9bfa634f6c166bf", "url": "https://github.com/apache/iotdb/commit/890566ed46eef36c6b2be09fc9bfa634f6c166bf", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-26T08:23:14Z", "type": "commit"}, {"oid": "45d9323493116511f1f2aeb5ce0d1707c4dc2ea6", "url": "https://github.com/apache/iotdb/commit/45d9323493116511f1f2aeb5ce0d1707c4dc2ea6", "message": "merge", "committedDate": "2020-03-27T10:45:03Z", "type": "commit"}, {"oid": "2f0465a32097202eda3422ab4bb7b362c6169f5c", "url": "https://github.com/apache/iotdb/commit/2f0465a32097202eda3422ab4bb7b362c6169f5c", "message": "fix deletion bug", "committedDate": "2020-03-27T10:45:59Z", "type": "commit"}, {"oid": "693832e459d59baa365301dbbf6868eb8d7b6ab7", "url": "https://github.com/apache/iotdb/commit/693832e459d59baa365301dbbf6868eb8d7b6ab7", "message": "Revert \"fix deletion bug\"\n\nThis reverts commit 2f0465a32097202eda3422ab4bb7b362c6169f5c.", "committedDate": "2020-03-27T10:47:27Z", "type": "commit"}, {"oid": "275fe1816f1a7fa88f439af7ee3960730abd3a56", "url": "https://github.com/apache/iotdb/commit/275fe1816f1a7fa88f439af7ee3960730abd3a56", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-04-23T02:37:13Z", "type": "commit"}, {"oid": "495eabb3b61dfb5d672c1e46168ecba02c2b42d4", "url": "https://github.com/apache/iotdb/commit/495eabb3b61dfb5d672c1e46168ecba02c2b42d4", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-05-01T02:57:34Z", "type": "commit"}, {"oid": "24b3da2f2a9e14c89bf90f9488afc1cc2eab5ece", "url": "https://github.com/apache/iotdb/commit/24b3da2f2a9e14c89bf90f9488afc1cc2eab5ece", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-05-08T02:49:41Z", "type": "commit"}, {"oid": "77c090e4711f905c8f03118f9a7f25bfc739ce01", "url": "https://github.com/apache/iotdb/commit/77c090e4711f905c8f03118f9a7f25bfc739ce01", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-06-08T04:21:49Z", "type": "commit"}, {"oid": "9204d952fc4ece331c4a902d9361341583513f21", "url": "https://github.com/apache/iotdb/commit/9204d952fc4ece331c4a902d9361341583513f21", "message": "init", "committedDate": "2020-06-08T05:07:21Z", "type": "commit"}, {"oid": "7e67fed1157b0902dbc54ed83f574721dc29c8f3", "url": "https://github.com/apache/iotdb/commit/7e67fed1157b0902dbc54ed83f574721dc29c8f3", "message": "add test", "committedDate": "2020-06-09T18:02:26Z", "type": "commit"}, {"oid": "1784c5a97c40a59aa8bb81f5a8476cfe6a7eaf29", "url": "https://github.com/apache/iotdb/commit/1784c5a97c40a59aa8bb81f5a8476cfe6a7eaf29", "message": "add Test", "committedDate": "2020-06-11T04:29:48Z", "type": "commit"}, {"oid": "73e56b941cd5e96cccf900e0efbce9534726daa5", "url": "https://github.com/apache/iotdb/commit/73e56b941cd5e96cccf900e0efbce9534726daa5", "message": "fix bug", "committedDate": "2020-07-01T11:52:55Z", "type": "commit"}, {"oid": "9eaef644dd434423516e86d1bf592c9112953b57", "url": "https://github.com/apache/iotdb/commit/9eaef644dd434423516e86d1bf592c9112953b57", "message": "add comment", "committedDate": "2020-07-01T11:55:07Z", "type": "commit"}, {"oid": "122a6c97e54a08d6b44f2b11b76cd367b30b4167", "url": "https://github.com/apache/iotdb/commit/122a6c97e54a08d6b44f2b11b76cd367b30b4167", "message": "fix bugs", "committedDate": "2020-07-02T02:08:05Z", "type": "commit"}, {"oid": "20cf2e31843d664e8e1ec43e1dc7bf1e72028488", "url": "https://github.com/apache/iotdb/commit/20cf2e31843d664e8e1ec43e1dc7bf1e72028488", "message": "add license", "committedDate": "2020-07-02T16:00:47Z", "type": "commit"}, {"oid": "ab543a55d1b84fec94dc7927213f22bc7596842d", "url": "https://github.com/apache/iotdb/commit/ab543a55d1b84fec94dc7927213f22bc7596842d", "message": "fix bugs", "committedDate": "2020-07-05T13:13:46Z", "type": "commit"}, {"oid": "bed2a9314a4676f94be81734050ee08afa7bcb26", "url": "https://github.com/apache/iotdb/commit/bed2a9314a4676f94be81734050ee08afa7bcb26", "message": "solve conflict", "committedDate": "2020-07-09T06:24:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2NTc0Mw==", "url": "https://github.com/apache/iotdb/pull/1448#discussion_r453665743", "bodyText": "To be consistent with LZ4UnCompressor and simplified, rename this to LZ4Compressor?", "author": "qiaojialin", "createdAt": "2020-07-13T13:52:49Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/compress/ICompressor.java", "diffHunk": "@@ -52,6 +52,8 @@ static ICompressor getCompressor(CompressionType name) {\n         return new NoCompressor();\n       case SNAPPY:\n         return new SnappyCompressor();\n+      case LZ4:\n+        return new IOTDBLZ4Compressor();", "originalCommit": "bed2a9314a4676f94be81734050ee08afa7bcb26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2ODk4OQ==", "url": "https://github.com/apache/iotdb/pull/1448#discussion_r453668989", "bodyText": "The package I import is called LZ4Compressor, so I can't use this name", "author": "SilverNarcissus", "createdAt": "2020-07-13T13:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2NTc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2NjUzOA==", "url": "https://github.com/apache/iotdb/pull/1448#discussion_r453666538", "bodyText": "I think it's better to throw this exception and let the upper level handle it.", "author": "qiaojialin", "createdAt": "2020-07-13T13:53:58Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/compress/IUnCompressor.java", "diffHunk": "@@ -184,4 +186,82 @@ public CompressionType getCodecName() {\n       return CompressionType.SNAPPY;\n     }\n   }\n+\n+\n+  class LZ4UnCompressor implements IUnCompressor {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(LZ4Compressor.class);\n+    private static final int MAX_COMPRESS_RATIO = 255;\n+    private LZ4SafeDecompressor decompressor;\n+\n+\n+    public LZ4UnCompressor() {\n+      LZ4Factory factory = LZ4Factory.fastestInstance();\n+      decompressor = factory.safeDecompressor();\n+    }\n+\n+    @Override\n+    public int getUncompressedLength(byte[] array, int offset, int length) throws IOException {\n+      throw new UnsupportedOperationException(\"unsupported get uncompress length\");\n+    }\n+\n+    @Override\n+    public int getUncompressedLength(ByteBuffer buffer) throws IOException {\n+      throw new UnsupportedOperationException(\"unsupported get uncompress length\");\n+    }\n+\n+    /**\n+     * We don't recommend using this method because we have to allocate MAX_COMPRESS_RATIO *\n+     * compressedSize to ensure uncompress safety, you can use other method if you know the\n+     * uncompressed size\n+     */\n+    @Override\n+    public byte[] uncompress(byte[] bytes) {\n+      if (bytes == null) {\n+        return new byte[0];\n+      }\n+\n+      try {\n+        return decompressor.decompress(bytes, MAX_COMPRESS_RATIO * bytes.length);\n+      } catch (RuntimeException e) {\n+        logger.error(", "originalCommit": "bed2a9314a4676f94be81734050ee08afa7bcb26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2OTA2NQ==", "url": "https://github.com/apache/iotdb/pull/1448#discussion_r453669065", "bodyText": "Sure~", "author": "SilverNarcissus", "createdAt": "2020-07-13T13:57:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2NjUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2Njg0Mg==", "url": "https://github.com/apache/iotdb/pull/1448#discussion_r453666842", "bodyText": "throw IOException", "author": "qiaojialin", "createdAt": "2020-07-13T13:54:23Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/compress/IUnCompressor.java", "diffHunk": "@@ -184,4 +186,82 @@ public CompressionType getCodecName() {\n       return CompressionType.SNAPPY;\n     }\n   }\n+\n+\n+  class LZ4UnCompressor implements IUnCompressor {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(LZ4Compressor.class);\n+    private static final int MAX_COMPRESS_RATIO = 255;\n+    private LZ4SafeDecompressor decompressor;\n+\n+\n+    public LZ4UnCompressor() {\n+      LZ4Factory factory = LZ4Factory.fastestInstance();\n+      decompressor = factory.safeDecompressor();\n+    }\n+\n+    @Override\n+    public int getUncompressedLength(byte[] array, int offset, int length) throws IOException {\n+      throw new UnsupportedOperationException(\"unsupported get uncompress length\");\n+    }\n+\n+    @Override\n+    public int getUncompressedLength(ByteBuffer buffer) throws IOException {\n+      throw new UnsupportedOperationException(\"unsupported get uncompress length\");\n+    }\n+\n+    /**\n+     * We don't recommend using this method because we have to allocate MAX_COMPRESS_RATIO *\n+     * compressedSize to ensure uncompress safety, you can use other method if you know the\n+     * uncompressed size\n+     */\n+    @Override\n+    public byte[] uncompress(byte[] bytes) {\n+      if (bytes == null) {\n+        return new byte[0];\n+      }\n+\n+      try {\n+        return decompressor.decompress(bytes, MAX_COMPRESS_RATIO * bytes.length);\n+      } catch (RuntimeException e) {\n+        logger.error(\n+            \"tsfile-compression LZ4UnCompressor: errors occurs when uncompress input byte\", e);\n+      }\n+      return new byte[0];\n+    }\n+\n+    @Override\n+    public int uncompress(byte[] byteArray, int offset, int length, byte[] output, int outOffset)\n+        throws IOException {\n+      try {\n+        return decompressor.decompress(byteArray, offset, length, output, offset);\n+      }\n+      catch (RuntimeException e){\n+        logger.error(\n+            \"tsfile-compression LZ4UnCompressor: errors occurs when uncompress input byte\", e);\n+        throw new IOException(e);\n+      }\n+    }\n+\n+    @Override\n+    public int uncompress(ByteBuffer compressed, ByteBuffer uncompressed) {\n+      if (compressed == null || !compressed.hasRemaining()) {\n+        return 0;\n+      }\n+\n+      try {\n+        decompressor.decompress(compressed, uncompressed);\n+        return compressed.limit();\n+      } catch (RuntimeException e) {\n+        logger.error(", "originalCommit": "bed2a9314a4676f94be81734050ee08afa7bcb26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2OTE3Ng==", "url": "https://github.com/apache/iotdb/pull/1448#discussion_r453669176", "bodyText": "Sure~", "author": "SilverNarcissus", "createdAt": "2020-07-13T13:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2Njg0Mg=="}], "type": "inlineReview"}, {"oid": "8a241aca1d31b7a48f917cba2b3c8c90da60680b", "url": "https://github.com/apache/iotdb/commit/8a241aca1d31b7a48f917cba2b3c8c90da60680b", "message": "fix bug", "committedDate": "2020-07-13T14:01:44Z", "type": "commit"}]}