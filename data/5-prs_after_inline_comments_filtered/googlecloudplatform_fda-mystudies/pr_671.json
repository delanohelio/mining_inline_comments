{"pr_number": 671, "pr_title": "Participant Manager Service: GET  /sites/{siteId}/participants endpoint implementation", "pr_createdAt": "2020-07-24T11:18:19Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671", "timeline": [{"oid": "217ca87856bc49dc681b0363be285a0cc3382393", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/217ca87856bc49dc681b0363be285a0cc3382393", "message": "GET /sites/{siteId}/participants endpoint implementation with integration tests\n\nGET /sites/{siteId}/participants endpoint implementation with integration tests", "committedDate": "2020-07-24T10:54:31Z", "type": "commit"}, {"oid": "92a317197ac4eb4aa694785851f7fbd0f339aea2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/92a317197ac4eb4aa694785851f7fbd0f339aea2", "message": "Merge branch 'participant-manager-site-addNewParticipant-endpoint' into participant-manager-site-getParticipant-endpoint", "committedDate": "2020-07-24T11:13:50Z", "type": "commit"}, {"oid": "2db80dd745d93c63b55450d9f7549d1a9a56fc16", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2db80dd745d93c63b55450d9f7549d1a9a56fc16", "message": "added ParticipantDetail\n\nadded ParticipantDetail", "committedDate": "2020-07-24T11:14:30Z", "type": "commit"}, {"oid": "46ccd2da051cd47b55d8939f60c5d1553acebd9e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/46ccd2da051cd47b55d8939f60c5d1553acebd9e", "message": "changed ParticipantDetails to ParticipantDetail\n\nchanged ParticipantDetails to ParticipantDetail", "committedDate": "2020-07-24T13:04:37Z", "type": "commit"}, {"oid": "943b6346cca4e7ef6d6454e630184b71d814c83f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/943b6346cca4e7ef6d6454e630184b71d814c83f", "message": "added validations\n\nadded validations", "committedDate": "2020-07-28T09:38:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc2OTk1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r461769956", "bodyText": "Shouldn't the message be Not Found instead of Bad Request for this one?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              SITE_NOT_FOUND(404, \"EC-94\", Constants.BAD_REQUEST, \"Site not found\"),\n          \n          \n            \n              SITE_NOT_FOUND(404, \"EC-94\", HttpStatus.NOT_FOUND.toString(), \"Site not found\"),\n          \n      \n    \n    \n  \n\nAlso any particular reason why sometimes we are using the String from HttpStatus and sometimes from Constants?", "author": "saminguyen", "createdAt": "2020-07-28T18:00:05Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ErrorCode.java", "diffHunk": "@@ -120,6 +120,11 @@\n   SITE_NOT_EXIST_OR_INACTIVE(\n       400, \"EC-869\", Constants.BAD_REQUEST, \"Site doesn't exists or is inactive\"),\n \n+  SITE_NOT_FOUND(404, \"EC-94\", Constants.BAD_REQUEST, \"Site not found\"),", "originalCommit": "943b6346cca4e7ef6d6454e630184b71d814c83f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE1NzczMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462157731", "bodyText": "changed to HttpStatus.NOT_FOUND.toString(), before we are using Constants later we come to know that we can make use of HttpStatus so we started using String from HttpStatus", "author": "navya-BTC", "createdAt": "2020-07-29T09:16:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc2OTk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3Nzk4NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r461777985", "bodyText": "I would avoid using hard coded value like this for readability. Do we have enum for all the OnboardingStatus", "author": "saminguyen", "createdAt": "2020-07-28T18:14:18Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -239,4 +250,91 @@ private ErrorCode validationForAddNewParticipant(\n     }\n     return null;\n   }\n+\n+  @Override\n+  public ParticipantRegistryResponse getParticipants(\n+      String userId, String siteId, String onboardingStatus) {\n+    logger.info(\"getParticipants()\");\n+    Optional<SiteEntity> optSite = siteRepository.findById(siteId);\n+\n+    if (!optSite.isPresent()) {\n+      logger.exit(ErrorCode.SITE_NOT_FOUND);\n+      return new ParticipantRegistryResponse(ErrorCode.SITE_NOT_FOUND);\n+    }\n+\n+    Optional<SitePermissionEntity> optSitePermission =\n+        sitePermissionRepository.findByUserIdAndSiteId(userId, siteId);\n+\n+    if (!optSitePermission.isPresent()\n+        || Permission.NO_PERMISSION == Permission.fromValue(optSitePermission.get().getCanEdit())) {\n+      logger.exit(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED);\n+      return new ParticipantRegistryResponse(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED);\n+    }\n+\n+    ParticipantRegistryDetail participantRegistry =\n+        ParticipantMapper.fromSite(optSite.get(), optSitePermission.get(), siteId);\n+    Map<String, Long> statusWithCountMap = getOnboardingStatusWithCount(siteId);\n+    participantRegistry.setCountByStatus(statusWithCountMap);\n+\n+    List<ParticipantRegistrySiteEntity> registryParticipants = null;\n+    if (StringUtils.isEmpty(onboardingStatus)) {\n+      registryParticipants = participantRegistrySiteRepository.findBySiteId(siteId);\n+    } else {\n+      registryParticipants =\n+          participantRegistrySiteRepository.findBySiteIdAndStatus(siteId, onboardingStatus);\n+    }\n+\n+    addRegistryParticipants(participantRegistry, registryParticipants);\n+\n+    ParticipantRegistryResponse participantRegistryResponse =\n+        new ParticipantRegistryResponse(\n+            MessageCode.GET_PARTICIPANT_REGISTRY_SUCCESS, participantRegistry);\n+\n+    logger.exit(String.format(\"message=%s\", participantRegistryResponse.getMessage()));\n+    return participantRegistryResponse;\n+  }\n+\n+  private Map<String, Long> getOnboardingStatusWithCount(String siteId) {\n+    List<ParticipantRegistrySiteCount> statusCount =\n+        (List<ParticipantRegistrySiteCount>)\n+            CollectionUtils.emptyIfNull(\n+                participantRegistrySiteRepository.findStatusCountBySiteId(siteId));\n+\n+    Map<String, Long> statusWithCountMap = new HashMap<>();\n+    for (OnboardingStatus onboardingStatus : OnboardingStatus.values()) {\n+      statusWithCountMap.put(onboardingStatus.getCode(), (long) 0);\n+    }\n+\n+    long total = 0;\n+    for (ParticipantRegistrySiteCount count : statusCount) {\n+      total += count.getCount();\n+      statusWithCountMap.put(count.getOnboardingStatus(), count.getCount());\n+    }\n+\n+    statusWithCountMap.put(\"A\", total);", "originalCommit": "943b6346cca4e7ef6d6454e630184b71d814c83f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE1ODAwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462158009", "bodyText": "used OnboardingStatus enum", "author": "navya-BTC", "createdAt": "2020-07-29T09:16:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3Nzk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NDgyMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r461884820", "bodyText": "move the error code handling out of the Service layer. If not done here make sure to keep track of it (maybe with a TODO comment)", "author": "saminguyen", "createdAt": "2020-07-28T21:16:58Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -239,4 +250,91 @@ private ErrorCode validationForAddNewParticipant(\n     }\n     return null;\n   }\n+\n+  @Override\n+  public ParticipantRegistryResponse getParticipants(\n+      String userId, String siteId, String onboardingStatus) {\n+    logger.info(\"getParticipants()\");\n+    Optional<SiteEntity> optSite = siteRepository.findById(siteId);\n+\n+    if (!optSite.isPresent()) {\n+      logger.exit(ErrorCode.SITE_NOT_FOUND);\n+      return new ParticipantRegistryResponse(ErrorCode.SITE_NOT_FOUND);", "originalCommit": "943b6346cca4e7ef6d6454e630184b71d814c83f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE0OTc1OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462149759", "bodyText": "#702 issue created to address this comment", "author": "navya-BTC", "createdAt": "2020-07-29T09:02:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NDgyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxMjQ4Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462612486", "bodyText": "Gotcha", "author": "saminguyen", "createdAt": "2020-07-29T21:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NDgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1MDM0OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462050348", "bodyText": "You should probably name this participantRegistryDetail, line 287 looks incredibly confusing", "author": "saminguyen", "createdAt": "2020-07-29T05:40:02Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -239,4 +250,91 @@ private ErrorCode validationForAddNewParticipant(\n     }\n     return null;\n   }\n+\n+  @Override\n+  public ParticipantRegistryResponse getParticipants(\n+      String userId, String siteId, String onboardingStatus) {\n+    logger.info(\"getParticipants()\");\n+    Optional<SiteEntity> optSite = siteRepository.findById(siteId);\n+\n+    if (!optSite.isPresent()) {\n+      logger.exit(ErrorCode.SITE_NOT_FOUND);\n+      return new ParticipantRegistryResponse(ErrorCode.SITE_NOT_FOUND);\n+    }\n+\n+    Optional<SitePermissionEntity> optSitePermission =\n+        sitePermissionRepository.findByUserIdAndSiteId(userId, siteId);\n+\n+    if (!optSitePermission.isPresent()\n+        || Permission.NO_PERMISSION == Permission.fromValue(optSitePermission.get().getCanEdit())) {\n+      logger.exit(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED);\n+      return new ParticipantRegistryResponse(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED);\n+    }\n+\n+    ParticipantRegistryDetail participantRegistry =", "originalCommit": "943b6346cca4e7ef6d6454e630184b71d814c83f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE1ODQwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462158405", "bodyText": "changed variables name", "author": "navya-BTC", "createdAt": "2020-07-29T09:17:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1MDM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1MDU5MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462050591", "bodyText": "needs better naming for these vars", "author": "saminguyen", "createdAt": "2020-07-29T05:40:51Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -239,4 +250,91 @@ private ErrorCode validationForAddNewParticipant(\n     }\n     return null;\n   }\n+\n+  @Override\n+  public ParticipantRegistryResponse getParticipants(\n+      String userId, String siteId, String onboardingStatus) {\n+    logger.info(\"getParticipants()\");\n+    Optional<SiteEntity> optSite = siteRepository.findById(siteId);\n+\n+    if (!optSite.isPresent()) {\n+      logger.exit(ErrorCode.SITE_NOT_FOUND);\n+      return new ParticipantRegistryResponse(ErrorCode.SITE_NOT_FOUND);\n+    }\n+\n+    Optional<SitePermissionEntity> optSitePermission =\n+        sitePermissionRepository.findByUserIdAndSiteId(userId, siteId);\n+\n+    if (!optSitePermission.isPresent()\n+        || Permission.NO_PERMISSION == Permission.fromValue(optSitePermission.get().getCanEdit())) {\n+      logger.exit(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED);\n+      return new ParticipantRegistryResponse(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED);\n+    }\n+\n+    ParticipantRegistryDetail participantRegistry =\n+        ParticipantMapper.fromSite(optSite.get(), optSitePermission.get(), siteId);\n+    Map<String, Long> statusWithCountMap = getOnboardingStatusWithCount(siteId);\n+    participantRegistry.setCountByStatus(statusWithCountMap);\n+\n+    List<ParticipantRegistrySiteEntity> registryParticipants = null;\n+    if (StringUtils.isEmpty(onboardingStatus)) {\n+      registryParticipants = participantRegistrySiteRepository.findBySiteId(siteId);\n+    } else {\n+      registryParticipants =\n+          participantRegistrySiteRepository.findBySiteIdAndStatus(siteId, onboardingStatus);\n+    }\n+\n+    addRegistryParticipants(participantRegistry, registryParticipants);\n+\n+    ParticipantRegistryResponse participantRegistryResponse =\n+        new ParticipantRegistryResponse(\n+            MessageCode.GET_PARTICIPANT_REGISTRY_SUCCESS, participantRegistry);\n+\n+    logger.exit(String.format(\"message=%s\", participantRegistryResponse.getMessage()));\n+    return participantRegistryResponse;\n+  }\n+\n+  private Map<String, Long> getOnboardingStatusWithCount(String siteId) {\n+    List<ParticipantRegistrySiteCount> statusCount =\n+        (List<ParticipantRegistrySiteCount>)\n+            CollectionUtils.emptyIfNull(\n+                participantRegistrySiteRepository.findStatusCountBySiteId(siteId));\n+\n+    Map<String, Long> statusWithCountMap = new HashMap<>();\n+    for (OnboardingStatus onboardingStatus : OnboardingStatus.values()) {\n+      statusWithCountMap.put(onboardingStatus.getCode(), (long) 0);\n+    }\n+\n+    long total = 0;\n+    for (ParticipantRegistrySiteCount count : statusCount) {\n+      total += count.getCount();\n+      statusWithCountMap.put(count.getOnboardingStatus(), count.getCount());\n+    }\n+\n+    statusWithCountMap.put(\"A\", total);\n+    return statusWithCountMap;\n+  }\n+\n+  private void addRegistryParticipants(\n+      ParticipantRegistryDetail participantRegistry,\n+      List<ParticipantRegistrySiteEntity> registryParticipants) {", "originalCommit": "943b6346cca4e7ef6d6454e630184b71d814c83f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE1ODY2MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462158660", "bodyText": "changed naming for these vars", "author": "navya-BTC", "createdAt": "2020-07-29T09:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1MDU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1MTcxOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462051718", "bodyText": "handle this in service?", "author": "saminguyen", "createdAt": "2020-07-29T05:44:40Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/SiteController.java", "diffHunk": "@@ -68,12 +75,32 @@\n   public ResponseEntity<ParticipantResponse> addNewParticipant(\n       @PathVariable String siteId,\n       @RequestHeader(name = USER_ID_HEADER) String userId,\n-      @RequestBody ParticipantDetail participant,\n+      @Valid @RequestBody ParticipantDetailRequest participant,\n       HttpServletRequest request) {\n     logger.entry(BEGIN_REQUEST_LOG, request.getRequestURI());\n     participant.setSiteId(siteId);\n     ParticipantResponse participantResponse = siteService.addNewParticipant(participant, userId);\n     logger.exit(String.format(STATUS_LOG, participantResponse.getHttpStatusCode()));\n     return ResponseEntity.status(participantResponse.getHttpStatusCode()).body(participantResponse);\n   }\n+\n+  @GetMapping(value = \"/sites/{siteId}/participants\", produces = MediaType.APPLICATION_JSON_VALUE)\n+  public ResponseEntity<ParticipantRegistryResponse> getSiteParticipant(\n+      @PathVariable String siteId,\n+      @RequestHeader(name = USER_ID_HEADER) String userId,\n+      @RequestParam(name = \"onboardingStatus\", required = false) String onboardingStatus,\n+      HttpServletRequest request) {\n+    logger.entry(BEGIN_REQUEST_LOG, request.getRequestURI());\n+\n+    if (StringUtils.isNotEmpty(onboardingStatus)\n+        && OnboardingStatus.fromCode(onboardingStatus) == null) {\n+      return ResponseEntity.status(HttpStatus.BAD_REQUEST)\n+          .body(new ParticipantRegistryResponse(ErrorCode.INVALID_ONBOARDING_STATUS));\n+    }", "originalCommit": "943b6346cca4e7ef6d6454e630184b71d814c83f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE1MzI0Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462153242", "bodyText": "onboardingStatus is an optional field, hence we are checking correctness of the value before calling service method, I think its okay to have it in controller layer", "author": "navya-BTC", "createdAt": "2020-07-29T09:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1MTcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1Mjc3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462052775", "bodyText": "Shouldn't we check for the registryParticipants list returned here, too?", "author": "saminguyen", "createdAt": "2020-07-29T05:48:11Z", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SitesControllerTest.java", "diffHunk": "@@ -328,6 +332,96 @@ public void shouldAddNewParticipant() throws Exception {\n     assertEquals(participantRequest.getEmail(), optParticipantRegistrySite.get().getEmail());\n   }\n \n+  @Test\n+  public void shouldReturnSiteNotFoundError() throws Exception {\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_SITE_PARTICIPANTS.getPath(), IdGenerator.id())\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isNotFound())\n+        .andExpect(jsonPath(\"$.error_description\", is(SITE_NOT_FOUND.getDescription())));\n+  }\n+\n+  @Test\n+  public void shouldReturnSitePermissionAccessDeniedError() throws Exception {\n+    // Site 1: set manage site permission to no permission\n+    sitePermissionEntity = siteEntity.getSitePermissions().get(0);\n+    sitePermissionEntity.setCanEdit(Permission.NO_PERMISSION.value());\n+    testDataHelper.getSiteRepository().saveAndFlush(siteEntity);\n+\n+    // Step 2: Call API and expect MANAGE_SITE_PERMISSION_ACCESS_DENIED error\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_SITE_PARTICIPANTS.getPath(), siteEntity.getId())\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isForbidden())\n+        .andExpect(\n+            jsonPath(\n+                \"$.error_description\", is(MANAGE_SITE_PERMISSION_ACCESS_DENIED.getDescription())));\n+  }\n+\n+  @Test\n+  public void shouldReturnInvalidOnboardingStatusError() throws Exception {\n+    // Step 1: set study entity\n+    siteEntity.setStudy(studyEntity);\n+    testDataHelper.getSiteRepository().saveAndFlush(siteEntity);\n+    testDataHelper\n+        .getParticipantRegistrySiteRepository()\n+        .saveAndFlush(participantRegistrySiteEntity);\n+\n+    // Step 2: Call API and expect INVALID_ONBOARDING_STATUS error\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_SITE_PARTICIPANTS.getPath(), siteEntity.getId())\n+                .headers(headers)\n+                .param(\"onboardingStatus\", \"NEW\")\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isBadRequest())\n+        .andExpect(jsonPath(\"$.error_description\", is(INVALID_ONBOARDING_STATUS.getDescription())));\n+  }\n+\n+  @Test\n+  public void shouldReturnSiteParticipantsRegistry() throws Exception {\n+    // Step 1: set onboarding status to 'N'\n+    siteEntity.setStudy(studyEntity);\n+    testDataHelper.getSiteRepository().saveAndFlush(siteEntity);\n+    participantRegistrySiteEntity.setOnboardingStatus(OnboardingStatus.NEW.getCode());\n+    testDataHelper\n+        .getParticipantRegistrySiteRepository()\n+        .saveAndFlush(participantRegistrySiteEntity);\n+\n+    // Step 2: Call API and expect  GET_PARTICIPANT_REGISTRY_SUCCESS\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_SITE_PARTICIPANTS.getPath(), siteEntity.getId())\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.participantRegistryDetail\", notNullValue()))\n+        .andExpect(jsonPath(\"$.participantRegistryDetail.studyId\", is(studyEntity.getId())))\n+        .andExpect(jsonPath(\"$.participantRegistryDetail.siteStatus\", is(siteEntity.getStatus())))", "originalCommit": "943b6346cca4e7ef6d6454e630184b71d814c83f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE1OTIwMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462159202", "bodyText": "Added assertion for registryParticipants list", "author": "navya-BTC", "createdAt": "2020-07-29T09:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1Mjc3NQ=="}], "type": "inlineReview"}, {"oid": "00ba48fc237678cffcf57f01e2db12ddbd0a6eb5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/00ba48fc237678cffcf57f01e2db12ddbd0a6eb5", "message": "Fixed PR comments\n\nFixed PR comments", "committedDate": "2020-07-29T09:12:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxNjM2NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462616364", "bodyText": "fromAppInfo -> setParticipantRegistryAppInfo (?)", "author": "saminguyen", "createdAt": "2020-07-29T22:03:51Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java", "diffHunk": "@@ -67,4 +74,70 @@ public static ParticipantRegistrySiteEntity fromParticipantRequest(\n     participantRegistrySite.setStudy(site.getStudy());\n     return participantRegistrySite;\n   }\n+\n+  public static ParticipantRegistryDetail fromSite(\n+      SiteEntity site, SitePermissionEntity sitePermission, String siteId) {\n+    ParticipantRegistryDetail participants = new ParticipantRegistryDetail();\n+    participants.setSiteStatus(site.getStatus());\n+    participants.setSiteId(siteId);\n+    if (site.getStudy() != null) {\n+      StudyEntity study = site.getStudy();\n+      participants.setStudyId(study.getId());\n+      participants.setStudyName(study.getName());\n+      participants.setCustomStudyId(study.getCustomId());\n+      participants.setSitePermission(sitePermission.getCanEdit());\n+      fromAppInfo(participants, study);\n+      fromLocation(site, participants);\n+    }\n+    return participants;\n+  }\n+\n+  private static void fromAppInfo(ParticipantRegistryDetail participants, StudyEntity study) {", "originalCommit": "00ba48fc237678cffcf57f01e2db12ddbd0a6eb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5Njk4Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462896986", "bodyText": "changed to setParticipantRegistryAppInfo", "author": "navya-BTC", "createdAt": "2020-07-30T10:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxNjM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxNjQzMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462616432", "bodyText": "same as above", "author": "saminguyen", "createdAt": "2020-07-29T22:04:02Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java", "diffHunk": "@@ -67,4 +74,70 @@ public static ParticipantRegistrySiteEntity fromParticipantRequest(\n     participantRegistrySite.setStudy(site.getStudy());\n     return participantRegistrySite;\n   }\n+\n+  public static ParticipantRegistryDetail fromSite(\n+      SiteEntity site, SitePermissionEntity sitePermission, String siteId) {\n+    ParticipantRegistryDetail participants = new ParticipantRegistryDetail();\n+    participants.setSiteStatus(site.getStatus());\n+    participants.setSiteId(siteId);\n+    if (site.getStudy() != null) {\n+      StudyEntity study = site.getStudy();\n+      participants.setStudyId(study.getId());\n+      participants.setStudyName(study.getName());\n+      participants.setCustomStudyId(study.getCustomId());\n+      participants.setSitePermission(sitePermission.getCanEdit());\n+      fromAppInfo(participants, study);\n+      fromLocation(site, participants);\n+    }\n+    return participants;\n+  }\n+\n+  private static void fromAppInfo(ParticipantRegistryDetail participants, StudyEntity study) {\n+    if (study.getAppInfo() != null) {\n+      participants.setAppName(study.getAppInfo().getAppName());\n+      participants.setCustomAppId(study.getAppInfo().getAppId());\n+      participants.setAppId(study.getAppInfo().getAppId());\n+    }\n+  }\n+\n+  private static void fromLocation(SiteEntity site, ParticipantRegistryDetail participants) {", "originalCommit": "00ba48fc237678cffcf57f01e2db12ddbd0a6eb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjczMDQzMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/671#discussion_r462730432", "bodyText": "changed to setParticipantRegistryLocation", "author": "navya-BTC", "createdAt": "2020-07-30T04:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxNjQzMg=="}], "type": "inlineReview"}, {"oid": "8cb87d38f29146337cdc345e72b2258f6e5bfade", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8cb87d38f29146337cdc345e72b2258f6e5bfade", "message": "Fixed PR Comments\n\nFixed PR Comments", "committedDate": "2020-07-30T04:39:10Z", "type": "commit"}, {"oid": "817b861cfc1ffeaa5cd8d5b806196478213ceb72", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/817b861cfc1ffeaa5cd8d5b806196478213ceb72", "message": "Merge branch 'participant-manager-apps-with-optional-studies-and-sites' into participant-manager-site-getParticipant-endpoint", "committedDate": "2020-07-30T04:42:34Z", "type": "commit"}, {"oid": "c1c023fbe3afd1263336f8460481f83651254e1c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c1c023fbe3afd1263336f8460481f83651254e1c", "message": "Merge branch 'develop' into participant-manager-site-getParticipant-endpoint", "committedDate": "2020-08-13T15:41:12Z", "type": "commit"}, {"oid": "24559d1c94b039bb2c941fc9f722bab3647e0baf", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/24559d1c94b039bb2c941fc9f722bab3647e0baf", "message": "Resolved Conflicts\n\nResolved Conflicts", "committedDate": "2020-08-13T15:50:10Z", "type": "commit"}]}