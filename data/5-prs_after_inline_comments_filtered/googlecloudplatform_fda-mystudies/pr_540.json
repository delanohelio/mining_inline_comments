{"pr_number": 540, "pr_title": "Audit Log Service - /v1/events endpoint implementation", "pr_createdAt": "2020-06-22T14:07:15Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540", "timeline": [{"oid": "4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "message": "/v1/events endpoint implmentation\n\nMoved filters and health controller to common-service, added actuator, added JSoup to extract error message from Html etc", "committedDate": "2020-06-20T08:42:26Z", "type": "commit"}, {"oid": "8fe92752ca19de8e1618a8d36084f9ad3399d42d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8fe92752ca19de8e1618a8d36084f9ad3399d42d", "message": "Refactored AuditLogEventValidator\n\nconvert xpath to json path", "committedDate": "2020-06-20T10:21:58Z", "type": "commit"}, {"oid": "e3b4ade2159f7996752d05425678a83bb3ba08ce", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e3b4ade2159f7996752d05425678a83bb3ba08ce", "message": "minor refactoring and removed unused method\n\nminor refactoring and removed unused getEncodedAuthorization() from BaseServiceImpl", "committedDate": "2020-06-20T11:29:02Z", "type": "commit"}, {"oid": "6bfb2a698ca4238090bc11dedb84f13a4f16d186", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6bfb2a698ca4238090bc11dedb84f13a4f16d186", "message": "Added postman collection & BaseTokenIntrospectionFilter\n\nAdded getUriTemplateAndHttpMethodsMap() abstract method to BaseTokenIntrospectionFilter", "committedDate": "2020-06-20T13:01:28Z", "type": "commit"}, {"oid": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "message": "Removed unused method\n\nRemoved unused method: getEventInfo() from AuditLogEventEntity", "committedDate": "2020-06-20T13:35:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwNjA2NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443606065", "bodyText": "probably not a good idea to expose request body to the logs, just in case any PII or PHI is ever included in the audit logs.", "author": "zohrehj", "createdAt": "2020-06-22T14:36:33Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/controller/AuditLogEventController.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.auditlog.controller;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.bind.annotation.RequestBody;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.service.AuditLogEventService;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.validator.AuditLogEventValidator;\n+import com.google.cloud.healthcare.fdamystudies.common.JsonUtils;\n+\n+@RestController\n+@RequestMapping(\"/v1\")\n+public class AuditLogEventController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(AuditLogEventController.class.getName());\n+\n+  private static final String ERROR_DESCRIPTION = \"error_description\";\n+\n+  @Autowired private AuditLogEventService aleService;\n+\n+  @Autowired private AuditLogEventValidator validator;\n+\n+  @PostMapping(\n+      value = \"/events\",\n+      produces = {MediaType.APPLICATION_JSON_VALUE},\n+      consumes = {MediaType.APPLICATION_JSON_VALUE})\n+  public ResponseEntity<JsonNode> logEvent(\n+      @RequestBody JsonNode requestBody, HttpServletRequest request) {\n+    logger.entry(\n+        String.format(\n+            \"begin %s request with requestBody= %s\", request.getRequestURI(), requestBody));", "originalCommit": "4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxOTczMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443719732", "bodyText": "We learnt about XLogger from Nik's comments. This special logger is useful to diagnose issues in the application without the need for a debugging session. It helps developers to analyze the issue in a non-production (DEV/QA/UAT) environment. Logger.entry() and Logger.exit() statements are logged if the log level is TRACE. We should avoid TRACE log level in production.\nWe'll be adding XLogger entry/exit/catching statements to all the services for above mentioned benefits. This is also one of the areas of improvements feedback that was shared with us last week.\nAreas Of Improvements Feedback: Google will ask that proper error logs are implemented", "author": "dhanyak-btc", "createdAt": "2020-06-22T17:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwNjA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc4NzMxMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443787311", "bodyText": "\"Proper error logs\" also involves only logging when it provides value, so the Google team isn't asking for logging everywhere.\nBut Zohreh's point about PHI is separate from that. I don't know enough about slf4j logging, but we want to avoid a situation where PHI is logged in any way. If you can assure us that TRACE logs are never written in production then we could probably OK this.", "author": "nikklassen", "createdAt": "2020-06-22T19:48:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwNjA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk2MzA3Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443963076", "bodyText": "The WARN level is the level that should be active in production systems by default. Reference: Use Logging Levels Consistently\nIn application-mockit-common.properties (common-tests module), please change the log level to WARN and run the mvn clean test to verify XLogger entry and exit log statements are not logged.\nlogging.level.com.google.cloud.healthcare.fdamystudies=WARN\nPlease advise whether we need to add XLogger entry/exit/catching statements. I personally liked the use of XLogger as it helps to diagnose the issues in non-production environments but I will go with your suggestions. Kindly share samples for proper error logging so that team will follow the same suggestions for consistent logging across all services.", "author": "dhanyak-btc", "createdAt": "2020-06-23T05:04:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwNjA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM4MjcyNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444382725", "bodyText": "making XLogger makes sense, but please never add PHI or PII within logs. considering the repercussions of accidentally exposing this information to our logs in a health care setting, we do not want to take any risks when it comes to user information.", "author": "zohrehj", "createdAt": "2020-06-23T17:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwNjA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk2NTIwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444965209", "bodyText": "I've added @ToString.Exclude annotation to fields that contain PII or PHI. I've verified, XLogger is not logging fields that are annotated with @ToString.Exclude. Please review AuditLogEventEntity and AuditLogEventRequest classes.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:06:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwNjA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAxMjc5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445012798", "bodyText": "please remove the log line entirely.", "author": "zohrehj", "createdAt": "2020-06-24T16:15:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwNjA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMwNDU0Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445304543", "bodyText": "We'll remove Bean/Entity, request/response objects from logger statements. In addition, team will add @ToString.Exclude annotation to fields that contain PII/PHI just to avoid accidentally logging PHI/PII in the future. I've modified the logger statements, please review AuditLogEventController class.", "author": "dhanyak-btc", "createdAt": "2020-06-25T04:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwNjA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxMzI3OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443613279", "bodyText": "nit: extractFieldNameFromValidationError might be more descriptive.", "author": "zohrehj", "createdAt": "2020-06-22T14:45:51Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/validator/AuditLogEventValidator.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.auditlog.validator;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getArrayNode;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getObjectNode;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getTextValue;\n+import java.util.List;\n+import javax.annotation.PostConstruct;\n+import org.apache.commons.lang3.StringUtils;\n+import org.everit.json.schema.Schema;\n+import org.everit.json.schema.ValidationException;\n+import org.everit.json.schema.loader.SchemaLoader;\n+import org.json.JSONObject;\n+import org.json.JSONTokener;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+@Component\n+public final class AuditLogEventValidator {\n+\n+  private static final String ERROR_DESCRIPTION = \"error_description\";\n+\n+  private static final String ERROR_TYPE = \"error_type\";\n+\n+  private static final String FILED_NAME = \"fieldName\";\n+\n+  private static final String ERRORS = \"errors\";\n+\n+  private static final String STATUS = \"status\";\n+\n+  private static final String USER_ID = \"user_id\";\n+\n+  private Schema schema;\n+\n+  @PostConstruct\n+  public void loadSchema() {\n+    JSONObject jsonSchema =\n+        new JSONObject(\n+            new JSONTokener(\n+                AuditLogEventValidator.class.getResourceAsStream(\"/audit-log-event-schema.json\")));\n+    this.schema = SchemaLoader.load(jsonSchema);\n+  }\n+\n+  public JsonNode validateJson(JsonNode eventParams) {\n+    try {\n+      JSONObject jsonSubject = new JSONObject(eventParams.toString());\n+      schema.validate(jsonSubject);\n+    } catch (ValidationException e) {\n+      List<String> messages = e.getAllMessages();\n+      ArrayNode errors = getArrayNode();\n+      for (String msg : messages) {\n+        ObjectNode err = getObjectNode();\n+        err.put(FILED_NAME, extractFieldName(msg));\n+        err.put(ERROR_DESCRIPTION, msg);\n+        errors.add(err);\n+      }\n+\n+      return buildValidationResponse(eventParams, errors);\n+    }\n+\n+    return null;\n+  }\n+\n+  private JsonNode buildValidationResponse(JsonNode eventParams, ArrayNode errors) {\n+    StringBuilder errorDescription = new StringBuilder(\"Audit log event validation failed\");\n+    if (eventParams.hasNonNull(USER_ID)) {\n+      errorDescription.append(\" for user_id=\").append(getTextValue(eventParams, USER_ID));\n+    }\n+    ObjectNode result = getObjectNode();\n+    result.set(ERRORS, errors);\n+    result.put(ERROR_TYPE, HttpStatus.BAD_REQUEST.getReasonPhrase());\n+    result.put(STATUS, HttpStatus.BAD_REQUEST.value());\n+    result.put(ERROR_DESCRIPTION, errorDescription.toString());\n+    return result;\n+  }\n+\n+  private String extractFieldName(String msg) {", "originalCommit": "4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyNjc2NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443726764", "bodyText": "Renamed to extractFieldPathFromValidationError", "author": "dhanyak-btc", "createdAt": "2020-06-22T17:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxMzI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1MzQ3OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443653479", "bodyText": "I have noticed that you are using different logger libraries; why is that? wouldn't it be better to use the same logger across the code", "author": "zohrehj", "createdAt": "2020-06-22T15:42:57Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/RestExceptionHandler.java", "diffHunk": "@@ -1,19 +1,41 @@\n package com.google.cloud.healthcare.fdamystudies.common;\n \n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;", "originalCommit": "4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczMDY2OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443730668", "bodyText": "Thanks Zohreh, I'll add this point to PR notes and I'll ask developers to use XLoggerFactory as it brings consistency across all services. Replaced with XLogger and XLoggerFactory.", "author": "dhanyak-btc", "createdAt": "2020-06-22T17:54:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1MzQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5MDEwMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444390103", "bodyText": "XLogger sounds like a good idea.", "author": "zohrehj", "createdAt": "2020-06-23T17:29:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1MzQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MDU2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443660563", "bodyText": "please remove all logs from the health method.\nThe current kubernetes deployment is using health method as readinessprobe/livenessprobe and calls the method constantly.\nHaving any logs in the method will therefore make server logs almost unusable.", "author": "zohrehj", "createdAt": "2020-06-22T15:53:30Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/HealthController.java", "diffHunk": "@@ -6,31 +6,35 @@\n  * https://opensource.org/licenses/MIT.\n  */\n \n-package com.google.cloud.healthcare.fdamystudies.auditlog.controller;\n+package com.google.cloud.healthcare.fdamystudies.controller;\n \n import javax.servlet.http.HttpServletRequest;\n import org.slf4j.ext.XLogger;\n import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.http.MediaType;\n import org.springframework.http.ResponseEntity;\n import org.springframework.web.bind.annotation.GetMapping;\n import org.springframework.web.bind.annotation.RequestMapping;\n import org.springframework.web.bind.annotation.RestController;\n import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.service.OAuthService;\n \n @RestController\n @RequestMapping(\"/v1\")\n-public class HealthController extends BaseController {\n+public class HealthController {\n \n   private XLogger logger = XLoggerFactory.getXLogger(HealthController.class.getName());\n \n+  @Autowired private OAuthService oauthService;\n+\n   @GetMapping(\n       value = \"/health\",\n       produces = {MediaType.APPLICATION_JSON_VALUE})\n   public ResponseEntity<JsonNode> health(HttpServletRequest request) {\n     logger.entry(String.format(\"begin %s request with no args\", request.getRequestURI()));", "originalCommit": "4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc0NzcxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443747716", "bodyText": "Logger.entry() and Logger.exit() statements are logged if the log level is TRACE. We should avoid TRACE log level in production.", "author": "dhanyak-btc", "createdAt": "2020-06-22T18:26:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MDU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2NDM5NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443764394", "bodyText": "This will still provide a lot of noise in the TRACE logs so I also think it should be removed, even though it won't be logging in production.", "author": "nikklassen", "createdAt": "2020-06-22T19:00:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MDU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk3MTQ3Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443971472", "bodyText": "Removed logger statements from /healthCheck endpoint", "author": "dhanyak-btc", "createdAt": "2020-06-23T05:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MDU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MTI0Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443661243", "bodyText": "please remove this logger entry. It gets called too frequently and causes a lot of spam in the logs.", "author": "zohrehj", "createdAt": "2020-06-22T15:54:28Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/filter/FilterChainExceptionHandler.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.google.cloud.healthcare.fdamystudies.filter;\n+\n+import java.io.IOException;\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.client.HttpClientErrorException;\n+import org.springframework.web.client.HttpServerErrorException;\n+import org.springframework.web.filter.OncePerRequestFilter;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorResponse;\n+import com.google.cloud.healthcare.fdamystudies.common.JsonUtils;\n+\n+@Component\n+@Order(1)\n+public class FilterChainExceptionHandler extends OncePerRequestFilter {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(FilterChainExceptionHandler.class.getName());\n+\n+  @Override\n+  protected void doFilterInternal(\n+      HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)\n+      throws ServletException, IOException {\n+    logger.entry(String.format(\"begin doFilterInternal() for %s\", request.getRequestURI()));", "originalCommit": "4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc0ODM0OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443748348", "bodyText": "We learnt about XLogger from Nik's comments. This special logger is useful to diagnose issues in the application without the need for a debugging session. It help developers to analyze the issue in non-production (DEV/QA/UAT) environment. Logger.entry() and Logger.exit() statements are logged if the log level is TRACE. We should avoid TRACE log level in production.\nWe'll be adding XLogger entry/exit/catching statements to all the services for above mentioned benefits. This is also one of the areas of improvements feedback that was shared with us last week.\nAreas Of Improvements Feedback: Google will ask that proper error logs are implemented", "author": "dhanyak-btc", "createdAt": "2020-06-22T18:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MTI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc4NzkwMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443787901", "bodyText": "Again, proper error logging means not including logs that don't add any value, even at TRACE.", "author": "nikklassen", "createdAt": "2020-06-22T19:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MTI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk3MzY0NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443973644", "bodyText": "These logger statements helped me to analyze the @Order of filter execution. I personally liked the use of XLogger, it really helped while testing the service when deployed to tomcat server.", "author": "dhanyak-btc", "createdAt": "2020-06-23T05:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MTI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5MTMzOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444391339", "bodyText": "that makes sense and feel free to use your own debug logs when developing code, but what gets checked in should be useful in a production environment, and this log would be extremely noisy in production setting.", "author": "zohrehj", "createdAt": "2020-06-23T17:31:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MTI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk2ODE5NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444968195", "bodyText": "logger.entry removed now.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MTI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MzE4Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443663187", "bodyText": "change to healthCheck for consistency with other services", "author": "zohrehj", "createdAt": "2020-06-22T15:57:16Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/HealthController.java", "diffHunk": "@@ -6,31 +6,35 @@\n  * https://opensource.org/licenses/MIT.\n  */\n \n-package com.google.cloud.healthcare.fdamystudies.auditlog.controller;\n+package com.google.cloud.healthcare.fdamystudies.controller;\n \n import javax.servlet.http.HttpServletRequest;\n import org.slf4j.ext.XLogger;\n import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.http.MediaType;\n import org.springframework.http.ResponseEntity;\n import org.springframework.web.bind.annotation.GetMapping;\n import org.springframework.web.bind.annotation.RequestMapping;\n import org.springframework.web.bind.annotation.RestController;\n import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.service.OAuthService;\n \n @RestController\n @RequestMapping(\"/v1\")\n-public class HealthController extends BaseController {\n+public class HealthController {\n \n   private XLogger logger = XLoggerFactory.getXLogger(HealthController.class.getName());\n \n+  @Autowired private OAuthService oauthService;\n+\n   @GetMapping(\n       value = \"/health\",", "originalCommit": "4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczNjIzOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443736238", "bodyText": "Changed to /healthCheck", "author": "dhanyak-btc", "createdAt": "2020-06-22T18:04:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MzE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MzM5OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443663399", "bodyText": "please remove info level logs from very common methods; they cause too much noise in the logs.", "author": "zohrehj", "createdAt": "2020-06-22T15:57:34Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/filter/TokenIntrospectionFilter.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.filter;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import javax.annotation.PostConstruct;\n+import javax.servlet.Filter;\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletContext;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.ArrayUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.http.server.PathContainer;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.util.pattern.PathPattern;\n+import org.springframework.web.util.pattern.PathPatternParser;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.JsonUtils;\n+import com.google.cloud.healthcare.fdamystudies.service.OAuthService;\n+\n+@Component\n+@Order(2)\n+public class TokenIntrospectionFilter implements Filter {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(TokenIntrospectionFilter.class.getName());\n+\n+  public static final String TOKEN = \"token\";\n+\n+  public static final String ACTIVE = \"active\";\n+\n+  @Autowired ServletContext context;\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  private Map<String, String[]> uriTemplateAndMethods = new HashMap<>();\n+\n+  @PostConstruct\n+  public void init() {\n+    // list of paths and methods for token introspection\n+    uriTemplateAndMethods.put(\n+        String.format(\"%s/v1/events\", context.getContextPath()), new String[] {\"POST\"});\n+  }\n+\n+  @Override\n+  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)\n+      throws IOException, ServletException {\n+    logger.entry(\n+        String.format(\"begin doFilter() for %s\", ((HttpServletRequest) request).getRequestURI()));", "originalCommit": "4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc0ODQ4Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443748486", "bodyText": "Logger.entry() and Logger.exit() statements are logged if the log level is TRACE. We should avoid TRACE log level in production.", "author": "dhanyak-btc", "createdAt": "2020-06-22T18:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MzM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NDQxOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443664419", "bodyText": "why is this needed?", "author": "zohrehj", "createdAt": "2020-06-22T15:59:00Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/filter/TokenIntrospectionFilter.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.filter;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import javax.annotation.PostConstruct;\n+import javax.servlet.Filter;\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletContext;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.ArrayUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.http.server.PathContainer;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.util.pattern.PathPattern;\n+import org.springframework.web.util.pattern.PathPatternParser;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.JsonUtils;\n+import com.google.cloud.healthcare.fdamystudies.service.OAuthService;\n+\n+@Component\n+@Order(2)", "originalCommit": "4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczODQyMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443738420", "bodyText": "In order for Spring to be able to recognize a filter, we needed to define it as a bean with the @Component annotation. And, to have the filters fire in the right order \u2013 we needed to use the @Order annotation.\nFilterChainExceptionHandler filter should be fired before any other filters, FilterChainExceptionHandler handles exception thrown by other filters so TokenIntrospectionFilter has @Order(2)", "author": "dhanyak-btc", "createdAt": "2020-06-22T18:08:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NDQxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NjU2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443666566", "bodyText": "does this expose tokens to logs?\nIf that is the case, please remove the log entry.", "author": "zohrehj", "createdAt": "2020-06-22T16:02:11Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/OAuthServiceImpl.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.addTextFields;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getTextValue;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.http.HttpMethod;\n+import org.springframework.http.MediaType;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import com.fasterxml.jackson.databind.JsonNode;\n+\n+@Service\n+public class OAuthServiceImpl extends BaseServiceImpl implements OAuthService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(OAuthServiceImpl.class.getName());\n+\n+  private static final String TOKEN = \"token\";\n+\n+  private static final String SCOPE = \"scope\";\n+\n+  private static final String AUTHORIZATION = \"Authorization\";\n+\n+  private static final String CONTENT_TYPE = \"Content-Type\";\n+\n+  @Value(\"${security.oauth2.health_endpoint}\")\n+  private String healthEndpoint;\n+\n+  @Value(\"${security.oauth2.introspection_endpoint}\")\n+  private String introspectEndpoint;\n+\n+  @Override\n+  public ResponseEntity<JsonNode> health() {\n+    return getForJson(healthEndpoint);\n+  }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> introspectToken(JsonNode params) {\n+    logger.entry(String.format(\"begin introspectToken() with params=%s\", params));", "originalCommit": "4ec17dc7c98d6a1c7d06a5ab0fe1e91c75ab8e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc0ODc4NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443748784", "bodyText": "Logger.entry() and Logger.exit() statements are logged if the log level is TRACE. We should avoid TRACE log level in production.", "author": "dhanyak-btc", "createdAt": "2020-06-22T18:28:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NjU2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk2OTk0Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444969947", "bodyText": "I've removed params from logger.entry", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:13:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NjU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2OTI1Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443669257", "bodyText": "I think these two should be moved to the block below with the rest of  com.google.cloud.healthcare.fdamystudies.common import lines.", "author": "zohrehj", "createdAt": "2020-06-22T16:06:21Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/filter/TokenIntrospectionFilter.java", "diffHunk": "@@ -8,6 +8,8 @@\n \n package com.google.cloud.healthcare.fdamystudies.filter;\n \n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getObjectMapper;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getObjectNode;", "originalCommit": "e3b4ade2159f7996752d05425678a83bb3ba08ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1MjgxMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443752812", "bodyText": "Team is using google-java-format-eclipse-plugin_1.6.0.jar in STS to format the code. Please let me know if you are using different version.", "author": "dhanyak-btc", "createdAt": "2020-06-22T18:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2OTI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM4NzkxNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444387915", "bodyText": "I didn't notice the static keyword initially. The separation now makes more sense.\nreviewing https://google.github.io/styleguide/javaguide.html#s3.3.3-import-ordering-and-spacing it seems you need a separation between static and non-static imports.\nAlso you are free to use any formatter you prefer, as long as it follows Google styleguide.", "author": "zohrehj", "createdAt": "2020-06-23T17:25:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2OTI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3NTg0MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444975840", "bodyText": "I added a line spacing between static and non-static imports but google-java-format-eclipse-plugin_1.6.0.jar plugin removes the line spacing.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2OTI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAwNzYyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445007629", "bodyText": "here is suggestion when I googled your comment: google/styleguide#273", "author": "zohrehj", "createdAt": "2020-06-24T16:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2OTI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMzNDg5NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445334894", "bodyText": "@zohrehj  thanks for the link, I followed the steps given in the link to organize the imports and formatted the code. 'Organize imports' modified many classes. I'll ask the team to apply these settings in their IDE if the formatting is OK.", "author": "dhanyak-btc", "createdAt": "2020-06-25T06:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2OTI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY3MDI3Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443670276", "bodyText": "since this method is returning a boolean, maybe renaming to something like:\npathAndMethodAreValid or validatePathAndHttpMethod would make it more readable.", "author": "zohrehj", "createdAt": "2020-06-22T16:07:54Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/filter/TokenIntrospectionFilter.java", "diffHunk": "@@ -84,7 +85,7 @@ public void doFilter(ServletRequest request, ServletResponse response, FilterCha\n     }\n   }\n \n-  private boolean applyFilter(HttpServletRequest req) {\n+  private boolean checkPathAndHttpMethodMatches(HttpServletRequest req) {", "originalCommit": "e3b4ade2159f7996752d05425678a83bb3ba08ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczOTg3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443739875", "bodyText": "Renamed to validatePathAndHttpMethod", "author": "dhanyak-btc", "createdAt": "2020-06-22T18:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY3MDI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY3MTAyOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443671028", "bodyText": "why is this order needed here?", "author": "zohrehj", "createdAt": "2020-06-22T16:09:09Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/filter/TokenIntrospectionFilter.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.google.cloud.healthcare.fdamystudies.auditlog.filter;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import javax.annotation.PostConstruct;\n+import javax.servlet.ServletContext;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.http.HttpMethod;\n+import org.springframework.stereotype.Component;\n+import com.google.cloud.healthcare.fdamystudies.filter.BaseTokenIntrospectionFilter;\n+\n+@Component\n+@Order(2)", "originalCommit": "6bfb2a698ca4238090bc11dedb84f13a4f16d186", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NDcwNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443754706", "bodyText": "@component and @order not present in latest code of this filter.", "author": "dhanyak-btc", "createdAt": "2020-06-22T18:40:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY3MTAyOA=="}], "type": "inlineReview"}, {"oid": "8742363e61a5bdcbd25bc77d321b708b556ab3ac", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8742363e61a5bdcbd25bc77d321b708b556ab3ac", "message": "Fixed PR#540 comments\n\nFixed PR#540 comments", "committedDate": "2020-06-22T18:41:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNDkxMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443704910", "bodyText": "I thought we had said we were going to prefer using Java/Bean validators, especially for the cases where the validation is running on every request.", "author": "nikklassen", "createdAt": "2020-06-22T17:06:29Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/validator/AuditLogEventValidator.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.auditlog.validator;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getArrayNode;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getObjectNode;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getTextValue;\n+import java.util.List;\n+import javax.annotation.PostConstruct;\n+import org.apache.commons.lang3.StringUtils;\n+import org.everit.json.schema.Schema;\n+import org.everit.json.schema.ValidationException;\n+import org.everit.json.schema.loader.SchemaLoader;\n+import org.json.JSONObject;\n+import org.json.JSONTokener;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+@Component\n+public final class AuditLogEventValidator {\n+\n+  private static final String ERROR_DESCRIPTION = \"error_description\";\n+\n+  private static final String ERROR_TYPE = \"error_type\";\n+\n+  private static final String FILED_PATH = \"fieldPath\";\n+\n+  private static final String ERRORS = \"errors\";\n+\n+  private static final String STATUS = \"status\";\n+\n+  private static final String USER_ID = \"user_id\";\n+\n+  private Schema schema;\n+\n+  @PostConstruct\n+  public void loadSchema() {\n+    JSONObject jsonSchema =\n+        new JSONObject(\n+            new JSONTokener(\n+                AuditLogEventValidator.class.getResourceAsStream(\"/audit-log-event-schema.json\")));\n+    this.schema = SchemaLoader.load(jsonSchema);\n+  }\n+\n+  public JsonNode validateJson(JsonNode eventParams) {", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEwNDc4MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444104780", "bodyText": "I'll refactor the code to use Java/Bean validator's, this may take few days to implement. Please open a issue and close this PR after reviewing other comments replies.", "author": "dhanyak-btc", "createdAt": "2020-06-23T09:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNDkxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3ODY4OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444978688", "bodyText": "I've removed this class. Validation is handled using validation annotations and @ControllerAdvice GlobalExceptionHandler  This class is copied from user-mgmt module. I've added logger statements to all the methods in this to log exceptions.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNDkxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNTkyNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443705925", "bodyText": "This should not be operating on JsonNode. You should parse the JSON into the entity type directly.", "author": "nikklassen", "createdAt": "2020-06-22T17:08:28Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/service/AuditLogEventService.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package com.google.cloud.healthcare.fdamystudies.auditlog.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+\n+public interface AuditLogEventService {\n+\n+  public long saveAuditLogEvent(JsonNode eventParams);", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEwNTQ3OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444105478", "bodyText": "I'll refactor the code to use entity type. I'll use table structure to store the event details.", "author": "dhanyak-btc", "createdAt": "2020-06-23T09:55:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNTkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3NzUzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444977531", "bodyText": "I've refactored the code to use AuditLogEventRequest bean", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNTkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNjU4Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443706582", "bodyText": "This should all be done with the JSON deserialization code we went over in the last PR.", "author": "nikklassen", "createdAt": "2020-06-22T17:09:37Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/service/AuditLogEventServiceImpl.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package com.google.cloud.healthcare.fdamystudies.auditlog.service;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.AuditLogConstants.ALERT;\n+import static com.google.cloud.healthcare.fdamystudies.common.AuditLogConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.common.AuditLogConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.common.AuditLogConstants.EVENT_INFO;\n+import static com.google.cloud.healthcare.fdamystudies.common.AuditLogConstants.EVENT_NAME;\n+import static com.google.cloud.healthcare.fdamystudies.common.AuditLogConstants.EVENT_TIMESTAMP;\n+import static com.google.cloud.healthcare.fdamystudies.common.AuditLogConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.common.AuditLogConstants.PLATFORM_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.common.AuditLogConstants.SYSTEM_ID;\n+import static com.google.cloud.healthcare.fdamystudies.common.AuditLogConstants.USER_ID;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getObjectNode;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getTextValue;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.model.AuditLogEventEntity;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.repository.AuditLogEventRepository;\n+import com.google.cloud.healthcare.fdamystudies.common.DateTimeUtils;\n+import com.google.cloud.healthcare.fdamystudies.service.BaseServiceImpl;\n+\n+@Service\n+public class AuditLogEventServiceImpl extends BaseServiceImpl implements AuditLogEventService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(AuditLogEventServiceImpl.class.getName());\n+\n+  @Autowired private AuditLogEventRepository repository;\n+\n+  @Value(\"${auditlog.platform-version}\")\n+  private String platformVersion;\n+\n+  @Override\n+  public long saveAuditLogEvent(JsonNode eventParams) {\n+    logger.entry(String.format(\"begin saveAuditLogEvent() with eventParams=%s\", eventParams));\n+    AuditLogEventEntity event = new AuditLogEventEntity();\n+\n+    event.setCorrelationId(getTextValue(eventParams, CORRELATION_ID));\n+    event.setEventName(getTextValue(eventParams, EVENT_NAME));\n+    event.setSystemId(getTextValue(eventParams, SYSTEM_ID));\n+    event.setAppId(getTextValue(eventParams, APP_ID));\n+    event.setOrgId(getTextValue(eventParams, ORG_ID));\n+    event.setUserId(getTextValue(eventParams, USER_ID));\n+    event.setCreatedTimestamp(DateTimeUtils.getSystemDateTimestamp());\n+    event.setEventTimestamp(eventParams.get(EVENT_TIMESTAMP).longValue());\n+    event.setAlert(eventParams.get(ALERT).booleanValue());\n+\n+    ObjectNode eventInfo = getObjectNode();\n+    eventInfo.put(PLATFORM_VERSION, platformVersion);\n+    eventInfo.setAll((ObjectNode) eventParams.get(EVENT_INFO));\n+    event.setEventInfo(eventInfo.toString());", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNDk5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444124998", "bodyText": "I'll refactor the code to use entity type.", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNjU4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MDE4MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444980180", "bodyText": "I've refactored the code, added new fields to AuditLogEventEntity class. Added AuditLogEventMapper class to copy fields from AuditLogEventRequest to AuditLogEventEntity object.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNjU4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwODI1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443708256", "bodyText": "These length limits don't appear to be enforced anywhere.", "author": "nikklassen", "createdAt": "2020-06-22T17:12:34Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/model/AuditLogEventEntity.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.auditlog.model;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+@Setter\n+@Getter\n+@Entity\n+@Table(name = \"audit_log_events\")\n+public class AuditLogEventEntity {\n+\n+  @Id\n+  @GeneratedValue(strategy = GenerationType.IDENTITY)\n+  @Column(name = \"id\", updatable = false, nullable = false)\n+  private long id;\n+\n+  @Column(name = \"correlation_id\", nullable = false, length = 255)", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNTM1OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444125358", "bodyText": "I'll  fix this in next PR", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:32:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwODI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MjU4NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444982584", "bodyText": "Added validation annotations to AuditLogEventRequest class to handle these limits.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwODI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxMDMyNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443710326", "bodyText": "Can we use a UUID for the UUID? It seems that Hibernate supports this easily. https://xebia.com/blog/jpa-implementation-patterns-using-uuids-as-primary-keys/", "author": "nikklassen", "createdAt": "2020-06-22T17:16:31Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/model/AuditLogEventEntity.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.auditlog.model;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+@Setter\n+@Getter\n+@Entity\n+@Table(name = \"audit_log_events\")\n+public class AuditLogEventEntity {\n+\n+  @Id\n+  @GeneratedValue(strategy = GenerationType.IDENTITY)\n+  @Column(name = \"id\", updatable = false, nullable = false)\n+  private long id;", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE3MjM1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444172353", "bodyText": "I'll try your suggestion in next PR.", "author": "dhanyak-btc", "createdAt": "2020-06-23T12:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxMDMyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MzY2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444983663", "bodyText": "Used UUID  for 'id' field in AuditLogEventEntity.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:31:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxMDMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczODQ5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443738497", "bodyText": "This is an example of some of my concerns about using performPost and other methods you have created. I don't know what StringUtils.EMPTY is for if I'm just looking at this code (i.e. without an IDE). And you aren't able to use other matchers. This test is much easier to read when written like this\n    mockMvc.perform(post(ApiEndpoint.EVENTS.getPath()).headers(headers))\n        .andDo(print())\n        .andExpect(status().isCreated())\n        .andExpect(content().string(containsString(validAuditLogEvent)))\n        .andExpect(model().attribute(\"event_id\", greaterThan(0)));\nI think we are overoptimizing here to remove the duplicated code, but the function call just removes too much flexibility and information.", "author": "nikklassen", "createdAt": "2020-06-22T18:08:45Z", "path": "audit-log-module/audit-log-service/src/test/java/com/google/cloud/healthcare/fdamystudies/auditlog/controller/AuditLogEventControllerTest.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.auditlog.controller;\n+\n+import static org.junit.Assert.assertTrue;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.UUID;\n+import org.apache.commons.lang3.StringUtils;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.http.MediaType;\n+import org.springframework.test.web.servlet.MvcResult;\n+import com.fasterxml.jackson.core.JsonParseException;\n+import com.fasterxml.jackson.databind.JsonMappingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.common.ApiEndpoint;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.validator.AuditLogEventValidator;\n+import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n+import com.jayway.jsonpath.JsonPath;\n+\n+public class AuditLogEventControllerTest extends BaseMockIT {\n+\n+  @Autowired AuditLogEventValidator validator;\n+\n+  private static String validAuditLogEvent;\n+\n+  private static String invalidAuditLogEvent;\n+\n+  private static ObjectMapper objMapper = new ObjectMapper();\n+\n+  @BeforeAll\n+  public static void loadEvents() throws JsonParseException, JsonMappingException, IOException {\n+    invalidAuditLogEvent =\n+        objMapper\n+            .readValue(\n+                AuditLogEventControllerTest.class.getResourceAsStream(\n+                    \"/invalid_audit_log_event.json\"),\n+                JsonNode.class)\n+            .toString();\n+\n+    validAuditLogEvent =\n+        objMapper\n+            .readValue(\n+                AuditLogEventControllerTest.class.getResourceAsStream(\n+                    \"/valid_audit_log_event.json\"),\n+                JsonNode.class)\n+            .toString();\n+  }\n+\n+  @Test\n+  public void shouldSaveAuditLogEvent() throws Exception {\n+    HttpHeaders headers = getCommonHeaders();\n+    headers.add(\"Authorization\", VALID_BEARER_TOKEN);\n+    MvcResult result =\n+        performPost(\n+            ApiEndpoint.EVENTS.getPath(), validAuditLogEvent, headers, StringUtils.EMPTY, CREATED);\n+    int eventId = JsonPath.read(result.getResponse().getContentAsString(), \"$.event_id\");", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEwNzk1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444107956", "bodyText": "My bad, I was expecting event_id field in the response. I've replaced StringUtils.EMPTY with event_id fieldname.", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczODQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIxOTY0MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444219641", "bodyText": "This wasn't the point of my comment. I have been suggesting this, but I think I need to make a stronger statement. Do not create methods like performPost. It makes tests hard to read and adapt. The DRY software engineering principle doesn't really apply to tests. In fact at Google we talk about DAMP tests.\n\nIn tests we can use the DAMP principle (\u201cDescriptive and Meaningful Phrases\u201d), which emphasizes readability over uniqueness. Applying this principle can introduce code redundancy (e.g., by repeating similar code), but it makes tests more obviously correct.", "author": "nikklassen", "createdAt": "2020-06-23T13:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczODQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIyNTk4NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444225984", "bodyText": "Relevant SO post: https://stackoverflow.com/questions/6453235/what-does-damp-not-dry-mean-when-talking-about-unit-tests", "author": "nikklassen", "createdAt": "2020-06-23T13:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczODQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4NjE2MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444986161", "bodyText": "Thanks for sharing the SO post. I've not heard about DAMP principle before, hence followed DRY principle in tests. I've refactored the AuditLogEventControllerTest to apply DAMP principle for shouldSaveAuditLogEvent(), shouldReturnBadRequestForInvalidContent() methods.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczODQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1MjIzNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443752234", "bodyText": "This test suite isn't for the FilterChainExceptionHandler. So I wouldn't mention it here. We are only testing that we get a \"Not Found\", it doesn't matter how that is implement.", "author": "nikklassen", "createdAt": "2020-06-22T18:35:41Z", "path": "audit-log-module/audit-log-service/src/test/java/com/google/cloud/healthcare/fdamystudies/auditlog/controller/AuditLogEventControllerTest.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.auditlog.controller;\n+\n+import static org.junit.Assert.assertTrue;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.UUID;\n+import org.apache.commons.lang3.StringUtils;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.http.MediaType;\n+import org.springframework.test.web.servlet.MvcResult;\n+import com.fasterxml.jackson.core.JsonParseException;\n+import com.fasterxml.jackson.databind.JsonMappingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.common.ApiEndpoint;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.validator.AuditLogEventValidator;\n+import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n+import com.jayway.jsonpath.JsonPath;\n+\n+public class AuditLogEventControllerTest extends BaseMockIT {\n+\n+  @Autowired AuditLogEventValidator validator;\n+\n+  private static String validAuditLogEvent;\n+\n+  private static String invalidAuditLogEvent;\n+\n+  private static ObjectMapper objMapper = new ObjectMapper();\n+\n+  @BeforeAll\n+  public static void loadEvents() throws JsonParseException, JsonMappingException, IOException {\n+    invalidAuditLogEvent =\n+        objMapper\n+            .readValue(\n+                AuditLogEventControllerTest.class.getResourceAsStream(\n+                    \"/invalid_audit_log_event.json\"),\n+                JsonNode.class)\n+            .toString();\n+\n+    validAuditLogEvent =\n+        objMapper\n+            .readValue(\n+                AuditLogEventControllerTest.class.getResourceAsStream(\n+                    \"/valid_audit_log_event.json\"),\n+                JsonNode.class)\n+            .toString();\n+  }\n+\n+  @Test\n+  public void shouldSaveAuditLogEvent() throws Exception {\n+    HttpHeaders headers = getCommonHeaders();\n+    headers.add(\"Authorization\", VALID_BEARER_TOKEN);\n+    MvcResult result =\n+        performPost(\n+            ApiEndpoint.EVENTS.getPath(), validAuditLogEvent, headers, StringUtils.EMPTY, CREATED);\n+    int eventId = JsonPath.read(result.getResponse().getContentAsString(), \"$.event_id\");\n+    assertTrue(eventId > 0);\n+  }\n+\n+  @Test\n+  public void shouldReturnUnauthorized() throws Exception {\n+    HttpHeaders headers = getCommonHeaders();\n+    headers.add(\"Authorization\", INVALID_BEARER_TOKEN);\n+\n+    performPost(\n+        ApiEndpoint.EVENTS.getPath(), validAuditLogEvent, headers, \"Invalid token\", UNAUTHORIZED);\n+  }\n+\n+  @Test\n+  public void shouldReturnNotFoundForRestClientErrorException() throws Exception {\n+    HttpHeaders headers = getCommonHeaders();\n+    headers.add(\"Authorization\", \"Bearer \" + UUID.randomUUID().toString());\n+\n+    // expect FilterChainExceptionHandler extracts status code and error message from", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEwODkwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444108905", "bodyText": "Removed that comment from shouldReturnNotFoundForRestClientErrorException()", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1MjIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1MzEyOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443753128", "bodyText": "This doesn't appear to be used by this PR", "author": "nikklassen", "createdAt": "2020-06-22T18:37:35Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/DateTimeUtils.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.common;\n+\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+\n+public final class DateTimeUtils {\n+\n+  private DateTimeUtils() {}\n+\n+  public static long getSystemDateTimestamp() {\n+    return Instant.now().toEpochMilli();\n+  }\n+\n+  public static long getSystemDateTimestamp(long days, long hours, long minutes) {", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDExMDM1Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444110352", "bodyText": "Removed the method from this class. Are you using any tools or STS plugins to find unused methods/variables?", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1MzEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzMzYxOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444233618", "bodyText": "In this case I saw that you added this method, but I didn't see it anywhere else in the PR, but I used IntelliJ to double-check with the \"Find All References\" tool. In general IntelliJ is very good at highlighting these kinds of things. I can't speak for other tools because I find IntelliJ meets all my needs.", "author": "nikklassen", "createdAt": "2020-06-23T13:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1MzEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4NzAzNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444987037", "bodyText": "I've removed this class as it's not used by any other classes in this module or common-modules.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1MzEyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NDE5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443754198", "bodyText": "Why are we trying to process HTML responses and pull out error details? We should be handling the exceptions before they are formatted as HTML.", "author": "nikklassen", "createdAt": "2020-06-22T18:39:41Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ErrorResponse.java", "diffHunk": "@@ -23,13 +28,53 @@\n @JsonSerialize(using = ErrorResponse.ErrorResponseSerializer.class)\n public class ErrorResponse {\n \n-  private String requestUri;\n+  private XLogger logger = XLoggerFactory.getXLogger(ErrorResponse.class.getName());\n \n-  private RestClientResponseException restClientResponseException;\n+  private String errorDescription;\n \n-  public ErrorResponse(String requestUri, RestClientResponseException restClientResponseException) {\n-    this.requestUri = requestUri;\n-    this.restClientResponseException = restClientResponseException;\n+  private String errorType;\n+\n+  private int status;\n+\n+  private long timestamp = Instant.now().toEpochMilli();\n+\n+  public ErrorResponse(RestClientResponseException restClientResponseException) {\n+    populateErrorFields(restClientResponseException);\n+  }\n+\n+  private void populateErrorFields(RestClientResponseException restClientResponseException) {\n+    status = restClientResponseException.getRawStatusCode();\n+    errorType = restClientResponseException.getClass().getSimpleName();\n+    errorDescription = restClientResponseException.getResponseBodyAsString();\n+\n+    // tomcat sets response body as html\n+    if (StringUtils.containsIgnoreCase(errorDescription, \"html\")) {", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDExMTkyOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444111928", "bodyText": "Exception is handled before returning the response to browser. Tomcat sets the response as HTML.", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NDE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzNDIxMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444234211", "bodyText": "This isn't an HTML server though, it's a REST server. We don't want any HTML responses.", "author": "nikklassen", "createdAt": "2020-06-23T13:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NDE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4OTEzOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444989138", "bodyText": "I've removed JSoup dependency, added ErrorController for handling Spring Boot Whitelabel Error. Reference: Custom Error in Spring Boot\nErrorController added to common-service to avoid duplication across services.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NDE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NTM0Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443755342", "bodyText": "You've implemented serialization for ErrorResponse, so you don't need to return a ResponseEntity, just return the ErrorResponse. You can set the status code with @StatusCode to HttpStatus.Internal.", "author": "nikklassen", "createdAt": "2020-06-22T18:41:58Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/RestExceptionHandler.java", "diffHunk": "@@ -1,19 +1,41 @@\n package com.google.cloud.healthcare.fdamystudies.common;\n \n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.http.HttpStatus;\n import org.springframework.http.ResponseEntity;\n import org.springframework.web.bind.annotation.ControllerAdvice;\n import org.springframework.web.bind.annotation.ExceptionHandler;\n+import org.springframework.web.client.HttpClientErrorException;\n+import org.springframework.web.client.RestClientResponseException;\n+import org.springframework.web.context.request.ServletWebRequest;\n import org.springframework.web.context.request.WebRequest;\n import org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;\n \n @ControllerAdvice\n public class RestExceptionHandler extends ResponseEntityExceptionHandler {\n \n+  private static final Logger LOG = LoggerFactory.getLogger(RestExceptionHandler.class);\n+\n   @SuppressWarnings(\"rawtypes\")\n   @ExceptionHandler(Exception.class)\n   public ResponseEntity handleSystemException(Exception ex, WebRequest request) {\n+    String uri = ((ServletWebRequest) request).getRequest().getRequestURI();\n+    LOG.error(String.format(\"%s request failed with an exception\", uri), ex);\n     return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)\n         .body(ErrorCode.APPLICATION_ERROR);\n   }\n+\n+  @SuppressWarnings(\"rawtypes\")\n+  @ExceptionHandler(RestClientResponseException.class)\n+  public ResponseEntity handleRestClientResponseException(", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDExNjg5MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444116890", "bodyText": "I didn't find @statuscode annotation. I guess you mean @ResponseStatus. Refactored the code using @ResponseStatus.", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NTM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzNDQ5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444234497", "bodyText": "Yes, thanks. That was what I meant.", "author": "nikklassen", "createdAt": "2020-06-23T13:44:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NTM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1ODk2MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443758960", "bodyText": "I don't think we should be forwarding the OAuth server's response here. I think we should just return a generic \"Unauthorized\" like in the \"not ACTIVE\" code path.", "author": "nikklassen", "createdAt": "2020-06-22T18:49:30Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/filter/BaseTokenIntrospectionFilter.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.filter;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getObjectMapper;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getObjectNode;\n+import java.io.IOException;\n+import java.util.Map;\n+import javax.servlet.Filter;\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.ArrayUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.http.server.PathContainer;\n+import org.springframework.web.util.pattern.PathPattern;\n+import org.springframework.web.util.pattern.PathPatternParser;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.service.OAuthService;\n+\n+public abstract class BaseTokenIntrospectionFilter implements Filter {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(BaseTokenIntrospectionFilter.class.getName());\n+\n+  public static final String TOKEN = \"token\";\n+\n+  public static final String ACTIVE = \"active\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Override\n+  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)\n+      throws IOException, ServletException {\n+    logger.entry(\n+        String.format(\"begin doFilter() for %s\", ((HttpServletRequest) request).getRequestURI()));\n+    HttpServletRequest req = (HttpServletRequest) request;\n+    if (checkPathAndHttpMethodMatches(req)) {\n+      logger.info(String.format(\"validate token for %s\", req.getRequestURI()));\n+\n+      String auth = req.getHeader(\"Authorization\");\n+      if (StringUtils.isEmpty(auth)) {\n+        logger.exit(\"token is empty, return 401 Unauthorized response\");\n+        setUnauthorizedResponse(response);\n+      } else {\n+        validateOAuthToken(request, response, chain, auth);\n+      }\n+    } else {\n+      logger.info(String.format(\"skip token validation for %s\", req.getRequestURI()));\n+      chain.doFilter(request, response);\n+    }\n+  }\n+\n+  private boolean checkPathAndHttpMethodMatches(HttpServletRequest req) {\n+    String method = req.getMethod().toUpperCase();\n+    for (Map.Entry<String, String[]> entry : getUriTemplateAndHttpMethodsMap().entrySet()) {\n+      if (ArrayUtils.contains(entry.getValue(), method)\n+          && checkPathMatches(entry.getKey(), req.getRequestURI())) {\n+        return true;\n+      }\n+    }\n+    return false;\n+  }\n+\n+  private static boolean checkPathMatches(String uriTemplate, String path) {\n+    PathPatternParser parser = new PathPatternParser();\n+    parser.setMatchOptionalTrailingSeparator(true);\n+    PathPattern p = parser.parse(uriTemplate);\n+    return p.matches(PathContainer.parsePath(path));\n+  }\n+\n+  private void validateOAuthToken(\n+      ServletRequest request, ServletResponse response, FilterChain chain, String auth)\n+      throws IOException, ServletException {\n+    String token = StringUtils.replace(auth, \"Bearer\", \"\").trim();\n+    ObjectNode params = getObjectNode();\n+    params.put(TOKEN, token);\n+    ResponseEntity<JsonNode> oauthResponse = oauthService.introspectToken(params);\n+    if (oauthResponse.getStatusCode().is2xxSuccessful()) {\n+      if (oauthResponse.getBody().get(ACTIVE).booleanValue()) {\n+        chain.doFilter(request, response);\n+      } else {\n+        logger.exit(\"token is invalid, return 401 Unauthorized response\");\n+        setUnauthorizedResponse(response);\n+      }\n+    } else {\n+      logger.exit(\n+          String.format(\n+              \"status=%d, response=%s\",\n+              oauthResponse.getStatusCodeValue(), oauthResponse.getBody()));\n+      HttpServletResponse res = (HttpServletResponse) response;\n+      res.setStatus(oauthResponse.getStatusCodeValue());\n+      res.setContentType(MediaType.APPLICATION_JSON_VALUE);\n+      res.getOutputStream().write(oauthResponse.getBody().toString().getBytes());", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDExNzc5OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444117799", "bodyText": "Refactored the code to reuse setUnauthorizedResponse() method", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:17:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1ODk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MDUxMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443760512", "bodyText": "I don't think this should be a filter. We want to handle most errors with @ExceptionHandler. For catching errors in other Filters I would put they try-catch logic in those classes.", "author": "nikklassen", "createdAt": "2020-06-22T18:52:31Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/filter/FilterChainExceptionHandler.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.google.cloud.healthcare.fdamystudies.filter;\n+\n+import java.io.IOException;\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.client.HttpClientErrorException;\n+import org.springframework.web.client.HttpServerErrorException;\n+import org.springframework.web.filter.OncePerRequestFilter;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorResponse;\n+import com.google.cloud.healthcare.fdamystudies.common.JsonUtils;\n+\n+@Component\n+@Order(1)\n+public class FilterChainExceptionHandler extends OncePerRequestFilter {", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDExODgyMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444118823", "bodyText": "I referred the accepted answer in stackoverflow. How to manage exceptions thrown in filters in Spring?\nWe might need to duplicate exception handling when we add new filters. Also, I think there may be few audit log events related to exceptions so I think FilterChainExceptionHandler is better approach for handling exceptions in filters.", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MDUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzNzQ5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444237497", "bodyText": "I agree that this will do what you intend, but can you test how this approach interacts with Exceptions thrown from controller methods? We want the handling to be different, I don't want this Filter to be catching the Exceptions from Controllers because there will be a lot more logic to handle those. If this Filter doesn't catch those exceptions then it's probably ok to take this approach.", "author": "nikklassen", "createdAt": "2020-06-23T13:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MDUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5MTA4Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444991082", "bodyText": "I added String s=null; s.length(); to throw NPE from Service/Controller class. I noticed this NPE was handled by @ControllerAdvice RestExceptionHandler in logs.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:42:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MDUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MTYyNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445081626", "bodyText": "Ok, that's what we want. So I'm fine with keeping this to handle exceptions in the filters.", "author": "nikklassen", "createdAt": "2020-06-24T18:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MDUxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MDgzMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443760832", "bodyText": "avoid wrapping one-liners.", "author": "nikklassen", "createdAt": "2020-06-22T18:53:12Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/BaseServiceImpl.java", "diffHunk": "@@ -9,83 +9,44 @@\n package com.google.cloud.healthcare.fdamystudies.service;\n \n import java.util.Collections;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.http.HttpEntity;\n import org.springframework.http.HttpHeaders;\n import org.springframework.http.HttpMethod;\n import org.springframework.http.MediaType;\n import org.springframework.http.ResponseEntity;\n import org.springframework.util.MultiValueMap;\n-import org.springframework.web.client.HttpClientErrorException;\n-import org.springframework.web.client.HttpServerErrorException;\n import org.springframework.web.client.RestTemplate;\n import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import com.fasterxml.jackson.databind.node.ObjectNode;\n-import com.google.cloud.healthcare.fdamystudies.common.ErrorResponse;\n \n public abstract class BaseServiceImpl {\n \n-  private static final String REQUEST_FAILED_WITH_AN_EXCEPTION =\n-      \"%s request failed with an exception\";\n-\n-  private static final Logger LOG = LoggerFactory.getLogger(BaseServiceImpl.class);\n-\n-  @Autowired private ObjectMapper objectMapper;\n-\n   @Autowired private RestTemplate restTemplate;\n \n-  @SuppressWarnings(\"rawtypes\")\n-  protected ResponseEntity exchangeForJson(\n+  protected ResponseEntity<JsonNode> exchangeForJson(\n       String url,\n       HttpHeaders headers,\n       JsonNode request,\n       HttpMethod method,\n       Object... uriVariables) {\n     headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n     HttpEntity<JsonNode> requestEntity = new HttpEntity<>(request, headers);\n-    try {\n-      return restTemplate.exchange(url, method, requestEntity, JsonNode.class, uriVariables);\n-    } catch (HttpClientErrorException | HttpServerErrorException e) {\n-      LOG.error(String.format(REQUEST_FAILED_WITH_AN_EXCEPTION, url), e);\n-      ErrorResponse err = new ErrorResponse(url, e);\n-      return ResponseEntity.status(e.getRawStatusCode()).body(err);\n-    }\n+    return restTemplate.exchange(url, method, requestEntity, JsonNode.class, uriVariables);", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyMTEwNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444121107", "bodyText": "I agree with you. Initially this method had try..catch block but now exception handling moved to RestExceptionHandler and FilterChainExceptionHandler  so this method became one-liners.", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MDgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5MDkyOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444390928", "bodyText": "In that case that mean you don't need BaseServiceImpl anymore. The AuditLogEventService isn't doing anything with the methods anyways.", "author": "nikklassen", "createdAt": "2020-06-23T17:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MDgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5MzQ5Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444993496", "bodyText": "I agree with you, but I've already implemented the Service classes using these methods. We'll keep this class.", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MDgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MTA1MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r443761051", "bodyText": "avoid wrapping one-liners.", "author": "nikklassen", "createdAt": "2020-06-22T18:53:37Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/BaseServiceImpl.java", "diffHunk": "@@ -9,83 +9,44 @@\n package com.google.cloud.healthcare.fdamystudies.service;\n \n import java.util.Collections;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.http.HttpEntity;\n import org.springframework.http.HttpHeaders;\n import org.springframework.http.HttpMethod;\n import org.springframework.http.MediaType;\n import org.springframework.http.ResponseEntity;\n import org.springframework.util.MultiValueMap;\n-import org.springframework.web.client.HttpClientErrorException;\n-import org.springframework.web.client.HttpServerErrorException;\n import org.springframework.web.client.RestTemplate;\n import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import com.fasterxml.jackson.databind.node.ObjectNode;\n-import com.google.cloud.healthcare.fdamystudies.common.ErrorResponse;\n \n public abstract class BaseServiceImpl {\n \n-  private static final String REQUEST_FAILED_WITH_AN_EXCEPTION =\n-      \"%s request failed with an exception\";\n-\n-  private static final Logger LOG = LoggerFactory.getLogger(BaseServiceImpl.class);\n-\n-  @Autowired private ObjectMapper objectMapper;\n-\n   @Autowired private RestTemplate restTemplate;\n \n-  @SuppressWarnings(\"rawtypes\")\n-  protected ResponseEntity exchangeForJson(\n+  protected ResponseEntity<JsonNode> exchangeForJson(\n       String url,\n       HttpHeaders headers,\n       JsonNode request,\n       HttpMethod method,\n       Object... uriVariables) {\n     headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n     HttpEntity<JsonNode> requestEntity = new HttpEntity<>(request, headers);\n-    try {\n-      return restTemplate.exchange(url, method, requestEntity, JsonNode.class, uriVariables);\n-    } catch (HttpClientErrorException | HttpServerErrorException e) {\n-      LOG.error(String.format(REQUEST_FAILED_WITH_AN_EXCEPTION, url), e);\n-      ErrorResponse err = new ErrorResponse(url, e);\n-      return ResponseEntity.status(e.getRawStatusCode()).body(err);\n-    }\n+    return restTemplate.exchange(url, method, requestEntity, JsonNode.class, uriVariables);\n   }\n \n-  @SuppressWarnings(\"rawtypes\")\n-  protected ResponseEntity exchangeForJson(\n+  protected ResponseEntity<JsonNode> exchangeForJson(\n       String url,\n       HttpHeaders headers,\n       MultiValueMap<String, String> request,\n       HttpMethod method,\n       Object... uriVariables) {\n     headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n     HttpEntity<MultiValueMap<String, String>> requestEntity = new HttpEntity<>(request, headers);\n-    try {\n-      return restTemplate.exchange(url, method, requestEntity, JsonNode.class, uriVariables);\n-    } catch (HttpClientErrorException | HttpServerErrorException e) {\n-      LOG.error(String.format(REQUEST_FAILED_WITH_AN_EXCEPTION, url), e);\n-      ErrorResponse err = new ErrorResponse(url, e);\n-      return ResponseEntity.status(e.getRawStatusCode()).body(err);\n-    }\n-  }\n-\n-  @SuppressWarnings(\"rawtypes\")\n-  protected ResponseEntity getForJson(String url, Object... uriVariables) {\n-    try {\n-      return restTemplate.getForEntity(url, JsonNode.class, uriVariables);\n-    } catch (HttpClientErrorException | HttpServerErrorException e) {\n-      LOG.error(String.format(REQUEST_FAILED_WITH_AN_EXCEPTION, url), e);\n-      ErrorResponse err = new ErrorResponse(url, e);\n-      return ResponseEntity.status(e.getRawStatusCode()).body(err);\n-    }\n+    return restTemplate.exchange(url, method, requestEntity, JsonNode.class, uriVariables);\n   }\n \n-  protected ObjectNode getObjectNode() {\n-    return objectMapper.createObjectNode();\n+  protected ResponseEntity<JsonNode> getForJson(String url, Object... uriVariables) {\n+    return restTemplate.getForEntity(url, JsonNode.class, uriVariables);", "originalCommit": "78db1c61d867b77fd4025c62d9cf5c65dc7afed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyMTI5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444121298", "bodyText": "I agree with you. Initially this method had try..catch block but now exception handling moved to RestExceptionHandler and FilterChainExceptionHandler so this method became one-liners.", "author": "dhanyak-btc", "createdAt": "2020-06-23T10:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2MTA1MQ=="}], "type": "inlineReview"}, {"oid": "5d8f03e1b280fcd6e7f280e821bc5d47b2cc5e57", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5d8f03e1b280fcd6e7f280e821bc5d47b2cc5e57", "message": "Fixed PR review comments\n\nFixed PR review comments", "committedDate": "2020-06-23T12:10:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIyMTc4MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444221780", "bodyText": "You don't need to expose implementation details to your user. You've logged the reason so you know what happened here. Also, according to the Javadocs for @ResponseStatus, you shouldn't use reason for REST endpoints.", "author": "nikklassen", "createdAt": "2020-06-23T13:26:31Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/RestExceptionHandler.java", "diffHunk": "@@ -26,16 +27,18 @@ public ResponseEntity handleSystemException(Exception ex, WebRequest request) {\n         .body(ErrorCode.APPLICATION_ERROR);\n   }\n \n-  @SuppressWarnings(\"rawtypes\")\n   @ExceptionHandler(RestClientResponseException.class)\n-  public ResponseEntity handleRestClientResponseException(\n+  @ResponseStatus(\n+      code = HttpStatus.INTERNAL_SERVER_ERROR,\n+      reason = \"request failed due to RestClientResponseException\")", "originalCommit": "5d8f03e1b280fcd6e7f280e821bc5d47b2cc5e57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5NDQ3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r444994475", "bodyText": "Removed 'reason' from @ResponseStatus", "author": "dhanyak-btc", "createdAt": "2020-06-24T15:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIyMTc4MA=="}], "type": "inlineReview"}, {"oid": "4a346803bc6b9b92e46919cc6830bfc247aa607e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4a346803bc6b9b92e46919cc6830bfc247aa607e", "message": "Refactored the code to fix PR comments\n\nRemoved JSoup, Json Schema validator dependencies.\nAdded server-side validation using validation annotations,\nAdded ErrorController, GlobalExceptionHandler, ValidationErrorResponse and AuditLogEventRequest to common-service module\nAdded jsonassert dependency to assert json values.", "committedDate": "2020-06-24T14:13:43Z", "type": "commit"}, {"oid": "57fb701edb8f65ffc49cd242a8b6ca549d496665", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/57fb701edb8f65ffc49cd242a8b6ca549d496665", "message": "Added logger statements to GlobalExceptionHandler\n\nAdded logger statements to GlobalExceptionHandler", "committedDate": "2020-06-24T14:43:27Z", "type": "commit"}, {"oid": "12eea074c3d4134d745323783d5024161baadc12", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/12eea074c3d4134d745323783d5024161baadc12", "message": "Moved AuditLogEventResponse to common-service module\n\nMoved AuditLogEventResponse to common-service module", "committedDate": "2020-06-24T14:56:44Z", "type": "commit"}, {"oid": "55b5f413ef3f45f32dd0fbb82131b105f344a11e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/55b5f413ef3f45f32dd0fbb82131b105f344a11e", "message": "Deleted postman collection\n\nDeleted postman collection", "committedDate": "2020-06-24T14:58:04Z", "type": "commit"}, {"oid": "4a8c9f562cff273b716f5f2ce3e2d7bf59ccdd75", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4a8c9f562cff273b716f5f2ce3e2d7bf59ccdd75", "message": "Added @ToString.Exclude to entity class\n\nAdded @ToString.Exclude to entity class", "committedDate": "2020-06-24T15:06:12Z", "type": "commit"}, {"oid": "68c94de2235c2e7133899263391327d5647b6bc2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/68c94de2235c2e7133899263391327d5647b6bc2", "message": "Removed params from logger.entry\n\nRemoved params from logger.entry", "committedDate": "2020-06-24T15:48:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3MzI1NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445073254", "bodyText": "A convention we use at Google is to have verbs be consistent to the same data entity. So you've got two methods here starting with to so it's a bit more confusing about the types involved. Since the type this class is focusing is the AuditLogEvent you can make that more clear by calling this fromAuditLogEventRequest. The other method name is still correct. This way the mapper class name always reflects the data entity type, and the method name always refers to the other type involved.", "author": "nikklassen", "createdAt": "2020-06-24T17:59:00Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/mapper/AuditLogEventMapper.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.google.cloud.healthcare.fdamystudies.auditlog.mapper;\n+\n+import java.time.Instant;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.model.AuditLogEventEntity;\n+import com.google.cloud.healthcare.fdamystudies.beans.AuditLogEventRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.AuditLogEventResponse;\n+\n+public final class AuditLogEventMapper {\n+\n+  private AuditLogEventMapper() {}\n+\n+  public static AuditLogEventEntity toAuditLogEventEntity(AuditLogEventRequest aleRequest) {", "originalCommit": "68c94de2235c2e7133899263391327d5647b6bc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMxMDI1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445310256", "bodyText": "renamed to fromAuditLogEventRequest(AuditLogEventRequest aleRequest)", "author": "dhanyak-btc", "createdAt": "2020-06-25T05:10:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3MzI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3NzE5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445077198", "bodyText": "This is a great reference example of how a test should be written. Please pass this along to the rest of the team as an example of a meaningful assertion that your test succeeded, without the test being too busy asserting everything.", "author": "nikklassen", "createdAt": "2020-06-24T18:06:12Z", "path": "audit-log-module/audit-log-service/src/test/java/com/google/cloud/healthcare/fdamystudies/auditlog/controller/AuditLogEventControllerTest.java", "diffHunk": "@@ -8,62 +8,65 @@\n \n package com.google.cloud.healthcare.fdamystudies.auditlog.controller;\n \n-import static org.junit.Assert.assertTrue;\n-import java.io.IOException;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.asJsonString;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.readJsonFile;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+import java.time.Instant;\n import java.util.Collections;\n import java.util.UUID;\n-import org.junit.jupiter.api.BeforeAll;\n+import org.apache.commons.lang3.RandomStringUtils;\n import org.junit.jupiter.api.Test;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+import org.skyscreamer.jsonassert.JSONCompareMode;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.http.HttpHeaders;\n import org.springframework.http.MediaType;\n import org.springframework.test.web.servlet.MvcResult;\n-import com.fasterxml.jackson.core.JsonParseException;\n-import com.fasterxml.jackson.databind.JsonMappingException;\n-import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n import com.google.cloud.healthcare.fdamystudies.auditlog.common.ApiEndpoint;\n-import com.google.cloud.healthcare.fdamystudies.auditlog.validator.AuditLogEventValidator;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.model.AuditLogEventEntity;\n+import com.google.cloud.healthcare.fdamystudies.auditlog.repository.AuditLogEventRepository;\n+import com.google.cloud.healthcare.fdamystudies.beans.AuditLogEventRequest;\n import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n import com.jayway.jsonpath.JsonPath;\n \n public class AuditLogEventControllerTest extends BaseMockIT {\n \n-  @Autowired AuditLogEventValidator validator;\n-\n-  private static String validAuditLogEvent;\n-\n-  private static String invalidAuditLogEvent;\n-\n-  private static ObjectMapper objMapper = new ObjectMapper();\n-\n-  @BeforeAll\n-  public static void loadEvents() throws JsonParseException, JsonMappingException, IOException {\n-    invalidAuditLogEvent =\n-        objMapper\n-            .readValue(\n-                AuditLogEventControllerTest.class.getResourceAsStream(\n-                    \"/invalid_audit_log_event.json\"),\n-                JsonNode.class)\n-            .toString();\n-\n-    validAuditLogEvent =\n-        objMapper\n-            .readValue(\n-                AuditLogEventControllerTest.class.getResourceAsStream(\n-                    \"/valid_audit_log_event.json\"),\n-                JsonNode.class)\n-            .toString();\n-  }\n+  @Autowired private AuditLogEventRepository repository;\n \n   @Test\n   public void shouldSaveAuditLogEvent() throws Exception {", "originalCommit": "68c94de2235c2e7133899263391327d5647b6bc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMzNTg3Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445335873", "bodyText": "Thanks for the comments, I've asked the team to consider audit-log-service as a reference for writing integration tests.", "author": "dhanyak-btc", "createdAt": "2020-06-25T06:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3NzE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3OTMzMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445079332", "bodyText": "You can remove this now that there are no rawtypes involved.", "author": "nikklassen", "createdAt": "2020-06-24T18:10:06Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/exceptions/GlobalExceptionHandler.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.exceptions;\n+\n+import javax.validation.ConstraintViolation;\n+import javax.validation.ConstraintViolationException;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.converter.HttpMessageNotReadableException;\n+import org.springframework.validation.FieldError;\n+import org.springframework.web.bind.MethodArgumentNotValidException;\n+import org.springframework.web.bind.MissingRequestHeaderException;\n+import org.springframework.web.bind.annotation.ControllerAdvice;\n+import org.springframework.web.bind.annotation.ExceptionHandler;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+import org.springframework.web.bind.annotation.ResponseStatus;\n+import org.springframework.web.client.HttpClientErrorException.BadRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.ValidationErrorResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.ValidationErrorResponse.Violation;\n+\n+@ControllerAdvice\n+public class GlobalExceptionHandler {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(GlobalExceptionHandler.class.getName());\n+\n+  @ExceptionHandler(BadRequest.class)\n+  @ResponseStatus(HttpStatus.BAD_REQUEST)\n+  public void handleBadRequest() {}\n+\n+  @SuppressWarnings(\"rawtypes\")", "originalCommit": "68c94de2235c2e7133899263391327d5647b6bc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMzNjIwMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445336203", "bodyText": "I removed that but STS IDE shows:\nConstraintViolation is a raw type. References to generic type ConstraintViolation should be parameterized", "author": "dhanyak-btc", "createdAt": "2020-06-25T06:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3OTMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1NjgxMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445656812", "bodyText": "You can always use <?>, i.e. ConstraintViolation<?>, instead of RawTypes, unless you are trying to circumvent the type system.", "author": "nikklassen", "createdAt": "2020-06-25T15:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3OTMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3OTU2NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445679565", "bodyText": "Removed @SuppressWarnings(\"rawtypes\")", "author": "dhanyak-btc", "createdAt": "2020-06-25T16:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3OTMzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MDQwNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445080406", "bodyText": "I would move these down to the TRACE level. These are definitely helpful for debugging, but since they are caused by users we don't want them causing error log spam with malicious inputs. The error log level can be reserved for system exceptions and user requests that are dangerous.", "author": "nikklassen", "createdAt": "2020-06-24T18:12:04Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/exceptions/GlobalExceptionHandler.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.exceptions;\n+\n+import javax.validation.ConstraintViolation;\n+import javax.validation.ConstraintViolationException;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.converter.HttpMessageNotReadableException;\n+import org.springframework.validation.FieldError;\n+import org.springframework.web.bind.MethodArgumentNotValidException;\n+import org.springframework.web.bind.MissingRequestHeaderException;\n+import org.springframework.web.bind.annotation.ControllerAdvice;\n+import org.springframework.web.bind.annotation.ExceptionHandler;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+import org.springframework.web.bind.annotation.ResponseStatus;\n+import org.springframework.web.client.HttpClientErrorException.BadRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.ValidationErrorResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.ValidationErrorResponse.Violation;\n+\n+@ControllerAdvice\n+public class GlobalExceptionHandler {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(GlobalExceptionHandler.class.getName());\n+\n+  @ExceptionHandler(BadRequest.class)\n+  @ResponseStatus(HttpStatus.BAD_REQUEST)\n+  public void handleBadRequest() {}\n+\n+  @SuppressWarnings(\"rawtypes\")\n+  @ExceptionHandler(ConstraintViolationException.class)\n+  @ResponseStatus(HttpStatus.BAD_REQUEST)\n+  @ResponseBody\n+  public ValidationErrorResponse handleConstraintValidationException(\n+      ConstraintViolationException e) {\n+    logger.error(\"request failed with ConstraintViolationException\", e);", "originalCommit": "68c94de2235c2e7133899263391327d5647b6bc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMzOTMxNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445339317", "bodyText": "We might miss production issues if we suppress the exception with TRACE level. IMO, it's better to log all the exceptions initially, monitor the logs once the projects goes LIVE in production. Later, decide on which exceptions to fix and which ones to suppress by changing the log level to DEBUG or TRACE.\nIt may leads to bad user experience if mobile apps or web app gets 400 BAD REQUEST in production and we'll not come to know the root cause with TRACE level for this exception in production.", "author": "dhanyak-btc", "createdAt": "2020-06-25T06:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MDQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYzOTU2NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445639565", "bodyText": "The web/mobile app should definitely be informing the user when it receives a 400. For example, say we have server-side validation for emails that the must conform to regex \\w{3,}@\\w+\\.\\w+. The user sends us the email address \"invalid\". We throw a 400 and tell the user that the email they gave us was invalid. But logging that is pointless.", "author": "nikklassen", "createdAt": "2020-06-25T15:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MDQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3OTM5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445679397", "bodyText": "Thanks for the explanation. Changed the log level to TRACE.", "author": "dhanyak-btc", "createdAt": "2020-06-25T16:18:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MDQwNg=="}], "type": "inlineReview"}, {"oid": "1cab43d3434add0d523c8d9bfd21772ff1de11ef", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1cab43d3434add0d523c8d9bfd21772ff1de11ef", "message": "Fixed PR comments - imports and logger statements\n\nFixed Imports and Removed beans, request/response from logger statements", "committedDate": "2020-06-25T07:02:20Z", "type": "commit"}, {"oid": "e82280486d96aef4c2d34c5c4f5c3aa2cf02159a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e82280486d96aef4c2d34c5c4f5c3aa2cf02159a", "message": "Changed the column definition to TIMESTAMP\n\nChanged the column definition to TIMESTAMP for eventTimestamp and createdTimestamp in AuditLogEventEntity class.\n\nAdded javdocs to eventTimestamp in AuditLogEventRequest", "committedDate": "2020-06-25T08:38:31Z", "type": "commit"}, {"oid": "ac8a1ecaa5ed4c90a80afbc176e70af24eafea57", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ac8a1ecaa5ed4c90a80afbc176e70af24eafea57", "message": "Removed @SuppressWarnings and changed log level to trace\n\nRemoved  @SuppressWarnings(\"rawtypes\")\nChanged log level to trace in handleConstraintValidationException() method", "committedDate": "2020-06-25T16:17:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyMDc5NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445820795", "bodyText": "Google API guideline suggests calling these timestamp columns simply:\ncreated, modified etc", "author": "zohrehj", "createdAt": "2020-06-25T20:31:49Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/model/AuditLogEventEntity.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.auditlog.model;\n+\n+import java.sql.Timestamp;\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.ToString;\n+import org.hibernate.annotations.GenericGenerator;\n+\n+@Setter\n+@Getter\n+@Entity\n+@Table(name = \"audit_log_events\")\n+public class AuditLogEventEntity {\n+\n+  @Id\n+  @GeneratedValue(generator = \"system-uuid\")\n+  @GenericGenerator(name = \"system-uuid\", strategy = \"uuid\")\n+  @Column(name = \"id\", updatable = false, nullable = false)\n+  private String id;\n+\n+  @Column(name = \"correlation_id\", nullable = false, length = 36)\n+  private String correlationId;\n+\n+  @Column(name = \"event_name\", nullable = false, length = 40)\n+  private String eventName;\n+\n+  @Column(name = \"system_id\", nullable = false, length = 30)\n+  private String systemId;\n+\n+  @Column(\n+      name = \"event_timestamp\",\n+      nullable = false,\n+      updatable = false,\n+      columnDefinition = \"TIMESTAMP\")\n+  private Timestamp eventTimestamp;\n+\n+  @Column(\n+      name = \"created_timestamp\",\n+      insertable = false,\n+      updatable = false,\n+      columnDefinition = \"TIMESTAMP DEFAULT CURRENT_TIMESTAMP\")\n+  private Timestamp createdTimestamp;", "originalCommit": "ac8a1ecaa5ed4c90a80afbc176e70af24eafea57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk3MTk5Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445971992", "bodyText": "This link  has different naming convention. Please share the Google API guideline link to refer. Renamed both column and property name to 'created', it'll be pushed for review in next PR.", "author": "dhanyak-btc", "createdAt": "2020-06-26T05:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyMDc5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyMDkzOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445820938", "bodyText": "could be renamed to occured maybe?", "author": "zohrehj", "createdAt": "2020-06-25T20:32:04Z", "path": "audit-log-module/audit-log-service/src/main/java/com/google/cloud/healthcare/fdamystudies/auditlog/model/AuditLogEventEntity.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.auditlog.model;\n+\n+import java.sql.Timestamp;\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.ToString;\n+import org.hibernate.annotations.GenericGenerator;\n+\n+@Setter\n+@Getter\n+@Entity\n+@Table(name = \"audit_log_events\")\n+public class AuditLogEventEntity {\n+\n+  @Id\n+  @GeneratedValue(generator = \"system-uuid\")\n+  @GenericGenerator(name = \"system-uuid\", strategy = \"uuid\")\n+  @Column(name = \"id\", updatable = false, nullable = false)\n+  private String id;\n+\n+  @Column(name = \"correlation_id\", nullable = false, length = 36)\n+  private String correlationId;\n+\n+  @Column(name = \"event_name\", nullable = false, length = 40)\n+  private String eventName;\n+\n+  @Column(name = \"system_id\", nullable = false, length = 30)\n+  private String systemId;\n+\n+  @Column(\n+      name = \"event_timestamp\",\n+      nullable = false,\n+      updatable = false,\n+      columnDefinition = \"TIMESTAMP\")\n+  private Timestamp eventTimestamp;", "originalCommit": "ac8a1ecaa5ed4c90a80afbc176e70af24eafea57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAxNDE5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r446014198", "bodyText": "Renamed both column and property name to 'occured', it'll be pushed for review in next PR.", "author": "dhanyak-btc", "createdAt": "2020-06-26T07:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyMDkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyMzY2NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445823665", "bodyText": "please add back the healthcheck test as well. It should assert that the response status is 200", "author": "zohrehj", "createdAt": "2020-06-25T20:37:14Z", "path": "audit-log-module/audit-log-service/src/test/java/com/google/cloud/healthcare/fdamystudies/auditlog/ApplicationTest.java", "diffHunk": "@@ -9,14 +9,15 @@\n package com.google.cloud.healthcare.fdamystudies.auditlog;\n \n import static org.junit.Assert.assertNotNull;\n+\n+import com.google.cloud.healthcare.fdamystudies.auditlog.controller.AuditLogEventController;\n+import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n import org.junit.jupiter.api.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import com.google.cloud.healthcare.fdamystudies.auditlog.controller.HealthController;\n-import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n \n class ApplicationTest extends BaseMockIT {\n \n-  @Autowired HealthController controller;\n+  @Autowired AuditLogEventController controller;", "originalCommit": "ac8a1ecaa5ed4c90a80afbc176e70af24eafea57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAxNTUyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r446015529", "bodyText": "I've added assertNotNull(healthController); in this Test. There is already a HealthControllerTest that assert response status is 200. This will be pushed for review in next PR.", "author": "dhanyak-btc", "createdAt": "2020-06-26T07:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyMzY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyOTU0NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r445829545", "bodyText": "why is this method calling oauthservice.health()?\nIdeally it should just return a 200 status.", "author": "zohrehj", "createdAt": "2020-06-25T20:49:00Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/HealthController.java", "diffHunk": "@@ -6,35 +6,28 @@\n  * https://opensource.org/licenses/MIT.\n  */\n \n-package com.google.cloud.healthcare.fdamystudies.auditlog.controller;\n+package com.google.cloud.healthcare.fdamystudies.controller;\n \n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.service.OAuthService;\n import javax.servlet.http.HttpServletRequest;\n-import org.slf4j.ext.XLogger;\n-import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.http.MediaType;\n import org.springframework.http.ResponseEntity;\n import org.springframework.web.bind.annotation.GetMapping;\n import org.springframework.web.bind.annotation.RequestMapping;\n import org.springframework.web.bind.annotation.RestController;\n-import com.fasterxml.jackson.databind.JsonNode;\n \n @RestController\n @RequestMapping(\"/v1\")\n-public class HealthController extends BaseController {\n+public class HealthController {\n \n-  private XLogger logger = XLoggerFactory.getXLogger(HealthController.class.getName());\n+  @Autowired private OAuthService oauthService;\n \n   @GetMapping(\n-      value = \"/health\",\n+      value = \"/healthCheck\",\n       produces = {MediaType.APPLICATION_JSON_VALUE})\n   public ResponseEntity<JsonNode> health(HttpServletRequest request) {\n-    logger.entry(String.format(\"begin %s request with no args\", request.getRequestURI()));\n-\n-    ResponseEntity<JsonNode> healthResponse = getOAuthService().health();\n-    logger.exit(\n-        String.format(\n-            \"status=%d and response=%s\",\n-            healthResponse.getStatusCodeValue(), healthResponse.getBody()));\n-    return healthResponse;\n+    return oauthService.health();", "originalCommit": "ac8a1ecaa5ed4c90a80afbc176e70af24eafea57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAxODIwMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/540#discussion_r446018201", "bodyText": "I referred Monitoring Microservices With Health Checks, all services in our project requires token introspection so added downstream services in /healthCheck endpoint. I've changed to code to returns always OK. This will be pushed for review in next PR. Thanks a lot for approving the PR #540.", "author": "dhanyak-btc", "createdAt": "2020-06-26T07:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyOTU0NQ=="}], "type": "inlineReview"}, {"oid": "2920902e6f91123369bfad32afea54b2c71443bf", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2920902e6f91123369bfad32afea54b2c71443bf", "message": "Merge branch 'early-access' into auditlog-events-endpoint", "committedDate": "2020-06-26T04:35:39Z", "type": "commit"}]}