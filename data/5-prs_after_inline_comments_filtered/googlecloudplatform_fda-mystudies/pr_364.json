{"pr_number": 364, "pr_title": "Fix for user able to access the account even after de-activated", "pr_createdAt": "2020-05-08T16:13:28Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364", "timeline": [{"oid": "8820e9e1b415bade84f98adb4d5f19f2e736c803", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8820e9e1b415bade84f98adb4d5f19f2e736c803", "message": "code commit of issue fix for user able to access the account even after de-activated", "committedDate": "2020-05-08T16:07:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI5NDU0OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r422294549", "bodyText": "Don't declare variables before they are assigned.", "author": "nikklassen", "createdAt": "2020-05-08T18:16:30Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/controller/LoginController.java", "diffHunk": "@@ -391,8 +391,8 @@ public ModelAndView validateAccessCode(HttpServletRequest request) {\n   public ModelAndView validateSecurityToken(HttpServletRequest request) {\n     ModelMap map = new ModelMap();\n     logger.info(\"LoginController - createPassword() - Starts\");\n-    String securityToken = null;\n-    boolean checkSecurityToken = false;\n+    String securityToken = null, message = \"\";", "originalCommit": "8820e9e1b415bade84f98adb4d5f19f2e736c803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI5NTYzNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r422295636", "bodyText": "One variable per declaration.\nisDeactivateUser should be isInactiveUser\nPlease move variable declaration closer to where it is used (line 419)", "author": "nikklassen", "createdAt": "2020-05-08T18:18:40Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/controller/LoginController.java", "diffHunk": "@@ -391,8 +391,8 @@ public ModelAndView validateAccessCode(HttpServletRequest request) {\n   public ModelAndView validateSecurityToken(HttpServletRequest request) {\n     ModelMap map = new ModelMap();\n     logger.info(\"LoginController - createPassword() - Starts\");\n-    String securityToken = null;\n-    boolean checkSecurityToken = false;\n+    String securityToken = null, message = \"\";\n+    boolean checkSecurityToken = false, isDeactivateUser = false;", "originalCommit": "8820e9e1b415bade84f98adb4d5f19f2e736c803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI5NTc1OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r422295758", "bodyText": "isInactiveUser", "author": "nikklassen", "createdAt": "2020-05-08T18:18:55Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/controller/LoginController.java", "diffHunk": "@@ -415,7 +415,12 @@ public ModelAndView validateSecurityToken(HttpServletRequest request) {\n       if (userBO != null) {\n         checkSecurityToken = true;\n       }\n+      message = loginService.isActiveUser(securityToken);\n+      if (message.equalsIgnoreCase(FdahpStudyDesignerConstants.USER_STATUS)) {\n+        isDeactivateUser = true;\n+      }\n       map.addAttribute(\"isValidToken\", checkSecurityToken);\n+      map.addAttribute(\"isDeactivateUser\", isDeactivateUser);", "originalCommit": "8820e9e1b415bade84f98adb4d5f19f2e736c803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI5ODQ2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r422298466", "bodyText": "Don't catch Exception", "author": "nikklassen", "createdAt": "2020-05-08T18:24:20Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/service/LoginServiceImpl.java", "diffHunk": "@@ -612,4 +612,20 @@ public void sendLockedAccountPasswordResetLinkToMail(String email) {\n     }\n     logger.info(\"LoginServiceImpl - sendLockedAccountPasswordResetLinkToMail - Ends\");\n   }\n+\n+  @Override\n+  public String isActiveUser(String securityToken) {\n+    logger.info(\"LoginServiceImpl - isActiveUser() - Starts\");\n+    String message = \"\";\n+    try {\n+      UserBO user = loginDAO.getUserBySecurityToken(securityToken);\n+      if (user != null && !user.isEnabled()) {\n+        message = FdahpStudyDesignerConstants.USER_STATUS;\n+      }\n+    } catch (Exception e) {", "originalCommit": "8820e9e1b415bade84f98adb4d5f19f2e736c803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI5OTQwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r422299405", "bodyText": "This should be returning a bool", "author": "nikklassen", "createdAt": "2020-05-08T18:26:07Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/service/LoginService.java", "diffHunk": "@@ -50,4 +50,6 @@ public String sendPasswordResetLinkToMail(\n       HttpServletRequest request, String email, String oldEmail, String type);\n \n   public void sendLockedAccountPasswordResetLinkToMail(String email);\n+\n+  public String isActiveUser(String securityToken);", "originalCommit": "8820e9e1b415bade84f98adb4d5f19f2e736c803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "481b28aa0b59dd87fb2a55b3bfe8d74416a3b936", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/481b28aa0b59dd87fb2a55b3bfe8d74416a3b936", "message": "Merge branch 'early-access' into early-access-de-activated-user-login-fix", "committedDate": "2020-05-11T15:50:06Z", "type": "commit"}, {"oid": "72d47b382ed3af38e87345139bb7ce8f1d90a62a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/72d47b382ed3af38e87345139bb7ce8f1d90a62a", "message": "Merge branch 'early-access' into early-access-de-activated-user-login-fix", "committedDate": "2020-05-12T06:19:03Z", "type": "commit"}, {"oid": "c57995ba345788e1fb0b87bcbf7a17ba754f0d71", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c57995ba345788e1fb0b87bcbf7a17ba754f0d71", "message": "Merge branch 'early-access' into early-access-de-activated-user-login-fix", "committedDate": "2020-05-18T08:08:16Z", "type": "commit"}, {"oid": "8080dbe8337b37e08946480ffbaf838839bd7e38", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8080dbe8337b37e08946480ffbaf838839bd7e38", "message": "code commit for issue fixes based on GitHub PR #364 comments", "committedDate": "2020-05-19T05:02:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM3ODU4OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r427378589", "bodyText": "FdahpStudyDesignerConstants.FAILURE immediately gets overwritten. Please remove.", "author": "nikklassen", "createdAt": "2020-05-19T15:08:15Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/controller/LoginController.java", "diffHunk": "@@ -61,31 +61,34 @@\n   @RequestMapping(\"/addPassword.do\")\n   public ModelAndView addPassword(HttpServletRequest request, UserBO userBO) {\n     logger.info(\"LoginController - addPassword() - Starts\");\n-    String securityToken = null;\n-    String accessCode = null;\n-    String password = null;\n-    String errorMsg = FdahpStudyDesignerConstants.FAILURE;\n     ModelAndView mv = new ModelAndView(\"redirect:login.do\");\n-    Map<String, String> propMap = FdahpStudyDesignerUtil.getAppProperties();\n-    SessionObject sesObj = null;\n-    HttpSession session = null;\n     try {\n-      session = request.getSession(false);\n-      sesObj = (SessionObject) session.getAttribute(FdahpStudyDesignerConstants.SESSION_OBJECT);\n-      accessCode =\n+      Map<String, String> propMap = FdahpStudyDesignerUtil.getAppProperties();\n+      HttpSession session = request.getSession(false);\n+      SessionObject sesObj =\n+          (SessionObject) session.getAttribute(FdahpStudyDesignerConstants.SESSION_OBJECT);\n+      String accessCode =\n           FdahpStudyDesignerUtil.isNotEmpty(request.getParameter(\"accessCode\"))\n               ? request.getParameter(\"accessCode\")\n               : \"\";\n-      password =\n+      String password =\n           FdahpStudyDesignerUtil.isNotEmpty(request.getParameter(\"password\"))\n               ? request.getParameter(\"password\").replaceAll(request.getParameter(\"_csrf\"), \"\")\n               : \"\";\n-      securityToken =\n+      String securityToken =\n           FdahpStudyDesignerUtil.isNotEmpty(request.getParameter(\"securityToken\"))\n               ? request.getParameter(\"securityToken\")\n               : \"\";\n-      errorMsg =\n-          loginService.authAndAddPassword(securityToken, accessCode, password, userBO, sesObj);\n+\n+      Boolean isInactiveUser = loginService.isActiveUser(securityToken);\n+      String errorMsg = FdahpStudyDesignerConstants.FAILURE;", "originalCommit": "8080dbe8337b37e08946480ffbaf838839bd7e38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM3OTQzOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r427379439", "bodyText": "This method needs to be called isInactiveUser.", "author": "nikklassen", "createdAt": "2020-05-19T15:09:25Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/service/LoginServiceImpl.java", "diffHunk": "@@ -614,18 +614,14 @@ public void sendLockedAccountPasswordResetLinkToMail(String email) {\n   }\n \n   @Override\n-  public String isActiveUser(String securityToken) {\n+  public Boolean isActiveUser(String securityToken) {", "originalCommit": "8080dbe8337b37e08946480ffbaf838839bd7e38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM4MzgyMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r427383821", "bodyText": "Also should be boolean. Avoid boxing primitives when possible.", "author": "nikklassen", "createdAt": "2020-05-19T15:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM3OTQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM4MDg4OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r427380889", "bodyText": "boolean isValidToken = userBO != null", "author": "nikklassen", "createdAt": "2020-05-19T15:11:20Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/controller/LoginController.java", "diffHunk": "@@ -405,22 +404,23 @@ public ModelAndView validateSecurityToken(HttpServletRequest request) {\n         map.addAttribute(\"errMsg\", request.getSession(false).getAttribute(\"errMsg\"));\n         request.getSession(false).removeAttribute(\"errMsg\");\n       }\n-      securityToken =\n+      String securityToken =\n           FdahpStudyDesignerUtil.isNotEmpty(request.getParameter(\"securityToken\"))\n               ? request.getParameter(\"securityToken\")\n               : \"\";\n-      userBO = loginService.checkSecurityToken(securityToken);\n+      UserBO userBO = loginService.checkSecurityToken(securityToken);\n       map.addAttribute(\"securityToken\", securityToken);\n-      masterDataBO = dashBoardAndProfileService.getMasterData(\"terms\");\n+      MasterDataBO masterDataBO = dashBoardAndProfileService.getMasterData(\"terms\");\n+\n+      boolean checkSecurityToken = false;", "originalCommit": "8080dbe8337b37e08946480ffbaf838839bd7e38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "212dcb0a0dc76edcf54a75c0170e5f9f1f6e81af", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/212dcb0a0dc76edcf54a75c0170e5f9f1f6e81af", "message": "PR #364 comment issue fixes", "committedDate": "2020-05-21T18:13:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzOTEyMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r428839122", "bodyText": "This is exactly the same as what I asked you to change in the other file\nboolean isInactiveUser = user != null && !user.isEnabled();", "author": "nikklassen", "createdAt": "2020-05-21T18:36:48Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/service/LoginServiceImpl.java", "diffHunk": "@@ -612,4 +612,28 @@ public void sendLockedAccountPasswordResetLinkToMail(String email) {\n     }\n     logger.info(\"LoginServiceImpl - sendLockedAccountPasswordResetLinkToMail - Ends\");\n   }\n+\n+  @Override\n+  public boolean isInactiveUser(String securityToken) {\n+    logger.info(\"LoginServiceImpl - isActiveUser() - Starts\");\n+    boolean isInactiveUser = false;\n+    UserBO user = loginDAO.getUserBySecurityToken(securityToken);\n+    if (user != null && !user.isEnabled()) {\n+      isInactiveUser = true;", "originalCommit": "212dcb0a0dc76edcf54a75c0170e5f9f1f6e81af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MDc4Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r428850787", "bodyText": "Thanks for highlighting this. Modified as suggested.", "author": "aswinijena100", "createdAt": "2020-05-21T18:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzOTEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzOTQ2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r428839463", "bodyText": "Same here\nboolean isIntialPasswordSetUp = StringUtils.isBlank(user.getUserPassword());", "author": "nikklassen", "createdAt": "2020-05-21T18:37:19Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/service/LoginServiceImpl.java", "diffHunk": "@@ -612,4 +612,28 @@ public void sendLockedAccountPasswordResetLinkToMail(String email) {\n     }\n     logger.info(\"LoginServiceImpl - sendLockedAccountPasswordResetLinkToMail - Ends\");\n   }\n+\n+  @Override\n+  public boolean isInactiveUser(String securityToken) {\n+    logger.info(\"LoginServiceImpl - isActiveUser() - Starts\");\n+    boolean isInactiveUser = false;\n+    UserBO user = loginDAO.getUserBySecurityToken(securityToken);\n+    if (user != null && !user.isEnabled()) {\n+      isInactiveUser = true;\n+    }\n+    logger.info(\"LoginServiceImpl - isActiveUser() - Ends\");\n+    return isInactiveUser;\n+  }\n+\n+  @Override\n+  public boolean isIntialPasswordSetUp(String securityToken) {\n+    logger.info(\"LoginServiceImpl - isIntialPasswordSetUp() - Starts\");\n+    boolean isIntialPasswordSetUp = false;\n+    UserBO user = loginDAO.getUserBySecurityToken(securityToken);\n+    if (StringUtils.isBlank(user.getUserPassword())) {\n+      isIntialPasswordSetUp = true;", "originalCommit": "212dcb0a0dc76edcf54a75c0170e5f9f1f6e81af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MDgyNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/364#discussion_r428850826", "bodyText": "Thanks for highlighting this. Modified as suggested.", "author": "aswinijena100", "createdAt": "2020-05-21T18:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzOTQ2Mw=="}], "type": "inlineReview"}, {"oid": "f0f7856c3b54826921d34c955ee46c6f823f93d7", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f0f7856c3b54826921d34c955ee46c6f823f93d7", "message": "PR comment issue fix", "committedDate": "2020-05-21T18:57:25Z", "type": "commit"}, {"oid": "2d1846cf6d5f9218591fe784a17bcacd888a8c43", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2d1846cf6d5f9218591fe784a17bcacd888a8c43", "message": "Merge branch 'early-access' into early-access-de-activated-user-login-fix", "committedDate": "2020-05-22T05:33:05Z", "type": "commit"}, {"oid": "4772b169bace95fb380cc28fb11d477621aec542", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4772b169bace95fb380cc28fb11d477621aec542", "message": "Merge branch 'early-access' into early-access-de-activated-user-login-fix", "committedDate": "2020-05-22T05:55:54Z", "type": "commit"}, {"oid": "3232ca454da1b2ff6f1ba0dc6242a431a031aa4a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3232ca454da1b2ff6f1ba0dc6242a431a031aa4a", "message": "Merge branch 'early-access' into early-access-de-activated-user-login-fix", "committedDate": "2020-05-28T13:08:27Z", "type": "commit"}]}