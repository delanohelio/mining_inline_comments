{"pr_number": 1922, "pr_title": "[Enrollment service and Participant Manager]issue 1873 fixes, Error message should be displayed as 'Unknown token' if user decommission the site after sending the invitation", "pr_createdAt": "2020-11-09T14:30:22Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1922", "timeline": [{"oid": "590e38588408a62c919d54b9fe44749bb3572b66", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/590e38588408a62c919d54b9fe44749bb3572b66", "message": "issue 1873 fixed", "committedDate": "2020-11-09T14:25:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1NjAwNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1922#discussion_r519856004", "bodyText": "[enroll-mgmt Checks] reported by reviewdog \ud83d\udc36\nLine is longer than 100 characters (found 131).", "author": "github-actions", "createdAt": "2020-11-09T14:31:08Z", "path": "participant-datastore/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java", "diffHunk": "@@ -108,27 +108,16 @@ public boolean hasParticipant(@NotNull String studyId, @NotNull String tokenValu\n     logger.info(\"EnrollmentTokenDaoImpl hasParticipant() - Started \");\n     List<Object[]> participantList = null;\n     Session session = this.sessionFactory.getCurrentSession();\n-    List<String> studyStateStatus = new ArrayList<>();\n-    studyStateStatus.add(ParticipantStudyStateStatus.ENROLLED.getValue());\n-    studyStateStatus.add(ParticipantStudyStateStatus.WITHDRAWN.getValue());\n-    studyStateStatus.add(ParticipantStudyStateStatus.INPROGRESS.getValue());\n \n-    List<String> onboardingStatus = new ArrayList<>();\n-    onboardingStatus.add(OnboardingStatus.INVITED.getCode());\n-    onboardingStatus.add(OnboardingStatus.ENROLLED.getCode());\n-    onboardingStatus.add(OnboardingStatus.DISABLED.getCode());\n     participantList =\n         session\n             .createQuery(\n                 \"from ParticipantStudyEntity PS,StudyEntity SB, ParticipantRegistrySiteEntity PR\"\n                     + \" where SB.id =PS.study.id and PS.participantRegistrySite.id=PR.id\"\n-                    + \" and PS.status in (:studyStateStatus) \"\n-                    + \" and PR.onboardingStatus in (:onboardingStatus)\"\n-                    + \" and upper(trim(PR.enrollmentToken))=:token and SB.customId=:studyId\")\n-            .setParameter(\"studyStateStatus\", studyStateStatus)\n-            .setParameter(\"onboardingStatus\", onboardingStatus)\n+                    + \" and upper(trim(PR.enrollmentToken))=:token and SB.customId=:studyId and PR.enrollmentTokenUsed=:tokenUsed\")", "originalCommit": "590e38588408a62c919d54b9fe44749bb3572b66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2MDQxMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1922#discussion_r519860413", "bodyText": "Fixed", "author": "madhurya-btc", "createdAt": "2020-11-09T14:37:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1NjAwNA=="}], "type": "inlineReview"}, {"oid": "13b85f9178a7d1243c791165c3c56abc4f41ad39", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/13b85f9178a7d1243c791165c3c56abc4f41ad39", "message": "github actions comment fixes", "committedDate": "2020-11-09T14:32:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzMDAwMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1922#discussion_r520130003", "bodyText": "Why are these removed? Is it relevant to the current bug to be fixed?", "author": "saminguyen", "createdAt": "2020-11-09T21:25:41Z", "path": "participant-datastore/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java", "diffHunk": "@@ -108,27 +108,17 @@ public boolean hasParticipant(@NotNull String studyId, @NotNull String tokenValu\n     logger.info(\"EnrollmentTokenDaoImpl hasParticipant() - Started \");\n     List<Object[]> participantList = null;\n     Session session = this.sessionFactory.getCurrentSession();\n-    List<String> studyStateStatus = new ArrayList<>();\n-    studyStateStatus.add(ParticipantStudyStateStatus.ENROLLED.getValue());\n-    studyStateStatus.add(ParticipantStudyStateStatus.WITHDRAWN.getValue());\n-    studyStateStatus.add(ParticipantStudyStateStatus.INPROGRESS.getValue());\n \n-    List<String> onboardingStatus = new ArrayList<>();\n-    onboardingStatus.add(OnboardingStatus.INVITED.getCode());\n-    onboardingStatus.add(OnboardingStatus.ENROLLED.getCode());\n-    onboardingStatus.add(OnboardingStatus.DISABLED.getCode());\n     participantList =\n         session\n             .createQuery(\n                 \"from ParticipantStudyEntity PS,StudyEntity SB, ParticipantRegistrySiteEntity PR\"\n                     + \" where SB.id =PS.study.id and PS.participantRegistrySite.id=PR.id\"\n-                    + \" and PS.status in (:studyStateStatus) \"\n-                    + \" and PR.onboardingStatus in (:onboardingStatus)\"", "originalCommit": "13b85f9178a7d1243c791165c3c56abc4f41ad39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM3MDI1NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1922#discussion_r520370255", "bodyText": "With these status we were unable to find exactly whether token is already used or not, hence we have introduced a new column to check Token is used or not .", "author": "madhurya-btc", "createdAt": "2020-11-10T08:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzMDAwMw=="}], "type": "inlineReview"}, {"oid": "05206df2cae8556d9cb8666bf48b2b65f867379c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/05206df2cae8556d9cb8666bf48b2b65f867379c", "message": "Merge branch 'develop' into issue1873", "committedDate": "2020-11-10T08:22:57Z", "type": "commit"}, {"oid": "0f27c8ea550161166f3f768b4c55cc44d43b2130", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0f27c8ea550161166f3f768b4c55cc44d43b2130", "message": "Merge branch 'develop' into issue1873", "committedDate": "2020-11-13T12:55:53Z", "type": "commit"}, {"oid": "d4860ee4f7b161c30ec386f07a8cd08412399850", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d4860ee4f7b161c30ec386f07a8cd08412399850", "message": "Merge branch 'develop' into issue1873", "committedDate": "2020-11-13T20:01:10Z", "type": "commit"}, {"oid": "f92852917e2151541da464b7fed239c3f0bccf59", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f92852917e2151541da464b7fed239c3f0bccf59", "message": "Merge branch 'develop' into issue1873", "committedDate": "2020-11-16T15:53:06Z", "type": "commit"}, {"oid": "e5023ae87729eb534de1afdc5e06c16137c798d8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e5023ae87729eb534de1afdc5e06c16137c798d8", "message": "Merge branch 'develop' into issue1873", "committedDate": "2020-11-16T19:51:48Z", "type": "commit"}, {"oid": "6ffb694d9d782753b4a7ba24ce6d230c83d2a8e3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6ffb694d9d782753b4a7ba24ce6d230c83d2a8e3", "message": "Merge branch 'develop' into issue1873", "committedDate": "2020-11-17T04:17:13Z", "type": "commit"}]}