{"pr_number": 371, "pr_title": "Call URS from StudyMetaData server for userResources. ", "pr_createdAt": "2020-05-11T01:06:03Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/371", "timeline": [{"oid": "91c7e2ac951fa6ca2df61defb32a586de52dd4cb", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/91c7e2ac951fa6ca2df61defb32a586de52dd4cb", "message": "Add call to URS.", "committedDate": "2020-05-11T00:33:51Z", "type": "commit"}, {"oid": "d24a57292b7d401c05317dd72edb0ab462f0534c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d24a57292b7d401c05317dd72edb0ab462f0534c", "message": "Add comments.", "committedDate": "2020-05-11T01:07:23Z", "type": "commit"}, {"oid": "b23d4efd0921fecb29f4edbcfde435b8efc62faf", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b23d4efd0921fecb29f4edbcfde435b8efc62faf", "message": "Remove log.", "committedDate": "2020-05-11T01:08:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjczOTM4Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/371#discussion_r422739383", "bodyText": "What actually needs to be done here to convert the user management server response into the study metadata response? The user management server is returning json, so it seems like if the call succeeds the response should just be forwarded as is.", "author": "karepker", "createdAt": "2020-05-11T01:48:25Z", "path": "WCP-WS/src/main/java/com/hphc/mystudies/service/StudyMetaDataService.java", "diffHunk": "@@ -282,11 +285,27 @@ public Object resourcesForStudy(\n   @Consumes(MediaType.APPLICATION_JSON)\n   @Path(\"userResources\")\n   public Object getUserResources(\n+      @HeaderParam(\"userId\") String userId,\n+      @HeaderParam(\"clientToken\") String clientToken,\n+      @HeaderParam(\"accessToken\") String accessToken,\n       @QueryParam(\"studyId\") String studyId,\n       @Context ServletContext context,\n       @Context HttpServletResponse response) {\n-    // TODO: this endpoint should first try to get personalized user resource before falling back to\n-    // generic resources for this study.\n+    Client client = Client.create();\n+    WebResource webResource = client.resource(propMap.get(\"userRegistrationServerPersonalizedResourcesUrl\"));\n+    ClientResponse ursResponse = webResource\n+        .queryParam(\"studyId\", studyId)\n+        .header(\"userId\", userId)\n+        .header(\"clientToken\", clientToken)\n+        .header(\"accessToken\", accessToken)\n+        .get(ClientResponse.class);\n+\t\tif (ursResponse.getStatus() != 200) {\n+\t\t  LOGGER.error(\"Failed : HTTP error code : \" + ursResponse.getStatus());\n+      // Fall back to generic resources for this user.\n+      return resourcesForStudyImpl(studyId, context, response);\n+\t\t}\n+    // TODO: Actually convert ursResponse to the response of this REST call.\n+\t\tString ursOutput = ursResponse.getEntity(String.class);", "originalCommit": "b23d4efd0921fecb29f4edbcfde435b8efc62faf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc2NjUyNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/371#discussion_r422766527", "bodyText": "Ideally we shouldn't need to convert anything. I haven't figured out how to forward the response as is (but I imagine it shouldn't be hard). I'll do that in a separate change. Updated the comment here.", "author": "kuoyuchi", "createdAt": "2020-05-11T03:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjczOTM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjczOTY5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/371#discussion_r422739697", "bodyText": "nit: Indentation seems a little weird here. As far as I can tell, the coding style appears to be two spaces for a tab (this is what Google's Java formatter does so if you have the settings for that it should work).", "author": "karepker", "createdAt": "2020-05-11T01:50:03Z", "path": "WCP-WS/src/main/java/com/hphc/mystudies/service/StudyMetaDataService.java", "diffHunk": "@@ -282,11 +285,27 @@ public Object resourcesForStudy(\n   @Consumes(MediaType.APPLICATION_JSON)\n   @Path(\"userResources\")\n   public Object getUserResources(\n+      @HeaderParam(\"userId\") String userId,\n+      @HeaderParam(\"clientToken\") String clientToken,\n+      @HeaderParam(\"accessToken\") String accessToken,\n       @QueryParam(\"studyId\") String studyId,\n       @Context ServletContext context,\n       @Context HttpServletResponse response) {\n-    // TODO: this endpoint should first try to get personalized user resource before falling back to\n-    // generic resources for this study.\n+    Client client = Client.create();\n+    WebResource webResource = client.resource(propMap.get(\"userRegistrationServerPersonalizedResourcesUrl\"));\n+    ClientResponse ursResponse = webResource\n+        .queryParam(\"studyId\", studyId)\n+        .header(\"userId\", userId)\n+        .header(\"clientToken\", clientToken)\n+        .header(\"accessToken\", accessToken)\n+        .get(ClientResponse.class);\n+\t\tif (ursResponse.getStatus() != 200) {", "originalCommit": "b23d4efd0921fecb29f4edbcfde435b8efc62faf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc2NjU1OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/371#discussion_r422766559", "bodyText": "Oops. Fix the indentation. Thanks for the catch!", "author": "kuoyuchi", "createdAt": "2020-05-11T03:59:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjczOTY5Nw=="}], "type": "inlineReview"}, {"oid": "c48ff5d44cf629a2b11ae77ec4f3bca2ec0e00ab", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c48ff5d44cf629a2b11ae77ec4f3bca2ec0e00ab", "message": "Change spaces to tabs.", "committedDate": "2020-05-11T03:54:05Z", "type": "commit"}, {"oid": "fce27b2394ea9e1dceff590dc79a067a3cd11707", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/fce27b2394ea9e1dceff590dc79a067a3cd11707", "message": "Update indent.", "committedDate": "2020-05-11T03:56:32Z", "type": "commit"}, {"oid": "c8a57f07ab26ed87d26572a82a4b7cca00be8e9c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c8a57f07ab26ed87d26572a82a4b7cca00be8e9c", "message": "Update comment.", "committedDate": "2020-05-11T03:57:51Z", "type": "commit"}, {"oid": "9d47ae0c63a80d0a161abac5b83babe5c740e168", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9d47ae0c63a80d0a161abac5b83babe5c740e168", "message": "Merge branch 'early-access' into study-meta-data-urs-call", "committedDate": "2020-05-11T03:59:17Z", "type": "commit"}, {"oid": "cd47a247867adc5aa214b2029a40e4a4c09332f6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cd47a247867adc5aa214b2029a40e4a4c09332f6", "message": "Merge branch 'early-access' into study-meta-data-urs-call", "committedDate": "2020-05-11T16:47:24Z", "type": "commit"}]}