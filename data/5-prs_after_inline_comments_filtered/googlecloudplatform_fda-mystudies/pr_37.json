{"pr_number": 37, "pr_title": "Early access build", "pr_createdAt": "2020-03-30T14:53:13Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37", "timeline": [{"oid": "c7e910ad3a89c424e49bfd8a4804815e905ac221", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c7e910ad3a89c424e49bfd8a4804815e905ac221", "message": "Added valid value for Client ID and Secret Key for WCP Application. Also added property for send notification url and resolved copy right symbol issue", "committedDate": "2020-03-30T14:07:17Z", "type": "commit"}, {"oid": "5469130263dfc134329885b71a93e5991c3e2140", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5469130263dfc134329885b71a93e5991c3e2140", "message": "Copy Right issue fixes and added few properties into the property files", "committedDate": "2020-03-30T14:22:25Z", "type": "commit"}, {"oid": "b715f7e4bff50569f1c382acd107dd5b4df523af", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b715f7e4bff50569f1c382acd107dd5b4df523af", "message": "Internal QA issue fixes", "committedDate": "2020-03-30T14:24:04Z", "type": "commit"}, {"oid": "510c7fc74bdbe4ee1d3ac5fc7814392202ff1ff1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/510c7fc74bdbe4ee1d3ac5fc7814392202ff1ff1", "message": "Modified the property details as per the actial api url", "committedDate": "2020-03-30T14:25:50Z", "type": "commit"}, {"oid": "c91787ea574077eed153d88822a24e20b8dea675", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c91787ea574077eed153d88822a24e20b8dea675", "message": "Internal QA issue fixes and removed the api from interceptor url to by pass the auth server calls", "committedDate": "2020-03-30T14:30:20Z", "type": "commit"}, {"oid": "e1131b6b1a1485b5e34daf609320bc0576b71cc5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e1131b6b1a1485b5e34daf609320bc0576b71cc5", "message": "Internal QA issue Fixes", "committedDate": "2020-03-30T14:34:06Z", "type": "commit"}, {"oid": "a8fc0c6c8b27d2dc68b94167b799596e58e1024e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a8fc0c6c8b27d2dc68b94167b799596e58e1024e", "message": "Internal QA issue Fixes", "committedDate": "2020-03-30T14:37:54Z", "type": "commit"}, {"oid": "6e33eeb4aeb20e7e7de260c9eff8486880f8bc7b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6e33eeb4aeb20e7e7de260c9eff8486880f8bc7b", "message": "Internal QA issue fixes", "committedDate": "2020-03-30T14:44:09Z", "type": "commit"}, {"oid": "a7c23b4d2bd83dd35ab2734717fabe0ad6d8a74f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a7c23b4d2bd83dd35ab2734717fabe0ad6d8a74f", "message": "Modified the branch name in .yml file as the existing branch name modifed to new one and also added .yml file for Auth server build", "committedDate": "2020-03-30T14:48:08Z", "type": "commit"}, {"oid": "0fbd22e5964cd008909c530a94d4535b608e4c68", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0fbd22e5964cd008909c530a94d4535b608e4c68", "message": "Changed the workflow name and removed  duplicate declaration of version", "committedDate": "2020-03-30T15:07:10Z", "type": "commit"}, {"oid": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0d8f011cb950c18117c78f750bd7ec7e19918a73", "message": "Added maven dependency for apns-1.0.0.Beta6.jar", "committedDate": "2020-03-30T15:13:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwMzU2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400303563", "bodyText": "please do not change the format of the license. The previous format was consistent with other files, this change will make this one look different.", "author": "zohrehj", "createdAt": "2020-03-30T15:54:27Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/scheduler/FDASchedulerService.java", "diffHunk": "@@ -1,24 +1,23 @@\n /*\n- * Copyright \u00c2\u00a9 2017-2018 Harvard Pilgrim Health Care Institute (HPHCI) and its Contributors.\n+ * Copyright \u00a9 2017-2018 Harvard Pilgrim Health Care Institute (HPHCI) and its Contributors.\n+ * Copyright 2020 Google LLC\n  * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and\n- * associated documentation files (the \"Software\"), to deal in the Software without restriction, including\n- * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\n- * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the\n- * following conditions:\n+ * associated documentation files (the \"Software\"), to deal in the Software without restriction,\n+ * including without limitation the rights to use, copy, modify, merge, publish, distribute,", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMjc2OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402412769", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:39:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwMzU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwODY3NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400308674", "bodyText": "would this code allow validation of a service with another service's credential? i.e. RS with WCP id and secret or vice versa?", "author": "zohrehj", "createdAt": "2020-03-30T16:01:13Z", "path": "auth-server-ws/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/AuthenticationController.java", "diffHunk": "@@ -264,7 +264,8 @@\n       if (AppConstants.MA.equals(appCode)\n           || AppConstants.USWS.equals(appCode)\n           || AppConstants.URS.equals(appCode)\n-          || AppConstants.RS.equals(appCode)) {\n+          || AppConstants.RS.equals(appCode)\n+          || AppConstants.WCP.equals(appCode)) {", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMzYwNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402413607", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwODY3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxMTU4Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400311582", "bodyText": "are these pwsIds sequential?\nI am guessing these are database Ids and sequential, so is it possible to just fetch them in an ordered manner and not do a post sort instead?", "author": "zohrehj", "createdAt": "2020-03-30T16:05:07Z", "path": "auth-server-ws/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserDetailsServiceImpl.java", "diffHunk": "@@ -619,15 +621,17 @@ public String savePasswordHistory(String userId, String password, String salt) {\n     PasswordHistoryBO passHistoryBo = null;\n     String passwordHistoryCount = appConfig.getPasswordHistoryCount();\n     List<PasswordHistoryBO> passwordHistories = null;\n+    List<Integer> pwsIds = new ArrayList<>();\n     try {\n       passwordHistories = passHistoryRepo.findByUserId(userId);\n       if (passwordHistories != null\n+          && !passwordHistories.isEmpty()\n           && passwordHistories.size() > (Integer.parseInt(passwordHistoryCount) - 1)) {\n-        for (int i = 0;\n-            i < ((passwordHistories.size() - Integer.parseInt(passwordHistoryCount)) + 1);\n-            i++) {\n-          passHistoryRepo.deleteByUserId(userId);\n+        for (PasswordHistoryBO passwordHistoryBO : passwordHistories) {\n+          pwsIds.add(passwordHistoryBO.getPasswordHistoryId());\n         }\n+        Collections.sort(pwsIds);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNDE5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400314198", "bodyText": "nit: please rename to health controller.\nwith \"/health\" mapping for service health check.", "author": "zohrehj", "createdAt": "2020-03-30T16:08:48Z", "path": "response-server-ws/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/PingController.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+package com.google.cloud.healthcare.fdamystudies.controller;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@RestController\n+public class PingController {", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMzc4MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402413780", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:41:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNDE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNjA2NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400316065", "bodyText": "thanks for addressing all these issues!", "author": "zohrehj", "createdAt": "2020-03-30T16:11:32Z", "path": "response-server-ws/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/ProcessActivityResponseController.java", "diffHunk": "@@ -150,14 +148,9 @@\n \n         // Get ParticipantStudyInfo from Registration Server\n         ParticipantStudyInformation partStudyInfo =\n-            partStudyInfoService.getParticipantStudyInfo(\n-                orgId, applicationId, studyId, participantId);\n+            partStudyInfoService.getParticipantStudyInfo(studyId, participantId);\n         if (partStudyInfo == null) {\n-          logger.error(\n-              \"Input values are :\\n Study Id: \"\n-                  + studyId\n-                  + \"\\n participantId Id: \"\n-                  + participantId);\n+          logger.error(\"GetParticipantStudyInfo() - ParticipantInfo is null. Study Id: \" + studyId);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNzA0NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400317044", "bodyText": "nit: should we change this to client credentials to be consistent with other auth errors?", "author": "zohrehj", "createdAt": "2020-03-30T16:12:59Z", "path": "response-server-ws/src/main/java/com/google/cloud/healthcare/fdamystudies/service/CommonServiceImpl.java", "diffHunk": "@@ -77,7 +77,7 @@ public boolean validateServerClientCredentials(String clientId, String clientSec\n       logger.error(\"ERROR: \", e);\n \n       if (e.getRawStatusCode() == 401) {\n-        logger.error(\"Invalid client Id or client secret. Client id is: \" + clientId);\n+        logger.error(\"Invalid client Id or client secret.\");", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNDQxOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402414419", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:42:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNzA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxOTgxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400319816", "bodyText": "is this a test file? if yes, should it moved to the test directory instead?", "author": "zohrehj", "createdAt": "2020-03-30T16:17:09Z", "path": "user-registration-server-ws/consent-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/TestPDFUpload.java", "diffHunk": "@@ -40,7 +40,7 @@\n             + fileName);\n \n     try {\n-      logger.info(\"first try block starts\");\n+      logger.info(\"first try block starts in testPDFUpload\");", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyMDM4Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400320382", "bodyText": "I realize this is out of scope of this PR, but I would like to identify if there is an area for improvement in later stages.", "author": "zohrehj", "createdAt": "2020-03-30T16:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxOTgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyMTg1OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400321859", "bodyText": "why is this needed?", "author": "zohrehj", "createdAt": "2020-03-30T16:20:10Z", "path": "user-registration-server-ws/consent-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/CloudStorageService.java", "diffHunk": "@@ -53,7 +54,8 @@ public String saveFile(String fileName, String content, String underDirectory) {\n       byte[] bytes = null;\n \n       try (WriteChannel writer = storageService.writer(blobInfo)) {\n-        bytes = content.getBytes();\n+        bytes = Base64.getDecoder().decode(content.replaceAll(\"\\n\", \"\"));", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNjE5OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402416199", "bodyText": "Without decoding if we store the file , file was getting corrupted . Hence to store as proper file we need to decode the Base64 encoded file and store it cloud storage and vice versa.", "author": "aswinijena100", "createdAt": "2020-04-02T15:44:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyMTg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyNDgxNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400324817", "bodyText": "please remove commented code.", "author": "zohrehj", "createdAt": "2020-03-30T16:24:20Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java", "diffHunk": "@@ -263,12 +263,12 @@ public EnrollmentResponseBean enrollParticipant(\n                 countAddParticipant = (Integer) session.save(participants);\n               }\n               if (countAddParticipant > 0) {\n-                SiteBo sites = session.get(SiteBo.class, siteBo.getId());\n-                participantRegistry.setSites(sites);\n-                participantRegistry.setInvitationDate(\n-                    EnrollmentManagementUtil.getCurrentUtilDateTime());\n-                participantRegistry.setOnboardingStatus(\"E\");\n-                session.update(participantRegistry);\n+                //                SiteBo sites = session.get(SiteBo.class, siteBo.getId());\n+                //                participantRegistry.setSites(sites);\n+                //                participantRegistry.setInvitationDate(\n+                //                    EnrollmentManagementUtil.getCurrentUtilDateTime());\n+                //                participantRegistry.setOnboardingStatus(\"E\");\n+                //                session.update(participantRegistry);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNjMxOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402416319", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyNDgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzNTQ4OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400335488", "bodyText": "if (notificationForm == null\n    || notificationForm.getNotifications() == null\n    || notificationForm.getNotifications().isEmpty()\n    || errorBean.getCode() != ErrorCode.EC_200.code()) {\n  return new ResponseEntity<>(errorBean, HttpStatus.BAD_REQUEST);\n}```", "author": "zohrehj", "createdAt": "2020-03-30T16:39:58Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/StudiesController.java", "diffHunk": "@@ -52,7 +56,32 @@\n       errorBean = new ErrorBean(ErrorCode.EC_500.code(), ErrorCode.EC_500.errorMessage());\n       return new ResponseEntity<>(errorBean, HttpStatus.BAD_REQUEST);\n     }\n-    logger.error(\"StudiesController - getStudyParticipants() : ends\");\n+    logger.info(\"StudiesController - getStudyParticipants() : ends\");\n+    return new ResponseEntity<>(errorBean, HttpStatus.OK);\n+  }\n+\n+  @PostMapping(\"/sendNotification\")\n+  public ResponseEntity<?> SendNotification(@RequestBody NotificationForm notificationForm) {\n+    logger.error(\"StudiesController - SendNotification() : starts\");\n+    ErrorBean errorBean = null;\n+    try {\n+      if (notificationForm != null\n+          && notificationForm.getNotifications() != null\n+          && !notificationForm.getNotifications().isEmpty()) {\n+        errorBean = studiesServices.SendNotificationAction(notificationForm);\n+        if (errorBean.getCode() != ErrorCode.EC_200.code()) {\n+          return new ResponseEntity<>(errorBean, HttpStatus.BAD_REQUEST);\n+        }\n+      } else {\n+        return new ResponseEntity<>(errorBean, HttpStatus.BAD_REQUEST);\n+      }", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNzQ5NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402417494", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:46:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzNTQ4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzNjMzMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400336330", "bodyText": "this should not be logger.error. logger.info or logger.debug would be more appropriate", "author": "zohrehj", "createdAt": "2020-03-30T16:41:11Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/StudiesController.java", "diffHunk": "@@ -52,7 +56,32 @@\n       errorBean = new ErrorBean(ErrorCode.EC_500.code(), ErrorCode.EC_500.errorMessage());\n       return new ResponseEntity<>(errorBean, HttpStatus.BAD_REQUEST);\n     }\n-    logger.error(\"StudiesController - getStudyParticipants() : ends\");\n+    logger.info(\"StudiesController - getStudyParticipants() : ends\");\n+    return new ResponseEntity<>(errorBean, HttpStatus.OK);\n+  }\n+\n+  @PostMapping(\"/sendNotification\")\n+  public ResponseEntity<?> SendNotification(@RequestBody NotificationForm notificationForm) {\n+    logger.error(\"StudiesController - SendNotification() : starts\");\n+    ErrorBean errorBean = null;\n+    try {\n+      if (notificationForm != null\n+          && notificationForm.getNotifications() != null\n+          && !notificationForm.getNotifications().isEmpty()) {\n+        errorBean = studiesServices.SendNotificationAction(notificationForm);\n+        if (errorBean.getCode() != ErrorCode.EC_200.code()) {\n+          return new ResponseEntity<>(errorBean, HttpStatus.BAD_REQUEST);\n+        }\n+      } else {\n+        return new ResponseEntity<>(errorBean, HttpStatus.BAD_REQUEST);\n+      }\n+    } catch (Exception e) {\n+      logger.error(\"StudiesController - SendNotification() : error\", e);\n+      errorBean = new ErrorBean(ErrorCode.EC_500.code(), ErrorCode.EC_500.errorMessage());\n+      return new ResponseEntity<>(errorBean, HttpStatus.BAD_REQUEST);\n+    }\n+    logger.error(\"StudiesController - SendNotification() : ends\");", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NDQ2NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402494464", "bodyText": "please address this issue", "author": "zohrehj", "createdAt": "2020-04-02T17:38:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzNjMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzNzcxNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400337714", "bodyText": "nit: rename to androidJsonArray for consistency.", "author": "zohrehj", "createdAt": "2020-03-30T16:43:14Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/AuthInfoBODaoImpl.java", "diffHunk": "@@ -37,4 +42,37 @@ public AuthInfoBO save(AuthInfoBO authInfo) throws SystemException {\n       }\n     } else return null;\n   }\n+\n+  @Override\n+  public Map<String, JSONArray> getDeviceTokenOfAllUsers(List<Integer> appIds) {\n+    logger.info(\"AuthInfoBODaoImpl.getDeviceTokenOfAllUsers()-Start\");\n+    JSONArray jsonArray = null;\n+    JSONArray iosJsonArray = null;\n+    Map<String, JSONArray> deviceMap = new HashMap<>();\n+    try {\n+      List<AuthInfoBO> authInfos = authInfoRepository.findDevicesTokens(appIds);\n+      System.out.println(authInfos);\n+      if (authInfos != null && !authInfos.isEmpty()) {\n+        jsonArray = new JSONArray();", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNzY0Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402417647", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzNzcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzODMzNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400338337", "bodyText": "how do we handle other devices? should there be a log or exception in that case?", "author": "zohrehj", "createdAt": "2020-03-30T16:44:07Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/AuthInfoBODaoImpl.java", "diffHunk": "@@ -37,4 +42,37 @@ public AuthInfoBO save(AuthInfoBO authInfo) throws SystemException {\n       }\n     } else return null;\n   }\n+\n+  @Override\n+  public Map<String, JSONArray> getDeviceTokenOfAllUsers(List<Integer> appIds) {\n+    logger.info(\"AuthInfoBODaoImpl.getDeviceTokenOfAllUsers()-Start\");\n+    JSONArray jsonArray = null;\n+    JSONArray iosJsonArray = null;\n+    Map<String, JSONArray> deviceMap = new HashMap<>();\n+    try {\n+      List<AuthInfoBO> authInfos = authInfoRepository.findDevicesTokens(appIds);\n+      System.out.println(authInfos);\n+      if (authInfos != null && !authInfos.isEmpty()) {\n+        jsonArray = new JSONArray();\n+        iosJsonArray = new JSONArray();\n+        for (AuthInfoBO authInfoBO : authInfos) {\n+          String devicetoken = authInfoBO.getDeviceToken();\n+          String devicetype = authInfoBO.getDeviceType();\n+          if (devicetoken != null && devicetype != null) {\n+            if (devicetype.equalsIgnoreCase(AppConstants.DEVICE_ANDROID)) {\n+              jsonArray.put(devicetoken.trim());\n+            } else if (devicetype.equalsIgnoreCase(AppConstants.DEVICE_IOS)) {\n+              iosJsonArray.put(devicetoken.trim());\n+            }", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NTgwNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402495806", "bodyText": "not addressed.", "author": "zohrehj", "createdAt": "2020-04-02T17:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzODMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzOTQ0MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400339441", "bodyText": "nit: please rename to something more readable, e.g. studyInfoSet", "author": "zohrehj", "createdAt": "2020-03-30T16:45:46Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/CommonDao.java", "diffHunk": "@@ -17,4 +23,13 @@\n   public AppOrgInfoBean getUserAppDetailsByAllApi(String userId, String appId, String orgId);\n \n   public Integer getUserInfoDetails(String userId);\n+\n+  public List<AppInfoDetailsBO> getAppInfoIds(HashSet<String> appIds);\n+\n+  public List<StudyInfoBO> getStudyInfoIds(HashSet<String> studySetSet);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNzc3Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402417776", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzOTQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzOTg1Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400339857", "bodyText": "logger.error?", "author": "zohrehj", "createdAt": "2020-03-30T16:46:24Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/CommonDaoImpl.java", "diffHunk": "@@ -203,4 +210,145 @@ public Integer getUserInfoDetails(String userId) {\n     logger.info(\"CommonDaoImpl getUserInfoDetails() - Ends \");\n     return userDetailsId;\n   }\n+\n+  @Override\n+  public List<AppInfoDetailsBO> getAppInfoIds(HashSet<String> appIds) {\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - starts \");\n+    List<AppInfoDetailsBO> appInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      appInfos =\n+          session\n+              .createQuery(\"From AppInfoDetailsBO where appId in :appIds\")\n+              .setParameterList(\"appIds\", appIds)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getAppInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - ends \");\n+\n+    return appInfos;\n+  }\n+\n+  @Override\n+  public List<StudyInfoBO> getStudyInfoIds(HashSet<String> studyIdSet) {\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - starts \");\n+    List<StudyInfoBO> studyInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      studyInfos =\n+          session\n+              .createQuery(\"From StudyInfoBO where customId in :studyIdSet\")\n+              .setParameterList(\"studyIdSet\", studyIdSet)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getStudyInfoIds() - error \", e);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNzkyMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402417922", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:47:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzOTg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0MDg5Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400340892", "bodyText": "nit: CommonDaoImpl.getStudyLevelDeviceToken() - Start", "author": "zohrehj", "createdAt": "2020-03-30T16:47:57Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/CommonDaoImpl.java", "diffHunk": "@@ -203,4 +210,145 @@ public Integer getUserInfoDetails(String userId) {\n     logger.info(\"CommonDaoImpl getUserInfoDetails() - Ends \");\n     return userDetailsId;\n   }\n+\n+  @Override\n+  public List<AppInfoDetailsBO> getAppInfoIds(HashSet<String> appIds) {\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - starts \");\n+    List<AppInfoDetailsBO> appInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      appInfos =\n+          session\n+              .createQuery(\"From AppInfoDetailsBO where appId in :appIds\")\n+              .setParameterList(\"appIds\", appIds)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getAppInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - ends \");\n+\n+    return appInfos;\n+  }\n+\n+  @Override\n+  public List<StudyInfoBO> getStudyInfoIds(HashSet<String> studyIdSet) {\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - starts \");\n+    List<StudyInfoBO> studyInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      studyInfos =\n+          session\n+              .createQuery(\"From StudyInfoBO where customId in :studyIdSet\")\n+              .setParameterList(\"studyIdSet\", studyIdSet)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getStudyInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - ends \");\n+\n+    return studyInfos;\n+  }\n+\n+  @Override\n+  public Map<Integer, Map<String, JSONArray>> getStudyLevelDeviceToken(\n+      List<Integer> studyInfoIds, List<Integer> appInfoIds) {\n+    logger.info(\"CommonDaoImpl.getStudyLevelDeviceToken()-Start\");", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0MTQ3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400341475", "bodyText": "please remove", "author": "zohrehj", "createdAt": "2020-03-30T16:48:45Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/CommonDaoImpl.java", "diffHunk": "@@ -203,4 +210,145 @@ public Integer getUserInfoDetails(String userId) {\n     logger.info(\"CommonDaoImpl getUserInfoDetails() - Ends \");\n     return userDetailsId;\n   }\n+\n+  @Override\n+  public List<AppInfoDetailsBO> getAppInfoIds(HashSet<String> appIds) {\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - starts \");\n+    List<AppInfoDetailsBO> appInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      appInfos =\n+          session\n+              .createQuery(\"From AppInfoDetailsBO where appId in :appIds\")\n+              .setParameterList(\"appIds\", appIds)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getAppInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - ends \");\n+\n+    return appInfos;\n+  }\n+\n+  @Override\n+  public List<StudyInfoBO> getStudyInfoIds(HashSet<String> studyIdSet) {\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - starts \");\n+    List<StudyInfoBO> studyInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      studyInfos =\n+          session\n+              .createQuery(\"From StudyInfoBO where customId in :studyIdSet\")\n+              .setParameterList(\"studyIdSet\", studyIdSet)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getStudyInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - ends \");\n+\n+    return studyInfos;\n+  }\n+\n+  @Override\n+  public Map<Integer, Map<String, JSONArray>> getStudyLevelDeviceToken(\n+      List<Integer> studyInfoIds, List<Integer> appInfoIds) {\n+    logger.info(\"CommonDaoImpl.getStudyLevelDeviceToken()-Start\");\n+\n+    Map<Integer, Map<String, JSONArray>> studyDeviceTokenMap = new HashMap<>();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      List<Object[]> rs =\n+          session\n+              .createSQLQuery(\n+                  \"SELECT sp.study_info_id, GROUP_CONCAT(a.device_token) as device_token,GROUP_CONCAT(a.device_type) as device_type FROM participant_study_info sp, auth_info a\\r\\n\"\n+                      + \" where sp.user_details_id = a.user_details_id and sp.status not in('yetToJoin','withdrawn','notEligible') and a.auth_key != '0' and a.remote_notification_flag=1 \\r\\n\"\n+                      + \"and sp.study_info_id in (:studyIds)  and (a.device_token is not NULL and a.device_token != '' and a.device_type is not \\r\\n\"\n+                      + \"NULL and a.device_type != '') GROUP BY sp.study_info_id\")\n+              .setParameterList(\"studyIds\", studyInfoIds)\n+              .getResultList();\n+      System.out.println(rs);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxODA5OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402418099", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0MTQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0MzYzNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400343636", "bodyText": "please remove \\r\\n from query.", "author": "zohrehj", "createdAt": "2020-03-30T16:52:03Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/CommonDaoImpl.java", "diffHunk": "@@ -203,4 +210,145 @@ public Integer getUserInfoDetails(String userId) {\n     logger.info(\"CommonDaoImpl getUserInfoDetails() - Ends \");\n     return userDetailsId;\n   }\n+\n+  @Override\n+  public List<AppInfoDetailsBO> getAppInfoIds(HashSet<String> appIds) {\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - starts \");\n+    List<AppInfoDetailsBO> appInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      appInfos =\n+          session\n+              .createQuery(\"From AppInfoDetailsBO where appId in :appIds\")\n+              .setParameterList(\"appIds\", appIds)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getAppInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - ends \");\n+\n+    return appInfos;\n+  }\n+\n+  @Override\n+  public List<StudyInfoBO> getStudyInfoIds(HashSet<String> studyIdSet) {\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - starts \");\n+    List<StudyInfoBO> studyInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      studyInfos =\n+          session\n+              .createQuery(\"From StudyInfoBO where customId in :studyIdSet\")\n+              .setParameterList(\"studyIdSet\", studyIdSet)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getStudyInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - ends \");\n+\n+    return studyInfos;\n+  }\n+\n+  @Override\n+  public Map<Integer, Map<String, JSONArray>> getStudyLevelDeviceToken(\n+      List<Integer> studyInfoIds, List<Integer> appInfoIds) {\n+    logger.info(\"CommonDaoImpl.getStudyLevelDeviceToken()-Start\");\n+\n+    Map<Integer, Map<String, JSONArray>> studyDeviceTokenMap = new HashMap<>();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      List<Object[]> rs =\n+          session\n+              .createSQLQuery(\n+                  \"SELECT sp.study_info_id, GROUP_CONCAT(a.device_token) as device_token,GROUP_CONCAT(a.device_type) as device_type FROM participant_study_info sp, auth_info a\\r\\n\"\n+                      + \" where sp.user_details_id = a.user_details_id and sp.status not in('yetToJoin','withdrawn','notEligible') and a.auth_key != '0' and a.remote_notification_flag=1 \\r\\n\"\n+                      + \"and sp.study_info_id in (:studyIds)  and (a.device_token is not NULL and a.device_token != '' and a.device_type is not \\r\\n\"", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxODIxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402418216", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:47:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0MzYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NDg0Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400344847", "bodyText": "nit: studyId", "author": "zohrehj", "createdAt": "2020-03-30T16:53:48Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/CommonDaoImpl.java", "diffHunk": "@@ -203,4 +210,145 @@ public Integer getUserInfoDetails(String userId) {\n     logger.info(\"CommonDaoImpl getUserInfoDetails() - Ends \");\n     return userDetailsId;\n   }\n+\n+  @Override\n+  public List<AppInfoDetailsBO> getAppInfoIds(HashSet<String> appIds) {\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - starts \");\n+    List<AppInfoDetailsBO> appInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      appInfos =\n+          session\n+              .createQuery(\"From AppInfoDetailsBO where appId in :appIds\")\n+              .setParameterList(\"appIds\", appIds)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getAppInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - ends \");\n+\n+    return appInfos;\n+  }\n+\n+  @Override\n+  public List<StudyInfoBO> getStudyInfoIds(HashSet<String> studyIdSet) {\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - starts \");\n+    List<StudyInfoBO> studyInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      studyInfos =\n+          session\n+              .createQuery(\"From StudyInfoBO where customId in :studyIdSet\")\n+              .setParameterList(\"studyIdSet\", studyIdSet)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getStudyInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - ends \");\n+\n+    return studyInfos;\n+  }\n+\n+  @Override\n+  public Map<Integer, Map<String, JSONArray>> getStudyLevelDeviceToken(\n+      List<Integer> studyInfoIds, List<Integer> appInfoIds) {\n+    logger.info(\"CommonDaoImpl.getStudyLevelDeviceToken()-Start\");\n+\n+    Map<Integer, Map<String, JSONArray>> studyDeviceTokenMap = new HashMap<>();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      List<Object[]> rs =\n+          session\n+              .createSQLQuery(\n+                  \"SELECT sp.study_info_id, GROUP_CONCAT(a.device_token) as device_token,GROUP_CONCAT(a.device_type) as device_type FROM participant_study_info sp, auth_info a\\r\\n\"\n+                      + \" where sp.user_details_id = a.user_details_id and sp.status not in('yetToJoin','withdrawn','notEligible') and a.auth_key != '0' and a.remote_notification_flag=1 \\r\\n\"\n+                      + \"and sp.study_info_id in (:studyIds)  and (a.device_token is not NULL and a.device_token != '' and a.device_type is not \\r\\n\"\n+                      + \"NULL and a.device_type != '') GROUP BY sp.study_info_id\")\n+              .setParameterList(\"studyIds\", studyInfoIds)\n+              .getResultList();\n+      System.out.println(rs);\n+      if (rs != null) {\n+        for (Object[] objects : rs) {\n+\n+          Integer studyid = (Integer) objects[0];", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxODMzNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402418334", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NDg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NzE0Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400347142", "bodyText": "please handle the exception case, we need to identify if we are miscategorizing devices or missing new ones", "author": "zohrehj", "createdAt": "2020-03-30T16:57:20Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/CommonDaoImpl.java", "diffHunk": "@@ -203,4 +210,145 @@ public Integer getUserInfoDetails(String userId) {\n     logger.info(\"CommonDaoImpl getUserInfoDetails() - Ends \");\n     return userDetailsId;\n   }\n+\n+  @Override\n+  public List<AppInfoDetailsBO> getAppInfoIds(HashSet<String> appIds) {\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - starts \");\n+    List<AppInfoDetailsBO> appInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      appInfos =\n+          session\n+              .createQuery(\"From AppInfoDetailsBO where appId in :appIds\")\n+              .setParameterList(\"appIds\", appIds)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getAppInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - ends \");\n+\n+    return appInfos;\n+  }\n+\n+  @Override\n+  public List<StudyInfoBO> getStudyInfoIds(HashSet<String> studyIdSet) {\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - starts \");\n+    List<StudyInfoBO> studyInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      studyInfos =\n+          session\n+              .createQuery(\"From StudyInfoBO where customId in :studyIdSet\")\n+              .setParameterList(\"studyIdSet\", studyIdSet)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getStudyInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - ends \");\n+\n+    return studyInfos;\n+  }\n+\n+  @Override\n+  public Map<Integer, Map<String, JSONArray>> getStudyLevelDeviceToken(\n+      List<Integer> studyInfoIds, List<Integer> appInfoIds) {\n+    logger.info(\"CommonDaoImpl.getStudyLevelDeviceToken()-Start\");\n+\n+    Map<Integer, Map<String, JSONArray>> studyDeviceTokenMap = new HashMap<>();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      List<Object[]> rs =\n+          session\n+              .createSQLQuery(\n+                  \"SELECT sp.study_info_id, GROUP_CONCAT(a.device_token) as device_token,GROUP_CONCAT(a.device_type) as device_type FROM participant_study_info sp, auth_info a\\r\\n\"\n+                      + \" where sp.user_details_id = a.user_details_id and sp.status not in('yetToJoin','withdrawn','notEligible') and a.auth_key != '0' and a.remote_notification_flag=1 \\r\\n\"\n+                      + \"and sp.study_info_id in (:studyIds)  and (a.device_token is not NULL and a.device_token != '' and a.device_type is not \\r\\n\"\n+                      + \"NULL and a.device_type != '') GROUP BY sp.study_info_id\")\n+              .setParameterList(\"studyIds\", studyInfoIds)\n+              .getResultList();\n+      System.out.println(rs);\n+      if (rs != null) {\n+        for (Object[] objects : rs) {\n+\n+          Integer studyid = (Integer) objects[0];\n+          String deviceToken = (String) objects[1];\n+          String deviceType = (String) objects[2];\n+          if (deviceToken != null) {\n+            String[] deviceTokens = deviceToken.split(\",\");\n+            String[] deviceTypes = deviceType.split(\",\");\n+\n+            if (((deviceTokens != null && deviceTokens.length > 0)\n+                    && (deviceType != null && deviceTypes.length > 0))\n+                && (deviceTokens.length == deviceTypes.length)) {\n+\n+              JSONArray jsonArray = new JSONArray();\n+              JSONArray iosJsonArray = new JSONArray();\n+              Map<String, JSONArray> deviceMap = new HashMap<>();\n+              for (int i = 0; i < deviceTokens.length; i++) {\n+                if (deviceTypes[i] != null\n+                    && deviceTypes[i].equalsIgnoreCase(AppConstants.DEVICE_ANDROID)) {\n+                  jsonArray.put(deviceTokens[i].trim());\n+                } else if (deviceTypes[i] != null\n+                    && deviceTypes[i].equalsIgnoreCase(AppConstants.DEVICE_IOS)) {\n+                  iosJsonArray.put(deviceTokens[i].trim());\n+                }", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NzQ5NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400347494", "bodyText": "logger.error\nalso missing spaces in comment", "author": "zohrehj", "createdAt": "2020-03-30T16:57:48Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/CommonDaoImpl.java", "diffHunk": "@@ -203,4 +210,145 @@ public Integer getUserInfoDetails(String userId) {\n     logger.info(\"CommonDaoImpl getUserInfoDetails() - Ends \");\n     return userDetailsId;\n   }\n+\n+  @Override\n+  public List<AppInfoDetailsBO> getAppInfoIds(HashSet<String> appIds) {\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - starts \");\n+    List<AppInfoDetailsBO> appInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      appInfos =\n+          session\n+              .createQuery(\"From AppInfoDetailsBO where appId in :appIds\")\n+              .setParameterList(\"appIds\", appIds)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getAppInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getAppInfoIds() - ends \");\n+\n+    return appInfos;\n+  }\n+\n+  @Override\n+  public List<StudyInfoBO> getStudyInfoIds(HashSet<String> studyIdSet) {\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - starts \");\n+    List<StudyInfoBO> studyInfos = new ArrayList();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      studyInfos =\n+          session\n+              .createQuery(\"From StudyInfoBO where customId in :studyIdSet\")\n+              .setParameterList(\"studyIdSet\", studyIdSet)\n+              .getResultList();\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl getStudyInfoIds() - error \", e);\n+    }\n+    logger.info(\"CommonDaoImpl getStudyInfoIds() - ends \");\n+\n+    return studyInfos;\n+  }\n+\n+  @Override\n+  public Map<Integer, Map<String, JSONArray>> getStudyLevelDeviceToken(\n+      List<Integer> studyInfoIds, List<Integer> appInfoIds) {\n+    logger.info(\"CommonDaoImpl.getStudyLevelDeviceToken()-Start\");\n+\n+    Map<Integer, Map<String, JSONArray>> studyDeviceTokenMap = new HashMap<>();\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      List<Object[]> rs =\n+          session\n+              .createSQLQuery(\n+                  \"SELECT sp.study_info_id, GROUP_CONCAT(a.device_token) as device_token,GROUP_CONCAT(a.device_type) as device_type FROM participant_study_info sp, auth_info a\\r\\n\"\n+                      + \" where sp.user_details_id = a.user_details_id and sp.status not in('yetToJoin','withdrawn','notEligible') and a.auth_key != '0' and a.remote_notification_flag=1 \\r\\n\"\n+                      + \"and sp.study_info_id in (:studyIds)  and (a.device_token is not NULL and a.device_token != '' and a.device_type is not \\r\\n\"\n+                      + \"NULL and a.device_type != '') GROUP BY sp.study_info_id\")\n+              .setParameterList(\"studyIds\", studyInfoIds)\n+              .getResultList();\n+      System.out.println(rs);\n+      if (rs != null) {\n+        for (Object[] objects : rs) {\n+\n+          Integer studyid = (Integer) objects[0];\n+          String deviceToken = (String) objects[1];\n+          String deviceType = (String) objects[2];\n+          if (deviceToken != null) {\n+            String[] deviceTokens = deviceToken.split(\",\");\n+            String[] deviceTypes = deviceType.split(\",\");\n+\n+            if (((deviceTokens != null && deviceTokens.length > 0)\n+                    && (deviceType != null && deviceTypes.length > 0))\n+                && (deviceTokens.length == deviceTypes.length)) {\n+\n+              JSONArray jsonArray = new JSONArray();\n+              JSONArray iosJsonArray = new JSONArray();\n+              Map<String, JSONArray> deviceMap = new HashMap<>();\n+              for (int i = 0; i < deviceTokens.length; i++) {\n+                if (deviceTypes[i] != null\n+                    && deviceTypes[i].equalsIgnoreCase(AppConstants.DEVICE_ANDROID)) {\n+                  jsonArray.put(deviceTokens[i].trim());\n+                } else if (deviceTypes[i] != null\n+                    && deviceTypes[i].equalsIgnoreCase(AppConstants.DEVICE_IOS)) {\n+                  iosJsonArray.put(deviceTokens[i].trim());\n+                }\n+              }\n+              deviceMap.put(AppConstants.DEVICE_ANDROID, jsonArray);\n+              deviceMap.put(AppConstants.DEVICE_IOS, iosJsonArray);\n+\n+              studyDeviceTokenMap.put(studyid, deviceMap);\n+            }\n+          }\n+        }\n+      }\n+\n+    } catch (Exception e) {\n+      logger.info(\"CommonDaoImpl.getStudyLevelDeviceToken()-error \", e);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxODUwMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402418500", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NzQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0OTA5NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400349095", "bodyText": "why do we need to store this?", "author": "zohrehj", "createdAt": "2020-03-30T17:00:12Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/model/AppInfoDetailsBO.java", "diffHunk": "@@ -53,7 +53,7 @@\n   @Column(name = \"android_bundle_id\")\n   private String androidBundleId;\n \n-  @Column(name = \"ios_certificate\")\n+  @Column(name = \"ios_certificate\", columnDefinition = \"VARCHAR(5000)\")", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxOTQ4NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402419485", "bodyText": "we are storing base64 value of IOS certificate, which will be required  for sending push notification to IOS deveices", "author": "aswinijena100", "createdAt": "2020-04-02T15:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0OTA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1MjM5Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400352396", "bodyText": "please reverse this change. Previous format was correct.", "author": "zohrehj", "createdAt": "2020-03-30T17:05:37Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudiesServicesImpl.java", "diffHunk": "@@ -1,21 +1,45 @@\n /*\n- * Copyright 2020 Google LLC\n+ *Copyright 2020 Google LLC\n  *\n- * Use of this source code is governed by an MIT-style\n- * license that can be found in the LICENSE file or at\n- * https://opensource.org/licenses/MIT.\n+ *Use of this source code is governed by an MIT-style license that can be found in the LICENSE file", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxOTU5NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402419594", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1MjM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5Mjk0OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400392948", "bodyText": "please remove client ID from logs", "author": "zohrehj", "createdAt": "2020-03-30T18:09:35Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/CommonServiceImpl.java", "diffHunk": "@@ -120,4 +125,44 @@ public ActivityLog createActivityLog(String userId, String activityName, String\n     logger.info(\"CommonServiceImpl createActivityLog() - ends\");\n     return activityLog;\n   }\n+\n+  @Override\n+  public boolean validateServerClientCredentials(String clientId, String clientSecret)\n+      throws SystemException, UnAuthorizedRequestException, InvalidRequestException {\n+\n+    HttpHeaders headers = null;\n+    HttpEntity<BodyForProvider> requestBody = null;\n+    ResponseEntity<?> responseEntity = null;\n+    try {\n+      headers = new HttpHeaders();\n+      headers.setContentType(MediaType.APPLICATION_JSON);\n+      headers.set(AppConstants.CLIENT_ID, clientId);\n+      headers.set(AppConstants.SECRET_KEY, clientSecret);\n+      requestBody = new HttpEntity<>(null, headers);\n+      logger.debug(\"CommonServiceImpl validateServerClientCredentials() Begin\");\n+      responseEntity =\n+          restTemplate.exchange(\n+              appConfig.getAuthServerClientValidationUrl(),\n+              HttpMethod.POST,\n+              requestBody,\n+              String.class);\n+      HttpStatus status = responseEntity.getStatusCode();\n+      if (status == HttpStatus.OK) {\n+        return true;\n+      }\n+    } catch (RestClientResponseException e) {\n+\n+      if (e.getRawStatusCode() == 401) {\n+        logger.error(\"Invalid client Id or client secret. Client id is: \" + clientId);\n+        throw new UnAuthorizedRequestException();\n+      } else if (e.getRawStatusCode() == 400) {\n+        logger.error(\"Client verification ended with Bad Request\");\n+        throw new InvalidRequestException();\n+      } else {\n+        throw new SystemException();\n+      }\n+    }\n+    logger.error(\"Invalid client Id or client secret. Client id is: \" + clientId);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxOTc0MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402419741", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:49:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5Mjk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5MzIxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400393216", "bodyText": "please do not log client id", "author": "zohrehj", "createdAt": "2020-03-30T18:10:04Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/CommonServiceImpl.java", "diffHunk": "@@ -120,4 +125,44 @@ public ActivityLog createActivityLog(String userId, String activityName, String\n     logger.info(\"CommonServiceImpl createActivityLog() - ends\");\n     return activityLog;\n   }\n+\n+  @Override\n+  public boolean validateServerClientCredentials(String clientId, String clientSecret)\n+      throws SystemException, UnAuthorizedRequestException, InvalidRequestException {\n+\n+    HttpHeaders headers = null;\n+    HttpEntity<BodyForProvider> requestBody = null;\n+    ResponseEntity<?> responseEntity = null;\n+    try {\n+      headers = new HttpHeaders();\n+      headers.setContentType(MediaType.APPLICATION_JSON);\n+      headers.set(AppConstants.CLIENT_ID, clientId);\n+      headers.set(AppConstants.SECRET_KEY, clientSecret);\n+      requestBody = new HttpEntity<>(null, headers);\n+      logger.debug(\"CommonServiceImpl validateServerClientCredentials() Begin\");\n+      responseEntity =\n+          restTemplate.exchange(\n+              appConfig.getAuthServerClientValidationUrl(),\n+              HttpMethod.POST,\n+              requestBody,\n+              String.class);\n+      HttpStatus status = responseEntity.getStatusCode();\n+      if (status == HttpStatus.OK) {\n+        return true;\n+      }\n+    } catch (RestClientResponseException e) {\n+\n+      if (e.getRawStatusCode() == 401) {\n+        logger.error(\"Invalid client Id or client secret. Client id is: \" + clientId);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5NDgwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400394805", "bodyText": "please add a comment explaining why this is needed.", "author": "zohrehj", "createdAt": "2020-03-30T18:12:41Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudiesServicesImpl.java", "diffHunk": "@@ -37,4 +67,259 @@ public ErrorBean saveStudyMetadata(StudyMetadataBean studyMetadataBean) {\n     logger.info(\"StudiesServicesImpl - saveStudyMetadata() : ends\");\n     return errorBean;\n   }\n+\n+  @SuppressWarnings(\"unlikely-arg-type\")", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyMDI4NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402420285", "bodyText": "This was not required , hence removed", "author": "aswinijena100", "createdAt": "2020-04-02T15:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5NDgwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5NTUyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400395529", "bodyText": "nit: previous format was: StudiesServicesImpl.SendNotificationAction() - Starts", "author": "zohrehj", "createdAt": "2020-03-30T18:13:48Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudiesServicesImpl.java", "diffHunk": "@@ -37,4 +67,259 @@ public ErrorBean saveStudyMetadata(StudyMetadataBean studyMetadataBean) {\n     logger.info(\"StudiesServicesImpl - saveStudyMetadata() : ends\");\n     return errorBean;\n   }\n+\n+  @SuppressWarnings(\"unlikely-arg-type\")\n+  @Override\n+  public ErrorBean SendNotificationAction(NotificationForm notificationForm) {\n+    HashSet<String> studySet = new HashSet<>();\n+    HashSet<String> appSet = new HashSet<>();\n+    Map<Integer, Map<String, JSONArray>> studiesMap = null;\n+    ErrorBean errorBean = null;\n+    List<Integer> studyInfoIds = new ArrayList<Integer>();\n+    Map<Object, StudyInfoBO> studyInfobyStudyCustomId = new HashMap<>();\n+    Map<String, JSONArray> allDeviceTokens = new HashMap<>();\n+    List<Integer> appInfoIds = new ArrayList<>();\n+    Map<Object, AppInfoDetailsBO> appInfobyAppCustomId = new HashMap<>();\n+    logger.info(\"StudiesServicesImpl - SendNotificationAction() : starts\");", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyMDM1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402420353", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:50:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5NTUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5Nzg1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400397856", "bodyText": "this code is very complicated and hard to follow; it is not clear if all cases are covered.\nMoving the code into smaller functions or even simplifying some of the condition combinations into variable or methods might improve the readability of this block.", "author": "zohrehj", "createdAt": "2020-03-30T18:17:39Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudiesServicesImpl.java", "diffHunk": "@@ -37,4 +67,259 @@ public ErrorBean saveStudyMetadata(StudyMetadataBean studyMetadataBean) {\n     logger.info(\"StudiesServicesImpl - saveStudyMetadata() : ends\");\n     return errorBean;\n   }\n+\n+  @SuppressWarnings(\"unlikely-arg-type\")\n+  @Override\n+  public ErrorBean SendNotificationAction(NotificationForm notificationForm) {\n+    HashSet<String> studySet = new HashSet<>();\n+    HashSet<String> appSet = new HashSet<>();\n+    Map<Integer, Map<String, JSONArray>> studiesMap = null;\n+    ErrorBean errorBean = null;\n+    List<Integer> studyInfoIds = new ArrayList<Integer>();\n+    Map<Object, StudyInfoBO> studyInfobyStudyCustomId = new HashMap<>();\n+    Map<String, JSONArray> allDeviceTokens = new HashMap<>();\n+    List<Integer> appInfoIds = new ArrayList<>();\n+    Map<Object, AppInfoDetailsBO> appInfobyAppCustomId = new HashMap<>();\n+    logger.info(\"StudiesServicesImpl - SendNotificationAction() : starts\");\n+    try {\n+\n+      for (NotificationBean notificationBean : notificationForm.getNotifications()) {", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyMDUwMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402420500", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:50:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5Nzg1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5ODczMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400398733", "bodyText": "how about:\nif (notificationBean.getNotificationType().equalsIgnoreCase(AppConstants.STUDY_LEVEL)) {\n  studySet.add(notificationBean.getCustomStudyId());\n}\nappSet.add(notificationBean.getAppId());", "author": "zohrehj", "createdAt": "2020-03-30T18:19:09Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudiesServicesImpl.java", "diffHunk": "@@ -37,4 +67,259 @@ public ErrorBean saveStudyMetadata(StudyMetadataBean studyMetadataBean) {\n     logger.info(\"StudiesServicesImpl - saveStudyMetadata() : ends\");\n     return errorBean;\n   }\n+\n+  @SuppressWarnings(\"unlikely-arg-type\")\n+  @Override\n+  public ErrorBean SendNotificationAction(NotificationForm notificationForm) {\n+    HashSet<String> studySet = new HashSet<>();\n+    HashSet<String> appSet = new HashSet<>();\n+    Map<Integer, Map<String, JSONArray>> studiesMap = null;\n+    ErrorBean errorBean = null;\n+    List<Integer> studyInfoIds = new ArrayList<Integer>();\n+    Map<Object, StudyInfoBO> studyInfobyStudyCustomId = new HashMap<>();\n+    Map<String, JSONArray> allDeviceTokens = new HashMap<>();\n+    List<Integer> appInfoIds = new ArrayList<>();\n+    Map<Object, AppInfoDetailsBO> appInfobyAppCustomId = new HashMap<>();\n+    logger.info(\"StudiesServicesImpl - SendNotificationAction() : starts\");\n+    try {\n+\n+      for (NotificationBean notificationBean : notificationForm.getNotifications()) {\n+        if (notificationBean.getNotificationType().equalsIgnoreCase(AppConstants.STUDY_LEVEL)) {\n+          studySet.add(notificationBean.getCustomStudyId());\n+          appSet.add(notificationBean.getAppId());\n+        } else {\n+          appSet.add(notificationBean.getAppId());\n+        }", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyMDYzMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402420630", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5ODczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5OTk1NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400399954", "bodyText": "using early exits can reduce the nesting and improve code readability, e.g.\nif (appSet == null || appSet.isEmpty()) {\n   return new ErrorBean(ErrorCode.EC_400.code(), ErrorCode.EC_400.errorMessage());\n}\n....", "author": "zohrehj", "createdAt": "2020-03-30T18:21:23Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudiesServicesImpl.java", "diffHunk": "@@ -37,4 +67,259 @@ public ErrorBean saveStudyMetadata(StudyMetadataBean studyMetadataBean) {\n     logger.info(\"StudiesServicesImpl - saveStudyMetadata() : ends\");\n     return errorBean;\n   }\n+\n+  @SuppressWarnings(\"unlikely-arg-type\")\n+  @Override\n+  public ErrorBean SendNotificationAction(NotificationForm notificationForm) {\n+    HashSet<String> studySet = new HashSet<>();\n+    HashSet<String> appSet = new HashSet<>();\n+    Map<Integer, Map<String, JSONArray>> studiesMap = null;\n+    ErrorBean errorBean = null;\n+    List<Integer> studyInfoIds = new ArrayList<Integer>();\n+    Map<Object, StudyInfoBO> studyInfobyStudyCustomId = new HashMap<>();\n+    Map<String, JSONArray> allDeviceTokens = new HashMap<>();\n+    List<Integer> appInfoIds = new ArrayList<>();\n+    Map<Object, AppInfoDetailsBO> appInfobyAppCustomId = new HashMap<>();\n+    logger.info(\"StudiesServicesImpl - SendNotificationAction() : starts\");\n+    try {\n+\n+      for (NotificationBean notificationBean : notificationForm.getNotifications()) {\n+        if (notificationBean.getNotificationType().equalsIgnoreCase(AppConstants.STUDY_LEVEL)) {\n+          studySet.add(notificationBean.getCustomStudyId());\n+          appSet.add(notificationBean.getAppId());\n+        } else {\n+          appSet.add(notificationBean.getAppId());\n+        }\n+      }\n+      if (appSet != null && !appSet.isEmpty()) {", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyMDg3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402420875", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5OTk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQwNDg4Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400404883", "bodyText": "please remove these across the project", "author": "zohrehj", "createdAt": "2020-03-30T18:29:10Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudiesServicesImpl.java", "diffHunk": "@@ -37,4 +67,259 @@ public ErrorBean saveStudyMetadata(StudyMetadataBean studyMetadataBean) {\n     logger.info(\"StudiesServicesImpl - saveStudyMetadata() : ends\");\n     return errorBean;\n   }\n+\n+  @SuppressWarnings(\"unlikely-arg-type\")\n+  @Override\n+  public ErrorBean SendNotificationAction(NotificationForm notificationForm) {\n+    HashSet<String> studySet = new HashSet<>();\n+    HashSet<String> appSet = new HashSet<>();\n+    Map<Integer, Map<String, JSONArray>> studiesMap = null;\n+    ErrorBean errorBean = null;\n+    List<Integer> studyInfoIds = new ArrayList<Integer>();\n+    Map<Object, StudyInfoBO> studyInfobyStudyCustomId = new HashMap<>();\n+    Map<String, JSONArray> allDeviceTokens = new HashMap<>();\n+    List<Integer> appInfoIds = new ArrayList<>();\n+    Map<Object, AppInfoDetailsBO> appInfobyAppCustomId = new HashMap<>();\n+    logger.info(\"StudiesServicesImpl - SendNotificationAction() : starts\");\n+    try {\n+\n+      for (NotificationBean notificationBean : notificationForm.getNotifications()) {\n+        if (notificationBean.getNotificationType().equalsIgnoreCase(AppConstants.STUDY_LEVEL)) {\n+          studySet.add(notificationBean.getCustomStudyId());\n+          appSet.add(notificationBean.getAppId());\n+        } else {\n+          appSet.add(notificationBean.getAppId());\n+        }\n+      }\n+      if (appSet != null && !appSet.isEmpty()) {\n+        List<AppInfoDetailsBO> appInfos = commonDao.getAppInfoIds(appSet);\n+        if (appInfos != null && !appInfos.isEmpty()) {\n+          appInfoIds =\n+              appInfos.stream().map(a -> a.getAppInfoId()).distinct().collect(Collectors.toList());\n+\n+          appInfobyAppCustomId =\n+              appInfos\n+                  .stream()\n+                  .collect(Collectors.toMap(AppInfoDetailsBO::getAppId, Function.identity()));\n+\n+          if (appInfoIds != null && !appInfoIds.isEmpty()) {\n+            allDeviceTokens = authInfoBODao.getDeviceTokenOfAllUsers(appInfoIds);\n+          }\n+        }\n+        if (studySet != null\n+            && !studySet.isEmpty()\n+            && appInfoIds != null\n+            && !appInfoIds.isEmpty()) {\n+\n+          List<StudyInfoBO> studyInfos = commonDao.getStudyInfoIds(studySet);\n+          if (studyInfos != null && !studyInfos.isEmpty()) {\n+            studyInfoIds =\n+                studyInfos.stream().map(a -> a.getId()).distinct().collect(Collectors.toList());\n+\n+            studyInfobyStudyCustomId =\n+                studyInfos\n+                    .stream()\n+                    .collect(Collectors.toMap(StudyInfoBO::getCustomId, Function.identity()));\n+\n+            if (studyInfoIds != null && !studyInfoIds.isEmpty()) {\n+              studiesMap = commonDao.getStudyLevelDeviceToken(studyInfoIds, appInfoIds);\n+            }\n+          }\n+        }\n+        if ((allDeviceTokens != null && !allDeviceTokens.isEmpty())\n+            || (studiesMap != null && !studiesMap.isEmpty())) {\n+          for (NotificationBean notificationBean : notificationForm.getNotifications()) {\n+            if (notificationBean\n+                .getNotificationType()\n+                .equalsIgnoreCase(AppConstants.GATEWAY_LEVEL)) {\n+\n+              notificationBean.setNotificationType(AppConstants.GATEWAY);\n+              if (allDeviceTokens.get(AppConstants.DEVICE_ANDROID) != null\n+                  && allDeviceTokens.get(AppConstants.DEVICE_ANDROID).length() != 0) {\n+\n+                notificationBean.setDeviceToken(allDeviceTokens.get(AppConstants.DEVICE_ANDROID));\n+                if (notificationBean.getDeviceToken() != null\n+                    && notificationBean.getDeviceToken().length() > 0\n+                    && appInfobyAppCustomId != null\n+                    && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                  pushFCMNotification(\n+                      notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                }\n+              }\n+              if (allDeviceTokens.get(AppConstants.DEVICE_IOS) != null) {\n+\n+                notificationBean.setDeviceToken(allDeviceTokens.get(AppConstants.DEVICE_IOS));\n+                if (notificationBean.getDeviceToken() != null\n+                    && notificationBean.getDeviceToken().length() > 0\n+                    && appInfobyAppCustomId != null\n+                    && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                  pushNotification(\n+                      notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                }\n+              }\n+            } else if (notificationBean\n+                    .getNotificationType()\n+                    .equalsIgnoreCase(AppConstants.STUDY_LEVEL)\n+                && studyInfobyStudyCustomId != null\n+                && studyInfobyStudyCustomId.get(notificationBean.getCustomStudyId()) != null\n+                && studiesMap != null) {\n+              Map<String, JSONArray> deviceTokensMap =\n+                  studiesMap.get(\n+                      studyInfobyStudyCustomId.get(notificationBean.getCustomStudyId()).getId());\n+\n+              notificationBean.setNotificationType(AppConstants.STUDY);\n+              if (deviceTokensMap != null) {\n+                if (deviceTokensMap.get(AppConstants.DEVICE_ANDROID) != null) {\n+\n+                  notificationBean.setDeviceToken(deviceTokensMap.get(AppConstants.DEVICE_ANDROID));\n+                  if (notificationBean.getDeviceToken() != null\n+                      && notificationBean.getDeviceToken().length() > 0\n+                      && appInfobyAppCustomId != null\n+                      && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                    pushFCMNotification(\n+                        notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                  }\n+                }\n+                if (deviceTokensMap.get(AppConstants.DEVICE_IOS) != null) {\n+\n+                  notificationBean.setDeviceToken(deviceTokensMap.get(AppConstants.DEVICE_IOS));\n+                  if (notificationBean.getDeviceToken() != null\n+                      && notificationBean.getDeviceToken().length() > 0\n+                      && appInfobyAppCustomId != null\n+                      && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                    pushNotification(\n+                        notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                  }\n+                }\n+              }\n+            }\n+          }\n+        }\n+      } else {\n+        errorBean = new ErrorBean(ErrorCode.EC_400.code(), ErrorCode.EC_400.errorMessage());\n+        return errorBean;\n+      }\n+      errorBean = new ErrorBean(ErrorCode.EC_200.code(), ErrorCode.EC_200.errorMessage());\n+    } catch (Exception e) {\n+      logger.info(\"StudiesServicesImpl - SendNotificationAction() : error\", e);\n+      errorBean = new ErrorBean(ErrorCode.EC_500.code(), ErrorCode.EC_500.errorMessage());\n+    }\n+    logger.info(\"StudiesServicesImpl - SendNotificationAction() : ends\");\n+    return errorBean;\n+  }\n+  /**\n+   * Andriod push notification\n+   *\n+   * @param notification\n+   */\n+  public void pushFCMNotification(\n+      NotificationBean notification, AppInfoDetailsBO appPropertiesDetails) {\n+    String authKey = \"\";\n+    logger.info(\"StudiesServicesImpl - pushFCMNotification() : starts\");\n+    try {\n+\n+      if (appPropertiesDetails != null) {\n+        authKey = appPropertiesDetails.getAndroidServerKey(); // You FCM AUTH key\n+\n+        URL url = new URL((String) applicationPropertyConfiguration.getApiUrlFcm());\n+        HttpURLConnection conn = (HttpURLConnection) url.openConnection();\n+\n+        conn.setUseCaches(false);\n+        conn.setDoInput(true);\n+        conn.setDoOutput(true);\n+\n+        conn.setRequestMethod(\"POST\");\n+        conn.setRequestProperty(\"Authorization\", \"key=\" + authKey);\n+        conn.setRequestProperty(\"Content-Type\", \"application/json\");\n+\n+        JSONObject json = new JSONObject();\n+\n+        json.put(\"registration_ids\", notification.getDeviceToken());\n+        json.put(\"priority\", \"high\");\n+\n+        JSONObject dataInfo = new JSONObject();\n+        dataInfo.put(\"subtype\", notification.getNotificationSubType());\n+        dataInfo.put(\"type\", notification.getNotificationType());\n+        dataInfo.put(\"title\", notification.getNotificationTitle());\n+        dataInfo.put(\"message\", notification.getNotificationText());\n+        if (notification.getCustomStudyId() != null\n+            && StringUtils.isNotEmpty(notification.getCustomStudyId())) {\n+          dataInfo.put(\"studyId\", notification.getCustomStudyId());\n+        }\n+        json.put(\"data\", dataInfo);\n+        OutputStreamWriter wr = new OutputStreamWriter(conn.getOutputStream());\n+        wr.write(json.toString());\n+        wr.flush();\n+        conn.getInputStream();\n+      }\n+    } catch (Exception e) {\n+      logger.info(\"StudiesServicesImpl - pushFCMNotification() : error\", e);\n+    }\n+    logger.info(\"StudiesServicesImpl - pushFCMNotification() : ends\");\n+  }\n+\n+  public static void pushNotification(\n+      NotificationBean notificationBean, AppInfoDetailsBO appPropertiesDetails) {\n+    logger.info(\"StudiesServicesImpl - pushNotification() : starts\");\n+    String certificatePassword = \"\";\n+    try {\n+      File file = null;\n+      if (appPropertiesDetails != null) {\n+        File root = null;\n+        certificatePassword = appPropertiesDetails.getIosCertificatePassword();\n+        try {\n+          byte[] decodedBytes;\n+          FileOutputStream fop;\n+          decodedBytes =\n+              java.util.Base64.getDecoder()\n+                  .decode(appPropertiesDetails.getIosCertificate().replaceAll(\"\\n\", \"\"));\n+          file = File.createTempFile(\"pushCert_\" + appPropertiesDetails.getAppId(), \".p12\");\n+          System.out.println(file.getAbsolutePath());", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyMDk3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402420975", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQwNDg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQwNTA1NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400405055", "bodyText": "please remove commented code", "author": "zohrehj", "createdAt": "2020-03-30T18:29:26Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudiesServicesImpl.java", "diffHunk": "@@ -37,4 +67,259 @@ public ErrorBean saveStudyMetadata(StudyMetadataBean studyMetadataBean) {\n     logger.info(\"StudiesServicesImpl - saveStudyMetadata() : ends\");\n     return errorBean;\n   }\n+\n+  @SuppressWarnings(\"unlikely-arg-type\")\n+  @Override\n+  public ErrorBean SendNotificationAction(NotificationForm notificationForm) {\n+    HashSet<String> studySet = new HashSet<>();\n+    HashSet<String> appSet = new HashSet<>();\n+    Map<Integer, Map<String, JSONArray>> studiesMap = null;\n+    ErrorBean errorBean = null;\n+    List<Integer> studyInfoIds = new ArrayList<Integer>();\n+    Map<Object, StudyInfoBO> studyInfobyStudyCustomId = new HashMap<>();\n+    Map<String, JSONArray> allDeviceTokens = new HashMap<>();\n+    List<Integer> appInfoIds = new ArrayList<>();\n+    Map<Object, AppInfoDetailsBO> appInfobyAppCustomId = new HashMap<>();\n+    logger.info(\"StudiesServicesImpl - SendNotificationAction() : starts\");\n+    try {\n+\n+      for (NotificationBean notificationBean : notificationForm.getNotifications()) {\n+        if (notificationBean.getNotificationType().equalsIgnoreCase(AppConstants.STUDY_LEVEL)) {\n+          studySet.add(notificationBean.getCustomStudyId());\n+          appSet.add(notificationBean.getAppId());\n+        } else {\n+          appSet.add(notificationBean.getAppId());\n+        }\n+      }\n+      if (appSet != null && !appSet.isEmpty()) {\n+        List<AppInfoDetailsBO> appInfos = commonDao.getAppInfoIds(appSet);\n+        if (appInfos != null && !appInfos.isEmpty()) {\n+          appInfoIds =\n+              appInfos.stream().map(a -> a.getAppInfoId()).distinct().collect(Collectors.toList());\n+\n+          appInfobyAppCustomId =\n+              appInfos\n+                  .stream()\n+                  .collect(Collectors.toMap(AppInfoDetailsBO::getAppId, Function.identity()));\n+\n+          if (appInfoIds != null && !appInfoIds.isEmpty()) {\n+            allDeviceTokens = authInfoBODao.getDeviceTokenOfAllUsers(appInfoIds);\n+          }\n+        }\n+        if (studySet != null\n+            && !studySet.isEmpty()\n+            && appInfoIds != null\n+            && !appInfoIds.isEmpty()) {\n+\n+          List<StudyInfoBO> studyInfos = commonDao.getStudyInfoIds(studySet);\n+          if (studyInfos != null && !studyInfos.isEmpty()) {\n+            studyInfoIds =\n+                studyInfos.stream().map(a -> a.getId()).distinct().collect(Collectors.toList());\n+\n+            studyInfobyStudyCustomId =\n+                studyInfos\n+                    .stream()\n+                    .collect(Collectors.toMap(StudyInfoBO::getCustomId, Function.identity()));\n+\n+            if (studyInfoIds != null && !studyInfoIds.isEmpty()) {\n+              studiesMap = commonDao.getStudyLevelDeviceToken(studyInfoIds, appInfoIds);\n+            }\n+          }\n+        }\n+        if ((allDeviceTokens != null && !allDeviceTokens.isEmpty())\n+            || (studiesMap != null && !studiesMap.isEmpty())) {\n+          for (NotificationBean notificationBean : notificationForm.getNotifications()) {\n+            if (notificationBean\n+                .getNotificationType()\n+                .equalsIgnoreCase(AppConstants.GATEWAY_LEVEL)) {\n+\n+              notificationBean.setNotificationType(AppConstants.GATEWAY);\n+              if (allDeviceTokens.get(AppConstants.DEVICE_ANDROID) != null\n+                  && allDeviceTokens.get(AppConstants.DEVICE_ANDROID).length() != 0) {\n+\n+                notificationBean.setDeviceToken(allDeviceTokens.get(AppConstants.DEVICE_ANDROID));\n+                if (notificationBean.getDeviceToken() != null\n+                    && notificationBean.getDeviceToken().length() > 0\n+                    && appInfobyAppCustomId != null\n+                    && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                  pushFCMNotification(\n+                      notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                }\n+              }\n+              if (allDeviceTokens.get(AppConstants.DEVICE_IOS) != null) {\n+\n+                notificationBean.setDeviceToken(allDeviceTokens.get(AppConstants.DEVICE_IOS));\n+                if (notificationBean.getDeviceToken() != null\n+                    && notificationBean.getDeviceToken().length() > 0\n+                    && appInfobyAppCustomId != null\n+                    && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                  pushNotification(\n+                      notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                }\n+              }\n+            } else if (notificationBean\n+                    .getNotificationType()\n+                    .equalsIgnoreCase(AppConstants.STUDY_LEVEL)\n+                && studyInfobyStudyCustomId != null\n+                && studyInfobyStudyCustomId.get(notificationBean.getCustomStudyId()) != null\n+                && studiesMap != null) {\n+              Map<String, JSONArray> deviceTokensMap =\n+                  studiesMap.get(\n+                      studyInfobyStudyCustomId.get(notificationBean.getCustomStudyId()).getId());\n+\n+              notificationBean.setNotificationType(AppConstants.STUDY);\n+              if (deviceTokensMap != null) {\n+                if (deviceTokensMap.get(AppConstants.DEVICE_ANDROID) != null) {\n+\n+                  notificationBean.setDeviceToken(deviceTokensMap.get(AppConstants.DEVICE_ANDROID));\n+                  if (notificationBean.getDeviceToken() != null\n+                      && notificationBean.getDeviceToken().length() > 0\n+                      && appInfobyAppCustomId != null\n+                      && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                    pushFCMNotification(\n+                        notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                  }\n+                }\n+                if (deviceTokensMap.get(AppConstants.DEVICE_IOS) != null) {\n+\n+                  notificationBean.setDeviceToken(deviceTokensMap.get(AppConstants.DEVICE_IOS));\n+                  if (notificationBean.getDeviceToken() != null\n+                      && notificationBean.getDeviceToken().length() > 0\n+                      && appInfobyAppCustomId != null\n+                      && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                    pushNotification(\n+                        notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                  }\n+                }\n+              }\n+            }\n+          }\n+        }\n+      } else {\n+        errorBean = new ErrorBean(ErrorCode.EC_400.code(), ErrorCode.EC_400.errorMessage());\n+        return errorBean;\n+      }\n+      errorBean = new ErrorBean(ErrorCode.EC_200.code(), ErrorCode.EC_200.errorMessage());\n+    } catch (Exception e) {\n+      logger.info(\"StudiesServicesImpl - SendNotificationAction() : error\", e);\n+      errorBean = new ErrorBean(ErrorCode.EC_500.code(), ErrorCode.EC_500.errorMessage());\n+    }\n+    logger.info(\"StudiesServicesImpl - SendNotificationAction() : ends\");\n+    return errorBean;\n+  }\n+  /**\n+   * Andriod push notification\n+   *\n+   * @param notification\n+   */\n+  public void pushFCMNotification(\n+      NotificationBean notification, AppInfoDetailsBO appPropertiesDetails) {\n+    String authKey = \"\";\n+    logger.info(\"StudiesServicesImpl - pushFCMNotification() : starts\");\n+    try {\n+\n+      if (appPropertiesDetails != null) {\n+        authKey = appPropertiesDetails.getAndroidServerKey(); // You FCM AUTH key\n+\n+        URL url = new URL((String) applicationPropertyConfiguration.getApiUrlFcm());\n+        HttpURLConnection conn = (HttpURLConnection) url.openConnection();\n+\n+        conn.setUseCaches(false);\n+        conn.setDoInput(true);\n+        conn.setDoOutput(true);\n+\n+        conn.setRequestMethod(\"POST\");\n+        conn.setRequestProperty(\"Authorization\", \"key=\" + authKey);\n+        conn.setRequestProperty(\"Content-Type\", \"application/json\");\n+\n+        JSONObject json = new JSONObject();\n+\n+        json.put(\"registration_ids\", notification.getDeviceToken());\n+        json.put(\"priority\", \"high\");\n+\n+        JSONObject dataInfo = new JSONObject();\n+        dataInfo.put(\"subtype\", notification.getNotificationSubType());\n+        dataInfo.put(\"type\", notification.getNotificationType());\n+        dataInfo.put(\"title\", notification.getNotificationTitle());\n+        dataInfo.put(\"message\", notification.getNotificationText());\n+        if (notification.getCustomStudyId() != null\n+            && StringUtils.isNotEmpty(notification.getCustomStudyId())) {\n+          dataInfo.put(\"studyId\", notification.getCustomStudyId());\n+        }\n+        json.put(\"data\", dataInfo);\n+        OutputStreamWriter wr = new OutputStreamWriter(conn.getOutputStream());\n+        wr.write(json.toString());\n+        wr.flush();\n+        conn.getInputStream();\n+      }\n+    } catch (Exception e) {\n+      logger.info(\"StudiesServicesImpl - pushFCMNotification() : error\", e);\n+    }\n+    logger.info(\"StudiesServicesImpl - pushFCMNotification() : ends\");\n+  }\n+\n+  public static void pushNotification(\n+      NotificationBean notificationBean, AppInfoDetailsBO appPropertiesDetails) {\n+    logger.info(\"StudiesServicesImpl - pushNotification() : starts\");\n+    String certificatePassword = \"\";\n+    try {\n+      File file = null;\n+      if (appPropertiesDetails != null) {\n+        File root = null;\n+        certificatePassword = appPropertiesDetails.getIosCertificatePassword();\n+        try {\n+          byte[] decodedBytes;\n+          FileOutputStream fop;\n+          decodedBytes =\n+              java.util.Base64.getDecoder()\n+                  .decode(appPropertiesDetails.getIosCertificate().replaceAll(\"\\n\", \"\"));\n+          file = File.createTempFile(\"pushCert_\" + appPropertiesDetails.getAppId(), \".p12\");\n+          System.out.println(file.getAbsolutePath());\n+          fop = new FileOutputStream(file);\n+          fop.write(decodedBytes);\n+          fop.flush();\n+          fop.close();\n+          file.deleteOnExit();\n+        } catch (Exception e) {\n+          logger.error(\"FdahpUserRegWSController pushNotificationCertCreation:\", e);\n+        }\n+        ApnsService service = null;\n+        if (file != null) {\n+          service =\n+              APNS.newService()\n+                  .withCert(file.getPath(), certificatePassword)\n+                  .withProductionDestination()\n+                  .build();\n+          // for Production with production certificate\n+          /* service =\n+          APNS.newService()\n+              .withCert(file.getPath(), certificatePassword)\n+              .withSandboxDestination()\n+              .build();*/\n+          // for Test and UAT with dev certificate", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyMTE0Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402421143", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:51:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQwNTA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQwNTY3MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400405670", "bodyText": "can this be turned into an early exit? e.g.\n if (notificationBean.getDeviceToken() == null) return;", "author": "zohrehj", "createdAt": "2020-03-30T18:30:30Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudiesServicesImpl.java", "diffHunk": "@@ -37,4 +67,259 @@ public ErrorBean saveStudyMetadata(StudyMetadataBean studyMetadataBean) {\n     logger.info(\"StudiesServicesImpl - saveStudyMetadata() : ends\");\n     return errorBean;\n   }\n+\n+  @SuppressWarnings(\"unlikely-arg-type\")\n+  @Override\n+  public ErrorBean SendNotificationAction(NotificationForm notificationForm) {\n+    HashSet<String> studySet = new HashSet<>();\n+    HashSet<String> appSet = new HashSet<>();\n+    Map<Integer, Map<String, JSONArray>> studiesMap = null;\n+    ErrorBean errorBean = null;\n+    List<Integer> studyInfoIds = new ArrayList<Integer>();\n+    Map<Object, StudyInfoBO> studyInfobyStudyCustomId = new HashMap<>();\n+    Map<String, JSONArray> allDeviceTokens = new HashMap<>();\n+    List<Integer> appInfoIds = new ArrayList<>();\n+    Map<Object, AppInfoDetailsBO> appInfobyAppCustomId = new HashMap<>();\n+    logger.info(\"StudiesServicesImpl - SendNotificationAction() : starts\");\n+    try {\n+\n+      for (NotificationBean notificationBean : notificationForm.getNotifications()) {\n+        if (notificationBean.getNotificationType().equalsIgnoreCase(AppConstants.STUDY_LEVEL)) {\n+          studySet.add(notificationBean.getCustomStudyId());\n+          appSet.add(notificationBean.getAppId());\n+        } else {\n+          appSet.add(notificationBean.getAppId());\n+        }\n+      }\n+      if (appSet != null && !appSet.isEmpty()) {\n+        List<AppInfoDetailsBO> appInfos = commonDao.getAppInfoIds(appSet);\n+        if (appInfos != null && !appInfos.isEmpty()) {\n+          appInfoIds =\n+              appInfos.stream().map(a -> a.getAppInfoId()).distinct().collect(Collectors.toList());\n+\n+          appInfobyAppCustomId =\n+              appInfos\n+                  .stream()\n+                  .collect(Collectors.toMap(AppInfoDetailsBO::getAppId, Function.identity()));\n+\n+          if (appInfoIds != null && !appInfoIds.isEmpty()) {\n+            allDeviceTokens = authInfoBODao.getDeviceTokenOfAllUsers(appInfoIds);\n+          }\n+        }\n+        if (studySet != null\n+            && !studySet.isEmpty()\n+            && appInfoIds != null\n+            && !appInfoIds.isEmpty()) {\n+\n+          List<StudyInfoBO> studyInfos = commonDao.getStudyInfoIds(studySet);\n+          if (studyInfos != null && !studyInfos.isEmpty()) {\n+            studyInfoIds =\n+                studyInfos.stream().map(a -> a.getId()).distinct().collect(Collectors.toList());\n+\n+            studyInfobyStudyCustomId =\n+                studyInfos\n+                    .stream()\n+                    .collect(Collectors.toMap(StudyInfoBO::getCustomId, Function.identity()));\n+\n+            if (studyInfoIds != null && !studyInfoIds.isEmpty()) {\n+              studiesMap = commonDao.getStudyLevelDeviceToken(studyInfoIds, appInfoIds);\n+            }\n+          }\n+        }\n+        if ((allDeviceTokens != null && !allDeviceTokens.isEmpty())\n+            || (studiesMap != null && !studiesMap.isEmpty())) {\n+          for (NotificationBean notificationBean : notificationForm.getNotifications()) {\n+            if (notificationBean\n+                .getNotificationType()\n+                .equalsIgnoreCase(AppConstants.GATEWAY_LEVEL)) {\n+\n+              notificationBean.setNotificationType(AppConstants.GATEWAY);\n+              if (allDeviceTokens.get(AppConstants.DEVICE_ANDROID) != null\n+                  && allDeviceTokens.get(AppConstants.DEVICE_ANDROID).length() != 0) {\n+\n+                notificationBean.setDeviceToken(allDeviceTokens.get(AppConstants.DEVICE_ANDROID));\n+                if (notificationBean.getDeviceToken() != null\n+                    && notificationBean.getDeviceToken().length() > 0\n+                    && appInfobyAppCustomId != null\n+                    && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                  pushFCMNotification(\n+                      notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                }\n+              }\n+              if (allDeviceTokens.get(AppConstants.DEVICE_IOS) != null) {\n+\n+                notificationBean.setDeviceToken(allDeviceTokens.get(AppConstants.DEVICE_IOS));\n+                if (notificationBean.getDeviceToken() != null\n+                    && notificationBean.getDeviceToken().length() > 0\n+                    && appInfobyAppCustomId != null\n+                    && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                  pushNotification(\n+                      notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                }\n+              }\n+            } else if (notificationBean\n+                    .getNotificationType()\n+                    .equalsIgnoreCase(AppConstants.STUDY_LEVEL)\n+                && studyInfobyStudyCustomId != null\n+                && studyInfobyStudyCustomId.get(notificationBean.getCustomStudyId()) != null\n+                && studiesMap != null) {\n+              Map<String, JSONArray> deviceTokensMap =\n+                  studiesMap.get(\n+                      studyInfobyStudyCustomId.get(notificationBean.getCustomStudyId()).getId());\n+\n+              notificationBean.setNotificationType(AppConstants.STUDY);\n+              if (deviceTokensMap != null) {\n+                if (deviceTokensMap.get(AppConstants.DEVICE_ANDROID) != null) {\n+\n+                  notificationBean.setDeviceToken(deviceTokensMap.get(AppConstants.DEVICE_ANDROID));\n+                  if (notificationBean.getDeviceToken() != null\n+                      && notificationBean.getDeviceToken().length() > 0\n+                      && appInfobyAppCustomId != null\n+                      && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                    pushFCMNotification(\n+                        notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                  }\n+                }\n+                if (deviceTokensMap.get(AppConstants.DEVICE_IOS) != null) {\n+\n+                  notificationBean.setDeviceToken(deviceTokensMap.get(AppConstants.DEVICE_IOS));\n+                  if (notificationBean.getDeviceToken() != null\n+                      && notificationBean.getDeviceToken().length() > 0\n+                      && appInfobyAppCustomId != null\n+                      && appInfobyAppCustomId.get(notificationBean.getAppId()) != null) {\n+                    pushNotification(\n+                        notificationBean, appInfobyAppCustomId.get(notificationBean.getAppId()));\n+                  }\n+                }\n+              }\n+            }\n+          }\n+        }\n+      } else {\n+        errorBean = new ErrorBean(ErrorCode.EC_400.code(), ErrorCode.EC_400.errorMessage());\n+        return errorBean;\n+      }\n+      errorBean = new ErrorBean(ErrorCode.EC_200.code(), ErrorCode.EC_200.errorMessage());\n+    } catch (Exception e) {\n+      logger.info(\"StudiesServicesImpl - SendNotificationAction() : error\", e);\n+      errorBean = new ErrorBean(ErrorCode.EC_500.code(), ErrorCode.EC_500.errorMessage());\n+    }\n+    logger.info(\"StudiesServicesImpl - SendNotificationAction() : ends\");\n+    return errorBean;\n+  }\n+  /**\n+   * Andriod push notification\n+   *\n+   * @param notification\n+   */\n+  public void pushFCMNotification(\n+      NotificationBean notification, AppInfoDetailsBO appPropertiesDetails) {\n+    String authKey = \"\";\n+    logger.info(\"StudiesServicesImpl - pushFCMNotification() : starts\");\n+    try {\n+\n+      if (appPropertiesDetails != null) {\n+        authKey = appPropertiesDetails.getAndroidServerKey(); // You FCM AUTH key\n+\n+        URL url = new URL((String) applicationPropertyConfiguration.getApiUrlFcm());\n+        HttpURLConnection conn = (HttpURLConnection) url.openConnection();\n+\n+        conn.setUseCaches(false);\n+        conn.setDoInput(true);\n+        conn.setDoOutput(true);\n+\n+        conn.setRequestMethod(\"POST\");\n+        conn.setRequestProperty(\"Authorization\", \"key=\" + authKey);\n+        conn.setRequestProperty(\"Content-Type\", \"application/json\");\n+\n+        JSONObject json = new JSONObject();\n+\n+        json.put(\"registration_ids\", notification.getDeviceToken());\n+        json.put(\"priority\", \"high\");\n+\n+        JSONObject dataInfo = new JSONObject();\n+        dataInfo.put(\"subtype\", notification.getNotificationSubType());\n+        dataInfo.put(\"type\", notification.getNotificationType());\n+        dataInfo.put(\"title\", notification.getNotificationTitle());\n+        dataInfo.put(\"message\", notification.getNotificationText());\n+        if (notification.getCustomStudyId() != null\n+            && StringUtils.isNotEmpty(notification.getCustomStudyId())) {\n+          dataInfo.put(\"studyId\", notification.getCustomStudyId());\n+        }\n+        json.put(\"data\", dataInfo);\n+        OutputStreamWriter wr = new OutputStreamWriter(conn.getOutputStream());\n+        wr.write(json.toString());\n+        wr.flush();\n+        conn.getInputStream();\n+      }\n+    } catch (Exception e) {\n+      logger.info(\"StudiesServicesImpl - pushFCMNotification() : error\", e);\n+    }\n+    logger.info(\"StudiesServicesImpl - pushFCMNotification() : ends\");\n+  }\n+\n+  public static void pushNotification(\n+      NotificationBean notificationBean, AppInfoDetailsBO appPropertiesDetails) {\n+    logger.info(\"StudiesServicesImpl - pushNotification() : starts\");\n+    String certificatePassword = \"\";\n+    try {\n+      File file = null;\n+      if (appPropertiesDetails != null) {\n+        File root = null;\n+        certificatePassword = appPropertiesDetails.getIosCertificatePassword();\n+        try {\n+          byte[] decodedBytes;\n+          FileOutputStream fop;\n+          decodedBytes =\n+              java.util.Base64.getDecoder()\n+                  .decode(appPropertiesDetails.getIosCertificate().replaceAll(\"\\n\", \"\"));\n+          file = File.createTempFile(\"pushCert_\" + appPropertiesDetails.getAppId(), \".p12\");\n+          System.out.println(file.getAbsolutePath());\n+          fop = new FileOutputStream(file);\n+          fop.write(decodedBytes);\n+          fop.flush();\n+          fop.close();\n+          file.deleteOnExit();\n+        } catch (Exception e) {\n+          logger.error(\"FdahpUserRegWSController pushNotificationCertCreation:\", e);\n+        }\n+        ApnsService service = null;\n+        if (file != null) {\n+          service =\n+              APNS.newService()\n+                  .withCert(file.getPath(), certificatePassword)\n+                  .withProductionDestination()\n+                  .build();\n+          // for Production with production certificate\n+          /* service =\n+          APNS.newService()\n+              .withCert(file.getPath(), certificatePassword)\n+              .withSandboxDestination()\n+              .build();*/\n+          // for Test and UAT with dev certificate\n+\n+          List<String> tokens = new ArrayList<String>();\n+          if (notificationBean.getDeviceToken() != null) {", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMTg2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402411866", "bodyText": "fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:38:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQwNTY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxMjAwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400412005", "bodyText": "these headers are repeated three times; please extract them into a separate method", "author": "zohrehj", "createdAt": "2020-03-30T18:41:23Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/util/AuthenticationFilter.java", "diffHunk": "@@ -41,70 +43,182 @@ public void doFilter(ServletRequest request, ServletResponse response, FilterCha\n     HttpServletRequest httpServletRequest = (HttpServletRequest) request;\n     HttpServletResponse httpServletResponse = (HttpServletResponse) response;\n     if (request instanceof HttpServletRequest) {\n-      if (!\"OPTIONS\".equalsIgnoreCase(httpServletRequest.getMethod())) {\n-        String userId = httpServletRequest.getHeader(\"userId\");\n-        String accessToken = httpServletRequest.getHeader(\"accessToken\");\n-        String clientToken = httpServletRequest.getHeader(\"clientToken\");\n-\n+      if (!AppConstants.OPTIONS_METHOD.equalsIgnoreCase(httpServletRequest.getMethod())) {\n+        String userId = httpServletRequest.getHeader(AppConstants.KEY_USERID);\n+        String accessToken = httpServletRequest.getHeader(AppConstants.ACCESS_TOKEN);\n+        String clientToken = httpServletRequest.getHeader(AppConstants.CLIENT_TOKEN);\n         Integer value = null;\n+        boolean isValid = false;\n         boolean isInterceptorURL = false;\n-        boolean isInvalidURL = false;\n-        ApplicationPropertyConfiguration applicationConfiguratation =\n+        boolean isServerApiUrl = false;\n+        ApplicationPropertyConfiguration applicationConfiguration =\n             BeanUtil.getBean(ApplicationPropertyConfiguration.class);\n-        String interceptorURL = applicationConfiguratation.getInterceptorUrls();\n+        String interceptorURL = applicationConfiguration.getInterceptorUrls();\n+        String serverApiUrls = applicationConfiguration.getServerApiUrls();\n         String uri = ((HttpServletRequest) request).getRequestURI();\n         String[] list = interceptorURL.split(\",\");\n         for (int i = 0; i < list.length; i++) {\n-          logger.info(list[i]);\n           if (uri.endsWith(list[i].trim())) {\n             isInterceptorURL = true;\n+            break;\n+          }\n+        }\n+        if (!isInterceptorURL) {\n+          String[] listServerApiUrls = serverApiUrls.split(\",\");\n+          for (int i = 0; i < listServerApiUrls.length; i++) {\n+            if (uri.endsWith(listServerApiUrls[i].trim())) {\n+              isServerApiUrl = true;\n+              break;\n+            }\n           }\n         }\n \n         if (isInterceptorURL) {\n-          httpServletResponse.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n-          httpServletResponse.setHeader(\"Access-Control-Allow-Headers\", \"*\");\n-          httpServletResponse.setHeader(\"Access-Control-Allow-Credentials\", \"true\");\n+          httpServletResponse.setHeader(AppConstants.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+          httpServletResponse.setHeader(AppConstants.ACCESS_CONTROL_ALLOW_HEADERS, \"*\");\n           httpServletResponse.setHeader(\n-              \"Access-Control-Allow-Methods\", \"GET, POST, PUT, DELETE, OPTIONS, HEAD\");\n+              AppConstants.ACCESS_CONTROL_ALLOW_CREDENTIALS, AppConstants.TRUE_STR);\n+          httpServletResponse.setHeader(\n+              AppConstants.ACCESS_CONTROL_ALLOW_METHODS, AppConstants.HTTP_METHODS);\n           chain.doFilter(request, response);\n+\n+        } else if (isServerApiUrl) {\n+          String clientId = httpServletRequest.getHeader(AppConstants.CLIENT_ID);\n+          String clientSecret = httpServletRequest.getHeader(AppConstants.SECRET_KEY);\n+          CommonServiceImpl commonService = BeanUtil.getBean(CommonServiceImpl.class);\n+          boolean isAllowed = false;\n+          try {\n+            isAllowed = commonService.validateServerClientCredentials(clientId, clientSecret);\n+            if (isAllowed) {\n+              httpServletResponse.setHeader(AppConstants.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+              httpServletResponse.setHeader(AppConstants.ACCESS_CONTROL_ALLOW_HEADERS, \"*\");\n+              httpServletResponse.setHeader(\n+                  AppConstants.ACCESS_CONTROL_ALLOW_CREDENTIALS, AppConstants.TRUE_STR);\n+\n+              httpServletResponse.setHeader(\n+                  AppConstants.ACCESS_CONTROL_ALLOW_METHODS, AppConstants.HTTP_METHODS);\n+              chain.doFilter(request, response);\n+            } else {\n+              if (response instanceof HttpServletResponse) {\n+                httpServletResponse.setHeader(AppConstants.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+                httpServletResponse.setHeader(AppConstants.ACCESS_CONTROL_ALLOW_HEADERS, \"*\");\n+                httpServletResponse.setHeader(\n+                    AppConstants.ACCESS_CONTROL_ALLOW_CREDENTIALS, AppConstants.TRUE_STR);\n+                httpServletResponse.setHeader(\n+                    AppConstants.ACCESS_CONTROL_ALLOW_METHODS, AppConstants.HTTP_METHODS);\n+                httpServletResponse.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n+\n+                httpServletResponse.sendError(\n+                    HttpServletResponse.SC_UNAUTHORIZED, ErrorCode.EC_718.errorMessage());\n+              }\n+            }\n+          } catch (UnAuthorizedRequestException e) {\n+            httpServletResponse.setHeader(AppConstants.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+            httpServletResponse.setHeader(AppConstants.ACCESS_CONTROL_ALLOW_HEADERS, \"*\");\n+            httpServletResponse.setHeader(\n+                AppConstants.ACCESS_CONTROL_ALLOW_CREDENTIALS, AppConstants.TRUE_STR);\n+            httpServletResponse.setHeader(\n+                AppConstants.ACCESS_CONTROL_ALLOW_METHODS, AppConstants.HTTP_METHODS);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMjA0MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402412041", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxMjAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxMzA0NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400413045", "bodyText": "should be an error", "author": "zohrehj", "createdAt": "2020-03-30T18:43:15Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/util/UserManagementUtil.java", "diffHunk": "@@ -419,4 +425,67 @@ public static Date getCurrentUtilDateTime() {\n     }\n     return date;\n   }\n+\n+  public static String getHashedValue(String input) {\n+    String generatedHash = null;\n+    try {\n+      MessageDigest md = MessageDigest.getInstance(\"SHA-256\");\n+      byte[] bytes = md.digest(input.getBytes());\n+      StringBuilder sb = new StringBuilder();\n+      for (int i = 0; i < bytes.length; i++) {\n+        sb.append(Integer.toString((bytes[i] & 0xff) + 0x100, 16).substring(1));\n+      }\n+      generatedHash = sb.toString();\n+    } catch (NoSuchAlgorithmException e) {\n+      logger.info(\"No Such Algorithm Exception: \", e);", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMjE4MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402412180", "bodyText": "fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:39:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxMzA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxMzcxMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400413711", "bodyText": "nit: typo withdrawParticipantFromStudy", "author": "zohrehj", "createdAt": "2020-03-30T18:44:17Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/util/UserManagementUtil.java", "diffHunk": "@@ -419,4 +425,67 @@ public static Date getCurrentUtilDateTime() {\n     }\n     return date;\n   }\n+\n+  public static String getHashedValue(String input) {\n+    String generatedHash = null;\n+    try {\n+      MessageDigest md = MessageDigest.getInstance(\"SHA-256\");\n+      byte[] bytes = md.digest(input.getBytes());\n+      StringBuilder sb = new StringBuilder();\n+      for (int i = 0; i < bytes.length; i++) {\n+        sb.append(Integer.toString((bytes[i] & 0xff) + 0x100, 16).substring(1));\n+      }\n+      generatedHash = sb.toString();\n+    } catch (NoSuchAlgorithmException e) {\n+      logger.info(\"No Such Algorithm Exception: \", e);\n+    }\n+    return generatedHash;\n+  }\n+\n+  public String withDrawParticipantFromStudy(String participantId, String studyId, boolean delete)", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMjMwMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402412303", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:39:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxMzcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxNDAzNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r400414036", "bodyText": "please log this as an error as well.", "author": "zohrehj", "createdAt": "2020-03-30T18:44:52Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/util/UserManagementUtil.java", "diffHunk": "@@ -419,4 +425,67 @@ public static Date getCurrentUtilDateTime() {\n     }\n     return date;\n   }\n+\n+  public static String getHashedValue(String input) {\n+    String generatedHash = null;\n+    try {\n+      MessageDigest md = MessageDigest.getInstance(\"SHA-256\");\n+      byte[] bytes = md.digest(input.getBytes());\n+      StringBuilder sb = new StringBuilder();\n+      for (int i = 0; i < bytes.length; i++) {\n+        sb.append(Integer.toString((bytes[i] & 0xff) + 0x100, 16).substring(1));\n+      }\n+      generatedHash = sb.toString();\n+    } catch (NoSuchAlgorithmException e) {\n+      logger.info(\"No Such Algorithm Exception: \", e);\n+    }\n+    return generatedHash;\n+  }\n+\n+  public String withDrawParticipantFromStudy(String participantId, String studyId, boolean delete)\n+      throws UnAuthorizedRequestException, InvalidRequestException, SystemException {\n+    logger.info(\"EnrollmentManagementUtil withDrawParticipantFromStudy() - starts \");\n+    HttpHeaders headers = null;\n+    HttpEntity<WithdrawFromStudyBodyProvider> request = null;\n+\n+    String message = MyStudiesUserRegUtil.ErrorCodes.FAILURE.getValue();\n+    try {\n+      headers = new HttpHeaders();\n+      headers.setContentType(MediaType.APPLICATION_JSON);\n+      headers.set(AppConstants.APPLICATION_ID, null);\n+      headers.set(AppConstants.CLIENT_ID, appConfig.getClientId());\n+      headers.set(AppConstants.SECRET_KEY, getHashedValue(appConfig.getSecretKey()));\n+\n+      request = new HttpEntity<>(null, headers);\n+\n+      String url =\n+          appConfig.getWithdrawStudyUrl()\n+              + \"?studyId=\"\n+              + studyId\n+              + \"&participantId=\"\n+              + participantId\n+              + \"&deleteResponses=\"\n+              + String.valueOf(delete);\n+\n+      ResponseEntity<?> response = restTemplate.postForEntity(url, request, String.class);\n+\n+      if (response.getStatusCode() == HttpStatus.OK) {\n+        message = MyStudiesUserRegUtil.ErrorCodes.SUCCESS.getValue();\n+      }\n+\n+    } catch (RestClientResponseException e) {\n+      message = MyStudiesUserRegUtil.ErrorCodes.FAILURE.getValue();\n+      if (e.getRawStatusCode() == 401) {\n+        logger.error(\"Invalid client Id or client secret. Client id is: \" + AppConstants.CLIENT_ID);\n+        throw new UnAuthorizedRequestException();\n+      } else if (e.getRawStatusCode() == 400) {\n+        logger.error(\"Client verification ended with Bad Request\");\n+        throw new InvalidRequestException();\n+      } else {\n+        throw new SystemException();", "originalCommit": "0d8f011cb950c18117c78f750bd7ec7e19918a73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMjQ1NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402412454", "bodyText": "Fixed", "author": "aswinijena100", "createdAt": "2020-04-02T15:39:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxNDAzNg=="}], "type": "inlineReview"}, {"oid": "779a9148512e637c210df9c106b756f7a097bed1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/779a9148512e637c210df9c106b756f7a097bed1", "message": "Auth Server Issue fixes  as per the PR comments", "committedDate": "2020-04-02T13:58:12Z", "type": "commit"}, {"oid": "a606ac81c598fc42a4ca4838e0ba11ee3f9a5a54", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a606ac81c598fc42a4ca4838e0ba11ee3f9a5a54", "message": "issue fix as per PR comments", "committedDate": "2020-04-02T13:58:38Z", "type": "commit"}, {"oid": "ed89c86d910b94d2884198dd6d621e6640900daf", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ed89c86d910b94d2884198dd6d621e6640900daf", "message": "removed sensitive data from the properties files", "committedDate": "2020-04-02T13:59:33Z", "type": "commit"}, {"oid": "aba72e562af0372b3714b070d3cc01336ecd5a96", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/aba72e562af0372b3714b070d3cc01336ecd5a96", "message": "response server issue fixes based on github PR comments", "committedDate": "2020-04-02T14:04:07Z", "type": "commit"}, {"oid": "410695be38198094d2a7b23f71fed6a66a9b5a06", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/410695be38198094d2a7b23f71fed6a66a9b5a06", "message": "wcp issue fixes based on github PR comments", "committedDate": "2020-04-02T14:05:37Z", "type": "commit"}, {"oid": "586628cf33018005f3063cf67afbd15201a8d6a8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/586628cf33018005f3063cf67afbd15201a8d6a8", "message": "User Reg Server->Consent Bundle  issue fixes based on github PR comments and internal QA issue fixes for get consent api not working as expected", "committedDate": "2020-04-02T14:08:43Z", "type": "commit"}, {"oid": "31c8db2bc4a4e85d5016c8fac2ef476980347b13", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/31c8db2bc4a4e85d5016c8fac2ef476980347b13", "message": "User Reg Server-> Enroll Mgmt  issue fixes based on github PR comments", "committedDate": "2020-04-02T14:10:23Z", "type": "commit"}, {"oid": "2c817817767726706cc826a1ea32f09822c9d98c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2c817817767726706cc826a1ea32f09822c9d98c", "message": "User Reg Server-> Enroll Mgmt  issue fixes based on github PR comments", "committedDate": "2020-04-02T14:27:41Z", "type": "commit"}, {"oid": "15cb3e30002d4036509b1b60e4cf2b41657209cc", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/15cb3e30002d4036509b1b60e4cf2b41657209cc", "message": "User Reg Server->User Mgmt  issue fixes based on github PR comments", "committedDate": "2020-04-02T15:27:36Z", "type": "commit"}, {"oid": "fda9008fe5ef2125034871af543422ab6ed6e8ae", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/fda9008fe5ef2125034871af543422ab6ed6e8ae", "message": "removed commented code  as per the github PR comment", "committedDate": "2020-04-02T15:46:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ4NTU4Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402485582", "bodyText": "please remove", "author": "zohrehj", "createdAt": "2020-04-02T17:28:40Z", "path": "user-registration-server-ws/consent-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserConsentManagementServiceImpl.java", "diffHunk": "@@ -107,7 +108,11 @@ public ConsentStudyResponseBean getStudyConsentDetails(\n \n           ByteArrayOutputStream baos = new ByteArrayOutputStream();\n           cloudStorageService.downloadFileTo(path, baos);\n-          consentStudyResponseBean.getConsent().setContent(new String(baos.toByteArray()));\n+          //          consentStudyResponseBean.getConsent().setContent(new\n+          // String(baos.toByteArray()));", "originalCommit": "fda9008fe5ef2125034871af543422ab6ed6e8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ4NjM5Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402486393", "bodyText": "please remove", "author": "zohrehj", "createdAt": "2020-04-02T17:29:51Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/beans/DeactivateAcctBean.java", "diffHunk": "@@ -9,11 +9,13 @@\n package com.google.cloud.healthcare.fdamystudies.beans;\n \n import java.util.List;\n+import com.google.cloud.healthcare.fdamystudies.bean.StudyReqBean;\n import lombok.Getter;\n import lombok.Setter;\n \n @Setter\n @Getter\n public class DeactivateAcctBean {\n-  private List<String> deleteData;\n+  //  private List<String> deleteData;", "originalCommit": "fda9008fe5ef2125034871af543422ab6ed6e8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ4NjYxNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402486614", "bodyText": "same here, please remove commented code", "author": "zohrehj", "createdAt": "2020-04-02T17:30:06Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/beans/WithdrawFromStudyBean.java", "diffHunk": "@@ -16,5 +17,7 @@\n \n   private String participantId;\n   private String studyId;\n-  private boolean delete;\n+  //  private boolean delete;", "originalCommit": "fda9008fe5ef2125034871af543422ab6ed6e8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ4ODQxNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402488415", "bodyText": "please remove", "author": "zohrehj", "createdAt": "2020-04-02T17:32:05Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/StudiesDaoImpl.java", "diffHunk": "@@ -211,4 +215,61 @@ private void decommisionSiteFromStudy(Session session, Integer studyId) {\n     }\n     logger.info(\"StudiesDaoImpl - decommisionSiteFromStudy() : ends\");\n   }\n+\n+  @Override\n+  public String withdrawFromStudy(String participantId, String studyId, boolean delete) {\n+    logger.info(\"StudiesDaoImpl withdrawFromStudy() - Ends \");\n+    String message = MyStudiesUserRegUtil.ErrorCodes.FAILURE.getValue();\n+    Transaction transaction = null;\n+    CriteriaBuilder criteriaBuilder = null;\n+\n+    CriteriaQuery<StudyInfoBO> studiesBoCriteria = null;\n+    Root<StudyInfoBO> studiesBoRoot = null;\n+    Predicate[] studiesBoPredicates = new Predicate[1];\n+    List<StudyInfoBO> studiesBoList = null;\n+    StudyInfoBO studyInfo = null;\n+\n+    CriteriaUpdate<ParticipantStudiesBO> criteriaUpdate = null;\n+    Root<ParticipantStudiesBO> participantStudiesBoRoot = null;\n+    List<Predicate> predicates = new ArrayList<>();\n+    int isUpdated = 0;\n+    try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+\n+      transaction = session.beginTransaction();\n+      criteriaBuilder = session.getCriteriaBuilder();\n+\n+      studiesBoCriteria = criteriaBuilder.createQuery(StudyInfoBO.class);\n+      studiesBoRoot = studiesBoCriteria.from(StudyInfoBO.class);\n+      studiesBoPredicates[0] = criteriaBuilder.equal(studiesBoRoot.get(\"customId\"), studyId);\n+      studiesBoCriteria.select(studiesBoRoot).where(studiesBoPredicates);\n+      studiesBoList = session.createQuery(studiesBoCriteria).getResultList();\n+      if (!studiesBoList.isEmpty()) {\n+        studyInfo = studiesBoList.get(0);\n+        criteriaUpdate = criteriaBuilder.createCriteriaUpdate(ParticipantStudiesBO.class);\n+        participantStudiesBoRoot = criteriaUpdate.from(ParticipantStudiesBO.class);\n+        criteriaUpdate.set(\"status\", AppConstants.WITHDRAWN);\n+        //        criteriaUpdate.set(\"participantId\", \"NULL\");", "originalCommit": "fda9008fe5ef2125034871af543422ab6ed6e8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ4OTA5MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/37#discussion_r402489091", "bodyText": "please remove", "author": "zohrehj", "createdAt": "2020-04-02T17:32:48Z", "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDao.java", "diffHunk": "@@ -36,6 +36,8 @@ public UserDetailsBO getParticipantDetailsByEmail(\n \n   public UserDetailsBO getParticipantDetails(String id);\n \n-  public boolean deActivateAcct(\n-      String userId, DeactivateAcctBean deactivateBean, Integer userDetailsId);\n+  /*  public boolean deActivateAcct(\n+  String userId, DeactivateAcctBean deactivateBean, Integer userDetailsId);*/", "originalCommit": "fda9008fe5ef2125034871af543422ab6ed6e8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "12a34d0511242dc73752cad05632722adba0f2ac", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/12a34d0511242dc73752cad05632722adba0f2ac", "message": "Merge branch 'early-access' into early-access-build", "committedDate": "2020-04-03T11:43:51Z", "type": "commit"}]}