{"pr_number": 799, "pr_title": "Enroll Mgmt Module: Audit log implementation with test cases", "pr_createdAt": "2020-08-24T16:18:52Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799", "timeline": [{"oid": "cb5fc1f60dcb2a779a8671a49852727ba71219a0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cb5fc1f60dcb2a779a8671a49852727ba71219a0", "message": "Audit log implementation with test cases\n\nAudit log implementation with test cases", "committedDate": "2020-08-24T16:11:40Z", "type": "commit"}, {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/18731f9aed65cae9f8f957fd29a7ed0859774dbd", "message": "Removed old audit log code\n\nRemoved old audit log code", "committedDate": "2020-08-24T16:17:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUzNzQ1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476537453", "bodyText": "nit: remove empty comment", "author": "zohrehj", "createdAt": "2020-08-25T15:26:56Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/beans/AuditLogEventRequest.java", "diffHunk": "@@ -19,7 +20,10 @@\n @Getter\n @Setter\n @ToString\n-public class AuditLogEventRequest {\n+public class AuditLogEventRequest implements Serializable {\n+\n+  /** */", "originalCommit": "18731f9aed65cae9f8f957fd29a7ed0859774dbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEzOTg0MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r477139840", "bodyText": "fixed review comment", "author": "Kantharajut-btc", "createdAt": "2020-08-26T08:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUzNzQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUzOTY0Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476539646", "bodyText": "nit: move to constant", "author": "zohrehj", "createdAt": "2020-08-25T15:30:02Z", "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/StudyStateController.java", "diffHunk": "@@ -111,7 +124,10 @@\n \n   @GetMapping(value = \"/studyState\", produces = MediaType.APPLICATION_JSON_VALUE)\n   public ResponseEntity<?> getStudyState(\n-      @RequestHeader(\"userId\") String userId, @Context HttpServletResponse response) {\n+      @RequestHeader(\"userId\") String userId,", "originalCommit": "18731f9aed65cae9f8f957fd29a7ed0859774dbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE0MDE3OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r477140179", "bodyText": "fixed review comment", "author": "Kantharajut-btc", "createdAt": "2020-08-26T08:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUzOTY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0MDgwMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476540800", "bodyText": "please make sure the sql script for this module is also updated.", "author": "zohrehj", "createdAt": "2020-08-25T15:31:38Z", "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/enroll/model/ActivityLogBO.java", "diffHunk": "@@ -1,46 +0,0 @@\n-/*\n- * Copyright 2020 Google LLC\n- *\n- * Use of this source code is governed by an MIT-style\n- * license that can be found in the LICENSE file or at\n- * https://opensource.org/licenses/MIT.\n- */\n-\n-package com.google.cloud.healthcare.fdamystudies.enroll.model;", "originalCommit": "18731f9aed65cae9f8f957fd29a7ed0859774dbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyNTEzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r477325131", "bodyText": "this should be addressed, if it is too much work create a bug to address later.", "author": "zohrehj", "createdAt": "2020-08-26T14:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0MDgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIxMTQ1Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r478211457", "bodyText": "Updated sql script", "author": "Kantharajut-btc", "createdAt": "2020-08-27T07:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0MDgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0NzcxOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476547719", "bodyText": "Looks like this is saving a list of studies, and each of these studies may have a different state; Is that correct?\nIf yes, then I don't think adding the state_value of a single study into the audit log makes. sense", "author": "zohrehj", "createdAt": "2020-08-25T15:41:23Z", "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudyStateServiceImpl.java", "diffHunk": "@@ -165,28 +179,12 @@ public StudyStateRespBean saveParticipantStudies(\n         studyStateRespBean = new StudyStateRespBean();\n         studyStateRespBean.setMessage(\n             MyStudiesUserRegUtil.ErrorCodes.SUCCESS.getValue().toLowerCase());\n-        List<String> activityDescList =\n-            customStudyIdList\n-                .stream()\n-                .map(\n-                    studyId ->\n-                        String.format(AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_DESC, studyId))\n-                .collect(Collectors.toList());\n-        commonService.createActivityLogList(\n-            userId, AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_NAME, activityDescList);\n-      } else {\n-        List<String> activityDescList =\n-            customStudyIdList\n-                .stream()\n-                .map(\n-                    studyId ->\n-                        String.format(\n-                            AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_FAILED_DESC, studyId))\n-                .collect(Collectors.toList());\n-        commonService.createActivityLogList(\n-            userId, AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_FAILED_NAME, activityDescList);\n+        placeHolder.put(\"study_state_value\", addParticipantStudiesList.get(0).getStatus());", "originalCommit": "18731f9aed65cae9f8f957fd29a7ed0859774dbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE0MDU0Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r477140547", "bodyText": "fixed review comment", "author": "Kantharajut-btc", "createdAt": "2020-08-26T08:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0NzcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyNjYwMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r477326600", "bodyText": "I am not seeing any changes. Also this comment questions the audit log definition for this case and addressing it may require further discussion.", "author": "zohrehj", "createdAt": "2020-08-26T14:03:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0NzcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ2OTQ0Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r478469447", "bodyText": "My bad, i did a mistake by adding the study state at the end which was overriding the study state for the other studies. Now i have refactored the code to add the study state for each study. please find the code snippet for your reference\n      for (ParticipantStudiesBO participantStudies : existParticipantStudies) {\n        if (studyInfo != null) {\n          if (studyInfo.getId().equals(participantStudies.getStudyInfo().getId())) {\n            isExists = true;\n            if (participantStudies.getStatus() != null\n                && participantStudies\n                    .getStatus()\n                    .equalsIgnoreCase(MyStudiesUserRegUtil.ErrorCodes.YET_TO_JOIN.getValue())) {\n              participantStudies.setEnrolledDate(MyStudiesUserRegUtil.getCurrentUtilDateTime());\n            }\n            if (studiesBean.getStatus() != null\n                && !StringUtils.isEmpty(studiesBean.getStatus())) {\n              participantStudies.setStatus(studiesBean.getStatus());\n\n              if (studiesBean\n                  .getStatus()\n                  .equalsIgnoreCase(MyStudiesUserRegUtil.ErrorCodes.IN_PROGRESS.getValue())) {\n                participantStudies.setEnrolledDate(\n                    MyStudiesUserRegUtil.getCurrentUtilDateTime());\n              }\n            }\n            if (studiesBean.getBookmarked() != null) {\n              participantStudies.setBookmark(studiesBean.getBookmarked());\n            }\n            if (studiesBean.getCompletion() != null) {\n              participantStudies.setCompletion(studiesBean.getCompletion());\n            }\n            if (studiesBean.getAdherence() != null) {\n              participantStudies.setAdherence(studiesBean.getAdherence());\n            }\n            if (studiesBean.getParticipantId() != null\n                && StringUtils.isNotEmpty(studiesBean.getParticipantId())) {\n              participantStudies.setParticipantId(studiesBean.getParticipantId());\n            }\n            `placeHolder.put(\"study_state_value\", participantStudies.getStatus());`\n            addParticipantStudiesList.add(participantStudies);\n          }\n        }\n      }", "author": "Kantharajut-btc", "createdAt": "2020-08-27T14:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0NzcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1MzIzNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476553234", "bodyText": "this appId column was removed from the final audit columns", "author": "zohrehj", "createdAt": "2020-08-25T15:49:47Z", "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/testutils/TestUtils.java", "diffHunk": "@@ -10,6 +11,9 @@ public static HttpHeaders getCommonHeaders() {\n     HttpHeaders headers = new HttpHeaders();\n     headers.add(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON);\n     headers.add(HttpHeaders.ACCEPT, MediaType.APPLICATION_JSON);\n+    headers.add(\"correlationId\", IdGenerator.id());\n+    headers.add(\"appVersion\", \"1.0\");\n+    headers.add(\"appId\", \"GCPMS001\");", "originalCommit": "18731f9aed65cae9f8f957fd29a7ed0859774dbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE0MDk3Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r477140972", "bodyText": "fixed review comment", "author": "Kantharajut-btc", "createdAt": "2020-08-26T08:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1MzIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyOTA5Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r477329093", "bodyText": "my mistake, appID is still there.", "author": "zohrehj", "createdAt": "2020-08-26T14:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1MzIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1NTkwMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476555903", "bodyText": "remove debug log", "author": "zohrehj", "createdAt": "2020-08-25T15:53:39Z", "path": "common-modules/common-tests/src/main/java/com/google/cloud/healthcare/fdamystudies/common/BaseMockIT.java", "diffHunk": "@@ -149,9 +170,95 @@ protected MvcResult performPost(\n         .andReturn();\n   }\n \n+  /**\n+   * @param assertOptionalFieldsForEvent is a {@link Map} collection that contains {@link eventCode}\n+   *     as key and {@link AuditLogEventRequest} with optional field values as value.\n+   * @param auditEvents audit event enums\n+   */\n+  protected void verifyAuditEventCall(\n+      Map<String, AuditLogEventRequest> assertOptionalFieldsForEvent,\n+      AuditLogEvent... auditEvents) {\n+\n+    verifyAuditEventCall(auditEvents);\n+\n+    Map<String, AuditLogEventRequest> auditRequestByEventCode =\n+        auditRequests\n+            .stream()\n+            .collect(Collectors.toMap(AuditLogEventRequest::getEventCode, Function.identity()));\n+\n+    assertOptionalFieldsForEvent.forEach(\n+        (eventCode, expectedAuditRequest) -> {\n+          AuditLogEventRequest auditRequest = auditRequestByEventCode.get(eventCode);\n+          assertEquals(expectedAuditRequest.getUserId(), auditRequest.getUserId());\n+          assertEquals(expectedAuditRequest.getParticipantId(), auditRequest.getParticipantId());\n+          assertEquals(expectedAuditRequest.getStudyId(), auditRequest.getStudyId());\n+          assertEquals(expectedAuditRequest.getStudyVersion(), auditRequest.getStudyVersion());\n+        });\n+  }\n+\n+  protected void verifyAuditEventCall(AuditLogEvent... auditEvents) {\n+    ArgumentCaptor<AuditLogEventRequest> argument =\n+        ArgumentCaptor.forClass(AuditLogEventRequest.class);\n+    verify(mockAuditService, atLeastOnce()).postAuditLogEvent(argument.capture());\n+\n+    Map<String, AuditLogEventRequest> auditRequestByEventCode =\n+        auditRequests\n+            .stream()\n+            .collect(Collectors.toMap(AuditLogEventRequest::getEventCode, Function.identity()));\n+\n+    for (AuditLogEvent auditEvent : auditEvents) {\n+      AuditLogEventRequest auditRequest = auditRequestByEventCode.get(auditEvent.getEventCode());\n+      logger.debug(auditRequest.toString());", "originalCommit": "18731f9aed65cae9f8f957fd29a7ed0859774dbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE0MTY0Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r477141643", "bodyText": "removed debug log", "author": "Kantharajut-btc", "createdAt": "2020-08-26T08:52:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1NTkwMw=="}], "type": "inlineReview"}, {"oid": "7019e78c7d01850ae6ca3f5f18756ca2c480f8c4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7019e78c7d01850ae6ca3f5f18756ca2c480f8c4", "message": "Fixed PR comments\n\nFixed PR comments", "committedDate": "2020-08-26T08:43:14Z", "type": "commit"}, {"oid": "0acc7804985a3e29ae30560e0405ab8a782e69f1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0acc7804985a3e29ae30560e0405ab8a782e69f1", "message": "Merge branch 'develop' into enroll-mgmt-auditlog-events", "committedDate": "2020-08-26T08:48:42Z", "type": "commit"}, {"oid": "18a7844e8e3aa2fcc0bcd9eb5548261f9d158055", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/18a7844e8e3aa2fcc0bcd9eb5548261f9d158055", "message": "Updated sql script and added appId\n\nUpdated sql script and added appId", "committedDate": "2020-08-27T07:13:04Z", "type": "commit"}, {"oid": "0735b2732d52b9ffe8512f67884a4e204523577e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0735b2732d52b9ffe8512f67884a4e204523577e", "message": "Merge branch 'develop' into enroll-mgmt-auditlog-events", "committedDate": "2020-08-27T07:20:30Z", "type": "commit"}, {"oid": "29e57ca31b1a3a712e365b30f3691a65d6e0f502", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/29e57ca31b1a3a712e365b30f3691a65d6e0f502", "message": "Merge branch 'develop' into enroll-mgmt-auditlog-events", "committedDate": "2020-08-27T16:49:42Z", "type": "commit"}]}