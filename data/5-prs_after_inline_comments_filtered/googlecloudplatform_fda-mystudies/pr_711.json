{"pr_number": 711, "pr_title": "Participant manager service - POST /sites/{siteId}/participants/invite API endpoint implementation.", "pr_createdAt": "2020-07-31T14:07:19Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711", "timeline": [{"oid": "f503bedec6fc8d706961873bf614fffabc22c91a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f503bedec6fc8d706961873bf614fffabc22c91a", "message": "Participant manager POST /sites/{siteId}/participants/invite api endpoint implementation.", "committedDate": "2020-07-31T13:12:04Z", "type": "commit"}, {"oid": "f73c1d40309b7677b84812ff8effb574f91bad99", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f73c1d40309b7677b84812ff8effb574f91bad99", "message": "Code rafactor", "committedDate": "2020-07-31T13:30:14Z", "type": "commit"}, {"oid": "759511eba17671a62138e8115aca8528669b4544", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/759511eba17671a62138e8115aca8528669b4544", "message": "test cases failure fix", "committedDate": "2020-07-31T14:29:18Z", "type": "commit"}, {"oid": "92442bf12608b31a925b51d28cca2f213fb18b4d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/92442bf12608b31a925b51d28cca2f213fb18b4d", "message": "Test cases failure fixed", "committedDate": "2020-07-31T14:32:44Z", "type": "commit"}, {"oid": "5fa2a6fd154c998076abfa2296da09fd59ccabd9", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5fa2a6fd154c998076abfa2296da09fd59ccabd9", "message": "equals check", "committedDate": "2020-07-31T15:11:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3MzI3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463873275", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              PARTICIPANTS_INVITED_SUCCESS(HttpStatus.OK, \"MSG-0016\", \"participants are invited\"),\n          \n          \n            \n              PARTICIPANTS_INVITED_SUCCESS(HttpStatus.OK, \"MSG-0016\", \"Participants are invited\"),", "author": "saminguyen", "createdAt": "2020-07-31T22:32:32Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/MessageCode.java", "diffHunk": "@@ -64,7 +67,12 @@\n       HttpStatus.OK, \"MSG-0023\", \"Get user profile with security code successfully\"),\n \n   GET_PARTICIPANT_DETAILS_SUCCESS(\n-      HttpStatus.OK, \"MSG-0019\", \"Get participant details successfully\");\n+      HttpStatus.OK, \"MSG-0019\", \"Get participant details successfully\"),\n+\n+  PARTICIPANTS_INVITED_SUCCESS(HttpStatus.OK, \"MSG-0016\", \"participants are invited\"),", "originalCommit": "5fa2a6fd154c998076abfa2296da09fd59ccabd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNDM5MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r464214390", "bodyText": "Changed to Participants.", "author": "madhurya-btc", "createdAt": "2020-08-03T06:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3MzI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NTUyOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463875528", "bodyText": "Can you just use the built in isEmpty for this? I think even when CC and BCC are empty these ArrayLists should not be null, just empty right?", "author": "saminguyen", "createdAt": "2020-07-31T22:42:08Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EmailServiceImpl.java", "diffHunk": "@@ -34,23 +40,30 @@\n   @Autowired private JavaMailSender emailSender;\n \n   @Override\n-  public EmailResponse sendSimpleMail(EmailRequest emailRequest) {\n-    logger.entry(\"Begin sendSimpleMail()\");\n+  public EmailResponse sendMimeMail(EmailRequest emailRequest) {\n+    logger.entry(\"Begin sendMimeMail()\");\n     try {\n-      SimpleMailMessage message = new SimpleMailMessage();\n-      message.setFrom(emailRequest.getFrom());\n-      message.setBcc(emailRequest.getBcc());\n-      message.setCc(emailRequest.getCc());\n-      message.setTo(emailRequest.getTo());\n+      MimeMessage message = emailSender.createMimeMessage();\n+      MimeMessageHelper helper = new MimeMessageHelper(message, true);\n+      helper.setFrom(emailRequest.getFrom());\n+      helper.setTo(emailRequest.getTo());\n+\n+      if (ArrayUtils.isNotEmpty(emailRequest.getCc())) {", "originalCommit": "5fa2a6fd154c998076abfa2296da09fd59ccabd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxMzAxNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r464213014", "bodyText": "In EmailRequest  CC and BCC are not initialized and type of String[], hence checking ArrayUtils.isNotEmpty.", "author": "madhurya-btc", "createdAt": "2020-08-03T06:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NTUyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NTk3OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463875979", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Integer enrollmentTokenExpiryinHours;\n          \n          \n            \n              private Integer enrollmentTokenExpiryInHours;", "author": "saminguyen", "createdAt": "2020-07-31T22:44:03Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/config/AppPropertyConfig.java", "diffHunk": "@@ -23,4 +25,28 @@\n \n   @Value(\"${securityCodeExpireDate}\")\n   private String securityCodeExpireDate;\n+\n+  @Value(\"${enrollmentTokenExpiryinHours}\")\n+  private Integer enrollmentTokenExpiryinHours;", "originalCommit": "5fa2a6fd154c998076abfa2296da09fd59ccabd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNDI3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r464214275", "bodyText": "Changed to enrollmentTokenExpiryInHours.", "author": "madhurya-btc", "createdAt": "2020-08-03T06:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NTk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4MDMyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463880329", "bodyText": "participantsList", "author": "saminguyen", "createdAt": "2020-07-31T23:03:00Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -564,4 +580,113 @@ private ErrorCode validateParticipantDetailsRequest(\n     }\n     return null;\n   }\n+\n+  @Override\n+  @Transactional\n+  public InviteParticipantResponse inviteParticipants(\n+      InviteParticipantRequest inviteParticipantRequest) {\n+    logger.entry(\"begin inviteParticipants()\");\n+\n+    Optional<SiteEntity> optSiteEntity =\n+        siteRepository.findById(inviteParticipantRequest.getSiteId());\n+\n+    if (!optSiteEntity.isPresent() || !ACTIVE_STATUS.equals(optSiteEntity.get().getStatus())) {\n+      logger.exit(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+      return new InviteParticipantResponse(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+    }\n+\n+    Optional<SitePermissionEntity> optSitePermissionEntity =\n+        sitePermissionRepository.findSitePermissionByUserIdAndSiteId(\n+            inviteParticipantRequest.getUserId(), inviteParticipantRequest.getSiteId());\n+    if (!optSitePermissionEntity.isPresent()\n+        || Permission.READ_EDIT\n+            != Permission.fromValue(optSitePermissionEntity.get().getCanEdit())) {\n+      logger.exit(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED);\n+      return new InviteParticipantResponse(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED);\n+    }\n+\n+    List<ParticipantRegistrySiteEntity> listOfparticipants =", "originalCommit": "5fa2a6fd154c998076abfa2296da09fd59ccabd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNDIxNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r464214217", "bodyText": "Changed to participantsList.", "author": "madhurya-btc", "createdAt": "2020-08-03T06:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4MDMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4NDY4MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463884680", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              INVITE_PARTICIPANT(\n          \n          \n            \n              INVITE_PARTICIPANTS(", "author": "saminguyen", "createdAt": "2020-07-31T23:23:50Z", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/common/ApiEndpoint.java", "diffHunk": "@@ -51,7 +51,10 @@\n   GET_USER_DETAILS(\"http://localhost:8080/participant-manager-service/users\"),\n \n   GET_PARTICIPANT_DETAILS(\n-      \"http://localhost:8080/participant-manager-service/sites/{participantRegistrySite}/participant\");\n+      \"http://localhost:8080/participant-manager-service/sites/{participantRegistrySite}/participant\"),\n+\n+  INVITE_PARTICIPANT(", "originalCommit": "5fa2a6fd154c998076abfa2296da09fd59ccabd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNDEyNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r464214127", "bodyText": "Changed to INVITE_PARTICIPANTS.", "author": "madhurya-btc", "createdAt": "2020-08-03T06:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4NDY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4Njg5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463886897", "bodyText": "We should have more success cases in test, requests with multiple Ids, with some failed participantIds being returned", "author": "saminguyen", "createdAt": "2020-07-31T23:34:37Z", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SitesControllerTest.java", "diffHunk": "@@ -661,6 +663,73 @@ public void shouldReturnAccessDeniedForGetParticipantDetails() throws Exception\n                 is(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED.getDescription())));\n   }\n \n+  @Test\n+  public void shouldReturnSiteNotFoundForInviteParticipant() throws Exception {\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    InviteParticipantRequest inviteParticipantRequest = new InviteParticipantRequest();\n+    inviteParticipantRequest.setIds(Arrays.asList(participantRegistrySiteEntity.getId()));\n+    mockMvc\n+        .perform(\n+            post(ApiEndpoint.INVITE_PARTICIPANT.getPath(), IdGenerator.id())\n+                .content(asJsonString(inviteParticipantRequest))\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isBadRequest())\n+        .andExpect(\n+            jsonPath(\n+                \"$.error_description\", is(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE.getDescription())));\n+  }\n+\n+  @Test\n+  public void shouldInviteParticipant() throws Exception {", "originalCommit": "5fa2a6fd154c998076abfa2296da09fd59ccabd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNDA2OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r464214069", "bodyText": "Added test for failed invites.", "author": "madhurya-btc", "createdAt": "2020-08-03T06:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4Njg5Nw=="}], "type": "inlineReview"}, {"oid": "4e8ee601740cc9e30dca16be7d73107a8d3db9c2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4e8ee601740cc9e30dca16be7d73107a8d3db9c2", "message": "PR comment fixes", "committedDate": "2020-08-03T05:52:39Z", "type": "commit"}, {"oid": "323e1d868cdfbd097ced5a6b25fb93910efb8680", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/323e1d868cdfbd097ced5a6b25fb93910efb8680", "message": "1) fetching placeholder of orgName for email from property file.\n2) invitation count incrementing for NEW and INVITE also", "committedDate": "2020-08-14T05:56:37Z", "type": "commit"}, {"oid": "b047c38001d9fe105348e4608c1827feeb8dc9ee", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b047c38001d9fe105348e4608c1827feeb8dc9ee", "message": "Merge branch 'develop' into participant-manager-invite-participants", "committedDate": "2020-08-18T16:07:01Z", "type": "commit"}, {"oid": "d33c163f7d1a5b521a0b0d0c6e78b307e04b75a0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d33c163f7d1a5b521a0b0d0c6e78b307e04b75a0", "message": "resolved merge conflicts", "committedDate": "2020-08-19T13:15:14Z", "type": "commit"}, {"oid": "74a190055a1d36dcf66141469fa70be6c0573d1a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/74a190055a1d36dcf66141469fa70be6c0573d1a", "message": "Fixed test failures", "committedDate": "2020-08-19T13:43:27Z", "type": "commit"}, {"oid": "7f4feacad2882d2791c08b7f0b641ce426496be6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7f4feacad2882d2791c08b7f0b641ce426496be6", "message": "Merge branch 'develop' into participant-manager-invite-participants", "committedDate": "2020-08-19T14:14:25Z", "type": "commit"}]}