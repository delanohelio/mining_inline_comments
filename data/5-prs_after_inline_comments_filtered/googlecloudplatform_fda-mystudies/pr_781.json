{"pr_number": 781, "pr_title": "User Management Service - Audit Log Implementation", "pr_createdAt": "2020-08-20T10:57:29Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781", "timeline": [{"oid": "7e57e3028c659656df23b9c026be5b05cf473316", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7e57e3028c659656df23b9c026be5b05cf473316", "message": "Audit Log Implementation for User Management\n\nAudit Log Implementation for User Management", "committedDate": "2020-08-20T10:50:57Z", "type": "commit"}, {"oid": "5de6b5ea4c93a717c8840f262edb4b94c61668aa", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5de6b5ea4c93a717c8840f262edb4b94c61668aa", "message": "Merge branch 'develop' into user-mgmt-auditlog-with-commons", "committedDate": "2020-08-20T13:03:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzMTk4Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474831987", "bodyText": "missing copyright header", "author": "zohrehj", "createdAt": "2020-08-21T17:29:15Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/common/UserMgmntAuditHelper.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.google.cloud.healthcare.fdamystudies.common;", "originalCommit": "5de6b5ea4c93a717c8840f262edb4b94c61668aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzNjA0NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r475236045", "bodyText": "added copyright", "author": "navya-BTC", "createdAt": "2020-08-23T16:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzMTk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzMjQxNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474832417", "bodyText": "please remove if not needed", "author": "zohrehj", "createdAt": "2020-08-21T17:30:07Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/config/BeanConfig.java", "diffHunk": "@@ -46,8 +45,8 @@ public void addCorsMappings(CorsRegistry registry) {\n     return authenticationBean;\n   }\n \n-  @Bean\n+  /* @Bean\n   public RestTemplate restTemplate() {\n     return new RestTemplate();\n-  }\n+  }*/", "originalCommit": "5de6b5ea4c93a717c8840f262edb4b94c61668aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzNjA1Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r475236057", "bodyText": "Removed", "author": "navya-BTC", "createdAt": "2020-08-23T16:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzMjQxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkwMjczOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474902738", "bodyText": "shouldn't this be  isAfter?", "author": "zohrehj", "createdAt": "2020-08-21T19:41:22Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/VerifyEmailIdController.java", "diffHunk": "@@ -76,20 +97,36 @@\n         participantDetails = getParticipantDetails(verificationForm, appOrgInfoBean);\n       }\n       if (participantDetails == null) {\n+        userMgmntAuditHelper.logEvent(\n+            ACCOUNT_ACTIVATION_USER_EMAIL_VERIFICATION_FAILED, auditRequest);\n+\n         ResponseBean responseBean =\n             ResponseUtil.prepareBadRequestResponse(response, AppConstants.EMAIL_NOT_EXISTS);\n         return new ResponseEntity<>(responseBean, HttpStatus.BAD_REQUEST);\n       }\n       boolean verifyEmailCodeResponse =\n           userDetailsService.verifyCode(verificationForm.getCode().trim(), participantDetails);\n \n+      if (!verificationForm.getCode().trim().equals(participantDetails.getEmailCode())) {\n+        userMgmntAuditHelper.logEvent(\n+            ACCOUNT_ACTIVATION_USER_EMAIL_VERIFICATION_FAILED_WRONG_CODE, auditRequest);\n+      } else if (LocalDateTime.now().isBefore(participantDetails.getCodeExpireDate())) {", "originalCommit": "5de6b5ea4c93a717c8840f262edb4b94c61668aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzNjA4Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r475236082", "bodyText": "Fixed Review Comment", "author": "navya-BTC", "createdAt": "2020-08-23T16:04:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkwMjczOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkxMjkwMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474912901", "bodyText": "move these values into contants, enum probably", "author": "zohrehj", "createdAt": "2020-08-21T19:53:44Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -254,21 +268,64 @@ public String deActivateAcct(\n             studyBean.setDelete(studyReqBean.getDelete());\n             studyBean.setStudyId(studyReqBean.getStudyId());\n             deleteData.add(studyReqBean.getStudyId());\n+\n+            auditRequest.setStudyId(studyBean.getStudyId());\n+            auditRequest.setParticipantId(studyBean.getParticipantId());\n+\n             retVal =\n                 userManagementUtil.withdrawParticipantFromStudy(\n-                    studyBean.getParticipantId(), studyBean.getStudyId(), studyBean.getDelete());\n+                    studyBean.getParticipantId(),\n+                    studyBean.getStudyId(),\n+                    studyBean.getDelete(),\n+                    auditRequest);\n+\n+            if (Boolean.valueOf(studyReqBean.getDelete())) {\n+              Map<String, String> map =\n+                  Stream.of(\n+                          new String[][] {\n+                            {\"delete_or_retain\", \"delete\"},", "originalCommit": "5de6b5ea4c93a717c8840f262edb4b94c61668aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzNjE0Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r475236143", "bodyText": "Fixed review comment", "author": "navya-BTC", "createdAt": "2020-08-23T16:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkxMjkwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkxNTE1NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474915154", "bodyText": "this looks like an overkill for a small map with one element", "author": "zohrehj", "createdAt": "2020-08-21T19:56:33Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -254,21 +268,64 @@ public String deActivateAcct(\n             studyBean.setDelete(studyReqBean.getDelete());\n             studyBean.setStudyId(studyReqBean.getStudyId());\n             deleteData.add(studyReqBean.getStudyId());\n+\n+            auditRequest.setStudyId(studyBean.getStudyId());\n+            auditRequest.setParticipantId(studyBean.getParticipantId());\n+\n             retVal =\n                 userManagementUtil.withdrawParticipantFromStudy(\n-                    studyBean.getParticipantId(), studyBean.getStudyId(), studyBean.getDelete());\n+                    studyBean.getParticipantId(),\n+                    studyBean.getStudyId(),\n+                    studyBean.getDelete(),\n+                    auditRequest);\n+\n+            if (Boolean.valueOf(studyReqBean.getDelete())) {\n+              Map<String, String> map =\n+                  Stream.of(\n+                          new String[][] {\n+                            {\"delete_or_retain\", \"delete\"},\n+                          })\n+                      .collect(Collectors.toMap(data -> data[0], data -> data[1]));\n+\n+              userMgmntAuditHelper.logEvent(\n+                  DATA_RETENTION_SETTING_CAPTURED_ON_WITHDRAWAL, auditRequest, map);\n+\n+              AuditLogEvent auditEvent =\n+                  retVal.equalsIgnoreCase(MyStudiesUserRegUtil.ErrorCodes.SUCCESS.getValue())\n+                      ? PARTICIPANT_DATA_DELETED\n+                      : PARTICIPANT_DATA_DELETION_FAILED;\n+              userMgmntAuditHelper.logEvent(auditEvent, auditRequest);\n+\n+            } else {\n+              Map<String, String> map =\n+                  Stream.of(\n+                          new String[][] {\n+                            {\"delete_or_retain\", \"retain\"},\n+                          })\n+                      .collect(Collectors.toMap(data -> data[0], data -> data[1]));\n+", "originalCommit": "5de6b5ea4c93a717c8840f262edb4b94c61668aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzNjE4MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r475236181", "bodyText": "Fixed review comment", "author": "navya-BTC", "createdAt": "2020-08-23T16:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkxNTE1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkxOTMwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474919305", "bodyText": "same here, this is a couple of lines without use of stream and collectors", "author": "zohrehj", "createdAt": "2020-08-21T20:01:39Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserSupportServiceImpl.java", "diffHunk": "@@ -40,6 +52,18 @@ public boolean feedback(String subject, String body) {\n       isEmailSent =\n           emailNotification.sendEmailNotification(\n               feedbackSubject, dynamicContent, appConfig.getFeedbackToEmail(), null, null);\n+\n+      Map<String, String> map =\n+          Stream.of(\n+                  new String[][] {\n+                    {\"feedback_destination_email_address\", appConfig.getFeedbackToEmail()},\n+                  })\n+              .collect(Collectors.toMap(data -> data[0], data -> data[1]));", "originalCommit": "5de6b5ea4c93a717c8840f262edb4b94c61668aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzNjIxNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r475236217", "bodyText": "Fixed review comment", "author": "navya-BTC", "createdAt": "2020-08-23T16:05:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkxOTMwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkyMDMwMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474920301", "bodyText": "appVersion should be read from the config value, not hardcoded here.", "author": "zohrehj", "createdAt": "2020-08-21T20:02:51Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/testutils/TestUtils.java", "diffHunk": "@@ -12,15 +13,14 @@ public static HttpHeaders getCommonHeaders(String... addOptionalHeaderNames) {\n     headers.add(Constants.ACCESS_TOKEN_HEADER, Constants.ACCESS_TOKEN_VALUE);\n     headers.add(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON);\n     headers.add(HttpHeaders.ACCEPT, MediaType.APPLICATION_JSON);\n+    headers.add(\"correlationId\", IdGenerator.id());\n+    headers.add(\"appVersion\", \"1.0\");", "originalCommit": "5de6b5ea4c93a717c8840f262edb4b94c61668aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzNTk5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r475235997", "bodyText": "Refers to the version of the mobile app that was in use for the event logged. App versions can be different for iOS and Android. As appVersion is coming from headers, we can not add it in config.", "author": "navya-BTC", "createdAt": "2020-08-23T16:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkyMDMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyODE0NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r476428145", "bodyText": "Finalized Columns sheet in HIPAA-grade Audit Logs - FDA MyStudies\nApp Version: Refers to the version of the mobile app that was in use for the event logged. App versions can be different for iOS and Android.", "author": "dhanyak-btc", "createdAt": "2020-08-25T12:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkyMDMwMQ=="}], "type": "inlineReview"}, {"oid": "98352cf17d81d40cb062eb921f4e7a772f93afa0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/98352cf17d81d40cb062eb921f4e7a772f93afa0", "message": "Fixed PR Comments\n\nFixed PR Comments", "committedDate": "2020-08-23T10:22:06Z", "type": "commit"}, {"oid": "b0ed5d726f4d44860464be5ca4a7cdf5e4e9776c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b0ed5d726f4d44860464be5ca4a7cdf5e4e9776c", "message": "Added TestCase for auditLog events\n\nAdded TestCase for auditLog events", "committedDate": "2020-08-23T15:58:17Z", "type": "commit"}, {"oid": "e7b776c7d030ba37854b1821b636be824589108d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e7b776c7d030ba37854b1821b636be824589108d", "message": "Audit event TestCases\n\nAudit event TestCases", "committedDate": "2020-08-25T07:13:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4ODc5Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r476488793", "bodyText": "might be out of scope of this PR but tests should not have order", "author": "zohrehj", "createdAt": "2020-08-25T14:22:55Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserRegistrationControllerTest.java", "diffHunk": "@@ -168,6 +192,98 @@ public void shouldRegisterUser() throws Exception {\n         1,\n         postRequestedFor(urlEqualTo(\"/AuthServer/register\"))\n             .withRequestBody(new ContainsPattern(Constants.PASSWORD)));\n+\n+    AuditLogEventRequest auditRequest = new AuditLogEventRequest();\n+    auditRequest.setAppId(Constants.APP_ID_VALUE);\n+    auditRequest.setUserId(daoResp.getUserId());\n+\n+    Map<String, AuditLogEventRequest> auditEventMap = new HashedMap<>();\n+    auditEventMap.put(USER_CREATED.getEventCode(), auditRequest);\n+    auditEventMap.put(VERIFICATION_EMAIL_FAILED.getEventCode(), auditRequest);\n+\n+    verifyAuditEventCall(auditEventMap, USER_CREATED, VERIFICATION_EMAIL_FAILED);\n+  }\n+\n+  @Order(4)", "originalCommit": "e7b776c7d030ba37854b1821b636be824589108d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA3MzY5MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r477073690", "bodyText": "Created an issue #805 this review comment will be addressed in follow-up PR.", "author": "dhanyak-btc", "createdAt": "2020-08-26T06:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4ODc5Mw=="}], "type": "inlineReview"}, {"oid": "8c7b305de74878fbc6e22ef61f9103f0c66b6b24", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8c7b305de74878fbc6e22ef61f9103f0c66b6b24", "message": "Merge branch 'develop' into user-mgmt-auditlog-with-commons", "committedDate": "2020-08-26T07:36:32Z", "type": "commit"}, {"oid": "fbc03faf7d462961e69249467f0ecc40aeff60ac", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/fbc03faf7d462961e69249467f0ecc40aeff60ac", "message": "Source Format and Fixed Test failure\n\nSource Format and Fixed Test failure", "committedDate": "2020-08-26T07:51:03Z", "type": "commit"}]}