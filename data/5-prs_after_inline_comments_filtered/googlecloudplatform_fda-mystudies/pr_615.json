{"pr_number": 615, "pr_title": "Display Login or Auto Sign-in page implementation with integration tests", "pr_createdAt": "2020-07-10T19:10:19Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615", "timeline": [{"oid": "3ed785a14e52d7bb8d7c330b07d00828f2713da7", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3ed785a14e52d7bb8d7c330b07d00828f2713da7", "message": "Display Login or Auto Signin page implementation with integration tests\n\nDisplay Login or Auto Signin page implementation with integration tests", "committedDate": "2020-07-10T18:26:37Z", "type": "commit"}, {"oid": "b10ec4a66bcbb21cdff9ab9aa6d2f4e14afb4783", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b10ec4a66bcbb21cdff9ab9aa6d2f4e14afb4783", "message": "Removed Signup & Forgot password redirect urls, will be added in next PR\n\nRemoved Signup & Forgot password redirect urls, will be added in next PR", "committedDate": "2020-07-10T18:45:28Z", "type": "commit"}, {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "message": "Formatted JSON files using JSON Editor\n\nFormatted JSON files using JSON Editor", "committedDate": "2020-07-10T19:00:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY3MTg1MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454671851", "bodyText": "use numerical value. We are not saving any space if the value of the enum takes the same space as its name.\nunless this is not the value that ends up in the audit log database?", "author": "zohrehj", "createdAt": "2020-07-14T22:02:54Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/DevicePlatform.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.common;\n+\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+\n+@Getter\n+@RequiredArgsConstructor\n+public enum DevicePlatform {\n+  IOS(\"IOS\", \"Represents an apple platform\"),", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyODY4Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r456528683", "bodyText": "These values are used to determine the redirect url for callback/error/forgot password scenario based on device platform, not saved in the oauth scim service database.", "author": "dhanyak-btc", "createdAt": "2020-07-17T15:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY3MTg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5MTYzNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454691637", "bodyText": "maybe move this code to the DevicePlatform? e.g.\nDevicePlatform.fromString(devicePlatform) == ANDROID", "author": "zohrehj", "createdAt": "2020-07-14T22:56:03Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/config/RedirectConfig.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.config;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.DevicePlatform.ANDROID;\n+import static com.google.cloud.healthcare.fdamystudies.common.DevicePlatform.IOS;\n+\n+import java.io.Serializable;\n+import lombok.Getter;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+@Getter\n+public class RedirectConfig implements Serializable {\n+\n+  private static final long serialVersionUID = 2189883675260389666L;\n+\n+  @Value(\"${participant.manager.callback-url}\")\n+  private String participantManagerCallbackUrl;\n+\n+  @Value(\"${mystudies.ios.app.callback-url}\")\n+  private String myStudiesIosAppCallbackUrl;\n+\n+  @Value(\"${mystudies.android.app.callback-url}\")\n+  private String myStudiesAndroidAppCallbackUrl;\n+\n+  public String getCallbackUrl(String devicePlatform) {\n+    if (ANDROID.getValue().equalsIgnoreCase(devicePlatform)) {", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ1NDYwMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r457454603", "bodyText": "looks like this is fixed.", "author": "zohrehj", "createdAt": "2020-07-20T14:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5MTYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5MjcyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454692729", "bodyText": "Looks like loginChallenge should be required then?\nAlso why is it returning string \"error\"? not a meaningful string, and/or an exception?", "author": "zohrehj", "createdAt": "2020-07-14T22:59:25Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUzMjMxMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r456532310", "bodyText": "\"error\" - is a placeholder. I need to configure error urls for android/ios/participant manager and redirect to respective error url.", "author": "dhanyak-btc", "createdAt": "2020-07-17T15:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5MjcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ1MDIyNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r457450225", "bodyText": "please add a TODO comment with link to the bug that will handle this case, e.g.\n// TODO(714): replace with redirect to appropriate error URL.", "author": "zohrehj", "createdAt": "2020-07-20T14:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5MjcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2NDc5NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r457864794", "bodyText": "This review comment has been fixed in PR #650", "author": "dhanyak-btc", "createdAt": "2020-07-21T06:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5MjcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5NDE5MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454694190", "bodyText": "should this be named loginResponse instead of requestLoginResponse?", "author": "zohrehj", "createdAt": "2020-07-14T23:03:42Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }\n+\n+    // show or skip login page\n+    MultiValueMap<String, String> paramMap = new LinkedMultiValueMap<>();\n+    paramMap.add(LOGIN_CHALLENGE, loginChallenge);\n+    ResponseEntity<JsonNode> requestLoginResponse = oauthService.requestLogin(paramMap);", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUzNjI2OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r456536269", "bodyText": "I named the variable requestLoginResponse to avoid confusion between Hydra's endpoints responses: /oauth2/auth/requests/login and /oauth2/auth/requests/login/accept\nRenamed to loginResponse", "author": "dhanyak-btc", "createdAt": "2020-07-17T16:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5NDE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5NDQ5NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454694494", "bodyText": "nit: change to login to follow our usual naming pattern", "author": "zohrehj", "createdAt": "2020-07-14T23:04:39Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUzNjc2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r456536763", "bodyText": "Renamed to login", "author": "dhanyak-btc", "createdAt": "2020-07-17T16:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5NDQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5Nzg0MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454697841", "bodyText": "I would prefer this to be set to true by default, or to be set as a config param and set to false for dev environments only.", "author": "zohrehj", "createdAt": "2020-07-14T23:14:20Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/CookieUtils.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.common;\n+\n+import javax.servlet.http.Cookie;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.util.MultiValueMap;\n+\n+public final class CookieUtils {\n+\n+  private CookieUtils() {}\n+\n+  public static void addCookies(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      MultiValueMap<String, String> params,\n+      String... cookieNames) {\n+    for (String cookieName : cookieNames) {\n+      addCookie(request, response, cookieName, params.getFirst(cookieName));\n+    }\n+  }\n+\n+  public static void addCookie(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      String cookieName,\n+      String cookieValue) {\n+    Cookie cookie = new Cookie(cookieName, cookieValue);\n+    cookie.setMaxAge(600);\n+    if (StringUtils.equalsIgnoreCase(\"https\", request.getScheme())) {\n+      cookie.setSecure(true);\n+    }", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0MDEyNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r456540126", "bodyText": "Added below code to AppPropertyConfig and moved the code from CookieUtils to LoginController.\n@Value(\"${cookie.secure:true}\")\nprivate boolean secureCookie;", "author": "dhanyak-btc", "createdAt": "2020-07-17T16:14:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5Nzg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5ODI0OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454698248", "bodyText": "no reason to add ORG_ID since it will be removed.", "author": "zohrehj", "createdAt": "2020-07-14T23:15:36Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }\n+\n+    // show or skip login page\n+    MultiValueMap<String, String> paramMap = new LinkedMultiValueMap<>();\n+    paramMap.add(LOGIN_CHALLENGE, loginChallenge);\n+    ResponseEntity<JsonNode> requestLoginResponse = oauthService.requestLogin(paramMap);\n+    if (requestLoginResponse.getStatusCode().is2xxSuccessful()) {\n+      JsonNode responseBody = requestLoginResponse.getBody();\n+      if (skipLogin(responseBody)) {\n+        logger.exit(\"skip login, return to callback URL\");\n+        return redirectToCallbackUrl(request, code, response);\n+      }\n+      return redirectToLoginOrSigninPage(request, response, responseBody, model, loginChallenge);\n+    }\n+\n+    return \"error\";\n+  }\n+\n+  private boolean skipLogin(JsonNode responseBody) {\n+    return responseBody.has(SKIP) && responseBody.get(SKIP).booleanValue();\n+  }\n+\n+  private String redirectToLoginOrSigninPage(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      JsonNode responseBody,\n+      Model model,\n+      String loginChallenge) {\n+\n+    String requestUrl = responseBody.get(\"request_url\").textValue();\n+    MultiValueMap<String, String> qsParams =\n+        UriComponentsBuilder.fromUriString(requestUrl).build().getQueryParams();\n+\n+    addCookie(request, response, LOGIN_CHALLENGE, loginChallenge);\n+    addCookies(\n+        request,\n+        response,\n+        qsParams,\n+        APP_ID,\n+        ORG_ID,", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0MTAwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r456541009", "bodyText": "I've already submitted multiple PR's with ORG_ID. I'll address this comment in followup PR.", "author": "dhanyak-btc", "createdAt": "2020-07-17T16:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5ODI0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5ODk4OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454698988", "bodyText": "why do we need all these details?\nCookie will be bound to the browser/device it was planted in, so It's not likely that we would get the same cookie coming from another device etc", "author": "zohrehj", "createdAt": "2020-07-14T23:17:44Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }\n+\n+    // show or skip login page\n+    MultiValueMap<String, String> paramMap = new LinkedMultiValueMap<>();\n+    paramMap.add(LOGIN_CHALLENGE, loginChallenge);\n+    ResponseEntity<JsonNode> requestLoginResponse = oauthService.requestLogin(paramMap);\n+    if (requestLoginResponse.getStatusCode().is2xxSuccessful()) {\n+      JsonNode responseBody = requestLoginResponse.getBody();\n+      if (skipLogin(responseBody)) {\n+        logger.exit(\"skip login, return to callback URL\");\n+        return redirectToCallbackUrl(request, code, response);\n+      }\n+      return redirectToLoginOrSigninPage(request, response, responseBody, model, loginChallenge);\n+    }\n+\n+    return \"error\";\n+  }\n+\n+  private boolean skipLogin(JsonNode responseBody) {\n+    return responseBody.has(SKIP) && responseBody.get(SKIP).booleanValue();\n+  }\n+\n+  private String redirectToLoginOrSigninPage(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      JsonNode responseBody,\n+      Model model,\n+      String loginChallenge) {\n+\n+    String requestUrl = responseBody.get(\"request_url\").textValue();\n+    MultiValueMap<String, String> qsParams =\n+        UriComponentsBuilder.fromUriString(requestUrl).build().getQueryParams();\n+\n+    addCookie(request, response, LOGIN_CHALLENGE, loginChallenge);\n+    addCookies(\n+        request,\n+        response,\n+        qsParams,\n+        APP_ID,\n+        ORG_ID,\n+        CORRELATION_ID,", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0MzE2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r456543166", "bodyText": "Login/Consent flow has multiple redirects, so I need APP_ID in consent, auto sign-in flows. ORG_ID will be removed in next PR. CORRELATION_ID is for audit log event.", "author": "dhanyak-btc", "createdAt": "2020-07-17T16:20:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5ODk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5OTA4Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454699086", "bodyText": "why is this needed?", "author": "zohrehj", "createdAt": "2020-07-14T23:17:58Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }\n+\n+    // show or skip login page\n+    MultiValueMap<String, String> paramMap = new LinkedMultiValueMap<>();\n+    paramMap.add(LOGIN_CHALLENGE, loginChallenge);\n+    ResponseEntity<JsonNode> requestLoginResponse = oauthService.requestLogin(paramMap);\n+    if (requestLoginResponse.getStatusCode().is2xxSuccessful()) {\n+      JsonNode responseBody = requestLoginResponse.getBody();\n+      if (skipLogin(responseBody)) {\n+        logger.exit(\"skip login, return to callback URL\");\n+        return redirectToCallbackUrl(request, code, response);\n+      }\n+      return redirectToLoginOrSigninPage(request, response, responseBody, model, loginChallenge);\n+    }\n+\n+    return \"error\";\n+  }\n+\n+  private boolean skipLogin(JsonNode responseBody) {\n+    return responseBody.has(SKIP) && responseBody.get(SKIP).booleanValue();\n+  }\n+\n+  private String redirectToLoginOrSigninPage(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      JsonNode responseBody,\n+      Model model,\n+      String loginChallenge) {\n+\n+    String requestUrl = responseBody.get(\"request_url\").textValue();\n+    MultiValueMap<String, String> qsParams =\n+        UriComponentsBuilder.fromUriString(requestUrl).build().getQueryParams();\n+\n+    addCookie(request, response, LOGIN_CHALLENGE, loginChallenge);\n+    addCookies(\n+        request,\n+        response,\n+        qsParams,\n+        APP_ID,\n+        ORG_ID,\n+        CORRELATION_ID,\n+        CLIENT_APP_VERSION,", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0Mzc1NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r456543754", "bodyText": "Login/Consent flow has multiple redirects, so I need APP_ID in consent, auto sign-in flows. ORG_ID will be removed in next PR. CORRELATION_ID and CLIENT_APP_VERSION for audit log event.", "author": "dhanyak-btc", "createdAt": "2020-07-17T16:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5OTA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5OTc5OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454699799", "bodyText": "this is pretty short for a normal cookie; Considering your cookieUtil has a generic name and signature, I suggest you either:\n\npass cookie's age as an input\nrename the class to signal that this is for a spacial usecase, i.e. loginCookie", "author": "zohrehj", "createdAt": "2020-07-14T23:20:11Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/CookieUtils.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.common;\n+\n+import javax.servlet.http.Cookie;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.util.MultiValueMap;\n+\n+public final class CookieUtils {\n+\n+  private CookieUtils() {}\n+\n+  public static void addCookies(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      MultiValueMap<String, String> params,\n+      String... cookieNames) {\n+    for (String cookieName : cookieNames) {\n+      addCookie(request, response, cookieName, params.getFirst(cookieName));\n+    }\n+  }\n+\n+  public static void addCookie(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      String cookieName,\n+      String cookieValue) {\n+    Cookie cookie = new Cookie(cookieName, cookieValue);\n+    cookie.setMaxAge(600);", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0NDA5OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r456544099", "bodyText": "Removed CookieUtils and moved the code to LoginController.", "author": "dhanyak-btc", "createdAt": "2020-07-17T16:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5OTc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMzg3OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454703878", "bodyText": "I am finding this approach a bit confusing; wouldn't it make sense to return a proper json error string and just display that instead?\nConsidering Auth server is not directly client facing, I don't think having an error page makes a lot of sense anyway.", "author": "zohrehj", "createdAt": "2020-07-14T23:33:04Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }\n+\n+    // show or skip login page\n+    MultiValueMap<String, String> paramMap = new LinkedMultiValueMap<>();\n+    paramMap.add(LOGIN_CHALLENGE, loginChallenge);\n+    ResponseEntity<JsonNode> requestLoginResponse = oauthService.requestLogin(paramMap);\n+    if (requestLoginResponse.getStatusCode().is2xxSuccessful()) {\n+      JsonNode responseBody = requestLoginResponse.getBody();\n+      if (skipLogin(responseBody)) {\n+        logger.exit(\"skip login, return to callback URL\");\n+        return redirectToCallbackUrl(request, code, response);\n+      }\n+      return redirectToLoginOrSigninPage(request, response, responseBody, model, loginChallenge);\n+    }\n+\n+    return \"error\";", "originalCommit": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0NjEyNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r456546127", "bodyText": "I agree with you. I initially thought auth server will display generic error page for any exceptions. It'll be removed in followup PR and redirected to error url (configurable for IOS/ANDROID/Participant Manager)", "author": "dhanyak-btc", "createdAt": "2020-07-17T16:26:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMzg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ1MTM0Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r457451347", "bodyText": "Please create an issue tracking this work and add a comment in the code to note the upcoming change.", "author": "zohrehj", "createdAt": "2020-07-20T14:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMzg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2NzA1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r457867056", "bodyText": "This comment has been addressed in #650 and #651", "author": "dhanyak-btc", "createdAt": "2020-07-21T06:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMzg3OA=="}], "type": "inlineReview"}, {"oid": "faf83f30764c78c44a58723377d16d1c8b495620", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/faf83f30764c78c44a58723377d16d1c8b495620", "message": "Fixed PR#615 review comments\n\nFixed PR#615 review comments", "committedDate": "2020-07-17T16:28:18Z", "type": "commit"}, {"oid": "dd9e56f539410efaf50e9d37e2ca366f4129d80f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dd9e56f539410efaf50e9d37e2ca366f4129d80f", "message": "addCookie and addCookies methods moved to LoginController\n\naddCookie and addCookies methods moved to LoginController hence this file is removed", "committedDate": "2020-07-19T05:48:50Z", "type": "commit"}, {"oid": "f3f55b1abf4b3912e198f495fa72703a71ebacb5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f3f55b1abf4b3912e198f495fa72703a71ebacb5", "message": "Added TODO comments with Issue/PR number in HTML files\n\nAdded TODO comments with Issue/PR number in HTML files", "committedDate": "2020-07-21T06:43:57Z", "type": "commit"}, {"oid": "395a2c1af1b14ebcadac2d8c0d832ebe470e3d77", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/395a2c1af1b14ebcadac2d8c0d832ebe470e3d77", "message": "Merge branch 'develop' into oauth_scim_login", "committedDate": "2020-07-31T16:00:09Z", "type": "commit"}, {"oid": "7393b8c5f7fcdee4e4daf2c563c28324f727324e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7393b8c5f7fcdee4e4daf2c563c28324f727324e", "message": "Merge branch 'develop' into oauth_scim_login", "committedDate": "2020-08-02T05:00:33Z", "type": "commit"}]}