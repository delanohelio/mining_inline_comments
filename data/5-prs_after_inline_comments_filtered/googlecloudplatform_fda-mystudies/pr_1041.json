{"pr_number": 1041, "pr_title": "OAuth Scim Service - Added /callback endpoint with integration tests and fixed reset password issue due to code merge", "pr_createdAt": "2020-09-26T09:29:28Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041", "timeline": [{"oid": "1434d0dd4b1ad698c6ee8908670672a9ee3feba2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1434d0dd4b1ad698c6ee8908670672a9ee3feba2", "message": "Added /callback endpoint with integration tests and fixed reset password issue due to code merge\n\nAdded /callback endpoint with integration tests and fixed reset password issue due to code merge", "committedDate": "2020-09-26T09:23:50Z", "type": "commit"}, {"oid": "c6788e42334497b420a3316d4894c2916a4f442b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c6788e42334497b420a3316d4894c2916a4f442b", "message": "Merge branch 'develop' into oauth_scim_callback_endpoint", "committedDate": "2020-09-26T09:32:40Z", "type": "commit"}, {"oid": "4203238a5831df21941db301ae74b333d0c49577", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4203238a5831df21941db301ae74b333d0c49577", "message": "Changed spring.jpa.show-sql value to false\n\nBuild failed with The forked VM terminated without properly saying goodbye. VM crash or System.exit called?", "committedDate": "2020-09-26T14:50:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEwODgxOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041#discussion_r496108819", "bodyText": "this is mobile platform specific code, yet nothing in the method or controller name suggests that.", "author": "zohrehj", "createdAt": "2020-09-28T17:13:34Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/CallbackController.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ACCOUNT_STATUS_COOKIE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ERROR_VIEW_NAME;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.MOBILE_PLATFORM_COOKIE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID_COOKIE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimEvent.SIGNIN_FAILED;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimEvent.SIGNIN_SUCCEEDED;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimEvent.SIGNIN_WITH_TEMPORARY_PASSWORD_SUCCEEDED;\n+\n+import com.google.cloud.healthcare.fdamystudies.beans.AuditLogEventRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.UserAccountStatus;\n+import com.google.cloud.healthcare.fdamystudies.mapper.AuditEventMapper;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimAuditHelper;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import javax.servlet.http.Cookie;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.web.bind.annotation.ExceptionHandler;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class CallbackController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(CallbackController.class.getName());\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @Autowired private AuthScimAuditHelper auditHelper;\n+\n+  @GetMapping(value = \"/callback\")\n+  public String login(\n+      @RequestParam String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    AuditLogEventRequest auditRequest = AuditEventMapper.fromHttpServletRequest(request);\n+\n+    if (StringUtils.isEmpty(code)) {\n+      logger.error(\"authorization code is empty, return error view\");\n+      auditHelper.logEvent(SIGNIN_FAILED, auditRequest);\n+      return ERROR_VIEW_NAME;\n+    }\n+\n+    String userId = getCookieValue(request, USER_ID_COOKIE);\n+    if (StringUtils.isEmpty(userId)) {\n+      logger.error(\"userId cookie value is empty, return error view\");\n+      auditHelper.logEvent(SIGNIN_FAILED, auditRequest);\n+      return ERROR_VIEW_NAME;\n+    }\n+\n+    String mobilePlatform = getCookieValue(request, MOBILE_PLATFORM_COOKIE);\n+    String accountStatus = getCookieValue(request, ACCOUNT_STATUS_COOKIE);\n+    String callbackUrl = redirectConfig.getCallbackUrl(mobilePlatform);", "originalCommit": "4203238a5831df21941db301ae74b333d0c49577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyMjkwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041#discussion_r496122905", "bodyText": "mobilePlatform value is used to get the callback redirect URL hence not used in the method or controller name\npublic enum MobilePlatform {\n  ANDROID(\"ANDROID\", \"Represents an Android platform\"),\n  IOS(\"IOS\", \"Represents an Apple platform\"),\n  UNKNOWN(\"UNKNOWN\", \"Any other value. Should not happen\");\n}", "author": "dhanyak-btc", "createdAt": "2020-09-28T17:38:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEwODgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE0MTE2NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041#discussion_r496141164", "bodyText": "Issue will be fixed in #1061. Resolving for now.", "author": "zohrehj", "createdAt": "2020-09-28T18:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEwODgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMDU5MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041#discussion_r496110590", "bodyText": "where is this used and how does it work if the request is coming from the mobile app?", "author": "zohrehj", "createdAt": "2020-09-28T17:16:42Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/CallbackController.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ACCOUNT_STATUS_COOKIE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ERROR_VIEW_NAME;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.MOBILE_PLATFORM_COOKIE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID_COOKIE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimEvent.SIGNIN_FAILED;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimEvent.SIGNIN_SUCCEEDED;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimEvent.SIGNIN_WITH_TEMPORARY_PASSWORD_SUCCEEDED;\n+\n+import com.google.cloud.healthcare.fdamystudies.beans.AuditLogEventRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.UserAccountStatus;\n+import com.google.cloud.healthcare.fdamystudies.mapper.AuditEventMapper;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimAuditHelper;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import javax.servlet.http.Cookie;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.web.bind.annotation.ExceptionHandler;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class CallbackController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(CallbackController.class.getName());\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @Autowired private AuthScimAuditHelper auditHelper;\n+\n+  @GetMapping(value = \"/callback\")\n+  public String login(\n+      @RequestParam String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    AuditLogEventRequest auditRequest = AuditEventMapper.fromHttpServletRequest(request);\n+\n+    if (StringUtils.isEmpty(code)) {\n+      logger.error(\"authorization code is empty, return error view\");\n+      auditHelper.logEvent(SIGNIN_FAILED, auditRequest);\n+      return ERROR_VIEW_NAME;\n+    }\n+\n+    String userId = getCookieValue(request, USER_ID_COOKIE);\n+    if (StringUtils.isEmpty(userId)) {\n+      logger.error(\"userId cookie value is empty, return error view\");\n+      auditHelper.logEvent(SIGNIN_FAILED, auditRequest);\n+      return ERROR_VIEW_NAME;\n+    }\n+\n+    String mobilePlatform = getCookieValue(request, MOBILE_PLATFORM_COOKIE);\n+    String accountStatus = getCookieValue(request, ACCOUNT_STATUS_COOKIE);\n+    String callbackUrl = redirectConfig.getCallbackUrl(mobilePlatform);\n+\n+    String redirectUrl =\n+        String.format(\n+            \"%s?code=%s&userId=%s&accountStatus=%s\", callbackUrl, code, userId, accountStatus);\n+\n+    if (UserAccountStatus.ACTIVE.getStatus() == Integer.parseInt(accountStatus)) {\n+      auditHelper.logEvent(SIGNIN_SUCCEEDED, auditRequest);\n+    } else {\n+      auditHelper.logEvent(SIGNIN_WITH_TEMPORARY_PASSWORD_SUCCEEDED, auditRequest);\n+    }\n+\n+    logger.exit(String.format(\"redirect to %s from /login\", callbackUrl));\n+    return redirect(response, redirectUrl);\n+  }\n+\n+  private String getCookieValue(HttpServletRequest request, String cookieName) {\n+    Cookie cookie = WebUtils.getCookie(request, cookieName);\n+    return cookie != null ? cookie.getValue() : null;\n+  }\n+\n+  private String redirect(HttpServletResponse response, String redirectUrl) {\n+    response.setHeader(\"Location\", redirectUrl);\n+    response.setStatus(HttpStatus.FOUND.value());\n+    return \"redirect:\" + redirectUrl;\n+  }\n+\n+  @ExceptionHandler(Exception.class)\n+  public ModelAndView handleError(HttpServletRequest req, Exception ex) {", "originalCommit": "4203238a5831df21941db301ae74b333d0c49577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyNDU4OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041#discussion_r496124589", "bodyText": "This method is called by the Spring framework if the any exception thrown from CallbackController class. This method returns Error view. It works same way for both mobile app or web application.", "author": "dhanyak-btc", "createdAt": "2020-09-28T17:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMDU5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMTUzOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041#discussion_r496111538", "bodyText": "looks like login_challenge is now required, why is that?\nsame with other changes. removing code and cookie value, why are they needed, and should they be in this PR?", "author": "zohrehj", "createdAt": "2020-09-28T17:18:30Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -96,36 +92,16 @@\n \n   @Autowired private AuthScimAuditHelper auditHelper;\n \n-  /**\n-   * @param loginChallenge is optional. ORY Hydra sends this field as query param when login/consent\n-   *     flow is initiated.\n-   * @param code ORY Hydra redirects to this path again when the login/consent flow is completed.\n-   *     ORY Hydra sends authorization 'code' and no login challenge in query params.\n-   * @param request\n-   * @param response\n-   * @param model\n-   * @return\n-   */\n   @GetMapping(value = \"/login\")\n   public String login(\n-      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n-      @RequestParam(required = false) String code,\n-      @CookieValue(name = ACCOUNT_STATUS_COOKIE, required = false) String accountStatus,\n+      @RequestParam(name = LOGIN_CHALLENGE) String loginChallenge,", "originalCommit": "4203238a5831df21941db301ae74b333d0c49577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyNTY3OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041#discussion_r496125679", "bodyText": "Yes, login_challenge is required param, default value is true.\npublic @interface RequestParam {\n       boolean required() default true;\n}", "author": "dhanyak-btc", "createdAt": "2020-09-28T17:43:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMTUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEzMDA5Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041#discussion_r496130096", "bodyText": "code and accountStatus params moved to CallbackController class.", "author": "dhanyak-btc", "createdAt": "2020-09-28T17:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMTUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExNDU1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041#discussion_r496114553", "bodyText": "looks like a bug fix, but outside of the scope of this PR.", "author": "zohrehj", "createdAt": "2020-09-28T17:23:44Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -207,15 +204,17 @@ public ResetPasswordResponse resetPassword(\n       throw new ErrorCodeException(ErrorCode.ACCOUNT_DEACTIVATED);\n     }\n \n+    Integer accountStatusBeforePasswordReset = userEntity.getStatus();", "originalCommit": "4203238a5831df21941db301ae74b333d0c49577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyNzE2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1041#discussion_r496127166", "bodyText": "Code merge was not done properly by another developer, this caused an issue while testing my code changes so I had to fix the issue in this PR. I mentioned the same in PR description.", "author": "dhanyak-btc", "createdAt": "2020-09-28T17:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExNDU1Mw=="}], "type": "inlineReview"}, {"oid": "83abfbb9daf3ca3e1e09abccd0b3d64e69663223", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/83abfbb9daf3ca3e1e09abccd0b3d64e69663223", "message": "Merge branch 'develop' into oauth_scim_callback_endpoint", "committedDate": "2020-09-28T17:29:00Z", "type": "commit"}, {"oid": "348e32b191290f39fdf47ca26c7f6fb29e54a331", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/348e32b191290f39fdf47ca26c7f6fb29e54a331", "message": "Added TODO for Issue #1061\n\nAdded TODO for Issue #1061", "committedDate": "2020-09-28T18:04:36Z", "type": "commit"}]}