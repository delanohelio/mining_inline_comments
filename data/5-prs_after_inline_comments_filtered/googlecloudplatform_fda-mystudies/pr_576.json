{"pr_number": 576, "pr_title": "/v1/oauth2/token endpoint implementation with integration tests", "pr_createdAt": "2020-06-27T03:42:08Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/576", "timeline": [{"oid": "f15daaddf4b84f9107335c970b581b76e53adbe7", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f15daaddf4b84f9107335c970b581b76e53adbe7", "message": "/v1/oauth2/token endpoint implementation with integration tests\n\n/v1/oauth2/token endpoint implementation with integration tests", "committedDate": "2020-06-27T03:41:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI0OTc4MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/576#discussion_r451249780", "bodyText": "you have defined grantType above. just use that.", "author": "zohrehj", "createdAt": "2020-07-08T02:42:33Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/OAuthController.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.RequestParamValidator.validateRequiredParams;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.AUTHORIZATION_CODE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CODE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CODE_VERIFIER;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.GRANT_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.REDIRECT_URI;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.REFRESH_TOKEN;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SCOPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.beans.ValidationErrorResponse;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import javax.servlet.http.HttpServletRequest;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.CrossOrigin;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.bind.annotation.RequestHeader;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@CrossOrigin\n+@RestController\n+@RequestMapping(\"/v1\")\n+public class OAuthController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(OAuthController.class.getName());\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @PostMapping(\n+      value = \"/oauth2/token\",\n+      produces = MediaType.APPLICATION_JSON_VALUE,\n+      consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)\n+  public ResponseEntity<?> getToken(\n+      @RequestParam MultiValueMap<String, String> paramMap,\n+      @RequestHeader HttpHeaders headers,\n+      HttpServletRequest request) {\n+    logger.entry(String.format(\"begin %s request\", request.getRequestURI()));\n+\n+    String grantType = paramMap.getFirst(GRANT_TYPE);\n+\n+    // validate required params\n+    ValidationErrorResponse errors = null;\n+    if (REFRESH_TOKEN.equals(paramMap.getFirst(GRANT_TYPE))) {", "originalCommit": "f15daaddf4b84f9107335c970b581b76e53adbe7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MDE3OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/576#discussion_r451250179", "bodyText": "nit: could be more readable as a switch statement.", "author": "zohrehj", "createdAt": "2020-07-08T02:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI0OTc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI4OTYwNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/576#discussion_r451289607", "bodyText": "Refactored the code and used switch statement", "author": "dhanyak-btc", "createdAt": "2020-07-08T05:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI0OTc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MTU0Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/576#discussion_r451251547", "bodyText": "this piece is getting repeated everywhere, it would be nice to extract and reuse it instead.", "author": "zohrehj", "createdAt": "2020-07-08T02:49:47Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.service;\n+\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.AUTHORIZATION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.GRANT_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.REFRESH_TOKEN;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.service.BaseServiceImpl;\n+import java.util.Base64;\n+import javax.annotation.PostConstruct;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.MultiValueMap;\n+\n+@Service\n+class HydraOAuthServiceImpl extends BaseServiceImpl implements OAuthService {\n+\n+  @Value(\"${security.oauth2.hydra.token_endpoint}\")\n+  private String tokenEndpoint;\n+\n+  @Value(\"${security.oauth2.hydra.client.client-id}\")\n+  private String clientId;\n+\n+  @Value(\"${security.oauth2.hydra.client.client-secret}\")\n+  private String clientSecret;\n+\n+  private String encodedAuthorization;\n+\n+  @PostConstruct\n+  public void init() {\n+    String credentials = clientId + \":\" + clientSecret;\n+    encodedAuthorization = \"Basic \" + Base64.getEncoder().encodeToString(credentials.getBytes());", "originalCommit": "f15daaddf4b84f9107335c970b581b76e53adbe7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI5MjQ3OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/576#discussion_r451292478", "bodyText": "Extracted the code to getEncodedAuthorization(String clientId, String clientSecret) in BaseServiceImpl", "author": "dhanyak-btc", "createdAt": "2020-07-08T05:31:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MTU0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MzY0Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/576#discussion_r451253643", "bodyText": "As far as I know this is the only server with versioning in the URL, I don't remember any designs or plans to include versioning here; please explain this approach and share the appropriate design doc/discussion with me.", "author": "zohrehj", "createdAt": "2020-07-08T02:57:29Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/OAuthController.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.RequestParamValidator.validateRequiredParams;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.AUTHORIZATION_CODE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CODE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CODE_VERIFIER;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.GRANT_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.REDIRECT_URI;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.REFRESH_TOKEN;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SCOPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.beans.ValidationErrorResponse;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import javax.servlet.http.HttpServletRequest;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.CrossOrigin;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.bind.annotation.RequestHeader;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@CrossOrigin\n+@RestController\n+@RequestMapping(\"/v1\")", "originalCommit": "f15daaddf4b84f9107335c970b581b76e53adbe7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI5NDc1Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/576#discussion_r451294757", "bodyText": "I used versioning for APIs during Hydra POC. It follows Best Practices for Versioning REST APIs. I'll remove the versioning and correct the tests to keep it consistent with other services.", "author": "dhanyak-btc", "createdAt": "2020-07-08T05:39:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MzY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU1Nzc3MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/576#discussion_r451557771", "bodyText": "it's a good point and we should consider versioning them, but yes, let's do a design and decide on the change for all services.", "author": "zohrehj", "createdAt": "2020-07-08T13:48:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MzY0Mw=="}], "type": "inlineReview"}, {"oid": "7ccbd6b280c1e63e910378b11d34fb6fe1dcb135", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7ccbd6b280c1e63e910378b11d34fb6fe1dcb135", "message": "PR#576: Fixed Review Comments\n\nRemoved /v1 from API endpoints\nReplaced if..elseif with switch in OAuthController classes\nFormatted JSON files using JSON Editor Plugin 1.1.2", "committedDate": "2020-07-08T06:20:02Z", "type": "commit"}, {"oid": "794437c2e0fea43f20f61cc1033a220360164d9f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/794437c2e0fea43f20f61cc1033a220360164d9f", "message": "Merge branch 'develop' into oauth-scim-module_token_endpoint", "committedDate": "2020-07-13T11:03:25Z", "type": "commit"}, {"oid": "ace25161b878c71b0eaf4fbb4faaf8f7479cf93c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ace25161b878c71b0eaf4fbb4faaf8f7479cf93c", "message": "Merge branch 'develop' into oauth-scim-module_token_endpoint", "committedDate": "2020-07-17T07:53:26Z", "type": "commit"}]}