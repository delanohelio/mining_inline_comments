{"pr_number": 2524, "pr_title": "Consent Management Service: Server side validation", "pr_createdAt": "2020-12-22T14:14:54Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2524", "timeline": [{"oid": "0c943de2096df2e64dc948ee059650d671901347", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0c943de2096df2e64dc948ee059650d671901347", "message": "server-side-validation", "committedDate": "2020-12-22T14:08:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwMTEyNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2524#discussion_r547301127", "bodyText": "[consent-mgmt Checks] reported by reviewdog \ud83d\udc36\nDistance between variable 'message' declaration and its first usage is 10, but allowed 3.  Consider making that variable final if you still need to store its value in advance (before method calls that might have side effects on the original value).", "author": "github-actions", "createdAt": "2020-12-22T14:15:48Z", "path": "participant-datastore/consent-mgmt-module/consent-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/UserConsentManagementController.java", "diffHunk": "@@ -99,127 +100,84 @@\n     ErrorBean errorBean = null;\n     StudyInfoBean studyInfoBean = null;\n     String userDetailId = String.valueOf(0);\n-\n     String consentdocumentFilepath = null;\n-    if ((consentStatusBean != null)\n-        && (consentStatusBean.getConsent() != null)\n-        && ((consentStatusBean.getConsent().getVersion() != null)\n-            && (consentStatusBean.getConsent().getPdf() != null))\n-        && (consentStatusBean.getConsent().getStatus() != null)) {\n-\n-      if (!StringUtils.isEmpty(consentStatusBean.getStudyId()) && !StringUtils.isEmpty(userId)) {\n-        auditRequest.setUserId(userId);\n-        auditRequest.setStudyId(consentStatusBean.getStudyId());\n \n-        studyInfoBean = userConsentManagementService.getStudyInfoId(consentStatusBean.getStudyId());\n-        Optional<StudyEntity> optStudy = studyRepository.findById(studyInfoBean.getStudyInfoId());\n+    auditRequest.setUserId(userId);\n+    auditRequest.setStudyId(consentStatusBean.getStudyId());\n \n-        ParticipantStudyEntity participantStudies =\n-            userConsentManagementService.getParticipantStudies(\n-                studyInfoBean.getStudyInfoId(), userId);\n-        if (participantStudies != null) {\n-          if (consentStatusBean.getEligibility() != null) {\n-            participantStudies.setEligibility(consentStatusBean.getEligibility());\n-          }\n-          DataSharingStatus dataSharing =\n-              DataSharingStatus.fromValue(consentStatusBean.getSharing());\n-          if (dataSharing == null) {\n-            throw new ErrorCodeException(\n-                com.google.cloud.healthcare.fdamystudies.common.ErrorCode\n-                    .INVALID_DATA_SHARING_STATUS);\n-          }\n-          participantStudies.setSharing(dataSharing.value());\n+    studyInfoBean = userConsentManagementService.getStudyInfoId(consentStatusBean.getStudyId());\n+    Optional<StudyEntity> optStudy = studyRepository.findById(studyInfoBean.getStudyInfoId());\n \n-          List<ParticipantStudyEntity> participantStudiesList =\n-              new ArrayList<ParticipantStudyEntity>();\n-          participantStudiesList.add(participantStudies);\n-          String message =\n-              userConsentManagementService.saveParticipantStudies(participantStudiesList);\n-\n-          if (!StringUtils.isEmpty(consentStatusBean.getConsent().getVersion())) {\n-            userDetailId = userConsentManagementService.getUserDetailsId(userId);\n-            Optional<UserDetailsEntity> optUser = userDetailsRepository.findById(userDetailId);\n+    ParticipantStudyEntity participantStudies =\n+        userConsentManagementService.getParticipantStudies(studyInfoBean.getStudyInfoId(), userId);\n+    if (participantStudies != null) {\n+      if (consentStatusBean.getEligibility() != null) {\n+        participantStudies.setEligibility(consentStatusBean.getEligibility());\n+      }\n+      DataSharingStatus dataSharing = DataSharingStatus.fromValue(consentStatusBean.getSharing());\n+      if (dataSharing == null) {\n+        throw new ErrorCodeException(\n+            com.google.cloud.healthcare.fdamystudies.common.ErrorCode.INVALID_DATA_SHARING_STATUS);\n+      }\n+      participantStudies.setSharing(dataSharing.value());\n \n-            StudyConsentEntity studyConsent = new StudyConsentEntity();\n-            if (optUser.isPresent()) {\n-              studyConsent.setUserDetails(optUser.get());\n-            }\n+      List<ParticipantStudyEntity> participantStudiesList = new ArrayList<ParticipantStudyEntity>();\n+      participantStudiesList.add(participantStudies);\n+      String message = userConsentManagementService.saveParticipantStudies(participantStudiesList);", "originalCommit": "0c943de2096df2e64dc948ee059650d671901347", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0MjY0Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2524#discussion_r547342642", "bodyText": "Fixed the comment.", "author": "navya-BTC", "createdAt": "2020-12-22T15:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwMTEyNw=="}], "type": "inlineReview"}, {"oid": "9992b0bfe31a143ed2c23901d77bcefdaf57c27b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9992b0bfe31a143ed2c23901d77bcefdaf57c27b", "message": "Update UserConsentManagementController.java", "committedDate": "2020-12-22T15:20:29Z", "type": "commit"}, {"oid": "a2977bd043d5cbd4b6fd5dd10fda52d638d07961", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a2977bd043d5cbd4b6fd5dd10fda52d638d07961", "message": "Merge branch 'develop' into consent-server-side-validation", "committedDate": "2020-12-28T08:13:52Z", "type": "commit"}]}