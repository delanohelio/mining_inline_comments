{"pr_number": 2384, "pr_title": "[participant-manager-datastore] [participant-datastore]: Enrollment history implementation", "pr_createdAt": "2020-12-14T19:22:33Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384", "timeline": [{"oid": "dfd39fcfa6f39e98d0858c5d28516c9c5ab1f7ec", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dfd39fcfa6f39e98d0858c5d28516c9c5ab1f7ec", "message": "App Participant and Participant Detail API changes\n\nApp Participant and Participant Detail API changes", "committedDate": "2020-12-14T18:50:41Z", "type": "commit"}, {"oid": "382c88f8fe69d245e2d3234fe6d1d2b7d18208a1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/382c88f8fe69d245e2d3234fe6d1d2b7d18208a1", "message": "enrollment history added for enroll and withdrawal flow", "committedDate": "2020-12-14T19:18:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5NzY5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r542697697", "bodyText": "same comment as previous PR, using a more readable format could make future debugs easier. e.g. use \"-\" or similar", "author": "zohrehj", "createdAt": "2020-12-14T19:42:33Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/model/ParticipantEnrollmentHistory.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+package com.google.cloud.healthcare.fdamystudies.model;\n+\n+import java.sql.Timestamp;\n+\n+public interface ParticipantEnrollmentHistory {\n+  String getLocationCustomId();\n+\n+  String getLocationName();\n+\n+  String getStudyId();\n+\n+  String getSiteId();\n+\n+  String getUserDetailsId();\n+\n+  String getEnrollmentStatus();\n+\n+  Timestamp getCreated();\n+\n+  default String getUserIdStudyIdKey() {\n+    return getUserDetailsId() + getStudyId();\n+  }\n+\n+  default String getUserIdStudyIdSiteIdKey() {\n+    return getUserDetailsId() + getStudyId() + getSiteId();", "originalCommit": "382c88f8fe69d245e2d3234fe6d1d2b7d18208a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5OTA5OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543099099", "bodyText": "Fixed Review comment.", "author": "monica-BTC", "createdAt": "2020-12-15T07:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5NzY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjcwMDI3MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r542700271", "bodyText": "why is sortBy and sortDirection getting combined?\nthey would need to get separated before they can be applied, so why combine them in the first place?", "author": "zohrehj", "createdAt": "2020-12-14T19:45:03Z", "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/AppController.java", "diffHunk": "@@ -97,14 +96,7 @@\n \n     AppParticipantsResponse appParticipantsResponse =\n         appService.getAppParticipants(\n-            appId,\n-            userId,\n-            auditRequest,\n-            excludeParticipantStudyStatus,\n-            limit,\n-            offset,\n-            sortBy + \"_\" + sortDirection,\n-            searchTerm);\n+            appId, userId, auditRequest, limit, offset, sortBy + \"_\" + sortDirection, searchTerm);", "originalCommit": "382c88f8fe69d245e2d3234fe6d1d2b7d18208a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5MzM1Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543093357", "bodyText": "We tried to append the ASC or DESC to the query at the end but it didn't work. ASC or DESC should appear after the END  so we combined sortBy and sortDirection as orderByCondition.\nWHEN 'email_asc' THEN ud.email END ASC,\nWHEN 'email_desc THEN ud.email END DESC,", "author": "dhanyak-btc", "createdAt": "2020-12-15T06:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjcwMDI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjcwMjUyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r542702529", "bodyText": "looks like you are not handling anything but ASC, so you might as well remove sort direction from inputs and only pass the order by value here.\nalso your SQL is generating two ASC back to back", "author": "zohrehj", "createdAt": "2020-12-14T19:47:13Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/AppRepository.java", "diffHunk": "@@ -135,31 +134,10 @@\n   @Query(\n       value =\n           \"SELECT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n-              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n+              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType \"\n               + \"FROM user_details ud \"\n-              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n-              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id  AND ps.status NOT IN (:excludeParticipantStudyStatus) \"\n-              + \"WHERE ud.app_info_id=:appId AND ud.id IN (:userDetailIds) \"\n-              + \"ORDER BY CASE :orderByCondition WHEN 'email_asc' THEN ud.email END ASC, \"\n-              + \"         CASE :orderByCondition WHEN 'registrationDate_asc' THEN ud.verification_time END ASC, \"\n-              + \"         CASE :orderByCondition WHEN 'registrationStatus_asc' THEN ud.status END ASC, \"\n-              + \"         CASE :orderByCondition WHEN 'email_desc' THEN ud.email END DESC, \"\n-              + \"         CASE :orderByCondition WHEN 'registrationDate_desc' THEN ud.verification_time END DESC, \"\n-              + \"         CASE :orderByCondition WHEN 'registrationStatus_desc' THEN ud.status END DESC \",\n-      nativeQuery = true)\n-  public List<AppParticipantsInfo> findUserDetailsByAppIdAndStudyStatus(\n-      String appId,\n-      String[] excludeParticipantStudyStatus,\n-      List<String> userDetailIds,\n-      String orderByCondition);\n-\n-  @Query(\n-      value =\n-          \"SELECT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n-              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n-              + \"FROM user_details ud \"\n-              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n-              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id \"\n+              + \"LEFT JOIN participant_enrollment_history peh ON ud.id = peh.user_details_id \"\n+              + \"LEFT JOIN study_info st ON st.id=peh.study_info_id \"\n               + \"WHERE ud.app_info_id=:appId AND ud.id IN (:userDetailIds) \"\n               + \"ORDER BY CASE :orderByCondition WHEN 'email_asc' THEN ud.email END ASC, \"\n               + \"         CASE :orderByCondition WHEN 'registrationDate_asc' THEN ud.verification_time END ASC, \"", "originalCommit": "382c88f8fe69d245e2d3234fe6d1d2b7d18208a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5MzY2Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543093667", "bodyText": "Above comment applies to this review comment. DESC is handled at line 146", "author": "dhanyak-btc", "createdAt": "2020-12-15T07:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjcwMjUyOQ=="}], "type": "inlineReview"}, {"oid": "48bada15b059c19bc510709f0c0950efefa29960", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/48bada15b059c19bc510709f0c0950efefa29960", "message": "Merge branch 'develop' into enrollment-changes", "committedDate": "2020-12-15T04:30:36Z", "type": "commit"}, {"oid": "990e58208c3c899ff1134e657510394ed653358b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/990e58208c3c899ff1134e657510394ed653358b", "message": "Merge branch 'develop' into enrollment-changes", "committedDate": "2020-12-15T07:01:50Z", "type": "commit"}, {"oid": "e3537f604de8c555c0111da68a6e3f57643e9546", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e3537f604de8c555c0111da68a6e3f57643e9546", "message": "Fixed Review Comment\n\nFixed Review Comment", "committedDate": "2020-12-15T07:04:12Z", "type": "commit"}, {"oid": "d98a0fdcb682bb6d4685ce1b73518b25d3ab52f7", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d98a0fdcb682bb6d4685ce1b73518b25d3ab52f7", "message": "Merge branch 'enrollment-changes' of https://github.com/GoogleCloudPlatform/fda-mystudies into enrollment-changes", "committedDate": "2020-12-15T07:05:42Z", "type": "commit"}, {"oid": "1a85a18d6861757de90eb8085468e4234dd5341f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1a85a18d6861757de90eb8085468e4234dd5341f", "message": "Merge branch 'develop' into enrollment-changes", "committedDate": "2020-12-15T14:47:49Z", "type": "commit"}, {"oid": "daa26232a39fee6e2b79054ca45b7af0ec35eba9", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/daa26232a39fee6e2b79054ca45b7af0ec35eba9", "message": "currect enrollment status, date and withdrawal date added to getParticipantDetails api", "committedDate": "2020-12-15T15:25:26Z", "type": "commit"}, {"oid": "9d8e209f1b6c0db6ebaa085072c7f389ef04f1bb", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9d8e209f1b6c0db6ebaa085072c7f389ef04f1bb", "message": "Merge branch 'develop' into enrollment-changes", "committedDate": "2020-12-15T15:30:46Z", "type": "commit"}, {"oid": "06618a1f2fad61fcac68fd95dece2ba7cff42e26", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/06618a1f2fad61fcac68fd95dece2ba7cff42e26", "message": "/enroll flow changes\n\n/enroll flow changes", "committedDate": "2020-12-15T16:15:57Z", "type": "commit"}, {"oid": "8696f648a984252bb71f380d8986d2bd4cd9c724", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8696f648a984252bb71f380d8986d2bd4cd9c724", "message": "Merge branch 'develop' into enrollment-changes", "committedDate": "2020-12-15T16:20:09Z", "type": "commit"}, {"oid": "3e94edb9f567143ef5ebbab805fc0d551bbd8881", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3e94edb9f567143ef5ebbab805fc0d551bbd8881", "message": "Merge branch 'develop' into enrollment-changes", "committedDate": "2020-12-15T16:31:21Z", "type": "commit"}, {"oid": "c7ae09c4d5506e6d571b9b19ca81ffe1eab1491c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c7ae09c4d5506e6d571b9b19ca81ffe1eab1491c", "message": "Enrollment Status Changes in ParticipantDetails, App Participants, withrawFromStudy and deactivateAccnt\n\nEnrollment Status Changes in ParticipantDetails, App Participants, withrawFromStudy and deactivateAccnt", "committedDate": "2020-12-15T17:12:10Z", "type": "commit"}, {"oid": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4", "message": "Merge branch 'develop' into enrollment-changes", "committedDate": "2020-12-15T17:16:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NDY3Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543554673", "bodyText": "what if this value is already set?\nIt should come from the database and only be set in enroll/withdraw action where the status is being changed.", "author": "zohrehj", "createdAt": "2020-12-15T17:46:05Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantStatusHistoryMapper.java", "diffHunk": "@@ -29,6 +31,12 @@ public static ParticipantEnrollmentHistoryEntity toParticipantStatusHistoryEntit\n     participantStatusEntity.setStudy(participantRegistrySiteEntity.getStudy());\n     participantStatusEntity.setParticipantRegistrySite(participantRegistrySiteEntity);\n     participantStatusEntity.setUserDetails(userDetails);\n+    Timestamp now = new Timestamp(Instant.now().toEpochMilli());\n+    if (EnrollmentStatus.ENROLLED.equals(enrollment)) {\n+      participantStatusEntity.setEnrolledDate(now);\n+    } else if (EnrollmentStatus.WITHDRAWN.equals(enrollment)) {\n+      participantStatusEntity.setWithdrawalDate(now);", "originalCommit": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4MDUzNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r544280537", "bodyText": "Removed else if condition as this method will be called when participant with Enrollment Status as enrolled.", "author": "monica-BTC", "createdAt": "2020-12-16T13:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NDY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NTU5MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543555590", "bodyText": "keep the names consistent, is it a date, time or timestamp?", "author": "zohrehj", "createdAt": "2020-12-15T17:47:18Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/model/ParticipantEnrollmentHistoryEntity.java", "diffHunk": "@@ -66,6 +66,12 @@\n   @CreationTimestamp\n   private Timestamp created;\n \n+  @Column(name = \"withdrawal_time\")\n+  private Timestamp withdrawalDate;\n+\n+  @Column(name = \"enrolled_time\")\n+  private Timestamp enrolledDate;", "originalCommit": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA3MjQ0Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r544072446", "bodyText": "We copied these fields from ParticipantStudyEntity class for consistency. We may need to change code at many places if we rename the fields or columns.", "author": "dhanyak-btc", "createdAt": "2020-12-16T07:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NTU5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQzMDM5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r544430398", "bodyText": "This will be a breaking change after the public launch, please fix here for now and file an issue to fix in the ParticipantStudyEntity", "author": "zohrehj", "createdAt": "2020-12-16T16:15:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NTU5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NTg0NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543555844", "bodyText": "why change the order?", "author": "zohrehj", "createdAt": "2020-12-15T17:47:36Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/ParticipantEnrollmentHistoryRepository.java", "diffHunk": "@@ -25,24 +27,44 @@\n     extends JpaRepository<ParticipantEnrollmentHistoryEntity, String> {\n   @Query(\n       value =\n-          \"SELECT DISTINCT peh.site_id AS siteId, peh.user_details_id AS userDetailsId, peh.study_info_id AS studyId, \"\n-              + \"peh.status AS enrollmentStatus, peh.created_time AS created, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n+          \"SELECT peh.site_id AS siteId, peh.user_details_id AS userDetailsId, peh.study_info_id AS studyId, \"\n+              + \"peh.status AS enrollmentStatus, peh.withdrawal_time AS withdrawalDate,  peh.enrolled_time AS enrolledDate, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n               + \"FROM participant_enrollment_history peh, locations loc, sites s \"\n               + \"WHERE peh.site_id=s.id AND s.location_id=loc.id AND peh.status IN ('enrolled','withdrawn') AND \"\n               + \"peh.user_details_id IN (:userIds) AND peh.app_info_id=:appId \"\n-              + \"ORDER BY peh.user_details_id, peh.study_info_id, peh.site_id, peh.created_time DESC\",\n+              + \"ORDER BY loc.name DESC\",", "originalCommit": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA3NDI5Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r544074296", "bodyText": "We've added enrollment & withdrawal date columns that simplified the logic to prepare the response object. We are displaying the sites (location name) so added ORDER BY for location name.", "author": "dhanyak-btc", "createdAt": "2020-12-16T07:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NTg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NzUzNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543557535", "bodyText": "why do you have an OR here?\nare you expecting to pass an incorrect value to userId or participantRegistryId?", "author": "zohrehj", "createdAt": "2020-12-15T17:49:58Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/ParticipantEnrollmentHistoryRepository.java", "diffHunk": "@@ -25,24 +27,44 @@\n     extends JpaRepository<ParticipantEnrollmentHistoryEntity, String> {\n   @Query(\n       value =\n-          \"SELECT DISTINCT peh.site_id AS siteId, peh.user_details_id AS userDetailsId, peh.study_info_id AS studyId, \"\n-              + \"peh.status AS enrollmentStatus, peh.created_time AS created, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n+          \"SELECT peh.site_id AS siteId, peh.user_details_id AS userDetailsId, peh.study_info_id AS studyId, \"\n+              + \"peh.status AS enrollmentStatus, peh.withdrawal_time AS withdrawalDate,  peh.enrolled_time AS enrolledDate, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n               + \"FROM participant_enrollment_history peh, locations loc, sites s \"\n               + \"WHERE peh.site_id=s.id AND s.location_id=loc.id AND peh.status IN ('enrolled','withdrawn') AND \"\n               + \"peh.user_details_id IN (:userIds) AND peh.app_info_id=:appId \"\n-              + \"ORDER BY peh.user_details_id, peh.study_info_id, peh.site_id, peh.created_time DESC\",\n+              + \"ORDER BY loc.name DESC\",\n       nativeQuery = true)\n   public List<ParticipantEnrollmentHistory> findParticipantEnrollmentHistoryByAppId(\n       String appId, List<String> userIds);\n \n   @Query(\n       value =\n-          \"SELECT DISTINCT peh.status AS enrollmentStatus, peh.created_time AS created \"\n+          \"SELECT peh.status AS enrollmentStatus, peh.withdrawal_time AS withdrawalDate,  peh.enrolled_time AS enrolledDate \"\n               + \"FROM participant_enrollment_history peh \"\n               + \"WHERE peh.site_id=:siteId AND peh.study_info_id=:studyId AND \"\n               + \"peh.participant_registry_site_id=:participantRegistryId AND peh.app_info_id=:appId \"\n               + \"ORDER BY peh.created_time DESC\",\n       nativeQuery = true)\n   public List<ParticipantEnrollmentHistory> findByAppIdSiteIdAndStudyId(\n       String appId, String studyId, String siteId, String participantRegistryId);\n+\n+  @Modifying\n+  @Transactional\n+  @Query(\n+      value =\n+          \"UPDATE participant_enrollment_history SET status=:status, withdrawal_time= now() WHERE \"\n+              + \"withdrawal_time IS NULL AND study_info_id=:studyId AND \"\n+              + \"(user_details_id =:userId OR participant_registry_site_id=:participantRegistryId)\",", "originalCommit": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI3NzU4Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r544277583", "bodyText": "Updated a query by removing participantRegistryId.", "author": "monica-BTC", "createdAt": "2020-12-16T12:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NzUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2MDU1OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543560559", "bodyText": "comment is not needed.", "author": "zohrehj", "createdAt": "2020-12-15T17:54:07Z", "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/AppServiceImpl.java", "diffHunk": "@@ -447,48 +448,33 @@ public AppParticipantsResponse getAppParticipants(\n         participantEnrollmentHistoryRepository.findParticipantEnrollmentHistoryByAppId(\n             app.getId(), userIds);\n \n-    Map<String, AppSiteDetails> enrollmentHistoryMap = new HashMap<>();\n     Map<String, List<AppSiteDetails>> sitesByUserIdStudyIdMap = new HashMap<>();\n \n     List<AppSiteDetails> appSites = null;\n     AppSiteDetails appSiteDetails = null;\n-    String createdDate = null;\n     for (ParticipantEnrollmentHistory enrollmentHistory : enrollmentHistoryEntities) {\n-      createdDate = DateTimeUtils.format(enrollmentHistory.getCreated());\n       if (!sitesByUserIdStudyIdMap.containsKey(enrollmentHistory.getUserIdStudyIdKey())) {\n         appSites = new ArrayList<>();\n         sitesByUserIdStudyIdMap.put(enrollmentHistory.getUserIdStudyIdKey(), appSites);\n       }\n       appSites = sitesByUserIdStudyIdMap.get(enrollmentHistory.getUserIdStudyIdKey());\n-      if (!enrollmentHistoryMap.containsKey(enrollmentHistory.getUserIdStudyIdSiteIdKey())) {\n-        appSiteDetails = prepareAppSiteDetails(createdDate, enrollmentHistory);\n-        enrollmentHistoryMap.put(enrollmentHistory.getUserIdStudyIdSiteIdKey(), appSiteDetails);\n-        appSites.add(appSiteDetails);\n-        continue;\n-      }\n-\n-      appSiteDetails = enrollmentHistoryMap.get(enrollmentHistory.getUserIdStudyIdSiteIdKey());\n-\n-      if (StringUtils.isEmpty(appSiteDetails.getWithdrawlDate())\n-          && EnrollmentStatus.WITHDRAWN\n-              .getStatus()\n-              .equals(enrollmentHistory.getEnrollmentStatus())) {\n-        appSiteDetails.setWithdrawlDate(StringUtils.defaultIfEmpty(createdDate, NOT_APPLICABLE));\n-      } else if (StringUtils.isEmpty(appSiteDetails.getEnrollmentDate())\n-          && EnrollmentStatus.ENROLLED\n-              .getStatus()\n-              .equals(enrollmentHistory.getEnrollmentStatus())) {\n-        appSiteDetails.setEnrollmentDate(StringUtils.defaultIfEmpty(createdDate, NOT_APPLICABLE));\n-      }\n+      appSiteDetails = prepareAppSiteDetails(enrollmentHistory);\n+      appSites.add(appSiteDetails);\n     }\n \n+    // H2 Database throws error ORDER_BY_NOT_IN_RESULT Order by expression ID must be in the result\n+    // list in this case when DISTINCT is added to the SQL query so removing duplicates using\n+    // HashSet", "originalCommit": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDAxNzAxMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r544017012", "bodyText": "Removed commented lines.", "author": "monica-BTC", "createdAt": "2020-12-16T06:20:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2MDU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2MTIyNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543561224", "bodyText": "if user is enrolled, then withdrawal date should be empty, no?", "author": "zohrehj", "createdAt": "2020-12-15T17:55:03Z", "path": "participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java", "diffHunk": "@@ -1452,6 +1455,12 @@ public void shouldReturnParticipantDetailsForEnrollmentHistory() throws Exceptio\n         .andExpect(jsonPath(\"$.participantDetails.consentHistory\").isArray())\n         .andExpect(jsonPath(\"$.participantDetails.consentHistory\", hasSize(1)))\n         .andExpect(jsonPath(\"$.participantDetails.invitationDate\").isNotEmpty())\n+        .andExpect(jsonPath(\"$.participantDetails.enrollmentDate\").isNotEmpty())\n+        .andExpect(jsonPath(\"$.participantDetails.withdrawalDate\").isNotEmpty())", "originalCommit": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI3NzE1NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r544277155", "bodyText": "If enrollmentDate and withdrawalDate is empty we are setting it to default value as NOT_APPLICABLE. Changed expected value -\n```\n.andExpect(jsonPath(\"$.participantDetails.enrollmentDate\", is(NOT_APPLICABLE)))\n.andExpect(jsonPath(\"$.participantDetails.withdrawalDate\", is(NOT_APPLICABLE)))", "author": "monica-BTC", "createdAt": "2020-12-16T12:57:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2MTIyNA=="}], "type": "inlineReview"}, {"oid": "3be3d19e5684683f60d3e1ea2632e2ef7c069791", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3be3d19e5684683f60d3e1ea2632e2ef7c069791", "message": "Fixed Review comment\n\nFixed Review comment", "committedDate": "2020-12-16T06:12:35Z", "type": "commit"}, {"oid": "d0f3374b618947e9d7b152a6d9808240ee82f357", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d0f3374b618947e9d7b152a6d9808240ee82f357", "message": "Merge branch 'develop' into enrollment-changes", "committedDate": "2020-12-16T06:16:45Z", "type": "commit"}, {"oid": "311bb3764d581c0ab664d80c2b1d3928b562b8d1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/311bb3764d581c0ab664d80c2b1d3928b562b8d1", "message": "Issue fixes and comment fixes\n\nIssue fixes and comment fixes", "committedDate": "2020-12-16T12:40:22Z", "type": "commit"}, {"oid": "96352f89c8bbea18ba184cde459e29e871807c8d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/96352f89c8bbea18ba184cde459e29e871807c8d", "message": "Update mystudies_participant_datastore_db_script.sql", "committedDate": "2020-12-16T15:03:59Z", "type": "commit"}, {"oid": "34f1ca08634ceb0cf5ce42ce85cd87602f2116fd", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/34f1ca08634ceb0cf5ce42ce85cd87602f2116fd", "message": "Merge branch 'develop' into enrollment-changes", "committedDate": "2020-12-16T16:22:01Z", "type": "commit"}]}