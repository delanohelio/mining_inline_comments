{"pr_number": 2094, "pr_title": "[participant-manager-datastore] : Fixed Performance Issue in GET /apps/{appId}/participants endpoint", "pr_createdAt": "2020-11-19T12:25:32Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094", "timeline": [{"oid": "0f515b1833a5054182bdc0a98535b0933be28d4b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0f515b1833a5054182bdc0a98535b0933be28d4b", "message": "Fixed Issue #1932 in /apps/{appId}/participants endpoint\n\nFixed Issue #1932 in /apps/{appId}/participants endpoint", "committedDate": "2020-11-19T12:22:13Z", "type": "commit"}, {"oid": "c5c226dd56e9de0cf6fbd01c81f7ee79cee9d026", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c5c226dd56e9de0cf6fbd01c81f7ee79cee9d026", "message": "Merge branch 'develop' into app-participants-performance-issue-fix", "committedDate": "2020-11-19T13:25:51Z", "type": "commit"}, {"oid": "dade94738f7bb5bea3075f307ed41e3c5c92685d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dade94738f7bb5bea3075f307ed41e3c5c92685d", "message": "Merge branch 'develop' into app-participants-performance-issue-fix", "committedDate": "2020-11-23T07:27:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc2Njg5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528766897", "bodyText": "nit: keep each line shorter.", "author": "zohrehj", "createdAt": "2020-11-23T15:02:43Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/AppRepository.java", "diffHunk": "@@ -125,4 +127,49 @@\n               + \"GROUP BY appId\",\n       nativeQuery = true)\n   public List<AppCount> findEnrolledWithoutTarget();\n+\n+  @Query(\n+      value =\n+          \"SELECT DISTINCT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n+              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n+              + \"FROM user_details ud \"\n+              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n+              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id  AND ps.status NOT IN (:excludeParticipantStudyStatus) \"\n+              + \"WHERE ud.app_info_id=:appId \"\n+              + \"ORDER BY ud.verification_time,ud.id DESC \",\n+      nativeQuery = true)\n+  public List<AppParticipantsInfo> findUserDetailsByAppIdAndStudyStatus(\n+      String appId, String[] excludeParticipantStudyStatus);\n+\n+  @Query(\n+      value =\n+          \"SELECT DISTINCT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n+              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n+              + \"FROM user_details ud \"\n+              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n+              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id \"\n+              + \"WHERE ud.app_info_id=:appId \"\n+              + \"ORDER BY ud.verification_time,ud.id DESC \",\n+      nativeQuery = true)\n+  public List<AppParticipantsInfo> findUserDetailsByAppId(String appId);\n+\n+  @Query(\n+      value =\n+          \"SELECT ud.id AS userDetailsId, psi.site_id as siteId, psi.study_info_id AS studyId, loc.custom_id AS locationCustomId, loc.name AS locationName \"", "originalCommit": "dade94738f7bb5bea3075f307ed41e3c5c92685d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg0MDIwMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528840200", "bodyText": "Fixed review comment", "author": "monica-BTC", "createdAt": "2020-11-23T16:35:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc2Njg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc2OTYwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528769609", "bodyText": "writing query manually is more prone to error, please add tests to cover every single method that you added here. It can be unit tests at the repository level to simply verify that they do not fail and return the expected results.", "author": "zohrehj", "createdAt": "2020-11-23T15:06:18Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/AppRepository.java", "diffHunk": "@@ -125,4 +127,49 @@\n               + \"GROUP BY appId\",\n       nativeQuery = true)\n   public List<AppCount> findEnrolledWithoutTarget();\n+\n+  @Query(\n+      value =\n+          \"SELECT DISTINCT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n+              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n+              + \"FROM user_details ud \"\n+              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n+              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id  AND ps.status NOT IN (:excludeParticipantStudyStatus) \"\n+              + \"WHERE ud.app_info_id=:appId \"\n+              + \"ORDER BY ud.verification_time,ud.id DESC \",\n+      nativeQuery = true)\n+  public List<AppParticipantsInfo> findUserDetailsByAppIdAndStudyStatus(\n+      String appId, String[] excludeParticipantStudyStatus);\n+\n+  @Query(\n+      value =\n+          \"SELECT DISTINCT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n+              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n+              + \"FROM user_details ud \"\n+              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n+              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id \"\n+              + \"WHERE ud.app_info_id=:appId \"\n+              + \"ORDER BY ud.verification_time,ud.id DESC \",\n+      nativeQuery = true)\n+  public List<AppParticipantsInfo> findUserDetailsByAppId(String appId);\n+\n+  @Query(\n+      value =\n+          \"SELECT ud.id AS userDetailsId, psi.site_id as siteId, psi.study_info_id AS studyId, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n+              + \"FROM participant_study_info psi, locations loc, sites s, user_details ud \"\n+              + \"WHERE ud.id=psi.user_details_id AND psi.study_info_id=s.study_id AND psi.site_id=s.id AND loc.id=s.location_id AND \"\n+              + \"ud.app_info_id=:appId AND psi.status NOT IN (:excludeParticipantStudyStatus) \"\n+              + \"AND ud.id IN (:userIds)\",\n+      nativeQuery = true)\n+  public List<AppSiteInfo> findSitesByAppIdAndStudyStatusAndUserIds(\n+      String appId, String[] excludeParticipantStudyStatus, List<String> userIds);\n+\n+  @Query(\n+      value =\n+          \"SELECT ud.id AS userDetailsId, psi.site_id as siteId, psi.study_info_id AS studyId, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n+              + \"FROM participant_study_info psi, locations loc, sites s, user_details ud \"\n+              + \"WHERE ud.id=psi.user_details_id AND psi.study_info_id=s.study_id AND psi.site_id=s.id AND loc.id=s.location_id AND \"\n+              + \"ud.app_info_id=:appId AND ud.id IN (:userIds) \",\n+      nativeQuery = true)\n+  public List<AppSiteInfo> findSitesByAppIdAndUserIds(String appId, List<String> userIds);", "originalCommit": "dade94738f7bb5bea3075f307ed41e3c5c92685d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg0MDgxMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528840812", "bodyText": "Covered all the methods in existing test case.", "author": "monica-BTC", "createdAt": "2020-11-23T16:36:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc2OTYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3MTI4Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528771283", "bodyText": "site and location are two different concepts, please keep the naming consistent.\nas it is, this looks like an error to me.", "author": "zohrehj", "createdAt": "2020-11-23T15:08:32Z", "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/SiteMapper.java", "diffHunk": "@@ -43,33 +39,20 @@ public static AppSiteResponse toAppSiteResponse(SiteEntity site) {\n     return appSiteResponse;\n   }\n \n-  public static List<AppSiteDetails> toParticipantSiteList(\n-      Entry<StudyEntity, List<ParticipantStudyEntity>> entry, String[] excludeSiteStatus) {\n-    List<AppSiteDetails> sites = new ArrayList<>();\n-    for (ParticipantStudyEntity enrollment : entry.getValue()) {\n-      if (ArrayUtils.contains(excludeSiteStatus, enrollment.getStatus())) {\n-        continue;\n-      }\n+  public static AppSiteDetails toAppSiteDetails(\n+      AppSiteInfo appSiteInfo, AppParticipantsInfo appParticipantsInfo) {\n+    AppSiteDetails appSiteDetails = new AppSiteDetails();\n+    appSiteDetails.setSiteId(appSiteInfo.getSiteId());\n+    appSiteDetails.setCustomSiteId(appSiteInfo.getLocationCustomId());", "originalCommit": "dade94738f7bb5bea3075f307ed41e3c5c92685d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg0MjY1Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528842652", "bodyText": "Renamed customSiteId to customLocationId and siteName to locationName in AppSiteDetails class.", "author": "monica-BTC", "createdAt": "2020-11-23T16:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3MTI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3MTYwOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528771608", "bodyText": "same here. please rename, if they are indeed the same thing.", "author": "zohrehj", "createdAt": "2020-11-23T15:08:58Z", "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/SiteMapper.java", "diffHunk": "@@ -43,33 +39,20 @@ public static AppSiteResponse toAppSiteResponse(SiteEntity site) {\n     return appSiteResponse;\n   }\n \n-  public static List<AppSiteDetails> toParticipantSiteList(\n-      Entry<StudyEntity, List<ParticipantStudyEntity>> entry, String[] excludeSiteStatus) {\n-    List<AppSiteDetails> sites = new ArrayList<>();\n-    for (ParticipantStudyEntity enrollment : entry.getValue()) {\n-      if (ArrayUtils.contains(excludeSiteStatus, enrollment.getStatus())) {\n-        continue;\n-      }\n+  public static AppSiteDetails toAppSiteDetails(\n+      AppSiteInfo appSiteInfo, AppParticipantsInfo appParticipantsInfo) {\n+    AppSiteDetails appSiteDetails = new AppSiteDetails();\n+    appSiteDetails.setSiteId(appSiteInfo.getSiteId());\n+    appSiteDetails.setCustomSiteId(appSiteInfo.getLocationCustomId());\n+    appSiteDetails.setSiteName(appSiteInfo.getLocationName());", "originalCommit": "dade94738f7bb5bea3075f307ed41e3c5c92685d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg0MzMzNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528843337", "bodyText": "Renamed customSiteId to customLocationId and siteName to locationName in AppSiteDetails class.", "author": "monica-BTC", "createdAt": "2020-11-23T16:39:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3MTYwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3MjQyOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528772428", "bodyText": "why is siteStatus set to studyStatus? if they are supposed to hold the same value, they should be named the same.\nWe do not need to store site status, if it will always be the same as study status.", "author": "zohrehj", "createdAt": "2020-11-23T15:10:04Z", "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/SiteMapper.java", "diffHunk": "@@ -43,33 +39,20 @@ public static AppSiteResponse toAppSiteResponse(SiteEntity site) {\n     return appSiteResponse;\n   }\n \n-  public static List<AppSiteDetails> toParticipantSiteList(\n-      Entry<StudyEntity, List<ParticipantStudyEntity>> entry, String[] excludeSiteStatus) {\n-    List<AppSiteDetails> sites = new ArrayList<>();\n-    for (ParticipantStudyEntity enrollment : entry.getValue()) {\n-      if (ArrayUtils.contains(excludeSiteStatus, enrollment.getStatus())) {\n-        continue;\n-      }\n+  public static AppSiteDetails toAppSiteDetails(\n+      AppSiteInfo appSiteInfo, AppParticipantsInfo appParticipantsInfo) {\n+    AppSiteDetails appSiteDetails = new AppSiteDetails();\n+    appSiteDetails.setSiteId(appSiteInfo.getSiteId());\n+    appSiteDetails.setCustomSiteId(appSiteInfo.getLocationCustomId());\n+    appSiteDetails.setSiteName(appSiteInfo.getLocationName());\n+    appSiteDetails.setSiteStatus(appParticipantsInfo.getParticipantStudyStatus());", "originalCommit": "dade94738f7bb5bea3075f307ed41e3c5c92685d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg0NTQ5NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528845495", "bodyText": "Renamed siteStatus to participantStudyStatus because it is participant study status not site status.", "author": "monica-BTC", "createdAt": "2020-11-23T16:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3MjQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3NDQxNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528774417", "bodyText": "are these changes covered by existing tests? if not, please add test coverage.", "author": "zohrehj", "createdAt": "2020-11-23T15:12:38Z", "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/AppServiceImpl.java", "diffHunk": "@@ -376,16 +384,86 @@ public AppParticipantsResponse getAppParticipants(\n               .getApp();\n     }\n \n-    List<UserDetailsEntity> userDetails = userDetailsRepository.findByAppId(app.getId());\n-    List<StudyEntity> studyEntity = studyRepository.findByAppId(app.getId());\n-    List<ParticipantDetail> participants = new ArrayList<>();\n+    List<AppParticipantsInfo> appParticipantsInfoList = null;", "originalCommit": "dade94738f7bb5bea3075f307ed41e3c5c92685d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg0NTgyNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528845826", "bodyText": "All the changes are covered in existing test case.", "author": "monica-BTC", "createdAt": "2020-11-23T16:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3NDQxNw=="}], "type": "inlineReview"}, {"oid": "05d7b7f26d73a2082441f236dbb14baf37950ca1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/05d7b7f26d73a2082441f236dbb14baf37950ca1", "message": "fixed review comments\n\nfixed review comments", "committedDate": "2020-11-23T16:31:10Z", "type": "commit"}, {"oid": "e1558b23a4cf4a7b7042f596733e4ea23c310940", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e1558b23a4cf4a7b7042f596733e4ea23c310940", "message": "Merge branch 'develop' into app-participants-performance-issue-fix", "committedDate": "2020-11-24T05:06:48Z", "type": "commit"}, {"oid": "c6cd4f29d3802436dc050a6d79f17bc64ee49b88", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c6cd4f29d3802436dc050a6d79f17bc64ee49b88", "message": "Merge branch 'develop' into app-participants-performance-issue-fix", "committedDate": "2020-11-24T06:09:00Z", "type": "commit"}, {"oid": "6f47397b1ae228c43cc8051222994b2f455b6774", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6f47397b1ae228c43cc8051222994b2f455b6774", "message": "Merge branch 'develop' into app-participants-performance-issue-fix", "committedDate": "2020-11-24T15:47:19Z", "type": "commit"}]}