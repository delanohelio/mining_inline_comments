{"pr_number": 3190, "pr_title": "GH-3182: Properly reset bean in the MockIntCtx", "pr_createdAt": "2020-02-20T20:55:10Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3190", "timeline": [{"oid": "e69e038c19339bfbc54af14dbbb4163c14c51f9c", "url": "https://github.com/spring-projects/spring-integration/commit/e69e038c19339bfbc54af14dbbb4163c14c51f9c", "message": "GH-3182: Properly reset bean in the MockIntCtx\n\nFixes https://github.com/spring-projects/spring-integration/issues/3182\n\nThe `MockIntegrationContext.resetBeans()` doesn't really restore a state\nof endpoint beans: the handle/source is applied only after start for that endpoint\n\n* Stop endpoints in the `MockIntegrationContext.resetBeans()` is they are running currently\n* Start them back only if their `autoStartup == true`\n* Clear only those beans which names are provided for the `resetBeans()`\n\n**Cherry-pick to 5.2.x**", "committedDate": "2020-02-20T20:54:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI2NTA1OQ==", "url": "https://github.com/spring-projects/spring-integration/pull/3190#discussion_r382265059", "bodyText": "Don't we need a test for this \"partial\" reset use case?", "author": "garyrussell", "createdAt": "2020-02-20T21:22:43Z", "path": "spring-integration-test/src/main/java/org/springframework/integration/test/context/MockIntegrationContext.java", "diffHunk": "@@ -108,9 +114,19 @@ else if (endpoint instanceof ReactiveStreamsConsumer) {\n \t\t\t\t\telse if (endpoint instanceof IntegrationConsumer) {\n \t\t\t\t\t\tdirectFieldAccessor.setPropertyValue(HANDLER, e.getValue());\n \t\t\t\t\t}\n+\t\t\t\t\tif (lifecycle != null && lifecycle.isAutoStartup()) {\n+\t\t\t\t\t\tlifecycle.start();\n+\t\t\t\t\t}\n \t\t\t\t});\n \n-\t\tthis.beans.clear();\n+\t\tif (!ObjectUtils.isEmpty(beanNames)) {\n+\t\t\tfor (String name : beanNames) {", "originalCommit": "e69e038c19339bfbc54af14dbbb4163c14c51f9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91418746398c8c94d8ae613869c67d468bd0c631", "url": "https://github.com/spring-projects/spring-integration/commit/91418746398c8c94d8ae613869c67d468bd0c631", "message": "* Ensure that only provided beans are reset", "committedDate": "2020-02-20T22:32:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNzM0MA==", "url": "https://github.com/spring-projects/spring-integration/pull/3190#discussion_r382707340", "bodyText": "Doesn't this have potential to break existing tests?\nMaybe this just matters for constructed examples. But I could imagine something like this:\n@BeforeClass\nvoid init() {\n  nonAutostartupHandler.start();\n}\n\n@After \nvoid cleanup() {\n  mockIntegrationContext.reset()\n}\n\n@Test\nvoid t1() {\n  // do something with handler\n}\n\n@Test \nvoid t2() {\n  // expect handler to be still running\n}\n\nAdmittedly the @BeforeClass is somewhat artificial. But I could see a  handler being manually started as part of context initialization.\nI'm sorry for not contributing a fix myself, I had a pretty busy week at work.", "author": "hgarus", "createdAt": "2020-02-21T17:23:06Z", "path": "spring-integration-test/src/main/java/org/springframework/integration/test/context/MockIntegrationContext.java", "diffHunk": "@@ -108,9 +114,19 @@ else if (endpoint instanceof ReactiveStreamsConsumer) {\n \t\t\t\t\telse if (endpoint instanceof IntegrationConsumer) {\n \t\t\t\t\t\tdirectFieldAccessor.setPropertyValue(HANDLER, e.getValue());\n \t\t\t\t\t}\n+\t\t\t\t\tif (lifecycle != null && lifecycle.isAutoStartup()) {", "originalCommit": "e69e038c19339bfbc54af14dbbb4163c14c51f9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc0MjI2NQ==", "url": "https://github.com/spring-projects/spring-integration/pull/3190#discussion_r382742265", "bodyText": "nonAutostartupHandler.start(); - you definitely start it manually. The framework can't assume when and how you have started it or going to.\nOnly the way for the framework to start it when you have that autoStartup = true.\nI admit that it may break some peculiar test, but at the same time the test is wrong because it has been relied on bug which we are fixing here.\nOn the other hand I don't worry too much about breaking changes for tests. That's not that part of project which may make your customer unhappy.", "author": "artembilan", "createdAt": "2020-02-21T18:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNzM0MA=="}], "type": "inlineReview"}]}