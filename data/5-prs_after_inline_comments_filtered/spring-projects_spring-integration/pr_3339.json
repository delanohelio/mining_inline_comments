{"pr_number": 3339, "pr_title": "Fix Kafka Send Timeout", "pr_createdAt": "2020-07-14T21:03:50Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3339", "timeline": [{"oid": "d6213c64edc3f7b26e479bb3d41b521ca2542059", "url": "https://github.com/spring-projects/spring-integration/commit/d6213c64edc3f7b26e479bb3d41b521ca2542059", "message": "Fix Kafka Send Timeout\n\nResolves https://github.com/spring-cloud/spring-cloud-stream-binder-kafka/issues/928\n\nKafka has a longer default send timeout; this means a send could be successful long\nafter Spring has timed out the send.\n\n**I will backport to the 3.3.x extension after merge**", "committedDate": "2020-07-14T21:03:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1ODk4Nw==", "url": "https://github.com/spring-projects/spring-integration/pull/3339#discussion_r454658987", "bodyText": "Why can't we call setSendTimeout(long sendTimeout) instead?", "author": "artembilan", "createdAt": "2020-07-14T21:34:12Z", "path": "spring-integration-kafka/src/main/java/org/springframework/integration/kafka/outbound/KafkaProducerMessageHandler.java", "diffHunk": "@@ -175,6 +181,25 @@ public KafkaProducerMessageHandler(final KafkaTemplate<K, V> kafkaTemplate) {\n \t\t\tlogger.warn(\"The KafkaTemplate is transactional; this gateway will only work if the consumer is \"\n \t\t\t\t\t+ \"configured to read uncommitted records\");\n \t\t}\n+\t\tdetermineSendTimeout();\n+\t\tthis.deliveryTimeoutMsProperty = this.sendTimeoutExpression.getValue(Long.class) - TIMEOUT_BUFFER;\n+\t}\n+\n+\tprivate void determineSendTimeout() {\n+\t\tMap<String, Object> props = this.kafkaTemplate.getProducerFactory().getConfigurationProperties();\n+\t\tObject dt = props.get(ProducerConfig.DELIVERY_TIMEOUT_MS_CONFIG);\n+\t\tif (dt == null) {\n+\t\t\tdt = ProducerConfig.configDef().defaultValues().get(ProducerConfig.DELIVERY_TIMEOUT_MS_CONFIG);\n+\t\t}\n+\t\tif (dt instanceof Long) {\n+\t\t\tthis.sendTimeoutExpression = new ValueExpression<>(((Long) dt) + TIMEOUT_BUFFER);\n+\t\t}\n+\t\telse if (dt instanceof Integer) {\n+\t\t\tthis.sendTimeoutExpression = new ValueExpression<>(Long.valueOf((Integer) dt) + TIMEOUT_BUFFER);\n+\t\t}\n+\t\telse if (dt instanceof String) {\n+\t\t\tthis.sendTimeoutExpression = new ValueExpression<>(Long.parseLong((String) dt) + TIMEOUT_BUFFER);", "originalCommit": "d6213c64edc3f7b26e479bb3d41b521ca2542059", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1OTE3Nw==", "url": "https://github.com/spring-projects/spring-integration/pull/3339#discussion_r454659177", "bodyText": "Looks like you have changed your mind and decided to not use this setter in the ctor.\nI mean doesn't look like there is still a justification for a final...", "author": "artembilan", "createdAt": "2020-07-14T21:34:36Z", "path": "spring-integration-kafka/src/main/java/org/springframework/integration/kafka/outbound/KafkaProducerMessageHandler.java", "diffHunk": "@@ -257,13 +282,14 @@ public void setSendTimeout(long sendTimeout) {\n \n \t/**\n \t * Specify a SpEL expression to evaluate a timeout in milliseconds for how long this\n-\t * {@link KafkaProducerMessageHandler} should wait wait for send operation\n-\t * results. Defaults to 10 seconds. The timeout is applied only in {@link #sync} mode.\n+\t * {@link KafkaProducerMessageHandler} should wait wait for send operation results.\n+\t * Defaults to the kafka {@code delivery.timeout.ms} property + 5 seconds. The timeout\n+\t * is applied only in {@link #sync} mode.\n \t * @param sendTimeoutExpression the {@link Expression} for timeout to wait for result\n-\t * fo send operation.\n+\t * for a send operation.\n \t * @since 2.1.1\n \t */\n-\tpublic void setSendTimeoutExpression(Expression sendTimeoutExpression) {\n+\tpublic final void setSendTimeoutExpression(Expression sendTimeoutExpression) {", "originalCommit": "d6213c64edc3f7b26e479bb3d41b521ca2542059", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0962bb7e5f6a77bbcd3a2eae4f2df13c2f5a1daa", "url": "https://github.com/spring-projects/spring-integration/commit/0962bb7e5f6a77bbcd3a2eae4f2df13c2f5a1daa", "message": "Use setSendTimeout; make it final.", "committedDate": "2020-07-15T14:34:07Z", "type": "commit"}]}