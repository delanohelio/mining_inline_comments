{"pr_number": 4082, "pr_title": "[WFCORE-4486] Support for multiple security realms - Failover", "pr_createdAt": "2020-02-11T12:18:33Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4082", "timeline": [{"oid": "43a745acdd50e6a6199527697a2681ce99d42e3e", "url": "https://github.com/wildfly/wildfly-core/commit/43a745acdd50e6a6199527697a2681ce99d42e3e", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-02-11T14:44:21Z", "type": "forcePushed"}, {"oid": "fe3fc2af414832aa5fda63d899e4c23ea93a866d", "url": "https://github.com/wildfly/wildfly-core/commit/fe3fc2af414832aa5fda63d899e4c23ea93a866d", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-03-24T14:07:40Z", "type": "forcePushed"}, {"oid": "e078436b1ba54f7c65d67a6a1f60783054dc7d4c", "url": "https://github.com/wildfly/wildfly-core/commit/e078436b1ba54f7c65d67a6a1f60783054dc7d4c", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-03-24T15:02:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgwNjU5NQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4082#discussion_r412806595", "bodyText": "The description seems confusing to me a bit since the wrapped realm is delegate-realm and delegated realm is failover-realm.", "author": "OndrejKotek", "createdAt": "2020-04-22T09:05:07Z", "path": "elytron/src/main/java/org/wildfly/extension/elytron/FailoverRealmDefinition.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2019 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.wildfly.extension.elytron;\n+\n+import static org.wildfly.extension.elytron.Capabilities.SECURITY_REALM_CAPABILITY;\n+import static org.wildfly.extension.elytron.Capabilities.SECURITY_REALM_RUNTIME_CAPABILITY;\n+import static org.wildfly.extension.elytron.ElytronDefinition.commonDependencies;\n+\n+\n+import org.jboss.as.controller.AbstractAddStepHandler;\n+import org.jboss.as.controller.AbstractWriteAttributeHandler;\n+import org.jboss.as.controller.AttributeDefinition;\n+import org.jboss.as.controller.OperationContext;\n+import org.jboss.as.controller.OperationFailedException;\n+import org.jboss.as.controller.OperationStepHandler;\n+import org.jboss.as.controller.PathElement;\n+import org.jboss.as.controller.ResourceDefinition;\n+import org.jboss.as.controller.SimpleAttributeDefinition;\n+import org.jboss.as.controller.SimpleAttributeDefinitionBuilder;\n+import org.jboss.as.controller.SimpleResourceDefinition;\n+import org.jboss.as.controller.capability.RuntimeCapability;\n+import org.jboss.as.controller.registry.AttributeAccess;\n+import org.jboss.as.controller.registry.ManagementResourceRegistration;\n+import org.jboss.as.controller.registry.OperationEntry;\n+import org.jboss.dmr.ModelNode;\n+import org.jboss.dmr.ModelType;\n+import org.jboss.msc.inject.Injector;\n+import org.jboss.msc.service.ServiceBuilder;\n+import org.jboss.msc.service.ServiceController.Mode;\n+import org.jboss.msc.service.ServiceName;\n+import org.jboss.msc.service.ServiceTarget;\n+import org.jboss.msc.value.InjectedValue;\n+\n+import org.wildfly.security.auth.realm.FailoverModifiableSecurityRealm;\n+import org.wildfly.security.auth.realm.FailoverSecurityRealm;\n+import org.wildfly.security.auth.server.ModifiableSecurityRealm;\n+import org.wildfly.security.auth.server.RealmUnavailableException;\n+import org.wildfly.security.auth.server.SecurityDomain;\n+import org.wildfly.security.auth.server.SecurityRealm;\n+import org.wildfly.security.auth.server.event.SecurityRealmUnavailableEvent;\n+\n+import java.util.function.Consumer;\n+\n+/**\n+ * A {@link ResourceDefinition} for a {@link SecurityRealm} which wraps one realm and delegates to another in case the first is unavailable.", "originalCommit": "e078436b1ba54f7c65d67a6a1f60783054dc7d4c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d16181bf58979a1d958646fc9c9e2c3a255540fe", "url": "https://github.com/wildfly/wildfly-core/commit/d16181bf58979a1d958646fc9c9e2c3a255540fe", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-05-05T22:33:14Z", "type": "forcePushed"}, {"oid": "8d7e95b04cb6582920d92482f67d373bcb5aafb8", "url": "https://github.com/wildfly/wildfly-core/commit/8d7e95b04cb6582920d92482f67d373bcb5aafb8", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-05-05T22:39:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5MjAxNA==", "url": "https://github.com/wildfly/wildfly-core/pull/4082#discussion_r423692014", "bodyText": "The realm should offer operations with identity (add-identity, read-identity, ...).", "author": "OndrejKotek", "createdAt": "2020-05-12T12:27:12Z", "path": "elytron/src/main/java/org/wildfly/extension/elytron/FailoverRealmDefinition.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2019 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.wildfly.extension.elytron;\n+\n+import static org.wildfly.extension.elytron.Capabilities.SECURITY_REALM_CAPABILITY;\n+import static org.wildfly.extension.elytron.Capabilities.SECURITY_REALM_RUNTIME_CAPABILITY;\n+import static org.wildfly.extension.elytron.ElytronDefinition.commonDependencies;\n+\n+\n+import org.jboss.as.controller.AbstractAddStepHandler;\n+import org.jboss.as.controller.AbstractWriteAttributeHandler;\n+import org.jboss.as.controller.AttributeDefinition;\n+import org.jboss.as.controller.OperationContext;\n+import org.jboss.as.controller.OperationFailedException;\n+import org.jboss.as.controller.OperationStepHandler;\n+import org.jboss.as.controller.PathElement;\n+import org.jboss.as.controller.ResourceDefinition;\n+import org.jboss.as.controller.SimpleAttributeDefinition;\n+import org.jboss.as.controller.SimpleAttributeDefinitionBuilder;\n+import org.jboss.as.controller.SimpleResourceDefinition;\n+import org.jboss.as.controller.capability.RuntimeCapability;\n+import org.jboss.as.controller.registry.AttributeAccess;\n+import org.jboss.as.controller.registry.ManagementResourceRegistration;\n+import org.jboss.as.controller.registry.OperationEntry;\n+import org.jboss.dmr.ModelNode;\n+import org.jboss.dmr.ModelType;\n+import org.jboss.msc.inject.Injector;\n+import org.jboss.msc.service.ServiceBuilder;\n+import org.jboss.msc.service.ServiceController.Mode;\n+import org.jboss.msc.service.ServiceName;\n+import org.jboss.msc.service.ServiceTarget;\n+import org.jboss.msc.value.InjectedValue;\n+\n+import org.wildfly.security.auth.realm.FailoverModifiableSecurityRealm;\n+import org.wildfly.security.auth.realm.FailoverSecurityRealm;\n+import org.wildfly.security.auth.server.ModifiableSecurityRealm;\n+import org.wildfly.security.auth.server.RealmUnavailableException;\n+import org.wildfly.security.auth.server.SecurityDomain;\n+import org.wildfly.security.auth.server.SecurityRealm;\n+import org.wildfly.security.auth.server.event.SecurityRealmUnavailableEvent;\n+\n+import java.util.function.Consumer;\n+\n+/**\n+ * A {@link ResourceDefinition} for a {@link SecurityRealm} which wraps one realm and fails over to another in case the first is unavailable.\n+ *\n+ * @author <a href=\"mailto:mmazanek@jboss.com\">Martin Mazanek</a>\n+ */\n+class FailoverRealmDefinition extends SimpleResourceDefinition {\n+\n+    static final ServiceUtil<SecurityRealm> REALM_SERVICE_UTIL = ServiceUtil.newInstance(SECURITY_REALM_RUNTIME_CAPABILITY, ElytronDescriptionConstants.AGGREGATE_REALM, SecurityRealm.class);\n+\n+    static final SimpleAttributeDefinition DELEGATE_REALM = new SimpleAttributeDefinitionBuilder(ElytronDescriptionConstants.DELEGATE_REALM, ModelType.STRING, false)\n+            .setMinSize(1)\n+            .setCapabilityReference(SECURITY_REALM_CAPABILITY, SECURITY_REALM_CAPABILITY)\n+            .setRestartAllServices()\n+            .build();\n+\n+    static final SimpleAttributeDefinition FAILOVER_REALM = new SimpleAttributeDefinitionBuilder(ElytronDescriptionConstants.FAILOVER_REALM, ModelType.STRING, false)\n+            .setMinSize(1)\n+            .setCapabilityReference(SECURITY_REALM_CAPABILITY, SECURITY_REALM_CAPABILITY)\n+            .setRestartAllServices()\n+            .build();\n+\n+    static final SimpleAttributeDefinition EMIT_EVENTS = new SimpleAttributeDefinitionBuilder(ElytronDescriptionConstants.EMIT_EVENTS, ModelType.BOOLEAN, true)\n+            .setAllowExpression(true)\n+            .setMinSize(1)\n+            .setFlags(AttributeAccess.Flag.RESTART_RESOURCE_SERVICES)\n+            .setDefaultValue(ModelNode.TRUE)\n+            .build();\n+\n+    static final AttributeDefinition[] ATTRIBUTES = new AttributeDefinition[] { DELEGATE_REALM, FAILOVER_REALM, EMIT_EVENTS};\n+\n+    private static final AbstractAddStepHandler ADD = new RealmAddHandler();\n+    private static final OperationStepHandler REMOVE = new TrivialCapabilityServiceRemoveHandler(ADD, SECURITY_REALM_RUNTIME_CAPABILITY);\n+\n+    FailoverRealmDefinition() {", "originalCommit": "8d7e95b04cb6582920d92482f67d373bcb5aafb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5NDQ5NQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4082#discussion_r423694495", "bodyText": "I would only expect a realm to expose those operations if it exposes the modifiable realm capability, it wouldn't make sense to be able to support failing over things like an add-identity operation.", "author": "darranl", "createdAt": "2020-05-12T12:31:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5MjAxNA=="}], "type": "inlineReview"}, {"oid": "01fa275ca75e91aa84fcf0c0d4d16108fdca6331", "url": "https://github.com/wildfly/wildfly-core/commit/01fa275ca75e91aa84fcf0c0d4d16108fdca6331", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-07-21T12:47:05Z", "type": "forcePushed"}, {"oid": "fb9b12c7671f7ffa6099fc5e7b307fe312f7cfb1", "url": "https://github.com/wildfly/wildfly-core/commit/fb9b12c7671f7ffa6099fc5e7b307fe312f7cfb1", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-07-21T15:27:42Z", "type": "forcePushed"}, {"oid": "ea95a5d41e477240b1c9dff2955eee38bec2c8f6", "url": "https://github.com/wildfly/wildfly-core/commit/ea95a5d41e477240b1c9dff2955eee38bec2c8f6", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-07-24T13:49:21Z", "type": "forcePushed"}, {"oid": "d1ed382c692c9348eda2441aa8e7134fbb410a60", "url": "https://github.com/wildfly/wildfly-core/commit/d1ed382c692c9348eda2441aa8e7134fbb410a60", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-08-06T19:36:48Z", "type": "forcePushed"}, {"oid": "73565d4118160df5085290d3e35003152e2345ce", "url": "https://github.com/wildfly/wildfly-core/commit/73565d4118160df5085290d3e35003152e2345ce", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-08-10T07:42:21Z", "type": "commit"}, {"oid": "73565d4118160df5085290d3e35003152e2345ce", "url": "https://github.com/wildfly/wildfly-core/commit/73565d4118160df5085290d3e35003152e2345ce", "message": "[WFCORE-4486] Support for multiple security realms - Failover\n\nhttps://issues.redhat.com/browse/WFCORE-4486", "committedDate": "2020-08-10T07:42:21Z", "type": "forcePushed"}]}