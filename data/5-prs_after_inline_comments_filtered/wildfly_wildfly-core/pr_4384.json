{"pr_number": 4384, "pr_title": "[WFCORE-482] Add log4j2 support. Added the log4j-api and an implement\u2026", "pr_createdAt": "2020-11-04T23:16:22Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4384", "timeline": [{"oid": "a05728f1dc9807bf468c7eaa630ce0dd993cdd14", "url": "https://github.com/wildfly/wildfly-core/commit/a05728f1dc9807bf468c7eaa630ce0dd993cdd14", "message": "[WFCORE-482] Add log4j2 support. Added the log4j-api and an implementation that uses the jboss-logmanager as it's delegating log manager.\n\nhttps://issues.redhat.com/browse/WFCORE-482", "committedDate": "2020-11-05T22:05:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5NDc2Ng==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r521594766", "bodyText": "@jamezp I was wondering why you put in the LOG4J2_IMPL org.jboss.logmanager.lo4j2 as dependency. In JCL it is \"This allows the org.jboss.logging.commons.logging module to be private while keeping this module public\"\nI think the Apache Commons Logging way, to provide the API but not the Impl is quite good. It prevents app developers to depend on that classes.", "author": "boris-unckel", "createdAt": "2020-11-11T19:40:14Z", "path": "logging/src/main/java/org/jboss/as/logging/LoggingModuleDependency.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ *\n+ * Copyright 2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.jboss.as.logging;\n+\n+import org.jboss.as.controller.registry.RuntimePackageDependency;\n+\n+/**\n+ * Describes a module dependency.\n+ *\n+ * @author <a href=\"mailto:jperkins@redhat.com\">James R. Perkins</a>\n+ */\n+public enum LoggingModuleDependency {\n+    APACHE_COMMONS_LOGGING(\"org.apache.commons.logging\"),\n+    LOG4J(\"org.apache.log4j\"),\n+    LOG4J2(\"org.apache.logging.log4j.api\"),\n+    LOG4J2_IMPL(\"org.jboss.logmanager.log4j2\", true),", "originalCommit": "a05728f1dc9807bf468c7eaa630ce0dd993cdd14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4Mjg3Mw==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r521782873", "bodyText": "If we don't add it here we have to add a circular dependency in the org.apache.logging.log4j.api module so it knows where to find the implementation. I suppose another option would be to create a org.apache.logging.log4j module and make the add that as a dependency to the deployment exporting only the API.", "author": "jamezp", "createdAt": "2020-11-12T02:45:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5NDc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg2NjgwOA==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r521866808", "bodyText": "Yes, you're right. I'll change my backports in the same way.", "author": "boris-unckel", "createdAt": "2020-11-12T06:29:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5NDc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5NTMxNA==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r521595314", "bodyText": "@jamezp Same for SLF4_IMPL - I would prefer to keep it private/unreachable.", "author": "boris-unckel", "createdAt": "2020-11-11T19:41:16Z", "path": "logging/src/main/java/org/jboss/as/logging/LoggingModuleDependency.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ *\n+ * Copyright 2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.jboss.as.logging;\n+\n+import org.jboss.as.controller.registry.RuntimePackageDependency;\n+\n+/**\n+ * Describes a module dependency.\n+ *\n+ * @author <a href=\"mailto:jperkins@redhat.com\">James R. Perkins</a>\n+ */\n+public enum LoggingModuleDependency {\n+    APACHE_COMMONS_LOGGING(\"org.apache.commons.logging\"),\n+    LOG4J(\"org.apache.log4j\"),\n+    LOG4J2(\"org.apache.logging.log4j.api\"),\n+    LOG4J2_IMPL(\"org.jboss.logmanager.log4j2\", true),\n+    JBOSS_LOGGING(\"org.jboss.logging\"),\n+    JUL_TO_SLF4J(\"org.jboss.logging.jul-to-slf4j-stub\"),\n+    JBOSS_LOG_MANAGER(\"org.jboss.logmanager\"),\n+    SLF4J(\"org.slf4j\"),\n+    SLF4J_IMPL(\"org.slf4j.impl\"),", "originalCommit": "a05728f1dc9807bf468c7eaa630ce0dd993cdd14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3ODc1Mg==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r534078752", "bodyText": "@jamezp , @boris-unckel why are these permissions needed here? I don't see them in akin tests like Log4jLoggingProfilesTestCase .... is the customer required to grant these permissions to the deployment?", "author": "tommaso-borgato", "createdAt": "2020-12-02T11:00:09Z", "path": "testsuite/standalone/src/test/java/org/jboss/as/test/integration/logging/profiles/Log4j2LoggingProfilesTestCase.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ *\n+ * Copyright 2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.jboss.as.test.integration.logging.profiles;\n+\n+import java.io.FilePermission;\n+import java.security.Permission;\n+import java.util.PropertyPermission;\n+\n+import org.jboss.as.test.integration.logging.Log4j2ServiceActivator;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.runner.RunWith;\n+import org.wildfly.core.testrunner.ServerSetup;\n+import org.wildfly.core.testrunner.WildflyTestRunner;\n+\n+/**\n+ * @author <a href=\"mailto:jperkins@redhat.com\">James R. Perkins</a>\n+ */\n+@RunWith(WildflyTestRunner.class)\n+@ServerSetup(AbstractLoggingProfilesTestCase.LoggingProfilesTestCaseSetup.class)\n+public class Log4j2LoggingProfilesTestCase extends AbstractLoggingProfilesTestCase {\n+\n+    public Log4j2LoggingProfilesTestCase() {\n+        super(Log4j2ServiceActivator.class, 2);\n+    }\n+\n+    @Override\n+    protected void processDeployment(final JavaArchive deployment) {\n+        final Permission[] permissions = {", "originalCommit": "a05728f1dc9807bf468c7eaa630ce0dd993cdd14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM1NzQ2MA==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r535357460", "bodyText": "@tommaso-borgato I tried to explain the best I could in the comments. These are all because of the way the log4j2 API loads things so we have no control over it. I've made a note to update the future documentation for this. This documentation change will not be part of this RFE because it's going to be a large change and I don't want to hold this RFE up based a large documentation re-do.", "author": "jamezp", "createdAt": "2020-12-03T15:53:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3ODc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM2NTM1Mg==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r535365352", "bodyText": "I just created https://issues.redhat.com/browse/WFLY-14160 to track the documentation changes as a whole.", "author": "jamezp", "createdAt": "2020-12-03T16:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3ODc1Mg=="}], "type": "inlineReview"}, {"oid": "fc4cbe6d0580252b4fd0ab000ba645d9bc61616d", "url": "https://github.com/wildfly/wildfly-core/commit/fc4cbe6d0580252b4fd0ab000ba645d9bc61616d", "message": "[WFCORE-482] Add log4j2 support. Added the log4j-api and an implementation that uses the jboss-logmanager as it's delegating log manager.\n\nhttps://issues.redhat.com/browse/WFCORE-482", "committedDate": "2020-12-03T00:19:17Z", "type": "commit"}, {"oid": "fc4cbe6d0580252b4fd0ab000ba645d9bc61616d", "url": "https://github.com/wildfly/wildfly-core/commit/fc4cbe6d0580252b4fd0ab000ba645d9bc61616d", "message": "[WFCORE-482] Add log4j2 support. Added the log4j-api and an implementation that uses the jboss-logmanager as it's delegating log manager.\n\nhttps://issues.redhat.com/browse/WFCORE-482", "committedDate": "2020-12-03T00:19:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU1NTM2MQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r535555361", "bodyText": "@jamezp As we discussed in chat please follow up later with a more detailed comment as it's not obvious why this is needed and why it's safe.\nPartly I may be confused because I'm not sure what in the first sentence the \"This is required\" in the second sentence refers to: \"Create the StdioContext\" or \"using a privileged action\".", "author": "bstansberry", "createdAt": "2020-12-03T20:13:26Z", "path": "logging/src/main/java/org/jboss/as/logging/stdio/LogContextStdioContextSelector.java", "diffHunk": "@@ -50,16 +53,37 @@ public StdioContext getStdioContext() {\n         final Logger root = logContext.getLogger(CommonAttributes.ROOT_LOGGER_NAME);\n         StdioContext stdioContext = root.getAttachment(STDIO_CONTEXT_ATTACHMENT_KEY);\n         if (stdioContext == null) {\n-            stdioContext = StdioContext.create(\n-                    new NullInputStream(),\n-                    new LoggingOutputStream(logContext.getLogger(\"stdout\"), Level.INFO),\n-                    new LoggingOutputStream(logContext.getLogger(\"stderr\"), Level.ERROR)\n-            );\n-            final StdioContext appearing = root.attachIfAbsent(STDIO_CONTEXT_ATTACHMENT_KEY, stdioContext);\n+            // Create the StdioContext possibly using a privileged action. This is required for scenarios where a\n+            // deployment or library may attempt to write to System.out or System.err.", "originalCommit": "fc4cbe6d0580252b4fd0ab000ba645d9bc61616d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5Nzk5Mw==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r535597993", "bodyText": "Yes will do. The issue in this case was this blocked me from seeing the other log4j2 security issues because it attempted to write to System.out which triggered this error so I lost messages. I should have been more clear in the description.", "author": "jamezp", "createdAt": "2020-12-03T20:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU1NTM2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU2OTkzMg==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r535569932", "bodyText": "@jamezp When you work on WFLY-14160 you might want to experiment with something like\nnew FilePermission(\"${jboss.home.dir}/modules/*\", \"read\"),\n\nExpression resolution in a permissions.xml should work, and if it does that's a much better thing to document than suggesting giving ALL FILES.", "author": "bstansberry", "createdAt": "2020-12-03T20:26:40Z", "path": "testsuite/standalone/src/test/java/org/jboss/as/test/integration/logging/profiles/Log4j2LoggingProfilesTestCase.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ *\n+ * Copyright 2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.jboss.as.test.integration.logging.profiles;\n+\n+import java.io.FilePermission;\n+import java.security.Permission;\n+import java.util.PropertyPermission;\n+\n+import org.jboss.as.test.integration.logging.Log4j2ServiceActivator;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.runner.RunWith;\n+import org.wildfly.core.testrunner.ServerSetup;\n+import org.wildfly.core.testrunner.WildflyTestRunner;\n+\n+/**\n+ * @author <a href=\"mailto:jperkins@redhat.com\">James R. Perkins</a>\n+ */\n+@RunWith(WildflyTestRunner.class)\n+@ServerSetup(AbstractLoggingProfilesTestCase.LoggingProfilesTestCaseSetup.class)\n+public class Log4j2LoggingProfilesTestCase extends AbstractLoggingProfilesTestCase {\n+\n+    public Log4j2LoggingProfilesTestCase() {\n+        super(Log4j2ServiceActivator.class, 2);\n+    }\n+\n+    @Override\n+    protected void processDeployment(final JavaArchive deployment) {\n+        final Permission[] permissions = {\n+                // The getClassLoader permissions is required for the org.apache.logging.log4j.util.ProviderUtil.\n+                new RuntimePermission(\"getClassLoader\"),\n+                // The FilePermissions is also for the org.apache.logging.log4j.util.ProviderUtil as it needs to read the JAR\n+                // for the service loader.\n+                new FilePermission(\"<<ALL FILES>>\", \"read\"),", "originalCommit": "fc4cbe6d0580252b4fd0ab000ba645d9bc61616d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5ODczMA==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r535598730", "bodyText": "Ah good to know. I wasn't aware that expressions worked. That will be a better approach than <<ALL FILES>>. I really didn't like using that.", "author": "jamezp", "createdAt": "2020-12-03T20:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU2OTkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3NTQwOQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4384#discussion_r535775409", "bodyText": "Yeray added it earlier this year.", "author": "bstansberry", "createdAt": "2020-12-04T01:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU2OTkzMg=="}], "type": "inlineReview"}]}