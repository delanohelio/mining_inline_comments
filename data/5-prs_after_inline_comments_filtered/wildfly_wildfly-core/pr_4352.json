{"pr_number": 4352, "pr_title": "[WFCORE-5147] Adjusting git integration logging and stability of RemoteSshGitRepositoryTestCase", "pr_createdAt": "2020-10-05T17:09:37Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4352", "timeline": [{"oid": "be72613a35ee6e9d9c33c23a3268536a1255c5d3", "url": "https://github.com/wildfly/wildfly-core/commit/be72613a35ee6e9d9c33c23a3268536a1255c5d3", "message": "[WFCORE-5147] Group constructors together before the methods, and reduce excessive visibility.", "committedDate": "2020-10-05T14:19:26Z", "type": "commit"}, {"oid": "6136e7e9d11e6fd07a4d7d0934be229fd90eb1cd", "url": "https://github.com/wildfly/wildfly-core/commit/6136e7e9d11e6fd07a4d7d0934be229fd90eb1cd", "message": "[WFCORE-5147] Add a message ID for messages logged at Level.INFO.\n\nAlso remove DEBUG logging from ServerLogger as these should not be translated.", "committedDate": "2020-10-05T14:19:55Z", "type": "commit"}, {"oid": "55f63f8df9332d6390b58d7d220c181e4fbcc235", "url": "https://github.com/wildfly/wildfly-core/commit/55f63f8df9332d6390b58d7d220c181e4fbcc235", "message": "[WFCORE-5147] If initialising the git repository fails report as an Exception to end boot.", "committedDate": "2020-10-05T14:20:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3MzI4MQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508273281", "bodyText": "@darranl, Is this class considered API? can the restriction of the visibility impact user code or just server code?", "author": "jmesnil", "createdAt": "2020-10-20T07:34:50Z", "path": "server/src/main/java/org/jboss/as/server/controller/git/ElytronClientCredentialsProvider.java", "diffHunk": "@@ -39,12 +39,12 @@\n  * Currently only login/password is supported.\n  * @author Emmanuel Hugonnet (c) 2018 Red Hat, inc.\n  */\n-public class ElytronClientCredentialsProvider extends CredentialsProvider {\n+class ElytronClientCredentialsProvider extends CredentialsProvider {", "originalCommit": "2c86e2bf2076bbd5e25aa4f01c8e44a24e865624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI4NjEwMQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508286101", "bodyText": "Server code.", "author": "darranl", "createdAt": "2020-10-20T07:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3MzI4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3MzM3MA==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508273370", "bodyText": "idem", "author": "jmesnil", "createdAt": "2020-10-20T07:34:59Z", "path": "server/src/main/java/org/jboss/as/server/controller/git/ElytronClientSshdSessionFactory.java", "diffHunk": "@@ -66,7 +66,7 @@\n  *\n  * @author <a href=\"mailto:aabdelsa@redhat.com\">Ashley Abdel-Sayed</a>\n  */\n-public class ElytronClientSshdSessionFactory extends SshdSessionFactory {\n+class ElytronClientSshdSessionFactory extends SshdSessionFactory {", "originalCommit": "2c86e2bf2076bbd5e25aa4f01c8e44a24e865624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI4NjIwMQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508286201", "bodyText": "Server code.", "author": "darranl", "createdAt": "2020-10-20T07:55:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3MzM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3NDE4Mg==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508274182", "bodyText": "would it make sense to mention the path to the  cloned Git repository in that INFO log?", "author": "jmesnil", "createdAt": "2020-10-20T07:36:26Z", "path": "server/src/main/java/org/jboss/as/server/logging/ServerLogger.java", "diffHunk": "@@ -1345,6 +1345,17 @@\n     @Message(id = 277, value = \"Failed to load SSH Credentials %s\")\n     RuntimeException failedToLoadSSHCredentials(@Cause Throwable cause, String message);\n \n+    @LogMessage(level = INFO)\n+    @Message(id = 278, value = \"The configuration history is managed through Git\")", "originalCommit": "2c86e2bf2076bbd5e25aa4f01c8e44a24e865624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI4NzAzMw==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508287033", "bodyText": "I need to move on from this issue now, the logging I added was to get to the bottom of a test failure - I think other messages will help identify the path if needed.", "author": "darranl", "createdAt": "2020-10-20T07:56:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3NDE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3ODEzNQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508278135", "bodyText": "It's suspicious when I see a @Message without an ID. Most of the time, I consider that this should be a DEBUG log and in that case, I don't see which benefit we have to use a @message for it instead of a plain debugf() call.\nIn that case, it turns out that this is a String used in a Git commit:\ngit.commit().setSign(gitConfig.isSign()).setMessage(ServerLogger.ROOT_LOGGER.repositoryInitialized()).call();\n\nI'm not sure what we want to do here...\nDo we need to i18nize this commit message?\nShould it be a stable message with a Message ID that can be tracked in a knowledge base?", "author": "jmesnil", "createdAt": "2020-10-20T07:42:58Z", "path": "server/src/main/java/org/jboss/as/server/logging/ServerLogger.java", "diffHunk": "@@ -1354,23 +1365,10 @@\n     @Message(id = Message.NONE, value = \"The attribute '%s' has changed from '%s' to '%s'\")\n     String jmxAttributeChange(String name, String oldState, String stateString);\n \n-    @LogMessage(level = INFO)\n-    @Message(id = Message.NONE, value = \"The configuration history is managed through Git\")\n-    void usingGit();\n-\n     @Message(id = Message.NONE, value = \"Repository initialized\")", "originalCommit": "2c86e2bf2076bbd5e25aa4f01c8e44a24e865624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3ODI3NA==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508278274", "bodyText": "@darranl that's not directly related to your PR though :)", "author": "jmesnil", "createdAt": "2020-10-20T07:43:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3ODEzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI4ODE2OQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508288169", "bodyText": "IMO these should not have an ID - these messages are used for the commit messages in the git repository so similar to how we don't have message IDs for internationalised CLI messages we don't have message IDs for internationalised commit messages.", "author": "darranl", "createdAt": "2020-10-20T07:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3ODEzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI3ODgwMQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508278801", "bodyText": "if that's a constant, we should rename it to JBOSS_SERVER_BASE_DIR", "author": "jmesnil", "createdAt": "2020-10-20T07:44:04Z", "path": "testsuite/manualmode/src/test/java/org/jboss/as/test/manualmode/management/persistence/AbstractGitRepositoryTestCase.java", "diffHunk": "@@ -58,7 +58,7 @@\n  */\n public class AbstractGitRepositoryTestCase {\n \n-    private final Path jbossServerBaseDir = new File(System.getProperty(\"jboss.home\", System.getenv(\"JBOSS_HOME\"))).toPath().resolve(\"standalone\");\n+    private static final Path jbossServerBaseDir = new File(System.getProperty(\"jboss.home\", System.getenv(\"JBOSS_HOME\"))).toPath().resolve(\"standalone\");", "originalCommit": "2c86e2bf2076bbd5e25aa4f01c8e44a24e865624", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI4MDQxNA==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508280414", "bodyText": "should we also restore the configuration in the @AfterClass to avoid keeping the config from the last test for the rest of the test suite?", "author": "jmesnil", "createdAt": "2020-10-20T07:46:43Z", "path": "testsuite/manualmode/src/test/java/org/jboss/as/test/manualmode/management/persistence/RemoteSshGitRepositoryTestCase.java", "diffHunk": "@@ -171,10 +174,19 @@ public static void setUp() throws Exception {\n \n     }\n \n+    static void backupConfiguration() throws IOException {\n+        Path backUpRoot = Files.createTempDirectory(\"BackUpConfigurationFiles\").resolve(\"configuration\");\n+        Files.createDirectories(backUpRoot);\n+        PathUtil.copyRecursively(getJbossServerBaseDir().resolve(\"configuration\"), backUpRoot, true);\n+\n+        RemoteSshGitRepositoryTestCase.backupRoot = backUpRoot;\n+    }\n+\n     @AfterClass\n     public static void afterClass() throws IOException {\n         Security.removeProvider(CREDENTIAL_STORE_PROVIDER.getName());\n         FileUtils.delete(CS_PUBKEY.toFile(), FileUtils.RECURSIVE | FileUtils.RETRY);\n+        PathUtil.deleteRecursively(backupRoot);", "originalCommit": "2c86e2bf2076bbd5e25aa4f01c8e44a24e865624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODMxMTI1Ng==", "url": "https://github.com/wildfly/wildfly-core/pull/4352#discussion_r508311256", "bodyText": "The configuration is automatically restored after each individual test on line 260 at the end of the tearDown method.\nThe @BeforeClass and @afterclass methods are focused on taking a backup once at the start of the test run and deleting that backup at the end of the test run with the @after method handling the individual clean up after every test.", "author": "darranl", "createdAt": "2020-10-20T08:32:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI4MDQxNA=="}], "type": "inlineReview"}, {"oid": "e9acb6962cf0782310df8c197502a7186a130d50", "url": "https://github.com/wildfly/wildfly-core/commit/e9acb6962cf0782310df8c197502a7186a130d50", "message": "[WFCORE-5147] Log and throw is generally a bad practice, however these errors can be triggered so early in the boot process they are sent to the error output stream meaning the information can not be retrieved from a server log.", "committedDate": "2020-10-20T08:24:36Z", "type": "commit"}, {"oid": "e9acb6962cf0782310df8c197502a7186a130d50", "url": "https://github.com/wildfly/wildfly-core/commit/e9acb6962cf0782310df8c197502a7186a130d50", "message": "[WFCORE-5147] Log and throw is generally a bad practice, however these errors can be triggered so early in the boot process they are sent to the error output stream meaning the information can not be retrieved from a server log.", "committedDate": "2020-10-20T08:24:36Z", "type": "forcePushed"}]}