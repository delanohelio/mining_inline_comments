{"pr_number": 2644, "pr_title": "Send PG_TYPE_TEXTARRAY values to ODBC drivers properly", "pr_createdAt": "2020-05-23T14:11:05Z", "pr_url": "https://github.com/h2database/h2database/pull/2644", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0OTcxOQ==", "url": "https://github.com/h2database/h2database/pull/2644#discussion_r429549719", "bodyText": "I don't see any special treatment for , and } characters, but I guess it should be here.", "author": "katzyn", "createdAt": "2020-05-23T14:14:34Z", "path": "h2/src/main/org/h2/server/pg/PgServerThread.java", "diffHunk": "@@ -582,6 +583,21 @@ private void writeDataColumn(JdbcResultSet rs, int column, int pgType, boolean t\n                 write(data);\n                 break;\n             }\n+            case PgServer.PG_TYPE_TEXTARRAY:\n+                ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+                baos.write('{');\n+                Value[] values = ((ValueArray) v).getList();\n+                Charset encoding = getEncoding();\n+                for (int i = 0; i < values.length; i++) {\n+                    if (i > 0) {\n+                        baos.write(',');\n+                    }\n+                    baos.write(values[i].getString().getBytes(encoding));", "originalCommit": "70292b515628952ae2d9014f6550a5340f305596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1MzcyMQ==", "url": "https://github.com/h2database/h2database/pull/2644#discussion_r429553721", "bodyText": "Sorry for my carelessness. Should quote for \",{} and escape \".", "author": "auntyellow", "createdAt": "2020-05-23T15:06:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0OTcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0OTg0OA==", "url": "https://github.com/h2database/h2database/pull/2644#discussion_r429549848", "bodyText": "This import should be removed.", "author": "katzyn", "createdAt": "2020-05-23T14:16:20Z", "path": "h2/src/test/org/h2/test/unit/TestPgServer.java", "diffHunk": "@@ -32,6 +34,7 @@\n import org.h2.test.TestDb;\n import org.h2.tools.Server;\n import org.h2.util.DateTimeUtils;\n+import org.postgresql.jdbc.PgArray;", "originalCommit": "70292b515628952ae2d9014f6550a5340f305596", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0OTk2Mw==", "url": "https://github.com/h2database/h2database/pull/2644#discussion_r429549963", "bodyText": "If you want to test INTEGER ARRAY, you need to add some support for it first. Currently all arrays are incorrectly mapped to PG_TYPE_TEXTARRAY, but they should be mapped to different types of PostgreSQL, this type is suitable only for VARCHAR ARRAY.", "author": "katzyn", "createdAt": "2020-05-23T14:18:02Z", "path": "h2/src/test/org/h2/test/unit/TestPgServer.java", "diffHunk": "@@ -695,4 +699,34 @@ private void testOtherPgClients() throws SQLException {\n             conn0.close();\n         }\n     }\n+\n+    private void testArray() throws Exception {\n+        if (!getPgJdbcDriver()) {\n+            return;\n+        }\n+\n+        Server server = createPgServer(\n+                \"-ifNotExists\", \"-pgPort\", \"5535\", \"-pgDaemon\", \"-key\", \"pgserver\", \"mem:pgserver\");\n+        try (\n+                Connection conn = DriverManager.getConnection(\n+                        \"jdbc:postgresql://localhost:5535/pgserver\", \"sa\", \"sa\");\n+                Statement stat = conn.createStatement();\n+        ) {\n+            stat.execute(\"CREATE TABLE test (id int primary key, x1 int array, x2 varchar array)\");\n+            stat.execute(\"INSERT INTO test (id, x1, x2) VALUES (1, ARRAY[2, 3], ARRAY['4', '5'])\");", "originalCommit": "70292b515628952ae2d9014f6550a5340f305596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1NDE1OA==", "url": "https://github.com/h2database/h2database/pull/2644#discussion_r429554158", "bodyText": "Just test VARCHAR ARRAY only. Will add support for INTEGER ARRAY later. Some types may be added, like:\npublic static final int PG_TYPE_BOOLARRAY = 1000; \npublic static final int PG_TYPE_INT2ARRAY = 1005; \npublic static final int PG_TYPE_INT4ARRAY = 1007;\npublic static final int PG_TYPE_INT8ARRAY = 1016;\npublic static final int PG_TYPE_FLOAT4ARRAY = 1021;\npublic static final int PG_TYPE_FLOAT8ARRAY = 1022;\n...", "author": "auntyellow", "createdAt": "2020-05-23T15:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0OTk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1MDA3OQ==", "url": "https://github.com/h2database/h2database/pull/2644#discussion_r429550079", "bodyText": "Please, add tests for special characters and for array assignments via parameters of PreparedStatement and all necessary code for them.", "author": "katzyn", "createdAt": "2020-05-23T14:19:47Z", "path": "h2/src/test/org/h2/test/unit/TestPgServer.java", "diffHunk": "@@ -695,4 +699,34 @@ private void testOtherPgClients() throws SQLException {\n             conn0.close();\n         }\n     }\n+\n+    private void testArray() throws Exception {\n+        if (!getPgJdbcDriver()) {\n+            return;\n+        }\n+\n+        Server server = createPgServer(\n+                \"-ifNotExists\", \"-pgPort\", \"5535\", \"-pgDaemon\", \"-key\", \"pgserver\", \"mem:pgserver\");\n+        try (\n+                Connection conn = DriverManager.getConnection(\n+                        \"jdbc:postgresql://localhost:5535/pgserver\", \"sa\", \"sa\");\n+                Statement stat = conn.createStatement();\n+        ) {\n+            stat.execute(\"CREATE TABLE test (id int primary key, x1 int array, x2 varchar array)\");\n+            stat.execute(\"INSERT INTO test (id, x1, x2) VALUES (1, ARRAY[2, 3], ARRAY['4', '5'])\");\n+            try (ResultSet rs = stat.executeQuery(\n+                    \"SELECT x1, x2 FROM test WHERE id = 1\")) {\n+                assertTrue(rs.next());\n+                Object[] arr = (Object[]) rs.getArray(1).getArray();\n+                assertEquals(\"2\", arr[0]);\n+                assertEquals(\"3\", arr[1]);\n+                arr = (Object[]) rs.getArray(2).getArray();\n+                assertEquals(\"4\", arr[0]);\n+                assertEquals(\"5\", arr[1]);\n+            }", "originalCommit": "70292b515628952ae2d9014f6550a5340f305596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1NTAyOQ==", "url": "https://github.com/h2database/h2database/pull/2644#discussion_r429555029", "bodyText": "Prepare statement for an Array does not work like\nPreparedStatement ps = conn.prepareStatement(\"INSERT INTO test (id, x1) VALUES (1, ?)\")\nArray arr = conn.createArrayOf(\"VARCHAR\", new Object[] {\"'a'b'c'\", \"d\\\"e\", \"{,}\"});\n\npg-jdbc seems to generate an SQL that H2 does not support:\nSELECT t.oid, t.typname   FROM pg_catalog.pg_type t  JOIN pg_catalog.pg_namespace n ON t.typnamespace = n.oid WHERE t.typelem = (SELECT oid FROM pg_catalog.pg_type WHERE typname = $1) AND substring(t.typname, 1, 1) = '_' AND t.typlen = -1 AND (n.nspname = $2 OR $3 AND n.nspname = ANY (current_schemas(true))) ORDER BY t.typelem DESC LIMIT 1", "author": "auntyellow", "createdAt": "2020-05-23T15:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1MDA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1NTk2MQ==", "url": "https://github.com/h2database/h2database/pull/2644#discussion_r429555961", "bodyText": "Does it work with setObject(column, Object[] or String[])?", "author": "katzyn", "createdAt": "2020-05-23T15:36:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1MDA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1ODMyMA==", "url": "https://github.com/h2database/h2database/pull/2644#discussion_r429558320", "bodyText": "setObject(column, String[], Types.ARRAY) works, and send:\nINSERT INTO test (id, x1) VALUES (1, $1)\n$1 = {\"'a'b'c'\", \"d\\\"e\", \"{,}\"}\n\nBut H2 gets an array with one element {\"{\\\"'a'b'c'\\\", \\\"d\\\\\\\"e\\\", \\\"{,}\\\"}\"}.\nAnd PostgreSQL 12 works correct.", "author": "auntyellow", "createdAt": "2020-05-23T16:08:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1MDA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU5MjQxNg==", "url": "https://github.com/h2database/h2database/pull/2644#discussion_r429592416", "bodyText": "Hypothetically PgServerThread.setParameter() can parse PG_TYPE_TEXTARRAY parameters in that way.", "author": "katzyn", "createdAt": "2020-05-24T02:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1MDA3OQ=="}], "type": "inlineReview"}, {"oid": "34a094a7cfe20eb27c2a984286f9837d59ff685f", "url": "https://github.com/h2database/h2database/commit/34a094a7cfe20eb27c2a984286f9837d59ff685f", "message": "fixes #2643", "committedDate": "2020-05-23T15:04:54Z", "type": "forcePushed"}, {"oid": "eef6a0354b22d7bf6e20ef4687b1dadf7e6182ed", "url": "https://github.com/h2database/h2database/commit/eef6a0354b22d7bf6e20ef4687b1dadf7e6182ed", "message": "fixes #2643", "committedDate": "2020-05-23T16:21:13Z", "type": "commit"}, {"oid": "eef6a0354b22d7bf6e20ef4687b1dadf7e6182ed", "url": "https://github.com/h2database/h2database/commit/eef6a0354b22d7bf6e20ef4687b1dadf7e6182ed", "message": "fixes #2643", "committedDate": "2020-05-23T16:21:13Z", "type": "forcePushed"}]}