{"pr_number": 2976, "pr_title": "Linked table deadlock", "pr_createdAt": "2020-12-06T22:07:57Z", "pr_url": "https://github.com/h2database/h2database/pull/2976", "timeline": [{"oid": "92708b40851abdb5fbf342e98ba943cef8ee597a", "url": "https://github.com/h2database/h2database/commit/92708b40851abdb5fbf342e98ba943cef8ee597a", "message": "allow differently named databases to be opened concurrently", "committedDate": "2020-12-06T19:02:43Z", "type": "commit"}, {"oid": "00f66566a03afc751509b3d7d70dc998e24b87ca", "url": "https://github.com/h2database/h2database/commit/00f66566a03afc751509b3d7d70dc998e24b87ca", "message": "fix AUTO_SERVER case", "committedDate": "2020-12-06T21:11:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI4ODA3Mg==", "url": "https://github.com/h2database/h2database/pull/2976#discussion_r537288072", "bodyText": "extra semicolon", "author": "grandinj", "createdAt": "2020-12-07T07:37:41Z", "path": "h2/src/main/org/h2/engine/Engine.java", "diffHunk": "@@ -52,65 +52,75 @@ private static SessionLocal openSession(ConnectionInfo ci, boolean ifExists, boo\n         boolean openNew = ci.getProperty(\"OPEN_NEW\", false);\n         boolean opened = false;\n         User user = null;\n-        synchronized (DATABASES) {\n-            if (openNew || ci.isUnnamedInMemory()) {\n-                database = null;\n-            } else {\n-                database = DATABASES.get(name);\n+        DatabaseHolder databaseHolder = new DatabaseHolder();;", "originalCommit": "92708b40851abdb5fbf342e98ba943cef8ee597a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI4ODUyOA==", "url": "https://github.com/h2database/h2database/pull/2976#discussion_r537288528", "bodyText": "this is a double-checked locking pattern, which always make me nervouse. Given that this is a rather infrequent operation, let's just do the simple thing and always lock the databasHolder?", "author": "grandinj", "createdAt": "2020-12-07T07:38:40Z", "path": "h2/src/main/org/h2/engine/Engine.java", "diffHunk": "@@ -52,65 +52,75 @@ private static SessionLocal openSession(ConnectionInfo ci, boolean ifExists, boo\n         boolean openNew = ci.getProperty(\"OPEN_NEW\", false);\n         boolean opened = false;\n         User user = null;\n-        synchronized (DATABASES) {\n-            if (openNew || ci.isUnnamedInMemory()) {\n-                database = null;\n-            } else {\n-                database = DATABASES.get(name);\n+        DatabaseHolder databaseHolder = new DatabaseHolder();;\n+        if (!ci.isUnnamedInMemory()) {\n+            synchronized (DATABASES) {\n+                if (openNew) {\n+                    DATABASES.put(name, databaseHolder);\n+                } else {\n+                    databaseHolder = DATABASES.computeIfAbsent(name, (key) -> new DatabaseHolder());\n+                }\n             }\n-            if (database == null) {\n-                if (ci.isPersistent()) {\n-                    String p = ci.getProperty(\"MV_STORE\");\n-                    String fileName;\n-                    if (p == null) {\n-                        fileName = name + Constants.SUFFIX_MV_FILE;\n-                        if (!FileUtils.exists(fileName)) {\n-                            fileName = name + Constants.SUFFIX_PAGE_FILE;\n-                            if (FileUtils.exists(fileName)) {\n-                                ci.setProperty(\"MV_STORE\", \"false\");\n-                            } else {\n-                                throwNotFound(ifExists, forbidCreation, name);\n-                                fileName = name + Constants.SUFFIX_OLD_DATABASE_FILE;\n+        }\n+        database = databaseHolder.database;\n+        if (database == null) {\n+            synchronized (databaseHolder) {\n+                database = databaseHolder.database;\n+                if (database == null) {\n+                    if (ci.isPersistent()) {", "originalCommit": "92708b40851abdb5fbf342e98ba943cef8ee597a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1NzMxNA==", "url": "https://github.com/h2database/h2database/pull/2976#discussion_r537557314", "bodyText": "I was born long before double-checking locking has been invented and then condemned, so that's one of a few things about Java, I still remember (and love as an interview question).\nThis is not exactly it, because the field is volatile, therefore there is no reason to be nervous.  \ud83d\ude04\nI agree, it's infrequent enough indeed, but if database has been created already there is absolutely no reason for two concurrent new sessions to block each other.", "author": "andreitokar", "createdAt": "2020-12-07T14:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI4ODUyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY3NjE5OA==", "url": "https://github.com/h2database/h2database/pull/2976#discussion_r537676198", "bodyText": "DCL is not technically wrong e.g. here. Although it was wrong when I started writing Java with version 1.1.8, since that predated the memory model by a long way.\nIt's just an esoteric thing that is hard to read and hard to reason about, and therefore makes bad programming practice, especially when used somewhere it is completely unnecessary.", "author": "grandinj", "createdAt": "2020-12-07T17:09:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI4ODUyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3NjI4OQ==", "url": "https://github.com/h2database/h2database/pull/2976#discussion_r537876289", "bodyText": "Yes, it was wrong (and still is in it's classic incarnation) since JDK 1.0.2, nevertheless it was promoted everywhere since at least 1996. I do not find it particularly hard to read (i.e. compare with streams) or esoteric, because every Java developer have heard of it by now (or he/she is not a Java developer).\nIn that particular instance it's truly \"optional\", so if you have such a strong opinion, i'll remove it.", "author": "andreitokar", "createdAt": "2020-12-07T22:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI4ODUyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk5NzI0OA==", "url": "https://github.com/h2database/h2database/pull/2976#discussion_r537997248", "bodyText": "I learned something from your discussion. Thank you, appreciate it.", "author": "manticore-projects", "createdAt": "2020-12-08T03:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI4ODUyOA=="}], "type": "inlineReview"}, {"oid": "7dd7ac5e61aed9e48c054dbc65b6e449c3052b42", "url": "https://github.com/h2database/h2database/commit/7dd7ac5e61aed9e48c054dbc65b6e449c3052b42", "message": "remove extra semicolon", "committedDate": "2020-12-07T14:46:43Z", "type": "commit"}, {"oid": "38e14144f9ecd2270dc498ff090f4d1dbfed09f1", "url": "https://github.com/h2database/h2database/commit/38e14144f9ecd2270dc498ff090f4d1dbfed09f1", "message": "remove \"DCL\"", "committedDate": "2020-12-07T22:19:14Z", "type": "commit"}]}