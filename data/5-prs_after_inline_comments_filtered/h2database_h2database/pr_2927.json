{"pr_number": 2927, "pr_title": "Binary NUMERIC type support for Npgsql", "pr_createdAt": "2020-10-15T13:44:46Z", "pr_url": "https://github.com/h2database/h2database/pull/2927", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2OTk1Mw==", "url": "https://github.com/h2database/h2database/pull/2927#discussion_r505969953", "bodyText": "Why you convert short to int and then to Integer here and below?", "author": "katzyn", "createdAt": "2020-10-16T01:37:44Z", "path": "h2/src/main/org/h2/server/pg/PgServerThread.java", "diffHunk": "@@ -734,6 +739,57 @@ private void writeDataColumn(Value v, int pgType, boolean text) throws IOExcepti\n         }\n     }\n \n+    private static final int[] POWERS10 = {1, 10, 100, 1000, 10000};\n+    private static final int MAX_GROUP_SCALE = 4;\n+    private static final int MAX_GROUP_SIZE = POWERS10[4];\n+\n+    private static int divide(BigInteger[] unscaled, int divisor) {\n+        BigInteger[] bi = unscaled[0].divideAndRemainder(BigInteger.valueOf(divisor));\n+        unscaled[0] = bi[0];\n+        return bi[1].shortValue();", "originalCommit": "53cd55b956c49b022ccee4b601d45435d50f63bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk3NjIxNQ==", "url": "https://github.com/h2database/h2database/pull/2927#discussion_r505976215", "bodyText": "Such hyperlink is useless, because this file can be changed in the main branch at any moment, you need to use the exact commit, but it would be better not to use third-party resources at all. PostgreSQL has own documentation.", "author": "katzyn", "createdAt": "2020-10-16T01:51:51Z", "path": "h2/src/main/org/h2/server/pg/PgServerThread.java", "diffHunk": "@@ -734,6 +739,57 @@ private void writeDataColumn(Value v, int pgType, boolean text) throws IOExcepti\n         }\n     }\n \n+    private static final int[] POWERS10 = {1, 10, 100, 1000, 10000};\n+    private static final int MAX_GROUP_SCALE = 4;\n+    private static final int MAX_GROUP_SIZE = POWERS10[4];\n+\n+    private static int divide(BigInteger[] unscaled, int divisor) {\n+        BigInteger[] bi = unscaled[0].divideAndRemainder(BigInteger.valueOf(divisor));\n+        unscaled[0] = bi[0];\n+        return bi[1].shortValue();\n+    }\n+\n+    // https://www.npgsql.org/dev/types.html\n+    // https://github.com/npgsql/npgsql/blob/main/src/Npgsql/TypeHandlers/NumericHandlers/NumericHandler.cs#L167", "originalCommit": "53cd55b956c49b022ccee4b601d45435d50f63bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk0ODgwNw==", "url": "https://github.com/h2database/h2database/pull/2927#discussion_r506948807", "bodyText": "PostgreSQL official document doesn't seem to show details (detailed binary representation for each type) as Npgsql. In fact some representations are described in PG's internal C codes.", "author": "auntyellow", "createdAt": "2020-10-17T14:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk3NjIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4MjMyMg==", "url": "https://github.com/h2database/h2database/pull/2927#discussion_r505982322", "bodyText": "groups.size() can be extracted into a new variable.", "author": "katzyn", "createdAt": "2020-10-16T02:05:09Z", "path": "h2/src/main/org/h2/server/pg/PgServerThread.java", "diffHunk": "@@ -734,6 +739,57 @@ private void writeDataColumn(Value v, int pgType, boolean text) throws IOExcepti\n         }\n     }\n \n+    private static final int[] POWERS10 = {1, 10, 100, 1000, 10000};\n+    private static final int MAX_GROUP_SCALE = 4;\n+    private static final int MAX_GROUP_SIZE = POWERS10[4];\n+\n+    private static int divide(BigInteger[] unscaled, int divisor) {\n+        BigInteger[] bi = unscaled[0].divideAndRemainder(BigInteger.valueOf(divisor));\n+        unscaled[0] = bi[0];\n+        return bi[1].shortValue();\n+    }\n+\n+    // https://www.npgsql.org/dev/types.html\n+    // https://github.com/npgsql/npgsql/blob/main/src/Npgsql/TypeHandlers/NumericHandlers/NumericHandler.cs#L167\n+    private void writeNumericBinary(BigDecimal value) throws IOException {\n+        int weight = 0;\n+        List<Integer> groups = new ArrayList<>();\n+        int scale = value.scale();\n+        int signum = value.signum();\n+        if (signum != 0) {\n+            BigInteger[] unscaled = new BigInteger[] {value.unscaledValue()};\n+            if (signum < 0) {\n+                unscaled[0] = unscaled[0].negate();\n+            }\n+            weight = -scale / MAX_GROUP_SCALE - 1;\n+            int remainder = 0;\n+            int scaleChunk = scale % MAX_GROUP_SCALE;\n+            if (scaleChunk > 0) {\n+                remainder = divide(unscaled, POWERS10[scaleChunk]) * POWERS10[MAX_GROUP_SCALE - scaleChunk];\n+                if (remainder != 0) {\n+                    weight--;\n+                }\n+            }\n+            if (remainder == 0) {\n+                while ((remainder = divide(unscaled, MAX_GROUP_SIZE)) == 0) {\n+                    weight++;\n+                }\n+            }\n+            groups.add(remainder);\n+            while (unscaled[0].signum() != 0) {\n+                groups.add(divide(unscaled, MAX_GROUP_SIZE));\n+            }\n+        }\n+        writeInt(8 + groups.size() * 2);\n+        writeShort(groups.size());\n+        writeShort(groups.size() + weight);", "originalCommit": "53cd55b956c49b022ccee4b601d45435d50f63bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NTA0Nw==", "url": "https://github.com/h2database/h2database/pull/2927#discussion_r505985047", "bodyText": "And here we have another problem with scale. SELECT 1E-100000 and SELECT 1E-60000 throw\nException in thread \"main\" java.lang.IllegalArgumentException: invalid scale in \"numeric\" value\n\tat org.postgresql.util.ByteConverter.numeric(ByteConverter.java:183)\n\tat org.postgresql.util.ByteConverter.numeric(ByteConverter.java:147)\n\tat org.postgresql.jdbc.PgResultSet.getNumeric(PgResultSet.java:2355)\n\tat org.postgresql.jdbc.PgResultSet.getBigDecimal(PgResultSet.java:2332)\n\tat org.postgresql.jdbc.PgResultSet.getBigDecimal(PgResultSet.java:390)\n\nSELECT 1E-70000 returns 0E-4464.\nI think behavior should be consistent, for example, scale can be normalized to the supported by PosgreSQL range.", "author": "katzyn", "createdAt": "2020-10-16T02:11:06Z", "path": "h2/src/main/org/h2/server/pg/PgServerThread.java", "diffHunk": "@@ -734,6 +739,57 @@ private void writeDataColumn(Value v, int pgType, boolean text) throws IOExcepti\n         }\n     }\n \n+    private static final int[] POWERS10 = {1, 10, 100, 1000, 10000};\n+    private static final int MAX_GROUP_SCALE = 4;\n+    private static final int MAX_GROUP_SIZE = POWERS10[4];\n+\n+    private static int divide(BigInteger[] unscaled, int divisor) {\n+        BigInteger[] bi = unscaled[0].divideAndRemainder(BigInteger.valueOf(divisor));\n+        unscaled[0] = bi[0];\n+        return bi[1].shortValue();\n+    }\n+\n+    // https://www.npgsql.org/dev/types.html\n+    // https://github.com/npgsql/npgsql/blob/main/src/Npgsql/TypeHandlers/NumericHandlers/NumericHandler.cs#L167\n+    private void writeNumericBinary(BigDecimal value) throws IOException {\n+        int weight = 0;\n+        List<Integer> groups = new ArrayList<>();\n+        int scale = value.scale();\n+        int signum = value.signum();\n+        if (signum != 0) {\n+            BigInteger[] unscaled = new BigInteger[] {value.unscaledValue()};\n+            if (signum < 0) {\n+                unscaled[0] = unscaled[0].negate();\n+            }\n+            weight = -scale / MAX_GROUP_SCALE - 1;\n+            int remainder = 0;\n+            int scaleChunk = scale % MAX_GROUP_SCALE;\n+            if (scaleChunk > 0) {\n+                remainder = divide(unscaled, POWERS10[scaleChunk]) * POWERS10[MAX_GROUP_SCALE - scaleChunk];\n+                if (remainder != 0) {\n+                    weight--;\n+                }\n+            }\n+            if (remainder == 0) {\n+                while ((remainder = divide(unscaled, MAX_GROUP_SIZE)) == 0) {\n+                    weight++;\n+                }\n+            }\n+            groups.add(remainder);\n+            while (unscaled[0].signum() != 0) {\n+                groups.add(divide(unscaled, MAX_GROUP_SIZE));\n+            }\n+        }\n+        writeInt(8 + groups.size() * 2);\n+        writeShort(groups.size());\n+        writeShort(groups.size() + weight);\n+        writeShort(signum < 0 ? 16384 : 0);\n+        writeShort(scale);", "originalCommit": "53cd55b956c49b022ccee4b601d45435d50f63bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "17052cb3a3785a5887dfd944c9fcd44201d469c5", "url": "https://github.com/h2database/h2database/commit/17052cb3a3785a5887dfd944c9fcd44201d469c5", "message": "binary numeric for Npgsql\n\nbinary bool bugfix\nbinary formatCode bugfix", "committedDate": "2020-10-17T14:09:31Z", "type": "commit"}, {"oid": "17052cb3a3785a5887dfd944c9fcd44201d469c5", "url": "https://github.com/h2database/h2database/commit/17052cb3a3785a5887dfd944c9fcd44201d469c5", "message": "binary numeric for Npgsql\n\nbinary bool bugfix\nbinary formatCode bugfix", "committedDate": "2020-10-17T14:09:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk1MTYxNQ==", "url": "https://github.com/h2database/h2database/pull/2927#discussion_r506951615", "bodyText": "SELECT 1E1 works with PostgreSQL/PgJDBC well, getBigDecimal() returns 10 as expected. I think you need to normalize scale in your implementation too.", "author": "katzyn", "createdAt": "2020-10-17T15:00:52Z", "path": "h2/src/test/org/h2/test/unit/TestPgServer.java", "diffHunk": "@@ -521,6 +526,44 @@ private void testTextualAndBinaryTypes(boolean binary) throws SQLException {\n         }\n     }\n \n+    private void testBinaryNumeric() throws SQLException {\n+        if (!getPgJdbcDriver()) {\n+            return;\n+        }\n+        Server server = createPgServer(\n+                \"-ifNotExists\", \"-pgPort\", \"5535\", \"-pgDaemon\", \"-key\", \"pgserver\", \"mem:pgserver\");\n+        supportedBinaryOids.add(1700);\n+        try {\n+            Properties props = new Properties();\n+            props.setProperty(\"user\", \"sa\");\n+            props.setProperty(\"password\", \"sa\");\n+            // force binary\n+            props.setProperty(\"prepareThreshold\", \"-1\");\n+\n+            Connection conn = DriverManager.getConnection(\n+                    \"jdbc:postgresql://localhost:5535/pgserver\", props);\n+            Statement stat = conn.createStatement();\n+\n+            try (ResultSet rs = stat.executeQuery(\"SELECT 1E-16383, 1E-16384, 1E+1\")) {\n+                rs.next();\n+                assertEquals(new BigDecimal(\"1E-16383\"), rs.getBigDecimal(1));\n+                for (int i = 2; i <= 3; i ++) {\n+                    try {\n+                        rs.getBigDecimal(i);\n+                        fail();\n+                    } catch (IllegalArgumentException e) {\n+                        // PgJDBC doesn't support scale greater than 16383 or negative scale\n+                    }\n+                }\n+            }", "originalCommit": "17052cb3a3785a5887dfd944c9fcd44201d469c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE0NjE2NA==", "url": "https://github.com/h2database/h2database/pull/2927#discussion_r507146164", "bodyText": "Normalized in the latest commit. May still have problem for 1E+131072 or other edge cases. (Write an incorrect value or throw exception? I choose writing the incorrect value because PgJDBC and Npgsql will reject them.)", "author": "auntyellow", "createdAt": "2020-10-18T13:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk1MTYxNQ=="}], "type": "inlineReview"}, {"oid": "dda63349520cd44ad35c38891f1d9303c03c9369", "url": "https://github.com/h2database/h2database/commit/dda63349520cd44ad35c38891f1d9303c03c9369", "message": "normalize scale for binary numeric", "committedDate": "2020-10-18T13:12:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE3NDI5NQ==", "url": "https://github.com/h2database/h2database/pull/2927#discussion_r507174295", "bodyText": "This assertion is useless due to logic above.", "author": "katzyn", "createdAt": "2020-10-18T15:05:47Z", "path": "h2/src/main/org/h2/server/pg/PgServerThread.java", "diffHunk": "@@ -734,6 +739,66 @@ private void writeDataColumn(Value v, int pgType, boolean text) throws IOExcepti\n         }\n     }\n \n+    private static final int[] POWERS10 = {1, 10, 100, 1000, 10000};\n+    private static final int MAX_GROUP_SCALE = 4;\n+    private static final int MAX_GROUP_SIZE = POWERS10[4];\n+\n+    private static int divide(BigInteger[] unscaled, int divisor) {\n+        BigInteger[] bi = unscaled[0].divideAndRemainder(BigInteger.valueOf(divisor));\n+        unscaled[0] = bi[0];\n+        return bi[1].intValue();\n+    }\n+\n+    // https://www.npgsql.org/dev/types.html\n+    // https://github.com/npgsql/npgsql/blob/8a479081f707784b5040747b23102c3d6371b9d3/\n+    //         src/Npgsql/TypeHandlers/NumericHandlers/NumericHandler.cs#L166\n+    private void writeNumericBinary(BigDecimal value) throws IOException {\n+        int weight = 0;\n+        List<Integer> groups = new ArrayList<>();\n+        int scale = value.scale();\n+        int signum = value.signum();\n+        if (signum != 0) {\n+            BigInteger[] unscaled = {null};\n+            if (scale < 0) {\n+                unscaled[0] = value.setScale(0).unscaledValue();\n+                scale = 0;\n+            } else {\n+                unscaled[0] = value.unscaledValue();\n+            }\n+            if (signum < 0) {\n+                unscaled[0] = unscaled[0].negate();\n+            }\n+            weight = -scale / MAX_GROUP_SCALE - 1;\n+            int remainder = 0;\n+            int scaleChunk = scale % MAX_GROUP_SCALE;\n+            if (scaleChunk > 0) {\n+                remainder = divide(unscaled, POWERS10[scaleChunk]) * POWERS10[MAX_GROUP_SCALE - scaleChunk];\n+                if (remainder != 0) {\n+                    weight--;\n+                }\n+            }\n+            if (remainder == 0) {\n+                while ((remainder = divide(unscaled, MAX_GROUP_SIZE)) == 0) {\n+                    weight++;\n+                }\n+            }\n+            groups.add(remainder);\n+            while (unscaled[0].signum() != 0) {\n+                groups.add(divide(unscaled, MAX_GROUP_SIZE));\n+            }\n+        }\n+        int groupCount = groups.size();\n+        writeInt(8 + groupCount * 2);\n+        writeShort(groupCount);\n+        writeShort(groupCount + weight);\n+        writeShort(signum < 0 ? 16384 : 0);\n+        assert scale >= 0;", "originalCommit": "dda63349520cd44ad35c38891f1d9303c03c9369", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE3NDU0OQ==", "url": "https://github.com/h2database/h2database/pull/2927#discussion_r507174549", "bodyText": "I don't understand this condition. When scale is too large this code simply writes an incorrect scale? Why?\nIt looks like it should throw an exception instead.", "author": "katzyn", "createdAt": "2020-10-18T15:08:01Z", "path": "h2/src/main/org/h2/server/pg/PgServerThread.java", "diffHunk": "@@ -734,6 +739,66 @@ private void writeDataColumn(Value v, int pgType, boolean text) throws IOExcepti\n         }\n     }\n \n+    private static final int[] POWERS10 = {1, 10, 100, 1000, 10000};\n+    private static final int MAX_GROUP_SCALE = 4;\n+    private static final int MAX_GROUP_SIZE = POWERS10[4];\n+\n+    private static int divide(BigInteger[] unscaled, int divisor) {\n+        BigInteger[] bi = unscaled[0].divideAndRemainder(BigInteger.valueOf(divisor));\n+        unscaled[0] = bi[0];\n+        return bi[1].intValue();\n+    }\n+\n+    // https://www.npgsql.org/dev/types.html\n+    // https://github.com/npgsql/npgsql/blob/8a479081f707784b5040747b23102c3d6371b9d3/\n+    //         src/Npgsql/TypeHandlers/NumericHandlers/NumericHandler.cs#L166\n+    private void writeNumericBinary(BigDecimal value) throws IOException {\n+        int weight = 0;\n+        List<Integer> groups = new ArrayList<>();\n+        int scale = value.scale();\n+        int signum = value.signum();\n+        if (signum != 0) {\n+            BigInteger[] unscaled = {null};\n+            if (scale < 0) {\n+                unscaled[0] = value.setScale(0).unscaledValue();\n+                scale = 0;\n+            } else {\n+                unscaled[0] = value.unscaledValue();\n+            }\n+            if (signum < 0) {\n+                unscaled[0] = unscaled[0].negate();\n+            }\n+            weight = -scale / MAX_GROUP_SCALE - 1;\n+            int remainder = 0;\n+            int scaleChunk = scale % MAX_GROUP_SCALE;\n+            if (scaleChunk > 0) {\n+                remainder = divide(unscaled, POWERS10[scaleChunk]) * POWERS10[MAX_GROUP_SCALE - scaleChunk];\n+                if (remainder != 0) {\n+                    weight--;\n+                }\n+            }\n+            if (remainder == 0) {\n+                while ((remainder = divide(unscaled, MAX_GROUP_SIZE)) == 0) {\n+                    weight++;\n+                }\n+            }\n+            groups.add(remainder);\n+            while (unscaled[0].signum() != 0) {\n+                groups.add(divide(unscaled, MAX_GROUP_SIZE));\n+            }\n+        }\n+        int groupCount = groups.size();\n+        writeInt(8 + groupCount * 2);\n+        writeShort(groupCount);\n+        writeShort(groupCount + weight);\n+        writeShort(signum < 0 ? 16384 : 0);\n+        assert scale >= 0;\n+        writeShort(scale > Short.MAX_VALUE ? Short.MAX_VALUE : scale);", "originalCommit": "dda63349520cd44ad35c38891f1d9303c03c9369", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYzNzg0OA==", "url": "https://github.com/h2database/h2database/pull/2927#discussion_r508637848", "bodyText": "Ok. Just throw \"Numeric Value out of Range\" (22003).", "author": "auntyellow", "createdAt": "2020-10-20T15:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE3NDU0OQ=="}], "type": "inlineReview"}, {"oid": "1c4cdf95906b7844ee98eb28dcfec14d62eeb037", "url": "https://github.com/h2database/h2database/commit/1c4cdf95906b7844ee98eb28dcfec14d62eeb037", "message": "throws 22003 if binary numeric scale or weight too large", "committedDate": "2020-10-20T15:49:46Z", "type": "commit"}]}