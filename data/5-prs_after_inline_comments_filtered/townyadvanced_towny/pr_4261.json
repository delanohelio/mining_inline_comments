{"pr_number": 4261, "pr_title": "Refactor/nations dont save towns anymore", "pr_createdAt": "2020-08-12T20:39:37Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/4261", "timeline": [{"oid": "97021a2bffefa9c644e38fd9957437583ca2e117", "url": "https://github.com/TownyAdvanced/Towny/commit/97021a2bffefa9c644e38fd9957437583ca2e117", "message": "Removes towns.txt and nations.txt files.\n\nRemoves necessity of saving the towns and nations lists.\nLoads old towns.txt and nations.txt to ensure that orphaned files in the\ntowns & nations folders are not loaded. If successfully loaded, the\ntowns.txt and nations.txt files are deleted.", "committedDate": "2020-07-24T19:20:10Z", "type": "commit"}, {"oid": "22c0db544affaca4b4250e342e29f7ee2161b8b7", "url": "https://github.com/TownyAdvanced/Towny/commit/22c0db544affaca4b4250e342e29f7ee2161b8b7", "message": "Refactor for Towns loading their mayors.\n\nIf a town attempts to set a mayor who is not part of the town, and the\ntown has no residents, the town will be deleted.\n  - Closes #4170.", "committedDate": "2020-07-25T12:56:42Z", "type": "commit"}, {"oid": "c81a3b89c7c221bb4637a2cf63dc47448b214b4c", "url": "https://github.com/TownyAdvanced/Towny/commit/c81a3b89c7c221bb4637a2cf63dc47448b214b4c", "message": "Refactor removing nations storing their towns.\n\nWorkload of adding/removing a nation for a town now worked out in Town\ninstead of Nation.\nReduces all but one EmptyNationException.\n\nUntested.", "committedDate": "2020-07-25T19:11:34Z", "type": "commit"}, {"oid": "6d261c6b5025b97a25b3dff4d7db9cbaaa7d59cb", "url": "https://github.com/TownyAdvanced/Towny/commit/6d261c6b5025b97a25b3dff4d7db9cbaaa7d59cb", "message": "Merge remote-tracking branch 'origin/master' into refactor/nations_dont_save_towns_anymore", "committedDate": "2020-07-25T19:18:36Z", "type": "commit"}, {"oid": "d051e7e0692f80a289bd90debb6820a3d0a842e2", "url": "https://github.com/TownyAdvanced/Towny/commit/d051e7e0692f80a289bd90debb6820a3d0a842e2", "message": "Slight tweaking on initial commit.", "committedDate": "2020-07-25T19:45:02Z", "type": "commit"}, {"oid": "522140149fe9899dea031d3bf3d763c79fb7021c", "url": "https://github.com/TownyAdvanced/Towny/commit/522140149fe9899dea031d3bf3d763c79fb7021c", "message": "Clean up nation/town loading, handle loading nation capitals\nintelligently.", "committedDate": "2020-07-26T01:25:41Z", "type": "commit"}, {"oid": "f5f4af8bfc5b097ccec277e726d063f780958251", "url": "https://github.com/TownyAdvanced/Towny/commit/f5f4af8bfc5b097ccec277e726d063f780958251", "message": "Re-work mayor setting. Find new mayors when a town loads a mayor who\ndoesn't match.\n\nTODO: testing.", "committedDate": "2020-07-26T02:23:09Z", "type": "commit"}, {"oid": "69b9c3a75766d0a95ff48aa2d07a76e7442306e9", "url": "https://github.com/TownyAdvanced/Towny/commit/69b9c3a75766d0a95ff48aa2d07a76e7442306e9", "message": "Merge branch 'refactor/town_set_mayor_exception_removal' of https://github.com/TownyAdvanced/Towny.git into refactor/nations_dont_save_towns_anymore", "committedDate": "2020-07-26T02:41:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5ODc3MA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#discussion_r470198770", "bodyText": "Please wrap in {} for readability", "author": "silverwolfg11", "createdAt": "2020-08-13T19:32:27Z", "path": "src/com/palmergames/bukkit/towny/object/Nation.java", "diffHunk": "@@ -193,13 +200,35 @@ public void setCapital(Town capital) {\n \t\t} catch (Exception e) {\n \t\t\t// Dummy catch to prevent errors on startup when setting nation.\n \t\t}\n-\t\t//TownyUniverse.getInstance().getDataSource().saveNation(this);\n \t}\n \n \tpublic Town getCapital() {\n \n \t\treturn capital;\n \t}\n+\t\n+\t/**\n+\t * Finds the town in the nation with the most residents and makes it the capital.\n+\t * \n+\t * @return whether it successfully set a capital.\n+\t */\n+\tprivate boolean findNewCapital() {\n+\t\t\n+\t\tint numResidents = 0;\n+\t\tTown tempCapital = null;\n+\t\tfor (Town newCapital : getTowns())", "originalCommit": "69b9c3a75766d0a95ff48aa2d07a76e7442306e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5OTYwMw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#discussion_r470199603", "bodyText": "I don't really see a necessity in making a separate method just to throw an exception. Maybe just make the setMayor(...) method return a boolean indicating success and then handle the result in the loading areas.", "author": "silverwolfg11", "createdAt": "2020-08-13T19:34:02Z", "path": "src/com/palmergames/bukkit/towny/object/Town.java", "diffHunk": "@@ -129,13 +131,32 @@ public double getTaxes() {\n \t\treturn taxes == -1 ? TownySettings.getTownDefaultTax() : taxes;\n \t}\n \n-\tpublic void setMayor(Resident mayor) throws TownyException {\n+\t/**\n+\t * Sets a resident to become mayor. Used only in database loading.\n+\t * \n+\t * @param mayor - Town Resident to make into mayor.\n+\t * @throws TownyException - When given mayor is not a resident.\n+\t */\n+\tpublic void forceSetMayor(Resident mayor) throws TownyException {", "originalCommit": "69b9c3a75766d0a95ff48aa2d07a76e7442306e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwMTg1Ng==", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#discussion_r470201856", "bodyText": "I find it's a lot easier to have a brute-force method that we know will work, especially for loading things.", "author": "LlmDl", "createdAt": "2020-08-13T19:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5OTYwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwNDcyMw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#discussion_r470204723", "bodyText": "I mean both methods do the same thing. The only difference is that one throws an exception for one specific check, while the other just black-holes it. I'm just personally against the design practice of creating one slightly-different method that's only supposed to be in like 1-2 specific places.", "author": "silverwolfg11", "createdAt": "2020-08-13T19:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5OTYwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0ODQzMw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#discussion_r470248433", "bodyText": "Looked over this again. The force one is for loading only, has an exception that is caught if Towny needs to rethink who should be mayor/if a mayor is possible at all.\nThe second one doesn't throw an exception on purpose, one part of the update was making it so that during runtime the setMayor() will never throw an exception, making for less headaches.", "author": "LlmDl", "createdAt": "2020-08-13T21:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5OTYwMw=="}], "type": "inlineReview"}, {"oid": "69e14cbe3cfa300ced80f27a400cf2e34e0d6447", "url": "https://github.com/TownyAdvanced/Towny/commit/69e14cbe3cfa300ced80f27a400cf2e34e0d6447", "message": "Improve readability in Nation.java's findNewCapital().", "committedDate": "2020-08-14T21:26:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4NTIzOA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#discussion_r471185238", "bodyText": "Doesn't this need a return statement since otherwise it will continue to findNewCapital?", "author": "silverwolfg11", "createdAt": "2020-08-17T01:02:00Z", "path": "src/com/palmergames/bukkit/towny/object/Nation.java", "diffHunk": "@@ -171,20 +168,30 @@ public boolean hasTown(Town town) {\n \t\treturn towns.contains(town);\n \t}\n \n-\tpublic void addTown(Town town) throws AlreadyRegisteredException {\n+\tpublic void addTown(Town town) {\n+\t\ttowns.add(town);\n+\t}\n \n-\t\tif (hasTown(town))\n-\t\t\tthrow new AlreadyRegisteredException();\n-\t\telse if (town.hasNation())\n-\t\t\tthrow new AlreadyRegisteredException();\n-\t\telse {\n-\t\t\ttowns.add(town);\n-\t\t\ttown.setNation(this);\n-\t\t\t\n-\t\t\tBukkitTools.getPluginManager().callEvent(new NationAddTownEvent(town, this));\n+\t/**\n+\t * Only to be called from the loading methods.\n+\t * \n+\t * @param capital - Town to make capital.\n+\t * @throws EmptyNationException Thrown when no capital can be set.\n+\t */\n+\tpublic void forceSetCapital(Town capital) throws EmptyNationException {\n+\n+\t\tif (towns.isEmpty())\n+\t\t\tthrow new EmptyNationException(this);\n+\t\t\n+\t\ttry {\n+\t\t\tif (capital.getNation().equals(this))\n+\t\t\t\tsetCapital(capital);", "originalCommit": "69e14cbe3cfa300ced80f27a400cf2e34e0d6447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4NzY2OA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#discussion_r471187668", "bodyText": "Good catch.", "author": "LlmDl", "createdAt": "2020-08-17T01:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4NTIzOA=="}], "type": "inlineReview"}, {"oid": "92c8471c1d6422636f52da1c2a7648fa21edbbd9", "url": "https://github.com/TownyAdvanced/Towny/commit/92c8471c1d6422636f52da1c2a7648fa21edbbd9", "message": "Add missing return to forceSetCapital(Town capital).", "committedDate": "2020-08-17T14:20:50Z", "type": "commit"}, {"oid": "de29034804750b4891124d4b5a69ce5b13048d99", "url": "https://github.com/TownyAdvanced/Towny/commit/de29034804750b4891124d4b5a69ce5b13048d99", "message": "Merge tag '0.96.2.11' into refactor/nations_dont_save_towns_anymore\n\nConflicts:\n\tsrc/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "committedDate": "2020-08-19T01:54:12Z", "type": "commit"}, {"oid": "e0172fabaf74758e4e35d3b55493870eed917845", "url": "https://github.com/TownyAdvanced/Towny/commit/e0172fabaf74758e4e35d3b55493870eed917845", "message": "Merge master branch and sort out conflicts in TownySQLSource.\n\nAlso fix town loading after selecting a new mayor.", "committedDate": "2020-08-21T15:08:11Z", "type": "commit"}, {"oid": "26ca1532b62de8fdb960340c5ad33d204d52d3ab", "url": "https://github.com/TownyAdvanced/Towny/commit/26ca1532b62de8fdb960340c5ad33d204d52d3ab", "message": "Merge branch 'master' into refactor/nations_dont_save_towns_anymore", "committedDate": "2020-08-21T15:14:19Z", "type": "commit"}]}