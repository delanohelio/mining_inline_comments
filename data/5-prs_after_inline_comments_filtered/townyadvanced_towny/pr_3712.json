{"pr_number": 3712, "pr_title": "Implementation of a trie data structure for residents, towns, and nations", "pr_createdAt": "2020-02-22T02:48:31Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/3712", "timeline": [{"oid": "3a1d80f080d20596eff6bf1808f70fca66974caf", "url": "https://github.com/TownyAdvanced/Towny/commit/3a1d80f080d20596eff6bf1808f70fca66974caf", "message": "Functional trie structure implemented with /nation tab completes", "committedDate": "2020-02-21T17:41:30Z", "type": "commit"}, {"oid": "5a488d81ac0118412acaecce7ca7d28354a733cf", "url": "https://github.com/TownyAdvanced/Towny/commit/5a488d81ac0118412acaecce7ca7d28354a733cf", "message": "Trie.java", "committedDate": "2020-02-21T18:56:19Z", "type": "commit"}, {"oid": "987b0e0126a03ad04685f72711af50b22bffbd2a", "url": "https://github.com/TownyAdvanced/Towny/commit/987b0e0126a03ad04685f72711af50b22bffbd2a", "message": "Made applicable commands use trie structure", "committedDate": "2020-02-21T20:01:14Z", "type": "commit"}, {"oid": "5d973ece9260655a9032f087158d1349299d4706", "url": "https://github.com/TownyAdvanced/Towny/commit/5d973ece9260655a9032f087158d1349299d4706", "message": "Implemented getStringsFromKey to replace getTrieNodesFromKey", "committedDate": "2020-02-21T21:23:20Z", "type": "commit"}, {"oid": "2d46e6cc66f9b8119888d11d773022587fcd5fac", "url": "https://github.com/TownyAdvanced/Towny/commit/2d46e6cc66f9b8119888d11d773022587fcd5fac", "message": "Unused imports, made addKey void", "committedDate": "2020-02-21T22:47:39Z", "type": "commit"}, {"oid": "eac3835d317c19f86f1ec16e33e44fd445f76758", "url": "https://github.com/TownyAdvanced/Towny/commit/eac3835d317c19f86f1ec16e33e44fd445f76758", "message": "Comments, cleanup, and rearranging", "committedDate": "2020-02-22T00:15:45Z", "type": "commit"}, {"oid": "2be82260ee74e9da605b6b4dadf1df9f39cc39d5", "url": "https://github.com/TownyAdvanced/Towny/commit/2be82260ee74e9da605b6b4dadf1df9f39cc39d5", "message": "Typo, remove MAX_RETURNS because nothing will get that high (see usages)", "committedDate": "2020-02-22T00:44:11Z", "type": "commit"}, {"oid": "e0f331e558deeffc6059448541db64718a7d2065", "url": "https://github.com/TownyAdvanced/Towny/commit/e0f331e558deeffc6059448541db64718a7d2065", "message": "Removed test code, unused import", "committedDate": "2020-02-22T02:08:25Z", "type": "commit"}, {"oid": "605ef9ded3d914559e4b922fc37ca6abf96edea1", "url": "https://github.com/TownyAdvanced/Towny/commit/605ef9ded3d914559e4b922fc37ca6abf96edea1", "message": "Unused import", "committedDate": "2020-02-22T02:08:38Z", "type": "commit"}, {"oid": "79a344f6412a816041fa4ecc97f58e759095b7d5", "url": "https://github.com/TownyAdvanced/Towny/commit/79a344f6412a816041fa4ecc97f58e759095b7d5", "message": "Removed TrieUtil.java and moved to BaseCommand", "committedDate": "2020-02-22T02:15:25Z", "type": "commit"}, {"oid": "b082d32b80a112b4ab66587fa820ffdc89820f65", "url": "https://github.com/TownyAdvanced/Towny/commit/b082d32b80a112b4ab66587fa820ffdc89820f65", "message": "Grammar/style javadoc change", "committedDate": "2020-02-22T02:22:29Z", "type": "commit"}, {"oid": "84313896fe5553f4baa647d7e9118a90e4f2d25f", "url": "https://github.com/TownyAdvanced/Towny/commit/84313896fe5553f4baa647d7e9118a90e4f2d25f", "message": "Only check if arg isn't empty except for world", "committedDate": "2020-02-22T02:22:53Z", "type": "commit"}, {"oid": "ff6a49845845b0a4d83e3575a82acfca0f19e0c4", "url": "https://github.com/TownyAdvanced/Towny/commit/ff6a49845845b0a4d83e3575a82acfca0f19e0c4", "message": "Grammar/style change", "committedDate": "2020-02-22T02:23:23Z", "type": "commit"}, {"oid": "50f2861c89f3c71a92a74fa35fde99b72f65e9fa", "url": "https://github.com/TownyAdvanced/Towny/commit/50f2861c89f3c71a92a74fa35fde99b72f65e9fa", "message": "Building trie structures logs with TownyMessaging.sendDebugMsg", "committedDate": "2020-02-22T03:38:22Z", "type": "commit"}, {"oid": "74b462a13925bf9188517cc711ee1798a2e39d81", "url": "https://github.com/TownyAdvanced/Towny/commit/74b462a13925bf9188517cc711ee1798a2e39d81", "message": "Added removeKey to Trie, includes test code", "committedDate": "2020-02-22T19:27:58Z", "type": "commit"}, {"oid": "e1b8fdb83d7cb525a55aa14085dd8fa4976d8f39", "url": "https://github.com/TownyAdvanced/Towny/commit/e1b8fdb83d7cb525a55aa14085dd8fa4976d8f39", "message": "Added limit to Trie, removed test code, removed limit from BaseCommand", "committedDate": "2020-02-22T19:51:31Z", "type": "commit"}, {"oid": "566fda34289d6c6ad3029ed2cfd5885d4890576d", "url": "https://github.com/TownyAdvanced/Towny/commit/566fda34289d6c6ad3029ed2cfd5885d4890576d", "message": "Removed timing code", "committedDate": "2020-02-22T19:56:48Z", "type": "commit"}, {"oid": "fbb5584d3f4d2fab8420e472b7f1d21b81cdb94b", "url": "https://github.com/TownyAdvanced/Towny/commit/fbb5584d3f4d2fab8420e472b7f1d21b81cdb94b", "message": "Update trie on renames and removes", "committedDate": "2020-02-22T19:57:25Z", "type": "commit"}, {"oid": "b8721d5af5b41139b277c5ff8359f57c76889c5b", "url": "https://github.com/TownyAdvanced/Towny/commit/b8721d5af5b41139b277c5ff8359f57c76889c5b", "message": "Added missing support for town/nation deletion", "committedDate": "2020-02-22T20:01:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkzOTY0Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/3712#discussion_r382939647", "bodyText": "Remove debug code.", "author": "LlmDl", "createdAt": "2020-02-22T20:33:34Z", "path": "src/com/palmergames/bukkit/towny/command/BaseCommand.java", "diffHunk": "@@ -1,55 +1,75 @@\n package com.palmergames.bukkit.towny.command;\r\n \r\n import com.palmergames.bukkit.towny.TownyUniverse;\r\n-import com.palmergames.bukkit.towny.object.Nation;\r\n-import com.palmergames.bukkit.towny.object.Resident;\r\n-import com.palmergames.bukkit.towny.object.Town;\r\n+import com.palmergames.bukkit.towny.utils.NameUtil;\r\n import org.bukkit.command.Command;\r\n import org.bukkit.command.CommandSender;\r\n import org.bukkit.command.TabCompleter;\r\n \r\n-import java.util.LinkedList;\r\n+import java.util.ArrayList;\r\n import java.util.List;\r\n \r\n-\r\n public class BaseCommand implements TabCompleter{\r\n-\r\n+\t\r\n \t\r\n \t@Override\r\n \tpublic List<String> onTabComplete(CommandSender sender, Command command, String alias, String[] args) {\r\n-\t\tLinkedList<String> output = new LinkedList<>();\r\n-\t\tString lastArg = \"\";\r\n+\t\treturn getTownyStartingWith(args[args.length - 1], \"rtn\");\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Returns a List<String> containing strings of resident, town, and/or nation names that match with arg.\r\n+\t * Can check for multiple types, for example \"rt\" would check for residents and towns but not nations or worlds.\r\n+\t *\r\n+\t * @param arg the string to match with the chosen type\r\n+\t * @param type the type of Towny object to check for, can be r(esident), t(own), n(ation), w(orld), or any combination of those to check\r\n+\t * @return Matches for the arg with the chosen type\r\n+\t */\r\n+\tstatic List<String> getTownyStartingWith(String arg, String type) {\r\n+\t\t//long start = System.nanoTime();\r\n+\t\tList<String> matches = new ArrayList<>();\r\n \t\tTownyUniverse townyUniverse = TownyUniverse.getInstance();\r\n+\t\t\r\n+\t\tif (type.contains(\"r\")) {\r\n+\t\t\tmatches.addAll(townyUniverse.getResidentsTrie().getStringsFromKey(arg));\r\n+\t\t}\r\n \r\n-\t\t// Get the last argument\r\n-\t\tif (args.length > 0) {\r\n-\t\t\tlastArg = args[args.length - 1].toLowerCase();\r\n+\t\tif (type.contains(\"t\")) {\r\n+\t\t\tmatches.addAll(townyUniverse.getTownsTrie().getStringsFromKey(arg));\r\n \t\t}\r\n \r\n-\t\tif (!lastArg.equalsIgnoreCase(\"\")) {\r\n-\t\t\t// Match nations\r\n-\t\t\tfor (Nation nation : townyUniverse.getDataSource().getNations()) {\r\n-\t\t\t\tif (nation.getName().toLowerCase().startsWith(lastArg)) {\r\n-\t\t\t\t\toutput.add(nation.getName());\r\n-\t\t\t\t}\r\n+\t\tif (type.contains(\"n\")) {\r\n+\t\t\tmatches.addAll(townyUniverse.getNationsTrie().getStringsFromKey(arg));\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (type.contains(\"w\")) { // There aren't many worlds so check even if arg is empty\r\n+\t\t\tmatches.addAll(NameUtil.filterByStart(NameUtil.getNames(townyUniverse.getWorldMap().values()), arg));\r\n+\t\t}\r\n \r\n-\t\t\t}\r\n-\t\t\t// Match towns\r\n-\t\t\tfor (Town town : townyUniverse.getDataSource().getTowns()) {\r\n-\t\t\t\tif (town.getName().toLowerCase().startsWith(lastArg)) {\r\n-\t\t\t\t\toutput.add(town.getName());\r\n-\t\t\t\t}\r\n+\t\t//System.out.println(\"Found \"+matches.size()+\" for \"+type+\" in \"+(float)(System.nanoTime()-start)/1000000+\"ms\");\r", "originalCommit": "b8721d5af5b41139b277c5ff8359f57c76889c5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkzOTcxNg==", "url": "https://github.com/TownyAdvanced/Towny/pull/3712#discussion_r382939716", "bodyText": "Remove this line?", "author": "LlmDl", "createdAt": "2020-02-22T20:35:14Z", "path": "src/com/palmergames/util/Trie.java", "diffHunk": "@@ -0,0 +1,175 @@\n+package com.palmergames.util;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Queue;\n+\n+/**\n+ * Dynamic trie structure that can add/remove keys and recursively get matching strings for a key \n+ * \n+ * @author stzups\n+ */\n+public class Trie {\n+\n+\tprivate static final int MAX_RETURNS = 100;\n+\t/**\n+\t * TrieNode implementation that handles any character and keeps track of its own children and character\n+\t */\n+\tpublic static class TrieNode {\n+\t\tList<TrieNode> children = new ArrayList<>();\n+\t\tchar character;\n+\t\tboolean endOfWord = false;\n+\n+\t\tTrieNode(char character) {\n+\t\t\tthis.character = character;\n+\t\t}\n+\t}\n+\n+\tprivate final TrieNode root;\n+\n+\t/**\n+\t * Constructor that creates a new trie with a null root\n+\t */\n+\tpublic Trie() {\n+\t\troot = new TrieNode(Character.MIN_VALUE);\n+\t}\n+\n+\t/**\n+\t * Adds and links new TrieNodes to the trie for each character in the string\n+\t * \n+\t * @param key key to add to trie, can be longer than one character\n+\t */\n+\tpublic void addKey(String key) {\n+\n+\t\t// Current trieNode to crawl through\n+\t\tTrieNode trieNode = root;\n+\n+\t\t// Loop through each character of key\n+\t\tfor (int i = 0; i < key.length(); i++) {\n+\t\t\tchar index = Character.toLowerCase(key.charAt(i)); // Case insensitive\n+\n+\t\t\tTrieNode lastNode = trieNode;\n+\t\t\tOptional<TrieNode> optional = lastNode.children.stream().filter(e -> e.character==index).findFirst();\n+\n+\t\t\tif (!optional.isPresent()) { // No existing TrieNode here, so make a new one\n+\t\t\t\ttrieNode = new TrieNode(index);\n+\t\t\t\tlastNode.children.add(trieNode); // Put this node as one of lastNode's children\n+\t\t\t} else {\n+\t\t\t\ttrieNode = optional.get();\n+\t\t\t}\n+\n+\t\t\tif (i == key.length()-1) { // Check if this is the last character of the key, indicating a word ending\n+\t\t\t\ttrieNode.endOfWord = true;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Removes TrieNodes for a key\n+\t * \n+\t * @param key key to remove\n+\t */\n+\tpublic void removeKey(String key) {\n+\t\t// Current trieNode to crawl through\n+\t\tTrieNode trieNode = root;\n+\t\tQueue<TrieNode> found = Collections.asLifoQueue(new LinkedList<>());\n+\n+\t\t// Loop through each character of key\n+\t\tfor (int i = 0; i < key.length(); i++) {\n+\t\t\tchar index = Character.toLowerCase(key.charAt(i)); // Case insensitive\n+\n+\t\t\tTrieNode lastNode = trieNode;\n+\t\t\t//found.add(lastNode); // Adds to list of TrieNodes to remove", "originalCommit": "b8721d5af5b41139b277c5ff8359f57c76889c5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "51612d19781eaec331cc48bfe9131aca486508e5", "url": "https://github.com/TownyAdvanced/Towny/commit/51612d19781eaec331cc48bfe9131aca486508e5", "message": "Removed/cleaned up some stuff,\n\n- Removed uneccesary else clauses\n- Trim line lengths of some long lines", "committedDate": "2020-02-22T20:36:23Z", "type": "commit"}, {"oid": "196075b6b2bedf02a88d2f2eba7cd1eff7a56c88", "url": "https://github.com/TownyAdvanced/Towny/commit/196075b6b2bedf02a88d2f2eba7cd1eff7a56c88", "message": "More cleanup", "committedDate": "2020-02-22T20:44:23Z", "type": "commit"}, {"oid": "137bc2da5c50381f758511fa9ce081630a271826", "url": "https://github.com/TownyAdvanced/Towny/commit/137bc2da5c50381f758511fa9ce081630a271826", "message": "Spacing", "committedDate": "2020-02-22T20:45:32Z", "type": "commit"}, {"oid": "c48c39252893871bbdc46b729c9db110865b61b7", "url": "https://github.com/TownyAdvanced/Towny/commit/c48c39252893871bbdc46b729c9db110865b61b7", "message": "Removal of unnecessary debug lines, whitespace", "committedDate": "2020-02-22T20:49:13Z", "type": "commit"}, {"oid": "28c59a7b135cc618acf2c1743051effe0571156d", "url": "https://github.com/TownyAdvanced/Towny/commit/28c59a7b135cc618acf2c1743051effe0571156d", "message": "Made the Trie generation thread scheduled in Bukkit", "committedDate": "2020-02-22T21:09:09Z", "type": "commit"}, {"oid": "c641d514e2344c68a8e0ddc086f20dcc27ae31c9", "url": "https://github.com/TownyAdvanced/Towny/commit/c641d514e2344c68a8e0ddc086f20dcc27ae31c9", "message": "Only loop through keys, spacing", "committedDate": "2020-02-22T21:18:07Z", "type": "commit"}, {"oid": "16b5bf36612eadf18a5caedde264ade81cfb9676", "url": "https://github.com/TownyAdvanced/Towny/commit/16b5bf36612eadf18a5caedde264ade81cfb9676", "message": "add /r resident completion", "committedDate": "2020-02-22T21:48:09Z", "type": "commit"}, {"oid": "c8fd93866e559d2502592b4eb4533eb99c5807c4", "url": "https://github.com/TownyAdvanced/Towny/commit/c8fd93866e559d2502592b4eb4533eb99c5807c4", "message": "Fixed /r completions.", "committedDate": "2020-02-22T21:51:05Z", "type": "commit"}, {"oid": "a51a9e3e415932dce9f70ba8495bac30a0c0f95a", "url": "https://github.com/TownyAdvanced/Towny/commit/a51a9e3e415932dce9f70ba8495bac30a0c0f95a", "message": "Resident tab complete uses methods from BaseCommand, and doesn't always return all residents", "committedDate": "2020-02-22T21:57:23Z", "type": "commit"}, {"oid": "5669fe56dc6cf4af99ea1bc55426f2de4147f702", "url": "https://github.com/TownyAdvanced/Towny/commit/5669fe56dc6cf4af99ea1bc55426f2de4147f702", "message": "Merge remote-tracking branch 'origin/feature/trie-data-structure' into feature/trie-data-structure\n\n# Conflicts:\n#\tsrc/com/palmergames/bukkit/towny/command/ResidentCommand.java", "committedDate": "2020-02-22T21:57:39Z", "type": "commit"}]}