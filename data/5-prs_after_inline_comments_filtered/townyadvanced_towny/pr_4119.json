{"pr_number": 4119, "pr_title": "Residents.txt removal, Resident UUID Gathering.", "pr_createdAt": "2020-06-28T12:31:01Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/4119", "timeline": [{"oid": "df49b3725db6629bb133b0f552fcc97dec0c0adc", "url": "https://github.com/TownyAdvanced/Towny/commit/df49b3725db6629bb133b0f552fcc97dec0c0adc", "message": "Resident saving/loading clean up.\n\n- Removes residents.txt files.\n- Loads residents who do exist in the residents.txt file, deleting\norphaned files that weren't being read anyways.\n- Removes storing the town a resident belongs to in the residentname.txt\nfile.\n- Drops the town column from the resident table.\n- Adds methods to BukkitTools that should return UUIDs only when they\nare actually stored in the server cache, not pinging mojang.\n- TODO:\n  - Test offline player getting.\n  - Remove commented out code.", "committedDate": "2020-06-27T00:17:41Z", "type": "commit"}, {"oid": "71a2b54b2d31b3f8da08db356929078a37424c06", "url": "https://github.com/TownyAdvanced/Towny/commit/71a2b54b2d31b3f8da08db356929078a37424c06", "message": "Resident saving/loading clean up. Part 2.\n\n- Removed removeResidentList(resident) and consolidate it into\nremoveResident(resident).\n- Remove possible NotRegisteredException from\ntown.removeOutlaw(resident).\n- Remove old code which was commented out.\n\n- TODO:\n  - Test offline player getting.", "committedDate": "2020-06-27T15:14:39Z", "type": "commit"}, {"oid": "f802d8304726e9a800844e3bf96a4d42c4056007", "url": "https://github.com/TownyAdvanced/Towny/commit/f802d8304726e9a800844e3bf96a4d42c4056007", "message": "Resident saving/loading clean up. Part 3.\n\n- Remove possible NotRegisteredException from\nresident.removeFriend(resident).\n- Tested offline player getting.\n  - Works well but doesn't get UUIDs for players who have since changed\ntheir name. May be pinging Mojang servers.\n\n- TODO:\n  - Figure out if we're pinging mojang or the playerdata.\n  - Find solution for offline-player-getting for players who have since\nchanged their name.", "committedDate": "2020-06-27T16:25:37Z", "type": "commit"}, {"oid": "a050a6e2e454030a67df9bd313cfccbaec8381f0", "url": "https://github.com/TownyAdvanced/Towny/commit/a050a6e2e454030a67df9bd313cfccbaec8381f0", "message": "Resident saving/loading clean up. Part 4.\n\n- Adds BukkitTools.getUUIDFromResident(Resident resident) method to\nresolve the UUID of a resident, using their name and their lastLogin\ntimestamp.\n  - Temporarily being done to all residents without a UUID when\nresidents are loaded, for testing purposes only.\n  - In testing this has shown to solve the one resident who would not\nconvert from just using the BukkitTools.getUUIDSafely(String name)\nmethod.\n\n- TODO:\n  - Remove auto-conversion from loading cycle.\n  - Add task to accomplish async UUID collection via a queue.\n  - Add variable to determine if a server is at 100% UUIDs gathered.", "committedDate": "2020-06-27T22:45:26Z", "type": "commit"}, {"oid": "664be01a7ad4df148f7033375b7f508779dd3799", "url": "https://github.com/TownyAdvanced/Towny/commit/664be01a7ad4df148f7033375b7f508779dd3799", "message": "Resident saving/loading clean up. Part 5.\n\n- Fix compile error.\n- Create GatherResidentUUIDTask.\n  - Queue is populated with non-UUID residents on database load.\n  - Begins 1 minute after Towny has successfully enabled if UUID\ngathering is not 100%.\n  - Runs every 20 seconds gathering a UUID.\n  - Shuts itself down when 100% is reached.\n  - Works good.\n- Adds real-time tracking of gathered UUID count.\n\n- TODO:\n  - Give NPC residents a UUID.", "committedDate": "2020-06-28T02:48:02Z", "type": "commit"}, {"oid": "7034db00b5b9aa8190374c84f0ec88cd27315e7e", "url": "https://github.com/TownyAdvanced/Towny/commit/7034db00b5b9aa8190374c84f0ec88cd27315e7e", "message": "Resident saving/loading clean up. Part 6.\n\n- Fix reporting of UUID percentage.\n\n- TODO:\n  - Give NPC residents a UUID.", "committedDate": "2020-06-28T04:15:24Z", "type": "commit"}, {"oid": "e12a2d37e1be785a654245f5d159d3de4b8d9e48", "url": "https://github.com/TownyAdvanced/Towny/commit/e12a2d37e1be785a654245f5d159d3de4b8d9e48", "message": "Resident saving/loading clean up. Part 7.\n\n- NPC residents are given a UUID.\n- Exit GatherResidentUUIDTask if the resident has gotten a UUID since\nbeing added to the queue.\n- Handle /ta reload db|all properly when GatherResidentUUIDTask is\nrunning.\n\n- TODO:", "committedDate": "2020-06-28T12:14:38Z", "type": "commit"}, {"oid": "d017a234895cf977f5dae86b1ce9fd3908b09301", "url": "https://github.com/TownyAdvanced/Towny/commit/d017a234895cf977f5dae86b1ce9fd3908b09301", "message": "Resident saving/loading clean up. Part 8.\n\n- Copy UUID for residents renamed by TownyDatabaseHandler.\n\n- TODO:", "committedDate": "2020-06-28T12:30:30Z", "type": "commit"}, {"oid": "d5a5019fc76276808a73f9527356b738b45f508e", "url": "https://github.com/TownyAdvanced/Towny/commit/d5a5019fc76276808a73f9527356b738b45f508e", "message": "Formatting fix.", "committedDate": "2020-06-28T12:32:51Z", "type": "commit"}, {"oid": "54f4077b877ade30565261c5bb599fe9b8139f0d", "url": "https://github.com/TownyAdvanced/Towny/commit/54f4077b877ade30565261c5bb599fe9b8139f0d", "message": "Resident saving/loading clean up. Part 9.\n\n- Fix NPCs not getting assigned a UUID from the GatherTask.\n- Fix being unable to handle players who appear to have never had a\nMojang Account and return an HTTP Response Code 204.\n\n- TODO:\n  - Decide what to do with the above Un-resolvable residents.", "committedDate": "2020-06-28T16:25:34Z", "type": "commit"}, {"oid": "ff97096602bb3a21b31fd9916ebc5913bbdeca2b", "url": "https://github.com/TownyAdvanced/Towny/commit/ff97096602bb3a21b31fd9916ebc5913bbdeca2b", "message": "Resident saving/loading clean up. Part 10.\n\n- Fix exception.\n- Use TownyNameUpdater playermap as a fall back when Mojang cannot\ndeliver someones UUID any more, (solving Code 204 responses.)\n\n- TODO:", "committedDate": "2020-06-28T21:35:36Z", "type": "commit"}, {"oid": "52691a4b440c0b885adb1ec1c0744a3cd9f76837", "url": "https://github.com/TownyAdvanced/Towny/commit/52691a4b440c0b885adb1ec1c0744a3cd9f76837", "message": "Resident saving/loading clean up. Part 11.\n\n- Revert change to resident not storing town. Towns now no longer save\nresidents.\n- Towns no longer save the Resident list.\n- MySQL servers will drop the residents column from the Towns table.\n\n- TODO:\n  - Testing.\n  - Move code from Town object to Resident object when it deals with\nadding/removing Towns.", "committedDate": "2020-06-29T14:00:38Z", "type": "commit"}, {"oid": "c0458f75a2bbe5131d2e099dae85d112c7e93831", "url": "https://github.com/TownyAdvanced/Towny/commit/c0458f75a2bbe5131d2e099dae85d112c7e93831", "message": "Resident saving/loading clean up. Part 12.\n\n- Fix databases not loading.\n  - Achieved by moving loadResidents() in front of loadTowns().\n- Added config option:\n  - plugin.database.gather_resident_uuids\n  - default: true\n  - When true Towny will use a background task to gather UUIDs for\nresidents who do not have UUIDs.\n\n- TODO:\n  - More testing.\n  - Move code from Town object to Resident object when it deals with\nadding/removing Towns.", "committedDate": "2020-06-30T18:11:25Z", "type": "commit"}, {"oid": "b381a3b3acb65a245806bdbe3ac8747000d04770", "url": "https://github.com/TownyAdvanced/Towny/commit/b381a3b3acb65a245806bdbe3ac8747000d04770", "message": "Resident saving/loading clean up. Part 13.\n\n- Removed TNUPlayerMapImporter\n  - The only time it would be called is when a player's call to the\nMojangAPI for UUID returned 204, which means they no longer have an MC\naccount.\n  - Instead of finding a UUID for them they are going to have their\nresident deleted from the DB.\n- Cleaned up TownyDatabaseHandler.removeTown(Town).\n  - No longer saving the nation as that is already being done.\n- Removed Town.clear().\n  - Was not being used in any real capacity, what it was doing was\nalready being done somewhere else.\n- Remove Town.removeAllResidents().\n  - Not being used.\n\n- TODO:\n  - Not much.", "committedDate": "2020-07-12T19:54:07Z", "type": "commit"}, {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5", "url": "https://github.com/TownyAdvanced/Towny/commit/b29562d54d254ceae34207580ba5ee0753e1a2e5", "message": "Resident saving/loading clean up. Part 14.\n\n- Replace all calls of Town.removeResident(Resident) with\nResident.removeTown().\n  - As Residents are now storing the Town it makes sense to do all of\nthat logic on the resident.\n  - Town.removeResident(Resident) is now used to fire the\nEmptyTownException and determine the town's new mayor.\n  - Removes all of the EmptyTownExceptions throughout the codebase,\nleaving just the one which is caught in Resident.RemoveTown().\n- TownRemoveResident and TownAddResident Events are now fired from the\nResident object instead of the Town object.\n- Removed Resident.clear()\n  - Now unused.\n\n- TODO:\n  - Testing.\n  - Possibly further removal of Resident-oriented code in the Town\nobject.", "committedDate": "2020-07-12T23:55:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwNTg2Mw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454705863", "bodyText": "This should be just townsblocks not new ArrayList<>(townBlocks)", "author": null, "createdAt": "2020-07-14T23:39:09Z", "path": "src/com/palmergames/bukkit/towny/object/Resident.java", "diffHunk": "@@ -307,24 +310,69 @@ public Town getTown() throws NotRegisteredException {\n \n \tpublic void setTown(Town town) throws AlreadyRegisteredException {\n \n+\t\tif (this.town == town)\n+\t\t\treturn;\n+\n+\t\tTowny.getPlugin().deleteCache(this.getName());\n+\t\tsetTitle(\"\");\n+\t\tsetSurname(\"\");\n+\t\tupdatePerms();\n+\t\t\n+\n \t\tif (town == null) {\n \t\t\tthis.town = null;\n-\t\t\tsetTitle(\"\");\n-\t\t\tsetSurname(\"\");\n-\t\t\tupdatePerms();\n \t\t\treturn;\n \t\t}\n \n-\t\tif (this.town == town)\n-\t\t\treturn;\n-\n \t\tif (hasTown())\n \t\t\tthrow new AlreadyRegisteredException();\n \n \t\tthis.town = town;\n-\t\tsetTitle(\"\");\n-\t\tsetSurname(\"\");\n-\t\tupdatePerms();\n+\t\ttown.addResident(this);\n+\t\tBukkitTools.getPluginManager().callEvent(new TownAddResidentEvent(this, town));\n+\t}\n+\t\n+\tpublic void removeTown() {\n+\t\t\n+\t\tif (!hasTown())\n+\t\t\treturn;\n+\n+\t\tTown town = this.town;\n+\t\t\n+\t\tBukkitTools.getPluginManager().callEvent(new TownRemoveResidentEvent(this, town));\n+\t\ttry {\n+\t\t\t\n+\t\t\ttown.removeResident(this);\n+\t\t\t\n+\t\t} catch (NotRegisteredException e1) {\n+\t\t\te1.printStackTrace();\n+\t\t} catch (EmptyTownException e1) {\n+\t\t\tTownyUniverse.getInstance().getDataSource().removeTown(town);\n+\t\t}\n+\t\t\n+\t\tfor (TownBlock townBlock : new ArrayList<>(townBlocks)) {", "originalCommit": "b29562d54d254ceae34207580ba5ee0753e1a2e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwNjE5Mg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454706192", "bodyText": "I started with that and it throws concurrentmodification exceptions all over.", "author": "LlmDl", "createdAt": "2020-07-14T23:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwNTg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyNjk0NQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454726945", "bodyText": "Fixed via iterator", "author": null, "createdAt": "2020-07-15T00:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwNTg2Mw=="}], "type": "inlineReview"}, {"oid": "584e38608b97fe64bfbcf209ee3e2fccd037168b", "url": "https://github.com/TownyAdvanced/Towny/commit/584e38608b97fe64bfbcf209ee3e2fccd037168b", "message": "Use iterator to prevent concurrent modifications.", "committedDate": "2020-07-15T00:47:52Z", "type": "commit"}, {"oid": "b47f03fb6aefaa93cc6ea5396bbb71acc9ebab7d", "url": "https://github.com/TownyAdvanced/Towny/commit/b47f03fb6aefaa93cc6ea5396bbb71acc9ebab7d", "message": "Remove unused import.", "committedDate": "2020-07-15T00:51:55Z", "type": "commit"}, {"oid": "6731793f0c05a4e3cbaf81e858fae6c1705f66b0", "url": "https://github.com/TownyAdvanced/Towny/commit/6731793f0c05a4e3cbaf81e858fae6c1705f66b0", "message": "Merge branch 'master' into resident_txt_removal\n\n# Conflicts:\n#\tsrc/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "committedDate": "2020-07-15T00:56:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczMDY0Mg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454730642", "bodyText": "Were you having ConcurrentModicationExpection's here as well? If not this should be just universe.getResidentMap.values()", "author": null, "createdAt": "2020-07-15T01:07:29Z", "path": "src/com/palmergames/bukkit/towny/db/TownyDatabaseHandler.java", "diffHunk": "@@ -291,6 +290,27 @@ public TownyWorld getTownWorld(String townName) {\n \t@Override\n \tpublic void removeResident(Resident resident) {\n \n+\t\t// Remove resident from towns' outlawlists.\n+\t\tfor (Town townOutlaw : getTowns()) {\n+\t\t\tif (townOutlaw.hasOutlaw(resident)) {\n+\t\t\t\ttownOutlaw.removeOutlaw(resident);\n+\t\t\t\tsaveTown(townOutlaw);\n+\t\t\t}\n+\t\t}\n+\n+\t\t// Remove resident from residents' friendslists.\n+\t\tList<Resident> toSave = new ArrayList<>();\n+\t\tfor (Resident toCheck : new ArrayList<>(universe.getResidentMap().values())) {", "originalCommit": "b29562d54d254ceae34207580ba5ee0753e1a2e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczMzcwMw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454733703", "bodyText": "Although this isn't part of the diff, I still have the same comment as the others, why a new arraylist if that arraylist already exists?", "author": null, "createdAt": "2020-07-15T01:18:04Z", "path": "src/com/palmergames/bukkit/towny/db/TownyDatabaseHandler.java", "diffHunk": "@@ -1053,12 +1010,8 @@ public void renamePlayer(Resident resident, String newName) throws AlreadyRegist\n \t\t\tList<Resident> toSaveResident = new ArrayList<>(getResidents());", "originalCommit": "b29562d54d254ceae34207580ba5ee0753e1a2e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNDE5Mg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454734192", "bodyText": "same thing as above", "author": null, "createdAt": "2020-07-15T01:19:57Z", "path": "src/com/palmergames/bukkit/towny/db/TownyDatabaseHandler.java", "diffHunk": "@@ -1067,12 +1020,8 @@ public void renamePlayer(Resident resident, String newName) throws AlreadyRegist\n \t\t\tList<Town> toSaveTown = new ArrayList<>(getTowns());", "originalCommit": "b29562d54d254ceae34207580ba5ee0753e1a2e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNDkzMA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454734930", "bodyText": "Add a FileNameFilter for the file listings, we should only be picking up \".txt\" files, not just every file in the directory. See https://stackoverflow.com/questions/37900798/filenamefilter-to-show-list-files-with-certain-extension-and-directories for an example.", "author": null, "createdAt": "2020-07-15T01:22:48Z", "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -349,28 +346,46 @@ public boolean loadResidentList() {\n \t\t\n \t\tTownyMessaging.sendDebugMsg(\"Loading Resident List\");\n \t\tString line = null;\n+\t\tList residents = new ArrayList<String>();\n \n+\t\t// Build up a list of residents from any existing legacy residents.txt files.\n \t\ttry (BufferedReader fin = new BufferedReader(new InputStreamReader(new FileInputStream(dataFolderPath + File.separator + \"residents.txt\"), StandardCharsets.UTF_8))) {\n \t\t\t\n-\t\t\twhile ((line = fin.readLine()) != null) {\n-\t\t\t\tif (!line.equals(\"\")) {\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tnewResident(line);\n-\t\t\t\t\t} catch (AlreadyRegisteredException e) {\n-\t\t\t\t\t\tTownyMessaging.sendDebugMsg(\"Duplicate resident '\" + line + \"' found in residents.txt, ignoring.\");\n-\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t}\n-\t\t\t\t}\n+\t\t\twhile ((line = fin.readLine()) != null && !line.equals(\"\"))\n+\t\t\t\tresidents.add(line);\n+\t\t} catch (Exception ignored) {\n+\t\t\t// No residents.txt any more.\n+\t\t}\n+\t\tFile residentFolder = new File(dataFolderPath + File.separator + \"residents\");\n+\t\tFile[] residentFiles = residentFolder.listFiles();", "originalCommit": "b29562d54d254ceae34207580ba5ee0753e1a2e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNTk2OA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454735968", "bodyText": "This can be removed by applying the above fix", "author": null, "createdAt": "2020-07-15T01:26:48Z", "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -349,28 +346,46 @@ public boolean loadResidentList() {\n \t\t\n \t\tTownyMessaging.sendDebugMsg(\"Loading Resident List\");\n \t\tString line = null;\n+\t\tList residents = new ArrayList<String>();\n \n+\t\t// Build up a list of residents from any existing legacy residents.txt files.\n \t\ttry (BufferedReader fin = new BufferedReader(new InputStreamReader(new FileInputStream(dataFolderPath + File.separator + \"residents.txt\"), StandardCharsets.UTF_8))) {\n \t\t\t\n-\t\t\twhile ((line = fin.readLine()) != null) {\n-\t\t\t\tif (!line.equals(\"\")) {\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tnewResident(line);\n-\t\t\t\t\t} catch (AlreadyRegisteredException e) {\n-\t\t\t\t\t\tTownyMessaging.sendDebugMsg(\"Duplicate resident '\" + line + \"' found in residents.txt, ignoring.\");\n-\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t}\n-\t\t\t\t}\n+\t\t\twhile ((line = fin.readLine()) != null && !line.equals(\"\"))\n+\t\t\t\tresidents.add(line);\n+\t\t} catch (Exception ignored) {\n+\t\t\t// No residents.txt any more.\n+\t\t}\n+\t\tFile residentFolder = new File(dataFolderPath + File.separator + \"residents\");\n+\t\tFile[] residentFiles = residentFolder.listFiles();\n+\t\tfor (File resident : residentFiles) {\n+\t\t\t// Don't load resident files if they weren't in the residents.txt file.\n+\t\t\tString name = resident.getName().replace(\".txt\", \"\");\n+\t\t\tif (residents.size() > 0 && !residents.contains(name)) {\n+\t\t\t\tTownyMessaging.sendDebugMsg(\"Removing \" + resident.getName() + \" because they are not found in the residents.txt.\");\n+\t\t\t\tdeleteFile(resident.getAbsolutePath());\n+\t\t\t\tcontinue;\n \t\t\t}\n-\n-\t\t\treturn true;\n-\t\t\t\n-\t\t} catch (Exception e) {\n-\t\t\tTownyMessaging.sendErrorMsg(\"Error Loading Resident List at \" + line + \", in towny\\\\data\\\\residents.txt\");\n-\t\t\te.printStackTrace();\n-\t\t\treturn false;\n \t\t\t\n+\t\t\tif (!resident.getName().endsWith(\".txt\"))", "originalCommit": "b29562d54d254ceae34207580ba5ee0753e1a2e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fdd4ac49e5950013ac928c997b164e5545ab2644", "url": "https://github.com/TownyAdvanced/Towny/commit/fdd4ac49e5950013ac928c997b164e5545ab2644", "message": "Fix removeAllFriends()", "committedDate": "2020-07-15T01:46:50Z", "type": "commit"}, {"oid": "a440ac928f3a0ac01522a1210e2370039a7ef8d7", "url": "https://github.com/TownyAdvanced/Towny/commit/a440ac928f3a0ac01522a1210e2370039a7ef8d7", "message": "Fix useless array copies.", "committedDate": "2020-07-15T01:53:05Z", "type": "commit"}, {"oid": "f19e2ed375d7a70a6ca77031655131bf4a19a91f", "url": "https://github.com/TownyAdvanced/Towny/commit/f19e2ed375d7a70a6ca77031655131bf4a19a91f", "message": "Revert \"Fix useless array copies.\"\n\nThis reverts commit a440ac928f3a0ac01522a1210e2370039a7ef8d7.", "committedDate": "2020-07-15T13:30:05Z", "type": "commit"}, {"oid": "5f893d3430bdd792fbc0cb5231e54db4c2addec1", "url": "https://github.com/TownyAdvanced/Towny/commit/5f893d3430bdd792fbc0cb5231e54db4c2addec1", "message": "Resident saving/loading clean up. Part 15.\n\n- Remove unneeded ArrayList.\n- Use FileFilter.\n\n- TODO:\n  - Nothing.", "committedDate": "2020-07-15T17:42:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzNjYzOQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r455236639", "bodyText": "This can be condensed into a lambda:\nFile[] residentFiles = residentFolder.listFiles((file) -> file.getName.toLowerCase().endsWith(\".txt\");", "author": null, "createdAt": "2020-07-15T17:56:20Z", "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -349,28 +347,48 @@ public boolean loadResidentList() {\n \t\t\n \t\tTownyMessaging.sendDebugMsg(\"Loading Resident List\");\n \t\tString line = null;\n+\t\tList residents = new ArrayList<String>();\n \n+\t\t// Build up a list of residents from any existing legacy residents.txt files.\n \t\ttry (BufferedReader fin = new BufferedReader(new InputStreamReader(new FileInputStream(dataFolderPath + File.separator + \"residents.txt\"), StandardCharsets.UTF_8))) {\n \t\t\t\n-\t\t\twhile ((line = fin.readLine()) != null) {\n-\t\t\t\tif (!line.equals(\"\")) {\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tnewResident(line);\n-\t\t\t\t\t} catch (AlreadyRegisteredException e) {\n-\t\t\t\t\t\tTownyMessaging.sendDebugMsg(\"Duplicate resident '\" + line + \"' found in residents.txt, ignoring.\");\n-\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t}\n-\t\t\t\t}\n+\t\t\twhile ((line = fin.readLine()) != null && !line.equals(\"\"))\n+\t\t\t\tresidents.add(line);\n+\t\t} catch (Exception ignored) {\n+\t\t\t// No residents.txt any more.\n+\t\t}\n+\t\tFile residentFolder = new File(dataFolderPath + File.separator + \"residents\");\n+\t\tFile[] residentFiles = residentFolder.listFiles(new FileFilter() {\n+\t\t\t@Override\n+\t\t\tpublic boolean accept(File residentFolder) {\n+\t\t\t\treturn residentFolder.getName().toLowerCase().endsWith(\".txt\"); \n+\t\t\t}\n+\t\t});", "originalCommit": "5f893d3430bdd792fbc0cb5231e54db4c2addec1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "be75324f0470ff1e3d1b02f3fc2bf24e49f20f46", "url": "https://github.com/TownyAdvanced/Towny/commit/be75324f0470ff1e3d1b02f3fc2bf24e49f20f46", "message": "Resident saving/loading clean up. Part 16.\n\n- Switch to a lambda in loadResidentList().\n\n- TODO:\n  - Nothing.", "committedDate": "2020-07-15T18:27:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NjUzNQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r455256535", "bodyText": "Setting this to null is redundant, String line; has the exact same effect.", "author": null, "createdAt": "2020-07-15T18:28:11Z", "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -349,28 +347,48 @@ public boolean loadResidentList() {\n \t\t\n \t\tTownyMessaging.sendDebugMsg(\"Loading Resident List\");\n \t\tString line = null;", "originalCommit": "5f893d3430bdd792fbc0cb5231e54db4c2addec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NzAyOA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r455257028", "bodyText": "Eclipse complains when it isn't initialized.", "author": "LlmDl", "createdAt": "2020-07-15T18:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NjUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NjU0NA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r455256544", "bodyText": "You're using the raw type of List, you should be using the parameterized type:\nList<String> residents = new ArrayList<>();", "author": null, "createdAt": "2020-07-15T18:28:12Z", "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -349,28 +347,48 @@ public boolean loadResidentList() {\n \t\t\n \t\tTownyMessaging.sendDebugMsg(\"Loading Resident List\");\n \t\tString line = null;\n+\t\tList residents = new ArrayList<String>();", "originalCommit": "5f893d3430bdd792fbc0cb5231e54db4c2addec1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b454d9bf501b659a0878ee8a3938c0b853432a1a", "url": "https://github.com/TownyAdvanced/Towny/commit/b454d9bf501b659a0878ee8a3938c0b853432a1a", "message": "Not use raw type List.", "committedDate": "2020-07-15T18:40:40Z", "type": "commit"}]}