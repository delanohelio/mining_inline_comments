{"pr_number": 3838, "pr_title": "Branch will remove TownBlockLists saving/loading, remove TownBlocks from TownyWorld, add TownBlocks to Town and TownyUniverse.", "pr_createdAt": "2020-03-28T14:48:49Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/3838", "timeline": [{"oid": "a8152c039aa0768d69ae496089e0865f7d93591f", "url": "https://github.com/TownyAdvanced/Towny/commit/a8152c039aa0768d69ae496089e0865f7d93591f", "message": "Replace most TownyWorld#getTownBlock(Coord coord) calls with\nTownyAPI.getInstance().getTownBlock(location).", "committedDate": "2020-03-22T14:24:59Z", "type": "commit"}, {"oid": "9e20007f1f3480124055393d688cf8931c1188dc", "url": "https://github.com/TownyAdvanced/Towny/commit/9e20007f1f3480124055393d688cf8931c1188dc", "message": "Townblocks.txt no longer used.\n\nTowny parses the entire towny\\data\\townblocks\\ folder to create a\nConcurrentHashMap in TownyUniverse (probably just temporary for now.)\n\nTowny then loads individual TownBlocks from that list, and stores them\nin the towns.\n\nSaving the townblocklist is now done on a per-town basis, only doing the\nfull batch on saveAll().", "committedDate": "2020-03-22T19:55:53Z", "type": "commit"}, {"oid": "963c6da52fb389c549964aa8f9d4362e91c507fa", "url": "https://github.com/TownyAdvanced/Towny/commit/963c6da52fb389c549964aa8f9d4362e91c507fa", "message": "TownBlocks_Update Commit #3\n\nContinuing on with removing TownBlockLists, ending TownBlocks being\ntracked per-TownyWorld, adding TownBlocks being tracked per-Town.\n\n- Add TownyAPI.isWilderness(WorldCoord worldCoord) method.\n- Flesh out methods in TownyUniverse for maintaining the global\ntownblocks hashmap.\n- Remove all traces of saveTownBlockList() and saveTownBlockList(Town\ntown).\n- Remove extra townblock removal methods from TownyDatabaseHandler\n(removeOneOfManyTownBlocks(), removeManyTownBlocks())\n- Remove deprecated methods used to update ancient Towny databases that\nstill stored TownBlocks in the town and resident files.\n  - (utilLoadTownBlocks(), utilLoadTownBlockTypeData(),\nutilSaveTownBlocks()\n- Replaced the Town's List<TownBlock> with ConcurrentHashMap<WorldCoord,\nTownBlock>.\n- Removed TownyWorld's ConcurrentHashMap<Coord, TownBlock> townBlocks,\nwith all methods forwarding to TownyUniverse or otherwise handling\nthings.", "committedDate": "2020-03-25T22:14:24Z", "type": "commit"}, {"oid": "b9ba51e153f76c931815264833d21488e64596ec", "url": "https://github.com/TownyAdvanced/Towny/commit/b9ba51e153f76c931815264833d21488e64596ec", "message": "Small cleanup.", "committedDate": "2020-03-25T23:02:28Z", "type": "commit"}, {"oid": "329c9511ab7fbb77b6daedf1f730939037c6d411", "url": "https://github.com/TownyAdvanced/Towny/commit/329c9511ab7fbb77b6daedf1f730939037c6d411", "message": "Merge remote-tracking branch 'origin/master' into\ndatabase/townblocks_update\n\nConflicts:\n\tsrc/com/palmergames/bukkit/towny/command/TownCommand.java\n\tsrc/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java\n\tsrc/com/palmergames/bukkit/towny/object/TownyWorld.java", "committedDate": "2020-03-25T23:54:31Z", "type": "commit"}, {"oid": "e382495910e7a79276c20c09289f92f0a6b7bea2", "url": "https://github.com/TownyAdvanced/Towny/commit/e382495910e7a79276c20c09289f92f0a6b7bea2", "message": "Merge remote-tracking branch 'origin/master' into database/townblocks_update", "committedDate": "2020-03-27T01:53:43Z", "type": "commit"}, {"oid": "06dbd8ae6f6ee7d6a53fb381700f56e7bc099ee7", "url": "https://github.com/TownyAdvanced/Towny/commit/06dbd8ae6f6ee7d6a53fb381700f56e7bc099ee7", "message": "- Fix setting homeblock for Towns on load.", "committedDate": "2020-03-27T02:58:28Z", "type": "commit"}, {"oid": "50e130f38622cd89b94cfc53ad06471de897a1b8", "url": "https://github.com/TownyAdvanced/Towny/commit/50e130f38622cd89b94cfc53ad06471de897a1b8", "message": "- Moved a bit of code around in ChunkNotification.\n- Removed Town and TownyUniverse newTownBlock() methods.\n- Added addTownBlock() to TownyUniverse for populating the TownyUniverse\ntownBlocks ConcurrentHashMap.\n- Added townBlocks CHM to TownyUniverse.clearAll() to fix /ta reload.\n- Alter TownCommand.newTown() to reflect change to making new\nTownBlocks, sorted out needless setting of the homeblock.\n- Call TownyUniverse.removeTownBlock() directly from\nDataSource.removeTownBlock(), to begin removal of TownBlocks from towns\nand then the database.\n- Alter Flatfile & SQLSource loadTownBlockList(), we now create a new\nTownBlock object with a null town and then add it to the TownyUniverse\ntownBlock CHM.\n  - Town is taken care of later on in the loading process when each\nTownBlock is loaded.\n- Bit of reodering in the Town object for manipulating the Town\ntownBlock CHM.\n- TownClaimTask has had it's townClaim slightly simplified.", "committedDate": "2020-03-27T23:23:21Z", "type": "commit"}, {"oid": "9c9e63cc71b87b5ccd184ddd8084792fe4ccdc35", "url": "https://github.com/TownyAdvanced/Towny/commit/9c9e63cc71b87b5ccd184ddd8084792fe4ccdc35", "message": "- Further testing accomplished successfully.\n- Minor changes to things, mainly moving more TownBlock lookup calls\nfrom pointing to TownyWorld, via the API/TownyUniverse.", "committedDate": "2020-03-28T14:33:33Z", "type": "commit"}, {"oid": "36726fd32c3f8a1dfae6e6a185bf8ad49feaf9c0", "url": "https://github.com/TownyAdvanced/Towny/commit/36726fd32c3f8a1dfae6e6a185bf8ad49feaf9c0", "message": "- Load only townblock files from the townblocks dir.\n- On deletion of a townblock file, try to move it to\ntowny\\data\\townblocks\\worldname\\deleted\\townname\\\n  - Should make it easier to recover town's townblocks if something does\ngo wrong.", "committedDate": "2020-03-28T17:36:44Z", "type": "commit"}, {"oid": "463420c7b41cf21babd9e43aab0e264f2a08e5da", "url": "https://github.com/TownyAdvanced/Towny/commit/463420c7b41cf21babd9e43aab0e264f2a08e5da", "message": "Fix loading of homeblocks in non-primary worlds.", "committedDate": "2020-03-28T20:51:07Z", "type": "commit"}, {"oid": "7607bebbfae018841feb74f14b9e7e41d014984d", "url": "https://github.com/TownyAdvanced/Towny/commit/7607bebbfae018841feb74f14b9e7e41d014984d", "message": "Fix error when invalid world is loaded by townblock.", "committedDate": "2020-03-28T20:53:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MDY5NA==", "url": "https://github.com/TownyAdvanced/Towny/pull/3838#discussion_r401140694", "bodyText": "Isn't the new WorldCoord() redundant as WorldCoord.parseWorldCoord(location) will already return a new world coord object.", "author": "silverwolfg11", "createdAt": "2020-03-31T18:54:07Z", "path": "src/com/palmergames/bukkit/towny/TownyAPI.java", "diffHunk": "@@ -216,22 +199,24 @@ public boolean isWilderness(Block block) {\n      * @return true if the {@link Location} is in the wilderness, false otherwise.\n      */\n     public boolean isWilderness(Location location) {\n-        WorldCoord worldCoord;\n-        \n-        try {\n-            worldCoord = new WorldCoord(townyUniverse.getDataSource().getWorld(location.getWorld().getName()).getName(), Coord.parseCoord(location));\n-        } catch (NotRegisteredException e) {\n-            // No record so must be Wilderness\n-            return true;\n-        }\n+        return isWilderness(new WorldCoord(WorldCoord.parseWorldCoord(location)));", "originalCommit": "7607bebbfae018841feb74f14b9e7e41d014984d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MTY0NA==", "url": "https://github.com/TownyAdvanced/Towny/pull/3838#discussion_r401141644", "bodyText": "Good catch.", "author": "LlmDl", "createdAt": "2020-03-31T18:55:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MDY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MTU5MA==", "url": "https://github.com/TownyAdvanced/Towny/pull/3838#discussion_r401141590", "bodyText": "Same as above.", "author": "silverwolfg11", "createdAt": "2020-03-31T18:55:34Z", "path": "src/com/palmergames/bukkit/towny/TownyAPI.java", "diffHunk": "@@ -272,7 +256,7 @@ public String getTownName(Location location) {\n      */\n     public UUID getTownUUID(Location location) {\n         try {\n-            WorldCoord worldCoord = new WorldCoord(townyUniverse.getDataSource().getWorld(location.getWorld().getName()).getName(), Coord.parseCoord(location));\n+            WorldCoord worldCoord = new WorldCoord(WorldCoord.parseWorldCoord(location));", "originalCommit": "7607bebbfae018841feb74f14b9e7e41d014984d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac3e4e0b3f8f65adceb7129f129bb7ccd65a04ef", "url": "https://github.com/TownyAdvanced/Towny/commit/ac3e4e0b3f8f65adceb7129f129bb7ccd65a04ef", "message": "- Fix a couple redundant new WorldCoord's.", "committedDate": "2020-03-31T20:28:34Z", "type": "commit"}, {"oid": "fab063b6f4a77aa79b450327d2c82df65f3ae8a5", "url": "https://github.com/TownyAdvanced/Towny/commit/fab063b6f4a77aa79b450327d2c82df65f3ae8a5", "message": "Fix SQL saveAllTownBlocks() returning false preventing conversion from\nflatfile to mysql.", "committedDate": "2020-04-02T12:14:46Z", "type": "commit"}, {"oid": "9dadd7758ab11cd2df1e093f1d8c671b29c70a95", "url": "https://github.com/TownyAdvanced/Towny/commit/9dadd7758ab11cd2df1e093f1d8c671b29c70a95", "message": "Revert \"Fix SQL saveAllTownBlocks() returning false preventing conversion from flatfile to mysql.\"\n\nThis reverts commit fab063b6f4a77aa79b450327d2c82df65f3ae8a5.", "committedDate": "2020-04-02T12:18:38Z", "type": "commit"}]}