{"pr_number": 4499, "pr_title": "Implemented MySQL Connection Pooling", "pr_createdAt": "2020-11-28T21:08:44Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/4499", "timeline": [{"oid": "c97f0706105a71b67c99bed9425a6ba78e11cf94", "url": "https://github.com/TownyAdvanced/Towny/commit/c97f0706105a71b67c99bed9425a6ba78e11cf94", "message": "Implemented MySQL Connection Pooling", "committedDate": "2020-11-28T21:01:07Z", "type": "commit"}, {"oid": "3e05e0a36b3db2c507ad8b5e6db340da937c7ee5", "url": "https://github.com/TownyAdvanced/Towny/commit/3e05e0a36b3db2c507ad8b5e6db340da937c7ee5", "message": "Change - to _", "committedDate": "2020-11-28T21:05:40Z", "type": "commit"}, {"oid": "b8ce88409ce7c78768ddd63d80ae0d60ac1164ff", "url": "https://github.com/TownyAdvanced/Towny/commit/b8ce88409ce7c78768ddd63d80ae0d60ac1164ff", "message": "Inlined some properties that are only used once.", "committedDate": "2020-11-28T21:29:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI2ODE5Mw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#discussion_r532268193", "bodyText": "setMinimumIdle represents the number of minimum connections that Hikari will maintain, and not a timeout for each connections. So I think the config setting should be renamed to MinIdleConnections. Although, hikari recommends not to set this setting.\nFrom HikariCP README:\n\nThis property controls the minimum number of idle connections that HikariCP tries to maintain in the pool. If the idle connections dip below this value and total connections in the pool are less than maximumPoolSize, HikariCP will make a best effort to add additional connections quickly and efficiently.", "author": "silverwolfg11", "createdAt": "2020-11-29T21:22:25Z", "path": "src/com/palmergames/bukkit/towny/db/TownySQLSource.java", "diffHunk": "@@ -77,41 +80,46 @@ public TownySQLSource(Towny plugin, TownyUniverse universe, String type) {\n \t\t/*\n \t\t * Setup SQL connection\n \t\t */\n-\t\tString hostname = TownySettings.getSQLHostName();\n-\t\tString port = TownySettings.getSQLPort();\n-\t\tString flags = TownySettings.getSQLFlags();\n \t\tdb_name = TownySettings.getSQLDBName();\n \t\ttb_prefix = TownySettings.getSQLTablePrefix().toUpperCase();\n \t\t\n-\t\tString driver1;\n-\t\tif (this.type.equals(\"h2\")) {\n-\n-\t\t\tdriver1 = \"org.h2.Driver\";\n-\t\t\tthis.dsn = (\"jdbc:h2:\" + dataFolderPath + File.separator + db_name + \".h2db;AUTO_RECONNECT=TRUE\");\n-\t\t\tusername = \"sa\";\n-\t\t\tpassword = \"sa\";\n-\n-\t\t} else if (this.type.equals(\"mysql\")) {\n-\n-\t\t\tdriver1 = \"com.mysql.jdbc.Driver\";\n-\t\t\tthis.dsn = (\"jdbc:mysql://\" + hostname + \":\" + port + \"/\" + db_name + flags);\n-\t\t\tusername = TownySettings.getSQLUsername();\n-\t\t\tpassword = TownySettings.getSQLPassword();\n-\n-\t\t} else {\n-\n-\t\t\tdriver1 = \"org.sqlite.JDBC\";\n-\t\t\tthis.dsn = (\"jdbc:sqlite:\" + dataFolderPath + File.separator + db_name + \".sqldb\");\n-\t\t\tusername = \"\";\n-\t\t\tpassword = \"\";\n-\n-\t\t}\n+\t\tthis.dsn = (\"jdbc:mysql://\" + TownySettings.getSQLHostName() + \":\" + TownySettings.getSQLPort() + \"/\" + db_name + TownySettings.getSQLFlags());\n+\t\tthis.config = new HikariConfig();\n+\t\t\n+\t\tconfig.setPoolName(\"Towny MySQL\");\n+\t\tconfig.setJdbcUrl(this.dsn);\n+\n+\t\tusername = TownySettings.getSQLUsername();\n+\t\tpassword = TownySettings.getSQLPassword();\n+\n+\t\tconfig.setUsername(username);\n+\t\tconfig.setPassword(password);\n+\n+\t\tconfig.addDataSourceProperty(\"cachePrepStmts\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"prepStmtCacheSize\", \"250\");\n+\t\tconfig.addDataSourceProperty(\"prepStmtCacheSqlLimit\", \"2048\");\n+\t\tconfig.addDataSourceProperty(\"useServerPrepStmts\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"useLocalSessionState\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"rewriteBatchedStatements\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"cacheResultSetMetadata\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"cacheServerConfiguration\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"elideSetAutoCommits\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"maintainTimeStats\", \"false\");\n+\t\tconfig.addDataSourceProperty(\"alwaysSendSetIsolation\", \"false\");\n+\t\tconfig.addDataSourceProperty(\"cacheCallableStmts\", \"true\");\n+\n+\t\tconfig.setMaximumPoolSize(TownySettings.getMaxPoolSize());\n+\t\tconfig.setMinimumIdle(TownySettings.getMinIdleTime());", "originalCommit": "b8ce88409ce7c78768ddd63d80ae0d60ac1164ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkwMzUzNQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#discussion_r532903535", "bodyText": "Solved this by just removing it since it probably is not needed.", "author": "darbyjack", "createdAt": "2020-11-30T21:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI2ODE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI3MzE1NA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#discussion_r532273154", "bodyText": "It would appear this line doesn't do anything:\nNote that useLocalSessionState=true will force the same behavior as alwaysSendSetIsolation=false, regardless of how alwaysSendSetIsolation is set.", "author": "LlmDl", "createdAt": "2020-11-29T21:46:01Z", "path": "src/com/palmergames/bukkit/towny/db/TownySQLSource.java", "diffHunk": "@@ -77,41 +80,46 @@ public TownySQLSource(Towny plugin, TownyUniverse universe, String type) {\n \t\t/*\n \t\t * Setup SQL connection\n \t\t */\n-\t\tString hostname = TownySettings.getSQLHostName();\n-\t\tString port = TownySettings.getSQLPort();\n-\t\tString flags = TownySettings.getSQLFlags();\n \t\tdb_name = TownySettings.getSQLDBName();\n \t\ttb_prefix = TownySettings.getSQLTablePrefix().toUpperCase();\n \t\t\n-\t\tString driver1;\n-\t\tif (this.type.equals(\"h2\")) {\n-\n-\t\t\tdriver1 = \"org.h2.Driver\";\n-\t\t\tthis.dsn = (\"jdbc:h2:\" + dataFolderPath + File.separator + db_name + \".h2db;AUTO_RECONNECT=TRUE\");\n-\t\t\tusername = \"sa\";\n-\t\t\tpassword = \"sa\";\n-\n-\t\t} else if (this.type.equals(\"mysql\")) {\n-\n-\t\t\tdriver1 = \"com.mysql.jdbc.Driver\";\n-\t\t\tthis.dsn = (\"jdbc:mysql://\" + hostname + \":\" + port + \"/\" + db_name + flags);\n-\t\t\tusername = TownySettings.getSQLUsername();\n-\t\t\tpassword = TownySettings.getSQLPassword();\n-\n-\t\t} else {\n-\n-\t\t\tdriver1 = \"org.sqlite.JDBC\";\n-\t\t\tthis.dsn = (\"jdbc:sqlite:\" + dataFolderPath + File.separator + db_name + \".sqldb\");\n-\t\t\tusername = \"\";\n-\t\t\tpassword = \"\";\n-\n-\t\t}\n+\t\tthis.dsn = (\"jdbc:mysql://\" + TownySettings.getSQLHostName() + \":\" + TownySettings.getSQLPort() + \"/\" + db_name + TownySettings.getSQLFlags());\n+\t\tthis.config = new HikariConfig();\n+\t\t\n+\t\tconfig.setPoolName(\"Towny MySQL\");\n+\t\tconfig.setJdbcUrl(this.dsn);\n+\n+\t\tusername = TownySettings.getSQLUsername();\n+\t\tpassword = TownySettings.getSQLPassword();\n+\n+\t\tconfig.setUsername(username);\n+\t\tconfig.setPassword(password);\n+\n+\t\tconfig.addDataSourceProperty(\"cachePrepStmts\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"prepStmtCacheSize\", \"250\");\n+\t\tconfig.addDataSourceProperty(\"prepStmtCacheSqlLimit\", \"2048\");\n+\t\tconfig.addDataSourceProperty(\"useServerPrepStmts\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"useLocalSessionState\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"rewriteBatchedStatements\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"cacheResultSetMetadata\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"cacheServerConfiguration\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"elideSetAutoCommits\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"maintainTimeStats\", \"false\");\n+\t\tconfig.addDataSourceProperty(\"alwaysSendSetIsolation\", \"false\");", "originalCommit": "b8ce88409ce7c78768ddd63d80ae0d60ac1164ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkwMzY1MA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#discussion_r532903650", "bodyText": "Solved this by removing it since not needed.", "author": "darbyjack", "createdAt": "2020-11-30T21:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI3MzE1NA=="}], "type": "inlineReview"}, {"oid": "bf40caf9454fc4c318df8c39d9fc5d06cacdb98e", "url": "https://github.com/TownyAdvanced/Towny/commit/bf40caf9454fc4c318df8c39d9fc5d06cacdb98e", "message": "Updated in response to PR comments", "committedDate": "2020-11-30T15:35:54Z", "type": "commit"}, {"oid": "fdb6fa4723505b9f675c1acdd2da1ee4d5f26490", "url": "https://github.com/TownyAdvanced/Towny/commit/fdb6fa4723505b9f675c1acdd2da1ee4d5f26490", "message": "Merge branch 'master' into connection-pooling", "committedDate": "2020-11-30T19:37:21Z", "type": "commit"}, {"oid": "e6350cef0f131f10892dd934dc9874ceb2a50d22", "url": "https://github.com/TownyAdvanced/Towny/commit/e6350cef0f131f10892dd934dc9874ceb2a50d22", "message": "Close old connections on reload.", "committedDate": "2020-12-03T01:00:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYwMzE2Ng==", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#discussion_r534603166", "bodyText": "The trailing ` will have to go.", "author": "LlmDl", "createdAt": "2020-12-03T01:42:17Z", "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "diffHunk": "@@ -1648,7 +1648,7 @@ public void reloadConfig(boolean reset) {\n \t *\r\n \t */\r\n \tpublic void reloadDatabase() {\r\n-\t\t\r\n+\t\tTownyUniverse.getInstance().getDataSource().finishTasks();`\r", "originalCommit": "e6350cef0f131f10892dd934dc9874ceb2a50d22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6d23b2fc4c36c8b28468f3f9a46c0d08789cecfb", "url": "https://github.com/TownyAdvanced/Towny/commit/6d23b2fc4c36c8b28468f3f9a46c0d08789cecfb", "message": "Fixed not compiling", "committedDate": "2020-12-03T20:51:44Z", "type": "commit"}, {"oid": "40d9eee77e0f8ea0a05e53f749fa44b754ddd8a1", "url": "https://github.com/TownyAdvanced/Towny/commit/40d9eee77e0f8ea0a05e53f749fa44b754ddd8a1", "message": "Implemented shade filter.", "committedDate": "2020-12-03T23:06:16Z", "type": "commit"}]}