{"pr_number": 4420, "pr_title": "TownyExplodeEvent - Expanding the API.", "pr_createdAt": "2020-11-06T23:50:32Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/4420", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzU5NTA5NQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4420#discussion_r523595095", "bodyText": "I feel like canExplode should be renamed because it's actual value dictates whether the event is cancelled, so it's really more can't explode than can. Either that or the value should be inverted so canExplode returns false if the event should be cancelled.", "author": "silverwolfg11", "createdAt": "2020-11-15T01:45:22Z", "path": "src/com/palmergames/bukkit/towny/event/actions/TownyExplosionDamagesEntityEvent.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.palmergames.bukkit.towny.event.actions;\r\n+\r\n+import org.bukkit.Location;\r\n+import org.bukkit.entity.Entity;\r\n+import org.bukkit.event.Cancellable;\r\n+import org.bukkit.event.Event;\r\n+import org.bukkit.event.HandlerList;\r\n+import org.bukkit.event.entity.EntityDamageEvent.DamageCause;\r\n+\r\n+/**\r\n+ * Part of the API which lets Towny's war and other plugins modify Towny's\r\n+ * plot-permission-decision outcomes.\r\n+ * \r\n+ * TownyExplosionDamagesEntityEvents are thrown when an explosion \r\n+ * occurs in a Towny world, causing damage to an entity.\r\n+ * \r\n+ * <br> - When an entity explosion, block explosion or lightning damages an entity.\r\n+ * <br> - When an explosion would damage a Hanging entity.\r\n+ * <br> - When a pig is zapped by lightning.\r\n+ * <br> - When an explosion would damage a Vehicle.\r\n+ * \r\n+ * @param location - Location of the entity being damaged.\r\n+ * @param entity - Entity getting exploded.\r\n+ * @param cause - DamageCause.\r\n+ * @param canExplode - Whether Towny will cancel this already.\r\n+ * \r\n+ * @author LlmDl\r\n+ */\r\n+public class TownyExplosionDamagesEntityEvent extends Event implements Cancellable {\r\n+\r\n+\tprivate static final HandlerList handlers = new HandlerList();\r\n+\tprivate final Location location;\r\n+\tprivate final Entity entity;\r\n+\tprivate final DamageCause cause;\r\n+\tprivate boolean canExplode;\r\n+\r\n+\t/**\r\n+\t * Event thrown when an explosion damages an entity. \r\n+\t * Use ignorecancelled = true in order to filter out explosions Towny will already have stopped.\r\n+\t * \r\n+\t * @param location - Location of the entity being damaged.\r\n+\t * @param harmedEntity - Entity getting exploded.\r\n+\t * @param cause - DamageCause.\r\n+\t * @param canExplode - Whether Towny will cancel this already.\r", "originalCommit": "6cff46713fe5d48676356e1ea041fff89663698f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzU5NzQ3MA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4420#discussion_r523597470", "bodyText": "This should be an else if otherwise if isExpl is off, then it will override isForceExpl", "author": "silverwolfg11", "createdAt": "2020-11-15T01:47:13Z", "path": "src/com/palmergames/bukkit/towny/event/executors/TownyActionEventExecutor.java", "diffHunk": "@@ -66,6 +77,50 @@ private static boolean isAllowedAction(Player player, Location loc, Material mat\n \r\n \t\treturn !event.isCancelled();\r\n \t}\r\n+\t\r\n+\t/**\r\n+\t * Towny's primary internal test to determine if something can explode\r\n+\t * at the given location, based on Towny's plot permissions.\r\n+\t * \r\n+\t * @param loc - Location being tested.\r\n+\t * @return true if the explosion is allowed.\r\n+\t */\r\n+\tprivate static boolean isAllowedExplosion(Location loc) {\r\n+\t\tboolean canExplode = false;\r\n+\t\tTownyWorld world = TownyAPI.getInstance().getTownyWorld(loc.getWorld().getName());\r\n+\t\tif (world == null)\r\n+\t\t\tcanExplode = false;\r\n+\t\telse {\r\n+\t\t\r\n+\t\t\tif (TownyAPI.getInstance().isWilderness(loc)) {\r\n+\t\t\t\t/*\r\n+\t\t\t\t * Handle occasions in the wilderness first.\r\n+\t\t\t\t */\r\n+\t\t\t\tif (world.isForceExpl() || world.isExpl())\r\n+\t\t\t\t\tcanExplode = true;\r\n+\t\t\t\tif (!world.isExpl())\r", "originalCommit": "6cff46713fe5d48676356e1ea041fff89663698f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzU5OTMwNA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4420#discussion_r523599304", "bodyText": "If town explosions are enabled, do all townblocks in the town force toggle the explosion perm for the townblock?", "author": "silverwolfg11", "createdAt": "2020-11-15T01:48:50Z", "path": "src/com/palmergames/bukkit/towny/event/executors/TownyActionEventExecutor.java", "diffHunk": "@@ -66,6 +77,50 @@ private static boolean isAllowedAction(Player player, Location loc, Material mat\n \r\n \t\treturn !event.isCancelled();\r\n \t}\r\n+\t\r\n+\t/**\r\n+\t * Towny's primary internal test to determine if something can explode\r\n+\t * at the given location, based on Towny's plot permissions.\r\n+\t * \r\n+\t * @param loc - Location being tested.\r\n+\t * @return true if the explosion is allowed.\r\n+\t */\r\n+\tprivate static boolean isAllowedExplosion(Location loc) {\r\n+\t\tboolean canExplode = false;\r\n+\t\tTownyWorld world = TownyAPI.getInstance().getTownyWorld(loc.getWorld().getName());\r\n+\t\tif (world == null)\r\n+\t\t\tcanExplode = false;\r\n+\t\telse {\r\n+\t\t\r\n+\t\t\tif (TownyAPI.getInstance().isWilderness(loc)) {\r\n+\t\t\t\t/*\r\n+\t\t\t\t * Handle occasions in the wilderness first.\r\n+\t\t\t\t */\r\n+\t\t\t\tif (world.isForceExpl() || world.isExpl())\r\n+\t\t\t\t\tcanExplode = true;\r\n+\t\t\t\tif (!world.isExpl())\r\n+\t\t\t\t\tcanExplode = false;\t\t\t\r\n+\t\t\t} else {\r\n+\t\t\t\t/*\r\n+\t\t\t\t * Must be inside of a town.\r\n+\t\t\t\t */\r\n+\t\t\t\tcanExplode = TownyAPI.getInstance().getTownBlock(loc).getPermissions().explosion;\t\t\t\r", "originalCommit": "6cff46713fe5d48676356e1ea041fff89663698f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzY2OTY3Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4420#discussion_r523669677", "bodyText": "Town explosions enabling should enable them on all non-changed townblocks. So it will be a per-plot setting.", "author": "LlmDl", "createdAt": "2020-11-15T02:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzU5OTMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzYwNzE2OA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4420#discussion_r523607168", "bodyText": "Nitpick, but maybe should be called Blocks event instead of Block event since it's more than one block.", "author": "silverwolfg11", "createdAt": "2020-11-15T01:55:32Z", "path": "src/com/palmergames/bukkit/towny/event/actions/TownyExplodingBlockEvent.java", "diffHunk": "@@ -0,0 +1,150 @@\n+package com.palmergames.bukkit.towny.event.actions;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.List;\r\n+\r\n+import org.bukkit.Material;\r\n+import org.bukkit.block.Block;\r\n+import org.bukkit.entity.Entity;\r\n+import org.bukkit.event.Event;\r\n+import org.bukkit.event.HandlerList;\r\n+import org.jetbrains.annotations.Nullable;\r\n+\r\n+/**\r\n+ * Part of the API which lets Towny's war and other plugins modify Towny's\r\n+ * plot-permission-decision outcomes.\r\n+ * \r\n+ * TownyExplodingBlockEvents are thrown when an explosion occurs \r\n+ * in a Towny world, causing block damage.\r\n+ * \r\n+ * <br> - When a bed/respawn anchor explodes causing block damage.\r\n+ * <br> - When a an entity explodes causing block damage.\r\n+ * \r\n+ * @param vanillaBlockList - List of Blocks which were involved in the original explosion.\r\n+ * @param townyFilteredList - List of Blocks Towny has already filtered, these blocks will explode unless {@link #setBlockList(List)} is used.\r\n+ * @param mat - Material which caused the block explosion or null if it is an entity explosion.\r\n+ * @param entity - Entity which caused the entity explosion or null if it is a block explosion. \r\n+ * \r\n+ * @author LlmDl\r\n+ */\r\n+public class TownyExplodingBlockEvent extends Event {\r\n+\r\n+\tprivate static final HandlerList handlers = new HandlerList();\r\n+\tprivate final List<Block> vanillaBlockList;\r\n+\tprivate final List<Block> filteredBlockList;\r\n+\tprivate final Material material;\r\n+\tprivate final Entity entity;\r\n+\tprivate List<Block> blockList = new ArrayList<Block>();\r\n+\tprivate boolean isChanged = false;\r\n+\r\n+\t/**\r\n+\t * Event thrown when blocks are exploded by a block or entity.\r\n+\t * \r\n+\t * @param vanillaBlockList - List of Blocks which were involved in the original explosion.\r\n+\t * @param townyFilteredList - List of Blocks Towny has already filtered, these blocks will explode unless {@link #setBlockList(List)} is used.\r\n+\t * @param mat - Material which caused the block explosion or null if it is an entity explosion.\r\n+\t * @param entity - Entity which caused the entity explosion or null if it is a block explosion. \r\n+\t */\r\n+\tpublic TownyExplodingBlockEvent(List<Block> vanillaBlockList, List<Block> townyFilteredList, Material mat, Entity entity) {\r", "originalCommit": "6cff46713fe5d48676356e1ea041fff89663698f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcxMjA0MA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4420#discussion_r523712040", "bodyText": "Mismatched paramater", "author": "silverwolfg11", "createdAt": "2020-11-15T05:52:19Z", "path": "src/com/palmergames/bukkit/towny/event/actions/TownyExplosionDamagesEntityEvent.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.palmergames.bukkit.towny.event.actions;\r\n+\r\n+import org.bukkit.Location;\r\n+import org.bukkit.entity.Entity;\r\n+import org.bukkit.event.Cancellable;\r\n+import org.bukkit.event.Event;\r\n+import org.bukkit.event.HandlerList;\r\n+import org.bukkit.event.entity.EntityDamageEvent.DamageCause;\r\n+\r\n+/**\r\n+ * Part of the API which lets Towny's war and other plugins modify Towny's\r\n+ * plot-permission-decision outcomes.\r\n+ * \r\n+ * TownyExplosionDamagesEntityEvents are thrown when an explosion \r\n+ * occurs in a Towny world, causing damage to an entity.\r\n+ * \r\n+ * <br> - When an entity explosion, block explosion or lightning damages an entity.\r\n+ * <br> - When an explosion would damage a Hanging entity.\r\n+ * <br> - When a pig is zapped by lightning.\r\n+ * <br> - When an explosion would damage a Vehicle.\r\n+ * \r\n+ * @param location - Location of the entity being damaged.\r\n+ * @param entity - Entity getting exploded.\r\n+ * @param cause - DamageCause.\r\n+ * @param canExplode - Whether Towny will cancel this already.\r", "originalCommit": "27422350c8573a4839f25da19ca5e79acaad0f44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "71b8bd8e3dcaed6441acfbf0c9367d87daba2b43", "url": "https://github.com/TownyAdvanced/Towny/commit/71b8bd8e3dcaed6441acfbf0c9367d87daba2b43", "message": "TownyExplodeEvent commit.\n\n- Adds TownyExplodeEvent(Location location, boolean canExplode)\n- Used via the TownyActionEventExecutor in the Listener classes to\ndecide the outcome of an explosion.\n- Deletes the ExplosionUtil.\n- Separates the war explosion tests, moving them into the\nWarZoneListener, where the TownyExplodeEvent outcome is altered if\nneeded.\n\n\nTODO: Work out some way of allowing for Block Damage and Entity Damage to be separated from each other so that wars can have TNT that hurts entities but does not destroy the terrain. Potentially two events needed.", "committedDate": "2020-11-15T16:17:48Z", "type": "commit"}, {"oid": "ab4e3271bc63c6fab8d7d73ddb372dc53b6812c6", "url": "https://github.com/TownyAdvanced/Towny/commit/ab4e3271bc63c6fab8d7d73ddb372dc53b6812c6", "message": "TownyExplodeEvent commit.\n\n- First draft at a block/entity damage split.\n- Currently has a delay and block passed on in order to allow for things\nlike the revert-on-explosions-in-warzones. It's messy.\n- Also currently has a number of entities being tested like they are\nblocks (hangingentities and vehicles) which I'm not entirely sure of\nyet.", "committedDate": "2020-11-15T16:18:59Z", "type": "commit"}, {"oid": "6acab0ec9de940352621f885e6d9695c1a45d00c", "url": "https://github.com/TownyAdvanced/Towny/commit/6acab0ec9de940352621f885e6d9695c1a45d00c", "message": "TownyExplodeEvent commit.\n\n- Undo last commit's change that would make some explosions' checks into\nBlock damage instead of Entity damage tests.", "committedDate": "2020-11-15T16:18:59Z", "type": "commit"}, {"oid": "4b309859a83429af601bd5fb112383a7245b8990", "url": "https://github.com/TownyAdvanced/Towny/commit/4b309859a83429af601bd5fb112383a7245b8990", "message": "TownyExplodeEvent commit.\n\n- Changes events into TownyExplodingBlockEvent &\nTownyExplosionDamagesEntityEvent.\n  - BlockEvent uses filterable list of Blocks which will then determine\nwhat is allowed to explode.\n  - EntityEvent uses location and entity involved.\n- Wither explosion in EntityListener's EntityChangeBlockEvent is the\nonly exception (not sure what to do with this one, exactly) and just\nuses a canExplode(Location) test.\n- WarZoneListener has been altered to use the new setup.\n- New system is better than before but probably still not ready.", "committedDate": "2020-11-15T16:20:13Z", "type": "commit"}, {"oid": "9429d915401c66dac82e264153e110433867addc", "url": "https://github.com/TownyAdvanced/Towny/commit/9429d915401c66dac82e264153e110433867addc", "message": "TownyExplodeEvent commit.\n\n- Remove now-unused TownyExplodeEvent.", "committedDate": "2020-11-15T16:20:13Z", "type": "commit"}, {"oid": "1e394259576d540a3c0a4cb89327024db525a249", "url": "https://github.com/TownyAdvanced/Towny/commit/1e394259576d540a3c0a4cb89327024db525a249", "message": "TownyExplodeEvent commit.\n\n- Adds TownyExplosionEvent which tests only for a location.\n  - Currently only used for Wither explosions.\n- Adds javadoc comments explaining when the new explosion events are\nbeing called.", "committedDate": "2020-11-15T16:20:13Z", "type": "commit"}, {"oid": "13902953617ea643297c13bcc6849e92d4db1c70", "url": "https://github.com/TownyAdvanced/Towny/commit/13902953617ea643297c13bcc6849e92d4db1c70", "message": "TownyExplodeEvent commit.\n\n- Do away with the TownyExplosionEvent.\n  - Unneeded as Withers did not need to have their explosions cancelled\nin the EntityChangeBlockEvent, they throw EntityExplodeEvents.\n- Remove wither section from the EntityChangeBlockEvent in\nTownyEntityListener.", "committedDate": "2020-11-15T16:20:13Z", "type": "commit"}, {"oid": "764e4fddb4b3d4f7b5744f4ff981c01e2b2e660e", "url": "https://github.com/TownyAdvanced/Towny/commit/764e4fddb4b3d4f7b5744f4ff981c01e2b2e660e", "message": "TownyExplodeEvent commit.\n\n- Fix javadoc and whitespacing.", "committedDate": "2020-11-15T16:20:57Z", "type": "commit"}, {"oid": "11b62469a32b67d9318a80259b5754f26cdf39f2", "url": "https://github.com/TownyAdvanced/Towny/commit/11b62469a32b67d9318a80259b5754f26cdf39f2", "message": "TownyExplodeEvent commit.\n\n- Adds DamageCause to TownyExplosionDamagesEntityEvent.\n- Adds Material and Entity to TownyExplodingBlockEvent.", "committedDate": "2020-11-15T16:20:57Z", "type": "commit"}, {"oid": "d3e2a23f43b29605115dea609166fffb04dcbdd5", "url": "https://github.com/TownyAdvanced/Towny/commit/d3e2a23f43b29605115dea609166fffb04dcbdd5", "message": "TownyExplodeEvent commit.", "committedDate": "2020-11-15T16:20:57Z", "type": "commit"}, {"oid": "556b1f17ca40b5974bbbdedbdd847cca88b57447", "url": "https://github.com/TownyAdvanced/Towny/commit/556b1f17ca40b5974bbbdedbdd847cca88b57447", "message": "TownyExplodeEvent commit.", "committedDate": "2020-11-15T16:20:57Z", "type": "commit"}, {"oid": "70e47da4f9f29d4fd55feb051787cd12fd561a68", "url": "https://github.com/TownyAdvanced/Towny/commit/70e47da4f9f29d4fd55feb051787cd12fd561a68", "message": "TownyExplodeEvent commit.\n\n- Make silverwolf's requested changes.", "committedDate": "2020-11-15T16:20:57Z", "type": "commit"}, {"oid": "b8fa2b925fe7acd2ce37005536e285a22cf61ff1", "url": "https://github.com/TownyAdvanced/Towny/commit/b8fa2b925fe7acd2ce37005536e285a22cf61ff1", "message": "TownyExplodeEvent commit.\n\n- Fix mismatched parameter.", "committedDate": "2020-11-15T16:20:58Z", "type": "commit"}, {"oid": "b8fa2b925fe7acd2ce37005536e285a22cf61ff1", "url": "https://github.com/TownyAdvanced/Towny/commit/b8fa2b925fe7acd2ce37005536e285a22cf61ff1", "message": "TownyExplodeEvent commit.\n\n- Fix mismatched parameter.", "committedDate": "2020-11-15T16:20:58Z", "type": "forcePushed"}, {"oid": "d91690701a32c2bb390b6ff1dfbca5546b092800", "url": "https://github.com/TownyAdvanced/Towny/commit/d91690701a32c2bb390b6ff1dfbca5546b092800", "message": "TownyExplodeEvent commit.\n\n- Fix TownyExplosionDamagesEntityEvent being given the opposite of\ncancelled.", "committedDate": "2020-11-15T16:33:54Z", "type": "commit"}]}