{"pr_number": 2263, "pr_title": "Add support for spring.cloud.gcp.secretmanager.version property", "pr_createdAt": "2020-03-20T03:43:24Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2263", "timeline": [{"oid": "489dde6722f67249c1a5863243d00d4dda24c0a4", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/489dde6722f67249c1a5863243d00d4dda24c0a4", "message": "Add support for spring.cloud.gcp.secretmanager.version property\n\nSee gh-2260", "committedDate": "2020-03-20T04:20:04Z", "type": "forcePushed"}, {"oid": "e80f5fabbcf3841984bfe2f4b6731d49a4866cba", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/e80f5fabbcf3841984bfe2f4b6731d49a4866cba", "message": "Add support for spring.cloud.gcp.secretmanager.version property\n\nSee gh-2260", "committedDate": "2020-03-20T04:21:41Z", "type": "commit"}, {"oid": "51b74c76c9dcf99ba835a4df7669fc965bf5b012", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/51b74c76c9dcf99ba835a4df7669fc965bf5b012", "message": "Add support to load specific secret versions", "committedDate": "2020-03-20T05:03:31Z", "type": "commit"}, {"oid": "51b74c76c9dcf99ba835a4df7669fc965bf5b012", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/51b74c76c9dcf99ba835a4df7669fc965bf5b012", "message": "Add support to load specific secret versions", "committedDate": "2020-03-20T05:03:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2ODE0OQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2263#discussion_r395668149", "bodyText": "I think I would rather just keep it null to indicate to use the default.", "author": "meltsufin", "createdAt": "2020-03-20T14:21:04Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/GcpSecretManagerProperties.java", "diffHunk": "@@ -42,6 +45,18 @@\n \t */\n \tprivate String secretNamePrefix = \"\";\n \n+\tprivate static final String LATEST_VERSION_STRING = \"latest\";\n+\n+\t/**\n+\t * Defines the secret's version to be used.\n+\t */\n+\tprivate String version = LATEST_VERSION_STRING;", "originalCommit": "51b74c76c9dcf99ba835a4df7669fc965bf5b012", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2ODc0OA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2263#discussion_r395668748", "bodyText": "This change to the constructor would be breaking. Can we instead add an additional constructor with extra version params?", "author": "meltsufin", "createdAt": "2020-03-20T14:21:56Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertySource.java", "diffHunk": "@@ -48,12 +47,14 @@ public SecretManagerPropertySource(\n \t\t\tString propertySourceName,\n \t\t\tSecretManagerServiceClient client,\n \t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix) {\n+\t\t\tString secretsPrefix,\n+\t\t\tString version,", "originalCommit": "51b74c76c9dcf99ba835a4df7669fc965bf5b012", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3MDkzNQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2263#discussion_r395670935", "bodyText": "Again, maybe add an additional constructor rather than introducing a breaking change?", "author": "meltsufin", "createdAt": "2020-03-20T14:25:02Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertySourceLocator.java", "diffHunk": "@@ -40,13 +43,21 @@\n \n \tprivate final String secretsPrefix;\n \n+\tprivate final String version;\n+\n+\tprivate final Map<String, String> versions;\n+\n \tSecretManagerPropertySourceLocator(\n \t\t\tSecretManagerServiceClient client,\n \t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix) {\n+\t\t\tString secretsPrefix,\n+\t\t\tString version,", "originalCommit": "51b74c76c9dcf99ba835a4df7669fc965bf5b012", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3MjIzMA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2263#discussion_r395672230", "bodyText": "Can we add another test where both secretmanager.version and secretmanager.versions are specified and verify that the second takes precedence?", "author": "meltsufin", "createdAt": "2020-03-20T14:26:56Z", "path": "spring-cloud-gcp-autoconfigure/src/test/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/it/SecretManagerIntegrationTests.java", "diffHunk": "@@ -103,13 +103,52 @@ public void testConfigurationDisabled() {\n \t\t\t\t.getProperty(\"spring-cloud-gcp.secrets.my-secret\")).isNull();\n \t}\n \n+\t@Test\n+\tpublic void testVersion() {\n+\t\tthis.context = new SpringApplicationBuilder()\n+\t\t\t\t.sources(GcpContextAutoConfiguration.class, GcpSecretManagerBootstrapConfiguration.class)\n+\t\t\t\t.web(WebApplicationType.NONE)\n+\t\t\t\t.properties(\"spring.cloud.gcp.secretmanager.bootstrap.enabled=true\")\n+\t\t\t\t.properties(\"spring.cloud.gcp.secretmanager.bootstrap.version=2\")\n+\t\t\t\t.run();\n+\n+\t\tcreateSecret(TEST_SECRET_ID, \"the secret data\");\n+\t\tassertThat(secretExists(TEST_SECRET_ID, \"1\")).isTrue();\n+\t\tcreateSecret(TEST_SECRET_ID, \"the secret data v2\");\n+\t\tassertThat(secretExists(TEST_SECRET_ID, \"2\")).isTrue();\n+\t\tassertThat(secretExists(TEST_SECRET_ID, \"latest\")).isTrue();\n+\n+\t\tbyte[] byteArraySecret = this.context.getEnvironment().getProperty(\"my-secret\", byte[].class);\n+\t\tassertThat(byteArraySecret).isEqualTo(\"the secret data v2.\".getBytes());\n+\t}\n+\n+\t@Test\n+\tpublic void testSecretsWithSpecificVersion() {", "originalCommit": "51b74c76c9dcf99ba835a4df7669fc965bf5b012", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f30671e80c135fb975b890933958816bc6f87fdf", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/f30671e80c135fb975b890933958816bc6f87fdf", "message": "Add test to ensure specific version has priority over the global", "committedDate": "2020-03-20T16:04:36Z", "type": "commit"}, {"oid": "e5e701193f52bda6fc5303834e573fb5c0d8f8f9", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/e5e701193f52bda6fc5303834e573fb5c0d8f8f9", "message": "Fix filter due to getName() doesn't contain the version", "committedDate": "2020-03-20T16:05:13Z", "type": "commit"}, {"oid": "5236687eba0be4c925a0daf86fe75e19faf8e342", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/5236687eba0be4c925a0daf86fe75e19faf8e342", "message": "Remove latest default value for version", "committedDate": "2020-03-20T18:02:07Z", "type": "commit"}, {"oid": "1b53502e5d95065bf8cc1457d83f054e67a468f6", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/1b53502e5d95065bf8cc1457d83f054e67a468f6", "message": "Add docs", "committedDate": "2020-03-21T01:37:51Z", "type": "commit"}, {"oid": "946954064336210449a36874f4cf56fe346e3879", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/946954064336210449a36874f4cf56fe346e3879", "message": "Polish", "committedDate": "2020-03-21T01:48:58Z", "type": "commit"}, {"oid": "c19dda4b911a79585932dcf0533e47aad73eb74f", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/c19dda4b911a79585932dcf0533e47aad73eb74f", "message": "Polish docs", "committedDate": "2020-03-21T16:34:45Z", "type": "commit"}]}