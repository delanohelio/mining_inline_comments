{"pr_number": 2302, "pr_title": "Create protocol for specifying secrets' project and versions", "pr_createdAt": "2020-04-03T23:59:58Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302", "timeline": [{"oid": "222575d957dac93873422ae94315e728c22d307d", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/222575d957dac93873422ae94315e728c22d307d", "message": "Create protocol for specifying secrets", "committedDate": "2020-04-03T23:54:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1OTI2MA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404159260", "bodyText": "s/projectId/secretId", "author": "elefeint", "createdAt": "2020-04-06T14:58:26Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertyIdentifier.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n+\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+import org.springframework.util.Assert;\n+\n+/**\n+ * Identifiers for specifying Secret Manager secrets using (project-id, secret-id, version).\n+ *\n+ * @author Daniel Zou\n+ * @since 1.2.3\n+ */\n+public class SecretManagerPropertyIdentifier {\n+\n+\t// This prefix string distinguishes whether a property should be queried from Secret Manager or not.\n+\tprivate static final String GCP_SECRET_PREFIX = \"gcp-secret/\";\n+\n+\tprivate final String projectId;\n+\n+\tprivate final String secretId;\n+\n+\tprivate final String version;\n+\n+\tSecretManagerPropertyIdentifier(String projectId, String secretId, String version) {\n+\t\tAssert.notNull(projectId, \"Project Id of GCP Secret Manager secret must not be null\");\n+\t\tAssert.notNull(projectId, \"Secret Id of GCP Secret Manager secret must not be null\");", "originalCommit": "222575d957dac93873422ae94315e728c22d307d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzNTI0Nw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404435247", "bodyText": "Removed file in favor of using SecretVersionName", "author": "dzou", "createdAt": "2020-04-06T22:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1OTI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1OTQ3NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404159474", "bodyText": "s/projectId/version\nI leave these copy/paste problems all over the place when writing code; that's why I usually test trivial assert conditions -- they catch what I don't.", "author": "elefeint", "createdAt": "2020-04-06T14:58:40Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertyIdentifier.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n+\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+import org.springframework.util.Assert;\n+\n+/**\n+ * Identifiers for specifying Secret Manager secrets using (project-id, secret-id, version).\n+ *\n+ * @author Daniel Zou\n+ * @since 1.2.3\n+ */\n+public class SecretManagerPropertyIdentifier {\n+\n+\t// This prefix string distinguishes whether a property should be queried from Secret Manager or not.\n+\tprivate static final String GCP_SECRET_PREFIX = \"gcp-secret/\";\n+\n+\tprivate final String projectId;\n+\n+\tprivate final String secretId;\n+\n+\tprivate final String version;\n+\n+\tSecretManagerPropertyIdentifier(String projectId, String secretId, String version) {\n+\t\tAssert.notNull(projectId, \"Project Id of GCP Secret Manager secret must not be null\");\n+\t\tAssert.notNull(projectId, \"Secret Id of GCP Secret Manager secret must not be null\");\n+\t\tAssert.notNull(projectId, \"Version of GCP Secret Manager secret must not be null\");", "originalCommit": "222575d957dac93873422ae94315e728c22d307d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzNTE0NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404435144", "bodyText": "Nice catch :)", "author": "dzou", "createdAt": "2020-04-06T22:51:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1OTQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE2Mzc4MQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404163781", "bodyText": "Do we want to have both resolvable? The new version is more comprehensive. Or are we doing it for backwards compatibility?\nPerhaps we could automatically configure only the newest property source, and provide a \"legacy\" property for  loading the old one?", "author": "elefeint", "createdAt": "2020-04-06T15:04:20Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertySourceLocator.java", "diffHunk": "@@ -60,11 +61,22 @@ public void setVersions(Map<String, String> versions) {\n \n \t@Override\n \tpublic PropertySource<?> locate(Environment environment) {\n-\t\treturn new SecretManagerPropertySource(\n-\t\t\t\tSECRET_MANAGER_NAME,\n-\t\t\t\tthis.client,\n-\t\t\t\tthis.projectIdProvider,\n-\t\t\t\tthis.secretsPrefix,\n-\t\t\t\tthis.versions);\n+\t\tCompositePropertySource compositePropertySource = new CompositePropertySource(SECRET_MANAGER_NAME);\n+\n+\t\tcompositePropertySource.addPropertySource(", "originalCommit": "222575d957dac93873422ae94315e728c22d307d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM0ODM2NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404348365", "bodyText": "Yeah I wasn't sure how to handle this. I think would prefer if we only have the new version. Maybe if it's ok, I'd like to just remove the existing functionality and replace it with the new method. @meltsufin\nI guess it doesn't make sense for both to co-exist since the legacy one already does the work of downloading all the secrets, and then if the new system exists they might redownload secrets they already loaded into their properties.", "author": "dzou", "createdAt": "2020-04-06T19:53:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE2Mzc4MQ=="}], "type": "inlineReview"}, {"oid": "69ea656a3327bca3cbab58d8e791a732a9b4a360", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/69ea656a3327bca3cbab58d8e791a732a9b4a360", "message": "Fix assert notNull statements", "committedDate": "2020-04-06T16:33:04Z", "type": "commit"}, {"oid": "d9c75921e9cdee2238c1388fd2dce7076741db71", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/d9c75921e9cdee2238c1388fd2dce7076741db71", "message": "reduce visibility of SecretManagerPropertyIdentifier", "committedDate": "2020-04-06T16:34:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNjEwNQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404326105", "bodyText": "I'm not sure you really need this class. Can you just use the existing SecretVersionName?\nI understand you need a place to put the parseFromProperty method somewhere, but maybe for now you can just put it as a static method in SecretManagerAccessPropertySource?", "author": "meltsufin", "createdAt": "2020-04-06T19:12:20Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertyIdentifier.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n+\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+import org.springframework.util.Assert;\n+\n+/**\n+ * Identifiers for specifying Secret Manager secrets using (project-id, secret-id, version).\n+ *\n+ * @author Daniel Zou\n+ * @since 1.2.3\n+ */\n+public class SecretManagerPropertyIdentifier {", "originalCommit": "222575d957dac93873422ae94315e728c22d307d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzNTM3NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404435375", "bodyText": "Good call, done.", "author": "dzou", "createdAt": "2020-04-06T22:51:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNjEwNQ=="}], "type": "inlineReview"}, {"oid": "3d87209b182bbe381cc24408c4b161df2fb44b1e", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/3d87209b182bbe381cc24408c4b161df2fb44b1e", "message": "PR Comments", "committedDate": "2020-04-06T22:49:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404812208", "bodyText": "Did the Secrets Manager team comment on this prefix? Have you looked into using sm://?", "author": "meltsufin", "createdAt": "2020-04-07T13:33:46Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertySource.java", "diffHunk": "@@ -16,117 +16,119 @@\n \n package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n \n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.Map;\n-\n+import com.google.api.gax.rpc.NotFoundException;\n import com.google.cloud.secretmanager.v1beta1.AccessSecretVersionResponse;\n-import com.google.cloud.secretmanager.v1beta1.ProjectName;\n-import com.google.cloud.secretmanager.v1beta1.Secret;\n import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n-import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient.ListSecretsPagedResponse;\n import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n import com.google.protobuf.ByteString;\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n \n import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n import org.springframework.core.env.EnumerablePropertySource;\n \n /**\n- * Retrieves secrets from GCP Secret Manager under the current GCP project.\n+ * A property source for Secret Manager which accesses the Secret Manager APIs when {@link #getProperty} is called.\n  *\n  * @author Daniel Zou\n  * @author Edd\u00fa Mel\u00e9ndez\n  * @since 1.2.2\n  */\n public class SecretManagerPropertySource extends EnumerablePropertySource<SecretManagerServiceClient> {\n \n-\tprivate static final Log LOGGER = LogFactory.getLog(SecretManagerPropertySource.class);\n-\n-\tprivate static final String LATEST_VERSION_STRING = \"latest\";\n-\n-\tprivate final Map<String, Object> properties;\n+\tprivate static final String GCP_SECRET_PREFIX = \"gcp-secret/\";", "originalCommit": "3d87209b182bbe381cc24408c4b161df2fb44b1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg2Mjc0MA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404862740", "bodyText": "Colon can't be used in a property name because it means something special in SPEL. I wouldn't want to try to escape the colon either; I think it would look worse with the back slashes.\nAm open to other secret prefixes though.", "author": "dzou", "createdAt": "2020-04-07T14:40:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMTgzNQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405011835", "bodyText": "I wonder if we can tap into that \"special meaning\" and configure it for our purpose.", "author": "meltsufin", "createdAt": "2020-04-07T18:09:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMjkzMw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405012933", "bodyText": "Colon is like the null-safety operator. If the left side of the colon is evaluated to null, then it defaults to the value on the right side.\nSo if i do gs://blah/blah - it firsts evaluates gs which it finds to be null, then returns the string //blah/blah.", "author": "dzou", "createdAt": "2020-04-07T18:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MDc5MA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405050790", "bodyText": "This is only the case if SPEL is used, such as with @Value, right?\nNotice that with @Value on a Resource it's interpreted as a protocol instead.\nFor example, see the \"gs://\" implementation we have for Storage.", "author": "meltsufin", "createdAt": "2020-04-07T19:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2Mzk4MA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405163980", "bodyText": "Ok so I found something interesting. It seems like doing the gcp-sm:// works but has slightly unexpected behavior.\n\n\nIf the secret exists, then doing the gcp-sm://path/to/secret works fine. It will load the secret without issue.\n\n\nIf the secret property source returns null for any secret property, then it will fallback to the evaluating the left-hand side and if that is null it will show the right hand side. See in our sample, we have secrets named application-secret, so in our sample, if the secrets are not present, you see that it will render //application-secret instead of the secret value.\n\n\n\nSo I guess if we move forward with throwing an exception in the cases where a secret is missing or the secret URL is not formatted correctly then user will never reach this unexpected behavior.\nWhat are your thoughts?", "author": "dzou", "createdAt": "2020-04-07T23:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUzOTYxNA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405539614", "bodyText": "I'm not following fully. Let's discuss.", "author": "meltsufin", "createdAt": "2020-04-08T13:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NDY5NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405684695", "bodyText": "I'll look a little more into to understand if it's fixable.\nJust to summarize our discussion this morning, using colon has the consequence where if we ever return null for a secret, it will interpret the colon as the null safety operator. This is why it was printing out //application-secret for the secret that did not exist, because the original string was gcp-sm://application-secret; after resolving it to null, it treated the contents of the right of the colon as the \"default value\".", "author": "dzou", "createdAt": "2020-04-08T17:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NDA5OA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405694098", "bodyText": "Ran the code through the debugger, the colon is a special character; i don't think this is configurable. I think we should avoid it to avoid unexpected behavior in the future with null values.\nI would be open to other choices of prefixes, maybe sm| or gcp-sm| these seem to all work. I recall Seth suggested using | as an alternative.", "author": "dzou", "createdAt": "2020-04-08T17:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNTMwMw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405705303", "bodyText": "Should we ever return null though? Is there something wrong with throwing an exception for a property that doesn't exist?", "author": "meltsufin", "createdAt": "2020-04-08T17:50:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxNzIzNQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405717235", "bodyText": "Yeah I can see the argument where if a user specifies a secret using our syntax, there is the expectation that a secret is there; if it's missing then that's most likely an error and they probably don't want null there.\nI would be comfortable with either approach. We can still throw exception using | too by the way.\nTo me it seems the tradeoff here is purely cosmetic. I.e. if the cosmetic benefits of using : outweighs the risk that we need to change behavior to return null someday.", "author": "dzou", "createdAt": "2020-04-08T18:10:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyMTYyNQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405721625", "bodyText": "What's the prefix that the Secret Manager team suggested we use? There's value in being compatible with other libraries for this product. Let's confirm with the product team.", "author": "meltsufin", "createdAt": "2020-04-08T18:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNTU3Nw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405825577", "bodyText": "Based on discussion offline, looks like sm:// has precedent of being used, so I just changed it to that for now.", "author": "dzou", "createdAt": "2020-04-08T21:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMjIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMzU5Nw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404813597", "bodyText": "Interesting that this still works.\nMaybe we should log a warning when this method is called?", "author": "meltsufin", "createdAt": "2020-04-07T13:35:42Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertySource.java", "diffHunk": "@@ -16,117 +16,119 @@\n \n package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n \n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.Map;\n-\n+import com.google.api.gax.rpc.NotFoundException;\n import com.google.cloud.secretmanager.v1beta1.AccessSecretVersionResponse;\n-import com.google.cloud.secretmanager.v1beta1.ProjectName;\n-import com.google.cloud.secretmanager.v1beta1.Secret;\n import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n-import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient.ListSecretsPagedResponse;\n import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n import com.google.protobuf.ByteString;\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n \n import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n import org.springframework.core.env.EnumerablePropertySource;\n \n /**\n- * Retrieves secrets from GCP Secret Manager under the current GCP project.\n+ * A property source for Secret Manager which accesses the Secret Manager APIs when {@link #getProperty} is called.\n  *\n  * @author Daniel Zou\n  * @author Edd\u00fa Mel\u00e9ndez\n  * @since 1.2.2\n  */\n public class SecretManagerPropertySource extends EnumerablePropertySource<SecretManagerServiceClient> {\n \n-\tprivate static final Log LOGGER = LogFactory.getLog(SecretManagerPropertySource.class);\n-\n-\tprivate static final String LATEST_VERSION_STRING = \"latest\";\n-\n-\tprivate final Map<String, Object> properties;\n+\tprivate static final String GCP_SECRET_PREFIX = \"gcp-secret/\";\n \n-\tprivate final String[] propertyNames;\n+\tprivate final GcpProjectIdProvider projectIdProvider;\n \n \tpublic SecretManagerPropertySource(\n \t\t\tString propertySourceName,\n \t\t\tSecretManagerServiceClient client,\n-\t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix) {\n-\t\tthis(propertySourceName, client, projectIdProvider, secretsPrefix, Collections.EMPTY_MAP);\n-\t}\n-\n-\tpublic SecretManagerPropertySource(\n-\t\t\tString propertySourceName,\n-\t\t\tSecretManagerServiceClient client,\n-\t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix,\n-\t\t\tMap<String, String> versions) {\n+\t\t\tGcpProjectIdProvider projectIdProvider) {\n \t\tsuper(propertySourceName, client);\n \n-\t\tMap<String, Object> propertiesMap = createSecretsPropertiesMap(\n-\t\t\t\tclient, projectIdProvider.getProjectId(), secretsPrefix, versions);\n+\t\tthis.projectIdProvider = projectIdProvider;\n+\t}\n \n-\t\tthis.properties = propertiesMap;\n-\t\tthis.propertyNames = propertiesMap.keySet().toArray(new String[propertiesMap.size()]);\n+\t@Override\n+\tpublic Object getProperty(String name) {\n+\t\tSecretVersionName secretIdentifier = parseFromProperty(name, this.projectIdProvider);\n+\n+\t\tif (secretIdentifier != null) {\n+\t\t\treturn getSecretPayload(secretIdentifier);\n+\t\t}\n+\t\telse {\n+\t\t\treturn null;\n+\t\t}\n \t}\n \n+\t/**\n+\t * The {@link SecretManagerPropertySource} is not enumerable, so this always returns an empty array.\n+\t * @return the empty array.\n+\t */\n \t@Override\n \tpublic String[] getPropertyNames() {\n-\t\treturn propertyNames;\n+\t\treturn new String[0];", "originalCommit": "3d87209b182bbe381cc24408c4b161df2fb44b1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4MDE3Mw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404880173", "bodyText": "Can't unfortunately. This method gets called by framework code somewhere and will pollute the logs.", "author": "dzou", "createdAt": "2020-04-07T15:01:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMzU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMjA5Mg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405012092", "bodyText": "Maybe at DEBUG or TRACE level? How often will this be called?", "author": "meltsufin", "createdAt": "2020-04-07T18:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMzU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NDUzOQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405164539", "bodyText": "Hmm I don't think it's worth it; feel like it will just add noise. It is called at least 10 times per test run in the integration tests.", "author": "dzou", "createdAt": "2020-04-07T23:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMzU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNDYwNQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404814605", "bodyText": "Would it be so bad to let users overwrite the prefix?", "author": "meltsufin", "createdAt": "2020-04-07T13:37:11Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/GcpSecretManagerProperties.java", "diffHunk": "@@ -39,17 +36,6 @@\n \t */\n \tprivate String projectId;\n \n-\t/**\n-\t * Defines a prefix String that will be prepended to the environment property names\n-\t * of secrets in Secret Manager.\n-\t */\n-\tprivate String secretNamePrefix = \"\";", "originalCommit": "3d87209b182bbe381cc24408c4b161df2fb44b1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4MjAxOQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404882019", "bodyText": "I think it can only hurt users if they choose a bad prefix. It needs to be a unique/special string that lets us exit early so we know that it's definitely not a property we need to parse and attempt to query. So would prefer not leaving it in the hands of users.", "author": "dzou", "createdAt": "2020-04-07T15:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNDYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNTQxNw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404815417", "bodyText": "Wouldn't this be considered an error if we got here? Not sure we should swallow the exception.", "author": "meltsufin", "createdAt": "2020-04-07T13:38:18Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertySource.java", "diffHunk": "@@ -16,117 +16,119 @@\n \n package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n \n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.Map;\n-\n+import com.google.api.gax.rpc.NotFoundException;\n import com.google.cloud.secretmanager.v1beta1.AccessSecretVersionResponse;\n-import com.google.cloud.secretmanager.v1beta1.ProjectName;\n-import com.google.cloud.secretmanager.v1beta1.Secret;\n import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n-import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient.ListSecretsPagedResponse;\n import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n import com.google.protobuf.ByteString;\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n \n import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n import org.springframework.core.env.EnumerablePropertySource;\n \n /**\n- * Retrieves secrets from GCP Secret Manager under the current GCP project.\n+ * A property source for Secret Manager which accesses the Secret Manager APIs when {@link #getProperty} is called.\n  *\n  * @author Daniel Zou\n  * @author Edd\u00fa Mel\u00e9ndez\n  * @since 1.2.2\n  */\n public class SecretManagerPropertySource extends EnumerablePropertySource<SecretManagerServiceClient> {\n \n-\tprivate static final Log LOGGER = LogFactory.getLog(SecretManagerPropertySource.class);\n-\n-\tprivate static final String LATEST_VERSION_STRING = \"latest\";\n-\n-\tprivate final Map<String, Object> properties;\n+\tprivate static final String GCP_SECRET_PREFIX = \"gcp-secret/\";\n \n-\tprivate final String[] propertyNames;\n+\tprivate final GcpProjectIdProvider projectIdProvider;\n \n \tpublic SecretManagerPropertySource(\n \t\t\tString propertySourceName,\n \t\t\tSecretManagerServiceClient client,\n-\t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix) {\n-\t\tthis(propertySourceName, client, projectIdProvider, secretsPrefix, Collections.EMPTY_MAP);\n-\t}\n-\n-\tpublic SecretManagerPropertySource(\n-\t\t\tString propertySourceName,\n-\t\t\tSecretManagerServiceClient client,\n-\t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix,\n-\t\t\tMap<String, String> versions) {\n+\t\t\tGcpProjectIdProvider projectIdProvider) {\n \t\tsuper(propertySourceName, client);\n \n-\t\tMap<String, Object> propertiesMap = createSecretsPropertiesMap(\n-\t\t\t\tclient, projectIdProvider.getProjectId(), secretsPrefix, versions);\n+\t\tthis.projectIdProvider = projectIdProvider;\n+\t}\n \n-\t\tthis.properties = propertiesMap;\n-\t\tthis.propertyNames = propertiesMap.keySet().toArray(new String[propertiesMap.size()]);\n+\t@Override\n+\tpublic Object getProperty(String name) {\n+\t\tSecretVersionName secretIdentifier = parseFromProperty(name, this.projectIdProvider);\n+\n+\t\tif (secretIdentifier != null) {\n+\t\t\treturn getSecretPayload(secretIdentifier);\n+\t\t}\n+\t\telse {\n+\t\t\treturn null;\n+\t\t}\n \t}\n \n+\t/**\n+\t * The {@link SecretManagerPropertySource} is not enumerable, so this always returns an empty array.\n+\t * @return the empty array.\n+\t */\n \t@Override\n \tpublic String[] getPropertyNames() {\n-\t\treturn propertyNames;\n+\t\treturn new String[0];\n \t}\n \n-\t@Override\n-\tpublic Object getProperty(String name) {\n-\t\treturn properties.get(name);\n+\tprivate ByteString getSecretPayload(SecretVersionName secretIdentifier) {\n+\t\ttry {\n+\t\t\tAccessSecretVersionResponse response = getSource().accessSecretVersion(secretIdentifier);\n+\t\t\treturn response.getPayload().getData();\n+\t\t}\n+\t\tcatch (NotFoundException e) {\n+\t\t\treturn null;", "originalCommit": "3d87209b182bbe381cc24408c4b161df2fb44b1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NDcyMw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405164723", "bodyText": "Sure, let's throw exception, this might be good for supporting the gcp-sm:// prefix per our discussion above.", "author": "dzou", "createdAt": "2020-04-07T23:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNTQxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNzc3NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404817774", "bodyText": "Log an error or throw exception? Invalid format? etc.", "author": "meltsufin", "createdAt": "2020-04-07T13:41:32Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertySource.java", "diffHunk": "@@ -16,117 +16,119 @@\n \n package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n \n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.Map;\n-\n+import com.google.api.gax.rpc.NotFoundException;\n import com.google.cloud.secretmanager.v1beta1.AccessSecretVersionResponse;\n-import com.google.cloud.secretmanager.v1beta1.ProjectName;\n-import com.google.cloud.secretmanager.v1beta1.Secret;\n import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n-import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient.ListSecretsPagedResponse;\n import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n import com.google.protobuf.ByteString;\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n \n import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n import org.springframework.core.env.EnumerablePropertySource;\n \n /**\n- * Retrieves secrets from GCP Secret Manager under the current GCP project.\n+ * A property source for Secret Manager which accesses the Secret Manager APIs when {@link #getProperty} is called.\n  *\n  * @author Daniel Zou\n  * @author Edd\u00fa Mel\u00e9ndez\n  * @since 1.2.2\n  */\n public class SecretManagerPropertySource extends EnumerablePropertySource<SecretManagerServiceClient> {\n \n-\tprivate static final Log LOGGER = LogFactory.getLog(SecretManagerPropertySource.class);\n-\n-\tprivate static final String LATEST_VERSION_STRING = \"latest\";\n-\n-\tprivate final Map<String, Object> properties;\n+\tprivate static final String GCP_SECRET_PREFIX = \"gcp-secret/\";\n \n-\tprivate final String[] propertyNames;\n+\tprivate final GcpProjectIdProvider projectIdProvider;\n \n \tpublic SecretManagerPropertySource(\n \t\t\tString propertySourceName,\n \t\t\tSecretManagerServiceClient client,\n-\t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix) {\n-\t\tthis(propertySourceName, client, projectIdProvider, secretsPrefix, Collections.EMPTY_MAP);\n-\t}\n-\n-\tpublic SecretManagerPropertySource(\n-\t\t\tString propertySourceName,\n-\t\t\tSecretManagerServiceClient client,\n-\t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix,\n-\t\t\tMap<String, String> versions) {\n+\t\t\tGcpProjectIdProvider projectIdProvider) {\n \t\tsuper(propertySourceName, client);\n \n-\t\tMap<String, Object> propertiesMap = createSecretsPropertiesMap(\n-\t\t\t\tclient, projectIdProvider.getProjectId(), secretsPrefix, versions);\n+\t\tthis.projectIdProvider = projectIdProvider;\n+\t}\n \n-\t\tthis.properties = propertiesMap;\n-\t\tthis.propertyNames = propertiesMap.keySet().toArray(new String[propertiesMap.size()]);\n+\t@Override\n+\tpublic Object getProperty(String name) {\n+\t\tSecretVersionName secretIdentifier = parseFromProperty(name, this.projectIdProvider);\n+\n+\t\tif (secretIdentifier != null) {\n+\t\t\treturn getSecretPayload(secretIdentifier);\n+\t\t}\n+\t\telse {\n+\t\t\treturn null;\n+\t\t}\n \t}\n \n+\t/**\n+\t * The {@link SecretManagerPropertySource} is not enumerable, so this always returns an empty array.\n+\t * @return the empty array.\n+\t */\n \t@Override\n \tpublic String[] getPropertyNames() {\n-\t\treturn propertyNames;\n+\t\treturn new String[0];\n \t}\n \n-\t@Override\n-\tpublic Object getProperty(String name) {\n-\t\treturn properties.get(name);\n+\tprivate ByteString getSecretPayload(SecretVersionName secretIdentifier) {\n+\t\ttry {\n+\t\t\tAccessSecretVersionResponse response = getSource().accessSecretVersion(secretIdentifier);\n+\t\t\treturn response.getPayload().getData();\n+\t\t}\n+\t\tcatch (NotFoundException e) {\n+\t\t\treturn null;\n+\t\t}\n \t}\n \n-\tprivate static Map<String, Object> createSecretsPropertiesMap(\n-\t\t\tSecretManagerServiceClient client, String projectId, String secretsPrefix, Map<String, String> versions) {\n-\n-\t\tListSecretsPagedResponse response = client.listSecrets(ProjectName.of(projectId));\n-\t\tMap<String, Object> secretsMap = new HashMap<>();\n-\t\tfor (Secret secret : response.iterateAll()) {\n-\t\t\tString secretId = extractSecretId(secret);\n-\t\t\tByteString secretPayload = getSecretPayload(client, projectId, secretId, versions);\n-\t\t\tif (secretPayload != null) {\n-\t\t\t\tsecretsMap.put(secretsPrefix + secretId, secretPayload);\n-\t\t\t}\n+\tstatic SecretVersionName parseFromProperty(String property, GcpProjectIdProvider projectIdProvider) {\n+\t\tif (!property.startsWith(GCP_SECRET_PREFIX)) {\n+\t\t\treturn null;\n \t\t}\n \n-\t\treturn secretsMap;\n-\t}\n+\t\tString resourcePath = property.substring(GCP_SECRET_PREFIX.length());\n+\t\tString[] tokens = resourcePath.split(\"/\");\n \n-\tprivate static ByteString getSecretPayload(\n-\t\t\tSecretManagerServiceClient client,\n-\t\t\tString projectId,\n-\t\t\tString secretId,\n-\t\t\tMap<String, String> versions) {\n+\t\tString projectId = projectIdProvider.getProjectId();\n+\t\tString secretId = null;\n+\t\tString version = \"latest\";\n \n-\t\tString version = versions.containsKey(secretId) ? versions.get(secretId) : LATEST_VERSION_STRING;\n+\t\tif (tokens.length == 1) {\n+\t\t\t// property is form \"gcp-secret/<secret-id>\"\n+\t\t\tsecretId = tokens[0];\n+\t\t}\n+\t\telse if (tokens.length == 2) {\n+\t\t\t// property is form \"gcp-secret/<secret-id>/<version>\"\n+\t\t\tsecretId = tokens[0];\n+\t\t\tversion = tokens[1];\n+\t\t}\n+\t\telse if (tokens.length == 3) {\n+\t\t\t// property is form \"gcp-secret/<project-id>/<secret-id>/<version-id>\"\n+\t\t\tprojectId = tokens[0];\n+\t\t\tsecretId = tokens[1];\n+\t\t\tversion = tokens[2];\n+\t\t}\n+\t\telse if (tokens.length == 4\n+\t\t\t\t&& tokens[0].equals(\"projects\")\n+\t\t\t\t&& tokens[2].equals(\"secrets\")) {\n+\t\t\t// property is form \"gcp-secret/projects/<project-id>/secrets/<secret-id>\"\n+\t\t\tprojectId = tokens[1];\n+\t\t\tsecretId = tokens[3];\n+\t\t}\n+\t\telse if (tokens.length == 6\n+\t\t\t\t&& tokens[0].equals(\"projects\")\n+\t\t\t\t&& tokens[2].equals(\"secrets\")\n+\t\t\t\t&& tokens[4].equals(\"versions\")) {\n+\t\t\t// property is form \"gcp-secret/projects/<project-id>/secrets/<secret-id>/versions/<version>\"\n+\t\t\tprojectId = tokens[1];\n+\t\t\tsecretId = tokens[3];\n+\t\t\tversion = tokens[5];\n+\t\t}\n+\t\telse {\n+\t\t\treturn null;", "originalCommit": "3d87209b182bbe381cc24408c4b161df2fb44b1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NDc1Mw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405164753", "bodyText": "Done.", "author": "dzou", "createdAt": "2020-04-07T23:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNzc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDUyOQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404820529", "bodyText": "Maybe add a test for just \"gcp-secret/\"?", "author": "meltsufin", "createdAt": "2020-04-07T13:45:17Z", "path": "spring-cloud-gcp-autoconfigure/src/test/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretPropertySourceTests.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n+\n+import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n+import org.junit.Test;\n+\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class SecretPropertySourceTests {\n+\n+\tprivate static final GcpProjectIdProvider DEFAULT_PROJECT_ID_PROVIDER = () -> \"defaultProject\";\n+\n+\t@Test\n+\tpublic void testNonSecret() {\n+\t\tString property = \"spring.cloud.datasource\";\n+\t\tSecretVersionName secretIdentifier =\n+\t\t\t\tSecretManagerPropertySource.parseFromProperty(property, DEFAULT_PROJECT_ID_PROVIDER);\n+\n+\t\tassertThat(secretIdentifier).isNull();\n+\t}\n+\n+\t@Test\n+\tpublic void testShortProperty_secretId() {\n+\t\tString property = \"gcp-secret/the-secret\";", "originalCommit": "3d87209b182bbe381cc24408c4b161df2fb44b1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NDc4Nw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405164787", "bodyText": "Done.", "author": "dzou", "createdAt": "2020-04-07T23:06:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMTI1OA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404821258", "bodyText": "The name doesn't match the class SecretManagerPropertySource.", "author": "meltsufin", "createdAt": "2020-04-07T13:46:17Z", "path": "spring-cloud-gcp-autoconfigure/src/test/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretPropertySourceTests.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n+\n+import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n+import org.junit.Test;\n+\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class SecretPropertySourceTests {", "originalCommit": "3d87209b182bbe381cc24408c4b161df2fb44b1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NDgwOA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405164808", "bodyText": "Done.", "author": "dzou", "createdAt": "2020-04-07T23:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMTI1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMTk5NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404821994", "bodyText": "Visible for testing?", "author": "meltsufin", "createdAt": "2020-04-07T13:47:13Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertySource.java", "diffHunk": "@@ -16,117 +16,119 @@\n \n package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n \n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.Map;\n-\n+import com.google.api.gax.rpc.NotFoundException;\n import com.google.cloud.secretmanager.v1beta1.AccessSecretVersionResponse;\n-import com.google.cloud.secretmanager.v1beta1.ProjectName;\n-import com.google.cloud.secretmanager.v1beta1.Secret;\n import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n-import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient.ListSecretsPagedResponse;\n import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n import com.google.protobuf.ByteString;\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n \n import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n import org.springframework.core.env.EnumerablePropertySource;\n \n /**\n- * Retrieves secrets from GCP Secret Manager under the current GCP project.\n+ * A property source for Secret Manager which accesses the Secret Manager APIs when {@link #getProperty} is called.\n  *\n  * @author Daniel Zou\n  * @author Edd\u00fa Mel\u00e9ndez\n  * @since 1.2.2\n  */\n public class SecretManagerPropertySource extends EnumerablePropertySource<SecretManagerServiceClient> {\n \n-\tprivate static final Log LOGGER = LogFactory.getLog(SecretManagerPropertySource.class);\n-\n-\tprivate static final String LATEST_VERSION_STRING = \"latest\";\n-\n-\tprivate final Map<String, Object> properties;\n+\tprivate static final String GCP_SECRET_PREFIX = \"gcp-secret/\";\n \n-\tprivate final String[] propertyNames;\n+\tprivate final GcpProjectIdProvider projectIdProvider;\n \n \tpublic SecretManagerPropertySource(\n \t\t\tString propertySourceName,\n \t\t\tSecretManagerServiceClient client,\n-\t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix) {\n-\t\tthis(propertySourceName, client, projectIdProvider, secretsPrefix, Collections.EMPTY_MAP);\n-\t}\n-\n-\tpublic SecretManagerPropertySource(\n-\t\t\tString propertySourceName,\n-\t\t\tSecretManagerServiceClient client,\n-\t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix,\n-\t\t\tMap<String, String> versions) {\n+\t\t\tGcpProjectIdProvider projectIdProvider) {\n \t\tsuper(propertySourceName, client);\n \n-\t\tMap<String, Object> propertiesMap = createSecretsPropertiesMap(\n-\t\t\t\tclient, projectIdProvider.getProjectId(), secretsPrefix, versions);\n+\t\tthis.projectIdProvider = projectIdProvider;\n+\t}\n \n-\t\tthis.properties = propertiesMap;\n-\t\tthis.propertyNames = propertiesMap.keySet().toArray(new String[propertiesMap.size()]);\n+\t@Override\n+\tpublic Object getProperty(String name) {\n+\t\tSecretVersionName secretIdentifier = parseFromProperty(name, this.projectIdProvider);\n+\n+\t\tif (secretIdentifier != null) {\n+\t\t\treturn getSecretPayload(secretIdentifier);\n+\t\t}\n+\t\telse {\n+\t\t\treturn null;\n+\t\t}\n \t}\n \n+\t/**\n+\t * The {@link SecretManagerPropertySource} is not enumerable, so this always returns an empty array.\n+\t * @return the empty array.\n+\t */\n \t@Override\n \tpublic String[] getPropertyNames() {\n-\t\treturn propertyNames;\n+\t\treturn new String[0];\n \t}\n \n-\t@Override\n-\tpublic Object getProperty(String name) {\n-\t\treturn properties.get(name);\n+\tprivate ByteString getSecretPayload(SecretVersionName secretIdentifier) {\n+\t\ttry {\n+\t\t\tAccessSecretVersionResponse response = getSource().accessSecretVersion(secretIdentifier);\n+\t\t\treturn response.getPayload().getData();\n+\t\t}\n+\t\tcatch (NotFoundException e) {\n+\t\t\treturn null;\n+\t\t}\n \t}\n \n-\tprivate static Map<String, Object> createSecretsPropertiesMap(\n-\t\t\tSecretManagerServiceClient client, String projectId, String secretsPrefix, Map<String, String> versions) {\n-\n-\t\tListSecretsPagedResponse response = client.listSecrets(ProjectName.of(projectId));\n-\t\tMap<String, Object> secretsMap = new HashMap<>();\n-\t\tfor (Secret secret : response.iterateAll()) {\n-\t\t\tString secretId = extractSecretId(secret);\n-\t\t\tByteString secretPayload = getSecretPayload(client, projectId, secretId, versions);\n-\t\t\tif (secretPayload != null) {\n-\t\t\t\tsecretsMap.put(secretsPrefix + secretId, secretPayload);\n-\t\t\t}\n+\tstatic SecretVersionName parseFromProperty(String property, GcpProjectIdProvider projectIdProvider) {", "originalCommit": "3d87209b182bbe381cc24408c4b161df2fb44b1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NTM2NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405165365", "bodyText": "Added comment //visible for testing; can't add annotation though, it's guava.", "author": "dzou", "createdAt": "2020-04-07T23:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMTk5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMzY0OA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r404823648", "bodyText": "Missing a test for getSecretPayload.", "author": "meltsufin", "createdAt": "2020-04-07T13:49:23Z", "path": "spring-cloud-gcp-autoconfigure/src/test/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretPropertySourceTests.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n+\n+import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n+import org.junit.Test;\n+\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class SecretPropertySourceTests {\n+\n+\tprivate static final GcpProjectIdProvider DEFAULT_PROJECT_ID_PROVIDER = () -> \"defaultProject\";\n+\n+\t@Test\n+\tpublic void testNonSecret() {\n+\t\tString property = \"spring.cloud.datasource\";\n+\t\tSecretVersionName secretIdentifier =\n+\t\t\t\tSecretManagerPropertySource.parseFromProperty(property, DEFAULT_PROJECT_ID_PROVIDER);\n+\n+\t\tassertThat(secretIdentifier).isNull();\n+\t}\n+\n+\t@Test\n+\tpublic void testShortProperty_secretId() {\n+\t\tString property = \"gcp-secret/the-secret\";\n+\t\tSecretVersionName secretIdentifier =\n+\t\t\t\tSecretManagerPropertySource.parseFromProperty(property, DEFAULT_PROJECT_ID_PROVIDER);\n+\n+\t\tassertThat(secretIdentifier.getProject()).isEqualTo(\"defaultProject\");\n+\t\tassertThat(secretIdentifier.getSecret()).isEqualTo(\"the-secret\");\n+\t\tassertThat(secretIdentifier.getSecretVersion()).isEqualTo(\"latest\");\n+\t}\n+\n+\t@Test\n+\tpublic void testShortProperty_projectSecretId() {\n+\t\tString property = \"gcp-secret/the-secret/the-version\";\n+\t\tSecretVersionName secretIdentifier =\n+\t\t\t\tSecretManagerPropertySource.parseFromProperty(property, DEFAULT_PROJECT_ID_PROVIDER);\n+\n+\t\tassertThat(secretIdentifier.getProject()).isEqualTo(\"defaultProject\");\n+\t\tassertThat(secretIdentifier.getSecret()).isEqualTo(\"the-secret\");\n+\t\tassertThat(secretIdentifier.getSecretVersion()).isEqualTo(\"the-version\");\n+\t}\n+\n+\t@Test\n+\tpublic void testShortProperty_projectSecretIdVersion() {\n+\t\tString property = \"gcp-secret/my-project/the-secret/2\";\n+\t\tSecretVersionName secretIdentifier =\n+\t\t\t\tSecretManagerPropertySource.parseFromProperty(property, DEFAULT_PROJECT_ID_PROVIDER);\n+\n+\t\tassertThat(secretIdentifier.getProject()).isEqualTo(\"my-project\");\n+\t\tassertThat(secretIdentifier.getSecret()).isEqualTo(\"the-secret\");\n+\t\tassertThat(secretIdentifier.getSecretVersion()).isEqualTo(\"2\");\n+\t}\n+\n+\t@Test\n+\tpublic void testLongProperty_projectSecret() {\n+\t\tString property = \"gcp-secret/projects/my-project/secrets/the-secret\";\n+\t\tSecretVersionName secretIdentifier =\n+\t\t\t\tSecretManagerPropertySource.parseFromProperty(property, DEFAULT_PROJECT_ID_PROVIDER);\n+\n+\t\tassertThat(secretIdentifier.getProject()).isEqualTo(\"my-project\");\n+\t\tassertThat(secretIdentifier.getSecret()).isEqualTo(\"the-secret\");\n+\t\tassertThat(secretIdentifier.getSecretVersion()).isEqualTo(\"latest\");\n+\t}\n+\n+\t@Test\n+\tpublic void testLongProperty_projectSecretVersion() {\n+\t\tString property = \"gcp-secret/projects/my-project/secrets/the-secret/versions/3\";\n+\t\tSecretVersionName secretIdentifier =\n+\t\t\t\tSecretManagerPropertySource.parseFromProperty(property, DEFAULT_PROJECT_ID_PROVIDER);\n+\n+\t\tassertThat(secretIdentifier.getProject()).isEqualTo(\"my-project\");\n+\t\tassertThat(secretIdentifier.getSecret()).isEqualTo(\"the-secret\");\n+\t\tassertThat(secretIdentifier.getSecretVersion()).isEqualTo(\"3\");\n+\t}", "originalCommit": "3d87209b182bbe381cc24408c4b161df2fb44b1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NTg3Mw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405165873", "bodyText": "We'll cover this directly in your configuration tests.\nI don't think it's worth making it non-private to write tests for it unlike the parseProperty method which had a lot more code.", "author": "dzou", "createdAt": "2020-04-07T23:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMzY0OA=="}], "type": "inlineReview"}, {"oid": "f8d5fd238652c18e527ebc76cd1a9bbc97e00724", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/f8d5fd238652c18e527ebc76cd1a9bbc97e00724", "message": "PR Comments", "committedDate": "2020-04-07T20:53:01Z", "type": "commit"}, {"oid": "231b2087389e620fabfce011e0ade54bac314d68", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/231b2087389e620fabfce011e0ade54bac314d68", "message": "update sample", "committedDate": "2020-04-07T21:11:06Z", "type": "commit"}, {"oid": "4ae2c459f121ef09d34021031822911a47cdc251", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/4ae2c459f121ef09d34021031822911a47cdc251", "message": "Fix checkstyle", "committedDate": "2020-04-07T21:17:55Z", "type": "commit"}, {"oid": "1f2060917754868815e1121c8b67916ac4f60396", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/1f2060917754868815e1121c8b67916ac4f60396", "message": "Fix sample", "committedDate": "2020-04-07T21:22:21Z", "type": "commit"}, {"oid": "f02680909f30699e39f9bf54718b379a253b2a80", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/f02680909f30699e39f9bf54718b379a253b2a80", "message": "make private visibility for sample fields", "committedDate": "2020-04-07T21:22:48Z", "type": "commit"}, {"oid": "5b01c339f347873e2151f49a387f3bcd4fc747c9", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/5b01c339f347873e2151f49a387f3bcd4fc747c9", "message": "fix tests", "committedDate": "2020-04-07T22:39:00Z", "type": "commit"}, {"oid": "f00e1c36d10185617d3f4c675ed2af477e19dd98", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/f00e1c36d10185617d3f4c675ed2af477e19dd98", "message": "add visible for testing comment", "committedDate": "2020-04-07T23:07:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUzNzY4Ng==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405537686", "bodyText": "Docs need to be updated following this change.", "author": "meltsufin", "createdAt": "2020-04-08T13:47:03Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/GcpSecretManagerBootstrapConfiguration.java", "diffHunk": "@@ -48,7 +49,7 @@\n @Configuration\n @EnableConfigurationProperties(GcpSecretManagerProperties.class)\n @ConditionalOnClass(SecretManagerServiceClient.class)\n-@ConditionalOnProperty(\"spring.cloud.gcp.secretmanager.bootstrap.enabled\")", "originalCommit": "f00e1c36d10185617d3f4c675ed2af477e19dd98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2NDg4Mg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405664882", "bodyText": "Done, updated docs.", "author": "dzou", "createdAt": "2020-04-08T16:44:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUzNzY4Ng=="}], "type": "inlineReview"}, {"oid": "32a816506706d3f565744e5d7ef72b36ce1bcad6", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/32a816506706d3f565744e5d7ef72b36ce1bcad6", "message": "documentation updates", "committedDate": "2020-04-08T16:43:48Z", "type": "commit"}, {"oid": "d54c7d62de05e664f0d6e10d5c6551ca4282786f", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/d54c7d62de05e664f0d6e10d5c6551ca4282786f", "message": "Update secret manager enabled property name.", "committedDate": "2020-04-08T17:07:19Z", "type": "commit"}, {"oid": "8b145f1f2caa7f77e814cb1df68670b3d9857fa7", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/8b145f1f2caa7f77e814cb1df68670b3d9857fa7", "message": "remove enabled property from tests", "committedDate": "2020-04-08T17:10:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMjk0Mg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405712942", "bodyText": "Unused.", "author": "meltsufin", "createdAt": "2020-04-08T18:02:54Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/GcpSecretManagerBootstrapConfiguration.java", "diffHunk": "@@ -48,7 +49,7 @@\n @Configuration\n @EnableConfigurationProperties(GcpSecretManagerProperties.class)\n @ConditionalOnClass(SecretManagerServiceClient.class)\n-@ConditionalOnProperty(\"spring.cloud.gcp.secretmanager.bootstrap.enabled\")\n+@ConditionalOnProperty(value = \"spring.cloud.gcp.secretmanager.enabled\", matchIfMissing = true)\n public class GcpSecretManagerBootstrapConfiguration {\n \n \tprivate final GcpSecretManagerProperties properties;", "originalCommit": "8b145f1f2caa7f77e814cb1df68670b3d9857fa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxODI4Mg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405818282", "bodyText": "Done.", "author": "dzou", "createdAt": "2020-04-08T21:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMjk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxODE3MQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405718171", "bodyText": "Should this move to SecretManagerTemplate? We probably want to reconsider all those additional methods for specifying project and version and use the fully qualified secret identifiers instead.", "author": "meltsufin", "createdAt": "2020-04-08T18:11:57Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/SecretManagerPropertySource.java", "diffHunk": "@@ -16,117 +16,129 @@\n \n package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n \n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.Map;\n-\n import com.google.cloud.secretmanager.v1beta1.AccessSecretVersionResponse;\n-import com.google.cloud.secretmanager.v1beta1.ProjectName;\n-import com.google.cloud.secretmanager.v1beta1.Secret;\n import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n-import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient.ListSecretsPagedResponse;\n import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n import com.google.protobuf.ByteString;\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n \n import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n import org.springframework.core.env.EnumerablePropertySource;\n+import org.springframework.util.Assert;\n+import org.springframework.util.StringUtils;\n \n /**\n- * Retrieves secrets from GCP Secret Manager under the current GCP project.\n+ * A property source for Secret Manager which accesses the Secret Manager APIs when {@link #getProperty} is called.\n  *\n  * @author Daniel Zou\n  * @author Edd\u00fa Mel\u00e9ndez\n  * @since 1.2.2\n  */\n public class SecretManagerPropertySource extends EnumerablePropertySource<SecretManagerServiceClient> {\n \n-\tprivate static final Log LOGGER = LogFactory.getLog(SecretManagerPropertySource.class);\n-\n-\tprivate static final String LATEST_VERSION_STRING = \"latest\";\n-\n-\tprivate final Map<String, Object> properties;\n+\tprivate static final String GCP_SECRET_PREFIX = \"gcp-secret/\";\n \n-\tprivate final String[] propertyNames;\n+\tprivate final GcpProjectIdProvider projectIdProvider;\n \n \tpublic SecretManagerPropertySource(\n \t\t\tString propertySourceName,\n \t\t\tSecretManagerServiceClient client,\n-\t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix) {\n-\t\tthis(propertySourceName, client, projectIdProvider, secretsPrefix, Collections.EMPTY_MAP);\n-\t}\n-\n-\tpublic SecretManagerPropertySource(\n-\t\t\tString propertySourceName,\n-\t\t\tSecretManagerServiceClient client,\n-\t\t\tGcpProjectIdProvider projectIdProvider,\n-\t\t\tString secretsPrefix,\n-\t\t\tMap<String, String> versions) {\n+\t\t\tGcpProjectIdProvider projectIdProvider) {\n \t\tsuper(propertySourceName, client);\n \n-\t\tMap<String, Object> propertiesMap = createSecretsPropertiesMap(\n-\t\t\t\tclient, projectIdProvider.getProjectId(), secretsPrefix, versions);\n+\t\tthis.projectIdProvider = projectIdProvider;\n+\t}\n+\n+\t@Override\n+\tpublic Object getProperty(String name) {\n+\t\tSecretVersionName secretIdentifier = parseFromProperty(name, this.projectIdProvider);\n \n-\t\tthis.properties = propertiesMap;\n-\t\tthis.propertyNames = propertiesMap.keySet().toArray(new String[propertiesMap.size()]);\n+\t\tif (secretIdentifier != null) {\n+\t\t\treturn getSecretPayload(secretIdentifier);\n+\t\t}\n+\t\telse {\n+\t\t\treturn null;\n+\t\t}\n \t}\n \n+\t/**\n+\t * The {@link SecretManagerPropertySource} is not enumerable, so this always returns an empty array.\n+\t * @return the empty array.\n+\t */\n \t@Override\n \tpublic String[] getPropertyNames() {\n-\t\treturn propertyNames;\n+\t\treturn new String[0];\n \t}\n \n-\t@Override\n-\tpublic Object getProperty(String name) {\n-\t\treturn properties.get(name);\n+\tprivate ByteString getSecretPayload(SecretVersionName secretIdentifier) {\n+\t\tAccessSecretVersionResponse response = getSource().accessSecretVersion(secretIdentifier);\n+\t\treturn response.getPayload().getData();\n \t}\n \n-\tprivate static Map<String, Object> createSecretsPropertiesMap(\n-\t\t\tSecretManagerServiceClient client, String projectId, String secretsPrefix, Map<String, String> versions) {\n-\n-\t\tListSecretsPagedResponse response = client.listSecrets(ProjectName.of(projectId));\n-\t\tMap<String, Object> secretsMap = new HashMap<>();\n-\t\tfor (Secret secret : response.iterateAll()) {\n-\t\t\tString secretId = extractSecretId(secret);\n-\t\t\tByteString secretPayload = getSecretPayload(client, projectId, secretId, versions);\n-\t\t\tif (secretPayload != null) {\n-\t\t\t\tsecretsMap.put(secretsPrefix + secretId, secretPayload);\n-\t\t\t}\n+\t// Visible for Testing\n+\tstatic SecretVersionName parseFromProperty(String property, GcpProjectIdProvider projectIdProvider) {", "originalCommit": "8b145f1f2caa7f77e814cb1df68670b3d9857fa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyMjMxMw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r405822313", "bodyText": "Done; I added these methods for getSecret, but for createSecret and secretExists it doesn't quite fit since those methods can accept project and secretId as valid inputs but are not fixed to a version.", "author": "dzou", "createdAt": "2020-04-08T21:21:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxODE3MQ=="}], "type": "inlineReview"}, {"oid": "2ce82cb0626e8f9d07afab84952b74b090be9f94", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/2ce82cb0626e8f9d07afab84952b74b090be9f94", "message": "PR Comments", "committedDate": "2020-04-08T19:00:49Z", "type": "commit"}, {"oid": "41c83f0d38bfe5a45f906d4e8df982ac3ed0351e", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/41c83f0d38bfe5a45f906d4e8df982ac3ed0351e", "message": "template changes + refactor", "committedDate": "2020-04-08T21:02:22Z", "type": "commit"}, {"oid": "1116fb8905b6bd3b96e10b94284e1250d928d4d3", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/1116fb8905b6bd3b96e10b94284e1250d928d4d3", "message": "secret manager prefix change to sm://", "committedDate": "2020-04-08T21:03:57Z", "type": "commit"}, {"oid": "c48a3a58c3ff64fe5b61ad13d1cababbb403607e", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/c48a3a58c3ff64fe5b61ad13d1cababbb403607e", "message": "add comments", "committedDate": "2020-04-08T21:11:04Z", "type": "commit"}, {"oid": "968e44a4c680abe0efe121122ea63b74cf374806", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/968e44a4c680abe0efe121122ea63b74cf374806", "message": "fix checkstyle", "committedDate": "2020-04-08T21:16:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ0Mjg2Ng==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r406442866", "bodyText": "Do we really need a separate method for getting by URI?\nWe can easily detect that something is a URI and do it all in the existing getSecretString(String).", "author": "meltsufin", "createdAt": "2020-04-09T19:57:14Z", "path": "spring-cloud-gcp-secretmanager/src/main/java/org/springframework/cloud/gcp/secretmanager/SecretManagerOperations.java", "diffHunk": "@@ -78,15 +94,13 @@\n \tString getSecretString(String secretId);\n \n \t/**\n-\t * Gets the secret payload of the specified {@code secretId} at version\n-\t * {@code versionName}.\n+\t * Gets the secret payload of the secret looked up by {@code secretUri}.\n \t *\n-\t * @param secretId unique identifier of your secret in Secret Manager.\n-\t * @param versionName which version of the secret to load. The version can be a version\n-\t *     number as a string (e.g. \"5\") or an alias (e.g. \"latest\").\n+\t * @param secretUri the Uri string identifying the secret.\n+\t * \t\tSee the javadoc for {@link SecretManagerOperations} for a summary of the URI syntax.\n \t * @return The secret payload as String\n \t */\n-\tString getSecretString(String secretId, String versionName);\n+\tString getSecretStringByUri(String secretUri);", "originalCommit": "968e44a4c680abe0efe121122ea63b74cf374806", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5Mzc5NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r406893794", "bodyText": "Done.", "author": "dzou", "createdAt": "2020-04-10T18:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ0Mjg2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ0Mjk1NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r406442954", "bodyText": "Same here.", "author": "meltsufin", "createdAt": "2020-04-09T19:57:24Z", "path": "spring-cloud-gcp-secretmanager/src/main/java/org/springframework/cloud/gcp/secretmanager/SecretManagerOperations.java", "diffHunk": "@@ -97,38 +111,13 @@\n \tbyte[] getSecretBytes(String secretId);\n \n \t/**\n-\t * Gets the secret payload of the specified {@code secretId} at version\n-\t * {@code versionName}.\n+\t * Gets the secret payload of the secret looked up by {@code secretUri}.\n \t *\n-\t * @param secretId unique identifier of your secret in Secret Manager.\n-\t * @param versionName which version of the secret to load. The version can be a version\n-\t *     number as a string (e.g. \"5\") or an alias (e.g. \"latest\").\n+\t * @param secretUri the Uri string identifying the secret.\n+\t * \t\tSee the javadoc for {@link SecretManagerOperations} for a summary of the URI syntax.\n \t * @return The secret payload as byte[]\n \t */\n-\tbyte[] getSecretBytes(String secretId, String versionName);\n-\n-\t/**\n-\t * Gets the secret payload of the specified {@code secretId} at version\n-\t * {@code versionName}.\n-\t *\n-\t * @param secretId unique identifier of your secret in Secret Manager.\n-\t * @param versionName which version of the secret to load. The version can be a version\n-\t *     number as a string (e.g. \"5\") or an alias (e.g. \"latest\").\n-\t * @return The secret payload as {@link ByteString}\n-\t */\n-\tByteString getSecretByteString(String secretId, String versionName);\n-\n-\t/**\n-\t * Gets the secret payload of the specified {@code secretId} at version\n-\t * {@code versionName} for a specific {@code projectId}.\n-\t *\n-\t * @param secretId unique identifier of your secret in Secret Manager.\n-\t * @param versionName which version of the secret to load. The version can be a version\n-\t *     number as a string (e.g. \"5\") or an alias (e.g. \"latest\").\n-\t * @param projectId unique identifier of your project.\n-\t * @return The secret payload as {@link ByteString}\n-\t */\n-\tByteString getSecretByteString(String secretId, String versionName, String projectId);\n+\tbyte[] getSecretBytesByUri(String secretUri);", "originalCommit": "968e44a4c680abe0efe121122ea63b74cf374806", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5Mzg0Mw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r406893843", "bodyText": "Done.", "author": "dzou", "createdAt": "2020-04-10T18:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ0Mjk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ0NDYxOA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r406444618", "bodyText": "Can we wire in the template and use it here?", "author": "meltsufin", "createdAt": "2020-04-09T20:00:38Z", "path": "spring-cloud-gcp-secretmanager/src/main/java/org/springframework/cloud/gcp/secretmanager/SecretManagerPropertySource.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.secretmanager;\n+\n+import com.google.cloud.secretmanager.v1beta1.AccessSecretVersionResponse;\n+import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n+import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n+import com.google.protobuf.ByteString;\n+\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+import org.springframework.core.env.EnumerablePropertySource;\n+\n+/**\n+ * A property source for Secret Manager which accesses the Secret Manager APIs when {@link #getProperty} is called.\n+ *\n+ * @author Daniel Zou\n+ * @author Edd\u00fa Mel\u00e9ndez\n+ * @since 1.2.2\n+ */\n+public class SecretManagerPropertySource extends EnumerablePropertySource<SecretManagerServiceClient> {\n+\n+\tprivate final GcpProjectIdProvider projectIdProvider;\n+\n+\tpublic SecretManagerPropertySource(\n+\t\t\tString propertySourceName,\n+\t\t\tSecretManagerServiceClient client,\n+\t\t\tGcpProjectIdProvider projectIdProvider) {\n+\t\tsuper(propertySourceName, client);\n+\n+\t\tthis.projectIdProvider = projectIdProvider;\n+\t}\n+\n+\t@Override\n+\tpublic Object getProperty(String name) {\n+\t\tSecretVersionName secretIdentifier =", "originalCommit": "968e44a4c680abe0efe121122ea63b74cf374806", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5Mzg2Ng==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r406893866", "bodyText": "Done.", "author": "dzou", "createdAt": "2020-04-10T18:51:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ0NDYxOA=="}], "type": "inlineReview"}, {"oid": "a81143bbd26db0ae7760e8d9aa3147565232f034", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/a81143bbd26db0ae7760e8d9aa3147565232f034", "message": "PR Comments", "committedDate": "2020-04-10T18:49:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5NzYzOQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r406897639", "bodyText": "Assert.hasText instead maybe?", "author": "meltsufin", "createdAt": "2020-04-10T19:01:05Z", "path": "spring-cloud-gcp-secretmanager/src/main/java/org/springframework/cloud/gcp/secretmanager/SecretManagerPropertyUtils.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.secretmanager;\n+\n+import com.google.cloud.secretmanager.v1beta1.SecretVersionName;\n+\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+import org.springframework.util.Assert;\n+import org.springframework.util.StringUtils;\n+\n+/**\n+ * Utilities for parsing Secret Manager properties.\n+ *\n+ * @author Daniel Zou\n+ */\n+final class SecretManagerPropertyUtils {\n+\n+\tprivate static final String GCP_SECRET_PREFIX = \"sm://\";\n+\n+\tprivate SecretManagerPropertyUtils() { }\n+\n+\tstatic SecretVersionName getSecretVersionName(String input, GcpProjectIdProvider projectIdProvider) {\n+\t\tif (!input.startsWith(GCP_SECRET_PREFIX)) {\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tString resourcePath = input.substring(GCP_SECRET_PREFIX.length());\n+\t\tString[] tokens = resourcePath.split(\"/\");\n+\n+\t\tString projectId = projectIdProvider.getProjectId();\n+\t\tString secretId = null;\n+\t\tString version = \"latest\";\n+\n+\t\tif (tokens.length == 1) {\n+\t\t\t// property is form \"sm://<secret-id>\"\n+\t\t\tsecretId = tokens[0];\n+\t\t}\n+\t\telse if (tokens.length == 2) {\n+\t\t\t// property is form \"sm://<secret-id>/<version>\"\n+\t\t\tsecretId = tokens[0];\n+\t\t\tversion = tokens[1];\n+\t\t}\n+\t\telse if (tokens.length == 3) {\n+\t\t\t// property is form \"sm://<project-id>/<secret-id>/<version-id>\"\n+\t\t\tprojectId = tokens[0];\n+\t\t\tsecretId = tokens[1];\n+\t\t\tversion = tokens[2];\n+\t\t}\n+\t\telse if (tokens.length == 4\n+\t\t\t\t&& tokens[0].equals(\"projects\")\n+\t\t\t\t&& tokens[2].equals(\"secrets\")) {\n+\t\t\t// property is form \"sm://projects/<project-id>/secrets/<secret-id>\"\n+\t\t\tprojectId = tokens[1];\n+\t\t\tsecretId = tokens[3];\n+\t\t}\n+\t\telse if (tokens.length == 6\n+\t\t\t\t&& tokens[0].equals(\"projects\")\n+\t\t\t\t&& tokens[2].equals(\"secrets\")\n+\t\t\t\t&& tokens[4].equals(\"versions\")) {\n+\t\t\t// property is form \"sm://projects/<project-id>/secrets/<secret-id>/versions/<version>\"\n+\t\t\tprojectId = tokens[1];\n+\t\t\tsecretId = tokens[3];\n+\t\t\tversion = tokens[5];\n+\t\t}\n+\t\telse {\n+\t\t\tthrow new IllegalArgumentException(\n+\t\t\t\t\t\"Unrecognized format for specifying a GCP Secret Manager secret: \" + input);\n+\t\t}\n+\n+\t\tAssert.isTrue(", "originalCommit": "a81143bbd26db0ae7760e8d9aa3147565232f034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5ODY5OA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2302#discussion_r406898698", "bodyText": "Gotcha, i'll change it.\nLet me submit this and i'll send a followup cleanup PR; some other stuff I want to cleanup too.", "author": "dzou", "createdAt": "2020-04-10T19:03:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5NzYzOQ=="}], "type": "inlineReview"}]}