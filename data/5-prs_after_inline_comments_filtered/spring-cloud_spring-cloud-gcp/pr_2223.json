{"pr_number": 2223, "pr_title": "Create AutoConfiguration for Secret Manager Template and extend sample", "pr_createdAt": "2020-02-28T22:04:12Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223", "timeline": [{"oid": "3b7543cfc9d2f5c439a37818487e68fa918bfec0", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/3b7543cfc9d2f5c439a37818487e68fa918bfec0", "message": "Finalize autoconfiguration for Secret Manager and add Sample Application", "committedDate": "2020-02-28T22:01:46Z", "type": "commit"}, {"oid": "ae8cc811db7a0281a884dbe149fb8b2ae943a1e8", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/ae8cc811db7a0281a884dbe149fb8b2ae943a1e8", "message": "Fix typos", "committedDate": "2020-02-28T22:12:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk5NjU2NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r385996565", "bodyText": "I'm having second thoughts on the separation of the template from the bootstrap configuration. The main reason being that we wanted to re-use the template in the property source implementation, and currently we don't. If we do create the SecretManagerTemplate in the boostrap, does it remain accessible to the application context? If so, I'm not sure of what the benefit would be of this separate configuration class.", "author": "meltsufin", "createdAt": "2020-02-29T03:26:31Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/GcpSecretManagerTemplateConfiguration.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n+\n+import java.io.IOException;\n+\n+import com.google.api.gax.core.CredentialsProvider;\n+import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n+import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceSettings;\n+\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.boot.context.properties.EnableConfigurationProperties;\n+import org.springframework.cloud.gcp.core.DefaultCredentialsProvider;\n+import org.springframework.cloud.gcp.core.DefaultGcpProjectIdProvider;\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+import org.springframework.cloud.gcp.core.UserAgentHeaderProvider;\n+import org.springframework.cloud.gcp.secretmanager.SecretManagerTemplate;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+\n+/**\n+ * Autoconfiguration for GCP Secret Manager which provides an instance of the\n+ * {@link SecretManagerTemplate}.\n+ *\n+ * @author Daniel Zou\n+ * @since 1.2.2\n+ */\n+@Configuration\n+@EnableConfigurationProperties(GcpSecretManagerProperties.class)\n+@ConditionalOnClass(SecretManagerServiceClient.class)\n+@ConditionalOnProperty(value = \"spring.cloud.gcp.secretmanager.template.enabled\", matchIfMissing = true)\n+public class GcpSecretManagerTemplateConfiguration {", "originalCommit": "ae8cc811db7a0281a884dbe149fb8b2ae943a1e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk5NzE2NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r385997164", "bodyText": "Also, do we want to support the use-case where someone doesn't want to use bootstrap properties but wants to use the template?\nSince loading secrets into the application context inadvertently may be risky, maybe we should even disable it by default, and the only thing you get with the starter by default, would be the template.", "author": "meltsufin", "createdAt": "2020-02-29T03:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk5NjU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ3NjQ1OA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r386476458", "bodyText": "Right, I created two separate configurations in order to support the use-case where someone doesn't want to use bootstrap properties but wants to use the template. The would be able to choose which one to disable using @ConditionalOnProperty.\nIf you want the template in the property source impl, I can add an additional @ConditionalOnMissingBean SecretManagerTemplate to the bootstrap config. Then disable the bootstrap config by default?", "author": "dzou", "createdAt": "2020-03-02T15:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk5NjU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU5NjgzMQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r386596831", "bodyText": "Resolved offline; see #2223 (comment)", "author": "dzou", "createdAt": "2020-03-02T19:19:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk5NjU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ3MjMzMg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r386472332", "bodyText": "GcpSecretManagerTemplateConfiguration and GcpSecretManagerBootstrapConfiguration end up being somewhat similar.\nI guess it's related to Mike's comment above, but possibly we should have one autoconfiguration with an optional conversion bean/property source additions that are blocked by an extra, off-by-default, property?\nIs there any harm in doing regular bean initialization during bootstrap phase if someone does opt for template-only without enabling property initialization?", "author": "elefeint", "createdAt": "2020-03-02T15:44:59Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/GcpSecretManagerTemplateConfiguration.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n+\n+import java.io.IOException;\n+\n+import com.google.api.gax.core.CredentialsProvider;\n+import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n+import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceSettings;\n+\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.boot.context.properties.EnableConfigurationProperties;\n+import org.springframework.cloud.gcp.core.DefaultCredentialsProvider;\n+import org.springframework.cloud.gcp.core.DefaultGcpProjectIdProvider;\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+import org.springframework.cloud.gcp.core.UserAgentHeaderProvider;\n+import org.springframework.cloud.gcp.secretmanager.SecretManagerTemplate;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+\n+/**\n+ * Autoconfiguration for GCP Secret Manager which provides an instance of the\n+ * {@link SecretManagerTemplate}.\n+ *\n+ * @author Daniel Zou\n+ * @since 1.2.2\n+ */\n+@Configuration\n+@EnableConfigurationProperties(GcpSecretManagerProperties.class)\n+@ConditionalOnClass(SecretManagerServiceClient.class)\n+@ConditionalOnProperty(value = \"spring.cloud.gcp.secretmanager.template.enabled\", matchIfMissing = true)\n+public class GcpSecretManagerTemplateConfiguration {\n+\n+\tprivate final GcpSecretManagerProperties properties;\n+\n+\tprivate final CredentialsProvider credentialsProvider;\n+\n+\tprivate final GcpProjectIdProvider gcpProjectIdProvider;\n+\n+\tpublic GcpSecretManagerTemplateConfiguration(", "originalCommit": "ae8cc811db7a0281a884dbe149fb8b2ae943a1e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ3ODU3OQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r386478579", "bodyText": "Ohh I see, yes we can keep all beans in one configuration. I just created two because I wasn't sure if you could activate/deactivate beans by property as well.\nSo I could add a @ConditionalOnProperty to a bean definition?", "author": "dzou", "createdAt": "2020-03-02T15:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ3MjMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU5NjYxNg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r386596616", "bodyText": "Discussed offline with @meltsufin; see: #2223 (comment)", "author": "dzou", "createdAt": "2020-03-02T19:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ3MjMzMg=="}], "type": "inlineReview"}, {"oid": "c830a5ce59eadbb3ad944a4561f90fa7f7b487b7", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/c830a5ce59eadbb3ad944a4561f90fa7f7b487b7", "message": "PR Comments", "committedDate": "2020-03-02T19:16:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU5Nzk1NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r386597955", "bodyText": "The redirect makes it hard to tell that something actually happened.\nMaybe just return a message like \"Secret created\".\nYou can of course also just use the ModelAndView with an additional \"message\" argument for this endpoint and the one above, but that's a bit more fancy.", "author": "meltsufin", "createdAt": "2020-03-02T19:21:15Z", "path": "spring-cloud-gcp-samples/spring-cloud-gcp-secretmanager-sample/src/main/java/com/example/SecretManagerWebController.java", "diffHunk": "@@ -18,30 +18,50 @@\n \n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.cloud.gcp.secretmanager.SecretManagerTemplate;\n import org.springframework.core.env.Environment;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.ModelMap;\n import org.springframework.web.bind.annotation.GetMapping;\n-import org.springframework.web.bind.annotation.RestController;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+import org.springframework.web.servlet.ModelAndView;\n \n-@RestController\n-public class WebController {\n+@Controller\n+public class SecretManagerWebController {\n \n \t@Autowired\n \tprivate Environment environment;\n \n \t@Autowired\n \tprivate MyAppProperties properties;\n \n+\t@Autowired\n+\tprivate SecretManagerTemplate secretManagerTemplate;\n+\n \t// Application secrets can be accessed using @Value and passing in the secret name.\n \t// Note that the secret name is prefixed with \"secrets\" because of the prefix setting in\n \t// bootstrap.properties.\n \t@Value(\"${secrets.application-secret}\")\n \tprivate String applicationSecretValue;\n \n \t@GetMapping(\"/\")\n-\tpublic String getRoot() {\n-\t\t// In practice, you never want to print your secrets as plaintext.\n-\t\treturn \"<h1>Secret Manager Sample Application</h1>\"\n-\t\t\t\t+ \"The secret property is: \" + properties.getApplicationSecret() + \"<br/>\"\n-\t\t\t\t+ \"You can also access secrets using @Value: \" + applicationSecretValue + \"<br/>\";\n+\tpublic ModelAndView renderIndex(ModelMap map) {\n+\t\tmap.put(\"applicationSecret\", this.applicationSecretValue);\n+\t\treturn new ModelAndView(\"index.html\", map);\n+\t}\n+\n+\t@GetMapping(\"/getSecret\")\n+\t@ResponseBody\n+\tpublic String getSecret(@RequestParam String secretId, ModelMap map) {\n+\t\tString secretPayload = this.secretManagerTemplate.getSecretString(secretId);\n+\t\treturn \"Secret ID: \" + secretId + \" | Value: \" + secretPayload;\n+\t}\n+\n+\t@PostMapping(\"/createSecret\")\n+\tpublic String createSecret(@RequestParam String secretId, @RequestParam String secretPayload) {\n+\t\tthis.secretManagerTemplate.createSecret(secretId, secretPayload);\n+\t\treturn \"redirect:/\";", "originalCommit": "c830a5ce59eadbb3ad944a4561f90fa7f7b487b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwNjIxNQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r386606215", "bodyText": "Done. Went with the additional param approach.", "author": "dzou", "createdAt": "2020-03-02T19:36:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU5Nzk1NQ=="}], "type": "inlineReview"}, {"oid": "bacabd32c57296d0060b2e2e5414456d0aa45708", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/bacabd32c57296d0060b2e2e5414456d0aa45708", "message": "Polish Sample", "committedDate": "2020-03-02T19:35:51Z", "type": "commit"}]}