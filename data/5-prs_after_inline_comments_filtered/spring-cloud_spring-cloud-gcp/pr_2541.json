{"pr_number": 2541, "pr_title": "Add query methods that return Slice to DatastoreTemplate to allow pagination", "pr_createdAt": "2020-10-06T22:45:51Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541", "timeline": [{"oid": "d23c1e96ad4328ec3e0ef4fc91f0c9ebac56ed07", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/d23c1e96ad4328ec3e0ef4fc91f0c9ebac56ed07", "message": "add DatastoreNextPageAwareResultsIterable", "committedDate": "2020-10-06T22:44:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzODMwMw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r501138303", "bodyText": "Copyright 2017-2020", "author": "dzou", "createdAt": "2020-10-07T16:12:36Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreNextPageAwareResultsIterable.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2019-2019 the original author or authors.", "originalCommit": "d23c1e96ad4328ec3e0ef4fc91f0c9ebac56ed07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE1MjgwMw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r501152803", "bodyText": "I don't think this is quite the right approach; it seems a bit heavyweight to create a new class to hold a boolean.\nAlso the only method that returns this is nextPageAwareQuery; however, other query methods such as query, queryIterable, and queryByExample also return DatastoreResultsIterable but are not able to take advantage of the next-page-aware feature.\nI would try to get DatastoreResultsIterable to have access to the hasNextPage somehow.\nI would suggest a couple alternatives:\n\n\nIs it possible to add a method to DatastoreTemplate like hasNextPage(Cursor c) or hasNextPage(DatastoreResultsIterable i)? if so, the user can manually check for next page through usage of template.\n\n\nIf the query is cheap, you might as well pay the cost of nextPageExists(..) for each DatastoreResultsIterable; and build the hasNextPage parameter in there. no need for premature optimization\n\n\nAdd a method called hasNextPage() on the DatastoreResultsIterable which will run the query of checking if the cursor has a next page. This would require the Iterable obj have reference to the datastore client I suppose.", "author": "dzou", "createdAt": "2020-10-07T16:34:07Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreNextPageAwareResultsIterable.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2019-2019 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.data.datastore.core;\n+\n+import java.util.Iterator;\n+\n+import com.google.cloud.datastore.Cursor;\n+\n+/**\n+ * An iterable that contains a cursor for the next page and can be used to determine\n+ * if the next page exists.\n+ *\n+ * @author Dmitry Solomakha\n+ */\n+public class DatastoreNextPageAwareResultsIterable<T> implements Iterable<T> {", "originalCommit": "d23c1e96ad4328ec3e0ef4fc91f0c9ebac56ed07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIzMjMwNg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r501232306", "bodyText": "+1\nCan we just extend DatastoreResultsIterable?", "author": "meltsufin", "createdAt": "2020-10-07T18:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE1MjgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIzMzg1MQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r501233851", "bodyText": "Can we just move this code to hasNextPage in the Iterable?", "author": "meltsufin", "createdAt": "2020-10-07T18:44:24Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreTemplate.java", "diffHunk": "@@ -276,6 +277,21 @@ public long count(Class<?> entityClass) {\n \t\treturn resultsIterable;\n \t}\n \n+\t@Override\n+\tpublic <T> DatastoreNextPageAwareResultsIterable<?> nextPageAwareQuery(StructuredQuery query, Class<T> entityClass) {\n+\t\tDatastoreResultsIterable resultsIterable = queryKeysOrEntities(query, entityClass);\n+\n+\t\treturn new DatastoreNextPageAwareResultsIterable(resultsIterable, nextPageExists(query, resultsIterable.getCursor()));\n+\t}\n+\n+\tprivate boolean nextPageExists(StructuredQuery query, Cursor cursorAfter) {", "originalCommit": "d23c1e96ad4328ec3e0ef4fc91f0c9ebac56ed07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4ODI2OQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r501988269", "bodyText": "Same question as before.", "author": "meltsufin", "createdAt": "2020-10-08T20:18:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIzMzg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIzNTE1NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r501235154", "bodyText": "You can just return here without assigning to pageable.", "author": "meltsufin", "createdAt": "2020-10-07T18:46:47Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -248,21 +248,19 @@ private Slice executeSliceQuery(Object[] parameters) {\n \t\tStructuredQuery.Builder builder = getEntityOrProjectionQueryBuilder()\n \t\t\t\t.setKind(this.datastorePersistentEntity.kindName());\n \t\tStructuredQuery query = applyQueryBody(parameters, builder, false, false, null);\n-\t\tDatastoreResultsIterable<?> resultList = this.datastoreOperations.queryKeysOrEntities(query, this.entityType);\n-\n-\t\tParameterAccessor paramAccessor = new ParametersParameterAccessor(getQueryMethod().getParameters(), parameters);\n-\n-\t\tPageable pageable = DatastorePageable.from(paramAccessor.getPageable(), resultList.getCursor(), null);\n-\n-\t\tEntityQuery.Builder builderNext = newEntityQueryBuilder().setKind(this.datastorePersistentEntity.kindName());\n-\t\tStructuredQuery queryNext = applyQueryBody(parameters, builderNext, false, true, resultList.getCursor());\n-\t\tIterable nextResult = this.datastoreOperations.query(queryNext, x -> x);\n+\t\tDatastoreNextPageAwareResultsIterable<?> results = this.datastoreOperations.nextPageAwareQuery(query, this.entityType);\n \n \t\tList<Object> result =\n-\t\t\t\t\t\tStreamSupport.stream(resultList.spliterator(), false).collect(Collectors.toList());\n+\t\t\t\tStreamSupport.stream(results.spliterator(), false).collect(Collectors.toList());\n \n \t\treturn (Slice) this.processRawObjectForProjection(\n-\t\t\t\tnew SliceImpl(result, pageable, nextResult.iterator().hasNext()));\n+\t\t\t\tnew SliceImpl(result, getPageable(parameters, results.getCursor()), results.hasNextPage()));\n+\t}\n+\n+\tprivate Pageable getPageable(Object[] parameters, Cursor cursor) {\n+\t\tParameterAccessor paramAccessor = new ParametersParameterAccessor(getQueryMethod().getParameters(), parameters);\n+\t\tPageable pageable = DatastorePageable.from(paramAccessor.getPageable(), cursor, null);", "originalCommit": "d23c1e96ad4328ec3e0ef4fc91f0c9ebac56ed07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b3e46900e24604dda5e6d78a8ff293cdf2941e54", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/b3e46900e24604dda5e6d78a8ff293cdf2941e54", "message": "PR comments", "committedDate": "2020-10-08T19:34:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4NjIwNA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r501986204", "bodyText": "why not just\npublic boolean hasNextPage()?", "author": "meltsufin", "createdAt": "2020-10-08T20:14:31Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreResultsIterable.java", "diffHunk": "@@ -50,4 +61,20 @@ public Cursor getCursor() {\n \tpublic Iterable<T> getIterable() {\n \t\treturn this.iterable;\n \t}\n+\n+\tpublic Optional<Boolean> getHasNextPage() {", "originalCommit": "b3e46900e24604dda5e6d78a8ff293cdf2941e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxMzgzOQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r502013839", "bodyText": "@meltsufin Because it is not always there. We can only compute it for StructuredQuery queries, and we can't compute it for GQL queries. So we need to represent 3 values - true, false, empty.", "author": "dmitry-s", "createdAt": "2020-10-08T21:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4NjIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUyOTM1MQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r502529351", "bodyText": "@dmitry-s I must be missing something here. Both, GqlQuery and StructuredQuery, support cursors. So, I would image that it's possible to try to retrieve the next item using the cursor to determine hasNext(). How are they different in this respect?\nAlso, if there is a fundamental difference, then we should probably have two different classes for their results. So, maybe extend DatastoreResultsIterable and add hasNextPage()?", "author": "meltsufin", "createdAt": "2020-10-09T16:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4NjIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjYzMDg2NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r502630864", "bodyText": "The problem with GqlQuery is we need to set limit to 1 to avoid fetching the whole next page, and GqlQuery doesn't allow to change that.", "author": "dmitry-s", "createdAt": "2020-10-09T19:26:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4NjIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQwMzQ2NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r503403464", "bodyText": "So, for GqlQuery we would need to fetch the whole page? Is there a problem with that other than the potential performance overhead?", "author": "meltsufin", "createdAt": "2020-10-12T16:22:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4NjIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4Njg0MQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r501986841", "bodyText": "I don't think a public setter makes sense here. Can you just provide all the necessary objects to determine hasNextPage into the constructor?", "author": "meltsufin", "createdAt": "2020-10-08T20:15:46Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreResultsIterable.java", "diffHunk": "@@ -50,4 +61,20 @@ public Cursor getCursor() {\n \tpublic Iterable<T> getIterable() {\n \t\treturn this.iterable;\n \t}\n+\n+\tpublic Optional<Boolean> getHasNextPage() {\n+\t\treturn hasNextPage.get();\n+\t}\n+\n+\tpublic void setHasNextPageQuery(Supplier<Boolean> query) {", "originalCommit": "b3e46900e24604dda5e6d78a8ff293cdf2941e54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4NzU4NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r501987585", "bodyText": "Instead of calling setHasNextPageQuery can this block of code just move to DatastoreResultsIterable?\nAlso, why does this only apply to StructuredQuery?", "author": "meltsufin", "createdAt": "2020-10-08T20:17:21Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreTemplate.java", "diffHunk": "@@ -272,10 +273,25 @@ public long count(Class<?> entityClass) {\n \t\t\tresultsIterable = new DatastoreResultsIterable<>(convertEntitiesForRead(results, entityClass),\n \t\t\t\t\tresults.getCursorAfter());\n \t\t}\n+\t\tif (query instanceof StructuredQuery) {\n+\t\t\tresultsIterable.setHasNextPageQuery(", "originalCommit": "b3e46900e24604dda5e6d78a8ff293cdf2941e54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bd562d4c960f80db14ee7b3cbe1d8831eff392af", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/bd562d4c960f80db14ee7b3cbe1d8831eff392af", "message": "Merge branch 'master' of github.com:spring-cloud/spring-cloud-gcp into datastore-iterable-nextpage", "committedDate": "2020-10-08T21:51:52Z", "type": "commit"}, {"oid": "b879f14210745398ae7ed33992b71a056a834dc5", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/b879f14210745398ae7ed33992b71a056a834dc5", "message": "PR comments", "committedDate": "2020-10-13T12:14:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3NTEwNA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r504375104", "bodyText": "Never used.", "author": "meltsufin", "createdAt": "2020-10-14T03:14:50Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreNextPageAwareResultsIterable.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2017-2019 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.data.datastore.core;\n+\n+import java.util.Iterator;\n+\n+import com.google.cloud.datastore.Cursor;\n+import com.google.cloud.datastore.StructuredQuery;\n+\n+import org.springframework.data.util.Lazy;\n+\n+public class DatastoreNextPageAwareResultsIterable<T> implements DatastoreResultsIterable<T> {\n+\tprivate DatastoreResultsIterable datastoreResultsIterable;\n+\n+\tprivate Cursor cursor;", "originalCommit": "b879f14210745398ae7ed33992b71a056a834dc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3NTU0Mw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r504375543", "bodyText": "DatastoreStructuredQueryResultsIterable maybe?", "author": "meltsufin", "createdAt": "2020-10-14T03:16:28Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreNextPageAwareResultsIterable.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2017-2019 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.data.datastore.core;\n+\n+import java.util.Iterator;\n+\n+import com.google.cloud.datastore.Cursor;\n+import com.google.cloud.datastore.StructuredQuery;\n+\n+import org.springframework.data.util.Lazy;\n+\n+public class DatastoreNextPageAwareResultsIterable<T> implements DatastoreResultsIterable<T> {", "originalCommit": "b879f14210745398ae7ed33992b71a056a834dc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3NTY4Mg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r504375682", "bodyText": "Please add class-level javadoc and @since 1.2.6.", "author": "meltsufin", "createdAt": "2020-10-14T03:17:01Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreNextPageAwareResultsIterable.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2017-2019 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.data.datastore.core;\n+\n+import java.util.Iterator;\n+\n+import com.google.cloud.datastore.Cursor;\n+import com.google.cloud.datastore.StructuredQuery;\n+\n+import org.springframework.data.util.Lazy;\n+\n+public class DatastoreNextPageAwareResultsIterable<T> implements DatastoreResultsIterable<T> {", "originalCommit": "b879f14210745398ae7ed33992b71a056a834dc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3NTgzMw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r504375833", "bodyText": "Never used.", "author": "meltsufin", "createdAt": "2020-10-14T03:17:29Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreNextPageAwareResultsIterable.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2017-2019 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.data.datastore.core;\n+\n+import java.util.Iterator;\n+\n+import com.google.cloud.datastore.Cursor;\n+import com.google.cloud.datastore.StructuredQuery;\n+\n+import org.springframework.data.util.Lazy;\n+\n+public class DatastoreNextPageAwareResultsIterable<T> implements DatastoreResultsIterable<T> {\n+\tprivate DatastoreResultsIterable datastoreResultsIterable;\n+\n+\tprivate Cursor cursor;\n+\n+\tprivate StructuredQuery structuredQuery;", "originalCommit": "b879f14210745398ae7ed33992b71a056a834dc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3NzM5Mw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r504377393", "bodyText": "Javadoc missing\nqueryHasNextPage maybe?", "author": "meltsufin", "createdAt": "2020-10-14T03:23:16Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreTemplate.java", "diffHunk": "@@ -266,16 +267,28 @@ public long count(Class<?> entityClass) {\n \t\tQueryResults results = getDatastoreReadWriter().run(query);\n \t\tDatastoreResultsIterable resultsIterable;\n \t\tif (results.getResultClass() == Key.class) {\n-\t\t\tresultsIterable = new DatastoreResultsIterable(results, results.getCursorAfter());\n+\t\t\tresultsIterable = new DatastoreSimpleResultsIterable(results, results.getCursorAfter());\n \t\t}\n \t\telse {\n-\t\t\tresultsIterable = new DatastoreResultsIterable<>(convertEntitiesForRead(results, entityClass),\n+\t\t\tresultsIterable = new DatastoreSimpleResultsIterable<>(convertEntitiesForRead(results, entityClass),\n \t\t\t\t\tresults.getCursorAfter());\n \t\t}\n+\t\tif (query instanceof StructuredQuery) {\n+\t\t\tresultsIterable = new DatastoreNextPageAwareResultsIterable(\n+\t\t\t\t\tresultsIterable, results.getCursorAfter(), (StructuredQuery) query, this);\n+\t\t}\n \t\tmaybeEmitEvent(new AfterQueryEvent(resultsIterable, query));\n \t\treturn resultsIterable;\n \t}\n \n+\tpublic boolean nextPageExists(StructuredQuery query, Cursor cursorAfter) {", "originalCommit": "b879f14210745398ae7ed33992b71a056a834dc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3ODMzNw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r504378337", "bodyText": "I don't think you're gaining much by delegating to another iterable. I would just use the currently unused instance variables instead.", "author": "meltsufin", "createdAt": "2020-10-14T03:26:33Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreNextPageAwareResultsIterable.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2017-2019 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.data.datastore.core;\n+\n+import java.util.Iterator;\n+\n+import com.google.cloud.datastore.Cursor;\n+import com.google.cloud.datastore.StructuredQuery;\n+\n+import org.springframework.data.util.Lazy;\n+\n+public class DatastoreNextPageAwareResultsIterable<T> implements DatastoreResultsIterable<T> {\n+\tprivate DatastoreResultsIterable datastoreResultsIterable;", "originalCommit": "b879f14210745398ae7ed33992b71a056a834dc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3ODQ2MA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r504378460", "bodyText": "javadoc missing", "author": "meltsufin", "createdAt": "2020-10-14T03:26:54Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreSimpleResultsIterable.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2017-2019 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.data.datastore.core;\n+\n+import java.util.Iterator;\n+\n+import com.google.cloud.datastore.Cursor;\n+\n+public class DatastoreSimpleResultsIterable<T> implements DatastoreResultsIterable<T> {", "originalCommit": "b879f14210745398ae7ed33992b71a056a834dc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3OTI4MQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r504379281", "bodyText": "Does it make sense to make SliceImpl also evaluate hasNext() lazily?", "author": "meltsufin", "createdAt": "2020-10-14T03:30:13Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -245,24 +245,25 @@ private String mapToFieldName(PropertyDescriptor propertyDescriptor) {\n \t}\n \n \tprivate Slice executeSliceQuery(Object[] parameters) {\n+\t\tDatastoreNextPageAwareResultsIterable<?> results =\n+\t\t\t\t(DatastoreNextPageAwareResultsIterable<?>)\n+\t\t\t\t\t\tthis.datastoreOperations.queryKeysOrEntities(buildSliceQuey(parameters), this.entityType);\n+\n+\t\treturn (Slice) this.processRawObjectForProjection(\n+\t\t\t\tnew SliceImpl(results.toList(),\n+\t\t\t\t\t\tgetPageable(parameters, results.getCursor()),\n+\t\t\t\t\t\tresults.hasNextPage()));", "originalCommit": "b879f14210745398ae7ed33992b71a056a834dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4Nzg5MA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r504987890", "bodyText": "It is a Spring Data class and expects a boolean parameter.", "author": "dmitry-s", "createdAt": "2020-10-14T21:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3OTI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTExMTg4OQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r505111889", "bodyText": "Can we extend SliceImpl?", "author": "meltsufin", "createdAt": "2020-10-15T01:30:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3OTI4MQ=="}], "type": "inlineReview"}, {"oid": "6381db8928e532b067a5e14e37b66b70d85becb1", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/6381db8928e532b067a5e14e37b66b70d85becb1", "message": "PR comments", "committedDate": "2020-10-15T22:22:23Z", "type": "commit"}, {"oid": "16a9010be49dd26277edfa359322d0921d012b30", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/16a9010be49dd26277edfa359322d0921d012b30", "message": "PR comments", "committedDate": "2020-10-15T22:25:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4MTI0MQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r505981241", "bodyText": "Can you clarify which type to specify for key?", "author": "meltsufin", "createdAt": "2020-10-16T02:02:13Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreOperations.java", "diffHunk": "@@ -272,11 +275,31 @@\n \t/**\n \t * Finds objects by using a Cloud Datastore query. If the query is a key-query, then keys are\n \t * returned.\n+\t * Resulting Slice can be used to get a Pageable for the next page or to determine if next page exists.\n \t * @param query the query to execute.\n \t * @param entityClass the type of object to retrieve.", "originalCommit": "16a9010be49dd26277edfa359322d0921d012b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4MTc3Ng==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r505981776", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Resulting Slice can be used to get a Pageable for the next page or to determine if next page exists.\n          \n          \n            \n            \t * Resulting Slice can be used to get a Pageable for the next page or to determine if next the page exists.", "author": "meltsufin", "createdAt": "2020-10-16T02:03:35Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreOperations.java", "diffHunk": "@@ -272,11 +275,31 @@\n \t/**\n \t * Finds objects by using a Cloud Datastore query. If the query is a key-query, then keys are\n \t * returned.\n+\t * Resulting Slice can be used to get a Pageable for the next page or to determine if next page exists.", "originalCommit": "16a9010be49dd26277edfa359322d0921d012b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4MjgyNA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r505982824", "bodyText": "Do we still need this method, since Slice has hasNextPage()?", "author": "meltsufin", "createdAt": "2020-10-16T02:06:13Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreOperations.java", "diffHunk": "@@ -272,11 +275,31 @@\n \t/**\n \t * Finds objects by using a Cloud Datastore query. If the query is a key-query, then keys are\n \t * returned.\n+\t * Resulting Slice can be used to get a Pageable for the next page or to determine if next page exists.\n \t * @param query the query to execute.\n \t * @param entityClass the type of object to retrieve.\n+\t * @param pageable that indicates page number and page size\n \t * @param <T> the type of object to retrieve.\n-\t * @return a list of the objects found. If no keys could be found the list will be\n-\t * empty.\n+\t * @return a Slice containing found objects\n+\t */\n+\t<T> Slice<?> queryKeysOrEntitiesSlice(StructuredQuery query, Class<T> entityClass, Pageable pageable);\n+\n+\t/**\n+\t * Runs a query that checks if there is at least one entry after the cursor.\n+\t *\n+\t * @param query the query that returned the cursor\n+\t * @param cursorAfter the cursor\n+\t * @return true if next page exists for the given query and cursor\n+\t */\n+\tboolean nextPageExists(StructuredQuery query, Cursor cursorAfter);", "originalCommit": "16a9010be49dd26277edfa359322d0921d012b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDY2Mw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r505984663", "bodyText": "Can we extend SliceImpl such that hasNextPage() is lazy?\nFeel free to leave for another PR though.", "author": "meltsufin", "createdAt": "2020-10-16T02:10:09Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreTemplate.java", "diffHunk": "@@ -261,6 +266,32 @@ public long count(Class<?> entityClass) {\n \t\t\t\t: null;\n \t}\n \n+\t@Override\n+\tpublic <T> Slice<?> queryKeysOrEntitiesSlice(StructuredQuery query, Class<T> entityClass, Pageable pageable) {\n+\t\tDatastoreResultsIterable<?> results = queryKeysOrEntities(applyPageable(query, pageable), entityClass);\n+\t\treturn new SliceImpl<>(results.toList(),", "originalCommit": "16a9010be49dd26277edfa359322d0921d012b30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQxODIxMg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r506418212", "bodyText": "I don't think it is necessary because if you don't need  hasNextPage(), you could just use the queryKeysOrEntities method instead.", "author": "dmitry-s", "createdAt": "2020-10-16T13:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ2NzI5NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r506467294", "bodyText": "What about the use in repositories?", "author": "meltsufin", "createdAt": "2020-10-16T14:09:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NzkzOA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r505987938", "bodyText": "Can you remind me, what is the benefit of combining queryEntities() and queryKeys() into one method?\nSonar is identifying this as a \"code smell\".", "author": "meltsufin", "createdAt": "2020-10-16T02:16:24Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreOperations.java", "diffHunk": "@@ -272,11 +275,31 @@\n \t/**\n \t * Finds objects by using a Cloud Datastore query. If the query is a key-query, then keys are\n \t * returned.\n+\t * Resulting Slice can be used to get a Pageable for the next page or to determine if next page exists.\n \t * @param query the query to execute.\n \t * @param entityClass the type of object to retrieve.\n+\t * @param pageable that indicates page number and page size\n \t * @param <T> the type of object to retrieve.\n-\t * @return a list of the objects found. If no keys could be found the list will be\n-\t * empty.\n+\t * @return a Slice containing found objects\n+\t */\n+\t<T> Slice<?> queryKeysOrEntitiesSlice(StructuredQuery query, Class<T> entityClass, Pageable pageable);", "originalCommit": "16a9010be49dd26277edfa359322d0921d012b30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQyNDU1NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r506424554", "bodyText": "The code would be identical for these cases, so we are avoiding duplication this way.", "author": "dmitry-s", "createdAt": "2020-10-16T13:31:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NzkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ0NTQwMg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r506445402", "bodyText": "Let me see if I can refactor it to avoid duplication.", "author": "dmitry-s", "createdAt": "2020-10-16T13:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NzkzOA=="}], "type": "inlineReview"}, {"oid": "600da902b69358aa181dc7161cd6f67f365ae6cb", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/600da902b69358aa181dc7161cd6f67f365ae6cb", "message": "PR comments", "committedDate": "2020-10-16T14:06:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ3NDcxMw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r506474713", "bodyText": "Why don't you check for those types in the condition then? What if other query types are added in the future?", "author": "meltsufin", "createdAt": "2020-10-16T14:17:11Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreTemplate.java", "diffHunk": "@@ -267,8 +268,21 @@ public long count(Class<?> entityClass) {\n \t}\n \n \t@Override\n-\tpublic <T> Slice<?> queryKeysOrEntitiesSlice(StructuredQuery query, Class<T> entityClass, Pageable pageable) {\n-\t\tDatastoreResultsIterable<?> results = queryKeysOrEntities(applyPageable(query, pageable), entityClass);\n+\tpublic <T> Slice<Key> queryKeysSlice(KeyQuery query, Class<T> entityClass, Pageable pageable) {\n+\t\treturn buildSlice(query, pageable, Key.class);\n+\t}\n+\n+\t@Override\n+\tpublic <T> Slice<T> queryEntitiesSlice(StructuredQuery query, Class<T> entityClass, Pageable pageable) {\n+\t\tif (query instanceof KeyQuery) {\n+\t\t\tthrow new DatastoreDataException(\"query must be an EntityQuery or a ProjectionEntityQuery\");", "originalCommit": "600da902b69358aa181dc7161cd6f67f365ae6cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ3NjQxOQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r506476419", "bodyText": "Can we also deprecate this method and bifurcate it like you did for Slice? This can be in a separate PR.", "author": "meltsufin", "createdAt": "2020-10-16T14:19:15Z", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreOperations.java", "diffHunk": "@@ -269,14 +272,35 @@\n \t */\n \tDatastoreEntityConverter getDatastoreEntityConverter();\n \n+\t/**\n+\t * Finds keys by using a Cloud Datastore query.\n+\t * Resulting Slice can be used to get a Pageable for the next page or to determine if the next page exists.\n+\t * @param query the query to execute.\n+\t * @param entityClass the type of object to retrieve.\n+\t * @param pageable that indicates page number and page size\n+\t * @param <T> the type of object to retrieve.\n+\t * @return a Slice containing found objects\n+\t */\n+\t<T> Slice<Key> queryKeysSlice(KeyQuery query, Class<T> entityClass, Pageable pageable);\n+\n+\t/**\n+\t * Finds entities by using a Cloud Datastore query.\n+\t * Resulting Slice can be used to get a Pageable for the next page or to determine if the next page exists.\n+\t * @param query the query to execute.\n+\t * @param entityClass the type of object to retrieve.\n+\t * @param pageable that indicates page number and page size\n+\t * @param <T> the type of object to retrieve.\n+\t * @return a Slice containing found objects\n+\t */\n+\t<T> Slice<T> queryEntitiesSlice(StructuredQuery query, Class<T> entityClass, Pageable pageable);\n+\n \t/**\n \t * Finds objects by using a Cloud Datastore query. If the query is a key-query, then keys are\n \t * returned.\n \t * @param query the query to execute.\n \t * @param entityClass the type of object to retrieve.\n \t * @param <T> the type of object to retrieve.\n-\t * @return a list of the objects found. If no keys could be found the list will be\n-\t * empty.\n+\t * @return an iterable containing found objects and a cursor\n \t */\n \t<T> DatastoreResultsIterable<?> queryKeysOrEntities(Query query, Class<T> entityClass);", "originalCommit": "600da902b69358aa181dc7161cd6f67f365ae6cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcwMTM0NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2541#discussion_r506701344", "bodyText": "created an issue: #2559", "author": "dmitry-s", "createdAt": "2020-10-16T20:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ3NjQxOQ=="}], "type": "inlineReview"}, {"oid": "0e9887a14bf443a3cd1ac0004c26808397ead967", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/0e9887a14bf443a3cd1ac0004c26808397ead967", "message": "PR comments", "committedDate": "2020-10-16T19:57:14Z", "type": "commit"}]}