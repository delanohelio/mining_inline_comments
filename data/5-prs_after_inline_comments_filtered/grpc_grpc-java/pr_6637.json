{"pr_number": 6637, "pr_title": "core, grpclb: change policy selection strategy for Grpclb policy (take one: eliminate special logic for deciding grpclb policy in core)", "pr_createdAt": "2020-01-24T09:30:11Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6637", "timeline": [{"oid": "5ca8054a00c3f5614a98b4293c6a24dd97b69c7c", "url": "https://github.com/grpc/grpc-java/commit/5ca8054a00c3f5614a98b4293c6a24dd97b69c7c", "message": "Change DNS resolver to return balancer addresses as attributes of resolution result. Change AutoConfiguredLoadBalancerFactory to choose LB policy purely based on lb policy config in service config. GrpclbLoadBalancer populates balancer address from attributes instead of from addresses.", "committedDate": "2020-01-24T09:28:10Z", "type": "commit"}, {"oid": "c090767035fdce2da6f135b61d181516bc6cf96f", "url": "https://github.com/grpc/grpc-java/commit/c090767035fdce2da6f135b61d181516bc6cf96f", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/grpclb_selection_change_take_one", "committedDate": "2020-01-27T08:36:28Z", "type": "forcePushed"}, {"oid": "da29532e15f103810235ce354de4f366329b953e", "url": "https://github.com/grpc/grpc-java/commit/da29532e15f103810235ce354de4f366329b953e", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/grpclb_selection_change_take_one", "committedDate": "2020-01-27T08:44:32Z", "type": "commit"}, {"oid": "da29532e15f103810235ce354de4f366329b953e", "url": "https://github.com/grpc/grpc-java/commit/da29532e15f103810235ce354de4f366329b953e", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/grpclb_selection_change_take_one", "committedDate": "2020-01-27T08:44:32Z", "type": "forcePushed"}, {"oid": "c817b6f38f3e6079a834ef830642450512777792", "url": "https://github.com/grpc/grpc-java/commit/c817b6f38f3e6079a834ef830642450512777792", "message": "Add annotation for LB addrs attributes.", "committedDate": "2020-01-27T18:03:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MDE2MA==", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371550160", "bodyText": "can you also remove the ResolvedPolicySelection class?", "author": "creamsoup", "createdAt": "2020-01-28T00:03:16Z", "path": "core/src/main/java/io/grpc/internal/AutoConfiguredLoadBalancerFactory.java", "diffHunk": "@@ -125,48 +120,53 @@ Status tryHandleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n       }\n       PolicySelection policySelection =\n           (PolicySelection) resolvedAddresses.getLoadBalancingPolicyConfig();\n-      ResolvedPolicySelection resolvedSelection;", "originalCommit": "c817b6f38f3e6079a834ef830642450512777792", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk2ODY1MA==", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371968650", "bodyText": "Done.", "author": "voidzcy", "createdAt": "2020-01-28T18:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MDE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MTY3MQ==", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371551671", "bodyText": "this will be overwritten in some case where it execute L330. it looks like we should have both.", "author": "creamsoup", "createdAt": "2020-01-28T00:08:40Z", "path": "core/src/main/java/io/grpc/internal/DnsNameResolver.java", "diffHunk": "@@ -293,19 +293,24 @@ public void run() {\n             Status.UNAVAILABLE.withDescription(\"Unable to resolve host \" + host).withCause(e));\n         return;\n       }\n+      if (resolutionResults.addresses.isEmpty() && resolutionResults.balancerAddresses.isEmpty()) {\n+        savedListener.onError(Status.UNAVAILABLE.withDescription(\n+            \"No DNS backend or balancer addresses found for \" + host));\n+        return;\n+      }\n       // Each address forms an EAG\n       List<EquivalentAddressGroup> servers = new ArrayList<>();\n       for (InetAddress inetAddr : resolutionResults.addresses) {\n         servers.add(new EquivalentAddressGroup(new InetSocketAddress(inetAddr, port)));\n       }\n-      servers.addAll(resolutionResults.balancerAddresses);\n-      if (servers.isEmpty()) {\n-        savedListener.onError(Status.UNAVAILABLE.withDescription(\n-            \"No DNS backend or balancer addresses found for \" + host));\n-        return;\n-      }\n \n-      ResolutionResult.Builder resultBuilder = ResolutionResult.newBuilder().setAddresses(servers);\n+      ResolutionResult.Builder resultBuilder =\n+          ResolutionResult.newBuilder()\n+              .setAddresses(servers)\n+              .setAttributes(\n+                  Attributes.newBuilder()", "originalCommit": "c817b6f38f3e6079a834ef830642450512777792", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk2ODYyMQ==", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371968621", "bodyText": "Fixed.", "author": "voidzcy", "createdAt": "2020-01-28T18:07:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MTY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MzE4NQ==", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371553185", "bodyText": "it makes sense it is here. but it is quite different than proposal. can you update the wrong one?", "author": "creamsoup", "createdAt": "2020-01-28T00:14:29Z", "path": "core/src/main/java/io/grpc/internal/GrpcAttributes.java", "diffHunk": "@@ -37,6 +38,10 @@\n   public static final Attributes.Key<Map<String, ?>> NAME_RESOLVER_SERVICE_CONFIG =\n       Attributes.Key.create(\"service-config\");\n \n+  @NameResolver.ResolutionResultAttr\n+  public static final Attributes.Key<List<EquivalentAddressGroup>> ATTR_LB_ADDRS =", "originalCommit": "c817b6f38f3e6079a834ef830642450512777792", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk3NzQxNw==", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371977417", "bodyText": "Now we will have two ATTR_LB_ADDRS keys, one in grpclb and one in core. They point to the same key. DnsNameResolver in core sets this attribute and GrpclbLoadBalancer will access it. In the next change, logics for querying SRV will be moved to grpclb, so only grpclb's resolver will set ATTR_LB_ADDRS attribute. Then we can eliminate the key in core.", "author": "voidzcy", "createdAt": "2020-01-28T18:24:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MzE4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAyMzQyOA==", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r372023428", "bodyText": "can we mark those as deprecated and ask to use GrpcLbConstants?", "author": "creamsoup", "createdAt": "2020-01-28T19:55:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MzE4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMTkwNQ==", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r372711905", "bodyText": "Done.", "author": "voidzcy", "createdAt": "2020-01-30T00:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MzE4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NTI1Ng==", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371555256", "bodyText": "oh i may need to fix\nhttps://github.com/grpc/grpc-java/blob/master/core/src/main/java/io/grpc/internal/ManagedChannelImpl.java#L1388", "author": "creamsoup", "createdAt": "2020-01-28T00:22:22Z", "path": "grpclb/src/main/java/io/grpc/grpclb/GrpclbLoadBalancer.java", "diffHunk": "@@ -184,6 +185,11 @@ public void handleNameResolutionError(Status error) {\n     }\n   }\n \n+  @Override\n+  public boolean canHandleEmptyAddressListFromNameResolution() {\n+    return true;", "originalCommit": "c817b6f38f3e6079a834ef830642450512777792", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3fccafe4b573c1fc68fdb0422e48f2d704bbb086", "url": "https://github.com/grpc/grpc-java/commit/3fccafe4b573c1fc68fdb0422e48f2d704bbb086", "message": "Resolver can return empty result and let LB policy handle the error of no usable addresses.", "committedDate": "2020-01-28T09:33:28Z", "type": "commit"}, {"oid": "f02a7fab6dc898c853168bc414afb861d6a43f89", "url": "https://github.com/grpc/grpc-java/commit/f02a7fab6dc898c853168bc414afb861d6a43f89", "message": "Do not set ATTR_LB_ADDRS for test if resolved addresses do not contain balancer addresses, this mirrors the real behavior of DnsNameResolver.", "committedDate": "2020-01-28T18:05:11Z", "type": "commit"}, {"oid": "19d2d7c0100a4f0d8e8fb90900d4e931294bd63a", "url": "https://github.com/grpc/grpc-java/commit/19d2d7c0100a4f0d8e8fb90900d4e931294bd63a", "message": "Fix attributes being overwritten.", "committedDate": "2020-01-28T18:06:37Z", "type": "commit"}, {"oid": "b428ae3538353a45b0c8b703e5c876c1fde5c291", "url": "https://github.com/grpc/grpc-java/commit/b428ae3538353a45b0c8b703e5c876c1fde5c291", "message": "Delete no longer used class.", "committedDate": "2020-01-28T18:07:05Z", "type": "forcePushed"}, {"oid": "5adefa9b5760870406d41bf4d9beedde11819a9a", "url": "https://github.com/grpc/grpc-java/commit/5adefa9b5760870406d41bf4d9beedde11819a9a", "message": "Delete no longer used class.", "committedDate": "2020-01-28T23:03:23Z", "type": "commit"}, {"oid": "5adefa9b5760870406d41bf4d9beedde11819a9a", "url": "https://github.com/grpc/grpc-java/commit/5adefa9b5760870406d41bf4d9beedde11819a9a", "message": "Delete no longer used class.", "committedDate": "2020-01-28T23:03:23Z", "type": "forcePushed"}, {"oid": "8f38f42b6344fd01f2c15872acd16083116ab4bb", "url": "https://github.com/grpc/grpc-java/commit/8f38f42b6344fd01f2c15872acd16083116ab4bb", "message": "Add annotation for attribute keys being depracated.", "committedDate": "2020-01-30T23:03:44Z", "type": "forcePushed"}, {"oid": "ab974ef96a06e41cac5f2f98e1120888e7ca3d05", "url": "https://github.com/grpc/grpc-java/commit/ab974ef96a06e41cac5f2f98e1120888e7ca3d05", "message": "Add annotation for attribute keys being depracated.", "committedDate": "2020-01-30T23:21:31Z", "type": "forcePushed"}, {"oid": "08cb3d8c56becf15c8d77032ce8206444a99557e", "url": "https://github.com/grpc/grpc-java/commit/08cb3d8c56becf15c8d77032ce8206444a99557e", "message": "Add annotation for attribute keys being depracated.", "committedDate": "2020-01-30T23:58:27Z", "type": "commit"}, {"oid": "08cb3d8c56becf15c8d77032ce8206444a99557e", "url": "https://github.com/grpc/grpc-java/commit/08cb3d8c56becf15c8d77032ce8206444a99557e", "message": "Add annotation for attribute keys being depracated.", "committedDate": "2020-01-30T23:58:27Z", "type": "forcePushed"}]}