{"pr_number": 7689, "pr_title": "xds: fix ServerXdsClient to return subscribed resources only for LDS", "pr_createdAt": "2020-12-03T02:11:20Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7689", "timeline": [{"oid": "b81c50e640f8038c0a1ec5ac7059f0a9870a1be4", "url": "https://github.com/grpc/grpc-java/commit/b81c50e640f8038c0a1ec5ac7059f0a9870a1be4", "message": "xds: fix ServerXdsClient to return subscribed resources only for LDS", "committedDate": "2020-12-03T02:10:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNDg5MA==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r535504890", "bodyText": "This is still incorrect. It should always return null for type != ResourceType.LDS.", "author": "voidzcy", "createdAt": "2020-12-03T19:06:30Z", "path": "xds/src/main/java/io/grpc/xds/ServerXdsClient.java", "diffHunk": "@@ -107,7 +107,7 @@ public void run() {\n   @Nullable\n   @Override\n   Collection<String> getSubscribedResources(ResourceType type) {\n-    if (newServerApi) {\n+    if (newServerApi && (type == ResourceType.LDS)) {", "originalCommit": "b81c50e640f8038c0a1ec5ac7059f0a9870a1be4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUxMjc5Mg==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r535512792", "bodyText": "I can make the change but just curious what's the difference between returning null vs empty collection if the end result is the same?\nSo just to summarize:\n\nif type is LDS return subscribed resource for newServerApi else empty collection\nif type is non-LDS then just return null\n\nIs that right?", "author": "sanjaypujare", "createdAt": "2020-12-03T19:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNDg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5OTg3Mg==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r535599872", "bodyText": "It's not the same. I remember we discussed this before (in the doc).\nIn the old API, ServerXdsClient sends LDS requests with an empty list of resource names. When the RPC stream is recreated, we need to know if we need to re-subscribe to each type of resources. This is done by calling this getSubscribedResources(). It uses null vs non-null values to distinguish if the resources of that type is subscribed, and then decide if such a request needs to be sent. We cannot use empty vs non-empty to distinguish, because ServerXdsClient uses wildcard (empty list of resource names) to subscribe to LDS resources.\nSince ServerXdsClient never subscribes to resources other than LDS, it should always return null for other type of resources so that the abstract layer knows not to send requests for non-LDS resources.\nThe logic here should be\nif (type != ResourceType.LDS) {\n  return null;\n}\nif (newServerApi) {\n  return ImmutableList.<String>of(grpcServerResourceId);\n}\nreturn return Collections.emptyList();", "author": "voidzcy", "createdAt": "2020-12-03T20:53:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNDg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwOTE3Mg==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r536309172", "bodyText": "Strictly speaking, you should also include the condition of if there is a watcher watching for the resource. Just as what it initially looked like:\n\n  \n    \n      grpc-java/xds/src/main/java/io/grpc/xds/ServerXdsClient.java\n    \n    \n         Line 90\n      in\n      40191b2\n    \n    \n    \n    \n\n        \n          \n           if (type != ResourceType.LDS || listenerWatcher == null) {", "author": "voidzcy", "createdAt": "2020-12-04T18:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNDg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxMTc4NQ==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r536311785", "bodyText": "Strictly speaking, you should also include the condition of if there is a watcher watching for the resource. Just as what it initially looked like:\n\nThe ServerSdsClient is only created when there is a watcher to be registered. I can't think of a case where ServerSdsClient exists and there is no watcher. So adding this check is not going to make a difference.", "author": "sanjaypujare", "createdAt": "2020-12-04T18:58:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNDg5MA=="}], "type": "inlineReview"}, {"oid": "8f6813fb54e009af7ca43ddd26e6cb56327c7395", "url": "https://github.com/grpc/grpc-java/commit/8f6813fb54e009af7ca43ddd26e6cb56327c7395", "message": "address review comments", "committedDate": "2020-12-04T06:43:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ4MDAzNw==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r536480037", "bodyText": "Such a test is fairly weak. It would be much more robust to verify xDS requests sent to an in-process service implementation.", "author": "voidzcy", "createdAt": "2020-12-05T01:58:54Z", "path": "xds/src/test/java/io/grpc/xds/ServerXdsClientTest.java", "diffHunk": "@@ -759,6 +759,15 @@ public void streamClosedAndRetry() {\n         backoffPolicy2);\n   }\n \n+  @Test\n+  public void getSubscribedResources() {", "originalCommit": "8f6813fb54e009af7ca43ddd26e6cb56327c7395", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "466ddc5c534fdb069b1ee770cc4160bfbbbf6eba", "url": "https://github.com/grpc/grpc-java/commit/466ddc5c534fdb069b1ee770cc4160bfbbbf6eba", "message": "address review comments: part 2", "committedDate": "2020-12-09T22:54:00Z", "type": "commit"}, {"oid": "34ac6d3ee6251df41f0ad8ec4655daea0d588e41", "url": "https://github.com/grpc/grpc-java/commit/34ac6d3ee6251df41f0ad8ec4655daea0d588e41", "message": "put the tests in the right place: fix prev commit", "committedDate": "2020-12-09T23:38:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyODY3NQ==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r539728675", "bodyText": "This verify isn't useful. any(DiscoveryRequest.class) doesn't include anything, you need to be explicit for things you want to verify (on the other hand, for things not interested in terms of its behavior for a particular test case, you should just not verify it). I don't think we are much interested in verifying the ACK behavior particularly in this test case (that's why it was omitted in the original version). getSubscribedResources() is not covered by this test case, it's not called anywhere inside this test case's operations. It should be verified in streamClosedAndRetry() test case. One more thing, try to keep the two copies of ServerXdsClientTest consistent (that's why I hate maintaining two copies of tests \ud83d\ude04 ).", "author": "voidzcy", "createdAt": "2020-12-09T23:35:57Z", "path": "xds/src/test/java/io/grpc/xds/ServerXdsClientNewServerApiTest.java", "diffHunk": "@@ -376,6 +376,8 @@ public void notifyUpdatedListener() {\n     ArgumentCaptor<ListenerUpdate> listenerUpdateCaptor = ArgumentCaptor.forClass(null);\n     verify(listenerWatcher, times(1)).onListenerChanged(listenerUpdateCaptor.capture());\n \n+    // expect only 2 requests: original req and ACK: no other req for no other resource\n+    verify(requestObserver, times(2)).onNext(any(DiscoveryRequest.class));", "originalCommit": "466ddc5c534fdb069b1ee770cc4160bfbbbf6eba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczMjI0NA==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r539732244", "bodyText": "I have moved the test to streamClosedAndRetry() because that's where the new code is exercised. Check the latest commit. Also the count combined with the previous test verifies that LDS was the only query sent on the stream. FWIW the tests fail without the fix in the main code.", "author": "sanjaypujare", "createdAt": "2020-12-09T23:43:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyODY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczNTk5Mw==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r539735993", "bodyText": "Isn't this just what the previous line verified, except it adds the times(1) restriction? I think all you need is verifyNoMoreInteractions(requestObserver) at the end of the lifecycle of each requestObserver instance (note there are several requestObserver updates in this test as more than one RPCs are made).", "author": "voidzcy", "createdAt": "2020-12-09T23:51:10Z", "path": "xds/src/test/java/io/grpc/xds/ServerXdsClientTest.java", "diffHunk": "@@ -639,6 +636,8 @@ public void streamClosedAndRetry() {\n     verify(requestObserver)\n         .onNext(eq(buildDiscoveryRequest(getNodeToVerify(), \"\",\n             ResourceType.LDS.typeUrlV2(), \"\")));\n+    // expect only 1 request: for LDS\n+    verify(requestObserver, times(1)).onNext(any(DiscoveryRequest.class));", "originalCommit": "34ac6d3ee6251df41f0ad8ec4655daea0d588e41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczOTc3Mw==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r539739773", "bodyText": "So it does verify that there is only request which is the previous one (for LDS) and no more. So verifyNoMoreInteractions(requestObserver) also works but  in terms of qualitative testing there is no difference.", "author": "sanjaypujare", "createdAt": "2020-12-10T00:00:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczNTk5Mw=="}], "type": "inlineReview"}, {"oid": "6f09a351f0f77e1272ac57e4229ad226c4fd6613", "url": "https://github.com/grpc/grpc-java/commit/6f09a351f0f77e1272ac57e4229ad226c4fd6613", "message": "use better verification method", "committedDate": "2020-12-10T01:12:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc3NTkwOQ==", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r539775909", "bodyText": "Well, the two copies of tests have already diverged.  But it is minor...", "author": "voidzcy", "createdAt": "2020-12-10T01:33:54Z", "path": "xds/src/test/java/io/grpc/xds/ServerXdsClientTest.java", "diffHunk": "@@ -636,6 +636,7 @@ public void streamClosedAndRetry() {\n     verify(requestObserver)\n         .onNext(eq(buildDiscoveryRequest(getNodeToVerify(), \"\",\n             ResourceType.LDS.typeUrlV2(), \"\")));\n+    verifyNoMoreInteractions(requestObserver);", "originalCommit": "6f09a351f0f77e1272ac57e4229ad226c4fd6613", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}