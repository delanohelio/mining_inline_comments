{"pr_number": 7469, "pr_title": "xds: migrate xDS resolver to use XdsClient APIs for watching individual LDS/RDS resources", "pr_createdAt": "2020-09-29T09:26:26Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7469", "timeline": [{"oid": "f17e4753817a763e1ed45697136abf48673782b3", "url": "https://github.com/grpc/grpc-java/commit/f17e4753817a763e1ed45697136abf48673782b3", "message": "Add getters.", "committedDate": "2020-09-29T09:14:26Z", "type": "commit"}, {"oid": "ef26c71a9af56057335c0b4e6d5a84bd78280818", "url": "https://github.com/grpc/grpc-java/commit/ef26c71a9af56057335c0b4e6d5a84bd78280818", "message": "Change XdsNameResolver to use XdsClient APIs for watching LDS/RDS resource individually.", "committedDate": "2020-09-29T09:15:11Z", "type": "commit"}, {"oid": "171db328c7003d9d5891b390d9c552bb1da71c9a", "url": "https://github.com/grpc/grpc-java/commit/171db328c7003d9d5891b390d9c552bb1da71c9a", "message": "Enhance tests.", "committedDate": "2020-09-30T23:11:19Z", "type": "commit"}, {"oid": "f95e61cbf4436f808e0dbeb10571a2c0ddeaad72", "url": "https://github.com/grpc/grpc-java/commit/f95e61cbf4436f808e0dbeb10571a2c0ddeaad72", "message": "Fix callback lifecycle issue.", "committedDate": "2020-09-30T23:11:19Z", "type": "commit"}, {"oid": "f95e61cbf4436f808e0dbeb10571a2c0ddeaad72", "url": "https://github.com/grpc/grpc-java/commit/f95e61cbf4436f808e0dbeb10571a2c0ddeaad72", "message": "Fix callback lifecycle issue.", "committedDate": "2020-09-30T23:11:19Z", "type": "forcePushed"}, {"oid": "8502c35a6b35717fb607256f0f6f91a515a7c98c", "url": "https://github.com/grpc/grpc-java/commit/8502c35a6b35717fb607256f0f6f91a515a7c98c", "message": "Rename inner class.", "committedDate": "2020-10-01T01:27:44Z", "type": "commit"}, {"oid": "7611ec645fcab07c50f39d7b6e85dc24f046a745", "url": "https://github.com/grpc/grpc-java/commit/7611ec645fcab07c50f39d7b6e85dc24f046a745", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/migrate_xds_resolver_to_use_watch_lds_rds_individually", "committedDate": "2020-10-02T23:53:17Z", "type": "commit"}, {"oid": "9c4899aed385cc59e9a5b1e1f88ff448928c3989", "url": "https://github.com/grpc/grpc-java/commit/9c4899aed385cc59e9a5b1e1f88ff448928c3989", "message": "Use XdsClientImpl2.", "committedDate": "2020-10-05T19:34:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0MzkyNg==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r500643926", "bodyText": "I don't think this flag is necessary. It's immediately true once instantiated.", "author": "dapengzhang0", "createdAt": "2020-10-06T23:03:03Z", "path": "xds/src/main/java/io/grpc/xds/XdsNameResolver.java", "diffHunk": "@@ -300,15 +412,92 @@ public void run() {\n     }\n   }\n \n-  // https://github.com/google/error-prone/issues/1767\n-  @SuppressWarnings(\"ModifyCollectionInEnhancedForLoop\")\n-  private class ConfigWatcherImpl implements ConfigWatcher {\n+  private class ResolveState implements LdsResourceWatcher {\n+    private final ConfigOrError emptyServiceConfig =\n+        serviceConfigParser.parseServiceConfig(Collections.<String, Object>emptyMap());\n+    private final ResolutionResult emptyResult =\n+        ResolutionResult.newBuilder()\n+            .setServiceConfig(emptyServiceConfig)\n+            // let channel take action for no config selector\n+            .build();\n+    private boolean started;", "originalCommit": "9c4899aed385cc59e9a5b1e1f88ff448928c3989", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY1NzI4Mg==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r500657282", "bodyText": "Ah, this was for the same reason as the rdsWatcher != this check for RDS watcher. When there is multi-threading involved, it is possible that a callback was scheduled (to be executed later) while this resolver is being shut down. Then when the callback is invoked, it should be ignored.\nWithout this flag, it would do the similar check resolveState != this.", "author": "voidzcy", "createdAt": "2020-10-06T23:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0MzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2MjMxOQ==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r500662319", "bodyText": "I would recommend add the checks when you are really implementing the race handling, and review them together. This is really based on assumptions of future implementation which I cannot see the whole picture.", "author": "dapengzhang0", "createdAt": "2020-10-07T00:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0MzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3NTY2Mw==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r500675663", "bodyText": "Okay, eliminated flags used for racing cases for now.", "author": "voidzcy", "createdAt": "2020-10-07T00:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0MzkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0NDQ3Mg==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r500644472", "bodyText": "I believe start() is only called right after instantiation and won't be called twice.", "author": "dapengzhang0", "createdAt": "2020-10-06T23:05:01Z", "path": "xds/src/main/java/io/grpc/xds/XdsNameResolver.java", "diffHunk": "@@ -300,15 +412,92 @@ public void run() {\n     }\n   }\n \n-  // https://github.com/google/error-prone/issues/1767\n-  @SuppressWarnings(\"ModifyCollectionInEnhancedForLoop\")\n-  private class ConfigWatcherImpl implements ConfigWatcher {\n+  private class ResolveState implements LdsResourceWatcher {\n+    private final ConfigOrError emptyServiceConfig =\n+        serviceConfigParser.parseServiceConfig(Collections.<String, Object>emptyMap());\n+    private final ResolutionResult emptyResult =\n+        ResolutionResult.newBuilder()\n+            .setServiceConfig(emptyServiceConfig)\n+            // let channel take action for no config selector\n+            .build();\n+    private boolean started;\n     private Set<String> existingClusters;\n+    @Nullable\n+    private String rdsResource;\n+    @Nullable\n+    private RdsResourceWatcher rdsWatcher;\n+\n+    @Override\n+    public void onChanged(LdsUpdate update) {\n+      if (!started) {\n+        return;\n+      }\n+      logger.log(XdsLogLevel.INFO, \"Receive LDS resource update: {0}\", update);\n+      List<VirtualHost> virtualHosts = update.getVirtualHosts();\n+      String rdsName = update.getRdsName();\n+      if (rdsName != null && rdsName.equals(rdsResource)) {\n+        return;\n+      }\n+      cleanUpRdsWatcher();\n+      if (virtualHosts != null) {\n+        updateRoutes(virtualHosts);\n+      } else {\n+        rdsResource = rdsName;\n+        rdsWatcher = new RdsResourceWatcherImpl();\n+        logger.log(XdsLogLevel.INFO, \"Start watching RDS resource {0}\", rdsResource);\n+        xdsClient.watchRdsResource(rdsResource, rdsWatcher);\n+      }\n+    }\n \n     @Override\n-    public void onConfigChanged(ConfigUpdate update) {\n+    public void onError(Status error) {\n+      if (!started) {\n+        return;\n+      }\n+      logger.log(\n+          XdsLogLevel.WARNING,\n+          \"Received error from xDS client {0}: {1}\", xdsClient, error.getDescription());\n+      listener.onError(error);\n+    }\n+\n+    @Override\n+    public void onResourceDoesNotExist(String resourceName) {\n+      if (!started) {\n+        return;\n+      }\n+      logger.log(XdsLogLevel.INFO, \"LDS resource {0} unavailable\", resourceName);\n+      cleanUpRdsWatcher();\n+      listener.onResult(emptyResult);\n+    }\n+\n+    private void start() {\n+      if (started) {", "originalCommit": "9c4899aed385cc59e9a5b1e1f88ff448928c3989", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY1NTgyMQ==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r500655821", "bodyText": "The problem for not using start()/stop() is that the LdsResourceWatcher implementation class will not be self-contained. It would be something like\nclass XdsNameResolver {\n  private LdsResourceWatcher ldsWatcher;\n\n  @Override\n  public void start(Listener2 listener) {\n    ...\n    ldsWatcher = new LdsResourceWatcherImpl();\n    xdsClient.watchLdsResource(authority, ldsWatcher);\n  }\n\n\n  @Override\n  public void shutdown() {\n    ...\n    if (xdsClient != null) {\n      if (ldsWatcher != null) {\n        xdsClient.cancelLdsResourceWatch(authority, ldsWatcher);\n      }\n      ...\n    }\n    ...\n  }\n}\n\nI prefer the existing approach as it encapsulate things better. What do you think?", "author": "voidzcy", "createdAt": "2020-10-06T23:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0NDQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2MzExOQ==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r500663119", "bodyText": "I was not saying not to use start()/stop(). It was about checking the started flag.", "author": "dapengzhang0", "createdAt": "2020-10-07T00:05:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0NDQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0NTU1Mg==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r500645552", "bodyText": "Let's not do this now based on assumptions on future XdsClient implementation. It's not clear how race is handled by XdsClient yet.", "author": "dapengzhang0", "createdAt": "2020-10-06T23:08:23Z", "path": "xds/src/main/java/io/grpc/xds/XdsNameResolver.java", "diffHunk": "@@ -353,25 +542,44 @@ public void onConfigChanged(ConfigUpdate update) {\n       }\n     }\n \n-    @Override\n-    public void onResourceDoesNotExist(String resourceName) {\n-      logger.log(XdsLogLevel.INFO, \"Resource {0} is unavailable\", resourceName);\n-      ConfigOrError parsedServiceConfig =\n-          serviceConfigParser.parseServiceConfig(Collections.<String, Object>emptyMap());\n-      ResolutionResult result =\n-          ResolutionResult.newBuilder()\n-              .setServiceConfig(parsedServiceConfig)\n-              // let channel take action for no config selector\n-              .build();\n-      listener.onResult(result);\n+    private void cleanUpRdsWatcher() {\n+      if (rdsWatcher != null) {\n+        logger.log(XdsLogLevel.INFO, \"Stop watching RDS resource {0}\", rdsResource);\n+        xdsClient.cancelRdsResourceWatch(rdsResource, rdsWatcher);\n+        rdsResource = null;\n+        rdsWatcher = null;\n+      }\n     }\n \n-    @Override\n-    public void onError(Status error) {\n-      logger.log(\n-          XdsLogLevel.WARNING,\n-          \"Received error from xDS client {0}: {1}\", xdsClient, error.getDescription());\n-      listener.onError(error);\n+    private class RdsResourceWatcherImpl implements RdsResourceWatcher {\n+\n+      @Override\n+      public void onChanged(RdsUpdate update) {\n+        if (this != rdsWatcher) {", "originalCommit": "9c4899aed385cc59e9a5b1e1f88ff448928c3989", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3Njc2NA==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r500676764", "bodyText": "Eliminated. Will reconsider in next steps.", "author": "voidzcy", "createdAt": "2020-10-07T00:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0NTU1Mg=="}], "type": "inlineReview"}, {"oid": "6bc8e9d44419d9e30f8cf9c3df56edba424056f5", "url": "https://github.com/grpc/grpc-java/commit/6bc8e9d44419d9e30f8cf9c3df56edba424056f5", "message": "Remove race checks for now, as it is not needed now.", "committedDate": "2020-10-07T00:44:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyNjAxNg==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r501326016", "bodyText": "Should they be cleaned up in a FILO order?", "author": "dapengzhang0", "createdAt": "2020-10-07T21:40:39Z", "path": "xds/src/main/java/io/grpc/xds/XdsNameResolver.java", "diffHunk": "@@ -300,15 +412,74 @@ public void run() {\n     }\n   }\n \n-  // https://github.com/google/error-prone/issues/1767\n-  @SuppressWarnings(\"ModifyCollectionInEnhancedForLoop\")\n-  private class ConfigWatcherImpl implements ConfigWatcher {\n+  private class ResolveState implements LdsResourceWatcher {\n+    private final ConfigOrError emptyServiceConfig =\n+        serviceConfigParser.parseServiceConfig(Collections.<String, Object>emptyMap());\n+    private final ResolutionResult emptyResult =\n+        ResolutionResult.newBuilder()\n+            .setServiceConfig(emptyServiceConfig)\n+            // let channel take action for no config selector\n+            .build();\n     private Set<String> existingClusters;\n+    @Nullable\n+    private String rdsResource;\n+    @Nullable\n+    private RdsResourceWatcher rdsWatcher;\n+\n+    @Override\n+    public void onChanged(LdsUpdate update) {\n+      logger.log(XdsLogLevel.INFO, \"Receive LDS resource update: {0}\", update);\n+      List<VirtualHost> virtualHosts = update.getVirtualHosts();\n+      String rdsName = update.getRdsName();\n+      if (rdsName != null && rdsName.equals(rdsResource)) {\n+        return;\n+      }\n+      cleanUpRdsWatcher();\n+      if (virtualHosts != null) {\n+        updateRoutes(virtualHosts);\n+      } else {\n+        rdsResource = rdsName;\n+        rdsWatcher = new RdsResourceWatcherImpl();\n+        logger.log(XdsLogLevel.INFO, \"Start watching RDS resource {0}\", rdsResource);\n+        xdsClient.watchRdsResource(rdsResource, rdsWatcher);\n+      }\n+    }\n+\n+    @Override\n+    public void onError(Status error) {\n+      logger.log(\n+          XdsLogLevel.WARNING,\n+          \"Received error from xDS client {0}: {1}\", xdsClient, error.getDescription());\n+      listener.onError(error);\n+    }\n \n     @Override\n-    public void onConfigChanged(ConfigUpdate update) {\n+    public void onResourceDoesNotExist(String resourceName) {\n+      logger.log(XdsLogLevel.INFO, \"LDS resource {0} unavailable\", resourceName);\n+      cleanUpRdsWatcher();\n+      listener.onResult(emptyResult);\n+    }\n+\n+    private void start() {\n+      logger.log(XdsLogLevel.INFO, \"Start watching LDS resource {0}\", authority);\n+      xdsClient.watchLdsResource(authority, this);\n+    }\n+\n+    private void stop() {\n+      logger.log(XdsLogLevel.INFO, \"Stop watching LDS resource {0}\", authority);\n+      xdsClient.cancelLdsResourceWatch(authority, this);\n+      cleanUpRdsWatcher();", "originalCommit": "6bc8e9d44419d9e30f8cf9c3df56edba424056f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQyMzI0OQ==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r501423249", "bodyText": "It shouldn't matter. But sure, swapped.", "author": "voidzcy", "createdAt": "2020-10-08T03:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyNjAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyODg1Nw==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r501328857", "bodyText": "I wonder where the error-prone warning was coming from in the old code.", "author": "dapengzhang0", "createdAt": "2020-10-07T21:47:15Z", "path": "xds/src/main/java/io/grpc/xds/XdsNameResolver.java", "diffHunk": "@@ -300,15 +412,74 @@ public void run() {\n     }\n   }\n \n-  // https://github.com/google/error-prone/issues/1767\n-  @SuppressWarnings(\"ModifyCollectionInEnhancedForLoop\")", "originalCommit": "6bc8e9d44419d9e30f8cf9c3df56edba424056f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQyMzEwOQ==", "url": "https://github.com/grpc/grpc-java/pull/7469#discussion_r501423109", "bodyText": "It's for modifying ConcurrentMap clusterRefs in the loop. Not sure how that was triggered. But now, seems it doesn't trigger.", "author": "voidzcy", "createdAt": "2020-10-08T03:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyODg1Nw=="}], "type": "inlineReview"}, {"oid": "63aba3ffbced5d02feadb2da3c6f29b07defff43", "url": "https://github.com/grpc/grpc-java/commit/63aba3ffbced5d02feadb2da3c6f29b07defff43", "message": "Cancel RDS watcher before LDS watcher.", "committedDate": "2020-10-08T03:03:57Z", "type": "commit"}]}