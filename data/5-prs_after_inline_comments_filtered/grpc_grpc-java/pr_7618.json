{"pr_number": 7618, "pr_title": "interop-testing: fix wrong semantics for RPC failure stats in xDS test client", "pr_createdAt": "2020-11-12T09:29:44Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7618", "timeline": [{"oid": "5363495841e6a9efbe32c54b389a0f5d6420157f", "url": "https://github.com/grpc/grpc-java/commit/5363495841e6a9efbe32c54b389a0f5d6420157f", "message": "Clarify the actual semantics of num_failures.", "committedDate": "2020-11-12T09:17:00Z", "type": "commit"}, {"oid": "57461432f3e302ced52c5c3c9480e3082d45a6b3", "url": "https://github.com/grpc/grpc-java/commit/57461432f3e302ced52c5c3c9480e3082d45a6b3", "message": "Should not count RPCs reached the server but failed to num_failures.", "committedDate": "2020-11-12T19:06:36Z", "type": "commit"}, {"oid": "57461432f3e302ced52c5c3c9480e3082d45a6b3", "url": "https://github.com/grpc/grpc-java/commit/57461432f3e302ced52c5c3c9480e3082d45a6b3", "message": "Should not count RPCs reached the server but failed to num_failures.", "committedDate": "2020-11-12T19:06:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NjU2NA==", "url": "https://github.com/grpc/grpc-java/pull/7618#discussion_r522486564", "bodyText": "Do your tests need to distinguish between rpcs that have failed (rpcsFailed) versus still pending on the server (latch.getCount())?", "author": "ericgribkoff", "createdAt": "2020-11-12T22:55:47Z", "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestClient.java", "diffHunk": "@@ -565,7 +564,7 @@ LoadBalancerStatsResponse waitForRpcStats(long timeoutSeconds) {\n           rpcs.putAllRpcsByPeer(entry.getValue());\n           builder.putRpcsByMethod(getRpcTypeString(entry.getKey()), rpcs.build());\n         }\n-        builder.setNumFailures(noRemotePeer + (int) latch.getCount());\n+        builder.setNumFailures(rpcsFailed + (int) latch.getCount());", "originalCommit": "57461432f3e302ced52c5c3c9480e3082d45a6b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5NDEzOQ==", "url": "https://github.com/grpc/grpc-java/pull/7618#discussion_r522494139", "bodyText": "Actually, could you clarify exactly what the problem is that you encountered with the current \"wrong\" semantics? (As best I can tell, these are not wrong exactly but made your new tests harder to debug, but maybe there's actually something broken here that I misunderstand). Were you getting failed RPCs that had still received a peer, so they were getting reported under rpcs_by_peer?\nSince this new change still seems to group outstanding RPCs into num_failures, I don't see how this semantics change directly helps debug any tests with RPCs that are kept-open indefinitely by the server. Unless these end up timing out on the client and then get reported as DEADLINE_EXECEEDED? Even so, that's dependent on the parameters (client-side time out and number of seconds to wait when querying the stats service) and may not always occur. Should this change should also remove latch.getCount() from the reported numberOfFailures?", "author": "ericgribkoff", "createdAt": "2020-11-12T23:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NjU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUxNjI3Nw==", "url": "https://github.com/grpc/grpc-java/pull/7618#discussion_r522516277", "bodyText": "None of the tests depend on distinguishing rpcs have failed vs pending on the server. This change is just trying to make  it less ambiguous. It is extremely confusing and error-prone for defining rpcs_by_peer to be the number of completed RPCs for each peers. \"completed RPCs\" is ambiguous here, as it includes both RPCs failed after reaching the server (e.g., DEADLINE_EXECEEDED) and RPCs finished successfully. The definition for num_failures is also error-prone, as its comment says it is for RPCs that failed to record a remote peer. RPCs failed after reaching the server do not account for num_failures, which is very surprising, isn't it?\nIn the new LoadBalancerAccumulatedStatsResponse, it clearly states the stats are for RPCs failed (no matter how they fails, finishing with onError() is considered as failure) and RPCs completed successfully. For the same batch of RPCs failed with DEADLINE_EXECEEDED, you will see LoadBalancerStatsResponse counts them as completed but LoadBalancerAccumulatedStatsResponse counts them as failed. \ud83d\ude22\nRegarding RPCs not finished in upon GetClientStats call times out, previously they are considered \"completed\" but now being \"failed\". Both are not satisfactory (with the latter less error-prone I think?), we can change it to not count them towards either. Still no existing tests should be affected.", "author": "voidzcy", "createdAt": "2020-11-12T23:57:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NjU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MTQxNA==", "url": "https://github.com/grpc/grpc-java/pull/7618#discussion_r522591414", "bodyText": "The change here is good (that's why I approved) but I think it should go further and not include the number of pending RPCs in num_failures. As far as I can tell, with latch.getCount() still included in the num_failures response, the change in messages.proto's description of num_failures is not actually accurate: num_failures is actually being computed as the number of RPCs that failed + pending RPCs. I think we should just drop latch.getCount() here, and then num_failures=Number of failed RPCs", "author": "ericgribkoff", "createdAt": "2020-11-13T03:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NjU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3NzM3Mg==", "url": "https://github.com/grpc/grpc-java/pull/7618#discussion_r522677372", "bodyText": "Done.", "author": "voidzcy", "createdAt": "2020-11-13T06:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NjU2NA=="}], "type": "inlineReview"}, {"oid": "5c58863dfab4f46e07e8e236367f0f689c0c1713", "url": "https://github.com/grpc/grpc-java/commit/5c58863dfab4f46e07e8e236367f0f689c0c1713", "message": "Clarify stats message fields.", "committedDate": "2020-11-13T06:22:22Z", "type": "commit"}, {"oid": "3bc24fc7c6f188fbb09a14702f20dc0743db3112", "url": "https://github.com/grpc/grpc-java/commit/3bc24fc7c6f188fbb09a14702f20dc0743db3112", "message": "Do not include incompleted RPCs to number of failures.", "committedDate": "2020-11-13T06:23:18Z", "type": "commit"}]}