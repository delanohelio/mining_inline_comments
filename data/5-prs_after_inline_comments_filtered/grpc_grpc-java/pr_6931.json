{"pr_number": 6931, "pr_title": "xds: eliminate special code path for EDS-only workflow", "pr_createdAt": "2020-04-15T22:46:26Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6931", "timeline": [{"oid": "2bf3926cbaef722311061fab705fe71e36d41fae", "url": "https://github.com/grpc/grpc-java/commit/2bf3926cbaef722311061fab705fe71e36d41fae", "message": "Delete classes for EDS only workflow.", "committedDate": "2020-04-15T22:42:41Z", "type": "commit"}, {"oid": "6982f7847e3938d6f1468ef3b222dc4df43a88f0", "url": "https://github.com/grpc/grpc-java/commit/6982f7847e3938d6f1468ef3b222dc4df43a88f0", "message": "Eliminate callback logic in EDS lb policy, which was used for triggering fallback.", "committedDate": "2020-04-15T22:43:42Z", "type": "commit"}, {"oid": "26b8f7a8481df7ad6c4bf6f4df5efa63bc05e31c", "url": "https://github.com/grpc/grpc-java/commit/26b8f7a8481df7ad6c4bf6f4df5efa63bc05e31c", "message": "Gracefully handle missing EDS config, as the config can be from the external service config.", "committedDate": "2020-04-15T23:08:30Z", "type": "commit"}, {"oid": "56f7121f8691b043af016f6542f1c36f64bd36db", "url": "https://github.com/grpc/grpc-java/commit/56f7121f8691b043af016f6542f1c36f64bd36db", "message": "Add EDS policy config parser.", "committedDate": "2020-04-15T23:46:03Z", "type": "commit"}, {"oid": "56f7121f8691b043af016f6542f1c36f64bd36db", "url": "https://github.com/grpc/grpc-java/commit/56f7121f8691b043af016f6542f1c36f64bd36db", "message": "Add EDS policy config parser.", "committedDate": "2020-04-15T23:46:03Z", "type": "forcePushed"}, {"oid": "0afa1881e0661dca483b4957da4717b89821998f", "url": "https://github.com/grpc/grpc-java/commit/0afa1881e0661dca483b4957da4717b89821998f", "message": "Add unit test for CdsLoadBalancerProvider, cover logic for parsing CDS lb config.", "committedDate": "2020-04-16T07:54:57Z", "type": "commit"}, {"oid": "0afa1881e0661dca483b4957da4717b89821998f", "url": "https://github.com/grpc/grpc-java/commit/0afa1881e0661dca483b4957da4717b89821998f", "message": "Add unit test for CdsLoadBalancerProvider, cover logic for parsing CDS lb config.", "committedDate": "2020-04-16T07:54:57Z", "type": "forcePushed"}, {"oid": "dfcfa0d880a3bbe86fb47aa7e109a68776a3a947", "url": "https://github.com/grpc/grpc-java/commit/dfcfa0d880a3bbe86fb47aa7e109a68776a3a947", "message": "Remove check for changing cluster name in received EDS config. We may allow this for EDS only workflow.", "committedDate": "2020-04-16T17:32:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2Mjk3MA==", "url": "https://github.com/grpc/grpc-java/pull/6931#discussion_r409862970", "bodyText": "nit: +newline", "author": "dapengzhang0", "createdAt": "2020-04-16T21:36:51Z", "path": "xds/src/test/java/io/grpc/xds/EdsLoadBalancerProviderTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import io.grpc.NameResolver.ConfigOrError;\n+import io.grpc.internal.JsonParser;\n+import io.grpc.xds.EdsLoadBalancerProvider.EdsConfig;\n+import java.io.IOException;\n+import java.util.Map;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/** Unit tests for {@link EdsLoadBalancerProvider}. */\n+@RunWith(JUnit4.class)\n+public class EdsLoadBalancerProviderTest {\n+  private final EdsLoadBalancerProvider provider = new EdsLoadBalancerProvider();\n+\n+  @Test\n+  public void parseEdsLoadBalancingPolicyConfig() throws IOException {\n+    String rawEdsLbConfig = \"{\\n\"\n+        + \"  \\\"cluster\\\": \\\"cluster-foo.googleapis.com\\\",\\n\"\n+        + \"  \\\"edsServiceName\\\": \\\"cluster-foo:service-blade\\\",\\n\"\n+        + \"  \\\"lrsLoadReportingServerName\\\": \\\"trafficdirector.googleapis.com\\\",\\n\"\n+        + \"  \\\"endpointPickingPolicy\\\": [\\n\"\n+        + \"     { \\\"policy_foo\\\": {} },\\n\"\n+        + \"     { \\\"pick_first\\\": {} }\\n\"\n+        + \"  ]\\n\"\n+        + \"}\";\n+\n+    @SuppressWarnings(\"unchecked\")\n+    Map<String, ?> rawLbConfigMap = (Map<String, ?>) JsonParser.parse(rawEdsLbConfig);\n+    ConfigOrError result = provider.parseLoadBalancingPolicyConfig(rawLbConfigMap);\n+    assertThat(result.getConfig()).isNotNull();\n+    EdsConfig config = (EdsConfig) result.getConfig();\n+    assertThat(config.clusterName).isEqualTo(\"cluster-foo.googleapis.com\");\n+    assertThat(config.edsServiceName).isEqualTo(\"cluster-foo:service-blade\");\n+    assertThat(config.lrsServerName).isEqualTo(\"trafficdirector.googleapis.com\");\n+    assertThat(config.endpointPickingPolicy.getProvider().getPolicyName())\n+        .isEqualTo(\"pick_first\");\n+  }\n+\n+  @Test\n+  public void parseEdsLoadBalancingPolicyConfig_defaultEndpointPickingPolicy_roundRobin()\n+      throws IOException {\n+    String rawEdsLbConfig = \"{\\n\"\n+        + \"  \\\"cluster\\\": \\\"cluster-foo.googleapis.com\\\",\\n\"\n+        + \"  \\\"edsServiceName\\\": \\\"cluster-foo:service-blade\\\",\\n\"\n+        + \"  \\\"lrsLoadReportingServerName\\\": \\\"trafficdirector.googleapis.com\\\"\\n\"\n+        + \"}\";\n+\n+    @SuppressWarnings(\"unchecked\")\n+    Map<String, ?> rawLbConfigMap = (Map<String, ?>) JsonParser.parse(rawEdsLbConfig);\n+    ConfigOrError result = provider.parseLoadBalancingPolicyConfig(rawLbConfigMap);\n+    assertThat(result.getConfig()).isNotNull();\n+    EdsConfig config = (EdsConfig) result.getConfig();\n+    assertThat(config.endpointPickingPolicy.getProvider().getPolicyName())\n+        .isEqualTo(\"round_robin\");\n+  }\n+}", "originalCommit": "dfcfa0d880a3bbe86fb47aa7e109a68776a3a947", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f43664671946c8b1dbdb8509696ebcd3e06134ce", "url": "https://github.com/grpc/grpc-java/commit/f43664671946c8b1dbdb8509696ebcd3e06134ce", "message": "Merge branch 'master' of github.com:grpc/grpc-java into refactor/eliminate_eds_only_work_flow", "committedDate": "2020-04-16T23:25:09Z", "type": "commit"}, {"oid": "88c62bd441bb961bfbe23f0b5c4606f3adc4a8d0", "url": "https://github.com/grpc/grpc-java/commit/88c62bd441bb961bfbe23f0b5c4606f3adc4a8d0", "message": "New line format", "committedDate": "2020-04-16T23:25:33Z", "type": "commit"}]}