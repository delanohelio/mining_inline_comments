{"pr_number": 7764, "pr_title": "xds: decouple xds channel creation and bootstrapping", "pr_createdAt": "2020-12-28T19:46:08Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7764", "timeline": [{"oid": "e2554862938d9d8a78176a5c5569c83ccae5d7c0", "url": "https://github.com/grpc/grpc-java/commit/e2554862938d9d8a78176a5c5569c83ccae5d7c0", "message": "Select channel credentials for xDS servers during bootstrap.", "committedDate": "2020-12-28T19:21:56Z", "type": "commit"}, {"oid": "2d39f8884b44cd06126d997e87ddcd5b8c8242cb", "url": "https://github.com/grpc/grpc-java/commit/2d39f8884b44cd06126d997e87ddcd5b8c8242cb", "message": "Eliminate XdsChannel, pass plain ManagedChannel and useProtocolV3 as arguements for XdsClient creations.", "committedDate": "2020-12-28T19:25:16Z", "type": "commit"}, {"oid": "069f5234a4b13bfd5f9ef70c855f2864f14fe997", "url": "https://github.com/grpc/grpc-java/commit/069f5234a4b13bfd5f9ef70c855f2864f14fe997", "message": "Fix usages of BootstrapInfo.", "committedDate": "2020-12-28T19:26:18Z", "type": "commit"}, {"oid": "65cedd5e874135f49cc2a84c14be32692ef6d776", "url": "https://github.com/grpc/grpc-java/commit/65cedd5e874135f49cc2a84c14be32692ef6d776", "message": "Decouple bootstrapping and xDS channel creation. Fix the lifecycle issue of xDS channel.", "committedDate": "2020-12-28T19:27:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUyMDI3MQ==", "url": "https://github.com/grpc/grpc-java/pull/7764#discussion_r549520271", "bodyText": "It can be shutdown more gracefully with shutdown(). As long as all xdsClients cancel their streams in xdsClient.shutdown(), the channel can be terminated.", "author": "dapengzhang0", "createdAt": "2020-12-28T23:46:21Z", "path": "xds/src/main/java/io/grpc/xds/SharedXdsClientPoolProvider.java", "diffHunk": "@@ -121,26 +134,27 @@ public XdsClient returnObject(Object object) {\n         if (refCount == 0) {\n           xdsClient.shutdown();\n           xdsClient = null;\n+          channel.shutdownNow();", "originalCommit": "65cedd5e874135f49cc2a84c14be32692ef6d776", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUzNTAyNA==", "url": "https://github.com/grpc/grpc-java/pull/7764#discussion_r549535024", "bodyText": "Yeah, I was unsure if we need to use shutdownNow() here to make sure it is quickly shut down. For cases like #7752, the reference to the current xDS channel may be quickly cleared and a new xDS channel is created. shutdownNow() seems to be safer, doesn't it? Is there any reason that shutdown() is better?", "author": "voidzcy", "createdAt": "2020-12-29T01:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUyMDI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUzNzQwMQ==", "url": "https://github.com/grpc/grpc-java/pull/7764#discussion_r549537401", "bodyText": "Well, as you said it doesn't actually matter much as long as streams are canceled when XdsClient shuts down. I am changing it to shutdown(), we will see if any problem will be encountered.", "author": "voidzcy", "createdAt": "2020-12-29T01:34:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUyMDI3MQ=="}], "type": "inlineReview"}, {"oid": "7bc0b8a6d0c59c6eb7ff0adbd126987009466e5c", "url": "https://github.com/grpc/grpc-java/commit/7bc0b8a6d0c59c6eb7ff0adbd126987009466e5c", "message": "Use shutdown() for XdsClient shutdown.", "committedDate": "2020-12-29T01:29:03Z", "type": "commit"}, {"oid": "d80d7a00d269ebce7972599195b3dfcd6afd7549", "url": "https://github.com/grpc/grpc-java/commit/d80d7a00d269ebce7972599195b3dfcd6afd7549", "message": "Avoid leaking channel between tests.", "committedDate": "2020-12-29T01:34:02Z", "type": "commit"}, {"oid": "d80d7a00d269ebce7972599195b3dfcd6afd7549", "url": "https://github.com/grpc/grpc-java/commit/d80d7a00d269ebce7972599195b3dfcd6afd7549", "message": "Avoid leaking channel between tests.", "committedDate": "2020-12-29T01:34:02Z", "type": "forcePushed"}]}