{"pr_number": 7337, "pr_title": "core: fix a bug for hedging with throttling", "pr_createdAt": "2020-08-18T17:47:19Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7337", "timeline": [{"oid": "010f00a3bec28fc4be18d9c3cc093f70b2aa49d6", "url": "https://github.com/grpc/grpc-java/commit/010f00a3bec28fc4be18d9c3cc093f70b2aa49d6", "message": "core: fix a bug for hedging with throttling", "committedDate": "2020-08-18T17:43:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwODU5Mw==", "url": "https://github.com/grpc/grpc-java/pull/7337#discussion_r472508593", "bodyText": "No longer using \"fatal\" here, this is \"else isHedgeable=false\"", "author": "ericgribkoff", "createdAt": "2020-08-18T21:39:35Z", "path": "core/src/main/java/io/grpc/internal/RetriableStream.java", "diffHunk": "@@ -837,51 +836,54 @@ public void run() {\n             nextBackoffIntervalNanos = retryPolicy.initialBackoffNanos;\n           }\n \n-          RetryPlan retryPlan = makeRetryDecision(status, trailers);\n-          if (retryPlan.shouldRetry) {\n-            // The check state.winningSubstream == null, checking if is not already committed, is\n-            // racy, but is still safe b/c the retry will also handle committed/cancellation\n-            FutureCanceller scheduledRetryCopy;\n+          if (!isHedging) {\n+            RetryPlan retryPlan = makeRetryDecision(status, trailers);\n+            if (retryPlan.shouldRetry) {\n+              // The check state.winningSubstream == null, checking if is not already committed, is\n+              // racy, but is still safe b/c the retry will also handle committed/cancellation\n+              FutureCanceller scheduledRetryCopy;\n+              synchronized (lock) {\n+                scheduledRetry = scheduledRetryCopy = new FutureCanceller(lock);\n+              }\n+              scheduledRetryCopy.setFuture(\n+                  scheduledExecutorService.schedule(\n+                      new Runnable() {\n+                        @Override\n+                        public void run() {\n+                          callExecutor.execute(\n+                              new Runnable() {\n+                                @Override\n+                                public void run() {\n+                                  // retry\n+                                  Substream newSubstream =\n+                                      createSubstream(substream.previousAttemptCount + 1);\n+                                  drain(newSubstream);\n+                                }\n+                              });\n+                        }\n+                      },\n+                      retryPlan.backoffNanos,\n+                      TimeUnit.NANOSECONDS));\n+              return;\n+            }\n+          } else {\n+            HedgingPlan hedgingPlan = makeHedgingDecision(status, trailers);\n+            if (hedgingPlan.isHedgeable) {\n+              pushbackHedging(hedgingPlan.hedgingPushbackMillis);\n+            }\n             synchronized (lock) {\n-              scheduledRetry = scheduledRetryCopy = new FutureCanceller(lock);\n+              state = state.removeActiveHedge(substream);\n+              // The invariant is whether or not #(Potential Hedge + active hedges) > 0.\n+              // Once hasPotentialHedging(state) is false, it will always be false, and then\n+              // #(state.activeHedges) will be decreasing. This guarantees that even there may be\n+              // multiple concurrent hedges, one of the hedges will end up committed.\n+              if (hedgingPlan.isHedgeable) {\n+                if (hasPotentialHedging(state) || !state.activeHedges.isEmpty()) {\n+                  return;\n+                }\n+                // else, no activeHedges, no new hedges possible, try to commit\n+              } // else, fatal, try to commit", "originalCommit": "010f00a3bec28fc4be18d9c3cc093f70b2aa49d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDEyMg==", "url": "https://github.com/grpc/grpc-java/pull/7337#discussion_r472550122", "bodyText": "Fixed.", "author": "dapengzhang0", "createdAt": "2020-08-18T23:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwODU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwOTgyOQ==", "url": "https://github.com/grpc/grpc-java/pull/7337#discussion_r472509829", "bodyText": "This looks identical to lines 906-914 in makeRetryDecision. Can it be extracted out?", "author": "ericgribkoff", "createdAt": "2020-08-18T21:42:13Z", "path": "core/src/main/java/io/grpc/internal/RetriableStream.java", "diffHunk": "@@ -942,8 +935,27 @@ private RetryPlan makeRetryDecision(Status status, Metadata trailer) {\n         } // else no retry\n       } // else no retry\n \n-      return new RetryPlan(\n-          shouldRetry, /* isFatal = */ false, backoffNanos, isHedging ? pushbackMillis : null);\n+      return new RetryPlan(shouldRetry, backoffNanos);\n+    }\n+\n+    private HedgingPlan makeHedgingDecision(Status status, Metadata trailer) {\n+      String pushbackStr = trailer.get(GRPC_RETRY_PUSHBACK_MS);\n+      Integer pushbackMillis = null;\n+      if (pushbackStr != null) {\n+        try {\n+          pushbackMillis = Integer.valueOf(pushbackStr);\n+        } catch (NumberFormatException e) {\n+          pushbackMillis = -1;\n+        }\n+      }", "originalCommit": "010f00a3bec28fc4be18d9c3cc093f70b2aa49d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDEwMA==", "url": "https://github.com/grpc/grpc-java/pull/7337#discussion_r472550100", "bodyText": "Done.", "author": "dapengzhang0", "createdAt": "2020-08-18T23:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwOTgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMDY3NA==", "url": "https://github.com/grpc/grpc-java/pull/7337#discussion_r472510674", "bodyText": "Can this be && instead of ||? Or, even better, make line 953 if (!isFatal && throttle != null)? If isFatal=true, the return statement below will always be equivalent to return new HedgingPlan(false, pushbackMillis).", "author": "ericgribkoff", "createdAt": "2020-08-18T21:44:15Z", "path": "core/src/main/java/io/grpc/internal/RetriableStream.java", "diffHunk": "@@ -942,8 +935,27 @@ private RetryPlan makeRetryDecision(Status status, Metadata trailer) {\n         } // else no retry\n       } // else no retry\n \n-      return new RetryPlan(\n-          shouldRetry, /* isFatal = */ false, backoffNanos, isHedging ? pushbackMillis : null);\n+      return new RetryPlan(shouldRetry, backoffNanos);\n+    }\n+\n+    private HedgingPlan makeHedgingDecision(Status status, Metadata trailer) {\n+      String pushbackStr = trailer.get(GRPC_RETRY_PUSHBACK_MS);\n+      Integer pushbackMillis = null;\n+      if (pushbackStr != null) {\n+        try {\n+          pushbackMillis = Integer.valueOf(pushbackStr);\n+        } catch (NumberFormatException e) {\n+          pushbackMillis = -1;\n+        }\n+      }\n+      boolean isFatal = !hedgingPolicy.nonFatalStatusCodes.contains(status.getCode());\n+      boolean isThrottled = false;\n+      if (throttle != null) {\n+        if (!isFatal || (pushbackMillis != null && pushbackMillis < 0)) {", "originalCommit": "010f00a3bec28fc4be18d9c3cc093f70b2aa49d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU0NjUwMA==", "url": "https://github.com/grpc/grpc-java/pull/7337#discussion_r472546500", "bodyText": "I don't quite follow. throttle.onQualifiedFailure() must be called if !isFatal || (pushbackMillis != null && pushbackMillis < 0) regardless what HedgingPlan will be returned.", "author": "dapengzhang0", "createdAt": "2020-08-18T23:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMDY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDQwMw==", "url": "https://github.com/grpc/grpc-java/pull/7337#discussion_r472550403", "bodyText": "Ah, didn't realize that method had side effects", "author": "ericgribkoff", "createdAt": "2020-08-18T23:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMDY3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMjM2NA==", "url": "https://github.com/grpc/grpc-java/pull/7337#discussion_r472512364", "bodyText": "Nit: Swap the blocks here to avoid the negation, so that this can be if (isHedging) { /* handle hedging */ } else { /* handle retry */ }?", "author": "ericgribkoff", "createdAt": "2020-08-18T21:47:55Z", "path": "core/src/main/java/io/grpc/internal/RetriableStream.java", "diffHunk": "@@ -837,51 +836,54 @@ public void run() {\n             nextBackoffIntervalNanos = retryPolicy.initialBackoffNanos;\n           }\n \n-          RetryPlan retryPlan = makeRetryDecision(status, trailers);\n-          if (retryPlan.shouldRetry) {\n-            // The check state.winningSubstream == null, checking if is not already committed, is\n-            // racy, but is still safe b/c the retry will also handle committed/cancellation\n-            FutureCanceller scheduledRetryCopy;\n+          if (!isHedging) {", "originalCommit": "010f00a3bec28fc4be18d9c3cc093f70b2aa49d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDA3MA==", "url": "https://github.com/grpc/grpc-java/pull/7337#discussion_r472550070", "bodyText": "Done.", "author": "dapengzhang0", "createdAt": "2020-08-18T23:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMjM2NA=="}], "type": "inlineReview"}, {"oid": "aeb1a253d28a56fdd68cf2b70b617fb407834370", "url": "https://github.com/grpc/grpc-java/commit/aeb1a253d28a56fdd68cf2b70b617fb407834370", "message": "update outdated comment", "committedDate": "2020-08-18T22:14:17Z", "type": "commit"}, {"oid": "90d0a119bc38d4e1895984c49cef44d47ef620dc", "url": "https://github.com/grpc/grpc-java/commit/90d0a119bc38d4e1895984c49cef44d47ef620dc", "message": "reuse shared code", "committedDate": "2020-08-18T22:22:03Z", "type": "commit"}, {"oid": "a0a998d019dd50e6b5ed9f5bed93369536fcec0b", "url": "https://github.com/grpc/grpc-java/commit/a0a998d019dd50e6b5ed9f5bed93369536fcec0b", "message": "swap if (!isHedging) {} with else {}", "committedDate": "2020-08-18T23:32:12Z", "type": "commit"}]}