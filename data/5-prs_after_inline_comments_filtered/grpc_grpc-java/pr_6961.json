{"pr_number": 6961, "pr_title": "xds: reject case-insensitive route match", "pr_createdAt": "2020-04-21T23:54:28Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6961", "timeline": [{"oid": "ac1412b8bdb044fa3201683adf4ca24eb5f68b4f", "url": "https://github.com/grpc/grpc-java/commit/ac1412b8bdb044fa3201683adf4ca24eb5f68b4f", "message": "xds: reject case-insensitive route match", "committedDate": "2020-04-21T23:53:11Z", "type": "commit"}, {"oid": "1fed9ca359da0033ac2f7c32671779f8d01dfa36", "url": "https://github.com/grpc/grpc-java/commit/1fed9ca359da0033ac2f7c32671779f8d01dfa36", "message": "unit test for data", "committedDate": "2020-04-22T01:45:24Z", "type": "commit"}, {"oid": "1fed9ca359da0033ac2f7c32671779f8d01dfa36", "url": "https://github.com/grpc/grpc-java/commit/1fed9ca359da0033ac2f7c32671779f8d01dfa36", "message": "unit test for data", "committedDate": "2020-04-22T01:45:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4ODExNQ==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413188115", "bodyText": "I found that using addDomains(\"foo.googleapis.com\") actually it will fail/nack with a different reason: \"No routes found\". I think that's not what the test intended to test, it should fail/nack with \"Route action is not specified for the default route\", so I changed to addDomains(TARGET_AUTHORITY), namely \"foo.googleapis.com:8080\" instead.", "author": "dapengzhang0", "createdAt": "2020-04-22T17:45:04Z", "path": "xds/src/test/java/io/grpc/xds/XdsClientImplTest.java", "diffHunk": "@@ -863,7 +889,7 @@ public void matchingVirtualHostDoesNotContainRouteAction() {\n     VirtualHost virtualHost =\n         VirtualHost.newBuilder()\n             .setName(\"virtualhost00.googleapis.com\")  // don't care\n-            .addDomains(\"foo.googleapis.com\")\n+            .addDomains(TARGET_AUTHORITY)", "originalCommit": "1fed9ca359da0033ac2f7c32671779f8d01dfa36", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTIyOQ==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413185229", "bodyText": "Data validation should be done against the originally received proto messages at first place instead of against converted data. Conversion should not happen if the original proto message contains invalid data.", "author": "voidzcy", "createdAt": "2020-04-22T17:41:03Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -919,6 +919,9 @@ private static String validateRoutes(List<EnvoyProtoData.Route> routes) {\n       if (!routeMatch.isDefaultMatcher()) {\n         return \"The last route must be the default route\";\n       }\n+      if (!routeMatch.isCaseSensitive()) {", "originalCommit": "1fed9ca359da0033ac2f7c32671779f8d01dfa36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIwMzQ0OA==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413203448", "bodyText": "But how? I don't think it's so practical. The conversion is just pure data transformation from raw proto class to EnvoyProtoData class, it has no business logic, so it's transparent to validation, you can either validate raw proto with proto getters, or validate transformed data with EnvoyProtoData getters.\nThere are two stages of conversions: 1. from raw proto to EnvoyProtoData; 2. from EnvoyProtoData to ConfigUpdate. If the validation is after stage-2 conversion, then I can agree that's wrong because stage-2 conversion includes business logic.", "author": "dapengzhang0", "createdAt": "2020-04-22T18:06:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI2MTkzNg==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413261936", "bodyText": "The conversion itself is (straightforward) business logic (it interprets the proto messages).\nWhatever, your previous change already shifted things towards that direction (e.g., findRoutesInRouteConfig(...) method does some validation against RouteConfiguration proto, then it does the conversion for Route, then do more validation on converted data), which is not a big deal in terms of correctness but I would just consider it bad logic style.", "author": "voidzcy", "createdAt": "2020-04-22T19:32:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2MTUwMA==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413361500", "bodyText": "your previous change already shifted things towards that direction (e.g., findRoutesInRouteConfig(...) method does some validation against RouteConfiguration proto,\n\nYou don't have  the EnvoyProtoData counterpart of RouteConfiguration proto, so in findRoutesInRouteConfig it just used raw proto getters directly at the RouteConfiguration level. Any validation or business logic is at that level. It does not use any Route level proto getters. If RouteConfiguration had EnvoyProtoData counterpart, very likely we might convert it first and then do validation at that level.\ncaseSensitive is like hasRegex or header, grpc just chose not to support them or currently not to support them. This is the business logic that the conversion does not have to know. The conversion just blindly feed all the data the business logic needs, as how the logic will process the data, support it or not, we don't care before the conversion.", "author": "dapengzhang0", "createdAt": "2020-04-22T21:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2MjYyMw==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413362623", "bodyText": "Another aspect of my thought is, the converted data is something that gRPC would use in gRPC's internal logic such LB policies. So it should only contain fields that gRPC is interested in. Since responses with case-sensitive routes are rejected at the first place before the information is passed to gRPC's internal, this case-sensitivity information would not be needed and the converted data should not have it.\nI would consider this as a style problem, what I am worrying is we would be frustrated for maintainability as things like this spread more and more.", "author": "voidzcy", "createdAt": "2020-04-22T22:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM3NzU4Mg==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413377582", "bodyText": "the converted data is something that gRPC would use in gRPC's internal logic such LB policies\n\n\nI would consider this as a style problem\n\nI'm thinking about how the style problem comes. The LB policies use ConfigUpdate and EnpointUpdate etc, and they in turn happen to use types in EnovyProtoData because some sub-structures of ConfigUpdate and EnpointUpdate just currently (more or less) keep the proto structure. I think ConfigUpdate and EnpointUpdate shouldn't really use any type obtained from EnovyProtoData.fromEnvoyProto*() for sub-structures, they are causing the trouble and might be breaking easily.", "author": "dapengzhang0", "createdAt": "2020-04-22T22:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM5MzIxOA==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413393218", "bodyText": "What's the problem of converted data keeping the proto structure?\nMy thought about this issue is:\nEnovyProtoData.fromEnvoyProto*() is an easy/lazy way to quickly convert a proto message to POJO and preserve only fields that we are interested in. It is great for converting proto messages that we do not care its data. The problem is, in many cases, we need go into the proto message to validate its field values and then call EnovyProtoData.fromEnvoyProto*() to convert it. The two approaches we are discussing are:\n\nValidate data on proto message then convert to POJO\n\n\npros:\n\nClean definitions for converted objects, having only fields that gRPC is interested in. Every instantiated object is meaningful and usable for gRPC.\n\n\n\ncons:\n\nValidating (with business logic) the proto message requires walking through the message, converting it to POJO requires walking through it again if using EnovyProtoData.fromEnvoyProto*(). (one solution is to build the converted object step by step as the validation goes, instead of using EnovyProtoData.fromEnvoyProto*(). concern: what if the proto message is too complicated? That would require a lot of setters.).\n\n\n\n\n\n\n\nConvert proto to POJO then validate data on converted object\n\n\npros:\n\nConversion is easy and mechanical.\n\n\n\ncons:\n\nWould need to preserve fields in proto messages that gRPC do not use, as we may have validation rules for them. For example, case_sensitive field in RouteMatch and unknown fields that we may validate against (design under discussion?).\n\n\n\n\n\nI am thinking if we could move all the validation business logic into converters, so that we take advantage of both approaches above. It would be each converted type has a EnovyProtoData.fromEnvoyProto*() method, validations are performed inside it. If any rule is violated, throw some exception containing the error message (or we could do a similar trick as ConfigOrError).", "author": "voidzcy", "createdAt": "2020-04-22T23:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQxNTIyOA==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413415228", "bodyText": "The problem is that the design keeps changing. Validation also keeps changing. It might be a pain to incorporate new change.\nI'm okay with EnovyProtoData.fromEnvoyProto*() throws Exception approach.", "author": "dapengzhang0", "createdAt": "2020-04-23T00:05:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQxNzI3Mw==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413417273", "bodyText": "Sure, we can extend our discussion regarding response data validation and conversion further after this PR.", "author": "voidzcy", "createdAt": "2020-04-23T00:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MDUyNA==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413190524", "bodyText": "I would not add error_detail to the matcher and make it nullable is even worse. If you require checking error_detail for the message, you should check its value for all NACKs, not just test cases you just added. Why some test cases require checking error_detail in NACKs while others do not?  I would not verify error messages literally to make unit test fragile, unless the message is required to literally match some specific string.", "author": "voidzcy", "createdAt": "2020-04-22T17:48:16Z", "path": "xds/src/test/java/io/grpc/xds/XdsClientImplTest.java", "diffHunk": "@@ -3741,10 +3845,17 @@ private DiscoveryRequestMatcher(String versionInfo, String resourceName, String\n \n     private DiscoveryRequestMatcher(String versionInfo, List<String> resourceNames, String typeUrl,\n         String responseNonce) {\n+      this(versionInfo, resourceNames, typeUrl, responseNonce, null);\n+    }\n+\n+    private DiscoveryRequestMatcher(\n+        String versionInfo, List<String> resourceNames, String typeUrl, String responseNonce,\n+        @Nullable String nackErrorDetail) {\n       this.versionInfo = versionInfo;\n       this.resourceNames = new HashSet<>(resourceNames);\n       this.typeUrl = typeUrl;\n       this.responseNonce = responseNonce;\n+      this.nackErrorDetail = nackErrorDetail;", "originalCommit": "1fed9ca359da0033ac2f7c32671779f8d01dfa36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzk2NA==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413197964", "bodyText": "Why some test cases require checking error_detail in NACKs while others do not?\n\nI tried to check error detail in all NACK cases in this class. Not sure if I missed any.\n\nI would not verify error messages literally to make unit test fragile\n\nI agree it's not very good to test literal match. But if a test is broken just because it's fragile, it can easily be fixed. This helps find bugs than not checking error_detail, just like this one https://github.com/grpc/grpc-java/pull/6961/files#r413188115", "author": "dapengzhang0", "createdAt": "2020-04-22T17:58:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MDUyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI3NTc1OA==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413275758", "bodyText": "I see. The number of NACKs are much smaller than I expected.\nIt's verbose (this test class is already extremely verbose), and verifying all NACK cases is never likely to happen given how many branches involved in XdsClientImpl's implementation.\nAlso, the nullable setting of nackErrorDetail doesn't make tests more robust as setting it to null (or use the other constructor) will also make the test pass.\nIMO, it doesn't add much value, and it adds noise to the test.", "author": "voidzcy", "createdAt": "2020-04-22T19:49:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MDUyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0MzkyMQ==", "url": "https://github.com/grpc/grpc-java/pull/6961#discussion_r413343921", "bodyText": "Alright. I reverted the checking error_detail part. But to make sure the NACK is really caused by a specific error, not a NACK introduced by a bug in test code, I added a comparison test. Ideally it would be better to have comparison test for all other NACK tests.", "author": "dapengzhang0", "createdAt": "2020-04-22T21:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MDUyNA=="}], "type": "inlineReview"}, {"oid": "075c89aa0be0d77654ba77684f38dd1cd7067c5c", "url": "https://github.com/grpc/grpc-java/commit/075c89aa0be0d77654ba77684f38dd1cd7067c5c", "message": "not to compare error details in test", "committedDate": "2020-04-22T21:22:31Z", "type": "commit"}, {"oid": "4dd0a0310158b39f58f7786839af22748a691fde", "url": "https://github.com/grpc/grpc-java/commit/4dd0a0310158b39f58f7786839af22748a691fde", "message": "change test name", "committedDate": "2020-04-22T21:28:33Z", "type": "commit"}]}