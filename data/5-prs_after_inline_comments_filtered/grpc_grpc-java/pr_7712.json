{"pr_number": 7712, "pr_title": "core: Don't leak CallCredentials into OOB channels", "pr_createdAt": "2020-12-09T20:29:25Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7712", "timeline": [{"oid": "d3419ff96e19ba75ead01504b37472d88cffe026", "url": "https://github.com/grpc/grpc-java/commit/d3419ff96e19ba75ead01504b37472d88cffe026", "message": "core: Don't leak CallCredentials into OOB channels\n\nThe addition of CompositeChannelCredentials allowed CallCredentials to\nbe passed to the ManagedChannel itself. But the implementation was buggy\nand used the call creds for out-of-band channels as well, which is\ninappropriate since they have a different authority.\n\nThis also fixes a bug where resolving OOB channels would have CallCreds\nduplicated; that wasn't noticed or important because we don't use\nCallCreds in OOB channels.\n\nFixes #7643", "committedDate": "2020-12-09T20:25:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkwNjI1NA==", "url": "https://github.com/grpc/grpc-java/pull/7712#discussion_r539906254", "bodyText": "s/oobchannels/oobChannels/", "author": "sanjaypujare", "createdAt": "2020-12-10T06:49:13Z", "path": "core/src/test/java/io/grpc/internal/ManagedChannelImplTest.java", "diffHunk": "@@ -1741,6 +1744,87 @@ public void oobchannels() {\n         .returnObject(balancerRpcExecutor.getScheduledExecutorService());\n   }\n \n+  @Test\n+  public void oobchannelsHaveNoChannelCallCredentials() {", "originalCommit": "d3419ff96e19ba75ead01504b37472d88cffe026", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1NDAwNg==", "url": "https://github.com/grpc/grpc-java/pull/7712#discussion_r540354006", "bodyText": "Done.", "author": "ejona86", "createdAt": "2020-12-10T17:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkwNjI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkzMDIxNw==", "url": "https://github.com/grpc/grpc-java/pull/7712#discussion_r539930217", "bodyText": "Shouldn't this be oobTransportFactory? Otherwise there is no CallCredentialsApplyingTransport and no callCreds can be sent over oobChannel?", "author": "sanjaypujare", "createdAt": "2020-12-10T07:17:48Z", "path": "core/src/main/java/io/grpc/internal/ManagedChannelImpl.java", "diffHunk": "@@ -1577,7 +1582,7 @@ public ManagedChannel build() {\n           // TODO(creamsoup) prevent main channel to shutdown if oob channel is not terminated\n           return new ManagedChannelImpl(\n                   managedChannelImplBuilder,\n-                  transportFactory,\n+                  originalTransportFactory,", "originalCommit": "d3419ff96e19ba75ead01504b37472d88cffe026", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMxODQzOQ==", "url": "https://github.com/grpc/grpc-java/pull/7712#discussion_r540318439", "bodyText": "I checked the new test and if the test is passing then this change seems to be correct.", "author": "sanjaypujare", "createdAt": "2020-12-10T16:36:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkzMDIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1MjE1Nw==", "url": "https://github.com/grpc/grpc-java/pull/7712#discussion_r540352157", "bodyText": "This is the part that I mentioned was subtle in the description. It needs to be the original factory because this is getting passed to a new ManagedChannelImpl. That new instance will wrap the factory. If we use oobTransportFactory here then the CallCredentials are applied twice. This was a pre-existing bug that I only noticed because of the test I added.", "author": "ejona86", "createdAt": "2020-12-10T17:19:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkzMDIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1NDY3Mg==", "url": "https://github.com/grpc/grpc-java/pull/7712#discussion_r540354672", "bodyText": "Thanks for the explanation. Great catch.", "author": "sanjaypujare", "createdAt": "2020-12-10T17:22:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkzMDIxNw=="}], "type": "inlineReview"}, {"oid": "9d8c290e69039ef6d04de0ab6083db62463f2e32", "url": "https://github.com/grpc/grpc-java/commit/9d8c290e69039ef6d04de0ab6083db62463f2e32", "message": "Tweak test name", "committedDate": "2020-12-10T17:21:01Z", "type": "commit"}]}