{"pr_number": 7620, "pr_title": "xds: add support for setting bootstrap file with java system property", "pr_createdAt": "2020-11-13T13:10:28Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7620", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5NDEyMQ==", "url": "https://github.com/grpc/grpc-java/pull/7620#discussion_r523294121", "bodyText": "Technically it's not necessary to remove this and use the XdsLogger logger variable. You can just replace the hardcoded string BOOTSTRAP_PATH_SYS_ENV_VAR + \"={0}\" with a String variable which is set to either BOOTSTRAP_PATH_SYS_PROPERTY_VAR + \"={0}\" or BOOTSTRAP_PATH_SYS_ENV_VAR + \"={0}\" in your 'if-else` statement. But this also works...", "author": "sanjaypujare", "createdAt": "2020-11-14T00:04:21Z", "path": "xds/src/main/java/io/grpc/xds/Bootstrapper.java", "diffHunk": "@@ -47,21 +47,28 @@\n \n   private static final String LOG_PREFIX = \"xds-bootstrap\";\n   private static final String BOOTSTRAP_PATH_SYS_ENV_VAR = \"GRPC_XDS_BOOTSTRAP\";\n+  private static final String BOOTSTRAP_PATH_SYS_PROPERTY_VAR = \"io.grpc.xds.bootstrap\";\n   @VisibleForTesting\n   static final String CLIENT_FEATURE_DISABLE_OVERPROVISIONING =\n       \"envoy.lb.does_not_support_overprovisioning\";\n \n   private static final Bootstrapper DEFAULT_INSTANCE = new Bootstrapper() {\n     @Override\n     public BootstrapInfo readBootstrap() throws XdsInitializationException {\n+      XdsLogger logger = XdsLogger.withPrefix(LOG_PREFIX);\n       String filePath = System.getenv(BOOTSTRAP_PATH_SYS_ENV_VAR);\n       if (filePath == null) {\n-        throw new XdsInitializationException(\n-            \"Environment variable \" + BOOTSTRAP_PATH_SYS_ENV_VAR + \" not defined.\");\n+        filePath = System.getProperty(BOOTSTRAP_PATH_SYS_PROPERTY_VAR);\n+        if (filePath == null) {\n+          throw new XdsInitializationException(\n+                  \"Environment variable \" + BOOTSTRAP_PATH_SYS_ENV_VAR\n+                  + \" or Java System Property \" + BOOTSTRAP_PATH_SYS_PROPERTY_VAR\n+                  + \" not defined.\");\n+        }\n+        logger.log(XdsLogLevel.INFO, BOOTSTRAP_PATH_SYS_PROPERTY_VAR + \"={0}\", filePath);\n+      } else {\n+        logger.log(XdsLogLevel.INFO, BOOTSTRAP_PATH_SYS_ENV_VAR + \"={0}\", filePath);\n       }\n-      XdsLogger", "originalCommit": "f5065b51d8f71e1fcaf14f7842d6de2832f68817", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3NTEzMQ==", "url": "https://github.com/grpc/grpc-java/pull/7620#discussion_r524075131", "bodyText": "Hmm, I did it like this to avoid having a temporary variable only used for the log message but maybe that's fine in this case. What about something like this?\nString filePathSource = BOOTSTRAP_PATH_SYS_ENV_VAR;\nString filePath = System.getenv(filePathSource);\nif(filePath == null) {\n  filePathSource = BOOTSTRAP_PATH_SYS_PROPERTY_VAR;\n  filePath = System.getProperty(filePathSource);\n}\nif(filePath == null) {\n  throw new XdsInitializationException(\n         \"Environment variable \" + BOOTSTRAP_PATH_SYS_ENV_VAR\n         + \" or Java System Property \" + BOOTSTRAP_PATH_SYS_PROPERTY_VAR\n         + \" not defined.\");\n} \nXdsLogger\n   .withPrefix(LOG_PREFIX)\n   .log(XdsLogLevel.INFO, filePathSource + \"={0}\", filePath);", "author": "erikjoh", "createdAt": "2020-11-16T10:16:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5NDEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM5NDQzNQ==", "url": "https://github.com/grpc/grpc-java/pull/7620#discussion_r524394435", "bodyText": "Sounds good. It's fine even if you don't change it since the logic is correct", "author": "sanjaypujare", "createdAt": "2020-11-16T16:22:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5NDEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxMjYxNA==", "url": "https://github.com/grpc/grpc-java/pull/7620#discussion_r524412614", "bodyText": "Updated it anyway since I think it's more readable code.", "author": "erikjoh", "createdAt": "2020-11-16T16:46:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5NDEyMQ=="}], "type": "inlineReview"}, {"oid": "6ff16a0ae84f7d996b24f181140cfdfb654f534a", "url": "https://github.com/grpc/grpc-java/commit/6ff16a0ae84f7d996b24f181140cfdfb654f534a", "message": "xds: add support for setting bootstrap file with java system property\n\nWhile most languages support setting environment variables during runtime,\nJava does not. In Java, the preferred approach is to use Java System Properties\nin order so specify configuration options. By checking for the existence\nof the io.grpc.xds.bootstrap property if GRPC_XDS_BOOTSTRAP is not found,\nit is possible to either supply the bootstrap location during runtime or as\na Java argument. The environment variable still takes precedence in order\nto not break any existing documentation.", "committedDate": "2020-11-16T16:42:31Z", "type": "commit"}, {"oid": "6ff16a0ae84f7d996b24f181140cfdfb654f534a", "url": "https://github.com/grpc/grpc-java/commit/6ff16a0ae84f7d996b24f181140cfdfb654f534a", "message": "xds: add support for setting bootstrap file with java system property\n\nWhile most languages support setting environment variables during runtime,\nJava does not. In Java, the preferred approach is to use Java System Properties\nin order so specify configuration options. By checking for the existence\nof the io.grpc.xds.bootstrap property if GRPC_XDS_BOOTSTRAP is not found,\nit is possible to either supply the bootstrap location during runtime or as\na Java argument. The environment variable still takes precedence in order\nto not break any existing documentation.", "committedDate": "2020-11-16T16:42:31Z", "type": "forcePushed"}]}