{"pr_number": 7251, "pr_title": "xds: remove GRPC_XDS_EXPERIMENTAL_ROUTING flag", "pr_createdAt": "2020-07-24T21:07:57Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7251", "timeline": [{"oid": "150b74f5e3eeea63c35b41ef3c5078b3d8b80c0e", "url": "https://github.com/grpc/grpc-java/commit/150b74f5e3eeea63c35b41ef3c5078b3d8b80c0e", "message": "xds: remove GRPC_XDS_EXPERIMENTAL_ROUTING flag", "committedDate": "2020-07-24T21:06:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461206145", "bodyText": "Why still verify the last route being a \"default route\"? The only business logic for asserting the last route has been deleted.", "author": "voidzcy", "createdAt": "2020-07-27T22:27:32Z", "path": "xds/src/test/java/io/grpc/xds/XdsClientImplTest.java", "diffHunk": "@@ -492,7 +491,7 @@ public void resolveVirtualHostInLdsResponse() {\n \n     ArgumentCaptor<ConfigUpdate> configUpdateCaptor = ArgumentCaptor.forClass(null);\n     verify(configWatcher).onConfigChanged(configUpdateCaptor.capture());\n-    assertConfigUpdateContainsSingleClusterRoute(\n+    assertConfigUpdateContainsDefaultClusterRoute(", "originalCommit": "150b74f5e3eeea63c35b41ef3c5078b3d8b80c0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMTY4OQ==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461221689", "bodyText": "Reverted.", "author": "dapengzhang0", "createdAt": "2020-07-27T23:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyNjM3MA==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461226370", "bodyText": "If routing is always enabled, shouldn't the resolver always generate a load config that always picks xds-routing as the the top-most policy (even if there is only one route), instead of maintaining separate code paths like now?", "author": "voidzcy", "createdAt": "2020-07-27T23:24:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyODY4Ng==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461228686", "bodyText": "According to the design, even if routing is always enabled, it still generates cds policy as the top-most policy if there is only a single route and that route is a cluster. @menghanl Is that for optimization purpose?", "author": "dapengzhang0", "createdAt": "2020-07-27T23:31:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzMTYyOQ==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461231629", "bodyText": "IMO, that would be an overkill optimization. Or it doesn't even optimize anything, negligibly minimum amount. While we need to maintain multiple code paths, the amount of unnecessary code complexity it introduces is much more significant.\nI am approving for the env variable change for now.", "author": "voidzcy", "createdAt": "2020-07-27T23:40:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzMzY5NA==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461233694", "bodyText": "In both Java and Go, top level should always be xds_routing, because there's no subchannel pool, and switching balancer would cause recreating TCP connections.\nAnd, this is going to change after route_actions.", "author": "menghanl", "createdAt": "2020-07-27T23:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzMzc0Ng==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461233746", "bodyText": "We will change to cluster-manager-lb policy anyway, and that problem will be gone.", "author": "dapengzhang0", "createdAt": "2020-07-27T23:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzNDcwMg==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461234702", "bodyText": "In both Java and Go, top level should always be xds_routing\n\nIs the second level always weighted_target for the same reason?", "author": "dapengzhang0", "createdAt": "2020-07-27T23:50:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzNzU0OA==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461237548", "bodyText": "Yes. For the same reason.", "author": "menghanl", "createdAt": "2020-07-27T23:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzODI4Mg==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461238282", "bodyText": "Is the second level always weighted_target for the same reason?\n\n\n\nYes. For the same reason.\n\nIf the second level is always weighted_target, then the gRPF seems also out of date.", "author": "dapengzhang0", "createdAt": "2020-07-28T00:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzOTI5Mg==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461239292", "bodyText": "What about c-core? @markdroth I think c-core has subchannel pool so it's free to have any level structure, but isn't that code path complex?", "author": "dapengzhang0", "createdAt": "2020-07-28T00:04:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI1NTgwOQ==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461255809", "bodyText": "Right, the action section in the gRFC does seem out of date. I will update.", "author": "menghanl", "createdAt": "2020-07-28T01:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI1NzY3Nw==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461257677", "bodyText": "They will all be moved into ConfigSelector. The load balancing config returned to the channel by resolver will no longer contain routing and weighted_target policies. The gRFC is just for the time we were on the stage of designing traffic splitting and routing. It become obsolete nowadays. Maybe it would be a good idea to combine it with RouteAction's gRFC.", "author": "voidzcy", "createdAt": "2020-07-28T01:07:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYyNDY0MQ==", "url": "https://github.com/grpc/grpc-java/pull/7251#discussion_r461624641", "bodyText": "C-core could have implemented the optimization of directly using the CDS LB policy, but it looks like we didn't actually do so.  We will always configure the xds_routing policy as the top-level policy, even if there is only one route.\nIn any case, as Chengyuan mentioned, this doesn't really matter very much anymore, since we're going to move all of this code into the ConfigSelector as part of implementing the RouteAction design.", "author": "markdroth", "createdAt": "2020-07-28T14:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjE0NQ=="}], "type": "inlineReview"}, {"oid": "70ac69c77d7463268d8393a2e014f4ac67c5b4b1", "url": "https://github.com/grpc/grpc-java/commit/70ac69c77d7463268d8393a2e014f4ac67c5b4b1", "message": "revert assertConfigUpdateContainsSingleClusterRoute test change", "committedDate": "2020-07-27T23:07:51Z", "type": "commit"}]}