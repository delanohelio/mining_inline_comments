{"pr_number": 6794, "pr_title": "all: refactor select lb policy from a list of raw configs", "pr_createdAt": "2020-03-03T00:56:48Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6794", "timeline": [{"oid": "6775eb1e710f6144368f521ff356ff410ad1e457", "url": "https://github.com/grpc/grpc-java/commit/6775eb1e710f6144368f521ff356ff410ad1e457", "message": "all: refactor select lb policy from a list of raw configs", "committedDate": "2020-03-03T00:54:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0NzQ0Mw==", "url": "https://github.com/grpc/grpc-java/pull/6794#discussion_r386747443", "bodyText": "This is not necessary, even if you have a field marked as deprecated. You are not using something defined somewhere else that is deprecated.", "author": "voidzcy", "createdAt": "2020-03-03T01:17:53Z", "path": "core/src/main/java/io/grpc/internal/ServiceConfigUtil.java", "diffHunk": "@@ -367,4 +405,53 @@ public String toString() {\n           .toString();\n     }\n   }\n+\n+  @SuppressWarnings(\"deprecation\")", "originalCommit": "6775eb1e710f6144368f521ff356ff410ad1e457", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5MzM4Mw==", "url": "https://github.com/grpc/grpc-java/pull/6794#discussion_r387193383", "bodyText": "You would need public getters.", "author": "voidzcy", "createdAt": "2020-03-03T17:56:14Z", "path": "core/src/main/java/io/grpc/internal/ServiceConfigUtil.java", "diffHunk": "@@ -367,4 +405,53 @@ public String toString() {\n           .toString();\n     }\n   }\n+\n+  @SuppressWarnings(\"deprecation\")\n+  public static final class PolicySelection {\n+    final LoadBalancerProvider provider;", "originalCommit": "6775eb1e710f6144368f521ff356ff410ad1e457", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5NjQ1OA==", "url": "https://github.com/grpc/grpc-java/pull/6794#discussion_r387196458", "bodyText": "Reformat this into one line.", "author": "voidzcy", "createdAt": "2020-03-03T18:01:59Z", "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancerProvider.java", "diffHunk": "@@ -114,36 +111,16 @@ public ConfigOrError parseLoadBalancingPolicyConfig(Map<String, ?> rawConfig) {\n               \"No child policy for action \" + name + \" in xds_routing LB policy: \"\n                   + rawConfig));\n         }\n-        boolean targetParsingSucceeded = false;\n-        for (LbConfig lbConfig : childConfigCandidates) {\n-          String policyName = lbConfig.getPolicyName();\n-          LoadBalancerProvider lbProvider = loadBalancerRegistry().getProvider(policyName);\n-          if (lbProvider == null) {\n-            logger.log(\n-                Level.FINEST,\n-                \"The policy for {0} is not available in xds_routing LB policy: {1}\",\n-                new Object[]{policyName, rawConfig});\n-          } else {\n-            ConfigOrError parsedLbPolicyConfig = lbProvider\n-                .parseLoadBalancingPolicyConfig(lbConfig.getRawConfigValue());\n-            if (parsedLbPolicyConfig.getError() != null) {\n-              // Based on service config error-handling spec, if the chosen config is found invalid\n-              // while other configs that come later were valid, the gRPC config would still be\n-              // considered invalid as a whole.\n-              return parsedLbPolicyConfig;\n-            }\n-            parsedActions.put(\n-                name,\n-                new ChildConfig(policyName, parsedLbPolicyConfig.getConfig()));\n-            targetParsingSucceeded = true;\n-            break;\n-          }\n-        }\n-        if (!targetParsingSucceeded) {\n-          return ConfigOrError.fromError(Status.INTERNAL.withDescription(\n-              \"No child policy available for action \" + name + \" in xds_routing LB policy: \"\n-                  + rawConfig));\n+\n+        ConfigOrError selectedConfigOrError =\n+            ServiceConfigUtil.selectLbPolicyFromList(childConfigCandidates, loadBalancerRegistry());\n+        if (selectedConfigOrError.getError() != null) {\n+          return selectedConfigOrError;\n         }\n+\n+        parsedActions.put(", "originalCommit": "6775eb1e710f6144368f521ff356ff410ad1e457", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f8705309e9cdf49f6b8b79f8681bee4eb22bb46e", "url": "https://github.com/grpc/grpc-java/commit/f8705309e9cdf49f6b8b79f8681bee4eb22bb46e", "message": "fix review comments", "committedDate": "2020-03-03T18:32:35Z", "type": "commit"}]}