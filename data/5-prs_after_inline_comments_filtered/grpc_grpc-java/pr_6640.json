{"pr_number": 6640, "pr_title": "xds: fix bug of xDS resolver parsing service config incorrectly", "pr_createdAt": "2020-01-24T18:59:08Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6640", "timeline": [{"oid": "2bc31eba5c4da9422cc2b7fef938abbc018b0f66", "url": "https://github.com/grpc/grpc-java/commit/2bc31eba5c4da9422cc2b7fef938abbc018b0f66", "message": "Fix bug of XdsNameResolver parsing service config incorrectly.", "committedDate": "2020-01-24T19:11:58Z", "type": "commit"}, {"oid": "2bc31eba5c4da9422cc2b7fef938abbc018b0f66", "url": "https://github.com/grpc/grpc-java/commit/2bc31eba5c4da9422cc2b7fef938abbc018b0f66", "message": "Fix bug of XdsNameResolver parsing service config incorrectly.", "committedDate": "2020-01-24T19:11:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgxNzMyMA==", "url": "https://github.com/grpc/grpc-java/pull/6640#discussion_r370817320", "bodyText": "nit: I think the goal of the test should be verifying result.getServiceConfig() is updated.\nObject fakeParsedConfig = new Object();\nwhen(serviceConfigParser.parseServiceConfig(anyMap)).return(ConfigOrError.fromConfig(fakeParsedConfig));\n...\nverify(serviceConfigParser).parseServiceConfig(eq(serviceConfig));\nassertThat(result.getServiceConfig().getConfig()).isEqualTo(fakeParsedConfig);", "author": "dapengzhang0", "createdAt": "2020-01-24T19:59:29Z", "path": "xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java", "diffHunk": "@@ -260,6 +260,7 @@ public void resolve_foundResource() {\n     assertThat(result.getAddresses()).isEmpty();\n     Map<String, ?> serviceConfig =\n         result.getAttributes().get(GrpcAttributes.NAME_RESOLVER_SERVICE_CONFIG);\n+    verify(serviceConfigParser).parseServiceConfig(eq(serviceConfig));", "originalCommit": "2bc31eba5c4da9422cc2b7fef938abbc018b0f66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2OTA3Nw==", "url": "https://github.com/grpc/grpc-java/pull/6640#discussion_r370869077", "bodyText": "Changed a bit. This should cover the invocation of ResolutionResult#setServiceConfig(...).", "author": "voidzcy", "createdAt": "2020-01-24T22:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgxNzMyMA=="}], "type": "inlineReview"}, {"oid": "08681b5aba8c45c1aab529dbbe5b50672a667a6a", "url": "https://github.com/grpc/grpc-java/commit/08681b5aba8c45c1aab529dbbe5b50672a667a6a", "message": "Use a fake identity service config parser for testing, cover invocation of ResolutionResult#setServiceConfig(...).", "committedDate": "2020-01-24T22:23:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3NTQwNA==", "url": "https://github.com/grpc/grpc-java/pull/6640#discussion_r370875404", "bodyText": "assertThat(result.getServiceConfig()).isEqualTo(\n    serviceConfigParser.parseServiceConfig(serviceConfig));", "author": "dapengzhang0", "createdAt": "2020-01-24T22:46:31Z", "path": "xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java", "diffHunk": "@@ -260,7 +266,7 @@ public void resolve_foundResource() {\n     assertThat(result.getAddresses()).isEmpty();\n     Map<String, ?> serviceConfig =\n         result.getAttributes().get(GrpcAttributes.NAME_RESOLVER_SERVICE_CONFIG);\n-    verify(serviceConfigParser).parseServiceConfig(eq(serviceConfig));\n+    assertThat(result.getServiceConfig().getConfig()).isEqualTo(serviceConfig);", "originalCommit": "08681b5aba8c45c1aab529dbbe5b50672a667a6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3ODgwOQ==", "url": "https://github.com/grpc/grpc-java/pull/6640#discussion_r370878809", "bodyText": "Wait wait. That's not correct. I use a fake ServiceConfigParser, which is an identity parser, returns the raw map back. So it is known that the result is equal to the original service config map. isEqualTo(serviceConfigParser.parseServiceConfig(serviceConfig)) includes verification for the fake ServiceConfigParser's implementation.", "author": "voidzcy", "createdAt": "2020-01-24T22:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3NTQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3OTk5Nw==", "url": "https://github.com/grpc/grpc-java/pull/6640#discussion_r370879997", "bodyText": "No. assertThat(result.getServiceConfig().getConfig()).isEqualTo(serviceConfig) includes verification for the fake ServiceConfigParser's implementation. Because in general it does not and should not equal to serviceConfig, only for your particular test code parser implementation it is equal.\nOn the other hand result.getServiceConfig() is always equal to serviceConfigParser.parseServiceConfig(serviceConfig) regardless of parser implementation.", "author": "dapengzhang0", "createdAt": "2020-01-24T23:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3NTQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4NzU5Ng==", "url": "https://github.com/grpc/grpc-java/pull/6640#discussion_r370887596", "bodyText": "Take my words back from my previous comment, that's not the case. The fake ServiceConfigParser's implementation is in the recipe of producing the test outcome. However, assertThat(result.getServiceConfig()).isEqualTo( serviceConfigParser.parseServiceConfig(serviceConfig)); is trying to cancel the effect of input in test's output. So the net outcome is nothing, we just ran the code under test once. Nothing is actually verified. This is like doing x + 1 = x + 1.", "author": "voidzcy", "createdAt": "2020-01-24T23:39:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3NTQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MDE0NQ==", "url": "https://github.com/grpc/grpc-java/pull/6640#discussion_r370890145", "bodyText": "assertThat(result.getServiceConfig()).isEqualTo( serviceConfigParser.parseServiceConfig(serviceConfig)); is trying to cancel the effect of input in test's output\n\nI don't understand the above.\nIf XdsNameResolver has a bug and does not update the listener result, or if it updates the listener result with a wrong ConfigOrError, then assertThat(result.getServiceConfig()).isEqualTo( serviceConfigParser.parseServiceConfig(serviceConfig)) will fail, but something like x + 1 = x + 1 does not fail.", "author": "dapengzhang0", "createdAt": "2020-01-24T23:53:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3NTQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MDk0Mw==", "url": "https://github.com/grpc/grpc-java/pull/6640#discussion_r370890943", "bodyText": "assertThat(result.getServiceConfig()).isEqualTo( serviceConfigParser.parseServiceConfig(serviceConfig)) makes the fake ServiceConfigParser code garbage.", "author": "voidzcy", "createdAt": "2020-01-24T23:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3NTQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MjI1OA==", "url": "https://github.com/grpc/grpc-java/pull/6640#discussion_r370892258", "bodyText": "Why do you need fake ServiceConfigParser implementation be critical? Shouldn't its implementation a garbage implementation just to distinguish the argument?", "author": "dapengzhang0", "createdAt": "2020-01-25T00:05:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3NTQwNA=="}], "type": "inlineReview"}]}