{"pr_number": 7523, "pr_title": "xds: simplify XdsClient APIs to start load reporting automatically when the first stats is added ", "pr_createdAt": "2020-10-15T03:08:45Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7523", "timeline": [{"oid": "0f267e083f3c2033a5dc7167b236a2a97f2137e9", "url": "https://github.com/grpc/grpc-java/commit/0f267e083f3c2033a5dc7167b236a2a97f2137e9", "message": "Only one stopwatch is needed for the LoadReportClient.", "committedDate": "2020-10-15T03:04:03Z", "type": "commit"}, {"oid": "08d90d2736fdd77953044f3a72ab9174a2223507", "url": "https://github.com/grpc/grpc-java/commit/08d90d2736fdd77953044f3a72ab9174a2223507", "message": "Eliminate reportClientStats/cancelClientStatsReport APIs.", "committedDate": "2020-10-15T03:04:50Z", "type": "commit"}, {"oid": "204186c5d432f400b56ce17024c483327e5efa09", "url": "https://github.com/grpc/grpc-java/commit/204186c5d432f400b56ce17024c483327e5efa09", "message": "Start load reporting internally in XdsClient in the first call of addClusterStats.", "committedDate": "2020-10-15T03:06:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkxNDg0Ng==", "url": "https://github.com/grpc/grpc-java/pull/7523#discussion_r505914846", "bodyText": "The purpose of using a supplier is to let this class own and solely manage the state of the stopwatch. Passing in a stopwatch instance in the constructor does not prevent the stopwatch instance from being shared and reset() outside this class from API perspective. You either call supplier.get() inside or outside the constructor, but I think the original version of constructor can not be misused.", "author": "dapengzhang0", "createdAt": "2020-10-15T23:11:30Z", "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -77,13 +76,13 @@\n       SynchronizationContext syncContext,\n       ScheduledExecutorService scheduledExecutorService,\n       BackoffPolicy.Provider backoffPolicyProvider,\n-      Supplier<Stopwatch> stopwatchSupplier) {\n+      Stopwatch stopwatch) {\n     this.loadStatsManager = checkNotNull(loadStatsManager, \"loadStatsManager\");\n     this.xdsChannel = checkNotNull(xdsChannel, \"xdsChannel\");\n     this.syncContext = checkNotNull(syncContext, \"syncContext\");\n     this.timerService = checkNotNull(scheduledExecutorService, \"timeService\");\n     this.backoffPolicyProvider = checkNotNull(backoffPolicyProvider, \"backoffPolicyProvider\");\n-    this.retryStopwatch = checkNotNull(stopwatchSupplier, \"stopwatchSupplier\").get();\n+    this.stopwatch = checkNotNull(stopwatch, \"stopwatch\");", "originalCommit": "204186c5d432f400b56ce17024c483327e5efa09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkyNDM0OA==", "url": "https://github.com/grpc/grpc-java/pull/7523#discussion_r505924348", "bodyText": "Yeah, you are right. I can change this back.", "author": "voidzcy", "createdAt": "2020-10-15T23:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkxNDg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkyNjI2MA==", "url": "https://github.com/grpc/grpc-java/pull/7523#discussion_r505926260", "bodyText": "Changed back.", "author": "voidzcy", "createdAt": "2020-10-15T23:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkxNDg0Ng=="}], "type": "inlineReview"}, {"oid": "69044b7c3945ba3349e67f7fb63906829cca73f2", "url": "https://github.com/grpc/grpc-java/commit/69044b7c3945ba3349e67f7fb63906829cca73f2", "message": "Change back to pass a stopwatch supplier into LoadReportClient.", "committedDate": "2020-10-15T23:48:21Z", "type": "commit"}]}