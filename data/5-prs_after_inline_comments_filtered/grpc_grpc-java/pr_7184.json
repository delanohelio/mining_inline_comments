{"pr_number": 7184, "pr_title": "xds: parse resources in ADS response to envoy-api v3 objects", "pr_createdAt": "2020-07-06T21:55:18Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7184", "timeline": [{"oid": "a67afdb16a742ac9499021eee993df10938ea0cd", "url": "https://github.com/grpc/grpc-java/commit/a67afdb16a742ac9499021eee993df10938ea0cd", "message": "update import.sh to include v3 proto", "committedDate": "2020-07-06T21:53:00Z", "type": "commit"}, {"oid": "28003670d5b496ba664a92f98e864818fdec43ea", "url": "https://github.com/grpc/grpc-java/commit/28003670d5b496ba664a92f98e864818fdec43ea", "message": "import v3 proto", "committedDate": "2020-07-06T21:53:19Z", "type": "commit"}, {"oid": "abeedb722089f0b5c4f729a053d2ab29787351f6", "url": "https://github.com/grpc/grpc-java/commit/abeedb722089f0b5c4f729a053d2ab29787351f6", "message": "parse resources in ADS response to v3 objects", "committedDate": "2020-07-06T22:02:06Z", "type": "forcePushed"}, {"oid": "054a531a4ab2d2bbd1f65888fc084ea35b48fac1", "url": "https://github.com/grpc/grpc-java/commit/054a531a4ab2d2bbd1f65888fc084ea35b48fac1", "message": "parse resources in ADS response to v3 objects", "committedDate": "2020-07-06T22:05:37Z", "type": "forcePushed"}, {"oid": "d26dd19f2fe37d9e6b945c0d519c3580c73323c2", "url": "https://github.com/grpc/grpc-java/commit/d26dd19f2fe37d9e6b945c0d519c3580c73323c2", "message": "parse resources in ADS response to v3 objects", "committedDate": "2020-07-06T22:16:33Z", "type": "commit"}, {"oid": "d26dd19f2fe37d9e6b945c0d519c3580c73323c2", "url": "https://github.com/grpc/grpc-java/commit/d26dd19f2fe37d9e6b945c0d519c3580c73323c2", "message": "parse resources in ADS response to v3 objects", "committedDate": "2020-07-06T22:16:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzNzEyNQ==", "url": "https://github.com/grpc/grpc-java/pull/7184#discussion_r450537125", "bodyText": "nit: 10_000. But usually we only do this kind of format for long type (10_000L).", "author": "voidzcy", "createdAt": "2020-07-06T23:52:40Z", "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -394,6 +430,32 @@ static DropOverload fromEnvoyProtoDropOverload(\n       return new DropOverload(proto.getCategory(), numerator);\n     }\n \n+    @VisibleForTesting\n+    static DropOverload fromEnvoyProtoDropOverloadV2(\n+        io.envoyproxy.envoy.api.v2.ClusterLoadAssignment.Policy.DropOverload proto) {\n+      io.envoyproxy.envoy.type.FractionalPercent percent = proto.getDropPercentage();\n+      int numerator = percent.getNumerator();\n+      io.envoyproxy.envoy.type.FractionalPercent.DenominatorType type = percent.getDenominator();\n+      switch (type) {\n+        case TEN_THOUSAND:\n+          numerator *= 100;\n+          break;\n+        case HUNDRED:\n+          numerator *= 100_00;", "originalCommit": "d26dd19f2fe37d9e6b945c0d519c3580c73323c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0OTA1Nw==", "url": "https://github.com/grpc/grpc-java/pull/7184#discussion_r450549057", "bodyText": "Done.", "author": "dapengzhang0", "createdAt": "2020-07-07T00:37:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzNzEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzOTg5Mg==", "url": "https://github.com/grpc/grpc-java/pull/7184#discussion_r450539892", "bodyText": "nit: this line can be shrunk to the previous one. Same for below.", "author": "voidzcy", "createdAt": "2020-07-07T00:02:38Z", "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -299,18 +322,31 @@ public String toString() {\n     }\n \n     static LbEndpoint fromEnvoyProtoLbEndpoint(\n+        io.envoyproxy.envoy.config.endpoint.v3.LbEndpoint proto) {\n+      io.envoyproxy.envoy.config.core.v3.SocketAddress socketAddress =\n+          proto.getEndpoint().getAddress().getSocketAddress();\n+      InetSocketAddress addr =\n+          new InetSocketAddress(socketAddress.getAddress(), socketAddress.getPortValue());\n+      return new LbEndpoint(\n+          new EquivalentAddressGroup(ImmutableList.<java.net.SocketAddress>of(addr)),\n+          proto.getLoadBalancingWeight().getValue(),\n+          proto.getHealthStatus() == io.envoyproxy.envoy.config.core.v3.HealthStatus.HEALTHY\n+              || proto.getHealthStatus()\n+                  == io.envoyproxy.envoy.config.core.v3.HealthStatus.UNKNOWN);", "originalCommit": "d26dd19f2fe37d9e6b945c0d519c3580c73323c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0OTAyOA==", "url": "https://github.com/grpc/grpc-java/pull/7184#discussion_r450549028", "bodyText": "Done for below. Though this line can not be shrunk because otherwise the length would be 101 chars.", "author": "dapengzhang0", "createdAt": "2020-07-07T00:37:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzOTg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NTEzOA==", "url": "https://github.com/grpc/grpc-java/pull/7184#discussion_r450545138", "bodyText": "We should either use all v2 or all v3 messages for tests, but not a mix of both (although both can be handled). But we should just choose one version for all unit tests.", "author": "voidzcy", "createdAt": "2020-07-07T00:22:27Z", "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -148,7 +148,15 @@ public String toString() {\n       this.subZone = subZone;\n     }\n \n-    static Locality fromEnvoyProtoLocality(io.envoyproxy.envoy.api.v2.core.Locality locality) {\n+    static Locality fromEnvoyProtoLocality(io.envoyproxy.envoy.config.core.v3.Locality locality) {\n+      return new Locality(\n+          /* region = */ locality.getRegion(),\n+          /* zone = */ locality.getZone(),\n+          /* subZone = */ locality.getSubZone());\n+    }\n+\n+    @VisibleForTesting\n+    static Locality fromEnvoyProtoLocalityV2(io.envoyproxy.envoy.api.v2.core.Locality locality) {", "originalCommit": "d26dd19f2fe37d9e6b945c0d519c3580c73323c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NzQyNw==", "url": "https://github.com/grpc/grpc-java/pull/7184#discussion_r450547427", "bodyText": "V2 messages are used in the tests with a server sending response. We only test server sending v2 messages. There is no mix. Some v3 messages in the tests are testing EnvoyProtoData and some utils methods, not server response.", "author": "dapengzhang0", "createdAt": "2020-07-07T00:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NTEzOA=="}], "type": "inlineReview"}, {"oid": "59c2753fb221629712ec42bd77a9aa7f54bf80bb", "url": "https://github.com/grpc/grpc-java/commit/59c2753fb221629712ec42bd77a9aa7f54bf80bb", "message": "reformat line break", "committedDate": "2020-07-07T00:33:44Z", "type": "commit"}, {"oid": "89d0ca61e6712cfbebe023123cc18e789da6ae2c", "url": "https://github.com/grpc/grpc-java/commit/89d0ca61e6712cfbebe023123cc18e789da6ae2c", "message": "fix nit", "committedDate": "2020-07-07T00:35:38Z", "type": "commit"}]}