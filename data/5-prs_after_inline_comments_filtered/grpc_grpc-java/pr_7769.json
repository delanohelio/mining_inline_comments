{"pr_number": 7769, "pr_title": "xds: wire up re-resolution requests from LB policies for DNS clusters and bypass requests from LB policies for EDS clusters", "pr_createdAt": "2020-12-29T23:31:34Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7769", "timeline": [{"oid": "c4351c2447785e0131c682b403a354172bd929ab", "url": "https://github.com/grpc/grpc-java/commit/c4351c2447785e0131c682b403a354172bd929ab", "message": "Handle DNS resolution refresh from downstream LB policies in cluster_resolver LB policy.", "committedDate": "2020-12-23T05:53:26Z", "type": "commit"}, {"oid": "d642e8c57544ac3c00dba5b6a5755fbe535505de", "url": "https://github.com/grpc/grpc-java/commit/d642e8c57544ac3c00dba5b6a5755fbe535505de", "message": "Add ignore_reresolution field to PriorityLb policy config's per-priority config.", "committedDate": "2020-12-29T23:14:28Z", "type": "commit"}, {"oid": "b718304eab6d30328ce8630e63537926b94a6bd1", "url": "https://github.com/grpc/grpc-java/commit/b718304eab6d30328ce8630e63537926b94a6bd1", "message": "Bypass reresolution requests from downstream LB policies if its config specifies so.", "committedDate": "2020-12-29T23:15:40Z", "type": "commit"}, {"oid": "8fdf1a2378476f079fe45d4798265b77102dd746", "url": "https://github.com/grpc/grpc-java/commit/8fdf1a2378476f079fe45d4798265b77102dd746", "message": "Put ignore_reresolution=true for EDS cluter's priority config and ignore_reresolution=false for DNS cluster's.", "committedDate": "2020-12-29T23:17:18Z", "type": "commit"}, {"oid": "bf8ef3637442e89b511aff359a47534f75b04dfe", "url": "https://github.com/grpc/grpc-java/commit/bf8ef3637442e89b511aff359a47534f75b04dfe", "message": "Fix PriorityLbConfig usage in EDS LB policy accordingly.", "committedDate": "2020-12-29T23:17:46Z", "type": "commit"}, {"oid": "77ae013f99dfdc75b9d00c8b8803ba6fd3f0cfbc", "url": "https://github.com/grpc/grpc-java/commit/77ae013f99dfdc75b9d00c8b8803ba6fd3f0cfbc", "message": "Fix formatting.", "committedDate": "2020-12-30T02:01:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NzE3OA==", "url": "https://github.com/grpc/grpc-java/pull/7769#discussion_r552887178", "bodyText": "Also call delegate. refreshNameResolution()?", "author": "dapengzhang0", "createdAt": "2021-01-06T18:25:13Z", "path": "xds/src/main/java/io/grpc/xds/ClusterResolverLoadBalancer.java", "diffHunk": "@@ -273,6 +275,31 @@ private void handleEndpointResolutionError() {\n       }\n     }\n \n+    /**\n+     * Wires re-resolution requests from downstream LB policies with DNS resolver.\n+     */\n+    private final class RefreshableHelper extends ForwardingLoadBalancerHelper {\n+      private final Helper delegate;\n+\n+      private RefreshableHelper(Helper delegate) {\n+        this.delegate = checkNotNull(delegate, \"delegate\");\n+      }\n+\n+      @Override\n+      public void refreshNameResolution() {\n+        for (ClusterState state : clusterStates.values()) {\n+          if (state instanceof LogicalDnsClusterState) {\n+            ((LogicalDnsClusterState) state).refresh();\n+          }\n+        }", "originalCommit": "77ae013f99dfdc75b9d00c8b8803ba6fd3f0cfbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjkyNjY1OA==", "url": "https://github.com/grpc/grpc-java/pull/7769#discussion_r552926658", "bodyText": "Hmm... I don't think so. We can think of this wrap as a complete override instead of an extension.\nFrom the high-level design view, we shouldn't. It does nothing even if we call delegate.refreshNameResolution() as this is how xDS works (async resolver). Previously we did not explicitly override this API because to bypass re-resolution requests to the xDS resolver  since we know it does nothing. Not bother write code to turn some operation into no-op given that it's already a no-op. Same would apply here, not bother explicitly add operations that known to be no-op.", "author": "voidzcy", "createdAt": "2021-01-06T19:44:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NzE3OA=="}], "type": "inlineReview"}, {"oid": "fa85e70c82032963936ff5b30afccdeb50c3f1a9", "url": "https://github.com/grpc/grpc-java/commit/fa85e70c82032963936ff5b30afccdeb50c3f1a9", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/wire_up_dns_cluster_reresolution", "committedDate": "2021-01-07T19:26:43Z", "type": "commit"}]}