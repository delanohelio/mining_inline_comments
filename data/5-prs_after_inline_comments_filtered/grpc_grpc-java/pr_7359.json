{"pr_number": 7359, "pr_title": "Channel builders extend public API", "pr_createdAt": "2020-08-25T21:56:20Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7359", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc5MzA4Nw==", "url": "https://github.com/grpc/grpc-java/pull/7359#discussion_r476793087", "bodyText": "Note: this and corresponding methods of InternalNettyChannelBuilder are here only to smooth out the transition of google internal classes. To be removed when they are updated to use disableCheckAuthority().", "author": "sergiitk", "createdAt": "2020-08-25T22:18:36Z", "path": "core/src/main/java/io/grpc/internal/ManagedChannelImplBuilder.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.internal;\n+\n+import com.google.common.base.Preconditions;\n+import io.grpc.ManagedChannelBuilder;\n+import java.net.SocketAddress;\n+import java.util.concurrent.Executor;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Default managed channel builder, for usage in Transport implementations.\n+ */\n+public final class ManagedChannelImplBuilder\n+    extends AbstractManagedChannelImplBuilder<ManagedChannelImplBuilder> {\n+\n+  private boolean authorityCheckerDisabled;\n+  @Deprecated\n+  @Nullable\n+  private OverrideAuthorityChecker authorityChecker;\n+\n+  /**\n+   * An interface for Transport implementors to provide the {@link ClientTransportFactory}\n+   * appropriate for the channel.\n+   */\n+  public interface ClientTransportFactoryBuilder {\n+    ClientTransportFactory buildClientTransportFactory();\n+  }\n+\n+  /**\n+   * An interface for Transport implementors to provide a default port to {@link\n+   * io.grpc.NameResolver} for use in cases where the target string doesn't include a port. The\n+   * default implementation returns {@link GrpcUtil#DEFAULT_PORT_SSL}.\n+   */\n+  public interface ChannelBuilderDefaultPortProvider {\n+    int getDefaultPort();\n+  }\n+\n+  private class ManagedChannelDefaultPortProvider implements ChannelBuilderDefaultPortProvider {\n+    @Override\n+    public int getDefaultPort() {\n+      return ManagedChannelImplBuilder.super.getDefaultPort();\n+    }\n+  }\n+\n+  private final ClientTransportFactoryBuilder clientTransportFactoryBuilder;\n+  private final ChannelBuilderDefaultPortProvider channelBuilderDefaultPortProvider;\n+\n+  /**\n+   * Creates a new managed channel builder with a target string, which can be either a valid {@link\n+   * io.grpc.NameResolver}-compliant URI, or an authority string. Transport implementors must\n+   * provide client transport factory builder, and may set custom channel default port provider.\n+   */\n+  public ManagedChannelImplBuilder(String target,\n+      ClientTransportFactoryBuilder clientTransportFactoryBuilder,\n+      @Nullable ChannelBuilderDefaultPortProvider channelBuilderDefaultPortProvider) {\n+    super(target);\n+    this.clientTransportFactoryBuilder = Preconditions.checkNotNull(clientTransportFactoryBuilder,\n+        \"clientTransportFactoryBuilder cannot be null\");\n+\n+    if (channelBuilderDefaultPortProvider != null) {\n+      this.channelBuilderDefaultPortProvider = channelBuilderDefaultPortProvider;\n+    } else {\n+      this.channelBuilderDefaultPortProvider = new ManagedChannelDefaultPortProvider();\n+    }\n+  }\n+\n+  /**\n+   * Creates a new managed channel builder with the given server address, authority string of the\n+   * channel. Transport implementors must provide client transport factory builder, and may set\n+   * custom channel default port provider.\n+   */\n+  public ManagedChannelImplBuilder(SocketAddress directServerAddress, String authority,\n+      ClientTransportFactoryBuilder clientTransportFactoryBuilder,\n+      @Nullable ChannelBuilderDefaultPortProvider channelBuilderDefaultPortProvider) {\n+    super(directServerAddress, authority);\n+    this.clientTransportFactoryBuilder = Preconditions.checkNotNull(clientTransportFactoryBuilder,\n+        \"clientTransportFactoryBuilder cannot be null\");\n+\n+    if (channelBuilderDefaultPortProvider != null) {\n+      this.channelBuilderDefaultPortProvider = channelBuilderDefaultPortProvider;\n+    } else {\n+      this.channelBuilderDefaultPortProvider = new ManagedChannelDefaultPortProvider();\n+    }\n+  }\n+\n+  @Override\n+  protected ClientTransportFactory buildTransportFactory() {\n+    return clientTransportFactoryBuilder.buildClientTransportFactory();\n+  }\n+\n+  @Override\n+  protected int getDefaultPort() {\n+    return channelBuilderDefaultPortProvider.getDefaultPort();\n+  }\n+\n+  /** Disable the check whether the authority is valid. */\n+  public ManagedChannelImplBuilder disableCheckAuthority() {\n+    authorityCheckerDisabled = true;\n+    return this;\n+  }\n+\n+  /** Enable previously disabled authority check. */\n+  public ManagedChannelImplBuilder enableCheckAuthority() {\n+    authorityCheckerDisabled = false;\n+    return this;\n+  }\n+\n+  @Deprecated\n+  public interface OverrideAuthorityChecker {\n+    String checkAuthority(String authority);\n+  }\n+\n+  @Deprecated\n+  public void overrideAuthorityChecker(@Nullable OverrideAuthorityChecker authorityChecker) {", "originalCommit": "7481c2bc79799a6fb1758b361f9c35798e19c139", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1MzI3NQ==", "url": "https://github.com/grpc/grpc-java/pull/7359#discussion_r477553275", "bodyText": "nit: delete this line?", "author": "ejona86", "createdAt": "2020-08-26T19:56:24Z", "path": "core/src/main/java/io/grpc/inprocess/InProcessChannelBuilder.java", "diffHunk": "@@ -67,18 +70,36 @@ public static InProcessChannelBuilder forAddress(String name, int port) {\n     throw new UnsupportedOperationException(\"call forName() instead\");\n   }\n \n+  private final ManagedChannelImplBuilder managedChannelImplBuilder;\n   private final String name;\n   private ScheduledExecutorService scheduledExecutorService;\n   private int maxInboundMetadataSize = Integer.MAX_VALUE;\n   private boolean transportIncludeStatusCause = false;\n \n   private InProcessChannelBuilder(String name) {\n-    super(new InProcessSocketAddress(name), \"localhost\");\n+    super();", "originalCommit": "7481c2bc79799a6fb1758b361f9c35798e19c139", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1NjkwNw==", "url": "https://github.com/grpc/grpc-java/pull/7359#discussion_r477556907", "bodyText": "It'd probably good to continue setting this where it was previously. That way if it is used accidentally before it is configured it will cause a NullPointerException. (Or you can move its configuration here, but that is probably opening up trouble given this code uses @Mock.)", "author": "ejona86", "createdAt": "2020-08-26T20:03:05Z", "path": "core/src/test/java/io/grpc/internal/ManagedChannelImplTest.java", "diffHunk": "@@ -269,7 +271,17 @@ public String getPolicyName() {\n   private CallCredentials creds;\n   @Mock\n   private Executor offloadExecutor;\n-  private ChannelBuilder channelBuilder;\n+  private ManagedChannelImplBuilder channelBuilder = new ManagedChannelImplBuilder(TARGET,", "originalCommit": "7481c2bc79799a6fb1758b361f9c35798e19c139", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMwNjM3NQ==", "url": "https://github.com/grpc/grpc-java/pull/7359#discussion_r481306375", "bodyText": "We normally don't bother too much with the strings here. We include them because they are useful as line numbers commonly can't be trusted. But generally we just repeat the variable name: \"clientTransportFactoryBuilder\". It's fine to have more text, but it adds little value for the effort and how often we have to write code like this.\nFeel free to leave this as-is, but you may use the simpler string in the future.", "author": "ejona86", "createdAt": "2020-09-01T17:16:54Z", "path": "core/src/main/java/io/grpc/internal/ManagedChannelImplBuilder.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.internal;\n+\n+import com.google.common.base.Preconditions;\n+import io.grpc.ManagedChannelBuilder;\n+import java.net.SocketAddress;\n+import java.util.concurrent.Executor;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Default managed channel builder, for usage in Transport implementations.\n+ */\n+public final class ManagedChannelImplBuilder\n+    extends AbstractManagedChannelImplBuilder<ManagedChannelImplBuilder> {\n+\n+  private boolean authorityCheckerDisabled;\n+  @Deprecated\n+  @Nullable\n+  private OverrideAuthorityChecker authorityChecker;\n+\n+  /**\n+   * An interface for Transport implementors to provide the {@link ClientTransportFactory}\n+   * appropriate for the channel.\n+   */\n+  public interface ClientTransportFactoryBuilder {\n+    ClientTransportFactory buildClientTransportFactory();\n+  }\n+\n+  /**\n+   * An interface for Transport implementors to provide a default port to {@link\n+   * io.grpc.NameResolver} for use in cases where the target string doesn't include a port. The\n+   * default implementation returns {@link GrpcUtil#DEFAULT_PORT_SSL}.\n+   */\n+  public interface ChannelBuilderDefaultPortProvider {\n+    int getDefaultPort();\n+  }\n+\n+  private class ManagedChannelDefaultPortProvider implements ChannelBuilderDefaultPortProvider {\n+    @Override\n+    public int getDefaultPort() {\n+      return ManagedChannelImplBuilder.super.getDefaultPort();\n+    }\n+  }\n+\n+  private final ClientTransportFactoryBuilder clientTransportFactoryBuilder;\n+  private final ChannelBuilderDefaultPortProvider channelBuilderDefaultPortProvider;\n+\n+  /**\n+   * Creates a new managed channel builder with a target string, which can be either a valid {@link\n+   * io.grpc.NameResolver}-compliant URI, or an authority string. Transport implementors must\n+   * provide client transport factory builder, and may set custom channel default port provider.\n+   */\n+  public ManagedChannelImplBuilder(String target,\n+      ClientTransportFactoryBuilder clientTransportFactoryBuilder,\n+      @Nullable ChannelBuilderDefaultPortProvider channelBuilderDefaultPortProvider) {\n+    super(target);\n+    this.clientTransportFactoryBuilder = Preconditions.checkNotNull(clientTransportFactoryBuilder,\n+        \"clientTransportFactoryBuilder cannot be null\");", "originalCommit": "7481c2bc79799a6fb1758b361f9c35798e19c139", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxMTcxNA==", "url": "https://github.com/grpc/grpc-java/pull/7359#discussion_r481311714", "bodyText": "It seems a hard-coded port is fairly common. It might be fair to create a ManagedChannelImplBuilder.FixedPortProvider (or as a top-level class in core/src/test/io/grpc/internal) which just accepts the port in its constructor. Then you'd use new FixedPortProvider(DEFAULT_PORT).\nNot important, but Fixed* classes for stuff like this is semi-common in our code.", "author": "ejona86", "createdAt": "2020-09-01T17:26:12Z", "path": "core/src/test/java/io/grpc/internal/ServiceConfigErrorHandlingTest.java", "diffHunk": "@@ -153,7 +155,18 @@ public ConfigOrError parseLoadBalancingPolicyConfig(\n   private ObjectPool<Executor> balancerRpcExecutorPool;\n   @Mock\n   private Executor blockingExecutor;\n-  private ChannelBuilder channelBuilder;\n+\n+  private ManagedChannelImplBuilder channelBuilder = new ManagedChannelImplBuilder(TARGET,\n+      new ClientTransportFactoryBuilder() {\n+        @Override public ClientTransportFactory buildClientTransportFactory() {\n+          throw new UnsupportedOperationException();\n+        }\n+      },\n+      new ChannelBuilderDefaultPortProvider() {", "originalCommit": "7481c2bc79799a6fb1758b361f9c35798e19c139", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxMjc2Ng==", "url": "https://github.com/grpc/grpc-java/pull/7359#discussion_r481312766", "bodyText": "nit: remove? Ditto elsewhere.", "author": "ejona86", "createdAt": "2020-09-01T17:28:04Z", "path": "cronet/src/main/java/io/grpc/cronet/CronetChannelBuilder.java", "diffHunk": "@@ -103,12 +108,30 @@ public static CronetChannelBuilder forAddress(String name, int port) {\n   private int trafficStatsUid;\n \n   private CronetChannelBuilder(String host, int port, CronetEngine cronetEngine) {\n-    super(\n+    super();", "originalCommit": "7481c2bc79799a6fb1758b361f9c35798e19c139", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNDA5Nw==", "url": "https://github.com/grpc/grpc-java/pull/7359#discussion_r481314097", "bodyText": "Make some mention of setStatsEnabled() here, so it is clearer the two lines are related. It'd probably be fine to duplicate the builder.intercept(createCensusStatsClientInterceptor()); in both the okhttp and netty paths to keep the two lines together. But separate is fine, as long as we point out they are related.", "author": "ejona86", "createdAt": "2020-09-01T17:30:18Z", "path": "interop-testing/src/main/java/io/grpc/testing/integration/TestServiceClient.java", "diffHunk": "@@ -449,10 +451,10 @@ private void runTest(TestCases testCase) throws Exception {\n         if (fullStreamDecompression) {\n           okBuilder.enableFullStreamDecompression();\n         }\n+        InternalOkHttpChannelBuilder.setStatsEnabled(okBuilder, false);\n         builder = okBuilder;\n       }\n-      // Disable the default census stats interceptor, use testing interceptor instead.\n-      io.grpc.internal.TestingAccessor.setStatsEnabled(builder, false);\n+      // Use testing interceptor instead.", "originalCommit": "7481c2bc79799a6fb1758b361f9c35798e19c139", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNzk5Ng==", "url": "https://github.com/grpc/grpc-java/pull/7359#discussion_r481317996", "bodyText": "Instead, you can mark this method as @Deprecated. That can be a bit more clear that we planned on deleting this method (even if it is a test). Not a big deal in a test though.", "author": "ejona86", "createdAt": "2020-09-01T17:37:28Z", "path": "netty/src/test/java/io/grpc/netty/NettyChannelBuilderTest.java", "diffHunk": "@@ -92,14 +92,35 @@ private void overrideAuthorityIsReadableHelper(NettyChannelBuilder builder,\n   }\n \n   @Test\n+  @SuppressWarnings(\"deprecation\")", "originalCommit": "7481c2bc79799a6fb1758b361f9c35798e19c139", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c73ebc9b24958bfcb015dd0fffec28c403c7f549", "url": "https://github.com/grpc/grpc-java/commit/c73ebc9b24958bfcb015dd0fffec28c403c7f549", "message": "core: add default implementation of managed channel builder", "committedDate": "2020-09-01T23:05:25Z", "type": "forcePushed"}, {"oid": "9cd0e1a8dd414130238d0abb5d6c19d12dd2139b", "url": "https://github.com/grpc/grpc-java/commit/9cd0e1a8dd414130238d0abb5d6c19d12dd2139b", "message": "core, interop: InProcessChannelBuilder extends a public API class", "committedDate": "2020-09-02T02:03:38Z", "type": "forcePushed"}, {"oid": "f14a36cdc082fe84fc5ae5be58f43872bad37e91", "url": "https://github.com/grpc/grpc-java/commit/f14a36cdc082fe84fc5ae5be58f43872bad37e91", "message": "core: add default implementation of managed channel builder", "committedDate": "2020-09-02T16:39:32Z", "type": "commit"}, {"oid": "21c5a8591a08432332bde235ba78fc1740703f9d", "url": "https://github.com/grpc/grpc-java/commit/21c5a8591a08432332bde235ba78fc1740703f9d", "message": "cronet: CronetChannelBuilder extends a public API class", "committedDate": "2020-09-02T16:39:32Z", "type": "commit"}, {"oid": "e3967f2d1042ff357b8db397e7b1d07c76a007a5", "url": "https://github.com/grpc/grpc-java/commit/e3967f2d1042ff357b8db397e7b1d07c76a007a5", "message": "core: InProcessChannelBuilder extends a public API class", "committedDate": "2020-09-02T16:40:30Z", "type": "commit"}, {"oid": "3d7642d80f431edf1a59f837c18e4a194fe430c5", "url": "https://github.com/grpc/grpc-java/commit/3d7642d80f431edf1a59f837c18e4a194fe430c5", "message": "netty: NettyChannelBuilder extends a public API class", "committedDate": "2020-09-02T16:40:33Z", "type": "commit"}, {"oid": "a120cb6b2cc388b77d5f2f98006189a13cbd483a", "url": "https://github.com/grpc/grpc-java/commit/a120cb6b2cc388b77d5f2f98006189a13cbd483a", "message": "okhttp: OkHttpChannelBuilder extends a public API class", "committedDate": "2020-09-02T16:40:35Z", "type": "commit"}, {"oid": "b2365a11f367300962f5ce51dde1c388f86d8b4a", "url": "https://github.com/grpc/grpc-java/commit/b2365a11f367300962f5ce51dde1c388f86d8b4a", "message": "testing: remove channel setStatsEnabled accessor hack", "committedDate": "2020-09-02T16:40:38Z", "type": "commit"}, {"oid": "b2365a11f367300962f5ce51dde1c388f86d8b4a", "url": "https://github.com/grpc/grpc-java/commit/b2365a11f367300962f5ce51dde1c388f86d8b4a", "message": "testing: remove channel setStatsEnabled accessor hack", "committedDate": "2020-09-02T16:40:38Z", "type": "forcePushed"}]}