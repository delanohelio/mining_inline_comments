{"pr_number": 6800, "pr_title": "xds: refactor XdsConfig to use PolicySelection", "pr_createdAt": "2020-03-04T01:07:25Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6800", "timeline": [{"oid": "dda5a77c3418dbb9a56aaba634a649c795ea809f", "url": "https://github.com/grpc/grpc-java/commit/dda5a77c3418dbb9a56aaba634a649c795ea809f", "message": "xds: refactor XdsConfig to use PolicySelection", "committedDate": "2020-03-04T01:06:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2ODE1NQ==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387968155", "bodyText": "Why always add a round_robin policy into child policy? Even if its child policy is not empty.", "author": "voidzcy", "createdAt": "2020-03-04T22:17:09Z", "path": "xds/src/main/java/io/grpc/xds/XdsLoadBalancerProvider.java", "diffHunk": "@@ -78,8 +76,38 @@ static ConfigOrError parseLoadBalancingConfigPolicy(\n       Map<String, ?> rawLoadBalancingPolicyConfig, LoadBalancerRegistry registry) {\n     try {\n       String cluster = JsonUtil.getString(rawLoadBalancingPolicyConfig, \"cluster\");\n-      LbConfig childPolicy = selectChildPolicy(rawLoadBalancingPolicyConfig, registry);\n-      LbConfig fallbackPolicy = selectFallbackPolicy(rawLoadBalancingPolicyConfig, registry);\n+\n+      LbConfig roundRobinConfig = new LbConfig(\"round_robin\", ImmutableMap.<String, Object>of());", "originalCommit": "dda5a77c3418dbb9a56aaba634a649c795ea809f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MTczOA==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387971738", "bodyText": "round_robin is the default policy, if everything in the list is not supported, it will use round_robin instead of error.", "author": "dapengzhang0", "createdAt": "2020-03-04T22:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2ODE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MjM1Ng==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387972356", "bodyText": "Really? That's not the case for the existing implementation.", "author": "voidzcy", "createdAt": "2020-03-04T22:26:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2ODE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5NTczMg==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387995732", "bodyText": "The refactor design doc says so. The existing implementation used hard coded round_robin.", "author": "dapengzhang0", "createdAt": "2020-03-04T23:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2ODE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NTA4NQ==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387985085", "bodyText": "Since now this is the parsed child policy, I think we would make this field non-null.", "author": "voidzcy", "createdAt": "2020-03-04T22:58:17Z", "path": "xds/src/main/java/io/grpc/xds/XdsLoadBalancerProvider.java", "diffHunk": "@@ -92,51 +120,17 @@ static ConfigOrError parseLoadBalancingConfigPolicy(\n     }\n   }\n \n-  @VisibleForTesting\n-  static LbConfig selectFallbackPolicy(\n-      Map<String, ?> rawLoadBalancingPolicyConfig, LoadBalancerRegistry lbRegistry) {\n-    List<LbConfig> fallbackConfigs = ServiceConfigUtil.unwrapLoadBalancingConfigList(\n-        JsonUtil.getListOfObjects(rawLoadBalancingPolicyConfig, \"fallbackPolicy\"));\n-    LbConfig fallbackPolicy = selectSupportedLbPolicy(fallbackConfigs, lbRegistry);\n-    return fallbackPolicy == null ? DEFAULT_FALLBACK_POLICY : fallbackPolicy;\n-  }\n-\n-  @Nullable\n-  @VisibleForTesting\n-  static LbConfig selectChildPolicy(\n-      Map<String, ?> rawLoadBalancingPolicyConfig, LoadBalancerRegistry lbRegistry) {\n-    List<LbConfig> childConfigs = ServiceConfigUtil.unwrapLoadBalancingConfigList(\n-        JsonUtil.getListOfObjects(rawLoadBalancingPolicyConfig, \"childPolicy\"));\n-    return selectSupportedLbPolicy(childConfigs, lbRegistry);\n-  }\n-\n-  @Nullable\n-  private static LbConfig selectSupportedLbPolicy(\n-      @Nullable List<LbConfig> lbConfigs, LoadBalancerRegistry lbRegistry) {\n-    if (lbConfigs == null) {\n-      return null;\n-    }\n-    for (LbConfig lbConfig : lbConfigs) {\n-      String lbPolicy = lbConfig.getPolicyName();\n-      if (lbRegistry.getProvider(lbPolicy) != null) {\n-        return lbConfig;\n-      }\n-    }\n-    return null;\n-  }\n-\n   /**\n    * Represents a successfully parsed and validated LoadBalancingConfig for XDS.\n    */\n   static final class XdsConfig {\n     // FIXME(chengyuanzhang): make cluster name required.\n     @Nullable\n     final String cluster;\n-    // TODO(carl-mastrangelo): make these Object's containing the fully parsed child configs.\n     @Nullable\n-    final LbConfig childPolicy;\n+    final PolicySelection childPolicy;", "originalCommit": "dda5a77c3418dbb9a56aaba634a649c795ea809f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAwNjE1Nw==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r388006157", "bodyText": "Done.", "author": "dapengzhang0", "createdAt": "2020-03-05T00:00:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NTA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NzEwNw==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387987107", "bodyText": "Do we always have a default fallback policy? If it is, this would be non-null.", "author": "voidzcy", "createdAt": "2020-03-04T23:03:54Z", "path": "xds/src/main/java/io/grpc/xds/XdsLoadBalancerProvider.java", "diffHunk": "@@ -92,51 +120,17 @@ static ConfigOrError parseLoadBalancingConfigPolicy(\n     }\n   }\n \n-  @VisibleForTesting\n-  static LbConfig selectFallbackPolicy(\n-      Map<String, ?> rawLoadBalancingPolicyConfig, LoadBalancerRegistry lbRegistry) {\n-    List<LbConfig> fallbackConfigs = ServiceConfigUtil.unwrapLoadBalancingConfigList(\n-        JsonUtil.getListOfObjects(rawLoadBalancingPolicyConfig, \"fallbackPolicy\"));\n-    LbConfig fallbackPolicy = selectSupportedLbPolicy(fallbackConfigs, lbRegistry);\n-    return fallbackPolicy == null ? DEFAULT_FALLBACK_POLICY : fallbackPolicy;\n-  }\n-\n-  @Nullable\n-  @VisibleForTesting\n-  static LbConfig selectChildPolicy(\n-      Map<String, ?> rawLoadBalancingPolicyConfig, LoadBalancerRegistry lbRegistry) {\n-    List<LbConfig> childConfigs = ServiceConfigUtil.unwrapLoadBalancingConfigList(\n-        JsonUtil.getListOfObjects(rawLoadBalancingPolicyConfig, \"childPolicy\"));\n-    return selectSupportedLbPolicy(childConfigs, lbRegistry);\n-  }\n-\n-  @Nullable\n-  private static LbConfig selectSupportedLbPolicy(\n-      @Nullable List<LbConfig> lbConfigs, LoadBalancerRegistry lbRegistry) {\n-    if (lbConfigs == null) {\n-      return null;\n-    }\n-    for (LbConfig lbConfig : lbConfigs) {\n-      String lbPolicy = lbConfig.getPolicyName();\n-      if (lbRegistry.getProvider(lbPolicy) != null) {\n-        return lbConfig;\n-      }\n-    }\n-    return null;\n-  }\n-\n   /**\n    * Represents a successfully parsed and validated LoadBalancingConfig for XDS.\n    */\n   static final class XdsConfig {\n     // FIXME(chengyuanzhang): make cluster name required.\n     @Nullable\n     final String cluster;\n-    // TODO(carl-mastrangelo): make these Object's containing the fully parsed child configs.\n     @Nullable\n-    final LbConfig childPolicy;\n+    final PolicySelection childPolicy;\n     @Nullable\n-    final LbConfig fallbackPolicy;\n+    final PolicySelection fallbackPolicy;", "originalCommit": "dda5a77c3418dbb9a56aaba634a649c795ea809f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5ODAxNQ==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387998015", "bodyText": "Not clear. Currently the CdsLoadBalancer will not create a fallback policy in EDS policy. So it is nullable.", "author": "dapengzhang0", "createdAt": "2020-03-04T23:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAwMTE5Mg==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r388001192", "bodyText": "Hmm, that's bad. We might want to define EdsConfig in EdsLoadBalancerProvider so XdsConfig becomes\nclass XdsConfig {\n  PolicySelection edsPolicy;\n  PolicySelection fallbackPolicy;\n}", "author": "voidzcy", "createdAt": "2020-03-04T23:44:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAwMTk0NQ==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r388001945", "bodyText": "No, we don't know if we eventually will have FallbackPolicy in EdsConfig.", "author": "dapengzhang0", "createdAt": "2020-03-04T23:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NzEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4OTU5NA==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387989594", "bodyText": "I am thinking that, instead of receiving the entire XdsConfig, would it be better to just received the parsed fallback policy (i.e., PolicySelection). In this way, FallbackLb does not receive anything extra other than the policy it needs to instantiate.\nAt the mean time, I am feeling like the layer of FallbackLb is kinda unnecessary. Everything of fallback switching can be implemented in XdsLoadBalancer. The existing FallbackLb is basically doing nothing other than delegating handleResolvedAddresses call to the actual policy, which we can directly handle it in XdsLoadBalancer.", "author": "voidzcy", "createdAt": "2020-03-04T23:10:53Z", "path": "xds/src/main/java/io/grpc/xds/FallbackLb.java", "diffHunk": "@@ -58,55 +45,18 @@ protected LoadBalancer delegate() {\n     return fallbackPolicyLb;\n   }\n \n-  @SuppressWarnings(\"deprecation\")\n   @Override\n   public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n-    Attributes attributes = resolvedAddresses.getAttributes();\n-    XdsConfig xdsConfig;\n-    Object lbConfig = resolvedAddresses.getLoadBalancingPolicyConfig();\n-    if (lbConfig != null) {\n-      if (!(lbConfig instanceof XdsConfig)) {\n-        fallbackLbHelper.updateBalancingState(\n-            TRANSIENT_FAILURE,\n-            new ErrorPicker(Status.UNAVAILABLE.withDescription(\n-                \"Load balancing config '\" + lbConfig + \"' is not an XdsConfig\")));\n-        return;\n-      }\n-      xdsConfig = (XdsConfig) lbConfig;\n-    } else {\n-      // In the future, in all cases xdsConfig can be obtained directly by\n-      // resolvedAddresses.getLoadBalancingPolicyConfig().\n-      Map<String, ?> newRawLbConfig = attributes.get(ATTR_LOAD_BALANCING_CONFIG);\n-      if (newRawLbConfig == null) {\n-        // This will not happen when the service config error handling is implemented.\n-        // For now simply go to TRANSIENT_FAILURE.\n-        fallbackLbHelper.updateBalancingState(\n-            TRANSIENT_FAILURE,\n-            new ErrorPicker(\n-                Status.UNAVAILABLE.withDescription(\"ATTR_LOAD_BALANCING_CONFIG not available\")));\n-        return;\n-      }\n-      ConfigOrError cfg =\n-          XdsLoadBalancerProvider.parseLoadBalancingConfigPolicy(newRawLbConfig, lbRegistry);\n-      if (cfg.getError() != null) {\n-        // This will not happen when the service config error handling is implemented.\n-        // For now simply go to TRANSIENT_FAILURE.\n-        fallbackLbHelper.updateBalancingState(TRANSIENT_FAILURE, new ErrorPicker(cfg.getError()));\n-        return;\n-      }\n-      xdsConfig = (XdsConfig) cfg.getConfig();\n-    }\n-\n-    LbConfig fallbackPolicy = xdsConfig.fallbackPolicy;\n+    XdsConfig xdsConfig = (XdsConfig) resolvedAddresses.getLoadBalancingPolicyConfig();", "originalCommit": "dda5a77c3418dbb9a56aaba634a649c795ea809f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5NzQ1OQ==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387997459", "bodyText": "That's true, however FallbackLb is not actually used and eventually will be re-designed, I don't want to touch this class too much in this PR..", "author": "dapengzhang0", "createdAt": "2020-03-04T23:33:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4OTU5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5MzI2OA==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387993268", "bodyText": "You can directly use real default registry with round_robin included.", "author": "voidzcy", "createdAt": "2020-03-04T23:21:02Z", "path": "xds/src/test/java/io/grpc/xds/XdsLoadBalancerProviderTest.java", "diffHunk": "@@ -73,9 +73,15 @@ public String getPolicyName() {\n     public LoadBalancer newLoadBalancer(Helper helper) {\n       return fakeBalancer1;\n     }\n+\n+    @Override\n+    public ConfigOrError parseLoadBalancingPolicyConfig(\n+        Map<String, ?> rawLoadBalancingPolicyConfig) {\n+      return ConfigOrError.fromConfig(lbConfig1);\n+    }\n   };\n \n-  private final LoadBalancerProvider roundRobin = new LoadBalancerProvider() {\n+  private final LoadBalancerProvider roundRobinProvider = new LoadBalancerProvider() {", "originalCommit": "dda5a77c3418dbb9a56aaba634a649c795ea809f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5OTIwOQ==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r387999209", "bodyText": "I need register lbProvider1 as well. The default registry is global, it's not a good practice to change its state in test.", "author": "dapengzhang0", "createdAt": "2020-03-04T23:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5MzI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAwMjMwOQ==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r388002309", "bodyText": "That's ok, AutoConfiguredLoadBalancerFactoryTest is doing that thing.", "author": "voidzcy", "createdAt": "2020-03-04T23:48:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5MzI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAwNTQ3NA==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r388005474", "bodyText": "That is bad.", "author": "dapengzhang0", "createdAt": "2020-03-04T23:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5MzI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAwNTkzMA==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r388005930", "bodyText": "No, repeating implementation is bad...", "author": "voidzcy", "createdAt": "2020-03-04T23:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5MzI2OA=="}], "type": "inlineReview"}, {"oid": "8b64744a437e88257882a0492d234c8d98d7b7df", "url": "https://github.com/grpc/grpc-java/commit/8b64744a437e88257882a0492d234c8d98d7b7df", "message": "change field name", "committedDate": "2020-03-04T23:44:33Z", "type": "commit"}, {"oid": "2abf29b354f5a1b94f828cb1b928331f5586e24f", "url": "https://github.com/grpc/grpc-java/commit/2abf29b354f5a1b94f828cb1b928331f5586e24f", "message": "checkNotNull", "committedDate": "2020-03-04T23:58:02Z", "type": "commit"}, {"oid": "3d179132e7de0e614840364192006fe832769097", "url": "https://github.com/grpc/grpc-java/commit/3d179132e7de0e614840364192006fe832769097", "message": "not to reimplement round robin provider", "committedDate": "2020-03-05T00:52:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyMjI3MQ==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r388022271", "bodyText": "Wait, why do you do this? I mean you could just use the default registry instance for test.", "author": "voidzcy", "createdAt": "2020-03-05T00:55:53Z", "path": "xds/src/test/java/io/grpc/xds/XdsLoadBalancerProviderTest.java", "diffHunk": "@@ -73,92 +73,30 @@ public String getPolicyName() {\n     public LoadBalancer newLoadBalancer(Helper helper) {\n       return fakeBalancer1;\n     }\n-  };\n-\n-  private final LoadBalancerProvider roundRobin = new LoadBalancerProvider() {\n-    @Override\n-    public boolean isAvailable() {\n-      return true;\n-    }\n-\n-    @Override\n-    public int getPriority() {\n-      return 5;\n-    }\n-\n-    @Override\n-    public String getPolicyName() {\n-      return \"round_robin\";\n-    }\n \n     @Override\n-    public LoadBalancer newLoadBalancer(Helper helper) {\n-      return null;\n+    public ConfigOrError parseLoadBalancingPolicyConfig(\n+        Map<String, ?> rawLoadBalancingPolicyConfig) {\n+      return ConfigOrError.fromConfig(lbConfig1);\n     }\n   };\n \n+  private final LoadBalancerProvider roundRobinProvider =", "originalCommit": "3d179132e7de0e614840364192006fe832769097", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyNDcwMw==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r388024703", "bodyText": "Because I didn't like to modify the global registry.", "author": "dapengzhang0", "createdAt": "2020-03-05T01:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyMjI3MQ=="}], "type": "inlineReview"}, {"oid": "b478982f0948fdda8f026831fb4c4e30a1c3358b", "url": "https://github.com/grpc/grpc-java/commit/b478982f0948fdda8f026831fb4c4e30a1c3358b", "message": "change to use global registry", "committedDate": "2020-03-05T01:03:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzMjc5Mg==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r388032792", "bodyText": "Same for this one.", "author": "voidzcy", "createdAt": "2020-03-05T01:33:19Z", "path": "xds/src/test/java/io/grpc/xds/CdsLoadBalancerTest.java", "diffHunk": "@@ -119,6 +121,34 @@ public LoadBalancer newLoadBalancer(Helper helper) {\n     }\n   };\n \n+  private final LoadBalancerProvider fakeRoundRobinLbProvider = new LoadBalancerProvider() {", "originalCommit": "b478982f0948fdda8f026831fb4c4e30a1c3358b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMDUzMQ==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r389210531", "bodyText": "This one is not using global registry. The test uses a new registry and registers a fake EDS lb provider, because the global registry registers the built-in EDS lb provider.", "author": "dapengzhang0", "createdAt": "2020-03-07T01:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzMjc5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMDk4Mg==", "url": "https://github.com/grpc/grpc-java/pull/6800#discussion_r389210982", "bodyText": "Alright.", "author": "voidzcy", "createdAt": "2020-03-07T01:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzMjc5Mg=="}], "type": "inlineReview"}, {"oid": "366afa0c7afaaba06e54a71636fc4846b668dad6", "url": "https://github.com/grpc/grpc-java/commit/366afa0c7afaaba06e54a71636fc4846b668dad6", "message": "rename childPolicy json key", "committedDate": "2020-03-06T18:03:11Z", "type": "commit"}]}