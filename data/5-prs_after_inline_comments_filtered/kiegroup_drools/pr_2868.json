{"pr_number": 2868, "pr_title": "[DROOLS-5270] Refactored AST factories to avoid duplication ", "pr_createdAt": "2020-04-23T15:49:31Z", "pr_url": "https://github.com/kiegroup/drools/pull/2868", "timeline": [{"oid": "e38cda04a211d7addddeeab913df98d119ecc230", "url": "https://github.com/kiegroup/drools/commit/e38cda04a211d7addddeeab913df98d119ecc230", "message": "[DROOLS-5270] Refactored AST factories to avoid duplication between tree model and scorecard model", "committedDate": "2020-04-23T15:45:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1MDM3Nw==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r413950377", "bodyText": "Can you please double check these changes? Accumulator is an AtomicReference so it is a reference and I don't know how useful could be to compare/hash it.\nDo you compare different KiePMMLStatusHolder instances? When do you expect them to be the same?", "author": "danielezonca", "createdAt": "2020-04-23T16:36:35Z", "path": "kie-pmml-new/kie-pmml-models/kie-pmml-models-drools/kie-pmml-models-drools-common/src/main/java/org/kie/pmml/models/drools/executor/KiePMMLStatusHolder.java", "diffHunk": "@@ -48,11 +62,12 @@ public boolean equals(Object o) {\n             return false;\n         }\n         KiePMMLStatusHolder that = (KiePMMLStatusHolder) o;\n-        return Objects.equals(status, that.status);\n+        return Objects.equals(status, that.status) &&\n+                Objects.equals(accumulator, that.accumulator);\n     }\n \n     @Override\n     public int hashCode() {\n-        return Objects.hash(status);\n+        return Objects.hash(status, accumulator);", "originalCommit": "e38cda04a211d7addddeeab913df98d119ecc230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0OTY4OA==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414349688", "bodyText": "@danielezonca Those equals/hashcode are the one automatically generated by IJ. I usually add them on data classes (like this).", "author": "gitgabrio", "createdAt": "2020-04-24T07:15:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1MDM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1MDkyOA==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r413950928", "bodyText": "When this can happen? Is it an expected condition?", "author": "danielezonca", "createdAt": "2020-04-23T16:37:23Z", "path": "kie-pmml-new/kie-pmml-models/kie-pmml-models-drools/kie-pmml-models-drools-common/src/main/java/org/kie/pmml/models/drools/commons/utils/KiePMMLDroolsModelUtils.java", "diffHunk": "@@ -43,6 +43,9 @@ public static String getSanitizedClassName(String input) {\n      * @return\n      */\n     public static Object getCorrectlyFormattedResult(Object rawValue, DATA_TYPE targetType) {\n+        if (rawValue == null) {\n+            return null;\n+        }", "originalCommit": "e38cda04a211d7addddeeab913df98d119ecc230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1MDM1NQ==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414350355", "bodyText": "@danielezonca\nYes, it is expected and I prefer to manage this in one single place (here).", "author": "gitgabrio", "createdAt": "2020-04-24T07:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1MDkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1NjI1MA==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414356250", "bodyText": "Ok, can you please add this information to the javadoc?", "author": "danielezonca", "createdAt": "2020-04-24T07:27:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1MDkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4OTQ4Nw==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414489487", "bodyText": "@danielezonca\nDone", "author": "gitgabrio", "createdAt": "2020-04-24T11:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1MDkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1NDgxOQ==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r413954819", "bodyText": "If you want prevent external classes to alter the map you should create a new instance here like you are doing in the getter", "author": "danielezonca", "createdAt": "2020-04-23T16:42:53Z", "path": "kie-pmml-new/kie-pmml-models/kie-pmml-models-drools/kie-pmml-models-drools-common/src/main/java/org/kie/pmml/models/drools/ast/factories/PredicateASTFactoryData.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.pmml.models.drools.ast.factories;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.dmg.pmml.Predicate;\n+import org.kie.pmml.commons.model.KiePMMLOutputField;\n+import org.kie.pmml.models.drools.ast.KiePMMLDroolsRule;\n+import org.kie.pmml.models.drools.tuples.KiePMMLOriginalTypeGeneratedType;\n+\n+/**\n+ * Data class to contain objects required by <b>Predicate</b>s concrete ASTFactories\n+ */\n+public class PredicateASTFactoryData {\n+\n+    private final Predicate predicate;\n+    private final List<KiePMMLOutputField> outputFields;\n+    private final List<KiePMMLDroolsRule> rules;\n+    private final String parentPath;\n+    private final String currentRule;\n+    private final Map<String, KiePMMLOriginalTypeGeneratedType> fieldTypeMap;\n+\n+    public PredicateASTFactoryData(Predicate predicate,\n+                                   List<KiePMMLOutputField> outputFields,\n+                                   List<KiePMMLDroolsRule> rules,\n+                                   String parentPath,\n+                                   String currentRule,\n+                                   Map<String, KiePMMLOriginalTypeGeneratedType> fieldTypeMap) {\n+        this.predicate = predicate;\n+        this.outputFields = outputFields;\n+        this.rules = rules;\n+        this.parentPath = parentPath;\n+        this.currentRule = currentRule;\n+        this.fieldTypeMap = fieldTypeMap;", "originalCommit": "e38cda04a211d7addddeeab913df98d119ecc230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM5MjYzNg==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414392636", "bodyText": "@danielezonca\nI've moved the \"immutability\" logic in the constructor itself.", "author": "gitgabrio", "createdAt": "2020-04-24T08:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1NDgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1NTE4MA==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r413955180", "bodyText": "To be removed", "author": "danielezonca", "createdAt": "2020-04-23T16:43:23Z", "path": "kie-pmml-new/kie-pmml-models/kie-pmml-models-drools/kie-pmml-models-drools-common/src/main/java/org/kie/pmml/models/drools/commons/factories/KiePMMLDescrRhsFactory.java", "diffHunk": "@@ -62,31 +66,42 @@ public void declareRhs(final KiePMMLDroolsRule rule) {\n     protected void declareDefaultThen(final KiePMMLDroolsRule rule) {\n         StringJoiner joiner = new StringJoiner(\"\");\n         if (rule.getStatusToSet() != null) {\n-            joiner.add(String.format(UPDATE_STATUS_HOLDER, rule.getStatusToSet()));\n+            joiner.add(String.format(UPDATE_STATUS_HOLDER_STATUS, rule.getStatusToSet()));\n+        }\n+        if (rule.getStatusToSet() != null || rule.getToAccumulate() != null) {\n+            joiner.add(UPDATE_STATUS_HOLDER);\n         }\n         commonDeclareThen(rule, joiner);\n         builder.rhs(joiner.toString());\n     }\n \n     protected void declareIfThen(final KiePMMLDroolsRule rule) {\n-        builder.rhs(String.format(UPDATE_STATUS_HOLDER, rule.getStatusToSet()));\n+        builder.rhs(String.format(UPDATE_STATUS_HOLDER_STATUS, rule.getStatusToSet()));\n+//        builder.rhs(UPDATE_STATUS_HOLDER);", "originalCommit": "e38cda04a211d7addddeeab913df98d119ecc230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM5MjI4MA==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414392280", "bodyText": "@danielezonca\nDone", "author": "gitgabrio", "createdAt": "2020-04-24T08:27:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1NTE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1NTI3NA==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r413955274", "bodyText": "To be removed", "author": "danielezonca", "createdAt": "2020-04-23T16:43:33Z", "path": "kie-pmml-new/kie-pmml-models/kie-pmml-models-drools/kie-pmml-models-drools-common/src/main/java/org/kie/pmml/models/drools/commons/factories/KiePMMLDescrRhsFactory.java", "diffHunk": "@@ -62,31 +66,42 @@ public void declareRhs(final KiePMMLDroolsRule rule) {\n     protected void declareDefaultThen(final KiePMMLDroolsRule rule) {\n         StringJoiner joiner = new StringJoiner(\"\");\n         if (rule.getStatusToSet() != null) {\n-            joiner.add(String.format(UPDATE_STATUS_HOLDER, rule.getStatusToSet()));\n+            joiner.add(String.format(UPDATE_STATUS_HOLDER_STATUS, rule.getStatusToSet()));\n+        }\n+        if (rule.getStatusToSet() != null || rule.getToAccumulate() != null) {\n+            joiner.add(UPDATE_STATUS_HOLDER);\n         }\n         commonDeclareThen(rule, joiner);\n         builder.rhs(joiner.toString());\n     }\n \n     protected void declareIfThen(final KiePMMLDroolsRule rule) {\n-        builder.rhs(String.format(UPDATE_STATUS_HOLDER, rule.getStatusToSet()));\n+        builder.rhs(String.format(UPDATE_STATUS_HOLDER_STATUS, rule.getStatusToSet()));\n+//        builder.rhs(UPDATE_STATUS_HOLDER);\n         StringJoiner joiner = new StringJoiner(\"\");\n-        joiner.add(String.format(UPDATE_STATUS_HOLDER, DONE));\n+        joiner.add(String.format(UPDATE_STATUS_HOLDER_STATUS, DONE));\n         commonDeclareThen(rule, joiner);\n+//        joiner.add(UPDATE_STATUS_HOLDER);", "originalCommit": "e38cda04a211d7addddeeab913df98d119ecc230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM5MjI2Mw==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414392263", "bodyText": "@danielezonca\nDone", "author": "gitgabrio", "createdAt": "2020-04-24T08:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1NTI3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1ODgzNw==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r413958837", "bodyText": "Are you sure of this condition? If I understand it correct the code, this get(null) will always throw a NPE [1].\n[1] https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Field.html#get-java.lang.Object- [..]If the specified obj argument is null, the method throws a NullPointerException.[..]", "author": "danielezonca", "createdAt": "2020-04-23T16:48:41Z", "path": "kie-pmml-new/kie-pmml-commons/src/main/java/org/kie/pmml/commons/model/enums/DATA_TYPE.java", "diffHunk": "@@ -111,6 +111,16 @@ public Object getActualValue(Object rawValue) {\n                 throw new KieDataFieldException(\"Fail to convert \" + rawValue + \"[\" + rawValue.getClass().getName() + \"] to expected class \" + mappedClass.getName(), e);\n             }\n         }\n+        if (!rawValue.getClass().isPrimitive()) {\n+            try {\n+                if (mappedClass.equals(rawValue.getClass().getField(\"TYPE\").get(null))) {", "originalCommit": "e38cda04a211d7addddeeab913df98d119ecc230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM3MDUzMQ==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414370531", "bodyText": "@danielezonca\nIf the underlying field is a static field, the obj argument is ignored; it may be null.", "author": "gitgabrio", "createdAt": "2020-04-24T07:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1ODgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQwNTY2NA==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414405664", "bodyText": "Ok cool, I wasn't aware of this behavior :)", "author": "danielezonca", "createdAt": "2020-04-24T08:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1ODgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk2MjU1OQ==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r413962559", "bodyText": "If you create a common Builder interface with at least withAccumulationResult, withResult and withResultCode you can probably create a couple of static methods and get rid of:\n\nKiePMMLSimpleSetPredicateWithAccumulationASTFactory\nKiePMMLSimpleSetPredicateWithResultASTFactory\nKiePMMLTruePredicateWithAccumulationASTFactory\nKiePMMLTruePredicateWithResultASTFactory\npart of KiePMMLCompoundPredicateWithAccumulationASTFactory\npart of KiePMMLSimplePredicateWithResultASTFactory\npart of KiePMMLSimplePredicateWithAccumulationASTFactory\npart of KiePMMLCompoundPredicateWithResultASTFactory\n\nWdyt?\nIt could be done with another ticket too of course.", "author": "danielezonca", "createdAt": "2020-04-23T16:53:59Z", "path": "kie-pmml-new/kie-pmml-models/kie-pmml-models-drools/kie-pmml-models-drools-common/src/main/java/org/kie/pmml/models/drools/ast/factories/KiePMMLSimpleSetPredicateWithAccumulationASTFactory.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.pmml.models.drools.ast.factories;\n+\n+import java.util.List;\n+\n+import org.kie.pmml.commons.enums.ResultCode;\n+import org.kie.pmml.models.drools.ast.KiePMMLDroolsRule;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Class used to generate <code>KiePMMLDroolsRule</code> out of a <code>SimpleSetPredicate</code>\n+ */\n+public class KiePMMLSimpleSetPredicateWithAccumulationASTFactory {", "originalCommit": "e38cda04a211d7addddeeab913df98d119ecc230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM3ODk3OA==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414378978", "bodyText": "@danielezonca\nI avoided that on purpose, but I could not find a better solution.\nSome parameters are common by both implementations (e.g. KiePMMLSimpleSetPredicateWithAccumulationASTFactory and KiePMMLSimpleSetPredicateWithResultASTFactory) but AccumulationResult and Result (mostly) differentiate them.\nI already saw that the overall design could be improved/simplified, but for the moment being it helped me on separating concerns. At the same time, I'm not sure if other drools-implemented models (e.g. mining) will need another differentiation. I'll defer that decision.", "author": "gitgabrio", "createdAt": "2020-04-24T08:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk2MjU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQwNjI3Ng==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414406276", "bodyText": "Yes fine for me, what about open a ticket to review this after/together with mining model impl?", "author": "danielezonca", "createdAt": "2020-04-24T08:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk2MjU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0NDI4Nw==", "url": "https://github.com/kiegroup/drools/pull/2868#discussion_r414444287", "bodyText": "@danielezonca\nhttps://issues.redhat.com/browse/DROOLS-5272", "author": "gitgabrio", "createdAt": "2020-04-24T09:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk2MjU1OQ=="}], "type": "inlineReview"}, {"oid": "50e0eda6781e8250d2b4dd02489067002999f7c7", "url": "https://github.com/kiegroup/drools/commit/50e0eda6781e8250d2b4dd02489067002999f7c7", "message": "[DROOLS-5270] Fixed as per PR suggestin", "committedDate": "2020-04-24T08:27:12Z", "type": "commit"}, {"oid": "210111fc8df698162adb241c958385a280c69e3f", "url": "https://github.com/kiegroup/drools/commit/210111fc8df698162adb241c958385a280c69e3f", "message": "[DROOLS-5270] Fixed as per PR suggestion", "committedDate": "2020-04-24T11:01:12Z", "type": "commit"}]}