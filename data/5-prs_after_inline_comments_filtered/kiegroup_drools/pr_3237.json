{"pr_number": 3237, "pr_title": "[DROOLS-5780] descope ecj", "pr_createdAt": "2020-11-12T18:26:10Z", "pr_url": "https://github.com/kiegroup/drools/pull/3237", "timeline": [{"oid": "039751a81fb5611c240ddb022b1cfce18fcac8aa", "url": "https://github.com/kiegroup/drools/commit/039751a81fb5611c240ddb022b1cfce18fcac8aa", "message": "[DROOLS-5780] descope ecj", "committedDate": "2020-11-12T18:24:26Z", "type": "commit"}, {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f", "url": "https://github.com/kiegroup/drools/commit/13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f", "message": "wip", "committedDate": "2020-11-13T15:29:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAzMzQxNQ==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r523033415", "bodyText": "Does this work in Java11/Native image?", "author": "lucamolteni", "createdAt": "2020-11-13T15:43:54Z", "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/NativeJavaCompiler.java", "diffHunk": "@@ -347,12 +357,52 @@ public boolean hasLocation(Location location) {\n                         }\n                     }\n                 }\n-                return result == null ? Collections.<JavaFileObject>emptyList() : result;\n+                return result == null ? Collections.emptyList() : result;\n             } catch (IOException e) {\n                 return Collections.emptyList();\n             }\n         }\n \n+        private List<JavaFileObject> findClassesIndexed(String packageName) {\n+            List<JavaFileObject> result = new ArrayList<JavaFileObject>();\n+            for (String className : indexedClasses.getOrDefault( packageName, Collections.emptySet() )) {\n+                String binaryName = packageName + \".\" + className;\n+                URL classUrl = classLoader.getResource(binaryName.replace('.', '/') + \".class\");\n+                if (classUrl != null) {\n+                    try {\n+                        result.add(new CustomJavaFileObject(binaryName, classUrl.toURI()));\n+                    } catch (URISyntaxException e) {\n+                        throw new RuntimeException( e );\n+                    }\n+                }\n+            }\n+            return result;\n+        }\n+\n+        private Map<String, Set<String>> indexClassesByPackage() {\n+            Map<String, Set<String>> indexedClasses = new HashMap<>();\n+            for (ClassLoader cl = classLoader; cl != null; cl = cl.getParent()) {\n+                indexClassesByPackage(indexedClasses, cl);\n+            }\n+            return indexedClasses;\n+        }\n+\n+        private void indexClassesByPackage(Map<String, Set<String>> indexedClasses, ClassLoader classLoader) {\n+            if (classLoader instanceof ProjectClassLoader || classLoader == NativeJavaCompiler.class.getClassLoader()) {\n+                return;\n+            }\n+            try {\n+                Field classesField = ClassLoader.class.getDeclaredField( \"classes\" );", "originalCommit": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyMTk5NQ==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524021995", "bodyText": "This happens only at compile time, so I believe there shouldn't be any problem with the native image.", "author": "mariofusco", "createdAt": "2020-11-16T09:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAzMzQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA0MDM0Nw==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524040347", "bodyText": "It is a bit unrelated but why don't return Optional<JavaCompiler> if it can silently fail?", "author": "danielezonca", "createdAt": "2020-11-16T09:45:27Z", "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "diffHunk": "@@ -70,7 +52,7 @@ public JavaCompiler createCompiler(final String pHint) {\n         }\n         \n         try {\n-            return (JavaCompiler) clazz.newInstance();\n+            return (JavaCompiler) clazz.getConstructor().newInstance();\n         } catch (Throwable t) {\n             return null;", "originalCommit": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2MzU3OQ==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524063579", "bodyText": "What is the differences between loadCompiler and createCompiler? Both create it so it seems to be just an overload", "author": "danielezonca", "createdAt": "2020-11-16T10:05:47Z", "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "diffHunk": "@@ -81,34 +63,20 @@ public JavaCompiler loadCompiler( JavaConfiguration configuration) {\n     }\n \n     public JavaCompiler loadCompiler( JavaConfiguration.CompilerType compilerType, String lngLevel ) {", "originalCommit": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEzODYyOA==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524138628", "bodyText": "createCompiler is just an internal impl, I made it private.", "author": "mariofusco", "createdAt": "2020-11-16T11:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2MzU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2NDY0Mw==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524064643", "bodyText": "Why this hack?", "author": "danielezonca", "createdAt": "2020-11-16T10:06:48Z", "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "diffHunk": "@@ -81,34 +63,20 @@ public JavaCompiler loadCompiler( JavaConfiguration configuration) {\n     }\n \n     public JavaCompiler loadCompiler( JavaConfiguration.CompilerType compilerType, String lngLevel ) {\n-        JavaCompiler compiler;\n-        switch ( compilerType ) {\n-            case NATIVE : {\n-                compiler = createCompiler( \"native\" );\n-                if (compiler == null) {\n-                    throw new RuntimeException(\"Instance of native compiler cannot be created!\");\n-                } else {\n-                    updateSettings( compiler.createDefaultSettings(), lngLevel );\n-                }\n-                break;\n-            }\n-            case ECLIPSE :\n-            default : {\n-                compiler = createCompiler( \"eclipse\" );\n-                if (compiler == null) {\n-                    throw new RuntimeException(\"Instance of eclipse compiler cannot be created!\");\n-                } else {\n-                    updateSettings( compiler.createDefaultSettings(), lngLevel );\n-                }\n-                break;\n-            }\n+        JavaCompiler compiler = createCompiler( compilerType );\n+        if (compiler == null) {\n+            throw new RuntimeException(\"Instance of \" + compilerType + \" compiler cannot be created!\");\n+        } else {\n+            compiler.setJavaCompilerSettings( updateSettings( compiler.createDefaultSettings(), lngLevel ) );\n         }\n         return compiler;\n     }\n \n     private JavaCompilerSettings updateSettings( JavaCompilerSettings settings, String lngLevel ) {\n         settings.setTargetVersion( lngLevel );\n-        settings.setSourceVersion( lngLevel );\n+        if (lngLevel.startsWith( \"1.\" )) { // avoid in memory compilation with JPMS", "originalCommit": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE3NTg2Mw==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524175863", "bodyText": "This is to force the native java compiler to work with a 1.8 source level (or less). If I make it run with 9+ (i.e. with JPMS) I get weird compilation errors like the following\nUNKNOWN (-1:-1) : module jdk.accessibility reads package  from both java.base and java.naming\nI spent quite a lot of time trying to figure out what's going on here but I'm clueless so far. I understand that this a ugly hack and something that I should fix asap. Also it is quite surprising that ecj seems not suffer of the same problem, but still I haven't been able yet to figure out why.", "author": "mariofusco", "createdAt": "2020-11-16T11:47:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2NDY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2NzAxOQ==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524467019", "bodyText": "Does it mean that user will not be able to use >1.8 code in DRL until this is fixed?", "author": "danielezonca", "createdAt": "2020-11-16T18:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2NDY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4MTQwNQ==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524481405", "bodyText": "For now yes, I will avoid this for ecj.", "author": "mariofusco", "createdAt": "2020-11-16T18:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2NDY0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5MzQzMg==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524093432", "bodyText": "We should document this behavior, personally I don't like a \"dynamic\" default based on classpath.\nIs it for backward compatibility?\nIn any case, can you please add a log.debug with the selected value to make it easier to debug?\nSomething like\nlog.debug(\"Selected compiler \" + prop + \" [drools.dialect.java.compiler:\" + this.conf.getChainedProperties().getProperty( JAVA_COMPILER_PROPERTY, null) + \", hasEclipseCompiler:\" + hasEclipseCompiler() + \"]\");", "author": "danielezonca", "createdAt": "2020-11-16T10:32:56Z", "path": "drools-compiler/src/main/java/org/drools/compiler/compiler/JavaConfiguration.java", "diffHunk": "@@ -192,11 +195,10 @@ public CompilerType getCompiler() {\n      */\n     private CompilerType getDefaultCompiler() {\n         try {\n-            final String prop = this.conf.getChainedProperties().getProperty( JAVA_COMPILER_PROPERTY,\n-                                                                              \"ECLIPSE\" );\n-            if ( prop.equals( \"NATIVE\" ) ) {\n+            final String prop = this.conf.getChainedProperties().getProperty( JAVA_COMPILER_PROPERTY, hasEclipseCompiler() ? \"ECLIPSE\" : \"NATIVE\" );", "originalCommit": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE1OTg0OQ==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524159849", "bodyText": "The idea is that if you brought ecj in your classpath it is because you want to use it and then it makes it the default choice without the need of any further settings. I understand this behaviour is questionable and I'm open to discuss it.", "author": "mariofusco", "createdAt": "2020-11-16T11:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5MzQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5ODc0Mg==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524098742", "bodyText": "Is it possible to move this configuration as part of DEFAULT_JAVA_CONFIGURATION?", "author": "danielezonca", "createdAt": "2020-11-16T10:37:49Z", "path": "drools-compiler/src/main/java/org/drools/compiler/compiler/JavaConfiguration.java", "diffHunk": "@@ -77,25 +79,48 @@\n     implements\n     DialectConfiguration {\n \n+    // This should be in alphabetic order to search with BinarySearch\n+    protected static final String[]  LANGUAGE_LEVELS = new String[]{\"1.5\", \"1.6\", \"1.7\", \"1.8\", \"10\", \"11\", \"12\", \"13\", \"14\", \"15\", \"9\"};\n+\n+    private static final JavaConfiguration DEFAULT_JAVA_CONFIGURATION = new JavaConfiguration(new KnowledgeBuilderConfigurationImpl(JavaConfiguration.class.getClassLoader()));\n+    private static final String DEFAULT_JAVA_VERSION = findJavaVersion(DEFAULT_JAVA_CONFIGURATION.conf.getChainedProperties());\n+\n     protected static final transient Logger logger = LoggerFactory.getLogger( JavaConfiguration.class);\n \n     public static final String JAVA_COMPILER_PROPERTY = \"drools.dialect.java.compiler\";\n     public static final String JAVA_LANG_LEVEL_PROPERTY = \"drools.dialect.java.compiler.lnglevel\";\n \n     public enum CompilerType {\n-        ECLIPSE, NATIVE\n+        ECLIPSE(\"org.drools.ecj.EclipseJavaCompiler\"),\n+        NATIVE(\"org.drools.compiler.commons.jci.compilers.NativeJavaCompiler\");\n+\n+        private final String implClassName;\n+\n+        CompilerType( String implClassName ) {\n+            this.implClassName = implClassName;\n+        }\n+\n+        public String getImplClassName() {\n+            return implClassName;\n+        }\n     }\n \n-    // This should be in alphabetic order to search with BinarySearch\n-    protected static final String[]  LANGUAGE_LEVELS = new String[]{\"1.5\", \"1.6\", \"1.7\", \"1.8\", \"10\", \"11\", \"12\", \"9\"};\n+    public static JavaCompiler createDefaultCompiler() {\n+        JavaCompiler javaCompiler = JavaCompilerFactory.INSTANCE.loadCompiler(DEFAULT_JAVA_CONFIGURATION.getCompiler(), DEFAULT_JAVA_VERSION);\n+        javaCompiler.setSourceFolder(\"src/main/java/\");", "originalCommit": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEwOTU0Nw==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524109547", "bodyText": "What do you mean with \"Indexed\"?", "author": "danielezonca", "createdAt": "2020-11-16T10:47:35Z", "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/NativeJavaCompiler.java", "diffHunk": "@@ -347,12 +357,52 @@ public boolean hasLocation(Location location) {\n                         }\n                     }\n                 }\n-                return result == null ? Collections.<JavaFileObject>emptyList() : result;\n+                return result == null ? Collections.emptyList() : result;\n             } catch (IOException e) {\n                 return Collections.emptyList();\n             }\n         }\n \n+        private List<JavaFileObject> findClassesIndexed(String packageName) {", "originalCommit": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4NDkyNw==", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524484927", "bodyText": "What about findClassesFromPackage?", "author": "danielezonca", "createdAt": "2020-11-16T18:30:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEwOTU0Nw=="}], "type": "inlineReview"}, {"oid": "ad66a9ddccb288259ccbfa8cefd93630391305fe", "url": "https://github.com/kiegroup/drools/commit/ad66a9ddccb288259ccbfa8cefd93630391305fe", "message": "wip", "committedDate": "2020-11-16T11:54:08Z", "type": "commit"}, {"oid": "b8c370211c75ac671fe5c2402fb9ff557374a308", "url": "https://github.com/kiegroup/drools/commit/b8c370211c75ac671fe5c2402fb9ff557374a308", "message": "wip", "committedDate": "2020-11-17T11:54:04Z", "type": "commit"}, {"oid": "467964c2ca68b05258c563ac01fb578cba418bbd", "url": "https://github.com/kiegroup/drools/commit/467964c2ca68b05258c563ac01fb578cba418bbd", "message": "wip", "committedDate": "2020-11-17T15:15:58Z", "type": "commit"}, {"oid": "57823c51418a05305ca15cb4f30628c533d356e4", "url": "https://github.com/kiegroup/drools/commit/57823c51418a05305ca15cb4f30628c533d356e4", "message": "wip", "committedDate": "2020-11-18T09:20:38Z", "type": "commit"}, {"oid": "dcf9711e699ec0c39de910405d619cc88f93b549", "url": "https://github.com/kiegroup/drools/commit/dcf9711e699ec0c39de910405d619cc88f93b549", "message": "wip", "committedDate": "2020-11-18T10:56:24Z", "type": "commit"}, {"oid": "c751a4e38464c86d9a7c562fab9334024e7bd692", "url": "https://github.com/kiegroup/drools/commit/c751a4e38464c86d9a7c562fab9334024e7bd692", "message": "wip", "committedDate": "2020-11-19T11:22:46Z", "type": "commit"}, {"oid": "c751a4e38464c86d9a7c562fab9334024e7bd692", "url": "https://github.com/kiegroup/drools/commit/c751a4e38464c86d9a7c562fab9334024e7bd692", "message": "wip", "committedDate": "2020-11-19T11:22:46Z", "type": "forcePushed"}, {"oid": "c379fe0b3ff385048e3957c7399aeeb280ad1e58", "url": "https://github.com/kiegroup/drools/commit/c379fe0b3ff385048e3957c7399aeeb280ad1e58", "message": "Merge branch 'master' into d5780", "committedDate": "2020-11-19T11:26:57Z", "type": "commit"}]}