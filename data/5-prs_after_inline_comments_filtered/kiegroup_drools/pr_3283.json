{"pr_number": 3283, "pr_title": "[DROOLS-5887] The enhanced \"for\" (foreach) statement causes compilation error in executable models.", "pr_createdAt": "2020-12-09T16:56:47Z", "pr_url": "https://github.com/kiegroup/drools/pull/3283", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk0NjQ0OQ==", "url": "https://github.com/kiegroup/drools/pull/3283#discussion_r539946449", "bodyText": "Neither this test nor the one above are using the Person and Address objects in a strongly typed way inside the consequence, e.g. printing p.getName() instead of p. Also it would be better to put that string into a global and asserting on its content after the firing instead of just printing it out.", "author": "mariofusco", "createdAt": "2020-12-10T07:49:26Z", "path": "drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/MvelDialectTest.java", "diffHunk": "@@ -479,4 +481,65 @@ public void testSetOnInteger() throws Exception {\n         assertEquals(1, ksession.fireAllRules());\n         assertEquals(50000, (int) john.getSalary());\n     }\n+\n+    @Test\n+    public void testCollectSubtypeInConsequence() {\n+        // DROOLS-5887\n+        String drl =\n+                \"import \" + Person.class.getCanonicalName() + \"\\n\" +\n+                \"import \" + ArrayList.class.getCanonicalName() + \"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"rule \\\"bus1\\\"\\n\" +\n+                \"when\\n\" +\n+                \"    $people : ArrayList() from collect ( Person() )\\n\" +\n+                \"then\\n\" +\n+                \"    for (Person p : $people ) {\\n\" +\n+                \"        System.out.println(\\\"Person: \\\" + p);\\n\" +\n+                \"    }\\n\" +\n+                \"end\";\n+\n+        KieSession ksession = getKieSession(drl);\n+\n+        Person mario = new Person(\"Mario\", 46);\n+        Person luca = new Person(\"Luca\", 36);\n+        Person leonardo = new Person(\"Leonardo\", 3);\n+\n+        Arrays.asList(mario, luca, leonardo).forEach(ksession::insert);\n+\n+        assertEquals(1, ksession.fireAllRules());\n+    }\n+\n+    @Test\n+    public void testCollectSubtypeInConsequenceNested() {\n+        // DROOLS-5887\n+        String drl =\n+                \"import \" + Person.class.getCanonicalName() + \"\\n\" +\n+                \"import \" + Address.class.getCanonicalName() + \"\\n\" +\n+                \"import \" + ArrayList.class.getCanonicalName() + \"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"rule \\\"bus1\\\"\\n\" +\n+                \"when\\n\" +\n+                \"    $people : ArrayList() from collect ( Person() )\\n\" +\n+                \"    $addresses : ArrayList() from collect ( Address() )\\n\" +\n+                \"then\\n\" +\n+                \"    for (Person p : $people ) {\\n\" +\n+                \"       for (Address a : $addresses ) {\\n\" +\n+                \"           System.out.println(\\\"Person: \\\" + p + \\\" address: \\\" + a);\\n\" +", "originalCommit": "6c6ba9f2c237549893928b5eb4ce530ab2d0c5d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1MDA5Mw==", "url": "https://github.com/kiegroup/drools/pull/3283#discussion_r539950093", "bodyText": "Sorry, I don't get what this class is for. Also I don't see where this is used, can you please clarify?", "author": "mariofusco", "createdAt": "2020-12-10T07:56:13Z", "path": "drools-model/drools-mvel-parser/src/main/java/org/drools/mvel/parser/ast/visitor/DrlCloneVisitor.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.drools.mvel.parser.ast.visitor;\n+\n+import com.github.javaparser.ast.visitor.CloneVisitor;\n+import com.github.javaparser.ast.visitor.Visitable;\n+import org.drools.mvel.parser.ast.expr.BigDecimalLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.BigIntegerLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.DrlNameExpr;\n+import org.drools.mvel.parser.ast.expr.DrlxExpression;\n+import org.drools.mvel.parser.ast.expr.HalfBinaryExpr;\n+import org.drools.mvel.parser.ast.expr.HalfPointFreeExpr;\n+import org.drools.mvel.parser.ast.expr.InlineCastExpr;\n+import org.drools.mvel.parser.ast.expr.MapCreationLiteralExpression;\n+import org.drools.mvel.parser.ast.expr.MapCreationLiteralExpressionKeyValuePair;\n+import org.drools.mvel.parser.ast.expr.ModifyStatement;\n+import org.drools.mvel.parser.ast.expr.NullSafeFieldAccessExpr;\n+import org.drools.mvel.parser.ast.expr.NullSafeMethodCallExpr;\n+import org.drools.mvel.parser.ast.expr.OOPathChunk;\n+import org.drools.mvel.parser.ast.expr.OOPathExpr;\n+import org.drools.mvel.parser.ast.expr.PointFreeExpr;\n+import org.drools.mvel.parser.ast.expr.RuleBody;\n+import org.drools.mvel.parser.ast.expr.RuleConsequence;\n+import org.drools.mvel.parser.ast.expr.RuleDeclaration;\n+import org.drools.mvel.parser.ast.expr.RulePattern;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralChunkExpr;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralInfiniteChunkExpr;\n+import org.drools.mvel.parser.ast.expr.WithStatement;\n+\n+/**\n+ * Should be used instead of .clone() when cloning DRL AST\n+ * drlExpr.accept(new DrlCloneVisitor(), null);\n+ */\n+public class DrlCloneVisitor extends CloneVisitor implements DrlGenericVisitor<Visitable, Object> {", "originalCommit": "6c6ba9f2c237549893928b5eb4ce530ab2d0c5d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1MzExNw==", "url": "https://github.com/kiegroup/drools/pull/3283#discussion_r539953117", "bodyText": "You're right it was used in a first draft of the implementation but then I decided not to use it anymo\ufffdre.\nStill it took me so much time to get the types right that I wanted to include it in anyway as it will be useful in the future.", "author": "lucamolteni", "createdAt": "2020-12-10T08:01:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1MDA5Mw=="}], "type": "inlineReview"}, {"oid": "aaf0b98a6031bb0517de1ea9eaac6e609560ea2e", "url": "https://github.com/kiegroup/drools/commit/aaf0b98a6031bb0517de1ea9eaac6e609560ea2e", "message": "Reproducer", "committedDate": "2020-12-10T08:19:03Z", "type": "commit"}, {"oid": "a71025c5f7672bb90fa7bc3c888769f11051527b", "url": "https://github.com/kiegroup/drools/commit/a71025c5f7672bb90fa7bc3c888769f11051527b", "message": "new ForEachDowncastStmtT Node", "committedDate": "2020-12-10T08:19:03Z", "type": "commit"}, {"oid": "38f1b44fe1559cd44b60b25dc86e06f68a6cc1e1", "url": "https://github.com/kiegroup/drools/commit/38f1b44fe1559cd44b60b25dc86e06f68a6cc1e1", "message": "Support basic case", "committedDate": "2020-12-10T08:19:03Z", "type": "commit"}, {"oid": "48c7a84354ca6de57ddef0165e94220544bbe402", "url": "https://github.com/kiegroup/drools/commit/48c7a84354ca6de57ddef0165e94220544bbe402", "message": "Nested for reproducer", "committedDate": "2020-12-10T08:19:03Z", "type": "commit"}, {"oid": "dd22113984b31114d605d1f0a5bd23b2658ca981", "url": "https://github.com/kiegroup/drools/commit/dd22113984b31114d605d1f0a5bd23b2658ca981", "message": "Support MVEL compiling of nested conditions", "committedDate": "2020-12-10T08:19:03Z", "type": "commit"}, {"oid": "cec8c9107c872f4d34af215d31fc1bc3dc7a973a", "url": "https://github.com/kiegroup/drools/commit/cec8c9107c872f4d34af215d31fc1bc3dc7a973a", "message": "Removed test", "committedDate": "2020-12-10T08:19:03Z", "type": "commit"}, {"oid": "d02cefcf119005dc3bc56e8ba13083a04516ec87", "url": "https://github.com/kiegroup/drools/commit/d02cefcf119005dc3bc56e8ba13083a04516ec87", "message": "Copyright", "committedDate": "2020-12-10T08:19:03Z", "type": "commit"}, {"oid": "25c92d11506cfb3bfa8e2a8de9dfc1fdfce3fa8d", "url": "https://github.com/kiegroup/drools/commit/25c92d11506cfb3bfa8e2a8de9dfc1fdfce3fa8d", "message": "Use subtypes in consequence", "committedDate": "2020-12-10T08:19:03Z", "type": "commit"}, {"oid": "25c92d11506cfb3bfa8e2a8de9dfc1fdfce3fa8d", "url": "https://github.com/kiegroup/drools/commit/25c92d11506cfb3bfa8e2a8de9dfc1fdfce3fa8d", "message": "Use subtypes in consequence", "committedDate": "2020-12-10T08:19:03Z", "type": "forcePushed"}]}