{"pr_number": 2706, "pr_title": "[DROOLS-4870] Materialize consequences using Drools", "pr_createdAt": "2020-01-07T10:00:23Z", "pr_url": "https://github.com/kiegroup/drools/pull/2706", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMTIxNA==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r363801214", "bodyText": "Let's not use JP types as input for the model compiler, only for output.\nThis is because in the future we'd like to emit JP code at the very end, therefore during the processing we should only use types owned by us.", "author": "lucamolteni", "createdAt": "2020-01-07T15:25:07Z", "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/ExecModelLambdaPostProcessor.java", "diffHunk": "@@ -114,12 +120,21 @@ private Expression lambdaInstance(ClassOrInterfaceType type) {\n     }\n \n     private void extractLambdaFromMethodCall(MethodCallExpr methodCallExpr, Supplier<MaterializedLambda> lambdaExtractor) {\n+        List<VariableDeclarator> bitMaskVariables = new ArrayList<>();", "originalCommit": "ef99c4aa364699c1c17ffa5468ee9f57ab241177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExMTYyMQ==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364111621", "bodyText": "Fix applied. thanks!", "author": "tkobayas", "createdAt": "2020-01-08T08:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMTIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMTQ1NA==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r363801454", "bodyText": "I moved this parsing outside in the patch to avoid the instanceof", "author": "lucamolteni", "createdAt": "2020-01-07T15:25:32Z", "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/ExecModelLambdaPostProcessor.java", "diffHunk": "@@ -114,12 +120,21 @@ private Expression lambdaInstance(ClassOrInterfaceType type) {\n     }\n \n     private void extractLambdaFromMethodCall(MethodCallExpr methodCallExpr, Supplier<MaterializedLambda> lambdaExtractor) {\n+        List<VariableDeclarator> bitMaskVariables = new ArrayList<>();\n+        if (lambdaExtractor.get() instanceof MaterializedLambdaConsequence) {", "originalCommit": "ef99c4aa364699c1c17ffa5468ee9f57ab241177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExMTgxOA==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364111818", "bodyText": "Fix applied. thanks!", "author": "tkobayas", "createdAt": "2020-01-08T08:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMTQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMTY3Mg==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r363801672", "bodyText": "Superclass shouldn't be aware of implementation details of Consequences", "author": "lucamolteni", "createdAt": "2020-01-07T15:25:57Z", "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/MaterializedLambda.java", "diffHunk": "@@ -38,6 +39,7 @@\n abstract class MaterializedLambda {\n \n     final List<LambdaParameter> lambdaParameters = new ArrayList<>();\n+    final List<VariableDeclarator> bitMaskVariables = new ArrayList<>();", "originalCommit": "ef99c4aa364699c1c17ffa5468ee9f57ab241177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExMTg2Ng==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364111866", "bodyText": "Fix applied. thanks!", "author": "tkobayas", "createdAt": "2020-01-08T08:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMTY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMjEyMQ==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r363802121", "bodyText": "In the refactor patch I changed a logic reconstructing the original initialization method here, to avoid depending on JP data on input.", "author": "lucamolteni", "createdAt": "2020-01-07T15:26:45Z", "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/MaterializedLambdaConsequence.java", "diffHunk": "@@ -65,6 +65,23 @@ void createMethodDeclaration(EnumDeclaration classDeclaration) {\n         }\n     }\n \n+    @Override\n+    protected EnumDeclaration create(CompilationUnit compilationUnit) {\n+        EnumDeclaration lambdaClass = super.create(compilationUnit);\n+\n+        boolean hasDroolsParameter = lambdaParameters.stream().anyMatch(this::isDroolsParameter);", "originalCommit": "ef99c4aa364699c1c17ffa5468ee9f57ab241177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExMjA3MQ==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364112071", "bodyText": "Fix applied. thanks!", "author": "tkobayas", "createdAt": "2020-01-08T08:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMjEyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMjYwMA==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r363802600", "bodyText": "This test has too much Java code in text to be readable.\nIn the patch I modified the signature of the create method so that it can be tested in an easier way. Please take a look at it", "author": "lucamolteni", "createdAt": "2020-01-07T15:27:41Z", "path": "drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/util/lambdareplace/MaterializedLambdaConsequenceTest.java", "diffHunk": "@@ -32,4 +38,188 @@ public void createConsequence() {\n         assertThat(aClass.getCompilationUnitAsString(), equalToIgnoringWhiteSpace(expectedResult));\n \n     }\n+\n+    @Test\n+    public void createConsequenceWithDrools() {\n+        String originalJavaSource = \"package defaultpkg;\\n\" +\n+                \"\\n\" +", "originalCommit": "ef99c4aa364699c1c17ffa5468ee9f57ab241177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExMTkyMw==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364111923", "bodyText": "Fix applied. thanks!", "author": "tkobayas", "createdAt": "2020-01-08T08:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMjYwMA=="}], "type": "inlineReview"}, {"oid": "740f3fb479195c984023013cca022e88946c2a42", "url": "https://github.com/kiegroup/drools/commit/740f3fb479195c984023013cca022e88946c2a42", "message": "[DROOLS-4870] Materialize consequences using Drools", "committedDate": "2020-01-08T08:17:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEwOTI2MA==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364109260", "bodyText": "Originally, it picks only one field but BitMask may take multiple fields so I changed it to a List.", "author": "tkobayas", "createdAt": "2020-01-08T08:24:13Z", "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/ExecModelLambdaPostProcessor.java", "diffHunk": "@@ -113,6 +124,40 @@ private Expression lambdaInstance(ClassOrInterfaceType type) {\n         return new FieldAccessExpr(new NameExpr(type.asString()), \"INSTANCE\");\n     }\n \n+    private List<MaterializedLambda.BitMaskVariable> findBitMaskFields(MethodCallExpr methodCallExpr) {\n+        List<MaterializedLambda.BitMaskVariable> bitMaskVariables = new ArrayList<>();\n+        methodCallExpr.findAncestor(MethodDeclaration.class).ifPresent(node -> {\n+\n+            List<MaterializedLambda.BitMaskVariable> collect =\n+                    node.findAll(VariableDeclarator.class)\n+                            .stream()\n+                            .filter(vd -> vd.getType().asString().equals(BitMask.class.getCanonicalName()))\n+                            .flatMap(vd -> {\n+                                ArrayList<AssignExpr> result = new ArrayList<>();\n+                                vd.findAncestor(AssignExpr.class)\n+                                        .ifPresent(result::add);\n+                                return result.stream();\n+                            })\n+                            .map(ae -> {\n+                                String maskName = ae.getTarget().asVariableDeclarationExpr().getVariables().iterator().next().getNameAsString();\n+                                MethodCallExpr maskInit = ae.getValue().asMethodCallExpr();\n+                                if(maskInit.getArguments().isEmpty()) {\n+                                    return new MaterializedLambda.AllSetButLastBitMask(maskName);\n+                                } else {\n+                                    NodeList<Expression> arguments = maskInit.getArguments();\n+                                    String domainClassMetadata = arguments.get(0).toString();\n+                                    List<String> fields = arguments.subList(1, arguments.size()).stream().map(Expression::toString).collect(Collectors.toList());", "originalCommit": "740f3fb479195c984023013cca022e88946c2a42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExMTAwNw==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364111007", "bodyText": "Originally, the argument NodeWithMembers was not parameterized so i see compiler warns. It's fine to have <EnumDeclaration> here?", "author": "tkobayas", "createdAt": "2020-01-08T08:29:08Z", "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/MaterializedLambda.java", "diffHunk": "@@ -146,4 +154,53 @@ private EnumDeclaration create(CompilationUnit compilationUnit) {\n             this.type = type;\n         }\n     }\n+\n+    interface BitMaskVariable {\n+\n+        void generateBitMaskField(NodeWithMembers<EnumDeclaration> clazz);", "originalCommit": "740f3fb479195c984023013cca022e88946c2a42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExOTMwOQ==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364119309", "bodyText": "I also think it's better to remove the generic type argument", "author": "lucamolteni", "createdAt": "2020-01-08T08:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExMTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzOTAzNA==", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364139034", "bodyText": "Talked with Luca and confirmed that NodeWithMembers<EnumDeclaration> is better.", "author": "tkobayas", "createdAt": "2020-01-08T09:37:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExMTAwNw=="}], "type": "inlineReview"}, {"oid": "108e80ac13bb0d746fc8d49d29c0ef4158b116c2", "url": "https://github.com/kiegroup/drools/commit/108e80ac13bb0d746fc8d49d29c0ef4158b116c2", "message": "[DROOLS-4870] Materialize consequences using Drools", "committedDate": "2020-01-08T09:34:05Z", "type": "forcePushed"}, {"oid": "2bda482029f733fe395a4a436b3d26b92d128519", "url": "https://github.com/kiegroup/drools/commit/2bda482029f733fe395a4a436b3d26b92d128519", "message": "[DROOLS-4870] Materialize consequences using Drools", "committedDate": "2020-01-09T04:21:03Z", "type": "forcePushed"}, {"oid": "d4d959b29c611d7e8aa338a667c2d55af13fb5f3", "url": "https://github.com/kiegroup/drools/commit/d4d959b29c611d7e8aa338a667c2d55af13fb5f3", "message": "[DROOLS-4870] Materialize consequences using Drools", "committedDate": "2020-02-05T02:56:11Z", "type": "forcePushed"}, {"oid": "474b460a94c313352fe2508f2550f3221626f7d6", "url": "https://github.com/kiegroup/drools/commit/474b460a94c313352fe2508f2550f3221626f7d6", "message": "[DROOLS-4870] Materialize consequences using Drools", "committedDate": "2020-02-06T09:53:08Z", "type": "commit"}, {"oid": "474b460a94c313352fe2508f2550f3221626f7d6", "url": "https://github.com/kiegroup/drools/commit/474b460a94c313352fe2508f2550f3221626f7d6", "message": "[DROOLS-4870] Materialize consequences using Drools", "committedDate": "2020-02-06T09:53:08Z", "type": "forcePushed"}]}