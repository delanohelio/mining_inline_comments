{"pr_number": 155, "pr_title": "Optimize discovery module.", "pr_createdAt": "2020-03-31T11:51:11Z", "pr_url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155", "timeline": [{"oid": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/26b2b7d4fb907a0673a41a2518daefe2fa1e41ee", "message": "handle empty server list / use revision reduce request", "committedDate": "2020-03-31T11:50:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI5NjQwOQ==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401296409", "bodyText": "This check seams not neccessary.", "author": "liubao68", "createdAt": "2020-04-01T00:51:51Z", "path": "spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/Response.java", "diffHunk": "@@ -28,6 +32,21 @@\n \n   private String content;\n \n+  private Map<String, String> headers = new HashMap<>();\n+\n+  public String getHeader(String key) {\n+    if (!headers.containsKey(key)) {", "originalCommit": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM3ODc1MA==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401378750", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-04-01T06:17:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI5NjQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwMDcyMA==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401300720", "bodyText": "Define a setter is better, e.g. addServiceReivison(String, String). Or must difine it to be final .", "author": "liubao68", "createdAt": "2020-04-01T01:08:05Z", "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/discovery/MicroserviceHandler.java", "diffHunk": "@@ -39,9 +41,15 @@\n \n   private static List<ServiceInstance> instanceList = Collections.emptyList();\n \n+  public static Map<String, String> serviceRevision = new ConcurrentHashMap<>();", "originalCommit": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM3ODkxMw==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401378913", "bodyText": "change it to final", "author": "GuoYL123", "createdAt": "2020-04-01T06:17:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwMDcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwMTA3OA==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401301078", "bodyText": "Formate this code", "author": "liubao68", "createdAt": "2020-04-01T01:09:26Z", "path": "spring-cloud-huawei-servicecomb-discovery/src/test/java/com/huaweicloud/servicecomb/discovery/client/ServiceCombClientTest.java", "diffHunk": "@@ -210,7 +210,7 @@ public void getInstances(@Injectable\n       }\n     };\n     ServiceCombClient serviceCombClient = new ServiceCombClient(url, httpTransport);\n-    List<ServiceInstance> actual = serviceCombClient.getInstances(microservice);\n+    List<ServiceInstance> actual = serviceCombClient.getInstances(microservice,null);", "originalCommit": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM3ODk2OA==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401378968", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-04-01T06:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwMTA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwMTE3MQ==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401301171", "bodyText": "Format this code", "author": "liubao68", "createdAt": "2020-04-01T01:09:47Z", "path": "spring-cloud-huawei-servicecomb-discovery/src/test/java/com/huaweicloud/servicecomb/discovery/discovery/MicroserviceHandlerTest.java", "diffHunk": "@@ -54,7 +54,7 @@ public void getInstances(@Injectable ServiceCombClient serviceCombClient)\n     microservice.setServiceName(\"testservice\");\n     new Expectations() {\n       {\n-        serviceCombClient.getInstances(microservice);\n+        serviceCombClient.getInstances(microservice,\"0\");", "originalCommit": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM3OTAyNQ==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401379025", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-04-01T06:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwMTE3MQ=="}], "type": "inlineReview"}, {"oid": "9010b7d0a1a49db3e435dbf74f52cdfa1258298e", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/9010b7d0a1a49db3e435dbf74f52cdfa1258298e", "message": "support multi az", "committedDate": "2020-04-01T06:11:01Z", "type": "commit"}, {"oid": "9010b7d0a1a49db3e435dbf74f52cdfa1258298e", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/9010b7d0a1a49db3e435dbf74f52cdfa1258298e", "message": "support multi az", "committedDate": "2020-04-01T06:11:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMDgwMw==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401400803", "bodyText": "format code", "author": "liubao68", "createdAt": "2020-04-01T07:13:04Z", "path": "spring-cloud-huawei-servicecomb-discovery/src/test/java/com/huaweicloud/servicecomb/discovery/ribbon/ServiceCombServerListTest.java", "diffHunk": "@@ -85,21 +92,23 @@ public URI getUri() {\n \n       @Override\n       public Map<String, String> getMetadata() {\n-        return null;\n+        Map<String, String> map = new HashMap<>();\n+        map.put(\"status\", MicroserviceInstanceStatus.UP.name());\n+        return map;\n       }\n     };\n     instanceList.add(serviceInstance);\n     new Expectations() {\n       {\n         iClientConfig.getClientName();\n         result = \"serviceid11\";\n-        serviceCombClient.getInstances((Microservice) any);\n+        serviceCombClient.getInstances((Microservice) any,null);", "originalCommit": "8581163399217f047164756d37b3c0ead8b606fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI1NTg2OQ==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r402255869", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-04-02T11:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMDgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMTEwNQ==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401401105", "bodyText": "format code", "author": "liubao68", "createdAt": "2020-04-01T07:13:40Z", "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/discovery/KieAddrSeekerImpl.java", "diffHunk": "@@ -28,7 +28,7 @@ public String getKieAddr() {\n     microservice.setServiceName(\"servicecomb-kie\");\n     List<ServiceInstance> instanceList;\n     try {\n-      instanceList = serviceCombClient.getInstances(microservice);\n+      instanceList = serviceCombClient.getInstances(microservice,null);", "originalCommit": "8581163399217f047164756d37b3c0ead8b606fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI1NTkzOA==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r402255938", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-04-02T11:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMTEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMjIzMA==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401402230", "bodyText": "I am not sure where getMicroserviceIns is called. Seams use microservice instance id as the key is better. Not all endpoints starts with rest.", "author": "liubao68", "createdAt": "2020-04-01T07:16:12Z", "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/discovery/MicroserviceCache.java", "diffHunk": "@@ -35,19 +35,17 @@ public static void initService(List<Microservice> list) {\n         list.forEach(item ->\n                 item.getInstances().forEach(ins -> {\n                     ins.setServiceName(item.getServiceName());\n-                    ins.getEndpoints().forEach(ep -> {\n-                        microserviceList.put(ep.replaceAll(\"rest://\", \"\"), ins);\n-                    });\n+                    ins.getEndpoints()\n+                        .forEach(ep -> microserviceList.put(ep.replaceAll(\"rest://\", \"\"), ins));\n                 })\n         );\n     }\n \n     public static void initInsList(List<MicroserviceInstance> list, String serviceName) {\n         list.forEach(ins -> {\n             ins.setServiceName(serviceName);\n-            ins.getEndpoints().forEach(ep -> {\n-                microserviceList.put(ep.replaceAll(\"rest://\", \"\"), ins);\n-            });\n+            ins.getEndpoints()\n+                .forEach(ep -> microserviceList.put(ep.replaceAll(\"rest://\", \"\"), ins));", "originalCommit": "8581163399217f047164756d37b3c0ead8b606fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI1NDEwMw==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r402254103", "bodyText": "Ribbon's  com.netflix.loadbalancer.Server choose the endpint as the instance id, so I use  endpoint.\nIn spring cloud all endpoints with rest.", "author": "GuoYL123", "createdAt": "2020-04-02T11:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMjIzMA=="}], "type": "inlineReview"}, {"oid": "dc5cdba8d14b6c049c887689f07bd86bab7cf9e6", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/dc5cdba8d14b6c049c887689f07bd86bab7cf9e6", "message": "modify as comment", "committedDate": "2020-04-02T11:53:40Z", "type": "commit"}, {"oid": "dc5cdba8d14b6c049c887689f07bd86bab7cf9e6", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/dc5cdba8d14b6c049c887689f07bd86bab7cf9e6", "message": "modify as comment", "committedDate": "2020-04-02T11:53:40Z", "type": "forcePushed"}]}