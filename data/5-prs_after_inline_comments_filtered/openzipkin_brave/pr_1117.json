{"pr_number": 1117, "pr_title": "Hardens HTTP integration tests to catch more bugs easier", "pr_createdAt": "2020-03-20T01:24:31Z", "pr_url": "https://github.com/openzipkin/brave/pull/1117", "timeline": [{"oid": "78d6b3b624752a7c8cd51dd9785b766578a02c10", "url": "https://github.com/openzipkin/brave/commit/78d6b3b624752a7c8cd51dd9785b766578a02c10", "message": "Hardens HTTP integration tests to catch more bugs easier\n\nIt was very hard to detect subtle bugs in reactor until I redid the\ntests to force us to be conscious of whether a span error is expected or\nif we are expecting a remote or local span. Further, this makes sure\nthese two most difficult to debug things end up with better assertion\nfailures, including the entire span json. This is super handy when\ntests flake due to timing. For example, using a debugger could actually\nslow things to the point they pass!", "committedDate": "2020-03-20T01:21:50Z", "type": "commit"}, {"oid": "002a0ea763aa2ae4c914c61625e3e7f2437698f2", "url": "https://github.com/openzipkin/brave/commit/002a0ea763aa2ae4c914c61625e3e7f2437698f2", "message": "cover the common failure case of reverse order", "committedDate": "2020-03-20T03:25:18Z", "type": "commit"}, {"oid": "ca54ea554de2b321aa126ae7fe23e25681614f90", "url": "https://github.com/openzipkin/brave/commit/ca54ea554de2b321aa126ae7fe23e25681614f90", "message": "moar rejig", "committedDate": "2020-03-20T05:07:05Z", "type": "commit"}, {"oid": "8126088e956d26531079d2d737989f7c3a117295", "url": "https://github.com/openzipkin/brave/commit/8126088e956d26531079d2d737989f7c3a117295", "message": "message backwards", "committedDate": "2020-03-20T05:49:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ0ODYwMA==", "url": "https://github.com/openzipkin/brave/pull/1117#discussion_r395448600", "bodyText": "Recommend a normal loop with Arrays.asList since it's very similar code but there won't be a lambda in the stack trace if failure", "author": "anuraaga", "createdAt": "2020-03-20T05:50:30Z", "path": "instrumentation/http-tests/src/main/java/brave/test/http/ITHttp.java", "diffHunk": "@@ -157,6 +182,84 @@ protected Tracer tracer() {\n     }\n   };\n \n+  /**\n+   * Like {@link #assertSpansReportedKindInOrder(Span.Kind, Span.Kind)} except order isn't enforced.\n+   * However, the results will return in the kind order specified.\n+   */\n+  protected Span[] assertSpansReportedKindInAnyOrder(@Nullable Span.Kind kind1,\n+    @Nullable Span.Kind kind2) throws InterruptedException {\n+    if (Objects.equals(kind1, kind2)) {\n+      throw new AssertionError(\"Expected test to pass different span kinds\");\n+    }\n+\n+    // Intentionally pull both spans first to ensure neither are errors.\n+    Span span1 = takeSpan(), span2 = takeSpan();\n+\n+    Stream.of(span1, span2).forEach(span -> assertThat(span.kind())", "originalCommit": "8126088e956d26531079d2d737989f7c3a117295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ0OTM4Nw==", "url": "https://github.com/openzipkin/brave/pull/1117#discussion_r395449387", "bodyText": "great idea", "author": "codefromthecrypt", "createdAt": "2020-03-20T05:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ0ODYwMA=="}], "type": "inlineReview"}, {"oid": "e75512b5c2e55819bb19002ae603d0fa081c1a76", "url": "https://github.com/openzipkin/brave/commit/e75512b5c2e55819bb19002ae603d0fa081c1a76", "message": "less stacky", "committedDate": "2020-03-20T05:56:55Z", "type": "commit"}, {"oid": "50ba43fb81730a784980720c07849617dd7717cf", "url": "https://github.com/openzipkin/brave/commit/50ba43fb81730a784980720c07849617dd7717cf", "message": "punts deprecated type", "committedDate": "2020-03-20T07:50:31Z", "type": "commit"}]}