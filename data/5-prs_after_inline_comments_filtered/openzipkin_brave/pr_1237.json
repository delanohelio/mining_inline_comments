{"pr_number": 1237, "pr_title": "Add support for rabbitmq batch consume", "pr_createdAt": "2020-07-13T04:44:28Z", "pr_url": "https://github.com/openzipkin/brave/pull/1237", "timeline": [{"oid": "5832b052a113ca9f7c3dcd8e65449de0143a9ad5", "url": "https://github.com/openzipkin/brave/commit/5832b052a113ca9f7c3dcd8e65449de0143a9ad5", "message": "Add support for rabbitmq batch consume", "committedDate": "2020-07-13T04:42:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzNTcxNw==", "url": "https://github.com/openzipkin/brave/pull/1237#discussion_r453435717", "bodyText": "This is an interesting situation as we want one consumer span for the batch I think.. also, there's only one listener, so should only be one listener span!\nThe tricky bit is that we have an ambiguous situation. For example, we may have different trace contexts in the batch of messages. Consider 5 messages, and two of them have \"b3\" header in them.\nThis \"join\" type operation forces us to choose which of these possibly multiple traces should be the trace of the listener.\nAnother option is like you've done, which is to start a span for every message, but since only one can be the \"current trace\" we still I think should pick one. We don't yet have a link model, but meanwhile yeah I feel like we should have only 1 span started for the listener, because only one child started in a listener could be attached to a trace.\ncc @jorgheymans @anuraaga @jeqo for feedback on this.", "author": "codefromthecrypt", "createdAt": "2020-07-13T05:01:41Z", "path": "instrumentation/spring-rabbit/src/main/java/brave/spring/rabbit/TracingRabbitListenerAdvice.java", "diffHunk": "@@ -72,40 +76,53 @@\n    * Message)}\n    */\n   @Override public Object invoke(MethodInvocation methodInvocation) throws Throwable {\n-    Message message = (Message) methodInvocation.getArguments()[1];\n-    MessageConsumerRequest request = new MessageConsumerRequest(message);\n+    List<Message> messages = new ArrayList<>();\n+    if (methodInvocation.getArguments()[1] instanceof List) {\n+      messages.addAll((Collection<? extends Message>) methodInvocation.getArguments()[1]);\n+    } else {\n+      messages.add((Message) methodInvocation.getArguments()[1]);\n+    }\n+\n+    List<Span> listenerSpans = new ArrayList<>(messages.size());\n+    for (Message message : messages) {\n+      MessageConsumerRequest request = new MessageConsumerRequest(message);\n \n-    TraceContextOrSamplingFlags extracted =\n-      springRabbitTracing.extractAndClearTraceIdHeaders(extractor, request, message);\n+      TraceContextOrSamplingFlags extracted =\n+        springRabbitTracing.extractAndClearTraceIdHeaders(extractor, request, message);\n \n-    // named for BlockingQueueConsumer.nextMessage, which we can't currently see\n-    Span consumerSpan = springRabbitTracing.nextMessagingSpan(sampler, request, extracted);\n-    Span listenerSpan = tracer.newChild(consumerSpan.context());\n+      // named for BlockingQueueConsumer.nextMessage, which we can't currently see\n+      Span consumerSpan = springRabbitTracing.nextMessagingSpan(sampler, request, extracted);", "originalCommit": "5832b052a113ca9f7c3dcd8e65449de0143a9ad5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzODQyMw==", "url": "https://github.com/openzipkin/brave/pull/1237#discussion_r453438423", "bodyText": "I'd generally go with span per message since batching is an implementation detail of how the messages are handled. Many user requests to buy a sticker result in wanting to write a money transaction to a database, queues are great for supporting retries idempotently to make that reliable but each transaction is still independent from each other. To me, each message is very much like the request to an API server, so the messages without any header in them would just be new traces.\nNote, there might be other cases where this isn't really the cases (the messages are all related and part of some larger type of processing, maybe analytics?) in which case single span could make sense too.", "author": "anuraaga", "createdAt": "2020-07-13T05:13:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzNTcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ0MTY1MA==", "url": "https://github.com/openzipkin/brave/pull/1237#discussion_r453441650", "bodyText": "I realized, actually this change is probably related to my second paragraph - if it's a configuration change to switch from one message per listener to one batch per listener, that means a user is sort of opting into that behavior, presumably since there's a semantic relationship among the batch. So just one span does seem to make sense, but picking the trace is problematic.", "author": "anuraaga", "createdAt": "2020-07-13T05:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzNTcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ0NzI1OQ==", "url": "https://github.com/openzipkin/brave/pull/1237#discussion_r453447259", "bodyText": "So the solution is keep only one consumer span and one listener span  (maybe from the first message)\uff1f", "author": "dengliming", "createdAt": "2020-07-13T05:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzNTcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ1MzU3MQ==", "url": "https://github.com/openzipkin/brave/pull/1237#discussion_r453453571", "bodyText": "so far, I don't see a better way. for example, if we see any messages we can start and finish a consumer span, but we keep a reference to only the first consumer span, if exists use that as the listener's parent", "author": "codefromthecrypt", "createdAt": "2020-07-13T06:10:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzNTcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ1NjIwNQ==", "url": "https://github.com/openzipkin/brave/pull/1237#discussion_r453456205", "bodyText": "@adriancole Please re-review. Thanks.", "author": "dengliming", "createdAt": "2020-07-13T06:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzNTcxNw=="}], "type": "inlineReview"}, {"oid": "22e93376b8d3dbc3e4a5c7fbb52e798bcdb44134", "url": "https://github.com/openzipkin/brave/commit/22e93376b8d3dbc3e4a5c7fbb52e798bcdb44134", "message": "fix review", "committedDate": "2020-07-13T06:17:51Z", "type": "commit"}, {"oid": "2cfd90d2ef26074924fb71bdd8618f1236bffca4", "url": "https://github.com/openzipkin/brave/commit/2cfd90d2ef26074924fb71bdd8618f1236bffca4", "message": "Add test case for batch consume.", "committedDate": "2020-07-18T06:29:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzOTQxMA==", "url": "https://github.com/openzipkin/brave/pull/1237#discussion_r456839410", "bodyText": "please add a test for two messages in all combinations as it shows a problem to solve later\nnon traced that listener is a new trace\nfirst traced that listener continues that trace\ntwo traced that listener continues first  trace but TODO we aren't handling the second.\nlast trace that listener is new trace and TODO about the second", "author": "codefromthecrypt", "createdAt": "2020-07-18T23:45:25Z", "path": "instrumentation/spring-rabbit/src/test/java/brave/spring/rabbit/ITSpringRabbitTracing.java", "diffHunk": "@@ -150,4 +152,16 @@\n     awaitMessageConsumed();\n     // reporter rules verify nothing was reported\n   }\n+\n+  @Test public void batchConsumerTest() {\n+    produceUntracedMessage(exchange_batch.getName(), binding_batch);", "originalCommit": "2cfd90d2ef26074924fb71bdd8618f1236bffca4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NjQyNw==", "url": "https://github.com/openzipkin/brave/pull/1237#discussion_r456866427", "bodyText": "fixed at last commit.", "author": "dengliming", "createdAt": "2020-07-19T06:17:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzOTQxMA=="}], "type": "inlineReview"}, {"oid": "60055f7ed967ec421249244b4fa4c761bee1f4c2", "url": "https://github.com/openzipkin/brave/commit/60055f7ed967ec421249244b4fa4c761bee1f4c2", "message": "fix testcase", "committedDate": "2020-07-19T05:59:33Z", "type": "commit"}, {"oid": "4e4f3083d0364fdfca9348847e9ccc930934a1a9", "url": "https://github.com/openzipkin/brave/commit/4e4f3083d0364fdfca9348847e9ccc930934a1a9", "message": "fix testcase", "committedDate": "2020-07-19T06:17:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NTE3OQ==", "url": "https://github.com/openzipkin/brave/pull/1237#discussion_r456975179", "bodyText": "last thing from me on this.. I see you are only checking spans.get(0) the reported trace.\nthough I don't see any problems.. maybe ensure the B3 headers are cleared in all messages in each test after onBatchMessageConsumed similar to other tests\n    // cleared the headers to later work doesn't try to use the old parent\n    assertThat(message.getMessageProperties().getHeaders()).isEmpty();", "author": "codefromthecrypt", "createdAt": "2020-07-20T00:23:48Z", "path": "instrumentation/spring-rabbit/src/test/java/brave/spring/rabbit/TracingRabbitListenerAdviceTest.java", "diffHunk": "@@ -196,6 +203,72 @@\n       .containsExactly(error);\n   }\n \n+  @Test public void batch_starts_new_trace_if_none_exists() throws Throwable {\n+    // non traced that listener is a new trace\n+    onBatchMessageConsumed(Arrays.asList(MessageBuilder.withBody(new byte[0]).build(),\n+      MessageBuilder.withBody(new byte[0]).build()));\n+\n+    assertThat(spans)\n+      .extracting(MutableSpan::kind)\n+      .containsExactly(CONSUMER, null);\n+  }\n+\n+  @Test public void batch_continue_parent_trace() throws Throwable {\n+    MessageProperties props = new MessageProperties();\n+    props.setHeader(\"X-B3-TraceId\", TRACE_ID);\n+    props.setHeader(\"X-B3-SpanId\", SPAN_ID);\n+    props.setHeader(\"X-B3-ParentSpanId\", PARENT_ID);\n+    props.setHeader(\"X-B3-Sampled\", SAMPLED);\n+\n+    Message message = MessageBuilder.withBody(new byte[0]).andProperties(props).build();\n+    MessageProperties props2 = new MessageProperties();\n+    props2.setHeader(\"X-B3-TraceId\", TRACE_ID_2);\n+    props2.setHeader(\"X-B3-SpanId\", SPAN_ID_2);\n+    props2.setHeader(\"X-B3-ParentSpanId\", PARENT_ID_2);\n+    props2.setHeader(\"X-B3-Sampled\", SAMPLED);\n+    Message message2 = MessageBuilder.withBody(new byte[0]).andProperties(props2).build();\n+    onBatchMessageConsumed(Arrays.asList(message, message2));\n+\n+    // two traced that listener continues first trace but TODO we aren't handling the second.\n+    assertThat(spans.get(0))", "originalCommit": "4e4f3083d0364fdfca9348847e9ccc930934a1a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ1MzczMA==", "url": "https://github.com/openzipkin/brave/pull/1237#discussion_r457453730", "bodyText": "Thanks. fixed at last commit.", "author": "dengliming", "createdAt": "2020-07-20T14:45:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NTE3OQ=="}], "type": "inlineReview"}, {"oid": "fa20102ae8625e9c710f281b55e159fb9a644340", "url": "https://github.com/openzipkin/brave/commit/fa20102ae8625e9c710f281b55e159fb9a644340", "message": "fix review", "committedDate": "2020-07-20T14:44:42Z", "type": "commit"}]}