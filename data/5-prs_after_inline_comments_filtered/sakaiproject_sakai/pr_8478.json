{"pr_number": 8478, "pr_title": "SAK-44153 Improvements to Group and Date Released Subpages in Lessons", "pr_createdAt": "2020-08-26T20:57:41Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8478", "timeline": [{"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa", "url": "https://github.com/sakaiproject/sakai/commit/15cc21c095bcb9fcbfbeb1302dfbccaa529668fa", "message": "SAK-44153 Improvements to Group and Date Released Subpages in Lessons\n\n- Updated lesson page so hidden subpages would show \"released on\" instead of \"Not released until\" even\nafter the release date.\n- Changed released color to be green. The color of the text will toggle depending on the state of whether\nor not the page is visible.\n- Links are visible but disabled in the tool menu if they are not released\n- Make lessons subpage navigation group aware in the tool menu\n- Add option for visible but inactive subpages\n- Added release string to date released subpages for student view\n- Added checkbox to hide subpage on the main subpage edit screen rather than in gear icon\n- Add release date and Hidden properties to those copied in duplication", "committedDate": "2020-08-26T17:45:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQxMTczMw==", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478411733", "bodyText": "Why not type this?\nList groups = new ArrayList<>();\nActually:\nfinal List groupIds = siteService.getSite(siteId).getGroupsWithMember(userId).stream().map(Group::getId).collect(Collectors.toList());", "author": "adrianfish", "createdAt": "2020-08-27T13:18:03Z", "path": "lessonbuilder/components/src/java/org/sakaiproject/lessonbuildertool/model/SimplePageToolDaoImpl.java", "diffHunk": "@@ -1893,7 +1896,18 @@ public String getLessonSubPageJSON(final String userId, final boolean isInstruct\n \t\t\tfields[i+1] = pageIds.get(i);\n \t\t}\n \n-\t\tfinal LessonsSubNavBuilder lessonsSubNavBuilder = new LessonsSubNavBuilder(siteId, canSeeAll);\n+\t\tArrayList groups = new ArrayList();", "originalCommit": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyNjIxMg==", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478426212", "bodyText": "Indentation", "author": "adrianfish", "createdAt": "2020-08-27T13:39:16Z", "path": "lessonbuilder/tool/src/java/org/sakaiproject/lessonbuildertool/service/LessonBuilderEntityProducer.java", "diffHunk": "@@ -1120,6 +1122,18 @@ public String merge(String siteId, Element root, String archivePath, String from\n \t\t     String folder = pageElement.getAttribute(\"folder\");\n \t\t     if (StringUtils.isNotEmpty(folder))\n \t\t\t page.setFolder(folder);\n+\t\t     //get new page's Date Release property", "originalCommit": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyNjc3OQ==", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478426779", "bodyText": "Indentations gone a bit crazy here :)", "author": "adrianfish", "createdAt": "2020-08-27T13:40:07Z", "path": "lessonbuilder/tool/src/java/org/sakaiproject/lessonbuildertool/tool/beans/SimplePageBean.java", "diffHunk": "@@ -3555,19 +3555,19 @@ public String getReleaseString(SimplePageItem i, Locale locale) {\n \t\t if (page.isHidden())\n \t\t     return messageLocator.getMessage(\"simplepage.hiddenpage\");\n \t\t // for index of pages we need to show even out of date release dates\n-\t\t if (page.getReleaseDate() != null) { // && page.getReleaseDate().after(new Date())) {\n-\t\t     Date releaseDate = page.getReleaseDate();\n-\t\t     Date date = new Date();\n-\t\t     if (date.before(releaseDate)) {\n-\t\t        DateFormat df = DateFormat.getDateTimeInstance(DateFormat.MEDIUM, DateFormat.SHORT, locale);\n-\t\t        TimeZone tz = userTimeService.getLocalTimeZone();\n-\t\t        String releaseDateStr = df.format(page.getReleaseDate());\n-\t\t        df.setTimeZone(tz);\n-\t\t        return messageLocator.getMessage(\"simplepage.pagenotreleased\").replace(\"{}\", releaseDateStr);\n-\t\t     }\n-\t\t     return null;\n+\t\t if (page.getReleaseDate() != null ) {\n+\t\t     DateFormat df = DateFormat.getDateTimeInstance(DateFormat.SHORT, DateFormat.SHORT, locale);\n+\t\t     TimeZone tz = userTimeService.getLocalTimeZone();\n+\t\t     df.setTimeZone(tz);\n+\t\t\t String releaseDate = df.format(page.getReleaseDate());\n+\t\t     if(Instant.now().isBefore(page.getReleaseDate().toInstant())){\n+\t\t\t\t return messageLocator.getMessage(\"simplepage.pagenotreleased\").replace(\"{}\", releaseDate);\n+\t\t\t } else{", "originalCommit": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyODAyMA==", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478428020", "bodyText": "Need a opening brace after the if statement, close after. I know lessons does this all over the place, Python style, but still ...", "author": "adrianfish", "createdAt": "2020-08-27T13:41:50Z", "path": "lessonbuilder/tool/src/java/org/sakaiproject/lessonbuildertool/tool/beans/SimplePageBean.java", "diffHunk": "@@ -5063,13 +5063,11 @@ public boolean isItemVisible(SimplePageItem item, SimplePage page, boolean testp\n \t\tif (item.getType() == SimplePageItem.BREAK)\n \t\t    return true;  // breaks are always visible to all users\n \t\telse if (item.getType() == SimplePageItem.PAGE) {\n-\t\t  if (!item.isRequired()) {\n \t\t    SimplePage itemPage = getPage(Long.valueOf(item.getSakaiId()));\n \t\t    if (itemPage.isHidden())\n \t\t\treturn false;\n \t\t    if (itemPage.getReleaseDate() != null && itemPage.getReleaseDate().after(new Date()))\n-\t\t\treturn false;\n-\t\t  }\n+\t\t\treturn true;", "originalCommit": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyODg5Mg==", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478428892", "bodyText": "Can you wrap some braces around this?", "author": "adrianfish", "createdAt": "2020-08-27T13:43:01Z", "path": "lessonbuilder/tool/src/java/org/sakaiproject/lessonbuildertool/tool/producers/ShowPageProducer.java", "diffHunk": "@@ -1735,6 +1722,23 @@ else if (forum.notPublished())\n \n \t\t\t\t\t} // end of canEditPage\n \n+\t\t\t\t\tif (i.getType() == SimplePageItem.PAGE) {\n+\t\t\t\t\t\tUIOutput.make(tableRow, \"type\", \"page\");\n+\t\t\t\t\t\tUIOutput.make(tableRow, \"page-next\", Boolean.toString(i.getNextPage()));\n+\t\t\t\t\t\tUIOutput.make(tableRow, \"page-button\", Boolean.toString(\"button\".equals(i.getFormat())));\n+\t\t\t\t\t\tSimplePage page = simplePageToolDao.getPage(Long.valueOf(i.getSakaiId()));\n+\t\t\t\t\t\tUIOutput.make(tableRow, \"page-hidden\", Boolean.toString(page.isHidden()));\n+\t\t\t\t\t\titemGroupString = simplePageBean.getItemGroupString(i, null, true);\n+\t\t\t\t\t\tUIOutput.make(tableRow, \"item-groups\", itemGroupString);\n+\t\t\t\t\t\tSimplePage sPage = simplePageBean.getPage(Long.parseLong(i.getSakaiId()));\n+\t\t\t\t\t\tif (sPage != null) {\n+\t\t\t\t\t\t\tDate rDate = sPage.getReleaseDate();\n+\t\t\t\t\t\t\tString rDateString = \"\";\n+\t\t\t\t\t\t\tif (rDate != null)", "originalCommit": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyOTQxNQ==", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478429415", "bodyText": "Indentation", "author": "adrianfish", "createdAt": "2020-08-27T13:43:44Z", "path": "lessonbuilder/tool/src/java/org/sakaiproject/lessonbuildertool/tool/producers/ShowPageProducer.java", "diffHunk": "@@ -3939,8 +3991,27 @@ protected static boolean makeLink(UIContainer container, String ID, SimplePageIt\n \t\t    link.decorate(new UIFreeAttributeDecorator(\"lessonbuilderitem\", itemString));\n \t\t    // fake and available occurs when prerequisites aren't the issue (it's avaiable)\n \t\t    // so the item must be nonexistent or otherwise unavalable.\n-\t\t    if (available)\n-\t\t\tlink.decorate(new UITooltipDecorator(messageLocator.getMessage(\"simplepage.not_usable\")));\n+\t\t    if (available) {\n+\t\t    \tif(i.getType() == SimplePageItem.PAGE){\n+\t\t\t\t\t// set up locale\n+\t\t\t\t\tLocale M_locale = null;\n+\t\t\t\t\tString langLoc[] = localegetter.get().toString().split(\"_\");\n+\t\t\t\t\tif (langLoc.length >= 2) {\n+\t\t\t\t\t\tif (\"en\".equals(langLoc[0]) && \"ZA\".equals(langLoc[1])) {\n+\t\t\t\t\t\t\tM_locale = new Locale(\"en\", \"GB\");\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tM_locale = new Locale(langLoc[0], langLoc[1]);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tM_locale = new Locale(langLoc[0]);\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tString releaseString = simplePageBean.getReleaseString(i, M_locale);\n+\t\t    \t\tlink.decorate(new UITooltipDecorator(releaseString));", "originalCommit": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ccc75ef6aa5265ba0aa30136a615bfb4c2e4aeae", "url": "https://github.com/sakaiproject/sakai/commit/ccc75ef6aa5265ba0aa30136a615bfb4c2e4aeae", "message": "SAK-44153 Cleanup old Lessons code", "committedDate": "2020-08-28T20:45:27Z", "type": "commit"}]}