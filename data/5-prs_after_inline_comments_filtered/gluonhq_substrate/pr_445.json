{"pr_number": 445, "pr_title": "#438 Scan jars for dalvik precompiled classes", "pr_createdAt": "2020-03-15T23:49:16Z", "pr_url": "https://github.com/gluonhq/substrate/pull/445", "timeline": [{"oid": "dcd3edd4e96bca91adf9ec05ca1b89ef4807a6c3", "url": "https://github.com/gluonhq/substrate/commit/dcd3edd4e96bca91adf9ec05ca1b89ef4807a6c3", "message": "#438 Scan jars for dalvik precompiled classes", "committedDate": "2020-03-13T19:52:07Z", "type": "commit"}, {"oid": "c40dde5a116da7568791f94c382bf43a0aa58be3", "url": "https://github.com/gluonhq/substrate/commit/c40dde5a116da7568791f94c382bf43a0aa58be3", "message": "fix path", "committedDate": "2020-03-13T20:20:48Z", "type": "commit"}, {"oid": "fe749bedf7e6afda921212167e121b06bad8fdf3", "url": "https://github.com/gluonhq/substrate/commit/fe749bedf7e6afda921212167e121b06bad8fdf3", "message": "Remove KeyboardView class", "committedDate": "2020-03-15T20:15:52Z", "type": "commit"}, {"oid": "071859c5044d0e4faa3a00460bd0cfb182d28029", "url": "https://github.com/gluonhq/substrate/commit/071859c5044d0e4faa3a00460bd0cfb182d28029", "message": "Update MainActivity precompiled classes", "committedDate": "2020-03-15T23:35:13Z", "type": "commit"}, {"oid": "c30afdb4e5b15a946ef702fcc0be4dd435584561", "url": "https://github.com/gluonhq/substrate/commit/c30afdb4e5b15a946ef702fcc0be4dd435584561", "message": "Split compiledGlueCode in two, add existing precompiled classes to classpath", "committedDate": "2020-03-15T23:36:13Z", "type": "commit"}, {"oid": "9d2f51f492079c1018a9971d6c349b90d357870e", "url": "https://github.com/gluonhq/substrate/commit/9d2f51f492079c1018a9971d6c349b90d357870e", "message": "Update list of classes", "committedDate": "2020-03-15T23:43:05Z", "type": "commit"}, {"oid": "7e074b4d1153472262cf870705a945f0fec4fbf6", "url": "https://github.com/gluonhq/substrate/commit/7e074b4d1153472262cf870705a945f0fec4fbf6", "message": "Fix constants import", "committedDate": "2020-03-16T09:28:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0NzA4Nw==", "url": "https://github.com/gluonhq/substrate/pull/445#discussion_r393047087", "bodyText": "Why +2 here?", "author": "tiainen", "createdAt": "2020-03-16T14:07:16Z", "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "diffHunk": "@@ -380,12 +392,43 @@ private int compileDalvikCode(String androidSrc, String androidJar) throws IOExc\n         ProcessRunner processRunner = new ProcessRunner(projectConfiguration.getGraalPath().resolve(\"bin\").resolve(\"javac\").toString(),\n                 \"-d\", getApkClassPath().toString(),\n                 \"-source\", \"1.7\", \"-target\", \"1.7\",\n-                \"-cp\", getApkAndroidSourcePath().toString(),\n+                \"-cp\", getApkAndroidSourcePath().toString() + File.pathSeparator + getApkClassPath().toString(),\n                 \"-bootclasspath\", androidJar);\n         processRunner.addArgs(sources);\n         return processRunner.runProcess(\"dalvikCompilation\");\n     }\n \n+    /**\n+     * Walks through the jars in the classpath, excluding the JavaFX ones,\n+     * and looks for META-INF/substrate/dalvik/*.class files.\n+     *\n+     * The method will copy all the class files found into the target folder\n+     *\n+     * @throws IOException\n+     */\n+    private void copyOtherDalvikClasses() throws IOException, InterruptedException {\n+        Path targetFolder = getApkClassPath();\n+        Logger.logDebug(\"Scanning for dalvik classes\");\n+        final List<File> jars = new ClassPath(projectConfiguration.getClasspath()).getJars(true);\n+        String prefix = META_INF_SUBSTRATE_DALVIK + DALVIK_PRECOMPILED_CLASS;\n+        for (File jar : jars) {\n+            try (ZipFile zip = new ZipFile(jar)) {\n+                Logger.logDebug(\"Scanning \" + jar);\n+                for (Enumeration e = zip.entries(); e.hasMoreElements(); ) {\n+                    ZipEntry zipEntry = (ZipEntry) e.nextElement();\n+                    String name = zipEntry.getName();\n+                    if (!zipEntry.isDirectory() && name.startsWith(META_INF_SUBSTRATE_DALVIK)) {\n+                        Path classPath = targetFolder.resolve(name.substring(prefix.length() + 2));", "originalCommit": "7e074b4d1153472262cf870705a945f0fec4fbf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1MDE2Ng==", "url": "https://github.com/gluonhq/substrate/pull/445#discussion_r393050166", "bodyText": "+1 gives \"/com/gluonhq/helloandroid...\", so resolving \"/\" goes to root and doesn't take into account targetFolder. Adding +2 removes \"/\" and gives \"$targetFolder/com/gluonhq...\".", "author": "jperedadnr", "createdAt": "2020-03-16T14:11:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0NzA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNTI4Ng==", "url": "https://github.com/gluonhq/substrate/pull/445#discussion_r393115286", "bodyText": "I still don't understand. The value of prefix is META-INF/substrate/dalvik/precompiled/class/. And the name of a zip entry would be META-INF/substrate/dalvik/precompiled/class/com/hello/MyClass.class. This means that name.substring(prefix.length() + 2) results in the value m/hello/MyClass.class?", "author": "tiainen", "createdAt": "2020-03-16T15:36:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0NzA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzEyMjE1Ng==", "url": "https://github.com/gluonhq/substrate/pull/445#discussion_r393122156", "bodyText": "Should be fixed now", "author": "jperedadnr", "createdAt": "2020-03-16T15:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0NzA4Nw=="}], "type": "inlineReview"}, {"oid": "d3cfdc6338ea50964bbcb2149d503facc02bdecd", "url": "https://github.com/gluonhq/substrate/commit/d3cfdc6338ea50964bbcb2149d503facc02bdecd", "message": "Rename precompiled class to precompiled classes", "committedDate": "2020-03-16T15:42:21Z", "type": "commit"}, {"oid": "ab086f09b9eccf233e0d8e8f8d1cafde9aa805a4", "url": "https://github.com/gluonhq/substrate/commit/ab086f09b9eccf233e0d8e8f8d1cafde9aa805a4", "message": "Rename gvm/apk/class folder", "committedDate": "2020-03-16T15:45:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzEyNTgyOQ==", "url": "https://github.com/gluonhq/substrate/pull/445#discussion_r393125829", "bodyText": "Rename the method to getApkClassesPath?", "author": "tiainen", "createdAt": "2020-03-16T15:50:58Z", "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "diffHunk": "@@ -322,7 +329,7 @@ private Path getApkBinPath() {\n     }\n \n     private Path getApkClassPath() {", "originalCommit": "ab086f09b9eccf233e0d8e8f8d1cafde9aa805a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dda49497c26a4a3a50775df14d3540708e2a3593", "url": "https://github.com/gluonhq/substrate/commit/dda49497c26a4a3a50775df14d3540708e2a3593", "message": "Rename method", "committedDate": "2020-03-16T15:54:50Z", "type": "commit"}]}