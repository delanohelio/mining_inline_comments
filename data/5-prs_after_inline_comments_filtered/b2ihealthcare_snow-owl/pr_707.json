{"pr_number": 707, "pr_title": "SO-4285: ComponentURI constructor changes", "pr_createdAt": "2020-11-06T10:07:25Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/707", "timeline": [{"oid": "3b0f091b6ee7b5dbab29c504ee98a0d80cf4d45f", "url": "https://github.com/b2ihealthcare/snow-owl/commit/3b0f091b6ee7b5dbab29c504ee98a0d80cf4d45f", "message": "SO-4285: Add ComponentURI constructor changes\n\n* Allow constructing ComponentURIs using CodeSystemURIs too\n* Account for more than three parts present in a ComponentURI", "committedDate": "2020-11-06T10:06:45Z", "type": "commit"}, {"oid": "560b2f4f7d4d19a335438c59dd4ed4ce29eef990", "url": "https://github.com/b2ihealthcare/snow-owl/commit/560b2f4f7d4d19a335438c59dd4ed4ce29eef990", "message": "Merge branch '7.x' into issue/SO-4285-component_uri_constructor_changes", "committedDate": "2020-11-09T20:04:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA4NzM1NA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/707#discussion_r520087354", "bodyText": "Rename the first argument here to codeSystemUri to indicate that it accepts an URI.", "author": "cmark", "createdAt": "2020-11-09T20:05:22Z", "path": "core/com.b2international.snowowl.core/src/com/b2international/snowowl/core/uri/ComponentURI.java", "diffHunk": "@@ -113,6 +113,10 @@ private ComponentURI(CodeSystemURI codeSystem, short terminologyComponentId, Str\n \t\tthis.identifier = identifier;\n \t}\n \t\n+\tpublic static ComponentURI of(CodeSystemURI codeSystemURI, short terminologyComponentId, String identifier) {\n+\t\treturn new ComponentURI(codeSystemURI, terminologyComponentId, Strings.nullToEmpty(identifier));\n+\t}\n+\t\n \t@JsonCreator\n \tpublic static ComponentURI of(String codeSystem, short terminologyComponentId, String identifier) {", "originalCommit": "560b2f4f7d4d19a335438c59dd4ed4ce29eef990", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA4ODI4NQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/707#discussion_r520088285", "bodyText": "It would be great to have a few parse fail tests as well to verify the following:\n\nNumber of parts >= 3 (if not fail with reasonable error message)\nLast part is not empty (if not fail with reasonable error message)\nSecond last part is not empty and can be parsed into a short number (if not fail with reasonable error message)", "author": "cmark", "createdAt": "2020-11-09T20:07:09Z", "path": "core/com.b2international.snowowl.core.tests/src/com/b2international/snowowl/core/uri/ComponentURITest.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2020 B2i Healthcare Pte Ltd, http://b2i.sg\n+ * \n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.b2international.snowowl.core.uri;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import org.junit.Test;\n+\n+/**\n+ * @since 7.12.0\n+ */\n+public class ComponentURITest {", "originalCommit": "560b2f4f7d4d19a335438c59dd4ed4ce29eef990", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA4ODkyOA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/707#discussion_r520088928", "bodyText": "Null to empty call is really bad here, both null and empty are invalid values for the identifier part. Don't convert it to empty here, validate instead on the other factory method.", "author": "cmark", "createdAt": "2020-11-09T20:08:26Z", "path": "core/com.b2international.snowowl.core/src/com/b2international/snowowl/core/uri/ComponentURI.java", "diffHunk": "@@ -113,6 +113,10 @@ private ComponentURI(CodeSystemURI codeSystem, short terminologyComponentId, Str\n \t\tthis.identifier = identifier;\n \t}\n \t\n+\tpublic static ComponentURI of(CodeSystemURI codeSystemURI, short terminologyComponentId, String identifier) {\n+\t\treturn new ComponentURI(codeSystemURI, terminologyComponentId, Strings.nullToEmpty(identifier));", "originalCommit": "560b2f4f7d4d19a335438c59dd4ed4ce29eef990", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b09d61dec38cf82b14529e9a73996d7c1aed8407", "url": "https://github.com/b2ihealthcare/snow-owl/commit/b09d61dec38cf82b14529e9a73996d7c1aed8407", "message": "SO-4285: Rename constructor parameter to indicate it accepts a URI", "committedDate": "2020-11-16T09:48:40Z", "type": "commit"}, {"oid": "a3b7a99b5f5189a6d937d31736a6d8b8e9a172a4", "url": "https://github.com/b2ihealthcare/snow-owl/commit/a3b7a99b5f5189a6d937d31736a6d8b8e9a172a4", "message": "SO-4285: Add further componentURI parse tests", "committedDate": "2020-11-16T09:48:41Z", "type": "commit"}, {"oid": "b8e7d007966978851d618ba84688d9daa657b24a", "url": "https://github.com/b2ihealthcare/snow-owl/commit/b8e7d007966978851d618ba84688d9daa657b24a", "message": "SO-4285: Add id argument check, id argument test", "committedDate": "2020-11-16T09:48:41Z", "type": "commit"}, {"oid": "42cbd31c9df92aa25398095d5adc95100837f0c9", "url": "https://github.com/b2ihealthcare/snow-owl/commit/42cbd31c9df92aa25398095d5adc95100837f0c9", "message": "SO-4285: Add ComponentURI factory method that accepts ...\n\n... ComponentIdentifiers", "committedDate": "2020-11-16T09:48:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyODE2MA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/707#discussion_r525128160", "bodyText": "This should throw BadRequestException or IllegalArgumentException as well.", "author": "cmark", "createdAt": "2020-11-17T12:48:58Z", "path": "core/com.b2international.snowowl.core.tests/src/com/b2international/snowowl/core/uri/ComponentURITest.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 B2i Healthcare Pte Ltd, http://b2i.sg\n+ * \n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.b2international.snowowl.core.uri;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import org.junit.Test;\n+\n+import com.b2international.commons.exceptions.BadRequestException;\n+\n+/**\n+ * @since 7.12.0\n+ */\n+public class ComponentURITest {\n+\n+\t@Test\n+\tpublic void constructorTest() {\n+\t\tfinal String branchPath = \"SNOMEDCT/2019-09-30/SNOMEDCT-SE/2020-07-30/SNOMEDCT-EXT\";\n+\t\tfinal CodeSystemURI uri = new CodeSystemURI(branchPath);\n+\t\tshort terminologyComponentId = 150;\n+\t\tfinal String componentId = \"123456789\";\n+\t\tComponentURI componentURI = ComponentURI.of(uri, terminologyComponentId, componentId);\n+\t\tassertEquals(componentURI.codeSystem(), ComponentURI.SLASH_SPLITTER.split(branchPath).iterator().next());\n+\t\tassertEquals(componentURI.terminologyComponentId(), terminologyComponentId);\n+\t\tassertEquals(componentURI.identifier(), componentId);\n+\t}\n+\t\n+\t@Test\n+\tpublic void serializationTest() {\n+\t\tfinal String uri = \"LCS1/1542/750/SO\";\n+\t\tComponentURI componentURI = ComponentURI.of(uri);\n+\t\tassertEquals(componentURI.codeSystem(), \"LCS1\");\n+\t\tassertEquals(componentURI.terminologyComponentId(), 750);\n+\t\tassertEquals(componentURI.identifier(), \"SO\");\n+\t}\n+\t\n+\t@Test(expected = IllegalArgumentException.class)\n+\tpublic void numberOfPartsTest() {\n+\t\tfinal String incompleteURI = \"LCS1/1542\";\n+\t\tComponentURI.of(incompleteURI); //Attempt to parse incomplete component URI\n+\t}\n+\t\n+\t@Test(expected = BadRequestException.class)\n+\tpublic void missingCodeSystemTest() {\n+\t\tfinal String malformedURI = \"/750/1542\";\n+\t\tComponentURI.of(malformedURI);\n+\t}\n+\t\n+\t@Test(expected = NumberFormatException.class)", "originalCommit": "42cbd31c9df92aa25398095d5adc95100837f0c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyODgzMw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/707#discussion_r525128833", "bodyText": "\u26a0\ufe0f The new factory methods do not use the caching mechanism built into this class!", "author": "cmark", "createdAt": "2020-11-17T12:50:07Z", "path": "core/com.b2international.snowowl.core/src/com/b2international/snowowl/core/uri/ComponentURI.java", "diffHunk": "@@ -104,18 +104,28 @@ public final ComponentIdentifier toComponentIdentifier() {\n \t\treturn ComponentIdentifier.of(terminologyComponentId(), identifier());\n \t}\n \n-\tprivate ComponentURI(CodeSystemURI codeSystem, short terminologyComponentId, String identifier) {\n-\t\tcheckNotNull(codeSystem, \"Codesystem argument should not be null.\");\n+\tprivate ComponentURI(CodeSystemURI codeSystemURI, short terminologyComponentId, String identifier) {\n+\t\tcheckNotNull(codeSystemURI, \"Codesystem argument should not be null.\");\n \t\tcheckArgument(terminologyComponentId >= TerminologyRegistry.UNSPECIFIED_NUMBER_SHORT,\n \t\t\t\t\"Terminology component id should be either unspecified (-1) or greater than zero. Got: '%s'.\", terminologyComponentId);\n-\t\tthis.codeSystemUri = codeSystem;\n+\t\tboolean isUnspecified = codeSystemURI.getCodeSystem().equals(TerminologyRegistry.UNSPECIFIED);\n+\t\tcheckArgument(isUnspecified || !Strings.isNullOrEmpty(identifier), \"Identifier should not be null or empty.\");\n+\t\tthis.codeSystemUri = codeSystemURI;\n \t\tthis.terminologyComponentId = terminologyComponentId;\n \t\tthis.identifier = identifier;\n \t}\n \t\n+\tpublic static ComponentURI of(CodeSystemURI codeSystemURI, ComponentIdentifier componentIdentifier) {\n+\t\treturn new ComponentURI(codeSystemURI, componentIdentifier.getTerminologyComponentId(), componentIdentifier.getComponentId());", "originalCommit": "42cbd31c9df92aa25398095d5adc95100837f0c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f868b38e2263746a81120e99659a8bb0d880bc93", "url": "https://github.com/b2ihealthcare/snow-owl/commit/f868b38e2263746a81120e99659a8bb0d880bc93", "message": "SO-4285: Use ComponentURI cache in new constructors", "committedDate": "2020-11-18T08:03:53Z", "type": "commit"}, {"oid": "6c25e4e7cf4519dcbc9271c34c9f9906a241818b", "url": "https://github.com/b2ihealthcare/snow-owl/commit/6c25e4e7cf4519dcbc9271c34c9f9906a241818b", "message": "SO-4285: Add more exception checks to constructor test", "committedDate": "2020-11-18T08:25:00Z", "type": "commit"}, {"oid": "d0b6ab785daee44263f2914eb95ccf7fc2033390", "url": "https://github.com/b2ihealthcare/snow-owl/commit/d0b6ab785daee44263f2914eb95ccf7fc2033390", "message": "SO-4285: fix remaining issues with ComponentURI and ComponentURITest", "committedDate": "2020-11-18T15:07:09Z", "type": "commit"}]}