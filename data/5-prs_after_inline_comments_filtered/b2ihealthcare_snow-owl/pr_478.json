{"pr_number": 478, "pr_title": "Upgrade to Elasticsearch 7.x", "pr_createdAt": "2020-02-06T18:05:56Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/478", "timeline": [{"oid": "e00cf8e7764bee51ff791e47ecac939631ec44f4", "url": "https://github.com/b2ihealthcare/snow-owl/commit/e00cf8e7764bee51ff791e47ecac939631ec44f4", "message": "[index] bump version to Elasticsearch 7.5.2", "committedDate": "2020-02-06T16:10:39Z", "type": "commit"}, {"oid": "53b2651de927a12c81f95adead324a5bee9d4201", "url": "https://github.com/b2ihealthcare/snow-owl/commit/53b2651de927a12c81f95adead324a5bee9d4201", "message": "[index] fix tokenizer/analyzer compile errors", "committedDate": "2020-02-06T16:11:43Z", "type": "commit"}, {"oid": "bf3a5d999fbcff233be3bd8d5c152040e085c25d", "url": "https://github.com/b2ihealthcare/snow-owl/commit/bf3a5d999fbcff233be3bd8d5c152040e085c25d", "message": "[index] use indices level when fetching cluster health", "committedDate": "2020-02-06T16:12:16Z", "type": "commit"}, {"oid": "f949fb23cfa23befacbf67cda21474d14fe3a192", "url": "https://github.com/b2ihealthcare/snow-owl/commit/f949fb23cfa23befacbf67cda21474d14fe3a192", "message": "[index] fix EsNode initialization", "committedDate": "2020-02-06T16:13:14Z", "type": "commit"}, {"oid": "69b6aeb86743535de7a961cb23b145390f6e51a4", "url": "https://github.com/b2ihealthcare/snow-owl/commit/69b6aeb86743535de7a961cb23b145390f6e51a4", "message": "[index] fix client compile errors\n\nFix type and other warnings printed by ES API.", "committedDate": "2020-02-06T16:14:00Z", "type": "commit"}, {"oid": "82fa202806c93affb539a3221d32b2822737765d", "url": "https://github.com/b2ihealthcare/snow-owl/commit/82fa202806c93affb539a3221d32b2822737765d", "message": "[index] add CMS GC config to index tests\n\nFixes [parent] data too large issues during tests.", "committedDate": "2020-02-06T16:14:41Z", "type": "commit"}, {"oid": "b6d0c129fd27112c26ec2a1973bf382568cea5fe", "url": "https://github.com/b2ihealthcare/snow-owl/commit/b6d0c129fd27112c26ec2a1973bf382568cea5fe", "message": "[rf2] reduce RF2 exporter scroll timeout to 1m", "committedDate": "2020-02-06T16:15:00Z", "type": "commit"}, {"oid": "72caf256a28eb1d5cada48b3ae4d95179968e183", "url": "https://github.com/b2ihealthcare/snow-owl/commit/72caf256a28eb1d5cada48b3ae4d95179968e183", "message": "[tests] fix negative scores in SortIndexTest", "committedDate": "2020-02-06T16:15:36Z", "type": "commit"}, {"oid": "7ed070c281db9d04adc6bf16554adcf0e1cddac1", "url": "https://github.com/b2ihealthcare/snow-owl/commit/7ed070c281db9d04adc6bf16554adcf0e1cddac1", "message": "[api] remove scrollId and scrollKeepAlive from Java API\n\nUse searchAfter + branch@timestamp for efficient data snapshot\npaging/scrolling.", "committedDate": "2020-02-06T17:49:15Z", "type": "commit"}, {"oid": "a062e9cd268507ac618e6ce32ef42dae2e164fca", "url": "https://github.com/b2ihealthcare/snow-owl/commit/a062e9cd268507ac618e6ce32ef42dae2e164fca", "message": "[core] remove scrollId from core models and API", "committedDate": "2020-02-06T17:50:50Z", "type": "commit"}, {"oid": "7eb5ff6cd2d57d6b89da2bcff36706ea7f3f793f", "url": "https://github.com/b2ihealthcare/snow-owl/commit/7eb5ff6cd2d57d6b89da2bcff36706ea7f3f793f", "message": "[snomed] remove scrollId from snomed models and API", "committedDate": "2020-02-06T17:52:02Z", "type": "commit"}, {"oid": "873e9d5296d3955ad32c5811a3bcd58f0c3c5a9c", "url": "https://github.com/b2ihealthcare/snow-owl/commit/873e9d5296d3955ad32c5811a3bcd58f0c3c5a9c", "message": "[rest] remove scrollId from core REST API", "committedDate": "2020-02-06T17:52:22Z", "type": "commit"}, {"oid": "b30d8f127a7caecca5c67e58710f2e1524d1fb91", "url": "https://github.com/b2ihealthcare/snow-owl/commit/b30d8f127a7caecca5c67e58710f2e1524d1fb91", "message": "[snomed] remove scrollId from snomed REST API", "committedDate": "2020-02-06T17:52:43Z", "type": "commit"}, {"oid": "3108cfd0640e32da6953c7e6914243480589128d", "url": "https://github.com/b2ihealthcare/snow-owl/commit/3108cfd0640e32da6953c7e6914243480589128d", "message": "[rf2] use branch@timestamp for RF2 exports", "committedDate": "2020-02-06T17:53:32Z", "type": "commit"}, {"oid": "5d00bafe4946d6d9716f319a50d76dc53bc173f5", "url": "https://github.com/b2ihealthcare/snow-owl/commit/5d00bafe4946d6d9716f319a50d76dc53bc173f5", "message": "[build] add CMS GC settings to all tycho surefire executions", "committedDate": "2020-02-07T08:38:54Z", "type": "commit"}, {"oid": "f06f79f2c556b0fb970707bad94afb44b5825811", "url": "https://github.com/b2ihealthcare/snow-owl/commit/f06f79f2c556b0fb970707bad94afb44b5825811", "message": "[launch] add CMS GC settings to all test launch configs", "committedDate": "2020-02-07T08:45:32Z", "type": "commit"}, {"oid": "d8b4c34f1a8eb83dac19e55704cc39128c0801a4", "url": "https://github.com/b2ihealthcare/snow-owl/commit/d8b4c34f1a8eb83dac19e55704cc39128c0801a4", "message": "[qa] fix lgtm issues https://lgtm.com/rules/2049510531/", "committedDate": "2020-02-07T09:41:20Z", "type": "commit"}, {"oid": "6ada6d120f9a896ece7027925c4883fb7cd36de3", "url": "https://github.com/b2ihealthcare/snow-owl/commit/6ada6d120f9a896ece7027925c4883fb7cd36de3", "message": "[index] use bool query with should clauses for term filters with...\n\n...more than the configured index.max_terms_count.\n\nAlso make it possible to configure both maxTermsCount and resultWindow\nvalues from snowowl.yml (repository.index config).", "committedDate": "2020-02-07T13:13:18Z", "type": "commit"}, {"oid": "95bcd094ebbe4f669c66a9682474154e87baefbc", "url": "https://github.com/b2ihealthcare/snow-owl/commit/95bcd094ebbe4f669c66a9682474154e87baefbc", "message": "[index] fix some of the type_removal warnings reported by ES\n\nThe remaining warnings thrown by the Mapping API, but we cannot remove\nit yet, due to our dependency to the TCP client infrastructure. Those\nwarnings will be eliminated once ES 8 is out and we decide to upgrade to\nthat (which will remove the TCP client functionality entirely).\nFix some java compile warnings as well.\nAnd also add some serialVersionUIDs.", "committedDate": "2020-02-07T14:12:52Z", "type": "commit"}, {"oid": "02eea1456af3d3946e3350d2aab725258822f263", "url": "https://github.com/b2ihealthcare/snow-owl/commit/02eea1456af3d3946e3350d2aab725258822f263", "message": "[index] fix nested field name in terms queries\n\nAlso fix decimal value conversion when number of terms is less than the\nmax_terms_count.", "committedDate": "2020-02-07T14:37:45Z", "type": "commit"}, {"oid": "562a6e61e8c7d09e33d4ffac8b5006bc477d45d8", "url": "https://github.com/b2ihealthcare/snow-owl/commit/562a6e61e8c7d09e33d4ffac8b5006bc477d45d8", "message": "[index] searches should always track total hits accurately", "committedDate": "2020-02-07T15:04:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzOTAwMA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/478#discussion_r376439000", "bodyText": "Accuracy of total hits counting changed with ES 7.0 (\"Track total hits up to 10,000 by default\"): https://www.elastic.co/guide/en/elasticsearch/reference/current/release-notes-7.0.0.html", "author": "apeteri", "createdAt": "2020-02-07T15:07:03Z", "path": "commons/com.b2international.index/src/com/b2international/index/es/EsDocumentSearcher.java", "diffHunk": "@@ -190,7 +189,7 @@ public EsDocumentSearcher(EsIndexAdmin admin, ObjectMapper mapper) {\n \t\t\tthrow new IndexException(\"Couldn't execute query: \" + e.getMessage(), null);\n \t\t}\n \t\t\n-\t\tfinal int totalHits = (int) response.getHits().getTotalHits();\n+\t\tfinal int totalHits = (int) response.getHits().getTotalHits().value;", "originalCommit": "69b6aeb86743535de7a961cb23b145390f6e51a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ0MDUzMg==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/478#discussion_r376440532", "bodyText": "Thanks! Fixed in commit 562a6e6.", "author": "cmark", "createdAt": "2020-02-07T15:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzOTAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ0MjEyOQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/478#discussion_r376442129", "bodyText": "Is types still needed here?", "author": "apeteri", "createdAt": "2020-02-07T15:12:24Z", "path": "commons/com.b2international.index/src/com/b2international/index/es/admin/EsIndexAdmin.java", "diffHunk": "@@ -145,24 +145,23 @@ public void create() {\n \t\tfor (DocumentMapping mapping : mappings.getMappings()) {\n \t\t\tfinal String index = getTypeIndex(mapping);\n \t\t\tfinal String type = mapping.typeAsString();\n-\t\t\tfinal Map<String, Object> typeMapping = ImmutableMap.of(type,\n-\t\t\t\t\tImmutableMap.builder()\n+\t\t\tfinal Map<String, Object> typeMapping = ImmutableMap.<String, Object>builder()\n \t\t\t\t\t.put(\"date_detection\", false)\n \t\t\t\t\t.put(\"numeric_detection\", false)\n \t\t\t\t\t.putAll(toProperties(mapping))\n-\t\t\t\t\t.build());\n+\t\t\t\t\t.build();\n \t\t\t\n \t\t\tif (exists(mapping)) {\n \t\t\t\t// update mapping if required\n \t\t\t\tImmutableOpenMap<String, MappingMetaData> currentIndexMapping;\n \t\t\t\ttry {\n-\t\t\t\t\tcurrentIndexMapping = client.indices().getMapping(new GetMappingsRequest().indices(index).types(type)).mappings().get(index);\n+\t\t\t\t\tcurrentIndexMapping = client.indices().getMapping(new GetMappingsRequest().types(type).indices(index)).mappings().get(index);", "originalCommit": "69b6aeb86743535de7a961cb23b145390f6e51a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ0Mzc2Nw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/478#discussion_r376443767", "bodyText": "Yes, unfortunately, the GetMapping/PutMapping/CreateIndex action requests still require type value to be specified. The new ES HLRC however uses a different set of Request classes which do not require the type value. I was able to remove all other type fields from the EsClient interface and implementations.", "author": "cmark", "createdAt": "2020-02-07T15:15:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ0MjEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ1NTUyNw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/478#discussion_r376455527", "bodyText": "This comment should be updated as well.", "author": "apeteri", "createdAt": "2020-02-07T15:35:37Z", "path": "core/com.b2international.snowowl.core/src/com/b2international/snowowl/core/request/SearchResourceRequestIterator.java", "diffHunk": "@@ -84,7 +72,7 @@ protected R computeNext() {\n \t\t}\n \n \t\t// Update scrollId and visited counter", "originalCommit": "7ed070c281db9d04adc6bf16554adcf0e1cddac1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "289b9694112abf6a45b124c117ff3425ee7b4af1", "url": "https://github.com/b2ihealthcare/snow-owl/commit/289b9694112abf6a45b124c117ff3425ee7b4af1", "message": "[core] update comments in SearchResourceRequestIterator", "committedDate": "2020-02-07T15:41:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ2MDMzMQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/478#discussion_r376460331", "bodyText": "Now that SearchResourceRequestIterator relies on the revision system for snapshot semantics, limit constants like the above could be changed to eg. BATCH_SIZE or similar.", "author": "apeteri", "createdAt": "2020-02-07T15:44:16Z", "path": "snomed/com.b2international.snowowl.snomed.reasoner/src/com/b2international/snowowl/snomed/reasoner/request/SaveJobRequest.java", "diffHunk": "@@ -87,7 +87,6 @@\n \tprivate static final Logger LOG = LoggerFactory.getLogger(\"reasoner\");\n \n \tprivate static final int SCROLL_LIMIT = 10_000;", "originalCommit": "7ed070c281db9d04adc6bf16554adcf0e1cddac1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ2Mjk0Mw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/478#discussion_r376462943", "bodyText": "How about using the export reference branch's head timestamp? We could even run the export on a BranchContext just to ensure that it's not a moving target.", "author": "apeteri", "createdAt": "2020-02-07T15:48:45Z", "path": "snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/request/rf2/SnomedRf2ExportRequest.java", "diffHunk": "@@ -251,6 +252,8 @@ void setLocales(List<ExtendedLocale> locales) {\n \n \t@Override\n \tpublic ExportResult execute(final RepositoryContext context) {\n+\t\t// register export start time for later use\n+\t\tfinal long exportStartTime = Instant.now().toEpochMilli();", "originalCommit": "3108cfd0640e32da6953c7e6914243480589128d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ2NzQxNQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/478#discussion_r376467415", "bodyText": "Great idea, but I'm afraid we cannot change the RepositoryContext to BranchContext in the SnomedRF2ExportRequest now. Feel free to experiment with it.", "author": "cmark", "createdAt": "2020-02-07T15:56:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ2Mjk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ2NzgzOQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/478#discussion_r376467839", "bodyText": "\u26a0\ufe0f typo in constant", "author": "apeteri", "createdAt": "2020-02-07T15:57:24Z", "path": "commons/com.b2international.index/src/com/b2international/index/es/admin/EsIndexAdmin.java", "diffHunk": "@@ -556,9 +556,9 @@ private void bulkIndexByScroll(final EsClient client,\n \t\t\t\t\n \t\t\t\tfinal BulkByScrollResponse response; \n \t\t\t\tif (\"update\".equals(command)) {\n-\t\t\t\t\tresponse = client.updateByQuery(getTypeIndex(mapping), mapping.typeAsString(), BATCHS_SIZE, script, getConcurrencyLevel(), query);\n+\t\t\t\t\tresponse = client.updateByQuery(getTypeIndex(mapping), BATCHS_SIZE, script, getConcurrencyLevel(), query);", "originalCommit": "95bcd094ebbe4f669c66a9682474154e87baefbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e577b4d1206fa6d863031e44a2e7e52e5808f85", "url": "https://github.com/b2ihealthcare/snow-owl/commit/9e577b4d1206fa6d863031e44a2e7e52e5808f85", "message": "[index] aggregations should always track total hits accurately", "committedDate": "2020-02-07T16:02:01Z", "type": "commit"}, {"oid": "52e7c26c94cb4d7a868e7c5fef7bb07f7097a115", "url": "https://github.com/b2ihealthcare/snow-owl/commit/52e7c26c94cb4d7a868e7c5fef7bb07f7097a115", "message": "[index] fix typo", "committedDate": "2020-02-07T16:05:05Z", "type": "commit"}]}