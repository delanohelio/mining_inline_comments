{"pr_number": 2100, "pr_title": "HDFS-15436. Default mount table name used by ViewFileSystem should be configurable", "pr_createdAt": "2020-06-25T02:33:30Z", "pr_url": "https://github.com/apache/hadoop/pull/2100", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5NzgxNg==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445697816", "bodyText": "Please format this line\n'when then default mount' --> when the default mount  ?", "author": "umamaheswararao", "createdAt": "2020-06-25T16:47:44Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/viewfs/TestViewFileSystemOverloadSchemeWithHdfsScheme.java", "diffHunk": "@@ -235,6 +237,57 @@ public void testListStatusOnNonMountedPath() throws Exception {\n       Assert.fail(\"It should fail as no mount link with /nonMount\");\n     }\n   }\n+  /**\n+   * Create mount links as follows\n+   * hdfs://localhost:xxx/HDFSUser --> hdfs://localhost:xxx/HDFSUser/\n+   * hdfs://localhost:xxx/local --> file://TEST_ROOT_DIR/root/\n+   * and check that \"viewfs:/\" paths work without specifying authority when then default mount table name", "originalCommit": "495798bcd46130c371763810d12de8e3eb5c829d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgwODkwNw==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445808907", "bodyText": "fixed.", "author": "virajith", "createdAt": "2020-06-25T20:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5NzgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5ODAzNg==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445698036", "bodyText": "Nit: Need formatting of these lines", "author": "umamaheswararao", "createdAt": "2020-06-25T16:48:06Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/viewfs/TestViewFileSystemOverloadSchemeWithHdfsScheme.java", "diffHunk": "@@ -235,6 +237,57 @@ public void testListStatusOnNonMountedPath() throws Exception {\n       Assert.fail(\"It should fail as no mount link with /nonMount\");\n     }\n   }\n+  /**\n+   * Create mount links as follows\n+   * hdfs://localhost:xxx/HDFSUser --> hdfs://localhost:xxx/HDFSUser/\n+   * hdfs://localhost:xxx/local --> file://TEST_ROOT_DIR/root/\n+   * and check that \"viewfs:/\" paths work without specifying authority when then default mount table name\n+   * is set correctly.\n+   */\n+  @Test\n+  public void testAccessViewFsPathWithoutAuthority() throws Exception {\n+    final Path hdfsTargetPath = new Path(defaultFSURI + HDFS_USER_FOLDER);\n+    addMountLinks(defaultFSURI.getAuthority(),\n+        new String[] {HDFS_USER_FOLDER, LOCAL_FOLDER },\n+        new String[] {hdfsTargetPath.toUri().toString(),\n+            localTargetDir.toURI().toString() },\n+        conf);\n+\n+    // /HDFSUser/test\n+    Path hdfsDir = new Path(HDFS_USER_FOLDER + \"/test\");\n+    // /local/test\n+    Path localDir = new Path(LOCAL_FOLDER + \"/test\");\n+\n+    try (ViewFileSystemOverloadScheme fs = (ViewFileSystemOverloadScheme) FileSystem.get(conf)) {\n+      fs.mkdirs(hdfsDir); // /HDFSUser/testfile\n+      fs.mkdirs(localDir); // /local/test\n+    }\n+\n+    FileStatus[] expectedStatus;\n+    try (FileSystem fs = FileSystem.get(conf)) {\n+      expectedStatus = fs.listStatus(new Path(\"/\"));\n+    }\n+\n+    // check for viewfs path without authority\n+    Path viewFsRootPath = new Path(\"viewfs:/\");\n+    try {\n+      viewFsRootPath.getFileSystem(conf);\n+      Assert.fail(\"Mount table with authority default should not be initialized\");\n+    } catch (IOException e) {\n+      assertTrue(e.getMessage().contains(\"Empty Mount table in config for viewfs://default/\"));\n+    }\n+\n+    // set the name of the default mount table here and subsequent calls should succeed.\n+    conf.set(Constants.CONFIG_VIEWFS_DEFAULT_MOUNT_TABLE_NAME_KEY, defaultFSURI.getAuthority());\n+\n+    try (FileSystem fs = viewFsRootPath.getFileSystem(conf)) {\n+      FileStatus[] status = fs.listStatus(viewFsRootPath);\n+      // compare only the final components of the paths as full paths have different schemes (hdfs:/ vs. viewfs:/).\n+      List<String> expectedPaths = Arrays.stream(expectedStatus).map(s -> s.getPath().getName()).collect(Collectors.toList());", "originalCommit": "495798bcd46130c371763810d12de8e3eb5c829d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgwODk2MQ==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445808961", "bodyText": "fixed.", "author": "virajith", "createdAt": "2020-06-25T20:07:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5ODAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcwNjAwMQ==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445706001", "bodyText": "Nit: you may create path object as new Path(Path, child). so we can avoid str concat. I know lot of existing tests have the same concat. Recently Started using this way :-)", "author": "umamaheswararao", "createdAt": "2020-06-25T17:01:11Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/viewfs/TestViewFileSystemOverloadSchemeWithHdfsScheme.java", "diffHunk": "@@ -235,6 +237,57 @@ public void testListStatusOnNonMountedPath() throws Exception {\n       Assert.fail(\"It should fail as no mount link with /nonMount\");\n     }\n   }\n+  /**\n+   * Create mount links as follows\n+   * hdfs://localhost:xxx/HDFSUser --> hdfs://localhost:xxx/HDFSUser/\n+   * hdfs://localhost:xxx/local --> file://TEST_ROOT_DIR/root/\n+   * and check that \"viewfs:/\" paths work without specifying authority when then default mount table name\n+   * is set correctly.\n+   */\n+  @Test\n+  public void testAccessViewFsPathWithoutAuthority() throws Exception {\n+    final Path hdfsTargetPath = new Path(defaultFSURI + HDFS_USER_FOLDER);\n+    addMountLinks(defaultFSURI.getAuthority(),\n+        new String[] {HDFS_USER_FOLDER, LOCAL_FOLDER },\n+        new String[] {hdfsTargetPath.toUri().toString(),\n+            localTargetDir.toURI().toString() },\n+        conf);\n+\n+    // /HDFSUser/test\n+    Path hdfsDir = new Path(HDFS_USER_FOLDER + \"/test\");", "originalCommit": "495798bcd46130c371763810d12de8e3eb5c829d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgwODgyNQ==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445808825", "bodyText": "fixed this.", "author": "virajith", "createdAt": "2020-06-25T20:07:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcwNjAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcwODY4MA==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445708680", "bodyText": "You may want to add some documentation in ViewFSOverloadScheme.md docs?", "author": "umamaheswararao", "createdAt": "2020-06-25T17:05:54Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/viewfs/Constants.java", "diffHunk": "@@ -41,12 +41,17 @@\n    * then the hadoop default value (/user) is used.\n    */\n   public static final String CONFIG_VIEWFS_HOMEDIR = \"homedir\";\n-  \n+\n+  /**\n+   * Config key to specify the name of the default mount table.\n+   */\n+  public static final String CONFIG_VIEWFS_DEFAULT_MOUNT_TABLE_NAME_KEY = \"fs.viewfs.mounttable.default.name.key\";", "originalCommit": "495798bcd46130c371763810d12de8e3eb5c829d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgwODUyNQ==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445808525", "bodyText": "Added details in ViewFSOverloadScheme.md.", "author": "virajith", "createdAt": "2020-06-25T20:07:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcwODY4MA=="}], "type": "inlineReview"}, {"oid": "cf651c02c3ce5ef7c774632f126488be35832f4c", "url": "https://github.com/apache/hadoop/commit/cf651c02c3ce5ef7c774632f126488be35832f4c", "message": "Address Uma's comments on PR#2100", "committedDate": "2020-06-25T19:56:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkyODgzNw==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445928837", "bodyText": "Thank you for adding doc. It looks good to me.\nYou may want to remove \"public static final\" in above constant as they are implicitly same in interface. checkstyle would be happy with that. :-)", "author": "umamaheswararao", "createdAt": "2020-06-26T01:57:45Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/viewfs/Constants.java", "diffHunk": "@@ -41,12 +41,17 @@\n    * then the hadoop default value (/user) is used.\n    */\n   public static final String CONFIG_VIEWFS_HOMEDIR = \"homedir\";\n-  \n+\n+  /**\n+   * Config key to specify the name of the default mount table.\n+   */\n+  public static final String CONFIG_VIEWFS_DEFAULT_MOUNT_TABLE_NAME_KEY = \"fs.viewfs.mounttable.default.name.key\";", "originalCommit": "67b87487b785052cdf8bc6d58c57797d99158702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk0Njk5OA==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445946998", "bodyText": "thanks for checking - removed this.", "author": "virajith", "createdAt": "2020-06-26T03:19:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkyODgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkyOTkxNA==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445929914", "bodyText": "Tiny nit: in the comment: // /HDFSUser/testfile --> // /HDFSUser/test ?", "author": "umamaheswararao", "createdAt": "2020-06-26T02:02:17Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/viewfs/TestViewFileSystemOverloadSchemeWithHdfsScheme.java", "diffHunk": "@@ -236,6 +238,61 @@ public void testListStatusOnNonMountedPath() throws Exception {\n     }\n   }\n \n+  /**\n+   * Create mount links as follows\n+   * hdfs://localhost:xxx/HDFSUser --> hdfs://localhost:xxx/HDFSUser/\n+   * hdfs://localhost:xxx/local --> file://TEST_ROOT_DIR/root/\n+   * Check that \"viewfs:/\" paths without authority can work when the\n+   * default mount table name is set correctly.\n+   */\n+  @Test\n+  public void testAccessViewFsPathWithoutAuthority() throws Exception {\n+    final Path hdfsTargetPath = new Path(defaultFSURI + HDFS_USER_FOLDER);\n+    addMountLinks(defaultFSURI.getAuthority(),\n+        new String[] {HDFS_USER_FOLDER, LOCAL_FOLDER },\n+        new String[] {hdfsTargetPath.toUri().toString(),\n+            localTargetDir.toURI().toString() },\n+        conf);\n+\n+    // /HDFSUser/test\n+    Path hdfsDir = new Path(HDFS_USER_FOLDER, \"test\");\n+    // /local/test\n+    Path localDir = new Path(LOCAL_FOLDER, \"test\");\n+    FileStatus[] expectedStatus;\n+\n+    try (FileSystem fs = FileSystem.get(conf)) {\n+      fs.mkdirs(hdfsDir); // /HDFSUser/testfile", "originalCommit": "67b87487b785052cdf8bc6d58c57797d99158702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk0Njk2Mg==", "url": "https://github.com/apache/hadoop/pull/2100#discussion_r445946962", "bodyText": "Fixed this", "author": "virajith", "createdAt": "2020-06-26T03:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkyOTkxNA=="}], "type": "inlineReview"}, {"oid": "d7c443d655a3177918ebd1b13a609fe882f7f6f5", "url": "https://github.com/apache/hadoop/commit/d7c443d655a3177918ebd1b13a609fe882f7f6f5", "message": "HDFS-15436. Default mount table name used by ViewFileSystem should be configurable", "committedDate": "2020-06-26T13:42:50Z", "type": "commit"}, {"oid": "8e4c5c277f75c88d431b3ff5e2d38a6d91c98472", "url": "https://github.com/apache/hadoop/commit/8e4c5c277f75c88d431b3ff5e2d38a6d91c98472", "message": "Replace Constants.CONFIG_VIEWFS_DEFAULT_MOUNT_TABLE use in tests", "committedDate": "2020-06-26T13:42:50Z", "type": "commit"}, {"oid": "cb2a1e5e8356edae4d4025b0030ba39510217dcf", "url": "https://github.com/apache/hadoop/commit/cb2a1e5e8356edae4d4025b0030ba39510217dcf", "message": "Address Uma's comments on PR#2100", "committedDate": "2020-06-26T13:42:50Z", "type": "commit"}, {"oid": "429daa01576040e9f57f79165dc781cff1a99363", "url": "https://github.com/apache/hadoop/commit/429daa01576040e9f57f79165dc781cff1a99363", "message": "Sort lists in test to match without concern to order", "committedDate": "2020-06-26T13:42:50Z", "type": "commit"}, {"oid": "a18177170c28884736cdf42f7aeb1e9fb71ff3ae", "url": "https://github.com/apache/hadoop/commit/a18177170c28884736cdf42f7aeb1e9fb71ff3ae", "message": "Address comments, fix checkstyle and fix failing tests", "committedDate": "2020-06-26T13:42:50Z", "type": "commit"}, {"oid": "f1935fd40e98c83b615efdaa8a0358de3de3f2b9", "url": "https://github.com/apache/hadoop/commit/f1935fd40e98c83b615efdaa8a0358de3de3f2b9", "message": "Fix checkstyle", "committedDate": "2020-06-26T13:42:50Z", "type": "commit"}, {"oid": "f1935fd40e98c83b615efdaa8a0358de3de3f2b9", "url": "https://github.com/apache/hadoop/commit/f1935fd40e98c83b615efdaa8a0358de3de3f2b9", "message": "Fix checkstyle", "committedDate": "2020-06-26T13:42:50Z", "type": "forcePushed"}]}