{"pr_number": 2406, "pr_title": "HDFS-15460. TestFileCreation#testServerDefaultsWithMinimalCaching fails intermittently.", "pr_createdAt": "2020-10-23T14:02:22Z", "pr_url": "https://github.com/apache/hadoop/pull/2406", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAxNTY5MA==", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r511015690", "bodyText": "Should we wait a little longer than 100ms?", "author": "goiri", "createdAt": "2020-10-23T16:55:22Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileCreation.java", "diffHunk": "@@ -273,10 +272,17 @@ public void testServerDefaultsWithMinimalCaching()\n               defaults.getDefaultStoragePolicyId());\n       doReturn(newDefaults).when(spyNamesystem).getServerDefaults();\n \n-      Thread.sleep(1);\n-      defaults = dfsClient.getServerDefaults();\n-      // Value is updated correctly\n-      assertEquals(updatedDefaultBlockSize, defaults.getBlockSize());\n+      // Verify that the value is updated correctly\n+      GenericTestUtils.waitFor(()->{\n+        try {\n+          FsServerDefaults currDef = dfsClient.getServerDefaults();\n+          return (currDef.getBlockSize() == updatedDefaultBlockSize);\n+        } catch (IOException e) {\n+          // do nothing;\n+          return false;\n+        }\n+      }, 1, 100);", "originalCommit": "8d54e819bccd13905ca277ba0556cb898b1807ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzNjA0MQ==", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r511036041", "bodyText": "Thanks @goiri for taking the time to look at the fix.\nThe old code used to sleep 1 ms. So, theoretically, we are doing 100x in case the node is slow compared to before.\nHow long do you suggest we should wait?", "author": "amahussein", "createdAt": "2020-10-23T17:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAxNTY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4OTE3NA==", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r511489174", "bodyText": "I think something like 1 second is reasonable.\nTaking into account that this extra time would only happen when the test fails, we would never see this.\nIn this case I prefer to be conservative and handle corner cases.", "author": "goiri", "createdAt": "2020-10-24T16:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAxNTY5MA=="}], "type": "inlineReview"}, {"oid": "f074489de93c34b279472c586d815b8bbfa5704c", "url": "https://github.com/apache/hadoop/commit/f074489de93c34b279472c586d815b8bbfa5704c", "message": "HDFS-15460. increase wait time to 1 seconds", "committedDate": "2020-10-26T13:53:21Z", "type": "forcePushed"}, {"oid": "61af10856763fcde7a7e99ad5fdc6f2bddff08eb", "url": "https://github.com/apache/hadoop/commit/61af10856763fcde7a7e99ad5fdc6f2bddff08eb", "message": "HDFS-15460. increase wait time to 1 seconds", "committedDate": "2020-10-26T13:55:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3MDU1Mg==", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r512570552", "bodyText": "Thank you @amahussein. How about increasing the timeout to 2 or 3 seconds?", "author": "aajisaka", "createdAt": "2020-10-27T10:23:18Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileCreation.java", "diffHunk": "@@ -273,10 +272,17 @@ public void testServerDefaultsWithMinimalCaching()\n               defaults.getDefaultStoragePolicyId());\n       doReturn(newDefaults).when(spyNamesystem).getServerDefaults();\n \n-      Thread.sleep(1);\n-      defaults = dfsClient.getServerDefaults();\n-      // Value is updated correctly\n-      assertEquals(updatedDefaultBlockSize, defaults.getBlockSize());\n+      // Verify that the value is updated correctly\n+      GenericTestUtils.waitFor(()->{\n+        try {\n+          FsServerDefaults currDef = dfsClient.getServerDefaults();\n+          return (currDef.getBlockSize() == updatedDefaultBlockSize);\n+        } catch (IOException e) {\n+          // do nothing;\n+          return false;\n+        }\n+      }, 1, 1000);", "originalCommit": "61af10856763fcde7a7e99ad5fdc6f2bddff08eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4Nzg0OQ==", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r512987849", "bodyText": "Thank you @aajisaka .. I updated the Pr setting the waitTime to 3 seconds.", "author": "amahussein", "createdAt": "2020-10-27T19:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3MDU1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEzMzU0Mg==", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r513133542", "bodyText": "This is changed so I assume @aajisaka is fine with this.", "author": "goiri", "createdAt": "2020-10-28T01:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3MDU1Mg=="}], "type": "inlineReview"}, {"oid": "5c122f1eab0e71eb3fb64484555642ad764fa8b1", "url": "https://github.com/apache/hadoop/commit/5c122f1eab0e71eb3fb64484555642ad764fa8b1", "message": "HDFS-15461. fix testServerDefaultsWithMinimalCaching.", "committedDate": "2020-10-27T19:20:03Z", "type": "commit"}, {"oid": "f8b180874b930c2b87de4ca08410cfcbb5abf250", "url": "https://github.com/apache/hadoop/commit/f8b180874b930c2b87de4ca08410cfcbb5abf250", "message": "HDFS-15460. increase wait time to 1 seconds", "committedDate": "2020-10-27T19:20:03Z", "type": "commit"}, {"oid": "b69b035f3330fb9bbed19c26a2559871a0020874", "url": "https://github.com/apache/hadoop/commit/b69b035f3330fb9bbed19c26a2559871a0020874", "message": "HDFS-15460. Increase waitTime to 3 seconds.", "committedDate": "2020-10-27T19:50:32Z", "type": "commit"}, {"oid": "b69b035f3330fb9bbed19c26a2559871a0020874", "url": "https://github.com/apache/hadoop/commit/b69b035f3330fb9bbed19c26a2559871a0020874", "message": "HDFS-15460. Increase waitTime to 3 seconds.", "committedDate": "2020-10-27T19:50:32Z", "type": "forcePushed"}]}