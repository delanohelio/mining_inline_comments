{"pr_number": 1915, "pr_title": "YARN-10210. Add a RMFailoverProxyProvider that does DNS resolution on failover", "pr_createdAt": "2020-03-25T20:01:10Z", "pr_url": "https://github.com/apache/hadoop/pull/1915", "timeline": [{"oid": "1a258271e6256e674760344cda0e1126b55de0a8", "url": "https://github.com/apache/hadoop/commit/1a258271e6256e674760344cda0e1126b55de0a8", "message": "initial push", "committedDate": "2020-03-25T19:57:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEzNDc5NQ==", "url": "https://github.com/apache/hadoop/pull/1915#discussion_r398134795", "bodyText": "Avoid this change.", "author": "goiri", "createdAt": "2020-03-25T20:05:01Z", "path": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common/src/main/java/org/apache/hadoop/yarn/client/DefaultNoHARMFailoverProxyProvider.java", "diffHunk": "@@ -95,4 +95,4 @@ public void performFailover(T currentProxy) {\n   public void close() throws IOException {\n     RPC.stopProxy(proxy);\n   }\n-}\n\\ No newline at end of file\n+}", "originalCommit": "1a258271e6256e674760344cda0e1126b55de0a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEzODEwOQ==", "url": "https://github.com/apache/hadoop/pull/1915#discussion_r398138109", "bodyText": "Reverted", "author": "RogPodge", "createdAt": "2020-03-25T20:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEzNDc5NQ=="}], "type": "inlineReview"}, {"oid": "edee70e7c962eb132c2e13a3a190b8a12a025bf2", "url": "https://github.com/apache/hadoop/commit/edee70e7c962eb132c2e13a3a190b8a12a025bf2", "message": "reverted style change for consistency", "committedDate": "2020-03-25T20:10:22Z", "type": "commit"}, {"oid": "fe748369c80af6d472bf4e197bcc54c2ca9cb873", "url": "https://github.com/apache/hadoop/commit/fe748369c80af6d472bf4e197bcc54c2ca9cb873", "message": "added back TestProxy code as it seems to be the correct way to instantiate a Proxy for these tests", "committedDate": "2020-03-25T22:09:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIxMjUxNw==", "url": "https://github.com/apache/hadoop/pull/1915#discussion_r398212517", "bodyText": "It looks likes Yetus is complaining about this:\nerror: Proxy(InvocationHandler) has protected", "author": "goiri", "createdAt": "2020-03-25T22:35:57Z", "path": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-client/src/test/java/org/apache/hadoop/yarn/client/TestNoHaRMFailoverProxyProvider.java", "diffHunk": "@@ -0,0 +1,272 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.yarn.client;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.io.retry.FailoverProxyProvider;\n+import org.apache.hadoop.yarn.api.ApplicationClientProtocol;\n+import org.apache.hadoop.yarn.api.records.NodeReport;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hadoop.yarn.conf.YarnConfiguration;\n+import org.apache.hadoop.yarn.exceptions.YarnException;\n+import org.apache.hadoop.yarn.server.MiniYARNCluster;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.Proxy;\n+import java.net.InetSocketAddress;\n+import java.util.List;\n+\n+import static org.junit.Assert.*;\n+import static org.mockito.Mockito.any;\n+import static org.mockito.Mockito.eq;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Unit tests for {@link DefaultNoHARMFailoverProxyProvider} and\n+ * {@link AutoRefreshNoHARMFailoverProxyProvider}.\n+ */\n+public class TestNoHaRMFailoverProxyProvider {\n+\n+  // Default port of yarn RM\n+  private static final int RM1_PORT = 8032;\n+  private static final int RM2_PORT = 8031;\n+\n+  private static final int NUMNODEMANAGERS = 1;\n+  private Configuration conf;\n+\n+  @Before\n+  public void setUp() throws IOException, YarnException {\n+    conf = new YarnConfiguration();\n+  }\n+\n+  /**\n+   * Tests the proxy generated by {@link DefaultNoHAFailoverProxyProvider}\n+   * will connect to RM.\n+   */\n+  @Test\n+  public void testRestartedRM() throws Exception {\n+    MiniYARNCluster cluster =\n+        new MiniYARNCluster(\"testRestartedRMNegative\", NUMNODEMANAGERS, 1, 1);\n+    YarnClient rmClient = YarnClient.createYarnClient();\n+    try {\n+      cluster.init(conf);\n+      cluster.start();\n+      final Configuration yarnConf = cluster.getConfig();\n+      rmClient = YarnClient.createYarnClient();\n+      rmClient.init(yarnConf);\n+      rmClient.start();\n+      List <NodeReport> nodeReports = rmClient.getNodeReports();\n+      assertEquals(\n+          \"The proxy didn't get expected number of node reports\",\n+          NUMNODEMANAGERS, nodeReports.size());\n+    } finally {\n+      if (rmClient != null) {\n+        rmClient.stop();\n+      }\n+      cluster.stop();\n+    }\n+  }\n+\n+  /**\n+   * Tests the proxy generated by\n+   * {@link AutoRefreshNoHARMFailoverProxyProvider} will connect to RM.\n+   */\n+  @Test\n+  public void testConnectingToRM() throws Exception {\n+    conf.setClass(YarnConfiguration.CLIENT_FAILOVER_NO_HA_PROXY_PROVIDER,\n+        AutoRefreshNoHARMFailoverProxyProvider.class,\n+        RMFailoverProxyProvider.class);\n+    MiniYARNCluster cluster =\n+        new MiniYARNCluster(\"testRestartedRMNegative\", NUMNODEMANAGERS, 1, 1);\n+    YarnClient rmClient = null;\n+    try {\n+      cluster.init(conf);\n+      cluster.start();\n+      final Configuration yarnConf = cluster.getConfig();\n+      rmClient = YarnClient.createYarnClient();\n+      rmClient.init(yarnConf);\n+      rmClient.start();\n+      List <NodeReport> nodeReports = rmClient.getNodeReports();\n+      assertEquals(\n+          \"The proxy didn't get expected number of node reports\",\n+          NUMNODEMANAGERS, nodeReports.size());\n+    } finally {\n+      if (rmClient != null) {\n+        rmClient.stop();\n+      }\n+      cluster.stop();\n+    }\n+  }\n+\n+  /**\n+   * Test that the {@link DefaultNoHARMFailoverProxyProvider}\n+   * will generate different proxies after RM IP changed\n+   * and {@link DefaultNoHARMFailoverProxyProvider#performFailover(Object)}\n+   * get called.\n+   */\n+  @Test\n+  public void testDefaultFPPGetOneProxy() throws Exception {\n+    // Create a proxy and mock a RMProxy\n+    Proxy mockProxy1 = new TestProxy((proxy, method, args) -> null);", "originalCommit": "fe748369c80af6d472bf4e197bcc54c2ca9cb873", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIxMjcyNw==", "url": "https://github.com/apache/hadoop/pull/1915#discussion_r398212727", "bodyText": "Yetus complains here:\nerror: Proxy(InvocationHandler) has protected", "author": "goiri", "createdAt": "2020-03-25T22:36:27Z", "path": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-client/src/test/java/org/apache/hadoop/yarn/client/TestRMFailoverProxyProvider.java", "diffHunk": "@@ -0,0 +1,306 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.yarn.client;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.io.retry.FailoverProxyProvider;\n+import org.apache.hadoop.yarn.api.ApplicationClientProtocol;\n+import org.apache.hadoop.yarn.conf.YarnConfiguration;\n+import org.apache.hadoop.yarn.exceptions.YarnException;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.Proxy;\n+import java.net.InetSocketAddress;\n+\n+import static org.junit.Assert.*;\n+import static org.mockito.Mockito.any;\n+import static org.mockito.Mockito.eq;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Unit tests for {@link ConfiguredRMFailoverProxyProvider} and\n+ * {@link AutoRefreshRMFailoverProxyProvider}.\n+ */\n+public class TestRMFailoverProxyProvider {\n+\n+  // Default port of yarn RM\n+  private static final int RM1_PORT = 8032;\n+  private static final int RM2_PORT = 8031;\n+  private static final int RM3_PORT = 8033;\n+\n+  private Configuration conf;\n+\n+  @Before\n+  public void setUp() throws IOException, YarnException {\n+    conf = new YarnConfiguration();\n+    conf.setClass(YarnConfiguration.CLIENT_FAILOVER_NO_HA_PROXY_PROVIDER,\n+        ConfiguredRMFailoverProxyProvider.class, RMFailoverProxyProvider.class);\n+    conf.setBoolean(YarnConfiguration.RM_HA_ENABLED, true);\n+  }\n+\n+  /**\n+   * Test that the {@link ConfiguredRMFailoverProxyProvider}\n+   * will loop through its set of proxies when\n+   * and {@link ConfiguredRMFailoverProxyProvider#performFailover(Object)}\n+   * gets called.\n+   */\n+  @Test\n+  public void testFailoverChange() throws Exception {\n+    //Adjusting the YARN Conf\n+    conf.set(YarnConfiguration.RM_HA_IDS, \"rm0, rm1\");\n+\n+    // Create two proxies and mock a RMProxy\n+    Proxy mockProxy2 = new TestProxy((proxy, method, args) -> null);", "originalCommit": "fe748369c80af6d472bf4e197bcc54c2ca9cb873", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "36b32ea25cd675b43de3fefd141db91152b5358e", "url": "https://github.com/apache/hadoop/commit/36b32ea25cd675b43de3fefd141db91152b5358e", "message": "fixed formatting and moved helper classes inside the tests", "committedDate": "2020-03-25T22:51:07Z", "type": "commit"}, {"oid": "62cc3fd9b81e8d8033cbdadb0e93cc11ebcd5f66", "url": "https://github.com/apache/hadoop/commit/62cc3fd9b81e8d8033cbdadb0e93cc11ebcd5f66", "message": "explicitly declared TestProxy as private", "committedDate": "2020-03-26T00:52:53Z", "type": "commit"}, {"oid": "525b0b4521025890fc561673a47d2b3f31dcaf62", "url": "https://github.com/apache/hadoop/commit/525b0b4521025890fc561673a47d2b3f31dcaf62", "message": "fixed whitespace error", "committedDate": "2020-03-26T01:26:58Z", "type": "commit"}]}