{"pr_number": 1999, "pr_title": "HADOOP-14566. Add seek support for SFTP FileSystem.", "pr_createdAt": "2020-05-06T19:44:50Z", "pr_url": "https://github.com/apache/hadoop/pull/1999", "timeline": [{"oid": "7f95e24687304973cd8996ffaeb8f35f44cd1e77", "url": "https://github.com/apache/hadoop/commit/7f95e24687304973cd8996ffaeb8f35f44cd1e77", "message": "seek method implementation", "committedDate": "2020-05-06T17:39:29Z", "type": "commit"}, {"oid": "e0fa916714bc4421ba8b1cba7ad3d96272401bfc", "url": "https://github.com/apache/hadoop/commit/e0fa916714bc4421ba8b1cba7ad3d96272401bfc", "message": "fixed code style issues", "committedDate": "2020-05-06T18:49:58Z", "type": "commit"}, {"oid": "9fa1307d554efc04ab20f190c541224937324d43", "url": "https://github.com/apache/hadoop/commit/9fa1307d554efc04ab20f190c541224937324d43", "message": "close ssh server only in case it is initialised", "committedDate": "2020-05-06T19:31:51Z", "type": "commit"}, {"oid": "9896efd6855b6552c1bce20cfac4e4641c31dd6d", "url": "https://github.com/apache/hadoop/commit/9896efd6855b6552c1bce20cfac4e4641c31dd6d", "message": "fixed broken thread safety", "committedDate": "2020-05-07T06:44:45Z", "type": "commit"}, {"oid": "46a2d51ee5ec0c8162154bf3ecfc0f9bd151f057", "url": "https://github.com/apache/hadoop/commit/46a2d51ee5ec0c8162154bf3ecfc0f9bd151f057", "message": "Fixed broken tests", "committedDate": "2020-05-07T11:27:58Z", "type": "commit"}, {"oid": "fb098c73e68b04d8054f0cd695ab0194d0ddb425", "url": "https://github.com/apache/hadoop/commit/fb098c73e68b04d8054f0cd695ab0194d0ddb425", "message": "Merge branch 'trunk' of https://github.com/apache/hadoop into HADOOP-14566", "committedDate": "2020-05-11T07:58:22Z", "type": "commit"}, {"oid": "6bad39285e95114e7b39cac186f536d06f784b29", "url": "https://github.com/apache/hadoop/commit/6bad39285e95114e7b39cac186f536d06f784b29", "message": "Merge branch 'trunk' of https://github.com/apache/hadoop into HADOOP-14566", "committedDate": "2020-05-14T17:52:26Z", "type": "commit"}, {"oid": "a9bc169c98a1f9ef4e3c438a86445106af42bf0b", "url": "https://github.com/apache/hadoop/commit/a9bc169c98a1f9ef4e3c438a86445106af42bf0b", "message": "Merge branch 'trunk' of https://github.com/apache/hadoop into HADOOP-14566", "committedDate": "2020-05-14T18:26:22Z", "type": "commit"}, {"oid": "773284d78979ed5eede930e95865769ed830a14f", "url": "https://github.com/apache/hadoop/commit/773284d78979ed5eede930e95865769ed830a14f", "message": "Merge branch 'trunk' of https://github.com/apache/hadoop into HADOOP-14566", "committedDate": "2020-05-15T10:32:29Z", "type": "commit"}, {"oid": "5bf201c250705f27f22fb5456a521d55b5f6c54d", "url": "https://github.com/apache/hadoop/commit/5bf201c250705f27f22fb5456a521d55b5f6c54d", "message": "Merge branch 'trunk' of https://github.com/apache/hadoop into HADOOP-14566", "committedDate": "2020-05-18T11:49:20Z", "type": "commit"}, {"oid": "bd5f4dfc4a8e69a35260dd6abf49ed9ce429d681", "url": "https://github.com/apache/hadoop/commit/bd5f4dfc4a8e69a35260dd6abf49ed9ce429d681", "message": "Merge branch 'trunk' of https://github.com/apache/hadoop into HADOOP-14566", "committedDate": "2020-05-18T14:31:41Z", "type": "commit"}, {"oid": "576093738eff65b69a4ddae340f8a25ef4ced4d6", "url": "https://github.com/apache/hadoop/commit/576093738eff65b69a4ddae340f8a25ef4ced4d6", "message": "Merge branch 'trunk' of https://github.com/apache/hadoop into HADOOP-14566", "committedDate": "2020-05-18T16:08:54Z", "type": "commit"}, {"oid": "86bdff3d89be5324a213654947a2ba7c4fd6891b", "url": "https://github.com/apache/hadoop/commit/86bdff3d89be5324a213654947a2ba7c4fd6891b", "message": "Merge branch 'trunk' of https://github.com/apache/hadoop into HADOOP-14566", "committedDate": "2020-05-18T17:21:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzMzY2NA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427433664", "bodyText": "nit: add a gap between org.apache imports and the others", "author": "steveloughran", "createdAt": "2020-05-19T16:24:24Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/sftp/SFTPInputStream.java", "diffHunk": "@@ -15,86 +15,113 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n+\n package org.apache.hadoop.fs.sftp;\n \n+import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.io.UncheckedIOException;\n \n+import com.jcraft.jsch.ChannelSftp;\n+import com.jcraft.jsch.SftpATTRS;\n+import com.jcraft.jsch.SftpException;\n+import org.apache.hadoop.fs.FSExceptionMessages;", "originalCommit": "86bdff3d89be5324a213654947a2ba7c4fd6891b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzNjUxNQ==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427436515", "bodyText": "sure, thank you", "author": "mpryahin", "createdAt": "2020-05-19T16:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzMzY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzNDE3MA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427434170", "bodyText": "why the double wrap?", "author": "steveloughran", "createdAt": "2020-05-19T16:25:08Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/sftp/SFTPInputStream.java", "diffHunk": "@@ -15,86 +15,113 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n+\n package org.apache.hadoop.fs.sftp;\n \n+import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.io.UncheckedIOException;\n \n+import com.jcraft.jsch.ChannelSftp;\n+import com.jcraft.jsch.SftpATTRS;\n+import com.jcraft.jsch.SftpException;\n+import org.apache.hadoop.fs.FSExceptionMessages;\n import org.apache.hadoop.fs.FSInputStream;\n import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n \n /** SFTP FileSystem input stream. */\n class SFTPInputStream extends FSInputStream {\n \n-  public static final String E_SEEK_NOTSUPPORTED = \"Seek not supported\";\n-  public static final String E_NULL_INPUTSTREAM = \"Null InputStream\";\n-  public static final String E_STREAM_CLOSED = \"Stream closed\";\n-\n+  private final ChannelSftp channel;\n+  private final Path path;\n   private InputStream wrappedStream;\n   private FileSystem.Statistics stats;\n   private boolean closed;\n   private long pos;\n-\n-  SFTPInputStream(InputStream stream,  FileSystem.Statistics stats) {\n-\n-    if (stream == null) {\n-      throw new IllegalArgumentException(E_NULL_INPUTSTREAM);\n+  private long nextPos;\n+  private long contentLength;\n+\n+  SFTPInputStream(ChannelSftp channel, Path path, FileSystem.Statistics stats) {\n+    try {\n+      this.channel = channel;\n+      this.path = path;\n+      this.stats = stats;\n+      this.wrappedStream = channel.get(path.toUri().getPath());\n+      SftpATTRS stat = channel.lstat(path.toString());\n+      this.contentLength = stat.getSize();\n+    } catch (SftpException e) {\n+      throw new UncheckedIOException(new IOException(e));\n     }\n-    this.wrappedStream = stream;\n-    this.stats = stats;\n+  }\n \n-    this.pos = 0;\n-    this.closed = false;\n+  @Override\n+  public synchronized void seek(long position) throws IOException {\n+    checkNotClosed();\n+    if (position < 0) {\n+      throw new EOFException(FSExceptionMessages.NEGATIVE_SEEK);\n+    }\n+    nextPos = position;\n   }\n \n   @Override\n-  public void seek(long position) throws IOException {\n-    throw new IOException(E_SEEK_NOTSUPPORTED);\n+  public synchronized int available() throws IOException {\n+    checkNotClosed();\n+    long remaining = contentLength - nextPos;\n+    if (remaining > Integer.MAX_VALUE) {\n+      return Integer.MAX_VALUE;\n+    }\n+    return (int) remaining;\n+  }\n+\n+  private void seekInternal() throws IOException {\n+    if (pos == nextPos) {\n+      return;\n+    }\n+    if (nextPos > pos) {\n+      long skipped = wrappedStream.skip(nextPos - pos);\n+      pos = pos + skipped;\n+    }\n+    if (nextPos < pos) {\n+      wrappedStream.close();\n+      try {\n+        wrappedStream = channel.get(path.toUri().getPath());\n+        pos = wrappedStream.skip(nextPos);\n+      } catch (SftpException e) {\n+        throw new UncheckedIOException(new IOException(e));", "originalCommit": "86bdff3d89be5324a213654947a2ba7c4fd6891b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2NTUzOA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427465538", "bodyText": "my bad, i'll unwrap it. Thank you!", "author": "mpryahin", "createdAt": "2020-05-19T17:13:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzNDE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzNjQ1MQ==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427436451", "bodyText": "why the double wrap?", "author": "steveloughran", "createdAt": "2020-05-19T16:28:30Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/sftp/SFTPInputStream.java", "diffHunk": "@@ -15,86 +15,113 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n+\n package org.apache.hadoop.fs.sftp;\n \n+import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.io.UncheckedIOException;\n \n+import com.jcraft.jsch.ChannelSftp;\n+import com.jcraft.jsch.SftpATTRS;\n+import com.jcraft.jsch.SftpException;\n+import org.apache.hadoop.fs.FSExceptionMessages;\n import org.apache.hadoop.fs.FSInputStream;\n import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n \n /** SFTP FileSystem input stream. */\n class SFTPInputStream extends FSInputStream {\n \n-  public static final String E_SEEK_NOTSUPPORTED = \"Seek not supported\";\n-  public static final String E_NULL_INPUTSTREAM = \"Null InputStream\";\n-  public static final String E_STREAM_CLOSED = \"Stream closed\";\n-\n+  private final ChannelSftp channel;\n+  private final Path path;\n   private InputStream wrappedStream;\n   private FileSystem.Statistics stats;\n   private boolean closed;\n   private long pos;\n-\n-  SFTPInputStream(InputStream stream,  FileSystem.Statistics stats) {\n-\n-    if (stream == null) {\n-      throw new IllegalArgumentException(E_NULL_INPUTSTREAM);\n+  private long nextPos;\n+  private long contentLength;\n+\n+  SFTPInputStream(ChannelSftp channel, Path path, FileSystem.Statistics stats) {\n+    try {\n+      this.channel = channel;\n+      this.path = path;\n+      this.stats = stats;\n+      this.wrappedStream = channel.get(path.toUri().getPath());\n+      SftpATTRS stat = channel.lstat(path.toString());\n+      this.contentLength = stat.getSize();\n+    } catch (SftpException e) {\n+      throw new UncheckedIOException(new IOException(e));", "originalCommit": "86bdff3d89be5324a213654947a2ba7c4fd6891b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2NDM0OQ==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427464349", "bodyText": "I tried to keep the contract unchanged but it seems I dropped the ball:\nPreviously an inputstream instance was created in the SFTPFileSystem#open(Path f, int bufferSize) method which threw IOExpetion in case of failure and its clients might deeply rely on this behaviour. Now as an underlying inputstream creation was moved from\nSFTPFileSystem into FSDataInputStream constructor I should've added IOExpetion to the FSDataInputStream constructor signature to keep things unchanged and backward compatible. Thanks a lot for pointing out.", "author": "mpryahin", "createdAt": "2020-05-19T17:11:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzNjQ1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzNzY2MA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427437660", "bodyText": "shouldn't this be set in core-default.xml already?\nif not, sftp:// urls would break. (yes, i know every stack overflow spark example does this, but that is just superstition)", "author": "steveloughran", "createdAt": "2020-05-19T16:30:16Z", "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/contract/sftp/SFTPContract.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ *  or more contributor license agreements.  See the NOTICE file\n+ *  distributed with this work for additional information\n+ *  regarding copyright ownership.  The ASF licenses this file\n+ *  to you under the Apache License, Version 2.0 (the\n+ *  \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.contract.sftp;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.FileSystemTestHelper;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.contract.AbstractFSContract;\n+import org.apache.hadoop.fs.sftp.SFTPFileSystem;\n+import org.apache.sshd.common.NamedFactory;\n+import org.apache.sshd.server.SshServer;\n+import org.apache.sshd.server.auth.UserAuth;\n+import org.apache.sshd.server.auth.password.UserAuthPasswordFactory;\n+import org.apache.sshd.server.keyprovider.SimpleGeneratorHostKeyProvider;\n+import org.apache.sshd.server.subsystem.sftp.SftpSubsystemFactory;\n+\n+public class SFTPContract extends AbstractFSContract {\n+\n+  private String testDataDir = new FileSystemTestHelper().getTestRootDir();\n+  private Configuration conf;\n+  public static final String CONTRACT_XML = \"contract/sftp.xml\";\n+  private SshServer sshd;\n+\n+  public SFTPContract(Configuration conf) {\n+    super(conf);\n+    addConfResource(CONTRACT_XML);\n+    this.conf = conf;\n+  }\n+\n+  @Override\n+  public void init() throws IOException {\n+    sshd = SshServer.setUpDefaultServer();\n+    // ask OS to assign a port\n+    sshd.setPort(0);\n+    sshd.setKeyPairProvider(new SimpleGeneratorHostKeyProvider());\n+\n+    List<NamedFactory<UserAuth>> userAuthFactories = new ArrayList<>();\n+    userAuthFactories.add(new UserAuthPasswordFactory());\n+\n+    sshd.setUserAuthFactories(userAuthFactories);\n+    sshd.setPasswordAuthenticator((username, password, session) ->\n+        username.equals(\"user\") && password.equals(\"password\")\n+    );\n+\n+    sshd.setSubsystemFactories(\n+        Collections.singletonList(new SftpSubsystemFactory()));\n+\n+    sshd.start();\n+    int port = sshd.getPort();\n+\n+    conf.setClass(\"fs.sftp.impl\", SFTPFileSystem.class, FileSystem.class);", "originalCommit": "86bdff3d89be5324a213654947a2ba7c4fd6891b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3NTY0OQ==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427475649", "bodyText": "it's not set in core-default.xml, and if not specified here sftp urls won't be resolved by sftp schema. Could you please clarify a bit what exactly you mean here? Thank you!", "author": "mpryahin", "createdAt": "2020-05-19T17:29:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzNzY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxMzIzMA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427613230", "bodyText": "double checked, it's quite strange. Is it a candidate for an improvement issue?", "author": "mpryahin", "createdAt": "2020-05-19T21:33:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzNzY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzODE3MQ==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427438171", "bodyText": "nit: make a variable and reuse", "author": "steveloughran", "createdAt": "2020-05-19T16:30:59Z", "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/contract/sftp/SFTPContract.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ *  or more contributor license agreements.  See the NOTICE file\n+ *  distributed with this work for additional information\n+ *  regarding copyright ownership.  The ASF licenses this file\n+ *  to you under the Apache License, Version 2.0 (the\n+ *  \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.contract.sftp;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.FileSystemTestHelper;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.contract.AbstractFSContract;\n+import org.apache.hadoop.fs.sftp.SFTPFileSystem;\n+import org.apache.sshd.common.NamedFactory;\n+import org.apache.sshd.server.SshServer;\n+import org.apache.sshd.server.auth.UserAuth;\n+import org.apache.sshd.server.auth.password.UserAuthPasswordFactory;\n+import org.apache.sshd.server.keyprovider.SimpleGeneratorHostKeyProvider;\n+import org.apache.sshd.server.subsystem.sftp.SftpSubsystemFactory;\n+\n+public class SFTPContract extends AbstractFSContract {\n+\n+  private String testDataDir = new FileSystemTestHelper().getTestRootDir();\n+  private Configuration conf;\n+  public static final String CONTRACT_XML = \"contract/sftp.xml\";\n+  private SshServer sshd;\n+\n+  public SFTPContract(Configuration conf) {\n+    super(conf);\n+    addConfResource(CONTRACT_XML);\n+    this.conf = conf;\n+  }\n+\n+  @Override\n+  public void init() throws IOException {\n+    sshd = SshServer.setUpDefaultServer();\n+    // ask OS to assign a port\n+    sshd.setPort(0);\n+    sshd.setKeyPairProvider(new SimpleGeneratorHostKeyProvider());\n+\n+    List<NamedFactory<UserAuth>> userAuthFactories = new ArrayList<>();\n+    userAuthFactories.add(new UserAuthPasswordFactory());\n+\n+    sshd.setUserAuthFactories(userAuthFactories);\n+    sshd.setPasswordAuthenticator((username, password, session) ->\n+        username.equals(\"user\") && password.equals(\"password\")\n+    );\n+\n+    sshd.setSubsystemFactories(\n+        Collections.singletonList(new SftpSubsystemFactory()));\n+\n+    sshd.start();\n+    int port = sshd.getPort();\n+\n+    conf.setClass(\"fs.sftp.impl\", SFTPFileSystem.class, FileSystem.class);\n+    conf.setInt(\"fs.sftp.host.port\", port);\n+    conf.setBoolean(\"fs.sftp.impl.disable.cache\", true);\n+  }\n+\n+  @Override\n+  public void teardown() throws IOException {\n+    if (sshd != null) {\n+      sshd.stop();\n+    }\n+  }\n+\n+  @Override\n+  public FileSystem getTestFileSystem() throws IOException {\n+    return FileSystem.get(URI.create(\"sftp://user:password@localhost\"), conf);", "originalCommit": "86bdff3d89be5324a213654947a2ba7c4fd6891b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3MjU3OA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427472578", "bodyText": "will do, thank you!", "author": "mpryahin", "createdAt": "2020-05-19T17:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzODE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ0MDMwNA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427440304", "bodyText": "shame we didn't declare this as raising an ioe; probably too late now", "author": "steveloughran", "createdAt": "2020-05-19T16:33:46Z", "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/contract/sftp/SFTPContract.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ *  or more contributor license agreements.  See the NOTICE file\n+ *  distributed with this work for additional information\n+ *  regarding copyright ownership.  The ASF licenses this file\n+ *  to you under the Apache License, Version 2.0 (the\n+ *  \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.contract.sftp;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.FileSystemTestHelper;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.contract.AbstractFSContract;\n+import org.apache.hadoop.fs.sftp.SFTPFileSystem;\n+import org.apache.sshd.common.NamedFactory;\n+import org.apache.sshd.server.SshServer;\n+import org.apache.sshd.server.auth.UserAuth;\n+import org.apache.sshd.server.auth.password.UserAuthPasswordFactory;\n+import org.apache.sshd.server.keyprovider.SimpleGeneratorHostKeyProvider;\n+import org.apache.sshd.server.subsystem.sftp.SftpSubsystemFactory;\n+\n+public class SFTPContract extends AbstractFSContract {\n+\n+  private String testDataDir = new FileSystemTestHelper().getTestRootDir();\n+  private Configuration conf;\n+  public static final String CONTRACT_XML = \"contract/sftp.xml\";\n+  private SshServer sshd;\n+\n+  public SFTPContract(Configuration conf) {\n+    super(conf);\n+    addConfResource(CONTRACT_XML);\n+    this.conf = conf;\n+  }\n+\n+  @Override\n+  public void init() throws IOException {\n+    sshd = SshServer.setUpDefaultServer();\n+    // ask OS to assign a port\n+    sshd.setPort(0);\n+    sshd.setKeyPairProvider(new SimpleGeneratorHostKeyProvider());\n+\n+    List<NamedFactory<UserAuth>> userAuthFactories = new ArrayList<>();\n+    userAuthFactories.add(new UserAuthPasswordFactory());\n+\n+    sshd.setUserAuthFactories(userAuthFactories);\n+    sshd.setPasswordAuthenticator((username, password, session) ->\n+        username.equals(\"user\") && password.equals(\"password\")\n+    );\n+\n+    sshd.setSubsystemFactories(\n+        Collections.singletonList(new SftpSubsystemFactory()));\n+\n+    sshd.start();\n+    int port = sshd.getPort();\n+\n+    conf.setClass(\"fs.sftp.impl\", SFTPFileSystem.class, FileSystem.class);\n+    conf.setInt(\"fs.sftp.host.port\", port);\n+    conf.setBoolean(\"fs.sftp.impl.disable.cache\", true);\n+  }\n+\n+  @Override\n+  public void teardown() throws IOException {\n+    if (sshd != null) {\n+      sshd.stop();\n+    }\n+  }\n+\n+  @Override\n+  public FileSystem getTestFileSystem() throws IOException {\n+    return FileSystem.get(URI.create(\"sftp://user:password@localhost\"), conf);\n+  }\n+\n+  @Override\n+  public String getScheme() {\n+    return \"sftp\";\n+  }\n+\n+  @Override\n+  public Path getTestPath() {", "originalCommit": "86bdff3d89be5324a213654947a2ba7c4fd6891b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4MjExNA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427482114", "bodyText": "it's not too late I suppose, would you like me to try to declare it as throwing IOE? I can issue a new Jira and fix it there.", "author": "mpryahin", "createdAt": "2020-05-19T17:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ0MDMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ0MTgxOA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427441818", "bodyText": "wrap super.close() with a try/finally so the channel is always diconnected", "author": "steveloughran", "createdAt": "2020-05-19T16:36:07Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/sftp/SFTPFileSystem.java", "diffHunk": "@@ -516,16 +515,14 @@ public FSDataInputStream open(Path f, int bufferSize) throws IOException {\n       disconnect(channel);\n       throw new IOException(String.format(E_PATH_DIR, f));\n     }\n-    InputStream is;\n     try {\n       // the path could be a symbolic link, so get the real path\n       absolute = new Path(\"/\", channel.realpath(absolute.toUri().getPath()));\n-\n-      is = channel.get(absolute.toUri().getPath());\n     } catch (SftpException e) {\n       throw new IOException(e);\n     }\n-    return new FSDataInputStream(new SFTPInputStream(is, statistics)){\n+    return new FSDataInputStream(\n+        new SFTPInputStream(channel, absolute, statistics)){\n       @Override\n       public void close() throws IOException {\n         super.close();", "originalCommit": "86bdff3d89be5324a213654947a2ba7c4fd6891b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2ODU0MA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r427468540", "bodyText": "thanks a lot will do", "author": "mpryahin", "createdAt": "2020-05-19T17:18:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ0MTgxOA=="}], "type": "inlineReview"}, {"oid": "4e823fdc32eeb209c7306eda32284653a3225b51", "url": "https://github.com/apache/hadoop/commit/4e823fdc32eeb209c7306eda32284653a3225b51", "message": "code review improvements", "committedDate": "2020-05-19T17:50:46Z", "type": "commit"}, {"oid": "3bc3e90b22045739f8b367ebd2f6fd575cd613e1", "url": "https://github.com/apache/hadoop/commit/3bc3e90b22045739f8b367ebd2f6fd575cd613e1", "message": "Merge branch 'trunk' of https://github.com/apache/hadoop into HADOOP-14566", "committedDate": "2020-05-19T17:51:48Z", "type": "commit"}, {"oid": "fb49a212116103c81e62b50cda6ee1bce80b15d5", "url": "https://github.com/apache/hadoop/commit/fb49a212116103c81e62b50cda6ee1bce80b15d5", "message": "codestyle improvements", "committedDate": "2020-05-19T20:51:02Z", "type": "commit"}, {"oid": "b874cdf5b10d61184b6602147aa6a9ae1e6f9929", "url": "https://github.com/apache/hadoop/commit/b874cdf5b10d61184b6602147aa6a9ae1e6f9929", "message": "make sure an underlying channel gets closed", "committedDate": "2020-05-19T21:19:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNjc5NA==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r433416794", "bodyText": "add . so javadoc is happy", "author": "steveloughran", "createdAt": "2020-06-01T18:38:27Z", "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/contract/AbstractFSContract.java", "diffHunk": "@@ -69,6 +69,14 @@ public void init() throws IOException {\n \n   }\n \n+  /**\n+   * Any teardown logic can go here", "originalCommit": "b874cdf5b10d61184b6602147aa6a9ae1e6f9929", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5MTM4OQ==", "url": "https://github.com/apache/hadoop/pull/1999#discussion_r433891389", "bodyText": "fixed, thank you.", "author": "mpryahin", "createdAt": "2020-06-02T13:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNjc5NA=="}], "type": "inlineReview"}, {"oid": "86bf896afe20c4d39af9a039dab8c695f98feb52", "url": "https://github.com/apache/hadoop/commit/86bf896afe20c4d39af9a039dab8c695f98feb52", "message": "fixed missing persiod in javadoc", "committedDate": "2020-06-02T13:50:40Z", "type": "commit"}]}