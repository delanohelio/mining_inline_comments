{"pr_number": 2010, "pr_title": "HADOOP-17024. ListStatus on ViewFS root should list the linkFallBack root", "pr_createdAt": "2020-05-12T00:55:46Z", "pr_url": "https://github.com/apache/hadoop/pull/2010", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEzOTIwNw==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424139207", "bodyText": "Make it private as we don't need to access this out side.\nI think we may not need this at all. You can setConf and getConf.\nAnd look at next comments, we can completely avoid if we use targetFileSystem instead of FileSystem.get(...conf)", "author": "umamaheswararao", "createdAt": "2020-05-13T02:32:42Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/viewfs/ViewFileSystem.java", "diffHunk": "@@ -1107,6 +1107,7 @@ public boolean hasPathCapability(Path path, String capability)\n     final long creationTime; // of the the mount table\n     final UserGroupInformation ugi; // the user/group of user who created mtable\n     final URI myUri;\n+    final Configuration conf;", "originalCommit": "378dead9315892ed8f988e386c7cabd8b63f1be2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0MjE5NQ==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424142195", "bodyText": "Please use theInternalDir.getFallbackLink().targetFileSystem instead of initializing/getting another fs.\nNow conf is not need at all and you dont need above uri also.", "author": "umamaheswararao", "createdAt": "2020-05-13T02:44:48Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/viewfs/ViewFileSystem.java", "diffHunk": "@@ -1226,7 +1229,38 @@ public FileStatus getFileStatus(Path f) throws IOException {\n                 myUri, null));\n         }\n       }\n-      return result;\n+      if (fallbackStatuses.length > 0) {\n+        return consolidateFileStatuses(fallbackStatuses, result);\n+      } else {\n+        return result;\n+      }\n+    }\n+\n+    private FileStatus[] consolidateFileStatuses(FileStatus[] fallbackStatuses,\n+        FileStatus[] mountPointStatuses) {\n+      ArrayList<FileStatus> result = new ArrayList<>();\n+      Set<String> pathSet = new HashSet<>();\n+      int i = 0;\n+      for (FileStatus status : mountPointStatuses) {\n+        result.add(status);\n+        pathSet.add(status.getPath().getName());\n+      }\n+      for (FileStatus status : fallbackStatuses) {\n+        if (!pathSet.contains(status.getPath().getName())) {\n+          result.add(status);\n+        }\n+      }\n+      return result.toArray(new FileStatus[0]);\n+    }\n+\n+    private FileStatus[] listStatusForFallbackLink() throws IOException {\n+      if (theInternalDir.isRoot() && theInternalDir.getFallbackLink() != null) {\n+        URI fallBackUri = theInternalDir.getFallbackLink().targetDirLinkList[0];", "originalCommit": "378dead9315892ed8f988e386c7cabd8b63f1be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1MzAxNA==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424753014", "bodyText": "theInternalDir.getFallbackLink().targetFileSystem is going to return ChRootedFileSystem which will wrap the path with fullPath(Path p) method. That was causing error. I have used the underlying filesystem object of the ChRootedFileSystem", "author": "abhishekdas99", "createdAt": "2020-05-13T21:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0MjE5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ2OTA2Mg==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r425469062", "bodyText": "Why you might have issue was because you are passing fallBackUri. ChrootedFS already contains /fallBackDir and you are again passing a uri which contains /fallbackDir. SO it will fail with \"FNFE\". If you use chrootedfs, you should just pass relative path by cutting chrooteduri. Since we support only at root, it will be simply \"/\" on chorootedfs.\nI have one another concern that we are returning absolute path with fall back in ls. But with regular mountlinks we will return relative to viewfs scheme ex: [viewfs://default/data, viewfs://default/targetRoot, viewfs://default/danglingLink, [viewfs://default/user2, viewfs://default/user, viewfs://default/internalDir, viewfs://default/linkToAFile]\nSince fallback also part of viewfs and its actually a child fs, should we return fallback paths also relatively constructed with respective to viewfs:// scheme?\nexmaple: your fallback path is hdfs://nn1/fallBackDir and you have a  dir under it. That is /user1\nSo, when you do ls, should it return viewfs://default/user1 ?\nif you use this ls result path to create some directory like viewfs://default/user1/test1, it will/should work ( IMO) and it should create at physical location of hdfs://nn1/fallBackDir/user1/test1\nBecause you did not have any other mount link with /user1, it will fallback to create at fallback link.\nBut with the current behavior, we are returning hdfs://nn1/fallBackDir/user1 and if you use this path to create a dir under it, it will actually go to regular hdfs instance but not via viewfs. This could be a potentially problem in that case overloadScheme impl. There hdfs can go to ViewFSOverloadScheme and try to create path as hdfs://nn1/fallBackDir/user1. Now fallBackDir/user1 will be attempted to create in viewfsOS env, it checks whether we have any link with fallBackDir. Of course we will not have any regular link. So, it will create at fallback link.\nOur fallback link is already hdfs://nn1/fallbackDir and now it will attempt to create /fallbackDir/user1\nSo, it will result to create hdfs://nn1/fallbackDir/fallbackDir/user1. This seems not correct.", "author": "umamaheswararao", "createdAt": "2020-05-14T22:37:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0MjE5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY3MTU5Nw==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r425671597", "bodyText": "I totally agree with your thought. Changed the path back to viewfs. Also in the unit test, verified the creation of directory with the returned path.", "author": "abhishekdas99", "createdAt": "2020-05-15T09:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0MjE5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0NjU3OA==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424146578", "bodyText": "Can we also add asserts for paths? I would like to see how fallback paths are expected and what we get.\nHow we should display fallback ls paths..\nex: if fallback is : hdfs://nn2/root/ and it has /a /b at root folder\nthen ls on hdfs://nn2/root/ should display /a /b\nBut displaying qualified names makes sense to me to differentiate between mount links and fallback links.\nin another thought it would confuse and if users use that uri path directly, they would directly interact with that fs instead of going via ViewFS.\nexample if you return [hdfs://nn1/root/a, hdfs://nn1/root/b] and when application wants to use this path, they will directly initialize hdfs instead of going through ViewFS.", "author": "umamaheswararao", "createdAt": "2020-05-13T03:02:30Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/viewfs/TestViewFileSystemLinkFallback.java", "diffHunk": "@@ -261,4 +261,53 @@ public void testConfLinkFallbackWithMountPoint() throws Exception {\n           e.getMessage().contains(expectedErrorMsg));\n     }\n   }\n+\n+  @Test\n+  public void testListingWithFallbackLink() throws Exception {\n+    fsTarget.mkdirs(new Path(targetTestRoot, \"fallbackDir/dir1\"));\n+    fsTarget.mkdirs(new Path(targetTestRoot, \"fallbackDir/dir2\"));\n+    String clusterName = Constants.CONFIG_VIEWFS_DEFAULT_MOUNT_TABLE;\n+    URI viewFsUri = new URI(FsConstants.VIEWFS_SCHEME, clusterName,\n+        \"/\", null, null);\n+\n+    int itemCount = 0;\n+    try(FileSystem vfs = FileSystem.get(viewFsUri, conf)) {\n+      itemCount = vfs.listStatus(new Path(viewFsUri.toString())).length;\n+    }\n+\n+    ConfigUtil.addLinkFallback(conf, clusterName,\n+        new Path(targetTestRoot, \"fallbackDir\").toUri());\n+\n+    try (FileSystem vfs = FileSystem.get(viewFsUri, conf)) {\n+      FileStatus[] statuses = vfs.listStatus(new Path(viewFsUri.toString()));\n+      assertTrue(\"Listing didn't include fallback link\",", "originalCommit": "378dead9315892ed8f988e386c7cabd8b63f1be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1Mzk3NQ==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424753975", "bodyText": "Added the assert for paths", "author": "abhishekdas99", "createdAt": "2020-05-13T21:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0NjU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5MTgxNw==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r426191817", "bodyText": "Thanks you for addressing. Let me take a look at it.", "author": "umamaheswararao", "createdAt": "2020-05-16T21:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0NjU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0Njc1Mw==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424146753", "bodyText": "I would like to see small java doc for test what you are doing.", "author": "umamaheswararao", "createdAt": "2020-05-13T03:03:10Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/viewfs/TestViewFileSystemLinkFallback.java", "diffHunk": "@@ -261,4 +261,53 @@ public void testConfLinkFallbackWithMountPoint() throws Exception {\n           e.getMessage().contains(expectedErrorMsg));\n     }\n   }\n+", "originalCommit": "378dead9315892ed8f988e386c7cabd8b63f1be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1MzA1NQ==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424753055", "bodyText": "Done", "author": "abhishekdas99", "createdAt": "2020-05-13T21:53:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0Njc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0NzUxMw==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424147513", "bodyText": "For consistency: could you please change this method name as add* ?\nvar names can be fallBackLink --> fallbackLink\nIn exception message as well.", "author": "umamaheswararao", "createdAt": "2020-05-13T03:06:31Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/viewfs/InodeTree.java", "diffHunk": "@@ -149,6 +150,17 @@ boolean isRoot() {\n       return isRoot;\n     }\n \n+    INodeLink<T> getFallbackLink() {\n+      return fallbackLink;\n+    }\n+", "originalCommit": "378dead9315892ed8f988e386c7cabd8b63f1be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1MTUwMA==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424751500", "bodyText": "Done.", "author": "abhishekdas99", "createdAt": "2020-05-13T21:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0NzUxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0ODQwMw==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424148403", "bodyText": "How do we make sure we are getting mount link path displayed over fallback? Please validate this.", "author": "umamaheswararao", "createdAt": "2020-05-13T03:10:33Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/viewfs/TestViewFileSystemLinkFallback.java", "diffHunk": "@@ -261,4 +261,53 @@ public void testConfLinkFallbackWithMountPoint() throws Exception {\n           e.getMessage().contains(expectedErrorMsg));\n     }\n   }\n+\n+  @Test\n+  public void testListingWithFallbackLink() throws Exception {\n+    fsTarget.mkdirs(new Path(targetTestRoot, \"fallbackDir/dir1\"));\n+    fsTarget.mkdirs(new Path(targetTestRoot, \"fallbackDir/dir2\"));\n+    String clusterName = Constants.CONFIG_VIEWFS_DEFAULT_MOUNT_TABLE;\n+    URI viewFsUri = new URI(FsConstants.VIEWFS_SCHEME, clusterName,\n+        \"/\", null, null);\n+\n+    int itemCount = 0;\n+    try(FileSystem vfs = FileSystem.get(viewFsUri, conf)) {\n+      itemCount = vfs.listStatus(new Path(viewFsUri.toString())).length;\n+    }\n+\n+    ConfigUtil.addLinkFallback(conf, clusterName,\n+        new Path(targetTestRoot, \"fallbackDir\").toUri());\n+\n+    try (FileSystem vfs = FileSystem.get(viewFsUri, conf)) {\n+      FileStatus[] statuses = vfs.listStatus(new Path(viewFsUri.toString()));\n+      assertTrue(\"Listing didn't include fallback link\",\n+          statuses.length == itemCount + 2);\n+    }\n+  }\n+\n+  @Test\n+  public void testListingWithFallbackLinkWithSameMountDirectories()\n+      throws Exception {\n+    // Creating two directories under the fallback dircetory.\n+    // user directory already exists as configured mount point.\n+    fsTarget.mkdirs(new Path(targetTestRoot, \"fallbackDir/user\"));\n+    fsTarget.mkdirs(new Path(targetTestRoot, \"fallbackDir/user1\"));\n+    String clusterName = Constants.CONFIG_VIEWFS_DEFAULT_MOUNT_TABLE;\n+    URI viewFsUri = new URI(FsConstants.VIEWFS_SCHEME, clusterName,\n+        \"/\", null, null);\n+\n+    int itemCount = 0;\n+    try(FileSystem vfs = FileSystem.get(viewFsUri, conf)) {\n+      itemCount = vfs.listStatus(new Path(viewFsUri.toString())).length;\n+    }\n+\n+    ConfigUtil.addLinkFallback(conf, clusterName,\n+        new Path(targetTestRoot, \"fallbackDir\").toUri());\n+\n+    try (FileSystem vfs = FileSystem.get(viewFsUri, conf)) {\n+      FileStatus[] statuses = vfs.listStatus(new Path(viewFsUri.toString()));\n+      assertTrue(\"The same directory name in fallback link should be shaded\",", "originalCommit": "378dead9315892ed8f988e386c7cabd8b63f1be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NDI5Nw==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424754297", "bodyText": "Added a check to make sure the fallback path is not the one which has the same name as the mount path.", "author": "abhishekdas99", "createdAt": "2020-05-13T21:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0ODQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4MjY1Nw==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424582657", "bodyText": "You may want to add the similar changes in ViewFs.java  to cover FileContext based fs impl.", "author": "umamaheswararao", "createdAt": "2020-05-13T16:45:05Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/viewfs/ViewFileSystem.java", "diffHunk": "@@ -1107,6 +1107,7 @@ public boolean hasPathCapability(Path path, String capability)\n     final long creationTime; // of the the mount table", "originalCommit": "378dead9315892ed8f988e386c7cabd8b63f1be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2Mzk3Mw==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r424763973", "bodyText": "Added change in ViewFs.java", "author": "abhishekdas99", "createdAt": "2020-05-13T22:20:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4MjY1Nw=="}], "type": "inlineReview"}, {"oid": "2a610f99efe628bfa73230ed704bb28ddf857d79", "url": "https://github.com/apache/hadoop/commit/2a610f99efe628bfa73230ed704bb28ddf857d79", "message": "HADOOP-17024. ListStatus on ViewFS root should list the linkFallBack root", "committedDate": "2020-05-13T21:48:53Z", "type": "commit"}, {"oid": "2a610f99efe628bfa73230ed704bb28ddf857d79", "url": "https://github.com/apache/hadoop/commit/2a610f99efe628bfa73230ed704bb28ddf857d79", "message": "HADOOP-17024. ListStatus on ViewFS root should list the linkFallBack root", "committedDate": "2020-05-13T21:48:53Z", "type": "forcePushed"}, {"oid": "059092f831fa3362925ce40079e3921ec4ed687e", "url": "https://github.com/apache/hadoop/commit/059092f831fa3362925ce40079e3921ec4ed687e", "message": "HADOOP-17024. Added the same change in ViewFs to cover FileContext based fs impl.", "committedDate": "2020-05-13T22:04:17Z", "type": "commit"}, {"oid": "93200c650a0ad448c03e89da9b1f6e66732a15d9", "url": "https://github.com/apache/hadoop/commit/93200c650a0ad448c03e89da9b1f6e66732a15d9", "message": "HADOOP-17024. Fixed build issue.", "committedDate": "2020-05-13T22:09:29Z", "type": "commit"}, {"oid": "c17bc407000d842e77c0d907134e54bb8ad82842", "url": "https://github.com/apache/hadoop/commit/c17bc407000d842e77c0d907134e54bb8ad82842", "message": "HADOOP-17024. Fix style issues.", "committedDate": "2020-05-14T08:07:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ4NzM3NQ==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r425487375", "bodyText": "Please remove above unused variable.", "author": "umamaheswararao", "createdAt": "2020-05-14T23:37:27Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/viewfs/ViewFileSystem.java", "diffHunk": "@@ -1226,7 +1227,39 @@ public FileStatus getFileStatus(Path f) throws IOException {\n                 myUri, null));\n         }\n       }\n-      return result;\n+      if (fallbackStatuses.length > 0) {\n+        return consolidateFileStatuses(fallbackStatuses, result);\n+      } else {\n+        return result;\n+      }\n+    }\n+\n+    private FileStatus[] consolidateFileStatuses(FileStatus[] fallbackStatuses,\n+        FileStatus[] mountPointStatuses) {\n+      ArrayList<FileStatus> result = new ArrayList<>();\n+      Set<String> pathSet = new HashSet<>();\n+      int i = 0;", "originalCommit": "c17bc407000d842e77c0d907134e54bb8ad82842", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY3MDMzMQ==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r425670331", "bodyText": "Done", "author": "abhishekdas99", "createdAt": "2020-05-15T09:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ4NzM3NQ=="}], "type": "inlineReview"}, {"oid": "46988ede0a6935c2a323a42cd8a68ca3ed1279d0", "url": "https://github.com/apache/hadoop/commit/46988ede0a6935c2a323a42cd8a68ca3ed1279d0", "message": "HADOOP-17024. Addressed code review comments", "committedDate": "2020-05-15T09:09:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5MzY0NQ==", "url": "https://github.com/apache/hadoop/pull/2010#discussion_r426193645", "bodyText": "Overall looks good to me now.\nHowever, This will be a behavioral change. Users may suddenly see additional dirs listed in ls result. So, I would suggest to update Javadoc for this API? ( do the same thing at ViewFs.java as well)\nEx:\n/**\n   * {@inheritDoc}\n   * \n   * Note: ls on root(\"/\") considers listing from fallbackLink also if\n   * available. Also write about shading part when same dirs in mount link and\n   * fallback dir?\n   */\n  @Override\n  public FileStatus[] listStatus(final Path f) throws AccessControlException, \n\nI will also mark incompatible change at JIRA and can update release notes. What do you say?\nThanks for handling all the feedback. After adding this, I think we should be good to go.", "author": "umamaheswararao", "createdAt": "2020-05-16T21:41:57Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/viewfs/ViewFileSystem.java", "diffHunk": "@@ -1204,6 +1204,7 @@ public FileStatus getFileStatus(Path f) throws IOException {\n     public FileStatus[] listStatus(Path f) throws AccessControlException,", "originalCommit": "46988ede0a6935c2a323a42cd8a68ca3ed1279d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fb4bf895ce5d6896823bdf6f9ea52ef222a9abf8", "url": "https://github.com/apache/hadoop/commit/fb4bf895ce5d6896823bdf6f9ea52ef222a9abf8", "message": "HADOOP-17024. Updated javadoc for listStatus", "committedDate": "2020-05-18T23:05:16Z", "type": "commit"}]}