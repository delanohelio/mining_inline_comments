{"pr_number": 1948, "pr_title": "HADOOP-16986. S3A to not need wildfly on the classpath.", "pr_createdAt": "2020-04-09T14:05:24Z", "pr_url": "https://github.com/apache/hadoop/pull/1948", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY1MzEyOA==", "url": "https://github.com/apache/hadoop/pull/1948#discussion_r407653128", "bodyText": "Wouldn't it be better to move the code within try-catch into a new method so that the same can be resued for the case openSSL as well.", "author": "bilaharith", "createdAt": "2020-04-13T18:57:25Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/ssl/DelegatingSSLSocketFactory.java", "diffHunk": "@@ -149,11 +149,11 @@ private void initializeSSLContext(SSLChannelMode preferredChannelMode)\n       throws NoSuchAlgorithmException, KeyManagementException {\n     switch (preferredChannelMode) {\n     case Default:\n-      if (!openSSLProviderRegistered) {\n-        OpenSSLProvider.register();\n-        openSSLProviderRegistered = true;\n-      }\n       try {\n+        if (!openSSLProviderRegistered) {", "originalCommit": "55a2a77672762440c21e3013b7d72de599b1c190", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAwMzQ4NQ==", "url": "https://github.com/apache/hadoop/pull/1948#discussion_r408003485", "bodyText": "I'd put it here so that if someone asked for openSSL and there were problems, it really would fail. It was in default where wildfly load (and pointer errors) triggered catch and downgrade.\nFor the S3A Binding there already was some classpath catching, so I Added it there too so that any failure here just falls back to the default AWS SDK binding. For abfs I've left it alone", "author": "steveloughran", "createdAt": "2020-04-14T09:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY1MzEyOA=="}], "type": "inlineReview"}, {"oid": "4a0307e8e7b4c77515e52e6e181625606051961f", "url": "https://github.com/apache/hadoop/commit/4a0307e8e7b4c77515e52e6e181625606051961f", "message": "HADOOP-16986. s3a to not need wildfly on the classpath\n\n* completely remove wildfly jar as a dependency of hadoop-aws\n* socket factory to catch and swallow all\n* and verify that in tests\n* tests which also verify that in the default factory mode,\n  classloader errors are caught and downgrade to jvm\n* and in openssl mode, the s3a binding explicitly catches\n  these failures and handles too\n\nThis means\n\ns3a:\n\nwhen widlfy doesn't load for classpath or wildfly/openssl issues, S3A will\ndowngrade to jvm, irrespective of SSL mode option.\n\nabfs:\n\nwhen widlfy doesn't load for classpath or wildfly/openssl issues,\n\ndefault: swallow and downgrade to jvm\nopenssl: exception thrown; you can't talk to azure.\n\nYes, these are different behaviours. But abfs has always mandated the wildfly\nlibrary S3A has never done this and I do not want to start now. If\npeople/project downstream want to use it -fine. If they are running on the\nmachines where open SSL is found and is compatible -they will actually see a\nspeed up. Without that, it is utterly superfluous and simply any other source\nof class path dependency and stack trace issues.\n\nSorry, I hadn't realised the previous patch was going to require wildfly\neverywhere; I wouldn't make sure that was an otherwise.\n\nI intend to get this patch into branch 3.3 as well, so only 3.3.0 has the\nextra dependency.\n\nChange-Id: I74c4b8a1876b5c28d7d96fe3a6dc8e22ffbdc1f7", "committedDate": "2020-04-14T18:25:33Z", "type": "commit"}, {"oid": "4a0307e8e7b4c77515e52e6e181625606051961f", "url": "https://github.com/apache/hadoop/commit/4a0307e8e7b4c77515e52e6e181625606051961f", "message": "HADOOP-16986. s3a to not need wildfly on the classpath\n\n* completely remove wildfly jar as a dependency of hadoop-aws\n* socket factory to catch and swallow all\n* and verify that in tests\n* tests which also verify that in the default factory mode,\n  classloader errors are caught and downgrade to jvm\n* and in openssl mode, the s3a binding explicitly catches\n  these failures and handles too\n\nThis means\n\ns3a:\n\nwhen widlfy doesn't load for classpath or wildfly/openssl issues, S3A will\ndowngrade to jvm, irrespective of SSL mode option.\n\nabfs:\n\nwhen widlfy doesn't load for classpath or wildfly/openssl issues,\n\ndefault: swallow and downgrade to jvm\nopenssl: exception thrown; you can't talk to azure.\n\nYes, these are different behaviours. But abfs has always mandated the wildfly\nlibrary S3A has never done this and I do not want to start now. If\npeople/project downstream want to use it -fine. If they are running on the\nmachines where open SSL is found and is compatible -they will actually see a\nspeed up. Without that, it is utterly superfluous and simply any other source\nof class path dependency and stack trace issues.\n\nSorry, I hadn't realised the previous patch was going to require wildfly\neverywhere; I wouldn't make sure that was an otherwise.\n\nI intend to get this patch into branch 3.3 as well, so only 3.3.0 has the\nextra dependency.\n\nChange-Id: I74c4b8a1876b5c28d7d96fe3a6dc8e22ffbdc1f7", "committedDate": "2020-04-14T18:25:33Z", "type": "forcePushed"}, {"oid": "91d88c31463b1f1a514859f5df07eb5f5f882503", "url": "https://github.com/apache/hadoop/commit/91d88c31463b1f1a514859f5df07eb5f5f882503", "message": "HADOOP-16855. S3A resilience to wildfly classes missing.\n\nopenssl will not downgrade in AWS client setup\n\n* cover in docs, including troubleshooting\n* cleanup of duplicate code in DelegatingSSLSocketFactory\n* tests cover failure modes\n* add a way to reset the static DelegatingSSLSocketFactory so\n  that the tests can actually force a reload.\n\nChange-Id: I25d09d42cd87fe7e9909cff1e80141bfea69724a", "committedDate": "2020-04-14T20:40:25Z", "type": "commit"}, {"oid": "6acc273328e8960edecdde41cf9b6f4a22eb1a5c", "url": "https://github.com/apache/hadoop/commit/6acc273328e8960edecdde41cf9b6f4a22eb1a5c", "message": "HADOOP-16855. Wildfly class binding\n\nfix checkstyle and site\n\nChange-Id: I06a7fca5ec38aacdd53cbc9edd6c7794ca73adba", "committedDate": "2020-04-15T09:09:57Z", "type": "commit"}, {"oid": "ff698c852284e2cb20d5b9b5907d875ff18b0540", "url": "https://github.com/apache/hadoop/commit/ff698c852284e2cb20d5b9b5907d875ff18b0540", "message": "HADOOP-16855. reinstate wildfly as a dependency,\nbut we are resilient to its absence.\n\nChange-Id: I369489ce11f18624e13bc3e4319a7bd4d8ce1389", "committedDate": "2020-04-15T16:48:17Z", "type": "commit"}]}