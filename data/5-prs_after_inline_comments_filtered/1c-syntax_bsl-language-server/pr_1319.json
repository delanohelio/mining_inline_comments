{"pr_number": 1319, "pr_title": "\u0421\u043b\u0435\u0436\u0435\u043d\u0438\u0435 \u0437\u0430 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0435\u043c \u0444\u0430\u0439\u043b\u0430 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438", "pr_createdAt": "2020-08-01T21:18:33Z", "pr_url": "https://github.com/1c-syntax/bsl-language-server/pull/1319", "timeline": [{"oid": "fb6367998902813cedbe7d4069c92840aba5a8fa", "url": "https://github.com/1c-syntax/bsl-language-server/commit/fb6367998902813cedbe7d4069c92840aba5a8fa", "message": "\u041d\u0435\u0431\u043e\u043b\u044c\u0448\u043e\u0435 \u043f\u0440\u0438\u0447\u0435\u0441\u044b\u0432\u0430\u043d\u0438\u0435 API", "committedDate": "2020-08-01T21:16:38Z", "type": "commit"}, {"oid": "07c5130b9bb74d37364c66623c555452eaaf86c2", "url": "https://github.com/1c-syntax/bsl-language-server/commit/07c5130b9bb74d37364c66623c555452eaaf86c2", "message": "\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u0430\u0432\u0442\u043e\u043d\u043e\u043c\u043d\u043e\u0433\u043e \u0432\u043e\u0442\u0447\u0435\u0440\u0430 \u0437\u0430 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0435\u043c \u0444\u0430\u0439\u043b\u0430 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438", "committedDate": "2020-08-01T21:17:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAwMjU2MA==", "url": "https://github.com/1c-syntax/bsl-language-server/pull/1319#discussion_r464002560", "bodyText": "\u0422\u0443\u0442 \u043f\u043e\u0442\u0435\u043d\u0446\u0438\u0430\u043b\u044c\u043d\u043e \u043c\u043d\u043e\u0433\u043e\u0440\u0430\u0437\u043e\u0432\u0430\u044f \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f \u0441\u0435\u0440\u0432\u0438\u0441\u0430. \u042d\u0442\u043e \u0432\u0440\u043e\u0434\u0435 \u043d\u0435 \u0441\u0442\u0440\u0430\u0448\u043d\u043e (\u0441\u043e\u0431\u044b\u0442\u0438\u044f \u0432\u0441\u0435 \u0440\u0430\u0432\u043d\u043e \u0441\u0440\u0430\u0431\u0430\u0442\u044b\u0432\u0430\u044e\u0442 \u043e\u0436\u0438\u0434\u0430\u0435\u043c\u043e\u0435 \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0440\u0430\u0437), \u043d\u043e \u043d\u0435 \u043e\u0447\u0435\u043d\u044c \u043a\u0440\u0430\u0441\u0438\u0432\u043e + \u0433\u0430\u0434\u0438\u0442 \u0432 \u043b\u043e\u0433. \u042f \u0441\u0434\u0435\u043b\u0430\u043b \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0451\u043d\u043d\u044b\u0445 Path \u0432 Set, \u043d\u043e \u0437\u0430\u0431\u044b\u043b \u043f\u0443\u0448\u043d\u0443\u0442\u044c. \u0417\u0430\u0432\u0442\u0440\u0430 \u0434\u043e\u043a\u0438\u043d\u0443.", "author": "nixel2007", "createdAt": "2020-08-01T21:35:53Z", "path": "src/main/java/com/github/_1c_syntax/bsl/languageserver/configuration/watcher/ConfigurationFileSystemWatcher.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * This file is a part of BSL Language Server.\n+ *\n+ * Copyright \u00a9 2018-2020\n+ * Alexey Sosnoviy <labotamy@gmail.com>, Nikita Gryzlov <nixel2007@gmail.com> and contributors\n+ *\n+ * SPDX-License-Identifier: LGPL-3.0-or-later\n+ *\n+ * BSL Language Server is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3.0 of the License, or (at your option) any later version.\n+ *\n+ * BSL Language Server is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with BSL Language Server.\n+ */\n+package com.github._1c_syntax.bsl.languageserver.configuration.watcher;\n+\n+import com.github._1c_syntax.bsl.languageserver.configuration.LanguageServerConfiguration;\n+import com.github._1c_syntax.utils.Absolute;\n+import lombok.RequiredArgsConstructor;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+import javax.annotation.PostConstruct;\n+import javax.annotation.PreDestroy;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Path;\n+import java.nio.file.WatchEvent;\n+import java.nio.file.WatchKey;\n+import java.nio.file.WatchService;\n+\n+import static java.nio.file.StandardWatchEventKinds.ENTRY_CREATE;\n+import static java.nio.file.StandardWatchEventKinds.ENTRY_DELETE;\n+import static java.nio.file.StandardWatchEventKinds.ENTRY_MODIFY;\n+\n+@Component\n+@Slf4j\n+@RequiredArgsConstructor\n+public class ConfigurationFileSystemWatcher {\n+\n+  private final LanguageServerConfiguration configuration;\n+  private final ConfigurationFileChangeListener listener;\n+\n+  private WatchService watchService;\n+\n+  @PostConstruct\n+  public void init() throws IOException {\n+    watchService = FileSystems.getDefault().newWatchService();\n+    registerWatchService(configuration.getConfigurationFile());\n+  }\n+\n+  @PreDestroy\n+  public void onDestroy() throws IOException {\n+    watchService.close();\n+  }\n+\n+  @SneakyThrows\n+  @Scheduled(fixedDelay = 5000L)\n+  public void watch() {\n+    WatchKey key;\n+    // save last modified date to de-duplicate events\n+    long lastModified = 0L;\n+    while ((key = watchService.take()) != null) {\n+      for (WatchEvent<?> watchEvent : key.pollEvents()) {\n+        Path context = (Path) watchEvent.context();\n+        if (context == null) {\n+          continue;\n+        }\n+        File file = context.toFile();\n+        if (isConfigurationFile(file) && file.lastModified() != lastModified) {\n+          lastModified = file.lastModified();\n+          listener.onChange(file, watchEvent.kind());\n+        }\n+      }\n+\n+      key.reset();\n+    }\n+  }\n+\n+  @EventListener\n+  public void handleEvent(LanguageServerConfigurationFileChange event) {\n+    registerWatchService(event.getSource());\n+  }\n+\n+  @SneakyThrows\n+  private void registerWatchService(File configurationFile) {\n+    Path configurationDir = Absolute.path(configurationFile).getParent();", "originalCommit": "07c5130b9bb74d37364c66623c555452eaaf86c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13e5b187d0cbf1e634131c2904dffc7f172490a1", "url": "https://github.com/1c-syntax/bsl-language-server/commit/13e5b187d0cbf1e634131c2904dffc7f172490a1", "message": "\u041e\u043f\u0442\u0438\u043c\u0438\u0437\u0430\u0446\u0438\u044f \u0437\u0430\u0432\u0438\u0441\u0438\u043c\u043e\u0441\u0442\u0435\u0439, \u043f\u0435\u0440\u0435\u0445\u043e\u0434 \u043d\u0430 \u0441\u043f\u0440\u0438\u043d\u0433\u043e\u0432\u043e\u0435 \u043b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435", "committedDate": "2020-08-02T17:35:34Z", "type": "commit"}, {"oid": "37229c89c39ce303c08f6726cc1887722a41ae72", "url": "https://github.com/1c-syntax/bsl-language-server/commit/37229c89c39ce303c08f6726cc1887722a41ae72", "message": "\u041e\u0434\u043d\u043e\u0440\u0430\u0437\u043e\u0432\u0430\u044f \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f \u0441\u0435\u0440\u0432\u0438\u0441\u0430 \u0441\u043b\u0435\u0436\u0435\u043d\u0438\u044f", "committedDate": "2020-08-02T17:37:47Z", "type": "commit"}, {"oid": "f981c6ed7a0d73d59b4a45a882523bc713bb8112", "url": "https://github.com/1c-syntax/bsl-language-server/commit/f981c6ed7a0d73d59b4a45a882523bc713bb8112", "message": "\u0421\u043f\u0440\u0438\u043d\u0433\u043e\u0444\u0438\u043a\u0430\u0446\u0438\u044f \u0442\u0435\u0441\u0442\u043e\u0432", "committedDate": "2020-08-03T07:25:31Z", "type": "commit"}, {"oid": "c80d8168d345dc9b9cace9b330896cb12c876041", "url": "https://github.com/1c-syntax/bsl-language-server/commit/c80d8168d345dc9b9cace9b330896cb12c876041", "message": "\u0412\u044b\u0445\u043b\u043e\u043f \u043b\u043e\u0433\u0433\u0435\u0440\u0430 \u0442\u0435\u043f\u0435\u0440\u044c \u043e\u0436\u0438\u0434\u0430\u0435\u043c\u043e \u0432 stdout", "committedDate": "2020-08-03T07:31:55Z", "type": "commit"}, {"oid": "6824d8b94907cff03aad4cbcfbe4cef74a9d77d2", "url": "https://github.com/1c-syntax/bsl-language-server/commit/6824d8b94907cff03aad4cbcfbe4cef74a9d77d2", "message": "\u0421\u0442\u0430\u0431\u0438\u043b\u0438\u0437\u0430\u0446\u0438\u044f \u0440\u0430\u0431\u043e\u0442\u044b \u0432 \u043c\u043d\u043e\u0433\u043e\u043f\u043e\u0442\u043e\u0447\u043d\u043e\u0439 \u0441\u0440\u0435\u0434\u0435", "committedDate": "2020-08-03T10:01:46Z", "type": "commit"}, {"oid": "bc9b5533a7e2192fc58563270433ffa65442dac3", "url": "https://github.com/1c-syntax/bsl-language-server/commit/bc9b5533a7e2192fc58563270433ffa65442dac3", "message": "Javadoc", "committedDate": "2020-08-03T10:14:28Z", "type": "commit"}, {"oid": "3bd0124aaadca78aec955158c04a4166cf582f94", "url": "https://github.com/1c-syntax/bsl-language-server/commit/3bd0124aaadca78aec955158c04a4166cf582f94", "message": "\u0417\u0430\u0449\u0438\u0442\u043d\u0430\u044f \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043d\u0430 null", "committedDate": "2020-08-03T10:14:40Z", "type": "commit"}, {"oid": "4994fd9614c411040be8333e75c6573a14f67a0c", "url": "https://github.com/1c-syntax/bsl-language-server/commit/4994fd9614c411040be8333e75c6573a14f67a0c", "message": "\u0421\u0438\u043d\u0445\u0440\u043e\u043d\u0438\u0437\u0430\u0446\u0438\u044f \u043d\u0430 \u0432\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u0435\u043c \u043e\u0431\u044a\u0435\u043a\u0442\u0435\n\nsee https://projectlombok.org/features/Synchronized", "committedDate": "2020-08-03T10:59:25Z", "type": "commit"}, {"oid": "f5b8ef51f64d046cd107d3f6bff4dd9501442cca", "url": "https://github.com/1c-syntax/bsl-language-server/commit/f5b8ef51f64d046cd107d3f6bff4dd9501442cca", "message": "\u0418\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435 poll \u0432\u043c\u0435\u0441\u0442\u043e take\n\ntake \u043a\u0438\u0434\u0430\u0435\u0442 InterruptedException \u0432 \u0441\u043b\u0443\u0447\u0430\u0435 \u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0438\u044f \u0441\u043e\u0431\u044b\u0442\u0438\u0439 \u0432 \u043e\u0447\u0435\u0440\u0435\u0434\u0438. \u0412 \u0434\u0430\u043d\u043d\u043e\u043c \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442\u0435 exception-free poll() \u0432\u044b\u0433\u043b\u044f\u0434\u0438\u0442 \u043f\u0440\u0438\u044f\u0442\u043d\u0435\u0435.", "committedDate": "2020-08-03T11:19:00Z", "type": "commit"}, {"oid": "7c0b443dd3eed7d2dc7fde1aa0423fdf425ae2b2", "url": "https://github.com/1c-syntax/bsl-language-server/commit/7c0b443dd3eed7d2dc7fde1aa0423fdf425ae2b2", "message": "Fix QF", "committedDate": "2020-08-03T11:27:57Z", "type": "commit"}, {"oid": "99da3f5f3f872cb1545a87ba53af8653581cab05", "url": "https://github.com/1c-syntax/bsl-language-server/commit/99da3f5f3f872cb1545a87ba53af8653581cab05", "message": "\u041e\u0442\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u0432\u043e\u0442\u0447\u0435\u0440\u0430 \u043f\u0440\u0438 \u0441\u043c\u0435\u043d\u0435 \u043a\u0430\u0442\u0430\u043b\u043e\u0433\u0430 \u0438 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f \u043d\u043e\u0432\u043e\u0433\u043e.", "committedDate": "2020-08-03T15:54:00Z", "type": "commit"}, {"oid": "e7ece8930e28aae76fcf4874c60281905ac54a2d", "url": "https://github.com/1c-syntax/bsl-language-server/commit/e7ece8930e28aae76fcf4874c60281905ac54a2d", "message": "\u0412\u044b\u043d\u043e\u0441 \u0432\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u0448\u0435\u0434\u0443\u043b\u0435\u0440\u0430 \u0432 \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u0443\u044e \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044e", "committedDate": "2020-08-04T10:05:03Z", "type": "commit"}, {"oid": "5b09bb556644732054ea5886866987bf1e7e6211", "url": "https://github.com/1c-syntax/bsl-language-server/commit/5b09bb556644732054ea5886866987bf1e7e6211", "message": "\u0420\u0435\u0444\u0430\u043a\u0442\u043e\u0440\u0438\u043d\u0433 \u0438 \u0438\u0441\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043e\u0448\u0438\u0431\u043a\u0438 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u044f lastmodified", "committedDate": "2020-08-04T10:05:30Z", "type": "commit"}, {"oid": "df5acbaf31a9c374f8e70e024b3c44d0ad5e5bf3", "url": "https://github.com/1c-syntax/bsl-language-server/commit/df5acbaf31a9c374f8e70e024b3c44d0ad5e5bf3", "message": "Javadoc", "committedDate": "2020-08-04T10:09:01Z", "type": "commit"}, {"oid": "a78debc81c8debb43a2c64d95a9a060011b0679a", "url": "https://github.com/1c-syntax/bsl-language-server/commit/a78debc81c8debb43a2c64d95a9a060011b0679a", "message": "Merge branch 'develop' into feature/config-watch-v2", "committedDate": "2020-08-04T10:51:56Z", "type": "commit"}, {"oid": "c48a738eb96dc7e0a7e66a05105c61135df91842", "url": "https://github.com/1c-syntax/bsl-language-server/commit/c48a738eb96dc7e0a7e66a05105c61135df91842", "message": "\u0421\u0442\u0430\u0431\u0438\u043b\u0438\u0437\u0430\u0446\u0438\u044f \u0442\u0435\u0441\u0442\u043e\u0432", "committedDate": "2020-08-07T16:27:07Z", "type": "commit"}, {"oid": "b6897a67a3dadc7db83ad3808b0bd1747fe54bf3", "url": "https://github.com/1c-syntax/bsl-language-server/commit/b6897a67a3dadc7db83ad3808b0bd1747fe54bf3", "message": "\u041f\u043e\u043f\u044b\u0442\u043a\u0430 \u043e\u0436\u0438\u0434\u0430\u043d\u0438\u044f \u043e\u0442\u0432\u0435\u0442\u0430 \u043e\u0442 \u0444\u0430\u0439\u043b\u043e\u0432\u043e\u0439 \u0441\u0438\u0441\u0442\u0435\u043c\u044b", "committedDate": "2020-08-07T17:21:03Z", "type": "commit"}, {"oid": "bd71277c0dcd64a77b004a5253de98c3dca494e5", "url": "https://github.com/1c-syntax/bsl-language-server/commit/bd71277c0dcd64a77b004a5253de98c3dca494e5", "message": "\u0421\u0431\u0440\u0430\u0441\u044b\u0432\u0430\u0435\u043c \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442 \u043d\u0430 \u0432\u0441\u0435\u0445 \u0442\u0435\u0441\u0442\u0430\u0445 \u0434\u0438\u0430\u0433\u043d\u043e\u0441\u0442\u0438\u043a", "committedDate": "2020-08-07T17:56:31Z", "type": "commit"}, {"oid": "8e8dfe3b0e829e8ad18d817405e7bc53d8eb7710", "url": "https://github.com/1c-syntax/bsl-language-server/commit/8e8dfe3b0e829e8ad18d817405e7bc53d8eb7710", "message": "\u041e\u0447\u0438\u0441\u0442\u043a\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u043d\u043e\u0433\u043e \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442\u0430 \u0438 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438 \u0432\u043c\u0435\u0441\u0442\u043e \u043f\u043e\u043b\u043d\u043e\u0433\u043e \u0441\u0431\u0440\u043e\u0441\u0430 \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442\u0430\n\n\u0414\u043b\u044f \u0443\u0441\u043a\u043e\u0440\u0435\u043d\u0438\u044f \u0442\u0435\u0441\u0442\u043e\u0432", "committedDate": "2020-08-08T10:15:02Z", "type": "commit"}, {"oid": "ada2d49413923ffeb959908f2202764c1b19b8b9", "url": "https://github.com/1c-syntax/bsl-language-server/commit/ada2d49413923ffeb959908f2202764c1b19b8b9", "message": "\u041f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u043d\u0430\u0442\u0438\u0432\u043d\u043e\u0433\u043e watcher service \u0434\u043b\u044f mac os", "committedDate": "2020-08-08T10:16:02Z", "type": "commit"}, {"oid": "4bdecf7dbe7a5b6045ceaeadf693e97655efc3f9", "url": "https://github.com/1c-syntax/bsl-language-server/commit/4bdecf7dbe7a5b6045ceaeadf693e97655efc3f9", "message": "\u0417\u0430\u043c\u0435\u043d\u0430 Thread.sleep \u043d\u0430 awaitility", "committedDate": "2020-08-08T10:23:31Z", "type": "commit"}, {"oid": "9db87dfdb9f58d3459d63c952907fd2e81b562bc", "url": "https://github.com/1c-syntax/bsl-language-server/commit/9db87dfdb9f58d3459d63c952907fd2e81b562bc", "message": "Fix qf", "committedDate": "2020-08-08T10:24:36Z", "type": "commit"}, {"oid": "5b1babc9a2c61e86572e7107e75cf738be20e746", "url": "https://github.com/1c-syntax/bsl-language-server/commit/5b1babc9a2c61e86572e7107e75cf738be20e746", "message": "\u0420\u0430\u0431\u043e\u0442\u0430 \u0447\u0435\u0440\u0435\u0437 WatchablePath \u0438\u0437 \u0431\u0438\u0431\u043b\u0438\u043e\u0442\u0435\u043a\u0438", "committedDate": "2020-08-08T12:09:32Z", "type": "commit"}, {"oid": "3ecbad5ac5d5801b69d5ad50d14a15095792a2bb", "url": "https://github.com/1c-syntax/bsl-language-server/commit/3ecbad5ac5d5801b69d5ad50d14a15095792a2bb", "message": "\u0418\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435 SensitivityWatchEventModifier \u0432\u043c\u0435\u0441\u0442\u043e \u0431\u0438\u0431\u043b\u0438\u043e\u0442\u0435\u043a\u0438 \u0434\u043b\u044f \u043c\u0430\u043a\u0430", "committedDate": "2020-08-08T12:21:43Z", "type": "commit"}, {"oid": "6c88a83b9cf2420530b24da2b382b93f360a3887", "url": "https://github.com/1c-syntax/bsl-language-server/commit/6c88a83b9cf2420530b24da2b382b93f360a3887", "message": "\u0423\u0432\u0435\u043b\u0438\u0447\u0435\u043d\u0438\u0435 \u0442\u0430\u0439\u043c\u0435\u0440\u0430\n\n\u0427\u0442\u043e\u0431\u044b \u0443\u0441\u043f\u0435\u043b WatchService \u043d\u0430 macos", "committedDate": "2020-08-08T12:28:38Z", "type": "commit"}]}