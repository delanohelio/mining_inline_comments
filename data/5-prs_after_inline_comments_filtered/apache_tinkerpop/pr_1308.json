{"pr_number": 1308, "pr_title": "TINKERPOP-2389 Authorization support in TinkerPop", "pr_createdAt": "2020-08-06T13:28:11Z", "pr_url": "https://github.com/apache/tinkerpop/pull/1308", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYzNjA2MA==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r512636060", "bodyText": "I think you can safely put 3.5.0 as the version.", "author": "spmallette", "createdAt": "2020-10-27T12:03:09Z", "path": "gremlin-server/src/main/java/org/apache/tinkerpop/gremlin/server/Settings.java", "diffHunk": "@@ -418,7 +426,10 @@ public SerializerSettings() {}\n \n         /**\n          * Enable audit logging of authenticated users and gremlin evaluation requests.\n+         * @deprecated As of release x.y.z, replaced by {@link Settings#enableAuditLog} with slight changes in the", "originalCommit": "709f812af2046f5bf45f99155405d3fa7ccedd4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0MDI2Nw==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r512640267", "bodyText": "I haven't thought this through at all but is it desirable that we would double-log here if the user has somehow used both settings (the new and deprecated one as true)? I see this sort of code in the AbstractEvalOpProcessor as well. Perhaps setting both to true should be considered an \"illegal\" configuration or the setting of the new one to true should override the old to false? Perhaps, setting the old to true and the new to false should result in a WARN to the logger to let them know they are using a deprecated settings?", "author": "spmallette", "createdAt": "2020-10-27T12:10:05Z", "path": "gremlin-server/src/main/java/org/apache/tinkerpop/gremlin/server/handler/HttpGremlinEndpointHandler.java", "diffHunk": "@@ -189,6 +191,12 @@ public void channelRead(final ChannelHandlerContext ctx, final Object msg) {\n             try {\n                 logger.debug(\"Processing request containing script [{}] and bindings of [{}] on {}\",\n                         requestArguments.getValue0(), requestArguments.getValue1(), Thread.currentThread().getName());\n+                if (settings.enableAuditLog) {", "originalCommit": "709f812af2046f5bf45f99155405d3fa7ccedd4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ2NjAyNA==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r513466024", "bodyText": "Agreed. I thought about this, but this check ends up in the gremlin server startup code, which I had not touched yet... Good to see that you are not afraid to touch your own code!", "author": "vtslab", "createdAt": "2020-10-28T14:00:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0MDI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQwNzA0Nw==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r523407047", "bodyText": "Settings.java now logs an appropriate warning.", "author": "vtslab", "createdAt": "2020-11-14T11:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0MDI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0MDg2OQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r512640869", "bodyText": "nit: looks like your IDE is making a mockery of our code style by doing a wildcard import \ud83d\ude04", "author": "spmallette", "createdAt": "2020-10-27T12:11:09Z", "path": "gremlin-core/src/main/java/org/apache/tinkerpop/gremlin/process/traversal/util/BytecodeUtil.java", "diffHunk": "@@ -18,9 +18,12 @@\n  */\n package org.apache.tinkerpop.gremlin.process.traversal.util;\n \n-import org.apache.tinkerpop.gremlin.process.traversal.Bytecode;\n-import org.apache.tinkerpop.gremlin.process.traversal.TraversalSource;\n-import org.apache.tinkerpop.gremlin.process.traversal.TraversalStrategy;\n+import org.apache.tinkerpop.gremlin.jsr223.JavaTranslator;\n+import org.apache.tinkerpop.gremlin.process.traversal.*;", "originalCommit": "709f812af2046f5bf45f99155405d3fa7ccedd4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1MTUxMg==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r512651512", "bodyText": "I sense that we will do more with Bytecode analysis so this class will grow in functionality. Perhaps this PR is not the time to think it all through, but I'd offer that I think that we would want to avoid doing a Translator operation here and try to work on pure bytecode when doing these sorts of operations. I see the main use for this method in this PR is to detect lambdas. If that is the case, then I would instead write a hasLambda() function here and have it simply dig through the bytecode to look for Lambda objects.", "author": "spmallette", "createdAt": "2020-10-27T12:29:19Z", "path": "gremlin-core/src/main/java/org/apache/tinkerpop/gremlin/process/traversal/util/BytecodeUtil.java", "diffHunk": "@@ -43,4 +47,16 @@ private BytecodeUtil() {}\n                         s -> s.getOperator().equals(TraversalSource.Symbols.withStrategies) && clazz.isAssignableFrom(s.getArguments()[0].getClass())),\n                 os -> (A) os.getArguments()[0]);\n     }\n+\n+    /**\n+     * Parses {@link Bytecode} to find {@link Step} objects in the step instructions.\n+     * @return\n+     */\n+    public static Iterator<Step> findSteps(final Bytecode bytecode, final Class<?> clazz) {", "originalCommit": "709f812af2046f5bf45f99155405d3fa7ccedd4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ3MTg2MQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r513471861", "bodyText": "OK, I will do that. Note that the bytecode analysis of lambdas depends on magic strings that will come from the JavaTranslator anyway. So, this implies moving the magic strings to ByteUtil and also touching JavaTranslator (for the better!)", "author": "vtslab", "createdAt": "2020-10-28T14:07:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1MTUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUwODQ1OA==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r513508458", "bodyText": "Note that the bytecode analysis of lambdas depends on magic strings\n\nI'm not sure what you mean by that. I would expect the Bytecode object to contain an actual org.apache.tinkerpop.gremlin.util.function.Lambda object within it. You just need to detect that, no?", "author": "spmallette", "createdAt": "2020-10-28T14:51:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1MTUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYwNzE5MQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r515607191", "bodyText": "That was an excellent pointer and brought me to BytecodeHelper.getLambdaLanguage(bytecode).isPresent(). This means that I will not touch the BytecodeUtil code any more.\nYou may want to merge the BytecodeUtil and  BytecodeHelper classes in a separate PR, so that you can properly deprecate one in 3.4.x and get things right for 3.5.0 (assuming there is no valid reason for these classes to both exist). In a large codebase it is easy to overlook the other if you arrive at one via your IDE goTo.\n[Edited] I created the issue below because I also ran into minor issues regarding BytecodeHelper:\nhttps://issues.apache.org/jira/browse/TINKERPOP-2462", "author": "vtslab", "createdAt": "2020-11-01T11:01:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1MTUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkzNDYxOQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r515934619", "bodyText": "yeah - thanks for pointing that out. i shouldnt have added BytecodeUtil....", "author": "spmallette", "createdAt": "2020-11-02T12:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1MTUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA4NjY5NA==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r520086694", "bodyText": "I've implemented TINKERPOP-2462 on 7325846 - going to remove BytecodeUtil completely in master", "author": "spmallette", "createdAt": "2020-11-09T20:04:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1MTUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA5OTAyMg==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r520099022", "bodyText": "Removed here: 6e47f53 - when you rebase it will be gone.", "author": "spmallette", "createdAt": "2020-11-09T20:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1MTUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDMyNjY5NQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r520326695", "bodyText": "Great! Over here, documentation is becoming completer.", "author": "vtslab", "createdAt": "2020-11-10T06:42:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1MTUxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1NTk3Mw==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r512655973", "bodyText": "setup() for authentication and configure() for authorization - could we simply unify these and go with setup() for both? As long as the two methods have the same name/signature then it should look like one method from an inheritance perspective, no?", "author": "spmallette", "createdAt": "2020-10-27T12:36:56Z", "path": "gremlin-server/src/main/java/org/apache/tinkerpop/gremlin/server/AbstractChannelizer.java", "diffHunk": "@@ -200,6 +211,35 @@ private Authenticator createAuthenticator(final Settings.AuthenticationSettings\n         }\n     }\n \n+    private Authorizer createAuthorizer(final Settings.AuthorizationSettings config) {\n+        final String authorizerClass = config.authorizer;\n+        if (null == authorizerClass) {\n+            return null;\n+        }\n+        try {\n+            final Class<?> clazz = Class.forName(authorizerClass);\n+            final Authorizer authorizer = (Authorizer) clazz.newInstance();\n+            authorizer.configure(config.config);\n+            return authorizer;\n+        } catch (Exception ex) {\n+            logger.warn(ex.getMessage());\n+            throw new IllegalStateException(String.format(\"Could not create/configure Authorizer %s\", authorizer), ex);\n+        }\n+    }\n+\n+    private AuthenticatorAuthorizer createAuthenticatorAuthorizer(final Settings settings) {\n+        try {\n+            final Class<?> clazz = Class.forName(settings.authentication.authenticator);\n+            final AuthenticatorAuthorizer authenticatorAuthorizer = (AuthenticatorAuthorizer) clazz.newInstance();\n+            authenticatorAuthorizer.setup(settings.authentication.config);\n+            authenticatorAuthorizer.configure(settings.authorization.config);", "originalCommit": "709f812af2046f5bf45f99155405d3fa7ccedd4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ3ODI4MQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r513478281", "bodyText": "This refers to my earlier question (that you possibly overlooked) whether we should have this AuthenticatorAuthorizer interface anyway. Only reason for its existence is for the Authorizer to have easy access to any user details not present in the AuthenticatedUser (QwentB's request). The user or provide could realize this in an alternative way by building or wrapping an Authenticator implementation into a singleton.\nAgreed, that the setup/configure thing is too ugly too keep, but is also ugly to not give the AuthentionSetting and AuthorizationSetting their own config map. Not relevant if we do away with the AuthenticatorAuthorizer.", "author": "vtslab", "createdAt": "2020-10-28T14:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1NTk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUxNjU4NA==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r513516584", "bodyText": "I'm +0 with the AuthenticatorAuthorizer - whatever you decide on that is fine by me. I'm more concerned in just naming those methods the same thing.  I probably shouldn't have written that the methods should have the same signature I guess...just the same name. I guess we would go with setup() which is somewhat at odds with all our other things which use configure() but meh...it's fine", "author": "spmallette", "createdAt": "2020-10-28T15:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1NTk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2MjY2Mw==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r512662663", "bodyText": "Under what circumstance does it happen that we get a OPS_BYTECODE but its value remains a GraphSON 2.0 string that needs to be deserialized? if so, i would think we would want to figure out how to not let that happen and keep deserialization details out of the Authorizer?", "author": "spmallette", "createdAt": "2020-10-27T12:47:56Z", "path": "gremlin-server/src/main/java/org/apache/tinkerpop/gremlin/server/authz/AbstractAuthorizer.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.tinkerpop.gremlin.server.authz;\n+\n+import org.apache.tinkerpop.gremlin.driver.Tokens;\n+import org.apache.tinkerpop.gremlin.driver.message.RequestMessage;\n+import org.apache.tinkerpop.gremlin.process.computer.traversal.strategy.decoration.VertexProgramStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.Bytecode;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.LambdaHolder;\n+import org.apache.tinkerpop.gremlin.process.traversal.util.BytecodeUtil;\n+import org.apache.tinkerpop.gremlin.server.auth.AuthenticatedUser;\n+import org.apache.tinkerpop.gremlin.structure.io.graphson.GraphSONMapper;\n+import org.apache.tinkerpop.gremlin.structure.io.graphson.GraphSONVersion;\n+import org.apache.tinkerpop.shaded.jackson.databind.ObjectMapper;\n+\n+import java.io.IOException;\n+\n+\n+/**\n+ * Provides utilities for implementing the {@link Authorizer} interface.\n+ *\n+ * @author Marc de Lignie\n+ */\n+public abstract class AbstractAuthorizer implements Authorizer{\n+    private static final ObjectMapper mapper = GraphSONMapper.build().version(GraphSONVersion.V2_0).create().createMapper();\n+\n+    /**\n+     * Authorizes a user for a request.\n+     *\n+     * @param user {@link AuthenticatedUser} to be used for the authorization\n+     * @param msg RequestMessage to authorize the user for\n+     */\n+    public void authorize(final AuthenticatedUser user, final RequestMessage msg) throws AuthorizationException {\n+        switch (msg.getOp()) {\n+            case Tokens.OPS_EVAL:\n+                final String script = (String) msg.getArgs().get(Tokens.ARGS_GREMLIN);\n+                authorizeString(user, script, msg);\n+                break;\n+            case Tokens.OPS_BYTECODE:\n+                final Bytecode bytecode;\n+                try {\n+                    final Object bytecodeObj = msg.getArgs().get(Tokens.ARGS_GREMLIN);\n+                    bytecode = bytecodeObj instanceof Bytecode ? (Bytecode) bytecodeObj :\n+                            mapper.readValue(bytecodeObj.toString(), Bytecode.class);", "originalCommit": "709f812af2046f5bf45f99155405d3fa7ccedd4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ3ODg3Mw==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r513478873", "bodyText": "I will look into this, probably an oversight or some old test configs.", "author": "vtslab", "createdAt": "2020-10-28T14:16:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2MjY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2OTA4MQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r512669081", "bodyText": "nice. looks like this body of work will also close:\nhttps://issues.apache.org/jira/browse/TINKERPOP-2418\nWe will need to remember to close that issue too when this merges", "author": "spmallette", "createdAt": "2020-10-27T12:57:41Z", "path": "gremlin-server/src/main/java/org/apache/tinkerpop/gremlin/server/handler/StateKey.java", "diffHunk": "@@ -57,4 +58,9 @@ private StateKey() {}\n      * The key for the current request.\n      */\n     public static final AttributeKey<RequestMessage> REQUEST_MESSAGE = AttributeKey.valueOf(\"request\");\n+\n+    /**\n+     * The key for the current {@link AuthenticatedUser}.\n+     */\n+    public static final AttributeKey<AuthenticatedUser> AUTHENTICATED_USER = AttributeKey.valueOf(\"authenticatedUser\");", "originalCommit": "709f812af2046f5bf45f99155405d3fa7ccedd4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQwNzIyOQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r523407229", "bodyText": "There is a warning in the changelog you cannot miss before the release.", "author": "vtslab", "createdAt": "2020-11-14T11:02:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2OTA4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY3NzM3Mw==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r512677373", "bodyText": "i suppose the addition of the marko user was the change here:\nhttps://github.com/apache/tinkerpop/pull/1308/files#diff-a73da218a425ffa2b99f8c287c3ff3477426bb72748d0c21894d5067485b12a8R47\njust a new user...is that right? perhaps now would be a smart time to add a README.md to gremlin-server/data to remind us what the contents of those files are. i'm not even sure what gremlin-server/data/sample.kryo contains anymore.", "author": "spmallette", "createdAt": "2020-10-27T13:10:27Z", "path": "gremlin-server/src/test/java/org/apache/tinkerpop/gremlin/server/GremlinServerAuthIntegrateTest.java", "diffHunk": "@@ -56,7 +56,7 @@ public Settings overrideSettings(final Settings settings) {\n         final Settings.AuthenticationSettings authSettings = new Settings.AuthenticationSettings();\n         authSettings.authenticator = SimpleAuthenticator.class.getName();\n \n-        // use a credentials graph with one user in it: stephen/password\n+        // use a credentials graph with two users in it: stephen/password and marko/rainbow-dash", "originalCommit": "709f812af2046f5bf45f99155405d3fa7ccedd4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUwNDc0Mg==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r513504742", "bodyText": "Yes, I picked this user from the credentials-dsl example from the ref docs...\nI better leave this to you, because this also relates to preparing the console and server distributions.", "author": "vtslab", "createdAt": "2020-10-28T14:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY3NzM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3OTcwNg==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r519879706", "bodyText": "I've added the README to master - aea5d9a\nWhen you rebase you can just modify what I wrote for your purposes.", "author": "spmallette", "createdAt": "2020-11-09T15:02:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY3NzM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5MDIyMQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r519890221", "bodyText": "Thanks, will do that.", "author": "vtslab", "createdAt": "2020-11-09T15:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY3NzM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQwNzQwNA==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r523407404", "bodyText": "Done", "author": "vtslab", "createdAt": "2020-11-14T11:05:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY3NzM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY3ODg2OA==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r512678868", "bodyText": "I know this is just for testing but could you please change the naming (to this class and related ones) to AllowList?", "author": "spmallette", "createdAt": "2020-10-27T13:12:42Z", "path": "gremlin-server/src/test/java/org/apache/tinkerpop/gremlin/server/authz/Whitelist.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.tinkerpop.gremlin.server.authz;\n+\n+import org.yaml.snakeyaml.TypeDescription;\n+import org.yaml.snakeyaml.Yaml;\n+import org.yaml.snakeyaml.constructor.Constructor;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+\n+/**\n+ * Whitelist for the WhitelistAuthorizer as configured by a YAML file.\n+ *\n+ * @author Marc de Lignie\n+ */\n+public class Whitelist {", "originalCommit": "709f812af2046f5bf45f99155405d3fa7ccedd4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUwNDk2Nw==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r513504967", "bodyText": "Sure!", "author": "vtslab", "createdAt": "2020-10-28T14:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY3ODg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY4MDgwMQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r512680801", "bodyText": "This is a fairly advanced implementation for testing. It should provide a nice example for folks to learn from. would it be good to write user docs around this example and then snippet this code explicitly in the reference documentation?", "author": "spmallette", "createdAt": "2020-10-27T13:15:27Z", "path": "gremlin-server/src/test/java/org/apache/tinkerpop/gremlin/server/authz/WhitelistAuthorizer.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.tinkerpop.gremlin.server.authz;\n+\n+import org.apache.tinkerpop.gremlin.driver.Tokens;\n+import org.apache.tinkerpop.gremlin.driver.message.RequestMessage;\n+import org.apache.tinkerpop.gremlin.process.traversal.Bytecode;\n+import org.apache.tinkerpop.gremlin.process.traversal.TraversalSource;\n+import org.apache.tinkerpop.gremlin.server.Settings.AuthenticationSettings;\n+import org.apache.tinkerpop.gremlin.server.auth.AuthenticatedUser;\n+import org.apache.tinkerpop.gremlin.server.auth.Authenticator;\n+import org.apache.tinkerpop.gremlin.server.auth.SimpleAuthenticator;\n+\n+import java.util.*;\n+\n+\n+/**\n+ * Authorizes a user per request, based on a whitelist that grants access to {@link TraversalSource} instances for\n+ * bytecode requests and to gremlin server's sandbox for string requests and lambdas. The {@link\n+ * AuthenticationSettings}.config must have an authorizationWhitelist entry that contains the filename of the whitelist.\n+ * This authorizer is for demonstration purposes only. It does not scale well in the number of users regarding\n+ * memory usage and administrative burden.\n+ *\n+ * @author Marc de Lignie\n+ */\n+public class WhitelistAuthorizer extends AbstractAuthorizer {", "originalCommit": "709f812af2046f5bf45f99155405d3fa7ccedd4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUwNTUwNQ==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r513505505", "bodyText": "Fine to me: explain by example!", "author": "vtslab", "createdAt": "2020-10-28T14:48:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY4MDgwMQ=="}], "type": "inlineReview"}, {"oid": "bc99bf01216eb24351435a5334ea4d10944db89c", "url": "https://github.com/apache/tinkerpop/commit/bc99bf01216eb24351435a5334ea4d10944db89c", "message": "Adds the squashed work on the authorization feature until 2020-11-09\n\n  - Adds an AuthorizationHandler, an unfinished WhitelistAuthorizer and tests\n\n  - Adds Whitelist implementation and tests\n\n  - Extends WhitelistAuthorizer - abandoned first version\n\n  - Improves WhitelistAuthorizer: second version\n\n  - Adds WhiteList integration test for EVAL over websockets\n\n  - Extends Whitelist integration test with bytecode request over websockets\n\n  - Extends/improves whitelist integration tests\n\n  - Moves whitelist authorization to the gremlin server tests\n\n  - Simplifies and improves the WhiteListAuthorizer\n\n  - Embellishes the authorizer classes\n\n  - Adapts lambda and OLAP detection for authorization and naming of authz tests\n\n  - Addresses comments from the initial review and adds documentation.\n\n  - Extends provider documentation and resets AuthenticatedUser\n\n  - Extends audit logging\n\n  - Simplifies Authorizer API\n\n  - Adds AuthenticatorAuthorizer\n\n  - Addresses code issues from oct2020 review\n\n  - Addresses QwentB requirement for manipulating the RequestMessage\n\n  - Adds reference documentation for authorization", "committedDate": "2020-11-13T15:42:10Z", "type": "commit"}, {"oid": "221dc340eb5147138f89a3bd60875daf7f588777", "url": "https://github.com/apache/tinkerpop/commit/221dc340eb5147138f89a3bd60875daf7f588777", "message": "Fixes the issues caused and discovered due to rebasing", "committedDate": "2020-11-14T10:14:20Z", "type": "commit"}, {"oid": "221dc340eb5147138f89a3bd60875daf7f588777", "url": "https://github.com/apache/tinkerpop/commit/221dc340eb5147138f89a3bd60875daf7f588777", "message": "Fixes the issues caused and discovered due to rebasing", "committedDate": "2020-11-14T10:14:20Z", "type": "forcePushed"}, {"oid": "5a25f015fff4ab8f89b458fdb96856b20201281c", "url": "https://github.com/apache/tinkerpop/commit/5a25f015fff4ab8f89b458fdb96856b20201281c", "message": "Fixes minor oversights", "committedDate": "2020-11-14T11:08:25Z", "type": "commit"}, {"oid": "f92e764eb091802fa4d1fd355ccbde804bd37879", "url": "https://github.com/apache/tinkerpop/commit/f92e764eb091802fa4d1fd355ccbde804bd37879", "message": "Fixes issue with and adds test for authorization with http transport\n\nFixes issue with and adds test for authorization with http transport", "committedDate": "2020-11-20T08:28:40Z", "type": "commit"}, {"oid": "ea40044125793f9c03d71cded3f347563644479e", "url": "https://github.com/apache/tinkerpop/commit/ea40044125793f9c03d71cded3f347563644479e", "message": "Fixes audit logging for unauthorized http request", "committedDate": "2020-11-20T10:42:24Z", "type": "commit"}, {"oid": "779430beddfc5580285009ff1b032738628b01c7", "url": "https://github.com/apache/tinkerpop/commit/779430beddfc5580285009ff1b032738628b01c7", "message": "Adds code and test for VertexProgramDenyStrategy", "committedDate": "2020-11-20T14:40:21Z", "type": "commit"}, {"oid": "d41ede25ff3a4cea751155db423c071ae8d4351d", "url": "https://github.com/apache/tinkerpop/commit/d41ede25ff3a4cea751155db423c071ae8d4351d", "message": "Adds documentation on the application of TraversalStrategy instances", "committedDate": "2020-11-22T09:53:25Z", "type": "commit"}, {"oid": "d9140c2240d0d366e1b445d607e00363c9bc5565", "url": "https://github.com/apache/tinkerpop/commit/d9140c2240d0d366e1b445d607e00363c9bc5565", "message": "Refactors the Authorizer interface and all classes associated with it", "committedDate": "2020-11-27T09:16:24Z", "type": "commit"}, {"oid": "786207f24f2239db34e3fdff11c0fd61ce60ea83", "url": "https://github.com/apache/tinkerpop/commit/786207f24f2239db34e3fdff11c0fd61ce60ea83", "message": "Adds true-false-true test to GremlinServerAuthzIntegrateTest", "committedDate": "2020-11-29T09:53:31Z", "type": "commit"}, {"oid": "f4d7bb486de94404d52cbcd7e1f767c350332e7c", "url": "https://github.com/apache/tinkerpop/commit/f4d7bb486de94404d52cbcd7e1f767c350332e7c", "message": "Fixes issues regarding Authorizer usage with AlowAllAuthenticator", "committedDate": "2020-12-04T09:26:40Z", "type": "commit"}, {"oid": "2f95b1bb0424049a324ea321538972992e9c10e0", "url": "https://github.com/apache/tinkerpop/commit/2f95b1bb0424049a324ea321538972992e9c10e0", "message": "Extends AllowListAuthorizer with checks on mutations and SubgraphStrategy alterations", "committedDate": "2020-12-05T10:57:29Z", "type": "commit"}, {"oid": "41e2257378f53e5ae99d3b286b9a18a4c1f6fcf4", "url": "https://github.com/apache/tinkerpop/commit/41e2257378f53e5ae99d3b286b9a18a4c1f6fcf4", "message": "Does some more refinement on the AllowListAuthorizer and related documentation", "committedDate": "2020-12-05T14:33:29Z", "type": "commit"}, {"oid": "39db2b60da01125a2049a7e8a38a133e38cbcd57", "url": "https://github.com/apache/tinkerpop/commit/39db2b60da01125a2049a7e8a38a133e38cbcd57", "message": "Adds sessioned string requests to GremlinServerAuthzIntegrateTest", "committedDate": "2020-12-05T16:14:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ5OTkyMw==", "url": "https://github.com/apache/tinkerpop/pull/1308#discussion_r539499923", "bodyText": "As they are all static methods I think you could refactor to create a small final utility class to house them - HttpUtil or something like that?", "author": "spmallette", "createdAt": "2020-12-09T17:25:14Z", "path": "gremlin-server/src/main/java/org/apache/tinkerpop/gremlin/server/handler/HttpBasicAuthorizationHandler.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.tinkerpop.gremlin.server.handler;\n+\n+import io.netty.channel.ChannelFutureListener;\n+import io.netty.channel.ChannelHandler;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelInboundHandlerAdapter;\n+import io.netty.handler.codec.http.DefaultFullHttpResponse;\n+import io.netty.handler.codec.http.FullHttpMessage;\n+import io.netty.handler.codec.http.FullHttpRequest;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.netty.util.ReferenceCountUtil;\n+import org.apache.tinkerpop.gremlin.driver.Tokens;\n+import org.apache.tinkerpop.gremlin.driver.message.RequestMessage;\n+import org.apache.tinkerpop.gremlin.server.GremlinServer;\n+import org.apache.tinkerpop.gremlin.server.auth.AuthenticatedUser;\n+import org.apache.tinkerpop.gremlin.server.authz.AuthorizationException;\n+import org.apache.tinkerpop.gremlin.server.authz.Authorizer;\n+import org.javatuples.Quartet;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Map;\n+\n+import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;\n+import static io.netty.handler.codec.http.HttpResponseStatus.INTERNAL_SERVER_ERROR;\n+import static io.netty.handler.codec.http.HttpResponseStatus.UNAUTHORIZED;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+\n+\n+/**\n+ *  An authorization handler for the http channel that allows the {@link Authorizer} to be plugged into it.\n+ *\n+ * @author Marc de Lignie\n+ */\n+@ChannelHandler.Sharable\n+public class HttpBasicAuthorizationHandler extends ChannelInboundHandlerAdapter {\n+    private static final Logger logger = LoggerFactory.getLogger(HttpBasicAuthorizationHandler.class);\n+    private static final Logger auditLogger = LoggerFactory.getLogger(GremlinServer.AUDIT_LOGGER_NAME);\n+\n+    private AuthenticatedUser user;\n+    private final Authorizer authorizer;\n+\n+    public HttpBasicAuthorizationHandler(Authorizer authorizer) {\n+        this.authorizer = authorizer;\n+    }\n+\n+    @Override\n+    public void channelRead(final ChannelHandlerContext ctx, final Object msg) {\n+        if (msg instanceof FullHttpMessage){\n+            final FullHttpMessage request = (FullHttpMessage) msg;\n+            try {\n+                user = ctx.channel().attr(StateKey.AUTHENTICATED_USER).get();\n+                if (null == user) {    // This is expected when using the AllowAllAuthenticator\n+                    user = AuthenticatedUser.ANONYMOUS_USER;\n+                }\n+                // ToDo: move getRequestArguments to a new preceding pipeline step in the Channelizer, but @Stephen,\n+                //       how about the sendAndCleanupConnection logic in HttpGremlinEndpointHandler?", "originalCommit": "39db2b60da01125a2049a7e8a38a133e38cbcd57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "26d916fe21e8baedcd51e6fbc9dd865583e13d87", "url": "https://github.com/apache/tinkerpop/commit/26d916fe21e8baedcd51e6fbc9dd865583e13d87", "message": "Makes HttpBasicAuthorizationHandler consistent with HttpGremlinEndpointhandler", "committedDate": "2020-12-18T09:59:22Z", "type": "commit"}, {"oid": "f2c578dbc90d712fc4a882c79e3fe5c75273f063", "url": "https://github.com/apache/tinkerpop/commit/f2c578dbc90d712fc4a882c79e3fe5c75273f063", "message": "Corrects https://tinkerpop.apache.org/docs/current/ref* links in the asciidoc as requested in review", "committedDate": "2020-12-18T10:22:04Z", "type": "commit"}, {"oid": "d5317d38083e18c9ff7b96062a80c339fd7ecc9f", "url": "https://github.com/apache/tinkerpop/commit/d5317d38083e18c9ff7b96062a80c339fd7ecc9f", "message": "Reconstructs incomplete paragraph in new doc section", "committedDate": "2020-12-23T15:34:41Z", "type": "commit"}]}