{"pr_number": 1289, "pr_title": "TINKERPOP-2374 fix missing authorization with SaslAndHttpBasicAuthenticationHandler", "pr_createdAt": "2020-05-26T21:09:28Z", "pr_url": "https://github.com/apache/tinkerpop/pull/1289", "timeline": [{"oid": "ac68fd154987f135c83bb6110a95181061f2c296", "url": "https://github.com/apache/tinkerpop/commit/ac68fd154987f135c83bb6110a95181061f2c296", "message": "TINKERPOP-2374 fix missing authorization with SaslAndHttpBasicAuthenticationHandler", "committedDate": "2020-05-26T21:08:13Z", "type": "commit"}, {"oid": "f01ad830bb5eb2f190240d0648e54a4c7ccdfd5d", "url": "https://github.com/apache/tinkerpop/commit/f01ad830bb5eb2f190240d0648e54a4c7ccdfd5d", "message": "add address to credentials for HttpBasicAuthenticationHandler", "committedDate": "2020-05-26T21:13:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyODg1OQ==", "url": "https://github.com/apache/tinkerpop/pull/1289#discussion_r432228859", "bodyText": "This code change doesn't really solve the root cause and doesn't explain why are having random pipeline behaviour.\nHere's my theory:\nWhen keep alive is turned on, multiple HTTP requests use the same pipeline. This causes a race condition where multiple requests are trying to modify the pipeline dynamically in channelRead method of WsAndHttpChannelizerHandler. While one message is dynamically modifying the pipeline, let's say executing line 68 (removing the PIPELINE_AUTHENTICATOR), another message might come in and execute line 65 and erroneously jumped to line 71. This causes the unpredictable behaviour you are observing.\nThe correct fix would be to ensure that the above dynamic modification of pipeline is only done once per connection instead of modifying it with every message.\nIMO we should not push this workaround without fixing the underlying root cause. WDYT @spmallette ?", "author": "divijvaidya", "createdAt": "2020-05-29T02:53:31Z", "path": "gremlin-server/src/main/java/org/apache/tinkerpop/gremlin/server/handler/SaslAndHttpBasicAuthenticationHandler.java", "diffHunk": "@@ -47,9 +47,11 @@ public SaslAndHttpBasicAuthenticationHandler(final Authenticator authenticator,\n     @Override\n     public void channelRead(final ChannelHandlerContext ctx, final Object obj) throws Exception {\n         if (obj instanceof HttpMessage && !WebSocketHandlerUtil.isWebSocket((HttpMessage)obj)) {\n-            if (null == ctx.pipeline().get(HTTP_AUTH)) {\n-                ctx.pipeline().addAfter(PIPELINE_AUTHENTICATOR, HTTP_AUTH, new HttpBasicAuthenticationHandler(authenticator, this.authenticationSettings));\n+            ChannelPipeline pipeline = ctx.pipeline();\n+            if (null != pipeline.get(HTTP_AUTH)) {\n+                pipeline.remove(HTTP_AUTH);\n             }", "originalCommit": "f01ad830bb5eb2f190240d0648e54a4c7ccdfd5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQzMjkzMQ==", "url": "https://github.com/apache/tinkerpop/pull/1289#discussion_r432432931", "bodyText": "I'm fine with not merging a workaround. i trust your judgement with the Java driver - if you'd prefer a root cause fix, then let's shoot for that.\n@javeme do you have any thoughts on the theory that @divijvaidya proposed?", "author": "spmallette", "createdAt": "2020-05-29T11:52:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyODg1OQ=="}], "type": "inlineReview"}, {"oid": "2352d7335652d1e8ad3310b78c010b0d5cd37892", "url": "https://github.com/apache/tinkerpop/commit/2352d7335652d1e8ad3310b78c010b0d5cd37892", "message": "add test for pipeline with SaslAndHttpBasicAuthenticationHandler", "committedDate": "2020-06-02T13:04:09Z", "type": "commit"}, {"oid": "2352d7335652d1e8ad3310b78c010b0d5cd37892", "url": "https://github.com/apache/tinkerpop/commit/2352d7335652d1e8ad3310b78c010b0d5cd37892", "message": "add test for pipeline with SaslAndHttpBasicAuthenticationHandler", "committedDate": "2020-06-02T13:04:09Z", "type": "forcePushed"}]}