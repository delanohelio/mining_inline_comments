{"pr_number": 2353, "pr_title": "MP Testing", "pr_createdAt": "2020-09-13T16:28:00Z", "pr_url": "https://github.com/oracle/helidon/pull/2353", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NDEwMQ==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r487894101", "bodyText": "Would be nice to add something like boolean dirtiesContext() default false; if we want fresh container for every test", "author": "danielkec", "createdAt": "2020-09-14T13:02:30Z", "path": "microprofile/tests/junit5/src/main/java/io/helidon/microprofile/tests/junit5/HelidonTest.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.microprofile.tests.junit5;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+/**\n+ * An annotation making this test class a CDI bean with support for injection.\n+ * <p>\n+ * There is no need to provide {@code beans.xml} (actually it is not recommended, as it would combine beans\n+ * from all tests), instead use {@link io.helidon.microprofile.tests.junit5.AddBean},\n+ * {@link io.helidon.microprofile.tests.junit5.AddExtension}, and {@link io.helidon.microprofile.tests.junit5.AddConfig}\n+ * annotations to control the shape of the container.\n+ */\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target(ElementType.TYPE)\n+@ExtendWith(HelidonJunitExtension.class)\n+public @interface HelidonTest {\n+    /**\n+     * Whether discovery is automated or disabled.\n+     * <p>\n+     * When discovery is enabled, the whole classpath is scanned for bean archives (jar files containing\n+     * {@code META-INF/beans.xml}) and all beans and extensions are added automatically.\n+     * <p>\n+     * When discovery is disabled, CDI would only contain the CDI implementation itself and beans and extensions added\n+     * through annotations {@link io.helidon.microprofile.tests.junit5.AddBean} and\n+     * {@link io.helidon.microprofile.tests.junit5.AddExtension}\n+     *\n+     * @return whether to do discovery, defaults to {@code true}\n+     */\n+    boolean discovery() default true;", "originalCommit": "6e526b28f95e75ccb831a44eac43b4b4a67ec7c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk4NDE0OQ==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r487984149", "bodyText": "Related question, how do JUnit extensions work if TestA runs before TestB and sets config, extensions and beans. Can TestB run with a fresh environment?", "author": "spericas", "createdAt": "2020-09-14T14:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzNTM5Nw==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r488035397", "bodyText": "Can be done by injecting beans to the test methods params instead", "author": "danielkec", "createdAt": "2020-09-14T15:43:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2MjY4NQ==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r488162685", "bodyText": "That is quite expensive and complicated. Considering the test class itself is supposed to be a CDI bean, shutting the container and starting it again between tests would be unexpected (as you would need to run the next test method on a different instance of the bean)", "author": "tomas-langer", "createdAt": "2020-09-14T19:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MzI1NA==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r488853254", "bodyText": "I will try to do the following and see how complex it is:\nAllow @HelidonTest(resetPerTest=true)\nIn such a case:\n\nNo injection allowed into the class itself or using constructor\nAnnotations would be combined from class level and method levels\nEach method would run in a separate container\nTest methods can have SeContainer as a parameter", "author": "tomas-langer", "createdAt": "2020-09-15T17:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTIyMTE5OA==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r489221198", "bodyText": "Awesome thats exactly it! Works like a charm!\n    private WebClient client;\n    private TestMessagingBean bean;\n\n    @BeforeEach\n    void beforeEach() {\n        ServerCdiExtension server = CDI.current().select(ServerCdiExtension.class).get();\n        bean = CDI.current().select(TestMessagingBean.class).get();\n        client = WebClient.builder()\n                .baseUri(\"http://localhost:\" + server.port())\n                .addReader(JsonpSupport.reader())\n                .build();\n    }\n\n    @Test\n    void alivenessWithErrorSignal(SeContainer seContainer) {\n        TestMessagingBean bean = seContainer.select(TestMessagingBean.class).get();", "author": "danielkec", "createdAt": "2020-09-16T07:27:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTIyMjQ0MQ==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r489222441", "bodyText": "And its faster!\nContainer per method coded manually:\n\nContainer per method with @HelidonTest(resetPerTest = true):", "author": "danielkec", "createdAt": "2020-09-16T07:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NDEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyNjQxMA==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r487926410", "bodyText": "Works when injecting to field, but constructor param is not injected in my case:\n@HelidonTest(discovery = false)\n@AddBeans({\n        @AddBean(MessagingLivenessCheck.class),\n        @AddBean(TestMessagingBean.class),\n})\n@AddExtensions({\n        @AddExtension(ConfigCdiExtension.class),\n        @AddExtension(ServerCdiExtension.class),\n        @AddExtension(JaxRsCdiExtension.class),\n        @AddExtension(HealthCdiExtension.class),\n        @AddExtension(MessagingCdiExtension.class),\n})\npublic class MessagingHealthTest {\n\n    private WebClient client;\n\n    @Inject\n    public MessagingHealthTest(ServerCdiExtension server) {\n        //ServerCdiExtension server = CDI.current().select(ServerCdiExtension.class).get();\n        client = WebClient.builder()\n                .baseUri(\"http://localhost:\" + server.port())\n                .addReader(JsonpSupport.reader())\n                .build();\n    }\norg.junit.jupiter.api.extension.ParameterResolutionException: No ParameterResolver registered for parameter [io.helidon.microprofile.server.ServerCdiExtension arg0] in constructor [public io.helidon.microprofile.messaging.health.MessagingHealthTest(io.helidon.microprofile.server.ServerCdiExtension)", "author": "danielkec", "createdAt": "2020-09-14T13:42:32Z", "path": "microprofile/tests/junit5/src/main/java/io/helidon/microprofile/tests/junit5/HelidonJunitExtension.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.microprofile.tests.junit5;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Modifier;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.context.RequestScoped;\n+import javax.enterprise.event.Observes;\n+import javax.enterprise.inject.se.SeContainer;\n+import javax.enterprise.inject.se.SeContainerInitializer;\n+import javax.enterprise.inject.spi.BeforeBeanDiscovery;\n+import javax.enterprise.inject.spi.Extension;\n+import javax.inject.Singleton;\n+\n+import io.helidon.config.mp.MpConfigSources;\n+\n+import org.eclipse.microprofile.config.Config;\n+import org.eclipse.microprofile.config.spi.ConfigProviderResolver;\n+import org.junit.jupiter.api.extension.AfterAllCallback;\n+import org.junit.jupiter.api.extension.BeforeAllCallback;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+import org.junit.jupiter.api.extension.InvocationInterceptor;\n+import org.junit.jupiter.api.extension.ReflectiveInvocationContext;\n+\n+/**\n+ * Junit5 extension to support Helidon CDI container in tests.\n+ */\n+class HelidonJunitExtension implements BeforeAllCallback, AfterAllCallback, InvocationInterceptor {\n+    private Config config;\n+    private ConfigProviderResolver instance;\n+    private SeContainer container;\n+\n+    @SuppressWarnings(\"unchecked\")\n+    @Override\n+    public void beforeAll(ExtensionContext context) {\n+        Class<?> testClass = context.getRequiredTestClass();\n+\n+        // prepare configuration\n+        Map<String, String> additionalConfig = new HashMap<>();\n+        additionalConfig.put(\"mp.initializer.allow\", \"true\");\n+        additionalConfig.put(\"mp.initializer.no-warn\", \"true\");\n+\n+        AddConfig[] configAnnotations = testClass.getAnnotationsByType(AddConfig.class);\n+\n+        for (AddConfig configAnnotation : configAnnotations) {\n+            additionalConfig.put(configAnnotation.key(), configAnnotation.value());\n+        }\n+\n+        instance = ConfigProviderResolver.instance();\n+        config = instance.getBuilder()\n+                .withSources(MpConfigSources.create(additionalConfig))\n+                .addDefaultSources()\n+                .addDiscoveredSources()\n+                .addDiscoveredConverters()\n+                .build();\n+        instance.registerConfig(config, Thread.currentThread().getContextClassLoader());\n+\n+        // now let's prepare the CDI bootstrapping\n+        SeContainerInitializer initializer = SeContainerInitializer.newInstance();\n+\n+        HelidonTest testAnnot = testClass.getAnnotation(HelidonTest.class);\n+        if (testAnnot != null) {\n+            if (!testAnnot.discovery()) {\n+                initializer.disableDiscovery();\n+            }\n+        }\n+\n+        AddBean[] addBeans = testClass.getAnnotationsByType(AddBean.class);\n+        initializer.addExtensions(new AddBeansExtension(testClass, addBeans));\n+\n+        AddExtension[] addExtensions = testClass.getAnnotationsByType(AddExtension.class);\n+        for (AddExtension addExtension : addExtensions) {\n+            Class<? extends Extension> extensionClass = addExtension.value();\n+            if (Modifier.isPublic(extensionClass.getModifiers())) {\n+                initializer.addExtensions(addExtension.value());\n+            } else {\n+                throw new IllegalArgumentException(\"Extension classes must be public, but \" + extensionClass\n+                        .getName() + \" is not\");\n+            }\n+        }\n+\n+        container = initializer.initialize();\n+    }\n+\n+    @Override\n+    public void afterAll(ExtensionContext context) {\n+        if (container != null) {\n+            container.close();\n+        }\n+        if (instance != null && config != null) {\n+            instance.releaseConfig(config);\n+        }\n+    }\n+\n+    @Override\n+    public <T> T interceptTestClassConstructor(Invocation<T> invocation,\n+                                               ReflectiveInvocationContext<Constructor<T>> invocationContext,\n+                                               ExtensionContext extensionContext) {\n+\n+        // we need to replace instantiation with CDI lookup, to properly injection into fields (and constructors)\n+        invocation.skip();\n+\n+        return container.select(invocationContext.getExecutable().getDeclaringClass())\n+                .get();\n+    }", "originalCommit": "6e526b28f95e75ccb831a44eac43b4b4a67ec7c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyODk0Mw==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r487928943", "bodyText": "Turns out io.helidon.microprofile.tests.junit5.HelidonJunitExtension#interceptTestClassConstructor didn't get invoked at all.\nBut when implementing org.junit.jupiter.api.extension.ParameterResolver\n    @Override\n    public boolean supportsParameter(final ParameterContext parameterContext, final ExtensionContext extensionContext) throws ParameterResolutionException {\n        return !container.select(parameterContext.getParameter().getType()).isUnsatisfied();\n    }\n\n    @Override\n    public Object resolveParameter(final ParameterContext parameterContext, final ExtensionContext extensionContext) throws ParameterResolutionException {\n        return container.select(parameterContext.getParameter().getType()).get();\n    }\nConstructor params get resolved", "author": "danielkec", "createdAt": "2020-09-14T13:45:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyNjQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2Mzg0Ng==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r488163846", "bodyText": "I will look into the constructor injection", "author": "tomas-langer", "createdAt": "2020-09-14T19:16:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyNjQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2NDgyNg==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r488164826", "bodyText": "On the other hand people usually do not expect to add constructors to their test classes...", "author": "tomas-langer", "createdAt": "2020-09-14T19:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyNjQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2NzgzMw==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r488167833", "bodyText": "But when the test class becomes a bean ... \ud83d\ude04 , there is no other beforeAll invoked after injection", "author": "danielkec", "createdAt": "2020-09-14T19:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyNjQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE3NTI3MQ==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r488175271", "bodyText": "More of a nice to have than a must have IMO", "author": "spericas", "createdAt": "2020-09-14T19:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyNjQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyMjM2Mw==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r488822363", "bodyText": "This seems to be a small \"miss-design\" in Junit - they obtain argument definitions, argument values, and then their code is ignored, as I use CDI to instantiate the bean (so all of that gets discarded).\nI have created a workaround that does not actually select the constructor parameters from CDI and just returns default values (null or primitive type). Added a test as well", "author": "tomas-langer", "createdAt": "2020-09-15T17:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyNjQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTIxMDEyOA==", "url": "https://github.com/oracle/helidon/pull/2353#discussion_r489210128", "bodyText": "Thx for the hint @PostConstruct is just the beforeAll I needed\n@HelidonTest(resetPerTest = false)\n@DisableDiscovery\n@AddBeans({\n        @AddBean(MessagingLivenessCheck.class),\n        @AddBean(TestMessagingBean.class),\n})\n@AddExtensions({\n        @AddExtension(ConfigCdiExtension.class),\n        @AddExtension(ServerCdiExtension.class),\n        @AddExtension(JaxRsCdiExtension.class),\n        @AddExtension(HealthCdiExtension.class),\n        @AddExtension(MessagingCdiExtension.class),\n})\nclass MessagingHealthTest {\n\n    private WebClient client;\n\n    @Inject\n    ServerCdiExtension server;\n\n    @Inject\n    TestMessagingBean bean;\n\n    @PostConstruct\n    void beforeAll() {\n        client = WebClient.builder()\n                .baseUri(\"http://localhost:\" + server.port())\n                .addReader(JsonpSupport.reader())\n                .build();\n    }", "author": "danielkec", "createdAt": "2020-09-16T07:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyNjQxMA=="}], "type": "inlineReview"}, {"oid": "c99bacbd3081d3f0847857d559b6e6d0b0cf1e4c", "url": "https://github.com/oracle/helidon/commit/c99bacbd3081d3f0847857d559b6e6d0b0cf1e4c", "message": "Added support for\n * per test method CDI container.\n * custom config sources\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-09-15T19:29:18Z", "type": "forcePushed"}, {"oid": "d0d6336cb2e59ad127fd171e3db4ae9ac7b66f0f", "url": "https://github.com/oracle/helidon/commit/d0d6336cb2e59ad127fd171e3db4ae9ac7b66f0f", "message": "MP Testing\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-09-15T19:34:37Z", "type": "commit"}, {"oid": "0b7ee0723629cff50c77190619466c9ab1a7dcfd", "url": "https://github.com/oracle/helidon/commit/0b7ee0723629cff50c77190619466c9ab1a7dcfd", "message": "Added support for\n * per test method CDI container.\n * custom config sources\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-09-15T19:34:37Z", "type": "commit"}, {"oid": "5729e78cce664823ac684e3abbe329908b40b283", "url": "https://github.com/oracle/helidon/commit/5729e78cce664823ac684e3abbe329908b40b283", "message": "Rebased and checkstyle fixed.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-09-15T20:04:29Z", "type": "commit"}, {"oid": "5729e78cce664823ac684e3abbe329908b40b283", "url": "https://github.com/oracle/helidon/commit/5729e78cce664823ac684e3abbe329908b40b283", "message": "Rebased and checkstyle fixed.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-09-15T20:04:29Z", "type": "forcePushed"}, {"oid": "c9d029e891facd60fb529a3a07b4af9a4cc76983", "url": "https://github.com/oracle/helidon/commit/c9d029e891facd60fb529a3a07b4af9a4cc76983", "message": "We now only care about constructor parameters.\nMethod parameter is only checked when running in per-method mode.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-09-15T20:31:35Z", "type": "commit"}, {"oid": "643016b9fc2fc4d141da78e4a02ef85b3c66c116", "url": "https://github.com/oracle/helidon/commit/643016b9fc2fc4d141da78e4a02ef85b3c66c116", "message": "Added test scope when using the integration.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-09-15T20:34:15Z", "type": "commit"}, {"oid": "448c03f11178c344b7308c1d645096a20a16aa67", "url": "https://github.com/oracle/helidon/commit/448c03f11178c344b7308c1d645096a20a16aa67", "message": "Typo fixed.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-09-16T10:47:46Z", "type": "commit"}]}