{"pr_number": 1877, "pr_title": "DataChunk ByteBuffer array", "pr_createdAt": "2020-05-27T04:44:17Z", "pr_url": "https://github.com/oracle/helidon/pull/1877", "timeline": [{"oid": "41d100336f1a9ddbc95ff96ac3993f9ddbaf0713", "url": "https://github.com/oracle/helidon/commit/41d100336f1a9ddbc95ff96ac3993f9ddbaf0713", "message": "Update DataChunk to hold an array of ByteBuffer instead of a single ByteBuffer.\nFixes #1876", "committedDate": "2020-05-27T04:44:05Z", "type": "commit"}, {"oid": "83c26326d121bf193a82085c112617fa9546ae0f", "url": "https://github.com/oracle/helidon/commit/83c26326d121bf193a82085c112617fa9546ae0f", "message": "fix checkstyle errors", "committedDate": "2020-05-27T05:26:50Z", "type": "commit"}, {"oid": "d29fcdd4e666161b3f417cff69db89f9dd64956b", "url": "https://github.com/oracle/helidon/commit/d29fcdd4e666161b3f417cff69db89f9dd64956b", "message": "fix copyright errors", "committedDate": "2020-05-27T06:06:22Z", "type": "commit"}, {"oid": "4c29070833c2f608979845063b1284981cfc2074", "url": "https://github.com/oracle/helidon/commit/4c29070833c2f608979845063b1284981cfc2074", "message": "Merge remote-tracking branch 'origin/master' into datachunk-bytebuffers", "committedDate": "2020-05-27T06:39:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE2NTA4NA==", "url": "https://github.com/oracle/helidon/pull/1877#discussion_r431165084", "bodyText": "What would happen with this condition if the last ByteBuffer in the chunk returns 0 and continues in line 144?", "author": "spericas", "createdAt": "2020-05-27T14:14:37Z", "path": "media/common/src/main/java/io/helidon/media/common/DataChunkInputStream.java", "diffHunk": "@@ -132,32 +132,38 @@ public int read(byte[] buf, int off, int len) throws IOException {\n                 return -1;\n             }\n \n-            ByteBuffer currentBuffer = chunk.data();\n-\n-            if (currentBuffer.position() == 0) {\n-                LOGGER.finest(() -> \"Reading chunk ID: \" + chunk.id());\n-            }\n-\n-            // If there is anything to read, then read as much as fits into buf\n-            int rem = currentBuffer.remaining();\n-            if (len > rem) {\n-                len = rem;\n+            ByteBuffer[] currentBuffers = chunk.data();\n+            int count = 0;\n+            for (int i = 0; i < currentBuffers.length; i++) {\n+                if (i == 0 && currentBuffers[i].position() == 0) {\n+                    LOGGER.finest(() -> \"Reading chunk ID: \" + chunk.id());\n+                }\n+                // If there is anything to read, then read as much as fits into buf\n+                int rem = currentBuffers[i].remaining();\n+                if (rem == 0) {\n+                    continue;\n+                }\n+                int currentLen = len;\n+                if (currentLen > rem) {\n+                    currentLen = rem;\n+                }\n+                currentBuffers[i].get(buf, off, currentLen);\n+                off += currentLen;\n+                count += currentLen;\n+\n+                // Chunk is consumed entirely - release the chunk, and prefetch a new chunk; do not\n+                // wait for it to arrive - the next read may have to wait less.\n+                //\n+                // Assert: it is safe to request new chunks eagerly - there is no mechanism\n+                // to push back unconsumed data, so we can assume we own all the chunks,\n+                // consumed and unconsumed.\n+                if (i == currentBuffers.length - 1 && currentLen == rem) {", "originalCommit": "d29fcdd4e666161b3f417cff69db89f9dd64956b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxNjg1Mg==", "url": "https://github.com/oracle/helidon/pull/1877#discussion_r431316852", "bodyText": "Good point. I will make another pass at this and add a unit test.", "author": "romain-grecourt", "createdAt": "2020-05-27T17:27:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE2NTA4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2ODE1NQ==", "url": "https://github.com/oracle/helidon/pull/1877#discussion_r431468155", "bodyText": "@spericas, I've made changes, please take a look and let me know.", "author": "romain-grecourt", "createdAt": "2020-05-27T22:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE2NTA4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc4NzI1OA==", "url": "https://github.com/oracle/helidon/pull/1877#discussion_r431787258", "bodyText": "@romain-grecourt I'll take a closer look. At first glance, the code is still a bit odd; it seems that the DataChunk abstraction needs to be improved so we can call get(byte[], int off, int len) and so that it can iterate over its ByteBuffer's, copy the data and also remember which buffer it is reading from.\nYour code is always starting from the first buffer on each call to read(...), even though buffers may have been consumed in an earlier call. If the DataChunk abstraction is enhanced, thenDataChunkInputStream shouldn't need to change too much.", "author": "spericas", "createdAt": "2020-05-28T12:10:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE2NTA4NA=="}], "type": "inlineReview"}, {"oid": "cfaa8526496eea3588f90522ba0a1a43ceac117a", "url": "https://github.com/oracle/helidon/commit/cfaa8526496eea3588f90522ba0a1a43ceac117a", "message": "Fix DataChunkInputStream\nFix MultiPartDecoder to handle ByteBuffer[]", "committedDate": "2020-05-27T18:20:02Z", "type": "commit"}, {"oid": "ee925381cb157e6ecbe0e85ea1c0b5f5906e5cf4", "url": "https://github.com/oracle/helidon/commit/ee925381cb157e6ecbe0e85ea1c0b5f5906e5cf4", "message": "fix multipart example to handle ByteBuffer[]", "committedDate": "2020-05-27T19:38:18Z", "type": "commit"}, {"oid": "2a091d85f0d00b9dcea8cebf40da4b98f917cf05", "url": "https://github.com/oracle/helidon/commit/2a091d85f0d00b9dcea8cebf40da4b98f917cf05", "message": "Merge remote-tracking branch 'origin/master' into datachunk-bytebuffers", "committedDate": "2020-06-01T22:14:42Z", "type": "commit"}, {"oid": "7465510de4696b1cc9d3decbac9f52111d6ccc7e", "url": "https://github.com/oracle/helidon/commit/7465510de4696b1cc9d3decbac9f52111d6ccc7e", "message": "maintain bufferIndex", "committedDate": "2020-06-01T23:11:28Z", "type": "commit"}, {"oid": "011a7f9459562d8106e7bee5bff4d4d9799b3e5c", "url": "https://github.com/oracle/helidon/commit/011a7f9459562d8106e7bee5bff4d4d9799b3e5c", "message": "Improve implementation", "committedDate": "2020-06-02T19:25:05Z", "type": "commit"}]}