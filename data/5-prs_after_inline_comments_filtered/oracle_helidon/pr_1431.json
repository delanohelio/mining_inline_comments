{"pr_number": 1431, "pr_title": "Webclient implementation (#1205)", "pr_createdAt": "2020-02-21T22:57:13Z", "pr_url": "https://github.com/oracle/helidon/pull/1431", "timeline": [{"oid": "f82d12e237dc5f206159648b23dbd3c6649adb95", "url": "https://github.com/oracle/helidon/commit/f82d12e237dc5f206159648b23dbd3c6649adb95", "message": "Webclient implementation (#1205)\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-02-21T23:31:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1Njc5OA==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r382856798", "bodyText": "Is this left-over ?", "author": "romain-grecourt", "createdAt": "2020-02-21T23:47:02Z", "path": "examples/webclient/standalone/src/main/java/io/helidon/rest/client/example/basic/StandaloneClientExample.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.rest.client.example.basic;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Level;\n+import java.util.logging.LogManager;\n+import java.util.logging.Logger;\n+\n+import io.helidon.common.context.Context;\n+import io.helidon.config.Config;\n+import io.helidon.security.Security;\n+import io.helidon.security.SecurityContext;\n+import io.helidon.webclient.WebClient;\n+\n+/**\n+ * A standalone web client.\n+ */\n+public class StandaloneClientExample {\n+\n+    private static final Logger LOGGER = Logger.getLogger(StandaloneClientExample.class.getName());\n+\n+    private StandaloneClientExample() {\n+\n+    }\n+\n+    /**\n+     * Executes simple request using webclient.\n+     *\n+     * @param args arguments\n+     * @throws ExecutionException\n+     * @throws InterruptedException\n+     * @throws IOException\n+     */\n+    public static void main(String[] args) throws ExecutionException, InterruptedException, IOException {\n+        LogManager.getLogManager().readConfiguration(StandaloneClientExample.class.getResourceAsStream(\"/logging.properties\"));\n+\n+        /*\n+         * Prepare helidon stuff\n+         */\n+        Config config = Config.create();\n+        Security security = Security.builder().build();\n+\n+        SecurityContext securityContext = security.createContext(\"standalone-example\");\n+\n+        Context context = Context.builder().id(\"standalone-example\").build();\n+        context.register(securityContext);\n+\n+        /*\n+         * Initialize client.\n+         */\n+        WebClient client = WebClient.builder()\n+                .config(config.get(\"client\"))\n+                .context(context)\n+                .build();\n+\n+        /*\n+         * Each request is created using a builder like fluent api\n+         */\n+        //        CompletionStage<ClientResponse> response = client.put()", "originalCommit": "f82d12e237dc5f206159648b23dbd3c6649adb95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1MTU2NQ==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r383151565", "bodyText": "Yes, thank you.", "author": "Verdent", "createdAt": "2020-02-24T09:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1Njc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1ODM4NA==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r382858384", "bodyText": "Why not re-use io.helidon.common.http.HashParameters ?", "author": "romain-grecourt", "createdAt": "2020-02-21T23:54:32Z", "path": "webclient/webclient/src/main/java/io/helidon/webclient/ClientRequestHeadersImpl.java", "diffHunk": "@@ -0,0 +1,302 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.webclient;\n+\n+import java.time.ZoneId;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+\n+import io.helidon.common.http.Http;\n+import io.helidon.common.http.MediaType;\n+import io.helidon.common.http.Parameters;\n+\n+import io.netty.handler.codec.http.cookie.ClientCookieEncoder;\n+import io.netty.handler.codec.http.cookie.DefaultCookie;\n+\n+/**\n+ * Client request header implementation.\n+ */\n+class ClientRequestHeadersImpl implements ClientRequestHeaders {", "originalCommit": "f82d12e237dc5f206159648b23dbd3c6649adb95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1MTI5NA==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r383151294", "bodyText": "Because we needed full control over the map/object which stores those headers to be able to easily clear them if needed.", "author": "Verdent", "createdAt": "2020-02-24T09:23:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1ODM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MDgzNw==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r382860837", "bodyText": "Thinking-out-loud.\nI don't know if having a configuration for request/response specific readers/writers is really useful.\nInstead you could expose the context from request/response and let the user add these manually for each request/response.\nIf we think there is a need to have HTTP client specific readers/writers for all client request/response, then maybe we should consider updating MediaSupport, MessageBodyReaderContext and MessageBodyWriterContext to support creating a parented MediaSupport.\nThis way you would only need to pass-in a MediaSupport instance to RequestConfiguration.", "author": "romain-grecourt", "createdAt": "2020-02-22T00:07:12Z", "path": "webclient/webclient/src/main/java/io/helidon/webclient/RequestConfiguration.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.webclient;\n+\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+\n+import io.helidon.media.common.MessageBodyReader;\n+import io.helidon.media.common.MessageBodyWriter;\n+import io.helidon.webclient.spi.ClientService;\n+\n+/**\n+ * Configuration of specific request.\n+ */\n+class RequestConfiguration extends ClientConfiguration {\n+\n+    private final URI requestURI;\n+    private final ClientServiceRequest clientServiceRequest;\n+    private final List<ClientService> services;\n+    private final Set<MessageBodyReader<?>> requestReaders;\n+    private final Set<MessageBodyWriter<?>> requestWriters;\n+\n+    private RequestConfiguration(Builder builder) {\n+        super(builder);\n+        requestURI = builder.requestURI;\n+        clientServiceRequest = builder.clientServiceRequest;\n+        services = builder.services;\n+        requestReaders = builder.requestReaders;\n+        requestWriters = builder.messageBodyWriters;\n+    }\n+\n+    URI requestURI() {\n+        return requestURI;\n+    }\n+\n+    ClientServiceRequest clientServiceRequest() {\n+        return clientServiceRequest;\n+    }\n+\n+    List<ClientService> services() {\n+        return services;\n+    }\n+\n+    Set<MessageBodyReader<?>> requestReaders() {", "originalCommit": "f82d12e237dc5f206159648b23dbd3c6649adb95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1MTI1OQ==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r383151259", "bodyText": "Ah this is great you are mentioning this. I have a note to create issue for that. I think that having builder on MediaSupport which allows you to insert explicit parent, would be great for my usecase. I didn't added yet, because I wanted to talk to you about it before.\nIn case of the exposing of context, I do not think that is what we should do.\nThe reason why I opted for specific readers/writers for each request/response is, that it allows you to have control over entity handling. Basically you can have two or more ways how to handle specific entity type in your code and this helps you to achieve this without interfering with other request where it is not desirable.", "author": "Verdent", "createdAt": "2020-02-24T09:23:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MDgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ2NzUwMg==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r383467502", "bodyText": "There should be a parented context dedicated to each request, that would be symmetrical to how it's done in the webserver currently. We can talk more about this when you have some time.", "author": "romain-grecourt", "createdAt": "2020-02-24T19:28:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MDgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MTYwNQ==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r382861605", "bodyText": "Should that be named HttpClientException or WebClientException instead ?", "author": "romain-grecourt", "createdAt": "2020-02-22T00:11:21Z", "path": "webclient/webclient/src/main/java/io/helidon/webclient/ClientException.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.webclient;\n+\n+import java.util.Optional;\n+\n+/**\n+ * An exception that caused this client request to fail. If the exception is based on status or content of response from\n+ * server, the {@link ClientResponse} is available to obtain any needed details.\n+ * If the exception was caused before data was sent, or due to timeouts, socket exceptions etc., the {@link ClientResponse} is\n+ * not present and exception handling must be based on the wrapped exception.\n+ */\n+public class ClientException extends RuntimeException {", "originalCommit": "f82d12e237dc5f206159648b23dbd3c6649adb95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIzMjQ1MQ==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r383232451", "bodyText": "Yes in fact I do agree. I didn't think about it when I was writing it, because it was obvious for me where does this belong, but I are correct that this is probably better name.", "author": "Verdent", "createdAt": "2020-02-24T12:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MTYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MTcwMg==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r382861702", "bodyText": "Should that be named HttpClientConfiguration or WebClientConfiguration instead ?", "author": "romain-grecourt", "createdAt": "2020-02-22T00:11:53Z", "path": "webclient/webclient/src/main/java/io/helidon/webclient/ClientConfiguration.java", "diffHunk": "@@ -0,0 +1,539 @@\n+/*\n+ * Copyright (c) 2019, 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.webclient;\n+\n+import java.net.CookieManager;\n+import java.net.CookiePolicy;\n+import java.net.CookieStore;\n+import java.net.URI;\n+import java.security.cert.X509Certificate;\n+import java.time.Duration;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.SSLException;\n+\n+import io.helidon.common.LazyValue;\n+import io.helidon.common.context.Context;\n+import io.helidon.config.Config;\n+import io.helidon.media.common.MediaSupport;\n+import io.helidon.webclient.spi.ClientService;\n+\n+import io.netty.handler.ssl.ClientAuth;\n+import io.netty.handler.ssl.IdentityCipherSuiteFilter;\n+import io.netty.handler.ssl.JdkSslContext;\n+import io.netty.handler.ssl.SslContext;\n+import io.netty.handler.ssl.SslContextBuilder;\n+import io.netty.handler.ssl.SslProvider;\n+import io.netty.handler.ssl.util.InsecureTrustManagerFactory;\n+\n+/**\n+ * Configuration of the Helidon web client.\n+ */\n+class ClientConfiguration {", "originalCommit": "f82d12e237dc5f206159648b23dbd3c6649adb95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MTg2NQ==", "url": "https://github.com/oracle/helidon/pull/1431#discussion_r382861865", "bodyText": "Should that be named HttpClientTracing or WebClientTracing instead ?", "author": "romain-grecourt", "createdAt": "2020-02-22T00:12:47Z", "path": "webclient/tracing/src/main/java/io/helidon/webclient/tracing/ClientTracing.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.webclient.tracing;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+import io.helidon.common.HelidonFeatures;\n+import io.helidon.common.HelidonFlavor;\n+import io.helidon.webclient.ClientServiceRequest;\n+import io.helidon.webclient.spi.ClientService;\n+\n+import io.opentracing.Span;\n+import io.opentracing.SpanContext;\n+import io.opentracing.Tracer;\n+import io.opentracing.propagation.Format;\n+import io.opentracing.propagation.TextMapAdapter;\n+import io.opentracing.util.GlobalTracer;\n+\n+/**\n+ * Client service for tracing propagation.\n+ */\n+public class ClientTracing implements ClientService {", "originalCommit": "f82d12e237dc5f206159648b23dbd3c6649adb95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cb1ab6438e68132e056c4827fd7bf5ce49c4563f", "url": "https://github.com/oracle/helidon/commit/cb1ab6438e68132e056c4827fd7bf5ce49c4563f", "message": "Webclient implementation (#1205)\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-09T15:14:57Z", "type": "commit"}, {"oid": "b61a3677e8a8aed9a15f7807e6464fd1dc52b5be", "url": "https://github.com/oracle/helidon/commit/b61a3677e8a8aed9a15f7807e6464fd1dc52b5be", "message": "Romain suggestions implemented.\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-09T15:14:58Z", "type": "commit"}, {"oid": "2cff2e38ade5fd46a6ffa5cd43a76c17c14d12d1", "url": "https://github.com/oracle/helidon/commit/2cff2e38ade5fd46a6ffa5cd43a76c17c14d12d1", "message": "Checkstyle fixes.\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-09T15:14:58Z", "type": "commit"}, {"oid": "b831d93aef9bba7714288871adea029c608bb090", "url": "https://github.com/oracle/helidon/commit/b831d93aef9bba7714288871adea029c608bb090", "message": "Leftover comment removed.\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-09T15:14:58Z", "type": "commit"}, {"oid": "749a8c2969ee4068d1badc859c6682df2c0785f3", "url": "https://github.com/oracle/helidon/commit/749a8c2969ee4068d1badc859c6682df2c0785f3", "message": "Tracing test and tracing update.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-03-09T15:14:58Z", "type": "commit"}, {"oid": "8ad6443a55fb7155fd01a5ff25eb4d1f4001e390", "url": "https://github.com/oracle/helidon/commit/8ad6443a55fb7155fd01a5ff25eb4d1f4001e390", "message": "Improvements implemented.\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-09T15:14:59Z", "type": "commit"}, {"oid": "bf6736fc92fae1b9944dbeac90b8469f62f6a4a7", "url": "https://github.com/oracle/helidon/commit/bf6736fc92fae1b9944dbeac90b8469f62f6a4a7", "message": "Minor fixes and optimizations.\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-09T15:14:59Z", "type": "commit"}, {"oid": "0eef418a82c4e7676e3c4950975206703c90f931", "url": "https://github.com/oracle/helidon/commit/0eef418a82c4e7676e3c4950975206703c90f931", "message": "Javadoc comments added\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-09T15:14:59Z", "type": "commit"}, {"oid": "0eef418a82c4e7676e3c4950975206703c90f931", "url": "https://github.com/oracle/helidon/commit/0eef418a82c4e7676e3c4950975206703c90f931", "message": "Javadoc comments added\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-09T15:14:59Z", "type": "forcePushed"}, {"oid": "425177b000f0a31db830c8eb7c34dc011e1d43e2", "url": "https://github.com/oracle/helidon/commit/425177b000f0a31db830c8eb7c34dc011e1d43e2", "message": "Tests updated\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-10T08:50:37Z", "type": "commit"}, {"oid": "5716ca15760f4466ad068a591cd3ce99dc3015b9", "url": "https://github.com/oracle/helidon/commit/5716ca15760f4466ad068a591cd3ce99dc3015b9", "message": "Race condition fix\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-10T12:08:02Z", "type": "commit"}, {"oid": "9054118642b81b6e7f1cbc8c1de16dbdff265a46", "url": "https://github.com/oracle/helidon/commit/9054118642b81b6e7f1cbc8c1de16dbdff265a46", "message": "Module names improved\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-10T12:13:22Z", "type": "commit"}, {"oid": "f1dd51e6b6ee1c5153200a5e530aa4d6e4c1a303", "url": "https://github.com/oracle/helidon/commit/f1dd51e6b6ee1c5153200a5e530aa4d6e4c1a303", "message": "Checkstyle fix\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-03-10T12:38:45Z", "type": "commit"}]}