{"pr_number": 1345, "pr_title": "Added DatabaseMetaData.getDatabaseCompatabilityLevel", "pr_createdAt": "2020-05-28T21:35:39Z", "pr_url": "https://github.com/microsoft/mssql-jdbc/pull/1345", "timeline": [{"oid": "1ee8def3b0d8bdcceb8f4346d6b5157cb8b35f0f", "url": "https://github.com/microsoft/mssql-jdbc/commit/1ee8def3b0d8bdcceb8f4346d6b5157cb8b35f0f", "message": "Added DatabaseMetaData.getDatabaseCompatabilityLevel", "committedDate": "2020-05-28T21:33:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4NzQxMw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1345#discussion_r432687413", "bodyText": "I don't think we can guarantee this is always going to be true. Also I couldn't find any documentation on correlation between database version and compatibility level I think it's best not to assume this here", "author": "lilgreenbird", "createdAt": "2020-05-29T19:21:15Z", "path": "src/test/java/com/microsoft/sqlserver/jdbc/databasemetadata/DatabaseMetaDataTest.java", "diffHunk": "@@ -120,6 +120,16 @@ public void testDriverVersion() throws SQLException, IOException {\n         }\n     }\n \n+    @Test\n+    public void testDatabaseCompatibilityLevel() throws SQLException {\n+        try (Connection conn = getConnection()) {\n+            SQLServerDatabaseMetaData dbmData = (SQLServerDatabaseMetaData) conn.getMetaData();\n+            int compatibilityLevel = dbmData.getDatabaseCompatibilityLevel();\n+            assertTrue(compatibilityLevel > 0);\n+            assertTrue(compatibilityLevel < dbmData.getDatabaseMajorVersion()*100);", "originalCommit": "1ee8def3b0d8bdcceb8f4346d6b5157cb8b35f0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTc2NA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1345#discussion_r432865764", "bodyText": "Here's the link to the MS documentation:\nhttps://docs.microsoft.com/en-us/sql/t-sql/statements/alter-database-transact-sql-compatibility-level?view=sql-server-ver15.\nYou are correct that in the case of Azure, it is possible that the compatibility level is greater than the database engine version, so I've deleted that check.  It should however always be greater than 0.", "author": "dhait", "createdAt": "2020-05-30T15:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4NzQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4ODU3MQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1345#discussion_r432688571", "bodyText": "please add javadoc header (see other public api's for format)", "author": "lilgreenbird", "createdAt": "2020-05-29T19:24:01Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerDatabaseMetaData.java", "diffHunk": "@@ -2537,6 +2537,22 @@ public boolean locatorsUpdateCopy() throws SQLException {\n         checkClosed();\n         return true;\n     }\n+\n+    /* -------------- MSSQL-JDBC Extension methods  ---------------- */\n+", "originalCommit": "1ee8def3b0d8bdcceb8f4346d6b5157cb8b35f0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NjQ4Mw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1345#discussion_r432866483", "bodyText": "Done.", "author": "dhait", "createdAt": "2020-05-30T16:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4ODU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MTQ2MA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1345#discussion_r432691460", "bodyText": "remove and just let the error throw", "author": "lilgreenbird", "createdAt": "2020-05-29T19:30:39Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerDatabaseMetaData.java", "diffHunk": "@@ -2537,6 +2537,22 @@ public boolean locatorsUpdateCopy() throws SQLException {\n         checkClosed();\n         return true;\n     }\n+\n+    /* -------------- MSSQL-JDBC Extension methods  ---------------- */\n+\n+    public int getDatabaseCompatibilityLevel() throws SQLException {\n+        checkClosed();\n+        String database = connection.getCatalog();\n+        try (SQLServerResultSet rs = getResultSetFromInternalQueries(null,\n+                \"select name, compatibility_level from sys.databases where name = '\" + database + \"'\")) {\n+            if (!rs.next()) {\n+                return 0;\n+            }\n+            return rs.getInt(\"compatibility_level\");\n+        } catch (SQLServerException e) {", "originalCommit": "1ee8def3b0d8bdcceb8f4346d6b5157cb8b35f0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTkyMw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1345#discussion_r432865923", "bodyText": "Fixed", "author": "dhait", "createdAt": "2020-05-30T15:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MTQ2MA=="}], "type": "inlineReview"}, {"oid": "97bf26036cf6cd0aaed4a1cd0bdbc8ba9680d6ac", "url": "https://github.com/microsoft/mssql-jdbc/commit/97bf26036cf6cd0aaed4a1cd0bdbc8ba9680d6ac", "message": "Incorporated reviewer comments", "committedDate": "2020-05-30T16:16:29Z", "type": "commit"}]}