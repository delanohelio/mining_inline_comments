{"pr_number": 1464, "pr_title": "Added support for ActiveDirectoryInteractive authentication", "pr_createdAt": "2020-11-23T11:08:12Z", "pr_url": "https://github.com/microsoft/mssql-jdbc/pull/1464", "timeline": [{"oid": "c97b863c95385bdcd1afc897ef39cbebaf495578", "url": "https://github.com/microsoft/mssql-jdbc/commit/c97b863c95385bdcd1afc897ef39cbebaf495578", "message": "Fix AEv2 tests exclude for reqExternalSetup and cleanup (#1247)", "committedDate": "2020-02-05T19:03:48Z", "type": "commit"}, {"oid": "54b5a194e5d46552419c86e0d1f8c800f42d3de8", "url": "https://github.com/microsoft/mssql-jdbc/commit/54b5a194e5d46552419c86e0d1f8c800f42d3de8", "message": "Fix | Add null check for getObject() with LocalTime and LocalDate (#1250)", "committedDate": "2020-02-08T00:19:05Z", "type": "commit"}, {"oid": "672b7d67caae75250c53f82a760e8d3880e62a37", "url": "https://github.com/microsoft/mssql-jdbc/commit/672b7d67caae75250c53f82a760e8d3880e62a37", "message": "added all AKV tests to use reqExternalSetup tag so they will be skipped by default (#1254)\n\n* skip AKV test properly\r\n\r\n* removed enclave properties string to failed errors as enclave tests could be skipped", "committedDate": "2020-02-10T19:04:22Z", "type": "commit"}, {"oid": "3c3331b7b0ff1b27b1e80271bf9ffdc6aae7be79", "url": "https://github.com/microsoft/mssql-jdbc/commit/3c3331b7b0ff1b27b1e80271bf9ffdc6aae7be79", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-03-25T06:21:47Z", "type": "commit"}, {"oid": "e2c5640370daa89c0d8c1559b5791e99656f78c8", "url": "https://github.com/microsoft/mssql-jdbc/commit/e2c5640370daa89c0d8c1559b5791e99656f78c8", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-03-26T06:10:08Z", "type": "commit"}, {"oid": "aad696640378b75f3cb8cb24cc2fa299358db9ac", "url": "https://github.com/microsoft/mssql-jdbc/commit/aad696640378b75f3cb8cb24cc2fa299358db9ac", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-03-28T03:18:02Z", "type": "commit"}, {"oid": "92bf04c2787c3b2a704f641f50cb4a83193f1d6d", "url": "https://github.com/microsoft/mssql-jdbc/commit/92bf04c2787c3b2a704f641f50cb4a83193f1d6d", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-03-31T01:58:20Z", "type": "commit"}, {"oid": "3ba5ab72008501e23f43dbcbcc333775320ddafa", "url": "https://github.com/microsoft/mssql-jdbc/commit/3ba5ab72008501e23f43dbcbcc333775320ddafa", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-04-04T05:47:37Z", "type": "commit"}, {"oid": "d20823deffea162b2b17b079cc291f91269558aa", "url": "https://github.com/microsoft/mssql-jdbc/commit/d20823deffea162b2b17b079cc291f91269558aa", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-04-07T00:45:05Z", "type": "commit"}, {"oid": "4cc959f7e76eedbf49e30e5b92de43c86d7eb803", "url": "https://github.com/microsoft/mssql-jdbc/commit/4cc959f7e76eedbf49e30e5b92de43c86d7eb803", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-04-29T02:59:23Z", "type": "commit"}, {"oid": "7b301f8184b26da4d99b2feab8b2aea886c01cea", "url": "https://github.com/microsoft/mssql-jdbc/commit/7b301f8184b26da4d99b2feab8b2aea886c01cea", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-04-30T06:36:21Z", "type": "commit"}, {"oid": "56bcf139fe6acd87c41b3829b4f157c59bd9f873", "url": "https://github.com/microsoft/mssql-jdbc/commit/56bcf139fe6acd87c41b3829b4f157c59bd9f873", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-05-07T22:26:03Z", "type": "commit"}, {"oid": "744e0ca78e57bc6c0db98910a9066d5b583c6ba8", "url": "https://github.com/microsoft/mssql-jdbc/commit/744e0ca78e57bc6c0db98910a9066d5b583c6ba8", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-05-12T22:47:18Z", "type": "commit"}, {"oid": "df8fd41ffa6005b18b0e328593faaeb495ce6547", "url": "https://github.com/microsoft/mssql-jdbc/commit/df8fd41ffa6005b18b0e328593faaeb495ce6547", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-05-19T01:06:51Z", "type": "commit"}, {"oid": "652e68b110828db6b172c1b02df6a06ab04c2b59", "url": "https://github.com/microsoft/mssql-jdbc/commit/652e68b110828db6b172c1b02df6a06ab04c2b59", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-05-26T07:07:35Z", "type": "commit"}, {"oid": "53736db944298004a4a383be14ae83370ffab717", "url": "https://github.com/microsoft/mssql-jdbc/commit/53736db944298004a4a383be14ae83370ffab717", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-05-26T23:02:59Z", "type": "commit"}, {"oid": "9ba6a42285fcc046a0a68e110454b62d8f7f6657", "url": "https://github.com/microsoft/mssql-jdbc/commit/9ba6a42285fcc046a0a68e110454b62d8f7f6657", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-06-02T06:50:57Z", "type": "commit"}, {"oid": "6d156f728a1253dd469da1c6896189762b00097b", "url": "https://github.com/microsoft/mssql-jdbc/commit/6d156f728a1253dd469da1c6896189762b00097b", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-06-05T19:15:40Z", "type": "commit"}, {"oid": "e08ffe5f54050344920bc48d44dc8e04cd143866", "url": "https://github.com/microsoft/mssql-jdbc/commit/e08ffe5f54050344920bc48d44dc8e04cd143866", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-06-10T21:34:05Z", "type": "commit"}, {"oid": "6b6cab266b655c48858187f56071aa3e4ba87054", "url": "https://github.com/microsoft/mssql-jdbc/commit/6b6cab266b655c48858187f56071aa3e4ba87054", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-06-18T19:14:21Z", "type": "commit"}, {"oid": "c2025901e1c9e8b279f42279da2f25ffd6c4232a", "url": "https://github.com/microsoft/mssql-jdbc/commit/c2025901e1c9e8b279f42279da2f25ffd6c4232a", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-06-24T18:58:46Z", "type": "commit"}, {"oid": "0515d4b0d51c3150b2149438f8b8a69be3dfc2bd", "url": "https://github.com/microsoft/mssql-jdbc/commit/0515d4b0d51c3150b2149438f8b8a69be3dfc2bd", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-06-24T20:34:25Z", "type": "commit"}, {"oid": "2c63b5828becf3f737f4edf95593d98ada4e273a", "url": "https://github.com/microsoft/mssql-jdbc/commit/2c63b5828becf3f737f4edf95593d98ada4e273a", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-06-25T06:36:46Z", "type": "commit"}, {"oid": "78aa941fab02af4aef190c7da6141b1251a84b4b", "url": "https://github.com/microsoft/mssql-jdbc/commit/78aa941fab02af4aef190c7da6141b1251a84b4b", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-07-02T18:43:21Z", "type": "commit"}, {"oid": "90e99cd54a0cb4347f813d965ea38b0a9801e8b0", "url": "https://github.com/microsoft/mssql-jdbc/commit/90e99cd54a0cb4347f813d965ea38b0a9801e8b0", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-07-02T20:57:03Z", "type": "commit"}, {"oid": "da1004bb9862d31941e537e77bd0e2ded5edef96", "url": "https://github.com/microsoft/mssql-jdbc/commit/da1004bb9862d31941e537e77bd0e2ded5edef96", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-07-06T22:39:35Z", "type": "commit"}, {"oid": "9ca12848377fad04ad8f8d2a29258ea8500f70d2", "url": "https://github.com/microsoft/mssql-jdbc/commit/9ca12848377fad04ad8f8d2a29258ea8500f70d2", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-07-28T07:45:46Z", "type": "commit"}, {"oid": "c67d8edea9341b2b94a075ecbbc4768e313f0658", "url": "https://github.com/microsoft/mssql-jdbc/commit/c67d8edea9341b2b94a075ecbbc4768e313f0658", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-08-01T00:41:25Z", "type": "commit"}, {"oid": "1d0a4adf7296966d52421ace5011fcc2fcc3147a", "url": "https://github.com/microsoft/mssql-jdbc/commit/1d0a4adf7296966d52421ace5011fcc2fcc3147a", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-08-05T00:02:31Z", "type": "commit"}, {"oid": "f1b1dfbf14ed46682044e343a9e1e34e258827d3", "url": "https://github.com/microsoft/mssql-jdbc/commit/f1b1dfbf14ed46682044e343a9e1e34e258827d3", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-08-26T20:44:33Z", "type": "commit"}, {"oid": "d9bad87bda75441fad79010fb31e90c7de8b6a5d", "url": "https://github.com/microsoft/mssql-jdbc/commit/d9bad87bda75441fad79010fb31e90c7de8b6a5d", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-09-02T05:47:37Z", "type": "commit"}, {"oid": "a2e50b9b66d9207415d6853fa449fc55e968a44a", "url": "https://github.com/microsoft/mssql-jdbc/commit/a2e50b9b66d9207415d6853fa449fc55e968a44a", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-09-09T19:00:26Z", "type": "commit"}, {"oid": "7ff97dee94ec4144ef22e5d12ba76f1a84ebe3c9", "url": "https://github.com/microsoft/mssql-jdbc/commit/7ff97dee94ec4144ef22e5d12ba76f1a84ebe3c9", "message": "enable ADintegrated tests for non-windows", "committedDate": "2020-09-09T23:20:13Z", "type": "commit"}, {"oid": "7cae3b431dc533e07042f1bbc810995f78b64510", "url": "https://github.com/microsoft/mssql-jdbc/commit/7cae3b431dc533e07042f1bbc810995f78b64510", "message": "fixed user test for kerberos", "committedDate": "2020-09-11T05:34:42Z", "type": "commit"}, {"oid": "c8c5a2977c700d62815ab8073ea11a8d40885deb", "url": "https://github.com/microsoft/mssql-jdbc/commit/c8c5a2977c700d62815ab8073ea11a8d40885deb", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-09-16T22:34:15Z", "type": "commit"}, {"oid": "d76368aedf39c5dbc573f7449e91524b1227daf7", "url": "https://github.com/microsoft/mssql-jdbc/commit/d76368aedf39c5dbc573f7449e91524b1227daf7", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-09-22T05:08:08Z", "type": "commit"}, {"oid": "e5aafd300061bee1968463cf7ad1d07d6da8356d", "url": "https://github.com/microsoft/mssql-jdbc/commit/e5aafd300061bee1968463cf7ad1d07d6da8356d", "message": "Merge branch 'dev' of https://github.com/lilgreenbird/mssql-jdbc into dev", "committedDate": "2020-09-22T05:08:27Z", "type": "commit"}, {"oid": "7800824306a3a34fb9976887e36e96fb8bcabd73", "url": "https://github.com/microsoft/mssql-jdbc/commit/7800824306a3a34fb9976887e36e96fb8bcabd73", "message": "Merge remote-tracking branch 'upstream/dev' into dev", "committedDate": "2020-10-05T20:56:53Z", "type": "commit"}, {"oid": "a8199bbbddf7c75d6381cf0d057b00504823c005", "url": "https://github.com/microsoft/mssql-jdbc/commit/a8199bbbddf7c75d6381cf0d057b00504823c005", "message": "merged", "committedDate": "2020-10-14T23:58:37Z", "type": "commit"}, {"oid": "b6d475c0852cba388178a222c8ff44e6e3789edd", "url": "https://github.com/microsoft/mssql-jdbc/commit/b6d475c0852cba388178a222c8ff44e6e3789edd", "message": "added ActiveDirectoryInteractive authentication", "committedDate": "2020-10-29T01:55:10Z", "type": "commit"}, {"oid": "6303db0b8bf8053e289ab9c8adfac466bed33127", "url": "https://github.com/microsoft/mssql-jdbc/commit/6303db0b8bf8053e289ab9c8adfac466bed33127", "message": "update", "committedDate": "2020-11-11T01:26:20Z", "type": "commit"}, {"oid": "f9f0e1f4b43594a220279a0f5fbba4d44b5fe842", "url": "https://github.com/microsoft/mssql-jdbc/commit/f9f0e1f4b43594a220279a0f5fbba4d44b5fe842", "message": "cache", "committedDate": "2020-11-13T23:51:04Z", "type": "commit"}, {"oid": "add1141ccd6cba736d5f6659317eccede335ea85", "url": "https://github.com/microsoft/mssql-jdbc/commit/add1141ccd6cba736d5f6659317eccede335ea85", "message": "cache", "committedDate": "2020-11-14T00:00:33Z", "type": "commit"}, {"oid": "d9e9b6391baa706a398d3dcb97a659196b5148da", "url": "https://github.com/microsoft/mssql-jdbc/commit/d9e9b6391baa706a398d3dcb97a659196b5148da", "message": "Merge remote-tracking branch 'upstream/dev' into mfa", "committedDate": "2020-11-14T02:10:32Z", "type": "commit"}, {"oid": "4c135f2a8638abadd786b85fec608e6be155fb3e", "url": "https://github.com/microsoft/mssql-jdbc/commit/4c135f2a8638abadd786b85fec608e6be155fb3e", "message": "added clearUserTokenCache", "committedDate": "2020-11-17T09:30:38Z", "type": "commit"}, {"oid": "fbe56ccd9cadd971a2bf7de06bd8733dbb0481a2", "url": "https://github.com/microsoft/mssql-jdbc/commit/fbe56ccd9cadd971a2bf7de06bd8733dbb0481a2", "message": "cleanup", "committedDate": "2020-11-18T05:01:39Z", "type": "commit"}, {"oid": "5a4ea5931a10c647332b69df4971d2e29e0559e2", "url": "https://github.com/microsoft/mssql-jdbc/commit/5a4ea5931a10c647332b69df4971d2e29e0559e2", "message": "token cache aspect", "committedDate": "2020-11-19T01:14:32Z", "type": "commit"}, {"oid": "198720cc18d34bd238791a6362d93fec4567263e", "url": "https://github.com/microsoft/mssql-jdbc/commit/198720cc18d34bd238791a6362d93fec4567263e", "message": "update", "committedDate": "2020-11-19T01:27:11Z", "type": "commit"}, {"oid": "cc44cd6de7bae0bd494ce04692c0d8476e1a595e", "url": "https://github.com/microsoft/mssql-jdbc/commit/cc44cd6de7bae0bd494ce04692c0d8476e1a595e", "message": "tests", "committedDate": "2020-11-20T03:57:56Z", "type": "commit"}, {"oid": "6f733b9abcf83da3fc52c2c1bbc5788806c21d0b", "url": "https://github.com/microsoft/mssql-jdbc/commit/6f733b9abcf83da3fc52c2c1bbc5788806c21d0b", "message": "removed debug", "committedDate": "2020-11-20T07:24:51Z", "type": "commit"}, {"oid": "938c7af0dca9082425550305681f3df0551bc0a7", "url": "https://github.com/microsoft/mssql-jdbc/commit/938c7af0dca9082425550305681f3df0551bc0a7", "message": "username", "committedDate": "2020-11-20T22:01:12Z", "type": "commit"}, {"oid": "ba238011df8f8431f0b02cba92ca87842477a839", "url": "https://github.com/microsoft/mssql-jdbc/commit/ba238011df8f8431f0b02cba92ca87842477a839", "message": "error msg format", "committedDate": "2020-11-20T23:16:04Z", "type": "commit"}, {"oid": "062bd1425ac56adcd934d07bd9c7695490d3a0df", "url": "https://github.com/microsoft/mssql-jdbc/commit/062bd1425ac56adcd934d07bd9c7695490d3a0df", "message": "update error msg", "committedDate": "2020-11-21T02:32:13Z", "type": "commit"}, {"oid": "05935cebbc7ac831cbd75779ca854ee8b8283001", "url": "https://github.com/microsoft/mssql-jdbc/commit/05935cebbc7ac831cbd75779ca854ee8b8283001", "message": "update client id", "committedDate": "2020-11-21T03:33:57Z", "type": "commit"}, {"oid": "5533134ec28008bef4c751401d6fe3ceeb5d1c1d", "url": "https://github.com/microsoft/mssql-jdbc/commit/5533134ec28008bef4c751401d6fe3ceeb5d1c1d", "message": "error msg fix", "committedDate": "2020-11-21T09:07:55Z", "type": "commit"}, {"oid": "53b5663b08fe26da7151c917456a85c568c65ea1", "url": "https://github.com/microsoft/mssql-jdbc/commit/53b5663b08fe26da7151c917456a85c568c65ea1", "message": "merged", "committedDate": "2020-11-23T09:41:08Z", "type": "commit"}, {"oid": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "url": "https://github.com/microsoft/mssql-jdbc/commit/76407e2bc52c8af4f41ebfe55526549191b3ec47", "message": "added clearUserTokenCache", "committedDate": "2020-11-23T22:58:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAzNDA0OQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r530034049", "bodyText": "Please create a separate enum for ActiveDirectoryInteractive to avoid confusion. See  ADALWORKFLOW_ACTIVEDIRECTORYSERVICEPRINCIPAL and ADALWORKFLOW_ACTIVEDIRECTORYPASSWORD for reference.", "author": "ulvii", "createdAt": "2020-11-25T00:38:48Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -3907,6 +3910,7 @@ int writeFedAuthFeatureRequest(boolean write, /* if false just calculates the le\n                             workflow = TDS.ADALWORKFLOW_ACTIVEDIRECTORYINTEGRATED;\n                             break;\n                         case ActiveDirectoryMSI:\n+                        case ActiveDirectoryInteractive:", "originalCommit": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2MTExMA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r530561110", "bodyText": "Are null checks not required for accounts, entries, or usernames? The following checks if accounts is null and not empty, before attempting to find the first element that matches the username. It also checks that the IAccount it just iterated over isn't null, the username within the IAccount isn't null, and then does the comparison. If it finds an element that matches the criteria, it'll assign that value to the return variable, if not, it'll assign null to the return variable.\n// Helper function to return account containing user name from set of accounts, or null if no match\nprivate static IAccount getAccountByUsername(Set<IAccount> accounts, String username) {\n    IAccount result = null;\n    if (null != accounts && !accounts.isEmpty())\n        result = accounts.parallelStream()\n                .filter(a -> (null != a && null != a.username() && a.username().equals(username))).findFirst()\n                .orElse(null);\n    return result;\n}", "author": "rene-ye", "createdAt": "2020-11-25T18:08:41Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerMSAL4JUtils.java", "diffHunk": "@@ -119,6 +127,76 @@ static SqlFedAuthToken getSqlFedAuthTokenIntegrated(SqlFedAuthInfo fedAuthInfo,\n         }\n     }\n \n+    static SqlFedAuthToken getSqlFedAuthTokenInteractive(SqlFedAuthInfo fedAuthInfo, String user,\n+            String authenticationString) throws SQLServerException {\n+        ExecutorService executorService = Executors.newFixedThreadPool(1);\n+\n+        try {\n+            PublicClientApplication pca = PublicClientApplication\n+                    .builder(ActiveDirectoryAuthentication.JDBC_FEDAUTH_CLIENT_ID).executorService(executorService)\n+                    .setTokenCacheAccessAspect(PersistentTokenCacheAccessAspect.getInstance())\n+                    .authority(fedAuthInfo.stsurl).logPii((logger.isLoggable(Level.FINE)) ? true : false).build();\n+\n+            CompletableFuture<IAuthenticationResult> future = null;\n+            IAuthenticationResult authenticationResult = null;\n+\n+            // try to acquire token silently if user account found in cache\n+            try {\n+                Set<IAccount> accountsInCache = pca.getAccounts().join();\n+                if (null != accountsInCache && !accountsInCache.isEmpty() && null != user && !user.isEmpty()) {\n+                    IAccount account = getAccountByUsername(accountsInCache, user);\n+                    if (null != account) {\n+                        if (logger.isLoggable(Level.FINE)) {\n+                            logger.fine(logger.toString() + \"Silent authentication for user:\" + user);\n+                        }\n+                        SilentParameters silentParameters = SilentParameters\n+                                .builder(Collections.singleton(fedAuthInfo.spn + \"/.default\"), account).build();\n+\n+                        future = pca.acquireTokenSilently(silentParameters);\n+                    }\n+                }\n+            } catch (MsalInteractionRequiredException e) {\n+                // not an error, need to get token interactively\n+            }\n+\n+            if (null != future) {\n+                authenticationResult = future.get();\n+            } else {\n+                // acquire token interactively with system browser\n+                if (logger.isLoggable(Level.FINE)) {\n+                    logger.fine(logger.toString() + \"Interactive authentication\");\n+                }\n+                InteractiveRequestParameters parameters = InteractiveRequestParameters.builder(new URI(REDIRECTURI))\n+                        .systemBrowserOptions(SystemBrowserOptions.builder()\n+                                .htmlMessageSuccess(SQLServerResource.getResource(\"R_MSALAuthComplete\")).build())\n+                        .loginHint(user).scopes(Collections.singleton(fedAuthInfo.spn + \"/.default\")).build();\n+\n+                future = pca.acquireToken(parameters);\n+                authenticationResult = future.get();\n+            }\n+\n+            return new SqlFedAuthToken(authenticationResult.accessToken(), authenticationResult.expiresOnDate());\n+        } catch (MalformedURLException | InterruptedException | URISyntaxException e) {\n+            throw new SQLServerException(e.getMessage(), e);\n+        } catch (ExecutionException e) {\n+            throw getCorrectedException(e, user, authenticationString);\n+        } finally {\n+            executorService.shutdown();\n+        }\n+    }\n+\n+    // Helper function to return account containing user name from set of accounts, or null if no match\n+    private static IAccount getAccountByUsername(Set<IAccount> accounts, String username) {\n+        if (!accounts.isEmpty()) {\n+            for (IAccount account : accounts) {\n+                if (account.username().equals(username)) {\n+                    return account;\n+                }\n+            }\n+        }\n+        return null;\n+    }", "originalCommit": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTIxNjQ5OA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r531216498", "bodyText": "accounts is the set of accounts in cache, which could be and would be null on 1st connection.", "author": "lilgreenbird", "createdAt": "2020-11-26T20:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2MTExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU5ODc1NA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r530598754", "bodyText": "This doesn't make sense? The class is a singleton and this is a static method. Shouldn't this be\nif (null != instance && null != instance.cache && !instance.cache.isEmpty()) {\n    instance.cache = null;\n}", "author": "rene-ye", "createdAt": "2020-11-25T19:27:22Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/PersistentTokenCacheAccessAspect.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.microsoft.aad.msal4j.ITokenCacheAccessAspect;\n+import com.microsoft.aad.msal4j.ITokenCacheAccessContext;\n+\n+\n+/**\n+ * Access aspect for accessing the token cache.\n+ * \n+ * MSAL token cache does not persist beyond lifetime of the application. This class implements the\n+ * ITokenCacheAccessAspect interface to persist the token cache between application instances so subsequent\n+ * authentications can use silent authentication if the user account is in the token cache.\n+ * \n+ * @see <a href=\"https://aka.ms/msal4j-token-cache\">https://aka.ms/msal4j-token-cache</a>\n+ */\n+class PersistentTokenCacheAccessAspect implements ITokenCacheAccessAspect {\n+    private static PersistentTokenCacheAccessAspect instance = null;\n+\n+    private PersistentTokenCacheAccessAspect() {};\n+\n+    static PersistentTokenCacheAccessAspect getInstance() {\n+        if (null == instance) {\n+            instance = new PersistentTokenCacheAccessAspect();\n+        }\n+        return instance;\n+    }\n+\n+    /**\n+     * Token cache in JSON format\n+     */\n+    private static String cache = null;\n+\n+    @Override\n+    public synchronized void beforeCacheAccess(ITokenCacheAccessContext iTokenCacheAccessContext) {\n+        if (null != cache && null != iTokenCacheAccessContext && null != iTokenCacheAccessContext.tokenCache()) {\n+            iTokenCacheAccessContext.tokenCache().deserialize(cache);\n+        }\n+    }\n+\n+    @Override\n+    public synchronized void afterCacheAccess(ITokenCacheAccessContext iTokenCacheAccessContext) {\n+        if (null != iTokenCacheAccessContext && null != iTokenCacheAccessContext.tokenCache()\n+                && iTokenCacheAccessContext.hasCacheChanged()) {\n+            cache = iTokenCacheAccessContext.tokenCache().serialize();\n+        }\n+    }\n+\n+    /**\n+     * Clears token cache. This will clear all account info so interactive login will be required on the next request to\n+     * acquire an access token.\n+     */\n+    public static void clearUserTokenCache() {\n+        if (null != cache && !cache.isEmpty()) {\n+            cache = null;\n+        }", "originalCommit": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU5OTY0NQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r530599645", "bodyText": "This object should not be static in the context of a Singleton class.", "author": "rene-ye", "createdAt": "2020-11-25T19:29:20Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/PersistentTokenCacheAccessAspect.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.microsoft.aad.msal4j.ITokenCacheAccessAspect;\n+import com.microsoft.aad.msal4j.ITokenCacheAccessContext;\n+\n+\n+/**\n+ * Access aspect for accessing the token cache.\n+ * \n+ * MSAL token cache does not persist beyond lifetime of the application. This class implements the\n+ * ITokenCacheAccessAspect interface to persist the token cache between application instances so subsequent\n+ * authentications can use silent authentication if the user account is in the token cache.\n+ * \n+ * @see <a href=\"https://aka.ms/msal4j-token-cache\">https://aka.ms/msal4j-token-cache</a>\n+ */\n+class PersistentTokenCacheAccessAspect implements ITokenCacheAccessAspect {\n+    private static PersistentTokenCacheAccessAspect instance = null;\n+\n+    private PersistentTokenCacheAccessAspect() {};\n+\n+    static PersistentTokenCacheAccessAspect getInstance() {\n+        if (null == instance) {\n+            instance = new PersistentTokenCacheAccessAspect();\n+        }\n+        return instance;\n+    }\n+\n+    /**\n+     * Token cache in JSON format\n+     */\n+    private static String cache = null;", "originalCommit": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYwODU2MA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r530608560", "bodyText": "This should be Executors.newSingleThreadExecutor().", "author": "rene-ye", "createdAt": "2020-11-25T19:48:23Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerMSAL4JUtils.java", "diffHunk": "@@ -16,37 +18,43 @@\n import java.util.concurrent.ExecutorService;\n import java.util.concurrent.Executors;\n import java.util.logging.Level;\n-\n import javax.security.auth.kerberos.KerberosPrincipal;\n-\n+import com.microsoft.aad.msal4j.IAccount;\n import com.microsoft.aad.msal4j.ClientCredentialFactory;\n import com.microsoft.aad.msal4j.ClientCredentialParameters;\n import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n import com.microsoft.aad.msal4j.IAuthenticationResult;\n import com.microsoft.aad.msal4j.IClientCredential;\n import com.microsoft.aad.msal4j.IntegratedWindowsAuthenticationParameters;\n+import com.microsoft.aad.msal4j.InteractiveRequestParameters;\n+import com.microsoft.aad.msal4j.MsalInteractionRequiredException;\n import com.microsoft.aad.msal4j.PublicClientApplication;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import com.microsoft.aad.msal4j.SystemBrowserOptions;\n import com.microsoft.aad.msal4j.UserNamePasswordParameters;\n import com.microsoft.sqlserver.jdbc.SQLServerConnection.ActiveDirectoryAuthentication;\n+\n import com.microsoft.sqlserver.jdbc.SQLServerConnection.SqlFedAuthInfo;\n \n \n class SQLServerMSAL4JUtils {\n \n+    static final String REDIRECTURI = \"http://localhost\";\n+\n     static final private java.util.logging.Logger logger = java.util.logging.Logger\n             .getLogger(\"com.microsoft.sqlserver.jdbc.SQLServerMSAL4JUtils\");\n \n     static SqlFedAuthToken getSqlFedAuthToken(SqlFedAuthInfo fedAuthInfo, String user, String password,\n             String authenticationString) throws SQLServerException {\n         ExecutorService executorService = Executors.newFixedThreadPool(1);", "originalCommit": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYwOTgyNQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r530609825", "bodyText": "Please use Executors.newSingleThreadExecutor().", "author": "rene-ye", "createdAt": "2020-11-25T19:51:10Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerMSAL4JUtils.java", "diffHunk": "@@ -119,6 +127,76 @@ static SqlFedAuthToken getSqlFedAuthTokenIntegrated(SqlFedAuthInfo fedAuthInfo,\n         }\n     }\n \n+    static SqlFedAuthToken getSqlFedAuthTokenInteractive(SqlFedAuthInfo fedAuthInfo, String user,\n+            String authenticationString) throws SQLServerException {\n+        ExecutorService executorService = Executors.newFixedThreadPool(1);", "originalCommit": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYxMjExMg==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r530612112", "bodyText": "If this is changed to:\nprivate static PersistentTokenCacheAccessAspect instance = new PersistentTokenCacheAccessAspect();\nwe can avoid a few null checks. Mainly the ones in the static methods.", "author": "rene-ye", "createdAt": "2020-11-25T19:56:02Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/PersistentTokenCacheAccessAspect.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.microsoft.aad.msal4j.ITokenCacheAccessAspect;\n+import com.microsoft.aad.msal4j.ITokenCacheAccessContext;\n+\n+\n+/**\n+ * Access aspect for accessing the token cache.\n+ * \n+ * MSAL token cache does not persist beyond lifetime of the application. This class implements the\n+ * ITokenCacheAccessAspect interface to persist the token cache between application instances so subsequent\n+ * authentications can use silent authentication if the user account is in the token cache.\n+ * \n+ * @see <a href=\"https://aka.ms/msal4j-token-cache\">https://aka.ms/msal4j-token-cache</a>\n+ */\n+class PersistentTokenCacheAccessAspect implements ITokenCacheAccessAspect {\n+    private static PersistentTokenCacheAccessAspect instance = null;", "originalCommit": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYxMzYwMQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r530613601", "bodyText": "I would reorder this to\nif (null != iTokenCacheAccessContext && iTokenCacheAccessContext.hasCacheChanged()\n        && null != iTokenCacheAccessContext.tokenCache())\nsince we want to know if the cache has changed first, and then if it has, then we need to do a null check on the token cache so we can call .serialize().", "author": "rene-ye", "createdAt": "2020-11-25T19:59:17Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/PersistentTokenCacheAccessAspect.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.microsoft.aad.msal4j.ITokenCacheAccessAspect;\n+import com.microsoft.aad.msal4j.ITokenCacheAccessContext;\n+\n+\n+/**\n+ * Access aspect for accessing the token cache.\n+ * \n+ * MSAL token cache does not persist beyond lifetime of the application. This class implements the\n+ * ITokenCacheAccessAspect interface to persist the token cache between application instances so subsequent\n+ * authentications can use silent authentication if the user account is in the token cache.\n+ * \n+ * @see <a href=\"https://aka.ms/msal4j-token-cache\">https://aka.ms/msal4j-token-cache</a>\n+ */\n+class PersistentTokenCacheAccessAspect implements ITokenCacheAccessAspect {\n+    private static PersistentTokenCacheAccessAspect instance = null;\n+\n+    private PersistentTokenCacheAccessAspect() {};\n+\n+    static PersistentTokenCacheAccessAspect getInstance() {\n+        if (null == instance) {\n+            instance = new PersistentTokenCacheAccessAspect();\n+        }\n+        return instance;\n+    }\n+\n+    /**\n+     * Token cache in JSON format\n+     */\n+    private static String cache = null;\n+\n+    @Override\n+    public synchronized void beforeCacheAccess(ITokenCacheAccessContext iTokenCacheAccessContext) {\n+        if (null != cache && null != iTokenCacheAccessContext && null != iTokenCacheAccessContext.tokenCache()) {\n+            iTokenCacheAccessContext.tokenCache().deserialize(cache);\n+        }\n+    }\n+\n+    @Override\n+    public synchronized void afterCacheAccess(ITokenCacheAccessContext iTokenCacheAccessContext) {\n+        if (null != iTokenCacheAccessContext && null != iTokenCacheAccessContext.tokenCache()\n+                && iTokenCacheAccessContext.hasCacheChanged()) {", "originalCommit": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYxNjI1Mw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r530616253", "bodyText": "This test currently exists for raw code coverage, and if the if blocks return false, it doesn't even really give codecov. Is there a meaningful way for us to verify whether the cache has been serialized/deserialized after calling the before/after CacheAccess methods?", "author": "rene-ye", "createdAt": "2020-11-25T20:04:49Z", "path": "src/test/java/com/microsoft/sqlserver/jdbc/SQLServerConnectionTest.java", "diffHunk": "@@ -861,4 +864,18 @@ public void testConnectionPoolProxyWithLobs() throws SQLException, IOException {\n             assertTrue(data.equals(received), \"Expected String: \" + data + \"\\nReceived String: \" + received);\r\n         }\r\n     }\r\n+\r\n+    /*\r\n+     * Test PersistentTokenCacheAccessAspect methods\r\n+     */\r\n+    @Test\r\n+    public void testPersistentTokenCacheAccessAspect() throws SQLException {\r\n+        TokenCacheAccessContext tokenCacheAccessContext = TokenCacheAccessContext.builder().clientId(null)\r\n+                .tokenCache(new TokenCache()).account(null).hasCacheChanged(true).build();\r\n+\r\n+        PersistentTokenCacheAccessAspect persistentTokenAspect = PersistentTokenCacheAccessAspect.getInstance();\r\n+        persistentTokenAspect.afterCacheAccess(tokenCacheAccessContext);\r\n+        persistentTokenAspect.beforeCacheAccess(tokenCacheAccessContext);\r\n+        PersistentTokenCacheAccessAspect.clearUserTokenCache();\r\n+    }\r", "originalCommit": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTIxOTEyNw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r531219127", "bodyText": "that requires interactive testing, currently can only do timeout tests in junit. Added comment in header", "author": "lilgreenbird", "createdAt": "2020-11-26T20:45:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYxNjI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYxNjg5OQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r530616899", "bodyText": "Please make sure newlines exist at the end of every new file. I'm not sure if it's already done and Github is just not showing it in the changes. If so, just resolve this comment.", "author": "rene-ye", "createdAt": "2020-11-25T20:06:15Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/PersistentTokenCacheAccessAspect.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.microsoft.aad.msal4j.ITokenCacheAccessAspect;\n+import com.microsoft.aad.msal4j.ITokenCacheAccessContext;\n+\n+\n+/**\n+ * Access aspect for accessing the token cache.\n+ * \n+ * MSAL token cache does not persist beyond lifetime of the application. This class implements the\n+ * ITokenCacheAccessAspect interface to persist the token cache between application instances so subsequent\n+ * authentications can use silent authentication if the user account is in the token cache.\n+ * \n+ * @see <a href=\"https://aka.ms/msal4j-token-cache\">https://aka.ms/msal4j-token-cache</a>\n+ */\n+class PersistentTokenCacheAccessAspect implements ITokenCacheAccessAspect {\n+    private static PersistentTokenCacheAccessAspect instance = null;\n+\n+    private PersistentTokenCacheAccessAspect() {};\n+\n+    static PersistentTokenCacheAccessAspect getInstance() {\n+        if (null == instance) {\n+            instance = new PersistentTokenCacheAccessAspect();\n+        }\n+        return instance;\n+    }\n+\n+    /**\n+     * Token cache in JSON format\n+     */\n+    private static String cache = null;\n+\n+    @Override\n+    public synchronized void beforeCacheAccess(ITokenCacheAccessContext iTokenCacheAccessContext) {\n+        if (null != cache && null != iTokenCacheAccessContext && null != iTokenCacheAccessContext.tokenCache()) {\n+            iTokenCacheAccessContext.tokenCache().deserialize(cache);\n+        }\n+    }\n+\n+    @Override\n+    public synchronized void afterCacheAccess(ITokenCacheAccessContext iTokenCacheAccessContext) {\n+        if (null != iTokenCacheAccessContext && null != iTokenCacheAccessContext.tokenCache()\n+                && iTokenCacheAccessContext.hasCacheChanged()) {\n+            cache = iTokenCacheAccessContext.tokenCache().serialize();\n+        }\n+    }\n+\n+    /**\n+     * Clears token cache. This will clear all account info so interactive login will be required on the next request to\n+     * acquire an access token.\n+     */\n+    public static void clearUserTokenCache() {\n+        if (null != cache && !cache.isEmpty()) {\n+            cache = null;\n+        }\n+    }\n+}", "originalCommit": "76407e2bc52c8af4f41ebfe55526549191b3ec47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7e5139aca7d869c49f0ae122eb18f20b41cded92", "url": "https://github.com/microsoft/mssql-jdbc/commit/7e5139aca7d869c49f0ae122eb18f20b41cded92", "message": "review updates", "committedDate": "2020-11-26T20:43:25Z", "type": "commit"}, {"oid": "cedceaf1148d5e4458917f2d8c9cc1f22a35cccf", "url": "https://github.com/microsoft/mssql-jdbc/commit/cedceaf1148d5e4458917f2d8c9cc1f22a35cccf", "message": "formatting", "committedDate": "2020-11-26T20:52:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI0MjMyNw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r531242327", "bodyText": "Remove these changes", "author": "ulvii", "createdAt": "2020-11-26T22:31:32Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "diffHunk": "@@ -2052,7 +2054,13 @@ else if (null != (trustStoreFileName = System.getProperty(\"javax.net.ssl.trustSt\n \n     final int read(byte[] data, int offset, int length) throws SQLServerException {\n         try {\n+            // System.out.println(\"socket timeout:\"+ tcpSocket.getSoTimeout());", "originalCommit": "cedceaf1148d5e4458917f2d8c9cc1f22a35cccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI0NzAxMQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1464#discussion_r531247011", "bodyText": "oops", "author": "lilgreenbird", "createdAt": "2020-11-26T22:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI0MjMyNw=="}], "type": "inlineReview"}, {"oid": "bd428b239790301af35a0390bfae62f04926f316", "url": "https://github.com/microsoft/mssql-jdbc/commit/bd428b239790301af35a0390bfae62f04926f316", "message": "removed debug lines", "committedDate": "2020-11-26T22:54:57Z", "type": "commit"}, {"oid": "7c166bf64ca09040ada4c1700100fbd05f8022ac", "url": "https://github.com/microsoft/mssql-jdbc/commit/7c166bf64ca09040ada4c1700100fbd05f8022ac", "message": "merged", "committedDate": "2020-11-27T23:11:42Z", "type": "commit"}]}