{"pr_number": 5932, "pr_title": "6399 Persona editing functionality", "pr_createdAt": "2020-06-02T15:05:35Z", "pr_url": "https://github.com/sleuthkit/autopsy/pull/5932", "timeline": [{"oid": "7d1813476a46c2acd040b0c5ff73ca98c0a77fd4", "url": "https://github.com/sleuthkit/autopsy/commit/7d1813476a46c2acd040b0c5ff73ca98c0a77fd4", "message": "6399 Persona editing functionality", "committedDate": "2020-06-02T14:59:56Z", "type": "commit"}, {"oid": "a456905d2d63dd13361faee4edc53781dcb47323", "url": "https://github.com/sleuthkit/autopsy/commit/a456905d2d63dd13361faee4edc53781dcb47323", "message": "6399 Renaming", "committedDate": "2020-06-02T16:28:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MjEzOQ==", "url": "https://github.com/sleuthkit/autopsy/pull/5932#discussion_r434172139", "bodyText": "Is this deleting the PersonAccount row with the given id? Or is it removing the Persona account row corresponding to the given persona and account (id)?\nIf former, then it shouldn't need the Persona argument.  And the id param documentation should say its a row id in the persona_account table.  If latter then the query should also use the persona id in the WHERE clause.", "author": "raman-bt", "createdAt": "2020-06-02T20:59:11Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/PersonaAccount.java", "diffHunk": "@@ -238,7 +289,21 @@ public void process(ResultSet rs) throws CentralRepoException, SQLException {\n \n         return queryCallback.getPersonaAccountsList();\n     }\n-    \n+\n+    /**\n+     * Removes an account from the specified Persona.\n+     *\n+     * @param persona Persona for which the account is being removed.\n+     * @param id row id for the account to be removed\n+     *\n+     * @throws CentralRepoException If there is an error in removing the\n+     * account.\n+     */\n+    static void removePersonaAccount(Persona persona, long id) throws CentralRepoException {", "originalCommit": "a456905d2d63dd13361faee4edc53781dcb47323", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5MDU4NQ==", "url": "https://github.com/sleuthkit/autopsy/pull/5932#discussion_r434190585", "bodyText": "It's the former, and good point. I'll remove the unncessary arg tomorrow and update the doc.", "author": "ethteck", "createdAt": "2020-06-02T21:39:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MjEzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NTEzNQ==", "url": "https://github.com/sleuthkit/autopsy/pull/5932#discussion_r434175135", "bodyText": "Same comment as before.\nSince this is deleting the row with the row id of the alias - it doesn't need the Persona as argument.", "author": "raman-bt", "createdAt": "2020-06-02T21:05:37Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/PersonaAlias.java", "diffHunk": "@@ -103,7 +114,35 @@ static PersonaAlias addPersonaAlias(Persona persona, String alias, String justif\n                 + \")\";\n \n         CentralRepository.getInstance().executeInsertSQL(insertClause);\n-        return new PersonaAlias(persona.getId(), alias, justification, confidence, timeStampMillis, examiner);\n+        \n+        String queryClause = SELECT_QUERY_BASE\n+                + \"WHERE pa.persona_id = \" + persona.getId()\n+                + \" AND pa.alias = \\\"\" + alias + \"\\\"\"\n+                + \" AND pa.date_added = \" + timeStampMillis\n+                + \" AND pa.examiner_id = \" + examiner.getId();\n+        \n+        PersonaAliasesQueryCallback queryCallback = new PersonaAliasesQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+        \n+        Collection<PersonaAlias> aliases = queryCallback.getAliases();\n+        if (aliases.size() != 1) {\n+            throw new CentralRepoException(\"Alias add query failed\");\n+        }\n+        \n+        return aliases.iterator().next();\n+    }\n+    \n+    /**\n+     * Removes an alias from the specified Persona.\n+     *\n+     * @param persona Persona for which the alias is being removed.\n+     * @param alias Alias to remove.\n+     *\n+     * @throws CentralRepoException If there is an error in removing the alias.\n+     */\n+    static void removePersonaAlias(Persona persona, PersonaAlias alias) throws CentralRepoException {\n+        String deleteClause = \" DELETE FROM persona_alias WHERE id = \" + alias.getId();", "originalCommit": "a456905d2d63dd13361faee4edc53781dcb47323", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NjU2Mg==", "url": "https://github.com/sleuthkit/autopsy/pull/5932#discussion_r434176562", "bodyText": "Again, doesn't need persona as argument.", "author": "raman-bt", "createdAt": "2020-06-02T21:08:47Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/PersonaMetadata.java", "diffHunk": "@@ -113,7 +124,36 @@ static PersonaMetadata addPersonaMetadata(long personaId, String name, String va\n                 + \")\";\n \n         CentralRepository.getInstance().executeInsertSQL(insertClause);\n-        return new PersonaMetadata(personaId, name, value, justification, confidence, timeStampMillis, examiner);\n+        \n+        String queryClause = SELECT_QUERY_BASE\n+                + \"WHERE pmd.persona_id = \" + personaId\n+                + \" AND pmd.name = \\\"\" + name + \"\\\"\"\n+                + \" AND pmd.value = \\\"\" + value + \"\\\"\"\n+                + \" AND pmd.date_added = \" + timeStampMillis\n+                + \" AND pmd.examiner_id = \" + examiner.getId();\n+        \n+        PersonaMetadataQueryCallback queryCallback = new PersonaMetadataQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+        \n+        Collection<PersonaMetadata> metadata = queryCallback.getMetadataList();\n+        if (metadata.size() != 1) {\n+            throw new CentralRepoException(\"Metadata add query failed\");\n+        }\n+        \n+        return metadata.iterator().next();\n+    }\n+    \n+    /**\n+     * Removes a metadata from the specified Persona.\n+     *\n+     * @param persona Persona for which the metadata is being removed.\n+     * @param metadata Metadata to remove.\n+     *\n+     * @throws CentralRepoException If there is an error in removing the metadata.\n+     */\n+    static void removePersonaMetadata(Persona persona, PersonaMetadata metadata) throws CentralRepoException {", "originalCommit": "a456905d2d63dd13361faee4edc53781dcb47323", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3ODk0MQ==", "url": "https://github.com/sleuthkit/autopsy/pull/5932#discussion_r434178941", "bodyText": "Based on Brian's reply - I think one account is sufficient to create a persona.", "author": "raman-bt", "createdAt": "2020-06-02T21:13:50Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/persona/PersonaDetailsPanel.java", "diffHunk": "@@ -716,39 +712,41 @@ void setMode(Component parent, PersonaDetailsMode mode, Persona persona) {\n         }\n         initializeFields();\n     }\n-    \n-        @Messages({\n-        \"PersonaDetailsPanel_NotEnoughAccounts_msg=Two or more accounts are necessary to create a persona\",\n+\n+    @Messages({\n+        \"PersonaDetailsPanel_NotEnoughAccounts_msg=A persona needs two or more accounts\",\n         \"PersonaDetailsPanel_NotEnoughAccounts_Title=Not enough accounts\",\n         \"PersonaDetailsPanel_CentralRepoErr_msg=Failure to write to Central Repository\",\n         \"PersonaDetailsPanel_CentralRepoErr_Title=Central Repository failure\",\n         \"PersonaDetailsPanel_EmptyName_msg=Persona name cannot be empty\",\n         \"PersonaDetailsPanel_EmptyName_Title=Empty persona name\",})\n     Persona okHandler() {\n+        if (accountsToAdd.size() + currentAccounts.size() < 2) {", "originalCommit": "a456905d2d63dd13361faee4edc53781dcb47323", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MzQyNA==", "url": "https://github.com/sleuthkit/autopsy/pull/5932#discussion_r434183424", "bodyText": "Based on Brian's response, I think we should also show the persona creation date, examiner, and comment.\nAlso the Persona Creation dialog should have a field for the user to enter a comment.", "author": "raman-bt", "createdAt": "2020-06-02T21:23:11Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/persona/PersonaDetailsPanel.java", "diffHunk": "@@ -535,14 +532,13 @@ private void nameFieldActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIR\n         \"PersonaDetailsPanel_load_exception_msg=Failed to load persona\",})\n     private void loadPersona(Component parent, Persona persona) {\n         String name;\n-        Collection<CentralRepoAccount> accounts;\n+        Collection<PersonaAccount> accounts;\n         Collection<PersonaMetadata> metadata;\n         Collection<PersonaAlias> aliases;\n         Collection<CorrelationCase> cases;\n         try {\n             name = persona.getName();\n-            accounts = persona.getPersonaAccounts().stream().map(PersonaAccount::getAccount)\n-                    .collect(Collectors.toList());\n+            accounts = persona.getPersonaAccounts();", "originalCommit": "a456905d2d63dd13361faee4edc53781dcb47323", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "26a7fb22fdaa84e6529d9eb1ece1f003ea680df0", "url": "https://github.com/sleuthkit/autopsy/commit/26a7fb22fdaa84e6529d9eb1ece1f003ea680df0", "message": "6399 PR comments", "committedDate": "2020-06-03T14:52:08Z", "type": "commit"}, {"oid": "857478e78ad312341313366c4461e63e6772a85f", "url": "https://github.com/sleuthkit/autopsy/commit/857478e78ad312341313366c4461e63e6772a85f", "message": "Merge branch 'develop' into 6399_edit_persona", "committedDate": "2020-06-03T16:35:40Z", "type": "commit"}]}