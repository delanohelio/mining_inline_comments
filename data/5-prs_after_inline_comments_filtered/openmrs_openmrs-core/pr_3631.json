{"pr_number": 3631, "pr_title": "TRUNK-5977 - getPatientOrPromotePerson leading to stack traces under \u2026", "pr_createdAt": "2020-11-06T16:28:26Z", "pr_url": "https://github.com/openmrs/openmrs-core/pull/3631", "timeline": [{"oid": "a899436afb4777b5b98e571418c957185847a44f", "url": "https://github.com/openmrs/openmrs-core/commit/a899436afb4777b5b98e571418c957185847a44f", "message": "TRUNK-5977 - getPatientOrPromotePerson leading to stack traces under some conditions", "committedDate": "2020-11-06T16:27:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIyNTkwNA==", "url": "https://github.com/openmrs/openmrs-core/pull/3631#discussion_r519225904", "bodyText": "Just like the original exception, i would explicitly use WrongClassException instead of the generic Exception.\nSecondly, even with the changes in this pull request, you would still get an UnexpectedRollbackException because of the above call Context.getPatientService().getPatient(patientOrPersonId) which marks the transaction for rollback,  because of the exception. Therefore, you need to either change Context.getPatientService().getPatient(patientOrPersonId) to getPatient(patientOrPersonId) such that it does not run with its new transaction, or add noRollbackFor = WrongClassException.class to the transaction definition for the getPatient(Integer patientId) method.", "author": "dkayiwa", "createdAt": "2020-11-07T22:12:54Z", "path": "api/src/main/java/org/openmrs/api/impl/PatientServiceImpl.java", "diffHunk": "@@ -223,7 +223,7 @@ public Patient getPatientOrPromotePerson(Integer patientOrPersonId) {\n \t\ttry {\n \t\t\tpatient = Context.getPatientService().getPatient(patientOrPersonId);\n \t\t}\n-\t\tcatch (ClassCastException ex) {", "originalCommit": "a899436afb4777b5b98e571418c957185847a44f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5ODg2NA==", "url": "https://github.com/openmrs/openmrs-core/pull/3631#discussion_r519898864", "bodyText": "@dkayiwa , thanks for that insight. I'd love to learn more about this from you.  Conceptually I'm confused about why any method annotated as a read-only transaction would ever result in an UnexpectedRollbackException - isn't the point of a read-only transaction that you want to prevent changes from getting written?  What is there to roll back?\nFrom the perspective of our code, I'm not entirely sure why limiting our exception handling so narrowly will lead to better behavior.  Why not catch all Exceptions here and then attempt to load by person?  What type of error would we be catching that we feel we'd be better off throwing back to the calling code?", "author": "mseaton", "createdAt": "2020-11-09T15:28:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIyNTkwNA=="}], "type": "inlineReview"}, {"oid": "f6d18844f0f6c66147886cd2bf0430a7d1819001", "url": "https://github.com/openmrs/openmrs-core/commit/f6d18844f0f6c66147886cd2bf0430a7d1819001", "message": "TRUNK-5977 - getPatientOrPromotePerson leading to stack traces under some conditions.  This changes the current approach by first loading the person with the given id, and then checking if the returned person is a patient or not.\n\nUnfortunately, none of the unit tests catch the error that this is fixing, but running the refapp with this fix + a related fix to idgen fixes the error case as described on the ticket.", "committedDate": "2020-11-13T17:25:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEwOTkyOQ==", "url": "https://github.com/openmrs/openmrs-core/pull/3631#discussion_r523109929", "bodyText": "@dkayiwa I was able to reproduce the issue and see the same errors that you reporting with my previous fix.  Here is my alternative solution, which fixes the issue for me.  Rather than try to load the patient, and then fall back to loading the person, this first loads the person, and checks to see if that person represents a valid patient or not.  This seems like the more correct behavior anyway, given our inheritance model.\nTo get this working in the refapp, I also needed to apply a related fix to idgen, which I raised a separate PR for, though you could also just disable the idgen module to test this standalone.\nThoughts on this approach?  This is a PR against the 2.3.x branch, which if accepted, we can up-port as needed.", "author": "mseaton", "createdAt": "2020-11-13T17:29:16Z", "path": "api/src/main/java/org/openmrs/api/impl/PatientServiceImpl.java", "diffHunk": "@@ -219,21 +220,17 @@ public Patient getPatient(Integer patientId) throws APIException {\n \t@Override\n \t@Transactional(readOnly = true)\n \tpublic Patient getPatientOrPromotePerson(Integer patientOrPersonId) {", "originalCommit": "f6d18844f0f6c66147886cd2bf0430a7d1819001", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE4NjUyNA==", "url": "https://github.com/openmrs/openmrs-core/pull/3631#discussion_r523186524", "bodyText": "This generally seems correct, but I'd be leery of backporting it if it's just to fix the bug reported in TRUNK-5977... does this manifest itself it somewhere, or is there a reason this bug is more insidious than on might believe. It seems like a bit of an edge case (registering an existing provider or other relationship person as a patient)?\nAnother option would be to just change this to catch the other exception thrown in 2.3.x, and then make the larger change in 2.4.x?", "author": "mogoodrich", "createdAt": "2020-11-13T19:47:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEwOTkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwMzQ5Mw==", "url": "https://github.com/openmrs/openmrs-core/pull/3631#discussion_r523203493", "bodyText": "@mogoodrich - as previous PR comments (now marked as resolved) with @dkayiwa discovered, simply catching the other exception wasn't enough.  There were other exceptions that occurred.\nThe entire reason we are working on this and coding it against 2.3.x is because this is a bug that is manifesting in our soon-to-go-to-production distribution in Rwanda that is running 2.3.2, and we need the fix to go into 2.3.3.", "author": "mseaton", "createdAt": "2020-11-13T20:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEwOTkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwNDQ1NQ==", "url": "https://github.com/openmrs/openmrs-core/pull/3631#discussion_r523204455", "bodyText": "I think this is a more common use case than the ticket might have you believe - as in the Rwanda distribution it is common to create relationships and providers, including CHWs, on the patient dashboard, and then later if/when they become patients to promote these persons to patients via the process described here.", "author": "mseaton", "createdAt": "2020-11-13T20:25:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEwOTkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIxNzIzNA==", "url": "https://github.com/openmrs/openmrs-core/pull/3631#discussion_r523217234", "bodyText": "Okay, fair enough... once we merge this we may actually want to upgrade the PIH EMR to 2.3.x to test...", "author": "mogoodrich", "createdAt": "2020-11-13T20:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEwOTkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzMzQ2Mg==", "url": "https://github.com/openmrs/openmrs-core/pull/3631#discussion_r523233462", "bodyText": "OK, will wait for approval or change requests until Monday and then look to commit.", "author": "mseaton", "createdAt": "2020-11-13T21:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEwOTkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0OTYyNQ==", "url": "https://github.com/openmrs/openmrs-core/pull/3631#discussion_r524249625", "bodyText": "@mseaton your solution is much better than the original code! \ud83d\udc4d", "author": "dkayiwa", "createdAt": "2020-11-16T12:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEwOTkyOQ=="}], "type": "inlineReview"}]}