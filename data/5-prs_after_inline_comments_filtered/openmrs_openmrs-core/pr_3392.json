{"pr_number": 3392, "pr_title": "TRUNK-5817: Migrate web and webapp package tests to Junit 5", "pr_createdAt": "2020-07-22T11:02:19Z", "pr_url": "https://github.com/openmrs/openmrs-core/pull/3392", "timeline": [{"oid": "89b178d5d9bca78a56aae6201e03d148fd7c3e31", "url": "https://github.com/openmrs/openmrs-core/commit/89b178d5d9bca78a56aae6201e03d148fd7c3e31", "message": "TRUNK-5817: Migrate web and webapp package tests to Junit 5", "committedDate": "2020-07-22T17:51:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MDgwMw==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r458980803", "bodyText": "@teleivo  i try to set a changeLogDetective field  ReflectionTestUtils.setField(DatabaseUpdater.class, \"changeLogDetective\", changeLogDetective); but i am getting this error :\njava.lang.IllegalStateException: Could not access method or field: Can not set static final org.openmrs.liquibase.ChangeLogDetective field org.openmrs.util.DatabaseUpdater.changeLogDetective to org.openmrs.liquibase.ChangeLogDetective", "author": "achilep", "createdAt": "2020-07-22T17:59:52Z", "path": "web/src/test/java/org/openmrs/web/filter/update/UpdateFilterModelTest.java", "diffHunk": "@@ -78,18 +75,22 @@ public void createUpdateFilterModel_shouldRequiredAnUpdateIfChangesAreEmptyButDa\n \t        throws Exception {\n \t\tList<OpenMRSChangeSet> changes = new ArrayList<>();\n \t\t\n-\t\twhen(DatabaseUpdater.getUnrunDatabaseChanges(any(LiquibaseProvider.class))).thenReturn(changes);\n-\t\twhen(DatabaseUpdater.isLocked()).thenReturn(false);\n-\t\twhen(DatabaseUpdater.updatesRequired()).thenReturn(true);\n \t\t\n \t\tmodel = new UpdateFilterModel(liquibaseProvider);\n-\t\t\n-\t\tassertTrue(\"should require an update\", model.updateRequired);\n+\t\tFieldUtils.writeField(model, \"updateRequired\", true, true);\n+\t\tFieldUtils.writeField(model, \"changes\", changes, true);\n+\t\tChangeLogDetective changeLogDetective = new ChangeLogDetective();\n+\t\tReflectionTestUtils.setField(DatabaseUpdater.class, \"changeLogDetective\", changeLogDetective);\n+\t\t/*when(DatabaseUpdater.getUnrunDatabaseChanges(any(LiquibaseProvider.class))).thenReturn(changes);\n+\t\twhen(DatabaseUpdater.isLocked()).thenReturn(false);\n+\t\twhen(DatabaseUpdater.updatesRequired()).thenReturn(true);\n+*/\n+\t\tassertTrue(model.updateRequired, \"should require an update\");\n \t\tassertThat(model.changes, is(empty()));\n \t\t\n-\t\tPowerMockito.verifyStatic(DatabaseUpdater.class);\n+\t\tverify(DatabaseUpdater.class);\n \t\tDatabaseUpdater.getUnrunDatabaseChanges(liquibaseProvider);\n-\t\tPowerMockito.verifyStatic(DatabaseUpdater.class);\n+\t\tverify(DatabaseUpdater.class);", "originalCommit": "89b178d5d9bca78a56aae6201e03d148fd7c3e31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4ODIxMg==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r458988212", "bodyText": "cc @ibacher  @mozzy11", "author": "achilep", "createdAt": "2020-07-22T18:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MDgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2MzI2Nw==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r459263267", "bodyText": "its always a good idea to read the javadocs of the methods you are using. if you are talking about the spring reflectionutils then yes the javadoc says it does not support final fields. for these you have to use powermock.reflection you can find a usage in the api package. I think something like Whitebox.set...\nYou will then also need to adjust the dependencies of the web package. Also see the api pom.XML where I added a test score dependency for powermock.reflection and excluded the other 2 powermock dependencies.", "author": "teleivo", "createdAt": "2020-07-23T07:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MDgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM3MTM3Mg==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r459371372", "bodyText": "thanks @teleivo .  i will eventually used whitebox.set. I avoided using it, since we want to remove powermock dependencies.", "author": "achilep", "createdAt": "2020-07-23T11:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MDgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM5MjAwMg==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r459392002", "bodyText": "did you have a look at the api pom? https://github.com/openmrs/openmrs-core/blob/master/api/pom.xml#L24-L45\nI did exclude powermock mockito library and its junit 4 runner in the api package. what we are using is simply the powermock reflection library. since that one allows setting of static final fields.", "author": "teleivo", "createdAt": "2020-07-23T11:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MDgwMw=="}], "type": "inlineReview"}, {"oid": "a8bb03bb32a83d5be48e06a9cd896569fc8ab603", "url": "https://github.com/openmrs/openmrs-core/commit/a8bb03bb32a83d5be48e06a9cd896569fc8ab603", "message": "TRUNK-5817: Migrate web and webapp package tests to Junit 5", "committedDate": "2020-07-25T05:03:46Z", "type": "forcePushed"}, {"oid": "70e405595bce6f2272e210ec7b5638c60a5ee5d1", "url": "https://github.com/openmrs/openmrs-core/commit/70e405595bce6f2272e210ec7b5638c60a5ee5d1", "message": "TRUNK-5817: Migrate web and webapp package tests to Junit 5\n\nTRUNK-5817: Migrate web and webapp package tests to Junit 5", "committedDate": "2020-07-25T05:06:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NjczMw==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r460366733", "bodyText": "i had some error with the database connection that is why i extends BaseContextSensitiveTest", "author": "achilep", "createdAt": "2020-07-25T05:13:37Z", "path": "web/src/test/java/org/openmrs/web/filter/update/UpdateFilterModelTest.java", "diffHunk": "@@ -9,49 +9,50 @@\n  */\n package org.openmrs.web.filter.update;\n \n-import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.List;\n-import org.junit.Before;\n-import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.openmrs.liquibase.LiquibaseProvider;\n-import org.openmrs.util.DatabaseUpdater;\n-import org.openmrs.util.DatabaseUpdater.OpenMRSChangeSet;\n-import org.openmrs.util.DatabaseUpdaterLiquibaseProvider;\n-import org.powermock.api.mockito.PowerMockito;\n-import org.powermock.core.classloader.annotations.PowerMockIgnore;\n-import org.powermock.core.classloader.annotations.PrepareForTest;\n-import org.powermock.modules.junit4.PowerMockRunner;\n-\n import static org.hamcrest.CoreMatchers.is;\n import static org.hamcrest.MatcherAssert.assertThat;\n import static org.hamcrest.collection.IsEmptyCollection.empty;\n-import static org.junit.Assert.assertFalse;\n-import static org.junit.Assert.assertNull;\n-import static org.junit.Assert.assertTrue;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.mockito.Matchers.any;\n import static org.mockito.Mockito.mock;\n import static org.mockito.Mockito.never;\n import static org.mockito.Mockito.times;\n import static org.mockito.Mockito.when;\n \n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mock;\n+import org.openmrs.liquibase.ChangeLogDetective;\n+import org.openmrs.liquibase.ChangeLogVersionFinder;\n+import org.openmrs.liquibase.LiquibaseProvider;\n+import org.openmrs.test.jupiter.BaseContextSensitiveTest;\n+import org.openmrs.util.DatabaseUpdater;\n+import org.openmrs.util.DatabaseUpdater.OpenMRSChangeSet;\n+import org.openmrs.util.DatabaseUpdaterLiquibaseProvider;\n+import org.powermock.api.mockito.PowerMockito;\n+import org.powermock.reflect.Whitebox;\n+\n /**\n  * Tests {@link UpdateFilterModel}.\n  */\n-@RunWith(PowerMockRunner.class)\n-@PrepareForTest(DatabaseUpdater.class)\n-@PowerMockIgnore({ \"com.sun.org.apache.xerces.*\", \"javax.xml.*\", \"org.xml.*\", \"javax.management.*\", \"org.w3c.dom.*\" })\n-public class UpdateFilterModelTest {\n+public class UpdateFilterModelTest  extends BaseContextSensitiveTest {", "originalCommit": "70e405595bce6f2272e210ec7b5638c60a5ee5d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r460367099", "bodyText": "the error is with this method . i have some difficulty to manipulate the behavior of this method .", "author": "achilep", "createdAt": "2020-07-25T05:18:04Z", "path": "web/src/test/java/org/openmrs/web/filter/update/UpdateFilterModelTest.java", "diffHunk": "@@ -77,19 +78,20 @@ public void createUpdateFilterModel_shouldrequireAnUpdateAndSetChangesToUnrunDat\n \tpublic void createUpdateFilterModel_shouldRequiredAnUpdateIfChangesAreEmptyButDatabaseUpdaterDoesRequireAnUpdate()\n \t        throws Exception {\n \t\tList<OpenMRSChangeSet> changes = new ArrayList<>();\n-\t\t\n-\t\twhen(DatabaseUpdater.getUnrunDatabaseChanges(any(LiquibaseProvider.class))).thenReturn(changes);\n-\t\twhen(DatabaseUpdater.isLocked()).thenReturn(false);\n-\t\twhen(DatabaseUpdater.updatesRequired()).thenReturn(true);\n-\t\t\n+\n+\t\tChangeLogDetective changeLogDetective = new ChangeLogDetective();\n+\t\tChangeLogVersionFinder changeLogVersionFinder = new ChangeLogVersionFinder();\n+\t\t\t\t\n \t\tmodel = new UpdateFilterModel(liquibaseProvider);\n+\t\tFieldUtils.writeField(model, \"updateRequired\", true, true);\n+\t\tFieldUtils.writeField(model, \"changes\", changes, true);\n+\t\tFieldUtils.writeField(changeLogDetective, \"changeLogVersionFinder\", changeLogVersionFinder, true);\n+\t\tWhitebox.setInternalState(DatabaseUpdater.class, \"changeLogDetective\", changeLogDetective);\n \t\t\n-\t\tassertTrue(\"should require an update\", model.updateRequired);\n+\t\tassertTrue(model.updateRequired, \"should require an update\");\n \t\tassertThat(model.changes, is(empty()));\n \t\t\n-\t\tPowerMockito.verifyStatic(DatabaseUpdater.class);\n \t\tDatabaseUpdater.getUnrunDatabaseChanges(liquibaseProvider);", "originalCommit": "70e405595bce6f2272e210ec7b5638c60a5ee5d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzQwNA==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r460367404", "bodyText": "java.lang.IllegalStateException: identifying the snapshot version that had been used to initialize the OpenMRS database failed as no candidate change set resulted in zero un-run changes", "author": "achilep", "createdAt": "2020-07-25T05:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2Nzk5MQ==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r460367991", "bodyText": "the exception is cause by this line\n\n  \n    \n      openmrs-core/api/src/main/java/org/openmrs/liquibase/ChangeLogDetective.java\n    \n    \n         Line 116\n      in\n      02ba3ae\n    \n    \n    \n    \n\n        \n          \n           throw new IllegalStateException( \n        \n    \n  \n\n\ni have try to solve the error with this FieldUtils.writeField(changeLogDetective, \"changeLogVersionFinder\", changeLogVersionFinder, true); but it did  not work", "author": "achilep", "createdAt": "2020-07-25T05:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwNzI0Mw==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r460407243", "bodyText": "@WolfSchlegel can you help us out here. So with JUnit 5 PowerMock and thus mocking static methods does not work anymore. We are migrating all test to JUnit 5. This might be the last one we have to migrate. What we can do is use reflection to set static fields. Can you help us out with replacing powermock in this test with reflection so we keep its original intent.", "author": "teleivo", "createdAt": "2020-07-25T13:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwNzM4Mg==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r462407382", "bodyText": "Looking into this and apologies for the delay...\norg/openmrs/web/filter/update/UpdateFilterModelTest.java is a unit test and extending BaseContextSensitiveTest makes it an integration test. I would advise against that and would revert that change first.\nIn the context of https://issues.openmrs.org/browse/TRUNK-4830 I wrote a few new integration tests and found that tests based on BaseContextSensitiveTestare not well isolated and understanding the behaviour of individual tests was quite hard. Eventually I created a new base class for integration tests.\n@achilep could you please change the test so that it is a unit test again and ping me when this is done?\nThank you,\nWolf", "author": "WolfSchlegel", "createdAt": "2020-07-29T15:54:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM2ODQ1Ng==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r463368456", "bodyText": "sorry @WolfSchlegel for the delay . i restarted every thing back . this is the initial change .", "author": "achilep", "createdAt": "2020-07-31T02:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYzMjA1Mg==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r463632052", "bodyText": "Thanks, I have a look", "author": "WolfSchlegel", "createdAt": "2020-07-31T14:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYwNjU1Mg==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r464606552", "bodyText": "Hey there,\nplease have a look at WolfSchlegel@6a08797.\nI introduced a wrapper for the (mostly static) org/openmrs/util/DatabaseUpdater.java class so that PowerMock is no longer needed for mocking it. This is good news for org/openmrs/web/filter/update/UpdateFilterModelTest.java.\nHowever, this comes at a cost as the next question is how to unit test the new wrapper without resorting to PowerMock. I gave JMockit a short try but bumped into issues that are (allegedly) resolved by rearranging the order of dependencies in the pom file (yuck) and it seems a java agent needs to be registered as well for JMockit (yuck-ish).\nSo I am back at square one looking for a unit test that proves that the all new org/openmrs/util/DatabaseUpdaterWrapper.java class plays nicely with the incumbent org/openmrs/util/DatabaseUpdater.java class.\nTo be frank, I am not sure how Java reflections or respective Spring utilities help here. At the end of the day I need to verify that the wrapper calls the (static) methods. For this purpose I introduced some static helper variables and a helper method in org/openmrs/util/DatabaseUpdater.java.\nPlease have a look and let me know what you think. I believe we are facing a trade-off between not testing something and adding test helpers in production code.", "author": "WolfSchlegel", "createdAt": "2020-08-03T19:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg0NDc3OA==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r464844778", "bodyText": "thank you @WolfSchlegel !\nI think your suggestion for adding a wrapper is good. I added a suggestion in the code at the commit you sent.\nOur goal with the UpdateModelFilterTest is to test that the filter makes sure updates are made. Your wrapper enables us to do just that. The update logic should be tested else were.\nI am ok with not testing the wrapper as its super thin. This tradeoff is also ok for me since it enables us to remove powermock which hopefully forces us to rethink our designs going forward. The proliferation of static methods with side effects in the code base are a sign of bad design for me that circumvent springs dependency injection and harm testability.\nCan you please bring in your changes while keeping the UpdateModelFilterTest a JUnit 4 test. We can chat about my suggestion on the code. @achilep  will then do the migration to JUnit 5 once the changes are merged.", "author": "teleivo", "createdAt": "2020-08-04T07:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk1MjgwMQ==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r464952801", "bodyText": "thanks @WolfSchlegel", "author": "achilep", "createdAt": "2020-08-04T10:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk1OTY2OQ==", "url": "https://github.com/openmrs/openmrs-core/pull/3392#discussion_r464959669", "bodyText": "Thanks for your feedback, @teleivo .\nI removed the hand-rolled verification from the DatabaseUpdater class and moved the new wrapper to the same package that contains the UpdateFilterModel class. Making the wrapper package-private resulted in flaky Mockito behaviour when running mvn clean install so the wrapper continues to be a public class.\nI created this pull request which is based on the current OpenMRS master. If you do not want to get an implicit rebase against master in mid flight, best cherry pick the relevant changes from here.\nPlease let me know if there is anything else I can do.", "author": "WolfSchlegel", "createdAt": "2020-08-04T10:39:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NzA5OQ=="}], "type": "inlineReview"}, {"oid": "607e1aa3a01f25f76cf4880118cd946ca99d2269", "url": "https://github.com/openmrs/openmrs-core/commit/607e1aa3a01f25f76cf4880118cd946ca99d2269", "message": "TRUNK-5817: Migrate web and webapp package tests to Junit 5", "committedDate": "2020-07-31T02:04:02Z", "type": "forcePushed"}, {"oid": "9fbdffc848d0097e8e36791b3fc502ff5d86aa2c", "url": "https://github.com/openmrs/openmrs-core/commit/9fbdffc848d0097e8e36791b3fc502ff5d86aa2c", "message": "TRUNK-5817 add wrapper for the DatabaseUpdater class to support mocking without PowerMock", "committedDate": "2020-08-04T17:51:22Z", "type": "commit"}, {"oid": "9fbdffc848d0097e8e36791b3fc502ff5d86aa2c", "url": "https://github.com/openmrs/openmrs-core/commit/9fbdffc848d0097e8e36791b3fc502ff5d86aa2c", "message": "TRUNK-5817 add wrapper for the DatabaseUpdater class to support mocking without PowerMock", "committedDate": "2020-08-04T17:51:22Z", "type": "forcePushed"}]}