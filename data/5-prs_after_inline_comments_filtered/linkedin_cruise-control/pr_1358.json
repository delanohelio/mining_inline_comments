{"pr_number": 1358, "pr_title": "Check whether a cluster is using JBOD when populate_disk_info is true", "pr_createdAt": "2020-10-16T23:14:28Z", "pr_url": "https://github.com/linkedin/cruise-control/pull/1358", "timeline": [{"oid": "cb1ed78a650c141ccae3e24d171b9db3c3318c58", "url": "https://github.com/linkedin/cruise-control/commit/cb1ed78a650c141ccae3e24d171b9db3c3318c58", "message": "Check whether a cluster is using JBOD when populate_disk_info is true", "committedDate": "2020-10-16T23:11:25Z", "type": "commit"}, {"oid": "5ccd70883c090551a6f4f35c20342052ed993b39", "url": "https://github.com/linkedin/cruise-control/commit/5ccd70883c090551a6f4f35c20342052ed993b39", "message": "Removed an unused import", "committedDate": "2020-10-16T23:19:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MjA1Mg==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506772052", "bodyText": "Can we add a JavaDoc?\nNit: _diskByLogdir.size() > 1 -> !_diskByLogdir.isEmpty()", "author": "efeg", "createdAt": "2020-10-17T00:33:17Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/model/Broker.java", "diffHunk": "@@ -202,6 +202,10 @@ public boolean isAlive() {\n     return _state != State.DEAD;\n   }\n \n+  public boolean isUsingJBOD() {\n+    return _diskByLogdir.size() > 1;", "originalCommit": "5ccd70883c090551a6f4f35c20342052ed993b39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4MTYwNw==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506781607", "bodyText": "If we use !_diskByLogdir.isEmpty(), does that mean that the broker is using JBOD if and only if _diskByLogdir is NOT empty?\nI thought _diskByLogdir.size() == 1 means that the broker is using non-JBOD and _diskByLogdir .size() > 1  means that the broker is using JBOD. I am not sure what it means if _diskByLogdir.isEmpty()", "author": "Lincong", "createdAt": "2020-10-17T02:05:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MjA1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4NDEwOA==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506784108", "bodyText": "If we use !_diskByLogdir.isEmpty(), does that mean that the broker is using JBOD if and only if _diskByLogdir is NOT empty?\n\nCorrect -- please see how we _diskByLogdir is initialized in constructor.\nNote that if a broker has 1 disk (i.e. non-JBOD), then the cluster model does not add another layer of abstraction -- i.e. keeps track of replicas per broker as opposed to replicas per disk in the broker, which would always be the same disk/logDir in a non-JBOD broker.", "author": "efeg", "createdAt": "2020-10-17T02:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MjA1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4NzQ1Nw==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506787457", "bodyText": "Got it. Thanks", "author": "Lincong", "createdAt": "2020-10-17T03:19:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MjA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MzA0MA==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506773040", "bodyText": "Can we avoid checking _populateDiskInfo here again -- i.e. can't we do the following?\n} else if (!isClusterUsingJBOD()) {\n   ...\n}", "author": "efeg", "createdAt": "2020-10-17T00:40:57Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/servlet/handler/async/runnable/LoadRunnable.java", "diffHunk": "@@ -64,13 +66,29 @@ protected BrokerStats getResult() throws Exception {\n         return cachedBrokerStats;\n       }\n     }\n+    if (_populateDiskInfo && !isClusterUsingJBOD()) {", "originalCommit": "5ccd70883c090551a6f4f35c20342052ed993b39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4MDk2OQ==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506780969", "bodyText": "Good idea!", "author": "Lincong", "createdAt": "2020-10-17T01:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MzA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MzE3NQ==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506773175", "bodyText": "Nit: extra space.", "author": "efeg", "createdAt": "2020-10-17T00:42:04Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/servlet/handler/async/runnable/LoadRunnable.java", "diffHunk": "@@ -64,13 +66,29 @@ protected BrokerStats getResult() throws Exception {\n         return cachedBrokerStats;\n       }\n     }\n+    if (_populateDiskInfo && !isClusterUsingJBOD()) {\n+      throw new UserRequestException(\"populate_disk_info = true when Kafka cluster is NOT using JBOD\");\n+    }\n+\n     if (_start != DEFAULT_START_TIME_FOR_CLUSTER_MODEL) {\n       return clusterModel(_modelCompletenessRequirements.minMonitoredPartitionsPercentage()).brokerStats(_kafkaCruiseControl.config());\n     } else {\n       return clusterModelFromEarliest().brokerStats(_kafkaCruiseControl.config());\n     }\n   }\n \n+  private boolean isClusterUsingJBOD() throws Exception {\n+    ClusterModel clusterModel = _kafkaCruiseControl.loadMonitor().clusterCapacity();\n+    // If and only if all brokers in the cluster are using JBOD, the cluster is considered to be using JBOD\n+    for (Broker broker : clusterModel.brokers()) {\n+      if (!broker.isUsingJBOD()) {\n+        return false;\n+      }\n+    }\n+    return true;\n+  }\n+\n+", "originalCommit": "5ccd70883c090551a6f4f35c20342052ed993b39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4MTAwMA==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506781000", "bodyText": "Fixed", "author": "Lincong", "createdAt": "2020-10-17T01:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MzE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3NDE3OA==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506774178", "bodyText": "Can we refrain from (1) using hardcoded parameter names and (2) emphasis via capitalization -- i.e. maybe we can use something like:\nthrow new UserRequestException(String.format(\"Cannot set %s=true for non-JBOD Kafka clusters.\", POPULATE_DISK_INFO_PARAM));", "author": "efeg", "createdAt": "2020-10-17T00:50:21Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/servlet/handler/async/runnable/LoadRunnable.java", "diffHunk": "@@ -64,13 +66,29 @@ protected BrokerStats getResult() throws Exception {\n         return cachedBrokerStats;\n       }\n     }\n+    if (_populateDiskInfo && !isClusterUsingJBOD()) {\n+      throw new UserRequestException(\"populate_disk_info = true when Kafka cluster is NOT using JBOD\");", "originalCommit": "5ccd70883c090551a6f4f35c20342052ed993b39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4MTE2OQ==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506781169", "bodyText": "Good idea", "author": "Lincong", "createdAt": "2020-10-17T02:00:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3NDE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3NDQ2Nw==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506774467", "bodyText": "Nit: This seems like a good candidate to replace with stream API for conciseness:\nreturn clusterModel.brokers().stream().allMatch(Broker::isUsingJBOD);", "author": "efeg", "createdAt": "2020-10-17T00:53:02Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/servlet/handler/async/runnable/LoadRunnable.java", "diffHunk": "@@ -64,13 +66,29 @@ protected BrokerStats getResult() throws Exception {\n         return cachedBrokerStats;\n       }\n     }\n+    if (_populateDiskInfo && !isClusterUsingJBOD()) {\n+      throw new UserRequestException(\"populate_disk_info = true when Kafka cluster is NOT using JBOD\");\n+    }\n+\n     if (_start != DEFAULT_START_TIME_FOR_CLUSTER_MODEL) {\n       return clusterModel(_modelCompletenessRequirements.minMonitoredPartitionsPercentage()).brokerStats(_kafkaCruiseControl.config());\n     } else {\n       return clusterModelFromEarliest().brokerStats(_kafkaCruiseControl.config());\n     }\n   }\n \n+  private boolean isClusterUsingJBOD() throws Exception {\n+    ClusterModel clusterModel = _kafkaCruiseControl.loadMonitor().clusterCapacity();\n+    // If and only if all brokers in the cluster are using JBOD, the cluster is considered to be using JBOD\n+    for (Broker broker : clusterModel.brokers()) {\n+      if (!broker.isUsingJBOD()) {\n+        return false;\n+      }\n+    }\n+    return true;", "originalCommit": "5ccd70883c090551a6f4f35c20342052ed993b39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "77298fb257dbc9c34a161667ec1edd1135e72116", "url": "https://github.com/linkedin/cruise-control/commit/77298fb257dbc9c34a161667ec1edd1135e72116", "message": "Fixed open issues", "committedDate": "2020-10-17T02:14:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4NDc0Nw==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506784747", "bodyText": "Nit: Maybe we can avoid having the boilerplate ParameterUtils.XXX if we static import just the POPULATE_DISK_INFO_PARAM.\nimport static com.linkedin.kafka.cruisecontrol.servlet.parameters.ParameterUtils.POPULATE_DISK_INFO_PARAM;", "author": "efeg", "createdAt": "2020-10-17T02:43:58Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/servlet/handler/async/runnable/LoadRunnable.java", "diffHunk": "@@ -7,9 +7,12 @@\n import com.linkedin.kafka.cruisecontrol.KafkaCruiseControl;\n import com.linkedin.kafka.cruisecontrol.async.progress.OperationProgress;\n import com.linkedin.kafka.cruisecontrol.exception.KafkaCruiseControlException;\n+import com.linkedin.kafka.cruisecontrol.model.Broker;\n import com.linkedin.kafka.cruisecontrol.model.ClusterModel;\n import com.linkedin.kafka.cruisecontrol.monitor.ModelCompletenessRequirements;\n+import com.linkedin.kafka.cruisecontrol.servlet.UserRequestException;\n import com.linkedin.kafka.cruisecontrol.servlet.parameters.ClusterLoadParameters;\n+import com.linkedin.kafka.cruisecontrol.servlet.parameters.ParameterUtils;", "originalCommit": "77298fb257dbc9c34a161667ec1edd1135e72116", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4NjI5NA==", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506786294", "bodyText": "OK. Fixed", "author": "Lincong", "createdAt": "2020-10-17T03:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4NDc0Nw=="}], "type": "inlineReview"}, {"oid": "faf423b65c4b7914713c916aa0695c12d2dce736", "url": "https://github.com/linkedin/cruise-control/commit/faf423b65c4b7914713c916aa0695c12d2dce736", "message": "Use static import for POPULATE_DISK_INFO_PARAM", "committedDate": "2020-10-17T03:02:42Z", "type": "commit"}]}