{"pr_number": 1064, "pr_title": "Skip broker with no log flush metrics in slow broker detection.", "pr_createdAt": "2020-01-10T01:13:34Z", "pr_url": "https://github.com/linkedin/cruise-control/pull/1064", "timeline": [{"oid": "88615a2cc1dd9d1de566709f18926b2b9b68f3ef", "url": "https://github.com/linkedin/cruise-control/commit/88615a2cc1dd9d1de566709f18926b2b9b68f3ef", "message": "Skip broker with no log flush metrics in slow broker detection.", "committedDate": "2020-01-10T01:12:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ2OTE5NQ==", "url": "https://github.com/linkedin/cruise-control/pull/1064#discussion_r365469195", "bodyText": "Is it possible to make this more generic by making this sanity check in a util function?  -- e.g. please see how we handle similar operation in HolderUtils#allowMissingBrokerMetric(Cluster, int, RawMetricType).", "author": "efeg", "createdAt": "2020-01-10T23:24:42Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinder.java", "diffHunk": "@@ -112,19 +113,26 @@ public SlowBrokerFinder() {\n     // Preprocess raw metrics to get the derived metrics for each broker.\n     Map<BrokerEntity, List<Double>> historicalValueByBroker = new HashMap<>();\n     Map<BrokerEntity, Double> currentValueByBroker = new HashMap<>();\n+    Set<Integer> skippedBrokers = new HashSet<>();\n     for (Map.Entry<BrokerEntity, ValuesAndExtrapolations> entry : currentMetricsByBroker.entrySet()) {\n       BrokerEntity entity = entry.getKey();\n-      ValuesAndExtrapolations valuesAndExtrapolations = entry.getValue();\n-      double latestTotalBytesIn = valuesAndExtrapolations.metricValues().valuesFor(ALL_TOPIC_BYTES_IN.id()).latest() +\n-                                  valuesAndExtrapolations.metricValues().valuesFor(ALL_TOPIC_REPLICATION_BYTES_IN.id()).latest();\n-      double latestLogFlushTime = valuesAndExtrapolations.metricValues().valuesFor(BROKER_LOG_FLUSH_TIME_MS_999TH.id()).latest();\n+      AggregatedMetricValues aggregatedMetricValues = entry.getValue().metricValues();\n+      // BROKER_LOG_FLUSH_TIME_MS_999TH comes from a Timer metric, which may not report if there is no value recorded (\n+      // the broker serves no traffic and never performs log flush operation).\n+      if (aggregatedMetricValues.valuesFor(BROKER_LOG_FLUSH_TIME_MS_999TH.id()) == null) {", "originalCommit": "88615a2cc1dd9d1de566709f18926b2b9b68f3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ2OTUwOQ==", "url": "https://github.com/linkedin/cruise-control/pull/1064#discussion_r365469509", "bodyText": "(Not introduced in this patch) Nit: Can we make SELF_HEALING_UNFIXABLE_RATIO a final?", "author": "efeg", "createdAt": "2020-01-10T23:26:06Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinder.java", "diffHunk": "@@ -112,19 +113,26 @@ public SlowBrokerFinder() {\n     // Preprocess raw metrics to get the derived metrics for each broker.\n     Map<BrokerEntity, List<Double>> historicalValueByBroker = new HashMap<>();\n     Map<BrokerEntity, Double> currentValueByBroker = new HashMap<>();\n+    Set<Integer> skippedBrokers = new HashSet<>();", "originalCommit": "88615a2cc1dd9d1de566709f18926b2b9b68f3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3MDU0Ng==", "url": "https://github.com/linkedin/cruise-control/pull/1064#discussion_r365470546", "bodyText": "Can we move the computation of latestTotalBytesIn and latestLogFlushTime to functions? This makes them easier to unit test and makes these calculations self-contained; hence, it makes it easier to use additional or different metrics in the future -- e.g. BROKER_LOG_FLUSH_TIME_MS_99TH rather than BROKER_LOG_FLUSH_TIME_MS_999TH.", "author": "efeg", "createdAt": "2020-01-10T23:31:17Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinder.java", "diffHunk": "@@ -112,19 +113,26 @@ public SlowBrokerFinder() {\n     // Preprocess raw metrics to get the derived metrics for each broker.\n     Map<BrokerEntity, List<Double>> historicalValueByBroker = new HashMap<>();\n     Map<BrokerEntity, Double> currentValueByBroker = new HashMap<>();\n+    Set<Integer> skippedBrokers = new HashSet<>();\n     for (Map.Entry<BrokerEntity, ValuesAndExtrapolations> entry : currentMetricsByBroker.entrySet()) {\n       BrokerEntity entity = entry.getKey();\n-      ValuesAndExtrapolations valuesAndExtrapolations = entry.getValue();\n-      double latestTotalBytesIn = valuesAndExtrapolations.metricValues().valuesFor(ALL_TOPIC_BYTES_IN.id()).latest() +\n-                                  valuesAndExtrapolations.metricValues().valuesFor(ALL_TOPIC_REPLICATION_BYTES_IN.id()).latest();\n-      double latestLogFlushTime = valuesAndExtrapolations.metricValues().valuesFor(BROKER_LOG_FLUSH_TIME_MS_999TH.id()).latest();\n+      AggregatedMetricValues aggregatedMetricValues = entry.getValue().metricValues();\n+      // BROKER_LOG_FLUSH_TIME_MS_999TH comes from a Timer metric, which may not report if there is no value recorded (\n+      // the broker serves no traffic and never performs log flush operation).\n+      if (aggregatedMetricValues.valuesFor(BROKER_LOG_FLUSH_TIME_MS_999TH.id()) == null) {\n+        skippedBrokers.add(entity.brokerId());\n+        continue;\n+      }\n+      double latestLogFlushTime = aggregatedMetricValues.valuesFor(BROKER_LOG_FLUSH_TIME_MS_999TH.id()).latest();\n+      double latestTotalBytesIn = aggregatedMetricValues.valuesFor(ALL_TOPIC_BYTES_IN.id()).latest() +", "originalCommit": "88615a2cc1dd9d1de566709f18926b2b9b68f3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3MDg3Nw==", "url": "https://github.com/linkedin/cruise-control/pull/1064#discussion_r365470877", "bodyText": "Nit: no traffic or negligible traffic?", "author": "efeg", "createdAt": "2020-01-10T23:33:08Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinder.java", "diffHunk": "@@ -133,9 +141,15 @@ public SlowBrokerFinder() {\n           }\n         }\n         historicalValueByBroker.put(entity, historicalValue);\n+      } else {\n+        skippedBrokers.add(entity.brokerId());\n       }\n     }\n \n+    if (!skippedBrokers.isEmpty()) {\n+      LOG.info(\"Skip broker slowness checking for brokers {} because they serve no traffic.\", skippedBrokers);", "originalCommit": "88615a2cc1dd9d1de566709f18926b2b9b68f3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b54cd6352ed3c52c3f78ef38c6fb1a8a54277c83", "url": "https://github.com/linkedin/cruise-control/commit/b54cd6352ed3c52c3f78ef38c6fb1a8a54277c83", "message": "Address the feedback.", "committedDate": "2020-01-13T19:16:28Z", "type": "commit"}]}