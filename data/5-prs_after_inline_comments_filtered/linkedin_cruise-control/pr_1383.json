{"pr_number": 1383, "pr_title": "Ensure that topology distribution goals compute balance constraints properly", "pr_createdAt": "2020-11-10T03:33:43Z", "pr_url": "https://github.com/linkedin/cruise-control/pull/1383", "timeline": [{"oid": "94aafe2bf57b69f7b8aa69fe29cade83a812e030", "url": "https://github.com/linkedin/cruise-control/commit/94aafe2bf57b69f7b8aa69fe29cade83a812e030", "message": "Ensure that topology distribution goals compute balance constraints properly.\n* Ensure that RackAwareDistributionGoal, TopicReplicaDistributionGoal, ReplicaDistributionGoal, LeaderReplicaDistributionGoal do not include brokers excluded for replica moves while computing balance constraints.\n* Fix incorect numOfflineTopicReplicasInB1 within rebalanceByMovingReplicasIn of TopicReplicaDistributionGoal.\n* Update the following dead configs, which are not supported after in cruisecontrol.properties in https://github.com/linkedin/cruise-control/pull/985\n  broker.failure.exclude.recently.demoted.brokers=true\n  broker.failure.exclude.recently.removed.brokers=true\n  goal.violation.exclude.recently.demoted.brokers=true\n  goal.violation.exclude.recently.removed.brokers=true", "committedDate": "2020-11-10T03:28:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0MDU1MQ==", "url": "https://github.com/linkedin/cruise-control/pull/1383#discussion_r520940551", "bodyText": "Nit: Consider making it more memory efficient.\ntopicsToRebalance = new HashSet<>(clusterModel.selfHealingEligibleReplicas().size())", "author": "Lincong", "createdAt": "2020-11-10T23:31:04Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/analyzer/goals/GoalUtils.java", "diffHunk": "@@ -389,6 +389,62 @@ public static String replicaSortName(Goal goal, boolean reverse, boolean leaderO\n     return String.format(\"%s%s%s\", goal.name(), reverse ? \"-REVERSE\" : \"\", leaderOnly ? \"-LEADER\" : \"\");\n   }\n \n+\n+  /**\n+   * Get the set of topics to rebalance for a soft goal.\n+   *\n+   * @param clusterModel The state of the cluster.\n+   * @param excludedTopics The topics to exclude from rebalance.\n+   * @return Topics of self-healing eligible replicas if the given cluster model has any, all topics except the given\n+   * excluded topics otherwise.\n+   */\n+  public static Set<String> topicsToRebalance(ClusterModel clusterModel, Set<String> excludedTopics) {\n+    Set<String> topicsToRebalance;\n+    if (!clusterModel.selfHealingEligibleReplicas().isEmpty()) {\n+      topicsToRebalance = new HashSet<>();", "originalCommit": "94aafe2bf57b69f7b8aa69fe29cade83a812e030", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA1NDM5MA==", "url": "https://github.com/linkedin/cruise-control/pull/1383#discussion_r521054390", "bodyText": "Self-healing eligible replicas could be all from the same or different topic. So the size is in [1, clusterModel.selfHealingEligibleReplicas().size()]. If the majority of replicas share the same topic, then we may end up wasting memory.", "author": "efeg", "createdAt": "2020-11-11T02:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0MDU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NjQ0OA==", "url": "https://github.com/linkedin/cruise-control/pull/1383#discussion_r520946448", "bodyText": "Maybe I am missing something here. when isExcludedForReplicaMove(sourceBroker) == true, we might return ACCEPT  to allow a INTER_BROKER_REPLICA_MOVEMENT  action? Intuitively, It feels strange. Shouldn't it be that if the source broker is excluded for replica move, we reject this INTER_BROKER_REPLICA_MOVEMENT action?\nPlease consider adding some comments here for clarification.", "author": "Lincong", "createdAt": "2020-11-10T23:47:12Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/analyzer/goals/ReplicaDistributionGoal.java", "diffHunk": "@@ -93,7 +95,8 @@ public ActionAcceptance actionAcceptance(BalancingAction action, ClusterModel cl\n \n         //Check that destination and source would not become unbalanced.\n         return (isReplicaCountUnderBalanceUpperLimitAfterChange(destinationBroker, destinationBroker.replicas().size(), ADD)\n-               && isReplicaCountAboveBalanceLowerLimitAfterChange(sourceBroker, sourceBroker.replicas().size(), REMOVE))\n+               && (isExcludedForReplicaMove(sourceBroker)", "originalCommit": "94aafe2bf57b69f7b8aa69fe29cade83a812e030", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA1NDQyNw==", "url": "https://github.com/linkedin/cruise-control/pull/1383#discussion_r521054427", "bodyText": "I agree that the name is confusing -- added documentation to clarify what is meant by excluded for replica move. In summary, a broker that is excluded for replica move cannot receive replicas, but can give away replicas -- e.g. a Preferred Leader in LinkedIn Kafka cluster is an excluded broker.", "author": "efeg", "createdAt": "2020-11-11T02:53:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NjQ0OA=="}], "type": "inlineReview"}, {"oid": "14a6bd7d8e689a185368054429da1fce7c6846b8", "url": "https://github.com/linkedin/cruise-control/commit/14a6bd7d8e689a185368054429da1fce7c6846b8", "message": "Address the feedback.", "committedDate": "2020-11-11T02:53:47Z", "type": "commit"}]}