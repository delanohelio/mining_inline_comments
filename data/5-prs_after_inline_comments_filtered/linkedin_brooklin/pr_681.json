{"pr_number": 681, "pr_title": "Deleting connector task nodes shouldn't do an ls", "pr_createdAt": "2020-02-07T22:59:31Z", "pr_url": "https://github.com/linkedin/brooklin/pull/681", "timeline": [{"oid": "3eda94c2d93fd8f263e2798853ec8c7df98b43dc", "url": "https://github.com/linkedin/brooklin/commit/3eda94c2d93fd8f263e2798853ec8c7df98b43dc", "message": "Deleting connector task nodes shouldn't do an ls\n\nTask node deletion does not require reading all connector task nodes. If\ntop level directories get too heavy an ls on the node will start failing\ndue to jute.maxbuffer limits on zookeeper and we will not successfully\ndelete nodes because of that causing a huge set of stale tasks to get\nbuilt up further adding to the issue of growing tasks nodes under one top\nlevel node. Change also adds a couple of constructors in zkclient and\nzkadaper to override operation retry ms which I was planning to use in\nunit-test, however the UT did not pan out and I thought it might come of\nuse later, so leaving those constructors in place.", "committedDate": "2020-02-07T22:50:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjczODk5Nw==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r376738997", "bodyText": "Not your fault nit: replace deprecated w/ stale or expired?", "author": "ahmedahamid", "createdAt": "2020-02-08T22:38:40Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -364,32 +384,26 @@ public boolean updateDatastream(Datastream datastream) {\n \n   /**\n    * Delete ZooKeeper znodes for all datastream tasks belonging to a group with a specified task prefix\n-   * @param connectors Connectors to look under for datastream tasks to delete\n+   * @param connector Connector to which the datastream tasks with the task prefix belong\n    * @param taskPrefix Task prefix of the datastream tasks to be deleted\n    */\n-  public void deleteTasksWithPrefix(Set<String> connectors, String taskPrefix) {\n+  public void deleteTasksWithPrefix(String connector, String taskPrefix) {\n     Set<String> tasksToDelete = _liveTaskMap.values()\n         .stream()\n         .flatMap(Collection::stream)\n-        .filter(x -> x.getTaskPrefix().equals(taskPrefix))\n+        .filter(x -> x.getTaskPrefix().equals(taskPrefix) && x.getConnectorType().equals(connector))\n         .map(DatastreamTask::getDatastreamTaskName)\n         .collect(Collectors.toSet());\n \n-    for (String connector : connectors) {\n-      Set<String> allTasks = new HashSet<>(_zkclient.getChildren(KeyBuilder.connector(_cluster, connector)));\n-      List<String> deadTasks = allTasks.stream().filter(tasksToDelete::contains).collect(Collectors.toList());\n-\n-      if (deadTasks.size() > 0) {\n-        LOG.info(\"Cleaning up deprecated connector tasks: {} for connector: {}\", deadTasks, connector);\n-        for (String task : deadTasks) {\n-          deleteConnectorTask(connector, task);\n-        }\n-      }\n+    LOG.info(\"Cleaning up deprecated connector tasks: {} for connector: {}\",", "originalCommit": "3eda94c2d93fd8f263e2798853ec8c7df98b43dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgzNjkzNA==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r377836934", "bodyText": "Done", "author": "DEEPTHIKORAT", "createdAt": "2020-02-11T19:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjczODk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MDc4MA==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r376740780", "bodyText": "Thank you for cleaning this up. There are more extraneous throws in this file if you're feeling generous \ud83d\ude05", "author": "ahmedahamid", "createdAt": "2020-02-08T23:20:08Z", "path": "datastream-server/src/test/java/com/linkedin/datastream/server/zk/TestZkAdapter.java", "diffHunk": "@@ -167,7 +169,7 @@ public void testLeaderElection() throws Exception {\n   }\n \n   @Test\n-  public void testStressLeaderElection() throws Exception {\n+  public void testStressLeaderElection() {", "originalCommit": "3eda94c2d93fd8f263e2798853ec8c7df98b43dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgzNzA0Mg==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r377837042", "bodyText": "I wasn't but couldn't unsee them anymore :(", "author": "DEEPTHIKORAT", "createdAt": "2020-02-11T19:04:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MDc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MTYxMA==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r376741610", "bodyText": "It would be really neat if we ordered the ctors of this class least-permissive-first and had each one call the one right below it, i.e.\n  /**\n   * Constructor for ZkClient\n   * @param zkServers the ZooKeeper connection String\n   */\n  public ZkClient(String zkServers) {\n    this(zkServers, DEFAULT_SESSION_TIMEOUT);\n  }\n  \n  /**\n   * Constructor for ZkClient\n   * @param zkServers the ZooKeeper connection String\n   * @param sessionTimeout the session timeout in milliseconds\n   */\n  public ZkClient(String zkServers, int sessionTimeout) {\n    this(zkServers, sessionTimeout, DEFAULT_CONNECTION_TIMEOUT);\n  }\n\n  /**\n   * Constructor for ZkClient\n   * @param zkServers the ZooKeeper connection String\n   * @param sessionTimeout the session timeout in milliseconds\n   * @param connectionTimeout the connection timeout in milliseconds\n   */\n  public ZkClient(String zkServers, int sessionTimeout, int connectionTimeout) {\n    this(zkServers, sessionTimeout, connectionTimeout, DEFAULT_OPERATION_RETRY_TIMEOUT);\n  }\n\n  /**\n   * Constructor for ZkClient\n   * @param zkServers the ZooKeeper connection String\n   * @param sessionTimeout the session timeout in milliseconds\n   * @param connectionTimeout the connection timeout in milliseconds\n   * @param operationRetryTimeoutMs The maximum amount of time, in milli seconds, each failed\n   *                                operation is retried. A value lesser than 0 is considered as\n   *                                retry forever until a connection has been reestablished.\n   */\n  public ZkClient(String zkServers, int sessionTimeout, int connectionTimeout, int operationRetryTimeoutMs) {\n    super(zkServers, sessionTimeout, connectionTimeout, new ZKStringSerializer(), operationRetryTimeoutMs);\n    _zkSessionTimeoutMs = sessionTimeout;\n  }", "author": "ahmedahamid", "createdAt": "2020-02-08T23:37:27Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/zk/ZkClient.java", "diffHunk": "@@ -47,20 +47,34 @@\n    * @param zkServers the ZooKeeper connection String", "originalCommit": "3eda94c2d93fd8f263e2798853ec8c7df98b43dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgzODk5MQ==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r377838991", "bodyText": "Sure. Thank you for the code.", "author": "DEEPTHIKORAT", "createdAt": "2020-02-11T19:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MTYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg4NjcwMw==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r377886703", "bodyText": "My pleasure :)", "author": "ahmedahamid", "createdAt": "2020-02-11T20:43:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MTYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MTY5MA==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r376741690", "bodyText": "Please, append the Ms suffix to all parameters (and their defaults) or remove it from operationRetryTimeoutMs for consistency's sake", "author": "ahmedahamid", "createdAt": "2020-02-08T23:39:19Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/zk/ZkClient.java", "diffHunk": "@@ -47,20 +47,34 @@\n    * @param zkServers the ZooKeeper connection String\n    * @param sessionTimeout the session timeout in milliseconds\n    * @param connectionTimeout the connection timeout in milliseconds\n+   * @param operationRetryTimeoutMs The maximum amount of time, in milli seconds, each failed\n+   *                                operation is retried. A value lesser than 0 is considered as\n+   *                                retry forever until a connection has been reestablished.\n    */\n-  public ZkClient(String zkServers, int sessionTimeout, int connectionTimeout) {\n-    super(zkServers, sessionTimeout, connectionTimeout, new ZKStringSerializer());\n \n+  public ZkClient(String zkServers, int sessionTimeout, int connectionTimeout, int operationRetryTimeoutMs) {", "originalCommit": "3eda94c2d93fd8f263e2798853ec8c7df98b43dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg0MTA0OQ==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r377841049", "bodyText": "Done.", "author": "DEEPTHIKORAT", "createdAt": "2020-02-11T19:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MTY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg2MzMyNg==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r377863326", "bodyText": "I've left the DEFAULTS without MS since they are public to avoid updating all dependencies. Since the variable names have been updated with the ms, it offers some improvement in readability as opposed to none for the sake of consistency. And there is some consistency still with all variables having the ms, while all defaults left without it.", "author": "DEEPTHIKORAT", "createdAt": "2020-02-11T19:53:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MTY5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MzU0Nw==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r376743547", "bodyText": "Just thinking out loud (I'm not sure this is a great suggestion): I often feel a little nervous about such getters. Even though they're only intended for testing, there's not much preventing anyone (in the same package) from using it. Of course it can also be easily made accessible everywhere by just marking it public.\nWould it be better if we introduce a visible-for-testing package private createZkClient() that tests can override to get access to the ZkClient? This would make _zkClient itself inaccessible through the API of ZkAdapter, but it also means we'd have to introduce a sub-type in tests (slightly tedious but that's exactly the point; make it more work to get access to ZkClient).\n/***************** ZkAdapter.java *****************/\n\npublic void connect() {\n    ...\n    _zkclient = createZkClient();\n    ...\n}\n\n@VisibleForTesting\nZkClient createZkClient() {\n    return new ZkClient(_zkServers, _sessionTimeout, _connectionTimeout, _operationRetryMs);\n}\n\n/***************** TestZkAdapter.java *****************/\n\nprivate SpyingZkAdapter createZkAdapter(String testCluster) {\n    return new SpyingZkAdapter(_zkConnectionString, testCluster, defaultTransportProviderName,  ZkClient.DEFAULT_SESSION_TIMEOUT,\n        ZkClient.DEFAULT_CONNECTION_TIMEOUT, null);\n}\n\nprivate static class SpyingZkAdapter extends ZkAdapter {\n    private ZkClient _zkClient;\n\n    public SpyingZkAdapter(String zkConnectionString, String testCluster, String defaultTransportProviderName,\n        int defaultSessionTimeout, int defaultConnectionTimeout, ZkAdapterListener listener) {\n        super(zkConnectionString, testCluster, defaultTransportProviderName, defaultSessionTimeout,\n            defaultConnectionTimeout, listener);\n    }\n\n    @Override\n    ZkClient createZkClient() {\n        _zkClient = spy(super.createZkClient());\n        return _zkClient;\n    }\n\n    public ZkClient getZkClient() {\n        return _zkClient;\n    }\n}\n\n@Test\npublic void testDeleteTasksWithPrefix() throws IOException {\n    ...\n    // Set operation timeout of 5secs so ZK doesn't end up retrying for the longer default\n    SpyingZkAdapter adapter =  createZkAdapter(testCluster);\n    ...\n}", "author": "ahmedahamid", "createdAt": "2020-02-09T00:11:38Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -1306,6 +1320,11 @@ public void handleDataDeleted(String dataPath) throws Exception {\n     }\n   }\n \n+  @VisibleForTesting\n+  ZkClient getZkClient() {\n+    return _zkclient;\n+  }\n+", "originalCommit": "3eda94c2d93fd8f263e2798853ec8c7df98b43dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg2MTY1Ng==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r377861656", "bodyText": "Thank you for the discussion and the code. I've updated the code with this snippet. I definitely share your concern, but wasn't able to figure a way out. This is a novel solution!", "author": "DEEPTHIKORAT", "createdAt": "2020-02-11T19:50:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MzU0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NDgyMg==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r376744822", "bodyText": "please add Timeout in the name", "author": "ahmedahamid", "createdAt": "2020-02-09T00:23:56Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -110,6 +111,7 @@\n   private final String _cluster;\n   private final int _sessionTimeout;\n   private final int _connectionTimeout;\n+  private final int _operationRetryMs;", "originalCommit": "3eda94c2d93fd8f263e2798853ec8c7df98b43dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg0MjE0OQ==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r377842149", "bodyText": "Done", "author": "DEEPTHIKORAT", "createdAt": "2020-02-11T19:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NDgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NTE1OQ==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r376745159", "bodyText": "\ud83e\udd28\nI have no idea why the code was going through every connector here. This would only make sense if it were possible for datastreams under different connectors to be deduped. In fact, the caller of this function \u2014 i.e. Coordinator.hardDeleteDatastream() \u2014 seems to be interested in deleting the tasks associated with a specific datastream/group/task-prefix (which would naturally be associated with a single connector). However, the (old) code below seems to be deleting tasks underneath all connectors. Wouldn't this cause us to delete innocent tasks that have not necessarily expired under other connectors just because the names of those tasks happened to collide with expired task names? What am I missing?", "author": "ahmedahamid", "createdAt": "2020-02-09T00:33:26Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -364,32 +384,26 @@ public boolean updateDatastream(Datastream datastream) {\n \n   /**\n    * Delete ZooKeeper znodes for all datastream tasks belonging to a group with a specified task prefix\n-   * @param connectors Connectors to look under for datastream tasks to delete\n+   * @param connector Connector to which the datastream tasks with the task prefix belong\n    * @param taskPrefix Task prefix of the datastream tasks to be deleted\n    */\n-  public void deleteTasksWithPrefix(Set<String> connectors, String taskPrefix) {\n+  public void deleteTasksWithPrefix(String connector, String taskPrefix) {\n     Set<String> tasksToDelete = _liveTaskMap.values()\n         .stream()\n         .flatMap(Collection::stream)\n-        .filter(x -> x.getTaskPrefix().equals(taskPrefix))\n+        .filter(x -> x.getTaskPrefix().equals(taskPrefix) && x.getConnectorType().equals(connector))\n         .map(DatastreamTask::getDatastreamTaskName)\n         .collect(Collectors.toSet());\n \n-    for (String connector : connectors) {", "originalCommit": "3eda94c2d93fd8f263e2798853ec8c7df98b43dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg0MjMzMQ==", "url": "https://github.com/linkedin/brooklin/pull/681#discussion_r377842331", "bodyText": "My feeling exactly", "author": "DEEPTHIKORAT", "createdAt": "2020-02-11T19:14:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NTE1OQ=="}], "type": "inlineReview"}, {"oid": "e236183632445f0cc1bef95f747e6e452d84051a", "url": "https://github.com/linkedin/brooklin/commit/e236183632445f0cc1bef95f747e6e452d84051a", "message": "Fixes from code review comments", "committedDate": "2020-02-11T20:38:35Z", "type": "commit"}, {"oid": "eaaa60321f73a43512b58abfbbc0de2c525e5ebf", "url": "https://github.com/linkedin/brooklin/commit/eaaa60321f73a43512b58abfbbc0de2c525e5ebf", "message": "Few more fixes", "committedDate": "2020-02-11T21:42:04Z", "type": "commit"}]}