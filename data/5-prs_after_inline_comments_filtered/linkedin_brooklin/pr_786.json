{"pr_number": 786, "pr_title": "Pre-commit and post-commit hooks in AbstractKafkaMirrorMakerConnectorTask", "pr_createdAt": "2020-12-14T19:07:13Z", "pr_url": "https://github.com/linkedin/brooklin/pull/786", "timeline": [{"oid": "62c4c658ae95fa53ab3f9a69fa58f5ebee8c9599", "url": "https://github.com/linkedin/brooklin/commit/62c4c658ae95fa53ab3f9a69fa58f5ebee8c9599", "message": "Added pre-commit and post-commit hooks in AbstractKafkaMirrorMakerConnectorTask", "committedDate": "2020-12-14T18:53:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5OTUyOQ==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r542699529", "bodyText": "It'll be good if the postCommitHook() can get hold of the exception causing the commit to fail.", "author": "abhishekmendhekar", "createdAt": "2020-12-14T19:44:23Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaBasedConnectorTask.java", "diffHunk": "@@ -774,6 +770,23 @@ protected void preConsumerPollHook() {\n     }\n   }\n \n+  /**\n+   * Pre commit hook for all operations that need to be performed before committing offsets.\n+   */\n+  protected void preCommitHook() { }\n+\n+  /**\n+   * Post commit hook for all operations that need to be performed after committing offsets.\n+   * @param success Indicates whether the commit attempt was successful or not.\n+   */\n+  protected void postCommitHook(boolean success) {", "originalCommit": "62c4c658ae95fa53ab3f9a69fa58f5ebee8c9599", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc3ODY1NQ==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r542778655", "bodyText": "Since we have multiple retries for commit, caching  the last exception should be sufficient.", "author": "somandal", "createdAt": "2020-12-14T20:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5OTUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc5NzQ3NA==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r542797474", "bodyText": "I'm not sure if there's value in propagating the Kafka exception up except for logging purposes, and the code in commitWithRetries already logs the exception. Do you think that there's value in propagating the last exception, @somandal?\nEdit: by up I mean in the class hierarchy.", "author": "jzakaryan", "createdAt": "2020-12-14T21:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5OTUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgwMTI1OA==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r542801258", "bodyText": "Right, at the moment I don't really fully see a need for the postCommitHook either, so i'm not yet clear about how the exception will help as such. I'll leave it up to you @jzakaryan to make a call on this.", "author": "somandal", "createdAt": "2020-12-14T21:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5OTUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5NDYyNQ==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r542894625", "bodyText": "Assuming there is a set of actions that follow post commit using this hook.\ntrue/false will give a signal of commit succeed or failed but an exception can help understand why it failed. Are you saying that there are more than 1 exception thrown? Generally Kafka should send only one commit message for a given consumer group and if this method commits more than 1 CG then I suggest returning a Map<String, Exception>. This gives user the most flexibility in terms of using this API.", "author": "abhishekmendhekar", "createdAt": "2020-12-14T22:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5OTUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjcwMTU1OA==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r542701558", "bodyText": "I think the postCommitHook() should not throw the exception because if the method is overridden the derived class and it fails to implement this logic then ab exception will never be thrown.\nInstead the logic should remain the same as before and this operation can remain as a no-op.", "author": "abhishekmendhekar", "createdAt": "2020-12-14T19:46:16Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaBasedConnectorTask.java", "diffHunk": "@@ -774,6 +770,23 @@ protected void preConsumerPollHook() {\n     }\n   }\n \n+  /**\n+   * Pre commit hook for all operations that need to be performed before committing offsets.\n+   */\n+  protected void preCommitHook() { }\n+\n+  /**\n+   * Post commit hook for all operations that need to be performed after committing offsets.\n+   * @param success Indicates whether the commit attempt was successful or not.\n+   */\n+  protected void postCommitHook(boolean success) {\n+    if (!success) {", "originalCommit": "62c4c658ae95fa53ab3f9a69fa58f5ebee8c9599", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc3NzM2NA==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r542777364", "bodyText": "+1", "author": "somandal", "createdAt": "2020-12-14T20:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjcwMTU1OA=="}], "type": "inlineReview"}, {"oid": "20d280afce29a4a4938ca84402a3caec7cb9ed5a", "url": "https://github.com/linkedin/brooklin/commit/20d280afce29a4a4938ca84402a3caec7cb9ed5a", "message": "Propagating last kafka exception in a commit attempt to post-commit hook", "committedDate": "2020-12-14T21:35:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMjA3OA==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r542822078", "bodyText": "I think there are many other exceptions that can be thrown here, other than KafkaException. (check documentation for commitSync())\nI'd suggest adding a catch block for those exceptions too, where you just cache the exception.", "author": "somandal", "createdAt": "2020-12-14T21:39:33Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaBasedConnectorTask.java", "diffHunk": "@@ -618,6 +621,7 @@ protected void commitWithRetries(Consumer<?, ?> consumer, Optional<Map<TopicPart\n         }\n         _logger.info(\"Commit succeeded.\");\n       } catch (KafkaException e) {\n+        lastKafkaExceptionRef.set(e);", "originalCommit": "20d280afce29a4a4938ca84402a3caec7cb9ed5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg1ODQwNg==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r542858406", "bodyText": "According to API reference, commitSync indeed throws a variety of exceptions other than KafkaException. However, I think there's a reason these exceptions are not handled here and are left to propagate up the call stack and I don't think there's a need to trigger the post-commit hook with the cached exception in this case.", "author": "jzakaryan", "createdAt": "2020-12-14T22:13:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMjA3OA=="}], "type": "inlineReview"}, {"oid": "cb64c11ff076a7f4c5ffde48b12e3814dead4802", "url": "https://github.com/linkedin/brooklin/commit/cb64c11ff076a7f4c5ffde48b12e3814dead4802", "message": "Fixed styling issue", "committedDate": "2020-12-14T22:13:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQwMTE0OA==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r545401148", "bodyText": "During shutdown, if it hits KafkaException, it returns true, which does not really mean success. This can impact the postCommit hook.", "author": "vmaheshw", "createdAt": "2020-12-17T21:01:36Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaBasedConnectorTask.java", "diffHunk": "@@ -618,6 +621,7 @@ protected void commitWithRetries(Consumer<?, ?> consumer, Optional<Map<TopicPart\n         }\n         _logger.info(\"Commit succeeded.\");\n       } catch (KafkaException e) {\n+        lastKafkaExceptionRef.set(e);\n         if (_shutdown) {\n           _logger.info(\"Caught KafkaException in commitWithRetries while shutting down, so exiting.\", e);\n           return true;", "originalCommit": "cb64c11ff076a7f4c5ffde48b12e3814dead4802", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk5NzcxMA==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r546997710", "bodyText": "This is no longer relevant now that post-commit hook is removed.", "author": "jzakaryan", "createdAt": "2020-12-22T00:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQwMTE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQwMjAxOQ==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r545402019", "bodyText": "Since, we don't have a concrete usage for this hook in open source and we currently have identified only the need for preCommit hook, will it be okay to postpone it, till either we identify the use for it or we get any pull/feature request. This will help us in avoiding an unnecessary tech debt to keep on maintaining.", "author": "vmaheshw", "createdAt": "2020-12-17T21:03:20Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaBasedConnectorTask.java", "diffHunk": "@@ -774,6 +780,22 @@ protected void preConsumerPollHook() {\n     }\n   }\n \n+  /**\n+   * Pre commit hook for all operations that need to be performed before committing offsets.\n+   */\n+  protected void preCommitHook() { }\n+\n+  /**\n+   * Post commit hook for all operations that need to be performed after committing offsets.\n+   * <p>\n+   *     Note: A commit attempt can be declared successful even when there's an exception. This can happen when a commit\n+   *     exception is thrown during task shutdown.\n+   * </p>\n+   * @param success Indicates whether the commit attempt was successful or not.\n+   * @param exception Exception caught during a commit attempt.\n+   */\n+  protected void postCommitHook(boolean success, KafkaException exception) { }", "originalCommit": "cb64c11ff076a7f4c5ffde48b12e3814dead4802", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQwNTYyNg==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r545405626", "bodyText": "If preCommitHook() threw exception, the commit will not go through. Your current use-case to have audit related drain in the preCommitHook() also adds a dependency that if there is any failure in audit, the commits will not go through. Is this really expected ? Is it possible to have the audit system throwing errors while the regular producers are working fine.", "author": "vmaheshw", "createdAt": "2020-12-17T21:10:09Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaBasedConnectorTask.java", "diffHunk": "@@ -608,6 +609,8 @@ protected void maybeCommitOffsetsInternal(Consumer<?, ?> consumer, boolean force\n \n   protected void commitWithRetries(Consumer<?, ?> consumer, Optional<Map<TopicPartition, OffsetAndMetadata>> offsets)\n       throws DatastreamRuntimeException {\n+    preCommitHook();", "originalCommit": "cb64c11ff076a7f4c5ffde48b12e3814dead4802", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk5NzgzOQ==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r546997839", "bodyText": "I made it explicit in javadoc that the overriding class needs to take care of handling exceptions from pre-commit hook.", "author": "jzakaryan", "createdAt": "2020-12-22T00:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQwNTYyNg=="}], "type": "inlineReview"}, {"oid": "cee0e986d31ac1437a4b1900bc43f98b7e1e86e5", "url": "https://github.com/linkedin/brooklin/commit/cee0e986d31ac1437a4b1900bc43f98b7e1e86e5", "message": "Removed post-commit hook. Added a note in javadoc", "committedDate": "2020-12-21T23:56:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAxNDUwOA==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r547014508", "bodyText": "Can we remove this now that we no longer need to pass it to the postCommitHook()?", "author": "somandal", "createdAt": "2020-12-22T01:23:27Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaBasedConnectorTask.java", "diffHunk": "@@ -608,6 +609,8 @@ protected void maybeCommitOffsetsInternal(Consumer<?, ?> consumer, boolean force\n \n   protected void commitWithRetries(Consumer<?, ?> consumer, Optional<Map<TopicPartition, OffsetAndMetadata>> offsets)\n       throws DatastreamRuntimeException {\n+    preCommitHook();\n+    AtomicReference<KafkaException> lastKafkaExceptionRef = new AtomicReference<>(null);", "originalCommit": "cee0e986d31ac1437a4b1900bc43f98b7e1e86e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU1NTAwMw==", "url": "https://github.com/linkedin/brooklin/pull/786#discussion_r551555003", "bodyText": "Done", "author": "jzakaryan", "createdAt": "2021-01-04T20:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAxNDUwOA=="}], "type": "inlineReview"}, {"oid": "40f375926b84889a701e69d8ba07036728605a1c", "url": "https://github.com/linkedin/brooklin/commit/40f375926b84889a701e69d8ba07036728605a1c", "message": "Removed unnecessary code\n\nRemoved unnecessary reference", "committedDate": "2021-01-04T20:13:34Z", "type": "commit"}]}