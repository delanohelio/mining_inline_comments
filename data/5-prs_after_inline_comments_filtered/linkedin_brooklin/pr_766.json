{"pr_number": 766, "pr_title": "Add sourcePartition to the record metadata. EventProducer should track high latency TopicPartitions via source partition", "pr_createdAt": "2020-10-14T20:53:41Z", "pr_url": "https://github.com/linkedin/brooklin/pull/766", "timeline": [{"oid": "4e60a18511605d3e3d87712173fcd1cfb85e2354", "url": "https://github.com/linkedin/brooklin/commit/4e60a18511605d3e3d87712173fcd1cfb85e2354", "message": "Add sourcePartition to the record metadata. EventProducer should track high latency TopicPartitions via source partition", "committedDate": "2020-10-14T20:42:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MTkwOA==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504971908", "bodyText": "I wonder if metadata.put(\"kafka-origin-partition\", partitionStr); from line 129 is being used anywhere", "author": "celiakung", "createdAt": "2020-10-14T21:05:54Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/KafkaConnectorTask.java", "diffHunk": "@@ -141,6 +141,7 @@ protected DatastreamProducerRecord translate(ConsumerRecord<?, ?> fromKafka, Ins\n       metadata.put(BrooklinEnvelopeMetadataConstants.EVENT_TIMESTAMP, String.valueOf(readTime.toEpochMilli()));\n       eventsSourceTimestamp = fromKafka.timestamp();\n     }\n+    metadata.put(BrooklinEnvelopeMetadataConstants.SOURCE_PARTITION, partitionStr);", "originalCommit": "4e60a18511605d3e3d87712173fcd1cfb85e2354", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MzYyMQ==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504973621", "bodyText": "@celiakung at the moment I don't see it being used. Also, since metadata isn't propagated to the downstream Kafka, this data is lost (I remember seeing a few asks from users). I did consider using \"kafka-origin-partition\", but since these are declared only for the Kafka connectors, I thought it'll make more sense to add a Metadata field which can be used by any connector that wants this  feature. Let me know if you think it may make sense to move out these metadata fields (all origin fields) to the common metadata constants. I wasn't sure since I wasn't sure why these are present.", "author": "somandal", "createdAt": "2020-10-14T21:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MTkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3Mjk1Mg==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504972952", "bodyText": "Suggest to update param docs & clarify that \"partition\" is destination Kafka topic partition", "author": "celiakung", "createdAt": "2020-10-14T21:08:09Z", "path": "datastream-server-api/src/main/java/com/linkedin/datastream/server/api/transport/DatastreamRecordMetadata.java", "diffHunk": "@@ -14,9 +14,10 @@\n   private final int _partition;\n   private final String _checkpoint;\n   private final int _eventIndex;\n+  private final int _sourcePartition;\n \n   /**\n-   * Construct an instance of DatastreamRecordMetadata. Defaults the event index to 0.\n+   * Construct an instance of DatastreamRecordMetadata. Defaults the event index to 0 and source partition to -1.\n    * @param  checkpoint checkpoint string\n    * @param topic Kafka topic name\n    * @param partition Kafka topic partition", "originalCommit": "4e60a18511605d3e3d87712173fcd1cfb85e2354", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NTk5Mg==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504975992", "bodyText": "done", "author": "somandal", "createdAt": "2020-10-14T21:14:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3Mjk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MzA3NQ==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504973075", "bodyText": "Suggest clarifying this is destination", "author": "celiakung", "createdAt": "2020-10-14T21:08:24Z", "path": "datastream-server-api/src/main/java/com/linkedin/datastream/server/api/transport/DatastreamRecordMetadata.java", "diffHunk": "@@ -34,12 +36,14 @@ public DatastreamRecordMetadata(String checkpoint, String topic, int partition)\n    * @param topic Kafka topic name\n    * @param partition Kafka topic partition", "originalCommit": "4e60a18511605d3e3d87712173fcd1cfb85e2354", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NjA0NQ==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504976045", "bodyText": "done", "author": "somandal", "createdAt": "2020-10-14T21:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MzA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MzE2MA==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504973160", "bodyText": "Partition -> Destination Partition ?", "author": "celiakung", "createdAt": "2020-10-14T21:08:34Z", "path": "datastream-server-api/src/main/java/com/linkedin/datastream/server/api/transport/DatastreamRecordMetadata.java", "diffHunk": "@@ -71,9 +75,16 @@ public int getEventIndex() {\n     return _eventIndex;\n   }\n \n+  /**\n+   * Partition number from which the record was consumed.\n+   */\n+  public int getSourcePartition() {\n+    return _sourcePartition;\n+  }\n+\n   @Override\n   public String toString() {\n-    return String.format(\"Checkpoint: %s, Topic: %s, Partition: %d, Event Index: %d\", _checkpoint, _topic, _partition,\n-        _eventIndex);\n+    return String.format(\"Checkpoint: %s, Topic: %s, Partition: %d, Event Index: %d, Source Partition: %d\", _checkpoint,", "originalCommit": "4e60a18511605d3e3d87712173fcd1cfb85e2354", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NjA3OA==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504976078", "bodyText": "done", "author": "somandal", "createdAt": "2020-10-14T21:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MzE2MA=="}], "type": "inlineReview"}, {"oid": "13cec012ba224c4ce7dc24e4dfa92bddda893a70", "url": "https://github.com/linkedin/brooklin/commit/13cec012ba224c4ce7dc24e4dfa92bddda893a70", "message": "Address review comments", "committedDate": "2020-10-14T21:13:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxNzUzNw==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r505017537", "bodyText": "Nit: Is it possible to merge this constant with \"kafka-origin-offset\"? It feels like we have some redundancy in metadata fields otherwise.", "author": "jzakaryan", "createdAt": "2020-10-14T22:20:14Z", "path": "datastream-common/src/main/java/com/linkedin/datastream/common/BrooklinEnvelopeMetadataConstants.java", "diffHunk": "@@ -36,4 +36,7 @@\n \n   // Timestamp of the event when it was written in the last leg (i.e. the Source of the connector)\n   public static final String SOURCE_TIMESTAMP = \"SourceTimestamp\";\n+\n+  // Source partition number from where the event was generated\n+  public static final String SOURCE_PARTITION = \"SourcePartition\";", "originalCommit": "13cec012ba224c4ce7dc24e4dfa92bddda893a70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA0ODk3Nw==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r505048977", "bodyText": "Discussed this a little bit. One problem with reconciling this with \"kafka-origin-partition\" and even moving all \"kafka-origin-*\" constants into this file is that these are very specific to Kafka based sources. Want to have a generic field that isn't tied to Kafka, as this concept of \"partition\" is generic and can even mean a database partitioning scheme. Plus need the constant to be accessible in the transport layers which ideally shouldn't be tied to the source connector type.", "author": "somandal", "createdAt": "2020-10-14T23:04:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxNzUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxOTk1MQ==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r505019951", "bodyText": "Nit: It may be worth renaming partition to destinationPartition to make it explicit to the users.", "author": "jzakaryan", "createdAt": "2020-10-14T22:23:32Z", "path": "datastream-server-api/src/main/java/com/linkedin/datastream/server/api/transport/DatastreamRecordMetadata.java", "diffHunk": "@@ -71,9 +75,16 @@ public int getEventIndex() {\n     return _eventIndex;\n   }\n \n+  /**\n+   * Partition number from which the record was consumed.\n+   */\n+  public int getSourcePartition() {\n+    return _sourcePartition;\n+  }\n+\n   @Override\n   public String toString() {\n-    return String.format(\"Checkpoint: %s, Topic: %s, Partition: %d, Event Index: %d\", _checkpoint, _topic, _partition,\n-        _eventIndex);\n+    return String.format(\"Checkpoint: %s, Topic: %s, Destination Partition: %d, Event Index: %d, Source Partition: %d\",", "originalCommit": "13cec012ba224c4ce7dc24e4dfa92bddda893a70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA0NzMxNQ==", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r505047315", "bodyText": "Discussed offline and decided leave partition as is for now, since this is touched in many places and has some integration effort. Will open a ticket to fix this later.", "author": "somandal", "createdAt": "2020-10-14T23:02:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxOTk1MQ=="}], "type": "inlineReview"}]}