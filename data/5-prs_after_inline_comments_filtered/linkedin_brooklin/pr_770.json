{"pr_number": 770, "pr_title": "Handle the new session after session expiry", "pr_createdAt": "2020-10-20T05:40:42Z", "pr_url": "https://github.com/linkedin/brooklin/pull/770", "timeline": [{"oid": "c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "url": "https://github.com/linkedin/brooklin/commit/c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "message": "Merge pull request #1 from linkedin/master\n\nPull latest", "committedDate": "2019-11-18T20:06:44Z", "type": "commit"}, {"oid": "28d2d11372814b122c6e62c2a3309f275b1f7f84", "url": "https://github.com/linkedin/brooklin/commit/28d2d11372814b122c6e62c2a3309f275b1f7f84", "message": "Merge branch 'master' of github.com:linkedin/brooklin", "committedDate": "2020-09-21T19:21:30Z", "type": "commit"}, {"oid": "0653c15d870615a5d6619f0dc745c66abd8bd43e", "url": "https://github.com/linkedin/brooklin/commit/0653c15d870615a5d6619f0dc745c66abd8bd43e", "message": "Merge branch 'master' of github.com:linkedin/brooklin", "committedDate": "2020-09-30T06:26:06Z", "type": "commit"}, {"oid": "84e36f2f18291458014a22836d876c0f6ca25703", "url": "https://github.com/linkedin/brooklin/commit/84e36f2f18291458014a22836d876c0f6ca25703", "message": "Handle session expiry", "committedDate": "2020-10-05T19:16:43Z", "type": "commit"}, {"oid": "e808651ebf09ba23d713bed936d86544cac33b71", "url": "https://github.com/linkedin/brooklin/commit/e808651ebf09ba23d713bed936d86544cac33b71", "message": "Merge branch 'master' of github.com:linkedin/brooklin into reinitNewSession", "committedDate": "2020-10-14T21:34:20Z", "type": "commit"}, {"oid": "93058c747b97beec9c4027cbbdfd562a98f0e995", "url": "https://github.com/linkedin/brooklin/commit/93058c747b97beec9c4027cbbdfd562a98f0e995", "message": "Update test cases", "committedDate": "2020-10-20T05:38:55Z", "type": "commit"}, {"oid": "6fd12e3275f2d09edf0bf729d389165acda61b0b", "url": "https://github.com/linkedin/brooklin/commit/6fd12e3275f2d09edf0bf729d389165acda61b0b", "message": "Fix test case", "committedDate": "2020-10-20T05:43:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzczMDU2OQ==", "url": "https://github.com/linkedin/brooklin/pull/770#discussion_r517730569", "bodyText": "Can this API be meaningfully split? I am yet to fully understand all the parts, but if can be logically split to be closerLeaderSpecificListeners or closeListnersOnDisconnect.. or whatever is logical, it will make following code much easier.", "author": "DEEPTHIKORAT", "createdAt": "2020-11-05T01:35:50Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -295,11 +307,15 @@ private void onBecomeFollower() {\n \n     LOG.info(\"Instance \" + _instanceName + \" becomes follower\");\n \n-    closeZkListener(false);\n+    closeZkListeners(false);\n     _isLeader = false;\n   }\n \n-  private void closeZkListener(boolean isDisconnect) {\n+  private void closeZkListeners(boolean isDisconnect) {\n+    closeZkListeners(isDisconnect, false);\n+  }\n+\n+  private void closeZkListeners(boolean isDisconnect, boolean isSessionExpired) {", "originalCommit": "6fd12e3275f2d09edf0bf729d389165acda61b0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzczMTY2MQ==", "url": "https://github.com/linkedin/brooklin/pull/770#discussion_r517731661", "bodyText": "nit: not sure if this comment is relevant to this code path. Also since this is overlap with start, should this eventQueue work be moved to a method.", "author": "DEEPTHIKORAT", "createdAt": "2020-11-05T01:39:35Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java", "diffHunk": "@@ -521,6 +522,22 @@ boolean isZkSessionExpired() {\n     return _zkSessionExpired;\n   }\n \n+  @Override\n+  public void onNewSession() {\n+    createEventThread();\n+    startEventThread();\n+    _adapter.connect();\n+    // now that instance is started, make sure it doesn't miss any assignment created during", "originalCommit": "6fd12e3275f2d09edf0bf729d389165acda61b0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODMwMTYwMA==", "url": "https://github.com/linkedin/brooklin/pull/770#discussion_r518301600", "bodyText": "nit: Reword to Task lock node might have been deleted\nIf we got ZkNoNodeException doesn't that mean lockPath doesn't exist or is that a more generic exception?", "author": "DEEPTHIKORAT", "createdAt": "2020-11-05T19:18:31Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -1378,13 +1395,17 @@ public void releaseTask(DatastreamTaskImpl task) {\n       return;\n     }\n \n-    String owner = _zkclient.ensureReadData(lockPath);\n-    if (!owner.equals(_instanceName)) {\n-      LOG.warn(\"{} does not have the lock on {}-{}/{}\", _instanceName, task.getConnectorType(), task.getTaskPrefix(),\n-          task.getDatastreamTaskName());\n+    try {\n+      String owner = _zkclient.ensureReadData(lockPath);\n+      if (!owner.equals(_instanceName)) {\n+        LOG.warn(\"{} does not have the lock on {}-{}/{}\", _instanceName, task.getConnectorType(), task.getTaskPrefix(),\n+            task.getDatastreamTaskName());\n+        return;\n+      }\n+    } catch (ZkNoNodeException e) {\n+      LOG.info(\"Task lock node may be got deleted. exists: {}\", _zkclient.exists(lockPath));", "originalCommit": "6fd12e3275f2d09edf0bf729d389165acda61b0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA3ODc1Nw==", "url": "https://github.com/linkedin/brooklin/pull/770#discussion_r519078757", "bodyText": "+1\nCan we also make this a warn log?", "author": "somandal", "createdAt": "2020-11-07T01:41:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODMwMTYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODMwMzg4NQ==", "url": "https://github.com/linkedin/brooklin/pull/770#discussion_r518303885", "bodyText": "Can you please reword this? Node dying is a bit confusing to read. The actual event might be helpful as in.. instance's session expired or something like that. Same for the exception below.", "author": "DEEPTHIKORAT", "createdAt": "2020-11-05T19:21:00Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -1554,12 +1580,16 @@ public ZkBackedLiveInstanceListProvider() {\n     private List<String> getLiveInstanceNames(List<String> nodes) {\n       List<String> liveInstances = new ArrayList<>();\n       for (String n : nodes) {\n-        String hostname = _zkclient.ensureReadData(KeyBuilder.liveInstance(_cluster, n));\n-        if (hostname == null) {\n-          // hostname can be null if a node dies immediately after reading all live instances\n-          LOG.error(\"Node {} is dead. Likely cause it dies after reading list of nodes.\", n);\n-        } else {\n-          liveInstances.add(formatZkInstance(hostname, n));\n+        try {\n+          String hostname = _zkclient.ensureReadData(KeyBuilder.liveInstance(_cluster, n));\n+          if (hostname == null) {\n+            // hostname can be null if a node dies immediately after reading all live instances\n+            LOG.error(\"Node {} is dead. It died after the list of nodes were read.\", n);", "originalCommit": "6fd12e3275f2d09edf0bf729d389165acda61b0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA3ODczMA==", "url": "https://github.com/linkedin/brooklin/pull/770#discussion_r519078730", "bodyText": "can we make this a warn log?", "author": "somandal", "createdAt": "2020-11-07T01:40:47Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -1554,12 +1580,16 @@ public ZkBackedLiveInstanceListProvider() {\n     private List<String> getLiveInstanceNames(List<String> nodes) {\n       List<String> liveInstances = new ArrayList<>();\n       for (String n : nodes) {\n-        String hostname = _zkclient.ensureReadData(KeyBuilder.liveInstance(_cluster, n));\n-        if (hostname == null) {\n-          // hostname can be null if a node dies immediately after reading all live instances\n-          LOG.error(\"Node {} is dead. Likely cause it dies after reading list of nodes.\", n);\n-        } else {\n-          liveInstances.add(formatZkInstance(hostname, n));\n+        try {\n+          String hostname = _zkclient.ensureReadData(KeyBuilder.liveInstance(_cluster, n));\n+          if (hostname == null) {\n+            // hostname can be null if a node dies immediately after reading all live instances\n+            LOG.error(\"Node {} is dead. It died after the list of nodes were read.\", n);\n+          } else {\n+            liveInstances.add(formatZkInstance(hostname, n));\n+          }\n+        } catch (ZkNoNodeException e) {\n+          LOG.info(\"Node {} is dead. It died after the list of nodes were read.\", n);", "originalCommit": "6fd12e3275f2d09edf0bf729d389165acda61b0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3a8030f80af9627ba69c0d46eab8adb237a9f988", "url": "https://github.com/linkedin/brooklin/commit/3a8030f80af9627ba69c0d46eab8adb237a9f988", "message": "Merge commits", "committedDate": "2021-01-25T18:30:25Z", "type": "commit"}, {"oid": "1429ce1d5eafb588c90a5764d310c72b9ef543f7", "url": "https://github.com/linkedin/brooklin/commit/1429ce1d5eafb588c90a5764d310c72b9ef543f7", "message": "Merge branch 'master' of github.com:vmaheshw/Brooklin", "committedDate": "2021-04-26T21:55:05Z", "type": "commit"}, {"oid": "301bde30fb8eeb5b65cf4e4805c446062a232e7a", "url": "https://github.com/linkedin/brooklin/commit/301bde30fb8eeb5b65cf4e4805c446062a232e7a", "message": "Merge branch 'master' of github.com:linkedin/brooklin", "committedDate": "2021-05-06T06:03:16Z", "type": "commit"}, {"oid": "a968e3fcaf81aae70695be6f313ade10ad6beb9c", "url": "https://github.com/linkedin/brooklin/commit/a968e3fcaf81aae70695be6f313ade10ad6beb9c", "message": "Rebase", "committedDate": "2021-05-07T06:24:50Z", "type": "commit"}, {"oid": "37dc9f70c2a2d5f443005904dc3f375d30c73a5a", "url": "https://github.com/linkedin/brooklin/commit/37dc9f70c2a2d5f443005904dc3f375d30c73a5a", "message": "Add knob to enable session expiry", "committedDate": "2021-05-07T18:44:25Z", "type": "commit"}]}