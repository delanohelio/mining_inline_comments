{"pr_number": 740, "pr_title": "Add metric to count number of Nanny Task restarts for BMM", "pr_createdAt": "2020-08-11T13:47:53Z", "pr_url": "https://github.com/linkedin/brooklin/pull/740", "timeline": [{"oid": "b25a8950c220fd6bc56a493e54b53d6efb007535", "url": "https://github.com/linkedin/brooklin/commit/b25a8950c220fd6bc56a493e54b53d6efb007535", "message": "Add espresso key schema to the datastream metadata\n\nThis patch just adds the constant. The actual change will be done\nin the brooklin-server.", "committedDate": "2020-04-16T18:12:44Z", "type": "commit"}, {"oid": "8df3a94268018b5fba22aa55458a80ba0ae93f63", "url": "https://github.com/linkedin/brooklin/commit/8df3a94268018b5fba22aa55458a80ba0ae93f63", "message": "Merge branch 'master' of github.com:linkedin/brooklin", "committedDate": "2020-08-11T00:58:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMTI3Ng==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468701276", "bodyText": "Since this is an abstract class which needs to be extended by actual Connectors, can we take a metrics prefix as input and use that to construct the metrics instead? This way, the metrics will be more meaningful, and it'll be easier to differentiate between different connectors that use this as their base.\nYou can look at AbstractKafkaBasedConnectorTask to see how connector tasks that extend it construct and pass their metrics prefix. We do want both the extending class name and the connector name to be part of the metrics prefix. This is because we have many connectors which use the same class.", "author": "somandal", "createdAt": "2020-08-11T16:15:15Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -73,6 +77,11 @@\n   private static final Duration SHUTDOWN_EXECUTOR_SHUTDOWN_TIMEOUT = Duration.ofSeconds(30);\n   static final Duration MIN_DAEMON_THREAD_STARTUP_DELAY = Duration.ofMinutes(2);\n \n+  private static final String MODULE = AbstractKafkaConnector.class.getSimpleName();", "originalCommit": "d339fe5024579db9dbcb9c64b476a4b5c39a2395", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2NzA2NA==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468767064", "bodyText": "Done.", "author": "vishwajith-s", "createdAt": "2020-08-11T18:04:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMTI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMzI5Mg==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468703292", "bodyText": "Since this is an abstract class, you need to fix all the extenders of this class to call super.getMetricsInfos() in their override of getMetricsInfos(), along with their existing code to return all metrics, otherwise this metric won't be picked up by them. Any in-house Connectors need to be fixed too.", "author": "somandal", "createdAt": "2020-08-11T16:18:24Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -553,4 +564,12 @@ public AbstractKafkaBasedConnectorTask getConnectorTask() {\n       return _task;\n     }\n   }\n+\n+  @Override\n+  public List<BrooklinMetricInfo> getMetricInfos() {", "originalCommit": "d339fe5024579db9dbcb9c64b476a4b5c39a2395", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc3MTU4NQ==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468771585", "bodyText": "Done.", "author": "vishwajith-s", "createdAt": "2020-08-11T18:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMzI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcxMDM4OA==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468710388", "bodyText": "Connector already implements MetricsAware, so you don't need to here", "author": "somandal", "createdAt": "2020-08-11T16:29:10Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -64,7 +68,7 @@\n  *  <li>Restarting stalled {@link DatastreamTask}s</li>\n  * </ul>\n  */\n-public abstract class AbstractKafkaConnector implements Connector, DiagnosticsAware {\n+public abstract class AbstractKafkaConnector implements Connector, DiagnosticsAware, MetricsAware {", "originalCommit": "d339fe5024579db9dbcb9c64b476a4b5c39a2395", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcxNDY0Mg==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468714642", "bodyText": "@ahmedahamid is there a recommendation on when to use a gauge vs. a counter?", "author": "somandal", "createdAt": "2020-08-11T16:35:58Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -229,6 +239,7 @@ protected void restartDeadTasks() {\n         _logger.warn(\"Creating a new connector task for the datastream task {}\", datastreamTask);\n         _runningTasks.put(datastreamTask, createKafkaConnectorTask(datastreamTask));\n       });\n+      _dynamicMetricsManager.createOrUpdateCounter(MODULE, NUM_TASK_RESTARTS, deadDatastreamTasks.size());", "originalCommit": "d339fe5024579db9dbcb9c64b476a4b5c39a2395", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg0MTQyMg==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r470841422", "bodyText": "Here's what I found: #740 (comment). GitHub started allowing me to leave responses on comments after I posted my own review.", "author": "ahmedahamid", "createdAt": "2020-08-14T20:05:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcxNDY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyMDA0OQ==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468720049", "bodyText": "Once you move to using the metrics prefix, you'll need to modify this. Plus you should use a regex for matching:\n<metrics prefix> + MetricsAware.KEY_REGEX + <metrics name>", "author": "somandal", "createdAt": "2020-08-11T16:44:56Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -553,4 +564,12 @@ public AbstractKafkaBasedConnectorTask getConnectorTask() {\n       return _task;\n     }\n   }\n+\n+  @Override\n+  public List<BrooklinMetricInfo> getMetricInfos() {\n+    List<BrooklinMetricInfo> metrics = new ArrayList<>();\n+    metrics.add(new BrooklinMeterInfo(buildMetricName(NUM_TASK_RESTARTS)));", "originalCommit": "d339fe5024579db9dbcb9c64b476a4b5c39a2395", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "url": "https://github.com/linkedin/brooklin/commit/d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "message": "Add metric to count number of Task restarts for BMM\n\nMetric tracks the number of task restarts done by nanny thread in\ncase of AbstractKafkaConnector.", "committedDate": "2020-08-11T18:32:10Z", "type": "commit"}, {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "url": "https://github.com/linkedin/brooklin/commit/d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "message": "Add metric to count number of Task restarts for BMM\n\nMetric tracks the number of task restarts done by nanny thread in\ncase of AbstractKafkaConnector.", "committedDate": "2020-08-11T18:32:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc4Nzg3NQ==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468787875", "bodyText": "Do we need to add regex here? Is this right? @somandal @ahmedahamid", "author": "vishwajith-s", "createdAt": "2020-08-11T18:42:01Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -229,6 +245,7 @@ protected void restartDeadTasks() {\n         _logger.warn(\"Creating a new connector task for the datastream task {}\", datastreamTask);\n         _runningTasks.put(datastreamTask, createKafkaConnectorTask(datastreamTask));\n       });\n+      _dynamicMetricsManager.createOrUpdateCounter(_metricsPrefix, NUM_TASK_RESTARTS, deadDatastreamTasks.size());", "originalCommit": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk4MzU2MA==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468983560", "bodyText": "It's almost correct.\n\n\nThe metric's MBean name will be <_metricsPrefix>.<NUM_TASK_RESTARTS>\n\n\nThe corresponding BrooklinMetricInfo object we return from getMetricInfos() will have a nameOrRegex of: <concreteClassName>.<_metricsPrefix>([-.\\w\\d]+)\\.<NUM_TASK_RESTARTS>\nThis is the value returned by:\nbuildMetricName(_metricsPrefix + MetricsAware.KEY_REGEX + NUM_TASK_RESTARTS)\nIn case you're wondering, the <concreteClassName> prefix above is prepended by buildMetricName() itself (that's what this overload does).\n\n\nThe way it works is that the regex in (2) has to match the metric's MBean in (1), which won't happen right now because the regex (a) has an extra <concreteClassName> prefix and (b) expects a string (i.e. ([-.\\w\\d]+)\\.) between <_metricsPrefix> and <NUM_TASK_RESTARTS>\n\n\nIn fact, they do not match in TestAbstractKafkaConnector.testConnectorRestartCalled() when I step into it with a debugger. The metric's MBean is test.TestKafkaConnector.numTaskRestarts but the BrooklinMetricInfo's nameOrRegex is TestKafkaConnector.test.TestKafkaConnector([-.\\w\\d]+)\\.numTaskRestarts\n\n\nThere's a few different ways to resolve this but let me suggest this: how about we let AbstractKafkaConnector itself decide the metrics prefix?\n\nThis class has all the necessary ingredients; it knows the connector name and it can get the concrete class name by calling this.getClass().getSimpleName()\nDoing that would eliminate the redundancy entailed by having every subtype call generateMetricsPrefix() to pass its return value to super.\n\nIf you like the idea, here are some more details:\n\nIt won't be straightforward/ideal to use regexes with the metric you're adding because its name has no variable parts (like a datastream or topic name), it's just <metricsPrefix>.<NUM_TASK_RESTARTS>\nConsequently, you can use _dynamicMetricsManager.registerMetric() to create the metric's MBean (e.g. in the ctor or when start() is called), use _dynamicMetricsManager.createOrUpdate() when you need to update the metric, and return a BrooklinMetricInfo object from getMetricInfos() whose nameOrRegex is decided by buildMetricName(_metricsPrefix, NUM_TASK_RESTARTS)\nThis way, the metric's MBean and the corresponding BrooklinMetricInfo will both have the name <metricsPrefix>.<NUM_TASK_RESTARTS>\nOne last thing to note is that the specific BrooklinMetricInfo subtype you use in getMetricInfos() must match the metric type (e.g. BrooklinMeterInfo for meters, BrooklinCounterInfo for counters ... etc).", "author": "ahmedahamid", "createdAt": "2020-08-12T03:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc4Nzg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc3MjYxMQ==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471772611", "bodyText": "Thanks for the detailed explanation. I appreciate it.", "author": "vishwajith-s", "createdAt": "2020-08-17T21:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc4Nzg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyMjg1Mg==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468722852", "bodyText": "MetricsAware is redundant here; Connector is MetricsAware", "author": "ahmedahamid", "createdAt": "2020-08-11T16:49:28Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -64,7 +68,7 @@\n  *  <li>Restarting stalled {@link DatastreamTask}s</li>\n  * </ul>\n  */\n-public abstract class AbstractKafkaConnector implements Connector, DiagnosticsAware {\n+public abstract class AbstractKafkaConnector implements Connector, DiagnosticsAware, MetricsAware {", "originalCommit": "d339fe5024579db9dbcb9c64b476a4b5c39a2395", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2MjY0Nw==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468762647", "bodyText": "Not strictly related to your PR but would be nice to do: you can change the visibility of this field to protected so subtypes can utilize it. I know of one extender that currently needs it, i.e. KafkaMirrorMakerConnector, and it's maintaining a similar private field. It would be nice to have extenders use this field instead.", "author": "ahmedahamid", "createdAt": "2020-08-11T17:57:01Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -73,6 +77,11 @@\n   private static final Duration SHUTDOWN_EXECUTOR_SHUTDOWN_TIMEOUT = Duration.ofSeconds(30);\n   static final Duration MIN_DAEMON_THREAD_STARTUP_DELAY = Duration.ofMinutes(2);\n \n+  private static final String MODULE = AbstractKafkaConnector.class.getSimpleName();\n+  private static final String NUM_TASK_RESTARTS = \"numTaskRestarts\";\n+\n+  private final DynamicMetricsManager _dynamicMetricsManager;", "originalCommit": "d339fe5024579db9dbcb9c64b476a4b5c39a2395", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc2MTE2OQ==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r470761169", "bodyText": "Done.", "author": "vishwajith-s", "createdAt": "2020-08-14T17:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2MjY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQwODE1Nw==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r469408157", "bodyText": "Sonam left me a question about counters vs. gauges but GitHub won't allow me to comment on it for some reason \u2014 they're roughly comparable but this ingraphs wiki page seems to suggest we should be using gauges for values that would increase and decrease over time (which seems to be the case for the metric this PR is adding). A similar comment has been made in response to the same question on the repo of the metrics library we're using.", "author": "ahmedahamid", "createdAt": "2020-08-12T17:02:36Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -229,6 +245,7 @@ protected void restartDeadTasks() {\n         _logger.warn(\"Creating a new connector task for the datastream task {}\", datastreamTask);\n         _runningTasks.put(datastreamTask, createKafkaConnectorTask(datastreamTask));\n       });\n+      _dynamicMetricsManager.createOrUpdateCounter(_metricsPrefix, NUM_TASK_RESTARTS, deadDatastreamTasks.size());", "originalCommit": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc1NzA0Mw==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471757043", "bodyText": "As discussed made this a Gauge.", "author": "vishwajith-s", "createdAt": "2020-08-17T20:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQwODE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxMzA5OQ==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r469413099", "bodyText": "This should be BrooklinCounterInfo if the metric is a counter.", "author": "ahmedahamid", "createdAt": "2020-08-12T17:11:09Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -553,4 +570,12 @@ public AbstractKafkaBasedConnectorTask getConnectorTask() {\n       return _task;\n     }\n   }\n+\n+  @Override\n+  public List<BrooklinMetricInfo> getMetricInfos() {\n+    List<BrooklinMetricInfo> metrics = new ArrayList<>();\n+    metrics.add(new BrooklinMeterInfo(buildMetricName(_metricsPrefix + MetricsAware.KEY_REGEX + NUM_TASK_RESTARTS)));", "originalCommit": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxNzgzMw==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r469417833", "bodyText": "@ahmedahamid instead of using buildMetricName() here, which prepends the class, can we instead do what other  similar metrics do? One example from KafkaMirrorMakerConnectorTask:\n    metrics.add(new BrooklinMeterInfo(generateMetricsPrefix(connectorName, CLASS_NAME) + MetricsAware.KEY_REGEX + TASK_LOCK_ACQUIRE_ERROR_RATE));", "author": "somandal", "createdAt": "2020-08-12T17:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxMzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ4MzcyNA==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r469483724", "bodyText": "Discussed with @ahmedahamid offline, and we don't need a MetricsAware.KEY_REGEX here, since we don't have any dynamic element in the metric name. For the connector task metrics on the other hand, we do have the datastream or topic name as a dynamic part.", "author": "somandal", "createdAt": "2020-08-12T19:15:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxMzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc1ODI4OA==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471758288", "bodyText": "@somandal discussed this with @ahmedahamid . We do not need Regex here as we do not have any variable parts here. But I made this a Gauge.", "author": "vishwajith-s", "createdAt": "2020-08-17T20:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxMzA5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxODgzMg==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r469418832", "bodyText": "@ahmedahamid and @vishwajith-s I just noticed that callers of this pass the \"connectorName\" when fetching metrics from the connectorTask. Should we also only return metrics for a given \"connectorName\" here?", "author": "somandal", "createdAt": "2020-08-12T17:20:27Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -553,4 +570,12 @@ public AbstractKafkaBasedConnectorTask getConnectorTask() {\n       return _task;\n     }\n   }\n+\n+  @Override\n+  public List<BrooklinMetricInfo> getMetricInfos() {", "originalCommit": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ4MzExMQ==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r469483111", "bodyText": "@vishwajith-s had a chat with @ahmedahamid about this offline. We do not need to pass the \"connectorName\" here, as the only metric available is the one we added as part of this PR and it is keyed based on the \"connectorName\". For the tasks, it looks like the method needed to be static for some reason, or it was an oversight, which is why the \"connectorName\" is passed.", "author": "somandal", "createdAt": "2020-08-12T19:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxODgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc3MzM4MA==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471773380", "bodyText": "@somandal with the recent changes, this may not be required.", "author": "vishwajith-s", "createdAt": "2020-08-17T21:02:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxODgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc3NTAzOA==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471775038", "bodyText": "connector name is being passed as part of metrics prefix", "author": "vishwajith-s", "createdAt": "2020-08-17T21:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxODgzMg=="}], "type": "inlineReview"}, {"oid": "09816fcc7f99bc4d5c6fe7bc505e1bb735c0d59d", "url": "https://github.com/linkedin/brooklin/commit/09816fcc7f99bc4d5c6fe7bc505e1bb735c0d59d", "message": "Addressed comments from Ahmed and Sonam\n\n* Rectified the mbean and msensor name mismatch\n* Converted the counter to gauge", "committedDate": "2020-08-17T20:58:50Z", "type": "commit"}, {"oid": "88358a12e0d66fd2a321ddd485b6650806740e6c", "url": "https://github.com/linkedin/brooklin/commit/88358a12e0d66fd2a321ddd485b6650806740e6c", "message": "Rearranged import orders", "committedDate": "2020-08-17T21:27:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1MzU5OQ==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471853599", "bodyText": "nit: prefer using Apache commons lang3 (just change the import to lang3)\nThis would entail adding the following dependency in build.gradle under\nproject(':datastream-kafka-connector') {\n    ....\n    compile \"org.apache.commons:commons-lang3:$commonslang3Version\"", "author": "ahmedahamid", "createdAt": "2020-08-18T00:58:16Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -28,6 +28,7 @@\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.stream.Collectors;\n \n+import org.apache.commons.lang.StringUtils;", "originalCommit": "88358a12e0d66fd2a321ddd485b6650806740e6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1NDA0OQ==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471854049", "bodyText": "Could you please have KafkaMirrorMakerConnector use this field instead of the private one it's maintaining against the same object (KafkaMirrorMakerConnector.java line 77)?", "author": "ahmedahamid", "createdAt": "2020-08-18T00:59:53Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -73,6 +77,11 @@\n   private static final Duration SHUTDOWN_EXECUTOR_SHUTDOWN_TIMEOUT = Duration.ofSeconds(30);\n   static final Duration MIN_DAEMON_THREAD_STARTUP_DELAY = Duration.ofMinutes(2);\n \n+  private static final String NUM_TASK_RESTARTS = \"numTaskRestarts\";\n+  private long _numTaskRestarts = 0;\n+  private final String _metricsPrefix;\n+\n+  protected final DynamicMetricsManager _dynamicMetricsManager;", "originalCommit": "88358a12e0d66fd2a321ddd485b6650806740e6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1NTM1Nw==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471855357", "bodyText": "_numTaskRestarts will be accessed by different threads (for reading and writing). I suggest marking it volatile.", "author": "ahmedahamid", "createdAt": "2020-08-18T01:04:42Z", "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -118,6 +127,10 @@ public AbstractKafkaConnector(String connectorName, Properties config, GroupIdCo\n     _clusterName = clusterName;\n     _config = new KafkaBasedConnectorConfig(config);\n     _groupIdConstructor = groupIdConstructor;\n+    _dynamicMetricsManager = DynamicMetricsManager.getInstance();\n+    _metricsPrefix = StringUtils.isBlank(connectorName) ? this.getClass().getSimpleName()\n+        : connectorName + \".\" + this.getClass().getSimpleName();\n+    _dynamicMetricsManager.registerGauge(_metricsPrefix, NUM_TASK_RESTARTS, () -> _numTaskRestarts);", "originalCommit": "88358a12e0d66fd2a321ddd485b6650806740e6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1ODM5NA==", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471858394", "bodyText": "By default, this verification won't include metrics that do not start with the class name of the metricsAware object in question, i.e. it won't consider the metric test.TestKafkaConnector.numTaskRestarts because it doesn't start with TestKafkaConnector. To have it include that metric, you'll need to pass in a predicate that explicitly includes such metrics, e.g. s -> s.startsWith(\"test\")", "author": "ahmedahamid", "createdAt": "2020-08-18T01:15:50Z", "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/TestAbstractKafkaConnector.java", "diffHunk": "@@ -50,6 +62,16 @@ public void testConnectorRestartCalled() {\n         Duration.ofSeconds(10).toMillis());\n     Assert.assertTrue(connector.getCreateTaskCalled() >= 3);\n \n+    // Verify metric for nanny task restarts get incremented\n+    Gauge<Long> metric = DynamicMetricsManager.getInstance()\n+        .getMetric(\"test\" + \".\" + TestKafkaConnector.class.getSimpleName() + \".\" + \"numTaskRestarts\");\n+    Assert.assertNotNull(metric);\n+    Assert.assertEquals(metric.getValue(), Long.valueOf(1));\n+\n+    // Verify that metrics created through DynamicMetricsManager match those returned by getMetricInfos() given the\n+    // connector name of interest.\n+    MetricsTestUtils.verifyMetrics(connector, DynamicMetricsManager.getInstance());", "originalCommit": "88358a12e0d66fd2a321ddd485b6650806740e6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "24bf41816f0f6cd05e36ecd8a3f1ff83c7ffabb1", "url": "https://github.com/linkedin/brooklin/commit/24bf41816f0f6cd05e36ecd8a3f1ff83c7ffabb1", "message": "Addressed comments from Ahmed", "committedDate": "2020-08-18T12:55:51Z", "type": "commit"}]}