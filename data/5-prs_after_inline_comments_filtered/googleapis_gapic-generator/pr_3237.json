{"pr_number": 3237, "pr_title": "feat: preserve some values when regenerating BUILD.bazel", "pr_createdAt": "2020-06-18T16:51:42Z", "pr_url": "https://github.com/googleapis/gapic-generator/pull/3237", "timeline": [{"oid": "45afa4ea524db5716d049835220cb410031f536f", "url": "https://github.com/googleapis/gapic-generator/commit/45afa4ea524db5716d049835220cb410031f536f", "message": "feat: preserve some values when regenerating BUILD.bazel", "committedDate": "2020-06-18T16:34:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NDA3NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442394075", "bodyText": "I don't think this will match the java_gapic_assembly_gradle_pkg (example). Maybe kind.contains(\"_gapic_assembly_\") instead?", "author": "noahdietz", "createdAt": "2020-06-18T17:37:56Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ApiVersionedDir.java", "diffHunk": "@@ -285,6 +320,49 @@ void parseJsonFile(String fileName, String fileBody) {\n     }\n   }\n \n+  void parseBazelBuildFile(Path file) {\n+    try {\n+      Buildozer buildozer = Buildozer.getInstance();\n+\n+      // We cannot and we do not want to preserve all the content of the file.\n+      // We will let the user edit just the following:\n+      // - names of the final targets (*_gapic_assembly_pkg) because they are user-facing;\n+      // - extra protoc plugin parameters for *_gapic_library rules.\n+      List<String> allRules = buildozer.execute(file, \"print kind name\", \":*\");\n+      for (String rule : allRules) {\n+        String[] split = rule.split(\" \");\n+        if (split.length != 2) {\n+          continue;\n+        }\n+        String kind = split[0];\n+        String name = split[1];\n+        if (kind.endsWith(\"_gapic_assembly_pkg\")) {", "originalCommit": "45afa4ea524db5716d049835220cb410031f536f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3NjgxNw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442476817", "bodyText": "Good point! Changing to .contains(\"_gapic_assembly_\").", "author": "alexander-fenster", "createdAt": "2020-06-18T20:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NDA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NzE4MQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442397181", "bodyText": "Does this work with multi-line lists? i.e.\ndeps = [\n  \"foo\",\n  \"bar\",\n  \"baz\",\n],\n\nI wonder if the representation buildozer supplies the code is stripped of such whitespace/formatting.", "author": "noahdietz", "createdAt": "2020-06-18T17:43:54Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ApiVersionedDir.java", "diffHunk": "@@ -285,6 +320,49 @@ void parseJsonFile(String fileName, String fileBody) {\n     }\n   }\n \n+  void parseBazelBuildFile(Path file) {\n+    try {\n+      Buildozer buildozer = Buildozer.getInstance();\n+\n+      // We cannot and we do not want to preserve all the content of the file.\n+      // We will let the user edit just the following:\n+      // - names of the final targets (*_gapic_assembly_pkg) because they are user-facing;\n+      // - extra protoc plugin parameters for *_gapic_library rules.\n+      List<String> allRules = buildozer.execute(file, \"print kind name\", \":*\");\n+      for (String rule : allRules) {\n+        String[] split = rule.split(\" \");\n+        if (split.length != 2) {\n+          continue;\n+        }\n+        String kind = split[0];\n+        String name = split[1];\n+        if (kind.endsWith(\"_gapic_assembly_pkg\")) {\n+          this.assemblyPkgRulesNames.put(kind, name);\n+        } else if (kind.endsWith(\"_gapic_library\")) {\n+          this.overriddenStringAttributes.put(name, new HashMap<String, String>());\n+          this.overriddenListAttributes.put(name, new HashMap<String, List<String>>());\n+          for (String attr : ApiVersionedDir.PRESERVED_PROTO_LIBRARY_STRING_ATTRIBUTES) {\n+            String value = buildozer.getAttribute(file, name, attr);\n+            if (value != null) {\n+              this.overriddenStringAttributes.get(name).put(attr, value);\n+            }\n+          }\n+          for (String attr : ApiVersionedDir.PRESERVED_PROTO_LIBRARY_LIST_ATTRIBUTES) {\n+            String value = buildozer.getAttribute(file, name, attr);\n+            if (value != null && value.startsWith(\"[\") && value.endsWith(\"]\")) {", "originalCommit": "45afa4ea524db5716d049835220cb410031f536f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3MTU2Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442471566", "bodyText": "Yes, buildozer will return this as a single line [foo bar baz].", "author": "alexander-fenster", "createdAt": "2020-06-18T20:01:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NzE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NzgwMQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442397801", "bodyText": "Does buildozer express a list as space-delimited and strip the comma-separators we have?", "author": "noahdietz", "createdAt": "2020-06-18T17:44:58Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ApiVersionedDir.java", "diffHunk": "@@ -285,6 +320,49 @@ void parseJsonFile(String fileName, String fileBody) {\n     }\n   }\n \n+  void parseBazelBuildFile(Path file) {\n+    try {\n+      Buildozer buildozer = Buildozer.getInstance();\n+\n+      // We cannot and we do not want to preserve all the content of the file.\n+      // We will let the user edit just the following:\n+      // - names of the final targets (*_gapic_assembly_pkg) because they are user-facing;\n+      // - extra protoc plugin parameters for *_gapic_library rules.\n+      List<String> allRules = buildozer.execute(file, \"print kind name\", \":*\");\n+      for (String rule : allRules) {\n+        String[] split = rule.split(\" \");\n+        if (split.length != 2) {\n+          continue;\n+        }\n+        String kind = split[0];\n+        String name = split[1];\n+        if (kind.endsWith(\"_gapic_assembly_pkg\")) {\n+          this.assemblyPkgRulesNames.put(kind, name);\n+        } else if (kind.endsWith(\"_gapic_library\")) {\n+          this.overriddenStringAttributes.put(name, new HashMap<String, String>());\n+          this.overriddenListAttributes.put(name, new HashMap<String, List<String>>());\n+          for (String attr : ApiVersionedDir.PRESERVED_PROTO_LIBRARY_STRING_ATTRIBUTES) {\n+            String value = buildozer.getAttribute(file, name, attr);\n+            if (value != null) {\n+              this.overriddenStringAttributes.get(name).put(attr, value);\n+            }\n+          }\n+          for (String attr : ApiVersionedDir.PRESERVED_PROTO_LIBRARY_LIST_ATTRIBUTES) {\n+            String value = buildozer.getAttribute(file, name, attr);\n+            if (value != null && value.startsWith(\"[\") && value.endsWith(\"]\")) {\n+              value = value.substring(1, value.length() - 1);\n+              String[] values = value.split(\" \");", "originalCommit": "45afa4ea524db5716d049835220cb410031f536f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3NTE4Mw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442475183", "bodyText": "Yes. This is how it works:\nfenster-macbookpro:v1 fenster$ grep -A6 java_gapic_assembly_gradle_pkg'(' BUILD.bazel \njava_gapic_assembly_gradle_pkg(\n    name = \"google-cloud-language-v1-java\",\n    deps = [\n        \":language_java_gapic\",\n        \":language_java_grpc\",\n        \":language_java_proto\",\n        \":language_proto\",\nfenster-macbookpro:v1 fenster$ buildozer 'print deps' :google-cloud-language-v1-java\n[:language_java_gapic :language_java_grpc :language_java_proto :language_proto]", "author": "alexander-fenster", "createdAt": "2020-06-18T20:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NzgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQwMTExNA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442401114", "bodyText": "One can hope! But alas... \ud83d\ude09", "author": "noahdietz", "createdAt": "2020-06-18T17:50:49Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ApisVisitor.java", "diffHunk": "@@ -98,9 +98,7 @@ public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IO\n     } else if (fileName.endsWith(\".proto\")) {\n       bp.parseProtoFile(fileName, readFile(file));\n     } else if (fileName.endsWith(\".bazel\")) {\n-      // Consider merging BUILD.bazel files if it becomes necessary (i.e. people will be doing many\n-      // valuable manual edits in their BUILD.bazel files). This will complicate the whole logic\n-      // so not doing it for now, hoping it will not be required.", "originalCommit": "45afa4ea524db5716d049835220cb410031f536f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3NTc5Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442475796", "bodyText": "This comment was very helpful to find the actual place to make changes! :)", "author": "alexander-fenster", "createdAt": "2020-06-18T20:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQwMTExNA=="}], "type": "inlineReview"}, {"oid": "5977c0bc5dce7b2d985459744b17dcc4290ff98e", "url": "https://github.com/googleapis/gapic-generator/commit/5977c0bc5dce7b2d985459744b17dcc4290ff98e", "message": "pr feedback", "committedDate": "2020-06-18T22:34:52Z", "type": "commit"}, {"oid": "88252e7c1d6d8cffa2450c8aaf7b0752ae4f9a8b", "url": "https://github.com/googleapis/gapic-generator/commit/88252e7c1d6d8cffa2450c8aaf7b0752ae4f9a8b", "message": "use bazel version v2.2.0", "committedDate": "2020-06-18T22:45:53Z", "type": "commit"}, {"oid": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "url": "https://github.com/googleapis/gapic-generator/commit/a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "message": "added comment to the generated BUILD.bazel", "committedDate": "2020-06-18T23:10:05Z", "type": "commit"}, {"oid": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "url": "https://github.com/googleapis/gapic-generator/commit/a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "message": "added comment to the generated BUILD.bazel", "committedDate": "2020-06-18T23:10:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4MTEwNA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442681104", "bodyText": "Please make all container fields (maps, lists, etc) final. It will make only the reference itself final (the map itself will still be modifiable).", "author": "vam-google", "createdAt": "2020-06-19T07:35:27Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ApiVersionedDir.java", "diffHunk": "@@ -123,6 +139,13 @@\n   //         https://www.googleapis.com/auth/cloud-platform\n   private boolean cloudScope;\n \n+  // Names of *_gapic_assembly_* rules (since they may be overridden by the user)\n+  private Map<String, String> assemblyPkgRulesNames = new HashMap<>();", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExODEzNw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443118137", "bodyText": "Done!", "author": "alexander-fenster", "createdAt": "2020-06-20T09:53:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4MTEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4MjQ1Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442682457", "bodyText": "Is this possible (length != 2)? If yes, what would be an example?", "author": "vam-google", "createdAt": "2020-06-19T07:38:22Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ApiVersionedDir.java", "diffHunk": "@@ -285,6 +320,49 @@ void parseJsonFile(String fileName, String fileBody) {\n     }\n   }\n \n+  void parseBazelBuildFile(Path file) {\n+    try {\n+      Buildozer buildozer = Buildozer.getInstance();\n+\n+      // We cannot and we do not want to preserve all the content of the file.\n+      // We will let the user edit just the following:\n+      // - names of the final targets (*_gapic_assembly_*) because they are user-facing;\n+      // - extra protoc plugin parameters for *_gapic_library rules.\n+      List<String> allRules = buildozer.execute(file, \"print kind name\", \":*\");\n+      for (String rule : allRules) {\n+        String[] split = rule.split(\" \");\n+        if (split.length != 2) {\n+          continue;", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExNzgyOQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443117829", "bodyText": "Yes this is possible for rules that have no name, e.g. package(default_visibility = .....).\n$ buildozer 'print name kind' :% | head -3\n package\nlanguage_proto proto_library\nlanguage_proto_with_info proto_library_with_info", "author": "alexander-fenster", "createdAt": "2020-06-20T09:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4MjQ1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExNzg0NA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443117844", "bodyText": "Added comment.", "author": "alexander-fenster", "createdAt": "2020-06-20T09:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4MjQ1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4NDA0Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442684047", "bodyText": "You should be able to use diamond syntax (i.e. just 'new HashMap<>()' without specifying parametrized types explicitly) in arguments too (not only in assignments).", "author": "vam-google", "createdAt": "2020-06-19T07:41:45Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ApiVersionedDir.java", "diffHunk": "@@ -285,6 +320,49 @@ void parseJsonFile(String fileName, String fileBody) {\n     }\n   }\n \n+  void parseBazelBuildFile(Path file) {\n+    try {\n+      Buildozer buildozer = Buildozer.getInstance();\n+\n+      // We cannot and we do not want to preserve all the content of the file.\n+      // We will let the user edit just the following:\n+      // - names of the final targets (*_gapic_assembly_*) because they are user-facing;\n+      // - extra protoc plugin parameters for *_gapic_library rules.\n+      List<String> allRules = buildozer.execute(file, \"print kind name\", \":*\");\n+      for (String rule : allRules) {\n+        String[] split = rule.split(\" \");\n+        if (split.length != 2) {\n+          continue;\n+        }\n+        String kind = split[0];\n+        String name = split[1];\n+        if (kind.contains(\"_gapic_assembly_\")) {\n+          this.assemblyPkgRulesNames.put(kind, name);\n+        } else if (kind.endsWith(\"_gapic_library\")) {\n+          this.overriddenStringAttributes.put(name, new HashMap<String, String>());", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExODE5OA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443118198", "bodyText": "Yep, it works, thank you!", "author": "alexander-fenster", "createdAt": "2020-06-20T09:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4NDA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4NDY5Mg==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442684692", "bodyText": "How will this logic work if there is more than one instance of the same rule type in build file? (i.e. like two java_gapic_library targets in the same BUIDL.bazel file?)", "author": "vam-google", "createdAt": "2020-06-19T07:43:04Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ApiVersionedDir.java", "diffHunk": "@@ -285,6 +320,49 @@ void parseJsonFile(String fileName, String fileBody) {\n     }\n   }\n \n+  void parseBazelBuildFile(Path file) {\n+    try {\n+      Buildozer buildozer = Buildozer.getInstance();\n+\n+      // We cannot and we do not want to preserve all the content of the file.\n+      // We will let the user edit just the following:\n+      // - names of the final targets (*_gapic_assembly_*) because they are user-facing;\n+      // - extra protoc plugin parameters for *_gapic_library rules.\n+      List<String> allRules = buildozer.execute(file, \"print kind name\", \":*\");\n+      for (String rule : allRules) {\n+        String[] split = rule.split(\" \");\n+        if (split.length != 2) {\n+          continue;\n+        }\n+        String kind = split[0];\n+        String name = split[1];\n+        if (kind.contains(\"_gapic_assembly_\")) {\n+          this.assemblyPkgRulesNames.put(kind, name);\n+        } else if (kind.endsWith(\"_gapic_library\")) {", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExODYwNw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443118607", "bodyText": "It won't work. Let's just throw an exception in this case and ask the user to use --overwrite, what do you think?", "author": "alexander-fenster", "createdAt": "2020-06-20T10:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4NDY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg0NzgxOA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443847818", "bodyText": "Looks Ok to me.", "author": "vam-google", "createdAt": "2020-06-22T21:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4NDY5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4ODE3OA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442688178", "bodyText": "argNameVal.length will still be !=2, so line 22 will give true and then continue on line 24", "author": "vam-google", "createdAt": "2020-06-19T07:50:15Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ArgsParser.java", "diffHunk": "@@ -15,6 +15,10 @@\n   ArgsParser(String[] args) {\n     for (String arg : args) {\n       String[] argNameVal = arg.split(\"=\");\n+      if (argNameVal.length == 1) {", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExODY5Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443118696", "bodyText": "But I have continue in line 20 so it won't get to line 22 in this case.", "author": "alexander-fenster", "createdAt": "2020-06-20T10:02:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4ODE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4OTAyNg==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442689026", "bodyText": "When executed from googleapis (the actual workflow people use), the target is called //:build_gen (not //rules_gapic/bazel:build_file_generator), which makes this help very confusing.", "author": "vam-google", "createdAt": "2020-06-19T07:52:01Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ArgsParser.java", "diffHunk": "@@ -29,15 +33,37 @@\n               + \"The required arguments are: \"\n               + required;\n       System.out.println(msg);\n+      ArgsParser.printUsage();\n       throw new IllegalArgumentException(msg);\n     }\n   }\n \n+  static void printUsage() {\n+    String helpMessage =\n+        \"Usage:\\n\"\n+            + \"  bazel run //rules_gapic/bazel:build_file_generator -- \\n\"", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExODgzOA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443118838", "bodyText": "Changed the help text.", "author": "alexander-fenster", "createdAt": "2020-06-20T10:04:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4OTAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4OTQ0Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r442689447", "bodyText": "There is also --dest argument (which is equal to --src if not specified explicitly)", "author": "vam-google", "createdAt": "2020-06-19T07:52:53Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ArgsParser.java", "diffHunk": "@@ -29,15 +33,37 @@\n               + \"The required arguments are: \"\n               + required;\n       System.out.println(msg);\n+      ArgsParser.printUsage();\n       throw new IllegalArgumentException(msg);\n     }\n   }\n \n+  static void printUsage() {\n+    String helpMessage =\n+        \"Usage:\\n\"\n+            + \"  bazel run //rules_gapic/bazel:build_file_generator -- \\n\"\n+            + \"    --src=rules_gapic/bazel/src/test/data/googleapis\\n\"\n+            + \"\\n\"\n+            + \"Command line options:\\n\"\n+            + \"  --src=path: location of googleapis directory\\n\"", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExODgyOA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443118828", "bodyText": "Added, thank you!", "author": "alexander-fenster", "createdAt": "2020-06-20T10:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4OTQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzE1Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443027157", "bodyText": "Given stuff like this, I'm leaning towards making bazel-merge logic an \"opt-in\" (now it is \"opt-out\") by command line argument. It seems not flexible enough to be the default behavior.", "author": "vam-google", "createdAt": "2020-06-19T20:17:37Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/BazelBuildFileTemplate.java", "diffHunk": "@@ -32,7 +38,71 @@ private String expand(Map<String, String> tokens) {\n     return builder.toString();\n   }\n \n-  String expand(BazelBuildFileView bpv) {\n-    return this.expand(bpv.getTokens());\n+  String expand(BazelBuildFileView bpv) throws IOException {\n+    String expandedTemplate = this.expand(bpv.getTokens());\n+\n+    // Apply overrides\n+    Map<String, Map<String, String>> overriddenStringAttributes =\n+        bpv.getOverriddenStringAttributes();\n+    Map<String, Map<String, List<String>>> overriddenListAttributes =\n+        bpv.getOverriddenListAttributes();\n+    Map<String, String> assemblyPkgRulesNames = bpv.getAssemblyPkgRulesNames();\n+    if (overriddenStringAttributes.size() == 0\n+        && overriddenListAttributes.size() == 0\n+        && assemblyPkgRulesNames.size() == 0) {\n+      // nothing to override\n+      return expandedTemplate;\n+    }\n+\n+    // write the content of the build file to a temporary directory and fix it with Buildozer\n+    File tempdir = Files.createTempDirectory(\"build_file_generator_\").toFile();\n+    File buildBazel = new File(tempdir, \"BUILD.bazel\");\n+    Path buildBazelPath = buildBazel.toPath();\n+    Files.write(buildBazelPath, expandedTemplate.getBytes(StandardCharsets.UTF_8));\n+\n+    Buildozer buildozer = Buildozer.getInstance();\n+\n+    // First of all, rename the rules\n+    for (Map.Entry<String, String> entry : assemblyPkgRulesNames.entrySet()) {\n+      String kind = entry.getKey();\n+      String newName = entry.getValue();\n+      // Note: if there are multiple *_gapic_assembly_pkg rules for the same language,", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExODg5NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443118895", "bodyText": "So... for now I still think we should make it opt-in since regeneration with preserving parameters (e.g. for TypeScript generator) is going to be more common use case.", "author": "alexander-fenster", "createdAt": "2020-06-20T10:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExODk1NA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443118954", "bodyText": "I removed this comment because I'm now throwing an exception in this case during initial parsing.", "author": "alexander-fenster", "createdAt": "2020-06-20T10:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDY4NA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443030684", "bodyText": "Please make these final", "author": "vam-google", "createdAt": "2020-06-19T20:27:44Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/BazelBuildFileView.java", "diffHunk": "@@ -12,6 +12,9 @@\n class BazelBuildFileView {\n   private static final Pattern LABEL_NAME = Pattern.compile(\":\\\\w+$\");\n   private final Map<String, String> tokens = new HashMap<>();\n+  private Map<String, Map<String, String>> overriddenStringAttributes = new HashMap<>();", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExODk3MA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443118970", "bodyText": "Done", "author": "alexander-fenster", "createdAt": "2020-06-20T10:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzNzkzNw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443037937", "bodyText": "Is there any reason why these are all final? If no, please remove final modifier as it is not idiomatic for java to declare local variables final unless they are a part of a closure (which  is still very uncommon, unlike in js).", "author": "vam-google", "createdAt": "2020-06-19T20:48:02Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/Buildozer.java", "diffHunk": "@@ -0,0 +1,161 @@\n+package com.google.api.codegen.bazel;\n+\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.OutputStreamWriter;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class Buildozer {\n+  private static Buildozer instance = null;\n+  private File tempdir = null;\n+  private File buildozerBinary = null;\n+  private List<String> batch = null;\n+\n+  private Buildozer() throws IOException {\n+    tempdir = Files.createTempDirectory(\"build_file_generator_\").toFile();\n+    final String resourcePath = \"/rules_gapic/bazel/buildozer.bin\";\n+    final InputStream inputStream = (getClass().getResourceAsStream(resourcePath));\n+    buildozerBinary = new File(tempdir, \"buildozer.bin\");\n+    Files.copy(inputStream, buildozerBinary.getAbsoluteFile().toPath());\n+    buildozerBinary.setExecutable(true, false);\n+    buildozerBinary.deleteOnExit();\n+    tempdir.deleteOnExit();\n+    batch = new ArrayList<String>();\n+  }\n+\n+  // General purpose execute method. Runs buildozer with the given command line\n+  // arguments\n+  public List<String> execute(final String[] args, final String[] stdin) throws IOException {\n+    final ArrayList<String> cmdList = new ArrayList<String>(Arrays.asList(args));", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExODk3OQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443118979", "bodyText": "Nope - removed here and everywhere", "author": "alexander-fenster", "createdAt": "2020-06-20T10:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzNzkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA0MDIxOA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443040218", "bodyText": "Unless you need something specific from BufferedReader, please declare references as the interface type (Reader in this particular case)", "author": "vam-google", "createdAt": "2020-06-19T20:55:25Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/Buildozer.java", "diffHunk": "@@ -0,0 +1,161 @@\n+package com.google.api.codegen.bazel;\n+\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.OutputStreamWriter;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class Buildozer {\n+  private static Buildozer instance = null;\n+  private File tempdir = null;\n+  private File buildozerBinary = null;\n+  private List<String> batch = null;\n+\n+  private Buildozer() throws IOException {\n+    tempdir = Files.createTempDirectory(\"build_file_generator_\").toFile();\n+    final String resourcePath = \"/rules_gapic/bazel/buildozer.bin\";\n+    final InputStream inputStream = (getClass().getResourceAsStream(resourcePath));\n+    buildozerBinary = new File(tempdir, \"buildozer.bin\");\n+    Files.copy(inputStream, buildozerBinary.getAbsoluteFile().toPath());\n+    buildozerBinary.setExecutable(true, false);\n+    buildozerBinary.deleteOnExit();\n+    tempdir.deleteOnExit();\n+    batch = new ArrayList<String>();\n+  }\n+\n+  // General purpose execute method. Runs buildozer with the given command line\n+  // arguments\n+  public List<String> execute(final String[] args, final String[] stdin) throws IOException {\n+    final ArrayList<String> cmdList = new ArrayList<String>(Arrays.asList(args));\n+    cmdList.add(0, buildozerBinary.toString());\n+    final ProcessBuilder processBuilder = new ProcessBuilder(cmdList);\n+    final Process process = processBuilder.start();\n+    final BufferedWriter processStdin =\n+        new BufferedWriter(new OutputStreamWriter(process.getOutputStream()));\n+    final BufferedReader processStdout =", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExOTA2NA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443119064", "bodyText": "Done", "author": "alexander-fenster", "createdAt": "2020-06-20T10:08:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA0MDIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExOTE1MQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443119151", "bodyText": "Actually, I do need BufferedReader for readLine(), but I can use Writer interface instead of BufferedWriter.", "author": "alexander-fenster", "createdAt": "2020-06-20T10:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA0MDIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2ODQ3MQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443068471", "bodyText": "is it really necessary? If it is, why not just make it a requirement, instead of trying to fix users's input silently?", "author": "vam-google", "createdAt": "2020-06-19T22:41:41Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/Buildozer.java", "diffHunk": "@@ -0,0 +1,161 @@\n+package com.google.api.codegen.bazel;\n+\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.OutputStreamWriter;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class Buildozer {\n+  private static Buildozer instance = null;\n+  private File tempdir = null;\n+  private File buildozerBinary = null;\n+  private List<String> batch = null;\n+\n+  private Buildozer() throws IOException {\n+    tempdir = Files.createTempDirectory(\"build_file_generator_\").toFile();\n+    final String resourcePath = \"/rules_gapic/bazel/buildozer.bin\";\n+    final InputStream inputStream = (getClass().getResourceAsStream(resourcePath));\n+    buildozerBinary = new File(tempdir, \"buildozer.bin\");\n+    Files.copy(inputStream, buildozerBinary.getAbsoluteFile().toPath());\n+    buildozerBinary.setExecutable(true, false);\n+    buildozerBinary.deleteOnExit();\n+    tempdir.deleteOnExit();\n+    batch = new ArrayList<String>();\n+  }\n+\n+  // General purpose execute method. Runs buildozer with the given command line\n+  // arguments\n+  public List<String> execute(final String[] args, final String[] stdin) throws IOException {\n+    final ArrayList<String> cmdList = new ArrayList<String>(Arrays.asList(args));\n+    cmdList.add(0, buildozerBinary.toString());\n+    final ProcessBuilder processBuilder = new ProcessBuilder(cmdList);\n+    final Process process = processBuilder.start();\n+    final BufferedWriter processStdin =\n+        new BufferedWriter(new OutputStreamWriter(process.getOutputStream()));\n+    final BufferedReader processStdout =\n+        new BufferedReader(new InputStreamReader(process.getInputStream()));\n+\n+    if (stdin != null) {\n+      for (String line : stdin) {\n+        processStdin.write(line + \"\\n\");\n+      }\n+    }\n+    processStdin.close();\n+\n+    final List<String> result = new ArrayList<String>();\n+    String line = null;\n+    while ((line = processStdout.readLine()) != null) {\n+      result.add(line);\n+    }\n+\n+    return result;\n+  }\n+\n+  // Execute buildozer command for the given target\n+  public List<String> execute(final Path bazelBuildFile, final String command, String target)\n+      throws IOException {\n+    if (!target.startsWith(\":\")) {", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExOTI2NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443119265", "bodyText": "Just checked that it actually works without a colon. Changed the logic a little bit to make it easier.", "author": "alexander-fenster", "createdAt": "2020-06-20T10:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2ODQ3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2ODg0Mw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443068843", "bodyText": "Subjective, but String.format(\"%s%s\", bazelBuildFile, target) looks unnecessary,  bazelBuildFile + target  is looks shorter and cleaner.Using plus for string concatenation is still very idiomatic in java.", "author": "vam-google", "createdAt": "2020-06-19T22:43:24Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/Buildozer.java", "diffHunk": "@@ -0,0 +1,161 @@\n+package com.google.api.codegen.bazel;\n+\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.OutputStreamWriter;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class Buildozer {\n+  private static Buildozer instance = null;\n+  private File tempdir = null;\n+  private File buildozerBinary = null;\n+  private List<String> batch = null;\n+\n+  private Buildozer() throws IOException {\n+    tempdir = Files.createTempDirectory(\"build_file_generator_\").toFile();\n+    final String resourcePath = \"/rules_gapic/bazel/buildozer.bin\";\n+    final InputStream inputStream = (getClass().getResourceAsStream(resourcePath));\n+    buildozerBinary = new File(tempdir, \"buildozer.bin\");\n+    Files.copy(inputStream, buildozerBinary.getAbsoluteFile().toPath());\n+    buildozerBinary.setExecutable(true, false);\n+    buildozerBinary.deleteOnExit();\n+    tempdir.deleteOnExit();\n+    batch = new ArrayList<String>();\n+  }\n+\n+  // General purpose execute method. Runs buildozer with the given command line\n+  // arguments\n+  public List<String> execute(final String[] args, final String[] stdin) throws IOException {\n+    final ArrayList<String> cmdList = new ArrayList<String>(Arrays.asList(args));\n+    cmdList.add(0, buildozerBinary.toString());\n+    final ProcessBuilder processBuilder = new ProcessBuilder(cmdList);\n+    final Process process = processBuilder.start();\n+    final BufferedWriter processStdin =\n+        new BufferedWriter(new OutputStreamWriter(process.getOutputStream()));\n+    final BufferedReader processStdout =\n+        new BufferedReader(new InputStreamReader(process.getInputStream()));\n+\n+    if (stdin != null) {\n+      for (String line : stdin) {\n+        processStdin.write(line + \"\\n\");\n+      }\n+    }\n+    processStdin.close();\n+\n+    final List<String> result = new ArrayList<String>();\n+    String line = null;\n+    while ((line = processStdout.readLine()) != null) {\n+      result.add(line);\n+    }\n+\n+    return result;\n+  }\n+\n+  // Execute buildozer command for the given target\n+  public List<String> execute(final Path bazelBuildFile, final String command, String target)\n+      throws IOException {\n+    if (!target.startsWith(\":\")) {\n+      target = \":\" + target;\n+    }\n+    return execute(new String[] {command, String.format(\"%s%s\", bazelBuildFile, target)}, null);", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyMDU5MA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443120590", "bodyText": "After refactor, it's now \"%s:%s\" which looks a little bit better :)", "author": "alexander-fenster", "createdAt": "2020-06-20T10:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2ODg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2OTQ4NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443069485", "bodyText": "Please use try with resources block for these things try (BufferedWriter process = ...) {}. It will automatically close the streams (notice that processStdout not even closed explicitly in the code here and has to fallback to closing itself in finalize() method which is the last resort) .\nAlso it seems that processStdout is used only after processStdin is already closed. Please declare new variables as needed, not upfront (especially if they open new i/o streams) .", "author": "vam-google", "createdAt": "2020-06-19T22:46:32Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/Buildozer.java", "diffHunk": "@@ -0,0 +1,161 @@\n+package com.google.api.codegen.bazel;\n+\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.OutputStreamWriter;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class Buildozer {\n+  private static Buildozer instance = null;\n+  private File tempdir = null;\n+  private File buildozerBinary = null;\n+  private List<String> batch = null;\n+\n+  private Buildozer() throws IOException {\n+    tempdir = Files.createTempDirectory(\"build_file_generator_\").toFile();\n+    final String resourcePath = \"/rules_gapic/bazel/buildozer.bin\";\n+    final InputStream inputStream = (getClass().getResourceAsStream(resourcePath));\n+    buildozerBinary = new File(tempdir, \"buildozer.bin\");\n+    Files.copy(inputStream, buildozerBinary.getAbsoluteFile().toPath());\n+    buildozerBinary.setExecutable(true, false);\n+    buildozerBinary.deleteOnExit();\n+    tempdir.deleteOnExit();\n+    batch = new ArrayList<String>();\n+  }\n+\n+  // General purpose execute method. Runs buildozer with the given command line\n+  // arguments\n+  public List<String> execute(final String[] args, final String[] stdin) throws IOException {\n+    final ArrayList<String> cmdList = new ArrayList<String>(Arrays.asList(args));\n+    cmdList.add(0, buildozerBinary.toString());\n+    final ProcessBuilder processBuilder = new ProcessBuilder(cmdList);\n+    final Process process = processBuilder.start();\n+    final BufferedWriter processStdin =", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyMDcyNQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443120725", "bodyText": "Done!", "author": "alexander-fenster", "createdAt": "2020-06-20T10:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2OTQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NjgxMA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443076810", "bodyText": "This looks weird. Looks like this array is needed to only pass it to execute() as an argument, while execute simply reads it line by line (it can do the same with the list). Also it is generally considered a good practice to use collection types instead of using arrays directly in java. I.e. please accept collection directly in you execute method, it will make it more idiomatic and there will be no need in converting the collection to an array.\nThe same is true for the args argument for execute() - please consider using a map instead of an array.\n(if it is inspired by main(String[] args), main has to do it, because it is an entry point to the program and it must stick to the very basic stuff).", "author": "vam-google", "createdAt": "2020-06-19T23:28:52Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/Buildozer.java", "diffHunk": "@@ -0,0 +1,161 @@\n+package com.google.api.codegen.bazel;\n+\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.OutputStreamWriter;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class Buildozer {\n+  private static Buildozer instance = null;\n+  private File tempdir = null;\n+  private File buildozerBinary = null;\n+  private List<String> batch = null;\n+\n+  private Buildozer() throws IOException {\n+    tempdir = Files.createTempDirectory(\"build_file_generator_\").toFile();\n+    final String resourcePath = \"/rules_gapic/bazel/buildozer.bin\";\n+    final InputStream inputStream = (getClass().getResourceAsStream(resourcePath));\n+    buildozerBinary = new File(tempdir, \"buildozer.bin\");\n+    Files.copy(inputStream, buildozerBinary.getAbsoluteFile().toPath());\n+    buildozerBinary.setExecutable(true, false);\n+    buildozerBinary.deleteOnExit();\n+    tempdir.deleteOnExit();\n+    batch = new ArrayList<String>();\n+  }\n+\n+  // General purpose execute method. Runs buildozer with the given command line\n+  // arguments\n+  public List<String> execute(final String[] args, final String[] stdin) throws IOException {\n+    final ArrayList<String> cmdList = new ArrayList<String>(Arrays.asList(args));\n+    cmdList.add(0, buildozerBinary.toString());\n+    final ProcessBuilder processBuilder = new ProcessBuilder(cmdList);\n+    final Process process = processBuilder.start();\n+    final BufferedWriter processStdin =\n+        new BufferedWriter(new OutputStreamWriter(process.getOutputStream()));\n+    final BufferedReader processStdout =\n+        new BufferedReader(new InputStreamReader(process.getInputStream()));\n+\n+    if (stdin != null) {\n+      for (String line : stdin) {\n+        processStdin.write(line + \"\\n\");\n+      }\n+    }\n+    processStdin.close();\n+\n+    final List<String> result = new ArrayList<String>();\n+    String line = null;\n+    while ((line = processStdout.readLine()) != null) {\n+      result.add(line);\n+    }\n+\n+    return result;\n+  }\n+\n+  // Execute buildozer command for the given target\n+  public List<String> execute(final Path bazelBuildFile, final String command, String target)\n+      throws IOException {\n+    if (!target.startsWith(\":\")) {\n+      target = \":\" + target;\n+    }\n+    return execute(new String[] {command, String.format(\"%s%s\", bazelBuildFile, target)}, null);\n+  }\n+\n+  // Get the value of the given attribute of the given target\n+  public String getAttribute(final Path bazelBuildFile, String target, final String attribute)\n+      throws IOException {\n+    List<String> executeResult;\n+    try {\n+      executeResult = execute(bazelBuildFile, String.format(\"print %s\", attribute), target);\n+      String value = executeResult.get(0);\n+      if (value.equals(\"(missing)\")) {\n+        return null;\n+      }\n+      return value;\n+    } catch (IndexOutOfBoundsException ignored) {\n+      return null;\n+    }\n+  }\n+\n+  // Set the value to the given attribute of the given target. Apply changes\n+  // immediately.\n+  public void setAttribute(\n+      final Path bazelBuildFile, final String target, final String attribute, final String value)\n+      throws IOException {\n+    execute(bazelBuildFile, String.format(\"set %s \\\"%s\\\"\", attribute, value), target);\n+  }\n+\n+  // Remove the given attribute of the given target. Apply changes immediately.\n+  public void removeAttribute(\n+      final Path bazelBuildFile, final String target, final String attribute) throws IOException {\n+    execute(bazelBuildFile, String.format(\"remove %s\", attribute), target);\n+  }\n+\n+  // Add the value to the given list attribute of the given target. Apply changes\n+  // immediately.\n+  public void addAttribute(\n+      final Path bazelBuildFile, final String target, final String attribute, final String value)\n+      throws IOException {\n+    execute(bazelBuildFile, String.format(\"add %s \\\"%s\\\"\", attribute, value), target);\n+  }\n+\n+  // Set the value to the given attribute of the given target.\n+  // The changes will be applied when the whole batch is committed with .commit().\n+  public void batchSetAttribute(\n+      final Path bazelBuildFile, String target, final String attribute, final String value)\n+      throws IOException {\n+    if (!target.startsWith(\":\")) {\n+      target = \":\" + target;\n+    }\n+    batch.add(\n+        String.format(\"set %s \\\"%s\\\"|%s%s\", attribute, value, bazelBuildFile.toString(), target));\n+  }\n+\n+  // Remove the given attribute of the given target. Apply changes immediately.\n+  public void batchRemoveAttribute(final Path bazelBuildFile, String target, final String attribute)\n+      throws IOException {\n+    if (!target.startsWith(\":\")) {\n+      target = \":\" + target;\n+    }\n+    batch.add(String.format(\"remove %s|%s%s\", attribute, bazelBuildFile.toString(), target));\n+  }\n+\n+  // Add the value to the given list attribute of the given target.\n+  // The changes will be applied when the whole batch is committed with .commit().\n+  public void batchAddAttribute(\n+      final Path bazelBuildFile, String target, final String attribute, final String value)\n+      throws IOException {\n+    if (!target.startsWith(\":\")) {\n+      target = \":\" + target;\n+    }\n+    batch.add(\n+        String.format(\"add %s \\\"%s\\\"|%s%s\", attribute, value, bazelBuildFile.toString(), target));\n+  }\n+\n+  // Make all changes that are waiting in the batch.\n+  public void commit() throws IOException {\n+    if (batch.size() == 0) {\n+      return;\n+    }\n+    String[] stdin = new String[batch.size()];", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyMTU4NA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443121584", "bodyText": "Changed to lists (not maps, because the arguments are not k-v pairs most of the time).", "author": "alexander-fenster", "createdAt": "2020-06-20T10:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NjgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4MTM5Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443081396", "bodyText": "As we discussed offline plese try using classpath_resoruce in java_binary, maybe it will let your avoid copying the binary from java jar resoruce.", "author": "vam-google", "createdAt": "2020-06-20T00:02:29Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/Buildozer.java", "diffHunk": "@@ -0,0 +1,161 @@\n+package com.google.api.codegen.bazel;\n+\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.OutputStreamWriter;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class Buildozer {\n+  private static Buildozer instance = null;\n+  private File tempdir = null;\n+  private File buildozerBinary = null;\n+  private List<String> batch = null;\n+\n+  private Buildozer() throws IOException {\n+    tempdir = Files.createTempDirectory(\"build_file_generator_\").toFile();\n+    final String resourcePath = \"/rules_gapic/bazel/buildozer.bin\";", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyMDczNA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443120734", "bodyText": "Actually, I just figured that regular data still works.", "author": "alexander-fenster", "createdAt": "2020-06-20T10:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4MTM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4MjQzNQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443082435", "bodyText": "How hard would it be to make this stuff configurable (probably to the extent of passing it from command line)?", "author": "vam-google", "createdAt": "2020-06-20T00:11:50Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ApiVersionedDir.java", "diffHunk": "@@ -40,6 +44,18 @@\n \n   private static String CLOUD_AUTH_SCOPE = \"https://www.googleapis.com/auth/cloud-platform\";\n \n+  private static final String[] PRESERVED_PROTO_LIBRARY_STRING_ATTRIBUTES = {", "originalCommit": "a30ed2f04186e27975349ef3b9a2ce0be3b2ca16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyMDgwNw==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443120807", "bodyText": "I would prefer not to do it now until we have the first user who needs it. That's a kind of YAGNI :)", "author": "alexander-fenster", "createdAt": "2020-06-20T10:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4MjQzNQ=="}], "type": "inlineReview"}, {"oid": "97f2411dfab482459d720447c9b5228184746ac5", "url": "https://github.com/googleapis/gapic-generator/commit/97f2411dfab482459d720447c9b5228184746ac5", "message": "pr feedback", "committedDate": "2020-06-20T11:24:47Z", "type": "commit"}, {"oid": "97f2411dfab482459d720447c9b5228184746ac5", "url": "https://github.com/googleapis/gapic-generator/commit/97f2411dfab482459d720447c9b5228184746ac5", "message": "pr feedback", "committedDate": "2020-06-20T11:24:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg0ODU4OA==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r443848588", "bodyText": "Now the help became specific to googleapis context... That was kind of the reason why I did nto want to include any helps at all. Notice, the tool in its help speaks about how it must be executed from bazel (the java tool does not have to be bazel specific).", "author": "vam-google", "createdAt": "2020-06-22T21:56:46Z", "path": "rules_gapic/bazel/src/main/java/com/google/api/codegen/bazel/ArgsParser.java", "diffHunk": "@@ -29,15 +33,37 @@\n               + \"The required arguments are: \"\n               + required;\n       System.out.println(msg);\n+      ArgsParser.printUsage();\n       throw new IllegalArgumentException(msg);\n     }\n   }\n \n+  static void printUsage() {\n+    String helpMessage =\n+        \"Usage (when running from googleapis folder):\\n\"\n+            + \"  bazel run //:build_gen -- --src=rules_gapic/bazel/src/test/data/googleapis\\n\"", "originalCommit": "97f2411dfab482459d720447c9b5228184746ac5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7f6dcf9015197aca7fb0748c6d04462df954c5a0", "url": "https://github.com/googleapis/gapic-generator/commit/7f6dcf9015197aca7fb0748c6d04462df954c5a0", "message": "fix: accept buildozer path as a parameter", "committedDate": "2020-06-23T23:58:32Z", "type": "commit"}, {"oid": "7f6dcf9015197aca7fb0748c6d04462df954c5a0", "url": "https://github.com/googleapis/gapic-generator/commit/7f6dcf9015197aca7fb0748c6d04462df954c5a0", "message": "fix: accept buildozer path as a parameter", "committedDate": "2020-06-23T23:58:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU3NDM3Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3237#discussion_r444574376", "bodyText": "toString() is called automatically for all objects participating in string cancatenation. Please remove it (here and below)", "author": "vam-google", "createdAt": "2020-06-24T00:10:20Z", "path": "rules_gapic/bazel/src/test/java/com/google/api/codegen/bazel/BuildFileGeneratorTest.java", "diffHunk": "@@ -46,8 +48,11 @@ public void testRegeneration() throws IOException, InterruptedException {\n         .start()\n         .waitFor();\n \n+    String buildozerPath = getBuildozerPath();\n     Path copiedGoogleapis = Paths.get(tempDirPath.toString(), \"googleapis\");\n-    ArgsParser args = new ArgsParser(new String[] {\"--src=\" + copiedGoogleapis.toString()});\n+    ArgsParser args =\n+        new ArgsParser(\n+            new String[] {\"--buildozer=\" + buildozerPath, \"--src=\" + copiedGoogleapis.toString()});", "originalCommit": "7f6dcf9015197aca7fb0748c6d04462df954c5a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2bc118d091b252ae8cb38b66c2a161ccbe53a4da", "url": "https://github.com/googleapis/gapic-generator/commit/2bc118d091b252ae8cb38b66c2a161ccbe53a4da", "message": "pr feedback", "committedDate": "2020-06-24T00:15:21Z", "type": "commit"}]}