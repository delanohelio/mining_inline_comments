{"pr_number": 529, "pr_title": "CLDR-8383 fix some SQL issues with mail", "pr_createdAt": "2020-06-27T20:04:53Z", "pr_url": "https://github.com/unicode-org/cldr/pull/529", "timeline": [{"oid": "a4ab266558272dbb36694ea0c7d2f57d2f18810b", "url": "https://github.com/unicode-org/cldr/commit/a4ab266558272dbb36694ea0c7d2f57d2f18810b", "message": "CLDR-8383 fix some SQL issues with mail\n\n- cannot use first() on a forward only updateable resultset, changed to next()\n- cleaned up SurveyLog so that error messages aren't repeated.\n (Exception.toString() includes Exception.getMessage(), so do not need a separate getMessage())", "committedDate": "2020-09-08T15:27:05Z", "type": "commit"}, {"oid": "a4ab266558272dbb36694ea0c7d2f57d2f18810b", "url": "https://github.com/unicode-org/cldr/commit/a4ab266558272dbb36694ea0c7d2f57d2f18810b", "message": "CLDR-8383 fix some SQL issues with mail\n\n- cannot use first() on a forward only updateable resultset, changed to next()\n- cleaned up SurveyLog so that error messages aren't repeated.\n (Exception.toString() includes Exception.getMessage(), so do not need a separate getMessage())", "committedDate": "2020-09-08T15:27:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAwOTkzMA==", "url": "https://github.com/unicode-org/cldr/pull/529#discussion_r485009930", "bodyText": "this had put the message in twice,  t.toString() already has the message", "author": "srl295", "createdAt": "2020-09-08T15:28:15Z", "path": "tools/cldr-apps/src/org/unicode/cldr/web/SurveyLog.java", "diffHunk": "@@ -96,7 +96,7 @@ public static synchronized void logException(final Throwable exception, String w\n         sb.append(FIELD_SEP).append(LogField.LOGSITE).append(' ').append(StackTracker.currentStack()).append('\\n');\n         Throwable t = exception;\n         while (t != null) {\n-            sb.append(FIELD_SEP).append(LogField.MESSAGE).append(' ').append(t.toString()).append(' ').append(t.getMessage())", "originalCommit": "a4ab266558272dbb36694ea0c7d2f57d2f18810b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxMDU0NQ==", "url": "https://github.com/unicode-org/cldr/pull/529#discussion_r485010545", "bodyText": "this is the core change.  A forward-only cursor can't go \"back\" to next, and it turns out it is formally an error, even if 'rs.next()' is the first call.\nThere may be more instances of this, but this is the only  one i found.", "author": "srl295", "createdAt": "2020-09-08T15:29:05Z", "path": "tools/cldr-apps/src/org/unicode/cldr/web/MailSender.java", "diffHunk": "@@ -378,12 +380,11 @@ public void run() {\n                 conn = db.getDBConnection();\n                 conn.setAutoCommit(false);\n                 java.sql.Timestamp sqlnow = DBUtils.sqlNow();\n-                s = DBUtils.prepareForwardUpdateable(conn, \"select * from \" + CLDR_MAIL + \" where sent_date is NULL and id > ?  and try_count < 3 order by id \"\n+                s = DBUtils.prepareForwardUpdateable(conn, \"select * from \" + CLDR_MAIL + \" where sent_date is NULL and id > ? and try_count < 3 order by id \"\n                     + (DBUtils.db_Mysql ? \"limit 1\" : \"\"));\n                 s.setInt(1, lastIdProcessed);\n                 rs = s.executeQuery();\n-\n-                if (rs.first() == false) {\n+                if (rs.next() == false) { // No mail to send.", "originalCommit": "a4ab266558272dbb36694ea0c7d2f57d2f18810b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxMTE3NA==", "url": "https://github.com/unicode-org/cldr/pull/529#discussion_r485011174", "bodyText": "this confused me (though I wrote it :) \u2026so i added the comment.\nUnder heavy load, should more than one be processed at a time?", "author": "srl295", "createdAt": "2020-09-08T15:29:54Z", "path": "tools/cldr-apps/src/org/unicode/cldr/web/MailSender.java", "diffHunk": "@@ -336,6 +336,8 @@ private Properties getProperties() {\n \n     private int lastIdProcessed = -1; // spinner\n \n+    // Fetch one (1) row of mail that needs to be processed. Process it, then cause a new task to be created", "originalCommit": "a4ab266558272dbb36694ea0c7d2f57d2f18810b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}