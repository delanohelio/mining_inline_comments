{"pr_number": 740, "pr_title": "CLDR-13582 Make sure browser uses most recent JavaScript files for ST", "pr_createdAt": "2020-09-25T15:01:41Z", "pr_url": "https://github.com/unicode-org/cldr/pull/740", "timeline": [{"oid": "618f4414cc1c56560cd18a32dc1489d152cf3d8c", "url": "https://github.com/unicode-org/cldr/commit/618f4414cc1c56560cd18a32dc1489d152cf3d8c", "message": "CLDR-13582 Make sure browser uses most recent JavaScript files for ST\n\n-Implement a unit test for validating the hash value\n\n-New function CldrUtility.getCldrBaseDirHash for both TestMisc and SurveyAjax to get the hash value\n\n-Use getCldrBaseDirectory (not CLDR_DATA_HASH) for getCldrBaseDirHash\n\n-Move getGitHashForDir to CldrUtility (public for CLDRConfigImpl which cannot call getCldrBaseDirectory)\n\n-Delete some dead code concerning CLDR_WEB_TESTS", "committedDate": "2020-09-25T14:55:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4NjYyNA==", "url": "https://github.com/unicode-org/cldr/pull/740#discussion_r495086624", "bodyText": "minor: it's already been asserted as not-null on the prior line, so this is an unnecessary ifdef.", "author": "srl295", "createdAt": "2020-09-25T16:02:54Z", "path": "tools/cldr-apps/src/org/unicode/cldr/unittest/web/TestMisc.java", "diffHunk": "@@ -82,27 +83,26 @@ public void TestIsCoverageOrganization() {\n     }\n \n     public void TestGitHash() {\n-        final String appsVersion = CLDRConfigImpl.getGitHashForSlug(\"CLDR-Apps\");\n-        assertNotNull(\"getting CLDR-Apps version\", appsVersion);\n-        /*\n-         * TODO: fail if CLDRURLS.UNKNOWN_REVISION.equals(appsVersion))\n-         * and likewise for toolsVersion\n-         */\n-        // if (CLDRURLS.UNKNOWN_REVISION.equals(appsVersion)) {\n-        //    errln(\"\u274c appsVersion = UNKNOWN_REVISION: \" + appsVersion);\n-        // }\n-\n-        final String toolsVersion = CLDRConfigImpl.getGitHashForSlug(\"CLDR-Tools\");\n-        assertNotNull(\"getting CLDR-Tools version\", toolsVersion);\n-\n-        /*\n-         * TODO: add a regression test here for CLDR_DATA_HASH\n-         * Reference: https://unicode-org.atlassian.net/browse/CLDR-13582\n-         */\n-        // final String hash = CLDRConfig.getInstance().getProperty(\"CLDR_DATA_HASH\");\n-        // assertNotNull(\"getting CLDR_DATA_HASH\", hash);\n-        // if (hash != null && !hash.matches(\"[0-9a-f]+\")) {\n-        //    errln(\"\u274c CLDR_DATA_HASH is not hex: \" + hash);\n-        // }\n+        final String hash = CldrUtility.getCldrBaseDirHash();\n+        assertNotNull(\"getCldrBaseDirHash\", hash);\n+        if (hash != null) {", "originalCommit": "618f4414cc1c56560cd18a32dc1489d152cf3d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwODQxMg==", "url": "https://github.com/unicode-org/cldr/pull/740#discussion_r495108412", "bodyText": "the assertNotNull wouldn't stop execution of the rest of the method, though, would it? I didn't want to trigger a null pointer exception in that case", "author": "btangmu", "createdAt": "2020-09-25T16:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4NjYyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4NzM5NQ==", "url": "https://github.com/unicode-org/cldr/pull/740#discussion_r495087395", "bodyText": "it could be 'unknown' if git is missing or if the code was compiled from a source tarball?maybe this should be a warning?", "author": "srl295", "createdAt": "2020-09-25T16:04:14Z", "path": "tools/cldr-apps/src/org/unicode/cldr/unittest/web/TestMisc.java", "diffHunk": "@@ -82,27 +83,26 @@ public void TestIsCoverageOrganization() {\n     }\n \n     public void TestGitHash() {\n-        final String appsVersion = CLDRConfigImpl.getGitHashForSlug(\"CLDR-Apps\");\n-        assertNotNull(\"getting CLDR-Apps version\", appsVersion);\n-        /*\n-         * TODO: fail if CLDRURLS.UNKNOWN_REVISION.equals(appsVersion))\n-         * and likewise for toolsVersion\n-         */\n-        // if (CLDRURLS.UNKNOWN_REVISION.equals(appsVersion)) {\n-        //    errln(\"\u274c appsVersion = UNKNOWN_REVISION: \" + appsVersion);\n-        // }\n-\n-        final String toolsVersion = CLDRConfigImpl.getGitHashForSlug(\"CLDR-Tools\");\n-        assertNotNull(\"getting CLDR-Tools version\", toolsVersion);\n-\n-        /*\n-         * TODO: add a regression test here for CLDR_DATA_HASH\n-         * Reference: https://unicode-org.atlassian.net/browse/CLDR-13582\n-         */\n-        // final String hash = CLDRConfig.getInstance().getProperty(\"CLDR_DATA_HASH\");\n-        // assertNotNull(\"getting CLDR_DATA_HASH\", hash);\n-        // if (hash != null && !hash.matches(\"[0-9a-f]+\")) {\n-        //    errln(\"\u274c CLDR_DATA_HASH is not hex: \" + hash);\n-        // }\n+        final String hash = CldrUtility.getCldrBaseDirHash();\n+        assertNotNull(\"getCldrBaseDirHash\", hash);\n+        if (hash != null) {\n+            if (!hash.matches(\"[0-9a-f]+\")) {\n+                errln(\"\u274c getCldrBaseDirHash is not hex: \" + hash);", "originalCommit": "618f4414cc1c56560cd18a32dc1489d152cf3d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExNTIxNQ==", "url": "https://github.com/unicode-org/cldr/pull/740#discussion_r495115215", "bodyText": "That's a good point. On the other hand, if anyone runs Survey Tool in a context where the hash is unknown, cache busting will be broken. Warnings aren't always noticed in a timely fashion. It seems more important to prevent a regression in our actual usage, than to accommodate a hypothetical scenario.", "author": "btangmu", "createdAt": "2020-09-25T16:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4NzM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4OTczNw==", "url": "https://github.com/unicode-org/cldr/pull/740#discussion_r495089737", "bodyText": "So, in a test environment, you definitely don't have cldr-apps.war and thus no manifest to read \"CLDR-Apps\" from. You also might not have cldr*.jar for its tools manifest, if the tests are run in eclipse let's say.  So this might be a warning, but a challenge to get from the test environment.\nI don't know if you can use a warfile as if it were a jar on the classpath? If so, we could have a post build step, something like:   java -DCLDR_APPS_VERSION_TEST -classpath \u2026:\u2026:cldr*.jar:cldr-apps.war TestAll or something like that?", "author": "srl295", "createdAt": "2020-09-25T16:08:31Z", "path": "tools/cldr-apps/src/org/unicode/cldr/unittest/web/TestMisc.java", "diffHunk": "@@ -82,27 +83,26 @@ public void TestIsCoverageOrganization() {\n     }\n \n     public void TestGitHash() {\n-        final String appsVersion = CLDRConfigImpl.getGitHashForSlug(\"CLDR-Apps\");\n-        assertNotNull(\"getting CLDR-Apps version\", appsVersion);\n-        /*\n-         * TODO: fail if CLDRURLS.UNKNOWN_REVISION.equals(appsVersion))\n-         * and likewise for toolsVersion\n-         */\n-        // if (CLDRURLS.UNKNOWN_REVISION.equals(appsVersion)) {\n-        //    errln(\"\u274c appsVersion = UNKNOWN_REVISION: \" + appsVersion);\n-        // }\n-\n-        final String toolsVersion = CLDRConfigImpl.getGitHashForSlug(\"CLDR-Tools\");\n-        assertNotNull(\"getting CLDR-Tools version\", toolsVersion);\n-\n-        /*\n-         * TODO: add a regression test here for CLDR_DATA_HASH\n-         * Reference: https://unicode-org.atlassian.net/browse/CLDR-13582\n-         */\n-        // final String hash = CLDRConfig.getInstance().getProperty(\"CLDR_DATA_HASH\");\n-        // assertNotNull(\"getting CLDR_DATA_HASH\", hash);\n-        // if (hash != null && !hash.matches(\"[0-9a-f]+\")) {\n-        //    errln(\"\u274c CLDR_DATA_HASH is not hex: \" + hash);\n-        // }\n+        final String hash = CldrUtility.getCldrBaseDirHash();\n+        assertNotNull(\"getCldrBaseDirHash\", hash);\n+        if (hash != null) {\n+            if (!hash.matches(\"[0-9a-f]+\")) {\n+                errln(\"\u274c getCldrBaseDirHash is not hex: \" + hash);\n+            } else if (hash.length() < 8) {\n+                errln(\"\u274c getCldrBaseDirHash is shorter than 8 chars: \" + hash);\n+            }\n+        }\n+        final String strings[] = {\"CLDR-Apps\", \"CLDR-Tools\"};\n+        for (String s : strings) {\n+            final String version = CLDRConfigImpl.getGitHashForSlug(s);\n+            assertNotNull(\"getting \" + s + \" version\", version);\n+            /*\n+             * TODO: fail if CLDRURLS.UNKNOWN_REVISION.equals(version).\n+             * Currently they do equal CLDRURLS.UNKNOWN_REVISION, since SurveyMain.init isn't called for TestAll.", "originalCommit": "618f4414cc1c56560cd18a32dc1489d152cf3d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyNTc1Mg==", "url": "https://github.com/unicode-org/cldr/pull/740#discussion_r495125752", "bodyText": "I considered removing the getGitHashForSlug test entirely, or just the TODO. If you'd prefer either of those changes, that's OK with me.\nThat's all tangential to the cache-busting issue. I'm just concerned that a lot of code isn't under test at all, and the tight coupling with SurveyMain.init makes a lot of code hard to test. A unit test for getGitHashForSlug could be implemented using some other jar file, maybe a small one just for testing; or some other means of dependency injection. I don't know if you can use a warfile as if it were a jar on the classpath; it's very mysterious territory for me!", "author": "btangmu", "createdAt": "2020-09-25T17:16:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4OTczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5MDEwNQ==", "url": "https://github.com/unicode-org/cldr/pull/740#discussion_r495090105", "bodyText": "\ud83d\udc4d \"some time\" has passed, whatever it was :)", "author": "srl295", "createdAt": "2020-09-25T16:09:05Z", "path": "tools/cldr-apps/src/org/unicode/cldr/util/CLDRConfigImpl.java", "diffHunk": "@@ -80,13 +78,6 @@ protected Environment getDefaultEnvironment() {\n     }\n \n     CLDRConfigImpl() {\n-        // TODO remove this after some time- just warn people about the old message", "originalCommit": "618f4414cc1c56560cd18a32dc1489d152cf3d8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5MTEzMA==", "url": "https://github.com/unicode-org/cldr/pull/740#discussion_r495091130", "bodyText": "There's no comnon init() for CLDRConfig, but if there were, this line could move there.", "author": "srl295", "createdAt": "2020-09-25T16:10:53Z", "path": "tools/cldr-apps/src/org/unicode/cldr/util/CLDRConfigImpl.java", "diffHunk": "@@ -180,7 +171,7 @@ private synchronized void init() {\n         // The git version of the cldr.jar file embedded in cldr-apps.\n         survprops.put(\"CLDR_UTILITIES_HASH\", getGitHashForSlug(\"CLDR-Tools\"));\n         // The git version of the CLDR_DIR currently in use.\n-        survprops.put(\"CLDR_DATA_HASH\", getGitHashForDir(survprops.getProperty(\"CLDR_DIR\", null)));\n+        survprops.put(\"CLDR_DATA_HASH\", CldrUtility.getGitHashForDir(survprops.getProperty(\"CLDR_DIR\", null)));", "originalCommit": "618f4414cc1c56560cd18a32dc1489d152cf3d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyODQ1MQ==", "url": "https://github.com/unicode-org/cldr/pull/740#discussion_r495128451", "bodyText": "At first I tried to call getCldrBaseDirHash there but got \"Error: setDir() was already called once.\" Somehow putting the cart before the horse, I guess -- getCldrBaseDirHash calls getCldrBaseDirectory...", "author": "btangmu", "createdAt": "2020-09-25T17:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5MTEzMA=="}], "type": "inlineReview"}]}