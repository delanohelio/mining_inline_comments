{"pr_number": 2083, "pr_title": "Datanucleus/JDO instrumentation", "pr_createdAt": "2020-11-16T21:03:09Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2083", "timeline": [{"oid": "ecca835e2db0e9c1a7b03ed444baa217360ceef6", "url": "https://github.com/DataDog/dd-trace-java/commit/ecca835e2db0e9c1a7b03ed444baa217360ceef6", "message": "Fix broken connection+prepared statement unwrap", "committedDate": "2020-11-16T19:10:30Z", "type": "commit"}, {"oid": "764c5abca20985efd4688cf71daed11c478ce555", "url": "https://github.com/DataDog/dd-trace-java/commit/764c5abca20985efd4688cf71daed11c478ce555", "message": "Add ExecutionContext instrumentation", "committedDate": "2020-11-16T19:11:17Z", "type": "commit"}, {"oid": "880c88cc7e6232343b8571f012c3733cdeb8b047", "url": "https://github.com/DataDog/dd-trace-java/commit/880c88cc7e6232343b8571f012c3733cdeb8b047", "message": "Query instrumentation", "committedDate": "2020-11-16T19:11:17Z", "type": "commit"}, {"oid": "af9d38f563e63c6ec568cf14b500f6638a1fde43", "url": "https://github.com/DataDog/dd-trace-java/commit/af9d38f563e63c6ec568cf14b500f6638a1fde43", "message": "Transaction instrumentation", "committedDate": "2020-11-16T19:11:17Z", "type": "commit"}, {"oid": "1556436ebb2b6610d710360ad4aed0eb53fd0780", "url": "https://github.com/DataDog/dd-trace-java/commit/1556436ebb2b6610d710360ad4aed0eb53fd0780", "message": "fix muzzle", "committedDate": "2020-11-16T19:11:17Z", "type": "commit"}, {"oid": "f5fa22b77a47250d93101019cd34d5120b9ecf0a", "url": "https://github.com/DataDog/dd-trace-java/commit/f5fa22b77a47250d93101019cd34d5120b9ecf0a", "message": "tests", "committedDate": "2020-11-16T19:11:17Z", "type": "commit"}, {"oid": "ba51b34fd4215f8c98ebafb90c5a2fe4c01800cc", "url": "https://github.com/DataDog/dd-trace-java/commit/ba51b34fd4215f8c98ebafb90c5a2fe4c01800cc", "message": "LatestDepTest doesn't work", "committedDate": "2020-11-16T20:40:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1MDk5MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2083#discussion_r525050990", "bodyText": "Couldn't we use BaseDecorator.className(cls) here instead?", "author": "richardstartin", "createdAt": "2020-11-17T10:35:55Z", "path": "dd-java-agent/instrumentation/datanucleus-4/src/main/java/datadog/trace/instrumentation/datanucleus/ExecutionContextInstrumentation.java", "diffHunk": "@@ -0,0 +1,208 @@\n+package datadog.trace.instrumentation.datanucleus;\n+\n+import static datadog.trace.agent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.DDElementMatchers.implementsInterface;\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.NameMatchers.namedOneOf;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.datanucleus.DatanucleusDecorator.DATANUCLEUS_FIND_OBJECT;\n+import static datadog.trace.instrumentation.datanucleus.DatanucleusDecorator.DECORATE;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArguments;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import java.util.HashMap;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.datanucleus.ExecutionContext;\n+\n+@AutoService(Instrumenter.class)\n+public class ExecutionContextInstrumentation extends Instrumenter.Default {\n+  public ExecutionContextInstrumentation() {\n+    super(\"datanucleus\");\n+  }\n+\n+  private final ElementMatcher<ClassLoader> CLASS_LOADER_MATCHER =\n+      hasClassesNamed(\"org.datanucleus.ExecutionContext\");\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return CLASS_LOADER_MATCHER;\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return implementsInterface(named(\"org.datanucleus.ExecutionContext\"));\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\n+      packageName + \".DatanucleusDecorator\",\n+    };\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    final Map<ElementMatcher<? super MethodDescription>, String> transformers = new HashMap<>();\n+\n+    transformers.put(\n+        isMethod().and(namedOneOf(\"persistObject\", \"deleteObject\", \"refreshObject\")),\n+        ExecutionContextInstrumentation.class.getName() + \"$SingleObjectActionAdvice\");\n+\n+    transformers.put(\n+        isMethod()\n+            .and(namedOneOf(\"refreshAllObjects\", \"persistObjects\", \"deleteObjects\", \"findObjects\")),\n+        ExecutionContextInstrumentation.class.getName() + \"$MultiObjectActionAdvice\");\n+\n+    transformers.put(\n+        isMethod()\n+            .and(named(\"findObject\"))\n+            .and(takesArguments(4))\n+            .and(takesArgument(3, String.class)),\n+        ExecutionContextInstrumentation.class.getName() + \"$FindWithStringClassnameAdvice\");\n+    transformers.put(\n+        isMethod()\n+            .and(named(\"findObject\"))\n+            .and(takesArguments(4))\n+            .and(takesArgument(2, Class.class)),\n+        ExecutionContextInstrumentation.class.getName() + \"$FindWithClassAdvice\");\n+\n+    return transformers;\n+  }\n+\n+  public static class MultiObjectActionAdvice {\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static AgentScope startMethod(\n+        @Advice.This final ExecutionContext executionContext,\n+        @Advice.Origin(\"datanucleus.#m\") final String operationName) {\n+\n+      final AgentSpan span = startSpan(operationName);\n+      DECORATE.afterStart(span);\n+\n+      return activateSpan(span);\n+    }\n+\n+    @Advice.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)\n+    public static void endMethod(\n+        @Advice.Enter final AgentScope scope, @Advice.Thrown final Throwable throwable) {\n+\n+      if (scope == null) {\n+        return;\n+      }\n+\n+      AgentSpan span = scope.span();\n+      DECORATE.onError(span, throwable);\n+      DECORATE.beforeFinish(span);\n+\n+      span.finish();\n+      scope.close();\n+    }\n+  }\n+\n+  public static class SingleObjectActionAdvice {\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static AgentScope startMethod(\n+        @Advice.Origin(\"datanucleus.#m\") final String operationName,\n+        @Advice.Argument(0) Object entity) {\n+\n+      if (entity == null) {\n+        return null;\n+      }\n+\n+      final AgentSpan span = startSpan(operationName);\n+      DECORATE.afterStart(span);\n+\n+      return activateSpan(span);\n+    }\n+\n+    @Advice.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)\n+    public static void endMethod(\n+        @Advice.Enter final AgentScope scope,\n+        @Advice.Thrown final Throwable throwable,\n+        @Advice.Argument(0) Object entity) {\n+\n+      if (scope == null) {\n+        return;\n+      }\n+\n+      AgentSpan span = scope.span();\n+      DECORATE.onError(span, throwable);\n+      DECORATE.onOperation(span, entity);\n+      DECORATE.beforeFinish(span);\n+\n+      span.finish();\n+      scope.close();\n+    }\n+  }\n+\n+  public static class FindWithStringClassnameAdvice {\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static AgentScope startMethod() {\n+\n+      final AgentSpan span = startSpan(DATANUCLEUS_FIND_OBJECT);\n+      DECORATE.afterStart(span);\n+\n+      return activateSpan(span);\n+    }\n+\n+    @Advice.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)\n+    public static void endMethod(\n+        @Advice.Enter final AgentScope scope,\n+        @Advice.Thrown final Throwable throwable,\n+        @Advice.Argument(0) Object id,\n+        @Advice.Argument(3) String objectClassName) {\n+\n+      if (scope == null) {\n+        return;\n+      }\n+\n+      AgentSpan span = scope.span();\n+      DECORATE.setResourceFromIdOrClass(span, id, objectClassName);\n+      DECORATE.onError(span, throwable);\n+      DECORATE.beforeFinish(span);\n+\n+      span.finish();\n+      scope.close();\n+    }\n+  }\n+\n+  public static class FindWithClassAdvice {\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static AgentScope startMethod() {\n+\n+      final AgentSpan span = startSpan(DATANUCLEUS_FIND_OBJECT);\n+      DECORATE.afterStart(span);\n+\n+      return activateSpan(span);\n+    }\n+\n+    @Advice.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)\n+    public static void endMethod(\n+        @Advice.Enter final AgentScope scope,\n+        @Advice.Thrown final Throwable throwable,\n+        @Advice.Argument(0) Object id,\n+        @Advice.Argument(2) Class cls) {\n+\n+      if (scope == null) {\n+        return;\n+      }\n+\n+      AgentSpan span = scope.span();\n+      DECORATE.setResourceFromIdOrClass(span, id, cls == null ? null : cls.getName());", "originalCommit": "ba51b34fd4215f8c98ebafb90c5a2fe4c01800cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3OTMwNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2083#discussion_r527079305", "bodyText": "No because sometimes we have the \"id object\", sometimes we have the class, sometimes we only have the classname", "author": "randomanderson", "createdAt": "2020-11-19T17:45:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1MDk5MA=="}], "type": "inlineReview"}]}