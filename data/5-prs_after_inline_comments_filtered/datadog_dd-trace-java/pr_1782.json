{"pr_number": 1782, "pr_title": "Sampling priority based trace publishing lanes", "pr_createdAt": "2020-08-18T10:35:21Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1782", "timeline": [{"oid": "308046eb451f5c293c27b605e6fc28394e409477", "url": "https://github.com/DataDog/dd-trace-java/commit/308046eb451f5c293c27b605e6fc28394e409477", "message": "2 priority lane queue system for trace publishing", "committedDate": "2020-08-18T10:09:29Z", "type": "commit"}, {"oid": "8c4873f91cf770410c287dfaeb45f91f87c74e3c", "url": "https://github.com/DataDog/dd-trace-java/commit/8c4873f91cf770410c287dfaeb45f91f87c74e3c", "message": "propagate sampling priority to monitor for dropped traces", "committedDate": "2020-08-18T10:31:56Z", "type": "commit"}, {"oid": "20ad6a443ec28442ba7aebe96ebc6a7656279441", "url": "https://github.com/DataDog/dd-trace-java/commit/20ad6a443ec28442ba7aebe96ebc6a7656279441", "message": "make prioritization configurable, implement dead letter strategy, minor tweaks to queue consumption", "committedDate": "2020-08-18T12:18:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0NjUyMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1782#discussion_r472146520", "bodyText": "So are we calling yeild 50 times before we poll the second queue?", "author": "bantonsson", "createdAt": "2020-08-18T12:38:07Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/TraceProcessingWorker.java", "diffHunk": "@@ -196,26 +220,62 @@ private boolean shouldFlush() {\n     @Override\n     public void run() {\n       Thread thread = Thread.currentThread();\n-      int retries = 100;\n-      int polls = retries;\n       while (!thread.isInterrupted()) {\n-        Object event = primaryQueue.relaxedPoll();\n+        consumeFromPrimaryQueue();\n+      }\n+      log.info(\"datadog trace processor exited\");\n+    }\n+\n+    private void consumeFromPrimaryQueue() {\n+      int polls = 50;\n+      while (true) {\n+        Object event = primaryQueue.poll();\n         if (null != event) {\n+          // there's a high priority trace, consume it,\n+          // and then drain whatever's in the queue now\n           onEvent(event);\n-          polls = retries;\n+          consumeBatch(primaryQueue);\n         } else {\n-          if (polls > 50) {\n-            onSpinWait();\n-            --polls;\n-          } else if (polls > 0) {\n+          if (polls > 0) {\n+            // this is probably better than spinning when there\n+            // is a low number of CPUs, perhaps should do this instead of spinning above?\n+            // needs measurement in a low core environment\n             Thread.yield();", "originalCommit": "20ad6a443ec28442ba7aebe96ebc6a7656279441", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0OTI1NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1782#discussion_r472149254", "bodyText": "This needs refinement", "author": "richardstartin", "createdAt": "2020-08-18T12:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0NjUyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE1MzE1OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1782#discussion_r472153158", "bodyText": "I've changed it slightly, but it might be worth discussing.", "author": "richardstartin", "createdAt": "2020-08-18T12:44:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0NjUyMA=="}], "type": "inlineReview"}, {"oid": "79ebea4e12b641baa2eb8a4e26bfa339209c5c1d", "url": "https://github.com/DataDog/dd-trace-java/commit/79ebea4e12b641baa2eb8a4e26bfa339209c5c1d", "message": "make prioritization configurable, implement dead letter strategy, minor tweaks to queue consumption", "committedDate": "2020-08-18T12:44:31Z", "type": "forcePushed"}, {"oid": "be83897bb99058bcebd9766c85bec4082cd9b7d4", "url": "https://github.com/DataDog/dd-trace-java/commit/be83897bb99058bcebd9766c85bec4082cd9b7d4", "message": "make prioritization configurable, implement dead letter strategy, minor tweaks to queue consumption", "committedDate": "2020-08-18T12:58:23Z", "type": "commit"}, {"oid": "be83897bb99058bcebd9766c85bec4082cd9b7d4", "url": "https://github.com/DataDog/dd-trace-java/commit/be83897bb99058bcebd9766c85bec4082cd9b7d4", "message": "make prioritization configurable, implement dead letter strategy, minor tweaks to queue consumption", "committedDate": "2020-08-18T12:58:23Z", "type": "forcePushed"}, {"oid": "c1a77d47771fca4a8487bdff1abf731985c14f3d", "url": "https://github.com/DataDog/dd-trace-java/commit/c1a77d47771fca4a8487bdff1abf731985c14f3d", "message": "remove batch", "committedDate": "2020-08-18T14:08:41Z", "type": "commit"}, {"oid": "6c74ebeeec49e99885924580f3b17e9c25be9b82", "url": "https://github.com/DataDog/dd-trace-java/commit/6c74ebeeec49e99885924580f3b17e9c25be9b82", "message": "don't use past tense for method name", "committedDate": "2020-08-18T14:23:28Z", "type": "commit"}, {"oid": "94327ea3c637810106b99d012bd9c52ac0561874", "url": "https://github.com/DataDog/dd-trace-java/commit/94327ea3c637810106b99d012bd9c52ac0561874", "message": "remove unused class", "committedDate": "2020-08-18T14:44:59Z", "type": "commit"}, {"oid": "ef779b8fb1fdc8bb8f5c943c63dae7da08ff8a0e", "url": "https://github.com/DataDog/dd-trace-java/commit/ef779b8fb1fdc8bb8f5c943c63dae7da08ff8a0e", "message": "remove misleading comment", "committedDate": "2020-08-18T15:35:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMzMTQ3MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1782#discussion_r472331470", "bodyText": "the countdown latch works nicely here...", "author": "tylerbenson", "createdAt": "2020-08-18T16:37:47Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/Prioritization.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package datadog.trace.common.writer.ddagent;\n+\n+import static datadog.trace.common.sampling.PrioritySampling.SAMPLER_DROP;\n+import static datadog.trace.common.sampling.PrioritySampling.USER_DROP;\n+\n+import datadog.trace.core.DDSpan;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import org.jctools.queues.MessagePassingQueue;\n+\n+public enum Prioritization {\n+  FAST_LANE {\n+    @Override\n+    public PrioritizationStrategy create(\n+        MessagePassingQueue<Object> primary, MessagePassingQueue<Object> secondary) {\n+      return new FastLaneStrategy(primary, secondary);\n+    }\n+  },\n+  DEAD_LETTERS {\n+    @Override\n+    public PrioritizationStrategy create(\n+        MessagePassingQueue<Object> primary, MessagePassingQueue<Object> secondary) {\n+      return new DeadLettersStrategy(primary, secondary);\n+    }\n+  };\n+\n+  public abstract PrioritizationStrategy create(\n+      MessagePassingQueue<Object> primary, MessagePassingQueue<Object> secondary);\n+\n+  private static final class FastLaneStrategy implements PrioritizationStrategy {\n+\n+    private final MessagePassingQueue<Object> primary;\n+    private final MessagePassingQueue<Object> secondary;\n+\n+    private FastLaneStrategy(\n+        MessagePassingQueue<Object> primary, MessagePassingQueue<Object> secondary) {\n+      this.primary = primary;\n+      this.secondary = secondary;\n+    }\n+\n+    @Override\n+    public boolean publish(int priority, List<DDSpan> trace) {\n+      switch (priority) {\n+        case SAMPLER_DROP:\n+        case USER_DROP:\n+          return secondary.offer(trace);\n+        default:\n+          return primary.offer(trace);\n+      }\n+    }\n+\n+    @Override\n+    public boolean flush(long timeout, TimeUnit timeUnit) {\n+      // ok not to flush the secondary\n+      CountDownLatch latch = new CountDownLatch(1);\n+      FlushEvent event = new FlushEvent(latch);\n+      offer(primary, event);\n+      try {\n+        return latch.await(timeout, timeUnit);\n+      } catch (InterruptedException e) {\n+        Thread.currentThread().interrupt();\n+        return false;\n+      }\n+    }\n+\n+    private void offer(MessagePassingQueue<Object> queue, FlushEvent event) {\n+      boolean offered;\n+      do {\n+        offered = queue.offer(event);\n+      } while (!offered);\n+    }\n+  }\n+\n+  private static final class DeadLettersStrategy implements PrioritizationStrategy {\n+\n+    private final MessagePassingQueue<Object> primary;\n+    private final MessagePassingQueue<Object> secondary;\n+\n+    private DeadLettersStrategy(\n+        MessagePassingQueue<Object> primary, MessagePassingQueue<Object> secondary) {\n+      this.primary = primary;\n+      this.secondary = secondary;\n+    }\n+\n+    @Override\n+    public boolean publish(int priority, List<DDSpan> trace) {\n+      if (!primary.offer(trace)) {\n+        switch (priority) {\n+          case SAMPLER_DROP:\n+          case USER_DROP:\n+            return false;\n+          default:\n+            return secondary.offer(trace);\n+        }\n+      }\n+      return true;\n+    }\n+\n+    @Override\n+    public boolean flush(long timeout, TimeUnit timeUnit) {\n+      // both queues need to be flushed\n+      CountDownLatch latch = new CountDownLatch(2);", "originalCommit": "ef779b8fb1fdc8bb8f5c943c63dae7da08ff8a0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjgzMDIxNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1782#discussion_r472830215", "bodyText": "Maybe just me, but I would love to have some comment that explains the intended flow.\nAFAICS, as long as we can consume from primary or secondary we spin around and continue to consume, but if we fail to consume from both we yield at most 50 times and then we parkNanos a millisecond before we go back to the outer loop, to hopefully let other threads in.", "author": "bantonsson", "createdAt": "2020-08-19T07:58:31Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/TraceProcessingWorker.java", "diffHunk": "@@ -196,26 +218,53 @@ private boolean shouldFlush() {\n     @Override\n     public void run() {\n       Thread thread = Thread.currentThread();\n-      int retries = 100;\n-      int polls = retries;\n       while (!thread.isInterrupted()) {\n-        Object event = primaryQueue.relaxedPoll();\n+        consumeFromPrimaryQueue();\n+      }\n+      log.info(\"datadog trace processor exited\");\n+    }\n+\n+    private void consumeFromPrimaryQueue() {", "originalCommit": "ef779b8fb1fdc8bb8f5c943c63dae7da08ff8a0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg0MTg5Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1782#discussion_r472841893", "bodyText": "So there seems to be two FlushEvent classes. This one and one at TraceProcessingWorker.FlushEvent. We never seem to check for this one.", "author": "bantonsson", "createdAt": "2020-08-19T08:11:41Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/FlushEvent.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package datadog.trace.common.writer.ddagent;\n+\n+import java.util.concurrent.CountDownLatch;\n+\n+final class FlushEvent {", "originalCommit": "ef779b8fb1fdc8bb8f5c943c63dae7da08ff8a0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg5ODk5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1782#discussion_r472898999", "bodyText": "There can be only one...", "author": "bantonsson", "createdAt": "2020-08-19T09:38:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg0MTg5Mw=="}], "type": "inlineReview"}, {"oid": "fbde1338b8dca1c84bedc6acc08b452dd495c653", "url": "https://github.com/DataDog/dd-trace-java/commit/fbde1338b8dca1c84bedc6acc08b452dd495c653", "message": "avoid test becoming flaky with new queue semantics", "committedDate": "2020-08-19T13:42:34Z", "type": "forcePushed"}, {"oid": "3b59b5cd5ec81bd62505bbd44a126e013e80d460", "url": "https://github.com/DataDog/dd-trace-java/commit/3b59b5cd5ec81bd62505bbd44a126e013e80d460", "message": "verify flush occurs, remove unused inner class, document queue polling strategy", "committedDate": "2020-08-19T14:10:54Z", "type": "commit"}, {"oid": "6f34057ce0deb7ad51907f87c3d080e8a39d59e9", "url": "https://github.com/DataDog/dd-trace-java/commit/6f34057ce0deb7ad51907f87c3d080e8a39d59e9", "message": "avoid test becoming flaky with new queue semantics", "committedDate": "2020-08-19T14:10:54Z", "type": "commit"}, {"oid": "6f34057ce0deb7ad51907f87c3d080e8a39d59e9", "url": "https://github.com/DataDog/dd-trace-java/commit/6f34057ce0deb7ad51907f87c3d080e8a39d59e9", "message": "avoid test becoming flaky with new queue semantics", "committedDate": "2020-08-19T14:10:54Z", "type": "forcePushed"}]}