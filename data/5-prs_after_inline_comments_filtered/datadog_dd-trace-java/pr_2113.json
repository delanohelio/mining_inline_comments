{"pr_number": 2113, "pr_title": "simplify tag interceptors", "pr_createdAt": "2020-11-23T22:08:49Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2113", "timeline": [{"oid": "cfc4a253ed73ea18ac0aa927eefca613a8ba787a", "url": "https://github.com/DataDog/dd-trace-java/commit/cfc4a253ed73ea18ac0aa927eefca613a8ba787a", "message": "simplify tag interceptors", "committedDate": "2020-11-26T16:43:04Z", "type": "forcePushed"}, {"oid": "5b89db6439c9f3c92aa54f5a1b8b23f105a9f8fc", "url": "https://github.com/DataDog/dd-trace-java/commit/5b89db6439c9f3c92aa54f5a1b8b23f105a9f8fc", "message": "simplify tag interceptors", "committedDate": "2020-11-26T16:59:49Z", "type": "forcePushed"}, {"oid": "0a9d40c613f3faf79fd43ff6477e9b0188acb4f4", "url": "https://github.com/DataDog/dd-trace-java/commit/0a9d40c613f3faf79fd43ff6477e9b0188acb4f4", "message": "dodge the unsafeTags lock where possible", "committedDate": "2020-11-26T18:43:35Z", "type": "forcePushed"}, {"oid": "f5a360408739a9af75430e492c7cf12cf3e44c8d", "url": "https://github.com/DataDog/dd-trace-java/commit/f5a360408739a9af75430e492c7cf12cf3e44c8d", "message": "move ResourceNameRule to tag interception", "committedDate": "2020-11-26T19:17:01Z", "type": "forcePushed"}, {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd", "url": "https://github.com/DataDog/dd-trace-java/commit/d6e5757396a57497426d8e3ec9c430082fbcafbd", "message": "move ResourceNameRule to tag interception", "committedDate": "2020-11-26T19:19:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5NzU3NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531197574", "bodyText": "These names all derive from the simple class names which were used as config at some point in the past. As to whether these are really used, we'll never know, but the names have been changed without notice or mention in release notes in the past, so this configurability may or may not be important to maintain.", "author": "richardstartin", "createdAt": "2020-11-26T19:21:20Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/taginterceptor/RuleFlags.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package datadog.trace.core.taginterceptor;\n+\n+import datadog.trace.api.Config;\n+\n+public class RuleFlags {\n+\n+  public enum Feature {\n+    RESOURCE_NAME(\"ResourceNameRule\"),", "originalCommit": "d6e5757396a57497426d8e3ec9c430082fbcafbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMDk5Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531420993", "bodyText": "Add a comment explaining that in the file?", "author": "bantonsson", "createdAt": "2020-11-27T07:22:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5NzU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUwMzgyOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531503828", "bodyText": "Done", "author": "richardstartin", "createdAt": "2020-11-27T10:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5NzU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5Nzg0Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531197846", "bodyText": "All tag interception logic is now encapsulated in this class. If you want to know what will happen to a tag, step away from the debugger and just look here...", "author": "richardstartin", "createdAt": "2020-11-26T19:22:20Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/taginterceptor/TagInterceptor.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package datadog.trace.core.taginterceptor;", "originalCommit": "d6e5757396a57497426d8e3ec9c430082fbcafbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMTM1NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531421354", "bodyText": "Nice", "author": "bantonsson", "createdAt": "2020-11-27T07:23:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5Nzg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5ODY5MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531198691", "bodyText": "This will probably have a decent impact on performance, because a lot of the time no lock needs to be acquired. Previously, with the hybrid tag interceptor and rules based approach, we would have to contend for the locks, possibly find some space in the map to temporarily store the tag value, and only then decide that the tag value should really have been a field all along, or that the tag value is useless.", "author": "richardstartin", "createdAt": "2020-11-26T19:25:14Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java", "diffHunk": "@@ -357,26 +351,14 @@ public void setMetric(final CharSequence key, final Number value) {\n    * @param value the value of the tag. tags with null values are ignored.\n    */\n   public void setTag(final String tag, final Object value) {\n-    // intercept tags we represent as fields but used to store in a weakly typed map\n-    switch (tag) {\n-      case SPAN_TYPE:\n-        if (value instanceof CharSequence) {\n-          this.spanType = (CharSequence) value;\n-        }\n-        break;\n-      case ANALYTICS_SAMPLE_RATE:\n-        Number analyticsSampleRate = getOrTryParse(value);\n-        if (null != analyticsSampleRate) {\n-          setMetric(ANALYTICS_SAMPLE_RATE, analyticsSampleRate);\n-        }\n-        break;\n-      case Tags.ERROR:\n-        setErrorFlag(Boolean.TRUE.equals(value) || Boolean.parseBoolean(String.valueOf(value)));\n-        break;\n-      default:\n-        synchronized (unsafeTags) {\n-          unsafeSetTag(tag, value);\n-        }\n+    if (null == value || \"\".equals(value)) {", "originalCommit": "d6e5757396a57497426d8e3ec9c430082fbcafbd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5OTM1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531199350", "bodyText": "Unrelated to this PR, but what's below is incredibly wasteful:\n      context.setAllTags(defaultSpanTags);\n      context.setAllTags(tags);\n      context.setAllTags(coreTags);\n      context.setAllTags(rootSpanTags);\nWe're passing effectively constant values through tag interceptors over and over again here.", "author": "richardstartin", "createdAt": "2020-11-26T19:27:19Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/CoreTracer.java", "diffHunk": "@@ -674,30 +646,14 @@ public CoreSpanBuilder asChildOf(final AgentSpan agentSpan) {\n \n     @Override\n     public CoreSpanBuilder withTag(final String tag, final Object value) {\n-      switch (tag) {\n-        case DDTags.ANALYTICS_SAMPLE_RATE:\n-          analyticsSampleRate = getOrTryParse(value);\n-          break;\n-        case Tags.ERROR:\n-          if (Boolean.TRUE.equals(value) || Boolean.parseBoolean(String.valueOf(value))) {\n-            return withErrorFlag();\n-          }\n-          break;\n-        case DDTags.SPAN_TYPE:\n-          if (value instanceof CharSequence) {\n-            return withSpanType((CharSequence) value);\n-          }\n-          break;\n-        default:\n-          Map<String, Object> tagMap = tags;\n-          if (tagMap == null) {\n-            tags = tagMap = new LinkedHashMap<>(); // Insertion order is important\n-          }\n-          if (value == null || (value instanceof String && ((String) value).isEmpty())) {\n-            tagMap.remove(tag);\n-          } else {\n-            tagMap.put(tag, value);\n-          }\n+      Map<String, Object> tagMap = tags;\n+      if (tagMap == null) {\n+        tags = tagMap = new LinkedHashMap<>(); // Insertion order is important\n+      }\n+      if (value == null || (value instanceof String && ((String) value).isEmpty())) {\n+        tagMap.remove(tag);\n+      } else {\n+        tagMap.put(tag, value);\n       }\n       return this;\n     }", "originalCommit": "d6e5757396a57497426d8e3ec9c430082fbcafbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQxOTY3MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531419670", "bodyText": "Yes indeed. The whole builder mechanism needs more cleanup.", "author": "bantonsson", "createdAt": "2020-11-27T07:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5OTM1MA=="}], "type": "inlineReview"}, {"oid": "27d5ba0aaa18d6ca55884b8b48eff1a1fc8e7c8f", "url": "https://github.com/DataDog/dd-trace-java/commit/27d5ba0aaa18d6ca55884b8b48eff1a1fc8e7c8f", "message": "move ResourceNameRule to tag interception", "committedDate": "2020-11-26T20:13:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMjQxNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531422414", "bodyText": "Is there anything in the backend that relies on this tag being set?", "author": "bantonsson", "createdAt": "2020-11-27T07:26:32Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/DatabaseClientDecorator.java", "diffHunk": "@@ -56,7 +56,7 @@ public AgentSpan onConnection(final AgentSpan span, final CONNECTION connection)\n \n   public AgentSpan onStatement(final AgentSpan span, final CharSequence statement) {\n     assert span != null;\n-    span.setTag(Tags.DB_STATEMENT, statement);\n+    span.setResourceName(statement);", "originalCommit": "27d5ba0aaa18d6ca55884b8b48eff1a1fc8e7c8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ0MTQ3Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531441477", "bodyText": "We were removing it before sending for all but Mongo. I will find out if Mongo spans need the statement set.", "author": "richardstartin", "createdAt": "2020-11-27T08:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMjQxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ1NTM4Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531455386", "bodyText": "I got confirmation this is not required in the backend or the agent. It might be an historical user preference.", "author": "richardstartin", "createdAt": "2020-11-27T08:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMjQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTkzNTYwOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531935608", "bodyText": "BitSet or even just byte with masks, since we have only 7 legacy names", "author": "lpriima", "createdAt": "2020-11-28T06:23:57Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/taginterceptor/RuleFlags.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package datadog.trace.core.taginterceptor;\n+\n+import datadog.trace.api.Config;\n+\n+public class RuleFlags {\n+\n+  public enum Feature {\n+    // These names all derive from the simple class names which\n+    // were exposed as config at some point in the past.\n+    RESOURCE_NAME(\"ResourceNameRule\"),\n+    DB_STATEMENT(\"DBStatementRule\"),\n+    FORCE_MANUAL_DROP(\"ForceManualDropTagInterceptor\"),\n+    FORCE_MANUAL_KEEP(\"ForceManualKeepTagInterceptor\"),\n+    PEER_SERVICE(\"PeerServiceTagInterceptor\"),\n+    SERVICE_NAME(\"ServiceNameTagInterceptor\"),\n+    SERVLET_CONTEXT(\"ServletContextTagInterceptor\");\n+\n+    private final String name;\n+\n+    Feature(String name) {\n+      this.name = name;\n+    }\n+  }\n+\n+  private final boolean[] flags;", "originalCommit": "e6cb0f89ed5d1c7d1657b62defd9ac0a47d8f852", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ0Njg5OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r532446898", "bodyText": "Actually, if we used a BitSet it would take up quite a bit more space, if that's what we care about, because it uses long[] as its storage and has an int and a boolean field. We could use a byte, but would have to change it if we ever added two more flags. I think boolean[] is probably the most obvious choice here.", "author": "richardstartin", "createdAt": "2020-11-30T09:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTkzNTYwOA=="}], "type": "inlineReview"}, {"oid": "93da61b5599ce96130c4b573f1fb3820703401a2", "url": "https://github.com/DataDog/dd-trace-java/commit/93da61b5599ce96130c4b573f1fb3820703401a2", "message": "simplify tag interceptors", "committedDate": "2020-11-30T15:40:37Z", "type": "commit"}, {"oid": "eb3a4e7331e5aa7874e17e0d72065ef3f67d293d", "url": "https://github.com/DataDog/dd-trace-java/commit/eb3a4e7331e5aa7874e17e0d72065ef3f67d293d", "message": "dodge the unsafeTags lock where possible", "committedDate": "2020-11-30T15:40:44Z", "type": "commit"}, {"oid": "f9f26d6b8a7ff64789456b243e09d7e7ccda2bb8", "url": "https://github.com/DataDog/dd-trace-java/commit/f9f26d6b8a7ff64789456b243e09d7e7ccda2bb8", "message": "replace DBResourceNameRule with tag interception, refactor mongo instrumentation not to set db.statement (which duplicates its resource name)", "committedDate": "2020-11-30T15:40:45Z", "type": "commit"}, {"oid": "dddfeb75cd721c5676109a3b136430901d5bdcc0", "url": "https://github.com/DataDog/dd-trace-java/commit/dddfeb75cd721c5676109a3b136430901d5bdcc0", "message": "move ResourceNameRule to tag interception", "committedDate": "2020-11-30T15:40:45Z", "type": "commit"}, {"oid": "e73aa86da63482eea44d1aad675ab6cb24385721", "url": "https://github.com/DataDog/dd-trace-java/commit/e73aa86da63482eea44d1aad675ab6cb24385721", "message": "add comment about provenance of config names", "committedDate": "2020-11-30T15:40:45Z", "type": "commit"}, {"oid": "e73aa86da63482eea44d1aad675ab6cb24385721", "url": "https://github.com/DataDog/dd-trace-java/commit/e73aa86da63482eea44d1aad675ab6cb24385721", "message": "add comment about provenance of config names", "committedDate": "2020-11-30T15:40:45Z", "type": "forcePushed"}]}