{"pr_number": 1928, "pr_title": "[PROF-1988] default stackdepth", "pr_createdAt": "2020-09-29T16:27:15Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1928", "timeline": [{"oid": "f01014333ecfbdc2acfbab348ec16789c07dfcd8", "url": "https://github.com/DataDog/dd-trace-java/commit/f01014333ecfbdc2acfbab348ec16789c07dfcd8", "message": "DRAFT stackdepth", "committedDate": "2020-09-29T16:10:34Z", "type": "commit"}, {"oid": "f8782940f74bbf9c55b2fbb8bbee380b786d095e", "url": "https://github.com/DataDog/dd-trace-java/commit/f8782940f74bbf9c55b2fbb8bbee380b786d095e", "message": "set JFR.configure stackdepth on profiler start\n\n* uses 256 stack depth default\n* respects user-supplied over-ride for max stack depth\n* limits clients to a 1024 max stack depth", "committedDate": "2020-09-29T16:16:48Z", "type": "commit"}, {"oid": "96af86377430da9a615a574e577aec1ee342c967", "url": "https://github.com/DataDog/dd-trace-java/commit/96af86377430da9a615a574e577aec1ee342c967", "message": "add stackdepth integration tests", "committedDate": "2020-09-29T16:16:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3NzE0MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1928#discussion_r496877141", "bodyText": "we must initialize JMX system access for the profiling classloader as it now requires access to some JMX functionality: reading JVM options, setting JFR stackdepth.", "author": "pmbauer", "createdAt": "2020-09-29T16:28:49Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java", "diffHunk": "@@ -261,14 +261,24 @@ private static synchronized void installDatadogTracer() {\n \n   private static synchronized void startJmx(final URL bootstrapURL) {\n     startJmxFetch(bootstrapURL);\n-    initializeJmxSystemAccessProvider();\n+\n+    if (AGENT_CLASSLOADER == null) {\n+      throw new IllegalStateException(\"Datadog agent should have been started already\");\n+    }\n+    initializeJmxSystemAccessProvider(AGENT_CLASSLOADER);\n+\n+    if (PROFILING_CLASSLOADER == null) {\n+      throw new IllegalStateException(\"Datadog profiling agent should have been started already\");\n+    }\n+    initializeJmxSystemAccessProvider(PROFILING_CLASSLOADER);", "originalCommit": "96af86377430da9a615a574e577aec1ee342c967", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3NzU3Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1928#discussion_r496877573", "bodyText": "where best to document this?", "author": "pmbauer", "createdAt": "2020-09-29T16:29:25Z", "path": "dd-java-agent/agent-profiling/profiling-controller/src/main/java/com/datadog/profiling/controller/ProfilingSystem.java", "diffHunk": "@@ -16,20 +16,25 @@\n package com.datadog.profiling.controller;\n \n import com.datadog.profiling.util.ProfilingThreadFactory;\n+import datadog.trace.core.util.SystemAccess;\n+import lombok.extern.slf4j.Slf4j;\n+\n import java.time.Duration;\n import java.time.Instant;\n+import java.util.Optional;\n import java.util.concurrent.Executors;\n import java.util.concurrent.ScheduledExecutorService;\n import java.util.concurrent.ThreadLocalRandom;\n import java.util.concurrent.TimeUnit;\n-import lombok.extern.slf4j.Slf4j;\n \n /** Sets up the profiling strategy and schedules the profiling recordings. */\n @Slf4j\n public final class ProfilingSystem {\n   static final String RECORDING_NAME = \"dd-profiling\";\n \n   private static final long TERMINATION_TIMEOUT = 10;\n+  public static final int DEFAULT_STACK_DEPTH = 256;\n+  public static final int MAX_STACK_DEPTH = 1024;", "originalCommit": "96af86377430da9a615a574e577aec1ee342c967", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODE5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1928#discussion_r496878199", "bodyText": "add two methods to JMX interface", "author": "pmbauer", "createdAt": "2020-09-29T16:30:19Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/JmxSystemAccessProvider.java", "diffHunk": "@@ -26,15 +32,49 @@ public long getThreadCpuTime() {\n    */\n   @Override\n   public int getCurrentPid() {\n-    String name = runtimeMXBean.getName();\n+    final String name = runtimeMXBean.getName();\n     if (name == null) {\n       return 0;\n     }\n-    int idx = name.indexOf('@');\n+    final int idx = name.indexOf('@');\n     if (idx == -1) {\n       return 0;\n     }\n-    String pid = name.substring(0, idx);\n+    final String pid = name.substring(0, idx);\n     return Integer.parseInt(pid);\n   }\n+\n+  /** */\n+  @Override", "originalCommit": "96af86377430da9a615a574e577aec1ee342c967", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4MTY5Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1928#discussion_r496881692", "bodyText": "you may have stackdepth as second option like:\n-XX:FlightRecorderOptions=dumponexit=true,stackdepth=128", "author": "jpbempel", "createdAt": "2020-09-29T16:35:27Z", "path": "dd-java-agent/agent-profiling/profiling-controller/src/main/java/com/datadog/profiling/controller/ProfilingSystem.java", "diffHunk": "@@ -126,9 +131,53 @@ public final void start() {\n     }\n   }\n \n+  private static void setMaxStackDepth() {\n+    final String JFR_STACK_DEPTH_ARG = \"-XX:FlightRecorderOptions=stackdepth=\";", "originalCommit": "96af86377430da9a615a574e577aec1ee342c967", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4OTk4Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1928#discussion_r496889982", "bodyText": "good point, will fix", "author": "pmbauer", "createdAt": "2020-09-29T16:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4MTY5Mg=="}], "type": "inlineReview"}, {"oid": "92125e3ba15dd40e111c376fbe408420a1198cd4", "url": "https://github.com/DataDog/dd-trace-java/commit/92125e3ba15dd40e111c376fbe408420a1198cd4", "message": "remove vestigial explicit sleep", "committedDate": "2020-09-29T16:50:48Z", "type": "commit"}, {"oid": "3c6f6d009d14e15318b6117e3c99e07bac50e984", "url": "https://github.com/DataDog/dd-trace-java/commit/3c6f6d009d14e15318b6117e3c99e07bac50e984", "message": "make JFR option parsing robust", "committedDate": "2020-09-29T18:44:19Z", "type": "commit"}, {"oid": "209e5b3521d00d91db0eacf94af17b3dbb199a00", "url": "https://github.com/DataDog/dd-trace-java/commit/209e5b3521d00d91db0eacf94af17b3dbb199a00", "message": "skip integration tests for JDK 1.8", "committedDate": "2020-09-29T18:56:55Z", "type": "commit"}, {"oid": "3e7fb2115dae659adb14b4475d70f3e16ff0524d", "url": "https://github.com/DataDog/dd-trace-java/commit/3e7fb2115dae659adb14b4475d70f3e16ff0524d", "message": "fix codenarc, missing comments, misc cleanup", "committedDate": "2020-09-29T20:17:27Z", "type": "commit"}, {"oid": "3134a4250ff1adf455e4a1fa80b4a4434b39776c", "url": "https://github.com/DataDog/dd-trace-java/commit/3134a4250ff1adf455e4a1fa80b4a4434b39776c", "message": "fix test coverage", "committedDate": "2020-09-29T20:17:49Z", "type": "forcePushed"}, {"oid": "7c835ed5228ea6a70a3bfdc32872380f2877a485", "url": "https://github.com/DataDog/dd-trace-java/commit/7c835ed5228ea6a70a3bfdc32872380f2877a485", "message": "fix test coverage", "committedDate": "2020-09-29T21:51:55Z", "type": "commit"}, {"oid": "7c835ed5228ea6a70a3bfdc32872380f2877a485", "url": "https://github.com/DataDog/dd-trace-java/commit/7c835ed5228ea6a70a3bfdc32872380f2877a485", "message": "fix test coverage", "committedDate": "2020-09-29T21:51:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI4MzYxNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1928#discussion_r497283616", "bodyText": "Can we detect in one way or another that JMX is not yet initialized when we performed the call?\nto help diganostic when it does not work.\nreturn of the method is null = meaning this is the NoOp?", "author": "jpbempel", "createdAt": "2020-09-30T07:01:01Z", "path": "dd-java-agent/agent-profiling/profiling-controller/src/main/java/com/datadog/profiling/controller/ProfilingSystem.java", "diffHunk": "@@ -126,9 +132,73 @@ public final void start() {\n     }\n   }\n \n+  protected static int stackDepthFromClient(final String userSpecifiedDepth) {\n+    try {\n+      final int stackDepth = Integer.parseInt(userSpecifiedDepth);\n+\n+      // client specified a value considered safe\n+      if (stackDepth < MAX_STACK_DEPTH) {\n+        log.info(\"skip setting JFR.configure stackdepth, using \" + userSpecifiedDepth);\n+        return stackDepth;\n+      }\n+\n+      // limit how deep a stack depth we'll collect\n+      log.warn(userSpecifiedDepth + \" exceeds maximum value allowed by Datadog agent\");\n+      return MAX_STACK_DEPTH;\n+    } catch (final NumberFormatException e) { // \"this should never happen\"\n+      log.warn(\"malformed arg: \" + userSpecifiedDepth);\n+    }\n+\n+    return DEFAULT_STACK_DEPTH;\n+  }\n+\n+  private static void setMaxStackDepth() {\n+    int maxFrames = ProfilingSystem.DEFAULT_STACK_DEPTH;\n+\n+    // don't set stackdepth if the client has explicitly set it\n+    final Optional<String> userSpecifiedStackDepth =\n+        readJFRStackDepth(SystemAccess.getVMArguments());\n+    if (userSpecifiedStackDepth.isPresent()) {\n+      maxFrames = stackDepthFromClient(userSpecifiedStackDepth.get());\n+    }\n+\n+    log.info(\"setting JFR.configure stackdepth=\" + maxFrames);\n+    SystemAccess.executeDiagnosticCommand(", "originalCommit": "7c835ed5228ea6a70a3bfdc32872380f2877a485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1NzA2Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1928#discussion_r497557063", "bodyText": "fixed, reporting results df41df5", "author": "pmbauer", "createdAt": "2020-09-30T14:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI4MzYxNg=="}], "type": "inlineReview"}, {"oid": "966c70084be1b9be1f5606c0d7a63bdeb7611894", "url": "https://github.com/DataDog/dd-trace-java/commit/966c70084be1b9be1f5606c0d7a63bdeb7611894", "message": "indicate result of stackdepth setting in log", "committedDate": "2020-09-30T13:52:34Z", "type": "forcePushed"}, {"oid": "df41df5043ba296875390c8a35368740888d20e9", "url": "https://github.com/DataDog/dd-trace-java/commit/df41df5043ba296875390c8a35368740888d20e9", "message": "indicate result of stackdepth setting in log", "committedDate": "2020-09-30T13:54:00Z", "type": "commit"}, {"oid": "df41df5043ba296875390c8a35368740888d20e9", "url": "https://github.com/DataDog/dd-trace-java/commit/df41df5043ba296875390c8a35368740888d20e9", "message": "indicate result of stackdepth setting in log", "committedDate": "2020-09-30T13:54:00Z", "type": "forcePushed"}, {"oid": "c4d8640977fe0a28fb0c9509dfe75acf672cd83e", "url": "https://github.com/DataDog/dd-trace-java/commit/c4d8640977fe0a28fb0c9509dfe75acf672cd83e", "message": "JMX test not supported on 1.7", "committedDate": "2020-09-30T14:04:09Z", "type": "commit"}, {"oid": "913e3f24e58d31b829cfbdcd7fedeca56a3f0754", "url": "https://github.com/DataDog/dd-trace-java/commit/913e3f24e58d31b829cfbdcd7fedeca56a3f0754", "message": "IBM 8 VM can not invoke jfr diagnostic commands", "committedDate": "2020-09-30T16:07:39Z", "type": "commit"}, {"oid": "913e3f24e58d31b829cfbdcd7fedeca56a3f0754", "url": "https://github.com/DataDog/dd-trace-java/commit/913e3f24e58d31b829cfbdcd7fedeca56a3f0754", "message": "IBM 8 VM can not invoke jfr diagnostic commands", "committedDate": "2020-09-30T16:07:39Z", "type": "forcePushed"}]}