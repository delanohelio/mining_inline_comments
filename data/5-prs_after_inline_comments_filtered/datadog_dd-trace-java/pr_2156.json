{"pr_number": 2156, "pr_title": "Datastax Cassandra 4 instrumentation", "pr_createdAt": "2020-12-02T21:16:57Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2156", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ5NTU0NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r534495545", "bodyText": "Should this span be the active span at this time? If so, this lambda wouldn't need to capture here.", "author": "richardstartin", "createdAt": "2020-12-02T21:33:18Z", "path": "dd-java-agent/instrumentation/datastax-cassandra-4/src/main/java8/datadog/trace/instrumentation/datastax/cassandra/TracingSession.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package datadog.trace.instrumentation.datastax.cassandra;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.datastax.cassandra.CassandraClientDecorator.CASSANDRA_EXECUTE;\n+import static datadog.trace.instrumentation.datastax.cassandra.CassandraClientDecorator.DECORATE;\n+import static datadog.trace.util.AgentThreadFactory.AgentThread.TRACE_CASSANDRA_ASYNC_SESSION;\n+\n+import com.datastax.oss.driver.api.core.CqlSession;\n+import com.datastax.oss.driver.api.core.cql.AsyncResultSet;\n+import com.datastax.oss.driver.api.core.cql.BoundStatement;\n+import com.datastax.oss.driver.api.core.cql.ResultSet;\n+import com.datastax.oss.driver.api.core.cql.SimpleStatement;\n+import com.datastax.oss.driver.api.core.cql.Statement;\n+import com.datastax.oss.driver.api.core.session.Request;\n+import com.datastax.oss.driver.api.core.session.Session;\n+import com.datastax.oss.driver.api.core.type.reflect.GenericType;\n+import com.datastax.oss.driver.internal.core.session.SessionWrapper;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.util.AgentThreadFactory;\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import edu.umd.cs.findbugs.annotations.Nullable;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+public class TracingSession extends SessionWrapper implements CqlSession {\n+  private static final ExecutorService EXECUTOR_SERVICE =\n+      Executors.newCachedThreadPool(new AgentThreadFactory(TRACE_CASSANDRA_ASYNC_SESSION));\n+\n+  public TracingSession(final Session session) {\n+    super(session);\n+  }\n+\n+  @Override\n+  @Nullable\n+  public <RequestT extends Request, ResultT> ResultT execute(\n+      @NonNull RequestT request, @NonNull GenericType<ResultT> resultType) {\n+\n+    if (request instanceof Statement && resultType.equals(Statement.SYNC)) {\n+      return (ResultT) wrapSyncRequest((Statement) request);\n+    } else if (request instanceof Statement && resultType.equals(Statement.ASYNC)) {\n+      return (ResultT) wrapAsyncRequest((Statement) request);\n+    } else {\n+      // PrepareRequest or unknown request: just forward to delegate\n+      return getDelegate().execute(request, resultType);\n+    }\n+  }\n+\n+  private ResultSet wrapSyncRequest(Statement request) {\n+    AgentSpan span = startSpan(CASSANDRA_EXECUTE);\n+\n+    DECORATE.afterStart(span);\n+    DECORATE.onConnection(span, getDelegate());\n+    DECORATE.onStatement(span, getQuery(request));\n+\n+    try (AgentScope scope = activateSpan(span)) {\n+      ResultSet resultSet = getDelegate().execute(request, Statement.SYNC);\n+      DECORATE.onResponse(span, resultSet);\n+      DECORATE.beforeFinish(span);\n+\n+      return resultSet;\n+    } catch (Exception e) {\n+      DECORATE.onError(span, e);\n+      DECORATE.beforeFinish(span);\n+\n+      throw e;\n+    } finally {\n+      span.finish();\n+    }\n+  }\n+\n+  private CompletionStage<AsyncResultSet> wrapAsyncRequest(Statement request) {\n+    AgentSpan span = startSpan(CASSANDRA_EXECUTE);\n+\n+    DECORATE.afterStart(span);\n+    DECORATE.onConnection(span, getDelegate());\n+    DECORATE.onStatement(span, getQuery(request));\n+\n+    try (AgentScope scope = activateSpan(span)) {\n+      CompletionStage<AsyncResultSet> completionStage =\n+          getDelegate().execute(request, Statement.ASYNC);\n+\n+      return completionStage.whenComplete(\n+          (result, throwable) -> {\n+            if (result != null) {\n+              DECORATE.onResponse(span, result);\n+            }\n+\n+            if (throwable instanceof CompletionException) {\n+              throwable = throwable.getCause();\n+            }\n+            DECORATE.onError(span, throwable);\n+            span.finish();", "originalCommit": "b2b674f3eea416f36bde632dcea1234da5d929f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ5ODgyNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r534498825", "bodyText": "It seems unfortunate that we go to such lengths and quite some cost to propagate context into completable futures, when all we really need to do is capture the span in a closure, but we're doing both here, the CompletableFuture instrumentation should be making sure this would be the active span at the time.", "author": "richardstartin", "createdAt": "2020-12-02T21:39:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ5NTU0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ5NjQ5MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r534496491", "bodyText": "may or may not be worth it, but this will autobox, RadixTreeCache.PORTS.get(((InetSocketAddress) address).getPort()) works around this.", "author": "richardstartin", "createdAt": "2020-12-02T21:35:05Z", "path": "dd-java-agent/instrumentation/datastax-cassandra-4/src/main/java8/datadog/trace/instrumentation/datastax/cassandra/CassandraClientDecorator.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package datadog.trace.instrumentation.datastax.cassandra;\n+\n+import com.datastax.oss.driver.api.core.cql.AsyncResultSet;\n+import com.datastax.oss.driver.api.core.cql.ResultSet;\n+import com.datastax.oss.driver.api.core.metadata.Node;\n+import com.datastax.oss.driver.api.core.servererrors.CoordinatorException;\n+import com.datastax.oss.driver.api.core.session.Session;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.InternalSpanTypes;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.DBTypeProcessingDatabaseClientDecorator;\n+import java.net.InetSocketAddress;\n+import java.net.SocketAddress;\n+import java.util.Objects;\n+\n+public class CassandraClientDecorator extends DBTypeProcessingDatabaseClientDecorator<Session> {\n+\n+  public static final CharSequence CASSANDRA_EXECUTE =\n+      UTF8BytesString.createConstant(\"cassandra.execute\");\n+  public static final CharSequence JAVA_CASSANDRA =\n+      UTF8BytesString.createConstant(\"java-cassandra\");\n+\n+  public static final CassandraClientDecorator DECORATE = new CassandraClientDecorator();\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"cassandra\"};\n+  }\n+\n+  @Override\n+  protected String service() {\n+    return \"cassandra\";\n+  }\n+\n+  @Override\n+  protected CharSequence component() {\n+    return JAVA_CASSANDRA;\n+  }\n+\n+  @Override\n+  protected CharSequence spanType() {\n+    return InternalSpanTypes.CASSANDRA;\n+  }\n+\n+  @Override\n+  protected String dbType() {\n+    return \"cassandra\";\n+  }\n+\n+  @Override\n+  protected String dbUser(final Session session) {\n+    return null;\n+  }\n+\n+  @Override\n+  protected String dbInstance(final Session session) {\n+    return session.getKeyspace().map(Objects::toString).orElse(null);\n+  }\n+\n+  @Override\n+  protected String dbHostname(Session session) {\n+    return null;\n+  }\n+\n+  public AgentSpan onResponse(final AgentSpan span, final ResultSet result) {\n+    if (result != null) {\n+      return onResponse(span, result.getExecutionInfo().getCoordinator());\n+    }\n+\n+    return span;\n+  }\n+\n+  public AgentSpan onResponse(final AgentSpan span, final AsyncResultSet result) {\n+    if (result != null) {\n+      return onResponse(span, result.getExecutionInfo().getCoordinator());\n+    }\n+\n+    return span;\n+  }\n+\n+  @Override\n+  public AgentSpan onError(final AgentSpan span, final Throwable throwable) {\n+    super.onError(span, throwable);\n+\n+    if (throwable instanceof CoordinatorException) {\n+      onResponse(span, ((CoordinatorException) throwable).getCoordinator());\n+    }\n+\n+    return span;\n+  }\n+\n+  private AgentSpan onResponse(AgentSpan span, Node coordinator) {\n+    if (coordinator != null) {\n+      SocketAddress address = coordinator.getEndPoint().resolve();\n+      if (address instanceof InetSocketAddress) {\n+        span.setTag(Tags.PEER_PORT, ((InetSocketAddress) address).getPort());", "originalCommit": "b2b674f3eea416f36bde632dcea1234da5d929f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxMzg1NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r534513854", "bodyText": "@richardstartin would it be worth adding special logic for this in the setTag(String,int) method?", "author": "tylerbenson", "createdAt": "2020-12-02T22:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ5NjQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyNzYwMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r534527602", "bodyText": "That seems dangerous to me. Here, we know it's a port, and that it only has 16 bits, that it isn't negative, so can reason about worst cases. Elsewhere, it could be any integer.", "author": "richardstartin", "createdAt": "2020-12-02T22:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ5NjQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ0MDI5NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r535440294", "bodyText": "I changed the code to just call the other version BaseDecorator.onPeerConnection().  I'll update that in a separate PR", "author": "randomanderson", "createdAt": "2020-12-03T17:33:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ5NjQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUwODg5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r534508899", "bodyText": "Do we want to add a secondary name to distinguish 3 from 4?", "author": "tylerbenson", "createdAt": "2020-12-02T21:57:53Z", "path": "dd-java-agent/instrumentation/datastax-cassandra-4/src/main/java/datadog/trace/instrumentation/datastax/cassandra/CassandraClientInstrumentation.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package datadog.trace.instrumentation.datastax.cassandra;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.isStatic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArguments;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import java.util.Map;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public class CassandraClientInstrumentation extends Instrumenter.Default {\n+\n+  public CassandraClientInstrumentation() {\n+    super(\"cassandra\");", "originalCommit": "b2b674f3eea416f36bde632dcea1234da5d929f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUwOTk2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r534509960", "bodyText": "Ideally the package name should distinguish to avoid potential naming conflicts with 3. (Maybe update the 3.x package too?)", "author": "tylerbenson", "createdAt": "2020-12-02T21:59:20Z", "path": "dd-java-agent/instrumentation/datastax-cassandra-4/src/main/java/datadog/trace/instrumentation/datastax/cassandra/CassandraClientInstrumentation.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package datadog.trace.instrumentation.datastax.cassandra;", "originalCommit": "b2b674f3eea416f36bde632dcea1234da5d929f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyNDU3Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r534524573", "bodyText": "ah, yes.  I've been bitten by this quirk before", "author": "randomanderson", "createdAt": "2020-12-02T22:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUwOTk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxMTAxMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r534511010", "bodyText": "Since your advice is focused on the return type instead of arguments, consider a return type matcher (perhaps instead of the argument matcher).", "author": "tylerbenson", "createdAt": "2020-12-02T22:01:20Z", "path": "dd-java-agent/instrumentation/datastax-cassandra-4/src/main/java/datadog/trace/instrumentation/datastax/cassandra/CassandraClientInstrumentation.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package datadog.trace.instrumentation.datastax.cassandra;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.isStatic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArguments;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import java.util.Map;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public class CassandraClientInstrumentation extends Instrumenter.Default {\n+\n+  public CassandraClientInstrumentation() {\n+    super(\"cassandra\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return named(\"com.datastax.oss.driver.internal.core.session.DefaultSession\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\n+      packageName + \".CassandraClientDecorator\", packageName + \".TracingSession\"\n+    };\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return singletonMap(\n+        isMethod().and(named(\"init\")).and(isStatic()).and(takesArguments(3)),", "originalCommit": "b2b674f3eea416f36bde632dcea1234da5d929f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyNjAwNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2156#discussion_r534526006", "bodyText": "I'll add a return type matcher for defensive programming but there are 2 init methods with the same return type so the argument matcher needs to stay", "author": "randomanderson", "createdAt": "2020-12-02T22:31:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxMTAxMA=="}], "type": "inlineReview"}, {"oid": "1188d4e9f549f0b4b34e403ee35e26e44db4ab50", "url": "https://github.com/DataDog/dd-trace-java/commit/1188d4e9f549f0b4b34e403ee35e26e44db4ab50", "message": "Move package to datastax.cassandra4", "committedDate": "2020-12-02T22:51:47Z", "type": "forcePushed"}, {"oid": "adb9c26d3f551ab2ffa930f1552796588949a276", "url": "https://github.com/DataDog/dd-trace-java/commit/adb9c26d3f551ab2ffa930f1552796588949a276", "message": "fix bug with jdk15", "committedDate": "2020-12-03T03:15:24Z", "type": "forcePushed"}, {"oid": "c93f1c0e931e98ba586bf9ab55013e8f5fa85f9f", "url": "https://github.com/DataDog/dd-trace-java/commit/c93f1c0e931e98ba586bf9ab55013e8f5fa85f9f", "message": "fix bug with jdk15", "committedDate": "2020-12-03T03:30:58Z", "type": "forcePushed"}, {"oid": "c488deef87196fc3b847121ea25cb018a29b4dfd", "url": "https://github.com/DataDog/dd-trace-java/commit/c488deef87196fc3b847121ea25cb018a29b4dfd", "message": "Datastax Cassandra 4 instrumentation", "committedDate": "2020-12-03T17:12:52Z", "type": "commit"}, {"oid": "5b8c6065f82c0e2bac368884a51caa457caba3d7", "url": "https://github.com/DataDog/dd-trace-java/commit/5b8c6065f82c0e2bac368884a51caa457caba3d7", "message": "Bump up the timeout", "committedDate": "2020-12-03T17:12:52Z", "type": "commit"}, {"oid": "5c500e6449d5dc40d7a0f779f25d529e2828890f", "url": "https://github.com/DataDog/dd-trace-java/commit/5c500e6449d5dc40d7a0f779f25d529e2828890f", "message": "Add return type matcher", "committedDate": "2020-12-03T17:12:52Z", "type": "commit"}, {"oid": "004a303b60276ef661681d515ecaaf45790974d9", "url": "https://github.com/DataDog/dd-trace-java/commit/004a303b60276ef661681d515ecaaf45790974d9", "message": "Move package to datastax.cassandra4", "committedDate": "2020-12-03T17:12:53Z", "type": "commit"}, {"oid": "62fe3d85d27a392a54173d896653b9bf9558a0b9", "url": "https://github.com/DataDog/dd-trace-java/commit/62fe3d85d27a392a54173d896653b9bf9558a0b9", "message": "fix bug with jdk15", "committedDate": "2020-12-03T17:12:53Z", "type": "commit"}, {"oid": "165b84092b539aa14058116c8aed6877947bada9", "url": "https://github.com/DataDog/dd-trace-java/commit/165b84092b539aa14058116c8aed6877947bada9", "message": "Use onPeerConnection that sets port", "committedDate": "2020-12-03T17:12:53Z", "type": "commit"}, {"oid": "165b84092b539aa14058116c8aed6877947bada9", "url": "https://github.com/DataDog/dd-trace-java/commit/165b84092b539aa14058116c8aed6877947bada9", "message": "Use onPeerConnection that sets port", "committedDate": "2020-12-03T17:12:53Z", "type": "forcePushed"}]}