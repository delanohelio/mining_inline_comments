{"pr_number": 1216, "pr_title": "profiling lz4", "pr_createdAt": "2020-02-12T20:02:35Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1216", "timeline": [{"oid": "ca9f623d053d825e53f5f871b4c0d9108f08a467", "url": "https://github.com/DataDog/dd-trace-java/commit/ca9f623d053d825e53f5f871b4c0d9108f08a467", "message": "Add profiling lz4 compression support\n\nGzip is still the default", "committedDate": "2020-02-12T20:00:02Z", "type": "commit"}, {"oid": "ef9ebffc54c73206ea49235f413d88bffadb430f", "url": "https://github.com/DataDog/dd-trace-java/commit/ef9ebffc54c73206ea49235f413d88bffadb430f", "message": "Simplify unknown compression handling", "committedDate": "2020-02-12T20:08:25Z", "type": "commit"}, {"oid": "ef9ebffc54c73206ea49235f413d88bffadb430f", "url": "https://github.com/DataDog/dd-trace-java/commit/ef9ebffc54c73206ea49235f413d88bffadb430f", "message": "Simplify unknown compression handling", "committedDate": "2020-02-12T20:08:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM2NjM0Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386366347", "bodyText": "If we are reducing the levels I would propose just OFF, ON (lz4) and GZIP -  these values better correspond to a type  while values like high, low, medium etc. really resemble level.", "author": "jbachorik", "createdAt": "2020-03-02T12:34:47Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/CompressionType.java", "diffHunk": "@@ -1,25 +1,35 @@\n package com.datadog.profiling.uploader;\n \n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n enum CompressionType {\n   /** No compression */\n   OFF,\n   /** Default compression */\n   ON,\n-  /** Unknown compression config value */\n-  UNKNOWN;\n+  /** Lower compression ratio with less CPU overhead * */\n+  LOW,\n+  /** Better compression ratio for the price of higher CPU usage * */\n+  MEDIUM;\n \n-  static CompressionType of(final String type) {\n+  static CompressionType of(String type) {\n     if (type == null) {\n-      return UNKNOWN;\n+      type = \"\";\n     }\n \n     switch (type.toLowerCase()) {\n       case \"off\":\n         return OFF;\n       case \"on\":\n         return ON;\n+      case \"low\":\n+        return LOW;\n+      case \"medium\":\n+        return MEDIUM;", "originalCommit": "ef9ebffc54c73206ea49235f413d88bffadb430f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM2ODk3NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386368974", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              MEDIUM;\n          \n          \n            \n            GZIP;", "author": "jbachorik", "createdAt": "2020-03-02T12:40:43Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/CompressionType.java", "diffHunk": "@@ -1,25 +1,35 @@\n package com.datadog.profiling.uploader;\n \n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n enum CompressionType {\n   /** No compression */\n   OFF,\n   /** Default compression */\n   ON,\n-  /** Unknown compression config value */\n-  UNKNOWN;\n+  /** Lower compression ratio with less CPU overhead * */\n+  LOW,\n+  /** Better compression ratio for the price of higher CPU usage * */\n+  MEDIUM;", "originalCommit": "ef9ebffc54c73206ea49235f413d88bffadb430f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM2OTM1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386369350", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  case \"low\":\n          \n          \n            \n                    return LOW;\n          \n          \n            \n                  case \"medium\":\n          \n          \n            \n                    return MEDIUM;\n          \n          \n            \n                  case \"gzip\":\n          \n          \n            \n                    return GZIP;", "author": "jbachorik", "createdAt": "2020-03-02T12:41:35Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/CompressionType.java", "diffHunk": "@@ -1,25 +1,35 @@\n package com.datadog.profiling.uploader;\n \n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n enum CompressionType {\n   /** No compression */\n   OFF,\n   /** Default compression */\n   ON,\n-  /** Unknown compression config value */\n-  UNKNOWN;\n+  /** Lower compression ratio with less CPU overhead * */\n+  LOW,\n+  /** Better compression ratio for the price of higher CPU usage * */\n+  MEDIUM;\n \n-  static CompressionType of(final String type) {\n+  static CompressionType of(String type) {\n     if (type == null) {\n-      return UNKNOWN;\n+      type = \"\";\n     }\n \n     switch (type.toLowerCase()) {\n       case \"off\":\n         return OFF;\n       case \"on\":\n         return ON;\n+      case \"low\":\n+        return LOW;\n+      case \"medium\":\n+        return MEDIUM;", "originalCommit": "ef9ebffc54c73206ea49235f413d88bffadb430f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM3MDMzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386370330", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  case ON:\n          \n          \n            \n                  case MEDIUM:\n          \n          \n            \n                  default:\n          \n          \n            \n                  case GZIP:", "author": "jbachorik", "createdAt": "2020-03-02T12:43:53Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/RecordingUploader.java", "diffHunk": "@@ -245,19 +245,21 @@ private Compression getCompression(final CompressionType type) {\n     // this needs to be updated once more compression types are added\n     switch (type) {\n       case ON:\n+      case MEDIUM:\n+      default:", "originalCommit": "ef9ebffc54c73206ea49235f413d88bffadb430f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM3MDg3Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386370872", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  case OFF:\n          \n          \n            \n                  case LOW:\n          \n          \n            \n                  case ON:\n          \n          \n            \n                  default:", "author": "jbachorik", "createdAt": "2020-03-02T12:45:10Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/RecordingUploader.java", "diffHunk": "@@ -245,19 +245,21 @@ private Compression getCompression(final CompressionType type) {\n     // this needs to be updated once more compression types are added\n     switch (type) {\n       case ON:\n+      case MEDIUM:\n+      default:\n         {\n           compression = (is, expectedSize) -> StreamUtils.gzipStream(is, expectedSize, consumer);\n           break;\n         }\n-      case OFF:\n+      case LOW:", "originalCommit": "ef9ebffc54c73206ea49235f413d88bffadb430f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM3MTYyMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386371620", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @ValueSource(strings = {\"on\", \"low\", \"medium\", \"off\", \"invalid\"})\n          \n          \n            \n              @ValueSource(strings = {\"on\", \"gzip\", \"off\", \"invalid\"})", "author": "jbachorik", "createdAt": "2020-03-02T12:46:50Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/RecordingUploaderTest.java", "diffHunk": "@@ -138,7 +139,7 @@ public void tearDown() throws IOException {\n   }\n \n   @ParameterizedTest\n-  @ValueSource(strings = {\"on\", \"off\", \"invalid\"})\n+  @ValueSource(strings = {\"on\", \"low\", \"medium\", \"off\", \"invalid\"})", "originalCommit": "ef9ebffc54c73206ea49235f413d88bffadb430f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM3MTg0NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386371845", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (compression.equals(\"on\") || compression.equals(\"medium\") || compression.equals(\"invalid\")) {\n          \n          \n            \n                if (compression.equals(\"gzip\") || compression.equals(\"invalid\")) {", "author": "jbachorik", "createdAt": "2020-03-02T12:47:25Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/RecordingUploaderTest.java", "diffHunk": "@@ -184,8 +185,10 @@ public void testRequestParameters(final String compression)\n \n     byte[] uploadedBytes =\n         (byte[]) Iterables.getFirst(parameters.get(RecordingUploader.DATA_PARAM), new byte[] {});\n-    if (compression.equals(\"on\") || compression.equals(\"invalid\")) {\n+    if (compression.equals(\"on\") || compression.equals(\"medium\") || compression.equals(\"invalid\")) {", "originalCommit": "ef9ebffc54c73206ea49235f413d88bffadb430f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM3MTkwMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386371901", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } else if (compression.equals(\"low\")) {\n          \n          \n            \n                } else if (compression.equals(\"on\")) {", "author": "jbachorik", "createdAt": "2020-03-02T12:47:34Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/RecordingUploaderTest.java", "diffHunk": "@@ -184,8 +185,10 @@ public void testRequestParameters(final String compression)\n \n     byte[] uploadedBytes =\n         (byte[]) Iterables.getFirst(parameters.get(RecordingUploader.DATA_PARAM), new byte[] {});\n-    if (compression.equals(\"on\") || compression.equals(\"invalid\")) {\n+    if (compression.equals(\"on\") || compression.equals(\"medium\") || compression.equals(\"invalid\")) {\n       uploadedBytes = unGzip(uploadedBytes);\n+    } else if (compression.equals(\"low\")) {", "originalCommit": "ef9ebffc54c73206ea49235f413d88bffadb430f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b3d81281f617bbc440c2367222b3d6f4408810da", "url": "https://github.com/DataDog/dd-trace-java/commit/b3d81281f617bbc440c2367222b3d6f4408810da", "message": "Merge branch 'master' into mar-kolya/profiling-lz4", "committedDate": "2020-03-02T15:02:09Z", "type": "commit"}, {"oid": "a1f6ca1ee7c49a086bcff7543d5dd4f68b694469", "url": "https://github.com/DataDog/dd-trace-java/commit/a1f6ca1ee7c49a086bcff7543d5dd4f68b694469", "message": "Make lz4 default compression\n\nAlso do some renaming in compression settings", "committedDate": "2020-03-02T15:12:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NDIzMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386584231", "bodyText": "Nit- looks like the comments are swapped.", "author": "dbenamydd", "createdAt": "2020-03-02T18:56:06Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/CompressionType.java", "diffHunk": "@@ -1,25 +1,35 @@\n package com.datadog.profiling.uploader;\n \n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n enum CompressionType {\n   /** No compression */\n   OFF,\n   /** Default compression */\n   ON,\n-  /** Unknown compression config value */\n-  UNKNOWN;\n+  /** Lower compression ratio with less CPU overhead * */\n+  LZ4,\n+  /** Better compression ratio for the price of higher CPU usage * */\n+  GZIP;", "originalCommit": "a1f6ca1ee7c49a086bcff7543d5dd4f68b694469", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU5ODgxNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386598817", "bodyText": "@jbachorik isn't this correct, or am I missing something? does lz4 have better ratio than gzip?", "author": "mar-kolya", "createdAt": "2020-03-02T19:22:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg2MzE5MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386863190", "bodyText": "No it's fine by me. LZ4 is focused on speed, the ratio is worse than zlib/gzip.\nhttps://en.wikipedia.org/wiki/LZ4_(compression_algorithm)\nBTW, something that people tands to forgot is that Gzip has compression levels which gives opportunity to trade cpu with ratio...", "author": "jpbempel", "createdAt": "2020-03-03T08:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxMzU5NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r386913595", "bodyText": "This is correct - LZ4 has slightly worse compression ration while it has overwhelmingly higher throughput.\nAs for the levels - the comparisons were done with OOTB config provided for the Java libs. Perhaps, it would be possible to fine-tune both GZIP and LZ4 to provide either better compression ratio or throughput. But the difference in GZIP vs. LZ4 in throughput is much bigger than the difference in the compression ratio so it is rather improbable that it could beat LZ4 in both terms of throughput and compression ...", "author": "jbachorik", "createdAt": "2020-03-03T10:04:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5ODI0Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1216#discussion_r387098246", "bodyText": "Whoops! Thanks.", "author": "dbenamydd", "createdAt": "2020-03-03T15:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NDIzMQ=="}], "type": "inlineReview"}]}