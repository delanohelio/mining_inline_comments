{"pr_number": 1965, "pr_title": "Servlet RequestDispatcher and Spring MVC 404 fixes", "pr_createdAt": "2020-10-08T21:32:06Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1965", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNDk2OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r502034969", "bodyText": "Could we use a MethodHandle instead here?", "author": "richardstartin", "createdAt": "2020-10-08T21:56:07Z", "path": "dd-java-agent/instrumentation/servlet/src/main/java/datadog/trace/instrumentation/servlet/dispatcher/RequestDispatcherDecorator.java", "diffHunk": "@@ -1,13 +1,32 @@\n package datadog.trace.instrumentation.servlet.dispatcher;\n \n+import static datadog.trace.api.cache.RadixTreeCache.HTTP_STATUSES;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n import datadog.trace.bootstrap.instrumentation.decorator.BaseDecorator;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n \n public class RequestDispatcherDecorator extends BaseDecorator {\n   public static final RequestDispatcherDecorator DECORATE = new RequestDispatcherDecorator();\n   public static final CharSequence JAVA_WEB_SERVLET_DISPATCHER =\n       UTF8BytesString.createConstant(\"java-web-servlet-dispatcher\");\n \n+  private static Method STATUS_CODE_METHOD;\n+\n+  static {\n+    try {\n+      STATUS_CODE_METHOD = HttpServletResponse.class.getMethod(\"getStatus\");", "originalCommit": "bb687ed5ed9bcc47c397cc94ad72c277e7d13f20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA1MTMxOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r502051319", "bodyText": "Even better if you can provide a fallback no-op method handle to avoid the null check below.", "author": "tylerbenson", "createdAt": "2020-10-08T22:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNDk2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM0MjkzNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r502342936", "bodyText": "is it?", "author": "richardstartin", "createdAt": "2020-10-09T10:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNDk2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU0Mzk4NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r502543985", "bodyText": "Done.  Still need to null check because we only want to set the tag if the value exists", "author": "randomanderson", "createdAt": "2020-10-09T16:28:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNDk2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU0NTgyOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r502545829", "bodyText": "yeah, I think so since it would allow the removal of a branch below.", "author": "tylerbenson", "createdAt": "2020-10-09T16:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNDk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA1MDg0Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r502050842", "bodyText": "I think this can be final (assuming proper initialization below).", "author": "tylerbenson", "createdAt": "2020-10-08T22:38:47Z", "path": "dd-java-agent/instrumentation/servlet/src/main/java/datadog/trace/instrumentation/servlet/dispatcher/RequestDispatcherDecorator.java", "diffHunk": "@@ -1,13 +1,32 @@\n package datadog.trace.instrumentation.servlet.dispatcher;\n \n+import static datadog.trace.api.cache.RadixTreeCache.HTTP_STATUSES;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n import datadog.trace.bootstrap.instrumentation.decorator.BaseDecorator;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n \n public class RequestDispatcherDecorator extends BaseDecorator {\n   public static final RequestDispatcherDecorator DECORATE = new RequestDispatcherDecorator();\n   public static final CharSequence JAVA_WEB_SERVLET_DISPATCHER =\n       UTF8BytesString.createConstant(\"java-web-servlet-dispatcher\");\n \n+  private static Method STATUS_CODE_METHOD;", "originalCommit": "bb687ed5ed9bcc47c397cc94ad72c277e7d13f20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM1MDkzMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r502350931", "bodyText": "if you make this private static final and use a MethodHandle it will definitely be constant folded by the JIT compiler and it would be as good as calling the method itself.", "author": "richardstartin", "createdAt": "2020-10-09T11:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA1MDg0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUxMTUzNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r502511535", "bodyText": "Yes, I agree.  We should use MethodHandle whenever we can.  MethodHandles will tend to perform as well or better than reflection.  Both MethodHandles & reflection will generate classes, but MethodHandles do so without also requiring a ClassLoader and the generated class doesn't need to processed by instrumentation.", "author": "dougqh", "createdAt": "2020-10-09T15:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA1MDg0Mg=="}], "type": "inlineReview"}, {"oid": "e3b05e3c3cd579e8914ba9d122fc0b79c40e2f34", "url": "https://github.com/DataDog/dd-trace-java/commit/e3b05e3c3cd579e8914ba9d122fc0b79c40e2f34", "message": "Add childOfPrevious to spanAssert", "committedDate": "2020-10-09T20:52:07Z", "type": "commit"}, {"oid": "c024ee5a902fec915945c1e7faa1860165fe0597", "url": "https://github.com/DataDog/dd-trace-java/commit/c024ee5a902fec915945c1e7faa1860165fe0597", "message": "Request dispatcher fixes", "committedDate": "2020-10-09T20:52:07Z", "type": "commit"}, {"oid": "667e9332ecaa37bbda81a98b4d57eeac1e828a51", "url": "https://github.com/DataDog/dd-trace-java/commit/667e9332ecaa37bbda81a98b4d57eeac1e828a51", "message": "Test fixes and cleanup (tomcat)", "committedDate": "2020-10-09T20:52:07Z", "type": "commit"}, {"oid": "1225be176f0f6c4cdf6524a25cf5b2f36c930b66", "url": "https://github.com/DataDog/dd-trace-java/commit/1225be176f0f6c4cdf6524a25cf5b2f36c930b66", "message": "Jetty request-3 tests", "committedDate": "2020-10-09T20:52:07Z", "type": "commit"}, {"oid": "44e54ad56606c7c3379dc46bff47440567c2cf14", "url": "https://github.com/DataDog/dd-trace-java/commit/44e54ad56606c7c3379dc46bff47440567c2cf14", "message": "Spring mvc fixes", "committedDate": "2020-10-09T20:52:07Z", "type": "commit"}, {"oid": "7532b8861f15bf0d34cf862d1ea22b3cf4c43e4e", "url": "https://github.com/DataDog/dd-trace-java/commit/7532b8861f15bf0d34cf862d1ea22b3cf4c43e4e", "message": "Change comment wording", "committedDate": "2020-10-09T20:52:07Z", "type": "commit"}, {"oid": "6726b4d0e0df3471959f31d064a91dd5a6f11bf6", "url": "https://github.com/DataDog/dd-trace-java/commit/6726b4d0e0df3471959f31d064a91dd5a6f11bf6", "message": "Small fixes", "committedDate": "2020-10-09T20:52:07Z", "type": "commit"}, {"oid": "435385b908d720796e790eb2cd073c700f0d3697", "url": "https://github.com/DataDog/dd-trace-java/commit/435385b908d720796e790eb2cd073c700f0d3697", "message": "Method handle instead of reflection", "committedDate": "2020-10-09T20:52:07Z", "type": "commit"}, {"oid": "a546ccf23bc038e6915b1e42932a36691a5df293", "url": "https://github.com/DataDog/dd-trace-java/commit/a546ccf23bc038e6915b1e42932a36691a5df293", "message": "Fix test", "committedDate": "2020-10-09T20:52:07Z", "type": "commit"}, {"oid": "1b40843738144f87219fa3e85290e59f73483993", "url": "https://github.com/DataDog/dd-trace-java/commit/1b40843738144f87219fa3e85290e59f73483993", "message": "Later versions of Jetty create multiple response spans", "committedDate": "2020-10-09T20:52:07Z", "type": "commit"}, {"oid": "1b40843738144f87219fa3e85290e59f73483993", "url": "https://github.com/DataDog/dd-trace-java/commit/1b40843738144f87219fa3e85290e59f73483993", "message": "Later versions of Jetty create multiple response spans", "committedDate": "2020-10-09T20:52:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4MTEyNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r503181127", "bodyText": "what about other 2xx and 3xx non-error statuses - should they still be reported unchanged when there's an exception?", "author": "mcculls", "createdAt": "2020-10-12T09:58:20Z", "path": "dd-java-agent/instrumentation/servlet/src/main/java/datadog/trace/instrumentation/servlet/dispatcher/RequestDispatcherDecorator.java", "diffHunk": "@@ -22,4 +50,35 @@ protected CharSequence spanType() {\n   protected CharSequence component() {\n     return JAVA_WEB_SERVLET_DISPATCHER;\n   }\n+\n+  @Override\n+  public AgentSpan onError(final AgentSpan span, final Throwable throwable) {\n+    if (throwable instanceof ServletException && throwable.getCause() != null) {\n+      super.onError(span, throwable.getCause());\n+    } else {\n+      super.onError(span, throwable);\n+    }\n+    return span;\n+  }\n+\n+  public AgentSpan onResponse(\n+      final AgentSpan span, final ServletResponse response, Throwable throwable) {\n+    if (response instanceof HttpServletResponse && STATUS_CODE_METHOD != null) {\n+      try {\n+        int status = (int) STATUS_CODE_METHOD.invokeExact((HttpServletResponse) response);\n+\n+        if (throwable != null && status == HttpServletResponse.SC_OK) {", "originalCommit": "1b40843738144f87219fa3e85290e59f73483993", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEwOTExNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r504109114", "bodyText": "This is copying the behavior of other there server instrumentations.  There are bigger questions around different statuses, the tracer setting 500 even when the exception is handled, and mapping exceptions to different statuses.", "author": "randomanderson", "createdAt": "2020-10-13T16:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4MTEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4Nzc2NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1965#discussion_r503187764", "bodyText": "I sometimes widen catch blocks like this to Exception | LinkageError just to be absolutely sure...", "author": "mcculls", "createdAt": "2020-10-12T10:09:34Z", "path": "dd-java-agent/instrumentation/servlet/src/main/java/datadog/trace/instrumentation/servlet/dispatcher/RequestDispatcherDecorator.java", "diffHunk": "@@ -1,13 +1,41 @@\n package datadog.trace.instrumentation.servlet.dispatcher;\n \n+import static datadog.trace.api.cache.RadixTreeCache.HTTP_STATUSES;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n import datadog.trace.bootstrap.instrumentation.decorator.BaseDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n \n public class RequestDispatcherDecorator extends BaseDecorator {\n   public static final RequestDispatcherDecorator DECORATE = new RequestDispatcherDecorator();\n   public static final CharSequence JAVA_WEB_SERVLET_DISPATCHER =\n       UTF8BytesString.createConstant(\"java-web-servlet-dispatcher\");\n \n+  private static final MethodHandle STATUS_CODE_METHOD;\n+\n+  static {\n+    // to satisfy the compiler that STATUS_CODE_METHOD is only assigned once\n+    // use a local variable\n+    MethodHandle local = null;\n+    try {\n+      local =\n+          MethodHandles.publicLookup()\n+              .findVirtual(\n+                  HttpServletResponse.class, \"getStatus\", MethodType.methodType(int.class));\n+    } catch (NoSuchMethodException | IllegalAccessException e) {", "originalCommit": "1b40843738144f87219fa3e85290e59f73483993", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}