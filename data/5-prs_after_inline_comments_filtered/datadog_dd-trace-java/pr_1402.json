{"pr_number": 1402, "pr_title": "[okhttp] Add instrumentation for okhttp 2.2+", "pr_createdAt": "2020-04-27T17:27:45Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1402", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjExNDY3OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1402#discussion_r416114678", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                super(\"okhttp2\");\n          \n          \n            \n                super(\"okhttp\", \"okhttp-2\");", "author": "tylerbenson", "createdAt": "2020-04-27T20:10:56Z", "path": "dd-java-agent/instrumentation/okhttp-2/src/main/java/datadog/trace/instrumentation/okhttp2/OkHttp2Instrumentation.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package datadog.trace.instrumentation.okhttp2;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+\n+import com.google.auto.service.AutoService;\n+import com.squareup.okhttp.Interceptor;\n+import com.squareup.okhttp.OkHttpClient;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.isConstructor;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+@AutoService(Instrumenter.class)\n+public class OkHttp2Instrumentation extends Instrumenter.Default {\n+  public OkHttp2Instrumentation() {\n+    super(\"okhttp2\");", "originalCommit": "a7e2816c0c14aef28d3cb7152a5ee3c518b6d08c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjExNTQwNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1402#discussion_r416115407", "bodyText": "This should match the names in the OkHttp2Instrumentation constructor.", "author": "tylerbenson", "createdAt": "2020-04-27T20:12:01Z", "path": "dd-java-agent/instrumentation/okhttp-2/src/main/java/datadog/trace/instrumentation/okhttp2/OkHttpClientDecorator.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package datadog.trace.instrumentation.okhttp2;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import com.squareup.okhttp.Request;\n+import com.squareup.okhttp.Response;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpClientDecorator;\n+\n+public class OkHttpClientDecorator extends HttpClientDecorator<Request, Response> {\n+  public static final OkHttpClientDecorator DECORATE = new OkHttpClientDecorator();\n+\n+  @Override\n+  protected String method(Request request) {\n+    return request.method();\n+  }\n+\n+  @Override\n+  protected URI url(Request request) throws URISyntaxException {\n+    return request.url().toURI();\n+  }\n+\n+  @Override\n+  protected Integer status(Response response) {\n+    return response.code();\n+  }\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[]{\"okhttp\"};", "originalCommit": "a7e2816c0c14aef28d3cb7152a5ee3c518b6d08c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjExNjc1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1402#discussion_r416116750", "bodyText": "This part was added to the 3.x instrumentation because we use it internally and didn't want to trace our own requests.  This instrumentation shouldn't apply there, so this is unnecessary (but harmless).", "author": "tylerbenson", "createdAt": "2020-04-27T20:14:23Z", "path": "dd-java-agent/instrumentation/okhttp-2/src/main/java/datadog/trace/instrumentation/okhttp2/TracingInterceptor.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package datadog.trace.instrumentation.okhttp2;\n+\n+import java.io.IOException;\n+\n+import com.squareup.okhttp.Interceptor;\n+import com.squareup.okhttp.Request;\n+import com.squareup.okhttp.Response;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.propagate;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.okhttp2.OkHttpClientDecorator.DECORATE;\n+import static datadog.trace.instrumentation.okhttp2.RequestBuilderInjectAdapter.SETTER;\n+\n+public class TracingInterceptor implements Interceptor {\n+  @Override\n+  public Response intercept(Chain chain) throws IOException {\n+    if (chain.request().header(\"Datadog-Meta-Lang\") != null) {\n+      return chain.proceed(chain.request());\n+    }", "originalCommit": "a7e2816c0c14aef28d3cb7152a5ee3c518b6d08c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "447f3e8198996d899d939c76753e0c81091eb900", "url": "https://github.com/DataDog/dd-trace-java/commit/447f3e8198996d899d939c76753e0c81091eb900", "message": "[okhttp] Add instrumentation for okhttp 2.2+", "committedDate": "2020-04-29T06:24:21Z", "type": "forcePushed"}, {"oid": "1ae1b4f89f7d1885efdc9668eba4c9a5079d4ead", "url": "https://github.com/DataDog/dd-trace-java/commit/1ae1b4f89f7d1885efdc9668eba4c9a5079d4ead", "message": "[okhttp] Add instrumentation for okhttp 2.2+", "committedDate": "2020-04-29T16:43:24Z", "type": "forcePushed"}, {"oid": "46f4e248dcaf8cc487e366199d5eab4cdd2fd75c", "url": "https://github.com/DataDog/dd-trace-java/commit/46f4e248dcaf8cc487e366199d5eab4cdd2fd75c", "message": "[okhttp] Add instrumentation for okhttp 2.2+", "committedDate": "2020-04-29T17:04:33Z", "type": "commit"}, {"oid": "46f4e248dcaf8cc487e366199d5eab4cdd2fd75c", "url": "https://github.com/DataDog/dd-trace-java/commit/46f4e248dcaf8cc487e366199d5eab4cdd2fd75c", "message": "[okhttp] Add instrumentation for okhttp 2.2+", "committedDate": "2020-04-29T17:04:33Z", "type": "forcePushed"}]}