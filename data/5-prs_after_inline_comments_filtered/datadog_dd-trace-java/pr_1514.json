{"pr_number": 1514, "pr_title": "Always send id as long", "pr_createdAt": "2020-06-01T12:11:03Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1514", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ0NjA1NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1514#discussion_r433446055", "bodyText": "If we want to produce 64 bit ids why not do (ThreadLocalRandom.current().nextLong(1) << 63) | ThreadLocalRandom.current().nextLong(Long.MAX_VALUE)?", "author": "richardstartin", "createdAt": "2020-06-01T19:36:24Z", "path": "dd-trace-api/src/main/java/datadog/trace/api/DDId.java", "diffHunk": "@@ -24,13 +23,11 @@\n    * @return DDId\n    */\n   public static DDId generate() {\n-    // It is **extremely** unlikely to generate the value \"0\" but we still need to handle that\n-    // case\n+    // It is **extremely** unlikely to generate the value \"0\" but we still need to handle that case\n     long id;\n     do {\n-      // TODO the ids are positive here by design to avoid materialization of a BigInteger,\n-      //      and that can be changed to nextLong(Long.MIN_VALUE, Long.MAX_VALUE), when\n-      //      msgpack supports packUnsignedLong\n+      // TODO the ids are positive here since Java 7 doesn't support a negative origin. Can be\n+      //  changed to nextLong(Long.MIN_VALUE, Long.MAX_VALUE), when Java 7 support is dropped.\n       id = ThreadLocalRandom.current().nextLong(Long.MAX_VALUE);", "originalCommit": "3dea3550a4d95e30251cca74d04e3679ee60cd8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ0ODM5Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1514#discussion_r433448397", "bodyText": "We don't... we only want to produce 63 bit IDs.", "author": "tylerbenson", "createdAt": "2020-06-01T19:40:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ0NjA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY0NDc3Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1514#discussion_r433644777", "bodyText": "@tylerbenson It would be great if you could expand on that a bit. Why don't we want to use the last bit, since we still support it for ids that come from external sources?", "author": "bantonsson", "createdAt": "2020-06-02T06:21:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ0NjA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkyMDA4OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1514#discussion_r433920088", "bodyText": "These IDs are sent across the network to other clients and there are some clients that did not handle the full unsigned range well (including some very early Java versions).  It's been a long time though so maybe it isn't that big of deal, but we decided back then to support the full 64 bits, but only generate 63 bit ids to avoid causing problems elsewhere.  I would suggest we stay at 63 bits until we decide we need the full range.", "author": "tylerbenson", "createdAt": "2020-06-02T14:27:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ0NjA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4NTAyNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1514#discussion_r433985027", "bodyText": "Ok, I'll update the comment to reflect that as well...", "author": "bantonsson", "createdAt": "2020-06-02T15:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ0NjA1NQ=="}], "type": "inlineReview"}, {"oid": "0314e3ebcd4a2b2dc3973099446a8092d924599f", "url": "https://github.com/DataDog/dd-trace-java/commit/0314e3ebcd4a2b2dc3973099446a8092d924599f", "message": "Always send id as long", "committedDate": "2020-06-03T07:16:40Z", "type": "forcePushed"}, {"oid": "e1b55c7d419095f6da7204d824a248ecd4c1d6bc", "url": "https://github.com/DataDog/dd-trace-java/commit/e1b55c7d419095f6da7204d824a248ecd4c1d6bc", "message": "Always send id as long", "committedDate": "2020-06-03T07:33:38Z", "type": "commit"}, {"oid": "e1b55c7d419095f6da7204d824a248ecd4c1d6bc", "url": "https://github.com/DataDog/dd-trace-java/commit/e1b55c7d419095f6da7204d824a248ecd4c1d6bc", "message": "Always send id as long", "committedDate": "2020-06-03T07:33:38Z", "type": "forcePushed"}]}