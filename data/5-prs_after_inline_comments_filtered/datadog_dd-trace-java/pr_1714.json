{"pr_number": 1714, "pr_title": "MLT - Delay processing of stacktrace on construct", "pr_createdAt": "2020-07-27T16:05:12Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1714", "timeline": [{"oid": "df420124b20b53982671246d172b82638e9a062e", "url": "https://github.com/DataDog/dd-trace-java/commit/df420124b20b53982671246d172b82638e9a062e", "message": "MLT - Delay processing of stacktrace on construct\n\nThis was expensive, so we want to do it the first time collect is called, which will be on a background thread.", "committedDate": "2020-07-27T16:02:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwMzgwNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1714#discussion_r461003806", "bodyText": "for me it needs to be volatile here\ncollect will be called by JMXSampler thread", "author": "jpbempel", "createdAt": "2020-07-27T16:10:29Z", "path": "utils/mlt-support/src/main/java/com/datadog/mlt/io/MLTChunkCollector.java", "diffHunk": "@@ -17,6 +17,12 @@\n   private static final boolean USE_SUBTREE_COMPRESSION =\n       Boolean.getBoolean(\"mlt.subtree_compression\");\n \n+  /**\n+   * Base stacktrace to add the first time collect is called. This is done to avoid the cost of\n+   * converting in the main thread (especially if no additional stacktraces are collected).\n+   */\n+  private StackTraceElement[] baseStack;", "originalCommit": "df420124b20b53982671246d172b82638e9a062e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwNTk5NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1714#discussion_r461005994", "bodyText": "but it's initialized in the constructor, so visibility should be guaranteed, right?", "author": "tylerbenson", "createdAt": "2020-07-27T16:13:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwMzgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwODEwNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1714#discussion_r461008106", "bodyText": "only for final fields\nhttps://shipilev.net/blog/2014/all-fields-are-final/", "author": "jpbempel", "createdAt": "2020-07-27T16:17:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwMzgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwOTI5NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1714#discussion_r461009294", "bodyText": "Right, any fields set in constructor should be visible once initialized instance is released.", "author": "jbachorik", "createdAt": "2020-07-27T16:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwMzgwNg=="}], "type": "inlineReview"}, {"oid": "684d18e01162e8820c2956fbdce404f1be6cae65", "url": "https://github.com/DataDog/dd-trace-java/commit/684d18e01162e8820c2956fbdce404f1be6cae65", "message": "make field volatile\n\nsince it's a non-final field and referenced in a different thread than where it is constructed.", "committedDate": "2020-07-27T16:43:44Z", "type": "commit"}]}