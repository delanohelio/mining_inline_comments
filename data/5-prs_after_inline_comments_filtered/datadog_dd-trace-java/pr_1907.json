{"pr_number": 1907, "pr_title": "Cleanup dependency on Guava", "pr_createdAt": "2020-09-23T21:39:39Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1907", "timeline": [{"oid": "4a80b3715bd3070374e26e1d9544d772be25df52", "url": "https://github.com/DataDog/dd-trace-java/commit/4a80b3715bd3070374e26e1d9544d772be25df52", "message": "Remove guava from core with RateLimiter impl", "committedDate": "2020-09-24T20:28:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk3OTA1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r494979050", "bodyText": "Can we extract this somewhere it can be reused? This is a good practice we should build on for testability.", "author": "richardstartin", "createdAt": "2020-09-25T13:15:21Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SimpleRateLimiter.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package datadog.trace.core.util;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+/** Rate limiter that only supports non-blocking retrieval of a single token */\n+public class SimpleRateLimiter {\n+  private final long capacity;\n+  private long tokens;\n+  private long lastRefillTime;\n+  private final long refillIntervalInNanos;\n+  private final TimeSource timeSource;\n+\n+  public SimpleRateLimiter(long rate, TimeUnit unit) {\n+    this(rate, unit, new SystemNanoTimeSource());\n+  }\n+\n+  protected SimpleRateLimiter(long rate, TimeUnit unit, TimeSource timeSource) {\n+    refillIntervalInNanos = unit.toNanos(1) / rate;\n+    capacity = rate;\n+    tokens = rate;\n+    this.timeSource = timeSource;\n+    lastRefillTime = timeSource.getTime();\n+  }\n+\n+  public synchronized boolean tryAcquire() {\n+    fill();\n+\n+    if (tokens > 0) {\n+      tokens--;\n+      return true;\n+    } else {\n+      return false;\n+    }\n+  }\n+\n+  private void fill() {\n+    long timeElapsedSinceLastRefill = timeSource.getTime() - lastRefillTime;\n+    long intervals = timeElapsedSinceLastRefill / refillIntervalInNanos;\n+    tokens = Math.min(capacity, tokens + intervals);\n+\n+    lastRefillTime += intervals * refillIntervalInNanos;\n+  }\n+\n+  // This can probably be extracted to be more generic\n+  interface TimeSource {", "originalCommit": "48993be05430e17ad3cc939d9abe4389aa983338", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI3MDgzNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r495270834", "bodyText": "I extracted it.  RatelimitedLogger was using another similar interface", "author": "randomanderson", "createdAt": "2020-09-25T22:07:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk3OTA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk3OTQyNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r494979426", "bodyText": "Does this really need to be unmodifiable if we're making a copy anyway?", "author": "richardstartin", "createdAt": "2020-09-25T13:16:00Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java", "diffHunk": "@@ -407,7 +406,7 @@ Object unsafeGetAndRemoveTag(final String tag) {\n \n   public Map<String, Object> getTags() {\n     synchronized (unsafeTags) {\n-      return ImmutableMap.copyOf(unsafeTags);\n+      return Collections.unmodifiableMap(new HashMap<>(unsafeTags));", "originalCommit": "48993be05430e17ad3cc939d9abe4389aa983338", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExNDY1NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r495114655", "bodyText": "Yes. If a user tries to make changes to the map, we want them to know right away that it won't be reflected.", "author": "randomanderson", "createdAt": "2020-09-25T16:54:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk3OTQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyMjIwNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r495122207", "bodyText": "OK but can't we just put javadoc on the interface to make clear it's a copy? I'm OK with leaving it the way it is though.", "author": "richardstartin", "createdAt": "2020-09-25T17:08:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk3OTQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk4MzAyMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r494983022", "bodyText": "This is called from application threads and could easily create contention. Could we use something based on atomics and check if after decrementing the atomic is still positive, giving an approximate result?\nAlternatively, do we really need this class? Can we just delete it? Sampling rate can be controlled probabilistically without contention by adjusting/controlling distribution parameters", "author": "richardstartin", "createdAt": "2020-09-25T13:21:39Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SimpleRateLimiter.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package datadog.trace.core.util;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+/** Rate limiter that only supports non-blocking retrieval of a single token */\n+public class SimpleRateLimiter {\n+  private final long capacity;\n+  private long tokens;\n+  private long lastRefillTime;\n+  private final long refillIntervalInNanos;\n+  private final TimeSource timeSource;\n+\n+  public SimpleRateLimiter(long rate, TimeUnit unit) {\n+    this(rate, unit, new SystemNanoTimeSource());\n+  }\n+\n+  protected SimpleRateLimiter(long rate, TimeUnit unit, TimeSource timeSource) {\n+    refillIntervalInNanos = unit.toNanos(1) / rate;\n+    capacity = rate;\n+    tokens = rate;\n+    this.timeSource = timeSource;\n+    lastRefillTime = timeSource.getTime();\n+  }\n+\n+  public synchronized boolean tryAcquire() {", "originalCommit": "48993be05430e17ad3cc939d9abe4389aa983338", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk4NzIyNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r494987226", "bodyText": "I collaborated on a Java 6 compatible rate limiting sampler for brave I think we could consider: https://github.com/openzipkin/brave/blob/master/brave/src/main/java/brave/sampler/RateLimitingSampler.java", "author": "devinsba", "createdAt": "2020-09-25T13:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk4MzAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI3MjM1OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r495272358", "bodyText": "I ended up doing something simpler.  Only refilling once per second.  Much easier than dividing up the second and dealing with rounding issues.  If we need something more complex later we can add it (or switch to Java8+ and use one of the many libs available).", "author": "randomanderson", "createdAt": "2020-09-25T22:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk4MzAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk4NTA1Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r494985056", "bodyText": "Unrelated to this PR, probably not too important, can we move this one line down and use the classMethods to get an estimate for the size?", "author": "richardstartin", "createdAt": "2020-09-25T13:24:58Z", "path": "dd-java-agent/instrumentation/trace-annotation/src/main/java/datadog/trace/instrumentation/trace_annotation/TraceConfigInstrumentation.java", "diffHunk": "@@ -68,7 +68,7 @@ public TraceConfigInstrumentation() {\n       classMethodsToTrace = Collections.emptyMap();\n \n     } else {\n-      final Map<String, Set<String>> toTrace = Maps.newHashMap();\n+      final Map<String, Set<String>> toTrace = new HashMap<>();", "originalCommit": "48993be05430e17ad3cc939d9abe4389aa983338", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk4NTUyMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r494985520", "bodyText": "I think we could size this one accurately too", "author": "richardstartin", "createdAt": "2020-09-25T13:25:41Z", "path": "dd-java-agent/instrumentation/trace-annotation/src/main/java/datadog/trace/instrumentation/trace_annotation/TraceAnnotationsInstrumentation.java", "diffHunk": "@@ -60,7 +60,7 @@ public TraceAnnotationsInstrumentation() {\n           configString);\n       additionalTraceAnnotations = Collections.emptySet();\n     } else {\n-      final Set<String> annotations = Sets.newHashSet();\n+      final Set<String> annotations = new HashSet<>();", "originalCommit": "48993be05430e17ad3cc939d9abe4389aa983338", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMxMzg1NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r495313855", "bodyText": "I suggest giving this method a better name that represents the intended precision and clock type (time vs ticks).  Perhaps it could also be combined with datadog.trace.core.util.Clock?", "author": "tylerbenson", "createdAt": "2020-09-25T23:24:01Z", "path": "internal-api/src/main/java/datadog/trace/api/time/TimeSource.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package datadog.trace.api.time;\n+\n+public interface TimeSource {\n+  long get();", "originalCommit": "03874dc503a9723ae7ee93722b58963d4faca7c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMxNDIxOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r495314218", "bodyText": "The bigger part of this suggestion might be better in a separate PR.", "author": "tylerbenson", "createdAt": "2020-09-25T23:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMxMzg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3MTEwMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r496171102", "bodyText": "I changed it to getNanoTime().  I initially just pulled up an existing interface from RatelimitedLogger to a toplevel class.  If we want to make a more pervasive change, I think that belongs in a separate PR", "author": "randomanderson", "createdAt": "2020-09-28T19:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMxMzg1NQ=="}], "type": "inlineReview"}, {"oid": "71fd172059137c114505463b5015533b41e4ea43", "url": "https://github.com/DataDog/dd-trace-java/commit/71fd172059137c114505463b5015533b41e4ea43", "message": "Fix annotation processing not to pull in guava", "committedDate": "2020-09-28T17:15:54Z", "type": "commit"}, {"oid": "e0ee130a0bb5ee5fd392bfdf0049a56704d1ce53", "url": "https://github.com/DataDog/dd-trace-java/commit/e0ee130a0bb5ee5fd392bfdf0049a56704d1ce53", "message": "Remove guava where its unneeded", "committedDate": "2020-09-28T17:15:54Z", "type": "commit"}, {"oid": "ff1705ebc5bb7c3a29361b43252835245a7f4b73", "url": "https://github.com/DataDog/dd-trace-java/commit/ff1705ebc5bb7c3a29361b43252835245a7f4b73", "message": "Glassfish brings in the wrong Guava version", "committedDate": "2020-09-28T17:15:55Z", "type": "commit"}, {"oid": "8129ec24aefa553ab6bf629de25e136092e30d7a", "url": "https://github.com/DataDog/dd-trace-java/commit/8129ec24aefa553ab6bf629de25e136092e30d7a", "message": "Remove guava from core with RateLimiter impl", "committedDate": "2020-09-28T17:15:55Z", "type": "commit"}, {"oid": "123bebee7b02dc9fbce61e2d5e36dc572756514d", "url": "https://github.com/DataDog/dd-trace-java/commit/123bebee7b02dc9fbce61e2d5e36dc572756514d", "message": "Remove some direct dependencies on agent-tooling", "committedDate": "2020-09-28T17:15:55Z", "type": "commit"}, {"oid": "14803e80469fd7038b7e49072a3ed9afb4882d1b", "url": "https://github.com/DataDog/dd-trace-java/commit/14803e80469fd7038b7e49072a3ed9afb4882d1b", "message": "presize maps", "committedDate": "2020-09-28T17:15:55Z", "type": "commit"}, {"oid": "c7f01d7e136bce1d96119a0eefe50577aee5c073", "url": "https://github.com/DataDog/dd-trace-java/commit/c7f01d7e136bce1d96119a0eefe50577aee5c073", "message": "Extract time source.  Use synchronized-free limiter", "committedDate": "2020-09-28T17:15:55Z", "type": "commit"}, {"oid": "4487c58f7e5c928bae4e09fb36ac1482ce434ef4", "url": "https://github.com/DataDog/dd-trace-java/commit/4487c58f7e5c928bae4e09fb36ac1482ce434ef4", "message": "Change get() to getNanoTime()", "committedDate": "2020-09-28T17:15:55Z", "type": "commit"}, {"oid": "4487c58f7e5c928bae4e09fb36ac1482ce434ef4", "url": "https://github.com/DataDog/dd-trace-java/commit/4487c58f7e5c928bae4e09fb36ac1482ce434ef4", "message": "Change get() to getNanoTime()", "committedDate": "2020-09-28T17:15:55Z", "type": "forcePushed"}, {"oid": "86ab0401edf6a015de932c3dcd4031ecd653eebf", "url": "https://github.com/DataDog/dd-trace-java/commit/86ab0401edf6a015de932c3dcd4031ecd653eebf", "message": "add math utils test", "committedDate": "2020-09-28T19:03:00Z", "type": "commit"}, {"oid": "78e5db55a2c53e423bf4087f005e63a4e7ff43be", "url": "https://github.com/DataDog/dd-trace-java/commit/78e5db55a2c53e423bf4087f005e63a4e7ff43be", "message": "Add ControllableTimeSource test", "committedDate": "2020-09-28T20:33:28Z", "type": "commit"}, {"oid": "78e5db55a2c53e423bf4087f005e63a4e7ff43be", "url": "https://github.com/DataDog/dd-trace-java/commit/78e5db55a2c53e423bf4087f005e63a4e7ff43be", "message": "Add ControllableTimeSource test", "committedDate": "2020-09-28T20:33:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ3MTI3Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1907#discussion_r496471273", "bodyText": "timeSource.getNanoTime() - localRefill is the same as now - localRefill", "author": "bantonsson", "createdAt": "2020-09-29T07:20:00Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SimpleRateLimiter.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package datadog.trace.core.util;\n+\n+import datadog.trace.api.time.SystemTimeSource;\n+import datadog.trace.api.time.TimeSource;\n+import datadog.trace.api.utils.MathUtils;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+/**\n+ * Rate limiter that only supports non-blocking retrieval of a single token at a minimum rate of 1\n+ * per second. Tokens are not smoothed across the second\n+ */\n+public class SimpleRateLimiter {\n+  private static final long REFILL_INTERVAL = TimeUnit.SECONDS.toNanos(1);\n+  private final long capacity;\n+  private final AtomicLong tokens;\n+  private final AtomicLong lastRefillTime;\n+  private final TimeSource timeSource;\n+\n+  public SimpleRateLimiter(long rate) {\n+    this(rate, SystemTimeSource.INSTANCE);\n+  }\n+\n+  protected SimpleRateLimiter(long rate, TimeSource timeSource) {\n+    this.timeSource = timeSource;\n+\n+    capacity = Math.max(1, rate);\n+\n+    tokens = new AtomicLong(capacity);\n+\n+    lastRefillTime = new AtomicLong(timeSource.getNanoTime());\n+  }\n+\n+  public boolean tryAcquire() {\n+    long now = timeSource.getNanoTime();\n+    long localRefill = lastRefillTime.get();\n+    long timeElapsedSinceLastRefill = timeSource.getNanoTime() - localRefill;", "originalCommit": "78e5db55a2c53e423bf4087f005e63a4e7ff43be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4279751ea659161364d25d5c6567420485866425", "url": "https://github.com/DataDog/dd-trace-java/commit/4279751ea659161364d25d5c6567420485866425", "message": "review comments", "committedDate": "2020-09-29T15:23:54Z", "type": "commit"}]}