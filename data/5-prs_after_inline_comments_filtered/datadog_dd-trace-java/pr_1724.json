{"pr_number": 1724, "pr_title": "Axway API integration", "pr_createdAt": "2020-07-29T04:41:03Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1724", "timeline": [{"oid": "fd4b18aafab08a2f4607ba255e357cd9d6466959", "url": "https://github.com/DataDog/dd-trace-java/commit/fd4b18aafab08a2f4607ba255e357cd9d6466959", "message": "Axway API integration draft", "committedDate": "2020-07-29T05:25:54Z", "type": "forcePushed"}, {"oid": "7d798c6203dc0e190dfe91abc0c9eb699ee80652", "url": "https://github.com/DataDog/dd-trace-java/commit/7d798c6203dc0e190dfe91abc0c9eb699ee80652", "message": "Axway API integration draft", "committedDate": "2020-08-02T20:42:25Z", "type": "forcePushed"}, {"oid": "f40eca6067ab53298f8896e79a8d178f40c0365e", "url": "https://github.com/DataDog/dd-trace-java/commit/f40eca6067ab53298f8896e79a8d178f40c0365e", "message": "Axway API integration draft", "committedDate": "2020-08-04T04:22:28Z", "type": "forcePushed"}, {"oid": "0786c22eb7e366a8472638bf5bff7d17ea16d847", "url": "https://github.com/DataDog/dd-trace-java/commit/0786c22eb7e366a8472638bf5bff7d17ea16d847", "message": "Axway API integration draft", "committedDate": "2020-08-05T02:11:03Z", "type": "forcePushed"}, {"oid": "14f4c8c10909e4d32a1a588b0eceb01295c9dc92", "url": "https://github.com/DataDog/dd-trace-java/commit/14f4c8c10909e4d32a1a588b0eceb01295c9dc92", "message": "Axway API integration draft", "committedDate": "2020-08-05T02:43:02Z", "type": "forcePushed"}, {"oid": "f73197de0189e8fe1ccb10d9d14246fd6d28cff6", "url": "https://github.com/DataDog/dd-trace-java/commit/f73197de0189e8fe1ccb10d9d14246fd6d28cff6", "message": "Axway API integration draft", "committedDate": "2020-08-05T03:43:34Z", "type": "forcePushed"}, {"oid": "6e60182033ca94438e9e1ab98fab2036b42954b1", "url": "https://github.com/DataDog/dd-trace-java/commit/6e60182033ca94438e9e1ab98fab2036b42954b1", "message": "Axway API integration draft", "committedDate": "2020-11-24T05:05:08Z", "type": "forcePushed"}, {"oid": "15581e9b490553a725ad27bec97f1467c7342826", "url": "https://github.com/DataDog/dd-trace-java/commit/15581e9b490553a725ad27bec97f1467c7342826", "message": "Axway API integration draft", "committedDate": "2020-11-30T10:45:22Z", "type": "forcePushed"}, {"oid": "cbf29823127ad776992475e149c510a29acb73e1", "url": "https://github.com/DataDog/dd-trace-java/commit/cbf29823127ad776992475e149c510a29acb73e1", "message": "Axway API integration draft", "committedDate": "2020-11-30T11:42:52Z", "type": "forcePushed"}, {"oid": "90588d798d6ae1fc7b6310ffe008916def55bb23", "url": "https://github.com/DataDog/dd-trace-java/commit/90588d798d6ae1fc7b6310ffe008916def55bb23", "message": "Axway API integration draft", "committedDate": "2020-12-01T07:57:26Z", "type": "forcePushed"}, {"oid": "997bfcdcb22ce39310bb87627bda8147122eb0cf", "url": "https://github.com/DataDog/dd-trace-java/commit/997bfcdcb22ce39310bb87627bda8147122eb0cf", "message": "Axway API integration draft", "committedDate": "2020-12-01T08:26:58Z", "type": "forcePushed"}, {"oid": "394775b5d58807217d69f9fe6c7fce0f25132ea5", "url": "https://github.com/DataDog/dd-trace-java/commit/394775b5d58807217d69f9fe6c7fce0f25132ea5", "message": "Axway API integration", "committedDate": "2020-12-17T09:28:16Z", "type": "forcePushed"}, {"oid": "764e89e40472fd26db800ceedbdfe56d734395fe", "url": "https://github.com/DataDog/dd-trace-java/commit/764e89e40472fd26db800ceedbdfe56d734395fe", "message": "Axway API integration", "committedDate": "2020-12-30T04:55:24Z", "type": "forcePushed"}, {"oid": "1e1ee1851e2b07f424e94b9e8b6a7d6569b08702", "url": "https://github.com/DataDog/dd-trace-java/commit/1e1ee1851e2b07f424e94b9e8b6a7d6569b08702", "message": "Axway API integration", "committedDate": "2021-01-08T20:30:02Z", "type": "forcePushed"}, {"oid": "26b1ca10dfba4cf9929ff325eae8d5dad7d91cd5", "url": "https://github.com/DataDog/dd-trace-java/commit/26b1ca10dfba4cf9929ff325eae8d5dad7d91cd5", "message": "Axway API integration", "committedDate": "2021-01-14T06:47:00Z", "type": "forcePushed"}, {"oid": "3e8063808dc3b293622662cb4bc225a9899e7af9", "url": "https://github.com/DataDog/dd-trace-java/commit/3e8063808dc3b293622662cb4bc225a9899e7af9", "message": "Axway API integration", "committedDate": "2021-01-14T11:06:40Z", "type": "forcePushed"}, {"oid": "7fbc23b9fe98a94f2f0e2e5ef86a1e7382c61a79", "url": "https://github.com/DataDog/dd-trace-java/commit/7fbc23b9fe98a94f2f0e2e5ef86a1e7382c61a79", "message": "Axway API integration", "committedDate": "2021-01-20T06:26:12Z", "type": "forcePushed"}, {"oid": "910cf5aa3b260383bb2abdff52e0d9928b7ad46e", "url": "https://github.com/DataDog/dd-trace-java/commit/910cf5aa3b260383bb2abdff52e0d9928b7ad46e", "message": "Axway API integration", "committedDate": "2021-01-25T03:01:09Z", "type": "forcePushed"}, {"oid": "071d54882ff587eedc5c0b62efcbda7fb0f421d8", "url": "https://github.com/DataDog/dd-trace-java/commit/071d54882ff587eedc5c0b62efcbda7fb0f421d8", "message": "Axway API integration", "committedDate": "2021-01-27T10:20:24Z", "type": "forcePushed"}, {"oid": "1172c09061d152bbc5f3e589015a9643dcb802ce", "url": "https://github.com/DataDog/dd-trace-java/commit/1172c09061d152bbc5f3e589015a9643dcb802ce", "message": "Axway API integration", "committedDate": "2021-01-28T09:50:10Z", "type": "forcePushed"}, {"oid": "38e993a42dc87cc002eaaa967d90154d63d9471e", "url": "https://github.com/DataDog/dd-trace-java/commit/38e993a42dc87cc002eaaa967d90154d63d9471e", "message": "Axway API integration", "committedDate": "2021-02-02T10:48:54Z", "type": "forcePushed"}, {"oid": "d05f7dc68a2e6a06d9c2f9c0038b0c7d6a0aa20f", "url": "https://github.com/DataDog/dd-trace-java/commit/d05f7dc68a2e6a06d9c2f9c0038b0c7d6a0aa20f", "message": "Axway API integration", "committedDate": "2021-02-03T01:45:41Z", "type": "forcePushed"}, {"oid": "0e7787e6011ad88922678b876ff7a21447cc6588", "url": "https://github.com/DataDog/dd-trace-java/commit/0e7787e6011ad88922678b876ff7a21447cc6588", "message": "Axway API integration", "committedDate": "2021-02-03T07:43:17Z", "type": "forcePushed"}, {"oid": "753c5cc2884215cc1c10ac2ae4c5ee598df50fd0", "url": "https://github.com/DataDog/dd-trace-java/commit/753c5cc2884215cc1c10ac2ae4c5ee598df50fd0", "message": "Axway API integration", "committedDate": "2021-02-03T10:06:19Z", "type": "forcePushed"}, {"oid": "84118ae990736c2e1de1ee4789f7aea2a9b646df", "url": "https://github.com/DataDog/dd-trace-java/commit/84118ae990736c2e1de1ee4789f7aea2a9b646df", "message": "Axway API integration", "committedDate": "2021-02-03T11:02:43Z", "type": "forcePushed"}, {"oid": "4d17eb373275ecc3faea406770c7bfef0cdb22ab", "url": "https://github.com/DataDog/dd-trace-java/commit/4d17eb373275ecc3faea406770c7bfef0cdb22ab", "message": "Axway API integration", "committedDate": "2021-02-03T11:20:31Z", "type": "forcePushed"}, {"oid": "fbc9f0ef8e700f9ebc0b619af362996e741c2697", "url": "https://github.com/DataDog/dd-trace-java/commit/fbc9f0ef8e700f9ebc0b619af362996e741c2697", "message": "Axway API integration", "committedDate": "2021-02-03T16:47:46Z", "type": "forcePushed"}, {"oid": "1bb642ca13f585f57b91c6a87b8e7d17f1f93b9c", "url": "https://github.com/DataDog/dd-trace-java/commit/1bb642ca13f585f57b91c6a87b8e7d17f1f93b9c", "message": "Move reflection utils methods to Decorator", "committedDate": "2021-02-04T00:05:55Z", "type": "forcePushed"}, {"oid": "6cb3226bdc34db52c2ee20a51677c9955d23057f", "url": "https://github.com/DataDog/dd-trace-java/commit/6cb3226bdc34db52c2ee20a51677c9955d23057f", "message": "Move reflection utils methods to Decorator", "committedDate": "2021-02-04T06:55:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDA3NDY5Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570074696", "bodyText": "This doesn't look correct. Should there be an if (null != throwable) { ... } else { ... } here?", "author": "richardstartin", "createdAt": "2021-02-04T09:34:50Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/HTTPPluginAdvice.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.AXWAY_REQUEST;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.DECORATE;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import net.bytebuddy.asm.Advice;\n+\n+public class HTTPPluginAdvice {\n+\n+  @Advice.OnMethodEnter(suppress = Throwable.class)\n+  public static AgentScope onEnter(\n+      @Advice.This final Object stateInstance,\n+      @Advice.Argument(value = 2) final Object serverTransaction) {\n+    final AgentSpan span = startSpan(AXWAY_REQUEST);\n+    final AgentScope scope = activateSpan(span);\n+    span.setMeasured(true);\n+    DECORATE.afterStart(span);\n+    DECORATE.onConnection(span, serverTransaction);\n+    DECORATE.onRequest(span, serverTransaction);\n+    return scope;\n+  }\n+\n+  @Advice.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)\n+  public static void onExit(\n+      @Advice.Enter final AgentScope scope,\n+      @Advice.Argument(value = 2) final Object serverTransaction,\n+      @Advice.This final Object httpPlugin,\n+      // @Advice.Local(\"responseCode\") Integer responseCode,\n+      @Advice.Thrown final Throwable throwable) {\n+    if (scope == null) {\n+      return;\n+    }\n+    final AgentSpan span = scope.span();\n+    try {\n+      // manual DECORATE.onResponse(span, serverTransaction):\n+      // span.setTag(Tags.HTTP_STATUS, responseCode); //TODO\n+      DECORATE.onError(span, throwable);\n+      DECORATE.beforeFinish(span);", "originalCommit": "38968b0cf420914302634985addba97663e524a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2NzIxNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570367215", "bodyText": "Yes, it doesn't look correct, but it works. Check if (throwable != null) is here happening inside onError:\n\n  \n    \n      dd-trace-java/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/BaseDecorator.java\n    \n    \n         Line 104\n      in\n      38968b0\n    \n    \n    \n    \n\n        \n          \n           if (throwable != null) { \n        \n    \n  \n\n\nthis pattern used in other places with the assumption that null-check will be done inside onError. But I will add explicit check here.", "author": "lpriima", "createdAt": "2021-02-04T16:32:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDA3NDY5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDA3NTIxMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570075211", "bodyText": "Is it worth doing this with method handles?", "author": "richardstartin", "createdAt": "2021-02-04T09:35:37Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,88 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import org.slf4j.Logger;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final String METHOD = \"method\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final Logger log =\n+      org.slf4j.LoggerFactory.getLogger(AxwayHTTPPluginDecorator.class);\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-api\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-api\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    return invokeNoArgDeclaredMethod(serverTransaction, \"getMethod\").toString();\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    return new DefaultURIDataAdapter((URI) invokeNoArgDeclaredMethod(serverTransaction, \"getURI\"));\n+  }\n+\n+  @Override\n+  protected String peerHostIP(Object serverTransaction) {\n+    return ((InetSocketAddress)\n+            invokeNoArgsSuperSuperClassMethod(serverTransaction, \"getLocalAddr\"))\n+        .getHostString();\n+  }\n+\n+  @Override\n+  protected int peerPort(Object serverTransaction) {\n+    return ((InetSocketAddress)\n+            invokeNoArgsSuperSuperClassMethod(serverTransaction, \"getLocalAddr\"))\n+        .getPort();\n+  }\n+\n+  @Override\n+  protected int status(final Object serverTransaction) {\n+    // done manually\n+    return 0;\n+  }\n+\n+  public static Object invokeNoArgDeclaredMethod(Object obj, String methodName) {\n+    try {\n+      Method m = obj.getClass().getDeclaredMethod(methodName);\n+      m.setAccessible(true);\n+      Object v = m.invoke(obj);\n+      log.debug(\"{}(): {}\", methodName, v);\n+      return v;\n+    } catch (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) {\n+      log.debug(\"Can't find method '\" + methodName + \"' in object \" + obj, e);\n+    }\n+    return \"\";\n+  }\n+\n+  public static Object invokeNoArgsSuperSuperClassMethod(Object obj, String methodName) {\n+    try {\n+      Method m = obj.getClass().getSuperclass().getSuperclass().getMethod(methodName);\n+      Object v = m.invoke(obj);\n+      log.debug(\"{}(): {}\", methodName, v);\n+      return v;\n+    } catch (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) {\n+      log.debug(\"Can't find method '\" + methodName + \"' in object \" + obj, e);\n+    }\n+    return \"\";\n+  }", "originalCommit": "38968b0cf420914302634985addba97663e524a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQzOTc4OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570439788", "bodyText": "since class \"com.vordel.dwe.http.ServerTransaction\" only available at runtime and I have to call private methods, I'm not sure it will worth it. I will have to use reflection + MethodHandles.lookup().unreflect() to call private method", "author": "lpriima", "createdAt": "2021-02-04T18:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDA3NTIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDUwMTQ4OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570501489", "bodyText": "I've changed it to method handles.", "author": "lpriima", "createdAt": "2021-02-04T19:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDA3NTIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2Mjk2Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570362966", "bodyText": "What's the reason for using the super-super-class to get the method? Is this a static or instance method?", "author": "mcculls", "createdAt": "2021-02-04T16:27:14Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,88 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import org.slf4j.Logger;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final String METHOD = \"method\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final Logger log =\n+      org.slf4j.LoggerFactory.getLogger(AxwayHTTPPluginDecorator.class);\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-api\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-api\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    return invokeNoArgDeclaredMethod(serverTransaction, \"getMethod\").toString();\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    return new DefaultURIDataAdapter((URI) invokeNoArgDeclaredMethod(serverTransaction, \"getURI\"));\n+  }\n+\n+  @Override\n+  protected String peerHostIP(Object serverTransaction) {\n+    return ((InetSocketAddress)\n+            invokeNoArgsSuperSuperClassMethod(serverTransaction, \"getLocalAddr\"))\n+        .getHostString();\n+  }\n+\n+  @Override\n+  protected int peerPort(Object serverTransaction) {\n+    return ((InetSocketAddress)\n+            invokeNoArgsSuperSuperClassMethod(serverTransaction, \"getLocalAddr\"))\n+        .getPort();\n+  }\n+\n+  @Override\n+  protected int status(final Object serverTransaction) {\n+    // done manually\n+    return 0;\n+  }\n+\n+  public static Object invokeNoArgDeclaredMethod(Object obj, String methodName) {\n+    try {\n+      Method m = obj.getClass().getDeclaredMethod(methodName);\n+      m.setAccessible(true);\n+      Object v = m.invoke(obj);\n+      log.debug(\"{}(): {}\", methodName, v);\n+      return v;\n+    } catch (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) {\n+      log.debug(\"Can't find method '\" + methodName + \"' in object \" + obj, e);\n+    }\n+    return \"\";\n+  }\n+\n+  public static Object invokeNoArgsSuperSuperClassMethod(Object obj, String methodName) {\n+    try {\n+      Method m = obj.getClass().getSuperclass().getSuperclass().getMethod(methodName);", "originalCommit": "38968b0cf420914302634985addba97663e524a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM5MDE2OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570390168", "bodyText": "Instance method:\npublic class Transaction implements IMetricsTransaction {\n  public native InetSocketAddress getLocalAddr();\n  public native InetSocketAddress getRemoteAddr();\n}\npublic abstract class HTTPTransaction extends Transaction {}\npublic class ServerTransaction extends HTTPTransaction {}\n\nI have instance of ServerTransaction and need to call getRemoteAddr from Transaction.", "author": "lpriima", "createdAt": "2021-02-04T17:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2Mjk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM5NDczMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570394730", "bodyText": "OK, you don't need to access the superclass in that case - obj.getClass().getMethod(methodName) will work just as well because getMethod will consider all superclasses and superinterfaces when looking for the public method:\nhttps://docs.oracle.com/javase/8/docs/api/java/lang/Class.html#getMethod-java.lang.String-java.lang.Class...-\n(this is different to getDeclaredMethod which only considers methods declared by the given class.)", "author": "mcculls", "createdAt": "2021-02-04T17:08:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2Mjk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDUxMjc1NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570512755", "bodyText": "Yes.\nAnyway, I've changed it to method handles:)", "author": "lpriima", "createdAt": "2021-02-04T20:10:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2Mjk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2MTY0MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570361641", "bodyText": "This doesn't seem to be reading incoming headers to propagate the trace?  Is this an acceptable tradeoff?", "author": "tylerbenson", "createdAt": "2021-02-04T16:25:33Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/HTTPPluginAdvice.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.AXWAY_REQUEST;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.DECORATE;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import net.bytebuddy.asm.Advice;\n+\n+public class HTTPPluginAdvice {\n+\n+  @Advice.OnMethodEnter(suppress = Throwable.class)\n+  public static AgentScope onEnter(\n+      @Advice.This final Object stateInstance,\n+      @Advice.Argument(value = 2) final Object serverTransaction) {\n+    final AgentSpan span = startSpan(AXWAY_REQUEST);", "originalCommit": "38968b0cf420914302634985addba97663e524a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDUxNDE3MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570514170", "bodyText": "yes for now. I might need to change it in next PR", "author": "lpriima", "createdAt": "2021-02-04T20:13:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2MTY0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2MzI5Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570363293", "bodyText": "constant?", "author": "tylerbenson", "createdAt": "2021-02-04T16:27:36Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/StateAdvice.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.DECORATE;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.HOST;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.PORT;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n+import java.lang.reflect.Field;\n+import net.bytebuddy.asm.Advice;\n+import org.slf4j.Logger;\n+\n+public class StateAdvice {\n+  public static final Logger log = org.slf4j.LoggerFactory.getLogger(StateAdvice.class);\n+\n+  @Advice.OnMethodEnter(suppress = Throwable.class)\n+  public static AgentScope onEnter(@Advice.This final Object stateInstance) {\n+    final AgentSpan span = startSpan(\"axway.trytransaction\");", "originalCommit": "38968b0cf420914302634985addba97663e524a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2NTExNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570365114", "bodyText": "Advice classes shouldn't have fields, nor should they be logging like this.", "author": "tylerbenson", "createdAt": "2021-02-04T16:29:52Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/StateAdvice.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.DECORATE;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.HOST;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.PORT;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n+import java.lang.reflect.Field;\n+import net.bytebuddy.asm.Advice;\n+import org.slf4j.Logger;\n+\n+public class StateAdvice {\n+  public static final Logger log = org.slf4j.LoggerFactory.getLogger(StateAdvice.class);", "originalCommit": "38968b0cf420914302634985addba97663e524a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2NjY4OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570366689", "bodyText": "Please add a comment (for someone that is unfamiliar with axway) indicating what this advice is for and why it's useful to the user.  The HTTPPluginAdvice seems fairly straightforward, but I don't understand how this relates to it.", "author": "tylerbenson", "createdAt": "2021-02-04T16:32:01Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/StateAdvice.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.DECORATE;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.HOST;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.PORT;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n+import java.lang.reflect.Field;\n+import net.bytebuddy.asm.Advice;\n+import org.slf4j.Logger;\n+\n+public class StateAdvice {", "originalCommit": "38968b0cf420914302634985addba97663e524a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDUyNzMyMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570527322", "bodyText": "Added above^, please reveiw", "author": "lpriima", "createdAt": "2021-02-04T20:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2NjY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM5Njk0MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r594396941", "bodyText": "Yes, I think adding the comment was a good idea.  Although, I honestly think it applies to all instrumentation not just axway.", "author": "dougqh", "createdAt": "2021-03-15T14:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM2NjY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM3MTY3MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570371671", "bodyText": "where is the status set? - the manual line in the advice appears commented out", "author": "mcculls", "createdAt": "2021-02-04T16:38:20Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,88 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import org.slf4j.Logger;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final String METHOD = \"method\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final Logger log =\n+      org.slf4j.LoggerFactory.getLogger(AxwayHTTPPluginDecorator.class);\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-api\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-api\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    return invokeNoArgDeclaredMethod(serverTransaction, \"getMethod\").toString();\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    return new DefaultURIDataAdapter((URI) invokeNoArgDeclaredMethod(serverTransaction, \"getURI\"));\n+  }\n+\n+  @Override\n+  protected String peerHostIP(Object serverTransaction) {\n+    return ((InetSocketAddress)\n+            invokeNoArgsSuperSuperClassMethod(serverTransaction, \"getLocalAddr\"))\n+        .getHostString();\n+  }\n+\n+  @Override\n+  protected int peerPort(Object serverTransaction) {\n+    return ((InetSocketAddress)\n+            invokeNoArgsSuperSuperClassMethod(serverTransaction, \"getLocalAddr\"))\n+        .getPort();\n+  }\n+\n+  @Override\n+  protected int status(final Object serverTransaction) {\n+    // done manually", "originalCommit": "38968b0cf420914302634985addba97663e524a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQ0OTE4MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570449181", "bodyText": "This will be done in next PR.\ngetting local variable by name doesn't work for axway by some reason reason", "author": "lpriima", "createdAt": "2021-02-04T18:26:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM3MTY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM3MjY0NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570372644", "bodyText": "if you put @Slf4j on the class then lombok will add this for you", "author": "mcculls", "createdAt": "2021-02-04T16:39:39Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,88 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import org.slf4j.Logger;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final String METHOD = \"method\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final Logger log =\n+      org.slf4j.LoggerFactory.getLogger(AxwayHTTPPluginDecorator.class);", "originalCommit": "38968b0cf420914302634985addba97663e524a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQ1NTI1NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570455254", "bodyText": "I used it, because I was logging from Advice class, but i will change it", "author": "lpriima", "createdAt": "2021-02-04T18:35:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM3MjY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM3NDI1Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570374252", "bodyText": "this parameter appears unused and could be removed", "author": "mcculls", "createdAt": "2021-02-04T16:41:47Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/HTTPPluginAdvice.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.AXWAY_REQUEST;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.DECORATE;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import net.bytebuddy.asm.Advice;\n+\n+public class HTTPPluginAdvice {\n+\n+  @Advice.OnMethodEnter(suppress = Throwable.class)\n+  public static AgentScope onEnter(\n+      @Advice.This final Object stateInstance,", "originalCommit": "38968b0cf420914302634985addba97663e524a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg1MjE3Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570852176", "bodyText": "minor typo, should be AXWAY_TRY_TRANSACTION", "author": "mcculls", "createdAt": "2021-02-05T09:58:53Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRAMSACTION =", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg1NDUxNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570854516", "bodyText": "make private since it's only used by this class", "author": "mcculls", "createdAt": "2021-02-05T10:02:42Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRAMSACTION =\n+      UTF8BytesString.createConstant(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+  private static MethodHandle getRemoteAddr_mh;\n+  private static MethodHandle getMethod_mh;\n+  private static MethodHandle getURI_mh;\n+\n+  static {\n+    try {\n+      Class<?> classServerTransaction = Class.forName(\"com.vordel.dwe.http.ServerTransaction\");\n+      getRemoteAddr_mh =\n+          lookup.findVirtual(\n+              classServerTransaction, \"getRemoteAddr\", methodType(InetSocketAddress.class));\n+      getMethod_mh =\n+          lookup.findVirtual(classServerTransaction, \"getMethod\", methodType(String.class));\n+\n+      Method m = classServerTransaction.getDeclaredMethod(\"getURI\"); // private method\n+      m.setAccessible(true);\n+      getURI_mh = lookup.unreflect(m);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find 'com.vordel.dwe.http.ServerTransaction::getRemoteAddr' method: \", e);\n+    }\n+  }\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-api\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-api\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    try {\n+      return getMethod_mh.invoke(serverTransaction).toString();\n+    } catch (Throwable throwable) {\n+      log.debug(\"Can't invoke com.vordel.dwe.http.ServerTransaction::getMethod(): \", throwable);\n+    }\n+    return \"UNKNOWN\";\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    return new DefaultURIDataAdapter(getUri(serverTransaction));\n+  }\n+\n+  @Override\n+  protected String peerHostIP(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getHostString();\n+  }\n+\n+  @Override\n+  protected int peerPort(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getPort();\n+  }\n+\n+  @Override\n+  protected int status(final Object serverTransaction) {\n+    // TODO will be done manually\n+    return 0;\n+  }\n+\n+  public static URI getUri(Object obj) {", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg1NDk2Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570854967", "bodyText": "make private since it's only used by this class", "author": "mcculls", "createdAt": "2021-02-05T10:03:33Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRAMSACTION =\n+      UTF8BytesString.createConstant(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+  private static MethodHandle getRemoteAddr_mh;\n+  private static MethodHandle getMethod_mh;\n+  private static MethodHandle getURI_mh;\n+\n+  static {\n+    try {\n+      Class<?> classServerTransaction = Class.forName(\"com.vordel.dwe.http.ServerTransaction\");\n+      getRemoteAddr_mh =\n+          lookup.findVirtual(\n+              classServerTransaction, \"getRemoteAddr\", methodType(InetSocketAddress.class));\n+      getMethod_mh =\n+          lookup.findVirtual(classServerTransaction, \"getMethod\", methodType(String.class));\n+\n+      Method m = classServerTransaction.getDeclaredMethod(\"getURI\"); // private method\n+      m.setAccessible(true);\n+      getURI_mh = lookup.unreflect(m);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find 'com.vordel.dwe.http.ServerTransaction::getRemoteAddr' method: \", e);\n+    }\n+  }\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-api\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-api\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    try {\n+      return getMethod_mh.invoke(serverTransaction).toString();\n+    } catch (Throwable throwable) {\n+      log.debug(\"Can't invoke com.vordel.dwe.http.ServerTransaction::getMethod(): \", throwable);\n+    }\n+    return \"UNKNOWN\";\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    return new DefaultURIDataAdapter(getUri(serverTransaction));\n+  }\n+\n+  @Override\n+  protected String peerHostIP(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getHostString();\n+  }\n+\n+  @Override\n+  protected int peerPort(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getPort();\n+  }\n+\n+  @Override\n+  protected int status(final Object serverTransaction) {\n+    // TODO will be done manually\n+    return 0;\n+  }\n+\n+  public static URI getUri(Object obj) {\n+    try {\n+      return (URI) getURI_mh.invoke(obj);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find invoke 'getUri' in object \" + obj, e);\n+    }\n+    return URI.create(\"\");\n+  }\n+\n+  private static InetSocketAddress getRemoteAddr(Object obj) {\n+    try {\n+      return (InetSocketAddress) getRemoteAddr_mh.invoke(obj);\n+    } catch (Throwable throwable) {\n+      log.debug(\"Can't com.vordel.dwe.http.ServerTransaction::getRemoteAddr() : \", throwable);\n+    }\n+    return new InetSocketAddress(0);\n+  }\n+\n+  public static void setTagFromField(AgentSpan span, String tag, Object obj, String field) {\n+    span.setTag(tag, getFieldValue(obj, field).toString());\n+  }\n+\n+  public static Object getFieldValue(Object obj, String fieldName) {", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg1NTgwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570855809", "bodyText": "Missing invoke in log text?", "author": "mcculls", "createdAt": "2021-02-05T10:04:58Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRAMSACTION =\n+      UTF8BytesString.createConstant(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+  private static MethodHandle getRemoteAddr_mh;\n+  private static MethodHandle getMethod_mh;\n+  private static MethodHandle getURI_mh;\n+\n+  static {\n+    try {\n+      Class<?> classServerTransaction = Class.forName(\"com.vordel.dwe.http.ServerTransaction\");\n+      getRemoteAddr_mh =\n+          lookup.findVirtual(\n+              classServerTransaction, \"getRemoteAddr\", methodType(InetSocketAddress.class));\n+      getMethod_mh =\n+          lookup.findVirtual(classServerTransaction, \"getMethod\", methodType(String.class));\n+\n+      Method m = classServerTransaction.getDeclaredMethod(\"getURI\"); // private method\n+      m.setAccessible(true);\n+      getURI_mh = lookup.unreflect(m);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find 'com.vordel.dwe.http.ServerTransaction::getRemoteAddr' method: \", e);\n+    }\n+  }\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-api\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-api\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    try {\n+      return getMethod_mh.invoke(serverTransaction).toString();\n+    } catch (Throwable throwable) {\n+      log.debug(\"Can't invoke com.vordel.dwe.http.ServerTransaction::getMethod(): \", throwable);\n+    }\n+    return \"UNKNOWN\";\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    return new DefaultURIDataAdapter(getUri(serverTransaction));\n+  }\n+\n+  @Override\n+  protected String peerHostIP(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getHostString();\n+  }\n+\n+  @Override\n+  protected int peerPort(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getPort();\n+  }\n+\n+  @Override\n+  protected int status(final Object serverTransaction) {\n+    // TODO will be done manually\n+    return 0;\n+  }\n+\n+  public static URI getUri(Object obj) {\n+    try {\n+      return (URI) getURI_mh.invoke(obj);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find invoke 'getUri' in object \" + obj, e);\n+    }\n+    return URI.create(\"\");\n+  }\n+\n+  private static InetSocketAddress getRemoteAddr(Object obj) {\n+    try {\n+      return (InetSocketAddress) getRemoteAddr_mh.invoke(obj);\n+    } catch (Throwable throwable) {\n+      log.debug(\"Can't com.vordel.dwe.http.ServerTransaction::getRemoteAddr() : \", throwable);", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg1NzE4Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570857182", "bodyText": "log.debug(\"Can't invoke 'getUri' in object {}\", obj, e);  would be better", "author": "mcculls", "createdAt": "2021-02-05T10:07:11Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRAMSACTION =\n+      UTF8BytesString.createConstant(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+  private static MethodHandle getRemoteAddr_mh;\n+  private static MethodHandle getMethod_mh;\n+  private static MethodHandle getURI_mh;\n+\n+  static {\n+    try {\n+      Class<?> classServerTransaction = Class.forName(\"com.vordel.dwe.http.ServerTransaction\");\n+      getRemoteAddr_mh =\n+          lookup.findVirtual(\n+              classServerTransaction, \"getRemoteAddr\", methodType(InetSocketAddress.class));\n+      getMethod_mh =\n+          lookup.findVirtual(classServerTransaction, \"getMethod\", methodType(String.class));\n+\n+      Method m = classServerTransaction.getDeclaredMethod(\"getURI\"); // private method\n+      m.setAccessible(true);\n+      getURI_mh = lookup.unreflect(m);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find 'com.vordel.dwe.http.ServerTransaction::getRemoteAddr' method: \", e);\n+    }\n+  }\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-api\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-api\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    try {\n+      return getMethod_mh.invoke(serverTransaction).toString();\n+    } catch (Throwable throwable) {\n+      log.debug(\"Can't invoke com.vordel.dwe.http.ServerTransaction::getMethod(): \", throwable);\n+    }\n+    return \"UNKNOWN\";\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    return new DefaultURIDataAdapter(getUri(serverTransaction));\n+  }\n+\n+  @Override\n+  protected String peerHostIP(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getHostString();\n+  }\n+\n+  @Override\n+  protected int peerPort(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getPort();\n+  }\n+\n+  @Override\n+  protected int status(final Object serverTransaction) {\n+    // TODO will be done manually\n+    return 0;\n+  }\n+\n+  public static URI getUri(Object obj) {\n+    try {\n+      return (URI) getURI_mh.invoke(obj);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find invoke 'getUri' in object \" + obj, e);", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTA3MTc5NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r571071795", "bodyText": "I thought that will call debug(String format, Object... arguments); instead of `debug(String msg, Throwable t);, but you are right:  it still prints stack trace.", "author": "lpriima", "createdAt": "2021-02-05T15:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg1NzE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg2MDQ5Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570860496", "bodyText": "Looking up the field handle on every call will be expensive, because it involves various checks - could these field handles be cached? If we know which classes are involved then we could always do this in the static initializer like we're doing with the method handles.", "author": "mcculls", "createdAt": "2021-02-05T10:12:41Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRAMSACTION =\n+      UTF8BytesString.createConstant(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+  private static MethodHandle getRemoteAddr_mh;\n+  private static MethodHandle getMethod_mh;\n+  private static MethodHandle getURI_mh;\n+\n+  static {\n+    try {\n+      Class<?> classServerTransaction = Class.forName(\"com.vordel.dwe.http.ServerTransaction\");\n+      getRemoteAddr_mh =\n+          lookup.findVirtual(\n+              classServerTransaction, \"getRemoteAddr\", methodType(InetSocketAddress.class));\n+      getMethod_mh =\n+          lookup.findVirtual(classServerTransaction, \"getMethod\", methodType(String.class));\n+\n+      Method m = classServerTransaction.getDeclaredMethod(\"getURI\"); // private method\n+      m.setAccessible(true);\n+      getURI_mh = lookup.unreflect(m);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find 'com.vordel.dwe.http.ServerTransaction::getRemoteAddr' method: \", e);\n+    }\n+  }\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-api\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-api\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    try {\n+      return getMethod_mh.invoke(serverTransaction).toString();\n+    } catch (Throwable throwable) {\n+      log.debug(\"Can't invoke com.vordel.dwe.http.ServerTransaction::getMethod(): \", throwable);\n+    }\n+    return \"UNKNOWN\";\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    return new DefaultURIDataAdapter(getUri(serverTransaction));\n+  }\n+\n+  @Override\n+  protected String peerHostIP(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getHostString();\n+  }\n+\n+  @Override\n+  protected int peerPort(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getPort();\n+  }\n+\n+  @Override\n+  protected int status(final Object serverTransaction) {\n+    // TODO will be done manually\n+    return 0;\n+  }\n+\n+  public static URI getUri(Object obj) {\n+    try {\n+      return (URI) getURI_mh.invoke(obj);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find invoke 'getUri' in object \" + obj, e);\n+    }\n+    return URI.create(\"\");\n+  }\n+\n+  private static InetSocketAddress getRemoteAddr(Object obj) {\n+    try {\n+      return (InetSocketAddress) getRemoteAddr_mh.invoke(obj);\n+    } catch (Throwable throwable) {\n+      log.debug(\"Can't com.vordel.dwe.http.ServerTransaction::getRemoteAddr() : \", throwable);\n+    }\n+    return new InetSocketAddress(0);\n+  }\n+\n+  public static void setTagFromField(AgentSpan span, String tag, Object obj, String field) {\n+    span.setTag(tag, getFieldValue(obj, field).toString());\n+  }\n+\n+  public static Object getFieldValue(Object obj, String fieldName) {\n+    try {\n+      Field field = obj.getClass().getDeclaredField(fieldName);", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDk4NTY0Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570985646", "bodyText": "Yes, caching the field would be preferable.  That will also help performance wise, since a Field object that is used repeatedly will have a de-reflection class generated to make the reflection fast.", "author": "dougqh", "createdAt": "2021-02-05T13:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg2MDQ5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg2MjQ3Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570862476", "bodyText": "log.debug(\"Can't find field '{}': \", fieldName, e);\n... maybe also mention the class we were looking in?", "author": "mcculls", "createdAt": "2021-02-05T10:16:05Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRAMSACTION =\n+      UTF8BytesString.createConstant(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+  private static MethodHandle getRemoteAddr_mh;\n+  private static MethodHandle getMethod_mh;\n+  private static MethodHandle getURI_mh;\n+\n+  static {\n+    try {\n+      Class<?> classServerTransaction = Class.forName(\"com.vordel.dwe.http.ServerTransaction\");\n+      getRemoteAddr_mh =\n+          lookup.findVirtual(\n+              classServerTransaction, \"getRemoteAddr\", methodType(InetSocketAddress.class));\n+      getMethod_mh =\n+          lookup.findVirtual(classServerTransaction, \"getMethod\", methodType(String.class));\n+\n+      Method m = classServerTransaction.getDeclaredMethod(\"getURI\"); // private method\n+      m.setAccessible(true);\n+      getURI_mh = lookup.unreflect(m);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find 'com.vordel.dwe.http.ServerTransaction::getRemoteAddr' method: \", e);\n+    }\n+  }\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-api\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-api\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    try {\n+      return getMethod_mh.invoke(serverTransaction).toString();\n+    } catch (Throwable throwable) {\n+      log.debug(\"Can't invoke com.vordel.dwe.http.ServerTransaction::getMethod(): \", throwable);\n+    }\n+    return \"UNKNOWN\";\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    return new DefaultURIDataAdapter(getUri(serverTransaction));\n+  }\n+\n+  @Override\n+  protected String peerHostIP(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getHostString();\n+  }\n+\n+  @Override\n+  protected int peerPort(Object serverTransaction) {\n+    return getRemoteAddr(serverTransaction).getPort();\n+  }\n+\n+  @Override\n+  protected int status(final Object serverTransaction) {\n+    // TODO will be done manually\n+    return 0;\n+  }\n+\n+  public static URI getUri(Object obj) {\n+    try {\n+      return (URI) getURI_mh.invoke(obj);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find invoke 'getUri' in object \" + obj, e);\n+    }\n+    return URI.create(\"\");\n+  }\n+\n+  private static InetSocketAddress getRemoteAddr(Object obj) {\n+    try {\n+      return (InetSocketAddress) getRemoteAddr_mh.invoke(obj);\n+    } catch (Throwable throwable) {\n+      log.debug(\"Can't com.vordel.dwe.http.ServerTransaction::getRemoteAddr() : \", throwable);\n+    }\n+    return new InetSocketAddress(0);\n+  }\n+\n+  public static void setTagFromField(AgentSpan span, String tag, Object obj, String field) {\n+    span.setTag(tag, getFieldValue(obj, field).toString());\n+  }\n+\n+  public static Object getFieldValue(Object obj, String fieldName) {\n+    try {\n+      Field field = obj.getClass().getDeclaredField(fieldName);\n+      field.setAccessible(true);\n+      Object v = field.get(obj);\n+      log.debug(\"field '{}': {}\", fieldName, v);\n+      return v;\n+    } catch (NoSuchFieldException | IllegalAccessException e) {\n+      log.debug(\"Can't find field '\" + fieldName + \"': \", e);", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg2NDc5OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570864798", "bodyText": "These 4 methods could be moved into a DECORATE.onTransaction method in the decorator - then you could keep the setTagFromField method private.", "author": "mcculls", "createdAt": "2021-02-05T10:19:48Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/StateAdvice.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.AXWAY_TRY_TRAMSACTION;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.DECORATE;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.HOST;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.PORT;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.setTagFromField;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n+import net.bytebuddy.asm.Advice;\n+\n+/**\n+ * Axway apigateway server gathers responses from 1 or more services, aggregates them and sends\n+ * response(s) to client(s). Apigateway is just reverse proxy. com.vordel.circuit.net.State class\n+ * represents connection(s) and \"state\" of communication to one or more of the services from which\n+ * axway apigateway needs to get reply to prepare aggregates response to customer. This\n+ * instrumentation intends to see to which services apigateway goes to prepare it response.\n+ */\n+public class StateAdvice {\n+  @Advice.OnMethodEnter(suppress = Throwable.class)\n+  public static AgentScope onEnter(@Advice.This final Object stateInstance) {\n+    final AgentSpan span = startSpan(AXWAY_TRY_TRAMSACTION);\n+    final AgentScope scope = activateSpan(span);\n+    span.setMeasured(true);\n+    // manually DECORATE.onRequest(span, stateInstance) :\n+    setTagFromField(span, Tags.HTTP_METHOD, stateInstance, \"verb\");\n+    setTagFromField(span, Tags.HTTP_URL, stateInstance, \"uri\");\n+    setTagFromField(span, Tags.PEER_HOSTNAME, stateInstance, HOST);\n+    setTagFromField(span, Tags.PEER_PORT, stateInstance, PORT);", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDk4NjU2Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570986567", "bodyText": "It would be to make these all final -- then the JIT will be able to constant propagate the MH and might have easier time inlining through it as well.", "author": "dougqh", "createdAt": "2021-02-05T14:00:38Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRAMSACTION =\n+      UTF8BytesString.createConstant(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+  private static MethodHandle getRemoteAddr_mh;", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDk5MDMxNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570990315", "bodyText": "I believe the preferred way to do this with a MethodHandle is...\nreturn (String)methodHandle.invoke(serverTransaction);\nThe MethodHandle.invoke and invokeExact are magic signature polymorphic methods, so they adapt to accept the type of their arguments and return the type specified by the cast of the return type.\nhttps://docs.oracle.com/javase/8/docs/api/java/lang/invoke/MethodHandle.html#invokeExact-java.lang.Object...-\nIn this case, since we cannot statically reference the arg type, you probably do need invoke rather than invokeExact, but I believe it is still safe to cast the return.", "author": "dougqh", "createdAt": "2021-02-05T14:06:45Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final String HOST = \"host\";\n+  public static final String PORT = \"port\";\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.createConstant(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRAMSACTION =\n+      UTF8BytesString.createConstant(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+  private static MethodHandle getRemoteAddr_mh;\n+  private static MethodHandle getMethod_mh;\n+  private static MethodHandle getURI_mh;\n+\n+  static {\n+    try {\n+      Class<?> classServerTransaction = Class.forName(\"com.vordel.dwe.http.ServerTransaction\");\n+      getRemoteAddr_mh =\n+          lookup.findVirtual(\n+              classServerTransaction, \"getRemoteAddr\", methodType(InetSocketAddress.class));\n+      getMethod_mh =\n+          lookup.findVirtual(classServerTransaction, \"getMethod\", methodType(String.class));\n+\n+      Method m = classServerTransaction.getDeclaredMethod(\"getURI\"); // private method\n+      m.setAccessible(true);\n+      getURI_mh = lookup.unreflect(m);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find 'com.vordel.dwe.http.ServerTransaction::getRemoteAddr' method: \", e);\n+    }\n+  }\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-api\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-api\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    try {\n+      return getMethod_mh.invoke(serverTransaction).toString();", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTExNjAyMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r571116021", "bodyText": "Yes, I think there is no way to use invokeExact without having an exact type at compile time or is it still possible ?\nthis doesn't work(also return compile time generic which I can't narrow to required type at compile time):\n(String) getMethod_mh.invokeExact(Class.forName(\"com.vordel.dwe.http.ServerTransaction\")\n    .cast(serverTransaction));", "author": "lpriima", "createdAt": "2021-02-05T17:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDk5MDMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDk5MTI3Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r570991276", "bodyText": "If / when, we responseCode working we should make sure to use the Http code boxing cache.", "author": "dougqh", "createdAt": "2021-02-05T14:08:18Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/HTTPPluginAdvice.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.AXWAY_REQUEST;\n+import static datadog.trace.instrumentation.axway.AxwayHTTPPluginDecorator.DECORATE;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import net.bytebuddy.asm.Advice;\n+\n+public class HTTPPluginAdvice {\n+\n+  @Advice.OnMethodEnter(suppress = Throwable.class)\n+  public static AgentScope onEnter(@Advice.Argument(value = 2) final Object serverTransaction) {\n+    final AgentSpan span = startSpan(AXWAY_REQUEST);\n+    final AgentScope scope = activateSpan(span);\n+    span.setMeasured(true);\n+    DECORATE.afterStart(span);\n+    DECORATE.onConnection(span, serverTransaction);\n+    DECORATE.onRequest(span, serverTransaction);\n+    return scope;\n+  }\n+\n+  @Advice.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)\n+  public static void onExit(\n+      @Advice.Enter final AgentScope scope,\n+      // TODO getting local variable by name doens't work for axway\n+      // @Advice.Local(\"responseCode\") Integer responseCode,\n+      @Advice.Thrown final Throwable throwable) {\n+    if (scope == null) {\n+      return;\n+    }\n+    final AgentSpan span = scope.span();\n+    try {\n+      // manual DECORATE.onResponse(span, serverTransaction):\n+      // span.setTag(Tags.HTTP_STATUS, responseCode); //TODO", "originalCommit": "6f76e569463724da273b663b635ebebde0d3a3de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "291cef9b6d25170714cb33b8606d13283af300c0", "url": "https://github.com/DataDog/dd-trace-java/commit/291cef9b6d25170714cb33b8606d13283af300c0", "message": "axway doc typos", "committedDate": "2021-02-26T20:41:46Z", "type": "forcePushed"}, {"oid": "994c629b375cf0745a13100a1722a2d237af3900", "url": "https://github.com/DataDog/dd-trace-java/commit/994c629b375cf0745a13100a1722a2d237af3900", "message": "Axway http status code possible solution scheme", "committedDate": "2021-03-10T09:50:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM5MzE0MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r594393140", "bodyText": "This form of forName will initialize the class.  It is safer to use the other forName(name, initialized, ClassLoader) instead with initialized=false.", "author": "dougqh", "createdAt": "2021-03-15T14:38:46Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,236 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.create(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRANSACTION =\n+      UTF8BytesString.create(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+\n+  private static final String SERVERTRANSACTION_CLASSNAME = \"com.vordel.dwe.http.ServerTransaction\";\n+  private static final Class<?> classServerTransaction;\n+  private static final MethodHandle getRemoteAddr_mh;\n+  private static final MethodHandle getMethod_mh;\n+  private static final MethodHandle getURI_mh;\n+\n+  private static final String STATE_CLASSNAME = \"com.vordel.circuit.net.State\";\n+  private static final Class<?> classState;\n+  private static final MethodHandle hostField_mh;\n+  private static final MethodHandle portField_mh;\n+  private static final MethodHandle methodField_mh;\n+  private static final MethodHandle uriField_mh;\n+\n+  static final String SERVER_TRANSACTION_CLASSNAME = \"com.vordel.dwe.http.ServerTransaction\";\n+  static final Class<Object> SERVER_TRANSACTION_CLASS = getServerTransactionClass();\n+\n+  private static Class<Object> getServerTransactionClass() {\n+    try {\n+      return (Class<Object>) Class.forName(SERVER_TRANSACTION_CLASSNAME);\n+    } catch (ClassNotFoundException e) {\n+      log.debug(\"Can't get ServerTransaction class name\", e);\n+    }\n+    return null;\n+  }\n+\n+  static {\n+    classServerTransaction = initClass(SERVERTRANSACTION_CLASSNAME);\n+    getRemoteAddr_mh =\n+        initNoArgServerTransactionMethodHandle(\"getRemoteAddr\", InetSocketAddress.class);\n+    getMethod_mh = initNoArgServerTransactionMethodHandle(\"getMethod\", String.class);\n+    getURI_mh = initGetURI();\n+\n+    classState = initClass(STATE_CLASSNAME);\n+    hostField_mh = initStateFieldGetter(\"host\");\n+    portField_mh = initStateFieldGetter(\"port\");\n+    methodField_mh = initStateFieldGetter(\"verb\");\n+    uriField_mh = initStateFieldGetter(\"uri\");\n+  }\n+\n+  private static Class<?> initClass(final String name) {\n+    try {\n+      return Class.forName(name);", "originalCommit": "994c629b375cf0745a13100a1722a2d237af3900", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY1MjcxNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r594652715", "bodyText": "Thx. Updated", "author": "lpriima", "createdAt": "2021-03-15T20:15:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM5MzE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM5NTA2Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r594395067", "bodyText": "Can we not just return null?  Or does, the caller not support that?", "author": "dougqh", "createdAt": "2021-03-15T14:40:55Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,236 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.create(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRANSACTION =\n+      UTF8BytesString.create(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+\n+  private static final String SERVERTRANSACTION_CLASSNAME = \"com.vordel.dwe.http.ServerTransaction\";\n+  private static final Class<?> classServerTransaction;\n+  private static final MethodHandle getRemoteAddr_mh;\n+  private static final MethodHandle getMethod_mh;\n+  private static final MethodHandle getURI_mh;\n+\n+  private static final String STATE_CLASSNAME = \"com.vordel.circuit.net.State\";\n+  private static final Class<?> classState;\n+  private static final MethodHandle hostField_mh;\n+  private static final MethodHandle portField_mh;\n+  private static final MethodHandle methodField_mh;\n+  private static final MethodHandle uriField_mh;\n+\n+  static final String SERVER_TRANSACTION_CLASSNAME = \"com.vordel.dwe.http.ServerTransaction\";\n+  static final Class<Object> SERVER_TRANSACTION_CLASS = getServerTransactionClass();\n+\n+  private static Class<Object> getServerTransactionClass() {\n+    try {\n+      return (Class<Object>) Class.forName(SERVER_TRANSACTION_CLASSNAME);\n+    } catch (ClassNotFoundException e) {\n+      log.debug(\"Can't get ServerTransaction class name\", e);\n+    }\n+    return null;\n+  }\n+\n+  static {\n+    classServerTransaction = initClass(SERVERTRANSACTION_CLASSNAME);\n+    getRemoteAddr_mh =\n+        initNoArgServerTransactionMethodHandle(\"getRemoteAddr\", InetSocketAddress.class);\n+    getMethod_mh = initNoArgServerTransactionMethodHandle(\"getMethod\", String.class);\n+    getURI_mh = initGetURI();\n+\n+    classState = initClass(STATE_CLASSNAME);\n+    hostField_mh = initStateFieldGetter(\"host\");\n+    portField_mh = initStateFieldGetter(\"port\");\n+    methodField_mh = initStateFieldGetter(\"verb\");\n+    uriField_mh = initStateFieldGetter(\"uri\");\n+  }\n+\n+  private static Class<?> initClass(final String name) {\n+    try {\n+      return Class.forName(name);\n+    } catch (ClassNotFoundException e) {\n+      log.debug(\n+          \"Can't find class '{}': Axaway integration failed. \", SERVERTRANSACTION_CLASSNAME, e);\n+    }\n+    return null;\n+  }\n+\n+  private static MethodHandle initNoArgServerTransactionMethodHandle(String name, Class<?> rtype) {\n+    try {\n+      return lookup.findVirtual(classServerTransaction, name, methodType(rtype));\n+    } catch (NoSuchMethodException | IllegalAccessException e) {\n+      log.debug(\"Can't find method handler '{}' \", name, e);\n+    }\n+    return null;\n+  }\n+\n+  private static MethodHandle initGetURI() {\n+    Method m = null;\n+    try {\n+      m = classServerTransaction.getDeclaredMethod(\"getURI\"); // private method\n+      m.setAccessible(true);\n+      return lookup.unreflect(m);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't unreflect method '{}': \", m, e);\n+    }\n+    return null;\n+  }\n+\n+  private static MethodHandle initStateFieldGetter(String fieldName) {\n+    Field field = null;\n+    MethodHandle mh = null;\n+    try {\n+      field = classState.getDeclaredField(fieldName);\n+      field.setAccessible(true);\n+      mh = lookup.unreflectGetter(field);\n+      log.debug(\n+          \"Initialized field '{}' of class '{}' unreflected to {}\", fieldName, classState, mh);\n+    } catch (NoSuchFieldException | IllegalAccessException e) {\n+      log.debug(\n+          \"Can't find and unreflect declared field '{}' with name '{}' for class '{}' to mh: '{}'\",\n+          field,\n+          fieldName,\n+          classState,\n+          mh,\n+          e);\n+    }\n+    return mh;\n+  }\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-http\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-http\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    try {\n+      return (String) getMethod_mh.invoke(serverTransaction);\n+    } catch (Throwable throwable) {\n+      log.debug(\n+          \"Can't invoke invoke '{}' on instance '{}' of class '{}'\",\n+          getMethod_mh,\n+          serverTransaction,\n+          serverTransaction.getClass(),\n+          throwable);\n+    }\n+    return \"UNKNOWN\";\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    try {\n+      return new DefaultURIDataAdapter((URI) getURI_mh.invoke(serverTransaction));\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find invoke '{}}' on '{}': \", getURI_mh, serverTransaction, e);\n+    }\n+    return new DefaultURIDataAdapter(URI.create(\"\"));", "originalCommit": "994c629b375cf0745a13100a1722a2d237af3900", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDYzNjIxNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r594636217", "bodyText": "yes: https://github.com/DataDog/dd-trace-java/blob/master/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/HttpServerDecorator.java#L64", "author": "lpriima", "createdAt": "2021-03-15T19:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM5NTA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM5NTQ4Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r594395486", "bodyText": "If this happens, should we stop trying to the URL extraction?", "author": "dougqh", "createdAt": "2021-03-15T14:41:24Z", "path": "dd-java-agent/instrumentation/axway-api/src/main/java/datadog/trace/instrumentation/axway/AxwayHTTPPluginDecorator.java", "diffHunk": "@@ -0,0 +1,236 @@\n+package datadog.trace.instrumentation.axway;\n+\n+import static java.lang.invoke.MethodType.methodType;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.DefaultURIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n+import datadog.trace.bootstrap.instrumentation.api.URIDataAdapter;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+import java.net.URI;\n+import lombok.extern.slf4j.Slf4j;\n+\n+// request = is com.vordel.circuit.net.State,  connection = com.vordel.dwe.http.ServerTransaction\n+@Slf4j\n+public class AxwayHTTPPluginDecorator extends HttpServerDecorator<Object, Object, Object> {\n+  public static final CharSequence AXWAY_REQUEST = UTF8BytesString.create(\"axway.request\");\n+  public static final CharSequence AXWAY_TRY_TRANSACTION =\n+      UTF8BytesString.create(\"axway.trytransaction\");\n+\n+  public static final AxwayHTTPPluginDecorator DECORATE = new AxwayHTTPPluginDecorator();\n+\n+  private static final MethodHandles.Lookup lookup = MethodHandles.lookup();\n+\n+  private static final String SERVERTRANSACTION_CLASSNAME = \"com.vordel.dwe.http.ServerTransaction\";\n+  private static final Class<?> classServerTransaction;\n+  private static final MethodHandle getRemoteAddr_mh;\n+  private static final MethodHandle getMethod_mh;\n+  private static final MethodHandle getURI_mh;\n+\n+  private static final String STATE_CLASSNAME = \"com.vordel.circuit.net.State\";\n+  private static final Class<?> classState;\n+  private static final MethodHandle hostField_mh;\n+  private static final MethodHandle portField_mh;\n+  private static final MethodHandle methodField_mh;\n+  private static final MethodHandle uriField_mh;\n+\n+  static final String SERVER_TRANSACTION_CLASSNAME = \"com.vordel.dwe.http.ServerTransaction\";\n+  static final Class<Object> SERVER_TRANSACTION_CLASS = getServerTransactionClass();\n+\n+  private static Class<Object> getServerTransactionClass() {\n+    try {\n+      return (Class<Object>) Class.forName(SERVER_TRANSACTION_CLASSNAME);\n+    } catch (ClassNotFoundException e) {\n+      log.debug(\"Can't get ServerTransaction class name\", e);\n+    }\n+    return null;\n+  }\n+\n+  static {\n+    classServerTransaction = initClass(SERVERTRANSACTION_CLASSNAME);\n+    getRemoteAddr_mh =\n+        initNoArgServerTransactionMethodHandle(\"getRemoteAddr\", InetSocketAddress.class);\n+    getMethod_mh = initNoArgServerTransactionMethodHandle(\"getMethod\", String.class);\n+    getURI_mh = initGetURI();\n+\n+    classState = initClass(STATE_CLASSNAME);\n+    hostField_mh = initStateFieldGetter(\"host\");\n+    portField_mh = initStateFieldGetter(\"port\");\n+    methodField_mh = initStateFieldGetter(\"verb\");\n+    uriField_mh = initStateFieldGetter(\"uri\");\n+  }\n+\n+  private static Class<?> initClass(final String name) {\n+    try {\n+      return Class.forName(name);\n+    } catch (ClassNotFoundException e) {\n+      log.debug(\n+          \"Can't find class '{}': Axaway integration failed. \", SERVERTRANSACTION_CLASSNAME, e);\n+    }\n+    return null;\n+  }\n+\n+  private static MethodHandle initNoArgServerTransactionMethodHandle(String name, Class<?> rtype) {\n+    try {\n+      return lookup.findVirtual(classServerTransaction, name, methodType(rtype));\n+    } catch (NoSuchMethodException | IllegalAccessException e) {\n+      log.debug(\"Can't find method handler '{}' \", name, e);\n+    }\n+    return null;\n+  }\n+\n+  private static MethodHandle initGetURI() {\n+    Method m = null;\n+    try {\n+      m = classServerTransaction.getDeclaredMethod(\"getURI\"); // private method\n+      m.setAccessible(true);\n+      return lookup.unreflect(m);\n+    } catch (Throwable e) {\n+      log.debug(\"Can't unreflect method '{}': \", m, e);\n+    }\n+    return null;\n+  }\n+\n+  private static MethodHandle initStateFieldGetter(String fieldName) {\n+    Field field = null;\n+    MethodHandle mh = null;\n+    try {\n+      field = classState.getDeclaredField(fieldName);\n+      field.setAccessible(true);\n+      mh = lookup.unreflectGetter(field);\n+      log.debug(\n+          \"Initialized field '{}' of class '{}' unreflected to {}\", fieldName, classState, mh);\n+    } catch (NoSuchFieldException | IllegalAccessException e) {\n+      log.debug(\n+          \"Can't find and unreflect declared field '{}' with name '{}' for class '{}' to mh: '{}'\",\n+          field,\n+          fieldName,\n+          classState,\n+          mh,\n+          e);\n+    }\n+    return mh;\n+  }\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"axway-http\"};\n+  }\n+\n+  @Override\n+  protected String component() {\n+    return \"axway-http\";\n+  }\n+\n+  @Override\n+  protected String method(final Object serverTransaction) {\n+    try {\n+      return (String) getMethod_mh.invoke(serverTransaction);\n+    } catch (Throwable throwable) {\n+      log.debug(\n+          \"Can't invoke invoke '{}' on instance '{}' of class '{}'\",\n+          getMethod_mh,\n+          serverTransaction,\n+          serverTransaction.getClass(),\n+          throwable);\n+    }\n+    return \"UNKNOWN\";\n+  }\n+\n+  @Override\n+  protected URIDataAdapter url(final Object serverTransaction) {\n+    try {\n+      return new DefaultURIDataAdapter((URI) getURI_mh.invoke(serverTransaction));\n+    } catch (Throwable e) {\n+      log.debug(\"Can't find invoke '{}}' on '{}': \", getURI_mh, serverTransaction, e);", "originalCommit": "994c629b375cf0745a13100a1722a2d237af3900", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY0MjQ2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1724#discussion_r594642460", "bodyText": "I think this exception should never happen. At the point we instrumenting ServerTransaction it should have some valid URI behind it: otherwise it wouldn't be able to reach the server where we instrumenting it.", "author": "lpriima", "createdAt": "2021-03-15T19:57:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM5NTQ4Ng=="}], "type": "inlineReview"}, {"oid": "546f8dbb3ecb95791fd04b9a02b9aecab22435ff", "url": "https://github.com/DataDog/dd-trace-java/commit/546f8dbb3ecb95791fd04b9a02b9aecab22435ff", "message": "Axway API integration", "committedDate": "2021-03-15T19:39:00Z", "type": "commit"}, {"oid": "4d14221f23bfa0bb1ea7112ecdf00d479570cd41", "url": "https://github.com/DataDog/dd-trace-java/commit/4d14221f23bfa0bb1ea7112ecdf00d479570cd41", "message": "Decorate onrequest manually", "committedDate": "2021-03-15T19:39:00Z", "type": "commit"}, {"oid": "6e5cb1fa1f3e263735841d9dc596539a3ee2a352", "url": "https://github.com/DataDog/dd-trace-java/commit/6e5cb1fa1f3e263735841d9dc596539a3ee2a352", "message": "Move reflection utils methods to Decorator", "committedDate": "2021-03-15T19:39:01Z", "type": "commit"}, {"oid": "05167f4359911de4953c8dddc529b49f6b14a60f", "url": "https://github.com/DataDog/dd-trace-java/commit/05167f4359911de4953c8dddc529b49f6b14a60f", "message": "Don't add headers to State.header", "committedDate": "2021-03-15T19:39:01Z", "type": "commit"}, {"oid": "7a7e7f3c2162a282b7db609ac6e4cfa268ab5bea", "url": "https://github.com/DataDog/dd-trace-java/commit/7a7e7f3c2162a282b7db609ac6e4cfa268ab5bea", "message": "AxwayHTTPPluginDecorator: replace reflection calls to MH", "committedDate": "2021-03-15T19:39:01Z", "type": "commit"}, {"oid": "34c889b97cf46b8d28bc19d45f66a3d39abfeb7e", "url": "https://github.com/DataDog/dd-trace-java/commit/34c889b97cf46b8d28bc19d45f66a3d39abfeb7e", "message": "axway.StateAdvice: documentation", "committedDate": "2021-03-15T19:39:01Z", "type": "commit"}, {"oid": "a70312e57f04958cc2a9d2c61237494d26485eae", "url": "https://github.com/DataDog/dd-trace-java/commit/a70312e57f04958cc2a9d2c61237494d26485eae", "message": "axway-api: docs typos", "committedDate": "2021-03-15T19:39:01Z", "type": "commit"}, {"oid": "71b6ce4669518664839358414c2dad830606527b", "url": "https://github.com/DataDog/dd-trace-java/commit/71b6ce4669518664839358414c2dad830606527b", "message": "Access fields via method handles", "committedDate": "2021-03-15T19:39:01Z", "type": "commit"}, {"oid": "2c0ed7d719f2c350401a0a53848966b33f48ed19", "url": "https://github.com/DataDog/dd-trace-java/commit/2c0ed7d719f2c350401a0a53848966b33f48ed19", "message": "Name component 'axway-http'", "committedDate": "2021-03-15T19:39:01Z", "type": "commit"}, {"oid": "f393238e3b6c1cb34ad6adc3025702862aec99a4", "url": "https://github.com/DataDog/dd-trace-java/commit/f393238e3b6c1cb34ad6adc3025702862aec99a4", "message": "axway doc typos", "committedDate": "2021-03-15T19:39:01Z", "type": "commit"}, {"oid": "c3e7b5373c5f10533ca73169cd6a080b6ce86701", "url": "https://github.com/DataDog/dd-trace-java/commit/c3e7b5373c5f10533ca73169cd6a080b6ce86701", "message": "Axway http status code possible solution scheme", "committedDate": "2021-03-15T19:39:01Z", "type": "commit"}, {"oid": "9b0816c51448e4f26be333806fb559a39414119b", "url": "https://github.com/DataDog/dd-trace-java/commit/9b0816c51448e4f26be333806fb559a39414119b", "message": "avoid axway classes initialization at instrumentation time", "committedDate": "2021-03-15T20:14:37Z", "type": "commit"}, {"oid": "9b0816c51448e4f26be333806fb559a39414119b", "url": "https://github.com/DataDog/dd-trace-java/commit/9b0816c51448e4f26be333806fb559a39414119b", "message": "avoid axway classes initialization at instrumentation time", "committedDate": "2021-03-15T20:14:37Z", "type": "forcePushed"}]}