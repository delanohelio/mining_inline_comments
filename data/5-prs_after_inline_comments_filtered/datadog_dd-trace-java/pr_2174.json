{"pr_number": 2174, "pr_title": "Try to create a type description by loading a class if the pool fails", "pr_createdAt": "2020-12-08T12:44:10Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2174", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzNzQ4Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#discussion_r538337482", "bodyText": "Shouldn't this be klass = classLoader.loadClass(className.replace('.', '/')); ?", "author": "richardstartin", "createdAt": "2020-12-08T12:57:35Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/DDCachingPoolStrategy.java", "diffHunk": "@@ -248,12 +256,52 @@ public void clear() {\n     }\n   }\n \n+  private static class CachingResolutionForMaybeLoadableType implements TypePool.Resolution {\n+    private final WeakReference<ClassLoader> loaderRef;\n+    private final String className;\n+    private volatile TypeDescription typeDescription = null;\n+    private volatile boolean isResolved = false;\n+\n+    public CachingResolutionForMaybeLoadableType(\n+        WeakReference<ClassLoader> loaderRef, String className) {\n+      this.loaderRef = loaderRef;\n+      this.className = className;\n+    }\n+\n+    @Override\n+    public boolean isResolved() {\n+      return isResolved;\n+    }\n+\n+    @Override\n+    public TypeDescription resolve() {\n+      // Intentionally not \"thread safe\". Duplicate work deemed an acceptable trade-off.\n+      if (!isResolved) {\n+        Class<?> klass = null;\n+        ClassLoader classLoader = loaderRef.get();\n+        if (classLoader != null) {\n+          try {\n+            klass = classLoader.loadClass(className.replace('.', '\\\\'));", "originalCommit": "591b430243fa6668cf3f1666c6bbda8faa864f3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzOTc1NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#discussion_r538339755", "bodyText": "Doh! Thanks, and the test is without a package name... \ud83d\ude14", "author": "bantonsson", "createdAt": "2020-12-08T12:59:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzNzQ4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM3MDUwOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#discussion_r538370508", "bodyText": "There was even a double error, and there should be no replace.", "author": "bantonsson", "createdAt": "2020-12-08T13:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzNzQ4Mg=="}], "type": "inlineReview"}, {"oid": "97a880c7d3f1740509bfc8136ae8d929e94ea186", "url": "https://github.com/DataDog/dd-trace-java/commit/97a880c7d3f1740509bfc8136ae8d929e94ea186", "message": "Try to create a type description by loading a class if the pool fails", "committedDate": "2020-12-08T13:29:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwNTgyMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#discussion_r538805822", "bodyText": "Should we log a debug message when this happens?", "author": "tylerbenson", "createdAt": "2020-12-08T21:03:25Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/DDCachingPoolStrategy.java", "diffHunk": "@@ -248,12 +256,52 @@ public void clear() {\n     }\n   }\n \n+  private static class CachingResolutionForMaybeLoadableType implements TypePool.Resolution {\n+    private final WeakReference<ClassLoader> loaderRef;\n+    private final String className;\n+    private volatile TypeDescription typeDescription = null;\n+    private volatile boolean isResolved = false;\n+\n+    public CachingResolutionForMaybeLoadableType(\n+        WeakReference<ClassLoader> loaderRef, String className) {\n+      this.loaderRef = loaderRef;\n+      this.className = className;\n+    }\n+\n+    @Override\n+    public boolean isResolved() {\n+      return isResolved;\n+    }\n+\n+    @Override\n+    public TypeDescription resolve() {\n+      // Intentionally not \"thread safe\". Duplicate work deemed an acceptable trade-off.\n+      if (!isResolved) {\n+        Class<?> klass = null;\n+        ClassLoader classLoader = loaderRef.get();\n+        if (classLoader != null) {\n+          try {\n+            klass = classLoader.loadClass(className);", "originalCommit": "97a880c7d3f1740509bfc8136ae8d929e94ea186", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA1MTk0OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#discussion_r539051948", "bodyText": "Yes, we should definitely log when we are able to load the class. I'll add a comment as well.", "author": "bantonsson", "createdAt": "2020-12-09T06:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwNTgyMg=="}], "type": "inlineReview"}, {"oid": "fb14ab1cddb4a5e68a7f5cd98283fdbe33a20624", "url": "https://github.com/DataDog/dd-trace-java/commit/fb14ab1cddb4a5e68a7f5cd98283fdbe33a20624", "message": "Try to create a type description by loading a class if the pool fails", "committedDate": "2020-12-09T07:08:42Z", "type": "forcePushed"}, {"oid": "4994716fcd534ba6abea41df0d1c4f110c802a19", "url": "https://github.com/DataDog/dd-trace-java/commit/4994716fcd534ba6abea41df0d1c4f110c802a19", "message": "Try to create a type description using loadClass if the pool fails", "committedDate": "2020-12-09T11:41:57Z", "type": "commit"}, {"oid": "4994716fcd534ba6abea41df0d1c4f110c802a19", "url": "https://github.com/DataDog/dd-trace-java/commit/4994716fcd534ba6abea41df0d1c4f110c802a19", "message": "Try to create a type description using loadClass if the pool fails", "committedDate": "2020-12-09T11:41:57Z", "type": "forcePushed"}]}