{"pr_number": 1437, "pr_title": "Reduce copy/allocation in trace serialization pipeline", "pr_createdAt": "2020-05-07T15:19:52Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1437", "timeline": [{"oid": "844be383d19af7fd6314b811cfe14e77c86a35ec", "url": "https://github.com/DataDog/dd-trace-java/commit/844be383d19af7fd6314b811cfe14e77c86a35ec", "message": "replace byte[] with ByteBuffer to reduce copy/allocation", "committedDate": "2020-05-07T15:18:24Z", "type": "commit"}, {"oid": "894b1e303a558e7cee3b0d12e31e49a859060d9b", "url": "https://github.com/DataDog/dd-trace-java/commit/894b1e303a558e7cee3b0d12e31e49a859060d9b", "message": "return null from StringTables when no entry is present", "committedDate": "2020-05-08T06:57:17Z", "type": "commit"}, {"oid": "a7da77bc24e2fbf245f9c1dbeaa3bd02c0236aeb", "url": "https://github.com/DataDog/dd-trace-java/commit/a7da77bc24e2fbf245f9c1dbeaa3bd02c0236aeb", "message": "Merge branch 'master' into richardstartin/bytebuff-events", "committedDate": "2020-05-08T07:00:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE3MjQ0OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1437#discussion_r422172449", "bodyText": "For the sake of seeing the difference between this and the next check, it might make sense to change the 16 to 0x100", "author": "devinsba", "createdAt": "2020-05-08T14:23:24Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -147,14 +151,18 @@ public long contentLength() {\n \n             @Override\n             public void writeTo(final BufferedSink sink) throws IOException {\n-              final OutputStream out = sink.outputStream();\n-              final MessagePacker packer = MessagePack.newDefaultPacker(out);\n-              packer.packArrayHeader(traces.size());\n-              for (final byte[] trace : traces) {\n-                packer.writePayload(trace);\n+              if (traces.size() < 16) {", "originalCommit": "a7da77bc24e2fbf245f9c1dbeaa3bd02c0236aeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4NzAzMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1437#discussion_r422887031", "bodyText": "It's been inlined from MessagePacker so I will leave it exactly as it is there, I just don't like numbers written as shifts.", "author": "richardstartin", "createdAt": "2020-05-11T08:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE3MjQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU4OTc5MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1437#discussion_r421589790", "bodyText": "This is where the primary benefit is, right?  Perhaps you could update the PR description to describe how this change achieves its' benefits.", "author": "tylerbenson", "createdAt": "2020-05-07T15:22:12Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -141,14 +145,18 @@ public long contentLength() {\n \n             @Override\n             public void writeTo(final BufferedSink sink) throws IOException {\n-              final OutputStream out = sink.outputStream();\n-              final MessagePacker packer = MessagePack.newDefaultPacker(out);\n-              packer.packArrayHeader(traces.size());\n-              for (final byte[] trace : traces) {\n-                packer.writePayload(trace);\n+              if (traces.size() < 16) {\n+                sink.writeByte((byte) (traces.size() | FIXARRAY_PREFIX));\n+              } else if (traces.size() < 0x10000) {\n+                sink.writeByte(ARRAY16);\n+                sink.writeShort(traces.size());\n+              } else {\n+                sink.writeByte(ARRAY32);\n+                sink.writeInt(traces.size());\n+              }\n+              for (ByteBuffer trace : traces) {\n+                sink.write(trace);", "originalCommit": "844be383d19af7fd6314b811cfe14e77c86a35ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4ODI3Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1437#discussion_r422888276", "bodyText": "There may be some benefit here, especially once the buffers get large, but the motivation is that slicing as a ByteBuffer might not reallocate/copy the buffer. In any case, I have moved this on from here, to adaptively size the buffers to avoid needing to copy.", "author": "richardstartin", "createdAt": "2020-05-11T08:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU4OTc5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU5MTE0MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1437#discussion_r421591141", "bodyText": "Perhaps a comment here that you are inlining the MessagePacker.packArrayHeader behavior?", "author": "tylerbenson", "createdAt": "2020-05-07T15:24:05Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -141,14 +145,18 @@ public long contentLength() {\n \n             @Override\n             public void writeTo(final BufferedSink sink) throws IOException {\n-              final OutputStream out = sink.outputStream();\n-              final MessagePacker packer = MessagePack.newDefaultPacker(out);\n-              packer.packArrayHeader(traces.size());\n-              for (final byte[] trace : traces) {\n-                packer.writePayload(trace);\n+              if (traces.size() < 16) {\n+                sink.writeByte((byte) (traces.size() | FIXARRAY_PREFIX));\n+              } else if (traces.size() < 0x10000) {\n+                sink.writeByte(ARRAY16);\n+                sink.writeShort(traces.size());\n+              } else {\n+                sink.writeByte(ARRAY32);\n+                sink.writeInt(traces.size());\n+              }", "originalCommit": "844be383d19af7fd6314b811cfe14e77c86a35ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de740e62f3eabad366003518e2882e9dca641773", "url": "https://github.com/DataDog/dd-trace-java/commit/de740e62f3eabad366003518e2882e9dca641773", "message": "allow adapative sizing of message buffers based on moving average, allow buffer to be shared between multiple traces (without enabling batching yet).", "committedDate": "2020-05-11T09:26:12Z", "type": "forcePushed"}, {"oid": "e76e0ed817260e518250bb280157e3d400fa0121", "url": "https://github.com/DataDog/dd-trace-java/commit/e76e0ed817260e518250bb280157e3d400fa0121", "message": "update ddagent api integration test", "committedDate": "2020-05-11T10:00:38Z", "type": "forcePushed"}, {"oid": "310fae50d50422fa7c0df6c8ba65eb6aa3cd5cc6", "url": "https://github.com/DataDog/dd-trace-java/commit/310fae50d50422fa7c0df6c8ba65eb6aa3cd5cc6", "message": "allow adapative sizing of message buffers based on moving average, allow buffer to be shared between multiple traces (without enabling batching yet).", "committedDate": "2020-05-11T10:10:23Z", "type": "commit"}, {"oid": "310fae50d50422fa7c0df6c8ba65eb6aa3cd5cc6", "url": "https://github.com/DataDog/dd-trace-java/commit/310fae50d50422fa7c0df6c8ba65eb6aa3cd5cc6", "message": "allow adapative sizing of message buffers based on moving average, allow buffer to be shared between multiple traces (without enabling batching yet).", "committedDate": "2020-05-11T10:10:23Z", "type": "forcePushed"}, {"oid": "e55175329d6b93fc6cf4b6c91c695ea413c1c394", "url": "https://github.com/DataDog/dd-trace-java/commit/e55175329d6b93fc6cf4b6c91c695ea413c1c394", "message": "don't read tags from the string table because we don't know many of their values, add some documentation about the intent behind TraceBuffer", "committedDate": "2020-05-11T18:13:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5MjQ5Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1437#discussion_r423192492", "bodyText": "Can you add a comment here giving insight on the future direction of this?", "author": "tylerbenson", "createdAt": "2020-05-11T17:13:41Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/BatchWritingDisruptor.java", "diffHunk": "@@ -83,10 +84,11 @@ private BatchWritingHandler(\n     // TODO: reduce byte[] garbage by keeping the byte[] on the event and copy before returning.\n     @Override\n     public void onEvent(\n-        final DisruptorEvent<byte[]> event, final long sequence, final boolean endOfBatch) {\n+        final DisruptorEvent<TraceBuffer> event, final long sequence, final boolean endOfBatch) {\n       try {\n         if (event.data != null) {\n-          sizeInBytes += event.data.length;\n+          sizeInBytes += event.data.sizeInBytes();\n+          traceCount += event.data.traceCount();\n           serializedTraces.add(event.data);\n         }", "originalCommit": "310fae50d50422fa7c0df6c8ba65eb6aa3cd5cc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI2MTg3NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1437#discussion_r423261874", "bodyText": "Done.", "author": "richardstartin", "createdAt": "2020-05-11T19:16:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5MjQ5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIwNTgwMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1437#discussion_r423205803", "bodyText": "A little insight on future direction would also be nice here.", "author": "tylerbenson", "createdAt": "2020-05-11T17:35:43Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/TraceProcessingDisruptor.java", "diffHunk": "@@ -66,9 +68,11 @@ public void onEvent(\n           // TODO populate `_sample_rate` metric in a way that accounts for lost/dropped traces\n           try {\n             event.data = processor.onTraceComplete(event.data);\n-            final byte[] serializedTrace = api.serializeTrace(event.data);\n+            serializer.serialize(event.data);\n+            TraceBuffer serializedTrace = serializer.getBuffer();\n+            int sizeInBytes = serializedTrace.sizeInBytes();", "originalCommit": "310fae50d50422fa7c0df6c8ba65eb6aa3cd5cc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI2MTkyNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1437#discussion_r423261927", "bodyText": "Done", "author": "richardstartin", "createdAt": "2020-05-11T19:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIwNTgwMw=="}], "type": "inlineReview"}, {"oid": "fe75c087f2da4ffb8c5566add53fff393f01673a", "url": "https://github.com/DataDog/dd-trace-java/commit/fe75c087f2da4ffb8c5566add53fff393f01673a", "message": "don't read tags from the string table because we don't know many of their values, add some documentation about the intent behind TraceBuffer", "committedDate": "2020-05-11T18:21:04Z", "type": "forcePushed"}, {"oid": "90a3d234ac183541ca8aba62a6f7b83d6f12ceaa", "url": "https://github.com/DataDog/dd-trace-java/commit/90a3d234ac183541ca8aba62a6f7b83d6f12ceaa", "message": "don't read tags from the string table because we don't know many of their values, add some documentation about the intent behind TraceBuffer", "committedDate": "2020-05-11T18:24:08Z", "type": "commit"}, {"oid": "90a3d234ac183541ca8aba62a6f7b83d6f12ceaa", "url": "https://github.com/DataDog/dd-trace-java/commit/90a3d234ac183541ca8aba62a6f7b83d6f12ceaa", "message": "don't read tags from the string table because we don't know many of their values, add some documentation about the intent behind TraceBuffer", "committedDate": "2020-05-11T18:24:08Z", "type": "forcePushed"}]}