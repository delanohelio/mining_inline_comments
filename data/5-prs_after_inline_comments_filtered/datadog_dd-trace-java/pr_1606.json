{"pr_number": 1606, "pr_title": "do not eagerly load classfiles at startup", "pr_createdAt": "2020-06-19T14:04:02Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1606", "timeline": [{"oid": "7b00bcc701556637e22bfe3f5edfbb65e17f6306", "url": "https://github.com/DataDog/dd-trace-java/commit/7b00bcc701556637e22bfe3f5edfbb65e17f6306", "message": "do not eagerly load classfiles at startup", "committedDate": "2020-06-19T13:57:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3MTEwMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1606#discussion_r442871103", "bodyText": "What is the reason for this special treatment of META-INF/services folder?", "author": "jbachorik", "createdAt": "2020-06-19T14:25:29Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -27,35 +25,40 @@\n \n   private final String name;\n   private final FileNotInInternalJar notFound;\n-  private final Map<String, JarEntry> filenameToEntry = new HashMap<>();\n   private final Set<String> packages = new HashSet<>();\n   private final JarFile bootstrapJarFile;\n \n+  private static final ThreadLocal<StringBuilder> JAR_ENTRY_QUERY =\n+      new ThreadLocal<StringBuilder>() {\n+        @Override\n+        protected StringBuilder initialValue() {\n+          return new StringBuilder(128);\n+        }\n+      };\n+\n   private WeakReference<Pair<String, JarEntry>> cache = NULL;\n \n   InternalJarURLHandler(final String internalJarFileName, final URL bootstrapJarLocation) {\n     this.name = internalJarFileName;\n     this.notFound = new FileNotInInternalJar(internalJarFileName);\n     final String filePrefix = internalJarFileName + \"/\";\n     JarFile jarFile = null;\n-    String currentDir = \"$\";\n     try {\n       if (bootstrapJarLocation != null) {\n         jarFile = new JarFile(new File(bootstrapJarLocation.toURI()), false);\n         final Enumeration<JarEntry> entries = jarFile.entries();\n         while (entries.hasMoreElements()) {\n           final JarEntry entry = entries.nextElement();\n-          if (!entry.isDirectory() && entry.getName().startsWith(filePrefix)) {\n-            String name = entry.getName();\n-            // remove data suffix\n-            int end = name.endsWith(\".classdata\") ? name.length() - 4 : name.length();\n-            String fileName = name.substring(internalJarFileName.length(), end);\n-            filenameToEntry.put(fileName, entry);\n-            if (fileName.endsWith(\".class\") && !fileName.startsWith(currentDir)) {\n-              int fileNameStart = fileName.lastIndexOf('/');\n-              if (fileNameStart != -1) {\n-                currentDir = fileName.substring(1, fileNameStart);\n-                String currentPackage = currentDir.replace('/', '.');\n+          String name = entry.getName();\n+          if (name.startsWith(filePrefix)) {\n+            if (entry.isDirectory()) {\n+              int prefix = filePrefix.length();\n+              if (name.contains(\"META-INF/services/\")) {\n+                prefix += \"META-INF/services/\".length();\n+              }", "originalCommit": "7b00bcc701556637e22bfe3f5edfbb65e17f6306", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3ODkzNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1606#discussion_r442878934", "bodyText": "We package some stuff in META-INF - this is a bit hacky I agree, but we can't infer packages from the contents of the jar properly otherwise. I am investigating ways to store package info in the manifest and set it during the build to eliminate this scan entirely - should be less error prone.", "author": "richardstartin", "createdAt": "2020-06-19T14:39:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3MTEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3MTEyMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1606#discussion_r442871120", "bodyText": "nice one!", "author": "jpbempel", "createdAt": "2020-06-19T14:25:31Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -27,35 +25,40 @@\n \n   private final String name;\n   private final FileNotInInternalJar notFound;\n-  private final Map<String, JarEntry> filenameToEntry = new HashMap<>();\n   private final Set<String> packages = new HashSet<>();\n   private final JarFile bootstrapJarFile;\n \n+  private static final ThreadLocal<StringBuilder> JAR_ENTRY_QUERY =\n+      new ThreadLocal<StringBuilder>() {\n+        @Override\n+        protected StringBuilder initialValue() {\n+          return new StringBuilder(128);\n+        }\n+      };\n+\n   private WeakReference<Pair<String, JarEntry>> cache = NULL;\n \n   InternalJarURLHandler(final String internalJarFileName, final URL bootstrapJarLocation) {\n     this.name = internalJarFileName;\n     this.notFound = new FileNotInInternalJar(internalJarFileName);\n     final String filePrefix = internalJarFileName + \"/\";\n     JarFile jarFile = null;\n-    String currentDir = \"$\";\n     try {\n       if (bootstrapJarLocation != null) {\n         jarFile = new JarFile(new File(bootstrapJarLocation.toURI()), false);\n         final Enumeration<JarEntry> entries = jarFile.entries();\n         while (entries.hasMoreElements()) {\n           final JarEntry entry = entries.nextElement();\n-          if (!entry.isDirectory() && entry.getName().startsWith(filePrefix)) {\n-            String name = entry.getName();\n-            // remove data suffix\n-            int end = name.endsWith(\".classdata\") ? name.length() - 4 : name.length();\n-            String fileName = name.substring(internalJarFileName.length(), end);\n-            filenameToEntry.put(fileName, entry);\n-            if (fileName.endsWith(\".class\") && !fileName.startsWith(currentDir)) {\n-              int fileNameStart = fileName.lastIndexOf('/');\n-              if (fileNameStart != -1) {\n-                currentDir = fileName.substring(1, fileNameStart);\n-                String currentPackage = currentDir.replace('/', '.');\n+          String name = entry.getName();\n+          if (name.startsWith(filePrefix)) {", "originalCommit": "7b00bcc701556637e22bfe3f5edfbb65e17f6306", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3NjIwNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1606#discussion_r442876206", "bodyText": "Suggestion... instead of resetting this to 0 each time then calling sb.append(this.name), make the StringBuilder a non-static field, prepopulate it with this.name and reset to this.name.size() to avoid recopying it each time.", "author": "tylerbenson", "createdAt": "2020-06-19T14:34:39Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -90,7 +93,14 @@ protected URLConnection openConnection(final URL url) throws IOException {\n     // and the key will be a new object each time.\n     Pair<String, JarEntry> pair = cache.get();\n     if (null == pair || !filename.equals(pair.getLeft())) {\n-      final JarEntry entry = filenameToEntry.get(filename);\n+      StringBuilder sb = JAR_ENTRY_QUERY.get();\n+      sb.append(this.name).append(filename);\n+      if (filename.endsWith(\".class\")) {\n+        sb.append(\"data\");\n+      }\n+      String classFileName = sb.toString();\n+      sb.setLength(0);", "originalCommit": "7b00bcc701556637e22bfe3f5edfbb65e17f6306", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3NzgwNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1606#discussion_r442877804", "bodyText": "could do but no - I thought about it - but we save like a 5 chars copy", "author": "richardstartin", "createdAt": "2020-06-19T14:37:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3NjIwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4MDg0NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1606#discussion_r442880844", "bodyText": "isn't that multiplied over the many jar entries though?  what's the downside?", "author": "tylerbenson", "createdAt": "2020-06-19T14:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3NjIwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4MjQ4NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1606#discussion_r442882484", "bodyText": "The downside is making the change and getting a clean build, to save a nanosecond for at most the 10,000 classes we bundle. Of those 10,000 classes, at least 4000 are never loaded, so we're talking about saving 6000ns or 6us on seconds, for what will amount to about an hour of my time.", "author": "richardstartin", "createdAt": "2020-06-19T14:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3NjIwNg=="}], "type": "inlineReview"}]}