{"pr_number": 1879, "pr_title": "Handle custom bean classloader in Spring", "pr_createdAt": "2020-09-16T22:50:34Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1879", "timeline": [{"oid": "170d40cddede911fba5d38497ab8dbf4ad218fad", "url": "https://github.com/DataDog/dd-trace-java/commit/170d40cddede911fba5d38497ab8dbf4ad218fad", "message": "Handle custom bean classloader in Spring", "committedDate": "2020-09-16T22:47:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMjU2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1879#discussion_r490512560", "bodyText": "Is this something we need to replicate for other Spring instrumentation & bean types?\nI'm fine with us doing a targeted fix first.\nI'm just wondering if there's a bigger change that we need as well.", "author": "dougqh", "createdAt": "2020-09-17T19:35:08Z", "path": "dd-java-agent/instrumentation/spring-webmvc-3.1/src/main/java/datadog/trace/instrumentation/springweb/BeanFactoryInstrumentation.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package datadog.trace.instrumentation.springweb;\n+\n+import static datadog.trace.agent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.DDElementMatchers.extendsClass;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.springframework.beans.factory.support.RootBeanDefinition;\n+\n+/**\n+ * Bean Factories can be set with a \"beanClassloader\" that is different from the injected\n+ * classloader. This leads to a ClassNotFoundException at runtime.\n+ *\n+ * <p>This instrumentation ensures class lookups for the HandlerMappingResourceNameFilter don't fail\n+ * by manually setting the class on the bean definition\n+ *\n+ * <p>This can't be done at BeanDefinition construction time because Spring heavy use of clone()\n+ * which sometimes only copies the classname\n+ */\n+@AutoService(Instrumenter.class)\n+public class BeanFactoryInstrumentation extends Instrumenter.Default {\n+  public BeanFactoryInstrumentation() {\n+    super(\"spring-web\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    // Optimization for expensive typeMatcher.\n+    return hasClassesNamed(\"org.springframework.beans.factory.support.AbstractBeanFactory\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return extendsClass(named(\"org.springframework.beans.factory.support.AbstractBeanFactory\"));\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\n+      packageName + \".SpringWebHttpServerDecorator\",\n+      packageName + \".SpringWebHttpServerDecorator$1\",\n+      packageName + \".ServletRequestURIAdapter\",\n+      packageName + \".HandlerMappingResourceNameFilter\",\n+      packageName + \".HandlerMappingResourceNameFilter$BeanDefinition\",\n+    };\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+\n+    return singletonMap(\n+        isMethod()\n+            .and(named(\"resolveBeanClass\"))\n+            .and(\n+                takesArgument(\n+                    0, named(\"org.springframework.beans.factory.support.RootBeanDefinition\"))),\n+        BeanFactoryInstrumentation.class.getName() + \"$BeanResolvingAdvice\");\n+  }\n+\n+  public static class BeanResolvingAdvice {\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static void onEnter(@Advice.Argument(0) final RootBeanDefinition beanDefinition) {\n+      if (!beanDefinition.hasBeanClass()\n+          && HandlerMappingResourceNameFilter.class\n+              .getName()\n+              .equals(beanDefinition.getBeanClassName())) {\n+\n+        beanDefinition.setBeanClass(HandlerMappingResourceNameFilter.class);", "originalCommit": "170d40cddede911fba5d38497ab8dbf4ad218fad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3OTU4NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1879#discussion_r490579584", "bodyText": "HandlerMappingResourceNameFilter is the only bean that we register so no other changes are required", "author": "randomanderson", "createdAt": "2020-09-17T21:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMjU2MA=="}], "type": "inlineReview"}, {"oid": "8eda79da3155f1fd060431003105d7c7bda89575", "url": "https://github.com/DataDog/dd-trace-java/commit/8eda79da3155f1fd060431003105d7c7bda89575", "message": "Add test", "committedDate": "2020-09-17T23:02:30Z", "type": "commit"}, {"oid": "976d3c4fd1ba3002ce06fd06f3bd253ca059d71b", "url": "https://github.com/DataDog/dd-trace-java/commit/976d3c4fd1ba3002ce06fd06f3bd253ca059d71b", "message": "codenarc", "committedDate": "2020-09-18T15:43:57Z", "type": "commit"}]}