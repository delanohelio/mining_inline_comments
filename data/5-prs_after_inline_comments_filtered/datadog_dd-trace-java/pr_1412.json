{"pr_number": 1412, "pr_title": "Profiling API", "pr_createdAt": "2020-04-30T10:24:25Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1412", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNTk1MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r417935951", "bodyText": "This should be volatile or atomic. I think we already have pattern in datadog.trace.api.GlobalTracer that should be reused.", "author": "mar-kolya", "createdAt": "2020-04-30T11:16:54Z", "path": "dd-trace-api/src/main/java/datadog/trace/api/profiling/Profiler.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package datadog.trace.api.profiling;\n+\n+public class Profiler {\n+  private static SessionFactory factory;\n+\n+  public static Session startProfiling() {\n+    return factory.createSession();\n+  }\n+\n+  public static void initialize(SessionFactory sessionFactory) {\n+    factory = sessionFactory;", "originalCommit": "7b97ac09e247471b2546f871fa402cdf1c8d7a64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAyNDA2OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r418024068", "bodyText": "I'll admit I'm not necessarily a fan of our current to late binding approach; however, being consistent seems like a reasonable start for now.\nMy one question is \"why do we need the dependency injection for SessionFactory?\"  Do we foresee other implementations in the near term?", "author": "dougqh", "createdAt": "2020-04-30T13:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNTk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAyODE4Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r418028186", "bodyText": "The problem is the interaction between 3 classloaders:\n\njava agent Classloader\ntracer ClassLoader where you will use the API\nprofiling ClassLoader where the implementation will reside\nI need to inject the implementation at some point", "author": "jpbempel", "createdAt": "2020-04-30T13:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNTk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAzMjU2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r418032560", "bodyText": "Above is correct with possibly two comments:\n\n\nThere are limitations in terms of APIs older jvms provide and what we can inject into tracer/agent classloaders considering need to run on older jvms\n\n\nIt is not clear to me that implementation of that api has to be specifically on profiler classloader - I think it is TBD, really... Like we ended up doing cpu time event not on profiler Classloader - and on JMX classloader instead even though it produces JFR events.", "author": "mar-kolya", "createdAt": "2020-04-30T14:00:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNTk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0ODkzNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r418048937", "bodyText": "I am ok to move impl outside of Profiling ClassLoader, but if we endup in JMX classloader, the problem of late binding is the same :)", "author": "jpbempel", "createdAt": "2020-04-30T14:23:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNTk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ0MDEyMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r419440121", "bodyText": "@dougqh The whole late-binding business is caused by JMX initializing j.u.l classes which in turn seems to mess up some instrumented apps.\nUnfortunately, the JLS allows eager class runtime constant pool initialization in which case simply having the incriminating JMX code reachable via class references (not even using or instantiating the entry class!) can make the problem to pop up.\nTherefore all that late-binding-via-reflection magic :/", "author": "jbachorik", "createdAt": "2020-05-04T13:35:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNTk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ0NTE2NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r419445165", "bodyText": "@mar-kolya\n\nThere are limitations in terms of APIs older jvms provide and what we can inject into tracer/agent classloaders considering need to run on older jvms\n\nThe MX bean we are going to be using to get the stacktraces has been in JDK since 1.6 so it should be fairly safe to use :)\n\nIt is not clear to me that implementation of that api has to be specifically on profiler classloader - I think it is TBD, really... Like we ended up doing cpu time event not on profiler Classloader - and on JMX classloader instead even though it produces JFR events.\n\nWell, at least the API part will have to live in bootstrap since the classes need to be accessible from all instrumentations. In fact I think we will need to mirror the classloading setup we are using for ScopeEvents since this API will be called from more or less the same places.\nThe implementation part, on the other hand, is pretty much free to decide where it wants to live - we can add it to the profiler 'space' or create something separate just for the JMX sampler (although this would be a bit of overkill for the simple impl we have in mind).", "author": "jbachorik", "createdAt": "2020-05-04T13:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNTk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNjE5MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r417936190", "bodyText": "Public interfaces should be documented", "author": "mar-kolya", "createdAt": "2020-04-30T11:17:27Z", "path": "dd-trace-api/src/main/java/datadog/trace/api/profiling/SessionFactory.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package datadog.trace.api.profiling;\n+\n+public interface SessionFactory {", "originalCommit": "7b97ac09e247471b2546f871fa402cdf1c8d7a64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4Mzk1Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r418183957", "bodyText": "I'm fine with more documentation, but I think we should separate a few things here.\n\n\nFirst, there's a difference between a public class and a published API.\nI suspect we don't want outside users calling this class, so the more important thing might be placing this an internal package.\n\n\nSecond, added a minimal header comment isn't really documentation in my view.\nFor the most part, I'd say most of our code lacks documentation and we should fix that, but I'd place the emphasis on package and concept documentation over header doc.\n\n\nThird, I care more that we agree on the interface first -- we can add the documentation once we've reached agreemnt.", "author": "dougqh", "createdAt": "2020-04-30T17:48:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNjE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIxNzE2OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r418217168", "bodyText": "Some documentation is better than none, but yeah good points.", "author": "mar-kolya", "createdAt": "2020-04-30T18:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNjE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQzNTQ2NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r419435464", "bodyText": "A standard Javadoc block is a very good way to make the API (even internal one) discoverable. Nothing is more frustrating than guessing the expected input and output - although that should be also possible to deduce from unit tests having the javadoc being rendered right in the IDE without the need to jump around and build the mental model of the whole thing seems to be a better use of time (at least IMO).", "author": "jbachorik", "createdAt": "2020-05-04T13:28:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNjE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ0MzU1NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r419443554", "bodyText": "I am ok to move those classes, but where is the best place/package?\nThis api needs to be available by instrumenters and the implementation", "author": "jpbempel", "createdAt": "2020-05-04T13:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNjE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNjI5Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r417936292", "bodyText": "Should this be Closeable", "author": "mar-kolya", "createdAt": "2020-04-30T11:17:41Z", "path": "dd-trace-api/src/main/java/datadog/trace/api/profiling/Session.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package datadog.trace.api.profiling;\n+\n+public interface Session {\n+  void stop();", "originalCommit": "7b97ac09e247471b2546f871fa402cdf1c8d7a64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNjQyNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r423906424", "bodyText": "done", "author": "jpbempel", "createdAt": "2020-05-12T17:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNjI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk5NDkxNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r417994916", "bodyText": "The way things turn out to be we may not be able to use JMX inside profiler for certain setups. Please see how datadog.trace.common.util.ThreadCpuTimeAccess is implemented and used from datadog.trace.bootstrap.Agent", "author": "mar-kolya", "createdAt": "2020-04-30T13:07:05Z", "path": "dd-java-agent/agent-profiling/profiling-controller/src/main/java/com/datadog/profiling/mlt/JMXSession.java", "diffHunk": "@@ -0,0 +1,14 @@\n+package com.datadog.profiling.mlt;\n+\n+import datadog.trace.api.profiling.Session;\n+\n+public class JMXSession implements Session {", "originalCommit": "7b97ac09e247471b2546f871fa402cdf1c8d7a64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwMjM0OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r423902349", "bodyText": "Please add a fixme to address this if this is not going to be addressed in this PR.", "author": "mar-kolya", "createdAt": "2020-05-12T17:18:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk5NDkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNjYxMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r423906613", "bodyText": "done", "author": "jpbempel", "createdAt": "2020-05-12T17:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk5NDkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNTc2Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r423915762", "bodyText": "I do not think this has been done. getProvider may still be called too early - at least I do not see what prevents that from happening.\ndatadog.trace.common.util.ThreadCpuTimeAccess has enableJMX that is called from Agent.java when safe to load jmx parts..", "author": "mar-kolya", "createdAt": "2020-05-12T17:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk5NDkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkxMTI4NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r420911284", "bodyText": "Please move this and related classes to the internal-api project instead.", "author": "tylerbenson", "createdAt": "2020-05-06T16:06:32Z", "path": "dd-trace-api/src/main/java/datadog/trace/api/profiling/Profiler.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package datadog.trace.api.profiling;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * Entry point of the Profiling API to allow trigger sampling profiling on demand\n+ * Example of usage:\n+ * <pre>\n+ *   try (Session session = Profiler.startProfiling()) {\n+ *     // ...\n+ *   }\n+ * </pre>\n+ * or\n+ * <pre>\n+ *   Session session = Profiler.startProfiling()\n+ *   // ... and into another method:\n+ *   session.close();\n+ * </pre>\n+ *\n+ * Nested calls are allowed but only outer calls will be effective\n+ */\n+@Slf4j\n+public class Profiler {", "originalCommit": "756286ceaee94cc2f9d74498e830fe0433534e6e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e85f2d0250bd48c328029178f2eb86f27a049a8a", "url": "https://github.com/DataDog/dd-trace-java/commit/e85f2d0250bd48c328029178f2eb86f27a049a8a", "message": "Profiling API\n\nRough version mainly to validate the interaction with sub projects\nand classloaders", "committedDate": "2020-05-06T17:18:18Z", "type": "commit"}, {"oid": "f5f52a8b696f80d2532a1667bdb59368a932a337", "url": "https://github.com/DataDog/dd-trace-java/commit/f5f52a8b696f80d2532a1667bdb59368a932a337", "message": "Improve API\n\nAdd refCounting\nAdd docs", "committedDate": "2020-05-06T17:18:18Z", "type": "commit"}, {"oid": "2215b164fe540b1655277a1c90d85cfa7da38885", "url": "https://github.com/DataDog/dd-trace-java/commit/2215b164fe540b1655277a1c90d85cfa7da38885", "message": "add JMX provider", "committedDate": "2020-05-06T17:18:18Z", "type": "commit"}, {"oid": "d81a2a1bc6d9e5a95dee5b8d60d7a7e427f6b78e", "url": "https://github.com/DataDog/dd-trace-java/commit/d81a2a1bc6d9e5a95dee5b8d60d7a7e427f6b78e", "message": "move to internal-api", "committedDate": "2020-05-06T19:24:27Z", "type": "commit"}, {"oid": "d81a2a1bc6d9e5a95dee5b8d60d7a7e427f6b78e", "url": "https://github.com/DataDog/dd-trace-java/commit/d81a2a1bc6d9e5a95dee5b8d60d7a7e427f6b78e", "message": "move to internal-api", "committedDate": "2020-05-06T19:24:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzOTc3NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r423439774", "bodyText": "Because we saw this in python: what happens if a user starts and stops the profiler many times a second?", "author": "dbenamydd", "createdAt": "2020-05-12T03:25:37Z", "path": "internal-api/src/main/java/datadog/trace/profiling/Profiler.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package datadog.trace.profiling;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * Entry point of the Profiling API to allow trigger sampling profiling on demand\n+ * Example of usage:\n+ * <pre>\n+ *   try (Session session = Profiler.startProfiling()) {\n+ *     // ...\n+ *   }\n+ * </pre>\n+ * or\n+ * <pre>\n+ *   Session session = Profiler.startProfiling()\n+ *   // ... and into another method:\n+ *   session.close();\n+ * </pre>\n+ *\n+ * Nested calls are allowed but only outer calls will be effective", "originalCommit": "d81a2a1bc6d9e5a95dee5b8d60d7a7e427f6b78e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU2NzI5Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r423567297", "bodyText": "This is an internal API - meaning that only tracer should be calling it directly.\nThat should give us some control over the usage.\nAs for the initial question - the sampler periodical task is still running with a constant period.  Calling start() will just mark that particular thread as eligible for sampling - eg. add the thread ID to the list of thread IDs for which we request stack traces. So it is not really starting-stopping the profiler and the call frequency will impact only what is collected but has no real side-effects.", "author": "jbachorik", "createdAt": "2020-05-12T08:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzOTc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwMTk3NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r423901974", "bodyText": "Isn't this a race condition? I think you may potentially overwrite newly created live session with null.", "author": "mar-kolya", "createdAt": "2020-05-12T17:17:31Z", "path": "dd-java-agent/agent-profiling/profiling-controller/src/main/java/com/datadog/profiling/mlt/JMXSessionFactory.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package com.datadog.profiling.mlt;\n+\n+import datadog.trace.profiling.Session;\n+import datadog.trace.profiling.SessionFactory;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class JMXSessionFactory implements SessionFactory {\n+  private static final AtomicInteger refCount = new AtomicInteger();\n+  private static final AtomicReference<JMXSession> currentSession = new AtomicReference<>(null);\n+\n+  public Session createSession(Thread thread) {\n+    int prevCount = refCount.getAndIncrement();\n+    if (prevCount == 0) {\n+      currentSession.compareAndSet(null, new JMXSession(this, thread));\n+    }\n+    Session session = currentSession.get();\n+    session.addThread(thread);\n+    return session;\n+  }\n+\n+  void decCount() {\n+    int currentCount = refCount.decrementAndGet();\n+    if (currentCount == 0) {\n+      currentSession.set(null);", "originalCommit": "d81a2a1bc6d9e5a95dee5b8d60d7a7e427f6b78e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMDA4Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r423910087", "bodyText": "Indeed it is.\nAlso, calling JmxSession.close() is not idempotent since each call will decrement the counter and as such calls to createSession will not actually create a new session until it is called as many times as the previous closes :/\nAlso, the ref-counting is happening on a global level and it should be per-thread.\nIMO, the implementation should be a WeakMap<Thread, JMXSession> based and JMXSession should be doing the ref-counting via atomic counter. That should solve most if not all concurrency issues seen here.", "author": "jbachorik", "createdAt": "2020-05-12T17:30:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwMTk3NA=="}], "type": "inlineReview"}, {"oid": "d87e48b2638ae87c7c6a5c8dc108ff1a77e03217", "url": "https://github.com/DataDog/dd-trace-java/commit/d87e48b2638ae87c7c6a5c8dc108ff1a77e03217", "message": "Address JMX order load & concurrency issues", "committedDate": "2020-05-13T15:50:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1MTEwMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424551103", "bodyText": "Can this be simplified by having jmxSessions as ConcurrentHashMap?", "author": "jbachorik", "createdAt": "2020-05-13T15:57:43Z", "path": "dd-java-agent/agent-profiling/profiling-controller/src/main/java/com/datadog/profiling/mlt/JMXSessionFactory.java", "diffHunk": "@@ -2,27 +2,39 @@\n \n import datadog.trace.profiling.Session;\n import datadog.trace.profiling.SessionFactory;\n-import java.util.concurrent.atomic.AtomicInteger;\n-import java.util.concurrent.atomic.AtomicReference;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n \n public class JMXSessionFactory implements SessionFactory {\n-  private static final AtomicInteger refCount = new AtomicInteger();\n-  private static final AtomicReference<JMXSession> currentSession = new AtomicReference<>(null);\n+  private static final Map<Long, JMXSession> jmxSessions = new HashMap<>();\n+\n+  private final StackTraceSink sink;\n+\n+  public JMXSessionFactory(StackTraceSink sink) {\n+    this.sink = sink;\n+  }\n \n   public Session createSession(Thread thread) {\n-    int prevCount = refCount.getAndIncrement();\n-    if (prevCount == 0) {\n-      currentSession.compareAndSet(null, new JMXSession(this, thread));\n+    long id = thread.getId();\n+    JMXSession session;\n+    synchronized (jmxSessions) {\n+      session = jmxSessions.computeIfAbsent(id, this::newSession);", "originalCommit": "d87e48b2638ae87c7c6a5c8dc108ff1a77e03217", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1MjI4Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424552282", "bodyText": "I don't think so, because of the cleanup which iterates on thread ids and will generate a race condition if we starting a new session", "author": "jpbempel", "createdAt": "2020-05-13T15:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1MTEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1NDAyMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424554020", "bodyText": "Seems like the formatting tool messed this up a bit :)", "author": "jbachorik", "createdAt": "2020-05-13T16:01:42Z", "path": "internal-api/src/main/java/datadog/trace/profiling/Profiler.java", "diffHunk": "@@ -3,14 +3,16 @@\n import lombok.extern.slf4j.Slf4j;\n \n /**\n- * Entry point of the Profiling API to allow trigger sampling profiling on demand\n- * Example of usage:\n+ * Entry point of the Profiling API to allow trigger sampling profiling on demand Example of usage:", "originalCommit": "d87e48b2638ae87c7c6a5c8dc108ff1a77e03217", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "afd4fe07778c304d68b31af3a921c0d1c4330eef", "url": "https://github.com/DataDog/dd-trace-java/commit/afd4fe07778c304d68b31af3a921c0d1c4330eef", "message": "remove impl", "committedDate": "2020-05-13T16:36:02Z", "type": "commit"}, {"oid": "25038ec189770ab633d6075a82d238b18e9406f1", "url": "https://github.com/DataDog/dd-trace-java/commit/25038ec189770ab633d6075a82d238b18e9406f1", "message": "formatting", "committedDate": "2020-05-13T16:39:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4Mzk2OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424583968", "bodyText": "Do we need to pass in any metadata like trace/span id?", "author": "tylerbenson", "createdAt": "2020-05-13T16:47:06Z", "path": "internal-api/src/main/java/datadog/trace/profiling/Profiler.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package datadog.trace.profiling;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * Entry point of the Profiling API to allow trigger sampling profiling on demand Example of usage:\n+ *\n+ * <pre>\n+ *   try (Session session = Profiler.startProfiling()) {\n+ *     // ...\n+ *   }\n+ * </pre>\n+ *\n+ * or\n+ *\n+ * <pre>\n+ *   Session session = Profiler.startProfiling()\n+ *   // ... and into another method:\n+ *   session.close();\n+ * </pre>\n+ *\n+ * Nested calls are allowed but only outer calls will be effective\n+ */\n+@Slf4j\n+public class Profiler {\n+  private static volatile SessionFactory factory;\n+  private static final Session NO_SESSION = new NoSession();\n+\n+  /**\n+   * Starts a profiling session for the current thread\n+   *\n+   * @return an instance of profiling session\n+   */\n+  public static Session startProfiling() {", "originalCommit": "25038ec189770ab633d6075a82d238b18e9406f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxNjQ5Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424616492", "bodyText": "What is the type for those?", "author": "jpbempel", "createdAt": "2020-05-13T17:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4Mzk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwMjM5Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424702397", "bodyText": "Funny you should ask that... we use different representations internally depending on the context. (There's even a possibility that we change that: #1458)\nFor now, I'd suggest sticking with BigInteger.", "author": "tylerbenson", "createdAt": "2020-05-13T20:10:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4Mzk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczNTQ1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424735450", "bodyText": "We may want to use this for other kinds of contexts in the future, but perhaps cross that bridge when we have to? For now traceid and/or spanid should be enough. The implementation will basically record a special event with this context for the thread for the duration of the sampling.\nWhat is the internal representation for traceid/spanid? If they are sometimes strings, we might as well just accept strings. We'll basically have to convert them to strings in our events anyways (JFR has no native support for big integers).", "author": "thegreystone", "createdAt": "2020-05-13T21:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4Mzk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc0MDU3OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424740578", "bodyText": "I'd suggest exposing it as string then and we can do the conversion on our side.  We can likely do it more efficiently since we cache the serialization result.", "author": "tylerbenson", "createdAt": "2020-05-13T21:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4Mzk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1NDg2Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424954867", "bodyText": "done", "author": "jpbempel", "createdAt": "2020-05-14T08:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4Mzk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NDQxMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424584410", "bodyText": "I don't think we would ever use this since we wouldn't pass the session between threads.", "author": "tylerbenson", "createdAt": "2020-05-13T16:47:43Z", "path": "internal-api/src/main/java/datadog/trace/profiling/Session.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package datadog.trace.profiling;\n+\n+import java.io.Closeable;\n+\n+/** Represents the current profiling session Call close method to end the profiling session */\n+public interface Session extends Closeable {\n+\n+  /**\n+   * Adds a thread to be sampled for the current session\n+   *\n+   * @param thread additional thread to be sampled\n+   */\n+  void addThread(Thread thread);", "originalCommit": "25038ec189770ab633d6075a82d238b18e9406f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5NTExMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424595110", "bodyText": "I'd second that... is there any technical difference between 'multi-thread' session and multiple sessions, one per thread?", "author": "mar-kolya", "createdAt": "2020-05-13T17:04:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NDQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxNTg1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424615850", "bodyText": "I was thinking about one session for a trace and then adding thread for async calls, no?\nHow are you dealing with async calls?", "author": "jpbempel", "createdAt": "2020-05-13T17:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NDQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwMTA4MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424701081", "bodyText": "That would be a separate call to the api and an independent session.  Session would only be associated with a single thread since it's tied to a scope.", "author": "tylerbenson", "createdAt": "2020-05-13T20:08:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NDQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1NDY3MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r424954670", "bodyText": "done", "author": "jpbempel", "createdAt": "2020-05-14T08:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NDQxMA=="}], "type": "inlineReview"}, {"oid": "a4a42a05436d8798cdefa52729030937a2be1461", "url": "https://github.com/DataDog/dd-trace-java/commit/a4a42a05436d8798cdefa52729030937a2be1461", "message": "remove addThread and add id", "committedDate": "2020-05-14T08:20:06Z", "type": "commit"}, {"oid": "15b3a8742ed3210c75760a6f8dadd2dd99636a7c", "url": "https://github.com/DataDog/dd-trace-java/commit/15b3a8742ed3210c75760a6f8dadd2dd99636a7c", "message": "add package prefix", "committedDate": "2020-05-14T13:54:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE3MTEwNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r425171107", "bodyText": "This will be called through reflection during agent startup?\nIf yes, could you make this private (it kind of exposes the implementation detail) and just do setAccessible() before invoking it via reflection?\nIf it's not the usecase, please disregard this.", "author": "jbachorik", "createdAt": "2020-05-14T14:15:37Z", "path": "internal-api/src/main/java/datadog/trace/profiling/Profiler.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package datadog.trace.profiling;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * Entry point of the Profiling API to allow trigger sampling profiling on demand\n+ *\n+ * <p>Example of usage:\n+ *\n+ * <pre>\n+ *   try (Session session = Profiler.startProfiling(spanId)) {\n+ *     // ...\n+ *   }\n+ * </pre>\n+ *\n+ * or\n+ *\n+ * <pre>\n+ *   Session session = Profiler.startProfiling(spanId)\n+ *   // ... and into another method:\n+ *   session.close();\n+ * </pre>\n+ *\n+ * Nested calls are allowed but only outer calls will be effective\n+ */\n+@Slf4j\n+public class Profiler {\n+  private static volatile SessionFactory factory;\n+  private static final Session NO_SESSION = new NoSession();\n+\n+  /**\n+   * Starts a profiling session for the current thread\n+   *\n+   * @return an instance of profiling session\n+   */\n+  public static Session startProfiling(String id) {\n+    return startProfiling(id, Thread.currentThread());\n+  }\n+\n+  /**\n+   * Starts a profiling session for the specified thread\n+   *\n+   * @return an instance of profiling session\n+   */\n+  public static Session startProfiling(String id, Thread thread) {\n+    SessionFactory localFactory = factory;\n+    if (localFactory == null) {\n+      log.warn(\"Profiling session not initialized\");\n+      return NO_SESSION;\n+    }\n+    return localFactory.createSession(id, thread);\n+  }\n+\n+  /**\n+   * Initializes the Profiler API with an implementation through SessionFactory\n+   *\n+   * @param sessionFactory\n+   */\n+  public static void initialize(SessionFactory sessionFactory) {\n+    factory = sessionFactory;\n+  }", "originalCommit": "15b3a8742ed3210c75760a6f8dadd2dd99636a7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE3MzE5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1412#discussion_r425173199", "bodyText": "Ok, apparently this is called directly so the comment does not apply.", "author": "jbachorik", "createdAt": "2020-05-14T14:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE3MTEwNw=="}], "type": "inlineReview"}]}