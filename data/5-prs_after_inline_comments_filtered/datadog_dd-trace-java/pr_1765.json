{"pr_number": 1765, "pr_title": "mapadapter tweaks", "pr_createdAt": "2020-08-12T09:22:10Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1765", "timeline": [{"oid": "231e17ba33b8085d5da0c9d5394d438822710b77", "url": "https://github.com/DataDog/dd-trace-java/commit/231e17ba33b8085d5da0c9d5394d438822710b77", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground", "committedDate": "2020-08-12T09:27:48Z", "type": "forcePushed"}, {"oid": "7f7cc0912ebd778f83df2a170c2013607cf8f752", "url": "https://github.com/DataDog/dd-trace-java/commit/7f7cc0912ebd778f83df2a170c2013607cf8f752", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground", "committedDate": "2020-08-12T09:36:24Z", "type": "forcePushed"}, {"oid": "32f29a4c2214934be76975b41a2d702c53fb6ec4", "url": "https://github.com/DataDog/dd-trace-java/commit/32f29a4c2214934be76975b41a2d702c53fb6ec4", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground", "committedDate": "2020-08-12T09:50:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE2OTQ0Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#discussion_r469169442", "bodyText": "Spreading the synchronized. Nice.\nMaybe a comment about the & only working as expected since locks.length is a power of 2.\nOh, and looking at the WeakConcurrentMap it uses System.identityHashCode(key) and not key.hashCode(). I don't think that should cause any issues, since equality is also reference equality.", "author": "bantonsson", "createdAt": "2020-08-12T10:44:12Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/WeakMapSuppliers.java", "diffHunk": "@@ -92,36 +100,28 @@ public void putIfAbsent(final K key, final V value) {\n \n       @Override\n       public V computeIfAbsent(final K key, final ValueSupplier<? super K, ? extends V> supplier) {\n-        if (map.containsKey(key)) {\n-          return map.get(key);\n-        }\n-\n-        synchronized (this) {\n-          if (map.containsKey(key)) {\n-            return map.get(key);\n-          } else {\n-            final V value = supplier.get(key);\n-\n-            map.put(key, value);\n-            return value;\n+        // We can't use computeIfAbsent since it was added in 1.8.\n+        V value = map.get(key);\n+        if (null == value) {\n+          int bucket = key.hashCode() & (locks.length - 1);\n+          synchronized (locks[bucket]) {", "originalCommit": "32f29a4c2214934be76975b41a2d702c53fb6ec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE4ODEzOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#discussion_r469188138", "bodyText": "The aim here is to linearise a sequence of non-atomic operations on the same key, so which hash code is used shouldn't matter, even though the object's hash code is coarser than its identity hash code (also, an identity hash code won't spread well modulo 16 since I believe it's derived from an aligned native address), and this just happens to be less coarse than synchronized(this) except in degenerate cases.", "author": "richardstartin", "createdAt": "2020-08-12T11:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE2OTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNDU2Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#discussion_r469224562", "bodyText": "I am investigating if this is causing the test failures.", "author": "richardstartin", "createdAt": "2020-08-12T12:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE2OTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNzE1MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#discussion_r469237151", "bodyText": "I don't think the error came from the lock striping but possibly from the semantics of WeakMap. Will put the striping back in now.", "author": "richardstartin", "createdAt": "2020-08-12T12:54:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE2OTQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE3ODM4MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#discussion_r469178381", "bodyText": "I'm not sure that I follow this comment. This is a WeakMap from ClassLoader to ConcurrentHashMap. What is synchronized in this?", "author": "bantonsson", "createdAt": "2020-08-12T11:02:51Z", "path": "dd-java-agent/instrumentation/netty-4.0/src/main/java/datadog/trace/instrumentation/netty40/AttributeKeys.java", "diffHunk": "@@ -10,8 +10,9 @@\n import java.util.concurrent.ConcurrentMap;\n \n public class AttributeKeys {\n+  // TODO why are we using what is essentially a synchronized hashmap here?", "originalCommit": "32f29a4c2214934be76975b41a2d702c53fb6ec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE4NTUzNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#discussion_r469185535", "bodyText": "If you look at the implementation, it's not what you might have hoped for:\n  interface Implementation {\n    <K, V> WeakMap<K, V> get();\n\n    Implementation DEFAULT = new Default();\n\n    @Slf4j\n    class Default implements Implementation {\n\n      @Override\n      public <K, V> WeakMap<K, V> get() {\n        log.debug(\"WeakMap.Supplier not registered. Returning a synchronized WeakHashMap.\");\n        return new MapAdapter<>(Collections.synchronizedMap(new WeakHashMap<K, V>()));\n      }\n    }\n  }", "author": "richardstartin", "createdAt": "2020-08-12T11:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE3ODM4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIxMzk3NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#discussion_r469213975", "bodyText": "Doh! I missed that it was using WeakMap.Implementation.DEFAULT.get()", "author": "bantonsson", "createdAt": "2020-08-12T12:17:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE3ODM4MQ=="}], "type": "inlineReview"}, {"oid": "f07ef1e23afec1cebe7cdd330ad2ab1d56342bf8", "url": "https://github.com/DataDog/dd-trace-java/commit/f07ef1e23afec1cebe7cdd330ad2ab1d56342bf8", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground", "committedDate": "2020-08-12T12:40:49Z", "type": "forcePushed"}, {"oid": "a918019e87476b350a95a19ced8e593716d09c10", "url": "https://github.com/DataDog/dd-trace-java/commit/a918019e87476b350a95a19ced8e593716d09c10", "message": "finer grained synchronisation", "committedDate": "2020-08-12T14:03:23Z", "type": "commit"}, {"oid": "a918019e87476b350a95a19ced8e593716d09c10", "url": "https://github.com/DataDog/dd-trace-java/commit/a918019e87476b350a95a19ced8e593716d09c10", "message": "finer grained synchronisation", "committedDate": "2020-08-12T14:03:23Z", "type": "forcePushed"}]}