{"pr_number": 1728, "pr_title": "haystack/datadog context propagation", "pr_createdAt": "2020-07-31T09:30:48Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1728", "timeline": [{"oid": "fd556f7594ade2a88f0dbdfe93c4ac2ba70b7f40", "url": "https://github.com/DataDog/dd-trace-java/commit/fd556f7594ade2a88f0dbdfe93c4ac2ba70b7f40", "message": "Converted Haystack support to use UUID/Hex ID format", "committedDate": "2020-07-19T17:21:50Z", "type": "commit"}, {"oid": "d74b73310469d1f55291132185fff01f826ccb37", "url": "https://github.com/DataDog/dd-trace-java/commit/d74b73310469d1f55291132185fff01f826ccb37", "message": "Added support for Haystack ID extraction from Baggage on proxy calls", "committedDate": "2020-07-19T17:23:58Z", "type": "commit"}, {"oid": "2161fccf267acceed1d84bb4fffebdbb8b3071ac", "url": "https://github.com/DataDog/dd-trace-java/commit/2161fccf267acceed1d84bb4fffebdbb8b3071ac", "message": "Added debug logging of the injected codec platform trace id", "committedDate": "2020-07-19T17:24:57Z", "type": "commit"}, {"oid": "bfdba3ac3dc2aec38a4f409216b627bb47cbd0da", "url": "https://github.com/DataDog/dd-trace-java/commit/bfdba3ac3dc2aec38a4f409216b627bb47cbd0da", "message": "Added Haystack-Trace-ID tag to outbound calls", "committedDate": "2020-07-19T17:24:57Z", "type": "commit"}, {"oid": "c08d5795bcdfe0a9570561c84324f43e3ae6614c", "url": "https://github.com/DataDog/dd-trace-java/commit/c08d5795bcdfe0a9570561c84324f43e3ae6614c", "message": "Converted Haystack tests & codec to use DDId", "committedDate": "2020-07-19T18:01:31Z", "type": "commit"}, {"oid": "ce60ff8e8dcdfcf26e54cf7e7024af90e43068c5", "url": "https://github.com/DataDog/dd-trace-java/commit/ce60ff8e8dcdfcf26e54cf7e7024af90e43068c5", "message": "Added parent id check", "committedDate": "2020-07-20T13:36:57Z", "type": "commit"}, {"oid": "6e7d84447eb4e52278cafb03a724b25141a68526", "url": "https://github.com/DataDog/dd-trace-java/commit/6e7d84447eb4e52278cafb03a724b25141a68526", "message": "Applied spotlessApply ;)", "committedDate": "2020-07-20T13:51:34Z", "type": "commit"}, {"oid": "a4440019677dbd43e93c51b61c9f32f76746429a", "url": "https://github.com/DataDog/dd-trace-java/commit/a4440019677dbd43e93c51b61c9f32f76746429a", "message": "Merge branch 'master' into haystack", "committedDate": "2020-07-31T09:27:13Z", "type": "commit"}, {"oid": "6302ccd6f5084e0340ec106f36fc42ceb5d8f3eb", "url": "https://github.com/DataDog/dd-trace-java/commit/6302ccd6f5084e0340ec106f36fc42ceb5d8f3eb", "message": "fix up small differences post merge", "committedDate": "2020-07-31T09:28:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjU4Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1728#discussion_r463906586", "bodyText": "Given this no longer deals with BigInteger, should we rename to convertDDIdToUUID?", "author": "aantono", "createdAt": "2020-08-01T02:00:11Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/propagation/HaystackHttpCodec.java", "diffHunk": "@@ -139,9 +199,52 @@ public boolean accept(String key, String value) {\n       return true;\n     }\n \n+    private void addBaggageItem(String key, String value) {\n+      if (baggage.isEmpty()) {\n+        baggage = new TreeMap<>();\n+      }\n+      baggage.put(key, HttpCodec.decode(value));\n+    }\n+\n     @Override\n     protected int defaultSamplingPriority() {\n       return PrioritySampling.SAMPLER_KEEP;\n     }\n   }\n+\n+  private static String convertBigIntToUUID(DDId id) {", "originalCommit": "6302ccd6f5084e0340ec106f36fc42ceb5d8f3eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjY5Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1728#discussion_r463906692", "bodyText": "Given this no longer deals with BigInteger, should we rename to convertUUIDToDDId?", "author": "aantono", "createdAt": "2020-08-01T02:01:13Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/propagation/HaystackHttpCodec.java", "diffHunk": "@@ -139,9 +199,52 @@ public boolean accept(String key, String value) {\n       return true;\n     }\n \n+    private void addBaggageItem(String key, String value) {\n+      if (baggage.isEmpty()) {\n+        baggage = new TreeMap<>();\n+      }\n+      baggage.put(key, HttpCodec.decode(value));\n+    }\n+\n     @Override\n     protected int defaultSamplingPriority() {\n       return PrioritySampling.SAMPLER_KEEP;\n     }\n   }\n+\n+  private static String convertBigIntToUUID(DDId id) {\n+    // This is not a true/real UUID, as we don't care about the version and variant markers\n+    //  the creation is just taking the least significant bits and doing static most significant\n+    // ones.\n+    //  this is done for the purpose of being able to maintain cardinality and idempotence of the\n+    // conversion\n+    String idHex = String.format(\"%016x\", id.toLong());\n+    return DATADOG + \"-\" + idHex.substring(0, 4) + \"-\" + idHex.substring(4);\n+  }\n+\n+  private static DDId convertUUIDToBigInt(String value) {", "originalCommit": "6302ccd6f5084e0340ec106f36fc42ceb5d8f3eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjkzOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1728#discussion_r463906938", "bodyText": "Is there a particular appropriate convention for tag names that\u2019s used within DD ecosystem, to make sure the tag names are compliant here and in other places?\n(Also, do we want to add the same tags of original ids in Zipkin codec as well?)", "author": "aantono", "createdAt": "2020-08-01T02:03:45Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/propagation/HaystackHttpCodec.java", "diffHunk": "@@ -32,14 +44,54 @@ private HaystackHttpCodec() {\n     @Override\n     public <C> void inject(\n         final DDSpanContext context, final C carrier, final AgentPropagation.Setter<C> setter) {\n-      setter.set(carrier, TRACE_ID_KEY, context.getTraceId().toString());\n-      setter.set(carrier, SPAN_ID_KEY, context.getSpanId().toString());\n-      setter.set(carrier, PARENT_ID_KEY, context.getParentId().toString());\n+      try {\n+        // Given that Haystack uses a 128-bit UUID/GUID for all ID representations, need to convert\n+        // from 64-bit BigInteger\n+        //  also record the original DataDog IDs into Baggage payload\n+        //\n+        // If the original trace has originated within Haystack system and we have it saved in\n+        // Baggage, and it is equal\n+        //  to the converted value in BigInteger, use that instead.\n+        //  this will preserve the complete UUID/GUID without losing the most significant bit part\n+        String originalHaystackTraceId =\n+            getBaggageItemIgnoreCase(context.getBaggageItems(), HAYSTACK_TRACE_ID_BAGGAGE_KEY);\n+        String injectedTraceId;\n+        if (originalHaystackTraceId != null\n+            && convertUUIDToBigInt(originalHaystackTraceId).equals(context.getTraceId())) {\n+          injectedTraceId = originalHaystackTraceId;\n+        } else {\n+          injectedTraceId = convertBigIntToUUID(context.getTraceId());\n+        }\n+        setter.set(carrier, TRACE_ID_KEY, injectedTraceId);\n+        context.setTag(HAYSTACK_TRACE_ID_BAGGAGE_KEY, injectedTraceId);", "originalCommit": "6302ccd6f5084e0340ec106f36fc42ceb5d8f3eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}