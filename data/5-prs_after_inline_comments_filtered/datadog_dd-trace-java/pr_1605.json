{"pr_number": 1605, "pr_title": "Experimental instrumentation for the OpenTelemetry Tracing API", "pr_createdAt": "2020-06-18T20:13:09Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1605", "timeline": [{"oid": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "url": "https://github.com/DataDog/dd-trace-java/commit/74e90dd6b636c73f437731cafb2c1c13e7805c82", "message": "Experimental instrumentation for the OpenTelemetry Tracing API\n\nThis can be used as an alternative to OpenTracing for custom instrumentation.\n\nThe integration works by hijacking the `OpenTelemetry.getTracerProvider` and `OpenTelemetry.getPropagators` method return values and replacing it with our own.\n\nTo enable:\n* System Property: `-Ddd.integration.opentelemetry-beta.enabled=true`\n* Environment Variable: `DD_INTEGRATION_OPENTELEMETRY_BETA_ENABLED=true`\n\nThe actual mapping semantics are subject to change as the API matures.\n\nEvents are completely ignored as there's no analogous feature in Datadog APM. This also won't impact the existing MeterProvider.", "committedDate": "2020-06-18T20:09:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3ODY1Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442478656", "bodyText": "A matching private constructor would be good", "author": "devinsba", "createdAt": "2020-06-18T20:16:28Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelContextPropagators.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentPropagation;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import io.grpc.Context;\n+import io.opentelemetry.context.propagation.ContextPropagators;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class OtelContextPropagators implements ContextPropagators {\n+  public static final OtelContextPropagators INSTANCE = new OtelContextPropagators();", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3OTEyOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442979128", "bodyText": "Yes, and make this final as well.", "author": "dougqh", "createdAt": "2020-06-19T18:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3ODY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4MjUxMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442482512", "bodyText": "Doesn't this depend on the type of span? IE: a client sees 400 as an error where a server doesn't", "author": "devinsba", "createdAt": "2020-06-18T20:24:52Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelSpan.java", "diffHunk": "@@ -0,0 +1,223 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.api.DDTags;\n+import datadog.trace.api.interceptor.MutableSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.opentelemetry.common.AttributeValue;\n+import io.opentelemetry.trace.EndSpanOptions;\n+import io.opentelemetry.trace.Event;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.Status;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OtelSpan implements Span, MutableSpan {\n+  private final AgentSpan delegate;\n+  private final TypeConverter converter;\n+\n+  public OtelSpan(final AgentSpan agentSpan, final TypeConverter typeConverter) {\n+    delegate = agentSpan;\n+    converter = typeConverter;\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final String value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final long value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final double value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final boolean value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final AttributeValue value) {\n+    switch (value.getType()) {\n+      case LONG:\n+        delegate.setTag(key, value.getLongValue());\n+        break;\n+      case DOUBLE:\n+        delegate.setTag(key, value.getDoubleValue());\n+        break;\n+      case STRING:\n+        delegate.setTag(key, value.getStringValue());\n+        break;\n+      case BOOLEAN:\n+        delegate.setTag(key, value.getBooleanValue());\n+        break;\n+      default:\n+        // Unsupported.... Ignoring.\n+    }\n+  }\n+\n+  @Override\n+  public void addEvent(final String name) {}\n+\n+  @Override\n+  public void addEvent(final String name, final long timestamp) {}\n+\n+  @Override\n+  public void addEvent(final String name, final Map<String, AttributeValue> attributes) {}\n+\n+  @Override\n+  public void addEvent(\n+      final String name, final Map<String, AttributeValue> attributes, final long timestamp) {}\n+\n+  @Override\n+  public void addEvent(final Event event) {}\n+\n+  @Override\n+  public void addEvent(final Event event, final long timestamp) {}\n+\n+  @Override\n+  public void setStatus(final Status status) {\n+    if (!status.isOk()) {\n+      delegate.setError(true);", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMTgxMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442911813", "bodyText": "This isn't the regular http status codes... this is an OTel specific Status (more similar to grpc) https://github.com/open-telemetry/opentelemetry-java/blob/master/api/src/main/java/io/opentelemetry/trace/Status.java", "author": "tylerbenson", "createdAt": "2020-06-19T15:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4MjUxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4MzI2NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442483265", "bodyText": "We should probably cache this instead of returning a new one everytime to protect from bad instrumentation", "author": "devinsba", "createdAt": "2020-06-18T20:26:25Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelTracerProvider.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import io.opentelemetry.trace.Tracer;\n+import io.opentelemetry.trace.TracerProvider;\n+\n+public class OtelTracerProvider implements TracerProvider {\n+  public static final OtelTracerProvider INSTANCE = new OtelTracerProvider();\n+\n+  private final TypeConverter converter = new TypeConverter();\n+\n+  @Override\n+  public Tracer get(final String instrumentationName) {\n+    return get(instrumentationName, null);\n+  }\n+\n+  @Override\n+  public Tracer get(final String instrumentationName, final String instrumentationVersion) {\n+    return new OtelTracer(instrumentationName, AgentTracer.get(), converter);", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxNDc2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442914760", "bodyText": "There's a nice very low overhead cache on #1603, maybe we can use that once that's merged, but merge this without implementing caching yet?", "author": "richardstartin", "createdAt": "2020-06-19T15:46:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4MzI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3OTk1NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442979954", "bodyText": "I added a todo.", "author": "tylerbenson", "createdAt": "2020-06-19T18:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4MzI2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5MzQxNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442693416", "bodyText": "Could we move away from having lots of small nested classes with long names?", "author": "richardstartin", "createdAt": "2020-06-19T08:01:04Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OpenTelemetryInstrumentation.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import io.opentelemetry.context.propagation.ContextPropagators;\n+import io.opentelemetry.trace.TracerProvider;\n+import java.util.HashMap;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+/**\n+ * This is experimental instrumentation and should only be enabled for evaluation/testing purposes.\n+ */\n+@AutoService(Instrumenter.class)\n+public class OpenTelemetryInstrumentation extends Instrumenter.Default {\n+  public OpenTelemetryInstrumentation() {\n+    super(\"opentelemetry-beta\");\n+  }\n+\n+  @Override\n+  protected boolean defaultEnabled() {\n+    return false;\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return named(\"io.opentelemetry.OpenTelemetry\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\n+      packageName + \".OtelScope\",\n+      packageName + \".OtelSpan\",\n+      packageName + \".OtelSpan$1\", // switch statement\n+      packageName + \".OtelSpanContext\",\n+      packageName + \".OtelTracer\",\n+      packageName + \".OtelTracer$1\", // switch statement\n+      packageName + \".OtelTracerProvider\",\n+      packageName + \".OtelTracer$SpanBuilder\",\n+      packageName + \".OtelContextPropagators\",\n+      packageName + \".OtelContextPropagators$1\", // switch statement\n+      packageName + \".OtelContextPropagators$OtelHttpTextFormat\",\n+      packageName + \".OtelContextPropagators$OtelSetter\",\n+      packageName + \".OtelContextPropagators$OtelGetter\",\n+      packageName + \".TypeConverter\",\n+    };\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    final Map<ElementMatcher<? super MethodDescription>, String> transformers = new HashMap<>();\n+    transformers.put(\n+        named(\"getTracerProvider\").and(returns(named(\"io.opentelemetry.trace.TracerProvider\"))),\n+        OpenTelemetryInstrumentation.class.getName() + \"$TracerProviderAdvice\");\n+    transformers.put(\n+        named(\"getPropagators\")\n+            .and(returns(named(\"io.opentelemetry.context.propagation.ContextPropagators\"))),\n+        OpenTelemetryInstrumentation.class.getName() + \"$ContextPropagatorsAdvice\");\n+    return transformers;\n+  }\n+\n+  public static class TracerProviderAdvice {", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0NjEzMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442946132", "bodyText": "This should be a separate discussion and done in a consistent fashion.  Meanwhile, this is consistent with the rest of the repo style.", "author": "tylerbenson", "createdAt": "2020-06-19T16:48:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5MzQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNTIwMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442705200", "bodyText": "The thing about iterating over the keys and then checking for each possible thing that we care about it is that it's quadratic time and works against pretty much every HTTP API which presents headers to you as a HashMap. Maybe it makes sense not to encourage users to consume headers the way we do?", "author": "richardstartin", "createdAt": "2020-06-19T08:25:01Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelContextPropagators.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentPropagation;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import io.grpc.Context;\n+import io.opentelemetry.context.propagation.ContextPropagators;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class OtelContextPropagators implements ContextPropagators {\n+  public static final OtelContextPropagators INSTANCE = new OtelContextPropagators();\n+\n+  @Override\n+  public HttpTextFormat getHttpTextFormat() {\n+    return OtelHttpTextFormat.INSTANCE;\n+  }\n+\n+  private static class OtelHttpTextFormat implements HttpTextFormat {\n+    private static final OtelHttpTextFormat INSTANCE = new OtelHttpTextFormat();\n+\n+    private final AgentTracer.TracerAPI tracer = AgentTracer.get();\n+    private final TypeConverter converter = new TypeConverter();\n+\n+    @Override\n+    public List<String> fields() {\n+      return null;\n+    }\n+\n+    @Override\n+    public <C> void inject(final Context context, final C carrier, final Setter<C> setter) {\n+      final Span span = TracingContextUtils.getSpanWithoutDefault(context);\n+      if (span == null || !span.getContext().isValid()) {\n+        return;\n+      }\n+      tracer.inject(converter.toAgentSpan(span), carrier, new OtelSetter<>(setter));\n+    }\n+\n+    @Override\n+    public <C> Context extract(final Context context, final C carrier, final Getter<C> getter) {\n+      final AgentSpan.Context agentContext = tracer.extract(carrier, new OtelGetter<>(getter));\n+      return TracingContextUtils.withSpan(\n+          DefaultSpan.create(converter.toSpanContext(agentContext)), context);\n+    }\n+  }\n+\n+  private static class OtelSetter<C> implements AgentPropagation.Setter<C> {\n+    private final HttpTextFormat.Setter<C> setter;\n+\n+    private OtelSetter(final HttpTextFormat.Setter<C> setter) {\n+      this.setter = setter;\n+    }\n+\n+    @Override\n+    public void set(final C carrier, final String key, final String value) {\n+      setter.set(carrier, key, value);\n+    }\n+  }\n+\n+  private static class OtelGetter<C> implements AgentPropagation.Getter<C> {\n+    private static final String DD_TRACE_ID_KEY = \"x-datadog-trace-id\";\n+    private static final String DD_SPAN_ID_KEY = \"x-datadog-parent-id\";\n+    private static final String DD_SAMPLING_PRIORITY_KEY = \"x-datadog-sampling-priority\";\n+    private static final String DD_ORIGIN_KEY = \"x-datadog-origin\";\n+\n+    private static final String B3_TRACE_ID_KEY = \"X-B3-TraceId\";\n+    private static final String B3_SPAN_ID_KEY = \"X-B3-SpanId\";\n+    private static final String B3_SAMPLING_PRIORITY_KEY = \"X-B3-Sampled\";\n+\n+    private static final String HAYSTACK_TRACE_ID_KEY = \"Trace-ID\";\n+    private static final String HAYSTACK_SPAN_ID_KEY = \"Span-ID\";\n+    private static final String HAYSTACK_PARENT_ID_KEY = \"Parent_ID\";\n+\n+    private static final List<String> KEYS =\n+        Arrays.asList(\n+            DD_TRACE_ID_KEY,\n+            DD_SPAN_ID_KEY,\n+            DD_SAMPLING_PRIORITY_KEY,\n+            DD_ORIGIN_KEY,\n+            B3_TRACE_ID_KEY,\n+            B3_SPAN_ID_KEY,\n+            B3_SAMPLING_PRIORITY_KEY,\n+            HAYSTACK_TRACE_ID_KEY,\n+            HAYSTACK_SPAN_ID_KEY,\n+            HAYSTACK_PARENT_ID_KEY);\n+\n+    private final HttpTextFormat.Getter<C> getter;\n+\n+    private OtelGetter(final HttpTextFormat.Getter<C> getter) {\n+      this.getter = getter;\n+    }\n+\n+    @Override\n+    public Iterable<String> keys(final C carrier) {\n+      // TODO: Otel doesn't expose the keys, so we have to rely on hard coded keys.", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMzQyOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442913428", "bodyText": "I figured you'd appreciate this... the problem is it doesn't work with baggage which relies on a prefix.", "author": "tylerbenson", "createdAt": "2020-06-19T15:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNTIwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2ODE0Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442968143", "bodyText": "Then that's a design flaw in the codec", "author": "richardstartin", "createdAt": "2020-06-19T17:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNTIwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNTQ2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442705460", "bodyText": "Perhaps we should be aiming to use this more since every HTTP API can do this quickly.", "author": "richardstartin", "createdAt": "2020-06-19T08:25:31Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelContextPropagators.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentPropagation;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import io.grpc.Context;\n+import io.opentelemetry.context.propagation.ContextPropagators;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class OtelContextPropagators implements ContextPropagators {\n+  public static final OtelContextPropagators INSTANCE = new OtelContextPropagators();\n+\n+  @Override\n+  public HttpTextFormat getHttpTextFormat() {\n+    return OtelHttpTextFormat.INSTANCE;\n+  }\n+\n+  private static class OtelHttpTextFormat implements HttpTextFormat {\n+    private static final OtelHttpTextFormat INSTANCE = new OtelHttpTextFormat();\n+\n+    private final AgentTracer.TracerAPI tracer = AgentTracer.get();\n+    private final TypeConverter converter = new TypeConverter();\n+\n+    @Override\n+    public List<String> fields() {\n+      return null;\n+    }\n+\n+    @Override\n+    public <C> void inject(final Context context, final C carrier, final Setter<C> setter) {\n+      final Span span = TracingContextUtils.getSpanWithoutDefault(context);\n+      if (span == null || !span.getContext().isValid()) {\n+        return;\n+      }\n+      tracer.inject(converter.toAgentSpan(span), carrier, new OtelSetter<>(setter));\n+    }\n+\n+    @Override\n+    public <C> Context extract(final Context context, final C carrier, final Getter<C> getter) {\n+      final AgentSpan.Context agentContext = tracer.extract(carrier, new OtelGetter<>(getter));\n+      return TracingContextUtils.withSpan(\n+          DefaultSpan.create(converter.toSpanContext(agentContext)), context);\n+    }\n+  }\n+\n+  private static class OtelSetter<C> implements AgentPropagation.Setter<C> {\n+    private final HttpTextFormat.Setter<C> setter;\n+\n+    private OtelSetter(final HttpTextFormat.Setter<C> setter) {\n+      this.setter = setter;\n+    }\n+\n+    @Override\n+    public void set(final C carrier, final String key, final String value) {\n+      setter.set(carrier, key, value);\n+    }\n+  }\n+\n+  private static class OtelGetter<C> implements AgentPropagation.Getter<C> {\n+    private static final String DD_TRACE_ID_KEY = \"x-datadog-trace-id\";\n+    private static final String DD_SPAN_ID_KEY = \"x-datadog-parent-id\";\n+    private static final String DD_SAMPLING_PRIORITY_KEY = \"x-datadog-sampling-priority\";\n+    private static final String DD_ORIGIN_KEY = \"x-datadog-origin\";\n+\n+    private static final String B3_TRACE_ID_KEY = \"X-B3-TraceId\";\n+    private static final String B3_SPAN_ID_KEY = \"X-B3-SpanId\";\n+    private static final String B3_SAMPLING_PRIORITY_KEY = \"X-B3-Sampled\";\n+\n+    private static final String HAYSTACK_TRACE_ID_KEY = \"Trace-ID\";\n+    private static final String HAYSTACK_SPAN_ID_KEY = \"Span-ID\";\n+    private static final String HAYSTACK_PARENT_ID_KEY = \"Parent_ID\";\n+\n+    private static final List<String> KEYS =\n+        Arrays.asList(\n+            DD_TRACE_ID_KEY,\n+            DD_SPAN_ID_KEY,\n+            DD_SAMPLING_PRIORITY_KEY,\n+            DD_ORIGIN_KEY,\n+            B3_TRACE_ID_KEY,\n+            B3_SPAN_ID_KEY,\n+            B3_SAMPLING_PRIORITY_KEY,\n+            HAYSTACK_TRACE_ID_KEY,\n+            HAYSTACK_SPAN_ID_KEY,\n+            HAYSTACK_PARENT_ID_KEY);\n+\n+    private final HttpTextFormat.Getter<C> getter;\n+\n+    private OtelGetter(final HttpTextFormat.Getter<C> getter) {\n+      this.getter = getter;\n+    }\n+\n+    @Override\n+    public Iterable<String> keys(final C carrier) {\n+      // TODO: Otel doesn't expose the keys, so we have to rely on hard coded keys.\n+      // https://github.com/open-telemetry/opentelemetry-specification/issues/433\n+      return KEYS;\n+    }\n+\n+    @Override\n+    public String get(final C carrier, final String key) {\n+      return getter.get(carrier, key);", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNTc5Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442705796", "bodyText": "Scopes all the way down?", "author": "richardstartin", "createdAt": "2020-06-19T08:26:12Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelScope.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.context.TraceScope;\n+import io.opentelemetry.context.Scope;\n+\n+public class OtelScope implements Scope, TraceScope {\n+  private final AgentScope delegate;", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0NjY3MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442946671", "bodyText": "It's a wrapper/bridge class... similar to what is done in the opentracing instrumentation.", "author": "tylerbenson", "createdAt": "2020-06-19T16:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNTc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNjYzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442706630", "bodyText": "Which timezone? Is there a guarantee it's UTC?", "author": "richardstartin", "createdAt": "2020-06-19T08:27:54Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelSpan.java", "diffHunk": "@@ -0,0 +1,223 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.api.DDTags;\n+import datadog.trace.api.interceptor.MutableSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.opentelemetry.common.AttributeValue;\n+import io.opentelemetry.trace.EndSpanOptions;\n+import io.opentelemetry.trace.Event;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.Status;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OtelSpan implements Span, MutableSpan {\n+  private final AgentSpan delegate;\n+  private final TypeConverter converter;\n+\n+  public OtelSpan(final AgentSpan agentSpan, final TypeConverter typeConverter) {\n+    delegate = agentSpan;\n+    converter = typeConverter;\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final String value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final long value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final double value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final boolean value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final AttributeValue value) {\n+    switch (value.getType()) {\n+      case LONG:\n+        delegate.setTag(key, value.getLongValue());\n+        break;\n+      case DOUBLE:\n+        delegate.setTag(key, value.getDoubleValue());\n+        break;\n+      case STRING:\n+        delegate.setTag(key, value.getStringValue());\n+        break;\n+      case BOOLEAN:\n+        delegate.setTag(key, value.getBooleanValue());\n+        break;\n+      default:\n+        // Unsupported.... Ignoring.\n+    }\n+  }\n+\n+  @Override\n+  public void addEvent(final String name) {}\n+\n+  @Override\n+  public void addEvent(final String name, final long timestamp) {}\n+\n+  @Override\n+  public void addEvent(final String name, final Map<String, AttributeValue> attributes) {}\n+\n+  @Override\n+  public void addEvent(\n+      final String name, final Map<String, AttributeValue> attributes, final long timestamp) {}\n+\n+  @Override\n+  public void addEvent(final Event event) {}\n+\n+  @Override\n+  public void addEvent(final Event event, final long timestamp) {}\n+\n+  @Override\n+  public void setStatus(final Status status) {\n+    if (!status.isOk()) {\n+      delegate.setError(true);\n+      delegate.setTag(DDTags.ERROR_MSG, status.getDescription());\n+    }\n+  }\n+\n+  @Override\n+  public void updateName(final String name) {\n+    delegate.setResourceName(name);\n+  }\n+\n+  @Override\n+  public void end() {\n+    delegate.finish();\n+  }\n+\n+  @Override\n+  public void end(final EndSpanOptions endOptions) {\n+    if (endOptions.getEndTimestamp() > 0) {\n+      delegate.finish(TimeUnit.NANOSECONDS.toMicros(endOptions.getEndTimestamp()));", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0NzUyMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442947520", "bodyText": "I'm actually not sure... I think it fully depends on what the user provides which we can't control.", "author": "tylerbenson", "createdAt": "2020-06-19T16:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNjYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2ODg0NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442968844", "bodyText": "It doesn't make sense to compare timestamps taken relative to different clocks, so whoever computes durations needs to be in control of the clocks.", "author": "richardstartin", "createdAt": "2020-06-19T17:41:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNjYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwODU3NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442708574", "bodyText": "if (span instanceof OtelSpan) {\n      return ((OtelSpan) span).getDelegate();\n    }\n    return null == span ? null : AgentTracer.NoopAgentSpan.INSTANCE;", "author": "richardstartin", "createdAt": "2020-06-19T08:31:37Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/TypeConverter.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.SpanContext;\n+\n+// Centralized place to do conversions\n+public class TypeConverter {\n+  // TODO maybe add caching to reduce new objects being created\n+\n+  public AgentSpan toAgentSpan(final Span span) {\n+    if (span == null) {", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwOTUwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r442709509", "bodyText": "if (spanContext instanceof OtelSpanContext) {\n      return ((OtelSpanContext) spanContext).getDelegate();\n    } \n    return null == spanContext ? null : AgentTracer.NoopContext.INSTANCE;", "author": "richardstartin", "createdAt": "2020-06-19T08:33:27Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/TypeConverter.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.SpanContext;\n+\n+// Centralized place to do conversions\n+public class TypeConverter {\n+  // TODO maybe add caching to reduce new objects being created\n+\n+  public AgentSpan toAgentSpan(final Span span) {\n+    if (span == null) {\n+      return null;\n+    } else if (span instanceof OtelSpan) {\n+      return ((OtelSpan) span).getDelegate();\n+    } else {\n+      // NOOP Span, otherwise arbitrary spans aren't supported.\n+      return AgentTracer.NoopAgentSpan.INSTANCE;\n+    }\n+  }\n+\n+  public Span toSpan(final AgentSpan agentSpan) {\n+    if (agentSpan == null) {\n+      return null;\n+    }\n+    return new OtelSpan(agentSpan, this);\n+  }\n+\n+  public Scope toScope(final AgentScope scope) {\n+    if (scope == null) {\n+      return null;\n+    }\n+    return new OtelScope(scope);\n+  }\n+\n+  public SpanContext toSpanContext(final AgentSpan.Context context) {\n+    if (context == null) {\n+      return null;\n+    }\n+    return new OtelSpanContext(context);\n+  }\n+\n+  public AgentSpan.Context toContext(final SpanContext spanContext) {\n+    if (spanContext == null) {", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf7fac3afd0753cd291e882956ce71457a9e4b9b", "url": "https://github.com/DataDog/dd-trace-java/commit/bf7fac3afd0753cd291e882956ce71457a9e4b9b", "message": "Review changes", "committedDate": "2020-06-19T17:03:03Z", "type": "commit"}, {"oid": "a0517bccba0f46ed7fdc517d01f6b1cf4589b292", "url": "https://github.com/DataDog/dd-trace-java/commit/a0517bccba0f46ed7fdc517d01f6b1cf4589b292", "message": "Add cleanupSpec for beta system properties", "committedDate": "2020-06-19T17:04:23Z", "type": "commit"}, {"oid": "b190956ab842d3b74d1da3ae920e847c27aa5dd3", "url": "https://github.com/DataDog/dd-trace-java/commit/b190956ab842d3b74d1da3ae920e847c27aa5dd3", "message": "Separate out test cases better.", "committedDate": "2020-06-19T17:42:44Z", "type": "commit"}, {"oid": "1ac044ce3926ba0859eea18523b100ce4257e0c9", "url": "https://github.com/DataDog/dd-trace-java/commit/1ac044ce3926ba0859eea18523b100ce4257e0c9", "message": "Fix test", "committedDate": "2020-06-22T21:03:18Z", "type": "commit"}, {"oid": "1ac044ce3926ba0859eea18523b100ce4257e0c9", "url": "https://github.com/DataDog/dd-trace-java/commit/1ac044ce3926ba0859eea18523b100ce4257e0c9", "message": "Fix test", "committedDate": "2020-06-22T21:03:18Z", "type": "forcePushed"}, {"oid": "0f9bbbc3bdcb89d34392d3b7bcb06ad005a6ee6c", "url": "https://github.com/DataDog/dd-trace-java/commit/0f9bbbc3bdcb89d34392d3b7bcb06ad005a6ee6c", "message": "Revert \"Add cleanupSpec for beta system properties\"\n\nThis reverts commit a0517bccba0f46ed7fdc517d01f6b1cf4589b292.\n\n# Conflicts:\n#\tdd-java-agent/instrumentation/grizzly-2/src/test/groovy/GrizzlyTest.groovy", "committedDate": "2020-06-22T21:50:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4MjkzNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r447882935", "bodyText": "I wouldn't expect our Otel objects to implement our objects -- just the Otel objects.\nI'm curious why we're implementing both interfaces.", "author": "dougqh", "createdAt": "2020-06-30T18:09:31Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelScope.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.context.TraceScope;\n+import io.opentelemetry.context.Scope;\n+\n+public class OtelScope implements Scope, TraceScope {", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4MzM3NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r447883374", "bodyText": "I'm surprised to see the async propagation methods on this class.  I realize it follows from implementing datadog's TraceScope, but wonder why we need to do that.", "author": "dougqh", "createdAt": "2020-06-30T18:10:23Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelScope.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.context.TraceScope;\n+import io.opentelemetry.context.Scope;\n+\n+public class OtelScope implements Scope, TraceScope {\n+  private final AgentScope delegate;\n+\n+  public OtelScope(final AgentScope delegate) {\n+    this.delegate = delegate;\n+  }\n+\n+  @Override\n+  public Continuation capture() {\n+    return delegate.capture();\n+  }\n+\n+  @Override\n+  public void close() {\n+    delegate.close();\n+  }\n+\n+  @Override", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4NDE3MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r447884171", "bodyText": "I wonder if the unsupported methods / cases should an option to raise UnsupportedOperationException.\nNot raising an exception bit us in another situation recently.", "author": "dougqh", "createdAt": "2020-06-30T18:11:53Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelSpan.java", "diffHunk": "@@ -0,0 +1,223 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.api.DDTags;\n+import datadog.trace.api.interceptor.MutableSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.opentelemetry.common.AttributeValue;\n+import io.opentelemetry.trace.EndSpanOptions;\n+import io.opentelemetry.trace.Event;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.Status;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OtelSpan implements Span, MutableSpan {\n+  private final AgentSpan delegate;\n+  private final TypeConverter converter;\n+\n+  public OtelSpan(final AgentSpan agentSpan, final TypeConverter typeConverter) {\n+    delegate = agentSpan;\n+    converter = typeConverter;\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final String value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final long value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final double value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final boolean value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final AttributeValue value) {\n+    switch (value.getType()) {\n+      case LONG:\n+        delegate.setTag(key, value.getLongValue());\n+        break;\n+      case DOUBLE:\n+        delegate.setTag(key, value.getDoubleValue());\n+        break;\n+      case STRING:\n+        delegate.setTag(key, value.getStringValue());\n+        break;\n+      case BOOLEAN:\n+        delegate.setTag(key, value.getBooleanValue());\n+        break;\n+      default:\n+        // Unsupported.... Ignoring.", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4NDU1Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r447884553", "bodyText": "As with Scope, I wouldn't expect this to implement MutableSpan.", "author": "dougqh", "createdAt": "2020-06-30T18:12:36Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelSpan.java", "diffHunk": "@@ -0,0 +1,223 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.api.DDTags;\n+import datadog.trace.api.interceptor.MutableSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.opentelemetry.common.AttributeValue;\n+import io.opentelemetry.trace.EndSpanOptions;\n+import io.opentelemetry.trace.Event;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.Status;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OtelSpan implements Span, MutableSpan {", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4NjA4Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r447886082", "bodyText": "This looks wrong to me.\nI would expect the setters to return \"this\" -- not unwrap the delegate.", "author": "dougqh", "createdAt": "2020-06-30T18:14:53Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelSpan.java", "diffHunk": "@@ -0,0 +1,223 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.api.DDTags;\n+import datadog.trace.api.interceptor.MutableSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.opentelemetry.common.AttributeValue;\n+import io.opentelemetry.trace.EndSpanOptions;\n+import io.opentelemetry.trace.Event;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.Status;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OtelSpan implements Span, MutableSpan {\n+  private final AgentSpan delegate;\n+  private final TypeConverter converter;\n+\n+  public OtelSpan(final AgentSpan agentSpan, final TypeConverter typeConverter) {\n+    delegate = agentSpan;\n+    converter = typeConverter;\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final String value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final long value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final double value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final boolean value) {\n+    delegate.setTag(key, value);\n+  }\n+\n+  @Override\n+  public void setAttribute(final String key, final AttributeValue value) {\n+    switch (value.getType()) {\n+      case LONG:\n+        delegate.setTag(key, value.getLongValue());\n+        break;\n+      case DOUBLE:\n+        delegate.setTag(key, value.getDoubleValue());\n+        break;\n+      case STRING:\n+        delegate.setTag(key, value.getStringValue());\n+        break;\n+      case BOOLEAN:\n+        delegate.setTag(key, value.getBooleanValue());\n+        break;\n+      default:\n+        // Unsupported.... Ignoring.\n+    }\n+  }\n+\n+  @Override\n+  public void addEvent(final String name) {}\n+\n+  @Override\n+  public void addEvent(final String name, final long timestamp) {}\n+\n+  @Override\n+  public void addEvent(final String name, final Map<String, AttributeValue> attributes) {}\n+\n+  @Override\n+  public void addEvent(\n+      final String name, final Map<String, AttributeValue> attributes, final long timestamp) {}\n+\n+  @Override\n+  public void addEvent(final Event event) {}\n+\n+  @Override\n+  public void addEvent(final Event event, final long timestamp) {}\n+\n+  @Override\n+  public void setStatus(final Status status) {\n+    if (!status.isOk()) {\n+      delegate.setError(true);\n+      delegate.setTag(DDTags.ERROR_MSG, status.getDescription());\n+    }\n+  }\n+\n+  @Override\n+  public void updateName(final String name) {\n+    delegate.setResourceName(name);\n+  }\n+\n+  @Override\n+  public void end() {\n+    delegate.finish();\n+  }\n+\n+  @Override\n+  public void end(final EndSpanOptions endOptions) {\n+    if (endOptions.getEndTimestamp() > 0) {\n+      delegate.finish(TimeUnit.NANOSECONDS.toMicros(endOptions.getEndTimestamp()));\n+    } else {\n+      delegate.finish();\n+    }\n+  }\n+\n+  @Override\n+  public SpanContext getContext() {\n+    return converter.toSpanContext(delegate.context());\n+  }\n+\n+  @Override\n+  public boolean isRecording() {\n+    return delegate.getTraceId().toLong() != 0;\n+  }\n+\n+  public AgentSpan getDelegate() {\n+    return delegate;\n+  }\n+\n+  @Override\n+  public long getStartTime() {\n+    return delegate.getStartTime();\n+  }\n+\n+  @Override\n+  public long getDurationNano() {\n+    return delegate.getDurationNano();\n+  }\n+\n+  @Override\n+  public String getOperationName() {\n+    return delegate.getOperationName();\n+  }\n+\n+  @Override\n+  public MutableSpan setOperationName(final String serviceName) {\n+    return delegate.setOperationName(serviceName);", "originalCommit": "74e90dd6b636c73f437731cafb2c1c13e7805c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4ODE5MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r447888191", "bodyText": "This doesn't implement AgentSpan.Context?  I generally don't think we should implement our interfaces here, but the inconsistency confuses me.", "author": "dougqh", "createdAt": "2020-06-30T18:18:23Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelSpanContext.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.SpanId;\n+import io.opentelemetry.trace.TraceFlags;\n+import io.opentelemetry.trace.TraceId;\n+import io.opentelemetry.trace.TraceState;\n+\n+public class OtelSpanContext extends SpanContext {", "originalCommit": "0f9bbbc3bdcb89d34392d3b7bcb06ad005a6ee6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4ODczNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r447888737", "bodyText": "I'd like if we could push the information down into our tracers, too, but that can be another PR.", "author": "dougqh", "createdAt": "2020-06-30T18:19:08Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelTracer.java", "diffHunk": "@@ -0,0 +1,163 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import datadog.trace.bootstrap.instrumentation.api.Tags;\n+import io.opentelemetry.common.AttributeValue;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.trace.Link;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.Tracer;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OtelTracer implements Tracer {\n+  private final String tracerName;\n+  private final AgentTracer.TracerAPI tracer;\n+  private final TypeConverter converter;\n+\n+  OtelTracer(\n+      final String tracerName, final AgentTracer.TracerAPI tracer, final TypeConverter converter) {\n+    this.tracerName = tracerName;", "originalCommit": "0f9bbbc3bdcb89d34392d3b7bcb06ad005a6ee6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5Mzk4Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1605#discussion_r447893986", "bodyText": "I feel like this might be making things more complicated than they need to be.\nI don't see much value in centralizing this logic given that the conversion to / from should be a 1-liner.\nI'm also worried by the addition of more instanceof checks which we should avoid, but also just seem unnecessary in this case.", "author": "dougqh", "createdAt": "2020-06-30T18:27:59Z", "path": "dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/TypeConverter.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package datadog.trace.instrumentation.opentelemetry;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.SpanContext;\n+\n+// Centralized place to do conversions\n+public class TypeConverter {", "originalCommit": "0f9bbbc3bdcb89d34392d3b7bcb06ad005a6ee6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}