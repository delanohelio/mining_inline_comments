{"pr_number": 1334, "pr_title": "Multiple fixes for exception histogram", "pr_createdAt": "2020-03-23T22:09:07Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1334", "timeline": [{"oid": "dd06ebd4e6cd7af210d51e71667d6db6db95a43b", "url": "https://github.com/DataDog/dd-trace-java/commit/dd06ebd4e6cd7af210d51e71667d6db6db95a43b", "message": "Multiple fixes for exception histogram\n\n* Add limit to histogram size\n* Make sure entries are removed in the same iteration they were used\n* Improve tests\n* Fix configuration object initialization\n* Add tests for new config fields", "committedDate": "2020-03-23T22:06:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNTY0Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397025642", "bodyText": "This is for tests only. Should be at most package private.", "author": "jbachorik", "createdAt": "2020-03-24T09:52:17Z", "path": "dd-java-agent/agent-profiling/profiling-exceptions/src/main/java/com/datadog/profiling/exceptions/ExceptionHistogram.java", "diffHunk": "@@ -11,39 +11,22 @@\n \n @Slf4j\n public class ExceptionHistogram {\n-  private final Map<String, AtomicLong> histoMap = new ConcurrentHashMap<>();\n-  private final EventType exceptionCountEventType;\n+  private final Map<String, AtomicLong> histogram = new ConcurrentHashMap<>();\n   private final int maxTopItems;\n-  private final boolean forceEnabled;\n-\n-  @FunctionalInterface\n-  interface ValueVisitor {\n-    void visit(String key, long value);\n-  }\n+  private final int maxSize;\n+  private final EventType exceptionCountEventType;\n+  private final Runnable eventHook;\n \n   ExceptionHistogram(final Config config) {\n-    this(config.getProfilingExceptionHistoMax(), false);\n-  }\n-\n-  ExceptionHistogram(final int maxTopItems, final boolean forceEnabled) {\n-    this.maxTopItems = maxTopItems;\n+    maxTopItems = config.getProfilingExceptionHistogramTopItems();\n+    maxSize = config.getProfilingExceptionHistogramMaxCollectionSize();\n     exceptionCountEventType = EventType.getEventType(ExceptionCountEvent.class);\n-    this.forceEnabled = forceEnabled;\n-\n-    FlightRecorder.addPeriodicEvent(ExceptionCountEvent.class, this::emit);\n-  }\n-\n-  private void emit() {\n-    if (forceEnabled || exceptionCountEventType.isEnabled()) {\n-      processAndReset(this::newExceptionCountEvent);\n-    }\n+    eventHook = this::emit;\n+    FlightRecorder.addPeriodicEvent(ExceptionCountEvent.class, eventHook);\n   }\n \n-  private void newExceptionCountEvent(final String type, final long count) {\n-    final ExceptionCountEvent event = new ExceptionCountEvent(type, count);\n-    if (event.shouldCommit()) {\n-      event.commit();\n-    }\n+  public void deregister() {", "originalCommit": "dd06ebd4e6cd7af210d51e71667d6db6db95a43b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA2Njc4MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397066780", "bodyText": "fixed", "author": "mar-kolya", "createdAt": "2020-03-24T11:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNTY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzMDQxNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397030417", "bodyText": "size() on concurrent structures can be rather expensive as it needs to merge data from all thread-local buckets.\nAdditionally, this check is not thread safe but in the worst case it will add extra N items where N is the number of concurrently accessing threads - so the overflow should not be too severe.\nWhat makes me nervous about this histogram size clipping is that it may produce incorrect data once new items are refused. To make things worse the information about clipping will be available only in the customer logs so our analysis operating on JFR only will have no clue that the histogram may be garbage.", "author": "jbachorik", "createdAt": "2020-03-24T09:59:33Z", "path": "dd-java-agent/agent-profiling/profiling-exceptions/src/main/java/com/datadog/profiling/exceptions/ExceptionHistogram.java", "diffHunk": "@@ -53,13 +36,19 @@ public boolean record(final Exception exception) {\n     return record(exception.getClass().getCanonicalName());\n   }\n \n-  boolean record(final String typeName) {\n-    if (typeName == null) {\n-      return false;\n-    }\n-    if (forceEnabled || exceptionCountEventType.isEnabled()) {\n+  private boolean record(final String typeName) {\n+    if (exceptionCountEventType.isEnabled()) {\n+      if (histogram.size() >= maxSize && !histogram.containsKey(typeName)) {", "originalCommit": "dd06ebd4e6cd7af210d51e71667d6db6db95a43b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA2NTkyNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397065926", "bodyText": "I guess we could have special even when size clipping occurs - in fact we do not need 'special' event, we can have same even with special class name.\nAs far as size's cost goes - I'm not sure specifically concurrent hash map suffers from that problem.", "author": "mar-kolya", "createdAt": "2020-03-24T10:59:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzMDQxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3MTkxOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397071918", "bodyText": "So I've added two things:\n\nI've swapped containsKey check with with size - this makes calls to size less often\nI've added another event to count number of clipped exceptions - this way the problem will be visible in the histogram", "author": "mar-kolya", "createdAt": "2020-03-24T11:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzMDQxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3MjE0MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397072141", "bodyText": "We can not emit event for each refused entry - I think we are trying to prevent situation when we have few hundreds of thousands of different exception types being created all the time (I think this is almost impossible, but ok) and if we start emitting events for all refused exception types because crossing the histo limit we blow up the recording instead. So we will have to send only one event at the chunk end, signaling that the limit has been crossed some time during the event and the histo may contain garbage, statistically speaking.\nAs for the ConcurrentHashMap size implementation -\nhttps://opengrok.us1.staging.dog/xref/jdk11/src/java.base/share/classes/java/util/concurrent/ConcurrentHashMap.java?r=50762%3A3c3ff151c75e#2562", "author": "jbachorik", "createdAt": "2020-03-24T11:10:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzMDQxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzMjA1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397032050", "bodyText": "Well, with the size clipping it is totally confusing and basically can not be used since you can be getting quite random results depending on the histogram size limit and the number of unique type names of exceptions emitted during one chunk. Eg. all exception types which will not be added to the histogram will not be sampled on their first occurrence.", "author": "jbachorik", "createdAt": "2020-03-24T10:02:05Z", "path": "dd-java-agent/agent-profiling/profiling-exceptions/src/main/java/com/datadog/profiling/exceptions/ExceptionHistogram.java", "diffHunk": "@@ -71,24 +60,41 @@ boolean record(final String typeName) {\n               })\n           .incrementAndGet();\n \n+      // FIXME: this 'first hit' logic is confusing and untested", "originalCommit": "dd06ebd4e6cd7af210d51e71667d6db6db95a43b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA2NDQ2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397064460", "bodyText": "It was confusing even before size clipping.\n'First hit once per run' - this seems odd, especially for long running processes. With introduction of old entries clean up it became 'first entry after previous one was cleaned up' which is not less confusing.\nIn fact I do not see how size clipping changes much.", "author": "mar-kolya", "createdAt": "2020-03-24T10:56:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzMjA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzMzIzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397033230", "bodyText": "IMO a unit test should not require all this JFR machinery to test just a simple in-memory data structure.", "author": "jbachorik", "createdAt": "2020-03-24T10:04:02Z", "path": "dd-java-agent/agent-profiling/profiling-exceptions/src/test/java/com/datadog/profiling/exceptions/ExceptionHistogramTest.java", "diffHunk": "@@ -1,70 +1,259 @@\n package com.datadog.profiling.exceptions;\n \n-import java.util.Arrays;\n-import java.util.concurrent.atomic.AtomicInteger;\n-import org.junit.Assert;\n-import org.junit.jupiter.api.Assertions;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+\n+import com.google.common.collect.ImmutableSortedMap;\n+import datadog.trace.api.Config;\n+import java.io.IOException;\n+import java.time.Instant;\n+import java.util.Comparator;\n+import java.util.Map;\n+import java.util.Properties;\n+import jdk.jfr.FlightRecorder;\n+import jdk.jfr.Recording;\n+import org.junit.jupiter.api.AfterEach;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n+import org.openjdk.jmc.common.item.Aggregators;\n+import org.openjdk.jmc.common.item.Attribute;\n+import org.openjdk.jmc.common.item.IAttribute;\n+import org.openjdk.jmc.common.item.IItemCollection;\n+import org.openjdk.jmc.common.item.ItemFilters;\n+import org.openjdk.jmc.common.unit.IQuantity;\n+import org.openjdk.jmc.common.unit.UnitLookup;\n+import org.openjdk.jmc.flightrecorder.CouldNotLoadRecordingException;\n+import org.openjdk.jmc.flightrecorder.JfrLoaderToolkit;\n \n public class ExceptionHistogramTest {\n+\n+  private static final IAttribute<String> TYPE =\n+      Attribute.attr(\"type\", \"type\", \"Exception type\", UnitLookup.PLAIN_TEXT);\n+  private static final IAttribute<IQuantity> COUNT =\n+      Attribute.attr(\"count\", \"count\", \"Exception count\", UnitLookup.NUMBER);\n+\n+  private static final Comparator<Exception> EXCEPTION_COMPARATOR =\n+      new Comparator<>() {\n+        @Override\n+        public int compare(final Exception e1, final Exception e2) {\n+          return e1.getClass().getCanonicalName().compareTo(e2.getClass().getCanonicalName());\n+        }\n+\n+        @Override\n+        public boolean equals(final Object obj) {\n+          return this == obj;\n+        }\n+      };\n+\n   private static final int MAX_ITEMS = 2;\n+  private static final int MAX_SIZE = 2;\n+\n+  private Recording recording;", "originalCommit": "dd06ebd4e6cd7af210d51e71667d6db6db95a43b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA2NTI5Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397065297", "bodyText": "I would agree in general. In practice this turns out not to be a 'simple data structure' - this also creates and commits events due to JFR APIs are organized.", "author": "mar-kolya", "createdAt": "2020-03-24T10:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzMzIzMA=="}], "type": "inlineReview"}, {"oid": "1c4a1c8fa65ef1d31a440b4dc99678ec0020179a", "url": "https://github.com/DataDog/dd-trace-java/commit/1c4a1c8fa65ef1d31a440b4dc99678ec0020179a", "message": "Made deregister package private", "committedDate": "2020-03-24T11:00:32Z", "type": "commit"}, {"oid": "e465dcb796d1010115774dda9729a80fc8fcdf44", "url": "https://github.com/DataDog/dd-trace-java/commit/e465dcb796d1010115774dda9729a80fc8fcdf44", "message": "Remove logging left behind by accident", "committedDate": "2020-03-24T11:01:32Z", "type": "commit"}, {"oid": "b5721f6e1edc28118e76560430322fac6f104f27", "url": "https://github.com/DataDog/dd-trace-java/commit/b5721f6e1edc28118e76560430322fac6f104f27", "message": "Count 'clipped' exceptions and provide to provide information about histogram overflow", "committedDate": "2020-03-24T11:08:25Z", "type": "commit"}, {"oid": "362006d57449f0ff57f46377f13452d6935d0b15", "url": "https://github.com/DataDog/dd-trace-java/commit/362006d57449f0ff57f46377f13452d6935d0b15", "message": "Update helper list", "committedDate": "2020-03-24T11:28:59Z", "type": "commit"}, {"oid": "88471b749c6a8a2c3ff32f142fa7465de724b927", "url": "https://github.com/DataDog/dd-trace-java/commit/88471b749c6a8a2c3ff32f142fa7465de724b927", "message": "Use enablement config for exception instrumentation", "committedDate": "2020-03-24T12:13:43Z", "type": "commit"}, {"oid": "1b619a5f6153a68bacba68077b91f3467125fae4", "url": "https://github.com/DataDog/dd-trace-java/commit/1b619a5f6153a68bacba68077b91f3467125fae4", "message": "Remove unneccessary dependency", "committedDate": "2020-03-24T12:51:23Z", "type": "commit"}, {"oid": "f8ceb258bc9dcc6a53700cf907a5b7fd69548763", "url": "https://github.com/DataDog/dd-trace-java/commit/f8ceb258bc9dcc6a53700cf907a5b7fd69548763", "message": "Make sure samplier is initialized before using it\n\nException class can be loaded and instantiated before Sampler code had\na chance to initialize. This results in advice seeing null in static\nfield - so we have to check for that.", "committedDate": "2020-03-24T12:51:32Z", "type": "commit"}, {"oid": "cb9b38aa32a599e5098a248adf2bc778ad519c69", "url": "https://github.com/DataDog/dd-trace-java/commit/cb9b38aa32a599e5098a248adf2bc778ad519c69", "message": "Merge branch 'jb/PROF-581_exceptions_sampler' into mar-kolya/exceptions-histogram-fixes", "committedDate": "2020-03-24T13:16:26Z", "type": "commit"}, {"oid": "8a43a009e95eafd06b63fd2e6ff77d859ed529eb", "url": "https://github.com/DataDog/dd-trace-java/commit/8a43a009e95eafd06b63fd2e6ff77d859ed529eb", "message": "Make compiler happy", "committedDate": "2020-03-24T13:30:37Z", "type": "commit"}, {"oid": "1b0de5efb4d7741eed8564559840bd8d5773b236", "url": "https://github.com/DataDog/dd-trace-java/commit/1b0de5efb4d7741eed8564559840bd8d5773b236", "message": "Fix timing of chunk rotation is tests", "committedDate": "2020-03-24T14:13:04Z", "type": "commit"}, {"oid": "e05d10a2f2529768d01aaef953db85fae6a3e453", "url": "https://github.com/DataDog/dd-trace-java/commit/e05d10a2f2529768d01aaef953db85fae6a3e453", "message": "Merge branch 'master' into mar-kolya/exceptions-histogram-fixes", "committedDate": "2020-03-25T11:58:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxMDkzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397810930", "bodyText": "Is this correct? When you remove this override the exception instrumentation will be enabled only if 'integrations' are enabled. IMO, exception profiling is not an integration, like netty or elasticsearch.\nMaybe I am missing something but this does not seem right.", "author": "jbachorik", "createdAt": "2020-03-25T12:19:43Z", "path": "dd-java-agent/instrumentation/exception-profiling/src/main/java/datadog/exceptions/instrumentation/ExceptionInstrumentation.java", "diffHunk": "@@ -38,11 +36,6 @@ public ExceptionInstrumentation() {\n     hasJfr = jfr;\n   }\n \n-  @Override\n-  protected boolean defaultEnabled() {\n-    return true;", "originalCommit": "e05d10a2f2529768d01aaef953db85fae6a3e453", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxNzA0NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397817045", "bodyText": "I think this is correct.\nIf APM is disabled then whole BB agent will be disabled and nothing will get applied - so from that perspective this would be subject to same rules as APM.\nAlso per-integration enable-disable works the same as for other integrations...\nSo even though this may not seem like integration - in fact it is... And I'd also say potentially quite risky one since we mess with deep jdk guts... So I'd prefer it to be driven by same controls as the rest of integrations - mainly to avoid confusion.", "author": "mar-kolya", "createdAt": "2020-03-25T12:31:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxMDkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxODAzMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397818033", "bodyText": "Ok", "author": "jbachorik", "createdAt": "2020-03-25T12:32:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxMDkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxOTA3MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397819071", "bodyText": "We can revisit it if it causes problems/confusion - but overall it seems nice to have a universal 'kill switch' for messing up with the byte code", "author": "mar-kolya", "createdAt": "2020-03-25T12:34:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxMDkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgyODI2Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397828262", "bodyText": "Yes, that seems right to me.  For this integration, both ByteBuddy and JFR need to be available.\nMy concern is more how we're checking for JFR.  The Class.forName is problematic for a couple reasons.\n1 - It unnecessarily triggers class initialization.\n2 - It is effectively repeating the logic that the type of check typically performed by muzzle and ClassLoaderMatchers.\nUnless there's a good reason not to use the existing mechanisms, I think this code should do so.", "author": "dougqh", "createdAt": "2020-03-25T12:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxMDkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgzMDExNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397830116", "bodyText": "1 - It unnecessarily triggers class initialization.\n\nThis class will be loaded anyway when integration is applied... or am I missing something?", "author": "mar-kolya", "createdAt": "2020-03-25T12:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxMDkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgzMTc2Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397831767", "bodyText": "But classloader matcher seems like a good point, @jbachorik any reason not to use it?", "author": "mar-kolya", "createdAt": "2020-03-25T12:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxMDkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgzMTg1Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1334#discussion_r397831856", "bodyText": "(probably in main PR)", "author": "mar-kolya", "createdAt": "2020-03-25T12:57:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxMDkzMA=="}], "type": "inlineReview"}, {"oid": "a6313523d766c30cf95d4883a08df00329a20325", "url": "https://github.com/DataDog/dd-trace-java/commit/a6313523d766c30cf95d4883a08df00329a20325", "message": "Merge branch 'jb/PROF-581_exceptions_sampler' into mar-kolya/exceptions-histogram-fixes", "committedDate": "2020-03-25T12:50:03Z", "type": "commit"}, {"oid": "21a159568fa83d3018bc37b13a27503739c88e70", "url": "https://github.com/DataDog/dd-trace-java/commit/21a159568fa83d3018bc37b13a27503739c88e70", "message": "Add missing helper", "committedDate": "2020-03-25T14:02:40Z", "type": "commit"}]}