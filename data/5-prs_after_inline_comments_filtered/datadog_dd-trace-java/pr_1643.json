{"pr_number": 1643, "pr_title": "improve startup performance for clojure apps", "pr_createdAt": "2020-07-01T09:17:51Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1643", "timeline": [{"oid": "26bed80763a56c527dbdef33ac96f82115dca8f8", "url": "https://github.com/DataDog/dd-trace-java/commit/26bed80763a56c527dbdef33ac96f82115dca8f8", "message": "mke it possible to configurably skip transformation of any clojure class", "committedDate": "2020-07-01T09:21:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NTA4Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1643#discussion_r448475083", "bodyText": "Can't you do a break here as well as in the other non matching ones?", "author": "bantonsson", "createdAt": "2020-07-01T16:19:15Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/GlobalIgnoresMatcher.java", "diffHunk": "@@ -47,129 +47,145 @@ private GlobalIgnoresMatcher(final boolean skipAdditionalLibraryMatcher) {\n   @Override\n   public boolean matches(final T target) {\n     final String name = target.getActualName();\n-\n-    if (name.startsWith(\"datadog.opentracing.\")\n-        || name.startsWith(\"datadog.trace.core.\")\n-        || name.startsWith(\"datadog.slf4j.\")\n-        || name.startsWith(\"net.bytebuddy.\")\n-        || name.startsWith(\"jdk.\")\n-        || name.startsWith(\"org.aspectj.\")\n-        || name.startsWith(\"com.intellij.rt.debugger.\")\n-        || name.startsWith(\"com.p6spy.\")\n-        || name.startsWith(\"com.newrelic.\")\n-        || name.startsWith(\"com.dynatrace.\")\n-        || name.startsWith(\"com.jloadtrace.\")\n-        || name.startsWith(\"com.appdynamics.\")\n-        || name.startsWith(\"com.singularity.\")\n-        || name.startsWith(\"com.jinspired.\")\n-        || name.startsWith(\"org.jinspired.\")) {\n-      return true;\n+    switch (name.charAt(0) - 'a') {\n+        // starting at zero to get a tableswitch from javac, though it looks horrendous\n+      case 'a' - 'a':\n+      case 'b' - 'a':", "originalCommit": "ced6805f70f33aef44f2e3df02c2eff85a3057b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3Nzg5Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1643#discussion_r448477892", "bodyText": "Can't believe I missed that, will measure again.", "author": "richardstartin", "createdAt": "2020-07-01T16:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NTA4Mw=="}], "type": "inlineReview"}, {"oid": "e00ebc1f968408cf7ab55b3f1ae304da603febee", "url": "https://github.com/DataDog/dd-trace-java/commit/e00ebc1f968408cf7ab55b3f1ae304da603febee", "message": "ignore more clojure class name patterns, avoid repeated work in name matching", "committedDate": "2020-07-01T16:21:27Z", "type": "forcePushed"}, {"oid": "e4c775688028252cb8921c6b88f61cd1c5f97840", "url": "https://github.com/DataDog/dd-trace-java/commit/e4c775688028252cb8921c6b88f61cd1c5f97840", "message": "ignore more clojure class name patterns, avoid repeated work in name matching", "committedDate": "2020-07-01T16:39:37Z", "type": "forcePushed"}, {"oid": "91d36a51065888172dcea195726eff2ad196e15e", "url": "https://github.com/DataDog/dd-trace-java/commit/91d36a51065888172dcea195726eff2ad196e15e", "message": "ignore more clojure class name patterns, avoid repeated work in name matching", "committedDate": "2020-07-01T16:55:09Z", "type": "commit"}, {"oid": "91d36a51065888172dcea195726eff2ad196e15e", "url": "https://github.com/DataDog/dd-trace-java/commit/91d36a51065888172dcea195726eff2ad196e15e", "message": "ignore more clojure class name patterns, avoid repeated work in name matching", "committedDate": "2020-07-01T16:55:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2OTY0OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1643#discussion_r448569648", "bodyText": "what happens if the case doesn't start with 0?", "author": "tylerbenson", "createdAt": "2020-07-01T19:23:15Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/GlobalIgnoresMatcher.java", "diffHunk": "@@ -47,129 +47,159 @@ private GlobalIgnoresMatcher(final boolean skipAdditionalLibraryMatcher) {\n   @Override\n   public boolean matches(final T target) {\n     final String name = target.getActualName();\n-\n-    if (name.startsWith(\"datadog.opentracing.\")\n-        || name.startsWith(\"datadog.trace.core.\")\n-        || name.startsWith(\"datadog.slf4j.\")\n-        || name.startsWith(\"net.bytebuddy.\")\n-        || name.startsWith(\"jdk.\")\n-        || name.startsWith(\"org.aspectj.\")\n-        || name.startsWith(\"com.intellij.rt.debugger.\")\n-        || name.startsWith(\"com.p6spy.\")\n-        || name.startsWith(\"com.newrelic.\")\n-        || name.startsWith(\"com.dynatrace.\")\n-        || name.startsWith(\"com.jloadtrace.\")\n-        || name.startsWith(\"com.appdynamics.\")\n-        || name.startsWith(\"com.singularity.\")\n-        || name.startsWith(\"com.jinspired.\")\n-        || name.startsWith(\"org.jinspired.\")) {\n-      return true;\n-    }\n-\n-    // groovy\n-    if (name.startsWith(\"org.groovy.\") || name.startsWith(\"org.apache.groovy.\")) {\n-      return true;\n-    }\n-    if (name.startsWith(\"org.codehaus.groovy.\")) {\n-      // We seem to instrument some classes in runtime\n-      if (name.startsWith(\"org.codehaus.groovy.runtime.\")) {\n-        return false;\n-      }\n-      return true;\n-    }\n-    // clojure\n-    if (name.startsWith(\"clojure.\") || name.contains(\"$fn__\")) {\n-      return true;\n-    }\n-\n-    if (name.startsWith(\"datadog.trace.\")) {\n-      // FIXME: We should remove this once\n-      // https://github.com/raphw/byte-buddy/issues/558 is fixed\n-      if (name.equals(\"datadog.trace.bootstrap.instrumentation.java.concurrent.RunnableWrapper\")\n-          || name.equals(\n-              \"datadog.trace.bootstrap.instrumentation.java.concurrent.CallableWrapper\")) {\n-        return false;\n-      }\n-      return true;\n+    switch (name.charAt(0) - 'a') {\n+        // starting at zero to get a tableswitch from javac, though it looks horrendous", "originalCommit": "91d36a51065888172dcea195726eff2ad196e15e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MDIyMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1643#discussion_r448570220", "bodyText": "can these all fall through to the last break?  (does the break need to be duplicated?)", "author": "tylerbenson", "createdAt": "2020-07-01T19:24:28Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/GlobalIgnoresMatcher.java", "diffHunk": "@@ -47,129 +47,159 @@ private GlobalIgnoresMatcher(final boolean skipAdditionalLibraryMatcher) {\n   @Override\n   public boolean matches(final T target) {\n     final String name = target.getActualName();\n-\n-    if (name.startsWith(\"datadog.opentracing.\")\n-        || name.startsWith(\"datadog.trace.core.\")\n-        || name.startsWith(\"datadog.slf4j.\")\n-        || name.startsWith(\"net.bytebuddy.\")\n-        || name.startsWith(\"jdk.\")\n-        || name.startsWith(\"org.aspectj.\")\n-        || name.startsWith(\"com.intellij.rt.debugger.\")\n-        || name.startsWith(\"com.p6spy.\")\n-        || name.startsWith(\"com.newrelic.\")\n-        || name.startsWith(\"com.dynatrace.\")\n-        || name.startsWith(\"com.jloadtrace.\")\n-        || name.startsWith(\"com.appdynamics.\")\n-        || name.startsWith(\"com.singularity.\")\n-        || name.startsWith(\"com.jinspired.\")\n-        || name.startsWith(\"org.jinspired.\")) {\n-      return true;\n-    }\n-\n-    // groovy\n-    if (name.startsWith(\"org.groovy.\") || name.startsWith(\"org.apache.groovy.\")) {\n-      return true;\n-    }\n-    if (name.startsWith(\"org.codehaus.groovy.\")) {\n-      // We seem to instrument some classes in runtime\n-      if (name.startsWith(\"org.codehaus.groovy.runtime.\")) {\n-        return false;\n-      }\n-      return true;\n-    }\n-    // clojure\n-    if (name.startsWith(\"clojure.\") || name.contains(\"$fn__\")) {\n-      return true;\n-    }\n-\n-    if (name.startsWith(\"datadog.trace.\")) {\n-      // FIXME: We should remove this once\n-      // https://github.com/raphw/byte-buddy/issues/558 is fixed\n-      if (name.equals(\"datadog.trace.bootstrap.instrumentation.java.concurrent.RunnableWrapper\")\n-          || name.equals(\n-              \"datadog.trace.bootstrap.instrumentation.java.concurrent.CallableWrapper\")) {\n-        return false;\n-      }\n-      return true;\n+    switch (name.charAt(0) - 'a') {\n+        // starting at zero to get a tableswitch from javac, though it looks horrendous\n+      case 'a' - 'a':\n+        break;\n+      case 'b' - 'a':\n+        break;\n+      case 'c' - 'a':\n+        if (name.startsWith(\"com.\")) {\n+          if (name.startsWith(\"com.p6spy.\")\n+              || name.startsWith(\"com.newrelic.\")\n+              || name.startsWith(\"com.dynatrace.\")\n+              || name.startsWith(\"com.jloadtrace.\")\n+              || name.startsWith(\"com.appdynamics.\")\n+              || name.startsWith(\"com.singularity.\")\n+              || name.startsWith(\"com.jinspired.\")\n+              || name.startsWith(\"com.intellij.rt.debugger.\")) {\n+            return true;\n+          }\n+          if (name.startsWith(\"com.sun.\")) {\n+            return !name.startsWith(\"com.sun.messaging.\")\n+                && !name.startsWith(\"com.sun.jersey.api.client\");\n+          }\n+          if (COM_MCHANGE_PROXY.matcher(name).matches()) {\n+            return true;\n+          }\n+        }\n+        if (name.startsWith(\"clojure.\")) {\n+          return true;\n+        }\n+        break;\n+      case 'd' - 'a':\n+        if (name.startsWith(\"datadog.\")) {\n+          if (name.startsWith(\"datadog.opentracing.\")\n+              || name.startsWith(\"datadog.trace.core.\")\n+              || name.startsWith(\"datadog.slf4j.\")) {\n+            return true;\n+          }\n+          if (name.startsWith(\"datadog.trace.\")) {\n+            // FIXME: We should remove this once\n+            // https://github.com/raphw/byte-buddy/issues/558 is fixed\n+            return !name.equals(\n+                    \"datadog.trace.bootstrap.instrumentation.java.concurrent.RunnableWrapper\")\n+                && !name.equals(\n+                    \"datadog.trace.bootstrap.instrumentation.java.concurrent.CallableWrapper\");\n+          }\n+        }\n+        break;\n+      case 'e' - 'a':\n+        break;\n+      case 'f' - 'a':\n+        break;\n+      case 'g' - 'a':\n+        break;\n+      case 'h' - 'a':\n+        break;\n+      case 'i' - 'a':\n+        break;", "originalCommit": "91d36a51065888172dcea195726eff2ad196e15e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}