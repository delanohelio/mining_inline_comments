{"pr_number": 13428, "pr_title": "[BEAM-11338] Beam schema for thrift data", "pr_createdAt": "2020-11-25T16:11:42Z", "pr_url": "https://github.com/apache/beam/pull/13428", "timeline": [{"oid": "246b49e387d8e650466f7bd6fb51a1cd766eee48", "url": "https://github.com/apache/beam/commit/246b49e387d8e650466f7bd6fb51a1cd766eee48", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-26T01:33:02Z", "type": "forcePushed"}, {"oid": "f706aa666d58b7bb331ab5b9d18317581ba9ff2b", "url": "https://github.com/apache/beam/commit/f706aa666d58b7bb331ab5b9d18317581ba9ff2b", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-26T12:04:16Z", "type": "forcePushed"}, {"oid": "f152f7664d20591d722d7f80031fb8f147bcff3b", "url": "https://github.com/apache/beam/commit/f152f7664d20591d722d7f80031fb8f147bcff3b", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-26T12:12:29Z", "type": "forcePushed"}, {"oid": "4e8a83e155c4536c2241ca91bfbca24be4c1e6de", "url": "https://github.com/apache/beam/commit/4e8a83e155c4536c2241ca91bfbca24be4c1e6de", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-26T12:16:51Z", "type": "forcePushed"}, {"oid": "fe876d7df6055a16c0847e2a35ed61177fc828ce", "url": "https://github.com/apache/beam/commit/fe876d7df6055a16c0847e2a35ed61177fc828ce", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-26T12:47:55Z", "type": "forcePushed"}, {"oid": "89e33d8990e5fefd4a66db1bae22f339fe70f682", "url": "https://github.com/apache/beam/commit/89e33d8990e5fefd4a66db1bae22f339fe70f682", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-26T14:02:14Z", "type": "forcePushed"}, {"oid": "e56805805a0ab37a71bf1e22bcbd55ca2d910f54", "url": "https://github.com/apache/beam/commit/e56805805a0ab37a71bf1e22bcbd55ca2d910f54", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-26T14:55:10Z", "type": "forcePushed"}, {"oid": "c02944dd69aee6aafe746c109a7c003014d79433", "url": "https://github.com/apache/beam/commit/c02944dd69aee6aafe746c109a7c003014d79433", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-27T09:17:26Z", "type": "forcePushed"}, {"oid": "eb483d6c64ff3e9ba90aa3e2bdc8ac9f2023cf38", "url": "https://github.com/apache/beam/commit/eb483d6c64ff3e9ba90aa3e2bdc8ac9f2023cf38", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-27T11:12:07Z", "type": "forcePushed"}, {"oid": "b781e1eead71edb807a5e1c05747d97a6dd05421", "url": "https://github.com/apache/beam/commit/b781e1eead71edb807a5e1c05747d97a6dd05421", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-27T11:23:20Z", "type": "forcePushed"}, {"oid": "7b8b0af03f65bc7f83c588891960a1b64f8429cd", "url": "https://github.com/apache/beam/commit/7b8b0af03f65bc7f83c588891960a1b64f8429cd", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-27T13:44:52Z", "type": "forcePushed"}, {"oid": "b11dbdf84927f3c4f4087aa2fc477ef29fca10e7", "url": "https://github.com/apache/beam/commit/b11dbdf84927f3c4f4087aa2fc477ef29fca10e7", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-27T16:01:45Z", "type": "forcePushed"}, {"oid": "b9cba26631fdab7906b106ac98e605d80ea29e7c", "url": "https://github.com/apache/beam/commit/b9cba26631fdab7906b106ac98e605d80ea29e7c", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-11-27T18:19:38Z", "type": "forcePushed"}, {"oid": "bbca5e8b5ef9d7bf18825d4d334580e8a6dac867", "url": "https://github.com/apache/beam/commit/bbca5e8b5ef9d7bf18825d4d334580e8a6dac867", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-01T14:49:29Z", "type": "forcePushed"}, {"oid": "3f82dbcd8b8b1d506911343f7828fb2195d13e10", "url": "https://github.com/apache/beam/commit/3f82dbcd8b8b1d506911343f7828fb2195d13e10", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-01T22:48:07Z", "type": "forcePushed"}, {"oid": "a0cc78404ba7be2a5bd61dc42e210866fc6ad1bb", "url": "https://github.com/apache/beam/commit/a0cc78404ba7be2a5bd61dc42e210866fc6ad1bb", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-09T19:30:11Z", "type": "forcePushed"}, {"oid": "1497ec40f19a3940b27119df8ab51a975e2ee695", "url": "https://github.com/apache/beam/commit/1497ec40f19a3940b27119df8ab51a975e2ee695", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-09T20:58:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4MjI4Mw==", "url": "https://github.com/apache/beam/pull/13428#discussion_r539682283", "bodyText": "It irks me a little bit that this is in an io/thrift module, while the protobuf SchemaProvider is in an extensions/protobuf. With your ThriftCoder change this module is looking a lot like the protobuf one.\nBut whether we call it an IO module or an extension makes little practical difference... I think you're doing the right thing by just expanding the existing io/thrift module.", "author": "TheNeuralBit", "createdAt": "2020-12-09T22:04:14Z", "path": "sdks/java/io/thrift/src/main/java/org/apache/beam/sdk/io/thrift/ThriftSchema.java", "diffHunk": "@@ -0,0 +1,301 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.thrift;\n+\n+import static java.util.Collections.unmodifiableMap;\n+\n+import java.lang.reflect.Field;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.schemas.FieldValueGetter;\n+import org.apache.beam.sdk.schemas.FieldValueTypeInformation;\n+import org.apache.beam.sdk.schemas.GetterBasedSchemaProvider;\n+import org.apache.beam.sdk.schemas.Schema;\n+import org.apache.beam.sdk.schemas.Schema.Builder;\n+import org.apache.beam.sdk.schemas.Schema.FieldType;\n+import org.apache.beam.sdk.schemas.SchemaProvider;\n+import org.apache.beam.sdk.schemas.SchemaUserTypeCreator;\n+import org.apache.beam.sdk.schemas.logicaltypes.EnumerationType;\n+import org.apache.beam.sdk.values.TypeDescriptor;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TEnum;\n+import org.apache.thrift.TFieldIdEnum;\n+import org.apache.thrift.meta_data.EnumMetaData;\n+import org.apache.thrift.meta_data.FieldMetaData;\n+import org.apache.thrift.meta_data.FieldValueMetaData;\n+import org.apache.thrift.meta_data.ListMetaData;\n+import org.apache.thrift.meta_data.MapMetaData;\n+import org.apache.thrift.meta_data.SetMetaData;\n+import org.apache.thrift.meta_data.StructMetaData;\n+import org.apache.thrift.protocol.TType;\n+import org.checkerframework.checker.nullness.qual.NonNull;\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+@Experimental(Experimental.Kind.SCHEMAS)\n+public final class ThriftSchema extends GetterBasedSchemaProvider {", "originalCommit": "1497ec40f19a3940b27119df8ab51a975e2ee695", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM2MTUxOA==", "url": "https://github.com/apache/beam/pull/13428#discussion_r540361518", "bodyText": "I agree, I noticed this but thought my patch does not deserve a structural change or a dedicated module.", "author": "ccciudatu", "createdAt": "2020-12-10T17:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4MjI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4NDI0Mw==", "url": "https://github.com/apache/beam/pull/13428#discussion_r539684243", "bodyText": "You can exclude this class by adding it to the generatedClassPatterns in build.gradle, like how its done in for protobuf: \n  \n    \n      beam/sdks/java/extensions/protobuf/build.gradle\n    \n    \n        Lines 20 to 26\n      in\n      c5d5b9a\n    \n    \n    \n    \n\n        \n          \n           applyJavaNature( \n        \n\n        \n          \n             generatedClassPatterns: [ \n        \n\n        \n          \n               /^org\\.apache\\.beam\\.sdk\\.extensions\\.protobuf\\.Proto2CoderTestMessages/, \n        \n\n        \n          \n               /^org\\.apache\\.beam\\.sdk\\.extensions\\.protobuf\\.Proto2SchemaMessages/, \n        \n\n        \n          \n               /^org\\.apache\\.beam\\.sdk\\.extensions\\.protobuf\\.Proto3SchemaMessages/, \n        \n\n        \n          \n               /^org\\.apache\\.beam\\.sdk\\.extensions\\.protobuf\\.Proto3SchemaOptions/, \n        \n\n        \n          \n             ], \n        \n    \n  \n\n\n(Same for the other generated classes)", "author": "TheNeuralBit", "createdAt": "2020-12-09T22:07:40Z", "path": "sdks/java/io/thrift/src/test/java/org/apache/beam/sdk/io/thrift/TestThriftEnum.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.thrift;\n+\n+@SuppressWarnings({\n+  \"nullness\" // TODO(https://issues.apache.org/jira/browse/BEAM-10402)\n+})", "originalCommit": "1497ec40f19a3940b27119df8ab51a975e2ee695", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE4MTg3Mw==", "url": "https://github.com/apache/beam/pull/13428#discussion_r540181873", "bodyText": "done", "author": "ccciudatu", "createdAt": "2020-12-10T13:48:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4NDI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4OTk3Mg==", "url": "https://github.com/apache/beam/pull/13428#discussion_r539689972", "bodyText": "Could you try to address the nullness errors? We're working on removing all these class-level suppressions.\nIf it's too much trouble this is fine for now, at least the implementation is not suppressed.", "author": "TheNeuralBit", "createdAt": "2020-12-09T22:18:13Z", "path": "sdks/java/io/thrift/src/test/java/org/apache/beam/sdk/io/thrift/ThriftSchemaTest.java", "diffHunk": "@@ -0,0 +1,204 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.thrift;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.beam.sdk.schemas.Schema;\n+import org.apache.beam.sdk.schemas.Schema.Field;\n+import org.apache.beam.sdk.schemas.Schema.FieldType;\n+import org.apache.beam.sdk.schemas.Schema.TypeName;\n+import org.apache.beam.sdk.schemas.SchemaProvider;\n+import org.apache.beam.sdk.schemas.logicaltypes.EnumerationType;\n+import org.apache.beam.sdk.schemas.transforms.Convert;\n+import org.apache.beam.sdk.schemas.transforms.Group;\n+import org.apache.beam.sdk.schemas.transforms.Select;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.transforms.Count;\n+import org.apache.beam.sdk.transforms.Create;\n+import org.apache.beam.sdk.transforms.Distinct;\n+import org.apache.beam.sdk.transforms.FlatMapElements;\n+import org.apache.beam.sdk.transforms.MapElements;\n+import org.apache.beam.sdk.transforms.Sum;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.Row;\n+import org.apache.beam.sdk.values.TypeDescriptor;\n+import org.apache.beam.sdk.values.TypeDescriptors;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+@SuppressWarnings({\n+  \"nullness\" // TODO(https://issues.apache.org/jira/browse/BEAM-10402)\n+})", "originalCommit": "1497ec40f19a3940b27119df8ab51a975e2ee695", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE4Njg5OA==", "url": "https://github.com/apache/beam/pull/13428#discussion_r540186898", "bodyText": "I removed the class-level suppression, but had to keep this at the method level for half of of the tests. Is this acceptable?\nOne funny thing is that assertNotNull() expects the argument to be @NonNull already.", "author": "ccciudatu", "createdAt": "2020-12-10T13:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4OTk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMxNDAzNQ==", "url": "https://github.com/apache/beam/pull/13428#discussion_r540314035", "bodyText": "Oh yes I ran into this as well but forgot about it. I just filed BEAM-11436 to track this problem, could you please link that in the TODO? It's fine if you just do it at the class level, sorry for the churn.", "author": "TheNeuralBit", "createdAt": "2020-12-10T16:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4OTk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1NTAwMg==", "url": "https://github.com/apache/beam/pull/13428#discussion_r540355002", "bodyText": "Sure, I'll revert and point to the new Jira.\nMeanwhile, I found another annoying restriction of the checker:\nif (value == null) {\n    setSomething(null); // not allowed\n    setSomething(value); // allowed\n}\n\nAnd the compiler warns about value being always null here.", "author": "ccciudatu", "createdAt": "2020-12-10T17:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4OTk3Mg=="}], "type": "inlineReview"}, {"oid": "f7f28b04ecb751036ff9d25c7a7e7e9c5e042cf4", "url": "https://github.com/apache/beam/commit/f7f28b04ecb751036ff9d25c7a7e7e9c5e042cf4", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-10T14:05:48Z", "type": "forcePushed"}, {"oid": "497757d37d7bc2f635626bf995c19bbe6dcf5197", "url": "https://github.com/apache/beam/commit/497757d37d7bc2f635626bf995c19bbe6dcf5197", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-10T14:26:30Z", "type": "forcePushed"}, {"oid": "eeb61beab08eb0ce5cf96e552f0b3c26729b9290", "url": "https://github.com/apache/beam/commit/eeb61beab08eb0ce5cf96e552f0b3c26729b9290", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-10T15:20:37Z", "type": "forcePushed"}, {"oid": "67fac9ffb8eda814977a593d742def6e84eb7843", "url": "https://github.com/apache/beam/commit/67fac9ffb8eda814977a593d742def6e84eb7843", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-10T16:20:13Z", "type": "forcePushed"}, {"oid": "04dc46fbbdd25afe8eb6f5b93f2c1dda75612542", "url": "https://github.com/apache/beam/commit/04dc46fbbdd25afe8eb6f5b93f2c1dda75612542", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-10T16:21:06Z", "type": "forcePushed"}, {"oid": "e26e4065701b39ce9d29e8350abe82fdd706990d", "url": "https://github.com/apache/beam/commit/e26e4065701b39ce9d29e8350abe82fdd706990d", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-10T16:40:11Z", "type": "forcePushed"}, {"oid": "cb57c71fa7d0c5483d4b0387327dc2715dd274e6", "url": "https://github.com/apache/beam/commit/cb57c71fa7d0c5483d4b0387327dc2715dd274e6", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-10T16:43:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI2OTQzMg==", "url": "https://github.com/apache/beam/pull/13428#discussion_r540269432", "bodyText": "This should never happen with generated code, so we don't need to bother keeping track /inferring of the actual parameter type in order to choose the proper factory method here.", "author": "ccciudatu", "createdAt": "2020-12-10T15:37:50Z", "path": "sdks/java/io/thrift/src/main/java/org/apache/beam/sdk/io/thrift/ThriftSchema.java", "diffHunk": "@@ -0,0 +1,368 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.thrift;\n+\n+import static java.util.Collections.unmodifiableMap;\n+\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.schemas.FieldValueGetter;\n+import org.apache.beam.sdk.schemas.FieldValueTypeInformation;\n+import org.apache.beam.sdk.schemas.GetterBasedSchemaProvider;\n+import org.apache.beam.sdk.schemas.Schema;\n+import org.apache.beam.sdk.schemas.Schema.Builder;\n+import org.apache.beam.sdk.schemas.Schema.FieldType;\n+import org.apache.beam.sdk.schemas.SchemaProvider;\n+import org.apache.beam.sdk.schemas.SchemaUserTypeCreator;\n+import org.apache.beam.sdk.schemas.logicaltypes.EnumerationType;\n+import org.apache.beam.sdk.schemas.logicaltypes.OneOfType;\n+import org.apache.beam.sdk.values.TypeDescriptor;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TEnum;\n+import org.apache.thrift.TFieldIdEnum;\n+import org.apache.thrift.TUnion;\n+import org.apache.thrift.meta_data.EnumMetaData;\n+import org.apache.thrift.meta_data.FieldMetaData;\n+import org.apache.thrift.meta_data.FieldValueMetaData;\n+import org.apache.thrift.meta_data.ListMetaData;\n+import org.apache.thrift.meta_data.MapMetaData;\n+import org.apache.thrift.meta_data.SetMetaData;\n+import org.apache.thrift.meta_data.StructMetaData;\n+import org.apache.thrift.protocol.TType;\n+import org.checkerframework.checker.nullness.qual.NonNull;\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+/**\n+ * Schema provider for generated thrift types.\n+ *\n+ * <ul>\n+ *   <li>primitive type mapping is straight-forward (e.g. {@link TType#I32} -> {@link\n+ *       FieldType#INT32})\n+ *   <li>{@link TType#STRING} gets mapped as either {@link FieldType#STRING} or {@link\n+ *       FieldType#BYTES}, depending on whether the {@link FieldValueMetaData#isBinary()} flag is\n+ *       set.\n+ *   <li>{@link TType#MAP} becomes {@link FieldType#map(FieldType, FieldType) a beam map} passing\n+ *       the key and value types recursively\n+ *   <li>{@link TType#SET} gets translated into a beam {@link FieldType#iterable(FieldType)\n+ *       iterable}, passing the corresponding element type\n+ *   <li>{@link TType#LIST} becomes an {@link FieldType#array(FieldType) array} of the corresponding\n+ *       element type\n+ *   <li>{@link TType#ENUM thrift enums} are converted into {@link EnumerationType beam enumeration\n+ *       types}\n+ *   <li>{@link TUnion thrift union} types get mapped to {@link OneOfType beam one-of} types\n+ * </ul>\n+ *\n+ * <p>The mapping logic relies on the available {@link FieldMetaData thrift metadata} introspection\n+ * and tries to make as few assumptions about the generated code as possible (i.e. does not rely on\n+ * accessor naming convention, as the thrift compiler supports options such as \"beans\" or\n+ * \"fullcamel\"/\"nocamel\".<br>\n+ * However, the following strong assumptions are made by this class:\n+ *\n+ * <ul>\n+ *   <li>all thrift generated classes implement {@link TBase}, except for enums which become {@link\n+ *       Enum java enums} implementing {@link TEnum}\n+ *   <li>all {@link TUnion} types provide static factory methods for each of the supported field\n+ *       types, with the same name as the field itself and only one such method taking a single\n+ *       parameter exists.\n+ *   <li>all non-union types have a corresponding java field with the same name for every field in\n+ *       the original thrift source file\n+ *   <li>the underlying {@link FieldMetaData#getStructMetaDataMap(Class) metadata maps} are {@link\n+ *       java.util.EnumMap enum maps}, so the natural order of the field keys is preserved\n+ * </ul>\n+ *\n+ * <p>Thrift typedefs for container types (and possibly others) do not preserve the full type\n+ * information. For this reason, this class allows for {@link #custom() manual registration} of such\n+ * \"lossy\" typedefs with their corresponding beam types.\n+ */\n+@Experimental(Experimental.Kind.SCHEMAS)\n+public final class ThriftSchema extends GetterBasedSchemaProvider {\n+  private static final ThriftSchema defaultProvider = new ThriftSchema(Collections.emptyMap());\n+\n+  private final Map<String, FieldType> typedefs;\n+\n+  private ThriftSchema(Map<String, FieldType> typedefs) {\n+    this.typedefs = typedefs;\n+  }\n+\n+  /**\n+   * Schema provider that maps any thrift type to a Beam schema, assuming that any typedefs that\n+   * might have been used in the thrift definitions will preserve all required metadata to infer the\n+   * beam type (which is the case for any primitive typedefs and alike).\n+   *\n+   * @see #custom() for how to manually pass the beam type for container typedefs\n+   */\n+  public static @NonNull SchemaProvider provider() {\n+    return defaultProvider;\n+  }\n+\n+  /**\n+   * Builds a schema provider that maps any thrift type to a Beam schema, allowing for custom thrift\n+   * typedef entries (which cannot be resolved using the available metadata) to be manually\n+   * registered with their corresponding beam types.\n+   *\n+   * <p>E.g. {@code typedef set<string> StringSet} will not carry the element type information and\n+   * needs to be manually mapped here as {@code .custom().withTypedef(\"StringSet\",\n+   * FieldType.iterable(FieldType.STRING)).provider()}.\n+   */\n+  public static @NonNull Customizer custom() {\n+    return new Customizer();\n+  }\n+\n+  public static final class Customizer {\n+    private final Map<String, FieldType> typedefs = new HashMap<>();\n+\n+    private Customizer() {}\n+\n+    public @NonNull Customizer typedef(\n+        @NonNull String thriftTypedefName, @NonNull FieldType beamType) {\n+      typedefs.put(thriftTypedefName, beamType);\n+      return this;\n+    }\n+\n+    public @NonNull SchemaProvider provider() {\n+      if (typedefs.isEmpty()) {\n+        return defaultProvider;\n+      } else {\n+        return new ThriftSchema(unmodifiableMap(new HashMap<>(typedefs)));\n+      }\n+    }\n+  }\n+\n+  @Override\n+  public <T> @NonNull Schema schemaFor(TypeDescriptor<T> typeDescriptor) {\n+    return schemaFor(typeDescriptor.getRawType());\n+  }\n+\n+  private Schema schemaFor(Class<?> targetClass) {\n+    if (!TBase.class.isAssignableFrom(targetClass)) {\n+      throw new IllegalArgumentException(\"Expected thrift class but got: \" + targetClass);\n+    }\n+    final Stream<Schema.Field> fields =\n+        thriftFieldDescriptors(targetClass).values().stream().map(this::beamField);\n+    if (TUnion.class.isAssignableFrom(targetClass)) {\n+      return OneOfType.create(fields.collect(Collectors.toList())).getOneOfSchema();\n+    } else {\n+      return fields\n+          .reduce(Schema.builder(), Builder::addField, ThriftSchema::throwingCombiner)\n+          .build();\n+    }\n+  }\n+\n+  private static <X> X throwingCombiner(X lhs, X rhs) {\n+    throw new IllegalStateException();\n+  }\n+\n+  private Schema.Field beamField(FieldMetaData fieldDescriptor) {\n+    try {\n+      final FieldType type = beamType(fieldDescriptor.valueMetaData);\n+      return Schema.Field.nullable(fieldDescriptor.fieldName, type);\n+    } catch (Exception e) {\n+      throw new IllegalStateException(\n+          \"Could not infer beam type for thrift field: \" + fieldDescriptor.fieldName, e);\n+    }\n+  }\n+\n+  @SuppressWarnings(\"rawtypes\")\n+  @Override\n+  public @NonNull List<FieldValueGetter> fieldValueGetters(\n+      @NonNull Class<?> targetClass, @NonNull Schema schema) {\n+    return thriftFieldDescriptors(targetClass).keySet().stream()\n+        .map(FieldExtractor::new)\n+        .collect(Collectors.toList());\n+  }\n+\n+  @Override\n+  public @NonNull List<FieldValueTypeInformation> fieldValueTypeInformations(\n+      @NonNull Class<?> targetClass, @NonNull Schema schema) {\n+    return thriftFieldDescriptors(targetClass).values().stream()\n+        .map(descriptor -> fieldValueTypeInfo(targetClass, descriptor.fieldName))\n+        .collect(Collectors.toList());\n+  }\n+\n+  @SuppressWarnings(\"unchecked\")\n+  private static <FieldT extends Enum<FieldT> & TFieldIdEnum, T extends TBase<T, FieldT>>\n+      Map<FieldT, FieldMetaData> thriftFieldDescriptors(Class<?> targetClass) {\n+    return (Map<FieldT, FieldMetaData>) FieldMetaData.getStructMetaDataMap((Class<T>) targetClass);\n+  }\n+\n+  private FieldValueTypeInformation fieldValueTypeInfo(Class<?> type, String fieldName) {\n+    if (TUnion.class.isAssignableFrom(type)) {\n+      final List<Method> factoryMethods =\n+          Stream.of(type.getDeclaredMethods())\n+              .filter(m -> m.getName().equals(fieldName))\n+              .filter(m -> m.getModifiers() == (Modifier.PUBLIC | Modifier.STATIC))\n+              .filter(m -> m.getParameterCount() == 1)\n+              .filter(m -> m.getReturnType() == type)\n+              .collect(Collectors.toList());\n+      if (factoryMethods.isEmpty()) {\n+        throw new IllegalArgumentException(\n+            String.format(\n+                \"No suitable static factory method: %s.%s(...)\", type.getName(), fieldName));\n+      }\n+      if (factoryMethods.size() > 1) {\n+        throw new IllegalStateException(\"Overloaded factory methods: \" + factoryMethods);", "originalCommit": "eeb61beab08eb0ce5cf96e552f0b3c26729b9290", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8d0f8b7c4d3df79ede20c50b437b8c47a57b0d43", "url": "https://github.com/apache/beam/commit/8d0f8b7c4d3df79ede20c50b437b8c47a57b0d43", "message": "fixup! [BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-10T17:08:09Z", "type": "forcePushed"}, {"oid": "a6dd902af8b977036c161c091dc3e7eaaf221f88", "url": "https://github.com/apache/beam/commit/a6dd902af8b977036c161c091dc3e7eaaf221f88", "message": "[code review] nullness checks in tests", "committedDate": "2020-12-10T19:30:51Z", "type": "forcePushed"}, {"oid": "d198a92c020d51d2132faa531b0f5d0157a8aa5f", "url": "https://github.com/apache/beam/commit/d198a92c020d51d2132faa531b0f5d0157a8aa5f", "message": "[code review] nullness checks in tests", "committedDate": "2020-12-10T19:31:40Z", "type": "forcePushed"}, {"oid": "dc74eb58f59d13fd83012bfd4e32fb6f9d83832f", "url": "https://github.com/apache/beam/commit/dc74eb58f59d13fd83012bfd4e32fb6f9d83832f", "message": "[code review] nullness checks in tests", "committedDate": "2020-12-10T22:47:53Z", "type": "forcePushed"}, {"oid": "f332db5e4c6e2e050db7455665d83365760c092f", "url": "https://github.com/apache/beam/commit/f332db5e4c6e2e050db7455665d83365760c092f", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-11T10:48:44Z", "type": "commit"}, {"oid": "f332db5e4c6e2e050db7455665d83365760c092f", "url": "https://github.com/apache/beam/commit/f332db5e4c6e2e050db7455665d83365760c092f", "message": "[BEAM-11338] Beam schema for thrift data", "committedDate": "2020-12-11T10:48:44Z", "type": "forcePushed"}]}