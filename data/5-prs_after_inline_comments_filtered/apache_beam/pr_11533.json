{"pr_number": 11533, "pr_title": "[BEAM-9827] Ensure minimum watermark hold is computed across all keys", "pr_createdAt": "2020-04-27T10:27:56Z", "pr_url": "https://github.com/apache/beam/pull/11533", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTcxNQ==", "url": "https://github.com/apache/beam/pull/11533#discussion_r415735715", "bodyText": "To sum up if I understand this correctly\n\nWe only need to keep a single value (the minimum)\nWe can not use scalar value that would hold the minimum, because we need a mutable wrapper\n\nin this case can we only keep the minimum value in order to have O(log N) complexity? eg.:\nvoid insertAndKeepMinimum(PriorityQueue<T> pq, T element) {\n  pq.insert(element)\n  while(pq.size() > 1) {\n    pq.remove();\n  }\n}\n\npq.remove(T ...) has linear time complexity", "author": "dmvk", "createdAt": "2020-04-27T11:33:52Z", "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/wrappers/streaming/state/FlinkStateInternals.java", "diffHunk": "@@ -76,8 +76,8 @@\n   private final KeyedStateBackend<ByteBuffer> flinkStateBackend;\n   private Coder<K> keyCoder;\n \n-  // Combined watermark holds for all keys of this partition\n-  private final Map<String, Instant> watermarkHolds = new HashMap<>();\n+  // Watermark holds for all keys/windows of this partition\n+  private final PriorityQueue<Long> watermarkHolds = new PriorityQueue<>();", "originalCommit": "fc00b4b3d47ee3d4e56752673bb0cd6f10432b2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc0NjgyMQ==", "url": "https://github.com/apache/beam/pull/11533#discussion_r415746821", "bodyText": "Hmm, I see it now, FlinkWatermarkHoldState is per window :/", "author": "dmvk", "createdAt": "2020-04-27T11:52:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgwMjUyMg==", "url": "https://github.com/apache/beam/pull/11533#discussion_r415802522", "bodyText": "Only keeping the minimum doesn't work. When the minimum hold is cleared, we will have to recompute the minimum by iterating over all the keys in the state backend which will defeat the purpose of having the cache.", "author": "mxm", "createdAt": "2020-04-27T13:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgxMjE0NQ==", "url": "https://github.com/apache/beam/pull/11533#discussion_r415812145", "bodyText": "\ud83d\udc4d that makes sense\nIt would be nice if we could get rid of pq.remove(...) calls as these are O(n) and number of keys may be fairly large. How about using TreeMap<Long, Integer> instead, where value would be number of references to that particular offset?\nThis should have O(log n) characteristic and may hopefully deduplicate some of the entries.", "author": "dmvk", "createdAt": "2020-04-27T13:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg1MTk4MA==", "url": "https://github.com/apache/beam/pull/11533#discussion_r415851980", "bodyText": "Good idea. I've changed it to use a TreeMap.", "author": "mxm", "createdAt": "2020-04-27T14:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTcxNQ=="}], "type": "inlineReview"}, {"oid": "0d12aa56bc91de8a8a1d272657996d1094533f5c", "url": "https://github.com/apache/beam/commit/0d12aa56bc91de8a8a1d272657996d1094533f5c", "message": "[BEAM-9827] Ensure minimum watermark hold is computed across all keys\n\nFor computing the current output watermark we need to compute the minimum\nwatermark hold across all watermark holds. We maintain an in-memory view of all\nwatermark holds because iterating over all keys is an expensive operation which\nwe only want to do when restoring from a checkpoint, not on every watermark.\n\nThe watermark view may not be in sync with its backing managed state. This\nchange corrects this by maintaining a TreeMap with all watermark holds and\nadding additional tests.", "committedDate": "2020-04-27T14:17:03Z", "type": "commit"}, {"oid": "0d12aa56bc91de8a8a1d272657996d1094533f5c", "url": "https://github.com/apache/beam/commit/0d12aa56bc91de8a8a1d272657996d1094533f5c", "message": "[BEAM-9827] Ensure minimum watermark hold is computed across all keys\n\nFor computing the current output watermark we need to compute the minimum\nwatermark hold across all watermark holds. We maintain an in-memory view of all\nwatermark holds because iterating over all keys is an expensive operation which\nwe only want to do when restoring from a checkpoint, not on every watermark.\n\nThe watermark view may not be in sync with its backing managed state. This\nchange corrects this by maintaining a TreeMap with all watermark holds and\nadding additional tests.", "committedDate": "2020-04-27T14:17:03Z", "type": "forcePushed"}]}