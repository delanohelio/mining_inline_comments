{"pr_number": 12786, "pr_title": "[BEAM-7925]Add Column Projection to ParquetIO", "pr_createdAt": "2020-09-08T18:51:40Z", "pr_url": "https://github.com/apache/beam/pull/12786", "timeline": [{"oid": "40275abb71e511e553b9c0c35a5834f44f21aa0a", "url": "https://github.com/apache/beam/commit/40275abb71e511e553b9c0c35a5834f44f21aa0a", "message": "[BEAM-7925]add projection", "committedDate": "2020-09-08T18:47:46Z", "type": "commit"}, {"oid": "25a2368f8065daf402347c8b2dbee6a1d60e007a", "url": "https://github.com/apache/beam/commit/25a2368f8065daf402347c8b2dbee6a1d60e007a", "message": "[BEAM-7925]spotless", "committedDate": "2020-09-08T18:50:24Z", "type": "commit"}, {"oid": "a334bac48f808380386e1a7bb15a68d159045ef2", "url": "https://github.com/apache/beam/commit/a334bac48f808380386e1a7bb15a68d159045ef2", "message": "[BEAM-7925]add schema encoder", "committedDate": "2020-09-08T20:25:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzODc4NQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485238785", "bodyText": "Please also mention that withSplit() will be enabled automatically.", "author": "ihji", "createdAt": "2020-09-08T22:53:17Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -135,6 +135,16 @@\n  * ...\n  * }</pre>\n  *\n+ * <p>Reading with projection can be enabled with the projection schema as following. The\n+ * projection_schema contains only the column that we would like to read and encoder_schema contains\n+ * all field but with the unwanted columns changed to nullable.", "originalCommit": "a334bac48f808380386e1a7bb15a68d159045ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NDMyOA==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485264328", "bodyText": "Added.", "author": "danielxjd", "createdAt": "2020-09-09T00:18:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzODc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzOTc5NA==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485239794", "bodyText": "I think getProjectionSchema represents the field better.", "author": "ihji", "createdAt": "2020-09-08T22:56:19Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -194,6 +204,10 @@ public static ReadFiles readFiles(Schema schema) {\n \n     abstract @Nullable Schema getSchema();\n \n+    abstract @Nullable Schema getProjection();", "originalCommit": "a334bac48f808380386e1a7bb15a68d159045ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NDMwOQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485264309", "bodyText": "Changed.", "author": "danielxjd", "createdAt": "2020-09-09T00:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzOTc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzOTg2MQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485239861", "bodyText": "ditto.", "author": "ihji", "createdAt": "2020-09-08T22:56:30Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -209,6 +223,10 @@ public static ReadFiles readFiles(Schema schema) {\n \n       abstract Builder setSchema(Schema schema);\n \n+      abstract Builder setProjectionEncoder(Schema schema);\n+\n+      abstract Builder setProjection(Schema schema);", "originalCommit": "a334bac48f808380386e1a7bb15a68d159045ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NDI1MQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485264251", "bodyText": "Changed.", "author": "danielxjd", "createdAt": "2020-09-09T00:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzOTg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0MDMwMg==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485240302", "bodyText": "ditto.", "author": "ihji", "createdAt": "2020-09-08T22:57:56Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -269,6 +298,10 @@ public void populateDisplayData(DisplayData.Builder builder) {\n \n     abstract @Nullable GenericData getAvroDataModel();\n \n+    abstract @Nullable Schema getProjectionEncoder();\n+\n+    abstract @Nullable Schema getProjection();", "originalCommit": "a334bac48f808380386e1a7bb15a68d159045ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NDIzMQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485264231", "bodyText": "Changed.", "author": "danielxjd", "createdAt": "2020-09-09T00:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0MDMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0MDMzNg==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485240336", "bodyText": "ditto.", "author": "ihji", "createdAt": "2020-09-08T22:58:03Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -279,6 +312,10 @@ public void populateDisplayData(DisplayData.Builder builder) {\n \n       abstract Builder setAvroDataModel(GenericData model);\n \n+      abstract Builder setProjectionEncoder(Schema schema);\n+\n+      abstract Builder setProjection(Schema schema);", "originalCommit": "a334bac48f808380386e1a7bb15a68d159045ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NDIwOA==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485264208", "bodyText": "Changed", "author": "danielxjd", "createdAt": "2020-09-09T00:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0MDMzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1MjA2OA==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485252068", "bodyText": "To minimize duplication:\nSchema coderSchema = getProjection() == null ? getSchema() : getProjectionEncoder(); \nreturn input\n              .apply(ParDo.of(new SplitReadFn(getAvroDataModel(), getProjection())))\n              .setCoder(AvroCoder.of(coderSchema));", "author": "ihji", "createdAt": "2020-09-08T23:35:53Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -299,9 +344,14 @@ public ReadFiles withSplit() {\n     public PCollection<GenericRecord> expand(PCollection<FileIO.ReadableFile> input) {\n       checkNotNull(getSchema(), \"Schema can not be null\");\n       if (isSplittable()) {\n+        if (getProjection() == null) {", "originalCommit": "a334bac48f808380386e1a7bb15a68d159045ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NDE3NA==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485264174", "bodyText": "Changed.", "author": "danielxjd", "createdAt": "2020-09-09T00:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1MjA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1MzU3NA==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485253574", "bodyText": "Is there any reason to use String instead of Schema? Looks like this is referred only once.", "author": "ihji", "createdAt": "2020-09-08T23:40:47Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -312,12 +362,14 @@ public ReadFiles withSplit() {\n     static class SplitReadFn extends DoFn<FileIO.ReadableFile, GenericRecord> {\n       private Class<? extends GenericData> modelClass;\n       private static final Logger LOG = LoggerFactory.getLogger(SplitReadFn.class);\n+      private String requestSchemaString;", "originalCommit": "a334bac48f808380386e1a7bb15a68d159045ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2MDA0MQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485260041", "bodyText": "Because the Schema class is not serializable so can only pass with string.", "author": "danielxjd", "createdAt": "2020-09-09T00:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1MzU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1NTYxMw==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485255613", "bodyText": "Just out of curiosity: hadoopConf is from options, is this necessary to set properties from options again?", "author": "ihji", "createdAt": "2020-09-08T23:47:46Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -336,36 +388,41 @@ public void processElement(\n                 + tracker.currentRestriction().getFrom()\n                 + \" to \"\n                 + tracker.currentRestriction().getTo());\n-        ParquetReadOptions options = HadoopReadOptions.builder(getConfWithModelClass()).build();\n-        ParquetFileReader reader =\n-            ParquetFileReader.open(new BeamParquetInputFile(file.openSeekable()), options);\n+        Configuration conf = getConfWithModelClass();\n         GenericData model = null;\n         if (modelClass != null) {\n           model = (GenericData) modelClass.getMethod(\"get\").invoke(null);\n         }\n-        ReadSupport<GenericRecord> readSupport = new AvroReadSupport<GenericRecord>(model);\n-\n+        AvroReadSupport<GenericRecord> readSupport = new AvroReadSupport<GenericRecord>(model);\n+        if (requestSchemaString != null) {\n+          AvroReadSupport.setRequestedProjection(\n+              conf, new Schema.Parser().parse(requestSchemaString));\n+        }\n+        ParquetReadOptions options = HadoopReadOptions.builder(conf).build();\n+        ParquetFileReader reader =\n+            ParquetFileReader.open(new BeamParquetInputFile(file.openSeekable()), options);\n         Filter filter = checkNotNull(options.getRecordFilter(), \"filter\");\n         Configuration hadoopConf = ((HadoopReadOptions) options).getConf();\n+        for (String property : options.getPropertyNames()) {\n+          hadoopConf.set(property, options.getProperty(property));", "originalCommit": "a334bac48f808380386e1a7bb15a68d159045ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2MDMwNg==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485260306", "bodyText": "You are right ,I should delete this part.", "author": "danielxjd", "createdAt": "2020-09-09T00:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1NTYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1NjQ2Mg==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485256462", "bodyText": "Is this okay to be skipped?", "author": "ihji", "createdAt": "2020-09-08T23:50:31Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -336,36 +388,41 @@ public void processElement(\n                 + tracker.currentRestriction().getFrom()\n                 + \" to \"\n                 + tracker.currentRestriction().getTo());\n-        ParquetReadOptions options = HadoopReadOptions.builder(getConfWithModelClass()).build();\n-        ParquetFileReader reader =\n-            ParquetFileReader.open(new BeamParquetInputFile(file.openSeekable()), options);\n+        Configuration conf = getConfWithModelClass();\n         GenericData model = null;\n         if (modelClass != null) {\n           model = (GenericData) modelClass.getMethod(\"get\").invoke(null);\n         }\n-        ReadSupport<GenericRecord> readSupport = new AvroReadSupport<GenericRecord>(model);\n-\n+        AvroReadSupport<GenericRecord> readSupport = new AvroReadSupport<GenericRecord>(model);\n+        if (requestSchemaString != null) {\n+          AvroReadSupport.setRequestedProjection(\n+              conf, new Schema.Parser().parse(requestSchemaString));\n+        }\n+        ParquetReadOptions options = HadoopReadOptions.builder(conf).build();\n+        ParquetFileReader reader =\n+            ParquetFileReader.open(new BeamParquetInputFile(file.openSeekable()), options);\n         Filter filter = checkNotNull(options.getRecordFilter(), \"filter\");\n         Configuration hadoopConf = ((HadoopReadOptions) options).getConf();\n+        for (String property : options.getPropertyNames()) {\n+          hadoopConf.set(property, options.getProperty(property));\n+        }\n         FileMetaData parquetFileMetadata = reader.getFooter().getFileMetaData();\n         MessageType fileSchema = parquetFileMetadata.getSchema();\n         Map<String, String> fileMetadata = parquetFileMetadata.getKeyValueMetaData();\n-\n         ReadSupport.ReadContext readContext =\n             readSupport.init(\n                 new InitContext(\n                     hadoopConf, Maps.transformValues(fileMetadata, ImmutableSet::of), fileSchema));\n         ColumnIOFactory columnIOFactory = new ColumnIOFactory(parquetFileMetadata.getCreatedBy());\n-        MessageType requestedSchema = readContext.getRequestedSchema();\n+\n         RecordMaterializer<GenericRecord> recordConverter =\n             readSupport.prepareForRead(hadoopConf, fileMetadata, fileSchema, readContext);\n-        reader.setRequestedSchema(requestedSchema);", "originalCommit": "a334bac48f808380386e1a7bb15a68d159045ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2MjgxMQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485262811", "bodyText": "Maybe I should leave this line", "author": "danielxjd", "createdAt": "2020-09-09T00:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1NjQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1ODg0NQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485258845", "bodyText": "It would be also great if we could mention what is the expected improvement by projecting columns such as better memory usage or faster reading time.", "author": "ihji", "createdAt": "2020-09-08T23:58:44Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -135,6 +135,16 @@\n  * ...\n  * }</pre>\n  *\n+ * <p>Reading with projection can be enabled with the projection schema as following. The\n+ * projection_schema contains only the column that we would like to read and encoder_schema contains\n+ * all field but with the unwanted columns changed to nullable.\n+ *", "originalCommit": "a334bac48f808380386e1a7bb15a68d159045ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NDEzNQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485264135", "bodyText": "Added", "author": "danielxjd", "createdAt": "2020-09-09T00:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1ODg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM4Mzg1OA==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485383858", "bodyText": "The description is still a bit vague. Can you please elaborate more on how much improvement users could expect from the column projection? For example, if the transform with the column projection only reads a half of the columns, does it also use only half of the memory and finish two times faster than the transform without the column projection? (If not, why is that?)", "author": "ihji", "createdAt": "2020-09-09T07:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1ODg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc3OTcyNQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485779725", "bodyText": "The improvement is not as significant, since the processing time saved is only the time to read the unwanted columns, the reader will still go over the entire data set since data for each column in a row is stored interleaved. So the test showed that there is only a slight reduction in the reading time. For the memory, it is hard for me to track with the Dataflow server.", "author": "danielxjd", "createdAt": "2020-09-09T17:03:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1ODg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg4Mzg2OA==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485883868", "bodyText": "Please also adding\nNote that the improvement is not as significant though, since the processing\ntime saved is only the time to read the unwanted columns, the reader will still\ngo over the entire data set since data for each column in a row is stored interleaved.\n\nto the comments. It will help users a lot to understand how the column projection works.", "author": "ihji", "createdAt": "2020-09-09T19:56:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1ODg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5MTYyNw==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485891627", "bodyText": "Added", "author": "danielxjd", "createdAt": "2020-09-09T20:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1ODg0NQ=="}], "type": "inlineReview"}, {"oid": "2dc5048f15a3b209740db2319e7e8b1688702559", "url": "https://github.com/apache/beam/commit/2dc5048f15a3b209740db2319e7e8b1688702559", "message": "rename and remove duplicates", "committedDate": "2020-09-09T00:16:53Z", "type": "commit"}, {"oid": "49114534fa52f057595a28d754357f168c8b0ecc", "url": "https://github.com/apache/beam/commit/49114534fa52f057595a28d754357f168c8b0ecc", "message": "Modify description", "committedDate": "2020-09-09T18:38:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg4NDY1MQ==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485884651", "bodyText": "increase or decrease?", "author": "ihji", "createdAt": "2020-09-09T19:57:19Z", "path": "sdks/java/io/parquet/src/main/java/org/apache/beam/sdk/io/parquet/ParquetIO.java", "diffHunk": "@@ -135,6 +135,20 @@\n  * ...\n  * }</pre>\n  *\n+ * <p>Reading with projection can be enabled with the projection schema as following. Splittable\n+ * reading is enabled when reading with projection. The projection_schema contains only the column\n+ * that we would like to read and encoder_schema contains the schema to encode the output with the\n+ * unwanted columns changed to nullable. Partial reading provide increase of reading time due to", "originalCommit": "49114534fa52f057595a28d754357f168c8b0ecc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg4Nzk5NA==", "url": "https://github.com/apache/beam/pull/12786#discussion_r485887994", "bodyText": "should be decrease", "author": "danielxjd", "createdAt": "2020-09-09T20:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg4NDY1MQ=="}], "type": "inlineReview"}, {"oid": "1c3a9c2ed542d1efb7294a1c0a2329715c1b6bd2", "url": "https://github.com/apache/beam/commit/1c3a9c2ed542d1efb7294a1c0a2329715c1b6bd2", "message": "Add description", "committedDate": "2020-09-09T20:07:58Z", "type": "commit"}]}