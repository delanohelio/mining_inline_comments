{"pr_number": 12711, "pr_title": "Support read/write ZetaSQL DATETIME/NUMERIC types from/to BigQuery", "pr_createdAt": "2020-08-27T23:48:04Z", "pr_url": "https://github.com/apache/beam/pull/12711", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MzczNA==", "url": "https://github.com/apache/beam/pull/12711#discussion_r487193734", "bodyText": "It's possible for users of BigQueryIO to hit this code path through BigQueryIO.readTableRowsWithSchema() right? This will be a breaking change since the Java type for a DATETIME field changes from Instant to LocalDateTime. I think that's ok since it's experimental, but we should add a note to CHANGES.md", "author": "TheNeuralBit", "createdAt": "2020-09-11T17:40:59Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -257,10 +263,9 @@ private static FieldType fromTableFieldSchemaType(\n       case \"DATE\":\n         return FieldType.logicalType(SqlTypes.DATE);\n       case \"DATETIME\":\n-        // TODO[BEAM-10240]: map to the new logical type when ZetaSQL DATETIME type is supported\n-        return FieldType.logicalType(\n-            new PassThroughLogicalType<Instant>(\n-                \"SqlTimestampWithLocalTzType\", FieldType.STRING, \"\", FieldType.DATETIME) {});\n+        return FieldType.logicalType(SqlTypes.DATETIME);", "originalCommit": "705046e2c5275c3efcc3d0f6f541ae53d72df252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMyNzY2NA==", "url": "https://github.com/apache/beam/pull/12711#discussion_r516327664", "bodyText": "Done. Thanks for catching this.", "author": "robinyqiu", "createdAt": "2020-11-02T23:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MzczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MzgyOQ==", "url": "https://github.com/apache/beam/pull/12711#discussion_r487193829", "bodyText": "Could you make sure that BigQueryUtils.fromTableSchema is tested with NUMERIC and DATETIME? It looks like only TIMESTAMP may be tested now (as part of testTableFromSchema_flat): \n  \n    \n      beam/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtilsTest.java\n    \n    \n        Lines 91 to 106\n      in\n      738a910\n    \n    \n    \n    \n\n        \n          \n           private static final TableFieldSchema TIMESTAMP_VARIANT1 = \n        \n\n        \n          \n               new TableFieldSchema() \n        \n\n        \n          \n                   .setName(\"timestamp_variant1\") \n        \n\n        \n          \n                   .setType(StandardSQLTypeName.TIMESTAMP.toString()); \n        \n\n        \n          \n           private static final TableFieldSchema TIMESTAMP_VARIANT2 = \n        \n\n        \n          \n               new TableFieldSchema() \n        \n\n        \n          \n                   .setName(\"timestamp_variant2\") \n        \n\n        \n          \n                   .setType(StandardSQLTypeName.TIMESTAMP.toString()); \n        \n\n        \n          \n           private static final TableFieldSchema TIMESTAMP_VARIANT3 = \n        \n\n        \n          \n               new TableFieldSchema() \n        \n\n        \n          \n                   .setName(\"timestamp_variant3\") \n        \n\n        \n          \n                   .setType(StandardSQLTypeName.TIMESTAMP.toString()); \n        \n\n        \n          \n           private static final TableFieldSchema TIMESTAMP_VARIANT4 = \n        \n\n        \n          \n               new TableFieldSchema() \n        \n\n        \n          \n                   .setName(\"timestamp_variant4\") \n        \n\n        \n          \n                   .setType(StandardSQLTypeName.TIMESTAMP.toString());", "author": "TheNeuralBit", "createdAt": "2020-09-11T17:41:09Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtilsTest.java", "diffHunk": "@@ -452,6 +457,27 @@ public void testMicroPrecisionTimeType() {\n         equalTo(t));\n   }\n \n+  @Test\n+  public void testMicroPrecisionDateTimeType() {\n+    LocalDateTime dt = LocalDateTime.parse(\"2020-06-04T12:34:56.789876\");\n+    assertThat(\n+        BigQueryUtils.convertAvroFormat(\n+            FieldType.logicalType(SqlTypes.DATETIME), new Utf8(dt.toString()), REJECT_OPTIONS),\n+        equalTo(dt));\n+  }\n+\n+  @Test\n+  public void testNumericType() {\n+    // BigQuery NUMERIC type has precision 38 and scale 9\n+    BigDecimal n = new BigDecimal(\"123456789.987654321\").setScale(9);\n+    assertThat(\n+        BigQueryUtils.convertAvroFormat(\n+            FieldType.DECIMAL,\n+            new Conversions.DecimalConversion().toBytes(n, null, LogicalTypes.decimal(38, 9)),\n+            REJECT_OPTIONS),\n+        equalTo(n));\n+  }\n+", "originalCommit": "705046e2c5275c3efcc3d0f6f541ae53d72df252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMyNzg4Nw==", "url": "https://github.com/apache/beam/pull/12711#discussion_r516327887", "bodyText": "Done. Added test for new types: DATE, TIME, and DATETIME.\nTests for NUMERICS is already added in #12730", "author": "robinyqiu", "createdAt": "2020-11-02T23:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MzgyOQ=="}], "type": "inlineReview"}, {"oid": "3e373cad7192cd23317acc538ce1d4b3ca0d1e8d", "url": "https://github.com/apache/beam/commit/3e373cad7192cd23317acc538ce1d4b3ca0d1e8d", "message": "Support read/write ZetaSQL DATETIME/NUMERIC types from/to BigQuery", "committedDate": "2020-11-02T19:03:54Z", "type": "forcePushed"}, {"oid": "8ff1deca30c34658d81e1190e58b513df24e07be", "url": "https://github.com/apache/beam/commit/8ff1deca30c34658d81e1190e58b513df24e07be", "message": "Support read/write ZetaSQL DATETIME/NUMERIC types from/to BigQuery", "committedDate": "2020-11-02T21:15:17Z", "type": "commit"}, {"oid": "8ff1deca30c34658d81e1190e58b513df24e07be", "url": "https://github.com/apache/beam/commit/8ff1deca30c34658d81e1190e58b513df24e07be", "message": "Support read/write ZetaSQL DATETIME/NUMERIC types from/to BigQuery", "committedDate": "2020-11-02T21:15:17Z", "type": "forcePushed"}, {"oid": "e96168a4428ac13fb54e65f8c052da1da9100fd2", "url": "https://github.com/apache/beam/commit/e96168a4428ac13fb54e65f8c052da1da9100fd2", "message": "Address comments", "committedDate": "2020-11-02T23:22:07Z", "type": "commit"}]}