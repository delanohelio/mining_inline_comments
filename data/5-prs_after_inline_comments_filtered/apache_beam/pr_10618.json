{"pr_number": 10618, "pr_title": "[BEAM-8630] Turn on BeamZetaSqlCalcRel", "pr_createdAt": "2020-01-17T00:15:57Z", "pr_url": "https://github.com/apache/beam/pull/10618", "timeline": [{"oid": "1bf1f5dc952976438edfaef59bd8883ccf7cd07e", "url": "https://github.com/apache/beam/commit/1bf1f5dc952976438edfaef59bd8883ccf7cd07e", "message": "Fix broken windowing function in BeamZetaSqlCalcRel", "committedDate": "2020-01-24T00:59:34Z", "type": "forcePushed"}, {"oid": "b1acfe1d5da03b6980f02ec46c94a40e2c2682e8", "url": "https://github.com/apache/beam/commit/b1acfe1d5da03b6980f02ec46c94a40e2c2682e8", "message": "Turn on BeamZetaSqlCalcRel", "committedDate": "2020-01-24T21:26:01Z", "type": "forcePushed"}, {"oid": "abfbfb44a3c08bc471a1a9bffb24bf8587d65481", "url": "https://github.com/apache/beam/commit/abfbfb44a3c08bc471a1a9bffb24bf8587d65481", "message": "Turn on BeamZetaSqlCalcRel", "committedDate": "2020-01-24T21:29:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTYwNw==", "url": "https://github.com/apache/beam/pull/10618#discussion_r370861607", "bodyText": "Can you add this to SqlOperators.java and add the two calls above as a constant there instead?", "author": "apilloud", "createdAt": "2020-01-24T22:00:24Z", "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/translation/ExpressionConverter.java", "diffHunk": "@@ -486,27 +489,38 @@ private RexNode convertRexNodeFromComputedColumnWithFieldList(\n         return rexBuilder()\n             .makeInputRef(fieldList.get(windowFieldIndex).getType(), windowFieldIndex);\n       case FIXED_WINDOW_END:\n-        // WINDOW END is a function call\n         operands.add(\n             rexBuilder().makeInputRef(fieldList.get(windowFieldIndex).getType(), windowFieldIndex));\n         // TODO: check window_end 's duration is the same as it's aggregate window.\n         operands.add(\n             convertIntervalToRexIntervalLiteral(\n                 (ResolvedLiteral) functionCall.getArgumentList().get(0)));\n-        return rexBuilder().makeCall(SqlStdOperatorTable.PLUS, operands);\n+        return rexBuilder()\n+            .makeCall(createSqlFunction(\"timestamp_add\", SqlTypeName.TIMESTAMP), operands);\n       case SLIDING_WINDOW_END:\n         operands.add(\n             rexBuilder().makeInputRef(fieldList.get(windowFieldIndex).getType(), windowFieldIndex));\n         operands.add(\n             convertIntervalToRexIntervalLiteral(\n                 (ResolvedLiteral) functionCall.getArgumentList().get(1)));\n-        return rexBuilder().makeCall(SqlStdOperatorTable.PLUS, operands);\n+        return rexBuilder()\n+            .makeCall(createSqlFunction(\"timestamp_add\", SqlTypeName.TIMESTAMP), operands);\n       default:\n         throw new RuntimeException(\n             \"Does not support window start/end: \" + functionCall.getFunction().getName());\n     }\n   }\n \n+  private SqlFunction createSqlFunction(String name, SqlTypeName returnType) {", "originalCommit": "abfbfb44a3c08bc471a1a9bffb24bf8587d65481", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3MTk5NQ==", "url": "https://github.com/apache/beam/pull/10618#discussion_r370871995", "bodyText": "Done!", "author": "robinyqiu", "createdAt": "2020-01-24T22:34:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MjE0Mg==", "url": "https://github.com/apache/beam/pull/10618#discussion_r370862142", "bodyText": "Does this actually do anything anymore? Can it be deleted?", "author": "apilloud", "createdAt": "2020-01-24T22:01:52Z", "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/translation/SingleRowScanConverter.java", "diffHunk": "@@ -18,15 +18,8 @@\n package org.apache.beam.sdk.extensions.sql.zetasql.translation;\n \n import com.google.zetasql.resolvedast.ResolvedNodes.ResolvedSingleRowScan;\n-import java.math.BigDecimal;\n import java.util.List;\n-import org.apache.beam.vendor.calcite.v1_20_0.com.google.common.collect.ImmutableList;\n-import org.apache.beam.vendor.calcite.v1_20_0.org.apache.calcite.plan.RelOptCluster;\n import org.apache.beam.vendor.calcite.v1_20_0.org.apache.calcite.rel.RelNode;\n-import org.apache.beam.vendor.calcite.v1_20_0.org.apache.calcite.rel.logical.LogicalValues;\n-import org.apache.beam.vendor.calcite.v1_20_0.org.apache.calcite.rel.type.RelDataType;\n-import org.apache.beam.vendor.calcite.v1_20_0.org.apache.calcite.rex.RexLiteral;\n-import org.apache.beam.vendor.calcite.v1_20_0.org.apache.calcite.sql.type.SqlTypeName;\n \n /** Converts a single row value. */\n class SingleRowScanConverter extends RelConverter<ResolvedSingleRowScan> {", "originalCommit": "abfbfb44a3c08bc471a1a9bffb24bf8587d65481", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2NTg5Nw==", "url": "https://github.com/apache/beam/pull/10618#discussion_r370865897", "bodyText": "You mean the entire SingleRowScanConverter class? This class is still used for generating a dummy single-row input to queries like SELECT \"hello\".", "author": "robinyqiu", "createdAt": "2020-01-24T22:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MjE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3Mjg0Mw==", "url": "https://github.com/apache/beam/pull/10618#discussion_r370872843", "bodyText": "Yea, I think this whole class might be a no-op now, but we can worry about that later.", "author": "apilloud", "createdAt": "2020-01-24T22:37:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MjE0Mg=="}], "type": "inlineReview"}, {"oid": "34e5a1e80e915c05bfda6fc13665909870602f1c", "url": "https://github.com/apache/beam/commit/34e5a1e80e915c05bfda6fc13665909870602f1c", "message": "Turn on BeamZetaSqlCalcRel", "committedDate": "2020-01-24T22:33:43Z", "type": "commit"}, {"oid": "34e5a1e80e915c05bfda6fc13665909870602f1c", "url": "https://github.com/apache/beam/commit/34e5a1e80e915c05bfda6fc13665909870602f1c", "message": "Turn on BeamZetaSqlCalcRel", "committedDate": "2020-01-24T22:33:43Z", "type": "forcePushed"}]}