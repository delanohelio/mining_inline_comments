{"pr_number": 13593, "pr_title": "[BEAM-10925] Convert ScalarFn to Method.", "pr_createdAt": "2020-12-22T00:31:25Z", "pr_url": "https://github.com/apache/beam/pull/13593", "timeline": [{"oid": "b2e1054297df577385ad93c9f39281833354600b", "url": "https://github.com/apache/beam/commit/b2e1054297df577385ad93c9f39281833354600b", "message": "[BEAM-10925] Convert ScalarFn to Method.\n\nThe Method will be passed to createUdfOperator in a future PR.", "committedDate": "2020-12-22T00:29:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTE3MQ==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547041171", "bodyText": "Why is this in zetasql? How will it work for the calcite dialect?", "author": "apilloud", "createdAt": "2020-12-22T03:04:30Z", "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/translation/impl/ScalarFnImpl.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.extensions.sql.zetasql.translation.impl;", "originalCommit": "b2e1054297df577385ad93c9f39281833354600b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4NzAxMw==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547087013", "bodyText": "I think the PR description mentions the reason: The Method will be passed to createUdfOperator in a future PR.", "author": "amaliujia", "createdAt": "2020-12-22T06:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMzU1NA==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547403554", "bodyText": "How will that work for the calcite dialect?", "author": "apilloud", "createdAt": "2020-12-22T17:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQyMjYzMA==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547422630", "bodyText": "There's nothing specific to ZetaSQL in this class, I can move it somewhere else.", "author": "ibzib", "createdAt": "2020-12-22T18:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ1MTcyOQ==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547451729", "bodyText": "createUdfOperator is actually in ZetaSQL only now. But I agree we can move this code to the sql module and later might bring createUdfOperator to that module as well.", "author": "amaliujia", "createdAt": "2020-12-22T19:01:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2MzQ2MQ==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547463461", "bodyText": "Great. My concern here is that there already exists code to do this for Calcite SQL, if so we should just reuse that. It looks like Calcite SQL support just wasn't part of the prototype?", "author": "apilloud", "createdAt": "2020-12-22T19:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3NTY0MQ==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547475641", "bodyText": "My concern here is that there already exists code to do this for Calcite SQL, if so we should just reuse that.\n\nWe do something similar in Calcite SQL, but not exactly because the interfaces are different.\n\nIt looks like Calcite SQL support just wasn't part of the prototype?\n\nYeah, how (if at all) we want to integrate the new APIs into Calcite SQL is an open question.", "author": "ibzib", "createdAt": "2020-12-22T19:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3NzkyMg==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547477922", "bodyText": "What I hope happens it that the UDFs are loaded into the schema in BeamSqlEnvBuilder, then both Calcite and ZetaSQL dialects pull them from there.", "author": "apilloud", "createdAt": "2020-12-22T19:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU0NzY3Nw==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547547677", "bodyText": "What I hope happens it that the UDFs are loaded into the schema in BeamSqlEnvBuilder, then both Calcite and ZetaSQL dialects pull them from there.\n\nI will try doing that for the next PR in this series.", "author": "ibzib", "createdAt": "2020-12-22T23:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4NjY1OA==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547086658", "bodyText": "Makes sense that it has to be public, but why cannot be static? (is it because that implementation overwrites the interface function which is not static)?", "author": "amaliujia", "createdAt": "2020-12-22T06:07:14Z", "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/translation/impl/ScalarFnImpl.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.extensions.sql.zetasql.translation.impl;\n+\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import org.apache.beam.sdk.extensions.sql.udf.ScalarFn;\n+import org.apache.beam.sdk.util.common.ReflectHelpers;\n+\n+/** Implementation logic for {@link ScalarFn}. */\n+public class ScalarFnImpl {\n+  /**\n+   * Gets the method annotated with {@link\n+   * org.apache.beam.sdk.extensions.sql.udf.ScalarFn.ApplyMethod} from {@code scalarFn}.\n+   *\n+   * <p>There must be exactly one method annotated with {@link\n+   * org.apache.beam.sdk.extensions.sql.udf.ScalarFn.ApplyMethod}, and it must be public and\n+   * non-static.\n+   */\n+  public static Method getApplyMethod(ScalarFn scalarFn) {\n+    Class<? extends ScalarFn> clazz = scalarFn.getClass();\n+    Collection<Method> matches =\n+        ReflectHelpers.declaredMethodsWithAnnotation(\n+            ScalarFn.ApplyMethod.class, clazz, ScalarFn.class);\n+\n+    if (matches.isEmpty()) {\n+      throw new IllegalArgumentException(\n+          String.format(\n+              \"No method annotated with @%s found in class %s.\",\n+              ScalarFn.ApplyMethod.class.getSimpleName(), clazz.getName()));\n+    }\n+\n+    // If we have at least one match, then either it should be the only match\n+    // or it should be an extension of the other matches (which came from parent\n+    // classes).\n+    Method first = matches.iterator().next();\n+    for (Method other : matches) {\n+      if (!first.getName().equals(other.getName())\n+          || !Arrays.equals(first.getParameterTypes(), other.getParameterTypes())) {\n+        throw new IllegalArgumentException(\n+            String.format(\n+                \"Found multiple methods annotated with @%s. [%s] and [%s]\",\n+                ScalarFn.ApplyMethod.class.getSimpleName(),\n+                ReflectHelpers.formatMethod(first),\n+                ReflectHelpers.formatMethod(other)));\n+      }\n+    }\n+\n+    // Method must be public and non-static.", "originalCommit": "b2e1054297df577385ad93c9f39281833354600b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQyMTM2NQ==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547421365", "bodyText": "Actually, in our current implementation, I don't think there is any reason it can't be static. I just tested it and it seems to work fine. I will remove this restriction.", "author": "ibzib", "createdAt": "2020-12-22T18:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4NjY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4NjgwNQ==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547086805", "bodyText": "What will happen if we choose one to execute (can print which is chosen and other methods into log)?", "author": "amaliujia", "createdAt": "2020-12-22T06:07:51Z", "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/translation/impl/ScalarFnImpl.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.extensions.sql.zetasql.translation.impl;\n+\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import org.apache.beam.sdk.extensions.sql.udf.ScalarFn;\n+import org.apache.beam.sdk.util.common.ReflectHelpers;\n+\n+/** Implementation logic for {@link ScalarFn}. */\n+public class ScalarFnImpl {\n+  /**\n+   * Gets the method annotated with {@link\n+   * org.apache.beam.sdk.extensions.sql.udf.ScalarFn.ApplyMethod} from {@code scalarFn}.\n+   *\n+   * <p>There must be exactly one method annotated with {@link\n+   * org.apache.beam.sdk.extensions.sql.udf.ScalarFn.ApplyMethod}, and it must be public and\n+   * non-static.\n+   */\n+  public static Method getApplyMethod(ScalarFn scalarFn) {\n+    Class<? extends ScalarFn> clazz = scalarFn.getClass();\n+    Collection<Method> matches =\n+        ReflectHelpers.declaredMethodsWithAnnotation(\n+            ScalarFn.ApplyMethod.class, clazz, ScalarFn.class);\n+\n+    if (matches.isEmpty()) {\n+      throw new IllegalArgumentException(\n+          String.format(\n+              \"No method annotated with @%s found in class %s.\",\n+              ScalarFn.ApplyMethod.class.getSimpleName(), clazz.getName()));\n+    }\n+\n+    // If we have at least one match, then either it should be the only match\n+    // or it should be an extension of the other matches (which came from parent\n+    // classes).\n+    Method first = matches.iterator().next();\n+    for (Method other : matches) {", "originalCommit": "b2e1054297df577385ad93c9f39281833354600b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxMzM3Nw==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547413377", "bodyText": "This is standard inheritance, it shouldn't be any surprise to the user that a child class's implementation of a method overrides a parent class.", "author": "ibzib", "createdAt": "2020-12-22T17:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4NjgwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ1NTk5OA==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547455998", "bodyText": "makes sense!", "author": "amaliujia", "createdAt": "2020-12-22T19:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4NjgwNQ=="}], "type": "inlineReview"}, {"oid": "3885d47025a41cba05e0becc91090d3bafc4bd68", "url": "https://github.com/apache/beam/commit/3885d47025a41cba05e0becc91090d3bafc4bd68", "message": "Allow ApplyMethod to be static.", "committedDate": "2020-12-22T18:41:24Z", "type": "commit"}, {"oid": "3b593dcf66081d836876d48d67ac3d68340a8940", "url": "https://github.com/apache/beam/commit/3b593dcf66081d836876d48d67ac3d68340a8940", "message": "Rename ScalarFnImpl to ScalarFnReflector and move out of ZetaSQL.", "committedDate": "2020-12-22T18:41:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2NzY1OQ==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547467659", "bodyText": "Is there a test you could add to validate inheritance works as expected here? (Will the outer most class always be first?)", "author": "apilloud", "createdAt": "2020-12-22T19:29:27Z", "path": "sdks/java/extensions/sql/src/main/java/org/apache/beam/sdk/extensions/sql/impl/ScalarFnReflector.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.extensions.sql.impl;\n+\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import org.apache.beam.sdk.extensions.sql.udf.ScalarFn;\n+import org.apache.beam.sdk.util.common.ReflectHelpers;\n+\n+/** Reflection-based implementation logic for {@link ScalarFn}. */\n+public class ScalarFnReflector {\n+  /**\n+   * Gets the method annotated with {@link\n+   * org.apache.beam.sdk.extensions.sql.udf.ScalarFn.ApplyMethod} from {@code scalarFn}.\n+   *\n+   * <p>There must be exactly one method annotated with {@link\n+   * org.apache.beam.sdk.extensions.sql.udf.ScalarFn.ApplyMethod}, and it must be public.\n+   */\n+  public static Method getApplyMethod(ScalarFn scalarFn) {\n+    Class<? extends ScalarFn> clazz = scalarFn.getClass();\n+    Collection<Method> matches =\n+        ReflectHelpers.declaredMethodsWithAnnotation(\n+            ScalarFn.ApplyMethod.class, clazz, ScalarFn.class);\n+\n+    if (matches.isEmpty()) {\n+      throw new IllegalArgumentException(\n+          String.format(\n+              \"No method annotated with @%s found in class %s.\",\n+              ScalarFn.ApplyMethod.class.getSimpleName(), clazz.getName()));\n+    }\n+\n+    // If we have at least one match, then either it should be the only match", "originalCommit": "3b593dcf66081d836876d48d67ac3d68340a8940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2NjQ4Nw==", "url": "https://github.com/apache/beam/pull/13593#discussion_r547566487", "bodyText": "Added tests.", "author": "ibzib", "createdAt": "2020-12-23T00:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2NzY1OQ=="}], "type": "inlineReview"}, {"oid": "b8d62044adc5ed1d3f159b9f9677ecf7ee4233df", "url": "https://github.com/apache/beam/commit/b8d62044adc5ed1d3f159b9f9677ecf7ee4233df", "message": "Add tests for inherited ScalarFn subclasses.", "committedDate": "2020-12-23T00:21:54Z", "type": "commit"}, {"oid": "b8d62044adc5ed1d3f159b9f9677ecf7ee4233df", "url": "https://github.com/apache/beam/commit/b8d62044adc5ed1d3f159b9f9677ecf7ee4233df", "message": "Add tests for inherited ScalarFn subclasses.", "committedDate": "2020-12-23T00:21:54Z", "type": "forcePushed"}]}