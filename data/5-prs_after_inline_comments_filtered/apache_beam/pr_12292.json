{"pr_number": 12292, "pr_title": "[BEAM-8057] Support ZetaSQL DOUBLE +INF, -INF and NAN", "pr_createdAt": "2020-07-17T03:23:08Z", "pr_url": "https://github.com/apache/beam/pull/12292", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwNzIzMQ==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456207231", "bodyText": "How about just check val == Double.POSITIVE_INFINITY here? (similar below)", "author": "robinyqiu", "createdAt": "2020-07-17T04:08:42Z", "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/translation/ExpressionConverter.java", "diffHunk": "@@ -786,15 +786,39 @@ private RexNode convertSimpleValueToRexNode(TypeKind kind, Value value) {\n                     ZetaSqlCalciteTranslationUtils.toSimpleRelDataType(kind, rexBuilder()));\n         break;\n       case TYPE_DOUBLE:\n+        // Cannot simply call makeApproxLiteral() for ZetaSQL DOUBLE type because positive infinity,\n+        // negative infinity and Nan cannot be directly converted to BigDecimal. So we create three\n+        // wrapper functions here for these three cases such that we can later recognize it and\n+        // customize its unparsing in BeamBigQuerySqlDialect.\n         double val = value.getDoubleValue();\n-        if (Double.isInfinite(val) || Double.isNaN(val)) {\n-          throw new UnsupportedOperationException(\"Does not support Infinite or NaN literals.\");\n+        if (Double.isInfinite(val) && val > 0) {", "originalCommit": "b4ea922d4a9dff9f945af491048e2d2658bde950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5OTMwMw==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456599303", "bodyText": "Thanks. Done.", "author": "ZijieSong946", "createdAt": "2020-07-17T18:12:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwNzIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwNzk4Ng==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456207986", "bodyText": "I could create 2 local parameters: String wrapperFun (null for the last case) and RelDataType returnType to simplify this big if-else block.", "author": "robinyqiu", "createdAt": "2020-07-17T04:12:06Z", "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/translation/ExpressionConverter.java", "diffHunk": "@@ -786,15 +786,39 @@ private RexNode convertSimpleValueToRexNode(TypeKind kind, Value value) {\n                     ZetaSqlCalciteTranslationUtils.toSimpleRelDataType(kind, rexBuilder()));\n         break;\n       case TYPE_DOUBLE:\n+        // Cannot simply call makeApproxLiteral() for ZetaSQL DOUBLE type because positive infinity,\n+        // negative infinity and Nan cannot be directly converted to BigDecimal. So we create three\n+        // wrapper functions here for these three cases such that we can later recognize it and\n+        // customize its unparsing in BeamBigQuerySqlDialect.\n         double val = value.getDoubleValue();\n-        if (Double.isInfinite(val) || Double.isNaN(val)) {\n-          throw new UnsupportedOperationException(\"Does not support Infinite or NaN literals.\");\n+        if (Double.isInfinite(val) && val > 0) {\n+          ret =\n+              rexBuilder()\n+                  .makeCall(\n+                      SqlOperators.createOtherKindSqlFunction(\n+                          BeamBigQuerySqlDialect.DOUBLE_POSITIVE_INF_FUNCTION,\n+                          ZetaSqlCalciteTranslationUtils.toCalciteTypeName(kind)));\n+        } else if (Double.isInfinite(val) && val < 0) {\n+          ret =\n+              rexBuilder()\n+                  .makeCall(\n+                      SqlOperators.createOtherKindSqlFunction(\n+                          BeamBigQuerySqlDialect.DOUBLE_NEGATIVE_INF_FUNCTION,\n+                          ZetaSqlCalciteTranslationUtils.toCalciteTypeName(kind)));\n+        } else if (Double.isNaN(val)) {\n+          ret =\n+              rexBuilder()\n+                  .makeCall(\n+                      SqlOperators.createOtherKindSqlFunction(\n+                          BeamBigQuerySqlDialect.DOUBLE_NAN_FUNCTION,\n+                          ZetaSqlCalciteTranslationUtils.toCalciteTypeName(kind)));\n+        } else {\n+          ret =\n+              rexBuilder()\n+                  .makeApproxLiteral(\n+                      new BigDecimal(val),\n+                      ZetaSqlCalciteTranslationUtils.toSimpleRelDataType(kind, rexBuilder()));", "originalCommit": "b4ea922d4a9dff9f945af491048e2d2658bde950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0NTg0MQ==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456545841", "bodyText": "I am not quiet sure how to merge the first three blocks with the last one, because the first three use resBuilder().makeCall() while the last one uses rexBuilder().makeApproxLiteral(). Also, returnType seems can only be used in the last block.", "author": "ZijieSong946", "createdAt": "2020-07-17T16:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwNzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3Mjc2OA==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456572768", "bodyText": "I meant\nString wrapperFun = null;\nif (val == Double.POSITIVE_INFINITY) {\n  wrapperFun = BeamBigQuerySqlDialect.DOUBLE_POSITIVE_INF_FUNCTION;\n} else if (val == Double.NEGATIVE_INFINITY) {\n  wrapperFun = BeamBigQuerySqlDialect.DOUBLE_NEGATIVE_INF_FUNCTION;\n} else if (Double.isNan(val)) {\n  wrapperFun = BeamBigQuerySqlDialect.DOUBLE_NAN_FUNCTION;\n}\nRelDataType returnType = ZetaSqlCalciteTranslationUtils.toSimpleRelDataType(kind, rexBuilder());\nif (wrapperFun == null) {\n  ret = rexBuilder().makeApproxLiteral(new BigDecimal(val), returnType);\n} else {\n  ret = rexBuilder().makeCall(SqlOperators.createOtherKindSqlFunction(wrapperFun, returnType.getSqlTypeName()));\n}\n\nIsn't this simpler :)", "author": "robinyqiu", "createdAt": "2020-07-17T17:19:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwNzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5Mzk5NQ==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456593995", "bodyText": "That's seems good idea. Got it.", "author": "ZijieSong946", "createdAt": "2020-07-17T18:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwNzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5OTM4MQ==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456599381", "bodyText": "Done.", "author": "ZijieSong946", "createdAt": "2020-07-17T18:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwNzk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwODg0NQ==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456208845", "bodyText": "If you create a map DOUBLE_LITERAL_FUNCTIONS, you can merge the 3 branches here and the 3 functions below. (Similar to what I did with EXTRACT_FUNCTIONS)", "author": "robinyqiu", "createdAt": "2020-07-17T04:16:03Z", "path": "sdks/java/extensions/sql/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/bigquery/BeamBigQuerySqlDialect.java", "diffHunk": "@@ -157,8 +160,20 @@ public void unparseCall(\n         break;\n       case OTHER_FUNCTION:\n         String funName = call.getOperator().getName();\n-        if (NUMERIC_LITERAL_FUNCTION.equals(funName)) {\n-          // self-designed function dealing with the unparsing of ZetaSQL numeric literal\n+        if (DOUBLE_POSITIVE_INF_FUNCTION.equals(funName)) {", "originalCommit": "b4ea922d4a9dff9f945af491048e2d2658bde950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5OTY4Ng==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456599686", "bodyText": "Done. Thanks for pointing it out.", "author": "ZijieSong946", "createdAt": "2020-07-17T18:13:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwODg0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwOTIxNQ==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456209215", "bodyText": "Maybe comment here: \"There is no direct ZetaSQL literal representation of NaN or infinity\"?", "author": "robinyqiu", "createdAt": "2020-07-17T04:17:55Z", "path": "sdks/java/extensions/sql/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/bigquery/BeamBigQuerySqlDialect.java", "diffHunk": "@@ -239,6 +254,18 @@ private void unparseTrim(SqlWriter writer, SqlCall call, int leftPrec, int right\n     writer.endFunCall(trimFrame);\n   }\n \n+  private void unparseDoublePositiveINFWrapperFunction(SqlWriter writer) {\n+    writer.literal(\"CAST('+inf' AS FLOAT64)\");", "originalCommit": "b4ea922d4a9dff9f945af491048e2d2658bde950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5OTgzOA==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456599838", "bodyText": "Comment Added.", "author": "ZijieSong946", "createdAt": "2020-07-17T18:14:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwOTIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMjQxMQ==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456602411", "bodyText": "Actually you can just pass funName to it.", "author": "robinyqiu", "createdAt": "2020-07-17T18:19:24Z", "path": "sdks/java/extensions/sql/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/bigquery/BeamBigQuerySqlDialect.java", "diffHunk": "@@ -157,8 +166,13 @@ public void unparseCall(\n         break;\n       case OTHER_FUNCTION:\n         String funName = call.getOperator().getName();\n-        if (NUMERIC_LITERAL_FUNCTION.equals(funName)) {\n-          // self-designed function dealing with the unparsing of ZetaSQL numeric literal\n+        if (DOUBLE_FUNCTIONS.containsKey(funName)) {\n+          // self-designed function dealing with the unparsing of ZetaSQL DOUBLE positive\n+          // infinity, negative infinity and NaN\n+          unparseDoubleWrapperFunction(writer, call);", "originalCommit": "fa169f4b47ab3484bc02e174543ed30598d2ca71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMzA4MA==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456603080", "bodyText": "And after you change this, could you please do a rebase again?", "author": "robinyqiu", "createdAt": "2020-07-17T18:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMzgxMg==", "url": "https://github.com/apache/beam/pull/12292#discussion_r456603812", "bodyText": "Acknowledged.", "author": "ZijieSong946", "createdAt": "2020-07-17T18:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMjQxMQ=="}], "type": "inlineReview"}, {"oid": "c1b4f8807b57e0cb49f8751845f1412f7c20719a", "url": "https://github.com/apache/beam/commit/c1b4f8807b57e0cb49f8751845f1412f7c20719a", "message": "Support ZetaSQL DOUBLE +inf, -inf and Nan.", "committedDate": "2020-07-17T18:49:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1Mjg1Nw==", "url": "https://github.com/apache/beam/pull/12292#discussion_r458552857", "bodyText": "Usually I will make a TODO here (such that you can easily find it in the IntelliJ TODO tab), like:\n// TODO[BEAM-10550]: Update the temporary workaround below after vendored Calcite version >= 1.23.0", "author": "robinyqiu", "createdAt": "2020-07-22T05:59:53Z", "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/translation/ExpressionConverter.java", "diffHunk": "@@ -805,6 +805,9 @@ private RexNode convertSimpleValueToRexNode(TypeKind kind, Value value) {\n         if (wrapperFun == null) {\n           ret = rexBuilder().makeApproxLiteral(new BigDecimal(val), returnType);\n         } else if (BeamBigQuerySqlDialect.DOUBLE_NAN_FUNCTION.equals(wrapperFun)) {\n+          // 'https://issues.apache.org/jira/browse/BEAM-10550'", "originalCommit": "585939d4cd2451c5c94b0ac9a7bc138e477d85e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4MDc4OA==", "url": "https://github.com/apache/beam/pull/12292#discussion_r459080788", "bodyText": "Done.", "author": "ZijieSong946", "createdAt": "2020-07-22T21:01:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1Mjg1Nw=="}], "type": "inlineReview"}, {"oid": "0bff5fca7bf533b39bc04a97a48c208bed82c5a9", "url": "https://github.com/apache/beam/commit/0bff5fca7bf533b39bc04a97a48c208bed82c5a9", "message": "Support ZetaSQL DOUBLE +inf, -inf and NaN.", "committedDate": "2020-07-22T20:59:45Z", "type": "commit"}, {"oid": "0bff5fca7bf533b39bc04a97a48c208bed82c5a9", "url": "https://github.com/apache/beam/commit/0bff5fca7bf533b39bc04a97a48c208bed82c5a9", "message": "Support ZetaSQL DOUBLE +inf, -inf and NaN.", "committedDate": "2020-07-22T20:59:45Z", "type": "forcePushed"}]}