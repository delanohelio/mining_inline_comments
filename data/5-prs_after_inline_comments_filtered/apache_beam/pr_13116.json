{"pr_number": 13116, "pr_title": "[BEAM-9855] Provide an option to configure the Flink state backend", "pr_createdAt": "2020-10-14T19:44:48Z", "pr_url": "https://github.com/apache/beam/pull/13116", "timeline": [{"oid": "a7a2e0132a1a69a73c65d1144b8ddc25604d58cb", "url": "https://github.com/apache/beam/commit/a7a2e0132a1a69a73c65d1144b8ddc25604d58cb", "message": "Refactor checkpointing configuration code", "committedDate": "2020-10-14T19:31:53Z", "type": "commit"}, {"oid": "760137709a9aa930fa9bec297db14917e2cc2e78", "url": "https://github.com/apache/beam/commit/760137709a9aa930fa9bec297db14917e2cc2e78", "message": "[BEAM-9855] Provide an option to configure the Flink state backend\n\nWe should make it easier to configure a Flink state backend. At the moment,\nusers have to either:\n\n(A)  Configure the default state backend in their Flink cluster\n\n(B1) Include the dependency in their Gradle/Maven\n     project (e.g. \"org.apache.flink:flink-statebackend-rocksdb_2.11:$flink_version\"\n     for RocksDB).\n(B2) Set the state backend factory in the FlinkPipelineOptions. This only works\n     in Java due to the factory specification being in Java!\n\nWe can make it easier by simple adding pipeline options for the state backend\nname and the checkpoint directory which will be enough for configuring the state\nbackend. We bundle the RocksDB state backend by default.", "committedDate": "2020-10-14T19:59:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODI3NA==", "url": "https://github.com/apache/beam/pull/13116#discussion_r506988274", "bodyText": "Flink is headed in the direction where everything that is set on an environment becomes configurable (including the executor, FLIP-73). This change kind of goes in the opposite direction, increasing the amount of Flink pipeline options further. Should we look into the generic configuration mechanism instead, where it is really easy for the user to supply the Flink configuration (optionally inline, instead of via a separate file)?", "author": "tweise", "createdAt": "2020-10-17T21:58:05Z", "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkExecutionEnvironments.java", "diffHunk": "@@ -259,28 +278,44 @@ static StreamExecutionEnvironment createStreamExecutionEnvironment(\n         options.setShutdownSourcesAfterIdleMs(0L);\n       }\n     }\n+  }\n \n-    applyLatencyTrackingInterval(flinkStreamEnv.getConfig(), options);\n-\n-    if (options.getAutoWatermarkInterval() != null) {\n-      flinkStreamEnv.getConfig().setAutoWatermarkInterval(options.getAutoWatermarkInterval());\n-    }\n-\n-    // State backend\n-    if (options.getStateBackendFactory() != null) {\n+  private static void configureStateBackend(", "originalCommit": "760137709a9aa930fa9bec297db14917e2cc2e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3NzI5OA==", "url": "https://github.com/apache/beam/pull/13116#discussion_r507677298", "bodyText": "I think that's a great idea. We can start thinking about that on the mailing list and handle this via separate JIRA issue. This pipeline option can then be replaced by the generic configuration option.\nFor now, this pipeline option will fulfill a common request by Beam users to directly set the state backend without having to change the Flink configuration.", "author": "mxm", "createdAt": "2020-10-19T11:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3Nzk2MQ==", "url": "https://github.com/apache/beam/pull/13116#discussion_r507677961", "bodyText": "Plus, we want to be able to easily run Nexmark with RocksDB.", "author": "mxm", "createdAt": "2020-10-19T11:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk1ODgzOA==", "url": "https://github.com/apache/beam/pull/13116#discussion_r509958838", "bodyText": "Is the intention of supporting this to be able to configure new Backends too? I mean like the new one by the RISE team? Is this the intended Nexmark use?", "author": "iemejia", "createdAt": "2020-10-22T08:03:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NTY2NQ==", "url": "https://github.com/apache/beam/pull/13116#discussion_r511985665", "bodyText": "Yes, new state backends can be added as needed.", "author": "mxm", "createdAt": "2020-10-26T14:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxNTk2MQ==", "url": "https://github.com/apache/beam/pull/13116#discussion_r512415961", "bodyText": "@iemejia why does Nexmark need the rocksdb state backend? That backend is required when state does not fit into the heap, otherwise it is almost always better to use filesystem.", "author": "tweise", "createdAt": "2020-10-27T04:54:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM0NTU1Nw==", "url": "https://github.com/apache/beam/pull/13116#discussion_r519345557", "bodyText": "We may want to experiment with different state backends.", "author": "mxm", "createdAt": "2020-11-08T10:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODI3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMwMjg0NA==", "url": "https://github.com/apache/beam/pull/13116#discussion_r509302844", "bodyText": "s/unkown/unknown", "author": "iemejia", "createdAt": "2020-10-21T13:50:24Z", "path": "runners/flink/src/test/java/org/apache/beam/runners/flink/FlinkExecutionEnvironmentsTest.java", "diffHunk": "@@ -464,6 +467,63 @@ public void shouldSetSavepointRestoreForRemoteStreaming() {\n     assertThat(getSavepointPath(sev), is(path));\n   }\n \n+  @Test\n+  public void shouldFailOnUnknownStateBackend() {\n+    FlinkPipelineOptions options = PipelineOptionsFactory.as(FlinkPipelineOptions.class);\n+    options.setStreaming(true);\n+    options.setStateBackend(\"unknown\");\n+    options.setStateBackendStoragePath(\"/path\");\n+\n+    assertThrows(\n+        \"State backend was set to 'unkown' but no storage path was provided.\",\n+        IllegalArgumentException.class,\n+        () ->\n+            FlinkExecutionEnvironments.createStreamExecutionEnvironment(\n+                options, Collections.emptyList()));\n+  }\n+\n+  @Test\n+  public void shouldFailOnNoStoragePathProvided() {\n+    FlinkPipelineOptions options = PipelineOptionsFactory.as(FlinkPipelineOptions.class);\n+    options.setStreaming(true);\n+    options.setStateBackend(\"unknown\");\n+\n+    assertThrows(\n+        \"State backend was set to 'unkown' but no storage path was provided.\",", "originalCommit": "760137709a9aa930fa9bec297db14917e2cc2e78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMwMzc3NQ==", "url": "https://github.com/apache/beam/pull/13116#discussion_r509303775", "bodyText": "s/unkown/unknown", "author": "iemejia", "createdAt": "2020-10-21T13:51:13Z", "path": "runners/flink/src/test/java/org/apache/beam/runners/flink/FlinkExecutionEnvironmentsTest.java", "diffHunk": "@@ -464,6 +467,63 @@ public void shouldSetSavepointRestoreForRemoteStreaming() {\n     assertThat(getSavepointPath(sev), is(path));\n   }\n \n+  @Test\n+  public void shouldFailOnUnknownStateBackend() {\n+    FlinkPipelineOptions options = PipelineOptionsFactory.as(FlinkPipelineOptions.class);\n+    options.setStreaming(true);\n+    options.setStateBackend(\"unknown\");\n+    options.setStateBackendStoragePath(\"/path\");\n+\n+    assertThrows(\n+        \"State backend was set to 'unkown' but no storage path was provided.\",", "originalCommit": "760137709a9aa930fa9bec297db14917e2cc2e78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMxODA4NQ==", "url": "https://github.com/apache/beam/pull/13116#discussion_r509318085", "bodyText": "We can do this env.setStateBackend out of the if/else block.", "author": "iemejia", "createdAt": "2020-10-21T14:07:10Z", "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkExecutionEnvironments.java", "diffHunk": "@@ -259,28 +278,44 @@ static StreamExecutionEnvironment createStreamExecutionEnvironment(\n         options.setShutdownSourcesAfterIdleMs(0L);\n       }\n     }\n+  }\n \n-    applyLatencyTrackingInterval(flinkStreamEnv.getConfig(), options);\n-\n-    if (options.getAutoWatermarkInterval() != null) {\n-      flinkStreamEnv.getConfig().setAutoWatermarkInterval(options.getAutoWatermarkInterval());\n-    }\n-\n-    // State backend\n-    if (options.getStateBackendFactory() != null) {\n+  private static void configureStateBackend(\n+      FlinkPipelineOptions options, StreamExecutionEnvironment env) {\n+    if (options.getStateBackend() != null) {\n+      final String storagePath = options.getStateBackendStoragePath();\n+      Preconditions.checkArgument(\n+          storagePath != null,\n+          \"State backend was set to '%s' but no storage path was provided.\",\n+          options.getStateBackend());\n+\n+      final StateBackend stateBackend;\n+      if (options.getStateBackend().equalsIgnoreCase(\"rocksdb\")) {\n+        try {\n+          stateBackend = new RocksDBStateBackend(storagePath);\n+        } catch (IOException e) {\n+          throw new RuntimeException(\"Could not create RocksDB state backend.\", e);\n+        }\n+      } else if (options.getStateBackend().equalsIgnoreCase(\"filesystem\")) {\n+        stateBackend = new FsStateBackend(storagePath);\n+      } else {\n+        throw new IllegalArgumentException(\n+            String.format(\n+                \"Unknown state backend '%s'. Use 'rocksdb' or 'filesystem' or configure via Flink config file.\",\n+                options.getStateBackend()));\n+      }\n+      env.setStateBackend(stateBackend);\n+    } else if (options.getStateBackendFactory() != null) {\n+      // Legacy way of setting the state backend\n       final StateBackend stateBackend =\n           InstanceBuilder.ofType(FlinkStateBackendFactory.class)\n               .fromClass(options.getStateBackendFactory())\n               .build()\n               .createStateBackend(options);\n-      flinkStreamEnv.setStateBackend(stateBackend);\n+      env.setStateBackend(stateBackend);", "originalCommit": "760137709a9aa930fa9bec297db14917e2cc2e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM0NjM0MQ==", "url": "https://github.com/apache/beam/pull/13116#discussion_r519346341", "bodyText": "Actually we can't because the if blocks are non-exhaustive. If nothing is configured, we don't want to call `setStateBackend\u00b4.", "author": "mxm", "createdAt": "2020-11-08T10:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMxODA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk1Njc4OQ==", "url": "https://github.com/apache/beam/pull/13116#discussion_r509956789", "bodyText": "Should not this be the classname of the backend? I am assuming that what we want to achieve here is to allow new backends (not available in Flink) to be configured too (see comment above)", "author": "iemejia", "createdAt": "2020-10-22T08:00:06Z", "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkExecutionEnvironments.java", "diffHunk": "@@ -259,28 +278,44 @@ static StreamExecutionEnvironment createStreamExecutionEnvironment(\n         options.setShutdownSourcesAfterIdleMs(0L);\n       }\n     }\n+  }\n \n-    applyLatencyTrackingInterval(flinkStreamEnv.getConfig(), options);\n-\n-    if (options.getAutoWatermarkInterval() != null) {\n-      flinkStreamEnv.getConfig().setAutoWatermarkInterval(options.getAutoWatermarkInterval());\n-    }\n-\n-    // State backend\n-    if (options.getStateBackendFactory() != null) {\n+  private static void configureStateBackend(\n+      FlinkPipelineOptions options, StreamExecutionEnvironment env) {\n+    if (options.getStateBackend() != null) {\n+      final String storagePath = options.getStateBackendStoragePath();\n+      Preconditions.checkArgument(\n+          storagePath != null,\n+          \"State backend was set to '%s' but no storage path was provided.\",\n+          options.getStateBackend());\n+\n+      final StateBackend stateBackend;\n+      if (options.getStateBackend().equalsIgnoreCase(\"rocksdb\")) {", "originalCommit": "760137709a9aa930fa9bec297db14917e2cc2e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NTMzNw==", "url": "https://github.com/apache/beam/pull/13116#discussion_r511985337", "bodyText": "There is no factory method available for state backends, they all have different constructors. We can't use the class name.", "author": "mxm", "createdAt": "2020-10-26T14:05:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk1Njc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM3MjMxMA==", "url": "https://github.com/apache/beam/pull/13116#discussion_r519372310", "bodyText": "I've reduced this to one call by adding a null check.", "author": "mxm", "createdAt": "2020-11-08T12:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk1Njc4OQ=="}], "type": "inlineReview"}, {"oid": "f292ca89f75b2a7d8319198f21f268ae4f7902d8", "url": "https://github.com/apache/beam/commit/f292ca89f75b2a7d8319198f21f268ae4f7902d8", "message": "[BEAM-9855] Provide an option to configure the Flink state backend\n\nWe should make it easier to configure a Flink state backend. At the moment,\nusers have to either:\n\n(A)  Configure the default state backend in their Flink cluster\n\n(B1) Include the dependency in their Gradle/Maven\n     project (e.g. \"org.apache.flink:flink-statebackend-rocksdb_2.11:$flink_version\"\n     for RocksDB).\n(B2) Set the state backend factory in the FlinkPipelineOptions. This only works\n     in Java due to the factory specification being in Java!\n\nWe can make it easier by simple adding pipeline options for the state backend\nname and the checkpoint directory which will be enough for configuring the state\nbackend. We bundle the RocksDB state backend by default.", "committedDate": "2020-11-08T11:57:49Z", "type": "forcePushed"}, {"oid": "74663e28e9fbb698f6a09fef7f429f7d52b69c0f", "url": "https://github.com/apache/beam/commit/74663e28e9fbb698f6a09fef7f429f7d52b69c0f", "message": "[BEAM-9855] Provide an option to configure the Flink state backend\n\nWe should make it easier to configure a Flink state backend. At the moment,\nusers have to either:\n\n(A)  Configure the default state backend in their Flink cluster\n\n(B1) Include the dependency in their Gradle/Maven\n     project (e.g. \"org.apache.flink:flink-statebackend-rocksdb_2.11:$flink_version\"\n     for RocksDB).\n(B2) Set the state backend factory in the FlinkPipelineOptions. This only works\n     in Java due to the factory specification being in Java!\n\nWe can make it easier by simple adding pipeline options for the state backend\nname and the checkpoint directory which will be enough for configuring the state\nbackend. We bundle the RocksDB state backend by default.", "committedDate": "2020-11-08T11:59:22Z", "type": "commit"}, {"oid": "74663e28e9fbb698f6a09fef7f429f7d52b69c0f", "url": "https://github.com/apache/beam/commit/74663e28e9fbb698f6a09fef7f429f7d52b69c0f", "message": "[BEAM-9855] Provide an option to configure the Flink state backend\n\nWe should make it easier to configure a Flink state backend. At the moment,\nusers have to either:\n\n(A)  Configure the default state backend in their Flink cluster\n\n(B1) Include the dependency in their Gradle/Maven\n     project (e.g. \"org.apache.flink:flink-statebackend-rocksdb_2.11:$flink_version\"\n     for RocksDB).\n(B2) Set the state backend factory in the FlinkPipelineOptions. This only works\n     in Java due to the factory specification being in Java!\n\nWe can make it easier by simple adding pipeline options for the state backend\nname and the checkpoint directory which will be enough for configuring the state\nbackend. We bundle the RocksDB state backend by default.", "committedDate": "2020-11-08T11:59:22Z", "type": "forcePushed"}]}