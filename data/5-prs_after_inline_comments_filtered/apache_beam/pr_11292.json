{"pr_number": 11292, "pr_title": "[BEAM-9674] Don't specify selected fields when fetching BigQuery table size", "pr_createdAt": "2020-04-02T16:55:19Z", "pr_url": "https://github.com/apache/beam/pull/11292", "timeline": [{"oid": "4f15d7e52211cf1dc08bd36b7fcf6bd1003ff3ef", "url": "https://github.com/apache/beam/commit/4f15d7e52211cf1dc08bd36b7fcf6bd1003ff3ef", "message": "Don't specify selected fields when fetching BigQuery table size", "committedDate": "2020-04-01T21:02:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2ODYwMA==", "url": "https://github.com/apache/beam/pull/11292#discussion_r404468600", "bodyText": "Is this removing a public API?", "author": "aaltay", "createdAt": "2020-04-07T00:33:26Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServices.java", "diffHunk": "@@ -101,10 +101,6 @@ JobStatistics dryRunQuery(String projectId, JobConfigurationQuery queryConfig, S\n     @Nullable\n     Table getTable(TableReference tableRef) throws InterruptedException, IOException;\n \n-    @Nullable", "originalCommit": "4f15d7e52211cf1dc08bd36b7fcf6bd1003ff3ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5NjA4OA==", "url": "https://github.com/apache/beam/pull/11292#discussion_r404996088", "bodyText": "BigQueryServices is a public interface, although it's meant as a private implementation for BigQuery sources and sinks and is not surfaced at the BigQueryIO level. I can restore this functionality and simply stop calling it from BigQueryStorageStreamSource.", "author": "kmjung", "createdAt": "2020-04-07T17:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2ODYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwMjM3Ng==", "url": "https://github.com/apache/beam/pull/11292#discussion_r405002376", "bodyText": "Done.", "author": "kmjung", "createdAt": "2020-04-07T17:54:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2ODYwMA=="}], "type": "inlineReview"}, {"oid": "69810b4ad50a5d2abdd98b0b0b28cb800cc5759b", "url": "https://github.com/apache/beam/commit/69810b4ad50a5d2abdd98b0b0b28cb800cc5759b", "message": "Revert \"Don't specify selected fields when fetching BigQuery table size\"\n\nThis reverts commit 4f15d7e52211cf1dc08bd36b7fcf6bd1003ff3ef.", "committedDate": "2020-04-07T17:48:25Z", "type": "commit"}, {"oid": "20aee714aa9a51319ec39c10f4404c5d0994648b", "url": "https://github.com/apache/beam/commit/20aee714aa9a51319ec39c10f4404c5d0994648b", "message": "Add Avro utils functionality to trim BigQuery schemas", "committedDate": "2020-04-08T19:03:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNzAyNg==", "url": "https://github.com/apache/beam/pull/11292#discussion_r409107026", "bodyText": "Not sure how this trims the schema ? Does readSession.getAvroSchema() somehow has a smaller number of fields than targetTable.getSchema() ?", "author": "chamikaramj", "createdAt": "2020-04-15T20:14:53Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageSourceBase.java", "diffHunk": "@@ -149,11 +151,14 @@\n       return ImmutableList.of();\n     }\n \n+    Schema sessionSchema = new Schema.Parser().parse(readSession.getAvroSchema().getSchema());", "originalCommit": "20aee714aa9a51319ec39c10f4404c5d0994648b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTExNzgzMw==", "url": "https://github.com/apache/beam/pull/11292#discussion_r409117833", "bodyText": "With this change, we're no longer specifying the list of selected fields to the tables.get call from which the BigQuery schema is taken; as a result, we get the entire table schema back, so we have to trim it on the client side in the case where the client has specified selected fields. The Avro schema is returned as part of the read session and contains only the selected fields, so we use it as the basis for trimming the BigQuery schema.", "author": "kmjung", "createdAt": "2020-04-15T20:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNzAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTExMTg4Ng==", "url": "https://github.com/apache/beam/pull/11292#discussion_r409111886", "bodyText": "Is this a feature regression for the storage API based read path ?", "author": "chamikaramj", "createdAt": "2020-04-15T20:24:29Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryIOStorageReadTest.java", "diffHunk": "@@ -1368,19 +1368,14 @@ public void testStreamSourceSplitAtFractionFailsWhenParentIsPastSplitPoint() thr\n   public void testReadFromBigQueryIO() throws Exception {\n     fakeDatasetService.createDataset(\"foo.com:project\", \"dataset\", \"\", \"\", null);\n     TableReference tableRef = BigQueryHelpers.parseTableSpec(\"foo.com:project:dataset.table\");\n-\n-    Table table =\n-        new Table().setTableReference(tableRef).setNumBytes(10L).setSchema(new TableSchema());\n-\n+    Table table = new Table().setTableReference(tableRef).setNumBytes(10L).setSchema(TABLE_SCHEMA);\n     fakeDatasetService.createTable(table);\n \n     CreateReadSessionRequest expectedCreateReadSessionRequest =\n         CreateReadSessionRequest.newBuilder()\n             .setParent(\"projects/project-id\")\n             .setTableReference(BigQueryHelpers.toTableRefProto(tableRef))\n             .setRequestedStreams(10)\n-            .setReadOptions(", "originalCommit": "20aee714aa9a51319ec39c10f4404c5d0994648b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTExODk4MQ==", "url": "https://github.com/apache/beam/pull/11292#discussion_r409118981", "bodyText": "I'm not sure that I understand your question here. We used to have e2e tests for BigQueryIO with the read API only for the case where the caller specified all fields as selected fields; with this change, now we have two tests -- one which covers the case where no selected fields are covered (which is effectively the same as the case where all fields are specified), and another which covers the case where only a subset of fields are specified.", "author": "kmjung", "createdAt": "2020-04-15T20:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTExMTg4Ng=="}], "type": "inlineReview"}]}