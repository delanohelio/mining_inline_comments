{"pr_number": 11450, "pr_title": "[BEAM-9779] Patch HL7v2IOWriteIT Flakiness", "pr_createdAt": "2020-04-17T19:20:57Z", "pr_url": "https://github.com/apache/beam/pull/11450", "timeline": [{"oid": "f47a9774755032d02575f7657d5843916f47dac9", "url": "https://github.com/apache/beam/commit/f47a9774755032d02575f7657d5843916f47dac9", "message": "Patches for HL7v2IO\n\n* Use TestPipeline in ITs\n* Drop schematized data before calling message ingest (should be output only) to help pipelines that read/write from/to two HL7v2 stores\n* Make HL7v2MessageCoder constructor public", "committedDate": "2020-04-17T19:17:20Z", "type": "commit"}, {"oid": "55ab1818c2399ad56be585ccbc30f882c1b32693", "url": "https://github.com/apache/beam/commit/55ab1818c2399ad56be585ccbc30f882c1b32693", "message": "block on run", "committedDate": "2020-04-17T20:15:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1MTI2NQ==", "url": "https://github.com/apache/beam/pull/11450#discussion_r410451265", "bodyText": "I could add\npipeline.getOptions().as(DirectOptions.class).setBlockOnRun(true);\nBut I think this is the same as pipeline.run().waitUntilFinish(); for batch pipelines which I already use.", "author": "jaketf", "createdAt": "2020-04-17T20:22:12Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOWriteIT.java", "diffHunk": "@@ -46,6 +45,8 @@\n   private static final String HL7V2_STORE_NAME =\n       \"hl7v2_store_write_it_\" + System.currentTimeMillis() + \"_\" + (new SecureRandom().nextInt(32));\n \n+  @Rule public transient TestPipeline pipeline = TestPipeline.create();", "originalCommit": "f47a9774755032d02575f7657d5843916f47dac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUxMjc0Mg==", "url": "https://github.com/apache/beam/pull/11450#discussion_r411512742", "bodyText": "pipeline.run().waitUntilFinish() is the correct way to wait till completion.", "author": "lukecwik", "createdAt": "2020-04-20T16:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1MTI2NQ=="}], "type": "inlineReview"}, {"oid": "96d8e93032c3f61373012bea02c3febe53312c81", "url": "https://github.com/apache/beam/commit/96d8e93032c3f61373012bea02c3febe53312c81", "message": "add sleep to avoid flakiness due to asyncronous HL7v2 indexing", "committedDate": "2020-04-17T20:45:25Z", "type": "commit"}, {"oid": "1bbaea69187fe5f2a0e0f04e1af27f5528bb2f2a", "url": "https://github.com/apache/beam/commit/1bbaea69187fe5f2a0e0f04e1af27f5528bb2f2a", "message": "E2E integration test", "committedDate": "2020-04-17T23:51:33Z", "type": "commit"}, {"oid": "6ede0a8e60d6e7557a15a41d5baf4aaadbe784a8", "url": "https://github.com/apache/beam/commit/6ede0a8e60d6e7557a15a41d5baf4aaadbe784a8", "message": "fix merge issue", "committedDate": "2020-04-17T23:55:27Z", "type": "commit"}, {"oid": "40a23ef7efd9706e3b5f33c35b22213f84963e50", "url": "https://github.com/apache/beam/commit/40a23ef7efd9706e3b5f33c35b22213f84963e50", "message": "reconcile double sleeping", "committedDate": "2020-04-17T23:57:48Z", "type": "commit"}, {"oid": "194cf3e719b778ff5a4baf737134b00b8c601591", "url": "https://github.com/apache/beam/commit/194cf3e719b778ff5a4baf737134b00b8c601591", "message": "improve error hanlding", "committedDate": "2020-04-20T23:42:17Z", "type": "commit"}, {"oid": "7af97ddd2cec2f05faeaf3b49d7b495b72e2d7e4", "url": "https://github.com/apache/beam/commit/7af97ddd2cec2f05faeaf3b49d7b495b72e2d7e4", "message": "improve error handling", "committedDate": "2020-04-20T23:44:49Z", "type": "commit"}, {"oid": "6f86186e41c23a18d51036f24bb548d88efeac50", "url": "https://github.com/apache/beam/commit/6f86186e41c23a18d51036f24bb548d88efeac50", "message": "fix docs typo", "committedDate": "2020-04-21T00:19:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1NTc0Mg==", "url": "https://github.com/apache/beam/pull/11450#discussion_r413255742", "bodyText": "Seems like read and write sections are unrelated. Should these be two different tests ?\nAlternatively we can convert this to a single \"write and then read pipeline\" where data needed for the read step are generated in the write step (and remove data generation in the setUp method.", "author": "chamikaramj", "createdAt": "2020-04-22T19:22:23Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOReadWriteIT.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.healthcare;\n+\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.HEALTHCARE_DATASET_TEMPLATE;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.MESSAGES;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.deleteAllHL7v2Messages;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.writeHL7v2Messages;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.security.SecureRandom;\n+import java.util.Collections;\n+import org.apache.beam.sdk.extensions.gcp.options.GcpOptions;\n+import org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.ListHL7v2MessageIDs;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.transforms.Count;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * This should catch that we read {@link HL7v2Message} with schematized data but do not fail inserts\n+ * with schematized data which should be output only.\n+ */\n+@RunWith(JUnit4.class)\n+public class HL7v2IOReadWriteIT {\n+\n+  private transient HealthcareApiClient client;\n+  private static String healthcareDataset;\n+  private static final String BASE =\n+      \"hl7v2_store_rw_it_\" + System.currentTimeMillis() + \"_\" + (new SecureRandom().nextInt(32));\n+  private static final String INPUT_HL7V2_STORE_NAME = BASE + \"INPUT\";\n+  private static final String OUTPUT_HL7V2_STORE_NAME = BASE + \"OUTPUT\";\n+\n+  @Rule public transient TestPipeline pipeline = TestPipeline.create();\n+\n+  @BeforeClass\n+  public static void createHL7v2tores() throws IOException {\n+    String project = TestPipeline.testingPipelineOptions().as(GcpOptions.class).getProject();\n+    healthcareDataset = String.format(HEALTHCARE_DATASET_TEMPLATE, project);\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.createHL7v2Store(healthcareDataset, INPUT_HL7V2_STORE_NAME);\n+    client.createHL7v2Store(healthcareDataset, OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @AfterClass\n+  public static void deleteHL7v2tores() throws IOException {\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @Before\n+  public void setup() throws Exception {\n+    if (client == null) {\n+      client = new HttpHealthcareApiClient();\n+    }\n+\n+    // Create HL7 messages and write them to HL7v2 Store.\n+    writeHL7v2Messages(this.client, healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @After\n+  public void tearDown() throws Exception {\n+    deleteAllHL7v2Messages(client, healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @Test\n+  public void testHL7v2IOE2E() throws Exception {\n+    HL7v2IO.Read.Result readResult =\n+        pipeline\n+            .apply(\n+                new ListHL7v2MessageIDs(\n+                    Collections.singletonList(\n+                        healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME)))\n+            .apply(HL7v2IO.getAll());\n+\n+    PCollection<Long> numReadMessages =\n+        readResult.getMessages().setCoder(new HL7v2MessageCoder()).apply(Count.globally());\n+    PAssert.thatSingleton(numReadMessages).isEqualTo((long) MESSAGES.size());\n+    PAssert.that(readResult.getFailedReads()).empty();", "originalCommit": "6f86186e41c23a18d51036f24bb548d88efeac50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NDMzMQ==", "url": "https://github.com/apache/beam/pull/11450#discussion_r413444331", "bodyText": "The sections are actually related.\nthe write section starts with readResult.getMessages() (which is returns the output PCollection of the read).\nI specifically wanted to add this test because in testing w/ customer we noticed that (before the changes in this PR that set only data and labels) if you ran read and went straight to write you would get errors on ingest because our messages would have fields that should be output only.\nThis test will help us ensure we don't run introduce a regression in the future for this read to write case.\nFor context, we already have \"just read\" and \"just write\" integration tests for this connector.", "author": "jaketf", "createdAt": "2020-04-23T01:32:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1NTc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1ODQ1OA==", "url": "https://github.com/apache/beam/pull/11450#discussion_r413258458", "bodyText": "How do we know that 5000 is enough ? If not the test will be flaky.", "author": "chamikaramj", "createdAt": "2020-04-22T19:26:46Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOTestUtil.java", "diffHunk": "@@ -91,10 +92,13 @@ static void deleteAllHL7v2Messages(HealthcareApiClient client, String hl7v2Store\n   }\n \n   /** Populate the test messages into the HL7v2 store. */\n-  static void writeHL7v2Messages(HealthcareApiClient client, String hl7v2Store) throws IOException {\n+  static void writeHL7v2Messages(HealthcareApiClient client, String hl7v2Store)\n+      throws IOException, InterruptedException {\n     for (HL7v2Message msg : MESSAGES) {\n       client.createHL7v2Message(hl7v2Store, msg.toModel());\n     }\n+    // [BEAM-9779] HL7v2 indexing is asyncronous. Add sleep to stabilize this IT.\n+    Sleeper.DEFAULT.sleep(5000);", "originalCommit": "6f86186e41c23a18d51036f24bb548d88efeac50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NzM3NA==", "url": "https://github.com/apache/beam/pull/11450#discussion_r413447374", "bodyText": "Great Question!\nAs the Jira ticket explains I was not able to reproduce the flakiness of the test locally (I think because it takes long enough for my list request to reach us-central (from my workstation in Oregon) that the async indexing is complete (while the jenkins workers are much closer and end up sometimes beating the indexer to the punch and reading a stale list of messages). I chose 5000 based on my latency to us-central being well under 5 seconds and a hope that the indexer doesn't take this long to index 3 measly messages :)\nI know the Java Post Commit is already a long check so I didn't want to unnecessarily sleep for too long.\nI'm not sure if the Healthcare API has an SLA or benchmarks for the async HL7v2 Message indexing.\n@lastomato any idea?\nI'm happy to bump this value higher, but it's guesswork on my end for how long we should sleep.", "author": "jaketf", "createdAt": "2020-04-23T01:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1ODQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0ODgwNA==", "url": "https://github.com/apache/beam/pull/11450#discussion_r413448804", "bodyText": "Alternatively we could throw some EBO / retry logic waiting until the list returns the number of messages we expect.", "author": "jaketf", "createdAt": "2020-04-23T01:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1ODQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzNzY2Ng==", "url": "https://github.com/apache/beam/pull/11450#discussion_r414837666", "bodyText": "Based on internal thread it seems HCAPI team uses EBO w/ 10 min timeout to deal with async indexing in their own integration tests. I've added the same here.", "author": "jaketf", "createdAt": "2020-04-24T20:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1ODQ1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1OTkxOQ==", "url": "https://github.com/apache/beam/pull/11450#discussion_r413259919", "bodyText": "Does the store name here uniquely identify the set of data being deleted (just to confirm) ?", "author": "chamikaramj", "createdAt": "2020-04-22T19:29:15Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOReadWriteIT.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.healthcare;\n+\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.HEALTHCARE_DATASET_TEMPLATE;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.MESSAGES;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.deleteAllHL7v2Messages;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.writeHL7v2Messages;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.security.SecureRandom;\n+import java.util.Collections;\n+import org.apache.beam.sdk.extensions.gcp.options.GcpOptions;\n+import org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.ListHL7v2MessageIDs;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.transforms.Count;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * This should catch that we read {@link HL7v2Message} with schematized data but do not fail inserts\n+ * with schematized data which should be output only.\n+ */\n+@RunWith(JUnit4.class)\n+public class HL7v2IOReadWriteIT {\n+\n+  private transient HealthcareApiClient client;\n+  private static String healthcareDataset;\n+  private static final String BASE =\n+      \"hl7v2_store_rw_it_\" + System.currentTimeMillis() + \"_\" + (new SecureRandom().nextInt(32));\n+  private static final String INPUT_HL7V2_STORE_NAME = BASE + \"INPUT\";\n+  private static final String OUTPUT_HL7V2_STORE_NAME = BASE + \"OUTPUT\";\n+\n+  @Rule public transient TestPipeline pipeline = TestPipeline.create();\n+\n+  @BeforeClass\n+  public static void createHL7v2tores() throws IOException {\n+    String project = TestPipeline.testingPipelineOptions().as(GcpOptions.class).getProject();\n+    healthcareDataset = String.format(HEALTHCARE_DATASET_TEMPLATE, project);\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.createHL7v2Store(healthcareDataset, INPUT_HL7V2_STORE_NAME);\n+    client.createHL7v2Store(healthcareDataset, OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @AfterClass\n+  public static void deleteHL7v2tores() throws IOException {\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @Before\n+  public void setup() throws Exception {\n+    if (client == null) {\n+      client = new HttpHealthcareApiClient();\n+    }\n+\n+    // Create HL7 messages and write them to HL7v2 Store.\n+    writeHL7v2Messages(this.client, healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @After\n+  public void tearDown() throws Exception {\n+    deleteAllHL7v2Messages(client, healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);", "originalCommit": "6f86186e41c23a18d51036f24bb548d88efeac50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0MTkyMA==", "url": "https://github.com/apache/beam/pull/11450#discussion_r413441920", "bodyText": "yes.", "author": "jaketf", "createdAt": "2020-04-23T01:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1OTkxOQ=="}], "type": "inlineReview"}, {"oid": "766e6fd64af3d17b75e551f1e25dd1aad428e018", "url": "https://github.com/apache/beam/commit/766e6fd64af3d17b75e551f1e25dd1aad428e018", "message": "add latency distribution metrics", "committedDate": "2020-04-22T20:02:10Z", "type": "commit"}, {"oid": "e989ec4601df842d377bdc15c53a1324a474de3f", "url": "https://github.com/apache/beam/commit/e989ec4601df842d377bdc15c53a1324a474de3f", "message": "Merge branch 'metrics/HL7v2IO' into patch/HL7v2IO", "committedDate": "2020-04-22T20:03:38Z", "type": "commit"}, {"oid": "16399f1494e2071cee97fadaf56dc21a9eefbed3", "url": "https://github.com/apache/beam/commit/16399f1494e2071cee97fadaf56dc21a9eefbed3", "message": "remove unused imports", "committedDate": "2020-04-22T21:41:01Z", "type": "commit"}, {"oid": "9ef3a33c532535873ee8029a27e2656929ac2e1f", "url": "https://github.com/apache/beam/commit/9ef3a33c532535873ee8029a27e2656929ac2e1f", "message": "Merge branch 'metrics/HL7v2IO' into patch/HL7v2IO", "committedDate": "2020-04-22T22:16:06Z", "type": "commit"}, {"oid": "c8b576636f99f006c5738481ff72f06c576c46d0", "url": "https://github.com/apache/beam/commit/c8b576636f99f006c5738481ff72f06c576c46d0", "message": "ingest only data and labels", "committedDate": "2020-04-22T22:21:16Z", "type": "commit"}, {"oid": "50ba3d8da29f4d4522b29468aa01b800ad96b5e9", "url": "https://github.com/apache/beam/commit/50ba3d8da29f4d4522b29468aa01b800ad96b5e9", "message": "fix comment", "committedDate": "2020-04-22T22:26:08Z", "type": "commit"}, {"oid": "461b7cd79ece7cf27fb24032fb89cb3616d439ef", "url": "https://github.com/apache/beam/commit/461b7cd79ece7cf27fb24032fb89cb3616d439ef", "message": "call spliterator directly, use page size 1000", "committedDate": "2020-04-22T22:55:14Z", "type": "commit"}, {"oid": "b2602b477a8ebe535fe3060d643cbef45f0e2892", "url": "https://github.com/apache/beam/commit/b2602b477a8ebe535fe3060d643cbef45f0e2892", "message": "output elements more eagerly in ListHL72MessageFn", "committedDate": "2020-04-22T23:29:10Z", "type": "commit"}, {"oid": "1503fd4600654064e608e3c98c6e9e9b0de20560", "url": "https://github.com/apache/beam/commit/1503fd4600654064e608e3c98c6e9e9b0de20560", "message": "eagerly emit data from early pages", "committedDate": "2020-04-23T23:43:42Z", "type": "commit"}, {"oid": "5f9bad7c1c9df7c004f0f4f67185a3d5099a351f", "url": "https://github.com/apache/beam/commit/5f9bad7c1c9df7c004f0f4f67185a3d5099a351f", "message": "Optimization of Listing and Stablization of ITs\n\n* allow HL7v2 Message listing to emit early panes rather than waiting on pagination of all list results\n* add EBO on HL7v2 Message listing reaching a certain expected length in ITs to account for async indexing BEAM-9779", "committedDate": "2020-04-24T00:51:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkwOTg0OA==", "url": "https://github.com/apache/beam/pull/11450#discussion_r415909848", "bodyText": "This is a pretty large sleep for a single test. Java post commit test suite is run pretty regularly with limited Jenkins resources so I suggest adding a separate test suite for HI7v2 tests and removing this and any other tests that need large sleeps from general Java post-commit test suite.", "author": "chamikaramj", "createdAt": "2020-04-27T15:25:41Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/HttpHealthcareApiClient.java", "diffHunk": "@@ -127,6 +114,7 @@ public ListMessagesResponse makeHL7v2ListRequest(\n             .messages()\n             .list(hl7v2Store)\n             .set(\"view\", \"full\")\n+            .setPageSize(1000)", "originalCommit": "5f9bad7c1c9df7c004f0f4f67185a3d5099a351f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk5Nzg5NA==", "url": "https://github.com/apache/beam/pull/11450#discussion_r415997894", "bodyText": "This is not a sleep.\nI think this is a comment on the wrong line.\nCurrently the approach I've taken is to retry listing of HL7v2 messages until the desired number of messages is returned with EBO and an over all timeout of 10 minutes.\nThis is very different than a 10 minute sleep as it's expected to succeed well under 10 mins.\nI'm pretty sure this is an extremely over kill timeout for indexing 3 messages.\nI've asked the internal team about stats we have on this async indexing process to increase confidence here.\nI'm not sure how to move this out of the post commit test suite.\nSo I have some questions:\n\nWhat would an acceptable timeout be to keep this in the post commit?\nIf I were to run this test 1000x on a VM in the same region as the jenkins VMs with the contents of this PR to prove that it fixes the flakiness, is there additional stats (beyond 1000/1000 runs pass) you'd find helpful (e.g. distribution of total runtime for this test)?\nHow to move this to a \"sick bay\" or other test suite? Does this already exist in beam code base?", "author": "jaketf", "createdAt": "2020-04-27T17:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkwOTg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAzMDQyMA==", "url": "https://github.com/apache/beam/pull/11450#discussion_r416030420", "bodyText": "Thanks for clarifying. I agree waiting till completion with a timeout much better than waiting.\nThere's some information on adding new test suites here.\nhttps://beam.apache.org/documentation/io/testing/", "author": "chamikaramj", "createdAt": "2020-04-27T18:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkwOTg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkxMzM3Ng==", "url": "https://github.com/apache/beam/pull/11450#discussion_r415913376", "bodyText": "Ditto. I suggest moving tests that require a large sleep to a new test suite.", "author": "chamikaramj", "createdAt": "2020-04-27T15:29:53Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOReadWriteIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.healthcare;\n+\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.HEALTHCARE_DATASET_TEMPLATE;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.MESSAGES;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.deleteAllHL7v2Messages;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.writeHL7v2Messages;\n+\n+import java.io.IOException;\n+import java.security.SecureRandom;\n+import java.util.Collections;\n+import java.util.concurrent.TimeoutException;\n+import org.apache.beam.sdk.extensions.gcp.options.GcpOptions;\n+import org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.ListHL7v2MessageIDs;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.transforms.Count;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.joda.time.Duration;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * This should catch that we read {@link HL7v2Message} with schematized data but do not fail inserts\n+ * with schematized data which should be output only.\n+ */\n+@RunWith(JUnit4.class)\n+public class HL7v2IOReadWriteIT {\n+\n+  private transient HealthcareApiClient client;\n+  private static String healthcareDataset;\n+  private static final String BASE =\n+      \"hl7v2_store_rw_it_\" + System.currentTimeMillis() + \"_\" + (new SecureRandom().nextInt(32));\n+  private static final String INPUT_HL7V2_STORE_NAME = BASE + \"INPUT\";\n+  private static final String OUTPUT_HL7V2_STORE_NAME = BASE + \"OUTPUT\";\n+\n+  @Rule public transient TestPipeline pipeline = TestPipeline.create();\n+\n+  @BeforeClass\n+  public static void createHL7v2tores() throws IOException {\n+    String project = TestPipeline.testingPipelineOptions().as(GcpOptions.class).getProject();\n+    healthcareDataset = String.format(HEALTHCARE_DATASET_TEMPLATE, project);\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.createHL7v2Store(healthcareDataset, INPUT_HL7V2_STORE_NAME);\n+    client.createHL7v2Store(healthcareDataset, OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @AfterClass\n+  public static void deleteHL7v2tores() throws IOException {\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @Before\n+  public void setup() throws Exception {\n+    if (client == null) {\n+      client = new HttpHealthcareApiClient();\n+    }\n+\n+    // Create HL7 messages and write them to HL7v2 Store.\n+    writeHL7v2Messages(this.client, healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @After\n+  public void tearDown() throws Exception {\n+    deleteAllHL7v2Messages(client, healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @Test\n+  public void testHL7v2IOE2E() throws Exception {\n+    HL7v2IO.Read.Result readResult =\n+        pipeline\n+            .apply(\n+                new ListHL7v2MessageIDs(\n+                    Collections.singletonList(\n+                        healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME)))\n+            .apply(HL7v2IO.getAll());\n+\n+    PCollection<Long> numReadMessages =\n+        readResult.getMessages().setCoder(new HL7v2MessageCoder()).apply(Count.globally());\n+    PAssert.thatSingleton(numReadMessages).isEqualTo((long) MESSAGES.size());\n+    PAssert.that(readResult.getFailedReads()).empty();\n+\n+    HL7v2IO.Write.Result writeResult =\n+        readResult\n+            .getMessages()\n+            .apply(\n+                HL7v2IO.ingestMessages(\n+                    healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME));\n+\n+    PAssert.that(writeResult.getFailedInsertsWithErr()).empty();\n+\n+    pipeline.run().waitUntilFinish();\n+\n+    try {\n+      HL7v2IOTestUtil.waitForHL7v2Indexing(\n+          client,\n+          healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME,\n+          MESSAGES.size(),\n+          Duration.standardMinutes(10));", "originalCommit": "5f9bad7c1c9df7c004f0f4f67185a3d5099a351f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkxNzIwNQ==", "url": "https://github.com/apache/beam/pull/11450#discussion_r415917205", "bodyText": "Can we please defer adding these new tests till we are sure that the changes to fix flakyness actually fix the immediate issue. Also can you please send additional changes that are not related to BEAM https://issues.apache.org/jira/browse/BEAM-9779 as a separate PR and mention the correct JIRA.", "author": "chamikaramj", "createdAt": "2020-04-27T15:34:16Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOReadWriteIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.healthcare;\n+\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.HEALTHCARE_DATASET_TEMPLATE;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.MESSAGES;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.deleteAllHL7v2Messages;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.writeHL7v2Messages;\n+\n+import java.io.IOException;\n+import java.security.SecureRandom;\n+import java.util.Collections;\n+import java.util.concurrent.TimeoutException;\n+import org.apache.beam.sdk.extensions.gcp.options.GcpOptions;\n+import org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.ListHL7v2MessageIDs;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.transforms.Count;", "originalCommit": "5f9bad7c1c9df7c004f0f4f67185a3d5099a351f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk4NzQ0Mw==", "url": "https://github.com/apache/beam/pull/11450#discussion_r415987443", "bodyText": "sure.", "author": "jaketf", "createdAt": "2020-04-27T17:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkxNzIwNQ=="}], "type": "inlineReview"}, {"oid": "ee771ba18e22ea82518702130fc66113c3deeee4", "url": "https://github.com/apache/beam/commit/ee771ba18e22ea82518702130fc66113c3deeee4", "message": "revert unrelated changes", "committedDate": "2020-04-27T16:40:26Z", "type": "commit"}, {"oid": "d0b33499457fb1be8990967921cc1864a1963d2b", "url": "https://github.com/apache/beam/commit/d0b33499457fb1be8990967921cc1864a1963d2b", "message": "add back test", "committedDate": "2020-04-27T16:44:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk3NzY5NA==", "url": "https://github.com/apache/beam/pull/11450#discussion_r415977694", "bodyText": "these tests are actually redundant with the non-deleted testHL7v2IO_ListHL7v2Messages and testHL7v2IO_ListHL7v2Messages_filtered", "author": "jaketf", "createdAt": "2020-04-27T16:48:04Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOReadIT.java", "diffHunk": "@@ -86,36 +86,6 @@ public void tearDown() throws Exception {\n     deleteAllHL7v2Messages(this.client, healthcareDataset + \"/hl7V2Stores/\" + HL7V2_STORE_NAME);\n   }\n \n-  @Test", "originalCommit": "d0b33499457fb1be8990967921cc1864a1963d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "92af30086895e564a272eb3743bd32971c2795a2", "url": "https://github.com/apache/beam/commit/92af30086895e564a272eb3743bd32971c2795a2", "message": "Add constant for HL7v2 indexing timeout minutes", "committedDate": "2020-04-27T16:55:02Z", "type": "commit"}, {"oid": "a01e7d04dabd607f246aac219304254ed8bd975e", "url": "https://github.com/apache/beam/commit/a01e7d04dabd607f246aac219304254ed8bd975e", "message": "Add constant for HL7v2 indexing timeout minutes", "committedDate": "2020-04-27T16:55:26Z", "type": "commit"}, {"oid": "d80107edcd8f4d9e85ab0ccf110550072a2c9111", "url": "https://github.com/apache/beam/commit/d80107edcd8f4d9e85ab0ccf110550072a2c9111", "message": "fix checkstyle", "committedDate": "2020-04-27T17:45:47Z", "type": "commit"}]}