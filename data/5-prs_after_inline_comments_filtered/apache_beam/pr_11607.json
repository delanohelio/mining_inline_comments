{"pr_number": 11607, "pr_title": "[BEAM-9430] Fixes the bounds of initial watermark set to estimators instead of raising an error", "pr_createdAt": "2020-05-04T22:48:25Z", "pr_url": "https://github.com/apache/beam/pull/11607", "timeline": [{"oid": "479c875704d575c488de252ee7d3f370171064b7", "url": "https://github.com/apache/beam/commit/479c875704d575c488de252ee7d3f370171064b7", "message": "Fixes the bounds of initial watermark set to estimators instead of raising an error.", "committedDate": "2020-05-06T22:56:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNDI0OA==", "url": "https://github.com/apache/beam/pull/11607#discussion_r421824248", "bodyText": "The bounds are wrong, they should be BoundedWindow.TIMESTAMP_MIN_VALUE and BoundedWindow.TIMESTAMP_MAX_VALUE. This could have been the issue with the timestamp being out of range. If that is the case then I would rather keep the bounds as they were and make setWatermark more restrictive. We should also update the javadoc for setWatermark/currentWatermark (on the interfaces) saying that the value must always be within these bounds.\nI think it makes more sense keep the restriction here and also make the restriction within setWatermark as well so the user gets an error when setting it.", "author": "lukecwik", "createdAt": "2020-05-07T22:11:07Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/WatermarkEstimators.java", "diffHunk": "@@ -37,14 +37,16 @@\n     private Instant lastReportedWatermark;\n \n     public Manual(Instant watermark) {\n-      this.watermark = checkNotNull(watermark, \"watermark must not be null.\");\n-      if (watermark.isBefore(GlobalWindow.TIMESTAMP_MIN_VALUE)\n-          || watermark.isAfter(GlobalWindow.TIMESTAMP_MAX_VALUE)) {\n-        throw new IllegalArgumentException(\n-            String.format(\n-                \"Provided watermark %s must be within bounds [%s, %s].\",\n-                watermark, GlobalWindow.TIMESTAMP_MIN_VALUE, GlobalWindow.TIMESTAMP_MAX_VALUE));\n+      checkNotNull(watermark, \"watermark must not be null.\");\n+\n+      // Making sure that the watermark is within bounds.", "originalCommit": "479c875704d575c488de252ee7d3f370171064b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNjg5Ng==", "url": "https://github.com/apache/beam/pull/11607#discussion_r421826896", "bodyText": "What's the difference between those values. Seems like GlobalWindow get's these constants from the super class BoundedWindow ?", "author": "chamikaramj", "createdAt": "2020-05-07T22:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNDI0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNzQ0Mw==", "url": "https://github.com/apache/beam/pull/11607#discussion_r421827443", "bodyText": "MIN is the same but GlobalWindow.MAX = BoundedWindow.MAX - 1 day as can be seen here: \n  \n    \n      beam/model/pipeline/src/main/proto/beam_runner_api.proto\n    \n    \n         Line 38\n      in\n      25b4ebc\n    \n    \n    \n    \n\n        \n          \n           enum Constants {", "author": "lukecwik", "createdAt": "2020-05-07T22:19:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNDI0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgzMDkyMg==", "url": "https://github.com/apache/beam/pull/11607#discussion_r421830922", "bodyText": "Right, but we are using the constant from the super class here (TIMESTAMP_MAX_VALUE) not END_OF_GLOBAL_WINDOW.\n\n  \n    \n      beam/sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/windowing/GlobalWindow.java\n    \n    \n         Line 39\n      in\n      25b4ebc\n    \n    \n    \n    \n\n        \n          \n           private static final Instant END_OF_GLOBAL_WINDOW = extractMaxTimestampFromProto(); \n        \n    \n  \n\n\nAlso, the error we saw was following which points to min value being off, not max value.\njava.lang.IllegalArgumentException: Provided watermark -290308-12-21T19:59:05.224Z must be within bounds [-290308-12-21T19:59:05.225Z, 294247-01-10T04:00:54.775Z].", "author": "chamikaramj", "createdAt": "2020-05-07T22:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNDI0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzNjE2Nw==", "url": "https://github.com/apache/beam/pull/11607#discussion_r422236167", "bodyText": "Your right, it would be good to migrate to use BoundedWindow as the import for the static though.\nI think it makes sense to make the constructor validate the bounds and have setWatermark ensure that the value is within the range as expected. We can fix the UnboundedSource SDF wrapper to clamp the watermark value that is being reported from UnboundedReader instead.", "author": "lukecwik", "createdAt": "2020-05-08T16:20:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNDI0OA=="}], "type": "inlineReview"}, {"oid": "27353436387d03116dd682da4a75f25854bfae56", "url": "https://github.com/apache/beam/commit/27353436387d03116dd682da4a75f25854bfae56", "message": "Ensures that watermark passed to estimator is within bounds.\n\nAlso updates WatermarkEstimator and the test to link to correct class when using constants.", "committedDate": "2020-05-14T00:37:00Z", "type": "commit"}, {"oid": "27353436387d03116dd682da4a75f25854bfae56", "url": "https://github.com/apache/beam/commit/27353436387d03116dd682da4a75f25854bfae56", "message": "Ensures that watermark passed to estimator is within bounds.\n\nAlso updates WatermarkEstimator and the test to link to correct class when using constants.", "committedDate": "2020-05-14T00:37:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgwOTQzNQ==", "url": "https://github.com/apache/beam/pull/11607#discussion_r424809435", "bodyText": "How about moving to parent scope and making static so we can share this method in all three estimators?", "author": "ihji", "createdAt": "2020-05-14T00:45:04Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/WatermarkEstimators.java", "diffHunk": "@@ -37,18 +37,23 @@\n     private Instant lastReportedWatermark;\n \n     public Manual(Instant watermark) {\n+      validateWatermark(watermark);\n       this.watermark = checkNotNull(watermark, \"watermark must not be null.\");\n-      if (watermark.isBefore(GlobalWindow.TIMESTAMP_MIN_VALUE)\n-          || watermark.isAfter(GlobalWindow.TIMESTAMP_MAX_VALUE)) {\n+    }\n+\n+    private void validateWatermark(Instant watermark) {", "originalCommit": "27353436387d03116dd682da4a75f25854bfae56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxNDkzNg==", "url": "https://github.com/apache/beam/pull/11607#discussion_r424814936", "bodyText": "Done.", "author": "chamikaramj", "createdAt": "2020-05-14T01:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgwOTQzNQ=="}], "type": "inlineReview"}, {"oid": "78c4eb0dfb8f91c1020a85ba2ef514a240beaa9c", "url": "https://github.com/apache/beam/commit/78c4eb0dfb8f91c1020a85ba2ef514a240beaa9c", "message": "Moves the validator to parent.", "committedDate": "2020-05-14T01:06:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgzMDIyOA==", "url": "https://github.com/apache/beam/pull/11607#discussion_r424830228", "bodyText": "I was thinking that this logic would be where we call setWatermark above on line 510\nNote that the initial watermark estimate state is current element timestamp which is always between MIN and MAX timestamp values.", "author": "lukecwik", "createdAt": "2020-05-14T02:06:21Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/Read.java", "diffHunk": "@@ -537,6 +538,12 @@ public Instant getInitialWatermarkEstimatorState(@Timestamp Instant currentEleme\n     @NewWatermarkEstimator\n     public WatermarkEstimators.Manual newWatermarkEstimator(\n         @WatermarkEstimatorState Instant watermarkEstimatorState) {\n+      // Making sure that the watermark is within bounds.\n+      if (watermarkEstimatorState.isBefore(BoundedWindow.TIMESTAMP_MIN_VALUE)) {\n+        watermarkEstimatorState = BoundedWindow.TIMESTAMP_MIN_VALUE;\n+      } else if (watermarkEstimatorState.isAfter(BoundedWindow.TIMESTAMP_MAX_VALUE)) {\n+        watermarkEstimatorState = BoundedWindow.TIMESTAMP_MAX_VALUE;\n+      }", "originalCommit": "78c4eb0dfb8f91c1020a85ba2ef514a240beaa9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4NDA4NQ==", "url": "https://github.com/apache/beam/pull/11607#discussion_r425284085", "bodyText": "Added to both.", "author": "chamikaramj", "createdAt": "2020-05-14T16:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgzMDIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgzMTk5OA==", "url": "https://github.com/apache/beam/pull/11607#discussion_r424831998", "bodyText": "It makes more sense to add this method to BoundedWindow as it should apply to a lot more places then just WatermarkEstimators.", "author": "lukecwik", "createdAt": "2020-05-14T02:13:22Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/WatermarkEstimator.java", "diffHunk": "@@ -44,4 +45,19 @@\n    * <p>The state returned must not be mutated.\n    */\n   WatermarkEstimatorStateT getState();\n+\n+  /**\n+   * Validates that a given watermark is within timestamp min and max bounds.\n+   *\n+   * @param watermark watermark to validate\n+   */\n+  static void ensureWatermarkWithinBounds(Instant watermark) {", "originalCommit": "78c4eb0dfb8f91c1020a85ba2ef514a240beaa9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4MzY5NA==", "url": "https://github.com/apache/beam/pull/11607#discussion_r425283694", "bodyText": "Done.", "author": "chamikaramj", "createdAt": "2020-05-14T16:47:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgzMTk5OA=="}], "type": "inlineReview"}, {"oid": "11f8ca4477dd138b1a0687d4748b3ceedef7d105", "url": "https://github.com/apache/beam/commit/11f8ca4477dd138b1a0687d4748b3ceedef7d105", "message": "Addresses reviewer comments.", "committedDate": "2020-05-14T16:31:31Z", "type": "commit"}, {"oid": "68fe7c1131db39f05c7527ee05ef85d9403b70cc", "url": "https://github.com/apache/beam/commit/68fe7c1131db39f05c7527ee05ef85d9403b70cc", "message": "Addresses reviewer comments.", "committedDate": "2020-05-14T16:45:47Z", "type": "commit"}]}