{"pr_number": 13114, "pr_title": "[BEAM-11066] Fix java dataflow runner override factories ordering with streaming beam_fn_api ", "pr_createdAt": "2020-10-14T19:05:26Z", "pr_url": "https://github.com/apache/beam/pull/13114", "timeline": [{"oid": "98850ad70ee4cee15d49b58ea39e3be1b7c8c9f0", "url": "https://github.com/apache/beam/commit/98850ad70ee4cee15d49b58ea39e3be1b7c8c9f0", "message": "[BEAM-11066] Fix dataflow runner transform override ordering for streaming with beam_fn_api.", "committedDate": "2020-10-15T17:45:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNjM5OA==", "url": "https://github.com/apache/beam/pull/13114#discussion_r505726398", "bodyText": "The --streaming flag really just controls whether a runner is in \"streaming mode\". Not all runners even have a streaming mode, and it should never affect the semantics of the pipeline. So I don't think that should affect the code or logic of the example. The problem seems to be a bug in the DataflowRunner, not anything to do with the example.", "author": "kennknowles", "createdAt": "2020-10-15T17:45:04Z", "path": "examples/java/src/main/java/org/apache/beam/examples/WordCount.java", "diffHunk": "@@ -180,8 +181,11 @@ static void runWordCount(WordCountOptions options) {\n     p.apply(\"ReadLines\", TextIO.read().from(options.getInputFile()))\n         .apply(new CountWords())\n         .apply(MapElements.via(new FormatAsTextFn()))\n-        .apply(\"WriteCounts\", TextIO.write().to(options.getOutput()));\n-\n+        .apply(\n+            \"WriteCounts\",\n+            options.as(StreamingOptions.class).isStreaming()", "originalCommit": "1c16969b9fcff36a3e03e287556bfce5e9ecd73f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTczMDk2NQ==", "url": "https://github.com/apache/beam/pull/13114#discussion_r505730965", "bodyText": "looks like the StreamingShardedWriteFactory overwrites the WriteFiles transform(which incorporates Create.Values() that should be overwritten by StreamingFnApiCreateOverrideFactory, I've tested reordering of the overrides and it seems to solve the problem.\nit seems hard in general to keep the ordering always correct if we only replace all transforms in one run but I guess the Factories that overwrites into a composite transform should be added first.", "author": "y1chi", "createdAt": "2020-10-15T17:52:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNjM5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTczNzkzMg==", "url": "https://github.com/apache/beam/pull/13114#discussion_r505737932", "bodyText": "Yea it is hard to keep the ordering correct. I have some troubles with it all. We probably need to have a bigger plan for ordering them. Or, we could just apply them over and over until it stops... (or times out)", "author": "kennknowles", "createdAt": "2020-10-15T18:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNjM5OA=="}], "type": "inlineReview"}, {"oid": "98850ad70ee4cee15d49b58ea39e3be1b7c8c9f0", "url": "https://github.com/apache/beam/commit/98850ad70ee4cee15d49b58ea39e3be1b7c8c9f0", "message": "[BEAM-11066] Fix dataflow runner transform override ordering for streaming with beam_fn_api.", "committedDate": "2020-10-15T17:45:24Z", "type": "forcePushed"}]}