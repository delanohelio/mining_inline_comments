{"pr_number": 12639, "pr_title": "[BEAM-9979] Fix read index being reported to be reset after any metrics request could happen for the prior bundle and before any metrics request for the next bundle.", "pr_createdAt": "2020-08-19T22:24:06Z", "pr_url": "https://github.com/apache/beam/pull/12639", "timeline": [{"oid": "1b036d637f30366072d12ca9bc2e916f3425b5ac", "url": "https://github.com/apache/beam/commit/1b036d637f30366072d12ca9bc2e916f3425b5ac", "message": "[BEAM-9979] Fix read index being reported to be reset after any metrics request could happen for the prior bundle and before any metrics request for the next bundle.", "committedDate": "2020-08-19T22:21:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUwOTMwNA==", "url": "https://github.com/apache/beam/pull/12639#discussion_r473509304", "bodyText": "should we also check index != -1?", "author": "boyuanzz", "createdAt": "2020-08-20T01:26:22Z", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/BeamFnDataReadRunner.java", "diffHunk": "@@ -237,8 +232,9 @@ public void trySplit(\n     }\n \n     synchronized (splittingLock) {\n-      // Don't attempt to split if we haven't started.\n-      if (!started) {\n+      // Don't attempt to split if we are already done since there isn't a meaningful split we can\n+      // provide.\n+      if (index == stopIndex) {", "originalCommit": "1b036d637f30366072d12ca9bc2e916f3425b5ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEwNDQwNQ==", "url": "https://github.com/apache/beam/pull/12639#discussion_r474104405", "bodyText": "No, the logic below will allow us to choose a stopIndex even if registerInputLocation has not been invoked. See testSplittingWhenNoElementsProcessed. I added a variant of that test where we split before registerInputLocation happens to get coverage for this case.", "author": "lukecwik", "createdAt": "2020-08-20T16:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUwOTMwNA=="}], "type": "inlineReview"}, {"oid": "8705a9a11880a9befc6dfdf4e2e9641c8a331081", "url": "https://github.com/apache/beam/commit/8705a9a11880a9befc6dfdf4e2e9641c8a331081", "message": "fixup! Add additional test covering split before registerInputLocation is invoked.", "committedDate": "2020-08-20T16:16:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNTIyNA==", "url": "https://github.com/apache/beam/pull/12639#discussion_r474135224", "bodyText": "I may misunderstand some content here but I thought we don't perform splitting if the bundle is not started.", "author": "boyuanzz", "createdAt": "2020-08-20T16:53:03Z", "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/BeamFnDataReadRunnerTest.java", "diffHunk": "@@ -352,6 +354,35 @@ public void testRegistration() {\n       fail(\"Expected registrar not found.\");\n     }\n \n+    @Test\n+    public void testSplittingBeforeStartBundle() throws Exception {\n+      List<WindowedValue<String>> outputValues = new ArrayList<>();\n+      BeamFnDataReadRunner<String> readRunner =\n+          createReadRunner(outputValues::add, PTRANSFORM_ID, mockBeamFnDataClient);\n+      // The split should happen at 5 since the allowedSplitPoints is empty.\n+      assertEquals(", "originalCommit": "8705a9a11880a9befc6dfdf4e2e9641c8a331081", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NDYxOA==", "url": "https://github.com/apache/beam/pull/12639#discussion_r474144618", "bodyText": "A bundle can be started before each transforms start method has been invoked since we invoke start starting from the leaves and going to the parents and then we invoke finish in reverse order.\nHaving this definition of started allows us to get msec counters for start methods since they can be slow, checkpointing without processing through this read transform...", "author": "lukecwik", "createdAt": "2020-08-20T17:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3MzMwMg==", "url": "https://github.com/apache/beam/pull/12639#discussion_r474173302", "bodyText": "I see. So that means we are now allowing splitting before processing gets started, right?", "author": "boyuanzz", "createdAt": "2020-08-20T18:01:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NTcxNg==", "url": "https://github.com/apache/beam/pull/12639#discussion_r474185716", "bodyText": "We always did before as well since registerInputLocation doesn't mean we have seen any elements yet just that we are eligible to get them. This expands that time frame before receiving the first element slightly.", "author": "lukecwik", "createdAt": "2020-08-20T18:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNTIyNA=="}], "type": "inlineReview"}]}