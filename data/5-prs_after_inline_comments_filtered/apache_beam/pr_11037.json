{"pr_number": 11037, "pr_title": "[BEAM-9434] Improve Spark runner reshuffle translation to maximize parallelism", "pr_createdAt": "2020-03-04T01:13:00Z", "pr_url": "https://github.com/apache/beam/pull/11037", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4OTI2NQ==", "url": "https://github.com/apache/beam/pull/11037#discussion_r403789265", "bodyText": "I believe we should do the same thing in the streaming and batch portable pipeline translators as well.", "author": "lukecwik", "createdAt": "2020-04-06T01:30:47Z", "path": "runners/spark/src/main/java/org/apache/beam/runners/spark/translation/TransformTranslator.java", "diffHunk": "@@ -695,8 +695,10 @@ public void evaluate(Reshuffle<K, V> transform, EvaluationContext context) {\n         final WindowedValue.WindowedValueCoder<KV<K, V>> wvCoder =\n             WindowedValue.FullWindowedValueCoder.of(coder, windowFn.windowCoder());\n \n+        int numPartitions =\n+            Math.max(context.getSparkContext().defaultParallelism(), inRDD.getNumPartitions());", "originalCommit": "b0d2620749518eaa08ffcb046ea9bf31bed55ff7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA1MzM5Ng==", "url": "https://github.com/apache/beam/pull/11037#discussion_r404053396", "bodyText": "Can you please let this method how it was before and better, and do int numPartitions = Math.max(rdd.context().defaultParallelism(), rdd.getNumPartitions()); inside of it. That way you don't need to replicate the change in the different translators..", "author": "iemejia", "createdAt": "2020-04-06T12:31:26Z", "path": "runners/spark/src/main/java/org/apache/beam/runners/spark/translation/GroupCombineFunctions.java", "diffHunk": "@@ -184,11 +184,11 @@\n \n   /** An implementation of {@link Reshuffle} for the Spark runner. */\n   public static <T> JavaRDD<WindowedValue<T>> reshuffle(\n-      JavaRDD<WindowedValue<T>> rdd, WindowedValueCoder<T> wvCoder) {\n+      JavaRDD<WindowedValue<T>> rdd, WindowedValueCoder<T> wvCoder, int numPartitions) {", "originalCommit": "b0d2620749518eaa08ffcb046ea9bf31bed55ff7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3MjA5MA==", "url": "https://github.com/apache/beam/pull/11037#discussion_r404372090", "bodyText": "@iemejia @lukecwik ok will do the changes. The only reason why I opted to change only the batch pipeline for Spark is that it is the only one I am in a position to thoroughly test for real. However, analysing the code suggests that changing all pipelines does not harm, so I'll go for the suggested changes.\nWill submit the squashed PR soon. In the meantime, thanks for the review.", "author": "ecapoccia", "createdAt": "2020-04-06T20:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA1MzM5Ng=="}], "type": "inlineReview"}, {"oid": "62ad6bc7113db8287765b8c4fafaa5ea900d286a", "url": "https://github.com/apache/beam/commit/62ad6bc7113db8287765b8c4fafaa5ea900d286a", "message": "[BEAM-9434] Improve Spark runner reshuffle translation to maximize parallelism", "committedDate": "2020-04-06T22:56:12Z", "type": "commit"}, {"oid": "62ad6bc7113db8287765b8c4fafaa5ea900d286a", "url": "https://github.com/apache/beam/commit/62ad6bc7113db8287765b8c4fafaa5ea900d286a", "message": "[BEAM-9434] Improve Spark runner reshuffle translation to maximize parallelism", "committedDate": "2020-04-06T22:56:12Z", "type": "forcePushed"}]}