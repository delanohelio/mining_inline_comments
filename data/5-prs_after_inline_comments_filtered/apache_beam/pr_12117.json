{"pr_number": 12117, "pr_title": "[BEAM-10343] Add dispositions for SnowflakeIO.write", "pr_createdAt": "2020-06-29T08:37:34Z", "pr_url": "https://github.com/apache/beam/pull/12117", "timeline": [{"oid": "fdb94ae4ad4438772220340dcb152c012df4088c", "url": "https://github.com/apache/beam/commit/fdb94ae4ad4438772220340dcb152c012df4088c", "message": "[BEAM-10343] feat: add CreateDispostion support for write method", "committedDate": "2020-06-29T08:46:00Z", "type": "forcePushed"}, {"oid": "73df569be3a0fcff7edf6b1abd86f3d3df4e3cb3", "url": "https://github.com/apache/beam/commit/73df569be3a0fcff7edf6b1abd86f3d3df4e3cb3", "message": "[BEAM-10343] feat: add CreateDispostion support for write method", "committedDate": "2020-06-29T08:49:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE1MjA4OQ==", "url": "https://github.com/apache/beam/pull/12117#discussion_r449152089", "bodyText": "Rename toTable() method to to()? Seems more consistent with other ios, eg. BigQueryIO and you already specify String table argument and the docs tells what's the subject of this operation so it's all clear. :)", "author": "lgajowy", "createdAt": "2020-07-02T16:58:54Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java", "diffHunk": "@@ -593,7 +606,7 @@ public void populateDisplayData(DisplayData.Builder builder) {\n      *\n      * @param table - String with the name of the table.\n      */\n-    public Write<T> withTable(String table) {\n+    public Write<T> toTable(String table) {", "originalCommit": "c09123d8acff73569512f92a5bafddd6c97cf3a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxMTc3OQ==", "url": "https://github.com/apache/beam/pull/12117#discussion_r450011779", "bodyText": "Sounds reasonable. I will change to to()", "author": "purbanow", "createdAt": "2020-07-06T06:39:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE1MjA4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE1MjU4Mw==", "url": "https://github.com/apache/beam/pull/12117#discussion_r449152583", "bodyText": "nit: could you move this toTable() call below all with... calls?", "author": "lgajowy", "createdAt": "2020-07-02T16:59:46Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java", "diffHunk": "@@ -155,7 +157,7 @@\n  * items.apply(\n  *     SnowflakeIO.<KV<Integer, String>>write()\n  *         .withDataSourceConfiguration(dataSourceConfiguration)\n- *         .withTable(table)\n+ *         .toTable(table)", "originalCommit": "c09123d8acff73569512f92a5bafddd6c97cf3a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxMTI4Mg==", "url": "https://github.com/apache/beam/pull/12117#discussion_r450011282", "bodyText": "Sure :)", "author": "purbanow", "createdAt": "2020-07-06T06:37:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE1MjU4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3MDUxMQ==", "url": "https://github.com/apache/beam/pull/12117#discussion_r449170511", "bodyText": "I wonder if there's a way of testing all the Snowflake data types in one test/one testing SnowflakeDataTypeTest class  (parametrized test?). \ud83e\udd14 Worth trying imho but I didn't check this.", "author": "lgajowy", "createdAt": "2020-07-02T17:33:26Z", "path": "sdks/java/io/snowflake/src/test/java/org/apache/beam/sdk/io/snowflake/test/unit/data/SnowflakeBooleanTest.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.snowflake.test.unit.data;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import org.apache.beam.sdk.io.snowflake.data.logical.SnowflakeBoolean;\n+import org.junit.Test;\n+\n+public class SnowflakeBooleanTest {", "originalCommit": "c09123d8acff73569512f92a5bafddd6c97cf3a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIxODgyMw==", "url": "https://github.com/apache/beam/pull/12117#discussion_r450218823", "bodyText": "Thanks for this idea. I created parametrized test.\nhttps://github.com/apache/beam/blob/b68646ffab38774864e421c6d4a704af5fd6a668/sdks/java/io/snowflake/src/test/java/org/apache/beam/sdk/io/snowflake/test/unit/data/SnowflakeDataTypeValidTest.java", "author": "purbanow", "createdAt": "2020-07-06T13:26:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3MDUxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3ODI0Nw==", "url": "https://github.com/apache/beam/pull/12117#discussion_r449178247", "bodyText": "Are the double spaces needed here?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"SELECT EXISTS (SELECT 1 FROM  information_schema.tables  WHERE  table_name = '%s');\",\n          \n          \n            \n                        \"SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = '%s');\",", "author": "lgajowy", "createdAt": "2020-07-02T17:48:45Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/services/SnowflakeServiceImpl.java", "diffHunk": "@@ -169,6 +191,54 @@ private void prepareTableAccordingWriteDisposition(\n     }\n   }\n \n+  private void createTableIfNotExists(\n+      DataSource dataSource, String table, SnowflakeTableSchema tableSchema) throws SQLException {\n+    String query =\n+        String.format(\n+            \"SELECT EXISTS (SELECT 1 FROM  information_schema.tables  WHERE  table_name = '%s');\",", "originalCommit": "c09123d8acff73569512f92a5bafddd6c97cf3a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxMjY4Nw==", "url": "https://github.com/apache/beam/pull/12117#discussion_r450012687", "bodyText": "Totally not. Thanks for spotting this .", "author": "purbanow", "createdAt": "2020-07-06T06:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3ODI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MDI2MQ==", "url": "https://github.com/apache/beam/pull/12117#discussion_r449180261", "bodyText": "CloudProvider is used only in SnowflakeServiceImpl. I think it makes sense to keep it inside the serviceImpl as a private enum, wdyt?", "author": "lgajowy", "createdAt": "2020-07-02T17:52:43Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/services/SnowflakeServiceImpl.java", "diffHunk": "@@ -25,7 +27,9 @@\n import java.util.function.Consumer;\n import java.util.stream.Collectors;\n import javax.sql.DataSource;\n+import org.apache.beam.sdk.io.snowflake.data.SnowflakeTableSchema;\n import org.apache.beam.sdk.io.snowflake.enums.CloudProvider;", "originalCommit": "c09123d8acff73569512f92a5bafddd6c97cf3a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxNTI2Nw==", "url": "https://github.com/apache/beam/pull/12117#discussion_r450015267", "bodyText": "For now, I would keep it outside of serviceImpl as its easier to see which cloud providers currently are supported by IO.", "author": "purbanow", "createdAt": "2020-07-06T06:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MDI2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY3NzkzOQ==", "url": "https://github.com/apache/beam/pull/12117#discussion_r451677939", "bodyText": "I'm not sure, to be honest. Users should look for that information in the docs. Note that technically (not that I'd wish for this) there are ways of providing support to other cloud providers without extending that enum so looking at the endpoint is not the ultimate proof that only gcs is supported. If there's no docs or it's out of date regarding cloud providers support, the devs will still need to dig into the IO implementation details to really find out. So having this enum public is not much help imho.\nOn the other hand, what we do now is that we leave an implementation detail (noise) that is not useful for the users in any way in code in the public API. I'd suggest hiding it and maybe expose it later if there is a good reason to do so. :)", "author": "lgajowy", "createdAt": "2020-07-08T16:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MDI2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk3MzM3NA==", "url": "https://github.com/apache/beam/pull/12117#discussion_r451973374", "bodyText": "I see your point. I even removed this enum and add following variable to the Service file:\nprivate static final String GCS_PREFIX = \"gs://\";", "author": "purbanow", "createdAt": "2020-07-09T05:33:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MDI2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MzI2Nw==", "url": "https://github.com/apache/beam/pull/12117#discussion_r449183267", "bodyText": "Does it make sense to add a message for the exception? Something like \"Snowflake binary maximum size exceeded.\".", "author": "lgajowy", "createdAt": "2020-07-02T17:58:36Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/data/text/SnowflakeBinary.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.snowflake.data.text;\n+\n+import java.io.Serializable;\n+import org.apache.beam.sdk.io.snowflake.data.SnowflakeDataType;\n+\n+public class SnowflakeBinary implements SnowflakeDataType, Serializable {\n+\n+  private static final Long MAX_SIZE = 8388608L;\n+\n+  private Long size; // bytes\n+\n+  public SnowflakeBinary() {}\n+\n+  public static SnowflakeBinary of() {\n+    return new SnowflakeBinary();\n+  }\n+\n+  public static SnowflakeBinary of(long size) {\n+    return new SnowflakeBinary(size);\n+  }\n+\n+  public SnowflakeBinary(long size) {\n+    if (size > MAX_SIZE) {\n+      throw new IllegalArgumentException();", "originalCommit": "c09123d8acff73569512f92a5bafddd6c97cf3a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxODcxNQ==", "url": "https://github.com/apache/beam/pull/12117#discussion_r450018715", "bodyText": "I added message. Thanks", "author": "purbanow", "createdAt": "2020-07-06T06:56:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MzI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4Mzc4Mg==", "url": "https://github.com/apache/beam/pull/12117#discussion_r449183782", "bodyText": "(Same as above)", "author": "lgajowy", "createdAt": "2020-07-02T17:59:12Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/data/text/SnowflakeVarchar.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.snowflake.data.text;\n+\n+import java.io.Serializable;\n+import org.apache.beam.sdk.io.snowflake.data.SnowflakeDataType;\n+\n+public class SnowflakeVarchar implements SnowflakeDataType, Serializable {\n+  private static final Long MAX_LENGTH = 16777216L;\n+  private Long length;\n+\n+  public static SnowflakeVarchar of() {\n+    return new SnowflakeVarchar();\n+  }\n+\n+  public static SnowflakeVarchar of(long length) {\n+    return new SnowflakeVarchar(length);\n+  }\n+\n+  public SnowflakeVarchar() {}\n+\n+  public SnowflakeVarchar(long length) {\n+    if (length > MAX_LENGTH) {\n+      throw new IllegalArgumentException();", "originalCommit": "c09123d8acff73569512f92a5bafddd6c97cf3a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxODgzOA==", "url": "https://github.com/apache/beam/pull/12117#discussion_r450018838", "bodyText": "I added message. Thanks", "author": "purbanow", "createdAt": "2020-07-06T06:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4Mzc4Mg=="}], "type": "inlineReview"}, {"oid": "84c535f11dc5d2dcb5d32cbf5088cb58f0ee0dc5", "url": "https://github.com/apache/beam/commit/84c535f11dc5d2dcb5d32cbf5088cb58f0ee0dc5", "message": "refactor: introduce parametrized test for data types", "committedDate": "2020-07-06T13:35:01Z", "type": "forcePushed"}, {"oid": "af61ee29f8ca2ee96889760cd0bc6c1e05bc4954", "url": "https://github.com/apache/beam/commit/af61ee29f8ca2ee96889760cd0bc6c1e05bc4954", "message": "[BEAM-10343] feat: add CreateDispostion support for write method", "committedDate": "2020-07-06T13:41:58Z", "type": "commit"}, {"oid": "aecf5e5b092145103e33b644ef70f8b310cf3978", "url": "https://github.com/apache/beam/commit/aecf5e5b092145103e33b644ef70f8b310cf3978", "message": "fix: add missing licenses", "committedDate": "2020-07-06T13:41:58Z", "type": "commit"}, {"oid": "b5f50851a97fffaaabe0b98050a7adc9203edfd3", "url": "https://github.com/apache/beam/commit/b5f50851a97fffaaabe0b98050a7adc9203edfd3", "message": "fix: remove external keyword from tests and change output* to output", "committedDate": "2020-07-06T13:41:58Z", "type": "commit"}, {"oid": "c7032b0503dc604d3fe1d3906968239ce095442c", "url": "https://github.com/apache/beam/commit/c7032b0503dc604d3fe1d3906968239ce095442c", "message": "Small improvments after code-review", "committedDate": "2020-07-06T13:41:59Z", "type": "commit"}, {"oid": "c1244ff9bf9c1aaf659ee043d10be394f427420f", "url": "https://github.com/apache/beam/commit/c1244ff9bf9c1aaf659ee043d10be394f427420f", "message": "refactor: introduce parametrized test for data types", "committedDate": "2020-07-06T13:46:32Z", "type": "commit"}, {"oid": "c1244ff9bf9c1aaf659ee043d10be394f427420f", "url": "https://github.com/apache/beam/commit/c1244ff9bf9c1aaf659ee043d10be394f427420f", "message": "refactor: introduce parametrized test for data types", "committedDate": "2020-07-06T13:46:32Z", "type": "forcePushed"}, {"oid": "a4a8de671e4d1b7f71492361d0eb386bab1b7b00", "url": "https://github.com/apache/beam/commit/a4a8de671e4d1b7f71492361d0eb386bab1b7b00", "message": "feat: remove CloudProvider enum", "committedDate": "2020-07-09T05:30:58Z", "type": "commit"}]}