{"pr_number": 11919, "pr_title": "[BEAM-10114] Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.", "pr_createdAt": "2020-06-04T14:57:41Z", "pr_url": "https://github.com/apache/beam/pull/11919", "timeline": [{"oid": "8aa898e2eb0a686f4b99f978b0a649f3265b9dc6", "url": "https://github.com/apache/beam/commit/8aa898e2eb0a686f4b99f978b0a649f3265b9dc6", "message": "Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.\n\nAlso adapt to beam conventions and restrictions.", "committedDate": "2020-06-04T14:54:32Z", "type": "commit"}, {"oid": "a2d74ca34c0aadbda2c7293d1b59aaff3adea88a", "url": "https://github.com/apache/beam/commit/a2d74ca34c0aadbda2c7293d1b59aaff3adea88a", "message": "Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.\n\nAlso adapt to beam conventions and restrictions.", "committedDate": "2020-06-04T14:54:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2NTc1OQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r435965759", "bodyText": "this will fail on dataflow, it doesn't support SetState or MapState yet.  Dataflow does have its own deduplicate implementation [1] that pushes the work to windmill's own exactly-once impl, you might be able to override this transform w/ that in the runner?  There's also a Deduplicate transform [2] in beam now, but I don't think it'd scale very well.\n[1] \n  \n    \n      beam/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowRunner.java\n    \n    \n         Line 1729\n      in\n      8aedab2\n    \n    \n    \n    \n\n        \n          \n           private static class Deduplicate<T> \n        \n    \n  \n\n\n[2] https://github.com/apache/beam/blob/8aedab2da96e1324f8433df3c772d59346f825b4/sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/Deduplicate.java", "author": "steveniemitz", "createdAt": "2020-06-05T14:38:05Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/DeduplicationFn.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import org.apache.beam.sdk.coders.Coder;\n+import org.apache.beam.sdk.coders.DelegateCoder;\n+import org.apache.beam.sdk.coders.InstantCoder;\n+import org.apache.beam.sdk.coders.ListCoder;\n+import org.apache.beam.sdk.coders.MapCoder;\n+import org.apache.beam.sdk.state.SetState;\n+import org.apache.beam.sdk.state.StateSpec;\n+import org.apache.beam.sdk.state.StateSpecs;\n+import org.apache.beam.sdk.state.ValueState;\n+import org.apache.beam.sdk.transforms.DoFn;\n+import org.apache.beam.sdk.values.KV;\n+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.collect.Lists;\n+import org.joda.time.Instant;\n+\n+// A DeduplicationFn takes a KV from a hashed version of KeyT to a KV of KeyT and ValueT and\n+// deduplicates based on KeyT. KeyT must provide a non-identity implementation of equals.\n+class DeduplicationFn<KeyT, ValueT> extends DoFn<KV<Integer, KV<KeyT, ValueT>>, KV<KeyT, ValueT>> {\n+  private final DeduplicationFnOptions<KeyT> options;\n+\n+  // A state cell holding the set of recently received keys.\n+  @SuppressWarnings(\"unused\")\n+  @StateId(\"keySet\")\n+  private final StateSpec<SetState<KeyT>> keySetSpec;", "originalCommit": "a2d74ca34c0aadbda2c7293d1b59aaff3adea88a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxOTU4NQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r437419585", "bodyText": "Ill change this to use 2, this should work in all runners not just dataflow. I think the extensible approach would be to eventually have the dataflow runner override the deduplicate transform? but thats a bit out of scope for this.", "author": "dpcollins-google", "createdAt": "2020-06-09T13:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2NTc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3MTg3Nw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r437471877", "bodyText": "Done. I've chosen option 2, since I don't want this to be dataflow-specific.", "author": "dpcollins-google", "createdAt": "2020-06-09T14:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2NTc1OQ=="}], "type": "inlineReview"}, {"oid": "96d150819f333bd1a76f6b085b151cd14e8a9089", "url": "https://github.com/apache/beam/commit/96d150819f333bd1a76f6b085b151cd14e8a9089", "message": "Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.\n\nAlso adapt to beam conventions and restrictions.", "committedDate": "2020-06-04T14:54:32Z", "type": "forcePushed"}, {"oid": "a6ee4b3fa536f480075c4b619076864a23ad127f", "url": "https://github.com/apache/beam/commit/a6ee4b3fa536f480075c4b619076864a23ad127f", "message": "Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.\n\nAlso adapt to beam conventions and restrictions.", "committedDate": "2020-06-04T14:54:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2OTQ5Nw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r442969497", "bodyText": "In addition to @experimental, this needs javadoc about how it's not yet supported by GCP.\nMaybe this should all live in a directory with \"experimental\" in the name?  Unfortunately, there's quite a bit of stuff marked @experimental in Beam, so users won't treat it with appropriate caution", "author": "dpmills", "createdAt": "2020-06-19T17:43:15Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/PubsubLiteIO.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.Read;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.transforms.SerializableFunction;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.PDone;\n+import org.apache.beam.sdk.values.PInput;\n+import org.apache.beam.sdk.values.POutput;\n+\n+@Experimental", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA0ODgxMQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443048811", "bodyText": "Using a different directory will require \"moving\" it later which will have its own hassles. I think the annotation even if users may ignore it is the right way to go.", "author": "lukecwik", "createdAt": "2020-06-19T21:22:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2OTQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5NzgwNw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443097807", "bodyText": "I'm going to mark this as resolved, feel free to reopen?", "author": "dpcollins-google", "createdAt": "2020-06-20T03:41:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2OTQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwOTUxMw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443709513", "bodyText": "Please add javadoc explaining the current state of this code.  Current directory setup LGTM.", "author": "dpmills", "createdAt": "2020-06-22T17:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2OTQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1MDk0Mg==", "url": "https://github.com/apache/beam/pull/11919#discussion_r452650942", "bodyText": "Please address this.", "author": "chamikaramj", "createdAt": "2020-07-10T06:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2OTQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2OTk3OA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r442969978", "bodyText": "Change comments to javadoc style", "author": "dpmills", "createdAt": "2020-06-19T17:44:25Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/PubsubLiteIO.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.Read;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.transforms.SerializableFunction;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.PDone;\n+import org.apache.beam.sdk.values.PInput;\n+import org.apache.beam.sdk.values.POutput;\n+\n+@Experimental\n+public final class PubsubLiteIO {\n+  private PubsubLiteIO() {}\n+\n+  private static <InT extends PInput, OutT extends POutput> PTransform<InT, OutT> toTransform(\n+      SerializableFunction<InT, OutT> fn, String name) {\n+    return new PTransform<InT, OutT>(name) {\n+      @Override\n+      public OutT expand(InT input) {\n+        return fn.apply(input);\n+      }\n+    };\n+  }\n+\n+  // Read messages from Pub/Sub Lite. These messages may contain duplicates if the publisher", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NjQwMw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443596403", "bodyText": "Done.", "author": "dpcollins-google", "createdAt": "2020-06-22T14:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2OTk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3MDI3OA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r442970278", "bodyText": "Clarify that the call to addUuids() is assumed to have happened on the publisher side", "author": "dpmills", "createdAt": "2020-06-19T17:45:02Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/PubsubLiteIO.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.Read;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.transforms.SerializableFunction;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.PDone;\n+import org.apache.beam.sdk.values.PInput;\n+import org.apache.beam.sdk.values.POutput;\n+\n+@Experimental\n+public final class PubsubLiteIO {\n+  private PubsubLiteIO() {}\n+\n+  private static <InT extends PInput, OutT extends POutput> PTransform<InT, OutT> toTransform(\n+      SerializableFunction<InT, OutT> fn, String name) {\n+    return new PTransform<InT, OutT>(name) {\n+      @Override\n+      public OutT expand(InT input) {\n+        return fn.apply(input);\n+      }\n+    };\n+  }\n+\n+  // Read messages from Pub/Sub Lite. These messages may contain duplicates if the publisher\n+  // retried, which the PubsubLiteIO write method will do. Use the dedupe transform to remove these\n+  // duplicates.\n+  public static Read.Unbounded<SequencedMessage> read(SubscriberOptions options) {\n+    return Read.from(new PubsubLiteUnboundedSource(options));\n+  }\n+\n+  // Remove duplicates from the PTransform from a read. Assumes by default that the uuids were\n+  // added by a call to PubsubLiteIO.addUuids().", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NjU1NA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443596554", "bodyText": "done.", "author": "dpcollins-google", "createdAt": "2020-06-22T14:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3MDI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4MzYyMA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r442983620", "bodyText": "Here and elsewhere, javadoc for classes at least", "author": "dpmills", "createdAt": "2020-06-19T18:17:14Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/AddUuidsTransform.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.protobuf.ByteString;\n+import org.apache.beam.sdk.transforms.MapElements;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.Reshuffle;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.TypeDescriptor;\n+\n+class AddUuidsTransform extends PTransform<PCollection<Message>, PCollection<Message>> {", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5Njc3MQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443596771", "bodyText": "done.", "author": "dpcollins-google", "createdAt": "2020-06-22T14:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4MzYyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NDM3Nw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r442984377", "bodyText": "What does \"standard transformation methods\" mean? Is this something a user might hit? If so, how would they go about fixing things?", "author": "dpmills", "createdAt": "2020-06-19T18:19:11Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/CloudPubsubTransforms.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.fromCpsPublishTransformer;\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.toCpsPublishTransformer;\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.toCpsSubscribeTransformer;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import com.google.cloud.pubsublite.cloudpubsub.KeyExtractor;\n+import com.google.pubsub.v1.PubsubMessage;\n+import io.grpc.StatusException;\n+import org.apache.beam.sdk.transforms.DoFn;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.values.PCollection;\n+\n+// A class providing transforms between Cloud Pub/Sub and Pub/Sub Lite message types.\n+public final class CloudPubsubTransforms {\n+  private CloudPubsubTransforms() {}\n+\n+  // Transform a collection of SequencedMessages to Cloud Pub/Sub received PubsubMessages.\n+  public static PTransform<PCollection<? extends SequencedMessage>, PCollection<PubsubMessage>>\n+      toCpsSubscribeTransform() {\n+    return ParDo.of(\n+        new DoFn<SequencedMessage, PubsubMessage>() {\n+          @ProcessElement\n+          public void processElement(\n+              @Element SequencedMessage sequencedMessage, OutputReceiver<PubsubMessage> output)\n+              throws StatusException {\n+            output.output(toCpsSubscribeTransformer().transform(sequencedMessage));\n+          }\n+        });\n+  }\n+\n+  // Transform a collection of Cloud Pub/Sub publishable PubsubMessages (ignoring message_id and\n+  // publish_time) to Pub/Sub Lite Messages.\n+  public static PTransform<PCollection<? extends PubsubMessage>, PCollection<Message>>\n+      fromCpsPublishTransform() {\n+    return ParDo.of(\n+        new DoFn<PubsubMessage, Message>() {\n+          @ProcessElement\n+          public void processElement(@Element PubsubMessage message, OutputReceiver<Message> output)\n+              throws StatusException {\n+            output.output(fromCpsPublishTransformer(KeyExtractor.DEFAULT).transform(message));\n+          }\n+        });\n+  }\n+\n+  // Transform a collection of Pub/Sub Lite Messages to publishab Cloud Pub/Sub incomplete,\n+  // publishable\n+  // PubsubMessages.\n+  public static PTransform<PCollection<? extends Message>, PCollection<PubsubMessage>>\n+      toCpsPublishTransform() {\n+    return ParDo.of(\n+        new DoFn<Message, PubsubMessage>() {\n+          @ProcessElement\n+          public void processElement(@Element Message message, OutputReceiver<PubsubMessage> output)\n+              throws StatusException {\n+            output.output(toCpsPublishTransformer().transform(message));\n+          }\n+        });\n+  }\n+\n+  // Ensure that all messages that pass through can be converted to Cloud Pub/Sub messages using the\n+  // standard transformation methods.", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NjkxNw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443596917", "bodyText": "added more info.", "author": "dpcollins-google", "createdAt": "2020-06-22T14:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NDM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyMTg3NQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443021875", "bodyText": "link to deduplicate()", "author": "dpmills", "createdAt": "2020-06-19T20:01:40Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/PubsubLiteIO.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.Read;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.transforms.SerializableFunction;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.PDone;\n+import org.apache.beam.sdk.values.PInput;\n+import org.apache.beam.sdk.values.POutput;\n+\n+@Experimental\n+public final class PubsubLiteIO {\n+  private PubsubLiteIO() {}\n+\n+  private static <InT extends PInput, OutT extends POutput> PTransform<InT, OutT> toTransform(\n+      SerializableFunction<InT, OutT> fn, String name) {\n+    return new PTransform<InT, OutT>(name) {\n+      @Override\n+      public OutT expand(InT input) {\n+        return fn.apply(input);\n+      }\n+    };\n+  }\n+\n+  // Read messages from Pub/Sub Lite. These messages may contain duplicates if the publisher\n+  // retried, which the PubsubLiteIO write method will do. Use the dedupe transform to remove these", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5Njk5MA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443596990", "bodyText": "obsolete.", "author": "dpcollins-google", "createdAt": "2020-06-22T14:25:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyMTg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyMjgzNg==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443022836", "bodyText": "This will result in many small bundles downstream, which may end up being inefficient for the PubsubLiteSink.  It will probably perform better to pick a fixed number of keys to reshuffle on, such as maxNumWorkers*10", "author": "dpmills", "createdAt": "2020-06-19T20:04:38Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/AddUuidsTransform.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.protobuf.ByteString;\n+import org.apache.beam.sdk.transforms.MapElements;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.Reshuffle;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.TypeDescriptor;\n+\n+class AddUuidsTransform extends PTransform<PCollection<Message>, PCollection<Message>> {\n+  private static Message addUuid(Message message) {\n+    ImmutableListMultimap.Builder<String, ByteString> attributesBuilder =\n+        ImmutableListMultimap.builder();\n+    message.attributes().entries().stream()\n+        .filter(entry -> !entry.getKey().equals(Uuid.DEFAULT_ATTRIBUTE))\n+        .forEach(attributesBuilder::put);\n+    attributesBuilder.put(Uuid.DEFAULT_ATTRIBUTE, Uuid.random().value());\n+    return message.toBuilder().setAttributes(attributesBuilder.build()).build();\n+  }\n+\n+  @Override\n+  public PCollection<Message> expand(PCollection<Message> input) {\n+    PCollection<Message> withUuids =\n+        input\n+            .apply(\n+                \"AddUuids\",\n+                MapElements.into(new TypeDescriptor<Message>() {}).via(AddUuidsTransform::addUuid))\n+            .setCoder(new MessageCoder());\n+    return withUuids.apply(\"ShuffleToPersist\", Reshuffle.viaRandomKey());", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3MTkxMg==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443571912", "bodyText": "I think this should instead be a modification to Reshuffle.viaRandomKey(). I'm loathe to write custom behavior because the default implementation does something potentially degenerate. WDYT? Could a 'numBuckets' parameter with a reasonable default value be added to Reshuffle.viaRandomKey?", "author": "dpcollins-google", "createdAt": "2020-06-22T13:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyMjgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwODk3Mg==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443708972", "bodyText": "Adding a customizable numBuckets to Reshuffle.viaRandomKey sounds good to me.  Leave the default behavior as is to avoid breaking current users, though.", "author": "dpmills", "createdAt": "2020-06-22T17:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyMjgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc3OTM3Ng==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443779376", "bodyText": "Done.", "author": "dpcollins-google", "createdAt": "2020-06-22T19:31:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyMjgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc3OTcyNw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443779727", "bodyText": "Done.", "author": "dpcollins-google", "createdAt": "2020-06-22T19:31:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyMjgzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyMzg5Ng==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443023896", "bodyText": "Should message_id be converted to PubsubLite's UUID?", "author": "dpmills", "createdAt": "2020-06-19T20:07:49Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/CloudPubsubTransforms.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.fromCpsPublishTransformer;\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.toCpsPublishTransformer;\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.toCpsSubscribeTransformer;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import com.google.cloud.pubsublite.cloudpubsub.KeyExtractor;\n+import com.google.pubsub.v1.PubsubMessage;\n+import io.grpc.StatusException;\n+import org.apache.beam.sdk.transforms.DoFn;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.values.PCollection;\n+\n+// A class providing transforms between Cloud Pub/Sub and Pub/Sub Lite message types.\n+public final class CloudPubsubTransforms {\n+  private CloudPubsubTransforms() {}\n+\n+  // Transform a collection of SequencedMessages to Cloud Pub/Sub received PubsubMessages.\n+  public static PTransform<PCollection<? extends SequencedMessage>, PCollection<PubsubMessage>>\n+      toCpsSubscribeTransform() {\n+    return ParDo.of(\n+        new DoFn<SequencedMessage, PubsubMessage>() {\n+          @ProcessElement\n+          public void processElement(\n+              @Element SequencedMessage sequencedMessage, OutputReceiver<PubsubMessage> output)\n+              throws StatusException {\n+            output.output(toCpsSubscribeTransformer().transform(sequencedMessage));\n+          }\n+        });\n+  }\n+\n+  // Transform a collection of Cloud Pub/Sub publishable PubsubMessages (ignoring message_id and", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NzEzNA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443597134", "bodyText": "obsolete.", "author": "dpcollins-google", "createdAt": "2020-06-22T14:25:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyMzg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNTUyNA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443025524", "bodyText": "This will cast away the type of the input PCollection, and always return PCollection, which seems like a bad consequence of something that is intended to be a passthrough.  Maybe give this a type param?", "author": "dpmills", "createdAt": "2020-06-19T20:12:48Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/CloudPubsubTransforms.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.fromCpsPublishTransformer;\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.toCpsPublishTransformer;\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.toCpsSubscribeTransformer;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import com.google.cloud.pubsublite.cloudpubsub.KeyExtractor;\n+import com.google.pubsub.v1.PubsubMessage;\n+import io.grpc.StatusException;\n+import org.apache.beam.sdk.transforms.DoFn;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.values.PCollection;\n+\n+// A class providing transforms between Cloud Pub/Sub and Pub/Sub Lite message types.\n+public final class CloudPubsubTransforms {\n+  private CloudPubsubTransforms() {}\n+\n+  // Transform a collection of SequencedMessages to Cloud Pub/Sub received PubsubMessages.\n+  public static PTransform<PCollection<? extends SequencedMessage>, PCollection<PubsubMessage>>\n+      toCpsSubscribeTransform() {\n+    return ParDo.of(\n+        new DoFn<SequencedMessage, PubsubMessage>() {\n+          @ProcessElement\n+          public void processElement(\n+              @Element SequencedMessage sequencedMessage, OutputReceiver<PubsubMessage> output)\n+              throws StatusException {\n+            output.output(toCpsSubscribeTransformer().transform(sequencedMessage));\n+          }\n+        });\n+  }\n+\n+  // Transform a collection of Cloud Pub/Sub publishable PubsubMessages (ignoring message_id and\n+  // publish_time) to Pub/Sub Lite Messages.\n+  public static PTransform<PCollection<? extends PubsubMessage>, PCollection<Message>>\n+      fromCpsPublishTransform() {\n+    return ParDo.of(\n+        new DoFn<PubsubMessage, Message>() {\n+          @ProcessElement\n+          public void processElement(@Element PubsubMessage message, OutputReceiver<Message> output)\n+              throws StatusException {\n+            output.output(fromCpsPublishTransformer(KeyExtractor.DEFAULT).transform(message));\n+          }\n+        });\n+  }\n+\n+  // Transform a collection of Pub/Sub Lite Messages to publishab Cloud Pub/Sub incomplete,\n+  // publishable\n+  // PubsubMessages.\n+  public static PTransform<PCollection<? extends Message>, PCollection<PubsubMessage>>\n+      toCpsPublishTransform() {\n+    return ParDo.of(\n+        new DoFn<Message, PubsubMessage>() {\n+          @ProcessElement\n+          public void processElement(@Element Message message, OutputReceiver<PubsubMessage> output)\n+              throws StatusException {\n+            output.output(toCpsPublishTransformer().transform(message));\n+          }\n+        });\n+  }\n+\n+  // Ensure that all messages that pass through can be converted to Cloud Pub/Sub messages using the\n+  // standard transformation methods.\n+  public static PTransform<PCollection<? extends Message>, PCollection<Message>>", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5OTY5NQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443099695", "bodyText": "I don't know of a way to do this? Can you describe for me what you'd want the function signature to be?", "author": "dpcollins-google", "createdAt": "2020-06-20T04:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNTUyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzEyOQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443027129", "bodyText": "The names of these methods aren't very clear.  I think something like PubsubLiteConversions.sequenceMessageToCloudPubsubMessage would read better.  The distinction between publish and subscribe isn't obvious from the method name anyways, and is probably better in comments.", "author": "dpmills", "createdAt": "2020-06-19T20:17:33Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/CloudPubsubTransforms.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.fromCpsPublishTransformer;\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.toCpsPublishTransformer;\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.toCpsSubscribeTransformer;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import com.google.cloud.pubsublite.cloudpubsub.KeyExtractor;\n+import com.google.pubsub.v1.PubsubMessage;\n+import io.grpc.StatusException;\n+import org.apache.beam.sdk.transforms.DoFn;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.values.PCollection;\n+\n+// A class providing transforms between Cloud Pub/Sub and Pub/Sub Lite message types.\n+public final class CloudPubsubTransforms {\n+  private CloudPubsubTransforms() {}\n+\n+  // Transform a collection of SequencedMessages to Cloud Pub/Sub received PubsubMessages.\n+  public static PTransform<PCollection<? extends SequencedMessage>, PCollection<PubsubMessage>>\n+      toCpsSubscribeTransform() {", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5ODgzNQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443098835", "bodyText": "Will drop this method.", "author": "dpcollins-google", "createdAt": "2020-06-20T04:00:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzYwOQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443027609", "bodyText": "Provide more information about when these should be used.\nDo we expect it to be a common use case for pipelines to be using both Cloud Pub/Sub and Pub/Sub Lite? We might not need these as part of Beam.", "author": "dpmills", "createdAt": "2020-06-19T20:18:59Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/CloudPubsubTransforms.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.fromCpsPublishTransformer;\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.toCpsPublishTransformer;\n+import static com.google.cloud.pubsublite.cloudpubsub.MessageTransforms.toCpsSubscribeTransformer;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import com.google.cloud.pubsublite.cloudpubsub.KeyExtractor;\n+import com.google.pubsub.v1.PubsubMessage;\n+import io.grpc.StatusException;\n+import org.apache.beam.sdk.transforms.DoFn;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.values.PCollection;\n+\n+// A class providing transforms between Cloud Pub/Sub and Pub/Sub Lite message types.", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5ODg4MA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443098880", "bodyText": "Probably not, in any case they wouldn't use the proto PubsubMessage but the beam one. I'm removing most of the functions here.", "author": "dpcollins-google", "createdAt": "2020-06-20T04:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NzQxOQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443597419", "bodyText": "removed all but the check. done.", "author": "dpcollins-google", "createdAt": "2020-06-22T14:25:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyOTU5Ng==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443029596", "bodyText": "This is an awkward way for the user to configure the deduplication.  If you want to be future proof it's ok to still have this option, but provide a helper so the user only has to pass the time domain and duration", "author": "dpmills", "createdAt": "2020-06-19T20:24:37Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/UuidDeduplicationOptions.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import static com.google.cloud.pubsublite.internal.Preconditions.checkArgument;\n+\n+import com.google.auto.value.AutoValue;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import com.google.protobuf.ByteString;\n+import java.io.Serializable;\n+import java.util.List;\n+import org.apache.beam.sdk.state.TimeDomain;\n+import org.apache.beam.sdk.transforms.Deduplicate;\n+\n+@AutoValue\n+public abstract class UuidDeduplicationOptions implements Serializable {\n+  private static final long serialVersionUID = 9837489720893L;\n+\n+  public static final SerializableStatusFunction<SequencedMessage, Uuid> DEFAULT_UUID_EXTRACTOR =\n+      message -> {\n+        checkArgument(\n+            message.message().attributes().containsKey(Uuid.DEFAULT_ATTRIBUTE),\n+            \"Uuid attribute missing.\");\n+        List<ByteString> attributes =\n+            message.message().attributes().get(Uuid.DEFAULT_ATTRIBUTE);\n+        checkArgument(attributes.size() == 1, \"Duplicate Uuid attribute values exist.\");\n+        return Uuid.of(attributes.get(0));\n+      };\n+\n+  public static final int DEFAULT_HASH_PARTITIONS = 10000;\n+\n+  // All parameters are optional.\n+  public abstract SerializableStatusFunction<SequencedMessage, Uuid> uuidExtractor();\n+\n+  public abstract Deduplicate.KeyedValues<Uuid, SequencedMessage> deduplicate();\n+\n+  // The number of partitions to hash values into.\n+  public abstract int hashPartitions();\n+\n+  @SuppressWarnings(\"CheckReturnValue\")\n+  public static Builder newBuilder() {\n+    Builder builder = new AutoValue_UuidDeduplicationOptions.Builder();\n+    builder.setUuidExtractor(DEFAULT_UUID_EXTRACTOR);\n+    builder.setDeduplicate(\n+        Deduplicate.<Uuid, SequencedMessage>keyedValues().withTimeDomain(TimeDomain.EVENT_TIME));\n+    builder.setHashPartitions(DEFAULT_HASH_PARTITIONS);\n+    return builder;\n+  }\n+\n+  @AutoValue.Builder\n+  public abstract static class Builder {\n+    public abstract Builder setUuidExtractor(\n+        SerializableStatusFunction<SequencedMessage, Uuid> uuidExtractor);\n+\n+    public abstract Builder setDeduplicate(\n+        Deduplicate.KeyedValues<Uuid, SequencedMessage> deduplicate);", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3NDY4OA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443574688", "bodyText": "I don't really agree with you here. I think Deduplicate already provides a fluent interface for constructing a transform and knows all its properties. I think it mostly seems strange because the builder is wrapped up in the transform itself: if this was DeduplicateKeyedValuesOptions<Uuid, SequencedMessage>, that had a method toTransform(), I don't think it would seem awkward.\nI can add this, just think it would be duplicated code for no real gain.", "author": "dpcollins-google", "createdAt": "2020-06-22T13:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyOTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyMDg1MA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443720850", "bodyText": "Yeah, it's the wrapping into a tranform that I don't like.  I'm fine with leaving this as is if you add an example as I mentioned in a comment above", "author": "dpmills", "createdAt": "2020-06-22T17:36:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyOTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc3OTI0Mg==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443779242", "bodyText": "Done.", "author": "dpcollins-google", "createdAt": "2020-06-22T19:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyOTU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDU1Ng==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443030556", "bodyText": "Registering a coder as part of expand is weird, and will be confusing if the user uses these types elsewhere in the pipeline.  You can instead use the @defaultcoder annotation on Uuid and SequencedMessage to set their default coders globally.", "author": "dpmills", "createdAt": "2020-06-19T20:27:24Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/UuidDeduplicationTransform.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import java.math.BigInteger;\n+import org.apache.beam.sdk.transforms.MapElements;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.transforms.ProcessFunction;\n+import org.apache.beam.sdk.transforms.Values;\n+import org.apache.beam.sdk.values.KV;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.TypeDescriptor;\n+\n+class UuidDeduplicationTransform\n+    extends PTransform<PCollection<SequencedMessage>, PCollection<SequencedMessage>> {\n+  private final UuidDeduplicationOptions options;\n+\n+  UuidDeduplicationTransform(UuidDeduplicationOptions options) {\n+    this.options = options;\n+  }\n+\n+  @Override\n+  public PCollection<SequencedMessage> expand(PCollection<SequencedMessage> input) {\n+    input.getPipeline().getCoderRegistry().registerCoderForClass(Uuid.class, Uuid.getCoder());", "originalCommit": "a6ee4b3fa536f480075c4b619076864a23ad127f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA1MDc2Mw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443050763", "bodyText": "Uuid and SequencedMessage are part of the Pub/Sub Lite client library, not beam. Is there a way to register a default coder somewhere not in the type definition?", "author": "dpcollins-google", "createdAt": "2020-06-19T21:29:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA1MDkzNg==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443050936", "bodyText": "ah sorry, thatts only true of SequencedMessage. Will make this change for Uuid.", "author": "dpcollins-google", "createdAt": "2020-06-19T21:29:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5ODAzMA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443598030", "bodyText": "done for uuid, is there a way to set this globally on the SequencedMessage type that comes from the Pub/Sub Lite java client library?", "author": "dpcollins-google", "createdAt": "2020-06-22T14:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyMzU5OA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443723598", "bodyText": "Yeah, you can create a CoderProviderRegistrar.  There's an example from another IO solving the same problem here: https://github.com/apache/beam/blob/master/sdks/java/io/hbase/src/main/java/org/apache/beam/sdk/io/hbase/HBaseCoderProviderRegistrar.java\nIn that provider, add default coders for SequencedMessage and Message\nAlso, remove the registerCoderForClass calls here", "author": "dpmills", "createdAt": "2020-06-22T17:41:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NTgwNw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443755807", "bodyText": "Done.", "author": "dpcollins-google", "createdAt": "2020-06-22T18:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDU1Ng=="}], "type": "inlineReview"}, {"oid": "ed381889c4e177c9dffa427c52f946ffe4c28252", "url": "https://github.com/apache/beam/commit/ed381889c4e177c9dffa427c52f946ffe4c28252", "message": "Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.\n\nAlso adapt to beam conventions and restrictions.", "committedDate": "2020-06-04T14:54:32Z", "type": "forcePushed"}, {"oid": "bef2df8e99b05d210672b0f9baedc3d7123cd87e", "url": "https://github.com/apache/beam/commit/bef2df8e99b05d210672b0f9baedc3d7123cd87e", "message": "Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.\n\nAlso adapt to beam conventions and restrictions.", "committedDate": "2020-06-04T14:54:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxMTA4NA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443711084", "bodyText": "This is the only caller of toTransform now; I think it would be more readable to just inline that logic here", "author": "dpmills", "createdAt": "2020-06-22T17:17:50Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/PubsubLiteIO.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.Read;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.transforms.SerializableFunction;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.PDone;\n+import org.apache.beam.sdk.values.PInput;\n+import org.apache.beam.sdk.values.POutput;\n+\n+@Experimental\n+public final class PubsubLiteIO {\n+  private PubsubLiteIO() {}\n+\n+  private static <InT extends PInput, OutT extends POutput> PTransform<InT, OutT> toTransform(\n+      SerializableFunction<InT, OutT> fn, String name) {\n+    return new PTransform<InT, OutT>(name) {\n+      @Override\n+      public OutT expand(InT input) {\n+        return fn.apply(input);\n+      }\n+    };\n+  }\n+\n+  /**\n+   * Read messages from Pub/Sub Lite. These messages may contain duplicates if the publisher\n+   * retried, which the PubsubLiteIO write method will do. Use the dedupe transform to remove these\n+   * duplicates.\n+   */\n+  public static Read.Unbounded<SequencedMessage> read(SubscriberOptions options) {\n+    return Read.from(new PubsubLiteUnboundedSource(options));\n+  }\n+\n+  /**\n+   * Remove duplicates from the PTransform from a read. Assumes by default that the uuids were added\n+   * by a call to PubsubLiteIO.addUuids() when published.\n+   */\n+  public static PTransform<PCollection<SequencedMessage>, PCollection<SequencedMessage>>\n+      deduplicate(UuidDeduplicationOptions options) {\n+    return new UuidDeduplicationTransform(options);\n+  }\n+\n+  /** Add Uuids to to-be-published messages that ensures that uniqueness is maintained. */\n+  public static PTransform<PCollection<Message>, PCollection<Message>> addUuids() {\n+    return new AddUuidsTransform();\n+  }\n+\n+  /** Write messages to Pub/Sub Lite. */\n+  public static PTransform<PCollection<Message>, PDone> write(PublisherOptions options) {\n+    return toTransform(", "originalCommit": "bef2df8e99b05d210672b0f9baedc3d7123cd87e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc3ODczNQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443778735", "bodyText": "Done.", "author": "dpcollins-google", "createdAt": "2020-06-22T19:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxMTA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyMTk5OQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443721999", "bodyText": "For each of the main entrypoint functions here, please add examples of calling them to the javadoc.", "author": "dpmills", "createdAt": "2020-06-22T17:38:28Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/PubsubLiteIO.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import com.google.cloud.pubsublite.Message;\n+import com.google.cloud.pubsublite.SequencedMessage;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.Read;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.transforms.SerializableFunction;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.PDone;\n+import org.apache.beam.sdk.values.PInput;\n+import org.apache.beam.sdk.values.POutput;\n+\n+@Experimental\n+public final class PubsubLiteIO {\n+  private PubsubLiteIO() {}\n+\n+  private static <InT extends PInput, OutT extends POutput> PTransform<InT, OutT> toTransform(\n+      SerializableFunction<InT, OutT> fn, String name) {\n+    return new PTransform<InT, OutT>(name) {\n+      @Override\n+      public OutT expand(InT input) {\n+        return fn.apply(input);\n+      }\n+    };\n+  }\n+\n+  /**\n+   * Read messages from Pub/Sub Lite. These messages may contain duplicates if the publisher\n+   * retried, which the PubsubLiteIO write method will do. Use the dedupe transform to remove these\n+   * duplicates.\n+   */", "originalCommit": "bef2df8e99b05d210672b0f9baedc3d7123cd87e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc3ODgyOQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r443778829", "bodyText": "Done.", "author": "dpcollins-google", "createdAt": "2020-06-22T19:29:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyMTk5OQ=="}], "type": "inlineReview"}, {"oid": "fe4bcca94bd9837055ba1c001ea935357b29bc9e", "url": "https://github.com/apache/beam/commit/fe4bcca94bd9837055ba1c001ea935357b29bc9e", "message": "Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.\n\nAlso adapt to beam conventions and restrictions.", "committedDate": "2020-06-04T14:54:32Z", "type": "forcePushed"}, {"oid": "02f165e1061a9996d618c297b031af2ca27cdb91", "url": "https://github.com/apache/beam/commit/02f165e1061a9996d618c297b031af2ca27cdb91", "message": "Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.\n\nAlso adapt to beam conventions and restrictions.", "committedDate": "2020-06-04T14:54:32Z", "type": "forcePushed"}, {"oid": "1b0caecb34b3114898e4ef819918bc888f0ac990", "url": "https://github.com/apache/beam/commit/1b0caecb34b3114898e4ef819918bc888f0ac990", "message": "Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.\n\nAlso adapt to beam conventions and restrictions.", "committedDate": "2020-06-04T14:54:32Z", "type": "forcePushed"}, {"oid": "35d1d18c32e6ebcc8ffdc6e90b782b499a3b8fa1", "url": "https://github.com/apache/beam/commit/35d1d18c32e6ebcc8ffdc6e90b782b499a3b8fa1", "message": "Copy Pub/Sub Lite IO from Pub/Sub Lite github to beam.\n\nAlso adapt to beam conventions and restrictions.", "committedDate": "2020-06-04T14:54:32Z", "type": "forcePushed"}, {"oid": "0498102f88fc12318dd352c9c361f6db7d3bd155", "url": "https://github.com/apache/beam/commit/0498102f88fc12318dd352c9c361f6db7d3bd155", "message": "Restructure IO to expose proto types instead of client library wrapper types, as the wrapper types expose guava in the api surface.", "committedDate": "2020-06-27T22:35:18Z", "type": "commit"}, {"oid": "de5140f56af2efeb9a815abb7c611c59eb29d19f", "url": "https://github.com/apache/beam/commit/de5140f56af2efeb9a815abb7c611c59eb29d19f", "message": "Restructure IO to expose proto types instead of client library wrapper types, as the wrapper types expose guava in the api surface.", "committedDate": "2020-06-27T22:35:18Z", "type": "forcePushed"}, {"oid": "19fa0f3d69096cf403b77bfdeaf202a6027d6647", "url": "https://github.com/apache/beam/commit/19fa0f3d69096cf403b77bfdeaf202a6027d6647", "message": "Restructure IO to expose proto types instead of client library wrapper types, as the wrapper types expose guava in the api surface.", "committedDate": "2020-06-27T22:35:18Z", "type": "forcePushed"}, {"oid": "657348046ef28da217f597c8f93ff41d9a97ffba", "url": "https://github.com/apache/beam/commit/657348046ef28da217f597c8f93ff41d9a97ffba", "message": "Restructure IO to expose proto types instead of client library wrapper types, as the wrapper types expose guava in the api surface.", "committedDate": "2020-06-27T22:35:18Z", "type": "forcePushed"}, {"oid": "05ec4749645b259d83a4f831ddde31ef4850e36c", "url": "https://github.com/apache/beam/commit/05ec4749645b259d83a4f831ddde31ef4850e36c", "message": "Restructure IO to expose proto types instead of client library wrapper types, as the wrapper types expose guava in the api surface.", "committedDate": "2020-06-27T22:35:18Z", "type": "forcePushed"}, {"oid": "eac451f9716173a0a2b11af41dfe7bb9542d12f1", "url": "https://github.com/apache/beam/commit/eac451f9716173a0a2b11af41dfe7bb9542d12f1", "message": "Restructure IO to expose proto types instead of client library wrapper types, as the wrapper types expose guava in the api surface.", "committedDate": "2020-06-27T22:35:18Z", "type": "forcePushed"}, {"oid": "dba6edfa09d85127322f79a71903521b293722e3", "url": "https://github.com/apache/beam/commit/dba6edfa09d85127322f79a71903521b293722e3", "message": "Restructure IO to expose proto types instead of client library wrapper types, as the wrapper types expose guava in the api surface.", "committedDate": "2020-06-27T22:35:18Z", "type": "forcePushed"}, {"oid": "24cf3af864cac20f57fe38ec192ad4a194b17165", "url": "https://github.com/apache/beam/commit/24cf3af864cac20f57fe38ec192ad4a194b17165", "message": "Restructure IO to expose proto types instead of client library wrapper types, as the wrapper types expose guava in the api surface.", "committedDate": "2020-06-27T22:35:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0Mjg1Ng==", "url": "https://github.com/apache/beam/pull/11919#discussion_r452642856", "bodyText": "Could you send the update to core as a separate PR ?", "author": "chamikaramj", "createdAt": "2020-07-10T06:16:47Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/Reshuffle.java", "diffHunk": "@@ -109,16 +110,33 @@ public void processElement(\n   public static class ViaRandomKey<T> extends PTransform<PCollection<T>, PCollection<T>> {\n     private ViaRandomKey() {}\n \n+    private ViaRandomKey(@Nullable Integer numBuckets) {\n+      this.numBuckets = numBuckets;\n+    }\n+", "originalCommit": "24cf3af864cac20f57fe38ec192ad4a194b17165", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY0NTM1Nw==", "url": "https://github.com/apache/beam/pull/11919#discussion_r453645357", "bodyText": "These are only minor changes to the transform and this is the only file not directly related to pubsub lite io that is changed. Given the high latency on merging beam PRs and the fact that this change was proposed in this pr (see millsd@ comments above), I'd prefer not to.", "author": "dpcollins-google", "createdAt": "2020-07-13T13:23:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0Mjg1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1MDM5OQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r452650399", "bodyText": "Did you run into an issue when using existing Reshuffle implementation ?", "author": "chamikaramj", "createdAt": "2020-07-10T06:39:43Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/Reshuffle.java", "diffHunk": "@@ -109,16 +110,33 @@ public void processElement(\n   public static class ViaRandomKey<T> extends PTransform<PCollection<T>, PCollection<T>> {\n     private ViaRandomKey() {}\n \n+    private ViaRandomKey(@Nullable Integer numBuckets) {\n+      this.numBuckets = numBuckets;\n+    }\n+\n+    // The number of buckets to shard into. This is a performance optimization to prevent having\n+    // unit sized bundles on the output. If unset, uses a random integer key.\n+    private @Nullable Integer numBuckets;\n+\n+    public ViaRandomKey<T> withNumBuckets(@Nullable Integer numBuckets) {", "originalCommit": "24cf3af864cac20f57fe38ec192ad4a194b17165", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzNzk2NQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r453637965", "bodyText": "It was suggested by millsd@ above in this pr that it would have degenerate performance and lead to single key bundles, so he suggested I rewrite it like this.", "author": "dpcollins-google", "createdAt": "2020-07-13T13:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1MDM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1MTYwMA==", "url": "https://github.com/apache/beam/pull/11919#discussion_r452651600", "bodyText": "Please add a link to a Website that describes Pub/Sub Lite and briefly describe the difference between this and the Pub/Sub connector.", "author": "chamikaramj", "createdAt": "2020-07-10T06:42:59Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/PubsubLiteIO.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import com.google.cloud.pubsublite.proto.PubSubMessage;\n+import com.google.cloud.pubsublite.proto.SequencedMessage;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.Read;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.ParDo;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.PDone;\n+\n+@Experimental\n+public final class PubsubLiteIO {\n+  private PubsubLiteIO() {}\n+\n+  /**\n+   * Read messages from Pub/Sub Lite. These messages may contain duplicates if the publisher", "originalCommit": "24cf3af864cac20f57fe38ec192ad4a194b17165", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1NTc4Mg==", "url": "https://github.com/apache/beam/pull/11919#discussion_r453655782", "bodyText": "Done.", "author": "dpcollins-google", "createdAt": "2020-07-13T13:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1MTYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1MjU2Ng==", "url": "https://github.com/apache/beam/pull/11919#discussion_r452652566", "bodyText": "Are you hoping to add integration tests for source and sink in a follow up CL ?", "author": "chamikaramj", "createdAt": "2020-07-10T06:45:40Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/pubsublite/PubsubLiteUnboundedReaderTest.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,", "originalCommit": "24cf3af864cac20f57fe38ec192ad4a194b17165", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzOTg3MQ==", "url": "https://github.com/apache/beam/pull/11919#discussion_r453639871", "bodyText": "end to end integration tests, performance testing and other blockers for marking this as fully supported are WIP, they require a bunch more work.", "author": "dpcollins-google", "createdAt": "2020-07-13T13:14:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1MjU2Ng=="}], "type": "inlineReview"}, {"oid": "d15f50a83ff2c58e159b0429983d3c5c9d1574eb", "url": "https://github.com/apache/beam/commit/d15f50a83ff2c58e159b0429983d3c5c9d1574eb", "message": "Restructure IO to expose proto types instead of client library wrapper types, as the wrapper types expose guava in the api surface.", "committedDate": "2020-06-27T22:35:18Z", "type": "forcePushed"}, {"oid": "0498102f88fc12318dd352c9c361f6db7d3bd155", "url": "https://github.com/apache/beam/commit/0498102f88fc12318dd352c9c361f6db7d3bd155", "message": "Restructure IO to expose proto types instead of client library wrapper types, as the wrapper types expose guava in the api surface.", "committedDate": "2020-06-27T22:35:18Z", "type": "forcePushed"}]}