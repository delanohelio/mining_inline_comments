{"pr_number": 11492, "pr_title": "[BEAM-9801] Pass in fire timestamp to timer callback", "pr_createdAt": "2020-04-22T15:19:38Z", "pr_url": "https://github.com/apache/beam/pull/11492", "timeline": [{"oid": "9961394d4e25c8c3dd1ed5e59983b9a238664957", "url": "https://github.com/apache/beam/commit/9961394d4e25c8c3dd1ed5e59983b9a238664957", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-22T19:41:13Z", "type": "forcePushed"}, {"oid": "1134a70919e65f3af4a939da76750ac416d0eab3", "url": "https://github.com/apache/beam/commit/1134a70919e65f3af4a939da76750ac416d0eab3", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-23T10:35:57Z", "type": "forcePushed"}, {"oid": "ef32a4d84c4c6c5c936c20a7cbb32257a276ebd8", "url": "https://github.com/apache/beam/commit/ef32a4d84c4c6c5c936c20a7cbb32257a276ebd8", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-23T14:04:32Z", "type": "forcePushed"}, {"oid": "109d1f1c1a230c4a8ff62d25d228a9bbea8d5aec", "url": "https://github.com/apache/beam/commit/109d1f1c1a230c4a8ff62d25d228a9bbea8d5aec", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-23T14:26:55Z", "type": "forcePushed"}, {"oid": "10f217fb8adf21e54d5f7b2641bb8d0568372f9e", "url": "https://github.com/apache/beam/commit/10f217fb8adf21e54d5f7b2641bb8d0568372f9e", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-23T16:30:39Z", "type": "forcePushed"}, {"oid": "0294cc5a36e98cc9f38be659233667051935ddac", "url": "https://github.com/apache/beam/commit/0294cc5a36e98cc9f38be659233667051935ddac", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-24T10:33:42Z", "type": "forcePushed"}, {"oid": "7ac3e0acf3d9693aff261e13830219aae837005a", "url": "https://github.com/apache/beam/commit/7ac3e0acf3d9693aff261e13830219aae837005a", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-25T12:12:48Z", "type": "forcePushed"}, {"oid": "c986a53b88cba891c64d320a2ef2cf497868001f", "url": "https://github.com/apache/beam/commit/c986a53b88cba891c64d320a2ef2cf497868001f", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-29T10:40:15Z", "type": "forcePushed"}, {"oid": "07fb5aad4d7b697b39d49e82b40372def75b6ccf", "url": "https://github.com/apache/beam/commit/07fb5aad4d7b697b39d49e82b40372def75b6ccf", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-29T11:03:21Z", "type": "forcePushed"}, {"oid": "f656ad0ba5f1a6f0ba345071b3244c69714ed752", "url": "https://github.com/apache/beam/commit/f656ad0ba5f1a6f0ba345071b3244c69714ed752", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-30T09:31:56Z", "type": "forcePushed"}, {"oid": "3cfc993ad47f14bcca0aecb2201c3a085fef4b1f", "url": "https://github.com/apache/beam/commit/3cfc993ad47f14bcca0aecb2201c3a085fef4b1f", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-30T14:22:46Z", "type": "forcePushed"}, {"oid": "3a042b69a8bd97f322a674ac3753a09938648919", "url": "https://github.com/apache/beam/commit/3a042b69a8bd97f322a674ac3753a09938648919", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-30T14:25:12Z", "type": "commit"}, {"oid": "dc8f17e7b18eab520dd5edff48b7c5c4eb385d31", "url": "https://github.com/apache/beam/commit/dc8f17e7b18eab520dd5edff48b7c5c4eb385d31", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-30T14:25:12Z", "type": "commit"}, {"oid": "dc8f17e7b18eab520dd5edff48b7c5c4eb385d31", "url": "https://github.com/apache/beam/commit/dc8f17e7b18eab520dd5edff48b7c5c4eb385d31", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-30T14:25:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODc0MA==", "url": "https://github.com/apache/beam/pull/11492#discussion_r418778740", "bodyText": "It makes sense to do this in batch as well since the processing timers should get dropped and any newly scheduled event time timers should be continually fired.\nThis would require updating FlinkExecutableStageFunction and SparkExecutableStageFunction", "author": "lukecwik", "createdAt": "2020-05-01T23:31:44Z", "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/functions/FlinkExecutableStageFunction.java", "diffHunk": "@@ -247,25 +247,27 @@ public void reduce(Iterable<WindowedValue<InputT>> iterable, Collector<RawUnionV\n     timerInternals.advanceSynchronizedProcessingTime(BoundedWindow.TIMESTAMP_MAX_VALUE);\n \n     // Now we fire the timers and process elements generated by timers (which may be timers itself)\n-    try (RemoteBundle bundle =\n-        stageBundleFactory.getBundle(\n-            receiverFactory, timerReceiverFactory, stateRequestHandler, progressHandler)) {\n-\n-      PipelineTranslatorUtils.fireEligibleTimers(\n-          timerInternals,\n-          (KV<String, String> transformAndTimerId, Timer<?> timerValue) -> {\n-            FnDataReceiver<Timer> fnTimerReceiver =\n-                bundle.getTimerReceivers().get(transformAndTimerId);\n-            Preconditions.checkNotNull(\n-                fnTimerReceiver, \"No FnDataReceiver found for %s\", transformAndTimerId);\n-            try {\n-              fnTimerReceiver.accept(timerValue);\n-            } catch (Exception e) {\n-              throw new RuntimeException(\n-                  String.format(Locale.ENGLISH, \"Failed to process timer: %s\", timerValue));\n-            }\n-          },\n-          currentTimerKey);\n+    while (timerInternals.hasPendingTimers()) {", "originalCommit": "dc8f17e7b18eab520dd5edff48b7c5c4eb385d31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODgyOA==", "url": "https://github.com/apache/beam/pull/11492#discussion_r418778828", "bodyText": "Also, I made this same comment earlier today and it was lost somehow.", "author": "lukecwik", "createdAt": "2020-05-01T23:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc4MDU3Mw==", "url": "https://github.com/apache/beam/pull/11492#discussion_r418780573", "bodyText": "Agree that this should apply to Spark runner too. To clarify, FlinkExecutableStageFunction is for batch only, meaning this change only affected Flink batch. I assume Flink streaming (ExecutableStageDoFnOperator) was working from the start.", "author": "ibzib", "createdAt": "2020-05-01T23:41:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgxMzM2OQ==", "url": "https://github.com/apache/beam/pull/11492#discussion_r418813369", "bodyText": "Made #11595 to update Spark.", "author": "ibzib", "createdAt": "2020-05-02T01:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0MzYxMg==", "url": "https://github.com/apache/beam/pull/11492#discussion_r418943612", "bodyText": "Yes, this is a batch-only change (also evident in the commit message). The streaming operator already does that.\n\nprocessing timers should get dropped and any newly scheduled event time timers should be continually fired.\n\nWe do not drop processing timers. We fire all timers, including new ones, until there are none left.", "author": "mxm", "createdAt": "2020-05-02T10:52:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODc0MA=="}], "type": "inlineReview"}]}