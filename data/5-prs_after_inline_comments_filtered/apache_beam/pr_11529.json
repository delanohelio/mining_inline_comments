{"pr_number": 11529, "pr_title": "[BEAM-9822] Simplify pipeline when batching is disabled.", "pr_createdAt": "2020-04-26T16:33:19Z", "pr_url": "https://github.com/apache/beam/pull/11529", "timeline": [{"oid": "4bde0787b5c5ae438c7b450634fa539158f4b4d5", "url": "https://github.com/apache/beam/commit/4bde0787b5c5ae438c7b450634fa539158f4b4d5", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation.", "committedDate": "2020-04-27T07:59:16Z", "type": "forcePushed"}, {"oid": "f133b406f15c49b2e9c8f03b0ed41b3728d53d43", "url": "https://github.com/apache/beam/commit/f133b406f15c49b2e9c8f03b0ed41b3728d53d43", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation.", "committedDate": "2020-04-27T13:34:03Z", "type": "forcePushed"}, {"oid": "5d7dda43b64fd4d631674337ec9e73c4e8a808e2", "url": "https://github.com/apache/beam/commit/5d7dda43b64fd4d631674337ec9e73c4e8a808e2", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation.", "committedDate": "2020-04-27T14:02:36Z", "type": "forcePushed"}, {"oid": "40316593c05b84598c88a2d40aa4101e86b8421f", "url": "https://github.com/apache/beam/commit/40316593c05b84598c88a2d40aa4101e86b8421f", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation.", "committedDate": "2020-05-01T11:23:42Z", "type": "forcePushed"}, {"oid": "29559733904d041af7b7dcdc9ecbe8f3e64c9385", "url": "https://github.com/apache/beam/commit/29559733904d041af7b7dcdc9ecbe8f3e64c9385", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation.", "committedDate": "2020-05-18T22:50:33Z", "type": "forcePushed"}, {"oid": "718884b96e5a0f20512592b7cc24e454131c8144", "url": "https://github.com/apache/beam/commit/718884b96e5a0f20512592b7cc24e454131c8144", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation.", "committedDate": "2020-05-18T23:43:10Z", "type": "forcePushed"}, {"oid": "d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "url": "https://github.com/apache/beam/commit/d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies.", "committedDate": "2020-05-19T11:06:54Z", "type": "commit"}, {"oid": "ade11d9035e76d145457e7125809ea5f5206be54", "url": "https://github.com/apache/beam/commit/ade11d9035e76d145457e7125809ea5f5206be54", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation.", "committedDate": "2020-05-19T11:14:51Z", "type": "commit"}, {"oid": "ade11d9035e76d145457e7125809ea5f5206be54", "url": "https://github.com/apache/beam/commit/ade11d9035e76d145457e7125809ea5f5206be54", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation.", "committedDate": "2020-05-19T11:14:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3Njk4NQ==", "url": "https://github.com/apache/beam/pull/11529#discussion_r427576985", "bodyText": "This doesn't seem to be used. It seems we should either:\n\nPass fakeServiceFactory to withServiceFactory and the verify calls below, or\nJust remove fakeServiceFactory and use serviceFactory here instead. It seems to be capable of verifying that the schema isn't read, so I'm not sure there's value in building another fake that doesn't have a schema.\n\nI'd prefer the latter, but I'd be fine with the former if you think that's better.", "author": "TheNeuralBit", "createdAt": "2020-05-19T20:23:08Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/spanner/SpannerIOWriteTest.java", "diffHunk": "@@ -263,6 +263,17 @@ private void verifyBatches(Iterable<Mutation>... batches) {\n \n   @Test\n   public void noBatching() throws Exception {\n+\n+    // This test uses a different mock/fake because it explicitly does not want to populate the\n+    // Spanner schema.\n+    FakeServiceFactory fakeServiceFactory = new FakeServiceFactory();\n+    ReadOnlyTransaction tx = mock(ReadOnlyTransaction.class);\n+    when(fakeServiceFactory.mockDatabaseClient().readOnlyTransaction()).thenReturn(tx);\n+\n+    // Capture batches sent to writeAtLeastOnce.\n+    when(fakeServiceFactory.mockDatabaseClient().writeAtLeastOnce(mutationBatchesCaptor.capture()))\n+        .thenReturn(null);\n+", "originalCommit": "ade11d9035e76d145457e7125809ea5f5206be54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MDc5NQ==", "url": "https://github.com/apache/beam/pull/11529#discussion_r427580795", "bodyText": "Actually on second thought I wonder if we should just leave this test completely unchanged (i.e. call verifyBatches, don't check that the DB schema is never read). The fact the schema isn't read seems like an implementation detail that we don't need to explicitly verify. What do you think?", "author": "TheNeuralBit", "createdAt": "2020-05-19T20:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3Njk4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzNTU2Mw==", "url": "https://github.com/apache/beam/pull/11529#discussion_r428235563", "bodyText": "This test specifically tests that the pipeline stage for reading the schema (required for grouping/batching) are not being used, verifying that the batching is being bypassed. Yes, this is an implementation detail, but I added this part of the test so that future changes do not break this behaviour.\nI cannot use the already-created serviceFactory here because that does not give me access to the mock ReadOnlyTransaction that I need to verify that executeQuery() is never called.", "author": "nielm", "createdAt": "2020-05-20T18:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3Njk4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzNzkwNA==", "url": "https://github.com/apache/beam/pull/11529#discussion_r428237904", "bodyText": "Ah I see. But should you be using fakeServiceFactory throughout this test then? There are still references to serviceFactory", "author": "TheNeuralBit", "createdAt": "2020-05-20T18:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3Njk4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI0NjgyMA==", "url": "https://github.com/apache/beam/pull/11529#discussion_r428246820", "bodyText": "Oops, yes, correct. Fixed now.\n\nAh I see. But should you be using fakeServiceFactory throughout this test then? There are still references to serviceFactory\n\nOops, yes, correct! Fixed now.", "author": "nielm", "createdAt": "2020-05-20T19:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3Njk4NQ=="}], "type": "inlineReview"}, {"oid": "9ffe54998873645adf6d31f407b76d9f0c8b378e", "url": "https://github.com/apache/beam/commit/9ffe54998873645adf6d31f407b76d9f0c8b378e", "message": "Fix noBatching test", "committedDate": "2020-05-20T19:07:12Z", "type": "commit"}]}