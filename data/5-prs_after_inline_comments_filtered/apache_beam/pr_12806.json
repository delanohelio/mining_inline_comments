{"pr_number": 12806, "pr_title": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "pr_createdAt": "2020-09-10T04:05:44Z", "pr_url": "https://github.com/apache/beam/pull/12806", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0OTU1OQ==", "url": "https://github.com/apache/beam/pull/12806#discussion_r486549559", "bodyText": "Won't this break pipeline update?\nAlso, the implementation only uses the payload so I don't think we need the TODO since we don't use any of the other attributes from the message so we can leave a comment here stating instead that the unbounded sink only uses the payload of the pubsub message.", "author": "lukecwik", "createdAt": "2020-09-10T18:26:59Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsub/PubsubIO.java", "diffHunk": "@@ -1012,6 +1012,8 @@ public PDone expand(PCollection<T> input) {\n         case UNBOUNDED:\n           return input\n               .apply(MapElements.into(new TypeDescriptor<PubsubMessage>() {}).via(getFormatFn()))\n+              // TODO(BEAM-10869): Also plump through PubsubMessageWithAttributesCoder if needed.\n+              .setCoder(PubsubMessagePayloadOnlyCoder.of())", "originalCommit": "c9490a614bbe4a5418a23b65025bb27e043501a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNTk5Ng==", "url": "https://github.com/apache/beam/pull/12806#discussion_r486605996", "bodyText": "That's a good point. We can have it guard with \"beam_fn_api\" and \"use_runner_v2\".\nIt seems like given Cham work here: #12760, we just need to send PubsubMessage.data as bytes for portable dataflow.", "author": "boyuanzz", "createdAt": "2020-09-10T20:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0OTU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMxMDE3Ng==", "url": "https://github.com/apache/beam/pull/12806#discussion_r487310176", "bodyText": "I misunderstood what PR12760 does. Can you explain more about \"we don't use any of the other attributes from the message\"? It seems like both PubsubMessage in python and java contain 'attribute' map.", "author": "boyuanzz", "createdAt": "2020-09-11T22:02:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0OTU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwODU1MA==", "url": "https://github.com/apache/beam/pull/12806#discussion_r488208550", "bodyText": "PubsubUnboundedSink only consumes the data blob and sets the other attributes using properties from the element (e.g. timestamp).", "author": "lukecwik", "createdAt": "2020-09-14T20:43:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0OTU1OQ=="}], "type": "inlineReview"}, {"oid": "89f4beb36bd8b01747cdefbee1ceb7315f0a7bd9", "url": "https://github.com/apache/beam/commit/89f4beb36bd8b01747cdefbee1ceb7315f0a7bd9", "message": "Only set coder when with runner_v2", "committedDate": "2020-09-10T20:48:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIxNjUzNQ==", "url": "https://github.com/apache/beam/pull/12806#discussion_r488216535", "bodyText": "I think this should be \"beam_fn_api\" || \"use_runner_v2\" || \"use_unified_worker\"\nAlso, can we use the full pubsub with message attributes coder, this will allow for future changes to the PubsubUnboundedSink without needing to break update compatibility", "author": "lukecwik", "createdAt": "2020-09-14T20:59:35Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsub/PubsubIO.java", "diffHunk": "@@ -1010,20 +1011,27 @@ public PDone expand(PCollection<T> input) {\n                           getMaxBatchBytesSize(), MAX_PUBLISH_BATCH_BYTE_SIZE_DEFAULT))));\n           return PDone.in(input.getPipeline());\n         case UNBOUNDED:\n-          return input\n-              .apply(MapElements.into(new TypeDescriptor<PubsubMessage>() {}).via(getFormatFn()))\n-              .apply(\n-                  new PubsubUnboundedSink(\n-                      getPubsubClientFactory(),\n-                      NestedValueProvider.of(getTopicProvider(), new TopicPathTranslator()),\n-                      getTimestampAttribute(),\n-                      getIdAttribute(),\n-                      100 /* numShards */,\n-                      MoreObjects.firstNonNull(\n-                          getMaxBatchSize(), PubsubUnboundedSink.DEFAULT_PUBLISH_BATCH_SIZE),\n-                      MoreObjects.firstNonNull(\n-                          getMaxBatchBytesSize(),\n-                          PubsubUnboundedSink.DEFAULT_PUBLISH_BATCH_BYTES)));\n+          PCollection<PubsubMessage> output =\n+              input.apply(\n+                  MapElements.into(new TypeDescriptor<PubsubMessage>() {}).via(getFormatFn()));\n+          if (ExperimentalOptions.hasExperiment(input.getPipeline().getOptions(), \"beam_fn_api\")", "originalCommit": "89f4beb36bd8b01747cdefbee1ceb7315f0a7bd9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "60b0229666a32b2af9face06f48e38676003322a", "url": "https://github.com/apache/beam/commit/60b0229666a32b2af9face06f48e38676003322a", "message": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "committedDate": "2020-09-15T17:34:04Z", "type": "forcePushed"}, {"oid": "bcdc93239aefab09d5b2f544882205f501ba38cc", "url": "https://github.com/apache/beam/commit/bcdc93239aefab09d5b2f544882205f501ba38cc", "message": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "committedDate": "2020-09-17T20:38:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE3ODIzNw==", "url": "https://github.com/apache/beam/pull/12806#discussion_r491178237", "bodyText": "nit: rename classes to PubsubMessages", "author": "lukecwik", "createdAt": "2020-09-18T20:35:59Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsub/PubsubMessageUtils.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsub;\n+\n+import com.google.protobuf.ByteString;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import java.util.Map;\n+import org.apache.beam.sdk.transforms.SerializableFunction;\n+\n+/** Common util functions for converting between PubsubMessage proto and {@link PubsubMessage}. */\n+public class PubsubMessageUtils {", "originalCommit": "bcdc93239aefab09d5b2f544882205f501ba38cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b13bb7f2f1e90d6c2afa2cd706371762a800d10c", "url": "https://github.com/apache/beam/commit/b13bb7f2f1e90d6c2afa2cd706371762a800d10c", "message": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "committedDate": "2020-09-21T19:16:47Z", "type": "forcePushed"}, {"oid": "69051607a47ef510611fc990f56a5616cc26268a", "url": "https://github.com/apache/beam/commit/69051607a47ef510611fc990f56a5616cc26268a", "message": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "committedDate": "2020-09-22T17:15:30Z", "type": "forcePushed"}, {"oid": "7bf06d36abd59aaabafb53f834e9512d6589427f", "url": "https://github.com/apache/beam/commit/7bf06d36abd59aaabafb53f834e9512d6589427f", "message": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "committedDate": "2020-10-28T20:24:38Z", "type": "forcePushed"}, {"oid": "e4095ad13b9ef99a059322311d6f24e6d23752eb", "url": "https://github.com/apache/beam/commit/e4095ad13b9ef99a059322311d6f24e6d23752eb", "message": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "committedDate": "2020-10-28T21:20:16Z", "type": "forcePushed"}, {"oid": "fe0915503fa11b7b08aad395cda01a96698a2eb8", "url": "https://github.com/apache/beam/commit/fe0915503fa11b7b08aad395cda01a96698a2eb8", "message": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "committedDate": "2020-10-29T00:16:24Z", "type": "forcePushed"}, {"oid": "2d38a8b873cca34ca47f523035f35b0003445bd0", "url": "https://github.com/apache/beam/commit/2d38a8b873cca34ca47f523035f35b0003445bd0", "message": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "committedDate": "2020-10-29T00:27:35Z", "type": "forcePushed"}, {"oid": "7a309c2ce602fba67351f36067f9c65b150b86a8", "url": "https://github.com/apache/beam/commit/7a309c2ce602fba67351f36067f9c65b150b86a8", "message": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "committedDate": "2020-10-29T00:49:09Z", "type": "commit"}, {"oid": "7a309c2ce602fba67351f36067f9c65b150b86a8", "url": "https://github.com/apache/beam/commit/7a309c2ce602fba67351f36067f9c65b150b86a8", "message": "[BEAM-10869] Make WriteToPubsub output serialized PubsubMessage proto bytes when using runner v2", "committedDate": "2020-10-29T00:49:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NTA3MA==", "url": "https://github.com/apache/beam/pull/12806#discussion_r514295070", "bodyText": "BTW doesn't Java work (for runner v2) when we just set PropertyNames.PUBSUB_SERIALIZED_ATTRIBUTES_FN to empty string ?", "author": "chamikaramj", "createdAt": "2020-10-29T14:19:46Z", "path": "runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowRunner.java", "diffHunk": "@@ -1508,7 +1578,7 @@ public void translate(StreamingPubsubIOWrite transform, TranslationContext conte\n       // Using a GlobalWindowCoder as a place holder because GlobalWindowCoder is known coder.\n       stepContext.addEncodingInput(\n           WindowedValue.getFullCoder(VoidCoder.of(), GlobalWindow.Coder.INSTANCE));\n-      stepContext.addInput(PropertyNames.PARALLEL_INPUT, context.getInput(transform));\n+      stepContext.addInput(PropertyNames.PARALLEL_INPUT, input);", "originalCommit": "7a309c2ce602fba67351f36067f9c65b150b86a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ2NjMzMg==", "url": "https://github.com/apache/beam/pull/12806#discussion_r514466332", "bodyText": "Please refer to L1574. In java, it's not an empty string but a serialized func, though the func is not used in portable run.", "author": "boyuanzz", "createdAt": "2020-10-29T18:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NTA3MA=="}], "type": "inlineReview"}]}