{"pr_number": 13395, "pr_title": "[BEAM-11426] Add FHIR Search to io/gcp/healthcare/FhirIO", "pr_createdAt": "2020-11-20T17:27:57Z", "pr_url": "https://github.com/apache/beam/pull/13395", "timeline": [{"oid": "37f1134ae5c96016036442062ed0ec5a7e6edcb4", "url": "https://github.com/apache/beam/commit/37f1134ae5c96016036442062ed0ec5a7e6edcb4", "message": "Add Search to FHIRIO", "committedDate": "2020-11-20T05:31:51Z", "type": "commit"}, {"oid": "c7ce0ed246618a594596248882259594c332eb0c", "url": "https://github.com/apache/beam/commit/c7ce0ed246618a594596248882259594c332eb0c", "message": "Add Search to FHIRIO", "committedDate": "2020-11-20T17:14:59Z", "type": "commit"}, {"oid": "cba4b260ba9d370e6034ee754242f913074138ab", "url": "https://github.com/apache/beam/commit/cba4b260ba9d370e6034ee754242f913074138ab", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam", "committedDate": "2020-11-20T17:17:38Z", "type": "commit"}, {"oid": "7015ba7b4c520c2c2ae78ede16fa0aa1ee27ca61", "url": "https://github.com/apache/beam/commit/7015ba7b4c520c2c2ae78ede16fa0aa1ee27ca61", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam", "committedDate": "2020-11-20T17:23:17Z", "type": "commit"}, {"oid": "1cedaed15134216b919b1ae5c42ba487b8faf421", "url": "https://github.com/apache/beam/commit/1cedaed15134216b919b1ae5c42ba487b8faf421", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam", "committedDate": "2020-11-20T17:24:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1MzI5NA==", "url": "https://github.com/apache/beam/pull/13395#discussion_r527953294", "bodyText": "Should we pass the queries in as well, or is it part of fhirStore?", "author": "lastomato", "createdAt": "2020-11-20T20:28:22Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -215,6 +215,16 @@ public static Read readResources() {\n     return new Read();\n   }\n \n+  /**\n+   * Search resources from a PCollection\n+   *\n+   * @return the search\n+   * @see Search\n+   */\n+  public static Search searchResources(String fhirStore) {", "originalCommit": "1cedaed15134216b919b1ae5c42ba487b8faf421", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk2MTQyNg==", "url": "https://github.com/apache/beam/pull/13395#discussion_r527961426", "bodyText": "I just realized that your case is totally different from what I thought, I expect a single query is used to generate the input to the pipeline, while it looks like we are doing something in reverse here, the search parameters are from the input. Can you confirm this is indeed the use case you have in mind? Please feel free to reach out to me offline.", "author": "lastomato", "createdAt": "2020-11-20T20:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1MzI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyNzc2Mg==", "url": "https://github.com/apache/beam/pull/13395#discussion_r528727762", "bodyText": "I'll reply in an email offline.", "author": "janeliulwq", "createdAt": "2020-11-23T14:08:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1MzI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1NDg4Mw==", "url": "https://github.com/apache/beam/pull/13395#discussion_r527954883", "bodyText": "nit: maybe remove this comment? Doesn't seem to be very informative.", "author": "lastomato", "createdAt": "2020-11-20T20:31:45Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -1388,4 +1398,206 @@ public void deidentify(ProcessContext context)\n       }\n     }\n   }\n+\n+  /** The type Search. */\n+  public static class Search extends PTransform<PCollection<KV<String, Map<String, Object>>>, FhirIO.Search.Result> {\n+    private static final Logger LOG = LoggerFactory.getLogger(Search.class);\n+\n+    private final ValueProvider<String> fhirStore;\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(ValueProvider<String> fhirStore) {\n+      this.fhirStore = fhirStore;\n+    }\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(String fhirStore) {\n+      this.fhirStore = StaticValueProvider.of(fhirStore);\n+    }\n+\n+    /** The type Result. */\n+    public static class Result implements POutput, PInput {\n+      private PCollection<String> resources;\n+\n+      private PCollection<HealthcareIOError<String>> failedSearches;\n+      /** The Pct. */", "originalCommit": "1cedaed15134216b919b1ae5c42ba487b8faf421", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyNzUyNg==", "url": "https://github.com/apache/beam/pull/13395#discussion_r528727526", "bodyText": "Done.", "author": "janeliulwq", "createdAt": "2020-11-23T14:08:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1NDg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1OTc3Ng==", "url": "https://github.com/apache/beam/pull/13395#discussion_r527959776", "bodyText": "You will need to handle pagination here, see how this is handled for ListMessages: https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/HttpHealthcareApiClient.java#L682.", "author": "lastomato", "createdAt": "2020-11-20T20:43:09Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/HttpHealthcareApiClient.java", "diffHunk": "@@ -545,6 +529,26 @@ public HttpBody readFhirResource(String resourceId) throws IOException {\n     return client.projects().locations().datasets().fhirStores().fhir().read(resourceId).execute();\n   }\n \n+  @Override\n+  public HttpBody searchFhirResource(\n+          String fhirStore,\n+          String resourceType,\n+          @Nullable Map<String, Object> parameters)\n+          throws IOException {\n+    SearchResourcesRequest request = new SearchResourcesRequest().setResourceType(resourceType);\n+    Search search = client\n+            .projects()\n+            .locations()\n+            .datasets()\n+            .fhirStores()\n+            .fhir()\n+            .search(fhirStore, request);", "originalCommit": "1cedaed15134216b919b1ae5c42ba487b8faf421", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyNzU5MA==", "url": "https://github.com/apache/beam/pull/13395#discussion_r528727590", "bodyText": "Done.", "author": "janeliulwq", "createdAt": "2020-11-23T14:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1OTc3Ng=="}], "type": "inlineReview"}, {"oid": "55a28e1aa754b417224afdfbfb781d5c4327bd9c", "url": "https://github.com/apache/beam/commit/55a28e1aa754b417224afdfbfb781d5c4327bd9c", "message": "Search iterator", "committedDate": "2020-11-23T04:46:32Z", "type": "commit"}, {"oid": "eef752e3f57c67367f4b3f61276da79beb837815", "url": "https://github.com/apache/beam/commit/eef752e3f57c67367f4b3f61276da79beb837815", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam", "committedDate": "2020-11-23T04:51:13Z", "type": "commit"}, {"oid": "b0b91e9801279fd81701d541d8e4d46d5b8b5654", "url": "https://github.com/apache/beam/commit/b0b91e9801279fd81701d541d8e4d46d5b8b5654", "message": "Switch output type to String", "committedDate": "2020-11-23T05:04:57Z", "type": "commit"}, {"oid": "31b3b79c64b6b78b7c059cf35d19acf486756720", "url": "https://github.com/apache/beam/commit/31b3b79c64b6b78b7c059cf35d19acf486756720", "message": "Added documentation for search", "committedDate": "2020-11-23T17:04:56Z", "type": "commit"}, {"oid": "9144adc234fac396f45e0231f223734f7d7937e3", "url": "https://github.com/apache/beam/commit/9144adc234fac396f45e0231f223734f7d7937e3", "message": "Add FhirIOSearchIT", "committedDate": "2020-11-24T06:37:59Z", "type": "commit"}, {"oid": "ba1ef19f6215ca496fae9003b17b55f027bf9e35", "url": "https://github.com/apache/beam/commit/ba1ef19f6215ca496fae9003b17b55f027bf9e35", "message": "Add a timelimit to test to avoid OOM", "committedDate": "2020-11-24T18:44:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNjc5Nw==", "url": "https://github.com/apache/beam/pull/13395#discussion_r529806797", "bodyText": "nit: end with a period.", "author": "lastomato", "createdAt": "2020-11-24T18:55:13Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -215,6 +227,16 @@ public static Read readResources() {\n     return new Read();\n   }\n \n+  /**\n+   * Search resources from a PCollection", "originalCommit": "ba1ef19f6215ca496fae9003b17b55f027bf9e35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgzNjQ0Mg==", "url": "https://github.com/apache/beam/pull/13395#discussion_r529836442", "bodyText": "Done.", "author": "janeliulwq", "createdAt": "2020-11-24T19:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNjc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNzExMw==", "url": "https://github.com/apache/beam/pull/13395#discussion_r529807113", "bodyText": "nit: you can remove these if they are obvious. Same for other comments.", "author": "lastomato", "createdAt": "2020-11-24T18:55:43Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -215,6 +227,16 @@ public static Read readResources() {\n     return new Read();\n   }\n \n+  /**\n+   * Search resources from a PCollection\n+   *\n+   * @return the search", "originalCommit": "ba1ef19f6215ca496fae9003b17b55f027bf9e35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgzNjUwNA==", "url": "https://github.com/apache/beam/pull/13395#discussion_r529836504", "bodyText": "Keeping this one for consistency with other methods, removed some other comments.", "author": "janeliulwq", "createdAt": "2020-11-24T19:47:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNzExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwODA5Mw==", "url": "https://github.com/apache/beam/pull/13395#discussion_r529808093", "bodyText": "nit: You can let IntelliJ format these long lines.", "author": "lastomato", "createdAt": "2020-11-24T18:57:20Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -1388,4 +1410,208 @@ public void deidentify(ProcessContext context)\n       }\n     }\n   }\n+\n+  /** The type Search. */\n+  public static class Search extends PTransform<PCollection<KV<String, Map<String, String>>>, FhirIO.Search.Result> {\n+    private static final Logger LOG = LoggerFactory.getLogger(Search.class);\n+\n+    private final ValueProvider<String> fhirStore;\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(ValueProvider<String> fhirStore) {\n+      this.fhirStore = fhirStore;\n+    }\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(String fhirStore) {\n+      this.fhirStore = StaticValueProvider.of(fhirStore);\n+    }\n+\n+    /** The type Result. */\n+    public static class Result implements POutput, PInput {\n+      private PCollection<String> resources;\n+\n+      private PCollection<HealthcareIOError<String>> failedSearches;\n+      PCollectionTuple pct;\n+\n+      /**\n+       * Create FhirIO.Search.Result form PCollectionTuple with OUT and DEAD_LETTER tags.\n+       *\n+       * @param pct the pct\n+       * @return the search result\n+       * @throws IllegalArgumentException the illegal argument exception\n+       */\n+      static FhirIO.Search.Result of(PCollectionTuple pct) throws IllegalArgumentException {\n+        if (pct.getAll()\n+                .keySet()\n+                .containsAll((Collection<?>) TupleTagList.of(OUT).and(DEAD_LETTER))) {\n+          return new FhirIO.Search.Result(pct);\n+        } else {\n+          throw new IllegalArgumentException(\n+                  \"The PCollection tuple must have the FhirIO.Search.OUT \"\n+                          + \"and FhirIO.Search.DEAD_LETTER tuple tags\");\n+        }\n+      }\n+\n+      private Result(PCollectionTuple pct) {\n+        this.pct = pct;\n+        this.resources = pct.get(OUT);\n+        this.failedSearches =\n+                pct.get(DEAD_LETTER).setCoder(HealthcareIOErrorCoder.of(StringUtf8Coder.of()));", "originalCommit": "ba1ef19f6215ca496fae9003b17b55f027bf9e35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgzNjY5Mw==", "url": "https://github.com/apache/beam/pull/13395#discussion_r529836693", "bodyText": "I ran a reformat and it changed many lines other than the ones I'm touching, hope this is ok.", "author": "janeliulwq", "createdAt": "2020-11-24T19:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwODA5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUyNjg5MA==", "url": "https://github.com/apache/beam/pull/13395#discussion_r530526890", "bodyText": "It should be OK.", "author": "lastomato", "createdAt": "2020-11-25T17:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwODA5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwODYwMw==", "url": "https://github.com/apache/beam/pull/13395#discussion_r529808603", "bodyText": "Please only catch the exceptions you expect to handle.", "author": "lastomato", "createdAt": "2020-11-24T18:58:13Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -1388,4 +1410,208 @@ public void deidentify(ProcessContext context)\n       }\n     }\n   }\n+\n+  /** The type Search. */\n+  public static class Search extends PTransform<PCollection<KV<String, Map<String, String>>>, FhirIO.Search.Result> {\n+    private static final Logger LOG = LoggerFactory.getLogger(Search.class);\n+\n+    private final ValueProvider<String> fhirStore;\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(ValueProvider<String> fhirStore) {\n+      this.fhirStore = fhirStore;\n+    }\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(String fhirStore) {\n+      this.fhirStore = StaticValueProvider.of(fhirStore);\n+    }\n+\n+    /** The type Result. */\n+    public static class Result implements POutput, PInput {\n+      private PCollection<String> resources;\n+\n+      private PCollection<HealthcareIOError<String>> failedSearches;\n+      PCollectionTuple pct;\n+\n+      /**\n+       * Create FhirIO.Search.Result form PCollectionTuple with OUT and DEAD_LETTER tags.\n+       *\n+       * @param pct the pct\n+       * @return the search result\n+       * @throws IllegalArgumentException the illegal argument exception\n+       */\n+      static FhirIO.Search.Result of(PCollectionTuple pct) throws IllegalArgumentException {\n+        if (pct.getAll()\n+                .keySet()\n+                .containsAll((Collection<?>) TupleTagList.of(OUT).and(DEAD_LETTER))) {\n+          return new FhirIO.Search.Result(pct);\n+        } else {\n+          throw new IllegalArgumentException(\n+                  \"The PCollection tuple must have the FhirIO.Search.OUT \"\n+                          + \"and FhirIO.Search.DEAD_LETTER tuple tags\");\n+        }\n+      }\n+\n+      private Result(PCollectionTuple pct) {\n+        this.pct = pct;\n+        this.resources = pct.get(OUT);\n+        this.failedSearches =\n+                pct.get(DEAD_LETTER).setCoder(HealthcareIOErrorCoder.of(StringUtf8Coder.of()));\n+      }\n+\n+      /**\n+       * Gets failed searches.\n+       *\n+       * @return the failed searches\n+       */\n+      public PCollection<HealthcareIOError<String>> getFailedSearches() {\n+        return failedSearches;\n+      }\n+\n+      /**\n+       * Gets resources.\n+       *\n+       * @return the resources\n+       */\n+      public PCollection<String> getResources() {\n+        return resources;\n+      }\n+\n+      @Override\n+      public Pipeline getPipeline() {\n+        return this.pct.getPipeline();\n+      }\n+\n+      @Override\n+      public Map<TupleTag<?>, PValue> expand() {\n+        return ImmutableMap.of(OUT, resources);\n+      }\n+\n+      @Override\n+      public void finishSpecifyingOutput(\n+              String transformName, PInput input, PTransform<?, ?> transform) {}\n+    }\n+\n+    /** The tag for the main output of Fhir Messages. */\n+    public static final TupleTag<String> OUT = new TupleTag<String>() {};\n+    /** The tag for the deadletter output of Fhir Messages. */\n+    public static final TupleTag<HealthcareIOError<String>> DEAD_LETTER =\n+            new TupleTag<HealthcareIOError<String>>() {};\n+\n+    @Override\n+    public FhirIO.Search.Result expand(PCollection<KV<String, Map<String, String>>> input) {\n+      return input.apply(\"Fetch Fhir messages\", new SearchResourcesJsonString(this.fhirStore));\n+    }\n+\n+    /**\n+     * DoFn to fetch resources from an Google Cloud Healthcare FHIR store based on search request\n+     *\n+     * <p>This DoFn consumes a {@link PCollection} of search requests consisting of resource type\n+     * and search parameters, and fetches all matching resources based on the search criteria and\n+     * will output a {@link PCollectionTuple} which contains the output and dead-letter {@link\n+     * PCollection}*.\n+     *\n+     * <p>The {@link PCollectionTuple} output will contain the following {@link PCollection}:\n+     *\n+     * <ul>\n+     *   <li>{@link FhirIO.Search#OUT} - Contains all {@link PCollection} records successfully search\n+     *       from the Fhir store.\n+     *   <li>{@link FhirIO.Search#DEAD_LETTER} - Contains all {@link PCollection} of {@link\n+     *       HealthcareIOError}* of failed searches from the Fhir store, with\n+     *       error message and stacktrace.\n+     * </ul>\n+     */\n+    static class SearchResourcesJsonString\n+            extends PTransform<PCollection<KV<String, Map<String, String>>>, FhirIO.Search.Result> {\n+\n+      private final ValueProvider<String> fhirStore;\n+\n+      /** Instantiates a new Search Fhir resources DoFn. */\n+      public SearchResourcesJsonString(ValueProvider<String> fhirStore) {\n+        this.fhirStore = fhirStore;\n+      }\n+\n+      @Override\n+      public FhirIO.Search.Result expand(PCollection<KV<String, Map<String, String>>> resourceIds) {\n+        return new FhirIO.Search.Result(\n+                resourceIds.apply(\n+                        ParDo.of(new SearchResourcesFn(this.fhirStore))\n+                                .withOutputTags(FhirIO.Search.OUT, TupleTagList.of(FhirIO.Search.DEAD_LETTER))));\n+      }\n+\n+      /** DoFn for searching messages from the Fhir store with error handling. */\n+      static class SearchResourcesFn extends DoFn<KV<String, Map<String, String>>, String> {\n+\n+        private Counter failedSearches =\n+                Metrics.counter(SearchResourcesFn.class, \"failed-fhir-searches\");\n+        private static final Logger LOG = LoggerFactory.getLogger(SearchResourcesFn.class);\n+        private final Counter successfulSearches =\n+                Metrics.counter(SearchResourcesFn.class, \"successful-fhir-searches\");\n+        private HealthcareApiClient client;\n+        private final ValueProvider<String> fhirStore;\n+\n+        /** Instantiates a new Fhir resources search fn. */\n+        SearchResourcesFn(ValueProvider<String> fhirStore) {\n+          this.fhirStore = fhirStore;\n+        }\n+\n+        /**\n+         * Instantiate healthcare client.\n+         *\n+         * @throws IOException the io exception\n+         */\n+        @Setup\n+        public void instantiateHealthcareClient() throws IOException {\n+          this.client = new HttpHealthcareApiClient();\n+        }\n+\n+        /**\n+         * Process element.\n+         *\n+         * @param context the context\n+         */\n+        @ProcessElement\n+        public void processElement(ProcessContext context) {\n+          KV<String, Map<String, String>> elementValues = context.element();\n+          try {\n+            context.output(searchResources(\n+                    this.client, this.fhirStore.toString(), elementValues.getKey(), elementValues.getValue()));\n+          } catch (Exception e) {", "originalCommit": "ba1ef19f6215ca496fae9003b17b55f027bf9e35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgzNjczMA==", "url": "https://github.com/apache/beam/pull/13395#discussion_r529836730", "bodyText": "Would that mean that unhandled exceptions / errors won't be logged?", "author": "janeliulwq", "createdAt": "2020-11-24T19:48:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwODYwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUyNzY5Nw==", "url": "https://github.com/apache/beam/pull/13395#discussion_r530527697", "bodyText": "They will be handled by code that knows how to handle them. For example, the code here probably should not be responsible for an OutOfMemoryError.", "author": "lastomato", "createdAt": "2020-11-25T17:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwODYwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU4MjkxOQ==", "url": "https://github.com/apache/beam/pull/13395#discussion_r530582919", "bodyText": "Ah, makes sense, done. Sorry Java newbie here!", "author": "janeliulwq", "createdAt": "2020-11-25T18:53:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwODYwMw=="}], "type": "inlineReview"}, {"oid": "4f064d194901704793a0c364e8bda0a3ccb44a9d", "url": "https://github.com/apache/beam/commit/4f064d194901704793a0c364e8bda0a3ccb44a9d", "message": "Reformatting and comments", "committedDate": "2020-11-24T19:47:22Z", "type": "commit"}, {"oid": "58fee42168b6bf1f3b573ce843637a745e6f2897", "url": "https://github.com/apache/beam/commit/58fee42168b6bf1f3b573ce843637a745e6f2897", "message": "Reformatting and comments", "committedDate": "2020-11-25T18:49:53Z", "type": "commit"}, {"oid": "c7fdba8e85f8edaafd80d9f0292311f8b8982d42", "url": "https://github.com/apache/beam/commit/c7fdba8e85f8edaafd80d9f0292311f8b8982d42", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam", "committedDate": "2020-11-25T18:50:59Z", "type": "commit"}, {"oid": "c27ab33750edd54818d6293ff19d7a5f0cbc9ddf", "url": "https://github.com/apache/beam/commit/c27ab33750edd54818d6293ff19d7a5f0cbc9ddf", "message": "Merge branch 'master' into master", "committedDate": "2020-11-30T19:11:54Z", "type": "commit"}, {"oid": "f5ac2a19bcc94982d5813d6d03c318bb82a5228e", "url": "https://github.com/apache/beam/commit/f5ac2a19bcc94982d5813d6d03c318bb82a5228e", "message": "Fix library import errors from the newly merged DICOM code", "committedDate": "2020-11-30T20:20:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIzMzU5NQ==", "url": "https://github.com/apache/beam/pull/13395#discussion_r534233595", "bodyText": "Note that this test has failed (https://ci-beam.apache.org/job/beam_PreCommit_Java_Commit/14889/testReport/junit/org.apache.beam.sdk.io.gcp.healthcare/FhirIOTest/test_FhirIO_failedSearches/) - please fix", "author": "pabloem", "createdAt": "2020-12-02T14:58:58Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIOTest.java", "diffHunk": "@@ -58,6 +56,25 @@ public void test_FhirIO_failedReads() {\n     pipeline.run();\n   }\n \n+  @Test\n+  public void test_FhirIO_failedSearches() {", "originalCommit": "f5ac2a19bcc94982d5813d6d03c318bb82a5228e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2Mzg4OQ==", "url": "https://github.com/apache/beam/pull/13395#discussion_r534563889", "bodyText": "Done, looks like it's passing now (I'm not sure why Java PreCommit is marked as failed but there's no test failures when I open the details page, only warnings?)", "author": "janeliulwq", "createdAt": "2020-12-02T23:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIzMzU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM0MTkzMQ==", "url": "https://github.com/apache/beam/pull/13395#discussion_r534341931", "bodyText": "I had recommended using async calls. In this case, I see that the calls happen within the iterator. I think this is fine as it is. I have a question though:\nUsually, will one element often produce one result from the iterator? Or usually more than one? I see that in lines 1608:1609, for the first iteration, there will be two calls to Fhir (one in hasNext, and one in next). Is it possible to try to reduce this to one?\nI expect your connector to have a bottleneck on IO. I would recommend you add a distribution-type metric to track time spent on IO.", "author": "pabloem", "createdAt": "2020-12-02T17:17:24Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -1388,4 +1410,208 @@ public void deidentify(ProcessContext context)\n       }\n     }\n   }\n+\n+  /** The type Search. */\n+  public static class Search extends PTransform<PCollection<KV<String, Map<String, String>>>, FhirIO.Search.Result> {\n+    private static final Logger LOG = LoggerFactory.getLogger(Search.class);\n+\n+    private final ValueProvider<String> fhirStore;\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(ValueProvider<String> fhirStore) {\n+      this.fhirStore = fhirStore;\n+    }\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(String fhirStore) {\n+      this.fhirStore = StaticValueProvider.of(fhirStore);\n+    }\n+\n+    /** The type Result. */\n+    public static class Result implements POutput, PInput {\n+      private PCollection<String> resources;\n+\n+      private PCollection<HealthcareIOError<String>> failedSearches;\n+      PCollectionTuple pct;\n+\n+      /**\n+       * Create FhirIO.Search.Result form PCollectionTuple with OUT and DEAD_LETTER tags.\n+       *\n+       * @param pct the pct\n+       * @return the search result\n+       * @throws IllegalArgumentException the illegal argument exception\n+       */\n+      static FhirIO.Search.Result of(PCollectionTuple pct) throws IllegalArgumentException {\n+        if (pct.getAll()\n+                .keySet()\n+                .containsAll((Collection<?>) TupleTagList.of(OUT).and(DEAD_LETTER))) {\n+          return new FhirIO.Search.Result(pct);\n+        } else {\n+          throw new IllegalArgumentException(\n+                  \"The PCollection tuple must have the FhirIO.Search.OUT \"\n+                          + \"and FhirIO.Search.DEAD_LETTER tuple tags\");\n+        }\n+      }\n+\n+      private Result(PCollectionTuple pct) {\n+        this.pct = pct;\n+        this.resources = pct.get(OUT);\n+        this.failedSearches =\n+                pct.get(DEAD_LETTER).setCoder(HealthcareIOErrorCoder.of(StringUtf8Coder.of()));\n+      }\n+\n+      /**\n+       * Gets failed searches.\n+       *\n+       * @return the failed searches\n+       */\n+      public PCollection<HealthcareIOError<String>> getFailedSearches() {\n+        return failedSearches;\n+      }\n+\n+      /**\n+       * Gets resources.\n+       *\n+       * @return the resources\n+       */\n+      public PCollection<String> getResources() {\n+        return resources;\n+      }\n+\n+      @Override\n+      public Pipeline getPipeline() {\n+        return this.pct.getPipeline();\n+      }\n+\n+      @Override\n+      public Map<TupleTag<?>, PValue> expand() {\n+        return ImmutableMap.of(OUT, resources);\n+      }\n+\n+      @Override\n+      public void finishSpecifyingOutput(\n+              String transformName, PInput input, PTransform<?, ?> transform) {}\n+    }\n+\n+    /** The tag for the main output of Fhir Messages. */\n+    public static final TupleTag<String> OUT = new TupleTag<String>() {};\n+    /** The tag for the deadletter output of Fhir Messages. */\n+    public static final TupleTag<HealthcareIOError<String>> DEAD_LETTER =\n+            new TupleTag<HealthcareIOError<String>>() {};\n+\n+    @Override\n+    public FhirIO.Search.Result expand(PCollection<KV<String, Map<String, String>>> input) {\n+      return input.apply(\"Fetch Fhir messages\", new SearchResourcesJsonString(this.fhirStore));\n+    }\n+\n+    /**\n+     * DoFn to fetch resources from an Google Cloud Healthcare FHIR store based on search request\n+     *\n+     * <p>This DoFn consumes a {@link PCollection} of search requests consisting of resource type\n+     * and search parameters, and fetches all matching resources based on the search criteria and\n+     * will output a {@link PCollectionTuple} which contains the output and dead-letter {@link\n+     * PCollection}*.\n+     *\n+     * <p>The {@link PCollectionTuple} output will contain the following {@link PCollection}:\n+     *\n+     * <ul>\n+     *   <li>{@link FhirIO.Search#OUT} - Contains all {@link PCollection} records successfully search\n+     *       from the Fhir store.\n+     *   <li>{@link FhirIO.Search#DEAD_LETTER} - Contains all {@link PCollection} of {@link\n+     *       HealthcareIOError}* of failed searches from the Fhir store, with\n+     *       error message and stacktrace.\n+     * </ul>\n+     */\n+    static class SearchResourcesJsonString\n+            extends PTransform<PCollection<KV<String, Map<String, String>>>, FhirIO.Search.Result> {\n+\n+      private final ValueProvider<String> fhirStore;\n+\n+      /** Instantiates a new Search Fhir resources DoFn. */\n+      public SearchResourcesJsonString(ValueProvider<String> fhirStore) {\n+        this.fhirStore = fhirStore;\n+      }\n+\n+      @Override\n+      public FhirIO.Search.Result expand(PCollection<KV<String, Map<String, String>>> resourceIds) {\n+        return new FhirIO.Search.Result(\n+                resourceIds.apply(\n+                        ParDo.of(new SearchResourcesFn(this.fhirStore))\n+                                .withOutputTags(FhirIO.Search.OUT, TupleTagList.of(FhirIO.Search.DEAD_LETTER))));\n+      }\n+\n+      /** DoFn for searching messages from the Fhir store with error handling. */\n+      static class SearchResourcesFn extends DoFn<KV<String, Map<String, String>>, String> {\n+\n+        private Counter failedSearches =\n+                Metrics.counter(SearchResourcesFn.class, \"failed-fhir-searches\");\n+        private static final Logger LOG = LoggerFactory.getLogger(SearchResourcesFn.class);\n+        private final Counter successfulSearches =\n+                Metrics.counter(SearchResourcesFn.class, \"successful-fhir-searches\");\n+        private HealthcareApiClient client;\n+        private final ValueProvider<String> fhirStore;\n+\n+        /** Instantiates a new Fhir resources search fn. */\n+        SearchResourcesFn(ValueProvider<String> fhirStore) {\n+          this.fhirStore = fhirStore;\n+        }\n+\n+        /**\n+         * Instantiate healthcare client.\n+         *\n+         * @throws IOException the io exception\n+         */\n+        @Setup\n+        public void instantiateHealthcareClient() throws IOException {\n+          this.client = new HttpHealthcareApiClient();\n+        }\n+\n+        /**\n+         * Process element.\n+         *\n+         * @param context the context\n+         */\n+        @ProcessElement\n+        public void processElement(ProcessContext context) {\n+          KV<String, Map<String, String>> elementValues = context.element();\n+          try {\n+            context.output(searchResources(\n+                    this.client, this.fhirStore.toString(), elementValues.getKey(), elementValues.getValue()));\n+          } catch (Exception e) {\n+            failedSearches.inc();\n+            LOG.warn(\n+                    String.format(\n+                            \"Error search FHIR messages writing to Dead Letter \"\n+                                    + \"Queue. Cause: %s Stack Trace: %s\",\n+                            e.getMessage(), Throwables.getStackTraceAsString(e)));\n+            context.output(FhirIO.Search.DEAD_LETTER, HealthcareIOError.of(this.fhirStore.toString(), e));\n+          }\n+        }\n+\n+        private String searchResources(HealthcareApiClient client, String fhirStore, String resourceType,\n+                                       @Nullable Map<String, String> parameters)\n+                throws IllegalArgumentException {\n+          long startTime = System.currentTimeMillis();\n+\n+          HttpHealthcareApiClient.FhirResourcePages.FhirResourcePagesIterator iter =\n+                  new HttpHealthcareApiClient.FhirResourcePages.FhirResourcePagesIterator(\n+                          client, fhirStore, resourceType, parameters);\n+          JsonArray result = new JsonArray();\n+          while (iter.hasNext()) {\n+            result.addAll(iter.next());\n+          }\n+          this.successfulSearches.inc();\n+          return result.toString();", "originalCommit": "ba1ef19f6215ca496fae9003b17b55f027bf9e35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2MzkwMA==", "url": "https://github.com/apache/beam/pull/13395#discussion_r534563900", "bodyText": "I think for our use case, usually only one result will be produced from the iterator. Definitely makes sense to avoid one of the two calls, done.\nI assume you are talking about adding metrics on our end, but lmk if I misunderstood and there's anything to be added here. Thanks!", "author": "janeliulwq", "createdAt": "2020-12-02T23:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM0MTkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM1Nzg2NQ==", "url": "https://github.com/apache/beam/pull/13395#discussion_r535357865", "bodyText": "in this case I mean something like:\nprivate Distribution searchLatency =\n            Metrics.distribution(SearchResourcesFn.class, \"search-latency-or-something-ms\");\n.....\n    long startTime = System.currentTimeMillis();\n    ...\n    result.addAll(iter.next());\n    while (iter.hasNext()) {\n      result.addAll(iter.next());\n    }\n    searchLatency.update(System.currentTimeMillis() - startTime);  // Report latency to Dataflow monitoring for later inspection", "author": "pabloem", "createdAt": "2020-12-03T15:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM0MTkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM3MTgzOQ==", "url": "https://github.com/apache/beam/pull/13395#discussion_r535371839", "bodyText": "Ah got it, thank you for the pointers! Done.", "author": "janeliulwq", "createdAt": "2020-12-03T16:11:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM0MTkzMQ=="}], "type": "inlineReview"}, {"oid": "5c18a993aa9e300411eb72b4e21b9672027462b5", "url": "https://github.com/apache/beam/commit/5c18a993aa9e300411eb72b4e21b9672027462b5", "message": "Spotless + failing tests", "committedDate": "2020-12-02T21:30:35Z", "type": "commit"}, {"oid": "b72cee03db9faf40d16e544a5596fd0da15d6af1", "url": "https://github.com/apache/beam/commit/b72cee03db9faf40d16e544a5596fd0da15d6af1", "message": "Spotless + failing tests", "committedDate": "2020-12-02T22:53:03Z", "type": "commit"}, {"oid": "7a37060d628795e293f89207a6fb2e647bc41608", "url": "https://github.com/apache/beam/commit/7a37060d628795e293f89207a6fb2e647bc41608", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam", "committedDate": "2020-12-02T22:59:10Z", "type": "commit"}, {"oid": "66fe586e34580be8ab9707687cba54aaaf84d8dd", "url": "https://github.com/apache/beam/commit/66fe586e34580be8ab9707687cba54aaaf84d8dd", "message": "Add distribution metric for latency", "committedDate": "2020-12-03T16:09:49Z", "type": "commit"}, {"oid": "08da34baa66a2ab9718e8f174db0a6c10c9e0991", "url": "https://github.com/apache/beam/commit/08da34baa66a2ab9718e8f174db0a6c10c9e0991", "message": "Reformatted", "committedDate": "2020-12-03T19:45:32Z", "type": "commit"}, {"oid": "065bc7679d822229b00347b53720e8d393ab5d9d", "url": "https://github.com/apache/beam/commit/065bc7679d822229b00347b53720e8d393ab5d9d", "message": "Revert star imports", "committedDate": "2020-12-04T21:18:28Z", "type": "commit"}, {"oid": "376e0d5b3c57ec5e37bf73cf6bf4622eae8f3b32", "url": "https://github.com/apache/beam/commit/376e0d5b3c57ec5e37bf73cf6bf4622eae8f3b32", "message": "Reapply spotless", "committedDate": "2020-12-04T21:20:35Z", "type": "commit"}, {"oid": "94c80052f6ddc5896b78faf20734fd631773acf1", "url": "https://github.com/apache/beam/commit/94c80052f6ddc5896b78faf20734fd631773acf1", "message": "Use vendored guava", "committedDate": "2020-12-04T22:27:30Z", "type": "commit"}, {"oid": "4218b7d1f791e205eb53a60b204a7c46ccaec961", "url": "https://github.com/apache/beam/commit/4218b7d1f791e205eb53a60b204a7c46ccaec961", "message": "Switch FhirSearchIT from streaming pipeline to batch", "committedDate": "2020-12-08T18:49:06Z", "type": "commit"}, {"oid": "958ab09132b1f93f65e925f217c38a7859b86131", "url": "https://github.com/apache/beam/commit/958ab09132b1f93f65e925f217c38a7859b86131", "message": "Limit # of searches during test", "committedDate": "2020-12-08T21:01:01Z", "type": "commit"}]}