{"pr_number": 4799, "pr_title": "Implement and test new getbalance(s) api methods", "pr_createdAt": "2020-11-13T17:26:21Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4799", "timeline": [{"oid": "fc8af8c072af444caafe5b91abce0fa06cd4e78f", "url": "https://github.com/bisq-network/bisq/commit/fc8af8c072af444caafe5b91abce0fa06cd4e78f", "message": "Define new grpc bsq/btc balances protos\n\nThis change adds proto serivces and messages to support new api\nimplementations for serving bsq, btc or all wallet balances.\n\n- RPC GetBsqBalances will return complete BSQ balance info.\n- Message BsqBalanceInfo is proto returned by rpc GetBsqBalances.\n\n- RPC GetBtcBalances wil return complete BTC balance info.\n- Message BtcBalanceInfo is proto returned by rpc GetBtcBalances.\n\n- RPC GetBalances returns complete BTC and BSQ balance info.\n- Message BalancesInfo is proto returned by rpc GetBalances.\n\nRPC GetBalance remains unchnaged, still returns only the available\nBTC balance.  It may be deprecated and removed in a future PR.", "committedDate": "2020-11-13T14:01:02Z", "type": "commit"}, {"oid": "faf45ec301974b5a45af84b1e2246a6d2c1d02f4", "url": "https://github.com/bisq-network/bisq/commit/faf45ec301974b5a45af84b1e2246a6d2c1d02f4", "message": "Add proto wrappers for serving bsq, btc or all balances\n\nThis change adds proto wrappers for sending bsq, btc, or all balances\nto the CLI.  They will be used in future api method implementations:\ngetbsqbalance, getbtcbalance and getbalances.", "committedDate": "2020-11-13T14:24:08Z", "type": "commit"}, {"oid": "4c03b463fefb472cf518f055ab17201bec57d352", "url": "https://github.com/bisq-network/bisq/commit/4c03b463fefb472cf518f055ab17201bec57d352", "message": "Define proto for api method 'getunusedbsqaddress'\n\nThis change adds a proto to support a future api implementation for\ngetting an unused, bsq funding address.", "committedDate": "2020-11-13T14:35:06Z", "type": "commit"}, {"oid": "3e98910cc6e620ee2a56d001de9b53d984d25498", "url": "https://github.com/bisq-network/bisq/commit/3e98910cc6e620ee2a56d001de9b53d984d25498", "message": "Define proto fapi method 'sendbsq'\n\nThis change adds the proto to support a future api implementation for\ntransfering bsq.", "committedDate": "2020-11-13T14:44:42Z", "type": "commit"}, {"oid": "9f033ee572aa3afb41cf58e7aa6f64e7a7da9223", "url": "https://github.com/bisq-network/bisq/commit/9f033ee572aa3afb41cf58e7aa6f64e7a7da9223", "message": "Add proto fields to support trade fee currency choice\n\nThis change adds proto support for paying maker fees in bsq or btc.\nThe implementation will come in a future PR.\n\n- Added makerFeeCurrencyCode field to CreateOfferRequest proto.\n\n- Added isCurrencyForMakerFeeBtc field to OfferInfo proto wrapper.\n\n- Add takerFeeCurrencyCode field to TakeOfferRequest proto.", "committedDate": "2020-11-13T15:03:15Z", "type": "commit"}, {"oid": "c1c099c8320c5f19bed6e7b4ac1c1f6594be0d78", "url": "https://github.com/bisq-network/bisq/commit/c1c099c8320c5f19bed6e7b4ac1c1f6594be0d78", "message": "Implement and test api method 'getunusedbsqaddress'\n\n- Added new method to CLI, split some long msg strings into two lines,\n  and added a white space after a braceless else statement.\n\n- Added the gRPC server boilerplate.\n\n- Added the core implementation.\n\n- Added a test, and moved method wallet tests into their own package.", "committedDate": "2020-11-13T15:40:16Z", "type": "commit"}, {"oid": "7c2068e3c1d3a53ce45124c8a728a4aeec96d28a", "url": "https://github.com/bisq-network/bisq/commit/7c2068e3c1d3a53ce45124c8a728a4aeec96d28a", "message": "Add teardown to test case", "committedDate": "2020-11-13T15:45:40Z", "type": "commit"}, {"oid": "8dc1a74c8b5e11312a5b3e9db5581981dc70c68b", "url": "https://github.com/bisq-network/bisq/commit/8dc1a74c8b5e11312a5b3e9db5581981dc70c68b", "message": "Remove trailing spaces in blank line", "committedDate": "2020-11-13T15:55:48Z", "type": "commit"}, {"oid": "208a37b339378d28cf06de2c2b7232b37527b14f", "url": "https://github.com/bisq-network/bisq/commit/208a37b339378d28cf06de2c2b7232b37527b14f", "message": "Implement and test new getbalance(s) api methods\n\n- Added three new methods to CLI:\n\n      getbalances   ...\treturns complete bsq and btc balance info\n      getbsqbalance ...\treturns complete bsq balance info\n      getbtcbalance ...\treturns complete btc balance info\n\n      The old getbalance method is deprecated and will be removed\n      if there is agreement to do that.\n\n- Made the needed changes in the CLI's output formatting classes.\n\n- Added new tests to existing BsqWalletTest, added new BtcWalletTest\n  and WalletBalancesTest.\n\n- Added disabled tests for funding a bsq wallet (todo in next PR).", "committedDate": "2020-11-13T17:21:26Z", "type": "commit"}, {"oid": "7f0f949a2de9fee0cf91c0b8cd9bd5c0904343e7", "url": "https://github.com/bisq-network/bisq/commit/7f0f949a2de9fee0cf91c0b8cd9bd5c0904343e7", "message": "Resolve unnecessary use of fully qualified name for codacy", "committedDate": "2020-11-13T17:35:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxMTg2Ng==", "url": "https://github.com/bisq-network/bisq/pull/4799#discussion_r530311866", "bodyText": "Let's remove this. As the API hasn't been officially released we can just remove it unceremoniously.", "author": "sqrrm", "createdAt": "2020-11-25T11:43:41Z", "path": "apitest/src/test/java/bisq/apitest/method/MethodTest.java", "diffHunk": "@@ -104,12 +113,25 @@ public static void startSupportingApps(boolean registerDisputeAgents,\n \n     // Convenience methods for building gRPC request objects\n \n+    @Deprecated\n     protected final GetBalanceRequest createBalanceRequest() {", "originalCommit": "208a37b339378d28cf06de2c2b7232b37527b14f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2MTY2Mg==", "url": "https://github.com/bisq-network/bisq/pull/4799#discussion_r531161662", "bodyText": "This has already been replaced in one of the next PRs.  Commit 9d863e5 removed the deprecated core api method.", "author": "ghubstan", "createdAt": "2020-11-26T17:27:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxMTg2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMjEyNw==", "url": "https://github.com/bisq-network/bisq/pull/4799#discussion_r530322127", "bodyText": "Persistence has had some changes to increase the persist frequency, might not need to wait this long", "author": "sqrrm", "createdAt": "2020-11-25T12:01:57Z", "path": "apitest/src/test/java/bisq/apitest/method/wallet/BsqWalletTest.java", "diffHunk": "@@ -52,13 +83,164 @@ public void testGetUnusedBsqAddress() {\n         NetworkParameters networkParameters = LegacyAddress.getParametersFromAddress(address.substring(1));\n         String addressNetwork = networkParameters.getPaymentProtocolId();\n         assertNotEquals(PAYMENT_PROTOCOL_ID_MAINNET, addressNetwork);\n-        // TODO Fix bug(?) causing the regtest bsq address network to be evaluated as 'testnet' here.\n+        // TODO Fix bug causing the regtest bsq address network to be evaluated as 'testnet' here.\n         assertTrue(addressNetwork.equals(PAYMENT_PROTOCOL_ID_TESTNET)\n                 || addressNetwork.equals(PAYMENT_PROTOCOL_ID_REGTEST));\n     }\n \n+    @Test\n+    @Order(2)\n+    public void testInitialBsqBalances(final TestInfo testInfo) {\n+        BsqBalanceInfo alicesBsqBalances = getBsqBalances(alicedaemon);\n+        log.info(\"{} -> Alice's BSQ Initial Balances -> \\n{}\",\n+                testName(testInfo),\n+                formatBsqBalanceInfoTbl(alicesBsqBalances));\n+        verifyBsqBalances(ALICES_INITIAL_BSQ_BALANCES, alicesBsqBalances);\n+\n+        BsqBalanceInfo bobsBsqBalances = getBsqBalances(bobdaemon);\n+        log.info(\"{} -> Bob's BSQ Initial Balances -> \\n{}\",\n+                testName(testInfo),\n+                formatBsqBalanceInfoTbl(bobsBsqBalances));\n+        verifyBsqBalances(BOBS_INITIAL_BSQ_BALANCES, bobsBsqBalances);\n+    }\n+\n+    @Disabled // TODO\n+    @Test\n+    @Order(3)\n+    public void testSendBsqAndCheckBalancesBeforeGeneratingBtcBlock(final TestInfo testInfo) {\n+        String bobsBsqAddress = getUnusedBsqAddress(bobdaemon);\n+        sendBsq(alicedaemon, bobsBsqAddress, SEND_BSQ_AMOUNT);\n+        sleep(2000);\n+\n+        BsqBalanceInfo alicesBsqBalances = getBsqBalances(alicedaemon);\n+        BsqBalanceInfo bobsBsqBalances = waitForNonZeroUnverifiedBalance(bobdaemon);\n+\n+        log.info(\"BSQ Balances Before BTC Block Gen...\");\n+        printBobAndAliceBsqBalances(testInfo,\n+                bobsBsqBalances,\n+                alicesBsqBalances,\n+                alicedaemon);\n+\n+        verifyBsqBalances(expectedBsqBalanceModel(150000000,\n+                2500050,\n+                0,\n+                0,\n+                0,\n+                0),\n+                bobsBsqBalances);\n+\n+        verifyBsqBalances(expectedBsqBalanceModel(97499950,\n+                97499950,\n+                97499950,\n+                0,\n+                0,\n+                0),\n+                alicesBsqBalances);\n+    }\n+\n+    @Disabled // TODO\n+    @Test\n+    @Order(4)\n+    public void testBalancesAfterSendingBsqAndGeneratingBtcBlock(final TestInfo testInfo) {\n+        // There is a wallet persist delay;  we have to\n+        // wait for both wallets to be saved to disk.", "originalCommit": "208a37b339378d28cf06de2c2b7232b37527b14f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM4NTg5NQ==", "url": "https://github.com/bisq-network/bisq/pull/4799#discussion_r530385895", "bodyText": "I've noticed significant improvement while testing the api on top of v1.5.0.   I'll be checking what wait times I can reduce in apitest.", "author": "ghubstan", "createdAt": "2020-11-25T13:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMjEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE3MTA0Mg==", "url": "https://github.com/bisq-network/bisq/pull/4799#discussion_r531171042", "bodyText": "But I could not reduce that wait time without the test failing.  There may be other wait times that can be reduced, like waiting for app startup & shutdown, but not this one.", "author": "ghubstan", "createdAt": "2020-11-26T17:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMjEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyNDcyNg==", "url": "https://github.com/bisq-network/bisq/pull/4799#discussion_r530324726", "bodyText": "Let's remove it", "author": "sqrrm", "createdAt": "2020-11-25T12:06:43Z", "path": "cli/src/main/java/bisq/cli/CliMain.java", "diffHunk": "@@ -88,7 +92,10 @@\n         createpaymentacct,\n         getpaymentaccts,\n         getversion,\n-        getbalance,\n+        @Deprecated getbalance, // Use getbalances, return bsq and btc balance info", "originalCommit": "208a37b339378d28cf06de2c2b7232b37527b14f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2MTg2Mg==", "url": "https://github.com/bisq-network/bisq/pull/4799#discussion_r531161862", "bodyText": "Let's remove it\n\nThis has already been repurposed in one of the next PRs. Commit 9d863e5 removed the deprecated core api method.", "author": "ghubstan", "createdAt": "2020-11-26T17:28:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyNDcyNg=="}], "type": "inlineReview"}]}