{"pr_number": 4524, "pr_title": "Add core support for registration of regtest dispute agents via API", "pr_createdAt": "2020-09-14T15:49:34Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4524", "timeline": [{"oid": "359037a3ba9358282b9cf6ba687656a809a4a78a", "url": "https://github.com/bisq-network/bisq/commit/359037a3ba9358282b9cf6ba687656a809a4a78a", "message": "Move version service proto def to bottom of grpc.proto", "committedDate": "2020-09-14T13:43:31Z", "type": "commit"}, {"oid": "15b60445873304e614be6d9ba20c9e86181f6cba", "url": "https://github.com/bisq-network/bisq/commit/15b60445873304e614be6d9ba20c9e86181f6cba", "message": "Add dispute agents service proto def to grpc.proto", "committedDate": "2020-09-14T13:44:19Z", "type": "commit"}, {"oid": "bbf4f09181746759961f5404f241fa183dd6c5ec", "url": "https://github.com/bisq-network/bisq/commit/bbf4f09181746759961f5404f241fa183dd6c5ec", "message": "Add core impl for registering dispute agents\n\nThis change supports registering mediators and refund agents on\ndaemons running on regest or testnet chains.  Registering\narbitrators is not supported.", "committedDate": "2020-09-14T14:04:10Z", "type": "commit"}, {"oid": "3386b43e52de5a0eae01ac3612c63e422300d293", "url": "https://github.com/bisq-network/bisq/commit/3386b43e52de5a0eae01ac3612c63e422300d293", "message": "Add GrpcDisputeAgentsService to GrpcServer", "committedDate": "2020-09-14T14:39:36Z", "type": "commit"}, {"oid": "304047eacaae2f95760d3b336a9d2affcc8bc4be", "url": "https://github.com/bisq-network/bisq/commit/304047eacaae2f95760d3b336a9d2affcc8bc4be", "message": "Create GrpcDisputeAgentsService stub", "committedDate": "2020-09-14T14:40:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxNjcxMw==", "url": "https://github.com/bisq-network/bisq/pull/4524#discussion_r489416713", "bodyText": "Both of these work the same at the moment, but it would be correct to use the specific manager depending on case. Better make a disputeAgentManager and set to whichever type is being registered, or just move the specific registration code to their switch cases.", "author": "sqrrm", "createdAt": "2020-09-16T12:59:31Z", "path": "core/src/main/java/bisq/core/api/CoreDisputeAgentsService.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.api;\n+\n+import bisq.core.support.dispute.mediation.mediator.Mediator;\n+import bisq.core.support.dispute.mediation.mediator.MediatorManager;\n+import bisq.core.support.dispute.refund.refundagent.RefundAgent;\n+import bisq.core.support.dispute.refund.refundagent.RefundAgentManager;\n+\n+import bisq.network.p2p.NodeAddress;\n+import bisq.network.p2p.P2PService;\n+\n+import bisq.common.config.Config;\n+import bisq.common.crypto.KeyRing;\n+\n+import org.bitcoinj.core.ECKey;\n+\n+import javax.inject.Inject;\n+\n+import java.net.InetAddress;\n+\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import static bisq.common.app.DevEnv.DEV_PRIVILEGE_PRIV_KEY;\n+\n+@Slf4j\n+class CoreDisputeAgentsService {\n+\n+    private final Config config;\n+    private final KeyRing keyRing;\n+    private final MediatorManager mediatorManager;\n+    private final RefundAgentManager refundAgentManager;\n+    private final P2PService p2PService;\n+\n+    @Inject\n+    public CoreDisputeAgentsService(Config config,\n+                                    KeyRing keyRing,\n+                                    MediatorManager mediatorManager,\n+                                    RefundAgentManager refundAgentManager,\n+                                    P2PService p2PService) {\n+        this.config = config;\n+        this.keyRing = keyRing;\n+        this.mediatorManager = mediatorManager;\n+        this.refundAgentManager = refundAgentManager;\n+        this.p2PService = p2PService;\n+    }\n+\n+    public void registerDisputeAgent(String disputeAgentType, String registrationKey) {\n+        if (!p2PService.isBootstrapped())\n+            throw new IllegalStateException(\"p2p service is not bootstrapped yet\");\n+\n+        if (config.baseCurrencyNetwork.isMainnet()\n+                || config.baseCurrencyNetwork.isDaoBetaNet()\n+                || !config.useLocalhostForP2P)\n+            throw new IllegalStateException(\"dispute agents must be registered in a Bisq UI\");\n+\n+        if (!registrationKey.equals(DEV_PRIVILEGE_PRIV_KEY))\n+            throw new IllegalArgumentException(\"invalid registration key\");\n+\n+        switch (disputeAgentType) {\n+            case \"arbitrator\":\n+                throw new IllegalArgumentException(\"arbitrators must be registered in a Bisq UI\");\n+            case \"mediator\":\n+            case \"refundagent\":\n+                NodeAddress nodeAddress = new NodeAddress(\n+                        InetAddress.getLoopbackAddress().getHostAddress(), config.nodePort);\n+                List<String> languageCodes = Arrays.asList(\"de\", \"en\", \"es\", \"fr\");\n+                ECKey ecKey = mediatorManager.getRegistrationKey(registrationKey);\n+                String signature = mediatorManager.signStorageSignaturePubKey(Objects.requireNonNull(ecKey));", "originalCommit": "304047eacaae2f95760d3b336a9d2affcc8bc4be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ3MzI5OQ==", "url": "https://github.com/bisq-network/bisq/pull/4524#discussion_r489473299", "bodyText": "A fix is in commit 57423f4.", "author": "ghubstan", "createdAt": "2020-09-16T14:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxNjcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxOTgzMg==", "url": "https://github.com/bisq-network/bisq/pull/4524#discussion_r489419832", "bodyText": "This is some ugly indentation, seems it's what we have specified as our standard though, and codacy agrees.", "author": "sqrrm", "createdAt": "2020-09-16T13:04:12Z", "path": "core/src/main/java/bisq/core/api/CoreDisputeAgentsService.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.api;\n+\n+import bisq.core.support.dispute.mediation.mediator.Mediator;\n+import bisq.core.support.dispute.mediation.mediator.MediatorManager;\n+import bisq.core.support.dispute.refund.refundagent.RefundAgent;\n+import bisq.core.support.dispute.refund.refundagent.RefundAgentManager;\n+\n+import bisq.network.p2p.NodeAddress;\n+import bisq.network.p2p.P2PService;\n+\n+import bisq.common.config.Config;\n+import bisq.common.crypto.KeyRing;\n+\n+import org.bitcoinj.core.ECKey;\n+\n+import javax.inject.Inject;\n+\n+import java.net.InetAddress;\n+\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import static bisq.common.app.DevEnv.DEV_PRIVILEGE_PRIV_KEY;\n+\n+@Slf4j\n+class CoreDisputeAgentsService {\n+\n+    private final Config config;\n+    private final KeyRing keyRing;\n+    private final MediatorManager mediatorManager;\n+    private final RefundAgentManager refundAgentManager;\n+    private final P2PService p2PService;\n+\n+    @Inject\n+    public CoreDisputeAgentsService(Config config,\n+                                    KeyRing keyRing,\n+                                    MediatorManager mediatorManager,\n+                                    RefundAgentManager refundAgentManager,\n+                                    P2PService p2PService) {\n+        this.config = config;\n+        this.keyRing = keyRing;\n+        this.mediatorManager = mediatorManager;\n+        this.refundAgentManager = refundAgentManager;\n+        this.p2PService = p2PService;\n+    }\n+\n+    public void registerDisputeAgent(String disputeAgentType, String registrationKey) {\n+        if (!p2PService.isBootstrapped())\n+            throw new IllegalStateException(\"p2p service is not bootstrapped yet\");\n+\n+        if (config.baseCurrencyNetwork.isMainnet()\n+                || config.baseCurrencyNetwork.isDaoBetaNet()\n+                || !config.useLocalhostForP2P)\n+            throw new IllegalStateException(\"dispute agents must be registered in a Bisq UI\");\n+\n+        if (!registrationKey.equals(DEV_PRIVILEGE_PRIV_KEY))\n+            throw new IllegalArgumentException(\"invalid registration key\");\n+\n+        switch (disputeAgentType) {\n+            case \"arbitrator\":\n+                throw new IllegalArgumentException(\"arbitrators must be registered in a Bisq UI\");\n+            case \"mediator\":\n+            case \"refundagent\":\n+                NodeAddress nodeAddress = new NodeAddress(\n+                        InetAddress.getLoopbackAddress().getHostAddress(), config.nodePort);\n+                List<String> languageCodes = Arrays.asList(\"de\", \"en\", \"es\", \"fr\");\n+                ECKey ecKey = mediatorManager.getRegistrationKey(registrationKey);\n+                String signature = mediatorManager.signStorageSignaturePubKey(Objects.requireNonNull(ecKey));\n+\n+                if (disputeAgentType.equals(\"mediator\"))\n+                    registerMediator(nodeAddress, languageCodes, ecKey, signature);\n+                else\n+                    registerRefundAgent(nodeAddress, languageCodes, ecKey, signature);\n+\n+                return;\n+            default:\n+                throw new IllegalArgumentException(\"unknown dispute agent type \" + disputeAgentType);\n+        }\n+    }\n+\n+    private void registerMediator(NodeAddress nodeAddress,\n+                                  List<String> languageCodes,\n+                                  ECKey ecKey,\n+                                  String signature) {\n+        Mediator mediator = new Mediator(\n+                nodeAddress,\n+                keyRing.getPubKeyRing(),\n+                languageCodes,\n+                new Date().getTime(),\n+                ecKey.getPubKey(),\n+                signature,\n+                null,\n+                null,\n+                null\n+        );\n+        mediatorManager.addDisputeAgent(mediator, () -> {\n+        }, errorMessage -> {", "originalCommit": "304047eacaae2f95760d3b336a9d2affcc8bc4be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ3NDMzOA==", "url": "https://github.com/bisq-network/bisq/pull/4524#discussion_r489474338", "bodyText": "I thought the same about the indentation in lines 117-119.", "author": "ghubstan", "createdAt": "2020-09-16T14:18:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxOTgzMg=="}], "type": "inlineReview"}, {"oid": "57423f4fdb16a8720ff245c44ac1126bd0ba8079", "url": "https://github.com/bisq-network/bisq/commit/57423f4fdb16a8720ff245c44ac1126bd0ba8079", "message": "Refactor to fix dispute agent mgr usage", "committedDate": "2020-09-16T14:14:30Z", "type": "commit"}]}