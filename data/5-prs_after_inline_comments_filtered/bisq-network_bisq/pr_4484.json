{"pr_number": 4484, "pr_title": "Scan disputes for accounts where same user used diff. real names.", "pr_createdAt": "2020-09-05T06:41:29Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4484", "timeline": [{"oid": "7c78e9819203b3c10c5b1af82f763115b99d4355", "url": "https://github.com/bisq-network/bisq/commit/7c78e9819203b3c10c5b1af82f763115b99d4355", "message": "Scan disputes for accounts where same user used diff. real names.\nMight be fraudulent traders.", "committedDate": "2020-09-05T06:40:35Z", "type": "commit"}, {"oid": "5a65b150febd4d1fb2d86d7d94f2ec175ef36537", "url": "https://github.com/bisq-network/bisq/commit/5a65b150febd4d1fb2d86d7d94f2ec175ef36537", "message": "Remove unused var", "committedDate": "2020-09-05T12:41:27Z", "type": "commit"}, {"oid": "4a4bd7cd126cd6b90770b8d1bf80a033fc655ce0", "url": "https://github.com/bisq-network/bisq/commit/4a4bd7cd126cd6b90770b8d1bf80a033fc655ce0", "message": "Add alert icon to list entries\n\nSupport agent can mark a suspicious dispute as resolved so it does not\nshow the alert icon anymore. In the full report a [ACK] got added to\nthat dispute.", "committedDate": "2020-09-05T22:39:22Z", "type": "commit"}, {"oid": "959009d6d66cdcf3cdd5fa5702cac6fe15330708", "url": "https://github.com/bisq-network/bisq/commit/959009d6d66cdcf3cdd5fa5702cac6fe15330708", "message": "Remove unused method", "committedDate": "2020-09-05T22:54:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5NDgxNA==", "url": "https://github.com/bisq-network/bisq/pull/4484#discussion_r484094814", "bodyText": "Isn't this also known in the next if statement, could just set true and false instead of isBuyer when adding to map.", "author": "sqrrm", "createdAt": "2020-09-06T17:27:03Z", "path": "core/src/main/java/bisq/core/support/dispute/agent/FraudDetection.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.support.dispute.agent;\n+\n+import bisq.core.locale.Res;\n+import bisq.core.payment.payload.PayloadWithHolderName;\n+import bisq.core.payment.payload.PaymentAccountPayload;\n+import bisq.core.support.dispute.Dispute;\n+import bisq.core.support.dispute.DisputeList;\n+import bisq.core.support.dispute.DisputeManager;\n+import bisq.core.trade.Contract;\n+\n+import bisq.common.crypto.Hash;\n+import bisq.common.crypto.PubKeyRing;\n+import bisq.common.util.Utilities;\n+\n+import javafx.collections.ListChangeListener;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.stream.Collectors;\n+\n+import lombok.Getter;\n+import lombok.Value;\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public class FraudDetection {\n+    public interface Listener {\n+        void onSuspiciousDisputeDetected();\n+    }\n+\n+    private final DisputeManager<? extends DisputeList<? extends DisputeList>> disputeManager;\n+    private Map<String, List<RealNameAccountInfo>> buyerRealNameAccountByAddressMap = new HashMap<>();\n+    private Map<String, List<RealNameAccountInfo>> sellerRealNameAccountByAddressMap = new HashMap<>();\n+    @Getter\n+    private Map<String, List<RealNameAccountInfo>> accountsUsingMultipleNames = new HashMap<>();\n+    private List<Listener> listeners = new CopyOnWriteArrayList<>();\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Constructor\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    public FraudDetection(DisputeManager<? extends DisputeList<? extends DisputeList>> disputeManager) {\n+        this.disputeManager = disputeManager;\n+\n+        disputeManager.getDisputesAsObservableList().addListener((ListChangeListener<Dispute>) c -> {\n+            c.next();\n+            if (c.wasAdded()) {\n+                checkForMultipleHolderNames();\n+            }\n+        });\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // API\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    public void checkForMultipleHolderNames() {\n+        log.error(\"checkForMultipleHolderNames\");\n+        buildRealNameAccountMaps();\n+        detectUsageOfDifferentUserNames();\n+        log.error(\"hasSuspiciousDisputeDetected() \" + hasSuspiciousDisputeDetected());\n+    }\n+\n+    public boolean hasSuspiciousDisputeDetected() {\n+        return !accountsUsingMultipleNames.isEmpty();\n+    }\n+\n+    public String getAccountsUsingMultipleNamesAsString() {\n+        return accountsUsingMultipleNames.entrySet().stream()\n+                .map(entry -> {\n+                    String pubKeyHash = entry.getKey();\n+                    String accountInfo = entry.getValue().stream()\n+                            .map(info -> {\n+                                String tradeId = info.getDispute().getShortTradeId();\n+                                String holderName = info.getPayloadWithHolderName().getHolderName();\n+                                return \"    Account owner name: '\" + holderName +\n+                                        \"'; Trade ID: '\" + tradeId +\n+                                        \"'; Address: '\" + info.getAddress() +\n+                                        \"'; Payment method: '\" + Res.get(info.getPaymentAccountPayload().getPaymentMethodId()) +\n+                                        \"'; Role: \" + (info.isBuyer() ? \"'Buyer'\" : \"'Seller'\");\n+\n+                            })\n+                            .collect(Collectors.joining(\"\\n\"));\n+                    return \"Trader with multiple identities:\\n\" +\n+                            accountInfo;\n+                })\n+                .collect(Collectors.joining(\"\\n\\n\"));\n+    }\n+\n+    public void addListener(Listener listener) {\n+        listeners.add(listener);\n+    }\n+\n+    public void removeListener(Listener listener) {\n+        listeners.remove(listener);\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Private\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    private void buildRealNameAccountMaps() {\n+        buyerRealNameAccountByAddressMap.clear();\n+        sellerRealNameAccountByAddressMap.clear();\n+        disputeManager.getDisputesAsObservableList()\n+                .forEach(dispute -> {\n+                    Contract contract = dispute.getContract();\n+                    PubKeyRing traderPubKeyRing = dispute.getTraderPubKeyRing();\n+                    String traderPubKeyHash = getTraderPuKeyHash(traderPubKeyRing);\n+                    String buyerPubKeyHash = getTraderPuKeyHash(contract.getBuyerPubKeyRing());\n+                    boolean isBuyer = contract.isMyRoleBuyer(traderPubKeyRing);", "originalCommit": "7c78e9819203b3c10c5b1af82f763115b99d4355", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEzOTc2NA==", "url": "https://github.com/bisq-network/bisq/pull/4484#discussion_r484139764", "bodyText": "I think you reviewed an older version, not in current version anymore.", "author": "chimp1984", "createdAt": "2020-09-07T01:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5NDgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMxMzUyOQ==", "url": "https://github.com/bisq-network/bisq/pull/4484#discussion_r484313529", "bodyText": "Yeah, started with first commit, then everything changed and I didn't remove this comment.", "author": "sqrrm", "createdAt": "2020-09-07T09:34:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5NDgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5NTI5MQ==", "url": "https://github.com/bisq-network/bisq/pull/4484#discussion_r484095291", "bodyText": "Better to return early instead of big if blocks.", "author": "sqrrm", "createdAt": "2020-09-06T17:32:21Z", "path": "core/src/main/java/bisq/core/support/dispute/agent/FraudDetection.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.support.dispute.agent;\n+\n+import bisq.core.locale.Res;\n+import bisq.core.payment.payload.PayloadWithHolderName;\n+import bisq.core.payment.payload.PaymentAccountPayload;\n+import bisq.core.support.dispute.Dispute;\n+import bisq.core.support.dispute.DisputeList;\n+import bisq.core.support.dispute.DisputeManager;\n+import bisq.core.trade.Contract;\n+\n+import bisq.common.crypto.Hash;\n+import bisq.common.crypto.PubKeyRing;\n+import bisq.common.util.Utilities;\n+\n+import javafx.collections.ListChangeListener;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.stream.Collectors;\n+\n+import lombok.Getter;\n+import lombok.Value;\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public class FraudDetection {\n+    public interface Listener {\n+        void onSuspiciousDisputeDetected();\n+    }\n+\n+    private final DisputeManager<? extends DisputeList<? extends DisputeList>> disputeManager;\n+    private Map<String, List<RealNameAccountInfo>> buyerRealNameAccountByAddressMap = new HashMap<>();\n+    private Map<String, List<RealNameAccountInfo>> sellerRealNameAccountByAddressMap = new HashMap<>();\n+    @Getter\n+    private Map<String, List<RealNameAccountInfo>> accountsUsingMultipleNames = new HashMap<>();\n+    private List<Listener> listeners = new CopyOnWriteArrayList<>();\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Constructor\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    public FraudDetection(DisputeManager<? extends DisputeList<? extends DisputeList>> disputeManager) {\n+        this.disputeManager = disputeManager;\n+\n+        disputeManager.getDisputesAsObservableList().addListener((ListChangeListener<Dispute>) c -> {\n+            c.next();\n+            if (c.wasAdded()) {\n+                checkForMultipleHolderNames();\n+            }\n+        });\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // API\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    public void checkForMultipleHolderNames() {\n+        log.error(\"checkForMultipleHolderNames\");\n+        buildRealNameAccountMaps();\n+        detectUsageOfDifferentUserNames();\n+        log.error(\"hasSuspiciousDisputeDetected() \" + hasSuspiciousDisputeDetected());\n+    }\n+\n+    public boolean hasSuspiciousDisputeDetected() {\n+        return !accountsUsingMultipleNames.isEmpty();\n+    }\n+\n+    public String getAccountsUsingMultipleNamesAsString() {\n+        return accountsUsingMultipleNames.entrySet().stream()\n+                .map(entry -> {\n+                    String pubKeyHash = entry.getKey();\n+                    String accountInfo = entry.getValue().stream()\n+                            .map(info -> {\n+                                String tradeId = info.getDispute().getShortTradeId();\n+                                String holderName = info.getPayloadWithHolderName().getHolderName();\n+                                return \"    Account owner name: '\" + holderName +\n+                                        \"'; Trade ID: '\" + tradeId +\n+                                        \"'; Address: '\" + info.getAddress() +\n+                                        \"'; Payment method: '\" + Res.get(info.getPaymentAccountPayload().getPaymentMethodId()) +\n+                                        \"'; Role: \" + (info.isBuyer() ? \"'Buyer'\" : \"'Seller'\");\n+\n+                            })\n+                            .collect(Collectors.joining(\"\\n\"));\n+                    return \"Trader with multiple identities:\\n\" +\n+                            accountInfo;\n+                })\n+                .collect(Collectors.joining(\"\\n\\n\"));\n+    }\n+\n+    public void addListener(Listener listener) {\n+        listeners.add(listener);\n+    }\n+\n+    public void removeListener(Listener listener) {\n+        listeners.remove(listener);\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Private\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    private void buildRealNameAccountMaps() {\n+        buyerRealNameAccountByAddressMap.clear();\n+        sellerRealNameAccountByAddressMap.clear();\n+        disputeManager.getDisputesAsObservableList()\n+                .forEach(dispute -> {\n+                    Contract contract = dispute.getContract();\n+                    PubKeyRing traderPubKeyRing = dispute.getTraderPubKeyRing();\n+                    String traderPubKeyHash = getTraderPuKeyHash(traderPubKeyRing);\n+                    String buyerPubKeyHash = getTraderPuKeyHash(contract.getBuyerPubKeyRing());\n+                    boolean isBuyer = contract.isMyRoleBuyer(traderPubKeyRing);\n+\n+                    if (buyerPubKeyHash.equals(traderPubKeyHash)) {\n+                        PaymentAccountPayload buyerPaymentAccountPayload = contract.getBuyerPaymentAccountPayload();\n+                        String buyersAddress = contract.getBuyerNodeAddress().getFullAddress();\n+                        addToMap(traderPubKeyHash, buyerRealNameAccountByAddressMap, buyerPaymentAccountPayload, buyersAddress, dispute, isBuyer);\n+                    } else {\n+                        PaymentAccountPayload sellerPaymentAccountPayload = contract.getSellerPaymentAccountPayload();\n+                        String sellerAddress = contract.getSellerNodeAddress().getFullAddress();\n+                        addToMap(traderPubKeyHash, sellerRealNameAccountByAddressMap, sellerPaymentAccountPayload, sellerAddress, dispute, isBuyer);\n+                    }\n+                });\n+    }\n+\n+    private String getTraderPuKeyHash(PubKeyRing pubKeyRing) {\n+        return Utilities.encodeToHex(Hash.getRipemd160hash(pubKeyRing.toProtoMessage().toByteArray()));\n+    }\n+\n+    private void addToMap(String pubKeyHash, Map<String, List<RealNameAccountInfo>> map,\n+                          PaymentAccountPayload paymentAccountPayload,\n+                          String address,\n+                          Dispute dispute,\n+                          boolean isBuyer) {\n+        if (paymentAccountPayload instanceof PayloadWithHolderName) {", "originalCommit": "7c78e9819203b3c10c5b1af82f763115b99d4355", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE0MDY1MA==", "url": "https://github.com/bisq-network/bisq/pull/4484#discussion_r484140650", "bodyText": "I will use a stream filter in a new PR...", "author": "chimp1984", "createdAt": "2020-09-07T01:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5NTI5MQ=="}], "type": "inlineReview"}]}