{"pr_number": 4568, "pr_title": "Add segwit support to the BTC wallet", "pr_createdAt": "2020-09-29T00:24:21Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4568", "timeline": [{"oid": "b6462cf6031c44305454ef58f14b60e455027556", "url": "https://github.com/bisq-network/bisq/commit/b6462cf6031c44305454ef58f14b60e455027556", "message": "Remove unused import", "committedDate": "2020-09-29T14:31:40Z", "type": "forcePushed"}, {"oid": "f09d829523003bc38f4dbb1b838247fa858b19f9", "url": "https://github.com/bisq-network/bisq/commit/f09d829523003bc38f4dbb1b838247fa858b19f9", "message": "Enable reusing unused AVAILABLE entries", "committedDate": "2020-10-01T15:17:17Z", "type": "forcePushed"}, {"oid": "40d67ba19496c2baa1d14504143e49b1b0fac446", "url": "https://github.com/bisq-network/bisq/commit/40d67ba19496c2baa1d14504143e49b1b0fac446", "message": "Enable reusing unused AVAILABLE entries", "committedDate": "2020-10-01T16:04:44Z", "type": "forcePushed"}, {"oid": "a4b8b086c9b8774c66735ec082c82b65298d561e", "url": "https://github.com/bisq-network/bisq/commit/a4b8b086c9b8774c66735ec082c82b65298d561e", "message": "Make codacy happy", "committedDate": "2020-10-01T19:56:32Z", "type": "forcePushed"}, {"oid": "778a7aaa47ca164867e3cad779ceaebf7b485aaa", "url": "https://github.com/bisq-network/bisq/commit/778a7aaa47ca164867e3cad779ceaebf7b485aaa", "message": "Make codacy happy", "committedDate": "2020-10-02T13:46:14Z", "type": "forcePushed"}, {"oid": "d1e3e0977209b51d11314f81787161cafdc2dbb9", "url": "https://github.com/bisq-network/bisq/commit/d1e3e0977209b51d11314f81787161cafdc2dbb9", "message": "Make codacy happy", "committedDate": "2020-10-05T15:49:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2MDAzOA==", "url": "https://github.com/bisq-network/bisq/pull/4568#discussion_r499760038", "bodyText": "Is that never called from a trade protocol entry? e.g. the one for the multisig.", "author": "chimp1984", "createdAt": "2020-10-05T17:30:48Z", "path": "core/src/main/java/bisq/core/btc/wallet/BtcWalletService.java", "diffHunk": "@@ -584,23 +584,13 @@ public AddressEntry getOrCreateAddressEntry(String offerId, AddressEntry.Context\n             if (emptyAvailableAddressEntry.isPresent()) {\n                 return addressEntryList.swapAvailableToAddressEntryWithOfferId(emptyAvailableAddressEntry.get(), context, offerId);\n             } else {\n-                AddressEntry entry = new AddressEntry(wallet.freshReceiveKey(), context, offerId);\n+                AddressEntry entry = new AddressEntry(wallet.freshReceiveKey(), context, offerId, true);", "originalCommit": "5f2416aecf7cadeef473bb610cfc9448daaa749d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg3OTU1OA==", "url": "https://github.com/bisq-network/bisq/pull/4568#discussion_r499879558", "bodyText": "It seems you commented on outdated code.", "author": "oscarguindzberg", "createdAt": "2020-10-05T21:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2MDAzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2MzM5NQ==", "url": "https://github.com/bisq-network/bisq/pull/4568#discussion_r499763395", "bodyText": "Instead of depositTx.getInputs().size()-1) I would suggest to make a local var from the getTransactionInput(depositTx, getMakersScriptSigProgram(transactionInput), buyerInputs.get(i)) we add earlier so its more clear. Maybe even do the check before adding, technically no difference but somehow more clean if the input gets completely defined before added.", "author": "chimp1984", "createdAt": "2020-10-05T17:37:09Z", "path": "core/src/main/java/bisq/core/btc/wallet/TradeWalletService.java", "diffHunk": "@@ -601,6 +603,9 @@ public Transaction takerSignsDepositTx(boolean takerIsSeller,\n             for (int i = 0; i < buyerInputs.size(); i++) {\n                 TransactionInput transactionInput = makersDepositTx.getInputs().get(i);\n                 depositTx.addInput(getTransactionInput(depositTx, getMakersScriptSigProgram(transactionInput), buyerInputs.get(i)));\n+                if (!TransactionWitness.EMPTY.equals(transactionInput.getWitness())) {\n+                    depositTx.getInput(depositTx.getInputs().size()-1).setWitness(transactionInput.getWitness());", "originalCommit": "6c28ff3d28de4e2e621ec63c4826f6e034d2239f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2NTA0NQ==", "url": "https://github.com/bisq-network/bisq/pull/4568#discussion_r499765045", "bodyText": "As we do not support now segwit in the trade process, is that change needed at all? I dont see a risk to have it there but maybe better to leave all that out until we start adding segwit support to the trade protocol? Not sure if you started already in more pleaces to add support which do not interfere (as we discussed it is our strategy to add as much as possible without activating segwit in trade protocol...), so if you have started that process already all find, otherwise if its a single change it would be maybe more clear to start after the release with that process...", "author": "chimp1984", "createdAt": "2020-10-05T17:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2MzM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg3Nzg2MA==", "url": "https://github.com/bisq-network/bisq/pull/4568#discussion_r499877860", "bodyText": "You seem to be right. In any case, it causes no harm.", "author": "oscarguindzberg", "createdAt": "2020-10-05T21:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2MzM5NQ=="}], "type": "inlineReview"}, {"oid": "4fabbdf356ff58ad0f71377342e7f24bbeaa45e0", "url": "https://github.com/bisq-network/bisq/commit/4fabbdf356ff58ad0f71377342e7f24bbeaa45e0", "message": "Do a backup of the wallet before segwit migration", "committedDate": "2020-10-08T19:25:41Z", "type": "forcePushed"}, {"oid": "f13a7b164cebf632d198be65aa2f4ad746c993fc", "url": "https://github.com/bisq-network/bisq/commit/f13a7b164cebf632d198be65aa2f4ad746c993fc", "message": "Create a P2WPKH keychain for new btc wallets", "committedDate": "2020-10-08T19:33:48Z", "type": "commit"}, {"oid": "cd286600697f6cffc76ea9b84b0f6b6d3fe4e041", "url": "https://github.com/bisq-network/bisq/commit/cd286600697f6cffc76ea9b84b0f6b6d3fe4e041", "message": "Add a P2WPKH keychain for existing wallets", "committedDate": "2020-10-08T19:33:49Z", "type": "commit"}, {"oid": "ced357ce258a1538b592b5f00e703eab12619e1e", "url": "https://github.com/bisq-network/bisq/commit/ced357ce258a1538b592b5f00e703eab12619e1e", "message": "AddressEntry: Add boolean segwit flag", "committedDate": "2020-10-08T19:33:49Z", "type": "commit"}, {"oid": "e85c66b8103940975ae3562110c5ea50137fc368", "url": "https://github.com/bisq-network/bisq/commit/e85c66b8103940975ae3562110c5ea50137fc368", "message": "Stop using LegacyAddress for btc addresses", "committedDate": "2020-10-08T19:33:49Z", "type": "commit"}, {"oid": "0c7f3456b6561811cc1c5f3a90b39f5ce9a3733b", "url": "https://github.com/bisq-network/bisq/commit/0c7f3456b6561811cc1c5f3a90b39f5ce9a3733b", "message": "Fix log msg in BtcCoinSelector", "committedDate": "2020-10-08T19:33:50Z", "type": "commit"}, {"oid": "0f4c66f43d723f597e9646479d3776419681dc7e", "url": "https://github.com/bisq-network/bisq/commit/0f4c66f43d723f597e9646479d3776419681dc7e", "message": "Comment out segwit BSQ account path\n\nSegwit is not used for BSQ", "committedDate": "2020-10-08T19:33:50Z", "type": "commit"}, {"oid": "25515710ab724203690de8d7057d7bbd6903a094", "url": "https://github.com/bisq-network/bisq/commit/25515710ab724203690de8d7057d7bbd6903a094", "message": "TradeWalletService: adapt to segwit wallet", "committedDate": "2020-10-08T19:33:51Z", "type": "commit"}, {"oid": "d8b755794e2d7e0fb2e541a5635d35c138c8ff6f", "url": "https://github.com/bisq-network/bisq/commit/d8b755794e2d7e0fb2e541a5635d35c138c8ff6f", "message": "WalletService: adapt to segwit wallet", "committedDate": "2020-10-08T19:33:51Z", "type": "commit"}, {"oid": "a3708485f950912d18a9d62c992d35c9e175e90c", "url": "https://github.com/bisq-network/bisq/commit/a3708485f950912d18a9d62c992d35c9e175e90c", "message": "New AddressEntry: use different script types\n\nUse P2WPKH for AVAILABLE context and P2PKH for the rest.\nDisable reusing unused AVAILABLE entries until segwit support is\nmandatory in Bisq.", "committedDate": "2020-10-08T19:33:51Z", "type": "commit"}, {"oid": "a9cc28f65a701288097fe166d6b68ace0a75574c", "url": "https://github.com/bisq-network/bisq/commit/a9cc28f65a701288097fe166d6b68ace0a75574c", "message": "AddressEntryList: arbitrator entry use P2PKH", "committedDate": "2020-10-08T19:33:52Z", "type": "commit"}, {"oid": "f9f5d92941c49ecc24949c4b20b6b4c70de69729", "url": "https://github.com/bisq-network/bisq/commit/f9f5d92941c49ecc24949c4b20b6b4c70de69729", "message": "Add segwit/legacy checbox for address creation", "committedDate": "2020-10-08T19:33:52Z", "type": "commit"}, {"oid": "1f3c585c350320be1547bb7b47963b385dad736d", "url": "https://github.com/bisq-network/bisq/commit/1f3c585c350320be1547bb7b47963b385dad736d", "message": "Serialize tx without segwit\n\nThis is for backwards compatibility with bisq nodes that have not\nupgraded to bitcoinj 0.15.", "committedDate": "2020-10-08T19:33:52Z", "type": "commit"}, {"oid": "58afc00282d26fc0d8f92937b4fb955f31a269d4", "url": "https://github.com/bisq-network/bisq/commit/58afc00282d26fc0d8f92937b4fb955f31a269d4", "message": "Don't create an extra address at startup", "committedDate": "2020-10-08T19:33:53Z", "type": "commit"}, {"oid": "e2f74f025093ed2bfa71cf5d0b7922691f435484", "url": "https://github.com/bisq-network/bisq/commit/e2f74f025093ed2bfa71cf5d0b7922691f435484", "message": "Don't create a wallet address when not needed", "committedDate": "2020-10-08T19:33:53Z", "type": "commit"}, {"oid": "d1aeedd98b9eec683202b6210511fa5ce87cae0d", "url": "https://github.com/bisq-network/bisq/commit/d1aeedd98b9eec683202b6210511fa5ce87cae0d", "message": "Remove unused WalletService.findKeyFromPubKeyHash()", "committedDate": "2020-10-08T19:33:53Z", "type": "commit"}, {"oid": "78a2a43d48cea65688e0946c8b8bac3ebac66fc3", "url": "https://github.com/bisq-network/bisq/commit/78a2a43d48cea65688e0946c8b8bac3ebac66fc3", "message": "Remove unused import", "committedDate": "2020-10-08T19:33:54Z", "type": "commit"}, {"oid": "01455d2b209cc49a4f3688add3e481422c1bb3a2", "url": "https://github.com/bisq-network/bisq/commit/01455d2b209cc49a4f3688add3e481422c1bb3a2", "message": "Enable reusing unused AVAILABLE entries", "committedDate": "2020-10-08T19:33:54Z", "type": "commit"}, {"oid": "4a2c0ad75a8b49748b687f7171281d189b333d37", "url": "https://github.com/bisq-network/bisq/commit/4a2c0ad75a8b49748b687f7171281d189b333d37", "message": "Make codacy happy", "committedDate": "2020-10-08T19:33:54Z", "type": "commit"}, {"oid": "86ddd06e276f02cd07a137214b851666926acc69", "url": "https://github.com/bisq-network/bisq/commit/86ddd06e276f02cd07a137214b851666926acc69", "message": "Validate AddressEntry.segwit", "committedDate": "2020-10-08T19:33:55Z", "type": "commit"}, {"oid": "b9e404f0e25a8d14fd57eecea1850e97f7f5cc65", "url": "https://github.com/bisq-network/bisq/commit/b9e404f0e25a8d14fd57eecea1850e97f7f5cc65", "message": "Make it clear segwit is not used for the trade protocol yet.", "committedDate": "2020-10-08T19:33:55Z", "type": "commit"}, {"oid": "5524ba3e97d98f7f4559625ee1e83307596f1efe", "url": "https://github.com/bisq-network/bisq/commit/5524ba3e97d98f7f4559625ee1e83307596f1efe", "message": "BtcWalletService.getFreshAddressEntry(): code clean up", "committedDate": "2020-10-08T19:33:55Z", "type": "commit"}, {"oid": "d1aaf3e4eb9770d6a551001428e2599aa0616f61", "url": "https://github.com/bisq-network/bisq/commit/d1aaf3e4eb9770d6a551001428e2599aa0616f61", "message": "Construct dummy outputs with LegacyAddress", "committedDate": "2020-10-08T19:33:56Z", "type": "commit"}, {"oid": "3554e190842d100d2fb9f111a9219fea75024231", "url": "https://github.com/bisq-network/bisq/commit/3554e190842d100d2fb9f111a9219fea75024231", "message": "setWitness(): Code clean up", "committedDate": "2020-10-08T19:33:56Z", "type": "commit"}, {"oid": "499d7b7d35683b4f0747e9a674887c9329cc08c3", "url": "https://github.com/bisq-network/bisq/commit/499d7b7d35683b4f0747e9a674887c9329cc08c3", "message": "Use try-with-resources", "committedDate": "2020-10-08T19:33:56Z", "type": "commit"}, {"oid": "1d82c01670ba2943ef700d2e4116a0f649eb1b46", "url": "https://github.com/bisq-network/bisq/commit/1d82c01670ba2943ef700d2e4116a0f649eb1b46", "message": "Improve error handling for P2WPKH", "committedDate": "2020-10-08T19:33:57Z", "type": "commit"}, {"oid": "694446c296466904aa748f45db78b73d854d7d1e", "url": "https://github.com/bisq-network/bisq/commit/694446c296466904aa748f45db78b73d854d7d1e", "message": "Switch back to LegacyAddress for fee estimation", "committedDate": "2020-10-08T19:33:57Z", "type": "commit"}, {"oid": "a747e83211492a8d10ef4ce59d3c4cab99074948", "url": "https://github.com/bisq-network/bisq/commit/a747e83211492a8d10ef4ce59d3c4cab99074948", "message": "Fix add segwit keychain for encrypted wallet", "committedDate": "2020-10-08T19:33:57Z", "type": "commit"}, {"oid": "417daf56926c9f6a4c65dc0adfad473712ea0ddb", "url": "https://github.com/bisq-network/bisq/commit/417daf56926c9f6a4c65dc0adfad473712ea0ddb", "message": "Use bitcoinj 0.15.8 (commit a733034)", "committedDate": "2020-10-08T19:33:58Z", "type": "commit"}, {"oid": "87da2ae349cee0d7733adbfbe290cc38dfc0e657", "url": "https://github.com/bisq-network/bisq/commit/87da2ae349cee0d7733adbfbe290cc38dfc0e657", "message": "Do a backup of the wallet before segwit migration", "committedDate": "2020-10-08T19:33:58Z", "type": "commit"}, {"oid": "87da2ae349cee0d7733adbfbe290cc38dfc0e657", "url": "https://github.com/bisq-network/bisq/commit/87da2ae349cee0d7733adbfbe290cc38dfc0e657", "message": "Do a backup of the wallet before segwit migration", "committedDate": "2020-10-08T19:33:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4NDM3MA==", "url": "https://github.com/bisq-network/bisq/pull/4568#discussion_r501984370", "bodyText": "I think we should add a if(newValue) to make it more clear/safe. As we change only once from false to true it would not matter but feels more correct.", "author": "chimp1984", "createdAt": "2020-10-08T20:10:50Z", "path": "core/src/main/java/bisq/core/btc/setup/WalletConfig.java", "diffHunk": "@@ -293,25 +301,34 @@ protected void startUp() throws Exception {\n             vPeerGroup.addWallet(vBsqWallet);\n             onSetupCompleted();\n \n-            Futures.addCallback((ListenableFuture<?>) vPeerGroup.startAsync(), new FutureCallback<Object>() {\n-                @Override\n-                public void onSuccess(@Nullable Object result) {\n-                    //completeExtensionInitiations(vPeerGroup);\n-                    DownloadProgressTracker tracker = downloadListener == null ? new DownloadProgressTracker() : downloadListener;\n-                    vPeerGroup.startBlockChainDownload(tracker);\n-                }\n-\n-                @Override\n-                public void onFailure(Throwable t) {\n-                    throw new RuntimeException(t);\n+            if (migratedWalletToSegwit.get()) {\n+                startPeerGroup();\n+            } else {\n+                migratedWalletToSegwit.addListener((observable, oldValue, newValue) -> startPeerGroup());", "originalCommit": "a747e83211492a8d10ef4ce59d3c4cab99074948", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5MjQ4NA==", "url": "https://github.com/bisq-network/bisq/pull/4568#discussion_r501992484", "bodyText": "Fixed 261e0ec", "author": "oscarguindzberg", "createdAt": "2020-10-08T20:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4NDM3MA=="}], "type": "inlineReview"}, {"oid": "261e0ec714027be657ba7d1125ac65bd81b0135f", "url": "https://github.com/bisq-network/bisq/commit/261e0ec714027be657ba7d1125ac65bd81b0135f", "message": "Check migratedWalletToSegwit is true", "committedDate": "2020-10-08T20:26:24Z", "type": "commit"}]}