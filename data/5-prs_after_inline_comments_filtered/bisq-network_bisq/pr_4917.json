{"pr_number": 4917, "pr_title": "Detect and handle invalid maker fee tx", "pr_createdAt": "2020-12-08T20:46:55Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4917", "timeline": [{"oid": "960b835f3fbf08e672e636cfe0cf157e84b623c6", "url": "https://github.com/bisq-network/bisq/commit/960b835f3fbf08e672e636cfe0cf157e84b623c6", "message": "Check if maker fee tx is already spent or has invalid structure.\nIf so show popup to remove that offer.\nAdd maker fee tx ix to offer details window.\nIf invalid, add error msg to offer details window.", "committedDate": "2020-12-08T20:45:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNjM1OQ==", "url": "https://github.com/bisq-network/bisq/pull/4917#discussion_r539106359", "bodyText": "Maybe it would be easier to read if that is used as the else branch for line 421, as this is the only case where errorMsg can be null.", "author": "ripcurlx", "createdAt": "2020-12-09T08:33:02Z", "path": "core/src/main/java/bisq/core/offer/OfferUtil.java", "diffHunk": "@@ -383,4 +387,53 @@ public void validateOfferData(double buyerSecurityDeposit,\n             return Optional.empty();\n         }\n     }\n+\n+    public static Optional<String> getInvalidMakerFeeTxErrorMessage(Offer offer, BtcWalletService btcWalletService) {\n+        Transaction makerFeeTx = btcWalletService.getTransaction(offer.getOfferFeePaymentTxId());\n+        if (makerFeeTx == null) {\n+            return Optional.empty();\n+        }\n+\n+        String errorMsg = null;\n+        String header = \"The offer with offer ID '\" + offer.getShortId() +\n+                \"' has an invalid maker fee transaction.\\n\\n\";\n+        String spendingTransaction = null;\n+        String extraString = \"\\nYou have to remove that offer to avoid failed trades.\\n\" +\n+                \"If this happened because of a bug please contact the Bisq developers \" +\n+                \"and you can request reimbursement for the lost maker fee.\";\n+        if (makerFeeTx.getOutputs().size() > 1) {\n+            // Our output to fund the deposit tx is at index 1\n+            TransactionOutput output = makerFeeTx.getOutput(1);\n+            TransactionInput spentByTransactionInput = output.getSpentBy();\n+            if (spentByTransactionInput != null) {\n+                spendingTransaction = spentByTransactionInput.getConnectedTransaction() != null ?\n+                        spentByTransactionInput.getConnectedTransaction().toString() :\n+                        \"null\";\n+                // We this is an exceptional case we do not translate that error msg.\n+                errorMsg = \"The output of the maker fee tx is already spent.\\n\" +\n+                        extraString +\n+                        \"\\n\\nTransaction input which spent the reserved funds for that offer: '\" +\n+                        spentByTransactionInput.getConnectedTransaction().getTxId().toString() + \":\" +\n+                        (spentByTransactionInput.getConnectedOutput() != null ?\n+                                spentByTransactionInput.getConnectedOutput().getIndex() + \"'\" :\n+                                \"null'\");\n+                log.error(\"spentByTransactionInput {}\", spentByTransactionInput);\n+            }\n+        } else {\n+            errorMsg = \"The maker fee tx is invalid as it does not has at least 2 outputs.\" + extraString +\n+                    \"\\nMakerFeeTx=\" + makerFeeTx.toString();\n+        }\n+\n+        if (errorMsg == null) {\n+            return Optional.empty();\n+        }", "originalCommit": "960b835f3fbf08e672e636cfe0cf157e84b623c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}