{"pr_number": 4097, "pr_title": "Remove read stdin loop", "pr_createdAt": "2020-03-27T15:40:00Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4097", "timeline": [{"oid": "94ee49c5afdc0262dc888e58b4fcf572975307cd", "url": "https://github.com/bisq-network/bisq/commit/94ee49c5afdc0262dc888e58b4fcf572975307cd", "message": "Remove read stdin loop\n\nReplaced the Scanner input read loop with upgraded joptsimple\ndependency. Cli now takes a single, non-option program argument, runs\nit and exits.  Also removed the \"stop client\" command because there is\nno input loop, but shutdown() is called for orderly channel shudown\nbefore the jvm terminates.  Also changed cmd syntax from camel case\nto lowercase, mimicking bitcoin-cli.\n\nConfigured logback to supress all debug & info level netty output, and\nbypassed logback to print results to System.out.", "committedDate": "2020-03-27T15:27:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMjAwMw==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400002003", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final OptionParser cmdParser;\n          \n          \n            \n                private final OptionParser parser;", "author": "cbeams", "createdAt": "2020-03-30T08:10:45Z", "path": "cli/src/main/java/bisq/cli/app/BisqCliMain.java", "diffHunk": "@@ -41,60 +45,28 @@\n \n     private final ManagedChannel channel;\n     private final CliCommand cmd;\n+    private final OptionParser cmdParser;", "originalCommit": "94ee49c5afdc0262dc888e58b4fcf572975307cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNDQzMA==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400004430", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    new BisqCliMain(\"localhost\", 8888, args);\n          \n          \n            \n                    new BisqCliMain(\"localhost\", 9998, args);\n          \n      \n    \n    \n  \n\n8888 is a poor number as it's frequently used by other services. 9998 fits with bisq's p2p port of 9999 and follows suit with bitcoind's 8333 p2p port and 8332 rpc port. I realize you did not introduce this change and that it's somewhat out of scope for this PR, but please make it anyway.\n@freimair, please note that the choice of 9998 here overlaps with the same port used in monitor/src/main/java/bisq/monitor/metric/TorHiddenServiceStartupTime.java. Please consider changing that to something else if you see it being a conflict.", "author": "cbeams", "createdAt": "2020-03-30T08:14:49Z", "path": "cli/src/main/java/bisq/cli/app/BisqCliMain.java", "diffHunk": "@@ -41,60 +45,28 @@\n \n     private final ManagedChannel channel;\n     private final CliCommand cmd;\n+    private final OptionParser cmdParser;\n \n     public static void main(String[] args) {\n-        new BisqCliMain(\"localhost\", 8888);\n+        new BisqCliMain(\"localhost\", 8888, args);", "originalCommit": "94ee49c5afdc0262dc888e58b4fcf572975307cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI1MzIyNQ==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400253225", "bodyText": "BisqGrpcServer now listens on port 9998.", "author": "ghubstan", "createdAt": "2020-03-30T14:49:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNDQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2MDE3MQ==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400260171", "bodyText": "A reminder to @freimair, re TorHiddenServiceStartupTime\nint localPort = Integer.parseInt(configuration.getProperty(LOCAL_PORT, \"9998\"));\nint servicePort = Integer.parseInt(configuration.getProperty(SERVICE_PORT, \"9999\"));\n\nnow conflicts with the BisqGrpcServer listening port 9998 in this remove-read-stdin-loop branch (not merged).   I am sure I should not be changing server + listening ports in TorHiddenServiceStartupTime.", "author": "ghubstan", "createdAt": "2020-03-30T14:58:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNDQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg3NDQ1MQ==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400874451", "bodyText": "I do not think so. the monitor is quite separate from everything else, plus, this is a default fallback value - it can and should be configured via the monitors properties file.", "author": "freimair", "createdAt": "2020-03-31T12:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNDQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNDcyOQ==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400004729", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private BisqCliMain(String host, int port, String[] params) {\n          \n          \n            \n                private BisqCliMain(String host, int port, String[] args) {\n          \n      \n    \n    \n  \n\nFor consistency and conventionality.", "author": "cbeams", "createdAt": "2020-03-30T08:15:18Z", "path": "cli/src/main/java/bisq/cli/app/BisqCliMain.java", "diffHunk": "@@ -41,60 +45,28 @@\n \n     private final ManagedChannel channel;\n     private final CliCommand cmd;\n+    private final OptionParser cmdParser;\n \n     public static void main(String[] args) {\n-        new BisqCliMain(\"localhost\", 8888);\n+        new BisqCliMain(\"localhost\", 8888, args);\n     }\n \n-    private BisqCliMain(String host, int port) {\n+    private BisqCliMain(String host, int port, String[] params) {", "originalCommit": "94ee49c5afdc0262dc888e58b4fcf572975307cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNTE4NA==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400005184", "bodyText": "Please remove this.", "author": "cbeams", "createdAt": "2020-03-30T08:16:01Z", "path": "cli/src/main/java/bisq/cli/app/BisqCliMain.java", "diffHunk": "@@ -41,60 +45,28 @@\n \n     private final ManagedChannel channel;\n     private final CliCommand cmd;\n+    private final OptionParser cmdParser;\n \n     public static void main(String[] args) {\n-        new BisqCliMain(\"localhost\", 8888);\n+        new BisqCliMain(\"localhost\", 8888, args);\n     }\n \n-    private BisqCliMain(String host, int port) {\n+    private BisqCliMain(String host, int port, String[] params) {\n         // Channels are secure by default (via SSL/TLS);  for the example disable TLS to avoid needing certificates.\n         this(ManagedChannelBuilder.forAddress(host, port).usePlaintext().build());\n \n-        // Simple input scanner\n-        // TODO use some more sophisticated input processing with validation....\n-        try (Scanner scanner = new Scanner(in)) {\n-            while (true) {\n-                long startTs = currentTimeMillis();\n-\n-                String[] tokens = scanner.nextLine().split(\" \");\n-                if (tokens.length == 0) {\n-                    return;\n-                }\n-                String command = tokens[0];\n-                if (tokens.length > 1) {\n-                    List<String> params = new ArrayList<>(Arrays.asList(tokens));\n-                    params.remove(0);\n-                }\n-                String result;\n-\n-                switch (command) {\n-                    case \"getBalance\":\n-                        long satoshis = cmd.getBalance();\n-                        // TODO mimic bitcoin-cli?  Depends on an error code: Loading block index... Verifying blocks...\n-                        result = satoshis == -1 ? \"Server initializing...\" : cmd.prettyBalance.apply(satoshis);\n-                        break;\n-                    case \"getVersion\":\n-                        result = cmd.getVersion();\n-                        break;\n-                    case \"stop\":\n-                        result = \"Shut down client\";\n-                        try {\n-                            shutdown();\n-                        } catch (InterruptedException e) {\n-                            log.error(e.toString(), e);\n-                        }\n-                        break;\n-                    case \"stopServer\":\n-                        cmd.stopServer();\n-                        result = \"Server stopped\";\n-                        break;\n-                    default:\n-                        result = format(\"Unknown command '%s'\", command);\n-                }\n-\n-                // First response is rather slow (300 ms) but following responses are fast (3-5 ms).\n-                log.info(\"{}\\t{}\", result, cmd.responseTime.apply(startTs));\n-            }\n+        long startTs = currentTimeMillis();", "originalCommit": "94ee49c5afdc0262dc888e58b4fcf572975307cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNjAzNg==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400006036", "bodyText": "And this as well. There is no requirement at present to measure the response time, and output from a unix utility should not include anything other than the data requested, i.e. such that it can be piped to the next utility. This sort of output breaks that unix idiom. Again, I realize you did not introduce this. I'm just asking you to remove it and start thinking about things this way, making similar decisions as you go.", "author": "cbeams", "createdAt": "2020-03-30T08:17:32Z", "path": "cli/src/main/java/bisq/cli/app/BisqCliMain.java", "diffHunk": "@@ -41,60 +45,28 @@\n \n     private final ManagedChannel channel;\n     private final CliCommand cmd;\n+    private final OptionParser cmdParser;\n \n     public static void main(String[] args) {\n-        new BisqCliMain(\"localhost\", 8888);\n+        new BisqCliMain(\"localhost\", 8888, args);\n     }\n \n-    private BisqCliMain(String host, int port) {\n+    private BisqCliMain(String host, int port, String[] params) {\n         // Channels are secure by default (via SSL/TLS);  for the example disable TLS to avoid needing certificates.\n         this(ManagedChannelBuilder.forAddress(host, port).usePlaintext().build());\n \n-        // Simple input scanner\n-        // TODO use some more sophisticated input processing with validation....\n-        try (Scanner scanner = new Scanner(in)) {\n-            while (true) {\n-                long startTs = currentTimeMillis();\n-\n-                String[] tokens = scanner.nextLine().split(\" \");\n-                if (tokens.length == 0) {\n-                    return;\n-                }\n-                String command = tokens[0];\n-                if (tokens.length > 1) {\n-                    List<String> params = new ArrayList<>(Arrays.asList(tokens));\n-                    params.remove(0);\n-                }\n-                String result;\n-\n-                switch (command) {\n-                    case \"getBalance\":\n-                        long satoshis = cmd.getBalance();\n-                        // TODO mimic bitcoin-cli?  Depends on an error code: Loading block index... Verifying blocks...\n-                        result = satoshis == -1 ? \"Server initializing...\" : cmd.prettyBalance.apply(satoshis);\n-                        break;\n-                    case \"getVersion\":\n-                        result = cmd.getVersion();\n-                        break;\n-                    case \"stop\":\n-                        result = \"Shut down client\";\n-                        try {\n-                            shutdown();\n-                        } catch (InterruptedException e) {\n-                            log.error(e.toString(), e);\n-                        }\n-                        break;\n-                    case \"stopServer\":\n-                        cmd.stopServer();\n-                        result = \"Server stopped\";\n-                        break;\n-                    default:\n-                        result = format(\"Unknown command '%s'\", command);\n-                }\n-\n-                // First response is rather slow (300 ms) but following responses are fast (3-5 ms).\n-                log.info(\"{}\\t{}\", result, cmd.responseTime.apply(startTs));\n-            }\n+        long startTs = currentTimeMillis();\n+\n+        String command = parseCommand(params);\n+        String result = runCommand(command);\n+\n+        // First response is rather slow (300 ms) but following responses are fast (3-5 ms).\n+        // log.info(\"{}\\t{}\", result, cmd.responseTime.apply(startTs));\n+        out.println(result + \"\\t\" + cmd.responseTime.apply(startTs));", "originalCommit": "94ee49c5afdc0262dc888e58b4fcf572975307cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxMzAwMQ==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400013001", "bodyText": "Please study the way help output is printed in BisqExecutable#execute and note the use of BisqHelpFormatter which we may want to reuse (we would need to move it in order to do so, don't worry about it now, just use the default help formatter implementation in the meantime).\nIn any case, when help is explicitly requested, it shouldn't be printed to stderr, but stdout.\nPlease also explicitly System.exit 0 or 1 accordingly. You'll see how this is done in BisqExecutable as well.", "author": "cbeams", "createdAt": "2020-03-30T08:29:29Z", "path": "cli/src/main/java/bisq/cli/app/CommandParser.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package bisq.cli.app;\n+\n+import joptsimple.OptionParser;\n+\n+import static java.lang.System.err;\n+\n+final class CommandParser {\n+\n+    // Option name constants\n+    static final String HELP = \"help\";\n+    static final String GETBALANCE = \"getbalance\";\n+    static final String GETVERSION = \"getversion\";\n+    static final String STOPSERVER = \"stopserver\";\n+\n+    OptionParser configure() {\n+        OptionParser parser = new OptionParser();\n+        parser.allowsUnrecognizedOptions();\n+        parser.nonOptions(GETBALANCE).ofType(String.class).describedAs(\"get btc balance\");\n+        parser.nonOptions(GETVERSION).ofType(String.class).describedAs(\"get bisq version\");\n+        return parser;\n+    }\n+\n+    static void printUsage() {\n+        err.println(\"Usage:  bisq-cli getbalance | getversion\");", "originalCommit": "94ee49c5afdc0262dc888e58b4fcf572975307cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI0NjU5Ng==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400246596", "bodyText": "Prints usage message to stdout, and uses EXIT_SUCCESS and EXIT_FAILURE arguments in System.exit().\nWhat's not done:  help formatting.  I need to discuss Bisq + joptsimple.HelpFormatter issues with @cbeams.  Right now, the only options passed to Cli are of type NonOptionArgumentSpec, which did not work as expected with joptsimple.HelpFormatter.  It looks like Bisq Config only uses ArgumentAcceptingOptionSpec options, which do work with joptsimple.HelpFormatter.  It did not seem correct to change non-option cli arguments to argument accepting options just to make them work with the joptsimple.HelpFormatter interface, which is why I checked in the simple 'print usage' print statement.", "author": "ghubstan", "createdAt": "2020-03-30T14:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxMzAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM2Mjk3Nw==", "url": "https://github.com/bisq-network/bisq/pull/4097#discussion_r400362977", "bodyText": "Ok, that's fine then. We can come back to it later, thanks.", "author": "cbeams", "createdAt": "2020-03-30T17:22:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxMzAwMQ=="}], "type": "inlineReview"}, {"oid": "d3e60fa7a344bb8f9e5a9c3ab740ad76009f5878", "url": "https://github.com/bisq-network/bisq/commit/d3e60fa7a344bb8f9e5a9c3ab740ad76009f5878", "message": "Implement requested changes in PR #4097\n\nChange member name OptionParser cmdParser -> parser.\nChange server listening port to 9998, client port to 9998.\nChange constructor argument from String[] param -> args.\nPrint the result only, w/out exec time.\nPrint help to stdout, not stderr.\nUse explicit system SUCCESS/FAIL codes in System.exit(0 || 1).", "committedDate": "2020-03-30T15:00:30Z", "type": "forcePushed"}, {"oid": "c4517697e069d6463d0ca0e5ab77f0728a80665e", "url": "https://github.com/bisq-network/bisq/commit/c4517697e069d6463d0ca0e5ab77f0728a80665e", "message": "Implement requested changes in PR #4097\n\nChange member name OptionParser cmdParser -> parser.\nChange server listening port to 9998, client port to 9998.\nChange constructor argument from String[] param -> args.\nPrint the result only, w/out exec time.\nHandle help command, print help to stdout, not stderr.\nUse explicit system SUCCESS/FAIL codes in System.exit(0 || 1).", "committedDate": "2020-03-30T15:47:55Z", "type": "forcePushed"}, {"oid": "aba595b8e8d9db2b80843a3f802095186b6d83c8", "url": "https://github.com/bisq-network/bisq/commit/aba595b8e8d9db2b80843a3f802095186b6d83c8", "message": "Implement requested changes in PR #4097\n\nChange member name OptionParser cmdParser -> parser.\nChange server listening port to 9998, client port to 9998.\nChange constructor argument from String[] param -> args.\nPrint the result only, w/out exec time.\nHandle help command & print that to stdout;  print help\ntriggered by user error to stderr.\nUse explicit system SUCCESS/FAIL codes in System.exit(0 || 1).", "committedDate": "2020-03-30T15:53:45Z", "type": "commit"}, {"oid": "aba595b8e8d9db2b80843a3f802095186b6d83c8", "url": "https://github.com/bisq-network/bisq/commit/aba595b8e8d9db2b80843a3f802095186b6d83c8", "message": "Implement requested changes in PR #4097\n\nChange member name OptionParser cmdParser -> parser.\nChange server listening port to 9998, client port to 9998.\nChange constructor argument from String[] param -> args.\nPrint the result only, w/out exec time.\nHandle help command & print that to stdout;  print help\ntriggered by user error to stderr.\nUse explicit system SUCCESS/FAIL codes in System.exit(0 || 1).", "committedDate": "2020-03-30T15:53:45Z", "type": "forcePushed"}]}