{"pr_number": 4406, "pr_title": "Update GUI labels to reflect multiple rate providers", "pr_createdAt": "2020-08-08T19:21:11Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4406", "timeline": [{"oid": "b8a76b0e9251bdf418a8184815bdc9db2eddf7bb", "url": "https://github.com/bisq-network/bisq/commit/b8a76b0e9251bdf418a8184815bdc9db2eddf7bb", "message": "Update top-right bar references to price source\n\nUpdate the displayed text, as well as the tooltip, of the price box in\nthe top right bar. It now indicates that the price data is provided by\nBisq pricenodes (for for fiat, as well as for alts).", "committedDate": "2020-08-08T17:59:34Z", "type": "commit"}, {"oid": "189431ed7ea72930f000bbee4b24aa8cbf440e35", "url": "https://github.com/bisq-network/bisq/commit/189431ed7ea72930f000bbee4b24aa8cbf440e35", "message": "Correctly map lastRequest timestamp\n\nThe lastRequest timestamp is changed to show the last request to a\npricenode.\n\nThe previous approach of using the \"last provider request timestamp\"\ndoes not make sense in the new setup. Each currency rate is based on\nrates from several providers, each with their own \"request timestamps\".\nIn addition, the pricenode returns the timestamp each rate was\ncalculated. On top of that comes the timestamp when the Bisq node\nqueries the pricenode.\n\nSince what is most relevant for the Bisq node is the \"freshness\" of a\nspecific rate, the timestamp most indicative of that is the moment when\nthe pricenode is queried.", "committedDate": "2020-08-08T19:00:45Z", "type": "commit"}, {"oid": "2a4c11cb350d58a5c3111c3eb096a78c9e4ce641", "url": "https://github.com/bisq-network/bisq/commit/2a4c11cb350d58a5c3111c3eb096a78c9e4ce641", "message": "Remove unused methods\n\nRemoved getters for the BA and CMC timestamps, both of which are not\nused anymore.", "committedDate": "2020-08-08T19:02:57Z", "type": "commit"}, {"oid": "f73f4174dd77e222e02cab3e510287d9e14eef6c", "url": "https://github.com/bisq-network/bisq/commit/f73f4174dd77e222e02cab3e510287d9e14eef6c", "message": "Rename method\n\nRename method to remove reference to the BA provider.", "committedDate": "2020-08-08T19:04:17Z", "type": "commit"}, {"oid": "584e516fc445ca920be14cb5aaa696daea2af32c", "url": "https://github.com/bisq-network/bisq/commit/584e516fc445ca920be14cb5aaa696daea2af32c", "message": "Rename timestamp field\n\nRename timestamp field which implied it represents an epoch value in\nseconds, but the way it was used to build a Date object showed that it\nactually expected a millis value.", "committedDate": "2020-08-08T19:14:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5OTU4Ng==", "url": "https://github.com/bisq-network/bisq/pull/4406#discussion_r467499586", "bodyText": "Hold on a second, this isn't just changing labels, you're actually changing code here. It looks like you're replacing the timestamp of the actual price data, with the timestamp Bisq updated it from the Pricenode, which is incorrect. This behavior needs to be preserved, for example if a pricenode has an issue and doesn't get data updates, the local Bisq node needs to be able to detect that it's old data and switch to a different Pricenode with recently updated data.", "author": "wiz", "createdAt": "2020-08-08T20:05:27Z", "path": "core/src/main/java/bisq/core/provider/price/PriceFeedService.java", "diffHunk": "@@ -400,7 +384,12 @@ public void onSuccess(@Nullable Tuple2<Map<String, Long>, Map<String, MarketPric\n                 UserThread.execute(() -> {\n                     checkNotNull(result, \"Result must not be null at requestAllPrices\");\n                     timeStampMap = result.first;\n-                    epochInSecondAtLastRequest = timeStampMap.get(\"btcAverageTs\");\n+\n+                    // Each currency rate has a different timestamp, depending on when\n+                    // the pricenode aggregate rate was calculated\n+                    // However, the request timestamp is when the pricenode was queried\n+                    epochInMillisAtLastRequest = System.currentTimeMillis();", "originalCommit": "584e516fc445ca920be14cb5aaa696daea2af32c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzUwMTUyNA==", "url": "https://github.com/bisq-network/bisq/pull/4406#discussion_r467501524", "bodyText": "Since there is no more BA provider, the btcAverageTs field is basically useless.\nIt is however used here to populate the epochInMillisAtLastRequest timestamp -- which is used in the UI to show when the fiat rates were retrieved.\nBefore, when using BA: this made sense, cause BA was the \"single source of truth\" for all fiat rates, and Poloniex was the source of alt rates.\nNow, when using multiple providers: basically the pricenode itself is the \"provider\", because it aggregates rates from multiple sources for both fiat and alts.\nSo, the closest \"timestamp\" that shows the last time the \"provider\" (pricenode) was polled, is the one in the code snippet above.\nAlternative would be to extract and index every timestamp per exchange rate, then selectively show the right one depending on what currency pair the user selected in the UI. That seems like overkill for what this change tries to achieve. Especially since those \"per exchange rate\" timestamps are very likely the same, cause they all show the point in time when the avg rate was calculated, and they're all calculated when the pricenode is polled (the avg is freshly calculated based on newest data).\nSo I would say, this is the simplest and most pragmatic approach (epochInMillisAtLastRequest = timestamp_when_pricenode_last_successfully_queried).", "author": "cd2357", "createdAt": "2020-08-08T20:30:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5OTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzUwMzgzMg==", "url": "https://github.com/bisq-network/bisq/pull/4406#discussion_r467503832", "bodyText": "The timestamp is not for when the data was updated from the pricenode, that's irrelevant. The timestamp is for the price itself, i.e. when the price was obtained from the provider, or in the case of a weighted average aka index, the time when the index was last updated. Can you please use the timestampSec field for each asset's index?", "author": "wiz", "createdAt": "2020-08-08T21:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5OTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU3NTIzNg==", "url": "https://github.com/bisq-network/bisq/pull/4406#discussion_r467575236", "bodyText": "Done. This field now just stores the \"pricenode query timestamp\", but the timestampSec of each asset is shown in the tooltip (see PR screenshots).", "author": "cd2357", "createdAt": "2020-08-09T12:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5OTU4Ng=="}], "type": "inlineReview"}, {"oid": "f534939b35f8f63e0a47dce6df8fe3069673c08c", "url": "https://github.com/bisq-network/bisq/commit/f534939b35f8f63e0a47dce6df8fe3069673c08c", "message": "Update labels to indicate Bisq Price Index\n\nUpdate top-right status box and tooltip labels to indicate the price is\nbased on the Bisq Price Index.", "committedDate": "2020-08-09T11:13:10Z", "type": "commit"}, {"oid": "2ddb2c2ca2938cb443f4df635f7947feb1db83b3", "url": "https://github.com/bisq-network/bisq/commit/2ddb2c2ca2938cb443f4df635f7947feb1db83b3", "message": "Update top-right tooltip timestamp\n\nUpdate timestamp shown in top-right tooltip, to indicate the point in\ntime when that specific exchange rate was retrieved (from an Exchange,\nif only one exchange supported for that currency) or when it was\ncalculated (by the pricenode, based on inputs from multiple exchanges).", "committedDate": "2020-08-09T11:52:57Z", "type": "commit"}, {"oid": "ef5b80440cda2eee7de2f5c155eedfaf042cb3dd", "url": "https://github.com/bisq-network/bisq/commit/ef5b80440cda2eee7de2f5c155eedfaf042cb3dd", "message": "Update exchange rate info in About view\n\nUpdate field describing the source of the shown exchange rates,\nindicating that the Bisq Price Index is used.", "committedDate": "2020-08-09T13:28:09Z", "type": "commit"}, {"oid": "ef5b80440cda2eee7de2f5c155eedfaf042cb3dd", "url": "https://github.com/bisq-network/bisq/commit/ef5b80440cda2eee7de2f5c155eedfaf042cb3dd", "message": "Update exchange rate info in About view\n\nUpdate field describing the source of the shown exchange rates,\nindicating that the Bisq Price Index is used.", "committedDate": "2020-08-09T13:28:09Z", "type": "forcePushed"}, {"oid": "cdc624277958636b2a8c497b0926be87530becd9", "url": "https://github.com/bisq-network/bisq/commit/cdc624277958636b2a8c497b0926be87530becd9", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: wiz <j@wiz.biz>", "committedDate": "2020-08-09T18:13:37Z", "type": "commit"}]}