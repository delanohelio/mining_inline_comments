{"pr_number": 4214, "pr_title": "Add rpc wallet protection endpoints", "pr_createdAt": "2020-04-29T22:43:35Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4214", "timeline": [{"oid": "de50692daa829182247a539edef12d2baa083292", "url": "https://github.com/bisq-network/bisq/commit/de50692daa829182247a539edef12d2baa083292", "message": "Add rpc wallet protection endpoints\n\nImplemented lockwallet, unlockwallet, removewalletpassword, and\nsetwalletpassword methods with basic error handling.\n\nAlso added basic error handling to existing getbalance method,\nand removed unused BalancePresentation from CoreAPI.\n\nTODO:  update help text", "committedDate": "2020-04-29T22:25:23Z", "type": "commit"}, {"oid": "20962757220d5ca25258cf33f06f009eb0245d40", "url": "https://github.com/bisq-network/bisq/commit/20962757220d5ca25258cf33f06f009eb0245d40", "message": "Handle unlockwallet parameter errors", "committedDate": "2020-04-30T14:00:22Z", "type": "commit"}, {"oid": "ca68d0567fbcee9f0c210e2fd9188b2a126e119e", "url": "https://github.com/bisq-network/bisq/commit/ca68d0567fbcee9f0c210e2fd9188b2a126e119e", "message": "Add wallet protection methods to printHelp(opts)", "committedDate": "2020-04-30T14:21:04Z", "type": "commit"}, {"oid": "c5fcafb5f61c6834d73d00e76457cc6ea07e448c", "url": "https://github.com/bisq-network/bisq/commit/c5fcafb5f61c6834d73d00e76457cc6ea07e448c", "message": "Renamed tempWalletPassword -> tempLockWalletPassword\n\nThis @Nullable class level variable's name needs to specifically\ndescribe the use case.", "committedDate": "2020-04-30T14:57:59Z", "type": "commit"}, {"oid": "2a9d1f6d3460a9c951fe17a39b61153e5723696f", "url": "https://github.com/bisq-network/bisq/commit/2a9d1f6d3460a9c951fe17a39b61153e5723696f", "message": "Improve gRPC error handling\n\nThis change removes non-idiomatic gRPC *Reply proto message fields.\nThe client should not receive success/fail values from server methods\nwith a void return type, nor an optional error_message from any server\nmethod.  This change improves error handling by wrapping an appropriate\ngRPC Status with a meaningful error description in a StatusRuntimeException,\nand placing it in the server's response StreamObserver.  User error\nmessages are mapped to general purpose gRPC Status codes in a new ApiStatus\nenum class.  (Maybe ApiStatus should be renamed to CoreApiStatus.)", "committedDate": "2020-05-01T20:29:14Z", "type": "commit"}, {"oid": "c7a6c87bd168ae6cf26a49f51466c80939e74181", "url": "https://github.com/bisq-network/bisq/commit/c7a6c87bd168ae6cf26a49f51466c80939e74181", "message": "Refactor grpc wallet service\n\nPreviously, each wallet-related method was implemented with its own grpc\nservice. There is no need to do this, as a grpc service may declare\nmultiple rpc methods. This commit refactors everything wallet-related\ninto a single GrpcWalletService and also extracts a CoreWalletService\nfrom CoreApi in order to avoid the latter becoming overly large.\nIdeally, there would be no need for an abstraction in bisq.grpc called\nCoreWalletService; we would ideally use such a service implemented in\nbisq.core. The closest we have is WalletsManager, but it is not designed\nto be used the way we are using it here in the grpc context. Rather than\nmaking changes directly to core (which can be very risky), we will\nrather make them here in this layer, designing exactly the \"core wallet\nservice\" we need, and can then later see about folding it into the\nactual core.", "committedDate": "2020-05-03T13:46:41Z", "type": "commit"}, {"oid": "6334c5478cfd24cf9877e4a33b8ae07d12f2bee2", "url": "https://github.com/bisq-network/bisq/commit/6334c5478cfd24cf9877e4a33b8ae07d12f2bee2", "message": "Generalize gRPC exception message cleanup", "committedDate": "2020-05-03T13:47:26Z", "type": "commit"}, {"oid": "12d2de5e11a46af04aa089337f06ab701af90bb1", "url": "https://github.com/bisq-network/bisq/commit/12d2de5e11a46af04aa089337f06ab701af90bb1", "message": "Change CoreWalletService#getAvailableBalance from Tuple2 to long\n\nAnd throw an IllegalStateException with an appropriate message if the\nwallet is not available or still locked.\n\nThis change also eliminates the NullPointerException that would\nsometimes be thrown when calling #getAvailableBalance after the wallet\nhas become available but before the balance has become available.", "committedDate": "2020-05-03T13:48:54Z", "type": "forcePushed"}, {"oid": "163061ac757900642b0ce4ccd083e2c172a8fbca", "url": "https://github.com/bisq-network/bisq/commit/163061ac757900642b0ce4ccd083e2c172a8fbca", "message": "Return long vs Tuple2 from CoreWalletService#getAvailableBalance\n\nAnd throw an IllegalStateException with an appropriate message if the\nwallet is not available or still locked.\n\nThis change also eliminates the NullPointerException that would\nsometimes be thrown when calling #getAvailableBalance after the wallet\nhas become available but before the balance has become available.", "committedDate": "2020-05-03T14:15:49Z", "type": "commit"}, {"oid": "163061ac757900642b0ce4ccd083e2c172a8fbca", "url": "https://github.com/bisq-network/bisq/commit/163061ac757900642b0ce4ccd083e2c172a8fbca", "message": "Return long vs Tuple2 from CoreWalletService#getAvailableBalance\n\nAnd throw an IllegalStateException with an appropriate message if the\nwallet is not available or still locked.\n\nThis change also eliminates the NullPointerException that would\nsometimes be thrown when calling #getAvailableBalance after the wallet\nhas become available but before the balance has become available.", "committedDate": "2020-05-03T14:15:49Z", "type": "forcePushed"}, {"oid": "916457963f56747fae53b78de288a774c0865761", "url": "https://github.com/bisq-network/bisq/commit/916457963f56747fae53b78de288a774c0865761", "message": "Return void vs Tuple2 from CoreWalletService#setWalletPassword\n\nLike the change in commit 163061a, setWalletPassword now throws an\nIllegalStateException with an appropriate message if the wallet password\ncannot be set.\n\nAlso deletes unused StatusApi enums.", "committedDate": "2020-05-03T16:42:14Z", "type": "commit"}, {"oid": "feafd0c983527ef6fee71ad371a0623c7393e681", "url": "https://github.com/bisq-network/bisq/commit/feafd0c983527ef6fee71ad371a0623c7393e681", "message": "Return void vs Tuple2 from CoreWalletService#removeWalletPassword\n\nLike the change in commits 163061a and 9164579, removeWalletPassword\nnow throws an IllegalStateException with an appropriate message if\nthe wallet password cannot be removed.\n\nAlso deletes unused StatusApi enums.", "committedDate": "2020-05-03T16:51:56Z", "type": "commit"}, {"oid": "ab17b672294011b766da3ab6e02a349c01c4f7e0", "url": "https://github.com/bisq-network/bisq/commit/ab17b672294011b766da3ab6e02a349c01c4f7e0", "message": "Remove obsolete try/catch block in #setWalletPassword", "committedDate": "2020-05-03T16:54:01Z", "type": "commit"}, {"oid": "ec2ee45e584fee04206325ef210ae55f64851606", "url": "https://github.com/bisq-network/bisq/commit/ec2ee45e584fee04206325ef210ae55f64851606", "message": "Return void vs Tuple2 from CoreWalletService#lockWallet\n\nAnd delete unused StatusApi enum.", "committedDate": "2020-05-03T17:25:19Z", "type": "commit"}, {"oid": "3ef7286465f4027d49f1a28c136a6dea2910a0c4", "url": "https://github.com/bisq-network/bisq/commit/3ef7286465f4027d49f1a28c136a6dea2910a0c4", "message": "Return void vs Tuple2 from CoreWalletService#unlockWallet\n\nAlso remove unused StatusApi class.", "committedDate": "2020-05-03T17:29:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzNTM3MA==", "url": "https://github.com/bisq-network/bisq/pull/4214#discussion_r419135370", "bodyText": "Whitespace. Doesn't matter as ApiStatus will be removed shortly enough, but it makes me wonder whether or not you're using Editorconfig as suggested at bisq-network/style#10?", "author": "cbeams", "createdAt": "2020-05-03T17:39:22Z", "path": "core/src/main/java/bisq/core/grpc/ApiStatus.java", "diffHunk": "@@ -56,5 +53,5 @@ public String toString() {\n                 \", description='\" + description + '\\'' +\n                 '}';\n     }\n-}\n+    }", "originalCommit": "ec2ee45e584fee04206325ef210ae55f64851606", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzODQ1NA==", "url": "https://github.com/bisq-network/bisq/pull/4214#discussion_r419138454", "bodyText": "My Intellij IDE is using the project scheme defined in the repo's .editorconfig file:\nroot = true\n\n[*]\nindent_style = space\nindent_size = 4\ncontinuation_indent_size = 8\nend_of_line = lf\ncharset = utf-8\ntrim_trailing_whitespace = true\ninsert_final_newline = true\n\n[*.diff]\ntrim_trailing_whitespace = false\n\n[Makefile]\nindent_style = tab\n\n[*.bat]\nend_of_line = crlf\n\n[build.gradle]\ncontinuation_indent_size = 4\n\n[.idea/codeStyles/*.xml]\nindent_size = 2\ninsert_final_newline = false\n\n\nIt could have been a fat finger error when I was reformatting the class after removing some lines with ^ALT-L.  But I'm really not sure if that is the cause.  I'll keep an eye on it.", "author": "ghubstan", "createdAt": "2020-05-03T18:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzNTM3MA=="}], "type": "inlineReview"}, {"oid": "f5a4ca51a8e6c5926cd9c21bc4983f155bdb4ae6", "url": "https://github.com/bisq-network/bisq/commit/f5a4ca51a8e6c5926cd9c21bc4983f155bdb4ae6", "message": "Add missing return statement in CoreWalletService#setWalletPassword\n\nWithout bugfix, method would try to encrypt the wallet using using the\nold password argument immediately after encrypting the wallet with\na new password.", "committedDate": "2020-05-03T18:09:23Z", "type": "commit"}, {"oid": "b0e5da8e2ea31736234fe469fa4fb355ef1f442f", "url": "https://github.com/bisq-network/bisq/commit/b0e5da8e2ea31736234fe469fa4fb355ef1f442f", "message": "Refactor setwalletpassword handling to eliminate duplication", "committedDate": "2020-05-04T10:22:13Z", "type": "commit"}, {"oid": "d48f9eb6f0e4f0688b414d40809efb95ee3ce932", "url": "https://github.com/bisq-network/bisq/commit/d48f9eb6f0e4f0688b414d40809efb95ee3ce932", "message": "Tighten up error handling\n\nThis commit factors out a run() method in CliMain that either returns\n(void) or throws an exception. This eliminates the need to call\nSystem.exit in so many places as were previously. Indeed, now there is\nonly one place where System.exit is called.\n\nIt also removes the duplication of printing \"Error: ...\" to stderr when\nsomething goes wrong by doing this once in the global catch clause in\nthe main method.", "committedDate": "2020-05-04T11:58:46Z", "type": "commit"}, {"oid": "9b156b86ddfb16593b80dcae3398fd90257f892d", "url": "https://github.com/bisq-network/bisq/commit/9b156b86ddfb16593b80dcae3398fd90257f892d", "message": "Remove unlockwallet timeout variable initializer\n\nThis variable no longer needs to be initialized to avoid a compiler error.", "committedDate": "2020-05-04T18:19:18Z", "type": "commit"}, {"oid": "fbb025adb1abfd653fb1aec0ccfa5e739c2640ce", "url": "https://github.com/bisq-network/bisq/commit/fbb025adb1abfd653fb1aec0ccfa5e739c2640ce", "message": "Factor out two small duplcated code blocks", "committedDate": "2020-05-06T15:30:59Z", "type": "commit"}, {"oid": "4262f294625ba3e3dc501e39a938af3374c37113", "url": "https://github.com/bisq-network/bisq/commit/4262f294625ba3e3dc501e39a938af3374c37113", "message": "Cache temp key and crypter scrypt in unlockwallet\n\nCache the aesKey instead of the password in unlock wallet method,\navoiding extra overhead of deriving it from the temp password in the\nlock method.\n\nThe KeyCrypterScrypt used in the unlock method must also be cached for\nuse in the manual lock method.  Creating a new KeyCrypterScrypt instance\nin the manual lock method would have a different random salt value,\ninvalidating the password used in the unlock method.", "committedDate": "2020-05-06T18:20:41Z", "type": "commit"}, {"oid": "24248d43673cea54e1c75bf7bc578b1a0ff3588d", "url": "https://github.com/bisq-network/bisq/commit/24248d43673cea54e1c75bf7bc578b1a0ff3588d", "message": "Backup wallets after each encrypt/decrypt operation\n\nThis is consistent with :desktop's PasswordView#onApplyPassword.", "committedDate": "2020-05-06T18:40:15Z", "type": "commit"}, {"oid": "a79ae57ef05967688979dfac48593abb14552862", "url": "https://github.com/bisq-network/bisq/commit/a79ae57ef05967688979dfac48593abb14552862", "message": "Cache aesKey in unlockwallet, clear it in lockwallet\n\nThere is no need to decrypt and re-encrypt wallet files in the unlock\nand lock wallet methods.  The temporary aesKey saved in the unlock\nmethod will used for operations on an encrypted wallet.\n\nThere is also no need to cache a tempKeyCrypterScrypt;  this class\nlevel variable was removed.", "committedDate": "2020-05-07T17:21:51Z", "type": "commit"}, {"oid": "9178ad7a31908b88bb7df743e395233d52069852", "url": "https://github.com/bisq-network/bisq/commit/9178ad7a31908b88bb7df743e395233d52069852", "message": "Fix unlockwallet timeout override bug\n\nThe CoreWalletService should never be running more than one wallet lock\nTimerTask at any given time, and the wallet should lock at the correct time\nafter a user overrides a prior timeout value.\n\nThe CoreWalletService now cancels any existing lock TimerTask thread\nbefore creating a new one, to prevent the wallet from re-locking at\nunexpected times.\n\nThis change prevents error conditions created in scenarios similar to\nthe following:\n\n  (1)  User unlocks wallet for 60s\n  (2)  User overrides unlock timeout by calling unlockwallet \"pwd\" 600s\n  (3)  After 60s, the 1st, uncanceled lock timeout expires, and wallet is\n       locked 4 minutes too soon.", "committedDate": "2020-05-13T15:30:39Z", "type": "commit"}, {"oid": "d53cc38fdece6b32ff8242239e8813006dac06f4", "url": "https://github.com/bisq-network/bisq/commit/d53cc38fdece6b32ff8242239e8813006dac06f4", "message": "Wrap comments at 90 chars\n\nPer https://github.com/bisq-network/style/issues/5", "committedDate": "2020-05-18T12:08:35Z", "type": "commit"}, {"oid": "7f05f379abe4befc87656e257a7be5e08e65da88", "url": "https://github.com/bisq-network/bisq/commit/7f05f379abe4befc87656e257a7be5e08e65da88", "message": "Remove unused import\n\nThis should have been done in commit c7a6c87b.", "committedDate": "2020-05-18T12:11:50Z", "type": "commit"}]}