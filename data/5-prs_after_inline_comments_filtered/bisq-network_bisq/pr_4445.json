{"pr_number": 4445, "pr_title": "Use the index of a seed node address in the list of nodes at the", "pr_createdAt": "2020-08-28T07:31:24Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4445", "timeline": [{"oid": "fa5a58d41a343fed52b11c3d3641e24095a703dc", "url": "https://github.com/bisq-network/bisq/commit/fa5a58d41a343fed52b11c3d3641e24095a703dc", "message": "Use the index of a seed node address in the list of nodes at the\nrepository to determine the hour to restart.", "committedDate": "2020-08-28T07:30:45Z", "type": "commit"}, {"oid": "c218b287557a47a21afbc02c7f7495ee859fe31b", "url": "https://github.com/bisq-network/bisq/commit/c218b287557a47a21afbc02c7f7495ee859fe31b", "message": "Satistfy codacy", "committedDate": "2020-08-28T12:39:23Z", "type": "commit"}, {"oid": "5f7cfd2dc8e2e1fd0991dae1f4812215e7a3a1d7", "url": "https://github.com/bisq-network/bisq/commit/5f7cfd2dc8e2e1fd0991dae1f4812215e7a3a1d7", "message": "Improve logging of initial data requests", "committedDate": "2020-08-28T14:39:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM4MTQwOQ==", "url": "https://github.com/bisq-network/bisq/pull/4445#discussion_r479381409", "bodyText": "Why not use CHECK_SHUTDOWN_SEC here?", "author": "sqrrm", "createdAt": "2020-08-28T15:34:05Z", "path": "core/src/main/java/bisq/core/app/misc/ExecutableForAppWithP2p.java", "diffHunk": "@@ -106,6 +115,62 @@ public void gracefulShutDown(ResultHandler resultHandler) {\n         }\n     }\n \n+    public void startShutDownInterval(GracefulShutDownHandler gracefulShutDownHandler) {\n+        List<NodeAddress> seedNodeAddresses = new ArrayList<>(injector.getInstance(SeedNodeRepository.class).getSeedNodeAddresses());\n+        seedNodeAddresses.sort(Comparator.comparing(NodeAddress::getFullAddress));\n+\n+        NodeAddress myAddress = injector.getInstance(P2PService.class).getNetworkNode().getNodeAddress();\n+        int myIndex = -1;\n+        for (int i = 0; i < seedNodeAddresses.size(); i++) {\n+            if (seedNodeAddresses.get(i).equals(myAddress)) {\n+                myIndex = i;\n+                break;\n+            }\n+        }\n+\n+        if (myIndex == -1) {\n+            log.warn(\"We did not find our node address in the seed nodes repository. \" +\n+                            \"We use a 24 hour delay after startup as shut down strategy.\" +\n+                            \"myAddress={}, seedNodeAddresses={}\",\n+                    myAddress, seedNodeAddresses);\n+\n+            UserThread.runPeriodically(() -> {\n+                if (System.currentTimeMillis() - startTime > SHUTDOWN_INTERVAL) {\n+                    log.warn(\"\\n\\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\\n\" +\n+                                    \"Shut down as node was running longer as {} hours\" +\n+                                    \"\\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\\n\\n\",\n+                            SHUTDOWN_INTERVAL / 3600000);\n+\n+                    shutDown(gracefulShutDownHandler);\n+                }\n+\n+            }, CHECK_SHUTDOWN_SEC);\n+            return;\n+        }\n+\n+        // We interpret the value of myIndex as hour of day (0-23). That way we avoid the risk of a restart of\n+        // multiple nodes around the same time in case it would be not deterministic.\n+\n+        // We wrap our periodic check in a delay of 2 hours to avoid that we get\n+        // triggered multiple times after a restart while being in the same hour. It can be that we miss our target\n+        // hour during that delay but that is not considered problematic, the seed would just restart a bit longer than\n+        // 24 hours.\n+        int target = myIndex;\n+        UserThread.runAfter(() -> {\n+            // We check every hour if we are in the target hour.\n+            UserThread.runPeriodically(() -> {\n+                int currentHour = ZonedDateTime.ofInstant(Instant.now(), ZoneId.of(\"GMT0\")).getHour();\n+                if (currentHour == target) {\n+                    log.warn(\"\\n\\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\\n\" +\n+                            \"Shut down node at hour {}\" +\n+                            \"\\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\\n\\n\", target);\n+                    shutDown(gracefulShutDownHandler);\n+                }\n+            }, TimeUnit.MINUTES.toSeconds(10));", "originalCommit": "5f7cfd2dc8e2e1fd0991dae1f4812215e7a3a1d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ4MjczOA==", "url": "https://github.com/bisq-network/bisq/pull/4445#discussion_r479482738", "bodyText": "CHECK_SHUTDOWN_SEC is 1 hour. That has risk that we miss the hour we are targeting. If one timer event is triggered just 1 sec. before our target hour and then due cpu load the next 1 hour scheduled call takes longer we would miss our target hour. E.g. once call at 13:59, next call at 15:01, 14:00 would be our target.\nWith 10 min. Its safe enough and does not cause performance costs. We could maybe go higher like 30 min as well...but prefer to keep it on the safe side.", "author": "chimp1984", "createdAt": "2020-08-28T18:59:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM4MTQwOQ=="}], "type": "inlineReview"}]}