{"pr_number": 4950, "pr_title": "Improve offer publishing", "pr_createdAt": "2020-12-15T02:33:05Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4950", "timeline": [{"oid": "b55313054a5952e054a695a18d9f66b76c38619a", "url": "https://github.com/bisq-network/bisq/commit/b55313054a5952e054a695a18d9f66b76c38619a", "message": "Cleanup\n\nRemove debug and trace logs\nAdd curly brackets", "committedDate": "2020-12-15T02:29:07Z", "type": "commit"}, {"oid": "7bfbd0fd797e03ef5261fe82e7c5572018518608", "url": "https://github.com/bisq-network/bisq/commit/7bfbd0fd797e03ef5261fe82e7c5572018518608", "message": "Change handling of delay at republishing\n\nThe delay was too long. Some users have 100 - 200\noffers and with the 700 ms delay it takes 70-140 sec.\nThis causes more stress for the network and UI due\npermanent adding of offers. We decreased delay to 30 ms per offer.\nSo with 200 offers it would be about 6 sec. Maybe we could reduce\nit even further but as it is hard to test in the live network with\nso many offers it is better to not be too radical with the change.", "committedDate": "2020-12-15T02:32:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIyMTc4Mw==", "url": "https://github.com/bisq-network/bisq/pull/4950#discussion_r544221783", "bodyText": "Shouldn't this be !openOffer.isDeactivated() since it's being republished. That was the check before this change.", "author": "sqrrm", "createdAt": "2020-12-16T11:26:53Z", "path": "core/src/main/java/bisq/core/offer/OpenOfferManager.java", "diffHunk": "@@ -871,39 +871,46 @@ private void maybeUpdatePersistedOffers() {\n     ///////////////////////////////////////////////////////////////////////////////////////////\n \n     private void republishOffers() {\n-        int size = openOffers.size();\n-        final ArrayList<OpenOffer> openOffersList = new ArrayList<>(openOffers.getList());\n-        if (!stopped) {\n-            stopPeriodicRefreshOffersTimer();\n-            for (int i = 0; i < size; i++) {\n-                // we delay to avoid reaching throttle limits\n-\n-                long delay = 700;\n-                final long minDelay = (i + 1) * delay;\n-                final long maxDelay = (i + 2) * delay;\n-                final OpenOffer openOffer = openOffersList.get(i);\n-                UserThread.runAfterRandomDelay(() -> {\n-                    if (openOffers.contains(openOffer)) {\n-                        String id = openOffer.getId();\n-                        if (id != null && !openOffer.isDeactivated())\n-                            republishOffer(openOffer);\n-                    }\n+        if (stopped) {\n+            return;\n+        }\n \n-                }, minDelay, maxDelay, TimeUnit.MILLISECONDS);\n-            }\n-        } else {\n-            log.debug(\"We have stopped already. We ignore that republishOffers call.\");\n+        List<OpenOffer> openOffersList = new ArrayList<>(openOffers.getList());\n+        republishOffers(openOffersList);\n+\n+        stopPeriodicRefreshOffersTimer();\n+    }\n+\n+    private void republishOffers(List<OpenOffer> list) {\n+        if (list.isEmpty()) {\n+            return;\n         }\n+\n+        OpenOffer openOffer = list.remove(0);\n+        if (!openOffers.contains(openOffer) || openOffer.isDeactivated()) {", "originalCommit": "7bfbd0fd797e03ef5261fe82e7c5572018518608", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI5NTU3Mg==", "url": "https://github.com/bisq-network/bisq/pull/4950#discussion_r544295572", "bodyText": "No it is correct, we call our recursive method with the list where we have removed that offer. But the following lines neede to be in a else branch.\nI made a PR where I invert the if check and add a comment.", "author": "chimp1984", "createdAt": "2020-12-16T13:26:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIyMTc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI5NzU5Ng==", "url": "https://github.com/bisq-network/bisq/pull/4950#discussion_r544297596", "bodyText": "Yes, understood after the fix. Also the fix handles the recursion issue so I think it's good to merge.", "author": "sqrrm", "createdAt": "2020-12-16T13:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIyMTc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIyNzkxMA==", "url": "https://github.com/bisq-network/bisq/pull/4950#discussion_r544227910", "bodyText": "I don't understand the reason for the delay, all offers will be prepared to republish recursively, then during the recursion unwind they will all get this call so they delay is likely less than 1ms between each offer republish, but all the calls to republish will happen 30ms later. I think this is not much different to republishing without delay.\nThe previous version had a random delay, but it was a multiple of the number of orders and 700, so 200 orders ran into 140 seconds republish time and each offer would be spaced out in that time.", "author": "sqrrm", "createdAt": "2020-12-16T11:37:21Z", "path": "core/src/main/java/bisq/core/offer/OpenOfferManager.java", "diffHunk": "@@ -871,39 +871,46 @@ private void maybeUpdatePersistedOffers() {\n     ///////////////////////////////////////////////////////////////////////////////////////////\n \n     private void republishOffers() {\n-        int size = openOffers.size();\n-        final ArrayList<OpenOffer> openOffersList = new ArrayList<>(openOffers.getList());\n-        if (!stopped) {\n-            stopPeriodicRefreshOffersTimer();\n-            for (int i = 0; i < size; i++) {\n-                // we delay to avoid reaching throttle limits\n-\n-                long delay = 700;\n-                final long minDelay = (i + 1) * delay;\n-                final long maxDelay = (i + 2) * delay;\n-                final OpenOffer openOffer = openOffersList.get(i);\n-                UserThread.runAfterRandomDelay(() -> {\n-                    if (openOffers.contains(openOffer)) {\n-                        String id = openOffer.getId();\n-                        if (id != null && !openOffer.isDeactivated())\n-                            republishOffer(openOffer);\n-                    }\n+        if (stopped) {\n+            return;\n+        }\n \n-                }, minDelay, maxDelay, TimeUnit.MILLISECONDS);\n-            }\n-        } else {\n-            log.debug(\"We have stopped already. We ignore that republishOffers call.\");\n+        List<OpenOffer> openOffersList = new ArrayList<>(openOffers.getList());\n+        republishOffers(openOffersList);\n+\n+        stopPeriodicRefreshOffersTimer();\n+    }\n+\n+    private void republishOffers(List<OpenOffer> list) {\n+        if (list.isEmpty()) {\n+            return;\n         }\n+\n+        OpenOffer openOffer = list.remove(0);\n+        if (!openOffers.contains(openOffer) || openOffer.isDeactivated()) {\n+            republishOffers(list);\n+        }\n+\n+        republishOffer(openOffer,\n+                () -> UserThread.runAfter(() -> republishOffers(list),\n+                        30, TimeUnit.MILLISECONDS));", "originalCommit": "7bfbd0fd797e03ef5261fe82e7c5572018518608", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI5ODgwMA==", "url": "https://github.com/bisq-network/bisq/pull/4950#discussion_r544298800", "bodyText": "Ah damn, yes you are right...Wanted to avoid the way it was done before, but the delay from the callback is too short to be used as delay. I am acutally not very sure what happens if one publishes 200 offers without delay. It might be that connections to other peers get dropped due dos protection, but not sure if we hit those thresholds. To make it more smooth for the node and the network the delay was used, but could be that it makes things actually worse as it causes more messages (we use bundledEnvelope now to group msg in 1 container).\nMaybe best to leave the PR for now open and we do more tests first, just hard to test 200 offers on mainnet ;-(.", "author": "chimp1984", "createdAt": "2020-12-16T13:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIyNzkxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMwMDQ0Mw==", "url": "https://github.com/bisq-network/bisq/pull/4950#discussion_r544300443", "bodyText": "Yeah, could be it's better to have no delay and get all these messages into one bundle (or just a few) rather than spreading over time", "author": "sqrrm", "createdAt": "2020-12-16T13:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIyNzkxMA=="}], "type": "inlineReview"}, {"oid": "8e71575afd0d823357753a11e7250ce490e1e2f5", "url": "https://github.com/bisq-network/bisq/commit/8e71575afd0d823357753a11e7250ce490e1e2f5", "message": "Add else case for check for offer is in source list and deActivate state\nInvert the if branch so the normal case is first\nAdd comment", "committedDate": "2020-12-16T13:24:48Z", "type": "commit"}, {"oid": "24f53e0c0126efa994bf0e5c72e6534821e2892e", "url": "https://github.com/bisq-network/bisq/commit/24f53e0c0126efa994bf0e5c72e6534821e2892e", "message": "Add flush method.\nCall flush at openOfferManager shutdown.\nRemove unused method.\n\nForce broadcaster to send out immediately, otherwise we could\nhave a 2 sec delay until the bundled messages sent out.", "committedDate": "2020-12-16T14:01:12Z", "type": "commit"}, {"oid": "1049b7da7714bd1768115fdb9c7057d6b2982d43", "url": "https://github.com/bisq-network/bisq/commit/1049b7da7714bd1768115fdb9c7057d6b2982d43", "message": "Remove delay for publishing\n\nThis version is intended to be deployed to a power user to actually\ntry it out live as testing it with real conditions is very difficult.", "committedDate": "2020-12-16T14:04:36Z", "type": "commit"}, {"oid": "83e620d462b30700079f9d23d4985983070eade6", "url": "https://github.com/bisq-network/bisq/commit/83e620d462b30700079f9d23d4985983070eade6", "message": "Fix missing param in test", "committedDate": "2020-12-16T15:08:55Z", "type": "commit"}, {"oid": "c5d0fa789bad527e7eb645cc73df7f9662ce5551", "url": "https://github.com/bisq-network/bisq/commit/c5d0fa789bad527e7eb645cc73df7f9662ce5551", "message": "Move stopPeriodicRefreshOffersTimer before processListForRepublishOffers\n\nThe periodicRefreshOffersTimer gets started at offer publishing.\nBefore the stopPeriodicRefreshOffersTimer got overwritten by the start in offer\npublishing so it did not had any effect beside that we restarted it. Now we\nprocess offer publishing without delay and a stop after the call would stop\nthe refresh timer.", "committedDate": "2020-12-23T02:08:42Z", "type": "commit"}]}