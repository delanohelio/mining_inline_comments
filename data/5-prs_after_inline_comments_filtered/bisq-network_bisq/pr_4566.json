{"pr_number": 4566, "pr_title": "Trade protocol domain improvements", "pr_createdAt": "2020-09-27T06:46:25Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4566", "timeline": [{"oid": "456f16ddf4b8852ae86f0739c3521891be30c5fa", "url": "https://github.com/bisq-network/bisq/commit/456f16ddf4b8852ae86f0739c3521891be30c5fa", "message": "Remove handleTakeOfferRequest delegate method in maker trade", "committedDate": "2020-09-26T17:51:43Z", "type": "commit"}, {"oid": "7e16982b2b7eb249e97460aaa0fa2d8b39fe2490", "url": "https://github.com/bisq-network/bisq/commit/7e16982b2b7eb249e97460aaa0fa2d8b39fe2490", "message": "Remove onTakeOffer delegate method in taker trade", "committedDate": "2020-09-26T17:53:25Z", "type": "commit"}, {"oid": "a661ce6ed52c3b4aa2cc0811a2768721a40e3354", "url": "https://github.com/bisq-network/bisq/commit/a661ce6ed52c3b4aa2cc0811a2768721a40e3354", "message": "Remove onPaymentStarted delegate method in buyer trade", "committedDate": "2020-09-26T17:55:23Z", "type": "commit"}, {"oid": "c39a9b074f4684c43137e3c68d1e43804dfa484e", "url": "https://github.com/bisq-network/bisq/commit/c39a9b074f4684c43137e3c68d1e43804dfa484e", "message": "Remove onPaymentReceived delegate method in seller trade", "committedDate": "2020-09-26T17:56:42Z", "type": "commit"}, {"oid": "143377b7e5c72f0a3fbf738aa6b656b55319356f", "url": "https://github.com/bisq-network/bisq/commit/143377b7e5c72f0a3fbf738aa6b656b55319356f", "message": "Make some fields in ProcessModel final.\nMake init methods more clear\n\nThere will be more refactoring commits in that area...", "committedDate": "2020-09-26T18:36:24Z", "type": "commit"}, {"oid": "d6c242922b83190ba5009578387d537723a69734", "url": "https://github.com/bisq-network/bisq/commit/d6c242922b83190ba5009578387d537723a69734", "message": "Remove timeouts as it was not used before.", "committedDate": "2020-09-26T20:52:09Z", "type": "commit"}, {"oid": "27ac2d8e57ef486a736fe890e2cab45a728e4c6d", "url": "https://github.com/bisq-network/bisq/commit/27ac2d8e57ef486a736fe890e2cab45a728e4c6d", "message": "Remove never read field", "committedDate": "2020-09-26T20:52:31Z", "type": "commit"}, {"oid": "74317636b007eb6dbca7c0dc7f25ee841fbc1da0", "url": "https://github.com/bisq-network/bisq/commit/74317636b007eb6dbca7c0dc7f25ee841fbc1da0", "message": "Apply code inspection suggestions", "committedDate": "2020-09-26T21:00:03Z", "type": "commit"}, {"oid": "a9ad72d0e4f522ca05fb33875a85e31950b40c31", "url": "https://github.com/bisq-network/bisq/commit/a9ad72d0e4f522ca05fb33875a85e31950b40c31", "message": "Remove offer at close to avoid that button stays active when taking the offer\n\nCleanups", "committedDate": "2020-09-26T21:21:19Z", "type": "commit"}, {"oid": "3ce1ac92855913fb691767617adc404c9bd5987c", "url": "https://github.com/bisq-network/bisq/commit/3ce1ac92855913fb691767617adc404c9bd5987c", "message": "Refactor: improve logs", "committedDate": "2020-09-26T22:36:41Z", "type": "commit"}, {"oid": "07bcf6c38f6d0a43a0b8fa414d8b22c069f8a8e7", "url": "https://github.com/bisq-network/bisq/commit/07bcf6c38f6d0a43a0b8fa414d8b22c069f8a8e7", "message": "Refactor: improve logs", "committedDate": "2020-09-26T22:36:57Z", "type": "commit"}, {"oid": "6c6332d68df3b78ff8abbd40fb8b64a0f52dd662", "url": "https://github.com/bisq-network/bisq/commit/6c6332d68df3b78ff8abbd40fb8b64a0f52dd662", "message": "Allow also  Trade.Phase.PAYOUT_PUBLISHED in onPaymentReceived to support in failure situations to resend the msg", "committedDate": "2020-09-26T22:37:34Z", "type": "commit"}, {"oid": "5309f04b40cd6f1c3cf308194df2ea50b43be5f6", "url": "https://github.com/bisq-network/bisq/commit/5309f04b40cd6f1c3cf308194df2ea50b43be5f6", "message": "DO not deactivate move to failed trades button. Use different text in popup if all txs are valid.\nFix icon style issues.", "committedDate": "2020-09-26T23:33:25Z", "type": "commit"}, {"oid": "f0a30221ab5bbf7f56d30bcc65d060d868e8c2e4", "url": "https://github.com/bisq-network/bisq/commit/f0a30221ab5bbf7f56d30bcc65d060d868e8c2e4", "message": "Fix bug with showing popup once arbitration has been started", "committedDate": "2020-09-27T00:11:54Z", "type": "commit"}, {"oid": "cabc5af2c630b5d58a9fffb6661cc297ddec768d", "url": "https://github.com/bisq-network/bisq/commit/cabc5af2c630b5d58a9fffb6661cc297ddec768d", "message": "Make processModel in Trade final and pass in constructor instead of in init method", "committedDate": "2020-09-27T00:36:07Z", "type": "commit"}, {"oid": "84a498273266ed7a0c0949ef79061b7401a73ff3", "url": "https://github.com/bisq-network/bisq/commit/84a498273266ed7a0c0949ef79061b7401a73ff3", "message": "Remove TradeProtocol from Trade\n\nWe keep the TradeProtocol now in TradeManager in a hashmap.\nAs TradeProtocol constructors get called now earlier we need to add an onInitialized method which signals that the TradeProtocol is ready.\nThe processModel needs to get set the transient fields after construction.", "committedDate": "2020-09-27T02:34:28Z", "type": "commit"}, {"oid": "6deeecb8464918e48bbce3fca45443ca11621ba6", "url": "https://github.com/bisq-network/bisq/commit/6deeecb8464918e48bbce3fca45443ca11621ba6", "message": "Move handling of mailbox messages from TradeManager to TradeProtocol\n\nMake removal of mailbox messages automated in TradeProtocol", "committedDate": "2020-09-27T04:38:01Z", "type": "commit"}, {"oid": "d08591551b3a02ee9d5fbb8be995b2fb85fb6014", "url": "https://github.com/bisq-network/bisq/commit/d08591551b3a02ee9d5fbb8be995b2fb85fb6014", "message": "Add state listeners to warn icon columns to get correct state updates", "committedDate": "2020-09-27T06:26:48Z", "type": "commit"}, {"oid": "ab30e546b04fdae1dd99df66a63ab73cb0f59a96", "url": "https://github.com/bisq-network/bisq/commit/ab30e546b04fdae1dd99df66a63ab73cb0f59a96", "message": "Merge branch 'master_upstream' into fix-delayed-payout-tx-issues", "committedDate": "2020-09-27T06:28:51Z", "type": "commit"}, {"oid": "28a85c1ce56564a17347632f8d804ca88124803f", "url": "https://github.com/bisq-network/bisq/commit/28a85c1ce56564a17347632f8d804ca88124803f", "message": "Fix display strings", "committedDate": "2020-09-27T07:04:35Z", "type": "commit"}, {"oid": "2191693946a2919ac6c4af9e0eb7940f7e4dc0e1", "url": "https://github.com/bisq-network/bisq/commit/2191693946a2919ac6c4af9e0eb7940f7e4dc0e1", "message": "Apply stupid Codacy rule\n\nhttps://stackoverflow.com/questions/1750435/comparing-java-enum-members-or-equals\n\n```\nenum Color { BLACK, WHITE };\n\nColor nothing = null;\nif (nothing == Color.BLACK);      // runs fine\nif (nothing.equals(Color.BLACK)); // throws NullPointerException\n```\n```\nenum Color { BLACK, WHITE };\nenum Chiral { LEFT, RIGHT };\n\nif (Color.BLACK.equals(Chiral.LEFT)); // compiles fine\nif (Color.BLACK == Chiral.LEFT);      // DOESN'T COMPILE!!! Incompatible types!\n```\n\n\"To summarize, the arguments for using == on enum are:\n\n     It works.\n     It's faster.\n     It's safer at run-time.\n     It's safer at compile-time.\n\"", "committedDate": "2020-09-27T07:13:39Z", "type": "commit"}, {"oid": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "url": "https://github.com/bisq-network/bisq/commit/b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "message": "Another stupid codacy enforcement", "committedDate": "2020-09-27T07:16:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyMjUwMA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r495822500", "bodyText": "Why create multiple streams here, they are concatenated into one in the end anyway.\nNaming is also suspect, AVAILABLE is a keyword for a certain type of address, perhaps spendable would be better?\nSomething like\nvar spendable = Stream.concat...\nspendable = Stream.concat(spendable, ...\n...\nspendable.filter...", "author": "sqrrm", "createdAt": "2020-09-28T09:55:20Z", "path": "core/src/main/java/bisq/core/btc/wallet/BtcWalletService.java", "diffHunk": "@@ -738,6 +734,15 @@ public Coin getSavingWalletBalance() {\n                 .sum());\n     }\n \n+    public Stream<AddressEntry> getAddressEntriesForAvailableBalanceStream() {\n+        Stream<AddressEntry> availableAndPayout = Stream.concat(getAddressEntries(AddressEntry.Context.TRADE_PAYOUT)\n+                .stream(), getFundedAvailableAddressEntries().stream());\n+        Stream<AddressEntry> available = Stream.concat(availableAndPayout,\n+                getAddressEntries(AddressEntry.Context.ARBITRATOR).stream());", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4MDcwMw==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496280703", "bodyText": "AVAILABLE is if it has no role in the trade. Spendable would not cover that correctly as TRADE_PAYOUT is spendable as well. But better NOT_USED_IN_TRADE would be prob. more clear.  But as AddressEntry is a protobuf field I prefer to not change anything if not needed (though I guess rename would be ok).", "author": "chimp1984", "createdAt": "2020-09-28T22:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyMjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4MTA4Ng==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496281086", "bodyText": "Yes these stream concatenations are not nice. Its old code just moved from Trademanager, did not want to change too much... But to do a custom filter would be probably more clear here.", "author": "chimp1984", "createdAt": "2020-09-28T22:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyMjUwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNTY0Ng==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r495825646", "bodyText": "Would be nice to rename the protobuf class to TakeOfferRequest as well to conform with the rest of the code, this looks confusing.", "author": "sqrrm", "createdAt": "2020-09-28T10:00:41Z", "path": "core/src/main/java/bisq/core/proto/network/CoreNetworkProtoResolver.java", "diffHunk": "@@ -147,7 +147,7 @@ public NetworkEnvelope fromProto(protobuf.NetworkEnvelope proto) throws Protobuf\n                 case REFRESH_TRADE_STATE_REQUEST:\n                     return RefreshTradeStateRequest.fromProto(proto.getRefreshTradeStateRequest(), messageVersion);\n                 case INPUTS_FOR_DEPOSIT_TX_REQUEST:\n-                    return InputsForDepositTxRequest.fromProto(proto.getInputsForDepositTxRequest(), this, messageVersion);\n+                    return TakeOfferRequest.fromProto(proto.getInputsForDepositTxRequest(), this, messageVersion);", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4MTMzMw==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496281333", "bodyText": "Yes, agree. I would need to check out if renaming has any issues, I guess not but not 100% sure. If inheritence is used in PB it uses a key named after the class, so not sure if that is backward compatible...", "author": "chimp1984", "createdAt": "2020-09-28T23:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNTY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1NjM0NQ==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r495856345", "bodyText": "I'm not following why this is done. A comment would likely clarify.", "author": "sqrrm", "createdAt": "2020-09-28T11:00:41Z", "path": "core/src/main/java/bisq/core/trade/TradeManager.java", "diffHunk": "@@ -250,213 +203,137 @@ public void readPersisted() {\n     }\n \n \n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // DecryptedDirectMessageListener\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    @Override\n+    public void onDirectMessage(DecryptedMessageWithPubKey message, NodeAddress peer) {\n+        NetworkEnvelope networkEnvelope = message.getNetworkEnvelope();\n+        if (networkEnvelope instanceof TakeOfferRequest) {\n+            handleTakeOfferRequest(peer, (TakeOfferRequest) networkEnvelope);\n+        }\n+    }\n+\n+    // The maker received a TakeOfferRequest\n+    private void handleTakeOfferRequest(NodeAddress peer, TakeOfferRequest takeOfferRequest) {\n+        log.info(\"Received TakeOfferRequest from {} with tradeId {} and uid {}\",\n+                peer, takeOfferRequest.getTradeId(), takeOfferRequest.getUid());\n+\n+        try {\n+            Validator.nonEmptyStringOf(takeOfferRequest.getTradeId());\n+        } catch (Throwable t) {\n+            log.warn(\"Invalid TakeOfferRequest \" + takeOfferRequest.toString());\n+            return;\n+        }\n+\n+        Optional<OpenOffer> openOfferOptional = openOfferManager.getOpenOfferById(takeOfferRequest.getTradeId());\n+        if (!openOfferOptional.isPresent()) {\n+            return;\n+        }\n+\n+        OpenOffer openOffer = openOfferOptional.get();\n+        if (openOffer.getState() != OpenOffer.State.AVAILABLE) {\n+            return;\n+        }\n+\n+        Offer offer = openOffer.getOffer();\n+        openOfferManager.reserveOpenOffer(openOffer);\n+        Trade trade;\n+        if (offer.isBuyOffer()) {\n+            trade = new BuyerAsMakerTrade(offer,\n+                    Coin.valueOf(takeOfferRequest.getTxFee()),\n+                    Coin.valueOf(takeOfferRequest.getTakerFee()),\n+                    takeOfferRequest.isCurrencyForTakerFeeBtc(),\n+                    openOffer.getArbitratorNodeAddress(),\n+                    openOffer.getMediatorNodeAddress(),\n+                    openOffer.getRefundAgentNodeAddress(),\n+                    tradableListStorage,\n+                    btcWalletService,\n+                    getNewProcessModel(offer));\n+        } else {\n+            trade = new SellerAsMakerTrade(offer,\n+                    Coin.valueOf(takeOfferRequest.getTxFee()),\n+                    Coin.valueOf(takeOfferRequest.getTakerFee()),\n+                    takeOfferRequest.isCurrencyForTakerFeeBtc(),\n+                    openOffer.getArbitratorNodeAddress(),\n+                    openOffer.getMediatorNodeAddress(),\n+                    openOffer.getRefundAgentNodeAddress(),\n+                    tradableListStorage,\n+                    btcWalletService,\n+                    getNewProcessModel(offer));\n+        }\n+        TradeProtocol tradeProtocol = TradeProtocolFactory.getNewTradeProtocol(trade);\n+        tradeProtocolByTradeId.put(trade.getId(), tradeProtocol);\n+        tradableList.add(trade);\n+        initTradeAndProtocol(trade, tradeProtocol);\n+\n+        ((MakerProtocol) tradeProtocol).handleTakeOfferRequest(takeOfferRequest, peer, errorMessage -> {\n+            if (takeOfferRequestErrorMessageHandler != null)\n+                takeOfferRequestErrorMessageHandler.handleErrorMessage(errorMessage);\n+        });\n+    }\n+\n+\n     ///////////////////////////////////////////////////////////////////////////////////////////\n     // Lifecycle\n     ///////////////////////////////////////////////////////////////////////////////////////////\n \n     public void onAllServicesInitialized() {\n-        if (p2PService.isBootstrapped())\n-            initPendingTrades();\n-        else\n+        if (p2PService.isBootstrapped()) {\n+            initPersistedTrades();\n+        } else {\n             p2PService.addP2PServiceListener(new BootstrapListener() {\n                 @Override\n                 public void onUpdatedDataReceived() {\n-                    // Get called after onMailboxMessageAdded from initial data request\n-                    // The mailbox message will be removed inside the tasks after they are processed successfully\n-                    initPendingTrades();\n+                    initPersistedTrades();\n                 }\n             });\n+        }\n \n-        tradableList.getList().addListener((ListChangeListener<Trade>) change -> onTradesChanged());\n+        getTradesAsObservableList().addListener((ListChangeListener<Trade>) change -> onTradesChanged());\n         onTradesChanged();\n \n-        getAddressEntriesForAvailableBalanceStream()\n+        btcWalletService.getAddressEntriesForAvailableBalanceStream()\n                 .filter(addressEntry -> addressEntry.getOfferId() != null)\n                 .forEach(addressEntry -> {\n                     log.warn(\"Swapping pending OFFER_FUNDING entries at startup. offerId={}\", addressEntry.getOfferId());\n                     btcWalletService.swapTradeEntryToAvailableEntry(addressEntry.getOfferId(), AddressEntry.Context.OFFER_FUNDING);", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4MjUzNg==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496282536", "bodyText": "It was old code as well and I was wondering as well if its really needed. But did not want to risk to remove it or spend more time to think about the context. Not sure I can add a meaningful comment without starting to look more closely into it why it was added. I think it is a just a cleanup if address entries have not been swapped as intended in some error cases... We dont want that BitcoinJ creates too many addresses as it makes the wallet slower.", "author": "chimp1984", "createdAt": "2020-09-28T23:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1NjM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkwMjYzNA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r495902634", "bodyText": "Why change the copyright notice?", "author": "sqrrm", "createdAt": "2020-09-28T12:33:03Z", "path": "core/src/main/java/bisq/core/trade/protocol/BuyerAsMakerProtocol.java", "diffHunk": "@@ -11,7 +11,7 @@\n  * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n  * License for more details.\n  *\n- * You should have received a copy of the GNU Affero General Public License\n+ * You should have with a copy of the GNU Affero General Public License", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4Mjk4OQ==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496282989", "bodyText": "Ups, that was from some replace all, I guess. Will revert it.", "author": "chimp1984", "createdAt": "2020-09-28T23:05:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkwMjYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk1MjY2MA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r495952660", "bodyText": "Might want to return early to avoid large blocks", "author": "sqrrm", "createdAt": "2020-09-28T13:48:01Z", "path": "core/src/main/java/bisq/core/trade/protocol/FluentProtocol.java", "diffHunk": "@@ -0,0 +1,380 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.trade.protocol;\n+\n+import bisq.core.trade.Trade;\n+import bisq.core.trade.messages.TradeMessage;\n+\n+import bisq.network.p2p.NodeAddress;\n+\n+import bisq.common.taskrunner.Task;\n+\n+import java.text.MessageFormat;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.function.Consumer;\n+\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import javax.annotation.Nullable;\n+\n+import static bisq.core.util.Validator.isTradeIdValid;\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+// Main class. Contains the condition and setup, if condition is valid it will execute the\n+// taskRunner and the optional runnable.\n+public class FluentProtocol {\n+\n+\n+    interface Event {\n+        String name();\n+    }\n+\n+    private final TradeProtocol tradeProtocol;\n+    private Condition condition;\n+    private Setup setup;\n+    private Consumer<Condition.Result> resultHandler;\n+\n+    public FluentProtocol(TradeProtocol tradeProtocol) {\n+        this.tradeProtocol = tradeProtocol;\n+    }\n+\n+    protected FluentProtocol condition(Condition condition) {\n+        this.condition = condition;\n+        return this;\n+    }\n+\n+    protected FluentProtocol setup(Setup setup) {\n+        this.setup = setup;\n+        return this;\n+    }\n+\n+\n+    public FluentProtocol resultHandler(Consumer<Condition.Result> resultHandler) {\n+        this.resultHandler = resultHandler;\n+        return this;\n+    }\n+\n+    // Can be used before or after executeTasks\n+    public FluentProtocol run(Runnable runnable) {\n+        Condition.Result result = condition.getResult();\n+        if (result.isValid) {\n+            runnable.run();\n+        } else if (resultHandler != null) {\n+            resultHandler.accept(result);\n+        }\n+        return this;\n+    }\n+\n+    public FluentProtocol executeTasks() {\n+        Condition.Result result = condition.getResult();\n+        if (result.isValid) {", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4Mzg4Mw==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496283883", "bodyText": "Ok. Will change.", "author": "chimp1984", "createdAt": "2020-09-28T23:08:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk1MjY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk2MDYyNw==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r495960627", "bodyText": "Could return early for non null taskRunner...", "author": "sqrrm", "createdAt": "2020-09-28T13:58:45Z", "path": "core/src/main/java/bisq/core/trade/protocol/FluentProtocol.java", "diffHunk": "@@ -0,0 +1,380 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.trade.protocol;\n+\n+import bisq.core.trade.Trade;\n+import bisq.core.trade.messages.TradeMessage;\n+\n+import bisq.network.p2p.NodeAddress;\n+\n+import bisq.common.taskrunner.Task;\n+\n+import java.text.MessageFormat;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.function.Consumer;\n+\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import javax.annotation.Nullable;\n+\n+import static bisq.core.util.Validator.isTradeIdValid;\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+// Main class. Contains the condition and setup, if condition is valid it will execute the\n+// taskRunner and the optional runnable.\n+public class FluentProtocol {\n+\n+\n+    interface Event {\n+        String name();\n+    }\n+\n+    private final TradeProtocol tradeProtocol;\n+    private Condition condition;\n+    private Setup setup;\n+    private Consumer<Condition.Result> resultHandler;\n+\n+    public FluentProtocol(TradeProtocol tradeProtocol) {\n+        this.tradeProtocol = tradeProtocol;\n+    }\n+\n+    protected FluentProtocol condition(Condition condition) {\n+        this.condition = condition;\n+        return this;\n+    }\n+\n+    protected FluentProtocol setup(Setup setup) {\n+        this.setup = setup;\n+        return this;\n+    }\n+\n+\n+    public FluentProtocol resultHandler(Consumer<Condition.Result> resultHandler) {\n+        this.resultHandler = resultHandler;\n+        return this;\n+    }\n+\n+    // Can be used before or after executeTasks\n+    public FluentProtocol run(Runnable runnable) {\n+        Condition.Result result = condition.getResult();\n+        if (result.isValid) {\n+            runnable.run();\n+        } else if (resultHandler != null) {\n+            resultHandler.accept(result);\n+        }\n+        return this;\n+    }\n+\n+    public FluentProtocol executeTasks() {\n+        Condition.Result result = condition.getResult();\n+        if (result.isValid) {\n+            if (setup.getTimeoutSec() > 0) {\n+                tradeProtocol.startTimeout(setup.getTimeoutSec());\n+            }\n+\n+            NodeAddress peer = condition.getPeer();\n+            if (peer != null) {\n+                tradeProtocol.processModel.setTempTradingPeerNodeAddress(peer);\n+            }\n+\n+            TradeMessage message = condition.getMessage();\n+            if (message != null) {\n+                tradeProtocol.processModel.setTradeMessage(message);\n+            }\n+\n+            TradeTaskRunner taskRunner = setup.getTaskRunner(message, condition.getEvent());\n+            taskRunner.addTasks(setup.getTasks());\n+            taskRunner.run();\n+        } else if (resultHandler != null) {\n+            resultHandler.accept(result);\n+        }\n+        return this;\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Condition class\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    @Slf4j\n+    public static class Condition {\n+        enum Result {\n+            VALID(true),\n+            INVALID_PHASE,\n+            INVALID_STATE,\n+            INVALID_PRE_CONDITION,\n+            INVALID_TRADE_ID;\n+\n+            @Getter\n+            private boolean isValid;\n+            @Getter\n+            private String info;\n+\n+            Result() {\n+            }\n+\n+            Result(boolean isValid) {\n+                this.isValid = isValid;\n+            }\n+\n+            public Result info(String info) {\n+                this.info = info;\n+                return this;\n+            }\n+        }\n+\n+        private final Set<Trade.Phase> expectedPhases = new HashSet<>();\n+        private final Set<Trade.State> expectedStates = new HashSet<>();\n+        private final Set<Boolean> preConditions = new HashSet<>();\n+        private final Trade trade;\n+        @Nullable\n+        private Result result;\n+\n+        @Nullable\n+        @Getter\n+        private TradeMessage message;\n+        @Nullable\n+        @Getter\n+        private Event event;\n+        @Nullable\n+        @Getter\n+        private NodeAddress peer;\n+        @Nullable\n+        private Runnable preConditionFailedHandler;\n+\n+\n+        public Condition(Trade trade) {\n+            this.trade = trade;\n+        }\n+\n+        public Condition phase(Trade.Phase expectedPhase) {\n+            checkArgument(result == null);\n+            this.expectedPhases.add(expectedPhase);\n+            return this;\n+        }\n+\n+        public Condition anyPhase(Trade.Phase... expectedPhases) {\n+            checkArgument(result == null);\n+            this.expectedPhases.addAll(Set.of(expectedPhases));\n+            return this;\n+        }\n+\n+        public Condition state(Trade.State state) {\n+            checkArgument(result == null);\n+            this.expectedStates.add(state);\n+            return this;\n+        }\n+\n+        public Condition anyState(Trade.State... states) {\n+            checkArgument(result == null);\n+            this.expectedStates.addAll(Set.of(states));\n+            return this;\n+        }\n+\n+        public Condition with(TradeMessage message) {\n+            checkArgument(result == null);\n+            this.message = message;\n+            return this;\n+        }\n+\n+        public Condition with(Event event) {\n+            checkArgument(result == null);\n+            this.event = event;\n+            return this;\n+        }\n+\n+        public Condition from(NodeAddress peer) {\n+            checkArgument(result == null);\n+            this.peer = peer;\n+            return this;\n+        }\n+\n+        public Condition preCondition(boolean preCondition) {\n+            checkArgument(result == null);\n+            preConditions.add(preCondition);\n+            return this;\n+        }\n+\n+        public Condition preCondition(boolean preCondition, Runnable conditionFailedHandler) {\n+            checkArgument(result == null);\n+            preCondition(preCondition);\n+\n+            this.preConditionFailedHandler = conditionFailedHandler;\n+            return this;\n+        }\n+\n+        public Result getResult() {\n+            if (result == null) {\n+                boolean isTradeIdValid = message == null || isTradeIdValid(trade.getId(), message);\n+                if (!isTradeIdValid) {\n+                    String info = MessageFormat.format(\"TradeId does not match tradeId in message, TradeId={0}, tradeId in message={1}\",\n+                            trade.getId(), message.getTradeId());\n+                    result = Result.INVALID_TRADE_ID.info(info);\n+                    return result;\n+                }\n+\n+\n+                Result phaseValidationResult = getPhaseResult();\n+                if (!phaseValidationResult.isValid) {\n+                    result = phaseValidationResult;\n+                    return result;\n+                }\n+\n+                Result stateResult = getStateResult();\n+                if (!stateResult.isValid) {\n+                    result = stateResult;\n+                    return result;\n+                }\n+\n+                boolean allPreConditionsMet = preConditions.stream().allMatch(e -> e);\n+                if (!allPreConditionsMet) {\n+                    String info = MessageFormat.format(\"PreConditions not met. preConditions={0}, this={1}, tradeId={2}\",\n+                            preConditions, this, trade.getId());\n+                    result = Result.INVALID_PRE_CONDITION.info(info);\n+\n+                    if (preConditionFailedHandler != null) {\n+                        preConditionFailedHandler.run();\n+                    }\n+                    return result;\n+                }\n+\n+                result = Result.VALID;\n+            }\n+            return result;\n+        }\n+\n+        private Result getPhaseResult() {\n+            if (expectedPhases.isEmpty()) {\n+                return Result.VALID;\n+            }\n+\n+            boolean isPhaseValid = expectedPhases.stream().anyMatch(e -> e == trade.getPhase());\n+            String trigger = message != null ?\n+                    message.getClass().getSimpleName() :\n+                    event != null ?\n+                            event.name() + \" event\" :\n+                            \"\";\n+            if (isPhaseValid) {\n+                String info = MessageFormat.format(\"We received a {0} at phase {1} and state {2}, tradeId={3}\",\n+                        trigger,\n+                        trade.getPhase(),\n+                        trade.getState(),\n+                        trade.getId());\n+                log.info(info);\n+                return Result.VALID.info(info);\n+            } else {\n+                String info = MessageFormat.format(\"We received a {0} but we are are not in the expected phase. \" +\n+                                \"Expected phases={1}, Trade phase={2}, Trade state= {3}, tradeId={4}\",\n+                        trigger,\n+                        expectedPhases,\n+                        trade.getPhase(),\n+                        trade.getState(),\n+                        trade.getId());\n+                return Result.INVALID_PHASE.info(info);\n+            }\n+        }\n+\n+        private Result getStateResult() {\n+            if (expectedStates.isEmpty()) {\n+                return Result.VALID;\n+            }\n+\n+            boolean isStateValid = expectedStates.stream().anyMatch(e -> e == trade.getState());\n+            String trigger = message != null ?\n+                    message.getClass().getSimpleName() :\n+                    event != null ?\n+                            event.name() + \" event\" :\n+                            \"\";\n+            if (isStateValid) {\n+                String info = MessageFormat.format(\"We received a {0} at state {1}, tradeId={2}\",\n+                        trigger,\n+                        trade.getState(),\n+                        trade.getId());\n+                log.info(info);\n+                return Result.VALID.info(info);\n+            } else {\n+                String info = MessageFormat.format(\"We received a {0} but we are are not in the expected state. \" +\n+                                \"Expected states={1}, Trade state= {2}, tradeId={3}\",\n+                        trigger,\n+                        expectedStates,\n+                        trade.getState(),\n+                        trade.getId());\n+                return Result.INVALID_STATE.info(info);\n+            }\n+        }\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Setup class\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    @Slf4j\n+    public static class Setup {\n+        private final TradeProtocol tradeProtocol;\n+        private final Trade trade;\n+        @Getter\n+        private Class<? extends Task<Trade>>[] tasks;\n+        @Getter\n+        private int timeoutSec;\n+        @Nullable\n+        private TradeTaskRunner taskRunner;\n+\n+        public Setup(TradeProtocol tradeProtocol, Trade trade) {\n+            this.tradeProtocol = tradeProtocol;\n+            this.trade = trade;\n+        }\n+\n+        @SafeVarargs\n+        public final Setup tasks(Class<? extends Task<Trade>>... tasks) {\n+            this.tasks = tasks;\n+            return this;\n+        }\n+\n+        public Setup withTimeout(int timeoutSec) {\n+            this.timeoutSec = timeoutSec;\n+            return this;\n+        }\n+\n+        public Setup using(TradeTaskRunner taskRunner) {\n+            this.taskRunner = taskRunner;\n+            return this;\n+        }\n+\n+        public TradeTaskRunner getTaskRunner(@Nullable TradeMessage message, @Nullable Event event) {\n+            if (taskRunner == null) {", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk2NjgwMA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r495966800", "bodyText": "Changed copyright text", "author": "sqrrm", "createdAt": "2020-09-28T14:06:51Z", "path": "core/src/main/java/bisq/core/trade/protocol/BuyerAsTakerProtocol.java", "diffHunk": "@@ -11,7 +11,7 @@\n  * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n  * License for more details.\n  *\n- * You should have received a copy of the GNU Affero General Public License\n+ * You should have with a copy of the GNU Affero General Public License", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5MDU4Nw==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r495990587", "bodyText": "Should DEPOSIT_PUBLISHED really be expected? I thought deposit would only be published after this message was acked.", "author": "sqrrm", "createdAt": "2020-09-28T14:39:50Z", "path": "core/src/main/java/bisq/core/trade/protocol/BuyerProtocol.java", "diffHunk": "@@ -17,9 +17,176 @@\n \n package bisq.core.trade.protocol;\n \n+import bisq.core.trade.BuyerTrade;\n+import bisq.core.trade.Trade;\n+import bisq.core.trade.messages.DelayedPayoutTxSignatureRequest;\n+import bisq.core.trade.messages.DepositTxAndDelayedPayoutTxMessage;\n+import bisq.core.trade.messages.PayoutTxPublishedMessage;\n+import bisq.core.trade.messages.TradeMessage;\n+import bisq.core.trade.protocol.tasks.ApplyFilter;\n+import bisq.core.trade.protocol.tasks.PublishTradeStatistics;\n+import bisq.core.trade.protocol.tasks.TradeTask;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerProcessDepositTxAndDelayedPayoutTxMessage;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerProcessPayoutTxPublishedMessage;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSendCounterCurrencyTransferStartedMessage;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSetupDepositTxListener;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSetupPayoutTxListener;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSignPayoutTx;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerVerifiesFinalDelayedPayoutTx;\n+\n+import bisq.network.p2p.NodeAddress;\n+\n import bisq.common.handlers.ErrorMessageHandler;\n import bisq.common.handlers.ResultHandler;\n \n-public interface BuyerProtocol {\n-    void onFiatPaymentStarted(ResultHandler resultHandler, ErrorMessageHandler errorMessageHandler);\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public abstract class BuyerProtocol extends DisputeProtocol {\n+    enum BuyerEvent implements FluentProtocol.Event {\n+        STARTUP,\n+        PAYMENT_SENT\n+    }\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Constructor\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    public BuyerProtocol(BuyerTrade trade) {\n+        super(trade);\n+    }\n+\n+    @Override\n+    protected void onInitialized() {\n+        super.onInitialized();\n+        // We get called the constructor with any possible state and phase. As we don't want to log an error for such\n+        // cases we use the alternative 'given' method instead of 'expect'.\n+        given(phase(Trade.Phase.TAKER_FEE_PUBLISHED)\n+                .with(BuyerEvent.STARTUP))\n+                .setup(tasks(BuyerSetupDepositTxListener.class))\n+                .executeTasks();\n+\n+        given(anyPhase(Trade.Phase.FIAT_SENT, Trade.Phase.FIAT_RECEIVED)\n+                .with(BuyerEvent.STARTUP))\n+                .setup(tasks(BuyerSetupPayoutTxListener.class))\n+                .executeTasks();\n+\n+        given(anyPhase(Trade.Phase.FIAT_SENT, Trade.Phase.FIAT_RECEIVED)\n+                .anyState(Trade.State.BUYER_STORED_IN_MAILBOX_FIAT_PAYMENT_INITIATED_MSG,\n+                        Trade.State.BUYER_SEND_FAILED_FIAT_PAYMENT_INITIATED_MSG)\n+                .with(BuyerEvent.STARTUP))\n+                .setup(tasks(BuyerSendCounterCurrencyTransferStartedMessage.class))\n+                .executeTasks();\n+    }\n+\n+    @Override\n+    public void onMailboxMessage(TradeMessage message, NodeAddress peer) {\n+        super.onMailboxMessage(message, peer);\n+\n+        if (message instanceof DepositTxAndDelayedPayoutTxMessage) {\n+            handle((DepositTxAndDelayedPayoutTxMessage) message, peer);\n+        } else if (message instanceof PayoutTxPublishedMessage) {\n+            handle((PayoutTxPublishedMessage) message, peer);\n+        }\n+    }\n+\n+    protected abstract void handle(DelayedPayoutTxSignatureRequest message, NodeAddress peer);\n+\n+    // The DepositTxAndDelayedPayoutTxMessage is a mailbox message as earlier we use only the deposit tx which can\n+    // be also with from the network once published.\n+    // Now we send the delayed payout tx as well and with that this message is mandatory for continuing the protocol.\n+    // We do not support mailbox message handling during the take offer process as it is expected that both peers\n+    // are online.\n+    // For backward compatibility and extra resilience we still keep DepositTxAndDelayedPayoutTxMessage as a\n+    // mailbox message but the stored in mailbox case is not expected and the seller would try to send the message again\n+    // in the hope to reach the buyer directly.\n+    protected void handle(DepositTxAndDelayedPayoutTxMessage message, NodeAddress peer) {\n+        expect(anyPhase(Trade.Phase.TAKER_FEE_PUBLISHED, Trade.Phase.DEPOSIT_PUBLISHED)", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5MTEyMA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r495991120", "bodyText": "This log is quite odd, We with a...", "author": "sqrrm", "createdAt": "2020-09-28T14:40:32Z", "path": "core/src/main/java/bisq/core/trade/protocol/BuyerProtocol.java", "diffHunk": "@@ -17,9 +17,176 @@\n \n package bisq.core.trade.protocol;\n \n+import bisq.core.trade.BuyerTrade;\n+import bisq.core.trade.Trade;\n+import bisq.core.trade.messages.DelayedPayoutTxSignatureRequest;\n+import bisq.core.trade.messages.DepositTxAndDelayedPayoutTxMessage;\n+import bisq.core.trade.messages.PayoutTxPublishedMessage;\n+import bisq.core.trade.messages.TradeMessage;\n+import bisq.core.trade.protocol.tasks.ApplyFilter;\n+import bisq.core.trade.protocol.tasks.PublishTradeStatistics;\n+import bisq.core.trade.protocol.tasks.TradeTask;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerProcessDepositTxAndDelayedPayoutTxMessage;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerProcessPayoutTxPublishedMessage;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSendCounterCurrencyTransferStartedMessage;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSetupDepositTxListener;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSetupPayoutTxListener;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSignPayoutTx;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerVerifiesFinalDelayedPayoutTx;\n+\n+import bisq.network.p2p.NodeAddress;\n+\n import bisq.common.handlers.ErrorMessageHandler;\n import bisq.common.handlers.ResultHandler;\n \n-public interface BuyerProtocol {\n-    void onFiatPaymentStarted(ResultHandler resultHandler, ErrorMessageHandler errorMessageHandler);\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public abstract class BuyerProtocol extends DisputeProtocol {\n+    enum BuyerEvent implements FluentProtocol.Event {\n+        STARTUP,\n+        PAYMENT_SENT\n+    }\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Constructor\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    public BuyerProtocol(BuyerTrade trade) {\n+        super(trade);\n+    }\n+\n+    @Override\n+    protected void onInitialized() {\n+        super.onInitialized();\n+        // We get called the constructor with any possible state and phase. As we don't want to log an error for such\n+        // cases we use the alternative 'given' method instead of 'expect'.\n+        given(phase(Trade.Phase.TAKER_FEE_PUBLISHED)\n+                .with(BuyerEvent.STARTUP))\n+                .setup(tasks(BuyerSetupDepositTxListener.class))\n+                .executeTasks();\n+\n+        given(anyPhase(Trade.Phase.FIAT_SENT, Trade.Phase.FIAT_RECEIVED)\n+                .with(BuyerEvent.STARTUP))\n+                .setup(tasks(BuyerSetupPayoutTxListener.class))\n+                .executeTasks();\n+\n+        given(anyPhase(Trade.Phase.FIAT_SENT, Trade.Phase.FIAT_RECEIVED)\n+                .anyState(Trade.State.BUYER_STORED_IN_MAILBOX_FIAT_PAYMENT_INITIATED_MSG,\n+                        Trade.State.BUYER_SEND_FAILED_FIAT_PAYMENT_INITIATED_MSG)\n+                .with(BuyerEvent.STARTUP))\n+                .setup(tasks(BuyerSendCounterCurrencyTransferStartedMessage.class))\n+                .executeTasks();\n+    }\n+\n+    @Override\n+    public void onMailboxMessage(TradeMessage message, NodeAddress peer) {\n+        super.onMailboxMessage(message, peer);\n+\n+        if (message instanceof DepositTxAndDelayedPayoutTxMessage) {\n+            handle((DepositTxAndDelayedPayoutTxMessage) message, peer);\n+        } else if (message instanceof PayoutTxPublishedMessage) {\n+            handle((PayoutTxPublishedMessage) message, peer);\n+        }\n+    }\n+\n+    protected abstract void handle(DelayedPayoutTxSignatureRequest message, NodeAddress peer);\n+\n+    // The DepositTxAndDelayedPayoutTxMessage is a mailbox message as earlier we use only the deposit tx which can\n+    // be also with from the network once published.\n+    // Now we send the delayed payout tx as well and with that this message is mandatory for continuing the protocol.\n+    // We do not support mailbox message handling during the take offer process as it is expected that both peers\n+    // are online.\n+    // For backward compatibility and extra resilience we still keep DepositTxAndDelayedPayoutTxMessage as a\n+    // mailbox message but the stored in mailbox case is not expected and the seller would try to send the message again\n+    // in the hope to reach the buyer directly.\n+    protected void handle(DepositTxAndDelayedPayoutTxMessage message, NodeAddress peer) {\n+        expect(anyPhase(Trade.Phase.TAKER_FEE_PUBLISHED, Trade.Phase.DEPOSIT_PUBLISHED)\n+                .with(message)\n+                .from(peer)\n+                .preCondition(trade.getDepositTx() == null || trade.getDelayedPayoutTx() == null,\n+                        () -> {\n+                            log.warn(\"We with a DepositTxAndDelayedPayoutTxMessage but we have already processed the deposit and \" +", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAwNDc3Mw==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496004773", "bodyText": "Suggested change", "author": "sqrrm", "createdAt": "2020-09-28T14:55:54Z", "path": "core/src/main/java/bisq/core/trade/protocol/BuyerProtocol.java", "diffHunk": "@@ -17,9 +17,176 @@\n \n package bisq.core.trade.protocol;\n \n+import bisq.core.trade.BuyerTrade;\n+import bisq.core.trade.Trade;\n+import bisq.core.trade.messages.DelayedPayoutTxSignatureRequest;\n+import bisq.core.trade.messages.DepositTxAndDelayedPayoutTxMessage;\n+import bisq.core.trade.messages.PayoutTxPublishedMessage;\n+import bisq.core.trade.messages.TradeMessage;\n+import bisq.core.trade.protocol.tasks.ApplyFilter;\n+import bisq.core.trade.protocol.tasks.PublishTradeStatistics;\n+import bisq.core.trade.protocol.tasks.TradeTask;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerProcessDepositTxAndDelayedPayoutTxMessage;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerProcessPayoutTxPublishedMessage;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSendCounterCurrencyTransferStartedMessage;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSetupDepositTxListener;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSetupPayoutTxListener;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerSignPayoutTx;\n+import bisq.core.trade.protocol.tasks.buyer.BuyerVerifiesFinalDelayedPayoutTx;\n+\n+import bisq.network.p2p.NodeAddress;\n+\n import bisq.common.handlers.ErrorMessageHandler;\n import bisq.common.handlers.ResultHandler;\n \n-public interface BuyerProtocol {\n-    void onFiatPaymentStarted(ResultHandler resultHandler, ErrorMessageHandler errorMessageHandler);\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public abstract class BuyerProtocol extends DisputeProtocol {\n+    enum BuyerEvent implements FluentProtocol.Event {\n+        STARTUP,\n+        PAYMENT_SENT\n+    }\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Constructor\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    public BuyerProtocol(BuyerTrade trade) {\n+        super(trade);\n+    }\n+\n+    @Override\n+    protected void onInitialized() {\n+        super.onInitialized();\n+        // We get called the constructor with any possible state and phase. As we don't want to log an error for such\n+        // cases we use the alternative 'given' method instead of 'expect'.\n+        given(phase(Trade.Phase.TAKER_FEE_PUBLISHED)\n+                .with(BuyerEvent.STARTUP))\n+                .setup(tasks(BuyerSetupDepositTxListener.class))\n+                .executeTasks();\n+\n+        given(anyPhase(Trade.Phase.FIAT_SENT, Trade.Phase.FIAT_RECEIVED)\n+                .with(BuyerEvent.STARTUP))\n+                .setup(tasks(BuyerSetupPayoutTxListener.class))\n+                .executeTasks();\n+\n+        given(anyPhase(Trade.Phase.FIAT_SENT, Trade.Phase.FIAT_RECEIVED)\n+                .anyState(Trade.State.BUYER_STORED_IN_MAILBOX_FIAT_PAYMENT_INITIATED_MSG,\n+                        Trade.State.BUYER_SEND_FAILED_FIAT_PAYMENT_INITIATED_MSG)\n+                .with(BuyerEvent.STARTUP))\n+                .setup(tasks(BuyerSendCounterCurrencyTransferStartedMessage.class))\n+                .executeTasks();\n+    }\n+\n+    @Override\n+    public void onMailboxMessage(TradeMessage message, NodeAddress peer) {\n+        super.onMailboxMessage(message, peer);\n+\n+        if (message instanceof DepositTxAndDelayedPayoutTxMessage) {\n+            handle((DepositTxAndDelayedPayoutTxMessage) message, peer);\n+        } else if (message instanceof PayoutTxPublishedMessage) {\n+            handle((PayoutTxPublishedMessage) message, peer);\n+        }\n+    }\n+\n+    protected abstract void handle(DelayedPayoutTxSignatureRequest message, NodeAddress peer);\n+\n+    // The DepositTxAndDelayedPayoutTxMessage is a mailbox message as earlier we use only the deposit tx which can\n+    // be also with from the network once published.\n+    // Now we send the delayed payout tx as well and with that this message is mandatory for continuing the protocol.\n+    // We do not support mailbox message handling during the take offer process as it is expected that both peers\n+    // are online.\n+    // For backward compatibility and extra resilience we still keep DepositTxAndDelayedPayoutTxMessage as a\n+    // mailbox message but the stored in mailbox case is not expected and the seller would try to send the message again\n+    // in the hope to reach the buyer directly.\n+    protected void handle(DepositTxAndDelayedPayoutTxMessage message, NodeAddress peer) {\n+        expect(anyPhase(Trade.Phase.TAKER_FEE_PUBLISHED, Trade.Phase.DEPOSIT_PUBLISHED)\n+                .with(message)\n+                .from(peer)\n+                .preCondition(trade.getDepositTx() == null || trade.getDelayedPayoutTx() == null,\n+                        () -> {\n+                            log.warn(\"We with a DepositTxAndDelayedPayoutTxMessage but we have already processed the deposit and \" +\n+                                    \"delayed payout tx so we ignore the message. This can happen if the ACK message to the peer did not \" +\n+                                    \"arrive and the peer repeats sending us the message. We send another ACK msg.\");\n+                            stopTimeout();\n+                            sendAckMessage(message, true, null);\n+                            removeMailboxMessageAfterProcessing(message);\n+                        }))\n+                .setup(tasks(BuyerProcessDepositTxAndDelayedPayoutTxMessage.class,\n+                        BuyerVerifiesFinalDelayedPayoutTx.class,\n+                        PublishTradeStatistics.class)\n+                        .using(new TradeTaskRunner(trade,\n+                                () -> {\n+                                    stopTimeout();\n+                                    handleTaskRunnerSuccess(message);\n+                                },\n+                                errorMessage -> handleTaskRunnerFault(message, errorMessage))))\n+                .run(() -> processModel.witnessDebugLog(trade))\n+                .executeTasks();\n+    }\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // User interaction\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    public void onPaymentStarted(ResultHandler resultHandler, ErrorMessageHandler errorMessageHandler) {\n+        BuyerEvent event = BuyerEvent.PAYMENT_SENT;\n+        expect(phase(Trade.Phase.DEPOSIT_CONFIRMED)\n+                .with(event)\n+                .preCondition(notDisputed()))\n+                .setup(tasks(ApplyFilter.class,\n+                        getVerifyPeersFeePaymentClass(),\n+                        BuyerSignPayoutTx.class,\n+                        BuyerSetupPayoutTxListener.class,\n+                        BuyerSendCounterCurrencyTransferStartedMessage.class)\n+                        .using(new TradeTaskRunner(trade,\n+                                () -> {\n+                                    resultHandler.handleResult();\n+                                    handleTaskRunnerSuccess(event);\n+                                },\n+                                (errorMessage) -> {\n+                                    errorMessageHandler.handleErrorMessage(errorMessage);\n+                                    handleTaskRunnerFault(event, errorMessage);\n+                                })))\n+                .run(() -> trade.setState(Trade.State.BUYER_CONFIRMED_IN_UI_FIAT_PAYMENT_INITIATED))\n+                .executeTasks();\n+    }\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Incoming message Payout tx\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    protected void handle(PayoutTxPublishedMessage message, NodeAddress peer) {\n+        expect(anyPhase(Trade.Phase.FIAT_SENT, Trade.Phase.PAYOUT_PUBLISHED)\n+                .with(message)\n+                .from(peer))\n+                .setup(tasks(BuyerProcessPayoutTxPublishedMessage.class))\n+                .executeTasks();\n+", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAwNzg5MQ==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496007891", "bodyText": "ARBITRATION generally refers to legacy arbitration in code. REFUND is what's been used everywhere for refund cases.", "author": "sqrrm", "createdAt": "2020-09-28T14:58:34Z", "path": "core/src/main/java/bisq/core/trade/protocol/DisputeProtocol.java", "diffHunk": "@@ -0,0 +1,212 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.trade.protocol;\n+\n+import bisq.core.trade.Trade;\n+import bisq.core.trade.messages.MediatedPayoutTxPublishedMessage;\n+import bisq.core.trade.messages.MediatedPayoutTxSignatureMessage;\n+import bisq.core.trade.messages.PeerPublishedDelayedPayoutTxMessage;\n+import bisq.core.trade.messages.TradeMessage;\n+import bisq.core.trade.protocol.tasks.ApplyFilter;\n+import bisq.core.trade.protocol.tasks.ProcessPeerPublishedDelayedPayoutTxMessage;\n+import bisq.core.trade.protocol.tasks.arbitration.PublishedDelayedPayoutTx;\n+import bisq.core.trade.protocol.tasks.arbitration.SendPeerPublishedDelayedPayoutTxMessage;\n+import bisq.core.trade.protocol.tasks.mediation.BroadcastMediatedPayoutTx;\n+import bisq.core.trade.protocol.tasks.mediation.FinalizeMediatedPayoutTx;\n+import bisq.core.trade.protocol.tasks.mediation.ProcessMediatedPayoutSignatureMessage;\n+import bisq.core.trade.protocol.tasks.mediation.ProcessMediatedPayoutTxPublishedMessage;\n+import bisq.core.trade.protocol.tasks.mediation.SendMediatedPayoutSignatureMessage;\n+import bisq.core.trade.protocol.tasks.mediation.SendMediatedPayoutTxPublishedMessage;\n+import bisq.core.trade.protocol.tasks.mediation.SetupMediatedPayoutTxListener;\n+import bisq.core.trade.protocol.tasks.mediation.SignMediatedPayoutTx;\n+\n+import bisq.network.p2p.NodeAddress;\n+\n+import bisq.common.handlers.ErrorMessageHandler;\n+import bisq.common.handlers.ResultHandler;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public class DisputeProtocol extends TradeProtocol {\n+\n+    enum DisputeEvent implements FluentProtocol.Event {\n+        MEDIATION_RESULT_ACCEPTED,\n+        MEDIATION_RESULT_REJECTED,\n+        ARBITRATION_REQUESTED", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAxODIxMQ==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496018211", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (message instanceof MediatedPayoutTxSignatureMessage) {\n          \n          \n            \n                        handle((MediatedPayoutTxSignatureMessage) message, peer);\n          \n          \n            \n                    } else if (message instanceof MediatedPayoutTxPublishedMessage) {\n          \n          \n            \n                        handle((MediatedPayoutTxPublishedMessage) message, peer);\n          \n          \n            \n                    } else if (message instanceof PeerPublishedDelayedPayoutTxMessage) {\n          \n          \n            \n                        handle((PeerPublishedDelayedPayoutTxMessage) message, peer);\n          \n          \n            \n                    }\n          \n          \n            \n                    onTradeMessage(message, peer);", "author": "sqrrm", "createdAt": "2020-09-28T15:07:15Z", "path": "core/src/main/java/bisq/core/trade/protocol/DisputeProtocol.java", "diffHunk": "@@ -0,0 +1,212 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.trade.protocol;\n+\n+import bisq.core.trade.Trade;\n+import bisq.core.trade.messages.MediatedPayoutTxPublishedMessage;\n+import bisq.core.trade.messages.MediatedPayoutTxSignatureMessage;\n+import bisq.core.trade.messages.PeerPublishedDelayedPayoutTxMessage;\n+import bisq.core.trade.messages.TradeMessage;\n+import bisq.core.trade.protocol.tasks.ApplyFilter;\n+import bisq.core.trade.protocol.tasks.ProcessPeerPublishedDelayedPayoutTxMessage;\n+import bisq.core.trade.protocol.tasks.arbitration.PublishedDelayedPayoutTx;\n+import bisq.core.trade.protocol.tasks.arbitration.SendPeerPublishedDelayedPayoutTxMessage;\n+import bisq.core.trade.protocol.tasks.mediation.BroadcastMediatedPayoutTx;\n+import bisq.core.trade.protocol.tasks.mediation.FinalizeMediatedPayoutTx;\n+import bisq.core.trade.protocol.tasks.mediation.ProcessMediatedPayoutSignatureMessage;\n+import bisq.core.trade.protocol.tasks.mediation.ProcessMediatedPayoutTxPublishedMessage;\n+import bisq.core.trade.protocol.tasks.mediation.SendMediatedPayoutSignatureMessage;\n+import bisq.core.trade.protocol.tasks.mediation.SendMediatedPayoutTxPublishedMessage;\n+import bisq.core.trade.protocol.tasks.mediation.SetupMediatedPayoutTxListener;\n+import bisq.core.trade.protocol.tasks.mediation.SignMediatedPayoutTx;\n+\n+import bisq.network.p2p.NodeAddress;\n+\n+import bisq.common.handlers.ErrorMessageHandler;\n+import bisq.common.handlers.ResultHandler;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public class DisputeProtocol extends TradeProtocol {\n+\n+    enum DisputeEvent implements FluentProtocol.Event {\n+        MEDIATION_RESULT_ACCEPTED,\n+        MEDIATION_RESULT_REJECTED,\n+        ARBITRATION_REQUESTED\n+    }\n+\n+    public DisputeProtocol(Trade trade) {\n+        super(trade);\n+    }\n+\n+    protected boolean notDisputed() {\n+        return trade.getDisputeState() == Trade.DisputeState.NO_DISPUTE;\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // User interaction: Trader accepts mediation result\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    // Trader has not yet received the peer's signature but has clicked the accept button.\n+    public void onAcceptMediationResult(ResultHandler resultHandler, ErrorMessageHandler errorMessageHandler) {\n+        DisputeEvent event = DisputeEvent.MEDIATION_RESULT_ACCEPTED;\n+        expect(anyPhase(Trade.Phase.DEPOSIT_CONFIRMED,\n+                Trade.Phase.FIAT_SENT,\n+                Trade.Phase.FIAT_RECEIVED)\n+                .with(event)\n+                .preCondition(trade.getProcessModel().getTradingPeer().getMediatedPayoutTxSignature() == null,\n+                        () -> errorMessageHandler.handleErrorMessage(\"We have received already the signature from the peer.\"))\n+                .preCondition(trade.getPayoutTx() == null,\n+                        () -> errorMessageHandler.handleErrorMessage(\"Payout tx is already published.\")))\n+                .setup(tasks(ApplyFilter.class,\n+                        SignMediatedPayoutTx.class,\n+                        SendMediatedPayoutSignatureMessage.class,\n+                        SetupMediatedPayoutTxListener.class)\n+                        .using(new TradeTaskRunner(trade,\n+                                () -> {\n+                                    resultHandler.handleResult();\n+                                    handleTaskRunnerSuccess(event);\n+                                },\n+                                errorMessage -> {\n+                                    errorMessageHandler.handleErrorMessage(errorMessage);\n+                                    handleTaskRunnerFault(event, errorMessage);\n+                                })))\n+                .executeTasks();\n+    }\n+\n+    // Trader has already received the peer's signature and has clicked the accept button as well.\n+    public void onFinalizeMediationResultPayout(ResultHandler resultHandler, ErrorMessageHandler errorMessageHandler) {\n+        DisputeEvent event = DisputeEvent.MEDIATION_RESULT_ACCEPTED;\n+        expect(anyPhase(Trade.Phase.DEPOSIT_CONFIRMED,\n+                Trade.Phase.FIAT_SENT,\n+                Trade.Phase.FIAT_RECEIVED)\n+                .with(event)\n+                .preCondition(trade.getPayoutTx() == null,\n+                        () -> errorMessageHandler.handleErrorMessage(\"Payout tx is already published.\")))\n+                .setup(tasks(ApplyFilter.class,\n+                        SignMediatedPayoutTx.class,\n+                        FinalizeMediatedPayoutTx.class,\n+                        BroadcastMediatedPayoutTx.class,\n+                        SendMediatedPayoutTxPublishedMessage.class)\n+                        .using(new TradeTaskRunner(trade,\n+                                () -> {\n+                                    resultHandler.handleResult();\n+                                    handleTaskRunnerSuccess(event);\n+                                },\n+                                errorMessage -> {\n+                                    errorMessageHandler.handleErrorMessage(errorMessage);\n+                                    handleTaskRunnerFault(event, errorMessage);\n+                                })))\n+                .executeTasks();\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Mediation: incoming message\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    protected void handle(MediatedPayoutTxSignatureMessage message, NodeAddress peer) {\n+        expect(anyPhase(Trade.Phase.DEPOSIT_CONFIRMED,\n+                Trade.Phase.FIAT_SENT,\n+                Trade.Phase.FIAT_RECEIVED)\n+                .with(message)\n+                .from(peer))\n+                .setup(tasks(ProcessMediatedPayoutSignatureMessage.class))\n+                .executeTasks();\n+    }\n+\n+    protected void handle(MediatedPayoutTxPublishedMessage message, NodeAddress peer) {\n+        expect(anyPhase(Trade.Phase.DEPOSIT_CONFIRMED,\n+                Trade.Phase.FIAT_SENT,\n+                Trade.Phase.FIAT_RECEIVED)\n+                .with(message)\n+                .from(peer))\n+                .setup(tasks(ProcessMediatedPayoutTxPublishedMessage.class))\n+                .executeTasks();\n+    }\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Delayed payout tx\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    public void onPublishDelayedPayoutTx(ResultHandler resultHandler, ErrorMessageHandler errorMessageHandler) {\n+        DisputeEvent event = DisputeEvent.ARBITRATION_REQUESTED;\n+        expect(anyPhase(Trade.Phase.DEPOSIT_CONFIRMED,\n+                Trade.Phase.FIAT_SENT,\n+                Trade.Phase.FIAT_RECEIVED)\n+                .with(event)\n+                .preCondition(trade.getDelayedPayoutTx() != null))\n+                .setup(tasks(PublishedDelayedPayoutTx.class,\n+                        SendPeerPublishedDelayedPayoutTxMessage.class)\n+                        .using(new TradeTaskRunner(trade,\n+                                () -> {\n+                                    resultHandler.handleResult();\n+                                    handleTaskRunnerSuccess(event);\n+                                },\n+                                errorMessage -> {\n+                                    errorMessageHandler.handleErrorMessage(errorMessage);\n+                                    handleTaskRunnerFault(event, errorMessage);\n+                                })))\n+                .executeTasks();\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Peer has published the delayed payout tx\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    private void handle(PeerPublishedDelayedPayoutTxMessage message, NodeAddress peer) {\n+        expect(anyPhase(Trade.Phase.DEPOSIT_CONFIRMED,\n+                Trade.Phase.FIAT_SENT,\n+                Trade.Phase.FIAT_RECEIVED)\n+                .with(message)\n+                .from(peer))\n+                .setup(tasks(ProcessPeerPublishedDelayedPayoutTxMessage.class))\n+                .executeTasks();\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Dispatcher\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    @Override\n+    protected void onTradeMessage(TradeMessage message, NodeAddress peer) {\n+        if (message instanceof MediatedPayoutTxSignatureMessage) {\n+            handle((MediatedPayoutTxSignatureMessage) message, peer);\n+        } else if (message instanceof MediatedPayoutTxPublishedMessage) {\n+            handle((MediatedPayoutTxPublishedMessage) message, peer);\n+        } else if (message instanceof PeerPublishedDelayedPayoutTxMessage) {\n+            handle((PeerPublishedDelayedPayoutTxMessage) message, peer);\n+        }\n+    }\n+\n+    @Override\n+    protected void onMailboxMessage(TradeMessage message, NodeAddress peer) {\n+        super.onMailboxMessage(message, peer);\n+        if (message instanceof MediatedPayoutTxSignatureMessage) {\n+            handle((MediatedPayoutTxSignatureMessage) message, peer);\n+        } else if (message instanceof MediatedPayoutTxPublishedMessage) {\n+            handle((MediatedPayoutTxPublishedMessage) message, peer);\n+        } else if (message instanceof PeerPublishedDelayedPayoutTxMessage) {\n+            handle((PeerPublishedDelayedPayoutTxMessage) message, peer);\n+        }", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1NDk5Ng==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496054996", "bodyText": "Could default these to {}", "author": "sqrrm", "createdAt": "2020-09-28T15:49:14Z", "path": "core/src/main/java/bisq/core/trade/protocol/tasks/SendMailboxMessageTask.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.trade.protocol.tasks;\n+\n+import bisq.core.trade.Trade;\n+import bisq.core.trade.messages.TradeMessage;\n+\n+import bisq.network.p2p.NodeAddress;\n+import bisq.network.p2p.SendMailboxMessageListener;\n+\n+import bisq.common.taskrunner.TaskRunner;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public abstract class SendMailboxMessageTask extends TradeTask {\n+    public SendMailboxMessageTask(TaskRunner<Trade> taskHandler, Trade trade) {\n+        super(taskHandler, trade);\n+    }\n+\n+    protected abstract TradeMessage getMessage(String id);\n+\n+    protected abstract void setStateSent();\n+\n+    protected abstract void setStateArrived();\n+\n+    protected abstract void setStateStoredInMailbox();\n+\n+    protected abstract void setStateFault();", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2NzU0Nw==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496067547", "bodyText": "This is not new in this PR, but would be better named getMyPaymentAccountPayload", "author": "sqrrm", "createdAt": "2020-09-28T16:07:49Z", "path": "core/src/main/java/bisq/core/trade/protocol/ProcessModel.java", "diffHunk": "@@ -305,59 +266,118 @@ public void setTakeOfferFeeTx(Transaction takeOfferFeeTx) {\n     public PaymentAccountPayload getPaymentAccountPayload(Trade trade) {", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcwODA5Mg==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496708092", "bodyText": "ProcessModel always contains my data, if its peers data its in the tradingPeer model.", "author": "chimp1984", "createdAt": "2020-09-29T13:17:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2NzU0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2ODA3Mw==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496068073", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // message bu that cannot be changed due backward compatibility issues. It is a left over from the\n          \n          \n            \n                        // message but that cannot be changed due backward compatibility issues. It is a left over from the", "author": "sqrrm", "createdAt": "2020-09-28T16:08:45Z", "path": "core/src/main/java/bisq/core/trade/protocol/tasks/maker/MakerProcessesInputsForDepositTxRequest.java", "diffHunk": "@@ -43,44 +43,48 @@\n \n @Slf4j\n public class MakerProcessesInputsForDepositTxRequest extends TradeTask {\n-    @SuppressWarnings({\"unused\"})\n-    public MakerProcessesInputsForDepositTxRequest(TaskRunner taskHandler, Trade trade) {\n+    public MakerProcessesInputsForDepositTxRequest(TaskRunner<Trade> taskHandler, Trade trade) {\n         super(taskHandler, trade);\n     }\n \n     @Override\n     protected void run() {\n         try {\n             runInterceptHook();\n-            log.debug(\"current trade state \" + trade.getState());\n-            InputsForDepositTxRequest inputsForDepositTxRequest = (InputsForDepositTxRequest) processModel.getTradeMessage();\n-            checkNotNull(inputsForDepositTxRequest);\n-            checkTradeId(processModel.getOfferId(), inputsForDepositTxRequest);\n+            TakeOfferRequest request = (TakeOfferRequest) processModel.getTradeMessage();\n+            checkNotNull(request);\n+            checkTradeId(processModel.getOfferId(), request);\n \n-            final TradingPeer tradingPeer = processModel.getTradingPeer();\n-            tradingPeer.setPaymentAccountPayload(checkNotNull(inputsForDepositTxRequest.getTakerPaymentAccountPayload()));\n-            tradingPeer.setRawTransactionInputs(checkNotNull(inputsForDepositTxRequest.getRawTransactionInputs()));\n-            checkArgument(inputsForDepositTxRequest.getRawTransactionInputs().size() > 0);\n+            TradingPeer tradingPeer = processModel.getTradingPeer();\n+            tradingPeer.setPaymentAccountPayload(checkNotNull(request.getTakerPaymentAccountPayload()));\n+            tradingPeer.setRawTransactionInputs(checkNotNull(request.getRawTransactionInputs()));\n+            checkArgument(request.getRawTransactionInputs().size() > 0);\n \n-            tradingPeer.setChangeOutputValue(inputsForDepositTxRequest.getChangeOutputValue());\n-            tradingPeer.setChangeOutputAddress(inputsForDepositTxRequest.getChangeOutputAddress());\n+            tradingPeer.setChangeOutputValue(request.getChangeOutputValue());\n+            tradingPeer.setChangeOutputAddress(request.getChangeOutputAddress());\n \n-            tradingPeer.setMultiSigPubKey(checkNotNull(inputsForDepositTxRequest.getTakerMultiSigPubKey()));\n-            tradingPeer.setPayoutAddressString(nonEmptyStringOf(inputsForDepositTxRequest.getTakerPayoutAddressString()));\n-            tradingPeer.setPubKeyRing(checkNotNull(inputsForDepositTxRequest.getTakerPubKeyRing()));\n+            tradingPeer.setMultiSigPubKey(checkNotNull(request.getTakerMultiSigPubKey()));\n+            tradingPeer.setPayoutAddressString(nonEmptyStringOf(request.getTakerPayoutAddressString()));\n+            tradingPeer.setPubKeyRing(checkNotNull(request.getTakerPubKeyRing()));\n \n-            tradingPeer.setAccountId(nonEmptyStringOf(inputsForDepositTxRequest.getTakerAccountId()));\n-            trade.setTakerFeeTxId(nonEmptyStringOf(inputsForDepositTxRequest.getTakerFeeTxId()));\n+            tradingPeer.setAccountId(nonEmptyStringOf(request.getTakerAccountId()));\n \n-            // Taker has to sign offerId (he cannot manipulate that - so we avoid to have a challenge protocol for passing the nonce we want to get signed)\n+            // We set the taker fee only in the processModel yet not in the trade as the tx was only created but not\n+            // published yet. Once it was published we move it to trade. The takerFeeTx should be sent in a later\n+            // message bu that cannot be changed due backward compatibility issues. It is a left over from the", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4NDE5MA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496284190", "bodyText": "Will fix it..", "author": "chimp1984", "createdAt": "2020-09-28T23:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2ODA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MzgzOA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496073838", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * buyer does not has the delayed payout tx and would not be able to open arbitration.\n          \n          \n            \n             * buyer does not have the delayed payout tx and would not be able to open arbitration.", "author": "sqrrm", "createdAt": "2020-09-28T16:17:30Z", "path": "core/src/main/java/bisq/core/trade/protocol/tasks/seller/SellerSendsDepositTxAndDelayedPayoutTxMessage.java", "diffHunk": "@@ -17,85 +17,164 @@\n \n package bisq.core.trade.protocol.tasks.seller;\n \n+import bisq.core.network.MessageState;\n import bisq.core.trade.Trade;\n import bisq.core.trade.messages.DepositTxAndDelayedPayoutTxMessage;\n-import bisq.core.trade.protocol.tasks.TradeTask;\n-\n-import bisq.network.p2p.NodeAddress;\n-import bisq.network.p2p.SendMailboxMessageListener;\n+import bisq.core.trade.messages.TradeMessage;\n+import bisq.core.trade.protocol.tasks.SendMailboxMessageTask;\n \n+import bisq.common.Timer;\n+import bisq.common.UserThread;\n import bisq.common.taskrunner.TaskRunner;\n \n-import org.bitcoinj.core.Transaction;\n+import javafx.beans.value.ChangeListener;\n \n-import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n \n import lombok.extern.slf4j.Slf4j;\n \n import static com.google.common.base.Preconditions.checkNotNull;\n \n+/**\n+ * We send the buyer the deposit and delayed payout tx. We wait to receive a ACK message back and resend the message\n+ * in case that does not happen in 4 seconds or if the message was stored in mailbox or failed. We keep repeating that\n+ * with doubling the interval each time and until the MAX_RESEND_ATTEMPTS is reached. If never successful we fail and\n+ * do not continue the protocol with publishing the deposit tx. That way we avoid that a deposit tx is published but the\n+ * buyer does not has the delayed payout tx and would not be able to open arbitration.", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4NDQxOA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496284418", "bodyText": "Will fix it.", "author": "chimp1984", "createdAt": "2020-09-28T23:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MzgzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NTkzMA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496075930", "bodyText": "This is about 4 minutes until fail, I think that's too long, 5 resend attempts would be better in my opinion", "author": "sqrrm", "createdAt": "2020-09-28T16:20:51Z", "path": "core/src/main/java/bisq/core/trade/protocol/tasks/seller/SellerSendsDepositTxAndDelayedPayoutTxMessage.java", "diffHunk": "@@ -17,85 +17,164 @@\n \n package bisq.core.trade.protocol.tasks.seller;\n \n+import bisq.core.network.MessageState;\n import bisq.core.trade.Trade;\n import bisq.core.trade.messages.DepositTxAndDelayedPayoutTxMessage;\n-import bisq.core.trade.protocol.tasks.TradeTask;\n-\n-import bisq.network.p2p.NodeAddress;\n-import bisq.network.p2p.SendMailboxMessageListener;\n+import bisq.core.trade.messages.TradeMessage;\n+import bisq.core.trade.protocol.tasks.SendMailboxMessageTask;\n \n+import bisq.common.Timer;\n+import bisq.common.UserThread;\n import bisq.common.taskrunner.TaskRunner;\n \n-import org.bitcoinj.core.Transaction;\n+import javafx.beans.value.ChangeListener;\n \n-import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n \n import lombok.extern.slf4j.Slf4j;\n \n import static com.google.common.base.Preconditions.checkNotNull;\n \n+/**\n+ * We send the buyer the deposit and delayed payout tx. We wait to receive a ACK message back and resend the message\n+ * in case that does not happen in 4 seconds or if the message was stored in mailbox or failed. We keep repeating that\n+ * with doubling the interval each time and until the MAX_RESEND_ATTEMPTS is reached. If never successful we fail and\n+ * do not continue the protocol with publishing the deposit tx. That way we avoid that a deposit tx is published but the\n+ * buyer does not has the delayed payout tx and would not be able to open arbitration.\n+ */\n @Slf4j\n-public class SellerSendsDepositTxAndDelayedPayoutTxMessage extends TradeTask {\n-    @SuppressWarnings({\"unused\"})\n-    public SellerSendsDepositTxAndDelayedPayoutTxMessage(TaskRunner taskHandler, Trade trade) {\n+public class SellerSendsDepositTxAndDelayedPayoutTxMessage extends SendMailboxMessageTask {\n+    private static final int MAX_RESEND_ATTEMPTS = 7;\n+    private int delayInSec = 4;", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4NzI4OA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496287288", "bodyText": "If the peer had some network issues 1-2 minutes might be good. It is for extremely rare cases anyway and costs for sender are minimal, beside that he waits longer, but still better then a failed trade. But not super strong opinion either, just think we should be more on the safe side...", "author": "chimp1984", "createdAt": "2020-09-28T23:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NTkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NzAzMA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496077030", "bodyText": "This resend type class has a lot of duplicate code from BuyerSendCounterCurrencyTransferStartedMessage, could probably use a common base class, or helper class.", "author": "sqrrm", "createdAt": "2020-09-28T16:22:31Z", "path": "core/src/main/java/bisq/core/trade/protocol/tasks/seller/SellerSendsDepositTxAndDelayedPayoutTxMessage.java", "diffHunk": "@@ -17,85 +17,164 @@\n \n package bisq.core.trade.protocol.tasks.seller;\n \n+import bisq.core.network.MessageState;\n import bisq.core.trade.Trade;\n import bisq.core.trade.messages.DepositTxAndDelayedPayoutTxMessage;\n-import bisq.core.trade.protocol.tasks.TradeTask;\n-\n-import bisq.network.p2p.NodeAddress;\n-import bisq.network.p2p.SendMailboxMessageListener;\n+import bisq.core.trade.messages.TradeMessage;\n+import bisq.core.trade.protocol.tasks.SendMailboxMessageTask;\n \n+import bisq.common.Timer;\n+import bisq.common.UserThread;\n import bisq.common.taskrunner.TaskRunner;\n \n-import org.bitcoinj.core.Transaction;\n+import javafx.beans.value.ChangeListener;\n \n-import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n \n import lombok.extern.slf4j.Slf4j;\n \n import static com.google.common.base.Preconditions.checkNotNull;\n \n+/**\n+ * We send the buyer the deposit and delayed payout tx. We wait to receive a ACK message back and resend the message\n+ * in case that does not happen in 4 seconds or if the message was stored in mailbox or failed. We keep repeating that\n+ * with doubling the interval each time and until the MAX_RESEND_ATTEMPTS is reached. If never successful we fail and\n+ * do not continue the protocol with publishing the deposit tx. That way we avoid that a deposit tx is published but the\n+ * buyer does not has the delayed payout tx and would not be able to open arbitration.\n+ */\n @Slf4j\n-public class SellerSendsDepositTxAndDelayedPayoutTxMessage extends TradeTask {\n-    @SuppressWarnings({\"unused\"})\n-    public SellerSendsDepositTxAndDelayedPayoutTxMessage(TaskRunner taskHandler, Trade trade) {\n+public class SellerSendsDepositTxAndDelayedPayoutTxMessage extends SendMailboxMessageTask {", "originalCommit": "b31f5b7b23915656bd5a3eeba9d67f9057eec97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4NTUxNA==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496285514", "bodyText": "The SendMailboxMessageTask base class is already handling most. The exta code for resend has some differences so the same part is not worth IMO to extract to another superclass. If you compate both classes you see that there are small differences.", "author": "chimp1984", "createdAt": "2020-09-28T23:13:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4MTM0Ng==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496581346", "bodyText": "I get that a superclass might not fit well, but I think a helper class to encapsulate the resend code could help clean up the code, and perhaps there other cases where it would be useful.", "author": "sqrrm", "createdAt": "2020-09-29T09:40:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcxMDE0Nw==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496710147", "bodyText": "I think in that case its not worth it as there are small differences and would not make the code better readable if important parts are delegated to another class. If you like you can try it out and send me a patch, but I did a file compare and did not had the impression avoiding some code duplication justifies the higher complexity of distributed code. A part is already in the base class...", "author": "chimp1984", "createdAt": "2020-09-29T13:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcyMDE5Nw==", "url": "https://github.com/bisq-network/bisq/pull/4566#discussion_r496720197", "bodyText": "Then I'll drop it. Main reason was to encapsulate the logic to not have to think about it twice. If we do one more resend message it will likely be worth it.", "author": "sqrrm", "createdAt": "2020-09-29T13:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NzAzMA=="}], "type": "inlineReview"}, {"oid": "ad83183cbaa9ca13906c66216ff0b90f8d2dd8fd", "url": "https://github.com/bisq-network/bisq/commit/ad83183cbaa9ca13906c66216ff0b90f8d2dd8fd", "message": "Revert copyright text from un-intended change", "committedDate": "2020-09-28T23:05:09Z", "type": "commit"}, {"oid": "eec13cd2768dc609e2759375273208a873fbddde", "url": "https://github.com/bisq-network/bisq/commit/eec13cd2768dc609e2759375273208a873fbddde", "message": "Refactor: Return early if not valid", "committedDate": "2020-09-28T23:08:07Z", "type": "commit"}, {"oid": "0258205211f76133063141a8e61d0cca4bd1d843", "url": "https://github.com/bisq-network/bisq/commit/0258205211f76133063141a8e61d0cca4bd1d843", "message": "Fix typos", "committedDate": "2020-09-28T23:10:42Z", "type": "commit"}, {"oid": "e8ab4c7222671190b436aa54de7b792fd2d4060f", "url": "https://github.com/bisq-network/bisq/commit/e8ab4c7222671190b436aa54de7b792fd2d4060f", "message": "Merge branch 'master_upstream' into fix-delayed-payout-tx-issues", "committedDate": "2020-09-29T01:46:34Z", "type": "commit"}, {"oid": "6be21fa86c89d27669f9efa45bf5f28d473a6259", "url": "https://github.com/bisq-network/bisq/commit/6be21fa86c89d27669f9efa45bf5f28d473a6259", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:02:11Z", "type": "commit"}, {"oid": "285003743da60c29931df7ba4660722a2fb67bae", "url": "https://github.com/bisq-network/bisq/commit/285003743da60c29931df7ba4660722a2fb67bae", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:02:49Z", "type": "commit"}, {"oid": "c448b1b58d69f02d653e8faa73c9512de42657c6", "url": "https://github.com/bisq-network/bisq/commit/c448b1b58d69f02d653e8faa73c9512de42657c6", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:03:01Z", "type": "commit"}, {"oid": "08e2a2e0b0d49b562436162881b4280f042c62f8", "url": "https://github.com/bisq-network/bisq/commit/08e2a2e0b0d49b562436162881b4280f042c62f8", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:03:18Z", "type": "commit"}, {"oid": "126f99668dbb52b56b0e19ab9bb808a5a99fbff4", "url": "https://github.com/bisq-network/bisq/commit/126f99668dbb52b56b0e19ab9bb808a5a99fbff4", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:03:30Z", "type": "commit"}, {"oid": "e3cc62ed602dd326aafa19c783ae394b0a3ec035", "url": "https://github.com/bisq-network/bisq/commit/e3cc62ed602dd326aafa19c783ae394b0a3ec035", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:03:41Z", "type": "commit"}, {"oid": "dc15c7dfa7e45cc62f42bab38dd5e09f4085b5ed", "url": "https://github.com/bisq-network/bisq/commit/dc15c7dfa7e45cc62f42bab38dd5e09f4085b5ed", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:03:53Z", "type": "commit"}, {"oid": "1fef02e6f1e058a3d8bf8a833e9e638341d1cf74", "url": "https://github.com/bisq-network/bisq/commit/1fef02e6f1e058a3d8bf8a833e9e638341d1cf74", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:04:04Z", "type": "commit"}, {"oid": "4e2ccf249b20f96e99b0101817bf1f474c3ede79", "url": "https://github.com/bisq-network/bisq/commit/4e2ccf249b20f96e99b0101817bf1f474c3ede79", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:04:17Z", "type": "commit"}, {"oid": "92902102ec7f62913d3a728b09c28c6000f6d489", "url": "https://github.com/bisq-network/bisq/commit/92902102ec7f62913d3a728b09c28c6000f6d489", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:04:27Z", "type": "commit"}, {"oid": "77ae1bddfa27de7eae964f3eeb7a982d55327a5e", "url": "https://github.com/bisq-network/bisq/commit/77ae1bddfa27de7eae964f3eeb7a982d55327a5e", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:04:45Z", "type": "commit"}, {"oid": "6c114b44e828a684c68e2ea8cf7e4a948b356f3c", "url": "https://github.com/bisq-network/bisq/commit/6c114b44e828a684c68e2ea8cf7e4a948b356f3c", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:05:21Z", "type": "commit"}, {"oid": "c3d3e5230e5364861cf34f2ecf3a8e1c95279bb0", "url": "https://github.com/bisq-network/bisq/commit/c3d3e5230e5364861cf34f2ecf3a8e1c95279bb0", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:05:46Z", "type": "commit"}, {"oid": "9cf368c449f74bcb0f690078f74dde92b763cc44", "url": "https://github.com/bisq-network/bisq/commit/9cf368c449f74bcb0f690078f74dde92b763cc44", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:06:09Z", "type": "commit"}, {"oid": "e071d5e02574081e95c420456cb49f78de735f51", "url": "https://github.com/bisq-network/bisq/commit/e071d5e02574081e95c420456cb49f78de735f51", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:06:28Z", "type": "commit"}, {"oid": "25e64cd6b59c6a46614400f63d8ecc1ebbb96dca", "url": "https://github.com/bisq-network/bisq/commit/25e64cd6b59c6a46614400f63d8ecc1ebbb96dca", "message": "Update core/src/main/resources/i18n/displayStrings.properties\n\nCo-authored-by: m52go <mfiver@gmail.com>", "committedDate": "2020-09-29T06:06:44Z", "type": "commit"}, {"oid": "e9d7e53882ee67a22c8d1ee92e8de6487c8e533d", "url": "https://github.com/bisq-network/bisq/commit/e9d7e53882ee67a22c8d1ee92e8de6487c8e533d", "message": "Merge branch 'fix-delayed-payout-tx-issues' of https://github.com/chimp1984/bisq into fix-delayed-payout-tx-issues", "committedDate": "2020-09-29T06:07:42Z", "type": "commit"}, {"oid": "24e1155eeaaac9bb9a3a21e81e7db1284af72dc0", "url": "https://github.com/bisq-network/bisq/commit/24e1155eeaaac9bb9a3a21e81e7db1284af72dc0", "message": "Set peers pubkey at constructor instead of onInitialized", "committedDate": "2020-09-30T18:44:15Z", "type": "commit"}, {"oid": "7e847cd95b433035055d7cd1c79019393672aec4", "url": "https://github.com/bisq-network/bisq/commit/7e847cd95b433035055d7cd1c79019393672aec4", "message": "Only check pubKey for trade messages. Before we got it called for instance when the mediator sent the dispute-opened-by-peer msg, causing an error as its mediators key not peers key.\nWe need to check first for the message type and then apply the check.", "committedDate": "2020-09-30T18:45:27Z", "type": "commit"}, {"oid": "a44ba62c77c7e522d918526d56de20bca54deaff", "url": "https://github.com/bisq-network/bisq/commit/a44ba62c77c7e522d918526d56de20bca54deaff", "message": "Merge branch 'fix-delayed-payout-tx-issues' of https://github.com/chimp1984/bisq into fix-delayed-payout-tx-issues", "committedDate": "2020-10-01T05:06:03Z", "type": "commit"}, {"oid": "fb41a1984b716b5b2d247c216aa9abefa0ccc28a", "url": "https://github.com/bisq-network/bisq/commit/fb41a1984b716b5b2d247c216aa9abefa0ccc28a", "message": "Merge branch 'master_upstream' into fix-delayed-payout-tx-issues\n\n# Conflicts:\n#\tcore/src/main/java/bisq/core/trade/TradeManager.java\n#\tdesktop/src/main/java/bisq/desktop/main/overlays/windows/TradeDetailsWindow.java", "committedDate": "2020-10-01T14:24:46Z", "type": "commit"}, {"oid": "0af9e133a4c1db65e06ad0307c9037e3449dcbd7", "url": "https://github.com/bisq-network/bisq/commit/0af9e133a4c1db65e06ad0307c9037e3449dcbd7", "message": "Cleanups", "committedDate": "2020-10-01T14:42:33Z", "type": "commit"}, {"oid": "8a3cacd867f7ca8d9a5b1bc42d3afc9bff961f5c", "url": "https://github.com/bisq-network/bisq/commit/8a3cacd867f7ca8d9a5b1bc42d3afc9bff961f5c", "message": "Revert renaming from InputsForDepositTxRequest to TakeOfferRequest\n\nPrefer to keep it in sync with protobuf entry.", "committedDate": "2020-10-01T14:45:19Z", "type": "commit"}, {"oid": "9fce06832d25fed88180658e837539ec61e26fb0", "url": "https://github.com/bisq-network/bisq/commit/9fce06832d25fed88180658e837539ec61e26fb0", "message": "Rename baseCurrencyNetworkParameters to networkParameters", "committedDate": "2020-10-01T14:46:11Z", "type": "commit"}, {"oid": "66a26893f052dbdbaa24cb9108be6615683df1d8", "url": "https://github.com/bisq-network/bisq/commit/66a26893f052dbdbaa24cb9108be6615683df1d8", "message": "Always show deposit and delayed payout tx in trade details window. If null it shows N/A", "committedDate": "2020-09-21T23:55:49Z", "type": "commit"}, {"oid": "690104e6eac57d73a1623051cfe692e5b871ffa0", "url": "https://github.com/bisq-network/bisq/commit/690104e6eac57d73a1623051cfe692e5b871ffa0", "message": "Show popup on MissingDelayedPayoutTxException. Update display string of popup", "committedDate": "2020-09-21T23:56:58Z", "type": "commit"}, {"oid": "944a77d6954ef73eac4e7b24ce6f8a46c7628db2", "url": "https://github.com/bisq-network/bisq/commit/944a77d6954ef73eac4e7b24ce6f8a46c7628db2", "message": "Refactor:\n- Rename getFundsNeededForTradeAsLong to getFundsNeededForTrade\n- Use checkNotNull instead of if/else check\n- Cleanups", "committedDate": "2020-09-22T00:09:14Z", "type": "commit"}, {"oid": "4d7b2897fc6698d16a48ebd5890fa8324041aaa4", "url": "https://github.com/bisq-network/bisq/commit/4d7b2897fc6698d16a48ebd5890fa8324041aaa4", "message": "Refactor:\n- Use `TaskRunner<Trade> taskHandler` instead of `TaskRunner taskHandler`", "committedDate": "2020-09-22T00:11:07Z", "type": "commit"}, {"oid": "3d56312ccd1152c10d11346344fbf71f427b97a0", "url": "https://github.com/bisq-network/bisq/commit/3d56312ccd1152c10d11346344fbf71f427b97a0", "message": "Refactor:\n- Remove '@SuppressWarnings({\"unused\"})'", "committedDate": "2020-09-22T00:11:44Z", "type": "commit"}, {"oid": "6a835343776c42beb81ef727863e105e0d92a85c", "url": "https://github.com/bisq-network/bisq/commit/6a835343776c42beb81ef727863e105e0d92a85c", "message": "Cleanups. Small functional change by removing wrapping into arraylist", "committedDate": "2020-09-22T00:29:15Z", "type": "commit"}, {"oid": "87c2ddf20015920780ab6850ffcaafe146bc83ac", "url": "https://github.com/bisq-network/bisq/commit/87c2ddf20015920780ab6850ffcaafe146bc83ac", "message": "Remove Nullable annotations. arbitratorNodeAddress is not null and accountAgeWitnessSignatureOfOfferId\nwas added in v 0.6 so is with todays versions also not null", "committedDate": "2020-09-22T00:48:01Z", "type": "commit"}, {"oid": "a25dcf29faf112407dce450a2059ad180078cac1", "url": "https://github.com/bisq-network/bisq/commit/a25dcf29faf112407dce450a2059ad180078cac1", "message": "Refactor: Rename sig to accountAgeWitnessSignatureOfOfferId to make context more clear", "committedDate": "2020-09-22T00:48:35Z", "type": "commit"}, {"oid": "19afb449d5d42e40abdb38c93857ad8cf4ebcc9f", "url": "https://github.com/bisq-network/bisq/commit/19afb449d5d42e40abdb38c93857ad8cf4ebcc9f", "message": "Refactor: rename inputsForDepositTxRequest to request\nRemove final\nCleanups", "committedDate": "2020-09-22T00:49:36Z", "type": "commit"}, {"oid": "c88135713e5bb00413cb1e6857b1320702830ccf", "url": "https://github.com/bisq-network/bisq/commit/c88135713e5bb00413cb1e6857b1320702830ccf", "message": "Revert removal of Nullable. arbitratorNodeAddress is null (confused it with acceptedArbitratorNodeAddresses)", "committedDate": "2020-09-22T01:01:24Z", "type": "commit"}, {"oid": "525360c3ce671d8549b9664761922103cbc207ef", "url": "https://github.com/bisq-network/bisq/commit/525360c3ce671d8549b9664761922103cbc207ef", "message": "Use ApplyFilter at start at take offer process.\nMake paymentAccountPayload nullable\nSet TempTradingPeerNodeAddress with value from trade.getTradingPeerNodeAddress()", "committedDate": "2020-09-22T01:02:50Z", "type": "commit"}, {"oid": "a3864efe9aa21a391cca268567fee35d57cb4a0c", "url": "https://github.com/bisq-network/bisq/commit/a3864efe9aa21a391cca268567fee35d57cb4a0c", "message": "Refactor: Remove final", "committedDate": "2020-09-22T01:10:16Z", "type": "commit"}, {"oid": "3269e8c6f0482afa3b0aac83991fbbf0c407879e", "url": "https://github.com/bisq-network/bisq/commit/3269e8c6f0482afa3b0aac83991fbbf0c407879e", "message": "Remove check that account age signature can be null. Such old versions are not supported anymore.\nCleanups.", "committedDate": "2020-09-22T01:11:06Z", "type": "commit"}, {"oid": "3a7af57a43a5a6af5ee0d55e5f405508aaf27945", "url": "https://github.com/bisq-network/bisq/commit/3a7af57a43a5a6af5ee0d55e5f405508aaf27945", "message": "Refactoring: cleanups, add more checkNotNull tests", "committedDate": "2020-09-22T01:18:47Z", "type": "commit"}, {"oid": "dc8ddbd4ae0abe6cc8ed58cd2d3dc8865db619fd", "url": "https://github.com/bisq-network/bisq/commit/dc8ddbd4ae0abe6cc8ed58cd2d3dc8865db619fd", "message": "Refactoring: cleanups", "committedDate": "2020-09-22T01:31:22Z", "type": "commit"}, {"oid": "03c2fbfb1d526f42fda52658b3eea64334c75701", "url": "https://github.com/bisq-network/bisq/commit/03c2fbfb1d526f42fda52658b3eea64334c75701", "message": "Refactoring: cleanups", "committedDate": "2020-09-22T01:45:52Z", "type": "commit"}, {"oid": "e02355704ba7aea844576fbdfd1e7047d5ecc97a", "url": "https://github.com/bisq-network/bisq/commit/e02355704ba7aea844576fbdfd1e7047d5ecc97a", "message": "Unsubscribe before state is set to avoid duplicate calls\n\nCleanups", "committedDate": "2020-09-22T02:53:45Z", "type": "commit"}, {"oid": "5705d8e67ad68cc78a47266ce121d2af7061e15a", "url": "https://github.com/bisq-network/bisq/commit/5705d8e67ad68cc78a47266ce121d2af7061e15a", "message": "Refactoring: rename inputsForDepositTxResponse , add more checkNotNull checks", "committedDate": "2020-09-22T03:01:30Z", "type": "commit"}, {"oid": "a8a3318f673ccf78b811dd04e28f442a9b27c47b", "url": "https://github.com/bisq-network/bisq/commit/a8a3318f673ccf78b811dd04e28f442a9b27c47b", "message": "Refactoring: cleanups", "committedDate": "2020-09-22T03:07:51Z", "type": "commit"}, {"oid": "53526e3c20c7b380e5177979a3e813d639ac59a7", "url": "https://github.com/bisq-network/bisq/commit/53526e3c20c7b380e5177979a3e813d639ac59a7", "message": "Remove repeated TakerVerifyMakerAccount and TakerVerifyMakerFeePayment from taker protocol", "committedDate": "2020-09-22T03:08:24Z", "type": "commit"}, {"oid": "a725227ff30bf8e9083d113b7d902bb7edfe819f", "url": "https://github.com/bisq-network/bisq/commit/a725227ff30bf8e9083d113b7d902bb7edfe819f", "message": "Refactor: set string at success handlers correctly", "committedDate": "2020-09-22T03:20:08Z", "type": "commit"}, {"oid": "2aa5feebc14ac1d0192f218fd9fc68704b3f98e6", "url": "https://github.com/bisq-network/bisq/commit/2aa5feebc14ac1d0192f218fd9fc68704b3f98e6", "message": "Move stopTimeout to second message handler", "committedDate": "2020-09-22T03:23:01Z", "type": "commit"}, {"oid": "9966f9a9a880a7bfba193f567a1186f0dfc0355e", "url": "https://github.com/bisq-network/bisq/commit/9966f9a9a880a7bfba193f567a1186f0dfc0355e", "message": "Move contractHash creation to TakerVerifyAndSignContract", "committedDate": "2020-09-22T03:25:48Z", "type": "commit"}, {"oid": "fdde4b552cb4ff859bde968356e122edfd136ee6", "url": "https://github.com/bisq-network/bisq/commit/fdde4b552cb4ff859bde968356e122edfd136ee6", "message": "Refactoring: cleanups", "committedDate": "2020-09-22T03:29:13Z", "type": "commit"}, {"oid": "e960e1208470c6b76d15615d6abbd102bcecdbaf", "url": "https://github.com/bisq-network/bisq/commit/e960e1208470c6b76d15615d6abbd102bcecdbaf", "message": "Refactoring: cleanups", "committedDate": "2020-09-22T03:58:13Z", "type": "commit"}, {"oid": "17baf18844ac75cc4abb21289a8f3f71cb94af1b", "url": "https://github.com/bisq-network/bisq/commit/17baf18844ac75cc4abb21289a8f3f71cb94af1b", "message": "Refactoring: cleanups", "committedDate": "2020-09-22T04:01:33Z", "type": "commit"}, {"oid": "853dac75441ad5690931658f9dbe66ccdd21b2bf", "url": "https://github.com/bisq-network/bisq/commit/853dac75441ad5690931658f9dbe66ccdd21b2bf", "message": "Remove empty task runner", "committedDate": "2020-09-22T04:04:45Z", "type": "commit"}, {"oid": "0f36ae8928e1558be75d0825175faa9561179532", "url": "https://github.com/bisq-network/bisq/commit/0f36ae8928e1558be75d0825175faa9561179532", "message": "Refactoring: cleanups", "committedDate": "2020-09-22T04:17:50Z", "type": "commit"}, {"oid": "538db2f36f6da33055773065ef8189c412134a21", "url": "https://github.com/bisq-network/bisq/commit/538db2f36f6da33055773065ef8189c412134a21", "message": "Move contractHash creation to MakerCreateAndSignContract", "committedDate": "2020-09-22T04:26:51Z", "type": "commit"}, {"oid": "971cd57984768bf38e3187754f877e0a8302d190", "url": "https://github.com/bisq-network/bisq/commit/971cd57984768bf38e3187754f877e0a8302d190", "message": "Refactoring: cleanups, rename cleanupTradableOnFault", "committedDate": "2020-09-22T04:34:07Z", "type": "commit"}, {"oid": "33c816acf645a3e49fc367d7e7435fc5d4535bae", "url": "https://github.com/bisq-network/bisq/commit/33c816acf645a3e49fc367d7e7435fc5d4535bae", "message": "Move SellerPublishesDepositTx after SellerSendsDepositTxAndDelayedPayoutTxMessage\n\nThis should help to avoid that the buyer does not get the delayed payout tx.\nIf a timeout at deposit tx broadcast would prevent that it get out, the peer has at least both transactions.\nThe timeout could be Bisq internal but the tx gets in reality published. With the previous code we would get interrupted at\nSellerPublishesDepositTx and then the SellerSendsDepositTxAndDelayedPayoutTxMessage would never get executed.", "committedDate": "2020-09-22T04:41:24Z", "type": "commit"}, {"oid": "527f1537a9e9525fcdc92b2931e5bd64f8965669", "url": "https://github.com/bisq-network/bisq/commit/527f1537a9e9525fcdc92b2931e5bd64f8965669", "message": "Add listener on BuyerSendCounterCurrencyTransferStartedMessage to resend msg case it has not arrived\nAdd signed witness to PayoutTxPublishedMessage\nRemove usage of RefreshTradeStateRequest but leave it for backward compatibility\nMove removeMailboxMessageAfterProcessing calls in finally branch\nRename methods", "committedDate": "2020-09-22T05:32:28Z", "type": "commit"}, {"oid": "2b747cc32385123fde4cbfbdc83ff62f879c7f9f", "url": "https://github.com/bisq-network/bisq/commit/2b747cc32385123fde4cbfbdc83ff62f879c7f9f", "message": "Don't return null if name is null by try to use UNDEFINED. Only if that is not present we return null", "committedDate": "2020-09-22T23:48:47Z", "type": "commit"}, {"oid": "b13e1a3edbfa82326cddc5e7a9b208fbc161e806", "url": "https://github.com/bisq-network/bisq/commit/b13e1a3edbfa82326cddc5e7a9b208fbc161e806", "message": "Resend DepositTxAndDelayedPayoutTxMessage at\nSellerSendsDepositTxAndDelayedPayoutTxMessage if no ACK received\n\nAdd checks for valid trade state transitions", "committedDate": "2020-09-22T23:50:45Z", "type": "commit"}, {"oid": "96221317e2f474d53dddd946649b020be0ed2668", "url": "https://github.com/bisq-network/bisq/commit/96221317e2f474d53dddd946649b020be0ed2668", "message": "Change order of tasks\n\nCall BuyerSetupPayoutTxListener before BuyerSendCounterCurrencyTransferStartedMessage\nWe will change BuyerSendCounterCurrencyTransferStartedMessage so that it\ndoes not complete until the message has been ACKed by the peer.\nIt is more transparent to leave the task uncompleted and if it is the last task we dont have issues.\nThe caller would not get the result handler called though until all is completed. But the result handler in the UI was anyway empty.", "committedDate": "2020-09-23T00:01:51Z", "type": "commit"}, {"oid": "c7e0c51875e98645ffcf94a2bb905951a4e5e6f5", "url": "https://github.com/bisq-network/bisq/commit/c7e0c51875e98645ffcf94a2bb905951a4e5e6f5", "message": "Use same model as in SellerSendsDepositTxAndDelayedPayoutTxMessage\n\nReason: the other model was already tested quite a lot and seems to work correctly.\nWe gain a lot of resiliance with min. costs (repeated mailbox messages - as they are the same\nthey will not cause higher number of msg, just a bit more traffic)", "committedDate": "2020-09-23T00:34:14Z", "type": "commit"}, {"oid": "4b7307e07fbb687e989414ddd38f72f3901f1bab", "url": "https://github.com/bisq-network/bisq/commit/4b7307e07fbb687e989414ddd38f72f3901f1bab", "message": "Add checks for state at handle CounterCurrencyTransferStartedMessage\nAdd ApplyFilter task", "committedDate": "2020-09-23T00:35:01Z", "type": "commit"}, {"oid": "8ce5ebadeac03d34175d46029be46d0854d2899f", "url": "https://github.com/bisq-network/bisq/commit/8ce5ebadeac03d34175d46029be46d0854d2899f", "message": "Refactoring: rename, cleanups", "committedDate": "2020-09-23T00:35:24Z", "type": "commit"}, {"oid": "1abe6adac6a269e8e050f8baa363afc4c16002e1", "url": "https://github.com/bisq-network/bisq/commit/1abe6adac6a269e8e050f8baa363afc4c16002e1", "message": "Remove empty tasks.", "committedDate": "2020-09-23T00:40:15Z", "type": "commit"}, {"oid": "5f8f30a8b3e37c55c1d028b01152121c1a5906d4", "url": "https://github.com/bisq-network/bisq/commit/5f8f30a8b3e37c55c1d028b01152121c1a5906d4", "message": "Add BuyerSendCounterCurrencyTransferStartedMessage as second optional task instead of starting a new task runner", "committedDate": "2020-09-23T00:53:19Z", "type": "commit"}, {"oid": "48241af31660efdf699df17273cbbb20a3e6ed8f", "url": "https://github.com/bisq-network/bisq/commit/48241af31660efdf699df17273cbbb20a3e6ed8f", "message": "Change isTradeInPhase APi to fluent interface with ifInPhase", "committedDate": "2020-09-23T01:18:59Z", "type": "commit"}, {"oid": "7c6f0ac9b20c81b6975bc44df79d2069de4d9196", "url": "https://github.com/bisq-network/bisq/commit/7c6f0ac9b20c81b6975bc44df79d2069de4d9196", "message": "Use ifInPhase APi for testing expected phase(s)\nAdd ifInPhase method to allow alternative phases. We can have parallel branches how we reach a new state, e.g. receiving the tx from network or receiving it from the peer. no guarantee which will happen first.\n\nAllow phase transition to skip a future phase as we have phases only relevant for one role. This is not good for treading it as a state machine state, we need to redesign the state/phase handling...", "committedDate": "2020-09-23T02:09:09Z", "type": "commit"}, {"oid": "6fa2225b652684e354df0ad2fb615c94ccd1fc17", "url": "https://github.com/bisq-network/bisq/commit/6fa2225b652684e354df0ad2fb615c94ccd1fc17", "message": "Use fluent interface for checking state and conditions", "committedDate": "2020-09-23T06:48:02Z", "type": "commit"}, {"oid": "0fa45650b625103adbb4a300c853b6762bb8cdb4", "url": "https://github.com/bisq-network/bisq/commit/0fa45650b625103adbb4a300c853b6762bb8cdb4", "message": "Merge branch 'dispute-agent-branch' into wip-merge-tradeprot\n\n# Conflicts:\n#\tcore/src/main/java/bisq/core/trade/DelayedPayoutTxValidation.java\n#\tcore/src/main/java/bisq/core/trade/protocol/tasks/buyer/BuyerVerifiesFinalDelayedPayoutTx.java\n#\tdesktop/src/main/java/bisq/desktop/main/portfolio/pendingtrades/PendingTradesDataModel.java\n#\tdesktop/src/main/java/bisq/desktop/main/portfolio/pendingtrades/steps/buyer/BuyerStep1View.java\n#\tdesktop/src/main/java/bisq/desktop/main/portfolio/pendingtrades/steps/buyer/BuyerStep2View.java", "committedDate": "2020-09-23T13:27:09Z", "type": "commit"}, {"oid": "de008457cb22cbfc91f345b3ade976d776dd6890", "url": "https://github.com/bisq-network/bisq/commit/de008457cb22cbfc91f345b3ade976d776dd6890", "message": "Remove empty file (from merge)", "committedDate": "2020-09-23T13:28:04Z", "type": "commit"}, {"oid": "2b53312af9ca102a46532baee7b331c00a8d9de2", "url": "https://github.com/bisq-network/bisq/commit/2b53312af9ca102a46532baee7b331c00a8d9de2", "message": "Various improvements\n\n- Add time outs per request/response cycle.\n- Use custom timeouts\n- Stop timeout if condition not met\n- Allow multiple condition calls (all need to be true)\n- Move  processModel.setTradeMessage(tradeMessage); and processModel.setTempTradingPeerNodeAddress(peerNodeAddress); calls to FluentProcess\n- Add Validator.isTradeIdValid method\n- Replace Validator.checkTradeId(processModel.getOfferId(), tradeMessage); by isTradeIdValid in FluentProcess\n- Add DisputeEvent\n- Derive info string from message or event at handleTaskRunnerSuccess\n- Add from method\n- Add withTimeout method\n- Add BuyerEvent.STARTUP\n- Rename onMessage to on\n- Rename onEvent to on\n- Rename tradeMesage to message\n- Rename sener/peerNodeAddress to peer", "committedDate": "2020-09-23T17:07:38Z", "type": "commit"}, {"oid": "3f80d1b1ea1037c6e2c828eb9444ce00733f7c45", "url": "https://github.com/bisq-network/bisq/commit/3f80d1b1ea1037c6e2c828eb9444ce00733f7c45", "message": "Refactor: Rename condition to preCondition", "committedDate": "2020-09-23T17:13:07Z", "type": "commit"}, {"oid": "d91e44c9ab757e4379f8c30913677bc9eb06898e", "url": "https://github.com/bisq-network/bisq/commit/d91e44c9ab757e4379f8c30913677bc9eb06898e", "message": "Refactor: Rename from to expectedPhase", "committedDate": "2020-09-23T17:14:18Z", "type": "commit"}, {"oid": "faf07f623fe4674827a6094487678ccb3f89db72", "url": "https://github.com/bisq-network/bisq/commit/faf07f623fe4674827a6094487678ccb3f89db72", "message": "Refactor: Rename fromAny to expectedPhases", "committedDate": "2020-09-23T17:14:40Z", "type": "commit"}, {"oid": "9505179bed6e80c4bbdbf9aeddf3202efffa5d33", "url": "https://github.com/bisq-network/bisq/commit/9505179bed6e80c4bbdbf9aeddf3202efffa5d33", "message": "Use FluentProcess for boilerplate code (WIP - some custom code is commented out atm, will be fixed in follow up commits)\n\nAdd setTaskRunner method\nAdd addTasks method\nAdd run method", "committedDate": "2020-09-23T17:49:42Z", "type": "commit"}, {"oid": "968a6df550c0cdfe7504c624944162b1c4c2303f", "url": "https://github.com/bisq-network/bisq/commit/968a6df550c0cdfe7504c624944162b1c4c2303f", "message": "Refactor: Rename run to runTasks", "committedDate": "2020-09-23T17:50:22Z", "type": "commit"}, {"oid": "54d625e564be952ff88a03070a33638d1c44ca8f", "url": "https://github.com/bisq-network/bisq/commit/54d625e564be952ff88a03070a33638d1c44ca8f", "message": "Add run method to accept runnable which is execute before run tasks\nAdd isValid method in FluentProcess\nAdd more logs if invalid\nAdd toString\n\nRefactor:\n- Remove custom trade fields and use trade from base class instead", "committedDate": "2020-09-23T18:08:26Z", "type": "commit"}, {"oid": "cdbd6cdfa8189a58f74518505209da447801f57e", "url": "https://github.com/bisq-network/bisq/commit/cdbd6cdfa8189a58f74518505209da447801f57e", "message": "Redesigned fluent API again...\n\nMove code duplication to Buyer protocol", "committedDate": "2020-09-23T21:21:29Z", "type": "commit"}, {"oid": "e59b5b3cf52cef9b55907ada048943ce065dac14", "url": "https://github.com/bisq-network/bisq/commit/e59b5b3cf52cef9b55907ada048943ce065dac14", "message": "Change BuyerProtocol from interface to abstract class\n\nMove all common code of buyer protocol classes to BuyerProtocol", "committedDate": "2020-09-23T22:20:10Z", "type": "commit"}, {"oid": "a2e0ec4d2ebe3097bb63894c91e3426080a5739c", "url": "https://github.com/bisq-network/bisq/commit/a2e0ec4d2ebe3097bb63894c91e3426080a5739c", "message": "Change SellerProtocol from interface to abstract class\n\nMove all common code of seller protocol classes to SellerProtocol", "committedDate": "2020-09-24T00:26:49Z", "type": "commit"}, {"oid": "99afe23de62979c2460df6accc5c61dda234a629", "url": "https://github.com/bisq-network/bisq/commit/99afe23de62979c2460df6accc5c61dda234a629", "message": "Refactor: Rename takeAvailableOffer to onTakeOffer", "committedDate": "2020-09-24T00:29:29Z", "type": "commit"}, {"oid": "8847f4b13d735cc31d53f59ea6f7312ed416a345", "url": "https://github.com/bisq-network/bisq/commit/8847f4b13d735cc31d53f59ea6f7312ed416a345", "message": "Refactor: Rename createTrade to getNewTrade\nMove some code to caller method", "committedDate": "2020-09-24T00:35:19Z", "type": "commit"}, {"oid": "9644920a52da179ad79380c91cedc34b42d988f6", "url": "https://github.com/bisq-network/bisq/commit/9644920a52da179ad79380c91cedc34b42d988f6", "message": "Refactor: Move mediation code to new class", "committedDate": "2020-09-24T00:52:24Z", "type": "commit"}, {"oid": "f059f08b273589d252d5e6ab21d108bef81c42bd", "url": "https://github.com/bisq-network/bisq/commit/f059f08b273589d252d5e6ab21d108bef81c42bd", "message": "Refactor: Rearrange methods", "committedDate": "2020-09-24T00:56:41Z", "type": "commit"}, {"oid": "03023567a8b1d7f1981d3028d4b7d5740329b429", "url": "https://github.com/bisq-network/bisq/commit/03023567a8b1d7f1981d3028d4b7d5740329b429", "message": "Fix potential bug with peers pub key check. Use new isPubKeyValid method to avoid code duplication.\nBefore we did not apply messages if the peers key was null which can be the case at protocol start for maker side (takers key is not set yet). Makers key is in offer and available from the start.\n\nFix incorrect setPubKeyRing call in BuyerAsTakerProtocol and BuyerProtocol. Only taker can set it from offer. This bug was introduce in past commits of this branch.\n\nMove FluentProtocol to own class file\nClose open offer in task instead at state listener\nRemove state listener\nRemove default timeout as not used anymore\nAdd onWithdrawCompleted method to clean up when trade completed\nRearrange code in TradeProtocol\nRename doHandleDecryptedMessage to onTradeMessage\nRename doApplyMailboxTradeMessage to onMailboxMessage", "committedDate": "2020-09-24T03:24:45Z", "type": "commit"}, {"oid": "f6eefef1ae13dafed8fb965bd6c2426d4008d27b", "url": "https://github.com/bisq-network/bisq/commit/f6eefef1ae13dafed8fb965bd6c2426d4008d27b", "message": "Remove handling of failed trades. If a trade is in an invalid state (tx missing) or has an error message set we show in the pending trades view a red trash icon for moving the trade to failed trades.\nThe info icon next to the trade ID is then a warning icon (should be red but css is not my best friend) and if opening trade details window we also color the missing txs red with a warn icon and tooltip.\nWhen clicking the trash button a popup is displayed with detail info.\nAt failed trades there is a \"undo\" icon for reverting the trade back to pending (if user wants to open mediation, etc).\n\nAll the automatic handling of the failed trades and popups are removed as it never worked well and just confused users...\n\nIn next commits we will add more instructions what a user should/can do for diff. error cases.\n\nTradeManger:\n- Remove all the failed checks at initPendingTrade.\n- Remove tradesWithoutDepositTx\n- Remove tradesForStatistics as it was never read\n- Remove cleanUpAddressEntries\n- Rename addTradeToClosedTrades to onTradeCompleted\n\nTxIdTextField accepts a null for tx ID and shows then red colored N/A and a warning icon.\nHyperlinkWithIcon exposed the icon to be accessible for style change.\nDebugWindow was updated for one variation of the trade protocol (other is missing still).\nTrade detail window show now always all 4 mandatory txs.\nBeside that this commit has some cleanups and null pointer fixes (when testing error scenarios i got those NP).", "committedDate": "2020-09-25T00:47:12Z", "type": "commit"}, {"oid": "b4944346230fa3abbf9700732f6e68a3f4955db8", "url": "https://github.com/bisq-network/bisq/commit/b4944346230fa3abbf9700732f6e68a3f4955db8", "message": "Add warn icon next to trash icon. Show popup with info about the problem and instructions.\nSet trash button disabled if the tx chain is valid to avoid that users move to failed while trade is valid to be completed.\n\nContract: Add isMyRoleMaker method\nTrade: Add hasErrorMessage and isTxChainInvalid methods", "committedDate": "2020-09-25T02:07:40Z", "type": "commit"}, {"oid": "7167e2a8bdc69d33701a24373d98fdcaae026ef3", "url": "https://github.com/bisq-network/bisq/commit/7167e2a8bdc69d33701a24373d98fdcaae026ef3", "message": "Add check if trade has been paid out for button disable state", "committedDate": "2020-09-25T02:10:02Z", "type": "commit"}, {"oid": "6f614f4f4c54b1336a03186cafeef33a7357551f", "url": "https://github.com/bisq-network/bisq/commit/6f614f4f4c54b1336a03186cafeef33a7357551f", "message": "Set takerFeeTxId and depositTx in trade only once they are published. Before that we keep it temporary in the processModel.\nThe buyer receives the takerFeeTxId with the frist message, but at the moment it is not published. To reflect that he also keeps it in the process model and\nat the next message when the fee tx is published he sets it in the Trade.\n\nRemove\n`checkArgument(!walletService.getAddressEntry(id, AddressEntry.Context.MULTI_SIG).isPresent(),\n                     \"addressEntry must not be set here.\");\n`\nas it causes failure if a taker takes same offer after certain error conditions again.", "committedDate": "2020-09-25T05:19:43Z", "type": "commit"}, {"oid": "f1df52790b28e892139f579be951b1e3c7b16825", "url": "https://github.com/bisq-network/bisq/commit/f1df52790b28e892139f579be951b1e3c7b16825", "message": "improve trade details window", "committedDate": "2020-09-25T05:20:17Z", "type": "commit"}, {"oid": "b958c7519b6982eb06c525cc03883c8ad46b9765", "url": "https://github.com/bisq-network/bisq/commit/b958c7519b6982eb06c525cc03883c8ad46b9765", "message": "Add MakerRemovesOpenOffer task.\nRemoves offer once the taker fee was published. So we ensure that maker fee is not lost if an error happens before that.", "committedDate": "2020-09-25T19:17:04Z", "type": "commit"}, {"oid": "10bedee803f49391b510890f638818b5dd0471c4", "url": "https://github.com/bisq-network/bisq/commit/10bedee803f49391b510890f638818b5dd0471c4", "message": "Merge branch 'dispute-agent-branch' into fix-delayed-payout-tx-issues\n\n# Conflicts:\n#\tcore/src/main/java/bisq/core/trade/protocol/tasks/buyer/BuyerSetupDepositTxListener.java", "committedDate": "2020-09-25T20:03:28Z", "type": "commit"}, {"oid": "568dcdaad4c71ccaeb522fe81ce8d79d670f7fc6", "url": "https://github.com/bisq-network/bisq/commit/568dcdaad4c71ccaeb522fe81ce8d79d670f7fc6", "message": "Update tasks in debugview", "committedDate": "2020-09-25T20:32:49Z", "type": "commit"}, {"oid": "95cb3b271008f68ff6558450fb4c6e7ceb11668d", "url": "https://github.com/bisq-network/bisq/commit/95cb3b271008f68ff6558450fb4c6e7ceb11668d", "message": "Fix deposit tx setters", "committedDate": "2020-09-25T22:06:13Z", "type": "commit"}, {"oid": "3987f9cd5ad26148b64ad60b8d8bf451ce8f9e44", "url": "https://github.com/bisq-network/bisq/commit/3987f9cd5ad26148b64ad60b8d8bf451ce8f9e44", "message": "Fix incorrect getDepositTx calls", "committedDate": "2020-09-25T23:16:50Z", "type": "commit"}, {"oid": "dceba6d35030286eeb977be834dd670abb9f07c3", "url": "https://github.com/bisq-network/bisq/commit/dceba6d35030286eeb977be834dd670abb9f07c3", "message": "Bug fix: we created a new address entry which causes bugs in case a user takes an offer again which failed in an early preparation state before.", "committedDate": "2020-09-26T01:09:31Z", "type": "commit"}, {"oid": "98dec09c18801a2bbbbaad94c7bcbddc076b4c50", "url": "https://github.com/bisq-network/bisq/commit/98dec09c18801a2bbbbaad94c7bcbddc076b4c50", "message": "Rename given method to expect to make it more clear that it is mandatory that the condition is met. Also added a protocol error handler if the condition is not met.\nFor more tolerant usage we added the given method, which does not log errors and does not call a error handler.", "committedDate": "2020-09-26T02:10:20Z", "type": "commit"}, {"oid": "3cc633f39fb9aac0b07e2c38caca3ec3c81793bb", "url": "https://github.com/bisq-network/bisq/commit/3cc633f39fb9aac0b07e2c38caca3ec3c81793bb", "message": "Add check if trade was already taken in the past. If so show a popup at take offer screen.\n\nWe could deactivate such offers as well but as it is only for exceptional cases I think this way is good enough (would be more effort otherwise).", "committedDate": "2020-09-26T02:30:19Z", "type": "commit"}, {"oid": "612ecd3a6a7bb9dc4b6fb133a4917bdcde2fb44b", "url": "https://github.com/bisq-network/bisq/commit/612ecd3a6a7bb9dc4b6fb133a4917bdcde2fb44b", "message": "Rename onFiatPaymentReceived to onPaymentReceived", "committedDate": "2020-09-26T02:32:27Z", "type": "commit"}, {"oid": "a002fb33a5c01ae98c5489f434feb2767f38f188", "url": "https://github.com/bisq-network/bisq/commit/a002fb33a5c01ae98c5489f434feb2767f38f188", "message": "Rename onFiatPaymentStarted to onPaymentStarted", "committedDate": "2020-09-26T02:33:53Z", "type": "commit"}, {"oid": "7023b2acf50fe2883969e9e56211e60f8d9977e0", "url": "https://github.com/bisq-network/bisq/commit/7023b2acf50fe2883969e9e56211e60f8d9977e0", "message": "Remove onPaymentReceived method from TradeManager", "committedDate": "2020-09-26T02:35:34Z", "type": "commit"}, {"oid": "a5f4cb8e85801dfbe9407db54ae68f43fad9167e", "url": "https://github.com/bisq-network/bisq/commit/a5f4cb8e85801dfbe9407db54ae68f43fad9167e", "message": "Refactor: use getTradableList instead of tradableList.getList()", "committedDate": "2020-09-26T02:38:06Z", "type": "commit"}, {"oid": "6af9cb3dfeb43ea890943830434e4917d5895759", "url": "https://github.com/bisq-network/bisq/commit/6af9cb3dfeb43ea890943830434e4917d5895759", "message": "Refactor: rename getTradableList to getTradesAsObservableList", "committedDate": "2020-09-26T02:38:49Z", "type": "commit"}, {"oid": "5d312ae1bada12baaf3e073cd264a64fd8af7208", "url": "https://github.com/bisq-network/bisq/commit/5d312ae1bada12baaf3e073cd264a64fd8af7208", "message": "Refactor: add TODOs", "committedDate": "2020-09-26T02:43:56Z", "type": "commit"}, {"oid": "86569b1b2d7699bdb38714d9235590da7852df86", "url": "https://github.com/bisq-network/bisq/commit/86569b1b2d7699bdb38714d9235590da7852df86", "message": "Apply fluent protocol to MediationProtocol\n\nRename acceptMediationResult to onAcceptMediationResult", "committedDate": "2020-09-26T02:58:32Z", "type": "commit"}, {"oid": "2fc753bde4a8856089962065983cdf20e3293cf6", "url": "https://github.com/bisq-network/bisq/commit/2fc753bde4a8856089962065983cdf20e3293cf6", "message": "Rename InputsForDepositTxRequest to TakeOfferRequest\n\nThe protobuf file is not renamed. This breaks our convention to keep both the same but I think the added clarity for the trade protocol justifies the exception.", "committedDate": "2020-09-26T03:02:43Z", "type": "commit"}, {"oid": "82749cee70cb4c0fb8841f3090108f31ed0c6cf1", "url": "https://github.com/bisq-network/bisq/commit/82749cee70cb4c0fb8841f3090108f31ed0c6cf1", "message": "Refactor:\n - Rename handlePayDepositRequest to handleTakeOfferRequest\n - Add initTrade method without the redundant params\n - Use early returns in handleTakeOfferRequest", "committedDate": "2020-09-26T03:15:40Z", "type": "commit"}, {"oid": "a07fe30ac30b92e8fd3a61471065c84b59283319", "url": "https://github.com/bisq-network/bisq/commit/a07fe30ac30b92e8fd3a61471065c84b59283319", "message": "Refactor: Move method", "committedDate": "2020-09-26T03:16:25Z", "type": "commit"}, {"oid": "96ec87b50afaf8b60279133cff22e88acdaa3be4", "url": "https://github.com/bisq-network/bisq/commit/96ec87b50afaf8b60279133cff22e88acdaa3be4", "message": "Refactor: let TradeManager implement DecryptedDirectMessageListener, DecryptedMailboxListener", "committedDate": "2020-09-26T03:27:19Z", "type": "commit"}, {"oid": "4d40ca580c937deb79d83396e821212f9ecfc8d1", "url": "https://github.com/bisq-network/bisq/commit/4d40ca580c937deb79d83396e821212f9ecfc8d1", "message": "Refactor: Remove handleTakeOfferRequest method", "committedDate": "2020-09-26T03:28:31Z", "type": "commit"}, {"oid": "346d793d87bfc6551d704440ef6836402ef2658f", "url": "https://github.com/bisq-network/bisq/commit/346d793d87bfc6551d704440ef6836402ef2658f", "message": "Refactor: Remove onOfferRemovedFromRemoteOfferBook method", "committedDate": "2020-09-26T03:29:52Z", "type": "commit"}, {"oid": "246d1e3ddfe561f78f95472a041f44665645e936", "url": "https://github.com/bisq-network/bisq/commit/246d1e3ddfe561f78f95472a041f44665645e936", "message": "Refactor: Remove onCancelAvailabilityRequest method", "committedDate": "2020-09-26T03:31:08Z", "type": "commit"}, {"oid": "1c824f140cc32fab42ea94a5b6cec477aba65f2c", "url": "https://github.com/bisq-network/bisq/commit/1c824f140cc32fab42ea94a5b6cec477aba65f2c", "message": "Refactor: Cleanups", "committedDate": "2020-09-26T03:37:54Z", "type": "commit"}, {"oid": "35b758431dd4739cd2c37c2686efc50e4a756975", "url": "https://github.com/bisq-network/bisq/commit/35b758431dd4739cd2c37c2686efc50e4a756975", "message": "Refactor: Move methods, rename methods", "committedDate": "2020-09-26T03:50:42Z", "type": "commit"}, {"oid": "0b81db5a60113a8fc855fd9367fd6edaf109fdb4", "url": "https://github.com/bisq-network/bisq/commit/0b81db5a60113a8fc855fd9367fd6edaf109fdb4", "message": "Refactor: return early", "committedDate": "2020-09-26T03:52:54Z", "type": "commit"}, {"oid": "9f3fe7ad6d52aa2b892026f07391a58b43fba38d", "url": "https://github.com/bisq-network/bisq/commit/9f3fe7ad6d52aa2b892026f07391a58b43fba38d", "message": "Refactor: Move getAddressEntriesForAvailableBalanceStream to btcWalletService\nRename WithdrawalView.walletService to btcWalletService", "committedDate": "2020-09-26T03:56:00Z", "type": "commit"}, {"oid": "561abd7a499e5a45bfffe9a86bd22a054c86da0c", "url": "https://github.com/bisq-network/bisq/commit/561abd7a499e5a45bfffe9a86bd22a054c86da0c", "message": "Refactor: Move publishDelayedPayoutTx from TradeManager to MediationProtocol", "committedDate": "2020-09-26T04:07:16Z", "type": "commit"}, {"oid": "fded97fb9c6ca5277f04c426f59f3eb56503b5ac", "url": "https://github.com/bisq-network/bisq/commit/fded97fb9c6ca5277f04c426f59f3eb56503b5ac", "message": "Refactor: Use task runner for peer publish delayed payout tx", "committedDate": "2020-09-26T04:55:45Z", "type": "commit"}, {"oid": "191b031f385e6d0f2fc6f16c7793c5fe5d28c8f8", "url": "https://github.com/bisq-network/bisq/commit/191b031f385e6d0f2fc6f16c7793c5fe5d28c8f8", "message": "Refactor: Rename MediationProtocol to DisputeProtocol", "committedDate": "2020-09-26T04:56:58Z", "type": "commit"}, {"oid": "9e5cdada5d2a90e8ee01a3765cae5b306cf730de", "url": "https://github.com/bisq-network/bisq/commit/9e5cdada5d2a90e8ee01a3765cae5b306cf730de", "message": "Remove precondition as trade was added at that moment", "committedDate": "2020-09-26T17:14:10Z", "type": "commit"}, {"oid": "e61d04284e1574e5ea94941544b6eab3c13142ec", "url": "https://github.com/bisq-network/bisq/commit/e61d04284e1574e5ea94941544b6eab3c13142ec", "message": "Add ProcessModelServiceProvider to provide all the domain services to process model", "committedDate": "2020-09-26T17:24:57Z", "type": "commit"}, {"oid": "0c4af92f8624ab5cf402bb10c0195d5fc2ec055d", "url": "https://github.com/bisq-network/bisq/commit/0c4af92f8624ab5cf402bb10c0195d5fc2ec055d", "message": "Refactor: rename methods", "committedDate": "2020-09-26T17:28:38Z", "type": "commit"}, {"oid": "62a71e2173fc02091fca0d9e11b809375fc2a058", "url": "https://github.com/bisq-network/bisq/commit/62a71e2173fc02091fca0d9e11b809375fc2a058", "message": "Remove unused method", "committedDate": "2020-09-26T17:28:52Z", "type": "commit"}, {"oid": "2bb4bff41de3d7f9aa40c26e1cf3f87e532fc9ed", "url": "https://github.com/bisq-network/bisq/commit/2bb4bff41de3d7f9aa40c26e1cf3f87e532fc9ed", "message": "Refactor: move method, remove unneeded stream call", "committedDate": "2020-09-26T17:40:09Z", "type": "commit"}, {"oid": "766b1e2e1e8bf86c9e8df104a3b56807d0a73e40", "url": "https://github.com/bisq-network/bisq/commit/766b1e2e1e8bf86c9e8df104a3b56807d0a73e40", "message": "Add check to not add a duplicate address entry with same offer ID and context.\nIn debugging trade protocol and taking same offer I could generate problems where the multisig entry was twice but with diff. keys, so take offer failed. I remember the error log to have seen in the past and I assume this was a rare bug we encountered when users took again the same offer which failed with an uncritical state earlier.", "committedDate": "2020-09-26T17:42:17Z", "type": "commit"}]}