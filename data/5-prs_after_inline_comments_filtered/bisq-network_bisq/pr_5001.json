{"pr_number": 5001, "pr_title": "Deactivate open offer if trigger price is reached", "pr_createdAt": "2020-12-25T05:32:19Z", "pr_url": "https://github.com/bisq-network/bisq/pull/5001", "timeline": [{"oid": "b36802dc49661ebe3669d5145644bdeb4ed01781", "url": "https://github.com/bisq-network/bisq/commit/b36802dc49661ebe3669d5145644bdeb4ed01781", "message": "Add percentage price to open offer view", "committedDate": "2020-12-23T00:03:09Z", "type": "commit"}, {"oid": "d1c87185173622e8ccd6457c5df34827c023ad33", "url": "https://github.com/bisq-network/bisq/commit/d1c87185173622e8ccd6457c5df34827c023ad33", "message": "Merge branch 'add-percentage-price-to-open-offer-view' into deactivate-open-offer-if-trigger-price-is-reached", "committedDate": "2020-12-24T02:24:52Z", "type": "commit"}, {"oid": "8ac81d903d5da0ac6d34c76bd44258467cdcd565", "url": "https://github.com/bisq-network/bisq/commit/8ac81d903d5da0ac6d34c76bd44258467cdcd565", "message": "Refactor InfoInputTextField\n\nUse only one icon which is set on demand.\nWe will add a new icon later so that refactoring prepares that...", "committedDate": "2020-12-24T02:46:49Z", "type": "commit"}, {"oid": "99192e76ae7bdd09cf23ebc7330a3922907a1927", "url": "https://github.com/bisq-network/bisq/commit/99192e76ae7bdd09cf23ebc7330a3922907a1927", "message": "Apply formatting (no code change)", "committedDate": "2020-12-24T02:47:44Z", "type": "commit"}, {"oid": "752984726c118a453d7dcc6975b4dd57c72edc09", "url": "https://github.com/bisq-network/bisq/commit/752984726c118a453d7dcc6975b4dd57c72edc09", "message": "Add getRegularIconButton method", "committedDate": "2020-12-24T02:48:04Z", "type": "commit"}, {"oid": "0e6b9835644a615f136518977dc314ebeca79eca", "url": "https://github.com/bisq-network/bisq/commit/0e6b9835644a615f136518977dc314ebeca79eca", "message": "Add triggerPrice", "committedDate": "2020-12-24T02:50:53Z", "type": "commit"}, {"oid": "229d013844948b39db9f647f1a341d29af79e470", "url": "https://github.com/bisq-network/bisq/commit/229d013844948b39db9f647f1a341d29af79e470", "message": "Add PriceEventHandler", "committedDate": "2020-12-24T02:52:35Z", "type": "commit"}, {"oid": "e5957cd2fe2d18f9a10ec5758a23b12f671f3e00", "url": "https://github.com/bisq-network/bisq/commit/e5957cd2fe2d18f9a10ec5758a23b12f671f3e00", "message": "Set priceTypeToggleButton invisible once we move to funds section\nRemove disableProperty().unbind() calls which have never got a bind call before\nCleanups", "committedDate": "2020-12-24T04:22:02Z", "type": "commit"}, {"oid": "bb9de0b24c94e8712868592428589119a742dbd7", "url": "https://github.com/bisq-network/bisq/commit/bb9de0b24c94e8712868592428589119a742dbd7", "message": "Add trigger price field to create offer view", "committedDate": "2020-12-25T01:01:04Z", "type": "commit"}, {"oid": "f096351d60f85ad33150f7b49d99b21027d6ca0b", "url": "https://github.com/bisq-network/bisq/commit/f096351d60f85ad33150f7b49d99b21027d6ca0b", "message": "Make rows smaller", "committedDate": "2020-12-25T02:46:14Z", "type": "commit"}, {"oid": "39893a6aaf43be13bd3cfa465a991fde6c690709", "url": "https://github.com/bisq-network/bisq/commit/39893a6aaf43be13bd3cfa465a991fde6c690709", "message": "Add trigger price to OpenOffersView", "committedDate": "2020-12-25T04:05:23Z", "type": "commit"}, {"oid": "64607de9246c7b7a6cade4bea143ca5ae33c1191", "url": "https://github.com/bisq-network/bisq/commit/64607de9246c7b7a6cade4bea143ca5ae33c1191", "message": "Add trigger icon column", "committedDate": "2020-12-25T04:44:27Z", "type": "commit"}, {"oid": "2a86d5b5b59b0d6870cbd033ba4139d45bb45872", "url": "https://github.com/bisq-network/bisq/commit/2a86d5b5b59b0d6870cbd033ba4139d45bb45872", "message": "Add triggerPrice to csv", "committedDate": "2020-12-25T05:13:55Z", "type": "commit"}, {"oid": "57c1ad28a52c8285319114277136f982d6769ee2", "url": "https://github.com/bisq-network/bisq/commit/57c1ad28a52c8285319114277136f982d6769ee2", "message": "Add dontShowAgain to edit offer success popup", "committedDate": "2020-12-25T05:14:21Z", "type": "commit"}, {"oid": "4f96ade69d2d0b8c050ee9e992057afcf5a21df1", "url": "https://github.com/bisq-network/bisq/commit/4f96ade69d2d0b8c050ee9e992057afcf5a21df1", "message": "Rename wrong params", "committedDate": "2020-12-25T05:14:47Z", "type": "commit"}, {"oid": "1336cbb56972c968b922fb4ebcf4f7d84e4e7e4c", "url": "https://github.com/bisq-network/bisq/commit/1336cbb56972c968b922fb4ebcf4f7d84e4e7e4c", "message": "Fix test", "committedDate": "2020-12-25T06:27:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg4NzU4MA==", "url": "https://github.com/bisq-network/bisq/pull/5001#discussion_r548887580", "bodyText": "I instinctively need to ask if  PriceUtil could be moved to core.  I see dependencies on ChatView.log and ui validators, but much of the util logic could be made available to the api.", "author": "ghubstan", "createdAt": "2020-12-25T15:56:47Z", "path": "desktop/src/main/java/bisq/desktop/main/PriceUtil.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*", "originalCommit": "b36802dc49661ebe3669d5145644bdeb4ed01781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5NDg4Mg==", "url": "https://github.com/bisq-network/bisq/pull/5001#discussion_r548894882", "bodyText": "Yes I was thinking the same... was just to lazy to separate pure domain code with formatting stuff which is using desktop scope classes... But yes we should refactor that.", "author": "chimp1984", "createdAt": "2020-12-25T17:22:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg4NzU4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5Nzk3NQ==", "url": "https://github.com/bisq-network/bisq/pull/5001#discussion_r548897975", "bodyText": "Minor detail... placement of colons are not consistent (the last one).\nAnd you sure you wanted to use semi-colons to delimit key value pairs?  Is that consistent with other error log statements?", "author": "ghubstan", "createdAt": "2020-12-25T18:01:56Z", "path": "core/src/main/java/bisq/core/offer/PriceEventHandler.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.offer;\n+\n+import bisq.core.locale.CurrencyUtil;\n+import bisq.core.monetary.Altcoin;\n+import bisq.core.monetary.Price;\n+import bisq.core.provider.price.MarketPrice;\n+import bisq.core.provider.price.PriceFeedService;\n+\n+import bisq.common.util.MathUtils;\n+\n+import org.bitcoinj.utils.Fiat;\n+\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import javafx.collections.ListChangeListener;\n+\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import static bisq.common.util.MathUtils.roundDoubleToLong;\n+import static bisq.common.util.MathUtils.scaleUpByPowerOf10;\n+\n+@Slf4j\n+@Singleton\n+public class PriceEventHandler {\n+    private final OpenOfferManager openOfferManager;\n+    private final PriceFeedService priceFeedService;\n+    private final Map<String, Set<OpenOffer>> openOffersByCurrency = new HashMap<>();\n+\n+    @Inject\n+    public PriceEventHandler(OpenOfferManager openOfferManager, PriceFeedService priceFeedService) {\n+        this.openOfferManager = openOfferManager;\n+        this.priceFeedService = priceFeedService;\n+    }\n+\n+    public void onAllServicesInitialized() {\n+        openOfferManager.getObservableList().addListener((ListChangeListener<OpenOffer>) c -> {\n+            c.next();\n+            if (c.wasAdded()) {\n+                onAddedOpenOffers(c.getAddedSubList());\n+            }\n+            if (c.wasRemoved()) {\n+                onRemovedOpenOffers(c.getRemoved());\n+            }\n+        });\n+        onAddedOpenOffers(openOfferManager.getObservableList());\n+\n+        priceFeedService.updateCounterProperty().addListener((observable, oldValue, newValue) -> onPriceFeedChanged());\n+        onPriceFeedChanged();\n+    }\n+\n+    private void onPriceFeedChanged() {\n+        openOffersByCurrency.keySet().stream()\n+                .map(priceFeedService::getMarketPrice)\n+                .filter(Objects::nonNull)\n+                .filter(marketPrice -> openOffersByCurrency.containsKey(marketPrice.getCurrencyCode()))\n+                .forEach(marketPrice -> {\n+                    openOffersByCurrency.get(marketPrice.getCurrencyCode()).stream()\n+                            .filter(openOffer -> !openOffer.isDeactivated())\n+                            .forEach(openOffer -> checkPriceThreshold(marketPrice, openOffer));\n+                });\n+    }\n+\n+    private void checkPriceThreshold(bisq.core.provider.price.MarketPrice marketPrice, OpenOffer openOffer) {\n+        Price price = openOffer.getOffer().getPrice();\n+        if (price == null) {\n+            return;\n+        }\n+\n+        String currencyCode = openOffer.getOffer().getCurrencyCode();\n+        int smallestUnitExponent = CurrencyUtil.isCryptoCurrency(currencyCode) ?\n+                Altcoin.SMALLEST_UNIT_EXPONENT :\n+                Fiat.SMALLEST_UNIT_EXPONENT;\n+        long marketPriceAsLong = roundDoubleToLong(\n+                scaleUpByPowerOf10(marketPrice.getPrice(), smallestUnitExponent));\n+        long triggerPrice = openOffer.getTriggerPrice();\n+        if (triggerPrice > 0) {\n+            OfferPayload.Direction direction = openOffer.getOffer().getDirection();\n+            boolean triggered = direction == OfferPayload.Direction.BUY ?\n+                    marketPriceAsLong > triggerPrice :\n+                    marketPriceAsLong < triggerPrice;\n+            if (triggered) {\n+                log.error(\"Market price exceeded the trigger price of the open offer. \" +\n+                                \"We deactivate the open offer with ID {}. Currency: {}; offer direction: {}; \" +\n+                                \"Market price: {}; Upper price threshold : {}\",\n+                        openOffer.getOffer().getShortId(),", "originalCommit": "229d013844948b39db9f647f1a341d29af79e470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIwNTQyOQ==", "url": "https://github.com/bisq-network/bisq/pull/5001#discussion_r549205429", "bodyText": "I think we have no style rule for that...", "author": "chimp1984", "createdAt": "2020-12-28T03:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5Nzk3NQ=="}], "type": "inlineReview"}, {"oid": "681fed603e0a91f783905d2ec46e52d175cf1b60", "url": "https://github.com/bisq-network/bisq/commit/681fed603e0a91f783905d2ec46e52d175cf1b60", "message": "Fix log", "committedDate": "2020-12-28T03:50:56Z", "type": "commit"}]}