{"pr_number": 10075, "pr_title": "Make sure we always flush window update frames in AbstractHttp2StreamChannel", "pr_createdAt": "2020-03-02T20:32:27Z", "pr_url": "https://github.com/netty/netty/pull/10075", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzMzk1MA==", "url": "https://github.com/netty/netty/pull/10075#discussion_r386633950", "bodyText": "This feels like something that almost certainly exists somewhere else.", "author": "bryce-anderson", "createdAt": "2020-03-02T20:32:59Z", "path": "codec-http2/src/test/java/io/netty/handler/codec/http2/Http2TestUtil.java", "diffHunk": "@@ -687,6 +687,14 @@ static ByteBuf bb(String s) {\n         return ByteBufUtil.writeUtf8(UnpooledByteBufAllocator.DEFAULT, s);\n     }\n \n+    static ByteBuf bb(int size) {\n+        ByteBuf buf = UnpooledByteBufAllocator.DEFAULT.buffer();\n+        for (int i = 0; i < size; i++) {\n+            buf.writeByte('a');\n+        }\n+        return buf;\n+    }", "originalCommit": "9232b9a499ac6ccf6b571c7143e1a00a83950a91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY1MjI2OQ==", "url": "https://github.com/netty/netty/pull/10075#discussion_r386652269", "bodyText": "Just use bytebuf.writeZero(size); ?", "author": "normanmaurer", "createdAt": "2020-03-02T21:11:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzMzk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY2NDIxMw==", "url": "https://github.com/netty/netty/pull/10075#discussion_r386664213", "bodyText": "Would you prefer I replace the body of this method with\nUnpooledByteBufAllocator.DEFAULT.buffer().writeZero(size) or inline it in the best?", "author": "bryce-anderson", "createdAt": "2020-03-02T21:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzMzk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0NTc4MQ==", "url": "https://github.com/netty/netty/pull/10075#discussion_r386845781", "bodyText": "I dont care... I was just mention it as you said there is most likely something like this already :)", "author": "normanmaurer", "createdAt": "2020-03-03T07:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzMzk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzNDU3MA==", "url": "https://github.com/netty/netty/pull/10075#discussion_r386634570", "bodyText": "This change isn't strictly necessary for this patch but I spent a fair amount of time trying to read through this for the nth time and decided to clean it up so the control flow (when the method returns etc, not H2 flow control) is more readable. If desired, we can move it to a different patch.", "author": "bryce-anderson", "createdAt": "2020-03-02T20:34:15Z", "path": "codec-http2/src/main/java/io/netty/handler/codec/http2/AbstractHttp2StreamChannel.java", "diffHunk": "@@ -920,58 +920,57 @@ public void write(Object msg, final ChannelPromise promise) {\n             try {\n                 if (msg instanceof Http2StreamFrame) {\n                     Http2StreamFrame frame = validateStreamFrame((Http2StreamFrame) msg).stream(stream());\n-                    if (!firstFrameWritten && !isStreamIdValid(stream().id())) {", "originalCommit": "9232b9a499ac6ccf6b571c7143e1a00a83950a91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzNDc4NQ==", "url": "https://github.com/netty/netty/pull/10075#discussion_r386634785", "bodyText": "These are also not strictly necessary but part of the general cleanup I was attempting to do so this is more readable in the future.", "author": "bryce-anderson", "createdAt": "2020-03-02T20:34:44Z", "path": "codec-http2/src/main/java/io/netty/handler/codec/http2/AbstractHttp2StreamChannel.java", "diffHunk": "@@ -558,10 +558,7 @@ void fireChildRead(Http2Frame frame) {\n             // read (unknown, reset) and the trade off is less conditionals for the hot path (headers/data) at the\n             // cost of additional readComplete notifications on the rare path.\n             if (allocHandle.continueReading()) {\n-                if (!readCompletePending) {\n-                    readCompletePending = true;\n-                    addChannelToReadCompletePendingQueue();\n-                }", "originalCommit": "9232b9a499ac6ccf6b571c7143e1a00a83950a91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0NjUwMw==", "url": "https://github.com/netty/netty/pull/10075#discussion_r386846503", "bodyText": "nit: private final static", "author": "normanmaurer", "createdAt": "2020-03-03T07:51:11Z", "path": "codec-http2/src/test/java/io/netty/handler/codec/http2/Http2MultiplexTest.java", "diffHunk": "@@ -1152,6 +1152,66 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) {\n         verifyFramesMultiplexedToCorrectChannel(childChannel, inboundHandler, 3);\n     }\n \n+    class FlushSniffer extends ChannelOutboundHandlerAdapter {", "originalCommit": "9232b9a499ac6ccf6b571c7143e1a00a83950a91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eed3847f7d7275ba4718eece50a0838d97649c73", "url": "https://github.com/netty/netty/commit/eed3847f7d7275ba4718eece50a0838d97649c73", "message": "Make sure we always flush window update frames in AbstractHttp2StreamChannel\n\nMotivation:\n\nUnder certain read patters the AbstractHttp2StreamChannel can fail to\nflush, resulting in flow window starvation.\n\nModifications:\n\n- Ensure we flush if we exit the `doBeginRead()` method.\n- Account for the Http2FrameCodec always synchronously finishing writes\n  of window update frames.\n\nResult:\n\nFixes #10072", "committedDate": "2020-03-03T18:25:37Z", "type": "forcePushed"}, {"oid": "1e63317cad1ed65609b71c57b13850b153efb614", "url": "https://github.com/netty/netty/commit/1e63317cad1ed65609b71c57b13850b153efb614", "message": "Make sure we always flush window update frames in AbstractHttp2StreamChannel\n\nMotivation:\n\nUnder certain read patters the AbstractHttp2StreamChannel can fail to\nflush, resulting in flow window starvation.\n\nModifications:\n\n- Ensure we flush if we exit the `doBeginRead()` method.\n- Account for the Http2FrameCodec always synchronously finishing writes\n  of window update frames.\n\nResult:\n\nFixes #10072", "committedDate": "2020-03-03T22:43:08Z", "type": "commit"}, {"oid": "1e63317cad1ed65609b71c57b13850b153efb614", "url": "https://github.com/netty/netty/commit/1e63317cad1ed65609b71c57b13850b153efb614", "message": "Make sure we always flush window update frames in AbstractHttp2StreamChannel\n\nMotivation:\n\nUnder certain read patters the AbstractHttp2StreamChannel can fail to\nflush, resulting in flow window starvation.\n\nModifications:\n\n- Ensure we flush if we exit the `doBeginRead()` method.\n- Account for the Http2FrameCodec always synchronously finishing writes\n  of window update frames.\n\nResult:\n\nFixes #10072", "committedDate": "2020-03-03T22:43:08Z", "type": "forcePushed"}]}