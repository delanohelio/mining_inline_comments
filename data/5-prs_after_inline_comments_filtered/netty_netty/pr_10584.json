{"pr_number": 10584, "pr_title": "Not truncate MQTT SUBACK reason codes", "pr_createdAt": "2020-09-17T07:24:13Z", "pr_url": "https://github.com/netty/netty/pull/10584", "timeline": [{"oid": "9e6f44b91c130fef5bedcffb6193757facc17874", "url": "https://github.com/netty/netty/commit/9e6f44b91c130fef5bedcffb6193757facc17874", "message": "Return complete reason code in suback", "committedDate": "2020-09-17T07:18:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwMTcwNQ==", "url": "https://github.com/netty/netty/pull/10584#discussion_r490801705", "bodyText": "Do we need some special handling for MQTT 3.x ?", "author": "normanmaurer", "createdAt": "2020-09-18T08:54:44Z", "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttDecoder.java", "diffHunk": "@@ -543,15 +543,12 @@ private static int decodeMessageId(ByteBuf buffer) {\n     private static Result<MqttSubAckPayload> decodeSubackPayload(\n             ByteBuf buffer,\n             int bytesRemainingInVariablePart) {\n-        final List<Integer> grantedQos = new ArrayList<Integer>();\n+        final List<Integer> grantedQos = new ArrayList<Integer>(bytesRemainingInVariablePart);\n         int numberOfBytesConsumed = 0;\n         while (numberOfBytesConsumed < bytesRemainingInVariablePart) {\n-            int qos = buffer.readUnsignedByte();\n-            if (qos != MqttQoS.FAILURE.value()) {\n-                qos &= 0x03;\n-            }\n+            int reasonCode = buffer.readUnsignedByte();", "originalCommit": "9e6f44b91c130fef5bedcffb6193757facc17874", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgxMzg0NQ==", "url": "https://github.com/netty/netty/pull/10584#discussion_r490813845", "bodyText": "No special handling - this just cuts off some codes which were not valid in 3.x but became valid in 5.0. See http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/csprd02/mqtt-v3.1.1-csprd02.html#_Toc385349807 vs https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901178.", "author": "paul-lysak", "createdAt": "2020-09-18T09:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwMTcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwMTg0Mg==", "url": "https://github.com/netty/netty/pull/10584#discussion_r490901842", "bodyText": "The question is do we need to cut these off when 3.x is used ?", "author": "normanmaurer", "createdAt": "2020-09-18T12:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwMTcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwMzg3NQ==", "url": "https://github.com/netty/netty/pull/10584#discussion_r490903875", "bodyText": "I don't see much use in it, and as checking the protocol version has some performance penalty (need to retrieve it from the channel attribute) - decided not to do it. If you think someone might need it - I can add the check.", "author": "paul-lysak", "createdAt": "2020-09-18T12:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwMTcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4MDU1Mg==", "url": "https://github.com/netty/netty/pull/10584#discussion_r490980552", "bodyText": "Ok I was just wondering what will happen to users that \"depend\" on this... So you think there is no \"risk\" ?", "author": "normanmaurer", "createdAt": "2020-09-18T14:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwMTcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4NTkwOQ==", "url": "https://github.com/netty/netty/pull/10584#discussion_r490985909", "bodyText": "With well-behaved MQTT server they'll see exactly the same behavior, as MQTT 3.1 requires bits othter than 0,1 and 7 to remain 0 when sending a message. They only will see unexpected code if server violates the spec, which is possible, in principle, but is very unlikely and, well, it's spec violation from the server side.", "author": "paul-lysak", "createdAt": "2020-09-18T14:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwMTcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg5MTcwOA==", "url": "https://github.com/netty/netty/pull/10584#discussion_r491891708", "bodyText": "@paul-lysak hmm... this feels not correct to me. Do we need to use & 0x03 for the values here ?", "author": "normanmaurer", "createdAt": "2020-09-21T09:07:32Z", "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttSubAckPayload.java", "diffHunk": "@@ -28,39 +28,43 @@\n  */\n public class MqttSubAckPayload {\n \n-    private final List<Integer> grantedQoSLevels;\n+    private final List<Integer> reasonCodes;\n \n-    public MqttSubAckPayload(int... grantedQoSLevels) {\n-        ObjectUtil.checkNotNull(grantedQoSLevels, \"grantedQoSLevels\");\n+    public MqttSubAckPayload(int... reasonCodes) {\n+        ObjectUtil.checkNotNull(reasonCodes, \"reasonCodes\");\n \n-        List<Integer> list = new ArrayList<Integer>(grantedQoSLevels.length);\n-        for (int v: grantedQoSLevels) {\n+        List<Integer> list = new ArrayList<Integer>(reasonCodes.length);\n+        for (int v: reasonCodes) {\n             list.add(v);\n         }\n-        this.grantedQoSLevels = Collections.unmodifiableList(list);\n+        this.reasonCodes = Collections.unmodifiableList(list);\n     }\n \n     public MqttSubAckPayload(Iterable<Integer> grantedQoSLevels) {\n-        ObjectUtil.checkNotNull(grantedQoSLevels, \"grantedQoSLevels\");\n+        ObjectUtil.checkNotNull(grantedQoSLevels, \"reasonCodes\");\n         List<Integer> list = new ArrayList<Integer>();\n         for (Integer v: grantedQoSLevels) {\n             if (v == null) {\n                 break;\n             }\n             list.add(v);\n         }\n-        this.grantedQoSLevels = Collections.unmodifiableList(list);\n+        this.reasonCodes = Collections.unmodifiableList(list);\n     }\n \n     public List<Integer> grantedQoSLevels() {\n-        return grantedQoSLevels;\n+        return reasonCodes;", "originalCommit": "9e6f44b91c130fef5bedcffb6193757facc17874", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkwMDM2OQ==", "url": "https://github.com/netty/netty/pull/10584#discussion_r491900369", "bodyText": "In fact, it already can return error code 0x80 beside the actual QoS levels. Nevertheless, I've added a mask here to ensure no new error codes.", "author": "paul-lysak", "createdAt": "2020-09-21T09:23:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg5MTcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkwMTE3Ng==", "url": "https://github.com/netty/netty/pull/10584#discussion_r491901176", "bodyText": "can you add a test case for this as well ?", "author": "normanmaurer", "createdAt": "2020-09-21T09:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg5MTcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxMDI2Mw==", "url": "https://github.com/netty/netty/pull/10584#discussion_r491910263", "bodyText": "done", "author": "paul-lysak", "createdAt": "2020-09-21T09:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg5MTcwOA=="}], "type": "inlineReview"}, {"oid": "bd9b47f0cdaacf0f0b674a3f2e9f1bc073ca1a97", "url": "https://github.com/netty/netty/commit/bd9b47f0cdaacf0f0b674a3f2e9f1bc073ca1a97", "message": "Mask QoS level", "committedDate": "2020-09-21T09:21:13Z", "type": "commit"}, {"oid": "37a5e6c6183fb3a6857c2abf602cd27fc83493d0", "url": "https://github.com/netty/netty/commit/37a5e6c6183fb3a6857c2abf602cd27fc83493d0", "message": "Test SUBACK reason code truncation to QoS", "committedDate": "2020-09-21T09:39:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyODA5MQ==", "url": "https://github.com/netty/netty/pull/10584#discussion_r491928091", "bodyText": "nit: change the parameter name ?", "author": "normanmaurer", "createdAt": "2020-09-21T10:08:57Z", "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttSubAckPayload.java", "diffHunk": "@@ -28,39 +28,51 @@\n  */\n public class MqttSubAckPayload {\n \n-    private final List<Integer> grantedQoSLevels;\n+    private final List<Integer> reasonCodes;\n \n-    public MqttSubAckPayload(int... grantedQoSLevels) {\n-        ObjectUtil.checkNotNull(grantedQoSLevels, \"grantedQoSLevels\");\n+    public MqttSubAckPayload(int... reasonCodes) {\n+        ObjectUtil.checkNotNull(reasonCodes, \"reasonCodes\");\n \n-        List<Integer> list = new ArrayList<Integer>(grantedQoSLevels.length);\n-        for (int v: grantedQoSLevels) {\n+        List<Integer> list = new ArrayList<Integer>(reasonCodes.length);\n+        for (int v: reasonCodes) {\n             list.add(v);\n         }\n-        this.grantedQoSLevels = Collections.unmodifiableList(list);\n+        this.reasonCodes = Collections.unmodifiableList(list);\n     }\n \n     public MqttSubAckPayload(Iterable<Integer> grantedQoSLevels) {", "originalCommit": "37a5e6c6183fb3a6857c2abf602cd27fc83493d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5a2207ebfc8390858d86f2bbbdf854b5459ef556", "url": "https://github.com/netty/netty/commit/5a2207ebfc8390858d86f2bbbdf854b5459ef556", "message": "Rename parameter", "committedDate": "2020-09-21T10:25:13Z", "type": "commit"}]}