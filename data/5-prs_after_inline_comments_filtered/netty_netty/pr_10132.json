{"pr_number": 10132, "pr_title": "Introduce DomainWildcardMappingBuilder to fix wildcard matching accor\u2026", "pr_createdAt": "2020-03-24T14:00:38Z", "pr_url": "https://github.com/netty/netty/pull/10132", "timeline": [{"oid": "b0416fd93aaa6c2c57d0400a29c278b65f0a80b0", "url": "https://github.com/netty/netty/commit/b0416fd93aaa6c2c57d0400a29c278b65f0a80b0", "message": "Introduce DomainWildcardMappingBuilder to fix wildcard matching according to RFC6125\n\nMotivation:\n\nHow we did wildcard matching was not correct according to RFC6125. Beside this our implementation was quite CPU heavy.\n\nModifications:\n\n- Add new DomainWildcardMappingBuilder which correctly does wildcard matching. See https://tools.ietf.org/search/rfc6125#section-6.4\n- Add unit tests\n- Deprecate old implementations\n\nResult:\n\nCorrectly implement wildcard matching and improve performance", "committedDate": "2020-03-24T13:58:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3NjIzNg==", "url": "https://github.com/netty/netty/pull/10132#discussion_r397576236", "bodyText": "Optional idea:  If a user adds a wildcard domain *.netty.io,  it could be normalized to .netty.io, and stored in the map.  That would make it cheaper for this line to check if it's present, because no string concatenation would be needed.  You could just check the substring.\nI am not sure how fast you want it to go.", "author": "carl-mastrangelo", "createdAt": "2020-03-25T02:35:19Z", "path": "common/src/main/java/io/netty/util/DomainWildcardMappingBuilder.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+import static io.netty.util.internal.ObjectUtil.checkNotNull;\n+\n+/**\n+ * Builder that allows to build {@link Mapping}s that support\n+ * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> matching.\n+ * @param <V> the type of the value that we map to.\n+ */\n+public class DomainWildcardMappingBuilder<V> {\n+\n+    private final V defaultValue;\n+    private final Map<String, V> map;\n+\n+    /**\n+     * Constructor with default initial capacity of the map holding the mappings\n+     *\n+     * @param defaultValue the default value for {@link Mapping#map(Object)} )} to return\n+     *                     when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(V defaultValue) {\n+        this(4, defaultValue);\n+    }\n+\n+    /**\n+     * Constructor with initial capacity of the map holding the mappings\n+     *\n+     * @param initialCapacity initial capacity for the internal map\n+     * @param defaultValue    the default value for {@link Mapping#map(Object)} to return\n+     *                        when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(int initialCapacity, V defaultValue) {\n+        this.defaultValue = checkNotNull(defaultValue, \"defaultValue\");\n+        map = new LinkedHashMap<String, V>(initialCapacity);\n+    }\n+\n+    /**\n+     * Adds a mapping that maps the specified (optionally wildcard) host name to the specified output value.\n+     * {@code null} values are forbidden for both hostnames and values.\n+     * <p>\n+     * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> is supported as hostname. The\n+     * wildcard will only match one sub-domain deep and only when wildcard is used as the most-left label.\n+     *\n+     * For example:\n+     *\n+     * <p>\n+     *  *.netty.io will match xyz.netty.io but NOT abc.xyz.netty.io\n+     * </p>\n+     *\n+     * @param hostname the host name (optionally wildcard)\n+     * @param output   the output value that will be returned by {@link Mapping#map(Object)}\n+     *                 when the specified host name matches the specified input host name\n+     */\n+    public DomainWildcardMappingBuilder<V> add(String hostname, V output) {\n+        map.put(ImmutableDomainWildcardMapping.normalize(checkNotNull(hostname, \"hostname\")),\n+                checkNotNull(output, \"output\"));\n+        return this;\n+    }\n+\n+    /**\n+     * Creates a new instance of an immutable {@link Mapping}.\n+     *\n+     * @return new {@link Mapping} instance\n+     */\n+    public Mapping<String, V> build() {\n+        return new ImmutableDomainWildcardMapping<V>(defaultValue, new LinkedHashMap<String, V>(map));\n+    }\n+\n+    private static final class ImmutableDomainWildcardMapping<V> implements Mapping<String, V> {\n+        private static final String REPR_HEADER = \"ImmutableDomainWildcardMapping(default: \";\n+        private static final String REPR_MAP_OPENING = \", map: \";\n+        private static final String REPR_MAP_CLOSING = \")\";\n+\n+        private final V defaultValue;\n+        private final Map<String, V> map;\n+\n+        ImmutableDomainWildcardMapping(V defaultValue, Map<String, V> map) {\n+            this.defaultValue = defaultValue;\n+            this.map = Collections.unmodifiableMap(map);\n+        }\n+\n+        @Override\n+        public V map(String hostname) {\n+            if (hostname != null) {\n+                hostname = normalize(hostname);\n+\n+                // Let's try an exact match first\n+                V value = map.get(hostname);\n+                if (value != null) {\n+                    return value;\n+                }\n+\n+                // No exact match, let's try a wildcard match.\n+                int idx = hostname.indexOf('.');\n+                if (idx != -1) {\n+                    value = map.get('*' + hostname.substring(idx));", "originalCommit": "b0416fd93aaa6c2c57d0400a29c278b65f0a80b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY0MjQ1NQ==", "url": "https://github.com/netty/netty/pull/10132#discussion_r397642455", "bodyText": "thats a good idea ... Let me do this", "author": "normanmaurer", "createdAt": "2020-03-25T07:01:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3NjIzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3NzE5Ng==", "url": "https://github.com/netty/netty/pull/10132#discussion_r397577196", "bodyText": "s/.toString()//", "author": "carl-mastrangelo", "createdAt": "2020-03-25T02:39:14Z", "path": "common/src/main/java/io/netty/util/DomainWildcardMappingBuilder.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+import static io.netty.util.internal.ObjectUtil.checkNotNull;\n+\n+/**\n+ * Builder that allows to build {@link Mapping}s that support\n+ * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> matching.\n+ * @param <V> the type of the value that we map to.\n+ */\n+public class DomainWildcardMappingBuilder<V> {\n+\n+    private final V defaultValue;\n+    private final Map<String, V> map;\n+\n+    /**\n+     * Constructor with default initial capacity of the map holding the mappings\n+     *\n+     * @param defaultValue the default value for {@link Mapping#map(Object)} )} to return\n+     *                     when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(V defaultValue) {\n+        this(4, defaultValue);\n+    }\n+\n+    /**\n+     * Constructor with initial capacity of the map holding the mappings\n+     *\n+     * @param initialCapacity initial capacity for the internal map\n+     * @param defaultValue    the default value for {@link Mapping#map(Object)} to return\n+     *                        when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(int initialCapacity, V defaultValue) {\n+        this.defaultValue = checkNotNull(defaultValue, \"defaultValue\");\n+        map = new LinkedHashMap<String, V>(initialCapacity);\n+    }\n+\n+    /**\n+     * Adds a mapping that maps the specified (optionally wildcard) host name to the specified output value.\n+     * {@code null} values are forbidden for both hostnames and values.\n+     * <p>\n+     * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> is supported as hostname. The\n+     * wildcard will only match one sub-domain deep and only when wildcard is used as the most-left label.\n+     *\n+     * For example:\n+     *\n+     * <p>\n+     *  *.netty.io will match xyz.netty.io but NOT abc.xyz.netty.io\n+     * </p>\n+     *\n+     * @param hostname the host name (optionally wildcard)\n+     * @param output   the output value that will be returned by {@link Mapping#map(Object)}\n+     *                 when the specified host name matches the specified input host name\n+     */\n+    public DomainWildcardMappingBuilder<V> add(String hostname, V output) {\n+        map.put(ImmutableDomainWildcardMapping.normalize(checkNotNull(hostname, \"hostname\")),\n+                checkNotNull(output, \"output\"));\n+        return this;\n+    }\n+\n+    /**\n+     * Creates a new instance of an immutable {@link Mapping}.\n+     *\n+     * @return new {@link Mapping} instance\n+     */\n+    public Mapping<String, V> build() {\n+        return new ImmutableDomainWildcardMapping<V>(defaultValue, new LinkedHashMap<String, V>(map));\n+    }\n+\n+    private static final class ImmutableDomainWildcardMapping<V> implements Mapping<String, V> {\n+        private static final String REPR_HEADER = \"ImmutableDomainWildcardMapping(default: \";\n+        private static final String REPR_MAP_OPENING = \", map: \";\n+        private static final String REPR_MAP_CLOSING = \")\";\n+\n+        private final V defaultValue;\n+        private final Map<String, V> map;\n+\n+        ImmutableDomainWildcardMapping(V defaultValue, Map<String, V> map) {\n+            this.defaultValue = defaultValue;\n+            this.map = Collections.unmodifiableMap(map);\n+        }\n+\n+        @Override\n+        public V map(String hostname) {\n+            if (hostname != null) {\n+                hostname = normalize(hostname);\n+\n+                // Let's try an exact match first\n+                V value = map.get(hostname);\n+                if (value != null) {\n+                    return value;\n+                }\n+\n+                // No exact match, let's try a wildcard match.\n+                int idx = hostname.indexOf('.');\n+                if (idx != -1) {\n+                    value = map.get('*' + hostname.substring(idx));\n+                    if (value != null) {\n+                        return value;\n+                    }\n+                }\n+            }\n+\n+            return defaultValue;\n+        }\n+\n+        @SuppressWarnings(\"deprecation\")\n+        static String normalize(String hostname) {\n+            return DomainNameMapping.normalizeHostname(hostname);\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return REPR_HEADER + defaultValue + REPR_MAP_OPENING + map.toString() + REPR_MAP_CLOSING;", "originalCommit": "b0416fd93aaa6c2c57d0400a29c278b65f0a80b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d8817fad436791e47b1c856a309ab435b045b824", "url": "https://github.com/netty/netty/commit/d8817fad436791e47b1c856a309ab435b045b824", "message": "Address carls comments", "committedDate": "2020-03-25T07:23:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1MzQ2NA==", "url": "https://github.com/netty/netty/pull/10132#discussion_r397653464", "bodyText": "check that charAt(1) is a . ? (and is also at least length 2)", "author": "carl-mastrangelo", "createdAt": "2020-03-25T07:33:06Z", "path": "common/src/main/java/io/netty/util/DomainWildcardMappingBuilder.java", "diffHunk": "@@ -71,11 +71,22 @@ public DomainWildcardMappingBuilder(int initialCapacity, V defaultValue) {\n      *                 when the specified host name matches the specified input host name\n      */\n     public DomainWildcardMappingBuilder<V> add(String hostname, V output) {\n-        map.put(ImmutableDomainWildcardMapping.normalize(checkNotNull(hostname, \"hostname\")),\n+        map.put(normalizeHostName(hostname),\n                 checkNotNull(output, \"output\"));\n         return this;\n     }\n \n+    private String normalizeHostName(String hostname) {\n+        checkNotNull(hostname, \"hostname\");\n+        if (hostname.isEmpty() || hostname.charAt(0) == '.') {\n+            throw new IllegalArgumentException(\"Hostname '\" + hostname + \"'not valid\");\n+        }\n+        hostname = ImmutableDomainWildcardMapping.normalize(checkNotNull(hostname, \"hostname\"));\n+        if (hostname.charAt(0) == '*') {\n+            return hostname.substring(1);", "originalCommit": "d8817fad436791e47b1c856a309ab435b045b824", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1Njk3OA==", "url": "https://github.com/netty/netty/pull/10132#discussion_r397656978", "bodyText": "sure why not :)", "author": "normanmaurer", "createdAt": "2020-03-25T07:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1MzQ2NA=="}], "type": "inlineReview"}, {"oid": "f23b375f6433c98517e06643e5c4c9a80346cbd8", "url": "https://github.com/netty/netty/commit/f23b375f6433c98517e06643e5c4c9a80346cbd8", "message": "more validation", "committedDate": "2020-03-25T07:52:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY2MjAyMg==", "url": "https://github.com/netty/netty/pull/10132#discussion_r397662022", "bodyText": "The order is reversed.   This might throw an IOOBE", "author": "carl-mastrangelo", "createdAt": "2020-03-25T07:54:04Z", "path": "common/src/main/java/io/netty/util/DomainWildcardMappingBuilder.java", "diffHunk": "@@ -83,6 +83,9 @@ private String normalizeHostName(String hostname) {\n         }\n         hostname = ImmutableDomainWildcardMapping.normalize(checkNotNull(hostname, \"hostname\"));\n         if (hostname.charAt(0) == '*') {\n+            if (hostname.charAt(1) != '.' || hostname.length() < 3) {", "originalCommit": "f23b375f6433c98517e06643e5c4c9a80346cbd8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY2Mjg5OA==", "url": "https://github.com/netty/netty/pull/10132#discussion_r397662898", "bodyText": "I am an idiot... fixed", "author": "normanmaurer", "createdAt": "2020-03-25T07:56:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY2MjAyMg=="}], "type": "inlineReview"}, {"oid": "d16468626486b22dee57ac81c3b713431012e4e6", "url": "https://github.com/netty/netty/commit/d16468626486b22dee57ac81c3b713431012e4e6", "message": "Fix check", "committedDate": "2020-03-25T07:55:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA3ODkzNg==", "url": "https://github.com/netty/netty/pull/10132#discussion_r399078936", "bodyText": "https://gist.github.com/apangin/7a9b7062a4bd0cd41fcc#file-hotspot-jvm-intrinsics-L66 : java 8 doesn't contain String::indexOf(char) in the list of String intrinsics, while the version using String, yes. Java 9 has introduced the version with char IIRC", "author": "franz1981", "createdAt": "2020-03-27T07:31:42Z", "path": "common/src/main/java/io/netty/util/DomainWildcardMappingBuilder.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+import static io.netty.util.internal.ObjectUtil.checkNotNull;\n+\n+/**\n+ * Builder that allows to build {@link Mapping}s that support\n+ * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> matching.\n+ * @param <V> the type of the value that we map to.\n+ */\n+public class DomainWildcardMappingBuilder<V> {\n+\n+    private final V defaultValue;\n+    private final Map<String, V> map;\n+\n+    /**\n+     * Constructor with default initial capacity of the map holding the mappings\n+     *\n+     * @param defaultValue the default value for {@link Mapping#map(Object)} )} to return\n+     *                     when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(V defaultValue) {\n+        this(4, defaultValue);\n+    }\n+\n+    /**\n+     * Constructor with initial capacity of the map holding the mappings\n+     *\n+     * @param initialCapacity initial capacity for the internal map\n+     * @param defaultValue    the default value for {@link Mapping#map(Object)} to return\n+     *                        when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(int initialCapacity, V defaultValue) {\n+        this.defaultValue = checkNotNull(defaultValue, \"defaultValue\");\n+        map = new LinkedHashMap<String, V>(initialCapacity);\n+    }\n+\n+    /**\n+     * Adds a mapping that maps the specified (optionally wildcard) host name to the specified output value.\n+     * {@code null} values are forbidden for both hostnames and values.\n+     * <p>\n+     * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> is supported as hostname. The\n+     * wildcard will only match one sub-domain deep and only when wildcard is used as the most-left label.\n+     *\n+     * For example:\n+     *\n+     * <p>\n+     *  *.netty.io will match xyz.netty.io but NOT abc.xyz.netty.io\n+     * </p>\n+     *\n+     * @param hostname the host name (optionally wildcard)\n+     * @param output   the output value that will be returned by {@link Mapping#map(Object)}\n+     *                 when the specified host name matches the specified input host name\n+     */\n+    public DomainWildcardMappingBuilder<V> add(String hostname, V output) {\n+        map.put(normalizeHostName(hostname),\n+                checkNotNull(output, \"output\"));\n+        return this;\n+    }\n+\n+    private String normalizeHostName(String hostname) {\n+        checkNotNull(hostname, \"hostname\");\n+        if (hostname.isEmpty() || hostname.charAt(0) == '.') {\n+            throw new IllegalArgumentException(\"Hostname '\" + hostname + \"'not valid\");\n+        }\n+        hostname = ImmutableDomainWildcardMapping.normalize(checkNotNull(hostname, \"hostname\"));\n+        if (hostname.charAt(0) == '*') {\n+            if (hostname.length() < 3 || hostname.charAt(1) != '.') {\n+                throw new IllegalArgumentException(\"Wildcard Hostname '\" + hostname + \"'not valid\");\n+            }\n+            return hostname.substring(1);\n+        }\n+        return hostname;\n+    }\n+    /**\n+     * Creates a new instance of an immutable {@link Mapping}.\n+     *\n+     * @return new {@link Mapping} instance\n+     */\n+    public Mapping<String, V> build() {\n+        return new ImmutableDomainWildcardMapping<V>(defaultValue, new LinkedHashMap<String, V>(map));\n+    }\n+\n+    private static final class ImmutableDomainWildcardMapping<V> implements Mapping<String, V> {\n+        private static final String REPR_HEADER = \"ImmutableDomainWildcardMapping(default: \";\n+        private static final String REPR_MAP_OPENING = \", map: \";\n+        private static final String REPR_MAP_CLOSING = \")\";\n+\n+        private final V defaultValue;\n+        private final Map<String, V> map;\n+\n+        ImmutableDomainWildcardMapping(V defaultValue, Map<String, V> map) {\n+            this.defaultValue = defaultValue;\n+            this.map = Collections.unmodifiableMap(map);\n+        }\n+\n+        @Override\n+        public V map(String hostname) {\n+            if (hostname != null) {\n+                hostname = normalize(hostname);\n+\n+                // Let's try an exact match first\n+                V value = map.get(hostname);\n+                if (value != null) {\n+                    return value;\n+                }\n+\n+                // No exact match, let's try a wildcard match.\n+                int idx = hostname.indexOf('.');", "originalCommit": "d16468626486b22dee57ac81c3b713431012e4e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA4MzU0Ng==", "url": "https://github.com/netty/netty/pull/10132#discussion_r399083546", "bodyText": "sure we can also use String if you think it matters a lot...  WDYT @franz1981 ?", "author": "normanmaurer", "createdAt": "2020-03-27T07:44:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA3ODkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA5MzQ4MA==", "url": "https://github.com/netty/netty/pull/10132#discussion_r399093480", "bodyText": "I've written a small bench to check if if it can really matter, will tell you soon :)", "author": "franz1981", "createdAt": "2020-03-27T08:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA3ODkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA5Nzg4NQ==", "url": "https://github.com/netty/netty/pull/10132#discussion_r399097885", "bodyText": "Ok, for input Strings < 100, searching a String in whatever position is just slower then using indexOf(char), so better to left indexOf(char)", "author": "franz1981", "createdAt": "2020-03-27T08:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA3ODkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA5ODkwMg==", "url": "https://github.com/netty/netty/pull/10132#discussion_r399098902", "bodyText": "ok then I think I am done...", "author": "normanmaurer", "createdAt": "2020-03-27T08:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA3ODkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA4MDQ5MQ==", "url": "https://github.com/netty/netty/pull/10132#discussion_r399080491", "bodyText": "DomainWildcardMappingBuilder::build is alredy creating a fresh new map that would be owned by ImmutableDomainWildcardMapping: if you let the copy of DomainWildcardMappingBuilder::map to happen inside new ImmutableDomainWildcardMapping, you could save using an unmodifiableMap and the pointer chasing introduced by it", "author": "franz1981", "createdAt": "2020-03-27T07:36:13Z", "path": "common/src/main/java/io/netty/util/DomainWildcardMappingBuilder.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+import static io.netty.util.internal.ObjectUtil.checkNotNull;\n+\n+/**\n+ * Builder that allows to build {@link Mapping}s that support\n+ * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> matching.\n+ * @param <V> the type of the value that we map to.\n+ */\n+public class DomainWildcardMappingBuilder<V> {\n+\n+    private final V defaultValue;\n+    private final Map<String, V> map;\n+\n+    /**\n+     * Constructor with default initial capacity of the map holding the mappings\n+     *\n+     * @param defaultValue the default value for {@link Mapping#map(Object)} )} to return\n+     *                     when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(V defaultValue) {\n+        this(4, defaultValue);\n+    }\n+\n+    /**\n+     * Constructor with initial capacity of the map holding the mappings\n+     *\n+     * @param initialCapacity initial capacity for the internal map\n+     * @param defaultValue    the default value for {@link Mapping#map(Object)} to return\n+     *                        when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(int initialCapacity, V defaultValue) {\n+        this.defaultValue = checkNotNull(defaultValue, \"defaultValue\");\n+        map = new LinkedHashMap<String, V>(initialCapacity);\n+    }\n+\n+    /**\n+     * Adds a mapping that maps the specified (optionally wildcard) host name to the specified output value.\n+     * {@code null} values are forbidden for both hostnames and values.\n+     * <p>\n+     * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> is supported as hostname. The\n+     * wildcard will only match one sub-domain deep and only when wildcard is used as the most-left label.\n+     *\n+     * For example:\n+     *\n+     * <p>\n+     *  *.netty.io will match xyz.netty.io but NOT abc.xyz.netty.io\n+     * </p>\n+     *\n+     * @param hostname the host name (optionally wildcard)\n+     * @param output   the output value that will be returned by {@link Mapping#map(Object)}\n+     *                 when the specified host name matches the specified input host name\n+     */\n+    public DomainWildcardMappingBuilder<V> add(String hostname, V output) {\n+        map.put(normalizeHostName(hostname),\n+                checkNotNull(output, \"output\"));\n+        return this;\n+    }\n+\n+    private String normalizeHostName(String hostname) {\n+        checkNotNull(hostname, \"hostname\");\n+        if (hostname.isEmpty() || hostname.charAt(0) == '.') {\n+            throw new IllegalArgumentException(\"Hostname '\" + hostname + \"'not valid\");\n+        }\n+        hostname = ImmutableDomainWildcardMapping.normalize(checkNotNull(hostname, \"hostname\"));\n+        if (hostname.charAt(0) == '*') {\n+            if (hostname.length() < 3 || hostname.charAt(1) != '.') {\n+                throw new IllegalArgumentException(\"Wildcard Hostname '\" + hostname + \"'not valid\");\n+            }\n+            return hostname.substring(1);\n+        }\n+        return hostname;\n+    }\n+    /**\n+     * Creates a new instance of an immutable {@link Mapping}.\n+     *\n+     * @return new {@link Mapping} instance\n+     */\n+    public Mapping<String, V> build() {\n+        return new ImmutableDomainWildcardMapping<V>(defaultValue, new LinkedHashMap<String, V>(map));\n+    }\n+\n+    private static final class ImmutableDomainWildcardMapping<V> implements Mapping<String, V> {\n+        private static final String REPR_HEADER = \"ImmutableDomainWildcardMapping(default: \";\n+        private static final String REPR_MAP_OPENING = \", map: \";\n+        private static final String REPR_MAP_CLOSING = \")\";\n+\n+        private final V defaultValue;\n+        private final Map<String, V> map;\n+\n+        ImmutableDomainWildcardMapping(V defaultValue, Map<String, V> map) {\n+            this.defaultValue = defaultValue;\n+            this.map = Collections.unmodifiableMap(map);", "originalCommit": "d16468626486b22dee57ac81c3b713431012e4e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA4MzY5Mw==", "url": "https://github.com/netty/netty/pull/10132#discussion_r399083693", "bodyText": "@franz1981 good point...", "author": "normanmaurer", "createdAt": "2020-03-27T07:44:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA4MDQ5MQ=="}], "type": "inlineReview"}, {"oid": "73bd6b893d263f6fa7d68df172358827ea85dcfa", "url": "https://github.com/netty/netty/commit/73bd6b893d263f6fa7d68df172358827ea85dcfa", "message": "Address comment", "committedDate": "2020-03-27T07:47:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA5OTg4Nw==", "url": "https://github.com/netty/netty/pull/10132#discussion_r399099887", "bodyText": "you can pass directly map to the ImmutableDomainWildcardMapping constructor (it will make the copy internally)", "author": "franz1981", "createdAt": "2020-03-27T08:23:03Z", "path": "common/src/main/java/io/netty/util/DomainWildcardMappingBuilder.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+import static io.netty.util.internal.ObjectUtil.checkNotNull;\n+\n+/**\n+ * Builder that allows to build {@link Mapping}s that support\n+ * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> matching.\n+ * @param <V> the type of the value that we map to.\n+ */\n+public class DomainWildcardMappingBuilder<V> {\n+\n+    private final V defaultValue;\n+    private final Map<String, V> map;\n+\n+    /**\n+     * Constructor with default initial capacity of the map holding the mappings\n+     *\n+     * @param defaultValue the default value for {@link Mapping#map(Object)} )} to return\n+     *                     when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(V defaultValue) {\n+        this(4, defaultValue);\n+    }\n+\n+    /**\n+     * Constructor with initial capacity of the map holding the mappings\n+     *\n+     * @param initialCapacity initial capacity for the internal map\n+     * @param defaultValue    the default value for {@link Mapping#map(Object)} to return\n+     *                        when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(int initialCapacity, V defaultValue) {\n+        this.defaultValue = checkNotNull(defaultValue, \"defaultValue\");\n+        map = new LinkedHashMap<String, V>(initialCapacity);\n+    }\n+\n+    /**\n+     * Adds a mapping that maps the specified (optionally wildcard) host name to the specified output value.\n+     * {@code null} values are forbidden for both hostnames and values.\n+     * <p>\n+     * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> is supported as hostname. The\n+     * wildcard will only match one sub-domain deep and only when wildcard is used as the most-left label.\n+     *\n+     * For example:\n+     *\n+     * <p>\n+     *  *.netty.io will match xyz.netty.io but NOT abc.xyz.netty.io\n+     * </p>\n+     *\n+     * @param hostname the host name (optionally wildcard)\n+     * @param output   the output value that will be returned by {@link Mapping#map(Object)}\n+     *                 when the specified host name matches the specified input host name\n+     */\n+    public DomainWildcardMappingBuilder<V> add(String hostname, V output) {\n+        map.put(normalizeHostName(hostname),\n+                checkNotNull(output, \"output\"));\n+        return this;\n+    }\n+\n+    private String normalizeHostName(String hostname) {\n+        checkNotNull(hostname, \"hostname\");\n+        if (hostname.isEmpty() || hostname.charAt(0) == '.') {\n+            throw new IllegalArgumentException(\"Hostname '\" + hostname + \"'not valid\");\n+        }\n+        hostname = ImmutableDomainWildcardMapping.normalize(checkNotNull(hostname, \"hostname\"));\n+        if (hostname.charAt(0) == '*') {\n+            if (hostname.length() < 3 || hostname.charAt(1) != '.') {\n+                throw new IllegalArgumentException(\"Wildcard Hostname '\" + hostname + \"'not valid\");\n+            }\n+            return hostname.substring(1);\n+        }\n+        return hostname;\n+    }\n+    /**\n+     * Creates a new instance of an immutable {@link Mapping}.\n+     *\n+     * @return new {@link Mapping} instance\n+     */\n+    public Mapping<String, V> build() {\n+        return new ImmutableDomainWildcardMapping<V>(defaultValue, new LinkedHashMap<String, V>(map));", "originalCommit": "73bd6b893d263f6fa7d68df172358827ea85dcfa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2b1830ef855fc7e0996830abdcf21b099bb6d6e0", "url": "https://github.com/netty/netty/commit/2b1830ef855fc7e0996830abdcf21b099bb6d6e0", "message": "Remove extra copy", "committedDate": "2020-03-27T08:25:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxMzQ3Mw==", "url": "https://github.com/netty/netty/pull/10132#discussion_r400313473", "bodyText": "intentionally low default?", "author": "johnou", "createdAt": "2020-03-30T16:07:48Z", "path": "common/src/main/java/io/netty/util/DomainWildcardMappingBuilder.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+import static io.netty.util.internal.ObjectUtil.checkNotNull;\n+\n+/**\n+ * Builder that allows to build {@link Mapping}s that support\n+ * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> matching.\n+ * @param <V> the type of the value that we map to.\n+ */\n+public class DomainWildcardMappingBuilder<V> {\n+\n+    private final V defaultValue;\n+    private final Map<String, V> map;\n+\n+    /**\n+     * Constructor with default initial capacity of the map holding the mappings\n+     *\n+     * @param defaultValue the default value for {@link Mapping#map(Object)} )} to return\n+     *                     when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(V defaultValue) {\n+        this(4, defaultValue);", "originalCommit": "2b1830ef855fc7e0996830abdcf21b099bb6d6e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNDI5Mg==", "url": "https://github.com/netty/netty/pull/10132#discussion_r400314292", "bodyText": "yeah its what we use with our others as well...", "author": "normanmaurer", "createdAt": "2020-03-30T16:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxMzQ3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNDgxMA==", "url": "https://github.com/netty/netty/pull/10132#discussion_r400314810", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"Hostname '\" + hostname + \"'not valid\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"Hostname '\" + hostname + \"' not valid\");", "author": "johnou", "createdAt": "2020-03-30T16:09:39Z", "path": "common/src/main/java/io/netty/util/DomainWildcardMappingBuilder.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+import static io.netty.util.internal.ObjectUtil.checkNotNull;\n+\n+/**\n+ * Builder that allows to build {@link Mapping}s that support\n+ * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> matching.\n+ * @param <V> the type of the value that we map to.\n+ */\n+public class DomainWildcardMappingBuilder<V> {\n+\n+    private final V defaultValue;\n+    private final Map<String, V> map;\n+\n+    /**\n+     * Constructor with default initial capacity of the map holding the mappings\n+     *\n+     * @param defaultValue the default value for {@link Mapping#map(Object)} )} to return\n+     *                     when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(V defaultValue) {\n+        this(4, defaultValue);\n+    }\n+\n+    /**\n+     * Constructor with initial capacity of the map holding the mappings\n+     *\n+     * @param initialCapacity initial capacity for the internal map\n+     * @param defaultValue    the default value for {@link Mapping#map(Object)} to return\n+     *                        when nothing matches the input\n+     */\n+    public DomainWildcardMappingBuilder(int initialCapacity, V defaultValue) {\n+        this.defaultValue = checkNotNull(defaultValue, \"defaultValue\");\n+        map = new LinkedHashMap<String, V>(initialCapacity);\n+    }\n+\n+    /**\n+     * Adds a mapping that maps the specified (optionally wildcard) host name to the specified output value.\n+     * {@code null} values are forbidden for both hostnames and values.\n+     * <p>\n+     * <a href=\"https://tools.ietf.org/search/rfc6125#section-6.4\">DNS wildcard</a> is supported as hostname. The\n+     * wildcard will only match one sub-domain deep and only when wildcard is used as the most-left label.\n+     *\n+     * For example:\n+     *\n+     * <p>\n+     *  *.netty.io will match xyz.netty.io but NOT abc.xyz.netty.io\n+     * </p>\n+     *\n+     * @param hostname the host name (optionally wildcard)\n+     * @param output   the output value that will be returned by {@link Mapping#map(Object)}\n+     *                 when the specified host name matches the specified input host name\n+     */\n+    public DomainWildcardMappingBuilder<V> add(String hostname, V output) {\n+        map.put(normalizeHostName(hostname),\n+                checkNotNull(output, \"output\"));\n+        return this;\n+    }\n+\n+    private String normalizeHostName(String hostname) {\n+        checkNotNull(hostname, \"hostname\");\n+        if (hostname.isEmpty() || hostname.charAt(0) == '.') {\n+            throw new IllegalArgumentException(\"Hostname '\" + hostname + \"'not valid\");", "originalCommit": "2b1830ef855fc7e0996830abdcf21b099bb6d6e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2dbfe7a2529e861d5611a4fc3936004256b89173", "url": "https://github.com/netty/netty/commit/2dbfe7a2529e861d5611a4fc3936004256b89173", "message": "Update common/src/main/java/io/netty/util/DomainWildcardMappingBuilder.java\n\nCo-Authored-By: Johno Crawford <johno.crawford@gmail.com>", "committedDate": "2020-03-30T16:12:40Z", "type": "commit"}]}