{"pr_number": 10549, "pr_title": "Use multiple IovArray for writev when using io_uring based transport", "pr_createdAt": "2020-09-08T09:02:05Z", "pr_url": "https://github.com/netty/netty/pull/10549", "timeline": [{"oid": "67d9e4c006002dd39388cd1a2871a340c2ae7e03", "url": "https://github.com/netty/netty/commit/67d9e4c006002dd39388cd1a2871a340c2ae7e03", "message": "Use one IovArray for writev when using io_uring based transport\n\nMotivation:\n\nHow we did manage the memory of writev was quite wasteful and could\nproduce a lot of memory overhead. We can just keep it simple by using\none IovArray. Once it is full we can just submit and clear it as at this\npoint the kernel did take over a copy and its safe to reuse\n\nModifications:\n\nUse one IovArray and submit once it is full.\n\nResult:\n\nLess memory overhead and less code duplication", "committedDate": "2020-09-08T08:59:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc2NTEwOA==", "url": "https://github.com/netty/netty/pull/10549#discussion_r484765108", "bodyText": "happem", "author": "chrisvest", "createdAt": "2020-09-08T09:03:42Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -304,23 +302,17 @@ protected void doWrite(ChannelOutboundBuffer in) {\n     }\n \n      private void doWriteMultiple(ChannelOutboundBuffer in) {\n-\n-         final IovecArrayPool iovecArray = ((IOUringEventLoop) eventLoop()).getIovecArrayPool();\n-\n-         iovecMemoryAddress = iovecArray.createNewIovecMemoryAddress();\n-         if (iovecMemoryAddress != -1) {\n-             try {\n-                 in.forEachFlushedMessage(iovecArray);\n-             } catch (Exception e) {\n-                 // This should never happem, anyway fallback to single write.\n-                 doWriteSingle((ByteBuf) in.current());\n-             }\n-             submissionQueue().addWritev(socket.intValue(), iovecMemoryAddress, iovecArray.count());\n+         final IovArray iovecArray = ((IOUringEventLoop) eventLoop()).iovArray();\n+         try {\n+             int offset = iovecArray.count();\n+             in.forEachFlushedMessage(iovecArray);\n+             submissionQueue().addWritev(socket.intValue(), iovecArray.memoryAddress(offset), iovecArray.count() - offset);\n              ioState |= WRITE_SCHEDULED;\n-         } else {\n-             // We were not be able to create a new iovec, fallback to single write.\n+         } catch (Exception e) {\n+             // This should never happem, anyway fallback to single write.", "originalCommit": "67d9e4c006002dd39388cd1a2871a340c2ae7e03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MDYxMw==", "url": "https://github.com/netty/netty/pull/10549#discussion_r484780613", "bodyText": "one drawback would be that we reduce submission batch size when a lot of channel writing in the same time especially with a bigger message size, one solution would be: to make the capacity configurable, default iovec array size is only 1024 as far as I know", "author": "1Jo1", "createdAt": "2020-09-08T09:29:11Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -268,7 +278,12 @@ protected void wakeup(boolean inEventLoop) {\n         }\n     }\n \n-    public IovecArrayPool getIovecArrayPool() {\n-        return iovecArrayPool;\n+    public IovArray iovArray() {\n+        // Check if its full and if so submit so we can reuse it.\n+        if (iovArray.isFull()) {", "originalCommit": "67d9e4c006002dd39388cd1a2871a340c2ae7e03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzMTI1Mw==", "url": "https://github.com/netty/netty/pull/10549#discussion_r484831253", "bodyText": "yep I am aware of this... thats why I added some \"we may want to adjust this later comment\"... That said let me run some benchmarks for now first", "author": "normanmaurer", "createdAt": "2020-09-08T10:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MDYxMw=="}], "type": "inlineReview"}, {"oid": "bf6078e1afc6fdb77e762c2eaab95768b9a3a4ef", "url": "https://github.com/netty/netty/commit/bf6078e1afc6fdb77e762c2eaab95768b9a3a4ef", "message": "typo", "committedDate": "2020-09-08T11:00:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkyNTc2OQ==", "url": "https://github.com/netty/netty/pull/10549#discussion_r484925769", "bodyText": "we could even make this more optimal by writing a custom IovArray implementation. But for now this seems to work well enough and allows us for code-reuse.", "author": "normanmaurer", "createdAt": "2020-09-08T13:36:09Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -46,18 +47,26 @@\n     //    other value T    when EL is waiting with wakeup scheduled at time T\n     private final AtomicLong nextWakeupNanos = new AtomicLong(AWAKE);\n     private final FileDescriptor eventfd;\n-    private final IovecArrayPool iovecArrayPool;\n+\n+    private final IovArray[] iovArrays;\n+    private int iovArrayIdx;\n \n     private long prevDeadlineNanos = NONE;\n     private boolean pendingWakeup;\n \n     IOUringEventLoop(final EventLoopGroup parent, final Executor executor, final boolean addTaskWakesUp) {\n         super(parent, executor, addTaskWakesUp);\n+        // Ensure that we load all native bits as otherwise it may fail when try to use native methods in IovArray\n+        IOUring.ensureAvailability();\n \n+        // Let's hard code this to 8 IovArrays to keep the memory overhead kind of small.\n+        iovArrays = new IovArray[8];", "originalCommit": "75ef1d74c4ad317778a731247ca68674f8976128", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAwNDI4MA==", "url": "https://github.com/netty/netty/pull/10549#discussion_r485004280", "bodyText": "I like that, 8 we should take it as default value when it's configurable", "author": "1Jo1", "createdAt": "2020-09-08T15:20:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkyNTc2OQ=="}], "type": "inlineReview"}, {"oid": "95639ae66a6ac87e66f77ccf19d5a439d25fb03e", "url": "https://github.com/netty/netty/commit/95639ae66a6ac87e66f77ccf19d5a439d25fb03e", "message": "More efficient writev", "committedDate": "2020-09-08T13:39:56Z", "type": "commit"}, {"oid": "95639ae66a6ac87e66f77ccf19d5a439d25fb03e", "url": "https://github.com/netty/netty/commit/95639ae66a6ac87e66f77ccf19d5a439d25fb03e", "message": "More efficient writev", "committedDate": "2020-09-08T13:39:56Z", "type": "forcePushed"}]}