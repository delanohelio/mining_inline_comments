{"pr_number": 10428, "pr_title": "Do not try to use Unsafe.staticFieldOffset() method under a native im\u2026", "pr_createdAt": "2020-07-26T15:04:12Z", "pr_url": "https://github.com/netty/netty/pull/10428", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0MDU5MQ==", "url": "https://github.com/netty/netty/pull/10428#discussion_r461340591", "bodyText": "@rpuch can we merge this directly to PlatformDependent0 ? Seems overkill to add this class just for exposing one method etc", "author": "normanmaurer", "createdAt": "2020-07-28T06:10:38Z", "path": "common/src/main/java/io/netty/util/internal/GraalDetector.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util.internal;\n+\n+abstract class GraalDetector {", "originalCommit": "c0014a1804517cb7be85003545b198360699cf58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4MDE3NA==", "url": "https://github.com/netty/netty/pull/10428#discussion_r461780174", "bodyText": "I've moved the code to PlatformDependent0 and removed GraalDetector class. Please let me know if it is ok now.", "author": "rpuch", "createdAt": "2020-07-28T18:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0MDU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0MDY2Mg==", "url": "https://github.com/netty/netty/pull/10428#discussion_r461340662", "bodyText": "Use SystemPropertyUtils.", "author": "normanmaurer", "createdAt": "2020-07-28T06:10:49Z", "path": "common/src/main/java/io/netty/util/internal/GraalDetector.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util.internal;\n+\n+abstract class GraalDetector {\n+\n+    // See https://github.com/oracle/graal/blob/master/sdk/src/org.graalvm.nativeimage/src/org/graalvm/nativeimage/ImageInfo.java\n+    private static final boolean imageCode = System.getProperty(\"org.graalvm.nativeimage.imagecode\") != null;", "originalCommit": "c0014a1804517cb7be85003545b198360699cf58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4MDI0Mg==", "url": "https://github.com/netty/netty/pull/10428#discussion_r461780242", "bodyText": "Done", "author": "rpuch", "createdAt": "2020-07-28T18:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0MDY2Mg=="}], "type": "inlineReview"}, {"oid": "b18122834e3688cda6edc64af694cf6b06ac6b0d", "url": "https://github.com/netty/netty/commit/b18122834e3688cda6edc64af694cf6b06ac6b0d", "message": "Do not try to use Unsafe.staticFieldOffset() method under a native image.\n\nGraalVM's native images built with native-image tool do not support Unsafe.staticFieldOffset() method (at least, currently). If an application using Netty (and causing initialization of io.netty.util.internal.PlatformDependent0 class) is built into a native image and run, this results in the following error thrown during initialization:\n\nException in thread \"main\" com.oracle.svm.core.jdk.UnsupportedFeatureError: Unsupported method of Unsafe\n\tat com.oracle.svm.core.util.VMError.unsupportedFeature(VMError.java:86)\n\tat jdk.internal.misc.Unsafe.staticFieldOffset(Unsafe.java:230)\n\tat sun.misc.Unsafe.staticFieldOffset(Unsafe.java:662)\n\tat io.netty.util.internal.PlatformDependent0$5.run(PlatformDependent0.java:294)\n\tat java.security.AccessController.doPrivileged(AccessController.java:83)\n\tat io.netty.util.internal.PlatformDependent0.<clinit>(PlatformDependent0.java:279)\n\nThis seems to be the reason of the behavior described in #10051.\n\nThe idea of this commit is to only invoke Unsafe.staticFieldOffset() is we are not in a native image; if we are, behave like if we could not find the field at all.\n\n'In native image' detection code is borrowed from Spring framework.\n\nThe resulting code works successfully in a native image (at least, on x86_64).", "committedDate": "2020-07-29T19:18:27Z", "type": "commit"}]}