{"pr_number": 10694, "pr_title": "Allow EventLoops to rethrow Error", "pr_createdAt": "2020-10-15T18:31:50Z", "pr_url": "https://github.com/netty/netty/pull/10694", "timeline": [{"oid": "c192761b5040cf292f66bb5dc0c273ec7008aed8", "url": "https://github.com/netty/netty/commit/c192761b5040cf292f66bb5dc0c273ec7008aed8", "message": "Allow EventLoops to rethrow ThreadDeath errors. This allows them to be killed by Thread.stop()", "committedDate": "2020-10-15T18:26:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2MDc1OA==", "url": "https://github.com/netty/netty/pull/10694#discussion_r505760758", "bodyText": "Please refactor to:\ntry {\n    ...\n} catch (ThreadDeath td) {\n    throw (ThreadDeath) td;\n} catch (Throwable t) {\n    handleLoopException(t);\n}\nSome for all other places.", "author": "normanmaurer", "createdAt": "2020-10-15T18:39:06Z", "path": "transport-native-epoll/src/main/java/io/netty/channel/epoll/EpollEventLoop.java", "diffHunk": "@@ -391,7 +391,11 @@ protected void run() {\n                     events.increase();\n                 }\n             } catch (Throwable t) {\n-                handleLoopException(t);\n+                if (t instanceof ThreadDeath) {", "originalCommit": "c192761b5040cf292f66bb5dc0c273ec7008aed8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc5OTY4Mg==", "url": "https://github.com/netty/netty/pull/10694#discussion_r505799682", "bodyText": "Sure, refactored.", "author": "greenjustin", "createdAt": "2020-10-15T19:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2MDc1OA=="}], "type": "inlineReview"}, {"oid": "e8c21a1886229297fdce64c0a49492ba02c2847c", "url": "https://github.com/netty/netty/commit/e8c21a1886229297fdce64c0a49492ba02c2847c", "message": "Refactoring ThreadDeath rethrowing slightly", "committedDate": "2020-10-15T18:46:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMjMyMQ==", "url": "https://github.com/netty/netty/pull/10694#discussion_r506222321", "bodyText": "Right below these catch clauses it says \"Always handle shutdown even if the loop processing threw an exception.\"\nShould that perhaps be moved into a finally clause? It's the same deal in all of the event loops modified in this PR.", "author": "chrisvest", "createdAt": "2020-10-16T09:35:53Z", "path": "transport-native-epoll/src/main/java/io/netty/channel/epoll/EpollEventLoop.java", "diffHunk": "@@ -390,6 +390,8 @@ protected void run() {\n                     //increase the size of the array as we needed the whole space for the events\n                     events.increase();\n                 }\n+            } catch (ThreadDeath td) {\n+                throw (ThreadDeath) td;", "originalCommit": "e8c21a1886229297fdce64c0a49492ba02c2847c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI0MjE1Mw==", "url": "https://github.com/netty/netty/pull/10694#discussion_r506242153", "bodyText": "good idea @chrisvest ... @greenjustin can you please adjust ?", "author": "normanmaurer", "createdAt": "2020-10-16T09:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMjMyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5MzM0NA==", "url": "https://github.com/netty/netty/pull/10694#discussion_r506493344", "bodyText": "Sure, how does this look?", "author": "greenjustin", "createdAt": "2020-10-16T14:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMjMyMQ=="}], "type": "inlineReview"}, {"oid": "5e2f6d600df14fadcc1bfb2df41efd699d9652b7", "url": "https://github.com/netty/netty/commit/5e2f6d600df14fadcc1bfb2df41efd699d9652b7", "message": "Move shutdown handling code for EventLoops into a finally block.", "committedDate": "2020-10-16T14:29:16Z", "type": "commit"}, {"oid": "10258ed3316133eb90f8d6574c2498ee82e8df0d", "url": "https://github.com/netty/netty/commit/10258ed3316133eb90f8d6574c2498ee82e8df0d", "message": "Formatting fixes to EventLoops", "committedDate": "2020-10-16T14:36:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjg2MzQ3NQ==", "url": "https://github.com/netty/netty/pull/10694#discussion_r506863475", "bodyText": "@greenjustin wouldn't you want to rethrow ThreadDeath here as well ? (same is true for all the other impls)", "author": "normanmaurer", "createdAt": "2020-10-17T08:03:51Z", "path": "transport-native-epoll/src/main/java/io/netty/channel/epoll/EpollEventLoop.java", "diffHunk": "@@ -390,19 +390,22 @@ protected void run() {\n                     //increase the size of the array as we needed the whole space for the events\n                     events.increase();\n                 }\n+            } catch (ThreadDeath td) {\n+                throw (ThreadDeath) td;\n             } catch (Throwable t) {\n                 handleLoopException(t);\n-            }\n-            // Always handle shutdown even if the loop processing threw an exception.\n-            try {\n-                if (isShuttingDown()) {\n-                    closeAll();\n-                    if (confirmShutdown()) {\n-                        break;\n+            } finally {\n+                // Always handle shutdown even if the loop processing threw an exception.\n+                try {\n+                    if (isShuttingDown()) {\n+                        closeAll();\n+                        if (confirmShutdown()) {\n+                            break;\n+                        }\n                     }\n+                } catch (Throwable t) {\n+                    handleLoopException(t);", "originalCommit": "10258ed3316133eb90f8d6574c2498ee82e8df0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b06d4a42eb45cfa8e84f783d88888765dc1a30bd", "url": "https://github.com/netty/netty/commit/b06d4a42eb45cfa8e84f783d88888765dc1a30bd", "message": "Rethrow all errors, not just ThreadDeath. Errors are meant to be unrecoverable, like OOM.", "committedDate": "2020-10-19T14:18:52Z", "type": "commit"}]}