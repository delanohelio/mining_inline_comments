{"pr_number": 10157, "pr_title": "Close the file when IOException occurs in AbstractMemoryHttpData.", "pr_createdAt": "2020-04-01T16:20:45Z", "pr_url": "https://github.com/netty/netty/pull/10157", "timeline": [{"oid": "f91b4f3697a188046c9a0e993b158fc1feb4d68b", "url": "https://github.com/netty/netty/commit/f91b4f3697a188046c9a0e993b158fc1feb4d68b", "message": "Close the file when IOException occurs in AbstractMemoryHttpData.", "committedDate": "2020-04-01T15:58:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzMjM5MA==", "url": "https://github.com/netty/netty/pull/10157#discussion_r402132390", "bodyText": "@seedeed do we need to release this buf ?", "author": "normanmaurer", "createdAt": "2020-04-02T08:18:03Z", "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/AbstractMemoryHttpDataTest.java", "diffHunk": "@@ -19,22 +19,46 @@\n import io.netty.buffer.ByteBufInputStream;\n import io.netty.buffer.ByteBufUtil;\n import io.netty.buffer.Unpooled;\n-import io.netty.buffer.UnpooledByteBufAllocator;\n+import io.netty.util.internal.ThreadLocalRandom;\n \n import org.junit.Test;\n \n import java.io.ByteArrayInputStream;\n-import java.io.IOException;\n+import java.io.File;\n+import java.io.FileOutputStream;\n import java.nio.charset.Charset;\n import java.security.SecureRandom;\n import java.util.Arrays;\n import java.util.Random;\n+import java.util.UUID;\n \n import static io.netty.util.CharsetUtil.*;\n import static org.junit.Assert.*;\n \n /** {@link AbstractMemoryHttpData} test cases. */\n public class AbstractMemoryHttpDataTest {\n+\n+    @Test\n+    public void testSetContentFromFile() throws Exception {\n+        TestHttpData test = new TestHttpData(\"test\", UTF_8, 0);\n+        File tmpFile = File.createTempFile(UUID.randomUUID().toString(), \".tmp\");\n+        tmpFile.deleteOnExit();\n+        FileOutputStream fos = new FileOutputStream(tmpFile);\n+        byte[] bytes = new byte[4096];\n+        ThreadLocalRandom.current().nextBytes(bytes);\n+        try {\n+            fos.write(bytes);\n+            fos.flush();\n+        } finally {\n+            fos.close();\n+        }\n+        test.setContent(tmpFile);\n+        ByteBuf buf = test.getByteBuf();", "originalCommit": "f91b4f3697a188046c9a0e993b158fc1feb4d68b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE0NzM5OQ==", "url": "https://github.com/netty/netty/pull/10157#discussion_r402147399", "bodyText": "@normanmaurer this ByteBuf is held by AbstractMemoryHttpData. We can manually call its delete method to release it.", "author": "seedeed", "createdAt": "2020-04-02T08:42:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzMjM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzMjgwOQ==", "url": "https://github.com/netty/netty/pull/10157#discussion_r402132809", "bodyText": "you should use PlatformDependent.threadLocalRandom()", "author": "normanmaurer", "createdAt": "2020-04-02T08:18:49Z", "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/AbstractMemoryHttpDataTest.java", "diffHunk": "@@ -19,22 +19,46 @@\n import io.netty.buffer.ByteBufInputStream;\n import io.netty.buffer.ByteBufUtil;\n import io.netty.buffer.Unpooled;\n-import io.netty.buffer.UnpooledByteBufAllocator;\n+import io.netty.util.internal.ThreadLocalRandom;\n \n import org.junit.Test;\n \n import java.io.ByteArrayInputStream;\n-import java.io.IOException;\n+import java.io.File;\n+import java.io.FileOutputStream;\n import java.nio.charset.Charset;\n import java.security.SecureRandom;\n import java.util.Arrays;\n import java.util.Random;\n+import java.util.UUID;\n \n import static io.netty.util.CharsetUtil.*;\n import static org.junit.Assert.*;\n \n /** {@link AbstractMemoryHttpData} test cases. */\n public class AbstractMemoryHttpDataTest {\n+\n+    @Test\n+    public void testSetContentFromFile() throws Exception {\n+        TestHttpData test = new TestHttpData(\"test\", UTF_8, 0);\n+        File tmpFile = File.createTempFile(UUID.randomUUID().toString(), \".tmp\");\n+        tmpFile.deleteOnExit();\n+        FileOutputStream fos = new FileOutputStream(tmpFile);\n+        byte[] bytes = new byte[4096];\n+        ThreadLocalRandom.current().nextBytes(bytes);", "originalCommit": "f91b4f3697a188046c9a0e993b158fc1feb4d68b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4ae637f895d86c0e2784f9fd540a4ec423a36372", "url": "https://github.com/netty/netty/commit/4ae637f895d86c0e2784f9fd540a4ec423a36372", "message": "fix several test case problems.", "committedDate": "2020-04-02T08:47:35Z", "type": "commit"}]}