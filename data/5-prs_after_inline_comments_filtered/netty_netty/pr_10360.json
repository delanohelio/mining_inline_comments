{"pr_number": 10360, "pr_title": "Fix memory leak in AbstractDiskHttpData when CompositeByteBuf is used", "pr_createdAt": "2020-06-22T07:33:10Z", "pr_url": "https://github.com/netty/netty/pull/10360", "timeline": [{"oid": "a97aaeb9548039924c55ea51893f0d11704fcf60", "url": "https://github.com/netty/netty/commit/a97aaeb9548039924c55ea51893f0d11704fcf60", "message": "Fix memory leak in AbstractDiskHttpData when CompositeByteBuf is used\n\nMotivation:\n\nAbstractDiskHttpData may cause a memory leak when a CompositeByteBuf is used. This happened because we may call copy() but actually never release the newly created ByteBuf.\n\nModifications:\n\n- Remove copy() call and just use ByteBuf.getBytes(...) which will internally handle the writing to the FileChannel without any extra copies that need to be released later on.\n- Add unit test\n\nResult:\n\nFixes https://github.com/netty/netty/issues/10354", "committedDate": "2020-06-22T07:29:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4MTU2Nw==", "url": "https://github.com/netty/netty/pull/10360#discussion_r459381567", "bodyText": "@normanmaurer The javadocs for ByteBuf#getBytes state that the fileChannel position is not being modified. Does this not imply that all calls to this method start writing from the beginning of the file (and thus overwrite each other)?\nwritten is now also effectively unused; shouldn't this line be written = buffer.getBytes(...);?.\nsee #10425.", "author": "zentol", "createdAt": "2020-07-23T11:27:28Z", "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -165,9 +164,7 @@ public void addContent(ByteBuf buffer, boolean last)\n                     RandomAccessFile accessFile = new RandomAccessFile(file, \"rw\");\n                     fileChannel = accessFile.getChannel();\n                 }\n-                while (written < localsize) {\n-                    written += fileChannel.write(byteBuffer);\n-                }\n+                buffer.getBytes(buffer.readerIndex(), fileChannel, fileChannel.position(), localsize);", "originalCommit": "a97aaeb9548039924c55ea51893f0d11704fcf60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}