{"pr_number": 10866, "pr_title": "Don't catch Throwable in InternalLoggerFactory", "pr_createdAt": "2020-12-15T13:33:56Z", "pr_url": "https://github.com/netty/netty/pull/10866", "timeline": [{"oid": "929de2c76f054db9fde31a9bcf1edf5df8db3cc4", "url": "https://github.com/netty/netty/commit/929de2c76f054db9fde31a9bcf1edf5df8db3cc4", "message": "Don't catch Throwable in InternalLoggerFactory\n\nMotivation:\n\nWe shouldnt catch Throwable in InternalLoggerFactory as this may hide OOME etc.\n\nModifications:\n\nOnly catch LinkageError and Exception\n\nResult:\n\nFixes https://github.com/netty/netty/issues/10857", "committedDate": "2020-12-15T13:32:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0NjA2NQ==", "url": "https://github.com/netty/netty/pull/10866#discussion_r543346065", "bodyText": "Missing line break", "author": "chrisvest", "createdAt": "2020-12-15T13:36:37Z", "path": "common/src/main/java/io/netty/util/internal/logging/InternalLoggerFactory.java", "diffHunk": "@@ -39,24 +39,62 @@\n \n     @SuppressWarnings(\"UnusedCatchParameter\")\n     private static InternalLoggerFactory newDefaultFactory(String name) {\n-        InternalLoggerFactory f;\n+        InternalLoggerFactory f = useSlf4JLoggerFactory(name);\n+        if (f != null) {\n+            return f;\n+        }\n+\n+        f = useLog4J2LoggerFactory(name);\n+        if (f != null) {\n+            return f;\n+        }\n+\n+        f = useLog4JLoggerFactory(name);\n+        if (f != null) {\n+            return f;\n+        }\n+\n+        return useJdkLoggerFactory(name);\n+    }\n+\n+    private static InternalLoggerFactory useSlf4JLoggerFactory(String name) {\n         try {\n-            f = new Slf4JLoggerFactory(true);\n+            InternalLoggerFactory f = new Slf4JLoggerFactory(true);\n             f.newInstance(name).debug(\"Using SLF4J as the default logging framework\");\n-        } catch (Throwable ignore1) {\n-            try {\n-                f = Log4J2LoggerFactory.INSTANCE;\n-                f.newInstance(name).debug(\"Using Log4J2 as the default logging framework\");\n-            } catch (Throwable ignore2) {\n-                try {\n-                    f = Log4JLoggerFactory.INSTANCE;\n-                    f.newInstance(name).debug(\"Using Log4J as the default logging framework\");\n-                } catch (Throwable ignore3) {\n-                    f = JdkLoggerFactory.INSTANCE;\n-                    f.newInstance(name).debug(\"Using java.util.logging as the default logging framework\");\n-                }\n-            }\n+            return f;\n+        } catch (LinkageError ignore) {\n+            return null;\n+        } catch (Exception ignore) {\n+            return null;\n         }\n+    }\n+    private static InternalLoggerFactory useLog4J2LoggerFactory(String name) {", "originalCommit": "929de2c76f054db9fde31a9bcf1edf5df8db3cc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1Mzk4MQ==", "url": "https://github.com/netty/netty/pull/10866#discussion_r543353981", "bodyText": "This can catch the more specific (ReflectiveOperationException | SecurityException ignore) unless for some reason Slf4JLoggerFactory is throwing java.lang.Exception.", "author": "elharo", "createdAt": "2020-12-15T13:47:20Z", "path": "common/src/main/java/io/netty/util/internal/logging/InternalLoggerFactory.java", "diffHunk": "@@ -39,24 +39,62 @@\n \n     @SuppressWarnings(\"UnusedCatchParameter\")\n     private static InternalLoggerFactory newDefaultFactory(String name) {\n-        InternalLoggerFactory f;\n+        InternalLoggerFactory f = useSlf4JLoggerFactory(name);\n+        if (f != null) {\n+            return f;\n+        }\n+\n+        f = useLog4J2LoggerFactory(name);\n+        if (f != null) {\n+            return f;\n+        }\n+\n+        f = useLog4JLoggerFactory(name);\n+        if (f != null) {\n+            return f;\n+        }\n+\n+        return useJdkLoggerFactory(name);\n+    }\n+\n+    private static InternalLoggerFactory useSlf4JLoggerFactory(String name) {\n         try {\n-            f = new Slf4JLoggerFactory(true);\n+            InternalLoggerFactory f = new Slf4JLoggerFactory(true);\n             f.newInstance(name).debug(\"Using SLF4J as the default logging framework\");\n-        } catch (Throwable ignore1) {\n-            try {\n-                f = Log4J2LoggerFactory.INSTANCE;\n-                f.newInstance(name).debug(\"Using Log4J2 as the default logging framework\");\n-            } catch (Throwable ignore2) {\n-                try {\n-                    f = Log4JLoggerFactory.INSTANCE;\n-                    f.newInstance(name).debug(\"Using Log4J as the default logging framework\");\n-                } catch (Throwable ignore3) {\n-                    f = JdkLoggerFactory.INSTANCE;\n-                    f.newInstance(name).debug(\"Using java.util.logging as the default logging framework\");\n-                }\n-            }\n+            return f;\n+        } catch (LinkageError ignore) {\n+            return null;\n+        } catch (Exception ignore) {", "originalCommit": "929de2c76f054db9fde31a9bcf1edf5df8db3cc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1NTY4NQ==", "url": "https://github.com/netty/netty/pull/10866#discussion_r543355685", "bodyText": "@elharo I did decide to use Exception as ReflectiveOperationeException not exists in JDK6 :/", "author": "normanmaurer", "createdAt": "2020-12-15T13:49:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1Mzk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM2NTAwNA==", "url": "https://github.com/netty/netty/pull/10866#discussion_r543365004", "bodyText": "Netty still supports JDK 6? Impressive. In that case, please add a comment to that effect here for anyone who reads this code in the future. And then LGTM.", "author": "elharo", "createdAt": "2020-12-15T14:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1Mzk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM2OTA0OQ==", "url": "https://github.com/netty/netty/pull/10866#discussion_r543369049", "bodyText": "yes ... unfortunally we do :/", "author": "normanmaurer", "createdAt": "2020-12-15T14:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1Mzk4MQ=="}], "type": "inlineReview"}, {"oid": "1b23ca67c013f265b5030988dcc8eaf06e04c7e2", "url": "https://github.com/netty/netty/commit/1b23ca67c013f265b5030988dcc8eaf06e04c7e2", "message": "add missing line", "committedDate": "2020-12-15T13:52:44Z", "type": "commit"}, {"oid": "099abb0584570bf94cc2e8c9bd30dc492728db99", "url": "https://github.com/netty/netty/commit/099abb0584570bf94cc2e8c9bd30dc492728db99", "message": "add comment", "committedDate": "2020-12-15T14:46:18Z", "type": "commit"}]}