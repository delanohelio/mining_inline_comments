{"pr_number": 9974, "pr_title": "SslHandler.wrap(...) must ensure it not loose the original exception \u2026", "pr_createdAt": "2020-01-28T13:40:43Z", "pr_url": "https://github.com/netty/netty/pull/9974", "timeline": [{"oid": "ff6a84befccd22f308668f33792d107836d109ee", "url": "https://github.com/netty/netty/commit/ff6a84befccd22f308668f33792d107836d109ee", "message": "SslHandler.wrap(...) must ensure it not loose the original exception when finishWrap(...) fails\n\nMotivation:\n\nWhen SslHandler.finishWrap throws an exception, ensure that the promise and buf is not reused to avoid throwing IllegalArgumentException or IllegalReferenceCountException which causes the original exception to be lost.\n\nModification:\n\nThe change ensures that the values for the promise and bytebuf are nulled before calling finishWrap so that it will not be called again with the same arguments.\n\nResult:\n\nFixes #9971 .\n\nCo-authored-by: Norman Maurer <norman_maurer@apple.com>", "committedDate": "2020-01-28T13:43:14Z", "type": "commit"}, {"oid": "ff6a84befccd22f308668f33792d107836d109ee", "url": "https://github.com/netty/netty/commit/ff6a84befccd22f308668f33792d107836d109ee", "message": "SslHandler.wrap(...) must ensure it not loose the original exception when finishWrap(...) fails\n\nMotivation:\n\nWhen SslHandler.finishWrap throws an exception, ensure that the promise and buf is not reused to avoid throwing IllegalArgumentException or IllegalReferenceCountException which causes the original exception to be lost.\n\nModification:\n\nThe change ensures that the values for the promise and bytebuf are nulled before calling finishWrap so that it will not be called again with the same arguments.\n\nResult:\n\nFixes #9971 .\n\nCo-authored-by: Norman Maurer <norman_maurer@apple.com>", "committedDate": "2020-01-28T13:43:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTU3NQ==", "url": "https://github.com/netty/netty/pull/9974#discussion_r371959575", "bodyText": "How about out.clear() here too?", "author": "njhill", "createdAt": "2020-01-28T17:49:52Z", "path": "handler/src/main/java/io/netty/handler/ssl/SslHandler.java", "diffHunk": "@@ -858,11 +858,25 @@ private void wrap(ChannelHandlerContext ctx, boolean inUnwrap) throws SSLExcepti\n                         case NOT_HANDSHAKING:\n                             setHandshakeSuccessIfStillHandshaking();\n                             // deliberate fall-through\n-                        case NEED_WRAP:\n-                            finishWrap(ctx, out, promise, inUnwrap, false);\n+                        case NEED_WRAP: {\n+                            ChannelPromise p = promise;\n+\n+                            // Null out the promise so it is not reused in the finally block in the cause of\n+                            // finishWrap(...) throwing.\n                             promise = null;\n-                            out = null;\n+                            final ByteBuf b;\n+\n+                            if (out.isReadable()) {\n+                                // There is something in the out buffer. Ensure we null it out so it is not re-used.\n+                                b = out;\n+                                out = null;\n+                            } else {\n+                                // If out is not readable we can re-use it and so save an extra allocation\n+                                b = null;", "originalCommit": "ff6a84befccd22f308668f33792d107836d109ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMDAzNA==", "url": "https://github.com/netty/netty/pull/9974#discussion_r372230034", "bodyText": "this should not be needed.", "author": "normanmaurer", "createdAt": "2020-01-29T07:46:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTU3NQ=="}], "type": "inlineReview"}]}