{"pr_number": 10274, "pr_title": "Fix #10261 stomp can be chunked, so implement StompWebSocketFrameEncoder", "pr_createdAt": "2020-05-12T09:52:29Z", "pr_url": "https://github.com/netty/netty/pull/10274", "timeline": [{"oid": "21410f6172be9e2c063d497a03ebb8d31c201205", "url": "https://github.com/netty/netty/commit/21410f6172be9e2c063d497a03ebb8d31c201205", "message": "Fix #10261 stomp can be chunked, so implement StompWebSocketFrameEncoder for integration", "committedDate": "2020-05-12T09:32:30Z", "type": "commit"}, {"oid": "389726f70d4df5833e2d9587758eedb1407e1207", "url": "https://github.com/netty/netty/commit/389726f70d4df5833e2d9587758eedb1407e1207", "message": "Add copyright header", "committedDate": "2020-05-12T09:38:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMDk4Nw==", "url": "https://github.com/netty/netty/pull/10274#discussion_r423610987", "bodyText": "@amizurov unfortunately this is a a breaking change as it changes the method signature of some methods", "author": "normanmaurer", "createdAt": "2020-05-12T09:55:52Z", "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketProtocolCodec.java", "diffHunk": "@@ -15,33 +15,34 @@\n  */\n package io.netty.example.stomp.websocket;\n \n-import io.netty.buffer.ByteBuf;\n import io.netty.channel.ChannelHandler.Sharable;\n import io.netty.channel.ChannelHandlerContext;\n import io.netty.handler.codec.MessageToMessageCodec;\n import io.netty.handler.codec.http.websocketx.TextWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.WebSocketFrame;\n+import io.netty.handler.codec.http.websocketx.WebSocketFrameAggregator;\n import io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;\n import io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler.HandshakeComplete;\n+import io.netty.handler.codec.stomp.StompSubframe;\n import io.netty.handler.codec.stomp.StompSubframeAggregator;\n import io.netty.handler.codec.stomp.StompSubframeDecoder;\n-import io.netty.handler.codec.stomp.StompSubframeEncoder;\n \n import java.util.List;\n \n @Sharable\n-public class StompWebSocketProtocolCodec extends MessageToMessageCodec<WebSocketFrame, ByteBuf> {\n+public class StompWebSocketProtocolCodec extends MessageToMessageCodec<WebSocketFrame, StompSubframe> {", "originalCommit": "389726f70d4df5833e2d9587758eedb1407e1207", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMjY1NA==", "url": "https://github.com/netty/netty/pull/10274#discussion_r423612654", "bodyText": "Yes but this is only example, maybe you can advice another way ?", "author": "amizurov", "createdAt": "2020-05-12T09:58:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMDk4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY1NTM0MA==", "url": "https://github.com/netty/netty/pull/10274#discussion_r423655340", "bodyText": "ah sorry missed that... Changing an example is of course fine.", "author": "normanmaurer", "createdAt": "2020-05-12T11:18:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMDk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY1NjM5Mg==", "url": "https://github.com/netty/netty/pull/10274#discussion_r423656392", "bodyText": "hmm... is this really correct for the case where msg isn't an instance of StompFrame  ? Seems like you may loose items here then.", "author": "normanmaurer", "createdAt": "2020-05-12T11:20:39Z", "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketFrameEncoder.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.example.stomp.websocket;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.CompositeByteBuf;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.handler.codec.http.websocketx.ContinuationWebSocketFrame;\n+import io.netty.handler.codec.http.websocketx.TextWebSocketFrame;\n+import io.netty.handler.codec.http.websocketx.WebSocketFrame;\n+import io.netty.handler.codec.stomp.LastStompContentSubframe;\n+import io.netty.handler.codec.stomp.StompFrame;\n+import io.netty.handler.codec.stomp.StompHeadersSubframe;\n+import io.netty.handler.codec.stomp.StompSubframe;\n+import io.netty.handler.codec.stomp.StompSubframeEncoder;\n+\n+import java.util.List;\n+\n+public class StompWebSocketFrameEncoder extends StompSubframeEncoder {\n+\n+    @Override\n+    public void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) throws Exception {\n+        super.encode(ctx, msg, out);\n+\n+        if (out.isEmpty()) {\n+            return;\n+        }\n+\n+        final WebSocketFrame webSocketFrame;\n+        if (msg instanceof StompFrame) {\n+            if (out.size() == 1) {\n+                webSocketFrame = new TextWebSocketFrame(getFirst(out));\n+            } else {\n+                CompositeByteBuf content = ctx.alloc().compositeBuffer(out.size());\n+                for (Object byteBuf : out) {\n+                    content.addComponent(true, (ByteBuf) byteBuf);\n+                }\n+                webSocketFrame = new TextWebSocketFrame(content);\n+            }\n+        } else if (msg instanceof StompHeadersSubframe) {\n+            webSocketFrame = new TextWebSocketFrame(false, 0, getFirst(out));\n+        } else if (msg instanceof LastStompContentSubframe) {\n+            webSocketFrame = new ContinuationWebSocketFrame(true, 0, getFirst(out));\n+        } else {\n+            webSocketFrame = new ContinuationWebSocketFrame(false, 0, getFirst(out));\n+        }\n+\n+        out.clear();", "originalCommit": "389726f70d4df5833e2d9587758eedb1407e1207", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY1OTQ0MQ==", "url": "https://github.com/netty/netty/pull/10274#discussion_r423659441", "bodyText": "We use this encoder inside StompWebSocketProtocolCodec so we accept only StompSubframe and don't put it to pipeline, just delegate.", "author": "amizurov", "createdAt": "2020-05-12T11:26:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY1NjM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM4MDE2Nw==", "url": "https://github.com/netty/netty/pull/10274#discussion_r424380167", "bodyText": "still this seems very error-prone. At least we should add an assert imho", "author": "normanmaurer", "createdAt": "2020-05-13T11:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY1NjM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM5NjI3OQ==", "url": "https://github.com/netty/netty/pull/10274#discussion_r424396279", "bodyText": "Sorry could you please explain what kind of assertion you mean ?", "author": "amizurov", "createdAt": "2020-05-13T12:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY1NjM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkxNDA3NA==", "url": "https://github.com/netty/netty/pull/10274#discussion_r433914074", "bodyText": "never mind", "author": "normanmaurer", "createdAt": "2020-06-02T14:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY1NjM5Mg=="}], "type": "inlineReview"}]}