{"pr_number": 9970, "pr_title": "Ensure the DefaultChannelHandlerContext is unlinked once removed", "pr_createdAt": "2020-01-27T18:03:59Z", "pr_url": "https://github.com/netty/netty/pull/9970", "timeline": [{"oid": "d60bfe8d8bfd308f3df96b9e460be5c52f473473", "url": "https://github.com/netty/netty/commit/d60bfe8d8bfd308f3df96b9e460be5c52f473473", "message": "Ensure the DefaultChannelHandlerContext is unlinked once removed\n\nMotivation:\n\nAt the moment the next / prev references are not set to \"null\" in the DefaultChannelHandlerContext once the ChannelHandler is removed. This is bad as it basically let users still use the ChannelHandlerContext of a ChannelHandler after it is removed and may produce very suprising behaviour.\n\nModifications:\n\n- Fail if someone tries to use the ChannelHandlerContext once the ChannelHandler was removed (for outbound operations fail the promise, for inbound fire the error through the ChannelPipeline)\n- Fix some handlers to ensure we not use the ChannelHandlerContext after the handler was removed\n- Adjust DefaultChannelPipeline / DefaultChannelHandlerContext to fixes races with removal / replacement of handlers\n\nResult:\n\nCleanup behaviour and make it more predictible for pipeline modifications", "committedDate": "2020-01-30T12:51:52Z", "type": "forcePushed"}, {"oid": "8bd0eb834f2e67a62cec644532755eced290ac05", "url": "https://github.com/netty/netty/commit/8bd0eb834f2e67a62cec644532755eced290ac05", "message": "Ensure the DefaultChannelHandlerContext is unlinked once removed\n\nMotivation:\n\nAt the moment the next / prev references are not set to \"null\" in the DefaultChannelHandlerContext once the ChannelHandler is removed. This is bad as it basically let users still use the ChannelHandlerContext of a ChannelHandler after it is removed and may produce very suprising behaviour.\n\nModifications:\n\n- Fail if someone tries to use the ChannelHandlerContext once the ChannelHandler was removed (for outbound operations fail the promise, for inbound fire the error through the ChannelPipeline)\n- Fix some handlers to ensure we not use the ChannelHandlerContext after the handler was removed\n- Adjust DefaultChannelPipeline / DefaultChannelHandlerContext to fixes races with removal / replacement of handlers\n\nResult:\n\nCleanup behaviour and make it more predictible for pipeline modifications", "committedDate": "2020-02-03T09:27:45Z", "type": "forcePushed"}, {"oid": "b0a7b563a82ae7a475dd3e4e941ebb183928b057", "url": "https://github.com/netty/netty/commit/b0a7b563a82ae7a475dd3e4e941ebb183928b057", "message": "Ensure the DefaultChannelHandlerContext is unlinked once removed\n\nMotivation:\n\nAt the moment the next / prev references are not set to \"null\" in the DefaultChannelHandlerContext once the ChannelHandler is removed. This is bad as it basically let users still use the ChannelHandlerContext of a ChannelHandler after it is removed and may produce very suprising behaviour.\n\nModifications:\n\n- Fail if someone tries to use the ChannelHandlerContext once the ChannelHandler was removed (for outbound operations fail the promise, for inbound fire the error through the ChannelPipeline)\n- Fix some handlers to ensure we not use the ChannelHandlerContext after the handler was removed\n- Adjust DefaultChannelPipeline / DefaultChannelHandlerContext to fixes races with removal / replacement of handlers\n\nResult:\n\nCleanup behaviour and make it more predictible for pipeline modifications", "committedDate": "2020-02-03T09:43:24Z", "type": "forcePushed"}, {"oid": "58cd7c304a88ee1552e329fcb3b3bbcd71b3065c", "url": "https://github.com/netty/netty/commit/58cd7c304a88ee1552e329fcb3b3bbcd71b3065c", "message": "Ensure the DefaultChannelHandlerContext is unlinked once removed\n\nMotivation:\n\nAt the moment the next / prev references are not set to \"null\" in the DefaultChannelHandlerContext once the ChannelHandler is removed. This is bad as it basically let users still use the ChannelHandlerContext of a ChannelHandler after it is removed and may produce very suprising behaviour.\n\nModifications:\n\n- Fail if someone tries to use the ChannelHandlerContext once the ChannelHandler was removed (for outbound operations fail the promise, for inbound fire the error through the ChannelPipeline)\n- Fix some handlers to ensure we not use the ChannelHandlerContext after the handler was removed\n- Adjust DefaultChannelPipeline / DefaultChannelHandlerContext to fixes races with removal / replacement of handlers\n\nResult:\n\nCleanup behaviour and make it more predictible for pipeline modifications", "committedDate": "2020-02-03T11:13:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE4NjQ1OA==", "url": "https://github.com/netty/netty/pull/9970#discussion_r374186458", "bodyText": "I presume this is the result of the close call unlinking so throwing the exception doesn't do what you think it would at that point. I'd guess this is a relatively common pattern.", "author": "bryce-anderson", "createdAt": "2020-02-03T15:59:22Z", "path": "codec-http/src/main/java/io/netty/handler/codec/http/HttpObjectAggregator.java", "diffHunk": "@@ -266,13 +266,26 @@ protected void handleOversizedMessage(final ChannelHandlerContext ctx, HttpMessa\n                 });\n             }\n         } else if (oversized instanceof HttpResponse) {\n-            ctx.close();\n-            throw new TooLongFrameException(\"Response entity too large: \" + oversized);", "originalCommit": "58cd7c304a88ee1552e329fcb3b3bbcd71b3065c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIyNDE3Ng==", "url": "https://github.com/netty/netty/pull/9970#discussion_r374224176", "bodyText": "yep thats the result... lucky enough it is kind of easy to fix and understand why it happens.", "author": "normanmaurer", "createdAt": "2020-02-03T17:04:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE4NjQ1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE5NTM4NA==", "url": "https://github.com/netty/netty/pull/9970#discussion_r374195384", "bodyText": "This might deserve a different name: ChannelHandler has a method handlerRemoved which make it sound like this method fires a handler removed event, not an exception.", "author": "bryce-anderson", "createdAt": "2020-02-03T16:14:30Z", "path": "transport/src/main/java/io/netty/channel/DefaultChannelHandlerContext.java", "diffHunk": "@@ -76,6 +81,22 @@\n         this.handler = handler;\n     }\n \n+    private static void failRemoved(DefaultChannelHandlerContext ctx, ChannelPromise promise) {\n+        promise.setFailure(newRemovedException(ctx, null));\n+    }\n+\n+    private void fireHandlerRemoved() {\n+        fireHandlerRemoved(null);\n+    }", "originalCommit": "58cd7c304a88ee1552e329fcb3b3bbcd71b3065c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIyNDI1Ng==", "url": "https://github.com/netty/netty/pull/9970#discussion_r374224256", "bodyText": "good point.", "author": "normanmaurer", "createdAt": "2020-02-03T17:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE5NTM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkwNTQ4OA==", "url": "https://github.com/netty/netty/pull/9970#discussion_r375905488", "bodyText": "Are you still interested in changing the name?", "author": "bryce-anderson", "createdAt": "2020-02-06T15:33:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE5NTM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3NTQ1Nw==", "url": "https://github.com/netty/netty/pull/9970#discussion_r376275457", "bodyText": "yep...", "author": "normanmaurer", "createdAt": "2020-02-07T08:51:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE5NTM4NA=="}], "type": "inlineReview"}, {"oid": "211a3be1cfe558a3f0aa1b408cc19d355927c5cb", "url": "https://github.com/netty/netty/commit/211a3be1cfe558a3f0aa1b408cc19d355927c5cb", "message": "Ensure the DefaultChannelHandlerContext is unlinked once removed\n\nMotivation:\n\nAt the moment the next / prev references are not set to \"null\" in the DefaultChannelHandlerContext once the ChannelHandler is removed. This is bad as it basically let users still use the ChannelHandlerContext of a ChannelHandler after it is removed and may produce very suprising behaviour.\n\nModifications:\n\n- Fail if someone tries to use the ChannelHandlerContext once the ChannelHandler was removed (for outbound operations fail the promise, for inbound fire the error through the ChannelPipeline)\n- Fix some handlers to ensure we not use the ChannelHandlerContext after the handler was removed\n- Adjust DefaultChannelPipeline / DefaultChannelHandlerContext to fixes races with removal / replacement of handlers\n\nResult:\n\nCleanup behaviour and make it more predictible for pipeline modifications", "committedDate": "2020-02-06T13:29:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk3OTc3OQ==", "url": "https://github.com/netty/netty/pull/9970#discussion_r375979779", "bodyText": "I'd feel better with this if this method was still protected. Why was it made public in Netty 5?", "author": "ejona86", "createdAt": "2020-02-06T17:34:48Z", "path": "common/src/main/java/io/netty/util/concurrent/DefaultPromise.java", "diffHunk": "@@ -440,7 +440,7 @@ protected StringBuilder toStringBuilder() {\n      * @return The executor used to notify listeners when this promise is complete.\n      */\n     @Override\n-    public final EventExecutor executor() {\n+    public EventExecutor executor() {", "originalCommit": "211a3be1cfe558a3f0aa1b408cc19d355927c5cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3NjY4MQ==", "url": "https://github.com/netty/netty/pull/9970#discussion_r376276681", "bodyText": "@ejona86 I will need to have a look. That said this has nothing todo with this PR and so I would like to handle this as a followup.", "author": "normanmaurer", "createdAt": "2020-02-07T08:54:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk3OTc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0ODkzMw==", "url": "https://github.com/netty/netty/pull/9970#discussion_r378448933", "bodyText": "It isn't unrelated because the semantics are changing. I'd totally believe some code would (properly) be assuming this return value never changes. Because it is public the \"blast radius\" is harder to determine, not just classes in the Promise hierarchy. We sort of need to audit all callers to make sure they are safe with this change.", "author": "ejona86", "createdAt": "2020-02-12T18:58:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk3OTc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODcyNzAzNA==", "url": "https://github.com/netty/netty/pull/9970#discussion_r378727034", "bodyText": "fixed this...", "author": "normanmaurer", "createdAt": "2020-02-13T09:01:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk3OTc3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MzQzNQ==", "url": "https://github.com/netty/netty/pull/9970#discussion_r375983435", "bodyText": "Ewww... This nastiness was mostly pre-existing, but this does worry me. I'm not fully confident DefaultPromise would safely handle this changing, although it does seem like it is mostly fine. It doesn't look like checkDeadlock() uses this method, so that would be broken at least.\nI don't really have any suggestions how to improve this though.", "author": "ejona86", "createdAt": "2020-02-06T17:41:49Z", "path": "handler/src/main/java/io/netty/handler/ssl/SslHandler.java", "diffHunk": "@@ -2207,5 +2221,13 @@ protected void checkDeadLock() {\n             }\n             checkDeadLock(ctx.executor());\n         }\n+\n+        @Override\n+        public EventExecutor executor() {", "originalCommit": "211a3be1cfe558a3f0aa1b408cc19d355927c5cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3NTY5NQ==", "url": "https://github.com/netty/netty/pull/9970#discussion_r376275695", "bodyText": "@ejona86 yeah this is pre-existing. I would just \"suck it up\" for now and if we can improve it we can do it later on.", "author": "normanmaurer", "createdAt": "2020-02-07T08:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MzQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NzE3Ng==", "url": "https://github.com/netty/netty/pull/9970#discussion_r378447176", "bodyText": "This is making things worse. As I mentioned, this change breaks checkDeadlock().", "author": "ejona86", "createdAt": "2020-02-12T18:55:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MzQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0OTQxOQ==", "url": "https://github.com/netty/netty/pull/9970#discussion_r378449419", "bodyText": "(I'd be fine if you just fix checkDeadlock() and verify the rest of DefaultPromise is safe if the executor changes. That can be quite a subtle audit though.)", "author": "ejona86", "createdAt": "2020-02-12T18:59:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MzQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODcyNjg5Nw==", "url": "https://github.com/netty/netty/pull/9970#discussion_r378726897", "bodyText": "I reverted this change.", "author": "normanmaurer", "createdAt": "2020-02-13T09:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MzQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4NDQ4OQ==", "url": "https://github.com/netty/netty/pull/9970#discussion_r375984489", "bodyText": "It seems like replace() has become useless. Maybe it should be removed in Netty 5 as well.", "author": "ejona86", "createdAt": "2020-02-06T17:43:48Z", "path": "testsuite-http2/src/main/java/io/netty/testsuite/http2/Http2ServerInitializer.java", "diffHunk": "@@ -85,8 +85,9 @@ protected void messageReceived(ChannelHandlerContext ctx, HttpMessage msg) throw\n                 ChannelPipeline pipeline = ctx.pipeline();\n                 ChannelHandlerContext thisCtx = pipeline.context(this);\n                 pipeline.addAfter(thisCtx.name(), null, new HelloWorldHttp1Handler(\"Direct. No Upgrade Attempted.\"));\n-                pipeline.replace(this, null, new HttpObjectAggregator(maxHttpContentLength));", "originalCommit": "211a3be1cfe558a3f0aa1b408cc19d355927c5cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3NTkwMA==", "url": "https://github.com/netty/netty/pull/9970#discussion_r376275900", "bodyText": "@ejona86 it is not really useless as long as the context is not used after replace is called.", "author": "normanmaurer", "createdAt": "2020-02-07T08:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4NDQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NjYzNA==", "url": "https://github.com/netty/netty/pull/9970#discussion_r378446634", "bodyText": "We can look through code later and see how often replace can be used, but I almost always see it with a read, write, or event following.", "author": "ejona86", "createdAt": "2020-02-12T18:54:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4NDQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4OTQ1Mw==", "url": "https://github.com/netty/netty/pull/9970#discussion_r375989453", "bodyText": "This doesn't seem right. Shouldn't the channel+pipeline remain in-place? I thought we were still going to allow deregistering and re-registering on the same event loop.", "author": "ejona86", "createdAt": "2020-02-06T17:53:28Z", "path": "transport/src/main/java/io/netty/channel/AbstractChannel.java", "diffHunk": "@@ -775,12 +776,25 @@ private void deregister(final ChannelPromise promise, final boolean fireChannelI\n                         pipeline.fireChannelInactive();\n                     }\n                     // Some transports like local and AIO does not allow the deregistration of\n-                    // an open channel.  Their doDeregister() calls close(). Consequently,\n+                    // an open channel. Their doDeregister() calls close(). Consequently,\n                     // close() calls deregister() again - no need to fire channelUnregistered, so check\n                     // if it was registered.\n                     if (registered) {\n                         registered = false;\n                         pipeline.fireChannelUnregistered();\n+\n+                        if (!isOpen()) {\n+                            // Remove all handlers from the ChannelPipeline. This is needed to ensure", "originalCommit": "211a3be1cfe558a3f0aa1b408cc19d355927c5cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3NjA3Ng==", "url": "https://github.com/netty/netty/pull/9970#discussion_r376276076", "bodyText": "@ejona86 this is exactly the same as we did before in DefaultChannelPipeline. I just move the code.", "author": "normanmaurer", "createdAt": "2020-02-07T08:53:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4OTQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0MTU2NA==", "url": "https://github.com/netty/netty/pull/9970#discussion_r378441564", "bodyText": "Oh, I see. This only happens if the Channel is closed. That looks fine.", "author": "ejona86", "createdAt": "2020-02-12T18:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4OTQ1Mw=="}], "type": "inlineReview"}, {"oid": "3e878db24e964e85de3172be0c6b60544eadc458", "url": "https://github.com/netty/netty/commit/3e878db24e964e85de3172be0c6b60544eadc458", "message": "Ensure the DefaultChannelHandlerContext is unlinked once removed\n\nMotivation:\n\nAt the moment the next / prev references are not set to \"null\" in the DefaultChannelHandlerContext once the ChannelHandler is removed. This is bad as it basically let users still use the ChannelHandlerContext of a ChannelHandler after it is removed and may produce very suprising behaviour.\n\nModifications:\n\n- Fail if someone tries to use the ChannelHandlerContext once the ChannelHandler was removed (for outbound operations fail the promise, for inbound fire the error through the ChannelPipeline)\n- Fix some handlers to ensure we not use the ChannelHandlerContext after the handler was removed\n- Adjust DefaultChannelPipeline / DefaultChannelHandlerContext to fixes races with removal / replacement of handlers\n\nResult:\n\nCleanup behaviour and make it more predictible for pipeline modifications", "committedDate": "2020-02-11T15:34:17Z", "type": "commit"}, {"oid": "1cb65dcf0c9baa52d52c907cdd61a5432a6ce241", "url": "https://github.com/netty/netty/commit/1cb65dcf0c9baa52d52c907cdd61a5432a6ce241", "message": "rename method", "committedDate": "2020-02-11T15:34:18Z", "type": "commit"}, {"oid": "1cb65dcf0c9baa52d52c907cdd61a5432a6ce241", "url": "https://github.com/netty/netty/commit/1cb65dcf0c9baa52d52c907cdd61a5432a6ce241", "message": "rename method", "committedDate": "2020-02-11T15:34:18Z", "type": "forcePushed"}, {"oid": "2bbb2e1e2e6141da08dda9bd654e60e64c58fa78", "url": "https://github.com/netty/netty/commit/2bbb2e1e2e6141da08dda9bd654e60e64c58fa78", "message": "Address erics comment", "committedDate": "2020-02-13T08:48:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE3NzYzMg==", "url": "https://github.com/netty/netty/pull/9970#discussion_r382177632", "bodyText": "How does this compile?", "author": "carl-mastrangelo", "createdAt": "2020-02-20T18:25:39Z", "path": "transport/src/main/java/io/netty/channel/DefaultChannelPipeline.java", "diffHunk": "@@ -777,19 +720,24 @@ public ChannelHandler removeLast() {\n             assert ctx != null;\n \n             if (!inEventLoop) {\n-                try {\n-                    executor.execute(() -> remove0(ctx));\n-                    return ctx.handler();\n-                } catch (Throwable cause) {\n-                    handlers.add(idx, ctx);\n-                    throw cause;\n-                }\n+                return scheduleRemove(idx, ctx);\n             }\n         }\n         remove0(ctx);\n         return ctx.handler();\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private <T extends ChannelHandler> T scheduleRemove(int idx, DefaultChannelHandlerContext ctx) {\n+        try {\n+            ctx.executor().execute(() -> remove0(ctx));\n+            return (T) ctx.handler();\n+        } catch (Throwable cause) {\n+            handlers.add(idx, ctx);\n+            throw cause;", "originalCommit": "2bbb2e1e2e6141da08dda9bd654e60e64c58fa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ1Nzg2MA==", "url": "https://github.com/netty/netty/pull/9970#discussion_r383457860", "bodyText": "@carl-mastrangelo the compiler is smart enough when using Java8 to understand that the code in the try block can only throw an unchecked exception and so we will only rethrow this.", "author": "normanmaurer", "createdAt": "2020-02-24T19:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE3NzYzMg=="}], "type": "inlineReview"}]}