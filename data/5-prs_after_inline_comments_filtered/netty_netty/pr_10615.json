{"pr_number": 10615, "pr_title": "Close IOUringEventLoop wakeup/eventfd close shutdown race", "pr_createdAt": "2020-09-27T01:18:02Z", "pr_url": "https://github.com/netty/netty/pull/10615", "timeline": [{"oid": "f85b7c480d7ab26c5a8878120eb1e5e1f7095b37", "url": "https://github.com/netty/netty/commit/f85b7c480d7ab26c5a8878120eb1e5e1f7095b37", "message": "Close IOUringEventLoop wakeup/eventfd close shutdown race\n\nMotivation\n\nThere is a race condition when shutting down the event loop where the\neventFd write performed in the wakeup() method may actually hit a\ndifferent fd if it's closed and reassigned in the meantime.\n\nThis was already encountered and addressed in the epoll case.\n\nModifications\n\nSimilar to what's done for epoll, in IOUringEventLoop:\n- Reinstate pendingWakeup flag which tracks when there is a wakeup\npending (CAS of nextWakeupNanos performed by other thread in the\nwakeup() method)\n- Add logic to the cleanup() method to wait for corresponding READ CQE\nbefore closing the eventFd\n- Remove unused fields from IOUringCompletionQueue (cleanup)\n\nResult\n\nNo event loop shutdown race", "committedDate": "2020-09-27T01:13:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTMwNA==", "url": "https://github.com/netty/netty/pull/10615#discussion_r495581304", "bodyText": "@njhill shouldn't we keep the cancel check ?", "author": "normanmaurer", "createdAt": "2020-09-27T14:56:17Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -220,9 +223,8 @@ void handleLoopException(Throwable t) {\n     @Override\n     public void handle(int fd, int res, int flags, int op, int data) {\n         if (op == Native.IORING_OP_READ && eventfd.intValue() == fd) {\n-            if (res != Native.ERRNO_ECANCELED_NEGATIVE) {\n-                addEventFdRead(ringBuffer.ioUringSubmissionQueue());\n-            }\n+            pendingWakeup = false;\n+            addEventFdRead(ringBuffer.ioUringSubmissionQueue());", "originalCommit": "f85b7c480d7ab26c5a8878120eb1e5e1f7095b37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYzOTI1NA==", "url": "https://github.com/netty/netty/pull/10615#discussion_r495639254", "bodyText": "I don't think it can happen since we never cancel the blocking read. I think it was left over from when we were using non-blocking with poll.", "author": "njhill", "createdAt": "2020-09-28T00:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTMwNA=="}], "type": "inlineReview"}]}