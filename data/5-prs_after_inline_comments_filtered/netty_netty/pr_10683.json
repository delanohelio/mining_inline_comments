{"pr_number": 10683, "pr_title": "Better hash algorithm in FingerprintTrustManagerFactory", "pr_createdAt": "2020-10-14T08:26:24Z", "pr_url": "https://github.com/netty/netty/pull/10683", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzODY2OA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r504538668", "bodyText": "Add method to add a List of fingerprints.", "author": "hyperxpro", "createdAt": "2020-10-14T09:35:01Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -207,4 +252,50 @@ protected void engineInit(ManagerFactoryParameters managerFactoryParameters) thr\n     protected TrustManager[] engineGetTrustManagers() {\n         return new TrustManager[] { tm };\n     }\n+\n+    /**\n+     * A builder for creating {@link FingerprintTrustManagerFactory}.\n+     */\n+    public static final class Builder {\n+\n+        /**\n+         * A hash algorithm for fingerprints.\n+         */\n+        private final String algorithm;\n+\n+        /**\n+         * A list of fingerprints.\n+         */\n+        private final List<String> fingerprints = new ArrayList<String>();\n+\n+        /**\n+         * Creates a builder.\n+         *\n+         * @param algorithm a hash algorithm\n+         */\n+        private Builder(String algorithm) {\n+            this.algorithm = ObjectUtil.checkNotNull(algorithm, \"algorithm\");\n+        }\n+\n+        /**\n+         * Adds a fingerprint.\n+         *\n+         * @param fingerprint a fingerprint\n+         * @return the same builder\n+         */\n+        public Builder fingerprint(String fingerprint) {", "originalCommit": "44e6f4c33cf9070b1ef5231c80dcfb760a83ab9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2MDEwNA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r504560104", "bodyText": "honestly this feels a bit like overkill.. Let's just keep it or use String...", "author": "normanmaurer", "createdAt": "2020-10-14T10:10:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2OTAwMw==", "url": "https://github.com/netty/netty/pull/10683#discussion_r504569003", "bodyText": "Calling public Builder fingerprint(String fingerprint) every time is a little painful that's why we need something to add fingerprints in bulk. Both List and String... will do the job.", "author": "hyperxpro", "createdAt": "2020-10-14T10:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU3MTU0MA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r504571540", "bodyText": "I disagree... what is the point of a builder if you will never call its methods multiple times ?", "author": "normanmaurer", "createdAt": "2020-10-14T10:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU3MjUxNg==", "url": "https://github.com/netty/netty/pull/10683#discussion_r504572516", "bodyText": "That's a thing too.", "author": "hyperxpro", "createdAt": "2020-10-14T10:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM1NTQ3MA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r505355470", "bodyText": "I think both points are valid. The builder may be used in multiple ways. For example, someone may want to hardcode fingerprints like the following:\nFingerprintTrustManagerFactory f =\n  FingerprintTrustManagerFactory\n    .builder(\"SHA256\")\n    .fingerprint(\"deadbeef...\")\n    .fingerprint(\"cafecafe...\")\n    .build();\nBut someone may want to load fingerprints from a file. In this case, fingerprint() would need to be called in a loop:\nFingerprintTrustManagerFactory.Builder b = FingerprintTrustManagerFactory.builder(\"SHA256\");\nfor (String s : loadFingerprintsFrom(file)) {\n    b.fingerprint(s);\n}\nHere fingerprint(String...) might make it look a bit nicer:\nFingerprintTrustManagerFactory f =\n  FingerprintTrustManagerFactory\n    .builder(\"SHA256\")\n    .fingerprint(loadFingerprintsFrom(file))\n    .build();\nAnyway, I am fine to keep it as-is, or updating fingerprint() to accept String....", "author": "artem-smotrakov", "createdAt": "2020-10-15T08:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM1ODAxMg==", "url": "https://github.com/netty/netty/pull/10683#discussion_r505358012", "bodyText": "I am ok with String... but then call it fingerprints(...)", "author": "normanmaurer", "createdAt": "2020-10-15T08:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzODY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1Nzg4MA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r504557880", "bodyText": "Also add @deprecated javadoc tag", "author": "normanmaurer", "createdAt": "2020-10-14T10:06:19Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -135,45 +131,97 @@ private void checkTrusted(String type, X509Certificate[] chain) throws Certifica\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(Iterable<String> fingerprints) {\n-        this(toFingerprintArray(fingerprints));\n+        this(\"SHA1\", toFingerprintArray(fingerprints));\n     }\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form", "originalCommit": "44e6f4c33cf9070b1ef5231c80dcfb760a83ab9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1ODA4MA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r504558080", "bodyText": "also add @deprecated javadoc tag", "author": "normanmaurer", "createdAt": "2020-10-14T10:06:41Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -135,45 +131,97 @@ private void checkTrusted(String type, X509Certificate[] chain) throws Certifica\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(Iterable<String> fingerprints) {\n-        this(toFingerprintArray(fingerprints));\n+        this(\"SHA1\", toFingerprintArray(fingerprints));\n     }\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(String... fingerprints) {\n-        this(toFingerprintArray(Arrays.asList(fingerprints)));\n+        this(\"SHA1\", toFingerprintArray(Arrays.asList(fingerprints)));\n     }\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints", "originalCommit": "44e6f4c33cf9070b1ef5231c80dcfb760a83ab9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1ODYzOQ==", "url": "https://github.com/netty/netty/pull/10683#discussion_r504558639", "bodyText": "should we call MessageDigest.getInstance(algorithm) once in the constructor now to ensure it will not fail later on ?", "author": "normanmaurer", "createdAt": "2020-10-14T10:07:36Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -135,45 +131,97 @@ private void checkTrusted(String type, X509Certificate[] chain) throws Certifica\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(Iterable<String> fingerprints) {\n-        this(toFingerprintArray(fingerprints));\n+        this(\"SHA1\", toFingerprintArray(fingerprints));\n     }\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(String... fingerprints) {\n-        this(toFingerprintArray(Arrays.asList(fingerprints)));\n+        this(\"SHA1\", toFingerprintArray(Arrays.asList(fingerprints)));\n     }\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(byte[]... fingerprints) {\n+        this(\"SHA1\", fingerprints);\n+    }\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param algorithm a hash algorithm\n+     * @param fingerprints a list of fingerprints\n+     */\n+    private FingerprintTrustManagerFactory(final String algorithm, byte[][] fingerprints) {\n+        ObjectUtil.checkNotNull(algorithm, \"algorithm\");", "originalCommit": "44e6f4c33cf9070b1ef5231c80dcfb760a83ab9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1OTQzMA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r504559430", "bodyText": "see above... I think it is very unlikely that the \"constructing\" thread will use the factory itself. so I think it would be better to not waste resources in the FastThreadLocal  and construct it directly.", "author": "normanmaurer", "createdAt": "2020-10-14T10:09:00Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -135,45 +131,97 @@ private void checkTrusted(String type, X509Certificate[] chain) throws Certifica\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(Iterable<String> fingerprints) {\n-        this(toFingerprintArray(fingerprints));\n+        this(\"SHA1\", toFingerprintArray(fingerprints));\n     }\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(String... fingerprints) {\n-        this(toFingerprintArray(Arrays.asList(fingerprints)));\n+        this(\"SHA1\", toFingerprintArray(Arrays.asList(fingerprints)));\n     }\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(byte[]... fingerprints) {\n+        this(\"SHA1\", fingerprints);\n+    }\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param algorithm a hash algorithm\n+     * @param fingerprints a list of fingerprints\n+     */\n+    private FingerprintTrustManagerFactory(final String algorithm, byte[][] fingerprints) {\n+        ObjectUtil.checkNotNull(algorithm, \"algorithm\");\n         ObjectUtil.checkNotNull(fingerprints, \"fingerprints\");\n \n+        this.tlmd = new FastThreadLocal<MessageDigest>() {\n+\n+            @Override\n+            protected MessageDigest initialValue() {\n+                try {\n+                    return MessageDigest.getInstance(algorithm);\n+                } catch (NoSuchAlgorithmException e) {\n+                    throw new IllegalArgumentException(\"Unsupported hash algorithm\", e);\n+                }\n+            }\n+        };\n+\n+        int hashLength = tlmd.get().getDigestLength();", "originalCommit": "44e6f4c33cf9070b1ef5231c80dcfb760a83ab9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4MDQ3OA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r505380478", "bodyText": "If I understand you correctly, you're suggesting getting rid of FastThreadLocal. I was not sure about it since I am new to the code. Okay, I can remove FastThreadLocal and create a MessageDigest directly in the constructor if it's fine.", "author": "artem-smotrakov", "createdAt": "2020-10-15T09:09:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1OTQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4OTgwNA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r505389804", "bodyText": "no ... What I was saying that you should keep the FastThreadLocal but not access it in the constructor but better just create a new instance in the constructor and use it here.", "author": "normanmaurer", "createdAt": "2020-10-15T09:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1OTQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQwNzExNg==", "url": "https://github.com/netty/netty/pull/10683#discussion_r505407116", "bodyText": "Okay, sure I can create a MessageDigest in the constructor as an early-check that the algorithm exists. The initialization of FastThreadLocal would still stay in the constructor since it now requires an algorithm identifier.", "author": "artem-smotrakov", "createdAt": "2020-10-15T09:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1OTQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1OTYyNA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r504559624", "bodyText": "EmptyArrays.BYTES", "author": "normanmaurer", "createdAt": "2020-10-14T10:09:19Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -135,45 +131,97 @@ private void checkTrusted(String type, X509Certificate[] chain) throws Certifica\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(Iterable<String> fingerprints) {\n-        this(toFingerprintArray(fingerprints));\n+        this(\"SHA1\", toFingerprintArray(fingerprints));\n     }\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(String... fingerprints) {\n-        this(toFingerprintArray(Arrays.asList(fingerprints)));\n+        this(\"SHA1\", toFingerprintArray(Arrays.asList(fingerprints)));\n     }\n \n     /**\n      * Creates a new instance.\n+     * <p>\n+     * <strong>NOTE:</strong> This deprecated constructor uses SHA-1 that is considered insecure.\n+     * It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     * by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     * </p>\n      *\n      * @param fingerprints a list of SHA1 fingerprints\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(byte[]... fingerprints) {\n+        this(\"SHA1\", fingerprints);\n+    }\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param algorithm a hash algorithm\n+     * @param fingerprints a list of fingerprints\n+     */\n+    private FingerprintTrustManagerFactory(final String algorithm, byte[][] fingerprints) {\n+        ObjectUtil.checkNotNull(algorithm, \"algorithm\");\n         ObjectUtil.checkNotNull(fingerprints, \"fingerprints\");\n \n+        this.tlmd = new FastThreadLocal<MessageDigest>() {\n+\n+            @Override\n+            protected MessageDigest initialValue() {\n+                try {\n+                    return MessageDigest.getInstance(algorithm);\n+                } catch (NoSuchAlgorithmException e) {\n+                    throw new IllegalArgumentException(\"Unsupported hash algorithm\", e);\n+                }\n+            }\n+        };\n+\n+        int hashLength = tlmd.get().getDigestLength();\n         List<byte[]> list = new ArrayList<byte[]>(fingerprints.length);\n         for (byte[] f: fingerprints) {\n             if (f == null) {\n                 break;\n             }\n-            if (f.length != SHA1_BYTE_LEN) {\n-                throw new IllegalArgumentException(\"malformed fingerprint: \" +\n-                        ByteBufUtil.hexDump(Unpooled.wrappedBuffer(f)) + \" (expected: SHA1)\");\n+            if (f.length != hashLength) {\n+                throw new IllegalArgumentException(\n+                        \"malformed fingerprint (length): \" + ByteBufUtil.hexDump(Unpooled.wrappedBuffer(f)));\n             }\n             list.add(f.clone());\n         }\n \n         this.fingerprints = list.toArray(new byte[0][]);", "originalCommit": "44e6f4c33cf9070b1ef5231c80dcfb760a83ab9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4NjU1NA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r505386554", "bodyText": "If I am not missing something, that could not be used here because EmptyArrays.EMPTY_BYTES is byte[].\n\n  \n    \n      netty/common/src/main/java/io/netty/util/internal/EmptyArrays.java\n    \n    \n         Line 28\n      in\n      00afb19\n    \n    \n    \n    \n\n        \n          \n           public static final byte[] EMPTY_BYTES = {};", "author": "artem-smotrakov", "createdAt": "2020-10-15T09:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1OTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4OTI4Nw==", "url": "https://github.com/netty/netty/pull/10683#discussion_r505389287", "bodyText": "ah sorry I missed that it is [][]", "author": "normanmaurer", "createdAt": "2020-10-15T09:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1OTYyNA=="}], "type": "inlineReview"}, {"oid": "869ccd8ee9ce33378f49837c1d6389cd532263d0", "url": "https://github.com/netty/netty/commit/869ccd8ee9ce33378f49837c1d6389cd532263d0", "message": "Better hash algorithm in FingerprintTrustManagerFactory\n\nMotivation:\n\nFingerprintTrustManagerFactory can only use SHA-1 that is considered\ninsecure.\n\nModifications:\n\nUpdated FingerprintTrustManagerFactory to accept a stronger hash\nalgorithm.\nDeprecated the constructors that still use SHA-1.\n\nResult:\n\nA user can now configure FingerprintTrustManagerFactory to use a\nstronger hash algorithm.\nThe compiler shows a warning if the code still uses one of the\nunsafe constructors.", "committedDate": "2020-10-15T09:58:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4NjEzMA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r505486130", "bodyText": "nit: include algorithm in the message as well.", "author": "normanmaurer", "createdAt": "2020-10-15T12:04:23Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -136,44 +132,89 @@ private void checkTrusted(String type, X509Certificate[] chain) throws Certifica\n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(Iterable<String> fingerprints) {\n-        this(toFingerprintArray(fingerprints));\n+        this(\"SHA1\", toFingerprintArray(fingerprints));\n     }\n \n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(String... fingerprints) {\n-        this(toFingerprintArray(Arrays.asList(fingerprints)));\n+        this(\"SHA1\", toFingerprintArray(Arrays.asList(fingerprints)));\n     }\n \n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(byte[]... fingerprints) {\n+        this(\"SHA1\", fingerprints);\n+    }\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param algorithm a hash algorithm\n+     * @param fingerprints a list of fingerprints\n+     */\n+    private FingerprintTrustManagerFactory(final String algorithm, byte[][] fingerprints) {\n+        ObjectUtil.checkNotNull(algorithm, \"algorithm\");\n         ObjectUtil.checkNotNull(fingerprints, \"fingerprints\");\n \n+        MessageDigest md;\n+        try {\n+            md = MessageDigest.getInstance(algorithm);\n+        } catch (NoSuchAlgorithmException e) {\n+            throw new IllegalArgumentException(\"Unsupported hash algorithm\", e);", "originalCommit": "869ccd8ee9ce33378f49837c1d6389cd532263d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ5NTkwMw==", "url": "https://github.com/netty/netty/pull/10683#discussion_r505495903", "bodyText": "The wrapped exception usually mention the algorithm but nevertheless let's include it to the top message as well.", "author": "artem-smotrakov", "createdAt": "2020-10-15T12:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4NjEzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4NzE3NA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r505487174", "bodyText": "nit: include the actual length and the expected length in the message as well", "author": "normanmaurer", "createdAt": "2020-10-15T12:06:12Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -136,44 +132,89 @@ private void checkTrusted(String type, X509Certificate[] chain) throws Certifica\n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(Iterable<String> fingerprints) {\n-        this(toFingerprintArray(fingerprints));\n+        this(\"SHA1\", toFingerprintArray(fingerprints));\n     }\n \n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(String... fingerprints) {\n-        this(toFingerprintArray(Arrays.asList(fingerprints)));\n+        this(\"SHA1\", toFingerprintArray(Arrays.asList(fingerprints)));\n     }\n \n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(byte[]... fingerprints) {\n+        this(\"SHA1\", fingerprints);\n+    }\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param algorithm a hash algorithm\n+     * @param fingerprints a list of fingerprints\n+     */\n+    private FingerprintTrustManagerFactory(final String algorithm, byte[][] fingerprints) {\n+        ObjectUtil.checkNotNull(algorithm, \"algorithm\");\n         ObjectUtil.checkNotNull(fingerprints, \"fingerprints\");\n \n+        MessageDigest md;\n+        try {\n+            md = MessageDigest.getInstance(algorithm);\n+        } catch (NoSuchAlgorithmException e) {\n+            throw new IllegalArgumentException(\"Unsupported hash algorithm\", e);\n+        }\n+\n+        int hashLength = md.getDigestLength();\n         List<byte[]> list = new ArrayList<byte[]>(fingerprints.length);\n         for (byte[] f: fingerprints) {\n             if (f == null) {\n                 break;\n             }\n-            if (f.length != SHA1_BYTE_LEN) {\n-                throw new IllegalArgumentException(\"malformed fingerprint: \" +\n-                        ByteBufUtil.hexDump(Unpooled.wrappedBuffer(f)) + \" (expected: SHA1)\");\n+            if (f.length != hashLength) {\n+                throw new IllegalArgumentException(\n+                        \"malformed fingerprint (length): \" + ByteBufUtil.hexDump(Unpooled.wrappedBuffer(f)));", "originalCommit": "869ccd8ee9ce33378f49837c1d6389cd532263d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "187a6d43f881df5cb0ecbf157dfd808208824649", "url": "https://github.com/netty/netty/commit/187a6d43f881df5cb0ecbf157dfd808208824649", "message": "Better hash algorithm in FingerprintTrustManagerFactory\n\nMotivation:\n\nFingerprintTrustManagerFactory can only use SHA-1 that is considered\ninsecure.\n\nModifications:\n\nUpdated FingerprintTrustManagerFactory to accept a stronger hash\nalgorithm.\nDeprecated the constructors that still use SHA-1.\n\nResult:\n\nA user can now configure FingerprintTrustManagerFactory to use a\nstronger hash algorithm.\nThe compiler shows a warning if the code still uses one of the\nunsafe constructors.", "committedDate": "2020-10-15T12:26:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE0Mjk5NA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506142994", "bodyText": "How about moving this method before the member fields in this class? i.e.\nclass MyClass {\n\n    private static final ...;\n\n    public static Builder builder() { ... }\n\n    private final ...;\n\n    public MyClass() { ... }\n}", "author": "trustin", "createdAt": "2020-10-16T07:57:53Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -136,44 +132,91 @@ private void checkTrusted(String type, X509Certificate[] chain) throws Certifica\n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(Iterable<String> fingerprints) {\n-        this(toFingerprintArray(fingerprints));\n+        this(\"SHA1\", toFingerprintArray(fingerprints));\n     }\n \n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(String... fingerprints) {\n-        this(toFingerprintArray(Arrays.asList(fingerprints)));\n+        this(\"SHA1\", toFingerprintArray(Arrays.asList(fingerprints)));\n     }\n \n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(byte[]... fingerprints) {\n+        this(\"SHA1\", fingerprints);\n+    }\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param algorithm a hash algorithm\n+     * @param fingerprints a list of fingerprints\n+     */\n+    private FingerprintTrustManagerFactory(final String algorithm, byte[][] fingerprints) {\n+        ObjectUtil.checkNotNull(algorithm, \"algorithm\");\n         ObjectUtil.checkNotNull(fingerprints, \"fingerprints\");\n \n+        MessageDigest md;\n+        try {\n+            md = MessageDigest.getInstance(algorithm);\n+        } catch (NoSuchAlgorithmException e) {\n+            throw new IllegalArgumentException(\n+                    String.format(\"Unsupported hash algorithm: %s\", algorithm), e);\n+        }\n+\n+        int hashLength = md.getDigestLength();\n         List<byte[]> list = new ArrayList<byte[]>(fingerprints.length);\n         for (byte[] f: fingerprints) {\n             if (f == null) {\n                 break;\n             }\n-            if (f.length != SHA1_BYTE_LEN) {\n-                throw new IllegalArgumentException(\"malformed fingerprint: \" +\n-                        ByteBufUtil.hexDump(Unpooled.wrappedBuffer(f)) + \" (expected: SHA1)\");\n+            if (f.length != hashLength) {\n+                throw new IllegalArgumentException(\n+                        String.format(\"malformed fingerprint (length is %d but expected %d): %s\",\n+                                      f.length, hashLength, ByteBufUtil.hexDump(Unpooled.wrappedBuffer(f))));\n             }\n             list.add(f.clone());\n         }\n \n+        this.tlmd.set(md);\n         this.fingerprints = list.toArray(new byte[0][]);\n     }\n \n+    /**\n+     * Creates a builder for {@link FingerprintTrustManagerFactory}.\n+     *\n+     * @param algorithm a hash algorithm\n+     * @return a builder\n+     */\n+    public static Builder builder(String algorithm) {\n+       return new Builder(algorithm);\n+    }", "originalCommit": "187a6d43f881df5cb0ecbf157dfd808208824649", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE0MzQzNA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506143434", "bodyText": "I'd prefer having this in a top-level class as FingerprintTrustManagerFactoryBuilder.", "author": "trustin", "createdAt": "2020-10-16T07:58:25Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -207,4 +247,52 @@ protected void engineInit(ManagerFactoryParameters managerFactoryParameters) thr\n     protected TrustManager[] engineGetTrustManagers() {\n         return new TrustManager[] { tm };\n     }\n+\n+    /**\n+     * A builder for creating {@link FingerprintTrustManagerFactory}.\n+     */\n+    public static final class Builder {", "originalCommit": "187a6d43f881df5cb0ecbf157dfd808208824649", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE0NDE3MA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506144170", "bodyText": "How about accepting CharSequence... and then converting it to a String?\nCould we also add the version that accepts Iterable<? extends CharSequence>?", "author": "trustin", "createdAt": "2020-10-16T07:59:24Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -207,4 +247,52 @@ protected void engineInit(ManagerFactoryParameters managerFactoryParameters) thr\n     protected TrustManager[] engineGetTrustManagers() {\n         return new TrustManager[] { tm };\n     }\n+\n+    /**\n+     * A builder for creating {@link FingerprintTrustManagerFactory}.\n+     */\n+    public static final class Builder {\n+\n+        /**\n+         * A hash algorithm for fingerprints.\n+         */\n+        private final String algorithm;\n+\n+        /**\n+         * A list of fingerprints.\n+         */\n+        private final List<String> fingerprints = new ArrayList<String>();\n+\n+        /**\n+         * Creates a builder.\n+         *\n+         * @param algorithm a hash algorithm\n+         */\n+        private Builder(String algorithm) {\n+            this.algorithm = ObjectUtil.checkNotNull(algorithm, \"algorithm\");\n+        }\n+\n+        /**\n+         * Adds fingerprints.\n+         *\n+         * @param fingerprints a number of fingerprints\n+         * @return the same builder\n+         */\n+        public Builder fingerprints(String... fingerprints) {", "originalCommit": "187a6d43f881df5cb0ecbf157dfd808208824649", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM2ODgyMg==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506368822", "bodyText": "How about accepting CharSequence... and then converting it to a String?\n\n\nLet me try.\n\n\nCould we also add the version that accepts Iterable<? extends CharSequence>?\n\n\nWe've discussed adding fingerprings(List) but decided not to do that\n#10683 (comment)\nI am fine with adding fingerprints(Iterable<? extends CharSequence>) as long as other are fine.", "author": "artem-smotrakov", "createdAt": "2020-10-16T12:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE0NDE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU4MDAyNg==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506580026", "bodyText": "I think it was more about fingerprint(String) and fingerprints(String...). We do need fingerprints(Iterable<? extends CharSequence>) for the users who want to feed the fingerprints from a collection.", "author": "trustin", "createdAt": "2020-10-16T16:15:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE0NDE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU5NzY3Nw==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506597677", "bodyText": "Sure, no problem. I've added fingerprints(Iterable<? extends CharSequence>).", "author": "artem-smotrakov", "createdAt": "2020-10-16T16:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE0NDE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE0NTA2NA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506145064", "bodyText": "What would be the expected behavior when fingerprints is empty? Throwing an IllegalStateException in build()?", "author": "trustin", "createdAt": "2020-10-16T08:00:23Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -207,4 +247,52 @@ protected void engineInit(ManagerFactoryParameters managerFactoryParameters) thr\n     protected TrustManager[] engineGetTrustManagers() {\n         return new TrustManager[] { tm };\n     }\n+\n+    /**\n+     * A builder for creating {@link FingerprintTrustManagerFactory}.\n+     */\n+    public static final class Builder {\n+\n+        /**\n+         * A hash algorithm for fingerprints.\n+         */\n+        private final String algorithm;\n+\n+        /**\n+         * A list of fingerprints.\n+         */\n+        private final List<String> fingerprints = new ArrayList<String>();\n+\n+        /**\n+         * Creates a builder.\n+         *\n+         * @param algorithm a hash algorithm\n+         */\n+        private Builder(String algorithm) {\n+            this.algorithm = ObjectUtil.checkNotNull(algorithm, \"algorithm\");\n+        }\n+\n+        /**\n+         * Adds fingerprints.\n+         *\n+         * @param fingerprints a number of fingerprints\n+         * @return the same builder\n+         */\n+        public Builder fingerprints(String... fingerprints) {\n+            ObjectUtil.checkNotNull(fingerprints, \"fingerprints\");\n+            for (String fingerprint : fingerprints) {\n+                this.fingerprints.add(fingerprint);\n+            }\n+            return this;\n+        }\n+\n+        /**\n+         * Creates a {@link FingerprintTrustManagerFactory}.\n+         *\n+         * @return a new {@link FingerprintTrustManagerFactory}\n+         */\n+        public FingerprintTrustManagerFactory build() {\n+            return new FingerprintTrustManagerFactory(this.algorithm, toFingerprintArray(this.fingerprints));", "originalCommit": "187a6d43f881df5cb0ecbf157dfd808208824649", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5OTQ2Mg==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506399462", "bodyText": "Currently, no fingerprints are allowed. That would mean that no certificate is going to be trusted. In theory, it's okay but it looks unlikely that an application may want to use such a paranoid TrustManager. Therefore, I think it would be fine to throw an exception if no fingerprints are provided. I'd put this check in to a constructor since all the checks are currently done there, and FingerprintTrustManagerFactory may be still created by calling the deprecated constructors.", "author": "artem-smotrakov", "createdAt": "2020-10-16T13:11:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE0NTA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwNjY4NA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506206684", "bodyText": "The way this works means the FingerprintTrustManagerFactory cannot be shared between multiple threads, because only the constructing thread has initialised their thread-local, and there's not enough information in the factory instance for other threads to initialise their thread-locals as well.", "author": "chrisvest", "createdAt": "2020-10-16T09:14:25Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -136,44 +132,91 @@ private void checkTrusted(String type, X509Certificate[] chain) throws Certifica\n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(Iterable<String> fingerprints) {\n-        this(toFingerprintArray(fingerprints));\n+        this(\"SHA1\", toFingerprintArray(fingerprints));\n     }\n \n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(String... fingerprints) {\n-        this(toFingerprintArray(Arrays.asList(fingerprints)));\n+        this(\"SHA1\", toFingerprintArray(Arrays.asList(fingerprints)));\n     }\n \n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(byte[]... fingerprints) {\n+        this(\"SHA1\", fingerprints);\n+    }\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param algorithm a hash algorithm\n+     * @param fingerprints a list of fingerprints\n+     */\n+    private FingerprintTrustManagerFactory(final String algorithm, byte[][] fingerprints) {\n+        ObjectUtil.checkNotNull(algorithm, \"algorithm\");\n         ObjectUtil.checkNotNull(fingerprints, \"fingerprints\");\n \n+        MessageDigest md;\n+        try {\n+            md = MessageDigest.getInstance(algorithm);\n+        } catch (NoSuchAlgorithmException e) {\n+            throw new IllegalArgumentException(\n+                    String.format(\"Unsupported hash algorithm: %s\", algorithm), e);\n+        }\n+\n+        int hashLength = md.getDigestLength();\n         List<byte[]> list = new ArrayList<byte[]>(fingerprints.length);\n         for (byte[] f: fingerprints) {\n             if (f == null) {\n                 break;\n             }\n-            if (f.length != SHA1_BYTE_LEN) {\n-                throw new IllegalArgumentException(\"malformed fingerprint: \" +\n-                        ByteBufUtil.hexDump(Unpooled.wrappedBuffer(f)) + \" (expected: SHA1)\");\n+            if (f.length != hashLength) {\n+                throw new IllegalArgumentException(\n+                        String.format(\"malformed fingerprint (length is %d but expected %d): %s\",\n+                                      f.length, hashLength, ByteBufUtil.hexDump(Unpooled.wrappedBuffer(f))));\n             }\n             list.add(f.clone());\n         }\n \n+        this.tlmd.set(md);", "originalCommit": "187a6d43f881df5cb0ecbf157dfd808208824649", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMDI4MQ==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506220281", "bodyText": "@chrisvest huh... can you explain to me why is this ?", "author": "normanmaurer", "createdAt": "2020-10-16T09:33:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwNjY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMTUwOA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506221508", "bodyText": "nevermind... #10683 (comment)", "author": "normanmaurer", "createdAt": "2020-10-16T09:35:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwNjY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM2NDcxOA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506364718", "bodyText": "@chrisvest Thanks for pointing it out!", "author": "artem-smotrakov", "createdAt": "2020-10-16T12:30:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwNjY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMTA4NQ==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506221085", "bodyText": "@chrisvest was right here... you need to override initialValue() here", "author": "normanmaurer", "createdAt": "2020-10-16T09:34:50Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -75,20 +83,8 @@\n \n     private static final Pattern FINGERPRINT_PATTERN = Pattern.compile(\"^[0-9a-fA-F:]+$\");\n     private static final Pattern FINGERPRINT_STRIP_PATTERN = Pattern.compile(\":\");\n-    private static final int SHA1_BYTE_LEN = 20;\n-    private static final int SHA1_HEX_LEN = SHA1_BYTE_LEN * 2;\n \n-    private static final FastThreadLocal<MessageDigest> tlmd = new FastThreadLocal<MessageDigest>() {\n-        @Override\n-        protected MessageDigest initialValue() {\n-            try {\n-                return MessageDigest.getInstance(\"SHA1\");\n-            } catch (NoSuchAlgorithmException e) {\n-                // All Java implementation must have SHA1 digest algorithm.\n-                throw new Error(e);\n-            }\n-        }\n-    };\n+    private final FastThreadLocal<MessageDigest> tlmd = new FastThreadLocal<MessageDigest>();", "originalCommit": "187a6d43f881df5cb0ecbf157dfd808208824649", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM2NDAzNA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506364034", "bodyText": "Since FingerprintTrustManagerFactory is now configured with a hash algorithm, tlmd needs to be initialized in the constructor. It used to be before. Then, initialValue() was removed because we wanted to create an instance of MessageDigest earlier in the constructor to check if the algorithm exists. If I understand correctly, we just want to revert the logic to the previous version. I am not sure if we need to create another MessageDigest in the constructor. Please let me know if so.", "author": "artem-smotrakov", "createdAt": "2020-10-16T12:29:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMTA4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4Njk4Ng==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506386986", "bodyText": "I am not sure if we need to create another MessageDigest in the constructor. Please let me know if so.\n\nWell, looks like there is no harm if we do that. So, I'll add such a check if no objections.", "author": "artem-smotrakov", "createdAt": "2020-10-16T12:58:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMTA4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5MjgyNA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506392824", "bodyText": "Since tlmd is an instance field, you can create the FastThreadLocal with an initialValue method that has all the logic necessary to create MessageDigest instances. I'd still check that the algorithm exists before creating the FTL, though, because each FTL instance will claim some static resources that we'd prefer not to leak.", "author": "chrisvest", "createdAt": "2020-10-16T13:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMTA4NQ=="}], "type": "inlineReview"}, {"oid": "813300cdcd13c18ea6982fbefccaa2a99f9c375f", "url": "https://github.com/netty/netty/commit/813300cdcd13c18ea6982fbefccaa2a99f9c375f", "message": "Better hash algorithm in FingerprintTrustManagerFactory\n\nMotivation:\n\nFingerprintTrustManagerFactory can only use SHA-1 that is considered\ninsecure.\n\nModifications:\n\nUpdated FingerprintTrustManagerFactory to accept a stronger hash\nalgorithm.\nDeprecated the constructors that still use SHA-1.\n\nResult:\n\nA user can now configure FingerprintTrustManagerFactory to use a\nstronger hash algorithm.\nThe compiler shows a warning if the code still uses one of the\nunsafe constructors.", "committedDate": "2020-10-16T15:45:53Z", "type": "forcePushed"}, {"oid": "28e7e074cf803eb80edae56e9c7ea554e24fcfd9", "url": "https://github.com/netty/netty/commit/28e7e074cf803eb80edae56e9c7ea554e24fcfd9", "message": "Better hash algorithm in FingerprintTrustManagerFactory\n\nMotivation:\n\nFingerprintTrustManagerFactory can only use SHA-1 that is considered\ninsecure.\n\nModifications:\n\nUpdated FingerprintTrustManagerFactory to accept a stronger hash\nalgorithm.\nDeprecated the constructors that still use SHA-1.\n\nResult:\n\nA user can now configure FingerprintTrustManagerFactory to use a\nstronger hash algorithm.\nThe compiler shows a warning if the code still uses one of the\nunsafe constructors.", "committedDate": "2020-10-16T15:49:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc5MTU1MQ==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506791551", "bodyText": "How about moving this validation to build() and raising IllegalStateException? Otherwise, a user will get IllegalArgumentException on build(), which does not make sense. We could add an assertion here instead.", "author": "trustin", "createdAt": "2020-10-17T04:16:04Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactory.java", "diffHunk": "@@ -136,45 +142,99 @@ private void checkTrusted(String type, X509Certificate[] chain) throws Certifica\n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(Iterable<String> fingerprints) {\n-        this(toFingerprintArray(fingerprints));\n+        this(\"SHA1\", toFingerprintArray(fingerprints));\n     }\n \n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints in hexadecimal form\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(String... fingerprints) {\n-        this(toFingerprintArray(Arrays.asList(fingerprints)));\n+        this(\"SHA1\", toFingerprintArray(Arrays.asList(fingerprints)));\n     }\n \n     /**\n      * Creates a new instance.\n      *\n+     * @deprecated This deprecated constructor uses SHA-1 that is considered insecure.\n+     *      It is recommended to specify a stronger hash algorithm, such as SHA-256,\n+     *      by calling {@link FingerprintTrustManagerFactory#builder(String)} method.\n+     *\n      * @param fingerprints a list of SHA1 fingerprints\n      */\n+    @Deprecated\n     public FingerprintTrustManagerFactory(byte[]... fingerprints) {\n+        this(\"SHA1\", fingerprints);\n+    }\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param algorithm a hash algorithm\n+     * @param fingerprints a list of fingerprints\n+     */\n+    FingerprintTrustManagerFactory(final String algorithm, byte[][] fingerprints) {\n+        ObjectUtil.checkNotNull(algorithm, \"algorithm\");\n         ObjectUtil.checkNotNull(fingerprints, \"fingerprints\");\n \n+        if (fingerprints.length == 0) {\n+            throw new IllegalArgumentException(\"No fingerprints provided\");", "originalCommit": "28e7e074cf803eb80edae56e9c7ea554e24fcfd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2Mjg5OQ==", "url": "https://github.com/netty/netty/pull/10683#discussion_r506962899", "bodyText": "If we would like to prohibit creating a TrustManager with no fingerprints, then I think this check should be in the constructor because FingerprintTrustManagerFactory can still be created by calling the deprecated constructors.\nIf I understand you correctly, you mean that IllegalArgumentException may confuse users whey they call build() that has no arguments itself. We can add an extra check in build() that throws IllegalStateException if the list of fingerprints is empty. I'll update the code then. Please let me know if I missed something.", "author": "artem-smotrakov", "createdAt": "2020-10-17T17:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc5MTU1MQ=="}], "type": "inlineReview"}, {"oid": "ce495d23eb17e01b8a5cc55dcdb536b4386c6a0f", "url": "https://github.com/netty/netty/commit/ce495d23eb17e01b8a5cc55dcdb536b4386c6a0f", "message": "Better hash algorithm in FingerprintTrustManagerFactory\n\nMotivation:\n\nFingerprintTrustManagerFactory can only use SHA-1 that is considered\ninsecure.\n\nModifications:\n\n- Updated FingerprintTrustManagerFactory to accept a stronger hash algorithm.\n- Deprecated the constructors that still use SHA-1.\n- Added a test for FingerprintTrustManagerFactory.\n\nResult:\n\nA user can now configure FingerprintTrustManagerFactory to use a\nstronger hash algorithm.\nThe compiler shows a warning if the code still uses one of the\nunsafe constructors.", "committedDate": "2020-10-17T17:07:08Z", "type": "commit"}, {"oid": "ce495d23eb17e01b8a5cc55dcdb536b4386c6a0f", "url": "https://github.com/netty/netty/commit/ce495d23eb17e01b8a5cc55dcdb536b4386c6a0f", "message": "Better hash algorithm in FingerprintTrustManagerFactory\n\nMotivation:\n\nFingerprintTrustManagerFactory can only use SHA-1 that is considered\ninsecure.\n\nModifications:\n\n- Updated FingerprintTrustManagerFactory to accept a stronger hash algorithm.\n- Deprecated the constructors that still use SHA-1.\n- Added a test for FingerprintTrustManagerFactory.\n\nResult:\n\nA user can now configure FingerprintTrustManagerFactory to use a\nstronger hash algorithm.\nThe compiler shows a warning if the code still uses one of the\nunsafe constructors.", "committedDate": "2020-10-17T17:07:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwOTk3NA==", "url": "https://github.com/netty/netty/pull/10683#discussion_r511909974", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *   http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n             *   https://www.apache.org/licenses/LICENSE-2.0", "author": "normanmaurer", "createdAt": "2020-10-26T12:04:48Z", "path": "handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactoryBuilder.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0", "originalCommit": "ce495d23eb17e01b8a5cc55dcdb536b4386c6a0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxMTUxMQ==", "url": "https://github.com/netty/netty/pull/10683#discussion_r511911511", "bodyText": "Thanks for fixing this @normanmaurer !", "author": "artem-smotrakov", "createdAt": "2020-10-26T12:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwOTk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxMDA5MQ==", "url": "https://github.com/netty/netty/pull/10683#discussion_r511910091", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *   http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n             *   https://www.apache.org/licenses/LICENSE-2.0", "author": "normanmaurer", "createdAt": "2020-10-26T12:05:03Z", "path": "handler/src/test/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactoryTest.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0", "originalCommit": "ce495d23eb17e01b8a5cc55dcdb536b4386c6a0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "34160323bb2c9edbcedd8ea22d511a99b580091e", "url": "https://github.com/netty/netty/commit/34160323bb2c9edbcedd8ea22d511a99b580091e", "message": "Update handler/src/main/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactoryBuilder.java", "committedDate": "2020-10-26T12:05:29Z", "type": "commit"}, {"oid": "fdba1034d1685aed58a4c78eff5457824c2c53b4", "url": "https://github.com/netty/netty/commit/fdba1034d1685aed58a4c78eff5457824c2c53b4", "message": "Update handler/src/test/java/io/netty/handler/ssl/util/FingerprintTrustManagerFactoryTest.java", "committedDate": "2020-10-26T12:05:43Z", "type": "commit"}]}