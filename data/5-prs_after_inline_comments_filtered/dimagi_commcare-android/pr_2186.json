{"pr_number": 2186, "pr_title": "Fixes form load crash in case of an pending update", "pr_createdAt": "2020-02-25T16:59:40Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2186", "timeline": [{"oid": "fef5ef4876f8f57e3232379fe239080508e3c0d5", "url": "https://github.com/dimagi/commcare-android/commit/fef5ef4876f8f57e3232379fe239080508e3c0d5", "message": "Fixes form load crash in case of an pending update", "committedDate": "2020-02-25T16:53:39Z", "type": "commit"}, {"oid": "f5d9c001fcc0624778c6e257f95bb18e707c6ddf", "url": "https://github.com/dimagi/commcare-android/commit/f5d9c001fcc0624778c6e257f95bb18e707c6ddf", "message": "comment", "committedDate": "2020-02-25T16:59:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAzMjI4MA==", "url": "https://github.com/dimagi/commcare-android/pull/2186#discussion_r384032280", "bodyText": "Small point that I think this should be >=.\nThere could be a situation where the old resource and new resource have the same version and the old resource is on the way out. In that case the signal that this current resource is installed (because it is being initialized, which only happens to installed resources) should imply that this resource is valid, so with no other information about the installed resource we should presume that it may not be.", "author": "ctsims", "createdAt": "2020-02-25T18:01:57Z", "path": "app/src/org/commcare/android/resource/installers/XFormAndroidInstaller.java", "diffHunk": "@@ -74,19 +74,21 @@ public boolean initialize(AndroidCommCarePlatform platform, boolean isUpgrade) t\n             IOException, InvalidReferenceException, InvalidStructureException,\r\n             XmlPullParserException, UnfullfilledRequirementsException {\r\n         super.initialize(platform, isUpgrade);\r\n-        if (isLatestFormRecord(platform)) {\r\n+\r\n+        if (platform.getFormDefId(namespace) == -1) {\r\n             platform.registerXmlns(namespace, formDefId);\r\n+        } else {\r\n+            // Only overwrites the existing form if the resourceVersion of the new form is higher than the existing one\r\n+            FormDefRecord existingForm = FormDefRecord.getFormDef(platform.getFormDefStorage(), platform.getFormDefId(namespace));\r\n+            FormDefRecord newForm = FormDefRecord.getFormDef(platform.getFormDefStorage(), formDefId);\r\n+            if (newForm.getResourceVersion() > existingForm.getResourceVersion()) {\r", "originalCommit": "f5d9c001fcc0624778c6e257f95bb18e707c6ddf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2b12315931c2b6426e6dd8b45e6577caf61e126e", "url": "https://github.com/dimagi/commcare-android/commit/2b12315931c2b6426e6dd8b45e6577caf61e126e", "message": "Allow the form to overwrite in case the resource versions are equal", "committedDate": "2020-02-25T18:14:47Z", "type": "commit"}]}