{"pr_number": 2322, "pr_title": "Implements request age and source in Install requests headers", "pr_createdAt": "2020-08-23T09:48:01Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2322", "timeline": [{"oid": "72edb418554b431208ea275130e9e1b659a7474c", "url": "https://github.com/dimagi/commcare-android/commit/72edb418554b431208ea275130e9e1b659a7474c", "message": "Adds ParameterizedReference to support custom headers in a resource request", "committedDate": "2020-08-08T16:46:12Z", "type": "commit"}, {"oid": "db531acf5222f36164a7d33757362c2869f5c056", "url": "https://github.com/dimagi/commcare-android/commit/db531acf5222f36164a7d33757362c2869f5c056", "message": "Adds recovery headers", "committedDate": "2020-08-10T09:55:13Z", "type": "commit"}, {"oid": "d9c1b860590e9d439555885f765be4b70dcd08d4", "url": "https://github.com/dimagi/commcare-android/commit/d9c1b860590e9d439555885f765be4b70dcd08d4", "message": "handles lazy download headers", "committedDate": "2020-08-13T06:26:36Z", "type": "commit"}, {"oid": "f1026626fed561735819d046493468e46a4a79ac", "url": "https://github.com/dimagi/commcare-android/commit/f1026626fed561735819d046493468e46a4a79ac", "message": "Adds custom headers for update requests", "committedDate": "2020-08-13T12:15:07Z", "type": "commit"}, {"oid": "9f6dd20f44bc5628d6669cfc627951f46167a1e5", "url": "https://github.com/dimagi/commcare-android/commit/9f6dd20f44bc5628d6669cfc627951f46167a1e5", "message": "Merge branch 'master' into updateRequestHeaders", "committedDate": "2020-08-19T09:56:19Z", "type": "commit"}, {"oid": "a3cb00b4ca17c3217077fce86f9452a912d38e04", "url": "https://github.com/dimagi/commcare-android/commit/a3cb00b4ca17c3217077fce86f9452a912d38e04", "message": "Merge branch 'master' into updateRequestHeaders", "committedDate": "2020-08-19T12:18:34Z", "type": "commit"}, {"oid": "ad1e2fffbd9e68042cfe64ef2e188086c50d1b9e", "url": "https://github.com/dimagi/commcare-android/commit/ad1e2fffbd9e68042cfe64ef2e188086c50d1b9e", "message": "Fixes a bug where update worker would throw unknown failure after completion", "committedDate": "2020-08-19T16:56:09Z", "type": "commit"}, {"oid": "b8f34a5edc9ddcccce1adaf83284c431a9e8ede1", "url": "https://github.com/dimagi/commcare-android/commit/b8f34a5edc9ddcccce1adaf83284c431a9e8ede1", "message": "Adds register request calls", "committedDate": "2020-08-19T17:59:35Z", "type": "commit"}, {"oid": "d1137fed26eba77382933a805d07337215425f3c", "url": "https://github.com/dimagi/commcare-android/commit/d1137fed26eba77382933a805d07337215425f3c", "message": "test for request age with mockk", "committedDate": "2020-08-19T18:00:23Z", "type": "commit"}, {"oid": "249a681dc97fee9c76d1e60189859317b1bd7561", "url": "https://github.com/dimagi/commcare-android/commit/249a681dc97fee9c76d1e60189859317b1bd7561", "message": "corrects the success check for background update", "committedDate": "2020-08-19T19:45:56Z", "type": "commit"}, {"oid": "3f2c73acec6ba1ffb1e6645681709dd4d868420e", "url": "https://github.com/dimagi/commcare-android/commit/3f2c73acec6ba1ffb1e6645681709dd4d868420e", "message": "moved file package", "committedDate": "2020-08-21T09:31:17Z", "type": "commit"}, {"oid": "b3b34727a02fc5bdd1b5a4965475a854f7019a7f", "url": "https://github.com/dimagi/commcare-android/commit/b3b34727a02fc5bdd1b5a4965475a854f7019a7f", "message": "convert the app update test to kotlin", "committedDate": "2020-08-21T09:48:48Z", "type": "commit"}, {"oid": "b5526b9a4826f91340346a86a25daa85fd62980e", "url": "https://github.com/dimagi/commcare-android/commit/b5526b9a4826f91340346a86a25daa85fd62980e", "message": "Corrects the status code for upgrade success with tests", "committedDate": "2020-08-21T12:51:47Z", "type": "commit"}, {"oid": "6e2ae91511c9e59201f5f384fc7742fcebe59c8d", "url": "https://github.com/dimagi/commcare-android/commit/6e2ae91511c9e59201f5f384fc7742fcebe59c8d", "message": "Merge branch 'updateRequestHeaders' of https://github.com/dimagi/commcare-android into updateRequestHeaders", "committedDate": "2020-08-22T08:07:23Z", "type": "commit"}, {"oid": "f0bc70c384e52274d8ed6d59affb56a19313ebac", "url": "https://github.com/dimagi/commcare-android/commit/f0bc70c384e52274d8ed6d59affb56a19313ebac", "message": "cleanup", "committedDate": "2020-08-22T09:16:09Z", "type": "commit"}, {"oid": "cec404ea2d2e3975c13a1e23a952d02d51520e45", "url": "https://github.com/dimagi/commcare-android/commit/cec404ea2d2e3975c13a1e23a952d02d51520e45", "message": "Adds tests for lazy media download", "committedDate": "2020-08-22T18:59:35Z", "type": "commit"}, {"oid": "f5dc48355fa804d2609ffe0144ae06d795953834", "url": "https://github.com/dimagi/commcare-android/commit/f5dc48355fa804d2609ffe0144ae06d795953834", "message": "Only skip lazy media during update", "committedDate": "2020-08-23T07:15:32Z", "type": "commit"}, {"oid": "46dabc4b2a34aa06134c18135d974223ef792f11", "url": "https://github.com/dimagi/commcare-android/commit/46dabc4b2a34aa06134c18135d974223ef792f11", "message": "KDocs", "committedDate": "2020-08-23T09:27:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4NjcyNw==", "url": "https://github.com/dimagi/commcare-android/pull/2322#discussion_r475786727", "bodyText": "It's best practice to treat these map objects as immutable to ensure that params don't leak between requests as is done here", "author": "ctsims", "createdAt": "2020-08-24T17:42:32Z", "path": "app/src/org/commcare/network/CommcareRequestGenerator.java", "diffHunk": "@@ -226,17 +233,19 @@ private static String getDigest() {\n \r\n     @Override\r\n     public Response<ResponseBody> simpleGet(String uri) throws IOException {\r\n-        return simpleGet(uri, new HashMap());\r\n+        return simpleGet(uri, new HashMap<>(), new HashMap<>());\r\n     }\r\n \r\n     @Override\r\n-    public Response<ResponseBody> simpleGet(String uri, Map<String, String> httpParams) throws IOException {\r\n+    public Response<ResponseBody> simpleGet(String uri, Map<String, String> httpParams, Map<String, String> httpHeaders) throws IOException {\r\n+        HashMap<String, String> headers = getHeaders(\"\");\r\n+        headers.putAll(httpHeaders);\r", "originalCommit": "46dabc4b2a34aa06134c18135d974223ef792f11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "34d9d17a6e6a51cbb4d420d755fc26268f18e5b5", "url": "https://github.com/dimagi/commcare-android/commit/34d9d17a6e6a51cbb4d420d755fc26268f18e5b5", "message": "Wires install source via platform", "committedDate": "2020-08-27T06:52:02Z", "type": "commit"}, {"oid": "94867c22b8402296f54d9c7bbb2515a22197f7e5", "url": "https://github.com/dimagi/commcare-android/commit/94867c22b8402296f54d9c7bbb2515a22197f7e5", "message": "lower case enum values", "committedDate": "2020-08-27T11:33:56Z", "type": "commit"}, {"oid": "161dac9d86717ba04d344fd8d7ee8f0f2ee8d280", "url": "https://github.com/dimagi/commcare-android/commit/161dac9d86717ba04d344fd8d7ee8f0f2ee8d280", "message": "Adds commcare version as header in requests", "committedDate": "2020-08-27T11:34:12Z", "type": "commit"}, {"oid": "c1a5e43c88544858cc4dd4c209fb39dd7a90a4b9", "url": "https://github.com/dimagi/commcare-android/commit/c1a5e43c88544858cc4dd4c209fb39dd7a90a4b9", "message": "make a new mutable copy of headers", "committedDate": "2020-08-27T11:40:33Z", "type": "commit"}, {"oid": "5d5d5ad334b5d49b4f9df4d91304118c34a0f730", "url": "https://github.com/dimagi/commcare-android/commit/5d5d5ad334b5d49b4f9df4d91304118c34a0f730", "message": "clears the install context", "committedDate": "2020-08-27T12:24:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM4MjYxMA==", "url": "https://github.com/dimagi/commcare-android/pull/2322#discussion_r478382610", "bodyText": "Curious how is it different from BuildConfig.VERSION_NAME", "author": "ShivamPokhriyal", "createdAt": "2020-08-27T12:32:13Z", "path": "app/src/org/commcare/AppUtils.java", "diffHunk": "@@ -177,6 +177,13 @@ public static String getCurrentVersionString() {\n         return Localization.get(application.getString(R.string.app_version_string), new String[]{pi.versionName, String.valueOf(pi.versionCode), ccv, buildNumber, buildDate, profileVersion});\n     }\n \n+    public static String getCommCareVersion() throws PackageManager.NameNotFoundException {\n+        CommCareApplication application = CommCareApplication.instance();\n+        PackageManager pm = application.getPackageManager();\n+        PackageInfo pi = pm.getPackageInfo(application.getPackageName(), 0);\n+        return pi.versionName;", "originalCommit": "5d5d5ad334b5d49b4f9df4d91304118c34a0f730", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM4NzAwNw==", "url": "https://github.com/dimagi/commcare-android/pull/2322#discussion_r478387007", "bodyText": "ahh I should definitely be using BuildConfig.VERSION_NAME here. thanks for flagging.", "author": "shubham1g5", "createdAt": "2020-08-27T12:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM4MjYxMA=="}], "type": "inlineReview"}, {"oid": "9ce804477231844805bf5bd545aabf223ad3cb5b", "url": "https://github.com/dimagi/commcare-android/commit/9ce804477231844805bf5bd545aabf223ad3cb5b", "message": "using static version name from Build Config", "committedDate": "2020-08-27T13:12:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ0OTEwMA==", "url": "https://github.com/dimagi/commcare-android/pull/2322#discussion_r478449100", "bodyText": "Earlier, we were using getHeaders(\"\") and now we're using getHeaders(null) which means now we'd not be having X_COMMCAREHQ_LAST_SYNC_TOKEN in the headers(Although it would be sent with empty value earlier). Is this expected?", "author": "ShivamPokhriyal", "createdAt": "2020-08-27T14:10:47Z", "path": "app/src/org/commcare/network/CommcareRequestGenerator.java", "diffHunk": "@@ -226,17 +242,19 @@ private static String getDigest() {\n \r\n     @Override\r\n     public Response<ResponseBody> simpleGet(String uri) throws IOException {\r\n-        return simpleGet(uri, new HashMap());\r\n+        return simpleGet(uri, new HashMap<>(), new HashMap<>());\r\n     }\r\n \r\n     @Override\r\n-    public Response<ResponseBody> simpleGet(String uri, Map<String, String> httpParams) throws IOException {\r\n+    public Response<ResponseBody> simpleGet(String uri, Map<String, String> httpParams, Map<String, String> httpHeaders) throws IOException {\r\n+        HashMap<String, String> headers = new HashMap<>(getHeaders(null));\r", "originalCommit": "5d5d5ad334b5d49b4f9df4d91304118c34a0f730", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ1ODU3NA==", "url": "https://github.com/dimagi/commcare-android/pull/2322#discussion_r478458574", "bodyText": "yes, I don't think it serves any purpose to have X_COMMCAREHQ_LAST_SYNC_TOKEN as empty in headers.", "author": "shubham1g5", "createdAt": "2020-08-27T14:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ0OTEwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ3OTEyNA==", "url": "https://github.com/dimagi/commcare-android/pull/2322#discussion_r478479124", "bodyText": "Should we call markSuccess here?", "author": "ShivamPokhriyal", "createdAt": "2020-08-27T14:51:18Z", "path": "app/src/org/commcare/update/UpdateHelper.java", "diffHunk": "@@ -81,11 +83,11 @@ public static UpdateHelper getNewInstance(boolean autoUpdate, UpdateProgressList\n     }\n \n     // Main UpdateHelper function for staging updates\n-    public ResultAndError<AppInstallStatus> update(String profileRef) {\n-        setupUpdate(profileRef);\n+    public ResultAndError<AppInstallStatus> update(String profileRef, InstallRequestSource installRequestSource) {\n+        setupUpdate(profileRef, installRequestSource);\n \n         try {\n-            return new ResultAndError<>(stageUpdate(profileRef));\n+            return new ResultAndError<>(stageUpdate(profileRef, installRequestSource));", "originalCommit": "9ce804477231844805bf5bd545aabf223ad3cb5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ3OTc3NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2322#discussion_r478479775", "bodyText": "Ohh nvm, it's getting set from UpdateTask. Perhaps, it'd be good to move the call to register outside as well?", "author": "ShivamPokhriyal", "createdAt": "2020-08-27T14:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ3OTEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3NjIwNg==", "url": "https://github.com/dimagi/commcare-android/pull/2322#discussion_r479476206", "bodyText": "Good point, calling both register and markSuccess inside now", "author": "shubham1g5", "createdAt": "2020-08-28T18:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ3OTEyNA=="}], "type": "inlineReview"}, {"oid": "b54772fabcf42b12b15c965e3474993929f41720", "url": "https://github.com/dimagi/commcare-android/commit/b54772fabcf42b12b15c965e3474993929f41720", "message": "Removes unused param", "committedDate": "2020-08-28T17:13:46Z", "type": "commit"}, {"oid": "d77da47e92d52430890be04bdffc9c64a9e8888f", "url": "https://github.com/dimagi/commcare-android/commit/d77da47e92d52430890be04bdffc9c64a9e8888f", "message": "Adds installContext for install workflows", "committedDate": "2020-08-28T17:23:16Z", "type": "commit"}, {"oid": "17ee141ff1e9fba1168a246195c777aa33be44fc", "url": "https://github.com/dimagi/commcare-android/commit/17ee141ff1e9fba1168a246195c777aa33be44fc", "message": "Removes recovery param from install", "committedDate": "2020-08-28T17:58:47Z", "type": "commit"}, {"oid": "4dfcf2cc969aee309aac45888abf783d81f280f1", "url": "https://github.com/dimagi/commcare-android/commit/4dfcf2cc969aee309aac45888abf783d81f280f1", "message": "Merge branch 'lazyMediaTestsAndFixes' into updateRequestHeaders", "committedDate": "2020-08-28T18:04:40Z", "type": "commit"}, {"oid": "6f8c007476e1a49900426a2c4c43dd2ac536fdbc", "url": "https://github.com/dimagi/commcare-android/commit/6f8c007476e1a49900426a2c4c43dd2ac536fdbc", "message": "Abstract Requeststat register and success for update in same method", "committedDate": "2020-08-28T18:41:04Z", "type": "commit"}, {"oid": "51e61ee498fe11160de2889d516f551c2514b3f1", "url": "https://github.com/dimagi/commcare-android/commit/51e61ee498fe11160de2889d516f551c2514b3f1", "message": "Imports", "committedDate": "2020-08-28T18:43:04Z", "type": "commit"}, {"oid": "bd98b11d861530e2ef29d5f05533f80ea720a6bb", "url": "https://github.com/dimagi/commcare-android/commit/bd98b11d861530e2ef29d5f05533f80ea720a6bb", "message": "Decouple ResourceInstallContext from platform", "committedDate": "2020-09-11T09:38:00Z", "type": "commit"}, {"oid": "28700d14918be1a4977dd0155654b038d7f7a6b1", "url": "https://github.com/dimagi/commcare-android/commit/28700d14918be1a4977dd0155654b038d7f7a6b1", "message": "Merge branch 'master' into updateRequestHeaders", "committedDate": "2020-09-11T10:13:05Z", "type": "commit"}]}