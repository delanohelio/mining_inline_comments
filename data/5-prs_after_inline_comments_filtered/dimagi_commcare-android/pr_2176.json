{"pr_number": 2176, "pr_title": "Update app to target Android 10 ", "pr_createdAt": "2020-01-24T11:21:08Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2176", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3NDAzNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r371074035", "bodyText": "Not Sure about the use-case of this particular method, but it won't work with android 10.\nAndroid best practices suggest See 3rd option using either a random UUID(we'll have to save it in preferences to make sure it doesn't change) or Firebase Instance ID(read here).\nThough both of them have a drawback: if application is reinstalled or user clears app data then the id will be lost and a new id will be generated.\nLet me know, if this is something important and should we use one of the above approaches to get a id.", "author": "ShivamPokhriyal", "createdAt": "2020-01-27T06:09:06Z", "path": "app/src/org/commcare/CommCareApplication.java", "diffHunk": "@@ -410,20 +410,27 @@ public void initializeGlobalResources(CommCareApp app) {\n     }\r\n \r\n     @NonNull\r\n+    @Deprecated\r\n     public String getPhoneId() {\r", "originalCommit": "4de4064d9bc8a1df5eb88471faea6bb610933f6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc0OTYzMw==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r371749633", "bodyText": "So deviceId was useful to identify the 2 separate installations of the app. I think using Firebase Instance Id seems like a good workaround here to separate out the installations as we don't have any other id currently that we maintain that's unique per CC installation.", "author": "shubham1g5", "createdAt": "2020-01-28T11:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3NDAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzMjAyMQ==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r372932021", "bodyText": "That's annoying, although I suppose it makes sense against the backdrop of other changes.\nMy vote is for a random ID we set on first install (and probably/potentially prefix with an identifier that lets us see that it's different from other device ID's) rather than a Firebase ID. It's not clear to me that it's good practice for us to get dependent on firebase features for apps which we don't want communicating metadata up to us (like apps with analytics disabled) and I could imagine rules about using firebase features like that also evolving in ways that force changes.", "author": "ctsims", "createdAt": "2020-01-30T12:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3NDAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczNjIyNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r371736225", "bodyText": "Though I'm not sure whether we should be adding all the files to the content provider.\nIMO, it makes sense for the video that are recorded using the record button in app, but for videos that are chosen from gallery, we just make a copy of that inside our app's directory so if we add it to content provider there'll be 2 copies of the same video shown to the user in the gallery app.", "author": "ShivamPokhriyal", "createdAt": "2020-01-28T11:01:14Z", "path": "app/src/org/commcare/views/widgets/MediaWidget.java", "diffHunk": "@@ -237,21 +235,12 @@ public void setBinaryData(Object binaryuri) {\n             }\n         }\n \n-        if (newMedia.exists()) {\n-            // Add the copy to the content provider", "originalCommit": "ce3eda49affec893200ab103d1affaeaf57f0c54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1OTYzMA==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r371759630", "bodyText": "Agree that we should not save it to content Providers. @ctsims we did remove it for Images sometime back in here, so guessing no objections in removing them for audio and videos as well.", "author": "shubham1g5", "createdAt": "2020-01-28T11:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczNjIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzMzA4Mw==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r372933083", "bodyText": "Totally agree that we should remove adding stuff to the content provider. That was old, weird ODK behavior that I think is harmful.", "author": "ctsims", "createdAt": "2020-01-30T12:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczNjIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczNjU2NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r371736565", "bodyText": "PS: Though, this change will only prevent crashes and won't change the earlier behaviour.", "author": "ShivamPokhriyal", "createdAt": "2020-01-28T11:01:55Z", "path": "app/src/org/commcare/views/widgets/MediaWidget.java", "diffHunk": "@@ -237,21 +235,12 @@ public void setBinaryData(Object binaryuri) {\n             }\n         }\n \n-        if (newMedia.exists()) {\n-            // Add the copy to the content provider", "originalCommit": "ce3eda49affec893200ab103d1affaeaf57f0c54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MDI5OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r371750299", "bodyText": "Thanks for looking at it as part of this work. Though if it isn't realted to Android 10 work, would be nice to separate this out in another PR so that it's easy to revert in case of any edge cases.", "author": "shubham1g5", "createdAt": "2020-01-28T11:35:26Z", "path": "app/src/org/commcare/utils/MediaUtil.java", "diffHunk": "@@ -414,7 +414,7 @@ private static int getApproxScaleDownFactor(int newWidth, int originalWidth) {\n         double widthScaleDownFactor =  (double)boundingWidth / originalWidth;\r\n         // Choosing the larger of the scale down factors, so that the image still fills the entire\r\n         // container\r\n-        double dominantScaleDownFactor = Math.max(widthScaleDownFactor, heightScaleDownFactor);\r\n+        double dominantScaleDownFactor = Math.min(widthScaleDownFactor, heightScaleDownFactor);\r", "originalCommit": "0b0e3927dcc27eae881a90f5b96e993e208b4fe4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1OTg1Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r371759856", "bodyText": "We should let the app crash in case of exceptions here if we are going to retain this functionality.", "author": "shubham1g5", "createdAt": "2020-01-28T11:57:51Z", "path": "app/src/org/commcare/views/widgets/MediaWidget.java", "diffHunk": "@@ -237,21 +235,12 @@ public void setBinaryData(Object binaryuri) {\n             }\n         }\n \n-        if (newMedia.exists()) {\n-            // Add the copy to the content provider\n-            ContentValues values = new ContentValues(6);\n-            values.put(MediaStore.Audio.Media.TITLE, newMedia.getName());\n-            values.put(MediaStore.Audio.Media.DISPLAY_NAME, newMedia.getName());\n-            values.put(MediaStore.Audio.Media.DATE_ADDED, System.currentTimeMillis());\n-            values.put(MediaStore.Audio.Media.DATA, newMedia.getAbsolutePath());\n-\n-            Uri mediaUri =\n-                    getContext().getContentResolver().insert(MediaStore.Audio.Media.EXTERNAL_CONTENT_URI, values);\n-            String mediaUriString = mediaUri == null ? \"null\" : mediaUri.toString();\n-            Log.i(TAG, \"Inserting media returned uri = \" + mediaUriString);\n+        try {\n+            FileUtil.addMediaToGallery(getContext(), newMedia);\n             showToast(\"form.attachment.success\");\n-        } else {\n+        } catch (Exception e) {", "originalCommit": "0b0e3927dcc27eae881a90f5b96e993e208b4fe4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce3eda49affec893200ab103d1affaeaf57f0c54", "url": "https://github.com/dimagi/commcare-android/commit/ce3eda49affec893200ab103d1affaeaf57f0c54", "message": "Fix a crash where we added video using MediaStore.Audio contentValues", "committedDate": "2020-01-28T10:56:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MTM3MQ==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r376971371", "bodyText": "Using SharedPreference to store this unique id. We can also choose to create a text file and store UUID to that file. I'm not sure which option is more suitable of the two so using the sharedpreferences approach here.", "author": "ShivamPokhriyal", "createdAt": "2020-02-10T10:14:59Z", "path": "app/src/org/commcare/utils/DeviceIdentifier.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package org.commcare.utils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import androidx.preference.PreferenceManager;\n+import java.util.UUID;\n+\n+/**\n+ * A Utility to get a unique identifier for app's installation.\n+ * @author $|-|!\u02c5@M\n+ */\n+public final class DeviceIdentifier {\n+\n+    private static volatile String uuid;\n+    private static final String PREFIX = \"commcare_\";\n+    private static final String KEY_DEVICE_IDENTIFIER = \"commcare_device_id\";\n+\n+    /**\n+     * Returns a unique(very highly likely) identifier for this device.\n+     * This identifier is prefixed with \"commcare_\"\n+     *\n+     * This id may change when user re-installs the app or does a factory reset.\n+     */\n+    public static String getDeviceIdentifier(Context context) {\n+        if (uuid == null) {\n+            synchronized (DeviceIdentifier.class) {\n+                if (uuid == null) {\n+                    SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(context);", "originalCommit": "78fef8f0b4788e2dd6b5b650083dea2aa454ef6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91a7ebebf14177c629a6e3025abf01b8c654047c", "url": "https://github.com/dimagi/commcare-android/commit/91a7ebebf14177c629a6e3025abf01b8c654047c", "message": "Update compile and target sdk version to 29", "committedDate": "2020-02-14T12:43:45Z", "type": "commit"}, {"oid": "765d2145c1cccd8783e54139123b2464c086425f", "url": "https://github.com/dimagi/commcare-android/commit/765d2145c1cccd8783e54139123b2464c086425f", "message": "Deprecate getting phone IMEI since it gives SecurityException", "committedDate": "2020-02-14T12:43:45Z", "type": "commit"}, {"oid": "c5c5930378fcaa656206daaaa79771760e2d4f95", "url": "https://github.com/dimagi/commcare-android/commit/c5c5930378fcaa656206daaaa79771760e2d4f95", "message": "Temporarily opt-out of scoped storage till we add full support", "committedDate": "2020-02-14T12:43:45Z", "type": "commit"}, {"oid": "572ad9f18b9d3bd11802dec523136e57dd11e919", "url": "https://github.com/dimagi/commcare-android/commit/572ad9f18b9d3bd11802dec523136e57dd11e919", "message": "Fix a crash where we added video using MediaStore.Audio contentValues", "committedDate": "2020-02-14T12:43:45Z", "type": "commit"}, {"oid": "c8f22b98c4a8dd174f5a35ef5a843ce7f3acc76f", "url": "https://github.com/dimagi/commcare-android/commit/c8f22b98c4a8dd174f5a35ef5a843ce7f3acc76f", "message": "Use random UUID as a unique device identifier", "committedDate": "2020-02-14T12:43:45Z", "type": "commit"}, {"oid": "26a3e8cf05df4a52e6bd43463e33347537b5e742", "url": "https://github.com/dimagi/commcare-android/commit/26a3e8cf05df4a52e6bd43463e33347537b5e742", "message": "Use androidX PreferenceManager\n\nandroid.preference.PreferenceManager is deprecated in API level 29 so updating to the androidX implementation", "committedDate": "2020-02-14T12:43:45Z", "type": "commit"}, {"oid": "a2907d6428e80be71c5ed65ded47a0ea412cd544", "url": "https://github.com/dimagi/commcare-android/commit/a2907d6428e80be71c5ed65ded47a0ea412cd544", "message": "Fix failing tests by hardcoding deviceId", "committedDate": "2020-02-14T12:43:45Z", "type": "commit"}, {"oid": "a2907d6428e80be71c5ed65ded47a0ea412cd544", "url": "https://github.com/dimagi/commcare-android/commit/a2907d6428e80be71c5ed65ded47a0ea412cd544", "message": "Fix failing tests by hardcoding deviceId", "committedDate": "2020-02-14T12:43:45Z", "type": "forcePushed"}, {"oid": "e204cda43f56302be8fb968e0f9f6528feaeb127", "url": "https://github.com/dimagi/commcare-android/commit/e204cda43f56302be8fb968e0f9f6528feaeb127", "message": "Add soft assert logs where external storage directory is used", "committedDate": "2020-02-16T13:42:35Z", "type": "commit"}, {"oid": "614e927891fab52212ee364e453fbc0548af9633", "url": "https://github.com/dimagi/commcare-android/commit/614e927891fab52212ee364e453fbc0548af9633", "message": "Remove saving redundant media to content providers", "committedDate": "2020-02-17T06:36:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcyNjAzMA==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r383726030", "bodyText": "It seems like this path will definitely get hit if someone is using this functionality. So there is no point in adding soft assert here and we will likely need to disable this functionality in Android 11 if there is no other alternate provided in Android 11 for file searching.", "author": "shubham1g5", "createdAt": "2020-02-25T08:35:59Z", "path": "app/src/org/commcare/activities/MultimediaInflaterActivity.java", "diffHunk": "@@ -162,6 +164,7 @@ private void searchForDefault() {\n \r\n         if (Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState()) ||\r\n                 Environment.MEDIA_MOUNTED_READ_ONLY.equals(Environment.getExternalStorageState())) {\r\n+            Logger.log(LogTypes.SOFT_ASSERT, \"Access outside scoped storage in searching zip file\");\r", "originalCommit": "614e927891fab52212ee364e453fbc0548af9633", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcyNjQzOA==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r383726438", "bodyText": "We can remove this soft assert as well as this path will definitely get hit for someone using this functionality,", "author": "shubham1g5", "createdAt": "2020-02-25T08:36:45Z", "path": "app/src/org/commcare/recovery/measures/ScanCczTask.java", "diffHunk": "@@ -94,6 +96,7 @@ private void locateAppCcz(File[] files, int depth) {\n         if (!StringUtils.isEmpty(lastKnownCczLocation)) {\n             filePathsToScan.add(new File(lastKnownCczLocation));\n         }\n+        Logger.log(LogTypes.SOFT_ASSERT, \"Access outside scoped storage in scanning cczs.\");", "originalCommit": "614e927891fab52212ee364e453fbc0548af9633", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcyODE0Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r383728142", "bodyText": "there are 2 nested if here with uuid == null check. Is there a particular reason behind that ?", "author": "shubham1g5", "createdAt": "2020-02-25T08:40:11Z", "path": "app/src/org/commcare/utils/DeviceIdentifier.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package org.commcare.utils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import androidx.preference.PreferenceManager;\n+import java.util.UUID;\n+\n+/**\n+ * A Utility to get a unique identifier for app's installation.\n+ * @author $|-|!\u02c5@M\n+ */\n+public final class DeviceIdentifier {\n+\n+    private static volatile String uuid;\n+    private static final String PREFIX = \"commcare_\";\n+    private static final String KEY_DEVICE_IDENTIFIER = \"commcare_device_id\";\n+\n+    /**\n+     * Returns a unique(very highly likely) identifier for this device.\n+     * This identifier is prefixed with \"commcare_\"\n+     *\n+     * This id may change when user re-installs the app or does a factory reset.\n+     */\n+    public static String getDeviceIdentifier(Context context) {\n+        if (uuid == null) {", "originalCommit": "614e927891fab52212ee364e453fbc0548af9633", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc2NDE0NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r383764145", "bodyText": "Yeah, this pattern is also popular as double-checked locking idiom, used to reduce the overhead of acquiring a lock by first testing the locking criterion without actually acquiring the lock.", "author": "ShivamPokhriyal", "createdAt": "2020-02-25T09:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcyODE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc3OTEyOQ==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r383779129", "bodyText": "Interesting!", "author": "shubham1g5", "createdAt": "2020-02-25T10:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcyODE0Mg=="}], "type": "inlineReview"}, {"oid": "0229a29967de8a0d643f48cb331ab80b5d1a3210", "url": "https://github.com/dimagi/commcare-android/commit/0229a29967de8a0d643f48cb331ab80b5d1a3210", "message": "Remove soft asserts from paths that will definitely get hit", "committedDate": "2020-02-25T09:47:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc4MTE3MQ==", "url": "https://github.com/dimagi/commcare-android/pull/2176#discussion_r383781171", "bodyText": "@ctsims  Goint to merge this to go ahead with code freeze though can you review this class and see the device identifier makes sense to you.", "author": "shubham1g5", "createdAt": "2020-02-25T10:12:18Z", "path": "app/src/org/commcare/utils/DeviceIdentifier.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package org.commcare.utils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import androidx.preference.PreferenceManager;\n+import java.util.UUID;\n+\n+/**\n+ * A Utility to get a unique identifier for app's installation.\n+ * @author $|-|!\u02c5@M\n+ */\n+public final class DeviceIdentifier {", "originalCommit": "0229a29967de8a0d643f48cb331ab80b5d1a3210", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}