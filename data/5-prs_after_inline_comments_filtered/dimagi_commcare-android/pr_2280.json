{"pr_number": 2280, "pr_title": "Adds support for tiered lists and barcode scan in Case Claim prompts", "pr_createdAt": "2020-06-18T11:38:41Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2280", "timeline": [{"oid": "3688e4c92932dac8d996550a3b1571331125c91f", "url": "https://github.com/dimagi/commcare-android/commit/3688e4c92932dac8d996550a3b1571331125c91f", "message": "added todo", "committedDate": "2020-05-28T09:14:49Z", "type": "commit"}, {"oid": "b6765abeaaca4ff9297b6dde38a63c7fb6a10f28", "url": "https://github.com/dimagi/commcare-android/commit/b6765abeaaca4ff9297b6dde38a63c7fb6a10f28", "message": "adds scanner button", "committedDate": "2020-05-28T12:48:26Z", "type": "commit"}, {"oid": "aff9adcffe8f2cec59de1c24a06b96558e26b2ae", "url": "https://github.com/dimagi/commcare-android/commit/aff9adcffe8f2cec59de1c24a06b96558e26b2ae", "message": "Adds barcode intent", "committedDate": "2020-05-28T16:22:26Z", "type": "commit"}, {"oid": "9f8285c7a0d8567752c332cc10cdead6e6e386b1", "url": "https://github.com/dimagi/commcare-android/commit/9f8285c7a0d8567752c332cc10cdead6e6e386b1", "message": "Merge branch 'master' into caseClaim", "committedDate": "2020-05-31T13:56:45Z", "type": "commit"}, {"oid": "41aa290ba6c256c7c926c8badf6966f2a0b5c086", "url": "https://github.com/dimagi/commcare-android/commit/41aa290ba6c256c7c926c8badf6966f2a0b5c086", "message": "Toggle barcode visibility based on appearance for queryprompt", "committedDate": "2020-06-01T10:18:57Z", "type": "commit"}, {"oid": "45a43b5b67ea8af3f92e03a28ab5716899f7bcb0", "url": "https://github.com/dimagi/commcare-android/commit/45a43b5b67ea8af3f92e03a28ab5716899f7bcb0", "message": "Merge branch 'master' into caseClaim", "committedDate": "2020-06-01T10:30:45Z", "type": "commit"}, {"oid": "4426d8ae106c6f52016f9c49965c917c18465020", "url": "https://github.com/dimagi/commcare-android/commit/4426d8ae106c6f52016f9c49965c917c18465020", "message": "Layout fixes", "committedDate": "2020-06-03T18:52:20Z", "type": "commit"}, {"oid": "e445ccf35f67917c7fa72518177e734d5d89b052", "url": "https://github.com/dimagi/commcare-android/commit/e445ccf35f67917c7fa72518177e734d5d89b052", "message": "compact layout to make space for search results", "committedDate": "2020-06-03T19:13:39Z", "type": "commit"}, {"oid": "f2cecd0ce5f0abd4da477f131f554d7926a8664d", "url": "https://github.com/dimagi/commcare-android/commit/f2cecd0ce5f0abd4da477f131f554d7926a8664d", "message": "Populates spinner choice items - basic version", "committedDate": "2020-06-14T12:59:42Z", "type": "commit"}, {"oid": "39c3187a3a5dd7761bcf1e8d705a898073a86a4f", "url": "https://github.com/dimagi/commcare-android/commit/39c3187a3a5dd7761bcf1e8d705a898073a86a4f", "message": "Merge branch 'master' into caseClaim", "committedDate": "2020-06-18T03:06:49Z", "type": "commit"}, {"oid": "0544118defacdaffa7f5edcce22c9d0339a5babd", "url": "https://github.com/dimagi/commcare-android/commit/0544118defacdaffa7f5edcce22c9d0339a5babd", "message": "Adds refresh for tiered dropdowns", "committedDate": "2020-06-18T10:05:39Z", "type": "commit"}, {"oid": "13059b1cb18e067a7fdb61d6a7bb5065ff1f9307", "url": "https://github.com/dimagi/commcare-android/commit/13059b1cb18e067a7fdb61d6a7bb5065ff1f9307", "message": "layout changes", "committedDate": "2020-06-18T10:41:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI5OTEzOA==", "url": "https://github.com/dimagi/commcare-android/pull/2280#discussion_r442299138", "bodyText": "Does this handle blank entries effectively? It was unclear from the UI and I can't quite tell from the code how easy it is to \"undo\" entering a value into the spinner at all (which we definitely want to support)", "author": "ctsims", "createdAt": "2020-06-18T15:07:59Z", "path": "app/src/org/commcare/activities/QueryRequestActivity.java", "diffHunk": "@@ -116,56 +132,176 @@ private void buildPromptUI() {\n     }\n \n     private void buildPromptEntry(LinearLayout promptsLayout, String promptId,\n-                                  DisplayUnit displayUnit, boolean isLastPrompt) {\n+                                  QueryPrompt queryPrompt, boolean isLastPrompt) {\n         Hashtable<String, String> userAnswers =\n                 remoteQuerySessionManager.getUserAnswers();\n-        promptsLayout.addView(createPromptMedia(displayUnit));\n \n-        EditText promptEditText = new EditText(this);\n+        View promptView = LayoutInflater.from(this).inflate(R.layout.query_prompt_layout, promptsLayout, false);\n+        setLabelText(promptView, queryPrompt.getDisplay());\n+        View inputView;\n+        String input = queryPrompt.getInput();\n+        if (input != null && input.contentEquals(SELECT1)) {\n+            inputView = setUpSpinnerView(promptView, queryPrompt, userAnswers);\n+        } else {\n+            inputView = setUpEditTextView(promptView, queryPrompt, promptId, userAnswers, isLastPrompt);\n+        }\n+        setUpBarCodeScanButton(promptView, promptId, queryPrompt);\n+\n+        promptsLayout.addView(promptView);\n+        promptsBoxes.put(promptId, inputView);\n+    }\n+\n+    private void setUpBarCodeScanButton(View promptView, String promptId, QueryPrompt queryPrompt) {\n+        ImageView barcodeScannerView = promptView.findViewById(R.id.barcode_scanner);\n+        barcodeScannerView.setVisibility(isBarcodeEnabled(queryPrompt) ? View.VISIBLE : View.INVISIBLE);\n+        barcodeScannerView.setTag(promptId);\n+        barcodeScannerView.setOnClickListener(v ->\n+                callBarcodeScanIntent((String)v.getTag())\n+        );\n+    }\n+\n+    private Spinner setUpSpinnerView(View promptView, QueryPrompt queryPrompt,\n+                                     Hashtable<String, String> userAnswers) {\n+        Spinner promptSpinner = promptView.findViewById(R.id.prompt_spinner);\n+        promptSpinner.setVisibility(View.VISIBLE);\n+        promptView.findViewById(R.id.prompt_et).setVisibility(View.GONE);\n+\n+        promptSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {\n+            @Override\n+            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {\n+                Vector<SelectChoice> choices = queryPrompt.getItemsetBinding().getChoices();\n+                SelectChoice selectChoice = choices.get(position);\n+                String oldAnswer = userAnswers.get(queryPrompt.getKey());\n+                if(oldAnswer == null || !oldAnswer.contentEquals(selectChoice.getValue())) {\n+                    remoteQuerySessionManager.answerUserPrompt(queryPrompt.getKey(), selectChoice.getValue());\n+                    refreshUI();\n+                }\n+            }\n+\n+            @Override\n+            public void onNothingSelected(AdapterView<?> parent) {\n+\n+            }\n+        });\n+\n+        setSpinnerData(userAnswers, queryPrompt, promptSpinner);\n+        return promptSpinner;\n+    }\n+\n+    private void setSpinnerData(Hashtable<String, String> userAnswers, QueryPrompt queryPrompt, Spinner promptSpinner) {\n+        remoteQuerySessionManager.populateItemSetChoices(queryPrompt);\n+        Vector<SelectChoice> items = queryPrompt.getItemsetBinding().getChoices();\n+        String answer = userAnswers.get(queryPrompt.getKey());\n+        String[] choices = new String[items.size()];\n+        int selectedPosition = -1;\n+        for (int i = 0; i < items.size(); i++) {\n+            SelectChoice item = items.get(i);\n+            choices[i] = item.getLabelInnerText();\n+            if(item.getValue().equals(answer)){\n+                selectedPosition = i;\n+            }\n+        }\n+\n+        ArrayAdapter<String> adapter = new ArrayAdapter<>(this, android.R.layout.simple_spinner_item, choices);\n+        promptSpinner.setAdapter(adapter);\n+        if(selectedPosition != -1) {\n+            promptSpinner.setSelection(selectedPosition);", "originalCommit": "13059b1cb18e067a7fdb61d6a7bb5065ff1f9307", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxMjY0NA==", "url": "https://github.com/dimagi/commcare-android/pull/2280#discussion_r442312644", "bodyText": "Does this trigger a \"selection changed\" event at all, or is it only in like 208 that this gets processed?", "author": "ctsims", "createdAt": "2020-06-18T15:27:28Z", "path": "app/src/org/commcare/activities/QueryRequestActivity.java", "diffHunk": "@@ -116,56 +132,176 @@ private void buildPromptUI() {\n     }\n \n     private void buildPromptEntry(LinearLayout promptsLayout, String promptId,\n-                                  DisplayUnit displayUnit, boolean isLastPrompt) {\n+                                  QueryPrompt queryPrompt, boolean isLastPrompt) {\n         Hashtable<String, String> userAnswers =\n                 remoteQuerySessionManager.getUserAnswers();\n-        promptsLayout.addView(createPromptMedia(displayUnit));\n \n-        EditText promptEditText = new EditText(this);\n+        View promptView = LayoutInflater.from(this).inflate(R.layout.query_prompt_layout, promptsLayout, false);\n+        setLabelText(promptView, queryPrompt.getDisplay());\n+        View inputView;\n+        String input = queryPrompt.getInput();\n+        if (input != null && input.contentEquals(SELECT1)) {\n+            inputView = setUpSpinnerView(promptView, queryPrompt, userAnswers);\n+        } else {\n+            inputView = setUpEditTextView(promptView, queryPrompt, promptId, userAnswers, isLastPrompt);\n+        }\n+        setUpBarCodeScanButton(promptView, promptId, queryPrompt);\n+\n+        promptsLayout.addView(promptView);\n+        promptsBoxes.put(promptId, inputView);\n+    }\n+\n+    private void setUpBarCodeScanButton(View promptView, String promptId, QueryPrompt queryPrompt) {\n+        ImageView barcodeScannerView = promptView.findViewById(R.id.barcode_scanner);\n+        barcodeScannerView.setVisibility(isBarcodeEnabled(queryPrompt) ? View.VISIBLE : View.INVISIBLE);\n+        barcodeScannerView.setTag(promptId);\n+        barcodeScannerView.setOnClickListener(v ->\n+                callBarcodeScanIntent((String)v.getTag())\n+        );\n+    }\n+\n+    private Spinner setUpSpinnerView(View promptView, QueryPrompt queryPrompt,\n+                                     Hashtable<String, String> userAnswers) {\n+        Spinner promptSpinner = promptView.findViewById(R.id.prompt_spinner);\n+        promptSpinner.setVisibility(View.VISIBLE);\n+        promptView.findViewById(R.id.prompt_et).setVisibility(View.GONE);\n+\n+        promptSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {\n+            @Override\n+            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {\n+                Vector<SelectChoice> choices = queryPrompt.getItemsetBinding().getChoices();\n+                SelectChoice selectChoice = choices.get(position);\n+                String oldAnswer = userAnswers.get(queryPrompt.getKey());\n+                if(oldAnswer == null || !oldAnswer.contentEquals(selectChoice.getValue())) {\n+                    remoteQuerySessionManager.answerUserPrompt(queryPrompt.getKey(), selectChoice.getValue());\n+                    refreshUI();\n+                }\n+            }\n+\n+            @Override\n+            public void onNothingSelected(AdapterView<?> parent) {\n+\n+            }\n+        });\n+\n+        setSpinnerData(userAnswers, queryPrompt, promptSpinner);\n+        return promptSpinner;\n+    }\n+\n+    private void setSpinnerData(Hashtable<String, String> userAnswers, QueryPrompt queryPrompt, Spinner promptSpinner) {\n+        remoteQuerySessionManager.populateItemSetChoices(queryPrompt);\n+        Vector<SelectChoice> items = queryPrompt.getItemsetBinding().getChoices();\n+        String answer = userAnswers.get(queryPrompt.getKey());\n+        String[] choices = new String[items.size()];\n+        int selectedPosition = -1;\n+        for (int i = 0; i < items.size(); i++) {\n+            SelectChoice item = items.get(i);\n+            choices[i] = item.getLabelInnerText();\n+            if(item.getValue().equals(answer)){\n+                selectedPosition = i;\n+            }\n+        }\n+\n+        ArrayAdapter<String> adapter = new ArrayAdapter<>(this, android.R.layout.simple_spinner_item, choices);\n+        promptSpinner.setAdapter(adapter);", "originalCommit": "13059b1cb18e067a7fdb61d6a7bb5065ff1f9307", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxNDExNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2280#discussion_r442314115", "bodyText": "Am I right in assuming that it's this event loop that propagates out of order changes?\nIE: If this spinner view is the last item in the 213 loop, and its value is changed on 208, this selected method is fired, and the loop is redone in case a previous spinner needs to be changed?", "author": "ctsims", "createdAt": "2020-06-18T15:29:39Z", "path": "app/src/org/commcare/activities/QueryRequestActivity.java", "diffHunk": "@@ -116,56 +132,176 @@ private void buildPromptUI() {\n     }\n \n     private void buildPromptEntry(LinearLayout promptsLayout, String promptId,\n-                                  DisplayUnit displayUnit, boolean isLastPrompt) {\n+                                  QueryPrompt queryPrompt, boolean isLastPrompt) {\n         Hashtable<String, String> userAnswers =\n                 remoteQuerySessionManager.getUserAnswers();\n-        promptsLayout.addView(createPromptMedia(displayUnit));\n \n-        EditText promptEditText = new EditText(this);\n+        View promptView = LayoutInflater.from(this).inflate(R.layout.query_prompt_layout, promptsLayout, false);\n+        setLabelText(promptView, queryPrompt.getDisplay());\n+        View inputView;\n+        String input = queryPrompt.getInput();\n+        if (input != null && input.contentEquals(SELECT1)) {\n+            inputView = setUpSpinnerView(promptView, queryPrompt, userAnswers);\n+        } else {\n+            inputView = setUpEditTextView(promptView, queryPrompt, promptId, userAnswers, isLastPrompt);\n+        }\n+        setUpBarCodeScanButton(promptView, promptId, queryPrompt);\n+\n+        promptsLayout.addView(promptView);\n+        promptsBoxes.put(promptId, inputView);\n+    }\n+\n+    private void setUpBarCodeScanButton(View promptView, String promptId, QueryPrompt queryPrompt) {\n+        ImageView barcodeScannerView = promptView.findViewById(R.id.barcode_scanner);\n+        barcodeScannerView.setVisibility(isBarcodeEnabled(queryPrompt) ? View.VISIBLE : View.INVISIBLE);\n+        barcodeScannerView.setTag(promptId);\n+        barcodeScannerView.setOnClickListener(v ->\n+                callBarcodeScanIntent((String)v.getTag())\n+        );\n+    }\n+\n+    private Spinner setUpSpinnerView(View promptView, QueryPrompt queryPrompt,\n+                                     Hashtable<String, String> userAnswers) {\n+        Spinner promptSpinner = promptView.findViewById(R.id.prompt_spinner);\n+        promptSpinner.setVisibility(View.VISIBLE);\n+        promptView.findViewById(R.id.prompt_et).setVisibility(View.GONE);\n+\n+        promptSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {\n+            @Override\n+            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {\n+                Vector<SelectChoice> choices = queryPrompt.getItemsetBinding().getChoices();\n+                SelectChoice selectChoice = choices.get(position);\n+                String oldAnswer = userAnswers.get(queryPrompt.getKey());\n+                if(oldAnswer == null || !oldAnswer.contentEquals(selectChoice.getValue())) {", "originalCommit": "13059b1cb18e067a7fdb61d6a7bb5065ff1f9307", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7947f2ec0e5a3ce632220513f7f43ac02c28f8a8", "url": "https://github.com/dimagi/commcare-android/commit/7947f2ec0e5a3ce632220513f7f43ac02c28f8a8", "message": "adds an empty choice in spinners to provide users with a way to clear the answer", "committedDate": "2020-07-16T12:13:06Z", "type": "commit"}, {"oid": "fb7a7bcd8c6549fb78e4bb93be6e90190eedd897", "url": "https://github.com/dimagi/commcare-android/commit/fb7a7bcd8c6549fb78e4bb93be6e90190eedd897", "message": "delegates item set changes to remoteQuerySessionManager.refreshItemSetChoices", "committedDate": "2020-07-20T17:05:51Z", "type": "commit"}, {"oid": "b023b34c570837e46800655b7af8d44505dd5c78", "url": "https://github.com/dimagi/commcare-android/commit/b023b34c570837e46800655b7af8d44505dd5c78", "message": "Saves edittexts answer in listener rather than when making a query to keep the answer set always updated", "committedDate": "2020-07-20T19:26:23Z", "type": "commit"}, {"oid": "87a179ce5a14abb5755f24eacd83fad98a8c8211", "url": "https://github.com/dimagi/commcare-android/commit/87a179ce5a14abb5755f24eacd83fad98a8c8211", "message": "Merge branch 'master' into caseClaim", "committedDate": "2020-08-30T13:10:39Z", "type": "commit"}, {"oid": "b6c06381039cb2a9c4e3e6f0b9273e34d77c8b67", "url": "https://github.com/dimagi/commcare-android/commit/b6c06381039cb2a9c4e3e6f0b9273e34d77c8b67", "message": "update itemset on non select changes", "committedDate": "2020-08-30T17:42:17Z", "type": "commit"}, {"oid": "f0e7cd75ebdf9bedf25706e1e68134d1a3de4938", "url": "https://github.com/dimagi/commcare-android/commit/f0e7cd75ebdf9bedf25706e1e68134d1a3de4938", "message": "test fixes", "committedDate": "2020-08-31T08:26:26Z", "type": "commit"}, {"oid": "7a1c6d6d6236dafbb27b1bd8472126e0bb6e24cc", "url": "https://github.com/dimagi/commcare-android/commit/7a1c6d6d6236dafbb27b1bd8472126e0bb6e24cc", "message": "Correctly restores state on config changes", "committedDate": "2020-08-31T08:34:11Z", "type": "commit"}, {"oid": "10d147c8a27af53cbe0e00489df3e847304cf18f", "url": "https://github.com/dimagi/commcare-android/commit/10d147c8a27af53cbe0e00489df3e847304cf18f", "message": "test fixes along with fix for error persistence across config changes", "committedDate": "2020-08-31T08:47:18Z", "type": "commit"}, {"oid": "14e4f1d5e2174bb0bc31bef54ca1d4c135069d79", "url": "https://github.com/dimagi/commcare-android/commit/14e4f1d5e2174bb0bc31bef54ca1d4c135069d79", "message": "Fixes spinner state on config changes", "committedDate": "2020-08-31T10:47:54Z", "type": "commit"}, {"oid": "70528999b8b2fbde83abdac39a273947040b869e", "url": "https://github.com/dimagi/commcare-android/commit/70528999b8b2fbde83abdac39a273947040b869e", "message": "DRYing tests", "committedDate": "2020-08-31T11:09:58Z", "type": "commit"}, {"oid": "eb334d0df957662317b1244f7caab81fa92dbc30", "url": "https://github.com/dimagi/commcare-android/commit/eb334d0df957662317b1244f7caab81fa92dbc30", "message": "Correct url checking with params", "committedDate": "2020-08-31T11:25:17Z", "type": "commit"}, {"oid": "5df62c9a605f2c044772cf958e2babc98fc8c4ff", "url": "https://github.com/dimagi/commcare-android/commit/5df62c9a605f2c044772cf958e2babc98fc8c4ff", "message": "Install fixtures in case claim test", "committedDate": "2020-08-31T11:51:08Z", "type": "commit"}, {"oid": "aa1755dd00d9ad21400451dc24da483c2df4305b", "url": "https://github.com/dimagi/commcare-android/commit/aa1755dd00d9ad21400451dc24da483c2df4305b", "message": "Test dropdown filtering", "committedDate": "2020-08-31T12:29:36Z", "type": "commit"}, {"oid": "a9b40f674aa069a810c2e8d955c1c1602c3e3bd9", "url": "https://github.com/dimagi/commcare-android/commit/a9b40f674aa069a810c2e8d955c1c1602c3e3bd9", "message": "Merge branch 'master' into caseClaim", "committedDate": "2020-09-09T06:11:19Z", "type": "commit"}]}