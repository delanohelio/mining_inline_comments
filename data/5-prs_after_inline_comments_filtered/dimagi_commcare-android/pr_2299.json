{"pr_number": 2299, "pr_title": "Add more tests from calabash to espresso", "pr_createdAt": "2020-07-28T10:55:28Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2299", "timeline": [{"oid": "fd4743ac0a70838deed97c62c82ffea439ce537e", "url": "https://github.com/dimagi/commcare-android/commit/fd4743ac0a70838deed97c62c82ffea439ce537e", "message": "Remove assertion", "committedDate": "2020-08-06T04:57:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4MDMwMg==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469080302", "bodyText": "nit: we should abstract these matcher functions into their own class.", "author": "shubham1g5", "createdAt": "2020-08-12T08:06:30Z", "path": "app/instrumentation-tests/src/org/commcare/utils/InstrumentationUtility.java", "diffHunk": "@@ -211,6 +234,80 @@ public void describeTo(Description description) {\n         };\n     }\n \n+    /**\n+     * Matches the listView item count with the @param size\n+     * Note: Only works for listview.\n+     */\n+    public static Matcher<View> matchListSize(int size) {", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "afd02a0aa163534a1643c44dc923415e5801e021", "url": "https://github.com/dimagi/commcare-android/commit/afd02a0aa163534a1643c44dc923415e5801e021", "message": "Add tests for form submission errors", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "b088fe79ea5d76a5a16049d46ace4f54f141206d", "url": "https://github.com/dimagi/commcare-android/commit/b088fe79ea5d76a5a16049d46ace4f54f141206d", "message": "Add tests for app update", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "c283f3f4eca5a63f8ddea523bdaabbc0bc3a51c3", "url": "https://github.com/dimagi/commcare-android/commit/c283f3f4eca5a63f8ddea523bdaabbc0bc3a51c3", "message": "Add tests for app installation using app list", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "a39bc90f7056d099715ce05935b1e5782e722c10", "url": "https://github.com/dimagi/commcare-android/commit/a39bc90f7056d099715ce05935b1e5782e722c10", "message": "Enable network logging in browserstack", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "598e5fb63c36c5cb6a2a40ffde74860ef786c3bd", "url": "https://github.com/dimagi/commcare-android/commit/598e5fb63c36c5cb6a2a40ffde74860ef786c3bd", "message": "Get current activity from test application", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "f6644830726c833c12485b0977330cd5cdd8da2e", "url": "https://github.com/dimagi/commcare-android/commit/f6644830726c833c12485b0977330cd5cdd8da2e", "message": "Remove assertion", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "23918cb4741f32c095354f87c28813f23073e296", "url": "https://github.com/dimagi/commcare-android/commit/23918cb4741f32c095354f87c28813f23073e296", "message": "Workaround for kotlin.assert method not found", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "fb840bf98426123c74d69f780eb39217b47ee7d3", "url": "https://github.com/dimagi/commcare-android/commit/fb840bf98426123c74d69f780eb39217b47ee7d3", "message": "Add tests for lookup table sync", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "f97a1daec88862a640e3ab0d65831ef7dc4bd855", "url": "https://github.com/dimagi/commcare-android/commit/f97a1daec88862a640e3ab0d65831ef7dc4bd855", "message": "Add tests for Sync Recovery", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "faf3f426277eb65e1d843f6f6111038867dc6db1", "url": "https://github.com/dimagi/commcare-android/commit/faf3f426277eb65e1d843f6f6111038867dc6db1", "message": "Use sendBroadcastSync in asyncRestore tests", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "c0baec916e2ba4c33a0fc0bf5cb8dec6f9a56f2a", "url": "https://github.com/dimagi/commcare-android/commit/c0baec916e2ba4c33a0fc0bf5cb8dec6f9a56f2a", "message": "Add proguard rule for sendBroadcastSync", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "005ed46a496f15e5adf242867c173420646887e2", "url": "https://github.com/dimagi/commcare-android/commit/005ed46a496f15e5adf242867c173420646887e2", "message": "Use custom assert method", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "4fa9bde15b4c13252ff605f8c04395f1dbd6646a", "url": "https://github.com/dimagi/commcare-android/commit/4fa9bde15b4c13252ff605f8c04395f1dbd6646a", "message": "Add suggested changes", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "7e1430a332ba710f9d88f90c77880852e4b80e65", "url": "https://github.com/dimagi/commcare-android/commit/7e1430a332ba710f9d88f90c77880852e4b80e65", "message": "Add more suggested changes", "committedDate": "2020-08-21T13:57:33Z", "type": "commit"}, {"oid": "7e1430a332ba710f9d88f90c77880852e4b80e65", "url": "https://github.com/dimagi/commcare-android/commit/7e1430a332ba710f9d88f90c77880852e4b80e65", "message": "Add more suggested changes", "committedDate": "2020-08-21T13:57:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1NzIwNA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475057204", "bodyText": "Can't we use SyncDetailCalculations.getLastSyncTime directly ?", "author": "shubham1g5", "createdAt": "2020-08-22T07:10:07Z", "path": "app/instrumentation-tests/src/org/commcare/CommCareInstrumentationTestApplication.java", "diffHunk": "@@ -64,6 +65,11 @@ public void onActivityDestroyed(@NonNull Activity activity) {\n     public Activity getCurrentActivity() {\n         return currentActivity;\n     }\n-    \n \n+    public static long getLastSyncTime(String userName) {", "originalCommit": "7e1430a332ba710f9d88f90c77880852e4b80e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2MDE1Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475060156", "bodyText": "Nice, Didn't know it existed.", "author": "ShivamPokhriyal", "createdAt": "2020-08-22T07:47:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1NzIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODIyOA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475058228", "bodyText": "does this method throw an exception if it's called on api >= Q", "author": "shubham1g5", "createdAt": "2020-08-22T07:23:26Z", "path": "app/instrumentation-tests/src/org/commcare/utils/InstrumentationUtility.java", "diffHunk": "@@ -188,27 +215,59 @@ public void perform(UiController uiController, final View view) {\n     }\n \n     /**\n-     * In case a view contains more than 1 items of same type,\n-     * use this to select the item at @param position.\n-     * NOTE:- position is 1 based.\n+     * Matches total occurrences of child inside parent with count.\n      */\n-    public static <T> Matcher<T> find(Matcher<T> matcher, int position) {\n-        return new BaseMatcher<T>() {\n-            int count = 0;\n-            @Override\n-            public boolean matches(Object item) {\n-                if (matcher.matches(item)) {\n-                    count++;\n-                    return count == position;\n-                }\n-                return false;\n-            }\n+    public static void matchChildCount(Class<?> parent, Class<?> child, int count) {\n+        onView(withClassName(is(parent.getCanonicalName())))\n+                .check(matches(\n+                        CustomMatchers.withChildViewCount(count,\n+                                withClassName(is(child.getCanonicalName())))\n+                ));\n+    }\n \n-            @Override\n-            public void describeTo(Description description) {\n-                description.appendText(\"will return \" + position + \" matching item\");\n-            }\n-        };\n+    /**\n+     * Returns the count of total number of items present in the listView.\n+     * @param resId Resource reference to the list.\n+     */\n+    public static int getListSize(@IdRes int resId) {\n+        CommCareInstrumentationTestApplication application =\n+                (CommCareInstrumentationTestApplication) InstrumentationRegistry\n+                        .getInstrumentation()\n+                        .getTargetContext()\n+                        .getApplicationContext();\n+        Activity activity = application.getCurrentActivity();\n+        ListView listView = activity.findViewById(resId);\n+        return listView.getAdapter().getCount();\n+    }\n+\n+    /**\n+     * This method will toggle the wifi state in mobile.\n+     * Starting with Android Q, applications are not allowed to enable/disable Wi-Fi.\n+     */\n+    public static void changeWifi(boolean enable) {", "originalCommit": "7e1430a332ba710f9d88f90c77880852e4b80e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2MDM4MQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475060381", "bodyText": "Not sure, perhaps it doesn't give an exception(at least that's what the docs seems to hint).", "author": "ShivamPokhriyal", "createdAt": "2020-08-22T07:50:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxNTM4OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475215389", "bodyText": "I see, we should throw an error ourselves in that case so that we fail clearly and explicitly and avoid future confusions in case someone decides to run these tests on > Q device.", "author": "shubham1g5", "createdAt": "2020-08-23T12:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODIyOA=="}], "type": "inlineReview"}, {"oid": "ead53ca41a35a2c22cb824d1a21f92409a235b34", "url": "https://github.com/dimagi/commcare-android/commit/ead53ca41a35a2c22cb824d1a21f92409a235b34", "message": "Fix import of package level function", "committedDate": "2020-08-22T11:52:05Z", "type": "commit"}, {"oid": "3b66bc54a68239ae380da2a14bf1f1ebb7eac109", "url": "https://github.com/dimagi/commcare-android/commit/3b66bc54a68239ae380da2a14bf1f1ebb7eac109", "message": "Fix InstallFromListTest and Use getLastSyncTime directly", "committedDate": "2020-08-22T15:13:46Z", "type": "commit"}, {"oid": "e4e13e7bb02b7dae5b85453a230c8bdb01f14fa5", "url": "https://github.com/dimagi/commcare-android/commit/e4e13e7bb02b7dae5b85453a230c8bdb01f14fa5", "message": "Convert InstrumentationUtility to kotlin", "committedDate": "2020-08-23T14:52:52Z", "type": "commit"}, {"oid": "26a68d8118e0498faf3d6aba1bf011b3f1234fff", "url": "https://github.com/dimagi/commcare-android/commit/26a68d8118e0498faf3d6aba1bf011b3f1234fff", "message": "Decouple app update persistence test", "committedDate": "2020-08-24T07:32:41Z", "type": "commit"}, {"oid": "2d132ebf0bd63dd3136e07897bbfbc502d4ebcba", "url": "https://github.com/dimagi/commcare-android/commit/2d132ebf0bd63dd3136e07897bbfbc502d4ebcba", "message": "Fix InstallFromListTest", "committedDate": "2020-08-24T07:56:49Z", "type": "commit"}, {"oid": "342bbc38d797c0e99f55534a2f6685e49c63843d", "url": "https://github.com/dimagi/commcare-android/commit/342bbc38d797c0e99f55534a2f6685e49c63843d", "message": "Merge branch 'master' into espresso-tests", "committedDate": "2020-08-25T04:41:36Z", "type": "commit"}, {"oid": "f0f5de39f8bd68af30c9645caa63899f6c242285", "url": "https://github.com/dimagi/commcare-android/commit/f0f5de39f8bd68af30c9645caa63899f6c242285", "message": "Merge branch 'master' into espresso-tests", "committedDate": "2020-08-25T11:03:17Z", "type": "commit"}]}