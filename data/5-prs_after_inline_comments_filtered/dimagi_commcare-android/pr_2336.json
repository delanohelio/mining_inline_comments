{"pr_number": 2336, "pr_title": "Inflate MediaLayout using xml", "pr_createdAt": "2020-09-03T07:24:43Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2336", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4NTU1OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r482785559", "bodyText": "Wondering if we need to do something here if the media isn't present?", "author": "ShivamPokhriyal", "createdAt": "2020-09-03T08:02:38Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -114,69 +104,57 @@ public static MediaLayout buildComprehensiveLayout(Context context,\n         return mediaLayout;\n     }\n \n+//    public void build(Context context,\n+//                                                       TextView text, String audioURI, String imageURI,\n+//                                                       final String videoURI, final String bigImageURI,\n+//                                                       final String qrCodeContent, String inlineVideoURI,\n+//                                                       int questionIndex) {\n+//        setAVT(text, audioURI, imageURI, videoURI, bigImageURI, qrCodeContent, inlineVideoURI, false, questionIndex);\n+//    }\n+\n+\n+\n+    public void addDivider() {\n+        divider.setVisibility(VISIBLE);\n+    }\n+\n+    //region private helpers\n+\n     private void setAVT(TextView text, String audioURI, String imageURI,\n                         final String videoURI, final String bigImageURI,\n                         final String qrCodeContent, String inlineVideoURI,\n                         boolean showImageAboveText,\n                         int questionIndex) {\n-        viewText = text;\n-        mInlineVideoUri = inlineVideoURI;\n-        mImageURI = imageURI;\n-        mBigImageURI = bigImageURI;\n-        mQrCodeContent = qrCodeContent;\n-\n-        RelativeLayout questionTextPane = new RelativeLayout(this.getContext());\n-        questionTextPane.setId(QUESTION_TEXT_PANE_ID);\n-\n         setupStandardAudio(audioURI, questionIndex);\n         setupVideoButton(videoURI);\n-\n-        // Now set up the center view -- it is either an image, a QR Code, an inline video, or\n-        // expanded audio\n-        mediaPane = new RelativeLayout(getContext());\n-\n-        LayoutParams mediaPaneParams = refreshMediaView();\n-\n-        addAudioVideoButtonsToView(questionTextPane);\n-\n-        showImageAboveText = showImageAboveText || DeveloperPreferences.imageAboveTextEnabled();\n-        addElementsToView(mediaPane, mediaPaneParams, questionTextPane, showImageAboveText);\n+        setupQRView(qrCodeContent);\n+        setupInlineVideoView(inlineVideoURI);\n+        setupImage(imageURI, bigImageURI);\n+        addTextView(text);\n+        //TODO Need to use showImageAboveText\n     }\n \n-    private LayoutParams refreshMediaView() {\n-        RelativeLayout.LayoutParams mediaPaneParams =\n-                new RelativeLayout.LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.WRAP_CONTENT);\n-\n-        View mediaView = null;\n-        if (mInlineVideoUri != null) {\n-            mediaView = getInlineVideoView(mInlineVideoUri, mediaPaneParams);\n-        } else if (mQrCodeContent != null) {\n-            mediaView = setupQRView(mQrCodeContent);\n-        } else if (mImageURI != null) {\n-            mediaView = setupImage(mImageURI, mBigImageURI);\n-        }\n+    private void addTextView(TextView text) {\n+        textViewContainer.addView(text);\n+    }\n \n-        if (mediaView != null) {\n-            RelativeLayout.LayoutParams mediaViewParams =\n-                    new RelativeLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT);\n-            mediaViewParams.addRule(CENTER_IN_PARENT, mediaView.getId());\n-            mediaPane.addView(mediaView, mediaViewParams);\n+    private void setupStandardAudio(String audioURI, int questionIndex) {\n+        if (audioURI != null) {\n+            boolean mediaPresent = FileUtil.referenceFileExists(audioURI);", "originalCommit": "1fff6e26ea2da0b8e05edc0f66d20b2c87fd5e2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ1ODM1Nw==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r484458357", "bodyText": "the audio button should be handling the missing media state by itself, providing an option to download the file in case it's missing.", "author": "shubham1g5", "createdAt": "2020-09-07T14:15:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4NTU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ2MjE4NA==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r484462184", "bodyText": "awesome. Thanks!", "author": "ShivamPokhriyal", "createdAt": "2020-09-07T14:22:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4NTU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA3NTYyOQ==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487075629", "bodyText": "FYI, I'll remove this unused variable then.", "author": "ShivamPokhriyal", "createdAt": "2020-09-11T14:17:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4NTU1OQ=="}], "type": "inlineReview"}, {"oid": "931b63e126daf07eae19f08dc18881ee64af2e36", "url": "https://github.com/dimagi/commcare-android/commit/931b63e126daf07eae19f08dc18881ee64af2e36", "message": "Inflate MediaLayout using xml", "committedDate": "2020-09-03T14:48:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0NTUyNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r483045525", "bodyText": "Same, do we need to show something here as well just like we do for videoView?", "author": "ShivamPokhriyal", "createdAt": "2020-09-03T14:59:29Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -342,129 +232,66 @@ private View setupImage(String imageURI, String bigImageURI) {\n                     } else {\n                         mImageView.setImageBitmap(b);\n                     }\n-                    mImageView.setId(IMAGE_VIEW_ID);\n-                    mediaPane = mImageView;\n+                    mImageView.setVisibility(VISIBLE);\n                 }\n             } else {\n                 // An error hasn't been logged. We should have an image, but the file doesn't\n                 // exist.\n-                mediaPane = getMissingMediaView(imageURI,\n-                        StringUtils.getStringRobust(getContext(), R.string.video_download_prompt),\n-                        true);\n+                showMissingMediaView(imageURI,\n+                        StringUtils.getStringRobust(getContext(), R.string.image_download_prompt),\n+                        true,\n+                        () -> {\n+                            hideMissingMediaView();\n+                            setupImage(imageURI, bigImageURI);\n+                        });\n             }\n         } catch (InvalidReferenceException e) {\n             Log.e(TAG, \"image invalid reference exception\");", "originalCommit": "931b63e126daf07eae19f08dc18881ee64af2e36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ2MzY1Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r484463656", "bodyText": "we can follow the same pattern as videoView.", "author": "shubham1g5", "createdAt": "2020-09-07T14:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0NTUyNQ=="}], "type": "inlineReview"}, {"oid": "6cf8668998abaa3a47bb4ba72ae30912ebe198e7", "url": "https://github.com/dimagi/commcare-android/commit/6cf8668998abaa3a47bb4ba72ae30912ebe198e7", "message": "Re-Add support to show media above text", "committedDate": "2020-09-10T12:58:04Z", "type": "forcePushed"}, {"oid": "47ed9d21af2b4a86d4b95f78bfd1d5392dfaa2f4", "url": "https://github.com/dimagi/commcare-android/commit/47ed9d21af2b4a86d4b95f78bfd1d5392dfaa2f4", "message": "Inflate MediaLayout using xml", "committedDate": "2020-09-11T13:20:20Z", "type": "commit"}, {"oid": "122c75bb8578ff547b4809f0ed8b81bb68d869b0", "url": "https://github.com/dimagi/commcare-android/commit/122c75bb8578ff547b4809f0ed8b81bb68d869b0", "message": "Re-Add support to show media above text", "committedDate": "2020-09-11T13:20:20Z", "type": "commit"}, {"oid": "53f6ac61535ebd43249ec2dff8c56708dd02c729", "url": "https://github.com/dimagi/commcare-android/commit/53f6ac61535ebd43249ec2dff8c56708dd02c729", "message": "Fix videoView visibility issue after download completion", "committedDate": "2020-09-11T13:20:20Z", "type": "commit"}, {"oid": "53f6ac61535ebd43249ec2dff8c56708dd02c729", "url": "https://github.com/dimagi/commcare-android/commit/53f6ac61535ebd43249ec2dff8c56708dd02c729", "message": "Fix videoView visibility issue after download completion", "committedDate": "2020-09-11T13:20:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NTY2Mw==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487055663", "bodyText": "the reason why videoView doesn't appear after download completion was this maxBounds[1]. In my case, the textView had a really long text and I had to scroll down to see the videoView.\nThe getMaxCenterViewBounds method subtracts the text height from the total height\nmaxHeight = maxHeight - textViewContainer.getChildAt(0).getHeight(); making this maxBounds[1] to be 0.\nSince, videoView will automatically configure itself with the min height possible, we're good to give it max height here.", "author": "ShivamPokhriyal", "createdAt": "2020-09-11T13:46:06Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -350,13 +351,13 @@ private void setupInlineVideoView(String inlineVideoURI) {\n      * It's height is always 0(from LayoutInspector) even if you set it to match_parent.\n      */\n     private void makeVideoViewVisible() {\n-        int[] maxBounds = getMaxCenterViewBounds();\n         //These surprisingly get re-jiggered as soon as the video is loaded, so we\n         //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n         //itself when it's ready.\n+        DisplayMetrics metrics = this.getContext().getResources().getDisplayMetrics();\n         ViewGroup.LayoutParams params = videoView.getLayoutParams();\n-        params.width = maxBounds[0];\n-        params.height = maxBounds[1];\n+        params.width = metrics.widthPixels;\n+        params.height = metrics.heightPixels;", "originalCommit": "53f6ac61535ebd43249ec2dff8c56708dd02c729", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2OTY2OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487569669", "bodyText": "nice find.", "author": "shubham1g5", "createdAt": "2020-09-13T19:47:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NTY2Mw=="}], "type": "inlineReview"}, {"oid": "417698d21b42c2264eb3bea7841fc280d1a6b618", "url": "https://github.com/dimagi/commcare-android/commit/417698d21b42c2264eb3bea7841fc280d1a6b618", "message": "Add background color to missing media view", "committedDate": "2020-09-11T14:13:52Z", "type": "commit"}, {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf", "url": "https://github.com/dimagi/commcare-android/commit/d6f0688d6004080e8a4de1c3bfe894eeaba43fdf", "message": "Show missing media for invalid image reference", "committedDate": "2020-09-11T14:18:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4MDkxMQ==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487080911", "bodyText": "@shubham1g5 Do we need to localize this text?", "author": "ShivamPokhriyal", "createdAt": "2020-09-11T14:25:22Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -473,64 +337,75 @@ private View getInlineVideoView(String inlineVideoURI, RelativeLayout.LayoutPara\n                     }\n                     FirebaseAnalyticsUtil.reportInlineVideoPlayEvent(videoFilename, FileUtil.getDuration(videoFile), duration);\n                 });\n-\n                 videoView.setOnClickListener(v -> ViewUtil.hideVirtualKeyboard((Activity)getContext()));\n-\n-                //These surprisingly get re-jiggered as soon as the video is loaded, so we\n-                //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n-                //itself when it's ready.\n-                viewLayoutParams.width = maxBounds[0];\n-                viewLayoutParams.height = maxBounds[1];\n-\n-                videoView.setId(INLINE_VIDEO_PANE_ID);\n-                return videoView;\n+                videoView.setVisibility(VISIBLE);\n             }\n         } catch (InvalidReferenceException ire) {\n             Log.e(TAG, \"invalid video reference exception\");\n             ire.printStackTrace();\n-            return getMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false);\n+            showMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false, null);", "originalCommit": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4MjA5Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487082092", "bodyText": "Also the information here isn't really informative imo. Would it be better if we say: Can't show media due to: ?", "author": "ShivamPokhriyal", "createdAt": "2020-09-11T14:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4MDkxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2OTQ3NA==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487569474", "bodyText": "yes, we should localize anything we display on UI. I think the prefix you mentioned is redundant in Invalid ... but would not really mind us adding that.", "author": "shubham1g5", "createdAt": "2020-09-13T19:45:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4MDkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MDcyNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487570725", "bodyText": "nit: missingMediaText -> missingMediaStatus", "author": "shubham1g5", "createdAt": "2020-09-13T19:58:15Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -473,64 +337,75 @@ private View getInlineVideoView(String inlineVideoURI, RelativeLayout.LayoutPara\n                     }\n                     FirebaseAnalyticsUtil.reportInlineVideoPlayEvent(videoFilename, FileUtil.getDuration(videoFile), duration);\n                 });\n-\n                 videoView.setOnClickListener(v -> ViewUtil.hideVirtualKeyboard((Activity)getContext()));\n-\n-                //These surprisingly get re-jiggered as soon as the video is loaded, so we\n-                //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n-                //itself when it's ready.\n-                viewLayoutParams.width = maxBounds[0];\n-                viewLayoutParams.height = maxBounds[1];\n-\n-                videoView.setId(INLINE_VIDEO_PANE_ID);\n-                return videoView;\n+                videoView.setVisibility(VISIBLE);\n             }\n         } catch (InvalidReferenceException ire) {\n             Log.e(TAG, \"invalid video reference exception\");\n             ire.printStackTrace();\n-            return getMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false);\n+            showMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false, null);\n         }\n     }\n \n-    private View getMissingMediaView(String mediaUri, String errorMessage, boolean allowDownload) {\n-        missingMediaView = LayoutInflater.from(getContext()).inflate(R.layout.missing_media_view, this, false);\n-\n-        TextView status = missingMediaView.findViewById(R.id.missing_media_tv);\n-        status.setText(errorMessage);\n+    /**\n+     * Without this code VideoView doesn't appear on the screen.\n+     * It's height is always 0(from LayoutInspector) even if you set it to match_parent.\n+     */\n+    private void makeVideoViewVisible() {\n+        //These surprisingly get re-jiggered as soon as the video is loaded, so we\n+        //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n+        //itself when it's ready.\n+        DisplayMetrics metrics = this.getContext().getResources().getDisplayMetrics();\n+        ViewGroup.LayoutParams params = videoView.getLayoutParams();\n+        params.width = metrics.widthPixels;\n+        params.height = metrics.heightPixels;\n+        videoView.setLayoutParams(params);\n+    }\n \n-        View progressView = missingMediaView.findViewById(R.id.progress_bar);\n-        View downloadIcon = missingMediaView.findViewById(R.id.download_media_icon);\n+    private void showMissingMediaView(String mediaUri, String errorMessage, boolean allowDownload, @Nullable Runnable completion) {\n+        missingMediaBackground.setVisibility(VISIBLE);\n+        missingMediaText.setText(errorMessage);", "originalCommit": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MTQxNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487571415", "bodyText": "stylistic point that you can ignore: hideMissingMediaView can be called from showMissingMediaView to DRY the completion logic further.", "author": "shubham1g5", "createdAt": "2020-09-13T20:05:07Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -342,129 +271,64 @@ private View setupImage(String imageURI, String bigImageURI) {\n                     } else {\n                         mImageView.setImageBitmap(b);\n                     }\n-                    mImageView.setId(IMAGE_VIEW_ID);\n-                    mediaPane = mImageView;\n+                    mImageView.setVisibility(VISIBLE);\n                 }\n             } else {\n                 // An error hasn't been logged. We should have an image, but the file doesn't\n                 // exist.\n-                mediaPane = getMissingMediaView(imageURI,\n-                        StringUtils.getStringRobust(getContext(), R.string.video_download_prompt),\n-                        true);\n+                showMissingMediaView(imageURI,\n+                        StringUtils.getStringRobust(getContext(), R.string.image_download_prompt),\n+                        true,\n+                        () -> {\n+                            hideMissingMediaView();\n+                            setupImage(imageURI, bigImageURI);\n+                        });\n             }\n         } catch (InvalidReferenceException e) {\n             Log.e(TAG, \"image invalid reference exception\");\n             e.printStackTrace();\n-        }\n-        return mediaPane;\n-    }\n-\n-    private void addElementsToView(View mediaPane,\n-                                   RelativeLayout.LayoutParams mediaPaneParams,\n-                                   RelativeLayout questionTextPane, boolean showImageAboveText) {\n-        RelativeLayout.LayoutParams questionTextPaneParams =\n-                new RelativeLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT);\n-        if (mediaPane != null) {\n-            if (viewText.getVisibility() == GONE) {\n-                this.addView(questionTextPane, questionTextPaneParams);\n-                if (audioButton != null) {\n-                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR1) {\n-                        mediaPaneParams.addRule(RelativeLayout.START_OF, audioButton.getId());\n-                    } else {\n-                        mediaPaneParams.addRule(RelativeLayout.LEFT_OF, audioButton.getId());\n-                    }\n-                    questionTextPane.addView(mediaPane, mediaPaneParams);\n-                }\n-                if (videoButton != null) {\n-                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR1) {\n-                        mediaPaneParams.addRule(RelativeLayout.START_OF, videoButton.getId());\n-                    } else {\n-                        mediaPaneParams.addRule(RelativeLayout.LEFT_OF, videoButton.getId());\n-                    }\n-                    questionTextPane.addView(mediaPane, mediaPaneParams);\n-                }\n-            } else {\n-                if (showImageAboveText) {\n-                    mediaPaneParams.addRule(CENTER_HORIZONTAL);\n-                    this.addView(mediaPane, mediaPaneParams);\n-                    questionTextPaneParams.addRule(RelativeLayout.BELOW, mediaPane.getId());\n-                    this.addView(questionTextPane, questionTextPaneParams);\n-                } else {\n-                    this.addView(questionTextPane, questionTextPaneParams);\n-                    mediaPaneParams.addRule(RelativeLayout.BELOW, questionTextPane.getId());\n-                    mediaPaneParams.addRule(CENTER_HORIZONTAL);\n-                    this.addView(mediaPane, mediaPaneParams);\n-                }\n-            }\n-        } else {\n-            this.addView(questionTextPane, questionTextPaneParams);\n+            showMissingMediaView(imageURI, \"Invalid reference: \" + e.getReferenceString(), false, null);\n         }\n     }\n \n-    @SuppressWarnings(\"deprecation\")\n-    private int getScreenMinimumDimension() {\n-        Display display =\n-                ((WindowManager)getContext().getSystemService(Context.WINDOW_SERVICE))\n-                        .getDefaultDisplay();\n-\n-        int width, height;\n-        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.HONEYCOMB_MR2) {\n-            width = display.getWidth();\n-            height = display.getHeight();\n-        } else {\n-            Point screenDims = new Point();\n-            display.getSize(screenDims);\n-            width = screenDims.x;\n-            height = screenDims.y;\n-        }\n-\n-        return Math.min(width, height);\n-    }\n-\n-    /**\n-     * Creates a video view for the provided URI or an error view elaborating why the video\n-     * couldn't be displayed.\n-     *\n-     * @param inlineVideoURI   JavaRosa Reference URI\n-     * @param viewLayoutParams the layout params that will be applied to the view. Expect to be\n-     *                         mutated by this method\n-     */\n-    private View getInlineVideoView(String inlineVideoURI, RelativeLayout.LayoutParams viewLayoutParams) {\n+    private void setupInlineVideoView(String inlineVideoURI) {\n         try {\n             final String videoFilename = ReferenceManager.instance().DeriveReference(inlineVideoURI).getLocalURI();\n-\n-            int[] maxBounds = getMaxCenterViewBounds();\n-\n             final File videoFile = new File(videoFilename);\n             if (!videoFile.exists()) {\n-                return getMissingMediaView(inlineVideoURI,\n+                showMissingMediaView(inlineVideoURI,\n                         StringUtils.getStringRobust(getContext(), R.string.video_download_prompt),\n-                        true);\n+                        true,\n+                        () -> {\n+                            hideMissingMediaView();", "originalCommit": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MTU2Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487571562", "bodyText": "this method can be avoided by setting the initial visibility of all views as gone in xml layout itself.", "author": "shubham1g5", "createdAt": "2020-09-13T20:06:33Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -541,49 +416,39 @@ private boolean useResizingImageView() {\n                         || \"width\".equals(ResizingImageView.resizeMethod));\n     }\n \n-    /**\n-     * @return The appropriate max size of an image view pane in this widget. returned as an int\n-     * array of [width, height]\n-     */\n-    private int[] getMaxCenterViewBounds() {\n-        DisplayMetrics metrics = this.getContext().getResources().getDisplayMetrics();\n-        int maxWidth = metrics.widthPixels;\n-        int maxHeight = metrics.heightPixels;\n-\n-        // subtract height for textview and buttons, if present\n-        if (viewText != null) {\n-            maxHeight = maxHeight - viewText.getHeight();\n-        }\n-        if (videoButton != null) {\n-            maxHeight = maxHeight - videoButton.getHeight();\n-        } else if (audioButton != null) {\n-            maxHeight = maxHeight - audioButton.getHeight();\n-        }\n-\n-        // reduce by third for safety\n-        return new int[]{maxWidth, (2 * maxHeight) / 3};\n+    private void initView(Context context) {\n+        View view = LayoutInflater.from(context).inflate(R.layout.media_layout, this);\n+        audioButton = view.findViewById(R.id.audio_button);\n+        videoButton = view.findViewById(R.id.video_button);\n+        textViewContainer = view.findViewById(R.id.question_text_container);\n+        videoView = view.findViewById(R.id.inline_video_view);\n+        qrView = view.findViewById(R.id.qr_view);\n+        imageView = view.findViewById(R.id.image);\n+        resizingImageView = view.findViewById(R.id.resizing_image);\n+        downloadIcon = view.findViewById(R.id.download_media_icon);\n+        progressBar = view.findViewById(R.id.progress_bar);\n+        missingMediaText = view.findViewById(R.id.missing_media_tv);\n+        divider = view.findViewById(R.id.divider);\n+        mediaLayoutBottomBarrier = view.findViewById(R.id.media_barrier);\n+        missingMediaBackground = view.findViewById(R.id.missing_media_background);\n+\n+        resetView();\n     }\n \n-    /**\n-     * This adds a divider at the bottom of this layout. Used to separate\n-     * fields in lists.\n-     */\n-    public void addDivider(ImageView v) {\n-        RelativeLayout.LayoutParams dividerParams =\n-                new RelativeLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT);\n-        if (missingMediaView != null) {\n-            dividerParams.addRule(RelativeLayout.BELOW, missingMediaView.getId());\n-        } else if (videoButton != null) {\n-            dividerParams.addRule(RelativeLayout.BELOW, videoButton.getId());\n-        } else if (audioButton != null) {\n-            dividerParams.addRule(RelativeLayout.BELOW, audioButton.getId());\n-        } else if (viewText != null) {\n-            // No picture\n-            dividerParams.addRule(RelativeLayout.BELOW, viewText.getId());\n-        } else {\n-            Log.e(TAG, \"Tried to add divider to uninitialized ATVWidget\");\n-            return;\n-        }\n-        addView(v, dividerParams);\n+    private void resetView() {", "originalCommit": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b59bd7b17a77fa53036a96b1cb01836a08922bb4", "url": "https://github.com/dimagi/commcare-android/commit/b59bd7b17a77fa53036a96b1cb01836a08922bb4", "message": "Fix videobutton visibility issue when media is above text", "committedDate": "2020-09-14T04:49:33Z", "type": "commit"}, {"oid": "51b4df6d9e4c963eb5d9264475f181977b40487b", "url": "https://github.com/dimagi/commcare-android/commit/51b4df6d9e4c963eb5d9264475f181977b40487b", "message": "Fix missing media background when media is shown above text", "committedDate": "2020-09-14T05:25:21Z", "type": "commit"}, {"oid": "c7ecd9f56fb4bc49f77302b5aa4e9f198c738db2", "url": "https://github.com/dimagi/commcare-android/commit/c7ecd9f56fb4bc49f77302b5aa4e9f198c738db2", "message": "Fix ResizingImageView\n\nFix for android.view.ViewGroup cannot be cast to androidx.constraintlayout.widget.ConstraintLayout", "committedDate": "2020-09-14T05:29:23Z", "type": "commit"}, {"oid": "6a3b33cb329908e7e6cee127a78a7ad6e2c68039", "url": "https://github.com/dimagi/commcare-android/commit/6a3b33cb329908e7e6cee127a78a7ad6e2c68039", "message": "PR suggestions", "committedDate": "2020-09-14T05:48:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTAzNw==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487675037", "bodyText": "confused why did we remove videoButton from here", "author": "shubham1g5", "createdAt": "2020-09-14T06:21:28Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -144,12 +146,12 @@ private void showMediaAboveText() {\n         alignMediaAtTop(qrView);\n         alignMediaAtTop(imageView);\n         alignMediaAtTop(resizingImageView);\n+        alignMediaAtTop(missingMediaBackground);\n         alignMediaAtTop(downloadIcon);\n         alignMediaAtTop(progressBar);\n \n-        // Next align the text, audiobutton and videoButton below mediaView.\n+        // Next align the text, audiobutton below mediaView.\n         alignTextContainerBelowMediaView(audioButton);\n-        alignTextContainerBelowMediaView(videoButton);", "originalCommit": "6a3b33cb329908e7e6cee127a78a7ad6e2c68039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3OTk1OA==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487679958", "bodyText": "videoButton has a constraint which places it below audioButton. So we only need to align audioButton top constraint while shifting it below media view.", "author": "ShivamPokhriyal", "createdAt": "2020-09-14T06:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTIxNw==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487675217", "bodyText": "why is this required ?", "author": "shubham1g5", "createdAt": "2020-09-14T06:21:56Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -417,6 +426,7 @@ private boolean useResizingImageView() {\n     }\n \n     private void initView(Context context) {\n+        setId(AndroidUtil.generateViewId());", "originalCommit": "6a3b33cb329908e7e6cee127a78a7ad6e2c68039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3OTYxNA==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487679614", "bodyText": "If not set, this.getId() call above returns -1 which is the same as LayoutParams.UNSET.", "author": "ShivamPokhriyal", "createdAt": "2020-09-14T06:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4NDk1OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487684959", "bodyText": "Ahh Makes sense.", "author": "shubham1g5", "createdAt": "2020-09-14T06:46:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTIxNw=="}], "type": "inlineReview"}, {"oid": "fdf4d3896e6310b2525523cf444f87177b387ae7", "url": "https://github.com/dimagi/commcare-android/commit/fdf4d3896e6310b2525523cf444f87177b387ae7", "message": "Use guideline for shifting mediaview and textcontainer", "committedDate": "2020-09-14T07:31:03Z", "type": "commit"}, {"oid": "e25e598d5559f1080d536eb556cbabdb0bffcbf4", "url": "https://github.com/dimagi/commcare-android/commit/e25e598d5559f1080d536eb556cbabdb0bffcbf4", "message": "Use tools visibility along-with android visibility", "committedDate": "2020-09-14T07:38:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcxMDM5NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487710395", "bodyText": "this seems ununsed and can be removed.", "author": "shubham1g5", "createdAt": "2020-09-14T07:39:11Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -40,54 +44,46 @@\n import org.commcare.views.ViewUtil;\n import org.javarosa.core.reference.InvalidReferenceException;\n import org.javarosa.core.reference.ReferenceManager;\n+import org.javarosa.core.services.locale.Localization;\n \n import java.io.File;\n \n-import androidx.annotation.IdRes;\n-\n /**\n- * This layout is used anywhere we can have image/audio/video/text.\n- * TODO: Put this in a layout file!!!!\n- *\n- * @author carlhartung\n+ * @author $|-|!\u02c5@M\n  */\n-public class MediaLayout extends RelativeLayout {\n-    private static final String TAG = MediaLayout.class.getSimpleName();\n-\n-    @IdRes\n-    public static final int INLINE_VIDEO_PANE_ID = 99999;\n-\n-    @IdRes\n-    private static final int QUESTION_TEXT_PANE_ID = 2342134;\n-\n-    @IdRes\n-    private static final int AUDIO_BUTTON_ID = 3245345;\n-\n-    @IdRes\n-    private static final int VIDEO_BUTTON_ID = 234982340;\n-\n-    @IdRes\n-    private static final int IMAGE_VIEW_ID = 23423534;\n+public class MediaLayout extends ConstraintLayout {\n \n+    private static final String TAG = MediaLayout.class.getSimpleName();\n     private static final String IMAGE_GIF_EXTENSION = \".gif\";\n \n-    private TextView viewText;\n     private AudioPlaybackButton audioButton;\n     private ImageButton videoButton;\n-    private View missingMediaView;\n-    private String mInlineVideoUri;\n-    private String mImageURI;\n-    private String mBigImageURI;\n-    private String mQrCodeContent;\n-    private RelativeLayout mediaPane;\n-\n-    private MediaLayout(Context c) {\n-        super(c);\n-\n-        viewText = null;\n-        audioButton = null;\n-        missingMediaView = null;\n-        videoButton = null;\n+    private FrameLayout textViewContainer;\n+    private CommCareVideoView videoView;\n+    private ImageView qrView;\n+    private ImageView imageView;\n+    private ResizingImageView resizingImageView;\n+    private ImageView downloadIcon;\n+    private ProgressBar progressBar;\n+    private TextView missingMediaStatus;\n+    private ImageView divider;\n+    private Barrier mediaLayoutBottomBarrier;\n+    private View missingMediaBackground;\n+    private Barrier questionBottomBarrier;\n+\n+    public MediaLayout(@NonNull Context context) {\n+        super(context);\n+        initView(context);\n+    }\n+\n+    public MediaLayout(@NonNull Context context, @Nullable AttributeSet attrs) {\n+        super(context, attrs);\n+        initView(context);\n+    }\n+\n+    public MediaLayout(@NonNull Context context, @Nullable AttributeSet attrs, int defStyleAttr) {\n+        super(context, attrs, defStyleAttr);\n+        initView(context);\n     }\n \n     public static MediaLayout buildAudioImageLayout(Context context, TextView text, String audioURI, String imageURI) {", "originalCommit": "fdf4d3896e6310b2525523cf444f87177b387ae7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcxMzM5MQ==", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487713391", "bodyText": "Wondering if it's possible to avoid multiple calls of alignTextContainerBelowMediaView as well and instead use barrier/guideline mechanism to shift these views ?", "author": "shubham1g5", "createdAt": "2020-09-14T07:43:56Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -114,69 +110,75 @@ public static MediaLayout buildComprehensiveLayout(Context context,\n         return mediaLayout;\n     }\n \n+    public void addDivider() {\n+        divider.setVisibility(VISIBLE);\n+    }\n+\n+    //region private helpers\n+\n     private void setAVT(TextView text, String audioURI, String imageURI,\n                         final String videoURI, final String bigImageURI,\n                         final String qrCodeContent, String inlineVideoURI,\n                         boolean showImageAboveText,\n                         int questionIndex) {\n-        viewText = text;\n-        mInlineVideoUri = inlineVideoURI;\n-        mImageURI = imageURI;\n-        mBigImageURI = bigImageURI;\n-        mQrCodeContent = qrCodeContent;\n-\n-        RelativeLayout questionTextPane = new RelativeLayout(this.getContext());\n-        questionTextPane.setId(QUESTION_TEXT_PANE_ID);\n-\n         setupStandardAudio(audioURI, questionIndex);\n         setupVideoButton(videoURI);\n \n-        // Now set up the center view -- it is either an image, a QR Code, an inline video, or\n-        // expanded audio\n-        mediaPane = new RelativeLayout(getContext());\n+        // We only show one of the inline-video-view / qrview / image\n+        if (inlineVideoURI != null) {\n+            setupInlineVideoView(inlineVideoURI);\n+        } else if (qrCodeContent != null) {\n+            setupQRView(qrCodeContent);\n+        } else if (imageURI != null) {\n+            setupImage(imageURI, bigImageURI);\n+        }\n+\n+        addTextView(text);\n+        if (showImageAboveText || DeveloperPreferences.imageAboveTextEnabled()) {\n+            showMediaAboveText();\n+        }\n+    }\n+\n+    private void showMediaAboveText() {\n+        // This step will change the layout constraints of the views in xml to shift\n+        // media(video, image qr ) above text.\n \n-        LayoutParams mediaPaneParams = refreshMediaView();\n+        // Change the questionBottomBarrier to align at the top of parent which would automatically\n+        // align the mediaViews(including missing media view) to the top.\n+        questionBottomBarrier.setReferencedIds(new int[]{ R.id.top_guideline });\n \n-        addAudioVideoButtonsToView(questionTextPane);\n+        // Next align the text, audiobutton below mediaView.\n+        alignTextContainerBelowMediaView(audioButton);", "originalCommit": "e25e598d5559f1080d536eb556cbabdb0bffcbf4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a4395293823d4919c0359c1555554a2ee5f691a7", "url": "https://github.com/dimagi/commcare-android/commit/a4395293823d4919c0359c1555554a2ee5f691a7", "message": "Add suggested changes", "committedDate": "2020-09-14T07:59:44Z", "type": "commit"}, {"oid": "43a5b823ec35becbbd0dd4838e583bf3ff472706", "url": "https://github.com/dimagi/commcare-android/commit/43a5b823ec35becbbd0dd4838e583bf3ff472706", "message": "Merge branch 'master' into revamp-media-layout", "committedDate": "2020-09-14T08:12:25Z", "type": "commit"}]}