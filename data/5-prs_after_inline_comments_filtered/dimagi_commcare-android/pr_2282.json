{"pr_number": 2282, "pr_title": "Use FusedLocation client for capturing location", "pr_createdAt": "2020-06-22T06:57:02Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2282", "timeline": [{"oid": "f9d28a940f328b8f9d36a39bc857dbf638fee71e", "url": "https://github.com/dimagi/commcare-android/commit/f9d28a940f328b8f9d36a39bc857dbf638fee71e", "message": "Use FusedLocation client for capturing location", "committedDate": "2020-06-22T06:54:39Z", "type": "commit"}, {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb", "url": "https://github.com/dimagi/commcare-android/commit/820f167f3e358de42212fc5df23c56f9792a24bb", "message": "Use the new fused provider client in auto-gps-capture", "committedDate": "2020-06-23T06:55:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAwMTEzMg==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449001132", "bodyText": "so earlier the gps error will only show up if the receiver was fired before the form load completes ?", "author": "shubham1g5", "createdAt": "2020-07-02T13:27:52Z", "path": "app/src/org/commcare/activities/FormEntryActivity.java", "diffHunk": "@@ -984,9 +1000,7 @@ protected void deliverError(FormEntryActivity receiver, Exception e) {\n     }\n \n     private void handleFormLoadCompletion(AndroidFormController fc) {\n-        if (GeoUtils.ACTION_CHECK_GPS_ENABLED.equals(locationRecieverErrorAction)) {", "originalCommit": "820f167f3e358de42212fc5df23c56f9792a24bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNTc3Mw==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449535773", "bodyText": "Yeah.", "author": "ShivamPokhriyal", "createdAt": "2020-07-03T11:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAwMTEzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIzMjM5OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449232399", "bodyText": "unused", "author": "shubham1g5", "createdAt": "2020-07-02T19:45:08Z", "path": "app/src/org/commcare/activities/GeoPointActivity.java", "diffHunk": "@@ -1,42 +1,66 @@\n package org.commcare.activities;\n \n import android.Manifest;\n+import android.annotation.SuppressLint;\n import android.app.Activity;\n import android.content.Context;\n import android.content.DialogInterface;\n import android.content.Intent;\n+import android.content.IntentSender;\n import android.content.pm.PackageManager;\n import android.location.Location;\n import android.location.LocationListener;\n import android.location.LocationManager;\n import android.location.LocationProvider;\n+import android.os.Build;\n import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.RequiresApi;\n+import androidx.core.app.ActivityCompat;\n import androidx.core.content.ContextCompat;\n \n import android.view.View.OnClickListener;\n+import android.widget.Toast;\n+\n+import com.google.android.gms.common.api.ResolvableApiException;\n \n import org.commcare.activities.components.FormEntryConstants;\n import org.commcare.dalvik.R;\n+import org.commcare.interfaces.RuntimePermissionRequester;\n import org.commcare.interfaces.TimerListener;\n+import org.commcare.location.CommCareFusedLocationController;", "originalCommit": "820f167f3e358de42212fc5df23c56f9792a24bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyNzc5Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449527792", "bodyText": "you can provide a @JvmStatic annotation for getLocationController to avoid using Companion in references.", "author": "shubham1g5", "createdAt": "2020-07-03T11:12:16Z", "path": "app/src/org/commcare/activities/GeoPointActivity.java", "diffHunk": "@@ -47,9 +71,7 @@ protected void onCreate(Bundle savedInstanceState) {\n         setTitle(StringUtils.getStringRobust(this, R.string.application_name) +\n                 \" > \" + StringUtils.getStringRobust(this, R.string.get_location));\n \n-        locationManager = (LocationManager)getSystemService(Context.LOCATION_SERVICE);\n-\n-        providers = GeoUtils.evaluateProviders(locationManager);\n+        locationController = CommCareLocationControllerFactory.Companion.getLocationController(this, this);", "originalCommit": "820f167f3e358de42212fc5df23c56f9792a24bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNjEzMg==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449536132", "bodyText": "Yay! Thanks! I didn't know about this.", "author": "ShivamPokhriyal", "createdAt": "2020-07-03T11:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyNzc5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyOTA4Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449529082", "bodyText": "shouldn't we still dismiss the dialog ?", "author": "shubham1g5", "createdAt": "2020-07-03T11:15:38Z", "path": "app/src/org/commcare/activities/GeoPointActivity.java", "diffHunk": "@@ -67,36 +89,48 @@ protected void onCreate(Bundle savedInstanceState) {\n     @Override\n     protected void onPause() {\n         super.onPause();\n-\n-        // stops the GPS. Note that this will turn off the GPS if the screen goes to sleep.\n-        if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED ||\n-                ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_COARSE_LOCATION) == PackageManager.PERMISSION_GRANTED) {\n-            locationManager.removeUpdates(this);\n-        }\n-\n-        // We're not using managed dialogs, so we have to dismiss the dialog to prevent it from\n-        // leaking memory.\n-        if (locationDialog != null && locationDialog.isShowing()) {", "originalCommit": "820f167f3e358de42212fc5df23c56f9792a24bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNjM5OA==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449536398", "bodyText": "Aha! Thanks for catching this.", "author": "ShivamPokhriyal", "createdAt": "2020-07-03T11:34:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyOTA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MTkzMA==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449541930", "bodyText": "where does this receiver get fired from, the Location Manager itself ?", "author": "shubham1g5", "createdAt": "2020-07-03T11:48:38Z", "path": "app/src/org/commcare/android/javarosa/PollSensorController.java", "diffHunk": "@@ -112,27 +111,43 @@ public void onLocationChanged(Location location) {\n         }\n     }\n \n-    @Override\n-    public void onProviderDisabled(String provider) {\n+    private void sendBroadcast(Context context) {\n+        Intent noGPSIntent = new Intent(GeoUtils.ACTION_CHECK_GPS_ENABLED);\n+        context.sendStickyBroadcast(noGPSIntent);\n     }\n \n     @Override\n-    public void onProviderEnabled(String provider) {\n+    public void missingPermissions() {\n+        missingPermissions = true;\n+        Context context = CommCareApplication.instance();\n+        sendBroadcast(context);\n     }\n \n     @Override\n-    public void onStatusChanged(String provider, int status, Bundle extras) {\n+    public void onLocationRequestFailure(@NotNull CommCareLocationListener.Failure failure) {\n+        Context context = CommCareApplication.instance();\n+        if (failure instanceof CommCareLocationListener.Failure.ApiException) {\n+            Exception exception = ((CommCareLocationListener.Failure.ApiException) failure).getException();\n+            if (exception instanceof ResolvableApiException) {\n+                apiException = (ResolvableApiException) exception;\n+                sendBroadcast(context);\n+            } else {\n+                // ignore and return, we can't do anything.\n+            }\n+        } else {\n+            noProviders = true;\n+            context.registerReceiver(", "originalCommit": "820f167f3e358de42212fc5df23c56f9792a24bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0NDE5Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449544192", "bodyText": "Yeah, so this else part comes when the providers weren't enabled for this device so it sends a broadcast to the activity to ask users to enable providers GeoUtils.goToProperLocationSettingsScreen.\nSo we register a receiver to listen to events when the providers are changed by the users from settings.", "author": "ShivamPokhriyal", "createdAt": "2020-07-03T11:54:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MTkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MzIwNw==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449543207", "bodyText": "it seems like this broadcast is getting used to convey any kind of location errors, I would suggest 2 naming changes based on that -\nsendBroadcast -> broadcastLocationError\nACTION_CHECK_GPS_ENABLED -> ACTION_LOCATION_ERROR", "author": "shubham1g5", "createdAt": "2020-07-03T11:51:49Z", "path": "app/src/org/commcare/android/javarosa/PollSensorController.java", "diffHunk": "@@ -112,27 +111,43 @@ public void onLocationChanged(Location location) {\n         }\n     }\n \n-    @Override\n-    public void onProviderDisabled(String provider) {\n+    private void sendBroadcast(Context context) {\n+        Intent noGPSIntent = new Intent(GeoUtils.ACTION_CHECK_GPS_ENABLED);", "originalCommit": "820f167f3e358de42212fc5df23c56f9792a24bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4b6ea31c95a170b0c9fcacac78bd2d22357ae2a6", "url": "https://github.com/dimagi/commcare-android/commit/4b6ea31c95a170b0c9fcacac78bd2d22357ae2a6", "message": "PR suggestions", "committedDate": "2020-07-06T09:11:43Z", "type": "commit"}, {"oid": "6edffd572bc9f490e6e459a94d86c5af58b12d4b", "url": "https://github.com/dimagi/commcare-android/commit/6edffd572bc9f490e6e459a94d86c5af58b12d4b", "message": "Merge branch 'master' into location-provider-update", "committedDate": "2020-07-17T07:19:01Z", "type": "commit"}, {"oid": "0c50a9a5a66d8dc70888c29aeeefd57ee90b693a", "url": "https://github.com/dimagi/commcare-android/commit/0c50a9a5a66d8dc70888c29aeeefd57ee90b693a", "message": "Use broadcast receiver to check location providers change", "committedDate": "2020-07-19T13:19:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY5ODM5Mw==", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r460698393", "bodyText": "nit: would be good to delegate it to requestLocationUpdates", "author": "shubham1g5", "createdAt": "2020-07-27T07:32:50Z", "path": "app/src/org/commcare/android/javarosa/PollSensorController.java", "diffHunk": "@@ -47,22 +62,8 @@ void startLocationPolling(PollSensorAction action) {\n         new Handler(Looper.getMainLooper()).post(() -> {\n             // Start requesting GPS updates\n             Context context = CommCareApplication.instance();\n-            mLocationManager = (LocationManager)context.getSystemService(Context.LOCATION_SERVICE);\n-\n-            Set<String> providers = GeoUtils.evaluateProviders(mLocationManager);\n-            if (providers.isEmpty()) {\n-                context.registerReceiver(\n-                        new ProvidersChangedHandler(),\n-                        new IntentFilter(LocationManager.PROVIDERS_CHANGED_ACTION)\n-                );\n-\n-                // This thread can't take action on the UI, so instead send\n-                // a message that actual activities notice and then display\n-                // a dialog asking user to enable location access\n-                Intent noGPSIntent = new Intent(GeoUtils.ACTION_CHECK_GPS_ENABLED);\n-                context.sendStickyBroadcast(noGPSIntent);\n-            }\n-            requestLocationUpdates(providers);\n+            mLocationController = CommCareLocationControllerFactory.getLocationController(context, this);\n+            mLocationController.start();", "originalCommit": "0c50a9a5a66d8dc70888c29aeeefd57ee90b693a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "16e21db34d53e5e101593064477ca4d82e798d3d", "url": "https://github.com/dimagi/commcare-android/commit/16e21db34d53e5e101593064477ca4d82e798d3d", "message": "PR suggestions", "committedDate": "2020-07-28T11:10:30Z", "type": "commit"}, {"oid": "433b6aa4c099fded19052ed06866594e0972b051", "url": "https://github.com/dimagi/commcare-android/commit/433b6aa4c099fded19052ed06866594e0972b051", "message": "Merge branch 'master' into location-provider-update", "committedDate": "2020-07-28T11:23:05Z", "type": "commit"}, {"oid": "9e7672d0934ce4aa9833860043d1d1aa7967b2df", "url": "https://github.com/dimagi/commcare-android/commit/9e7672d0934ce4aa9833860043d1d1aa7967b2df", "message": "Fix tests failures\n\nstopLocationPolling always gets called by formentryactivity onpause even if we never started polling location which was causing NPEs", "committedDate": "2020-07-28T12:38:34Z", "type": "commit"}, {"oid": "9e7672d0934ce4aa9833860043d1d1aa7967b2df", "url": "https://github.com/dimagi/commcare-android/commit/9e7672d0934ce4aa9833860043d1d1aa7967b2df", "message": "Fix tests failures\n\nstopLocationPolling always gets called by formentryactivity onpause even if we never started polling location which was causing NPEs", "committedDate": "2020-07-28T12:38:34Z", "type": "forcePushed"}, {"oid": "4982345fddad11aa4bfb3216f1abf3443763580f", "url": "https://github.com/dimagi/commcare-android/commit/4982345fddad11aa4bfb3216f1abf3443763580f", "message": "Merge branch 'master' into location-provider-update", "committedDate": "2020-07-30T10:57:36Z", "type": "commit"}]}