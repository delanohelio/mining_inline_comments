{"pr_number": 2320, "pr_title": "[2.49.7 hotfix] Fix to current location for Maps Location Capture", "pr_createdAt": "2020-08-19T21:10:03Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2320", "timeline": [{"oid": "2e023777e8319931fae63e9e46cbc9fcce395464", "url": "https://github.com/dimagi/commcare-android/commit/2e023777e8319931fae63e9e46cbc9fcce395464", "message": "Corrects the accuracy check to consider the initial location fix", "committedDate": "2020-08-19T20:35:29Z", "type": "commit"}, {"oid": "bc8a7d8ee138c43baee752f2b790709010525f9f", "url": "https://github.com/dimagi/commcare-android/commit/bc8a7d8ee138c43baee752f2b790709010525f9f", "message": "Don't allow 0,0,0,0 location to be recorded", "committedDate": "2020-08-19T21:07:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMyNTUzOQ==", "url": "https://github.com/dimagi/commcare-android/pull/2320#discussion_r473325539", "bodyText": "this was breaking when there is no initial location set on the map as new location's accuracy is always greater than 0 while base location's accuracy is set to 0 on start up", "author": "shubham1g5", "createdAt": "2020-08-19T21:12:45Z", "path": "app/src/org/commcare/activities/GeoPointMapActivity.java", "diffHunk": "@@ -153,7 +164,8 @@ private void loadProviders() {\n     public void onLocationChanged(Location location) {\n         if (!inViewMode && !isManualSelectedLocation) {\n             if (location != null &&\n-                    (this.location == null || (location.getAccuracy() < this.location.getAccuracy()))) {", "originalCommit": "bc8a7d8ee138c43baee752f2b790709010525f9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwODE1Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2320#discussion_r473608156", "bodyText": "Shouldn't the this.location == null check work when there's no initial location?", "author": "ShivamPokhriyal", "createdAt": "2020-08-20T05:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMyNTUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY2MjY3Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2320#discussion_r473662676", "bodyText": "location is initialized to non null value to start with. So I don't think if it will ever be null.", "author": "shubham1g5", "createdAt": "2020-08-20T06:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMyNTUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY3NzQxMQ==", "url": "https://github.com/dimagi/commcare-android/pull/2320#discussion_r473677411", "bodyText": "Got it, so this.location == null is never going to be true or do you think there can be a possibility of a null location?", "author": "ShivamPokhriyal", "createdAt": "2020-08-20T07:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMyNTUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY4MDY4MA==", "url": "https://github.com/dimagi/commcare-android/pull/2320#discussion_r473680680", "bodyText": "yeah, I don't think there is such a possibility though have not removed it to minimize changes in the hotfix", "author": "shubham1g5", "createdAt": "2020-08-20T07:13:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMyNTUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwNDcwNA==", "url": "https://github.com/dimagi/commcare-android/pull/2320#discussion_r473604704", "bodyText": "What if location is null?", "author": "ShivamPokhriyal", "createdAt": "2020-08-20T05:26:04Z", "path": "app/src/org/commcare/activities/GeoPointMapActivity.java", "diffHunk": "@@ -120,12 +123,20 @@ private void changeMapLayer() {\n     }\n \n     private void returnLocation() {\n-        if (location != null) {\n+        if (location != null &&\n+                (location.getLatitude() == 0d && location.getLongitude() == 0d && location.getAccuracy() == 0d)) {\n+            // we do not have a location fix yet, show an error to the user\n+            Toast.makeText(\n+                    this,\n+                    StringUtils.getStringRobust(CommCareApplication.instance(), R.string.wait_for_location_fix),\n+                    Toast.LENGTH_LONG).show();\n+\n+        } else {\n             Intent i = new Intent();\n             i.putExtra(FormEntryConstants.LOCATION_RESULT, GeoUtils.locationToString(location));", "originalCommit": "bc8a7d8ee138c43baee752f2b790709010525f9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY2MzM2Nw==", "url": "https://github.com/dimagi/commcare-android/pull/2320#discussion_r473663367", "bodyText": "my bad, corrected.", "author": "shubham1g5", "createdAt": "2020-08-20T06:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwNDcwNA=="}], "type": "inlineReview"}, {"oid": "2c54d6d82f8869fe5cef62ecf2891044b24ae8df", "url": "https://github.com/dimagi/commcare-android/commit/2c54d6d82f8869fe5cef62ecf2891044b24ae8df", "message": "Handles null value correctly for location", "committedDate": "2020-08-20T06:51:40Z", "type": "commit"}]}