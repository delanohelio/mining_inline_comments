{"pr_number": 2216, "pr_title": "Add support for in-app updates", "pr_createdAt": "2020-04-11T07:29:04Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2216", "timeline": [{"oid": "d3bf8cc7127e8a1352f5742c4e1fb4b22ac2c384", "url": "https://github.com/dimagi/commcare-android/commit/d3bf8cc7127e8a1352f5742c4e1fb4b22ac2c384", "message": "Add initial code for in-app updates", "committedDate": "2020-04-11T07:27:47Z", "type": "commit"}, {"oid": "6e5b997c7794e8425ada0d3544706a4258f28301", "url": "https://github.com/dimagi/commcare-android/commit/6e5b997c7794e8425ada0d3544706a4258f28301", "message": "Check for updates in home activity", "committedDate": "2020-04-12T05:23:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMyNzA0OA==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r407327048", "bodyText": "Only using flexbile update type here cuz as per this issue it's upto developer to choose the type of update.", "author": "ShivamPokhriyal", "createdAt": "2020-04-13T05:38:40Z", "path": "app/src/org/commcare/appupdate/AppUpdateControllerFactory.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package org.commcare.appupdate;\n+\n+import android.content.Context;\n+import com.google.android.play.core.appupdate.AppUpdateManagerFactory;\n+\n+/**\n+ * A factory that creates {@link AppUpdateController} instance.\n+ * @author $|-|!\u02c5@M\n+ */\n+public class AppUpdateControllerFactory {\n+\n+    /**\n+     * @param callback {@link Runnable} to notify when there is a change in update state.\n+     * @param context Application context of app.\n+     * @return A new {@link FlexibleAppUpdateController} to use for in-app updates\n+     */\n+    public static FlexibleAppUpdateController create(Runnable callback, Context context) {\n+        // TODO: Should we check in-app update is enabled and return a demo or full operational controller?\n+        return new CommcareFlexibleAppUpdateManager(callback, AppUpdateManagerFactory.create(context));", "originalCommit": "6e5b997c7794e8425ada0d3544706a4258f28301", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6e99511d2514da7335925ced1410657b576c71e0", "url": "https://github.com/dimagi/commcare-android/commit/6e99511d2514da7335925ced1410657b576c71e0", "message": "Update docs", "committedDate": "2020-04-13T10:48:28Z", "type": "commit"}, {"oid": "4c95951fd1022749428761204c0f151af6260bc2", "url": "https://github.com/dimagi/commcare-android/commit/4c95951fd1022749428761204c0f151af6260bc2", "message": "Use dummy app updator for pre android 5 devices", "committedDate": "2020-04-17T10:14:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEyOTkxNw==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410129917", "bodyText": "I think it's a good idea to avoid asking users to update CommCare to a specific version if they deny installing the update", "author": "ShivamPokhriyal", "createdAt": "2020-04-17T10:16:13Z", "path": "app/src/org/commcare/activities/StandardHomeActivity.java", "diffHunk": "@@ -246,5 +263,60 @@ public boolean usesSubmissionProgressBar() {\n     public void refreshUI() {\n         uiController.refreshView();\n     }\n-    \n+\n+    @Override\n+    protected void onDestroy() {\n+        appUpdateController.unregister();\n+        super.onDestroy();\n+    }\n+\n+    private void handleAppUpdate() {\n+        AppUpdateState state = appUpdateController.getStatus();\n+        switch (state) {\n+            case UNAVAILABLE:\n+                break;\n+            case AVAILABLE:\n+                StandardAlertDialog alertDialog = StandardAlertDialog.getBasicAlertDialog(this,\n+                        Localization.get(\"in.app.update.available.title\"),\n+                        Localization.get(\"in.app.update.available.detail\"),\n+                        null);\n+                alertDialog.setPositiveButton(Localization.get(\"in.app.update.dialog.update\"), (dialog, which) -> {\n+                    appUpdateController.startUpdate(StandardHomeActivity.this);\n+                    dismissAlertDialog();\n+                });\n+                alertDialog.setNegativeButton(Localization.get(\"in.app.update.dialog.no.thanks\"), (dialog, which) -> {\n+                    appUpdateController.skipVersion();", "originalCommit": "4c95951fd1022749428761204c0f151af6260bc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyOTI1MA==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410729250", "bodyText": "can we have a counter instead, for eg. if they deny 3 times for a particular version then don't show it to them. User might just be busy at times and can deny because of that.", "author": "shubham1g5", "createdAt": "2020-04-18T17:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEyOTkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MjY2MQ==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410742661", "bodyText": "Actually I think it's fine to remove the prompt once user denies it for a particular update 2-3 times though can we give a menu option which only become visible in case an app update is available so that user still has some way to trigger the app update workflow.", "author": "shubham1g5", "createdAt": "2020-04-18T19:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEyOTkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzMDkxOA==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410130918", "bodyText": "This comment seems to suggest that it's up to the developer to start an Immediate or Flexible update.\nSo only using the Flexible update controller here.", "author": "ShivamPokhriyal", "createdAt": "2020-04-17T10:18:21Z", "path": "app/src/org/commcare/appupdate/FlexibleAppUpdateController.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package org.commcare.appupdate;\n+\n+import com.google.android.play.core.install.InstallStateUpdatedListener;\n+\n+/**\n+ * Helper for monitoring flexible app updates using playstore AppUpdateManager.\n+ * @author $|-|!\u02c5@M\n+ */\n+public interface FlexibleAppUpdateController extends AppUpdateController, InstallStateUpdatedListener {", "originalCommit": "4c95951fd1022749428761204c0f151af6260bc2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "93e70a0a7c43d3a036fbb80f2a0a75125aa30bee", "url": "https://github.com/dimagi/commcare-android/commit/93e70a0a7c43d3a036fbb80f2a0a75125aa30bee", "message": "Restrict repeated checking of in-app update in a day", "committedDate": "2020-04-17T10:48:29Z", "type": "commit"}, {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81", "url": "https://github.com/dimagi/commcare-android/commit/63e850ba4d705e09975657d59ff5a8d209322f81", "message": "Fix failing tests", "committedDate": "2020-04-17T13:59:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczNTk3NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410735975", "bodyText": "Confirming Pending doesn't mean that an app update is available but not downloading ?", "author": "shubham1g5", "createdAt": "2020-04-18T18:51:44Z", "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    Logger.log(TAG, \"completeUpdate|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Integer getProgress() {\n+        if (mInstallStatus != InstallStatus.DOWNLOADING) {\n+            return null;\n+        }\n+        return percentageDownloaded;\n+    }\n+\n+    @Override\n+    public int getErrorCode() {\n+        return mInstallErrorCode;\n+    }\n+\n+    @Override\n+    public void skipVersion() {\n+        if (mAppUpdateInfo == null) {\n+            return;\n+        }\n+        int currentAvailableVersion = mAppUpdateInfo.availableVersionCode();\n+        HiddenPreferences.skipCommCareVersionForUpdate(currentAvailableVersion);\n+    }\n+\n+    //endregion\n+\n+    @Override\n+    public void onStateUpdate(InstallState state) {\n+        Logger.log(TAG, \"Install state updated with install status: \" + state.installStatus()\n+                + \", and error code: \" + state.installErrorCode());\n+        mInstallErrorCode = state.installErrorCode();\n+        if (state.installStatus() == InstallStatus.DOWNLOADING) {\n+            // TODO: Should be keep on publishing status for showing download percentage.\n+            // From https://stackoverflow.com/a/10415638/6671572\n+            percentageDownloaded = (int) (state.bytesDownloaded() * 100.0 / state.totalBytesToDownload() + 0.5) ;\n+        }\n+        if (mInstallStatus != state.installStatus()) {\n+            mInstallStatus = state.installStatus();\n+            publishStatus();\n+        }\n+    }\n+\n+    //region Private helpers\n+    private void fetchAppUpdateInfo() {\n+        mAppUpdateManager.getAppUpdateInfo()\n+                .addOnSuccessListener(info -> {\n+                    mAppUpdateInfo = info;\n+                    mUpdateAvailability = info.updateAvailability();\n+                    mInstallStatus = info.installStatus();\n+                    Logger.log(TAG, \"fetchAppUpdateInfo|success with UpdateAvailability : \"\n+                            + mUpdateAvailability + \", and InstallStatus : \" + mInstallStatus);\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    mAppUpdateInfo = null;\n+                    mUpdateAvailability = UpdateAvailability.UNKNOWN;\n+                    mInstallStatus = InstallStatus.UNKNOWN;\n+                    Logger.log(TAG, \"fetchAppUpdateInfo|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    /**\n+     * Pings the listener using {@link #mCallback} when there is an update regarding installation state.\n+     */\n+    private void publishStatus() {\n+        if (!mEnabled) {\n+            return;\n+        }\n+        AppUpdateState newState = getAppUpdateState();\n+        if (mAppUpdateState == newState) {\n+            return;\n+        }\n+        Logger.log(TAG, \"Publishing status update to : \" + newState.name() + \", from : \"\n+                + (mAppUpdateState != null ? mAppUpdateState.name() : \"null\"));\n+        mAppUpdateState = newState;\n+        mCallback.run();\n+    }\n+\n+    /**\n+     * Gets {@link AppUpdateState} using {@link #mUpdateAvailability} and {@link #mInstallStatus}\n+     */\n+    private AppUpdateState getAppUpdateState() {\n+        if (mAppUpdateInfo != null && mAppUpdateInfo.availableVersionCode() == HiddenPreferences.getSkippedCommCareUpdateVersion()) {\n+            return AppUpdateState.UNAVAILABLE;\n+        }\n+        AppUpdateState state = AppUpdateState.UNAVAILABLE;\n+        switch (mInstallStatus) {\n+            case InstallStatus.PENDING:", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkyMTE5NA==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411921194", "bodyText": "@ShivamPokhriyal  bumping the query.", "author": "shubham1g5", "createdAt": "2020-04-21T06:57:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczNTk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAxNTM1OA==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r412015358", "bodyText": "Ohh, I missed it. The Pending status means that the downloading is paused maybe due to internet issues.", "author": "ShivamPokhriyal", "createdAt": "2020-04-21T09:13:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczNTk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTM1NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410739355", "bodyText": "ununsed", "author": "shubham1g5", "createdAt": "2020-04-18T19:18:28Z", "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTM4Mw==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410739383", "bodyText": "private", "author": "shubham1g5", "createdAt": "2020-04-18T19:18:40Z", "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTkxOA==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410739918", "bodyText": "since this would get repeatedly called in middle of an update download, we should avoid the general log statement here in order to reduce noise.", "author": "shubham1g5", "createdAt": "2020-04-18T19:23:21Z", "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    Logger.log(TAG, \"completeUpdate|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Integer getProgress() {\n+        if (mInstallStatus != InstallStatus.DOWNLOADING) {\n+            return null;\n+        }\n+        return percentageDownloaded;\n+    }\n+\n+    @Override\n+    public int getErrorCode() {\n+        return mInstallErrorCode;\n+    }\n+\n+    @Override\n+    public void skipVersion() {\n+        if (mAppUpdateInfo == null) {\n+            return;\n+        }\n+        int currentAvailableVersion = mAppUpdateInfo.availableVersionCode();\n+        HiddenPreferences.skipCommCareVersionForUpdate(currentAvailableVersion);\n+    }\n+\n+    //endregion\n+\n+    @Override\n+    public void onStateUpdate(InstallState state) {\n+        Logger.log(TAG, \"Install state updated with install status: \" + state.installStatus()", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MDAyOA==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410740028", "bodyText": "not sure if todo is still required ?", "author": "shubham1g5", "createdAt": "2020-04-18T19:24:09Z", "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    Logger.log(TAG, \"completeUpdate|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Integer getProgress() {\n+        if (mInstallStatus != InstallStatus.DOWNLOADING) {\n+            return null;\n+        }\n+        return percentageDownloaded;\n+    }\n+\n+    @Override\n+    public int getErrorCode() {\n+        return mInstallErrorCode;\n+    }\n+\n+    @Override\n+    public void skipVersion() {\n+        if (mAppUpdateInfo == null) {\n+            return;\n+        }\n+        int currentAvailableVersion = mAppUpdateInfo.availableVersionCode();\n+        HiddenPreferences.skipCommCareVersionForUpdate(currentAvailableVersion);\n+    }\n+\n+    //endregion\n+\n+    @Override\n+    public void onStateUpdate(InstallState state) {\n+        Logger.log(TAG, \"Install state updated with install status: \" + state.installStatus()\n+                + \", and error code: \" + state.installErrorCode());\n+        mInstallErrorCode = state.installErrorCode();\n+        if (state.installStatus() == InstallStatus.DOWNLOADING) {\n+            // TODO: Should be keep on publishing status for showing download percentage.", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MDU2MQ==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410740561", "bodyText": "guessing todo can be removed.", "author": "shubham1g5", "createdAt": "2020-04-18T19:28:56Z", "path": "app/src/org/commcare/activities/StandardHomeActivity.java", "diffHunk": "@@ -246,5 +264,63 @@ public boolean usesSubmissionProgressBar() {\n     public void refreshUI() {\n         uiController.refreshView();\n     }\n-    \n+\n+    @Override\n+    protected void onDestroy() {\n+        appUpdateController.unregister();\n+        super.onDestroy();\n+    }\n+\n+    private void handleAppUpdate() {\n+        AppUpdateState state = appUpdateController.getStatus();\n+        switch (state) {\n+            case UNAVAILABLE:\n+                if (ConnectivityStatus.isNetworkAvailable(this)) {\n+                    HiddenPreferences.setLastInAppUpdateCheckTime(System.currentTimeMillis());\n+                }\n+                break;\n+            case AVAILABLE:\n+                StandardAlertDialog alertDialog = StandardAlertDialog.getBasicAlertDialog(this,\n+                        Localization.get(\"in.app.update.available.title\"),\n+                        Localization.get(\"in.app.update.available.detail\"),\n+                        null);\n+                alertDialog.setPositiveButton(Localization.get(\"in.app.update.dialog.update\"), (dialog, which) -> {\n+                    appUpdateController.startUpdate(StandardHomeActivity.this);\n+                    dismissAlertDialog();\n+                });\n+                alertDialog.setNegativeButton(Localization.get(\"in.app.update.dialog.no.thanks\"), (dialog, which) -> {\n+                    appUpdateController.skipVersion();\n+                    dismissAlertDialog();\n+                });\n+                showAlertDialog(alertDialog);\n+                break;\n+            case DOWNLOADING:\n+                // TODO: Should we use appUpdateController's getProgress to show something here?", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MTA4NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410741085", "bodyText": "Guessing this call to publishStatus() would not do anything as app gets restarted on success and thus listeners won't be active.", "author": "shubham1g5", "createdAt": "2020-04-18T19:33:49Z", "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MTM2Nw==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410741367", "bodyText": "we should move all the in app update code here to the HomeScreenBaseActivity in order to support all different versions of the home activity.", "author": "shubham1g5", "createdAt": "2020-04-18T19:36:44Z", "path": "app/src/org/commcare/activities/StandardHomeActivity.java", "diffHunk": "@@ -44,10 +57,15 @@\n \n     private StandardHomeActivityUIController uiController;\n \n+    private FlexibleAppUpdateController appUpdateController;\n+    private static final String APP_UPDATE_NOTIFICATION = \"app_update_notification\";\n+\n     @Override\n     public void onCreateSessionSafe(Bundle savedInstanceState) {\n         super.onCreateSessionSafe(savedInstanceState);\n         uiController.setupUI();\n+        appUpdateController = AppUpdateControllerFactory.create(this::handleAppUpdate, getApplicationContext());", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MTQxNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410741415", "bodyText": "it would be great to show error code specific messages to the user and also log it to the sumo if it's not getting logged earlier in the process.", "author": "shubham1g5", "createdAt": "2020-04-18T19:37:13Z", "path": "app/src/org/commcare/activities/StandardHomeActivity.java", "diffHunk": "@@ -246,5 +264,63 @@ public boolean usesSubmissionProgressBar() {\n     public void refreshUI() {\n         uiController.refreshView();\n     }\n-    \n+\n+    @Override\n+    protected void onDestroy() {\n+        appUpdateController.unregister();\n+        super.onDestroy();\n+    }\n+\n+    private void handleAppUpdate() {\n+        AppUpdateState state = appUpdateController.getStatus();\n+        switch (state) {\n+            case UNAVAILABLE:\n+                if (ConnectivityStatus.isNetworkAvailable(this)) {\n+                    HiddenPreferences.setLastInAppUpdateCheckTime(System.currentTimeMillis());\n+                }\n+                break;\n+            case AVAILABLE:\n+                StandardAlertDialog alertDialog = StandardAlertDialog.getBasicAlertDialog(this,\n+                        Localization.get(\"in.app.update.available.title\"),\n+                        Localization.get(\"in.app.update.available.detail\"),\n+                        null);\n+                alertDialog.setPositiveButton(Localization.get(\"in.app.update.dialog.update\"), (dialog, which) -> {\n+                    appUpdateController.startUpdate(StandardHomeActivity.this);\n+                    dismissAlertDialog();\n+                });\n+                alertDialog.setNegativeButton(Localization.get(\"in.app.update.dialog.no.thanks\"), (dialog, which) -> {\n+                    appUpdateController.skipVersion();\n+                    dismissAlertDialog();\n+                });\n+                showAlertDialog(alertDialog);\n+                break;\n+            case DOWNLOADING:\n+                // TODO: Should we use appUpdateController's getProgress to show something here?\n+                // Though native downloads app gives a notification regarding the current download in progress.\n+                NotificationMessage message = NotificationMessageFactory.message(\n+                        NotificationMessageFactory.StockMessages.InApp_Update, APP_UPDATE_NOTIFICATION);\n+                CommCareApplication.notificationManager().reportNotificationMessage(message);\n+                break;\n+            case DOWNLOADED:\n+                CommCareApplication.notificationManager().clearNotifications(APP_UPDATE_NOTIFICATION);\n+                StandardAlertDialog dialog = StandardAlertDialog.getBasicAlertDialog(this,\n+                        Localization.get(\"in.app.update.installed.title\"),\n+                        Localization.get(\"in.app.update.installed.detail\"),\n+                        null);\n+                dialog.setPositiveButton(Localization.get(\"in.app.update.dialog.restart\"), (dialog1, which) -> {\n+                    appUpdateController.completeUpdate();\n+                    dismissAlertDialog();\n+                });\n+                dialog.setNegativeButton(Localization.get(\"in.app.update.dialog.cancel\"), (dialog1, which) -> {\n+                    dismissAlertDialog();\n+                });\n+                showAlertDialog(dialog);\n+                break;\n+            case FAILED:\n+                // TODO: We might wanna use appUpdateController's getErrorCode here.\n+                CommCareApplication.notificationManager().clearNotifications(APP_UPDATE_NOTIFICATION);\n+                Toast.makeText(this, Localization.get(\"in.app.update.failed\"), Toast.LENGTH_LONG).show();", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MTgwNA==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410741804", "bodyText": "We can omit the success logs here as this will be triggered every time user comes on Home screen.", "author": "shubham1g5", "createdAt": "2020-04-18T19:40:41Z", "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    Logger.log(TAG, \"completeUpdate|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Integer getProgress() {\n+        if (mInstallStatus != InstallStatus.DOWNLOADING) {\n+            return null;\n+        }\n+        return percentageDownloaded;\n+    }\n+\n+    @Override\n+    public int getErrorCode() {\n+        return mInstallErrorCode;\n+    }\n+\n+    @Override\n+    public void skipVersion() {\n+        if (mAppUpdateInfo == null) {\n+            return;\n+        }\n+        int currentAvailableVersion = mAppUpdateInfo.availableVersionCode();\n+        HiddenPreferences.skipCommCareVersionForUpdate(currentAvailableVersion);\n+    }\n+\n+    //endregion\n+\n+    @Override\n+    public void onStateUpdate(InstallState state) {\n+        Logger.log(TAG, \"Install state updated with install status: \" + state.installStatus()\n+                + \", and error code: \" + state.installErrorCode());\n+        mInstallErrorCode = state.installErrorCode();\n+        if (state.installStatus() == InstallStatus.DOWNLOADING) {\n+            // TODO: Should be keep on publishing status for showing download percentage.\n+            // From https://stackoverflow.com/a/10415638/6671572\n+            percentageDownloaded = (int) (state.bytesDownloaded() * 100.0 / state.totalBytesToDownload() + 0.5) ;\n+        }\n+        if (mInstallStatus != state.installStatus()) {\n+            mInstallStatus = state.installStatus();\n+            publishStatus();\n+        }\n+    }\n+\n+    //region Private helpers\n+    private void fetchAppUpdateInfo() {\n+        mAppUpdateManager.getAppUpdateInfo()\n+                .addOnSuccessListener(info -> {\n+                    mAppUpdateInfo = info;\n+                    mUpdateAvailability = info.updateAvailability();\n+                    mInstallStatus = info.installStatus();\n+                    Logger.log(TAG, \"fetchAppUpdateInfo|success with UpdateAvailability : \"", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MjAyMQ==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410742021", "bodyText": "this should be saved in Global prefs rather than app prefs as it's going to be same across all CommCare apps installed on CommCare.", "author": "shubham1g5", "createdAt": "2020-04-18T19:42:55Z", "path": "app/src/org/commcare/preferences/HiddenPreferences.java", "diffHunk": "@@ -446,4 +448,26 @@ public static void enableBypassPreUpdateSync(boolean enable) {\n     public static boolean shouldBypassPreUpdateSync() {\n         return CommCareApplication.instance().getCurrentApp().getAppPreferences().getBoolean(BYPASS_PRE_UPDATE_SYNC, false);\n     }\n+\n+    public static void skipCommCareVersionForUpdate(int version) {\n+        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n+                .edit()\n+                .putInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, version)\n+                .apply();\n+    }\n+\n+    public static int getSkippedCommCareUpdateVersion() {\n+        return CommCareApplication.instance().getCurrentApp().getAppPreferences().getInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, -1);\n+    }\n+\n+    public static void setLastInAppUpdateCheckTime(long millis) {", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MjE0Nw==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410742147", "bodyText": "should be saved in Global prefs instead of app prefs.", "author": "shubham1g5", "createdAt": "2020-04-18T19:43:35Z", "path": "app/src/org/commcare/preferences/HiddenPreferences.java", "diffHunk": "@@ -446,4 +448,26 @@ public static void enableBypassPreUpdateSync(boolean enable) {\n     public static boolean shouldBypassPreUpdateSync() {\n         return CommCareApplication.instance().getCurrentApp().getAppPreferences().getBoolean(BYPASS_PRE_UPDATE_SYNC, false);\n     }\n+\n+    public static void skipCommCareVersionForUpdate(int version) {", "originalCommit": "63e850ba4d705e09975657d59ff5a8d209322f81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5993933d851894e29c336ac8dfa1e266f14f2dfd", "url": "https://github.com/dimagi/commcare-android/commit/5993933d851894e29c336ac8dfa1e266f14f2dfd", "message": "PR suggestions", "committedDate": "2020-04-20T07:16:11Z", "type": "commit"}, {"oid": "9048df5063a6fc9196c6c006586e8bb63daddb4c", "url": "https://github.com/dimagi/commcare-android/commit/9048df5063a6fc9196c6c006586e8bb63daddb4c", "message": "Remove buggy null check", "committedDate": "2020-04-20T14:59:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxNTA4Nw==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411915087", "bodyText": "Instead of AppUpdate we should use already available LogTypes as tag. If none of them satsify the particular log, we shoud add to the existing log types and refer it here. Also we should add a prefix like \"Commcare In App Update failed because\" to the log message, this helps us in quickly lookup the log source in code.", "author": "shubham1g5", "createdAt": "2020-04-21T06:46:59Z", "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -1280,4 +1303,81 @@ public void setFormAndDataSyncer(FormAndDataSyncer formAndDataSyncer) {\n \n     abstract void refreshUI();\n \n+    abstract void refreshCCUpdateOption();\n+\n+    @Override\n+    protected void onDestroy() {\n+        appUpdateController.unregister();\n+        super.onDestroy();\n+    }\n+\n+    protected void startCommCareUpdate() {\n+        appUpdateController.startUpdate(this);\n+    }\n+\n+    private void handleAppUpdate() {\n+        AppUpdateState state = appUpdateController.getStatus();\n+        switch (state) {\n+            case UNAVAILABLE:\n+                if (ConnectivityStatus.isNetworkAvailable(this)) {\n+                    HiddenPreferences.setLastInAppUpdateCheckTime(System.currentTimeMillis());\n+                }\n+                break;\n+            case AVAILABLE:\n+                if (HiddenPreferences.isCommCareUpdateCancelled(String.valueOf(appUpdateController.availableVersionCode())) > 3) {\n+                    showCommCareUpdateMenu = true;\n+                    refreshCCUpdateOption();\n+                    return;\n+                }\n+                startCommCareUpdate();\n+                break;\n+            case DOWNLOADING:\n+                // Native downloads app gives a notification regarding the current download in progress.\n+                NotificationMessage message = NotificationMessageFactory.message(\n+                        NotificationMessageFactory.StockMessages.InApp_Update, APP_UPDATE_NOTIFICATION);\n+                CommCareApplication.notificationManager().reportNotificationMessage(message);\n+                break;\n+            case DOWNLOADED:\n+                CommCareApplication.notificationManager().clearNotifications(APP_UPDATE_NOTIFICATION);\n+                StandardAlertDialog dialog = StandardAlertDialog.getBasicAlertDialog(this,\n+                        Localization.get(\"in.app.update.installed.title\"),\n+                        Localization.get(\"in.app.update.installed.detail\"),\n+                        null);\n+                dialog.setPositiveButton(Localization.get(\"in.app.update.dialog.restart\"), (dialog1, which) -> {\n+                    appUpdateController.completeUpdate();\n+                    dismissAlertDialog();\n+                });\n+                dialog.setNegativeButton(Localization.get(\"in.app.update.dialog.cancel\"), (dialog1, which) -> {\n+                    dismissAlertDialog();\n+                });\n+                showAlertDialog(dialog);\n+                break;\n+            case FAILED:\n+                String errorReason = \"in.app.update.error.unknown\";\n+                switch (appUpdateController.getErrorCode()) {\n+                    case InstallErrorCode.ERROR_INSTALL_NOT_ALLOWED:\n+                        errorReason = \"in.app.update.error.not.allowed\";\n+                        break;\n+                    case InstallErrorCode.NO_ERROR_PARTIALLY_ALLOWED:\n+                        errorReason = \"in.app.update.error.partially.allowed\";\n+                        break;\n+                    case InstallErrorCode.ERROR_UNKNOWN:\n+                        errorReason = \"in.app.update.error.unknown\";\n+                        break;\n+                    case InstallErrorCode.ERROR_PLAY_STORE_NOT_FOUND:\n+                        errorReason = \"in.app.update.error.playstore\";\n+                        break;\n+                    case InstallErrorCode.ERROR_INVALID_REQUEST:\n+                        errorReason = \"in.app.update.error.invalid.request\";\n+                        break;\n+                    case InstallErrorCode.ERROR_INTERNAL_ERROR:\n+                        errorReason = \"in.app.update.error.internal.error\";\n+                        break;\n+                }\n+                Logger.log(\"AppUpdate\", errorReason);", "originalCommit": "9048df5063a6fc9196c6c006586e8bb63daddb4c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxNjEwMw==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411916103", "bodyText": "Nit: Should use a constant declaration instead of hardcoding 3", "author": "shubham1g5", "createdAt": "2020-04-21T06:48:52Z", "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -1280,4 +1303,81 @@ public void setFormAndDataSyncer(FormAndDataSyncer formAndDataSyncer) {\n \n     abstract void refreshUI();\n \n+    abstract void refreshCCUpdateOption();\n+\n+    @Override\n+    protected void onDestroy() {\n+        appUpdateController.unregister();\n+        super.onDestroy();\n+    }\n+\n+    protected void startCommCareUpdate() {\n+        appUpdateController.startUpdate(this);\n+    }\n+\n+    private void handleAppUpdate() {\n+        AppUpdateState state = appUpdateController.getStatus();\n+        switch (state) {\n+            case UNAVAILABLE:\n+                if (ConnectivityStatus.isNetworkAvailable(this)) {\n+                    HiddenPreferences.setLastInAppUpdateCheckTime(System.currentTimeMillis());\n+                }\n+                break;\n+            case AVAILABLE:\n+                if (HiddenPreferences.isCommCareUpdateCancelled(String.valueOf(appUpdateController.availableVersionCode())) > 3) {", "originalCommit": "9048df5063a6fc9196c6c006586e8bb63daddb4c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkyMjMzNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411922335", "bodyText": "Nit: A better function name would be incrementCommCareUpdateCancellationCounter", "author": "shubham1g5", "createdAt": "2020-04-21T06:59:48Z", "path": "app/src/org/commcare/preferences/HiddenPreferences.java", "diffHunk": "@@ -449,25 +448,25 @@ public static boolean shouldBypassPreUpdateSync() {\n         return CommCareApplication.instance().getCurrentApp().getAppPreferences().getBoolean(BYPASS_PRE_UPDATE_SYNC, false);\n     }\n \n-    public static void skipCommCareVersionForUpdate(int version) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n+    public static void setLastInAppUpdateCheckTime(long millis) {\n+        PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n                 .edit()\n-                .putInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, version)\n+                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n                 .apply();\n     }\n \n-    public static int getSkippedCommCareUpdateVersion() {\n-        return CommCareApplication.instance().getCurrentApp().getAppPreferences().getInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, -1);\n+    public static long getLastInAppUpdateCheckTime() {\n+        return PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n+                .getLong(LAST_IN_APP_UPDATE_CHECK_TIME, -1);\n     }\n \n-    public static void setLastInAppUpdateCheckTime(long millis) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n-                .edit()\n-                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n-                .apply();\n+    public static void cancelCommCareUpdate(String version) {", "originalCommit": "9048df5063a6fc9196c6c006586e8bb63daddb4c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkyMjc0Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411922742", "bodyText": "Nit: function name suggestion: getCommCareUpdateCancellationConter", "author": "shubham1g5", "createdAt": "2020-04-21T07:00:34Z", "path": "app/src/org/commcare/preferences/HiddenPreferences.java", "diffHunk": "@@ -449,25 +448,25 @@ public static boolean shouldBypassPreUpdateSync() {\n         return CommCareApplication.instance().getCurrentApp().getAppPreferences().getBoolean(BYPASS_PRE_UPDATE_SYNC, false);\n     }\n \n-    public static void skipCommCareVersionForUpdate(int version) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n+    public static void setLastInAppUpdateCheckTime(long millis) {\n+        PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n                 .edit()\n-                .putInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, version)\n+                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n                 .apply();\n     }\n \n-    public static int getSkippedCommCareUpdateVersion() {\n-        return CommCareApplication.instance().getCurrentApp().getAppPreferences().getInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, -1);\n+    public static long getLastInAppUpdateCheckTime() {\n+        return PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n+                .getLong(LAST_IN_APP_UPDATE_CHECK_TIME, -1);\n     }\n \n-    public static void setLastInAppUpdateCheckTime(long millis) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n-                .edit()\n-                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n-                .apply();\n+    public static void cancelCommCareUpdate(String version) {\n+        SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance());\n+        int count = sharedPreferences.getInt(version, 0);\n+        sharedPreferences.edit().putInt(version, count + 1).apply();\n     }\n \n-    public static long getLastInAppUpdateCheckTime() {\n-        return CommCareApplication.instance().getCurrentApp().getAppPreferences().getLong(LAST_IN_APP_UPDATE_CHECK_TIME, -1);\n+    public static int isCommCareUpdateCancelled(String version) {", "originalCommit": "9048df5063a6fc9196c6c006586e8bb63daddb4c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkyMzQ4NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411923485", "bodyText": "we should prefix the key with a constant to make it more explicit for eg - COMMCARE_UPDATE_CANCELLATION_COUNTER + \"_\" + version", "author": "shubham1g5", "createdAt": "2020-04-21T07:01:50Z", "path": "app/src/org/commcare/preferences/HiddenPreferences.java", "diffHunk": "@@ -449,25 +448,25 @@ public static boolean shouldBypassPreUpdateSync() {\n         return CommCareApplication.instance().getCurrentApp().getAppPreferences().getBoolean(BYPASS_PRE_UPDATE_SYNC, false);\n     }\n \n-    public static void skipCommCareVersionForUpdate(int version) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n+    public static void setLastInAppUpdateCheckTime(long millis) {\n+        PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n                 .edit()\n-                .putInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, version)\n+                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n                 .apply();\n     }\n \n-    public static int getSkippedCommCareUpdateVersion() {\n-        return CommCareApplication.instance().getCurrentApp().getAppPreferences().getInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, -1);\n+    public static long getLastInAppUpdateCheckTime() {\n+        return PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n+                .getLong(LAST_IN_APP_UPDATE_CHECK_TIME, -1);\n     }\n \n-    public static void setLastInAppUpdateCheckTime(long millis) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n-                .edit()\n-                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n-                .apply();\n+    public static void cancelCommCareUpdate(String version) {\n+        SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance());\n+        int count = sharedPreferences.getInt(version, 0);", "originalCommit": "9048df5063a6fc9196c6c006586e8bb63daddb4c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8075c789b0c32cf1c08e3b5c4024157a50ad9a6f", "url": "https://github.com/dimagi/commcare-android/commit/8075c789b0c32cf1c08e3b5c4024157a50ad9a6f", "message": "Add minor suggested changes", "committedDate": "2020-04-21T09:45:06Z", "type": "commit"}, {"oid": "ef45b6f08dee6bdf53d5d6bfcb3f02578127a799", "url": "https://github.com/dimagi/commcare-android/commit/ef45b6f08dee6bdf53d5d6bfcb3f02578127a799", "message": "Use new app update flow with prompted updates", "committedDate": "2020-04-22T08:41:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzODE1MA==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r413538150", "bodyText": "If the update is not available from play core APIs (For sideloaded apps), does the old behaviour of prompts remains the same. Asking because ICDS uses this prompt functionality with CommCare mostly sideloaded on their phones and these changes should not affect those users.", "author": "shubham1g5", "createdAt": "2020-04-23T06:17:08Z", "path": "app/src/org/commcare/activities/PromptApkUpdateActivity.java", "diffHunk": "@@ -26,6 +45,93 @@ protected void onCreate(Bundle savedInstanceState) {\n         } catch (SessionUnavailableException e) {\n             // we are showing the prompt before user login, so nothing to mark\n         }\n+        if (toPrompt.isForced()) {", "originalCommit": "ef45b6f08dee6bdf53d5d6bfcb3f02578127a799", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU0NTUzMQ==", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r413545531", "bodyText": "Yeah, there is no change in old behaviour, The new UI will come on top of older UI so if it fails the older functionality can take over.", "author": "ShivamPokhriyal", "createdAt": "2020-04-23T06:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzODE1MA=="}], "type": "inlineReview"}, {"oid": "51fad1ca016e646ca1c38eea786a59cbb7eaf97d", "url": "https://github.com/dimagi/commcare-android/commit/51fad1ca016e646ca1c38eea786a59cbb7eaf97d", "message": "Show in-app update only once per session", "committedDate": "2020-04-23T14:09:10Z", "type": "commit"}]}