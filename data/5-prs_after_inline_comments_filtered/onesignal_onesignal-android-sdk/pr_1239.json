{"pr_number": 1239, "pr_title": "Iam carousel page impressions", "pr_createdAt": "2020-12-10T18:15:15Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239", "timeline": [{"oid": "142e4b4d124c36096b5aeaf400df6205ad404358", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/142e4b4d124c36096b5aeaf400df6205ad404358", "message": "adding pageIds to OSInAppMessage", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "999ca8d5f4998b5c06575e8f84515994ba36aa5d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/999ca8d5f4998b5c06575e8f84515994ba36aa5d", "message": "adding page Id to in app message action", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "24d41f005ce9be4b808e2e5bfc95fa90eec78436", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/24d41f005ce9be4b808e2e5bfc95fa90eec78436", "message": "creating OSInAppMessagePage class", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "2d04a710668e95d98d072611488def7a3ee16127", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/2d04a710668e95d98d072611488def7a3ee16127", "message": "adding page impression rest call and page changed logic", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "565f47671c2dfe73426ed0a49471b13d6e12dafb", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/565f47671c2dfe73426ed0a49471b13d6e12dafb", "message": "firing onPageChanged from json event", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "0149a12c6d25806e583d070864564e52fbd0860b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0149a12c6d25806e583d070864564e52fbd0860b", "message": "Unit test for page changed event", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "04790085256c86606e69a3f5c622f4a562a2c039", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/04790085256c86606e69a3f5c622f4a562a2c039", "message": "matching json to backend spec change", "committedDate": "2020-12-10T00:14:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r540608267", "bodyText": "Looks like this is a TODO yet?", "author": "jkasten2", "createdAt": "2020-12-11T00:49:18Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId))\n+            return;\n+\n+        message.addPageId(page.getPageId());\n+\n+        try {\n+            JSONObject json = new JSONObject() {{\n+                put(\"app_id\", OneSignal.appId);\n+                put(\"player_id\", OneSignal.getUserId());\n+                put(\"variant_id\", variantId);\n+                put(\"device_type\", new OSUtils().getDeviceType());\n+                put(\"page_id\", pageId);\n+            }};\n+\n+            OneSignalRestClient.post(\"in_app_messages/\" + message.messageId + \"/pageImpression\", json, new ResponseHandler() {\n+                @Override\n+                void onSuccess(String response) {\n+                    printHttpSuccessForInAppMessageRequest(\"page impression\", response);\n+                    /*OneSignalPrefs.saveStringSet(", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDY1Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541134653", "bodyText": "Yes this was my question at the end of the PR do we need to save the ids to the prefs?", "author": "emawby", "createdAt": "2020-12-11T18:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIzNjAwMQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541236001", "bodyText": "The only scenario that I think needs this.\n1 - Opening app\n2 - Display IAM\n3 - Impression sent\n4 - Close application (swipe away) without dismiss IAM\n5 - Open app\n6 - IAM should display again\n7 - Impression shouldn't be sent again", "author": "Jeasmine", "createdAt": "2020-12-11T20:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM0MTExMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541341110", "bodyText": "Cool confirmed that this is an issue so I will store them in the prefs", "author": "emawby", "createdAt": "2020-12-11T22:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzMzUxNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541133514", "bodyText": "this is marked as notNull but\npageId = json.optString(PAGE_ID, null); it could end being null, maybe set a default value? tr change to Nullable", "author": "Jeasmine", "createdAt": "2020-12-11T18:10:23Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageAction.java", "diffHunk": "@@ -125,6 +133,11 @@ public String getClickName() {\n         return clickName;\n     }\n \n+    @NonNull", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1OTEwMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542659100", "bodyText": "fixed!", "author": "emawby", "createdAt": "2020-12-14T19:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzMzUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDQ2Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541134466", "bodyText": "remove extra enter", "author": "Jeasmine", "createdAt": "2020-12-11T18:11:53Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1ODkyOQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542658929", "bodyText": "fixed!", "author": "emawby", "createdAt": "2020-12-14T19:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDgyNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541134826", "bodyText": "this is checked under onPageChanged too, is that ok?", "author": "Jeasmine", "createdAt": "2020-12-11T18:12:27Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId))", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1MTc2OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542651768", "bodyText": "Now only checking in the rest method call for consistency with iOS and better separation of concerns", "author": "emawby", "createdAt": "2020-12-14T19:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541139337", "bodyText": "is this needed?", "author": "Jeasmine", "createdAt": "2020-12-11T18:20:32Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -616,4 +616,19 @@ public void testOnMessageWasShown() throws Exception {\n         assertEquals(1, iamImpressionRequest.payload.get(\"device_type\"));\n         assertEquals(true, iamImpressionRequest.payload.get(\"first_impression\"));\n     }\n+\n+    @Test\n+    public void testOnPageChanged() throws Exception {\n+        threadAndTaskWait();", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1ODc1NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542658754", "bodyText": "yes it crashes without it", "author": "emawby", "createdAt": "2020-12-14T19:07:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4NzMwNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542687305", "bodyText": "oh, weird \ud83e\udd14  test setup should not break tests, can you point out which error it is?", "author": "Jeasmine", "createdAt": "2020-12-14T19:32:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyODU4MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542828581", "bodyText": "Ah sorry the crash can be fixed, but you need to initialize to have the player id etc for the request", "author": "emawby", "createdAt": "2020-12-14T21:45:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTgzNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541139837", "bodyText": "is ok to test without mocking the IAM display?", "author": "Jeasmine", "createdAt": "2020-12-11T18:21:25Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -616,4 +616,19 @@ public void testOnMessageWasShown() throws Exception {\n         assertEquals(1, iamImpressionRequest.payload.get(\"device_type\"));\n         assertEquals(true, iamImpressionRequest.payload.get(\"first_impression\"));\n     }\n+\n+    @Test\n+    public void testOnPageChanged() throws Exception {\n+        threadAndTaskWait();\n+\n+        OneSignalPackagePrivateHelper.onPageChanged(message, InAppMessagingHelpers.buildTestPageJson());", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1NTU2Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542655563", "bodyText": "Yes we test without mocking the iam display for clicks as well and they should be entirely independent", "author": "emawby", "createdAt": "2020-12-14T19:04:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MDA1OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542690059", "bodyText": "same question as on iOS, see OneSignal/OneSignal-iOS-SDK#735 (comment)", "author": "Jeasmine", "createdAt": "2020-12-14T19:35:22Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +429,62 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void saveViewedPageIdsToPrefs() {\n+        OneSignalPrefs.saveStringSet(\n+                OneSignalPrefs.PREFS_ONESIGNAL,\n+                OneSignalPrefs.PREFS_OS_PAGE_IMPRESSIONED_IAMS,\n+                // Post success, store impressioned pages to disk\n+                viewedPageIds);\n+    }\n+\n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+        final String messagePrefixedPageId = message.messageId + pageId;\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId) || viewedPageIds.contains(messagePrefixedPageId)) {", "originalCommit": "9a428549751e320600989f56c94f53c976fc4e98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyODIwMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542828203", "bodyText": "same fix as ios. only tracking globally now, but it is still per inapp since we don't want them to affect each other (in local testing I was getting duplicate page ids for different inapps which is why I prefixed the page id with the message id)", "author": "emawby", "createdAt": "2020-12-14T21:45:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MDA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4NzI0Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r543687242", "bodyText": "can we put some comment over this desition of cleaning impressions, so we know in the future?", "author": "Jeasmine", "createdAt": "2020-12-15T21:08:25Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -494,6 +568,8 @@ private void setDataForRedisplay(OSInAppMessage message) {\n \n                 dismissedMessages.remove(message.messageId);\n                 impressionedMessages.remove(message.messageId);\n+                viewedPageIds.clear();", "originalCommit": "ba6373650125d7b6aa152380d99e949d35f96db5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5ODk5MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r544598991", "bodyText": "done!", "author": "emawby", "createdAt": "2020-12-16T20:24:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4NzI0Mg=="}], "type": "inlineReview"}, {"oid": "9fd95407f21bc626ef23fb78469313778f582a14", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/9fd95407f21bc626ef23fb78469313778f582a14", "message": "adding clarifying comment", "committedDate": "2020-12-16T20:24:24Z", "type": "forcePushed"}, {"oid": "1a8c6a90e71b76cae762afac8ef26460fdc9fa3b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1a8c6a90e71b76cae762afac8ef26460fdc9fa3b", "message": "Storing pageIds to prefs to fix double impression", "committedDate": "2020-12-23T22:23:36Z", "type": "forcePushed"}, {"oid": "d865c2202fe3dcf5a7959140f03eec8c4adba4eb", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d865c2202fe3dcf5a7959140f03eec8c4adba4eb", "message": "removing page id check in pageChanged", "committedDate": "2020-12-23T22:24:04Z", "type": "commit"}, {"oid": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "message": "Storing pageIds to prefs to fix double impression", "committedDate": "2020-12-23T22:24:04Z", "type": "commit"}, {"oid": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "message": "Storing pageIds to prefs to fix double impression", "committedDate": "2020-12-23T22:24:04Z", "type": "forcePushed"}]}