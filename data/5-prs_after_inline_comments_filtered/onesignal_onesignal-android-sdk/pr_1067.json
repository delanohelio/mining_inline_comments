{"pr_number": 1067, "pr_title": "Create GMS and HMS Location controller", "pr_createdAt": "2020-06-15T04:09:42Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1067", "timeline": [{"oid": "1a8c5abd690fae0fb1894f7042bc0e12b2d4f449", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1a8c5abd690fae0fb1894f7042bc0e12b2d4f449", "message": "Create GMS and HMS Loction controller\n\n   * Separate location controller by platform", "committedDate": "2020-06-15T04:10:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0NzY3MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1067#discussion_r440347670", "bodyText": "Lets rename this now that its an extended class controller\nMaybe\nOSLocationController?\nOneSignalLocationController?\nWe can also leave it as is if you think its fine", "author": "mikechoch", "createdAt": "2020-06-15T17:54:38Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationController.java", "diffHunk": "@@ -56,6 +47,27 @@\n \n class LocationController {", "originalCommit": "1a8c5abd690fae0fb1894f7042bc0e12b2d4f449", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2NTU5MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1067#discussion_r440465591", "bodyText": "I think it is fine to leave for now.", "author": "jkasten2", "createdAt": "2020-06-15T21:47:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0NzY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2ODM2Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1067#discussion_r440468363", "bodyText": "Actually I will like a full refactor for location, but out scope for now.", "author": "Jeasmine", "createdAt": "2020-06-15T21:53:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0NzY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxMzA1OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1067#discussion_r440413059", "bodyText": "Why wrap OSUtils.isHuaweiDeviceType(); when we can just use it directly?", "author": "mikechoch", "createdAt": "2020-06-15T19:58:33Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationController.java", "diffHunk": "@@ -289,106 +269,38 @@ static void startGetLocation() {\n       }\n    }\n \n-   private static void initGoogleLocation() {\n-      // Prevents overlapping requests\n-      if (fallbackFailThread != null)\n-         return;\n-\n-      synchronized (syncLock) {\n-         startFallBackThread();\n-\n-         if (googleApiClient == null || lastLocation == null) {\n-            GoogleApiClientListener googleApiClientListener = new GoogleApiClientListener();\n-            GoogleApiClient googleApiClient = new GoogleApiClient.Builder(classContext)\n-                    .addApi(LocationServices.API)\n-                    .addConnectionCallbacks(googleApiClientListener)\n-                    .addOnConnectionFailedListener(googleApiClientListener)\n-                    .setHandler(locationHandlerThread.mHandler)\n-                    .build();\n-\n-            LocationController.googleApiClient = new GoogleApiClientCompatProxy(googleApiClient);\n-            LocationController.googleApiClient.connect();\n-         } else if (lastLocation != null)\n-            fireCompleteForLocation(lastLocation);\n-      }\n-   }\n-\n-   private static void initHuaweiLocation() {\n+   static void onFocusChange() {\n       synchronized (syncLock) {\n-         if (huaweiFusedLocationClient == null) {\n-            try {\n-               huaweiFusedLocationClient = com.huawei.hms.location.LocationServices.getFusedLocationProviderClient(classContext);\n-            } catch (Exception e) {\n-               OneSignal.Log(OneSignal.LOG_LEVEL.ERROR, \"Huawei LocationServices getFusedLocationProviderClient failed! \" + e);\n-               fireFailedComplete();\n-               return;\n-            }\n+         // Google location not initialized or connected yet\n+         if (isGooglePlayServicesAvailable()) {\n+            GMSLocationController.onFocusChange();\n+            return;\n          }\n-         if (lastLocation != null)\n-            fireCompleteForLocation(lastLocation);\n-         else\n-            huaweiFusedLocationClient.getLastLocation()\n-                    .addOnSuccessListener(new com.huawei.hmf.tasks.OnSuccessListener<Location>() {\n-                       @Override\n-                       public void onSuccess(Location location) {\n-                          OneSignal.Log(OneSignal.LOG_LEVEL.WARN, \"Huawei LocationServices getLastLocation returned location: \" + location);\n-                          if (location == null) {\n-                             fireFailedComplete();\n-                             return;\n-                          }\n-                          lastLocation = location;\n-                          fireCompleteForLocation(lastLocation);\n-                          locationUpdateListener = new LocationUpdateListener(huaweiFusedLocationClient);\n-                       }\n-                    })\n-                    .addOnFailureListener(new com.huawei.hmf.tasks.OnFailureListener() {\n-                       @Override\n-                       public void onFailure(Exception e) {\n-                          OneSignal.Log(OneSignal.LOG_LEVEL.ERROR, \"Huawei LocationServices getLastLocation failed!\", e);\n-                          fireFailedComplete();\n-                       }\n-                    });\n+\n+         // Huawei location not initialized yet and not google play available\n+         if (isHMSAvailable())\n+            HMSLocationController.onFocusChange();\n       }\n    }\n \n    // If we are using device type Android for push we can safely assume we are using Google Play services\n-   private static boolean isGooglePlayServicesAvailable() {\n+   static boolean isGooglePlayServicesAvailable() {\n       return OSUtils.isAndroidDeviceType();\n    }\n \n    // If we are using device type Huawei for push we can safely assume we are using HMS Core\n-   private static boolean isHMSAvailable() {\n+   static boolean isHMSAvailable() {\n       return OSUtils.isHuaweiDeviceType();", "originalCommit": "1a8c5abd690fae0fb1894f7042bc0e12b2d4f449", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2NzM1Nw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1067#discussion_r440467357", "bodyText": "This wrapping makes the code where isHMSAvailable() is called more readable so I think this is preferred.", "author": "jkasten2", "createdAt": "2020-06-15T21:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxMzA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxMzA5NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1067#discussion_r440413095", "bodyText": "Why wrap OSUtils.isAndroidDeviceType(); when we can just use it directly?", "author": "mikechoch", "createdAt": "2020-06-15T19:58:39Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationController.java", "diffHunk": "@@ -289,106 +269,38 @@ static void startGetLocation() {\n       }\n    }\n \n-   private static void initGoogleLocation() {\n-      // Prevents overlapping requests\n-      if (fallbackFailThread != null)\n-         return;\n-\n-      synchronized (syncLock) {\n-         startFallBackThread();\n-\n-         if (googleApiClient == null || lastLocation == null) {\n-            GoogleApiClientListener googleApiClientListener = new GoogleApiClientListener();\n-            GoogleApiClient googleApiClient = new GoogleApiClient.Builder(classContext)\n-                    .addApi(LocationServices.API)\n-                    .addConnectionCallbacks(googleApiClientListener)\n-                    .addOnConnectionFailedListener(googleApiClientListener)\n-                    .setHandler(locationHandlerThread.mHandler)\n-                    .build();\n-\n-            LocationController.googleApiClient = new GoogleApiClientCompatProxy(googleApiClient);\n-            LocationController.googleApiClient.connect();\n-         } else if (lastLocation != null)\n-            fireCompleteForLocation(lastLocation);\n-      }\n-   }\n-\n-   private static void initHuaweiLocation() {\n+   static void onFocusChange() {\n       synchronized (syncLock) {\n-         if (huaweiFusedLocationClient == null) {\n-            try {\n-               huaweiFusedLocationClient = com.huawei.hms.location.LocationServices.getFusedLocationProviderClient(classContext);\n-            } catch (Exception e) {\n-               OneSignal.Log(OneSignal.LOG_LEVEL.ERROR, \"Huawei LocationServices getFusedLocationProviderClient failed! \" + e);\n-               fireFailedComplete();\n-               return;\n-            }\n+         // Google location not initialized or connected yet\n+         if (isGooglePlayServicesAvailable()) {\n+            GMSLocationController.onFocusChange();\n+            return;\n          }\n-         if (lastLocation != null)\n-            fireCompleteForLocation(lastLocation);\n-         else\n-            huaweiFusedLocationClient.getLastLocation()\n-                    .addOnSuccessListener(new com.huawei.hmf.tasks.OnSuccessListener<Location>() {\n-                       @Override\n-                       public void onSuccess(Location location) {\n-                          OneSignal.Log(OneSignal.LOG_LEVEL.WARN, \"Huawei LocationServices getLastLocation returned location: \" + location);\n-                          if (location == null) {\n-                             fireFailedComplete();\n-                             return;\n-                          }\n-                          lastLocation = location;\n-                          fireCompleteForLocation(lastLocation);\n-                          locationUpdateListener = new LocationUpdateListener(huaweiFusedLocationClient);\n-                       }\n-                    })\n-                    .addOnFailureListener(new com.huawei.hmf.tasks.OnFailureListener() {\n-                       @Override\n-                       public void onFailure(Exception e) {\n-                          OneSignal.Log(OneSignal.LOG_LEVEL.ERROR, \"Huawei LocationServices getLastLocation failed!\", e);\n-                          fireFailedComplete();\n-                       }\n-                    });\n+\n+         // Huawei location not initialized yet and not google play available\n+         if (isHMSAvailable())\n+            HMSLocationController.onFocusChange();\n       }\n    }\n \n    // If we are using device type Android for push we can safely assume we are using Google Play services\n-   private static boolean isGooglePlayServicesAvailable() {\n+   static boolean isGooglePlayServicesAvailable() {\n       return OSUtils.isAndroidDeviceType();", "originalCommit": "1a8c5abd690fae0fb1894f7042bc0e12b2d4f449", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2NzI5OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1067#discussion_r440467299", "bodyText": "This wrapping makes the code where isGooglePlayServicesAvailable() is called more readable so I think this is preferred.", "author": "jkasten2", "createdAt": "2020-06-15T21:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxMzA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4NTAzMQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1067#discussion_r440485031", "bodyText": "We should check for location permission here before attempting to access GMSLocationController or HMSLocationController.\nOtherwise NoClassDefFoundError will print in the logcat if they are don't have the location library in their app.", "author": "jkasten2", "createdAt": "2020-06-15T22:37:38Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationController.java", "diffHunk": "@@ -289,106 +269,38 @@ static void startGetLocation() {\n       }\n    }\n \n-   private static void initGoogleLocation() {\n-      // Prevents overlapping requests\n-      if (fallbackFailThread != null)\n-         return;\n-\n-      synchronized (syncLock) {\n-         startFallBackThread();\n-\n-         if (googleApiClient == null || lastLocation == null) {\n-            GoogleApiClientListener googleApiClientListener = new GoogleApiClientListener();\n-            GoogleApiClient googleApiClient = new GoogleApiClient.Builder(classContext)\n-                    .addApi(LocationServices.API)\n-                    .addConnectionCallbacks(googleApiClientListener)\n-                    .addOnConnectionFailedListener(googleApiClientListener)\n-                    .setHandler(locationHandlerThread.mHandler)\n-                    .build();\n-\n-            LocationController.googleApiClient = new GoogleApiClientCompatProxy(googleApiClient);\n-            LocationController.googleApiClient.connect();\n-         } else if (lastLocation != null)\n-            fireCompleteForLocation(lastLocation);\n-      }\n-   }\n-\n-   private static void initHuaweiLocation() {\n+   static void onFocusChange() {\n       synchronized (syncLock) {\n-         if (huaweiFusedLocationClient == null) {\n-            try {\n-               huaweiFusedLocationClient = com.huawei.hms.location.LocationServices.getFusedLocationProviderClient(classContext);\n-            } catch (Exception e) {\n-               OneSignal.Log(OneSignal.LOG_LEVEL.ERROR, \"Huawei LocationServices getFusedLocationProviderClient failed! \" + e);\n-               fireFailedComplete();\n-               return;\n-            }\n+         // Google location not initialized or connected yet", "originalCommit": "1a8c5abd690fae0fb1894f7042bc0e12b2d4f449", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxMjc3Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1067#discussion_r440512776", "bodyText": "good catch! Added dependency check", "author": "Jeasmine", "createdAt": "2020-06-16T00:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4NTAzMQ=="}], "type": "inlineReview"}, {"oid": "49e58348385f2f2a6b9f39e2f01547d7d137b784", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/49e58348385f2f2a6b9f39e2f01547d7d137b784", "message": "Create GMS and HMS Loction controller\n\n   * Separate location controller by platform", "committedDate": "2020-06-15T23:54:15Z", "type": "forcePushed"}, {"oid": "b7b37e0dd9724676599a8750ad804c43100de48a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b7b37e0dd9724676599a8750ad804c43100de48a", "message": "Create GMS and HMS Loction controller\n\n   * Separate location controller by platform", "committedDate": "2020-06-16T00:05:46Z", "type": "forcePushed"}, {"oid": "fdb549de926861df011028f12505ef98617eb76e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fdb549de926861df011028f12505ef98617eb76e", "message": "Create GMS and HMS Loction controller\n\n   * Separate location controller by platform", "committedDate": "2020-06-16T00:07:37Z", "type": "commit"}, {"oid": "fdb549de926861df011028f12505ef98617eb76e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fdb549de926861df011028f12505ef98617eb76e", "message": "Create GMS and HMS Loction controller\n\n   * Separate location controller by platform", "committedDate": "2020-06-16T00:07:37Z", "type": "forcePushed"}]}