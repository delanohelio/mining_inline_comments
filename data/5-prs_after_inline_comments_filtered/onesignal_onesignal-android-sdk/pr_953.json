{"pr_number": 953, "pr_title": "Display once per session IAM with redisplay", "pr_createdAt": "2020-02-11T19:17:42Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEyNjAwMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r379126000", "bodyText": "displayed seems to generic and is confusing. Thinking it should be called displayedInSession, and updating all other usages in this PR to match.", "author": "jkasten2", "createdAt": "2020-02-13T21:23:13Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -54,6 +54,7 @@\n     private OSInAppMessageDisplayStats displayStats = new OSInAppMessageDisplayStats();\n \n     private double displayDuration;\n+    private boolean displayed = false;", "originalCommit": "88cbc30bfd5739566316b01f3ee5a766a4572fda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MTQ2OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r379191469", "bodyText": "Add a space after //", "author": "mikechoch", "createdAt": "2020-02-14T00:18:18Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -161,6 +162,10 @@ void receivedInAppMessageJson(@NonNull JSONArray json) throws JSONException {\n         if (redisplayInAppMessages.size() != updatedRedisplayMessages.size()) {\n             redisplayInAppMessages = updatedRedisplayMessages;\n         }\n+        //Reset feature flag for redisplay", "originalCommit": "88cbc30bfd5739566316b01f3ee5a766a4572fda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MTkyOA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r379191928", "bodyText": "2 Questions:\n\nWill adding this new attribute to the IAM table require a migration?\nWhy must it be a 1 or a 0, can't we use a true or false instead?", "author": "mikechoch", "createdAt": "2020-02-14T00:20:07Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageRepository.java", "diffHunk": "@@ -75,6 +75,7 @@ synchronized void saveInAppMessage(OSInAppMessage inAppMessage) {\n         values.put(OneSignalDbContract.InAppMessageTable.COLUMN_NAME_DISPLAY_QUANTITY, inAppMessage.getDisplayStats().getDisplayQuantity());\n         values.put(OneSignalDbContract.InAppMessageTable.COLUMN_NAME_LAST_DISPLAY, inAppMessage.getDisplayStats().getLastDisplayTime());\n         values.put(OneSignalDbContract.InAppMessageTable.COLUMN_CLICK_IDS, inAppMessage.getClickedClickIds().toString());\n+        values.put(OneSignalDbContract.InAppMessageTable.COLUMN_DISPLAYED, inAppMessage.isDisplayed() ? 1 : 0);", "originalCommit": "88cbc30bfd5739566316b01f3ee5a766a4572fda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1NzMxNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r380957314", "bodyText": "No, this will be merged all together so it shouldn't\nhttps://www.sqlite.org/datatype3.html  \"SQLite does not have a separate Boolean storage class. Instead, Boolean values are stored as integers 0 (false) and 1 (true).\"\nI will refactor to save as boolean but the parsing will stay the same", "author": "Jeasmine", "createdAt": "2020-02-18T21:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MTkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA1NDkyNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r381054926", "bodyText": "Already covered by the upgradeToV7 function since it is a totally new table\nYup, integer is as close as you get to a boolean.", "author": "jkasten2", "createdAt": "2020-02-19T03:06:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MTkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MjYyNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r379192626", "bodyText": "Talked about this in the iOS PR, I don't think triggerChanged should be stored in the IAM but it should be created on the fly and decided by some local variable inside of the method processing the IAM.", "author": "mikechoch", "createdAt": "2020-02-14T00:22:58Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -54,6 +54,7 @@\n     private OSInAppMessageDisplayStats displayStats = new OSInAppMessageDisplayStats();\n \n     private double displayDuration;\n+    private boolean displayed = false;\n     private boolean triggerChanged = false;", "originalCommit": "88cbc30bfd5739566316b01f3ee5a766a4572fda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1Nzg2MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r380957860", "bodyText": "i will continue this discussion on iOS PR, this will need changes on #927", "author": "Jeasmine", "createdAt": "2020-02-18T21:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MjYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjExODI4OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r382118288", "bodyText": "the alternative is to have a set of messageIds with all the redisplayMessage that have one trigger changed, in that way we can track if some trigger changed. I didn't want to overflow with more data structures and I tried to re use the data that was already being saved", "author": "Jeasmine", "createdAt": "2020-02-20T16:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MjYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MzAxNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r379193017", "bodyText": "What does displayed represent?\nCurrently displayed?\nWas displayed?\nDisplayed in current session?\nOr something else?", "author": "mikechoch", "createdAt": "2020-02-14T00:24:29Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -62,10 +63,10 @@\n         this.isPreview = isPreview;\n     }\n \n-    OSInAppMessage(@NonNull String messageId, @NonNull Set<String> clickIds, OSInAppMessageDisplayStats displayStats) {\n+    OSInAppMessage(@NonNull String messageId, @NonNull Set<String> clickIds, boolean displayed, OSInAppMessageDisplayStats displayStats) {\n         this.messageId = messageId;\n         this.clickedClickIds = clickIds;\n-\n+        this.displayed = displayed;", "originalCommit": "88cbc30bfd5739566316b01f3ee5a766a4572fda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1NzU4NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r380957584", "bodyText": "yeah, i will rename to displayedInSession", "author": "Jeasmine", "createdAt": "2020-02-18T21:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MzAxNw=="}], "type": "inlineReview"}, {"oid": "c34bd2fd1e9875d816eeabc2c550359fc904ae9c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c34bd2fd1e9875d816eeabc2c550359fc904ae9c", "message": "Display once per session IAM with redisplay\n\n   * Add no trigger check, display once per session\n   * Add displayed param to IAM\n   * Add test for cold start and init OneSignal", "committedDate": "2020-02-18T22:15:04Z", "type": "forcePushed"}, {"oid": "9fbec7ea7a435d25c67132f1c52dcc4428b8aedc", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/9fbec7ea7a435d25c67132f1c52dcc4428b8aedc", "message": "Display once per session IAM with redisplay\n\n   * Add no trigger check, display once per session\n   * Add displayed param to IAM\n   * Add test for cold start and init OneSignal", "committedDate": "2020-02-18T22:24:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA1NTMzNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r381055337", "bodyText": "COLUMN_DISPLAYED should be COLUMN_DISPLAYED_IN_SESSION", "author": "jkasten2", "createdAt": "2020-02-19T03:08:50Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageRepository.java", "diffHunk": "@@ -81,6 +80,7 @@ synchronized void saveInAppMessage(OSInAppMessage inAppMessage) {\n         values.put(OneSignalDbContract.InAppMessageTable.COLUMN_NAME_DISPLAY_QUANTITY, inAppMessage.getDisplayStats().getDisplayQuantity());\n         values.put(OneSignalDbContract.InAppMessageTable.COLUMN_NAME_LAST_DISPLAY, inAppMessage.getDisplayStats().getLastDisplayTime());\n         values.put(OneSignalDbContract.InAppMessageTable.COLUMN_CLICK_IDS, inAppMessage.getClickedClickIds().toString());\n+        values.put(OneSignalDbContract.InAppMessageTable.COLUMN_DISPLAYED, inAppMessage.isDisplayedInSession());", "originalCommit": "9fbec7ea7a435d25c67132f1c52dcc4428b8aedc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA1NTU1OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r381055558", "bodyText": "COLUMN_DISPLAYED should be COLUMN_DISPLAYED_IN_SESSION\ndisplayed should be displayed_in_session", "author": "jkasten2", "createdAt": "2020-02-19T03:09:55Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbContract.java", "diffHunk": "@@ -81,5 +81,6 @@\n       public static final String COLUMN_NAME_DISPLAY_QUANTITY = \"display_quantity\";\n       public static final String COLUMN_NAME_LAST_DISPLAY = \"last_display\";\n       public static final String COLUMN_CLICK_IDS = \"click_ids\";\n+      public static final String COLUMN_DISPLAYED = \"displayed\";", "originalCommit": "9fbec7ea7a435d25c67132f1c52dcc4428b8aedc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c213bbccd96ab8bf144773f1d39a87808617b39", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/4c213bbccd96ab8bf144773f1d39a87808617b39", "message": "Display once per session IAM with redisplay\n\n   * Add no trigger check, display once per session\n   * Add displayed param to IAM\n   * Add test for cold start and init OneSignal", "committedDate": "2020-02-20T05:03:03Z", "type": "forcePushed"}, {"oid": "a4e06d0f37cbefd42ab95c9751fba711bd22f9b5", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/a4e06d0f37cbefd42ab95c9751fba711bd22f9b5", "message": "Display once per session IAM with redisplay\n\n   * Add no trigger check, display once per session\n   * Add displayed param to IAM\n   * Add test for cold start and init OneSignal", "committedDate": "2020-02-20T16:50:18Z", "type": "forcePushed"}, {"oid": "40981030647c650b83718760c31d0e4f81cbbf3d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/40981030647c650b83718760c31d0e4f81cbbf3d", "message": "Display once per session IAM with redisplay\n\n   * Add no trigger check, display once per session\n   * Add displayed param to IAM\n   * Add test for cold start and init OneSignal", "committedDate": "2020-02-20T17:27:10Z", "type": "forcePushed"}, {"oid": "91c3f5f60d05bed78e62294a39a8e27fe13ed8ae", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/91c3f5f60d05bed78e62294a39a8e27fe13ed8ae", "message": "Display once per session IAM with redisplay\n\n   * Add no trigger check, display once per session\n   * Add displayed param to IAM\n   * Add test for cold start and init OneSignal", "committedDate": "2020-02-20T18:21:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEzMjA5Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/953#discussion_r384132092", "bodyText": "I marked this in #951 already.", "author": "mikechoch", "createdAt": "2020-02-25T21:19:08Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -168,6 +168,16 @@ private void processInAppMessageJson(@NonNull JSONArray json) throws JSONExcepti\n         evaluateInAppMessages();\n     }\n \n+    private void deleteOldRedisplayedInAppMessages() {\n+        new Thread(new Runnable() {\n+            @Override\n+            public void run() {\n+                Thread.currentThread().setPriority(Process.THREAD_PRIORITY_BACKGROUND);\n+                inAppMessageRepository.deleteOldRedisplayedInAppMessages();\n+            }\n+        }, OS_SAVE_IN_APP_MESSAGE).start();", "originalCommit": "91c3f5f60d05bed78e62294a39a8e27fe13ed8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec1c78dc0bd168f0fb6e08003c7f147426f55b5d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ec1c78dc0bd168f0fb6e08003c7f147426f55b5d", "message": "Display once per session IAM with redisplay\n\n   * Add no trigger check, display once per session\n   * Add displayed param to IAM\n   * Add test for cold start and init OneSignal", "committedDate": "2020-02-25T22:33:23Z", "type": "commit"}, {"oid": "ec1c78dc0bd168f0fb6e08003c7f147426f55b5d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ec1c78dc0bd168f0fb6e08003c7f147426f55b5d", "message": "Display once per session IAM with redisplay\n\n   * Add no trigger check, display once per session\n   * Add displayed param to IAM\n   * Add test for cold start and init OneSignal", "committedDate": "2020-02-25T22:33:23Z", "type": "forcePushed"}]}