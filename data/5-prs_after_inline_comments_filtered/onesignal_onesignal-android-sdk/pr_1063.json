{"pr_number": 1063, "pr_title": "Hms device type fallback logic", "pr_createdAt": "2020-06-11T11:34:03Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063", "timeline": [{"oid": "cdf6b79b932ef6932ac6fe65d4a6e8d71808130a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/cdf6b79b932ef6932ac6fe65d4a6e8d71808130a", "message": "Fallback detection for Huawei device if no HMS SDK\n\n* We should still detect a real Huawei with HMS only as\ndevice_type 13 even if there is no HMS library in the app.", "committedDate": "2020-06-11T11:03:38Z", "type": "commit"}, {"oid": "efebaef3a94885aac3795b0e94fc47c66d45a092", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/efebaef3a94885aac3795b0e94fc47c66d45a092", "message": "Added missing HMS PushKit library detection\n\n* Now correctly handles reporting missing HMS PushKit library if app\nis running on an HMS only device.", "committedDate": "2020-06-11T11:33:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NzI4NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r438797285", "bodyText": "Should we keep this as Throwable or find the specific Exception(s)?", "author": "mikechoch", "createdAt": "2020-06-11T13:47:33Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSUtils.java", "diffHunk": "@@ -170,6 +170,21 @@ private boolean hasHMSPushKitLibrary() {\n       }\n    }\n \n+   private static boolean hasHMSAGConnectLibrary() {\n+      try {\n+         // noinspection ConstantConditions\n+         return com.huawei.agconnect.config.AGConnectServicesConfig.class != null;\n+      } catch (Throwable e) {", "originalCommit": "efebaef3a94885aac3795b0e94fc47c66d45a092", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM0ODI0OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r439348248", "bodyText": "These will throw a ClassNotFoundException at runtime if missing, however if I try to catch it here the compiler thinks it's not possible won't compile.\nThe best we can do is change these to Exception, which is a bit better than Throwable", "author": "jkasten2", "createdAt": "2020-06-12T10:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NzI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5ODU0OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r438798548", "bodyText": "Remove empty line", "author": "mikechoch", "createdAt": "2020-06-11T13:48:57Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSUtils.java", "diffHunk": "@@ -310,13 +336,22 @@ int getDeviceType() {\n \n       if (supportsGooglePush())\n          return UserState.DEVICE_TYPE_ANDROID;\n-      else {\n-         // If the Huawei device has both FCM & HMS support we prefer FCM (Google push)\n-         // HMS will only be used if it is the only option.\n-         if (supportsHMS())\n-            return UserState.DEVICE_TYPE_HUAWEI;\n-      }\n \n+      // Some Huawei devices have both FCM & HMS support, but prefer FCM (Google push) over HMS\n+      if (supportsHMS())\n+         return UserState.DEVICE_TYPE_HUAWEI;\n+\n+      // Start - Fallback logic\n+      //    Libraries in the app (Google:FCM, HMS:PushKit) + Device may not have a valid combo\n+      // Example: App with only the FCM library in it and a Huawei device with only HMS Core\n+", "originalCommit": "efebaef3a94885aac3795b0e94fc47c66d45a092", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM0OTYzNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r439349634", "bodyText": "Done", "author": "jkasten2", "createdAt": "2020-06-12T10:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5ODU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5OTUxOQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r438799519", "bodyText": "What do you mean \"If here is required\"?", "author": "mikechoch", "createdAt": "2020-06-11T13:49:58Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/PushRegistratorHMS.java", "diffHunk": "@@ -53,8 +53,12 @@ public void run() {\n     }\r\n \r\n     private synchronized void getHMSTokenTask(@NonNull Context context, @NonNull RegisteredHandler callback) throws ApiException {\r\n-        // TODO: See if we can handle an exact message like this\r\n-        // 2020-04-14 23:06:36.164 1565-1743/com.onesignal.example E/HMSSDK_Util: In getMetaDataAppId, Failed to read meta data for the AppID.\r\n+        // If here is required to prevent AGConnectServicesConfig or HmsInstanceId used below\r\n+        //   from throwing a ClassNotFoundException\r", "originalCommit": "efebaef3a94885aac3795b0e94fc47c66d45a092", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM0OTU4OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r439349588", "bodyText": "The if statement, not sure way I worded that way. Changing to \"Check\"", "author": "jkasten2", "createdAt": "2020-06-12T10:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5OTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM2MTg2OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r439361869", "bodyText": "Ahhh I read it wrong when I saw \"If here\", sorry", "author": "mikechoch", "createdAt": "2020-06-12T11:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5OTUxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMTU0OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r438801549", "bodyText": "Add past tense hasAllRecommendHMSLibraries to hasAllRecommendedHMSLibraries?", "author": "mikechoch", "createdAt": "2020-06-11T13:52:06Z", "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java", "diffHunk": "@@ -32,21 +32,36 @@ public static boolean isGMSInstalledAndEnabled() {\n \n    // Huawei: HMS\n    public static boolean hasHMSAvailability;\n-   public boolean hasHMSAvailability() {\n+   public static boolean hasHMSAvailability() {\n       return hasHMSAvailability;\n    }\n    public static boolean hasHMSPushKitLibrary;\n-   public boolean hasHMSPushKitLibrary() {\n+   public static boolean hasHMSPushKitLibrary() {\n       return hasHMSPushKitLibrary;\n    }\n+   public static boolean hasHMSAGConnectLibrary;\n+   public static boolean hasHMSAGConnectLibrary() {\n+      return hasHMSAGConnectLibrary;\n+   }\n+\n    public static boolean isHMSCoreInstalledAndEnabled;\n    public static boolean isHMSCoreInstalledAndEnabled() {\n       return isHMSCoreInstalledAndEnabled;\n    }\n+   public static boolean isHMSCoreInstalledAndEnabledFallback() {\n+      return isHMSCoreInstalledAndEnabled;\n+   }\n+\n+   public static void hasAllRecommendHMSLibraries(boolean value) {", "originalCommit": "efebaef3a94885aac3795b0e94fc47c66d45a092", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM1MTI5NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r439351295", "bodyText": "Done", "author": "jkasten2", "createdAt": "2020-06-12T10:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMTU0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMTkwNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r438801905", "bodyText": "recommend should be recommended?", "author": "mikechoch", "createdAt": "2020-06-11T13:52:27Z", "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java", "diffHunk": "@@ -32,21 +32,36 @@ public static boolean isGMSInstalledAndEnabled() {\n \n    // Huawei: HMS\n    public static boolean hasHMSAvailability;\n-   public boolean hasHMSAvailability() {\n+   public static boolean hasHMSAvailability() {\n       return hasHMSAvailability;\n    }\n    public static boolean hasHMSPushKitLibrary;\n-   public boolean hasHMSPushKitLibrary() {\n+   public static boolean hasHMSPushKitLibrary() {\n       return hasHMSPushKitLibrary;\n    }\n+   public static boolean hasHMSAGConnectLibrary;\n+   public static boolean hasHMSAGConnectLibrary() {\n+      return hasHMSAGConnectLibrary;\n+   }\n+\n    public static boolean isHMSCoreInstalledAndEnabled;\n    public static boolean isHMSCoreInstalledAndEnabled() {\n       return isHMSCoreInstalledAndEnabled;\n    }\n+   public static boolean isHMSCoreInstalledAndEnabledFallback() {\n+      return isHMSCoreInstalledAndEnabled;\n+   }\n+\n+   public static void hasAllRecommendHMSLibraries(boolean value) {\n+      // required\n+      hasHMSPushKitLibrary = value;\n+      hasHMSAGConnectLibrary = value;\n+      // recommend", "originalCommit": "efebaef3a94885aac3795b0e94fc47c66d45a092", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM1MTMzMQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r439351331", "bodyText": "Done", "author": "jkasten2", "createdAt": "2020-06-12T10:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMTkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMjM1Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r438802352", "bodyText": "Add a new line above to space out the methods?", "author": "mikechoch", "createdAt": "2020-06-11T13:52:52Z", "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java", "diffHunk": "@@ -32,21 +32,36 @@ public static boolean isGMSInstalledAndEnabled() {\n \n    // Huawei: HMS\n    public static boolean hasHMSAvailability;\n-   public boolean hasHMSAvailability() {\n+   public static boolean hasHMSAvailability() {\n       return hasHMSAvailability;\n    }\n    public static boolean hasHMSPushKitLibrary;\n-   public boolean hasHMSPushKitLibrary() {\n+   public static boolean hasHMSPushKitLibrary() {\n       return hasHMSPushKitLibrary;\n    }\n+   public static boolean hasHMSAGConnectLibrary;\n+   public static boolean hasHMSAGConnectLibrary() {\n+      return hasHMSAGConnectLibrary;\n+   }\n+\n    public static boolean isHMSCoreInstalledAndEnabled;\n    public static boolean isHMSCoreInstalledAndEnabled() {\n       return isHMSCoreInstalledAndEnabled;\n    }\n+   public static boolean isHMSCoreInstalledAndEnabledFallback() {", "originalCommit": "efebaef3a94885aac3795b0e94fc47c66d45a092", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMjM5Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r438802392", "bodyText": "Add a new line above to space out the methods?", "author": "mikechoch", "createdAt": "2020-06-11T13:52:55Z", "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java", "diffHunk": "@@ -32,21 +32,36 @@ public static boolean isGMSInstalledAndEnabled() {\n \n    // Huawei: HMS\n    public static boolean hasHMSAvailability;\n-   public boolean hasHMSAvailability() {\n+   public static boolean hasHMSAvailability() {\n       return hasHMSAvailability;\n    }\n    public static boolean hasHMSPushKitLibrary;\n-   public boolean hasHMSPushKitLibrary() {\n+   public static boolean hasHMSPushKitLibrary() {\n       return hasHMSPushKitLibrary;\n    }\n+   public static boolean hasHMSAGConnectLibrary;", "originalCommit": "efebaef3a94885aac3795b0e94fc47c66d45a092", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM1MDcxOQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r439350719", "bodyText": "Done", "author": "jkasten2", "createdAt": "2020-06-12T10:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMjM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMjQ0NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r438802444", "bodyText": "Add a new line above to space out the methods?", "author": "mikechoch", "createdAt": "2020-06-11T13:52:58Z", "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java", "diffHunk": "@@ -32,21 +32,36 @@ public static boolean isGMSInstalledAndEnabled() {\n \n    // Huawei: HMS\n    public static boolean hasHMSAvailability;\n-   public boolean hasHMSAvailability() {\n+   public static boolean hasHMSAvailability() {\n       return hasHMSAvailability;\n    }\n    public static boolean hasHMSPushKitLibrary;", "originalCommit": "efebaef3a94885aac3795b0e94fc47c66d45a092", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM1MDUyMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r439350520", "bodyText": "Fixed, still keeping the variables and getter method grouped so it is clear they go together.", "author": "jkasten2", "createdAt": "2020-06-12T10:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMjQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM2MjE5Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1063#discussion_r439362193", "bodyText": "Agreed, just looking for some space between the end of the getters and the new variables", "author": "mikechoch", "createdAt": "2020-06-12T11:23:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMjQ0NA=="}], "type": "inlineReview"}, {"oid": "e8b2150c688e8cb041f12548078ed6097357a468", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/e8b2150c688e8cb041f12548078ed6097357a468", "message": "Comment, naming, and spacing clean up", "committedDate": "2020-06-12T11:00:02Z", "type": "commit"}]}