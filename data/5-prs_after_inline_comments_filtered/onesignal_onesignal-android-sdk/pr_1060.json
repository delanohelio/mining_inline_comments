{"pr_number": 1060, "pr_title": "Moved logic out of NotificationOpenedActivityHMS", "pr_createdAt": "2020-06-11T07:34:56Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060", "timeline": [{"oid": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/06fcb162912ba0b230ea4eeeeec75b78d2242d7f", "message": "Moved logic out of NotificationOpenedActivityHMS\n\n* Moved most logic into NotificationPayloadProcessorHMS so the Activity\nhas a single responbility, to be an entry point only.\n* Added HMS action button id formatting logic\n* Added new HMS open intergration test.\n  - It covers testing firing the open callback + actionId is set.", "committedDate": "2020-06-11T07:33:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNjA2OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438816069", "bodyText": "So that its consistent should we capitalize HMS in covertHmsOpenIntentToJson?", "author": "mikechoch", "createdAt": "2020-06-11T14:10:48Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationPayloadProcessorHMS.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.onesignal;\r\n+\r\n+import android.app.Activity;\r\n+import android.content.Intent;\r\n+import android.os.Bundle;\r\n+import android.support.annotation.NonNull;\r\n+import android.support.annotation.Nullable;\r\n+\r\n+import org.json.JSONArray;\r\n+import org.json.JSONException;\r\n+import org.json.JSONObject;\r\n+\r\n+import static com.onesignal.GenerateNotification.BUNDLE_KEY_ACTION_ID;\r\n+\r\n+class NotificationPayloadProcessorHMS {\r\n+\r\n+    static void handleHmsNotificationOpenIntent(@NonNull Activity activity, @Nullable Intent intent) {\r\n+        OneSignal.setAppContext(activity);\r\n+        if (intent == null)\r\n+            return;\r\n+\r\n+        JSONObject jsonData = covertHmsOpenIntentToJson(intent);\r\n+        if (jsonData == null)\r\n+            return;\r\n+\r\n+        handleProcessJsonOpenData(activity, jsonData);\r\n+    }\r\n+\r\n+    // Takes in a Notification Open Intent fired from HMS Core and coverts it to an OS formatted JSONObject\r\n+    // Returns null if it is NOT a notification sent from OneSignal's backend\r\n+    private static @Nullable JSONObject covertHmsOpenIntentToJson(@Nullable Intent intent) {\r", "originalCommit": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk2Nzc2NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438967764", "bodyText": "Done", "author": "jkasten2", "createdAt": "2020-06-11T17:52:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNjA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNjMwNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438816307", "bodyText": "So that its consistent should we capitalize HMS in handleHmsNotificationOpenIntent?", "author": "mikechoch", "createdAt": "2020-06-11T14:11:05Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationPayloadProcessorHMS.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.onesignal;\r\n+\r\n+import android.app.Activity;\r\n+import android.content.Intent;\r\n+import android.os.Bundle;\r\n+import android.support.annotation.NonNull;\r\n+import android.support.annotation.Nullable;\r\n+\r\n+import org.json.JSONArray;\r\n+import org.json.JSONException;\r\n+import org.json.JSONObject;\r\n+\r\n+import static com.onesignal.GenerateNotification.BUNDLE_KEY_ACTION_ID;\r\n+\r\n+class NotificationPayloadProcessorHMS {\r\n+\r\n+    static void handleHmsNotificationOpenIntent(@NonNull Activity activity, @Nullable Intent intent) {\r", "originalCommit": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk2NzYwMg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438967602", "bodyText": "Done", "author": "jkasten2", "createdAt": "2020-06-11T17:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNjMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxOTM5Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438819396", "bodyText": "Use the OSNotificationFormatHelper.PAYLOAD_OS_NOTIFICATION_ID for \"i\"?\nUse the OSNotificationFormatHelper.PAYLOAD_OS_ROOT_CUSTOM for \"custom\"?", "author": "mikechoch", "createdAt": "2020-06-11T14:15:30Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/NotificationOpenedActivityHMSIntegrationTestsRunner.java", "diffHunk": "@@ -68,27 +70,50 @@ public void beforeEachTest() throws Exception {\n         ShadowOSUtils.supportsHMS(true);\r\n     }\r\n \r\n-    private static Intent helper_baseHMSOpenIntent() {\r\n+    private static @NonNull Intent helper_baseHMSOpenIntent() {\r\n         return new Intent()\r\n                 .setFlags(Intent.FLAG_ACTIVITY_NO_HISTORY | Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_MULTIPLE_TASK)\r\n                 .setAction(\"android.intent.action.VIEW\");\r\n     }\r\n \r\n-    private static void helper_startHMSOpenActivity(@NonNull Intent intent) {\r\n-        Robolectric.buildActivity(NotificationOpenedActivityHMS.class, intent).create();\r\n+    private static @NonNull Intent helper_basicOSHMSOpenIntent() throws JSONException {\r\n+        return helper_baseHMSOpenIntent()\r\n+                .putExtra(\r\n+                    \"custom\",\r\n+                    new JSONObject() {{\r\n+                        put(\"i\", UUID.randomUUID().toString());\r\n+                }}.toString()\r\n+        );\r\n     }\r\n \r\n-    private static void helper_initSDKAndFireHMSNotificationOpenIntent() throws Exception {\r\n-        OneSignal.init(RuntimeEnvironment.application, \"123456789\", ONESIGNAL_APP_ID);\r\n-        fastColdRestartApp();\r\n-\r\n-        Intent intent = helper_baseHMSOpenIntent()\r\n+    private static @NonNull Intent helper_basicOSHMSOpenIntentWithActionId(final @NonNull String actionId) throws JSONException {\r\n+        return helper_baseHMSOpenIntent()\r\n                 .putExtra(\r\n                         \"custom\",\r\n                         new JSONObject() {{\r\n                             put(\"i\", UUID.randomUUID().toString());\r\n+                            put(BUNDLE_KEY_ACTION_ID, actionId);\r\n                         }}.toString()\r\n                 );\r", "originalCommit": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk2ODAxOQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438968019", "bodyText": "Done", "author": "jkasten2", "createdAt": "2020-06-11T17:52:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxOTM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxOTgyNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438819824", "bodyText": "Use the OSNotificationFormatHelper.PAYLOAD_OS_NOTIFICATION_ID for \"i\"?\nUse the OSNotificationFormatHelper.PAYLOAD_OS_ROOT_CUSTOM for \"custom\"?", "author": "mikechoch", "createdAt": "2020-06-11T14:16:10Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/NotificationOpenedActivityHMSIntegrationTestsRunner.java", "diffHunk": "@@ -68,27 +70,50 @@ public void beforeEachTest() throws Exception {\n         ShadowOSUtils.supportsHMS(true);\r\n     }\r\n \r\n-    private static Intent helper_baseHMSOpenIntent() {\r\n+    private static @NonNull Intent helper_baseHMSOpenIntent() {\r\n         return new Intent()\r\n                 .setFlags(Intent.FLAG_ACTIVITY_NO_HISTORY | Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_MULTIPLE_TASK)\r\n                 .setAction(\"android.intent.action.VIEW\");\r\n     }\r\n \r\n-    private static void helper_startHMSOpenActivity(@NonNull Intent intent) {\r\n-        Robolectric.buildActivity(NotificationOpenedActivityHMS.class, intent).create();\r\n+    private static @NonNull Intent helper_basicOSHMSOpenIntent() throws JSONException {\r\n+        return helper_baseHMSOpenIntent()\r\n+                .putExtra(\r\n+                    \"custom\",\r\n+                    new JSONObject() {{\r\n+                        put(\"i\", UUID.randomUUID().toString());\r\n+                }}.toString()\r\n+        );\r", "originalCommit": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk2NzkxNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438967917", "bodyText": "Done", "author": "jkasten2", "createdAt": "2020-06-11T17:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxOTgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg3NDc4OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438874789", "bodyText": "can this go in the top with the other constants? \ud83d\ude01", "author": "Jeasmine", "createdAt": "2020-06-11T15:32:17Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/NotificationOpenedActivityHMSIntegrationTestsRunner.java", "diffHunk": "@@ -102,18 +127,34 @@ public void emptyIntent_doesNotThrow() {\n \r\n     @Test\r\n     public void barebonesOSPayload_startsMainActivity() throws Exception {\r\n-        helper_initSDKAndFireHMSNotificationOpenIntent();\r\n+        helper_initSDKAndFireHMSNotificationBarebonesOSOpenIntent();\r\n \r\n         Intent startedActivity = shadowOf(RuntimeEnvironment.application).getNextStartedActivity();\r\n         assertEquals(startedActivity.getComponent().getClassName(), BlankActivity.class.getName());\r\n     }\r\n \r\n     @Test\r\n     public void barebonesOSPayload_makesNotificationOpenRequest() throws Exception {\r\n-        helper_initSDKAndFireHMSNotificationOpenIntent();\r\n+        helper_initSDKAndFireHMSNotificationBarebonesOSOpenIntent();\r\n         assertNotificationOpenAtIndex(1, UserState.DEVICE_TYPE_HUAWEI);\r\n     }\r\n \r\n+    private static final String TEST_ACTION_ID = \"myTestActionId\";\r", "originalCommit": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NTY1NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438975654", "bodyText": "Done", "author": "jkasten2", "createdAt": "2020-06-11T18:04:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg3NDc4OQ=="}], "type": "inlineReview"}, {"oid": "93cf2f6a6dab56b05d0edf49ec58578ac8e350f9", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/93cf2f6a6dab56b05d0edf49ec58578ac8e350f9", "message": "Switching to constants keys from strings", "committedDate": "2020-06-11T18:03:45Z", "type": "commit"}, {"oid": "f24308c61bb82192b60e051fa3c29bdf5b667c04", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f24308c61bb82192b60e051fa3c29bdf5b667c04", "message": "HMS casing fixes on method names", "committedDate": "2020-06-11T18:04:07Z", "type": "commit"}]}