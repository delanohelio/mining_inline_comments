{"pr_number": 990, "pr_title": "Android x migration", "pr_createdAt": "2020-04-16T04:24:04Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/990", "timeline": [{"oid": "81be068b53864ac8c82b44b7b8ef49a84810ec53", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/81be068b53864ac8c82b44b7b8ef49a84810ec53", "message": "Checkout from android_x_migration\nMerged major_release_4.0.0 into this new branch and resolve conflicts\nNow will merge this into android_x_migration and force push", "committedDate": "2020-04-16T21:48:35Z", "type": "forcePushed"}, {"oid": "d324aa12da0bcf765e3f833e98e7533fbb94ee7e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d324aa12da0bcf765e3f833e98e7533fbb94ee7e", "message": "Android X migration for demo app\n* Updated all dependencies to Android x minimums with ranges\n  * androidx.cardview:cardview:[1.0.0, 1.99.99]\n  * androidx.appcompat:appcompat:[1.0.0, 1.99.99]\n  * androidx.legacy:legacy-support-v4:[1.0.0, 1.99.99]\n  * androidx.vectordrawable:vectordrawable:[1.0.0, 1.99.99]\n* Updated demo app XML\n  * Android X scroll behavior\n  * All Right and Left based attributes now ave the matching Start and End attributes to match and remove errors/warnings\n* Demo app build.gradle updates\n  * Android SDK min for demo app is 16\n  * Added compile options to demo app build.gradle", "committedDate": "2020-04-30T14:39:57Z", "type": "commit"}, {"oid": "1d0573ab7751632b2a93093024efe60477dc08b6", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1d0573ab7751632b2a93093024efe60477dc08b6", "message": "Android X migration for onesignal SDK\n* Android X libs replace all Android support libs\n* Set mUnsubscribeWhenNotificationsAreDisabled to true\n* Set mDisplayOption to NOTIFICATION\n* Updated OneSignalChromeTab class to work with Android X\n* Updated all GCM to FCM across codebase\n* Deleted PREFS_OS_FILTER_OTHER_GCM_RECEIVERS param\n* Updated dependencies to Android X min\n  * com.google.android.gms:play-services-location:[17.0.0, 17.99.99]\n  * com.google.android.gms:play-services-ads-identifier:[17.0.0, 17.99.99]\n  * com.google.android.gms:play-services-base:[17.0.0, 17.99.99]\n  * com.google.firebase:firebase-messaging:[19.0.0, 20.99.99]\n* Updated gradle for onesignal\n  * Min SDK is 16 now\n  * Gradle wrapper 5.6.4\n  * Build Gradle 3.6.2", "committedDate": "2020-04-30T14:46:34Z", "type": "commit"}, {"oid": "6bf729d94b229c6f7a0826049e04c6cc18c9f933", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/6bf729d94b229c6f7a0826049e04c6cc18c9f933", "message": "Android X migration for unit tests\n* Updated all android support to Android X libs\n* Updated all GCM to FCM across unit tests\n* Updated min sdk to 16\n* Updated dependencies to min Android X\n  * com.google.android.gms:play-services-location:17.0.0\n  * com.google.firebase:firebase-core:17.2.2", "committedDate": "2020-04-30T14:50:09Z", "type": "commit"}, {"oid": "499b9c25f230c723ef1fd0106abc308e34c72f38", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/499b9c25f230c723ef1fd0106abc308e34c72f38", "message": "Changed androidx.appcompat to api and added a range of versions", "committedDate": "2020-04-30T14:50:26Z", "type": "commit"}, {"oid": "714ad44fc5b5575ddfe3d097df2ee352f01117e9", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/714ad44fc5b5575ddfe3d097df2ee352f01117e9", "message": "Was not receiving notifications on device\n* Fixed this by using\n  * com.google.android.c2dm.intent.RECEIVE in FCMBroadcastReceiver and AndroidManifest action name\n  * Should eventually be com.google.firebase.MESSAGING_EVENT but wa snot able ot ge this working correctly", "committedDate": "2020-04-30T15:38:56Z", "type": "commit"}, {"oid": "714ad44fc5b5575ddfe3d097df2ee352f01117e9", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/714ad44fc5b5575ddfe3d097df2ee352f01117e9", "message": "Was not receiving notifications on device\n* Fixed this by using\n  * com.google.android.c2dm.intent.RECEIVE in FCMBroadcastReceiver and AndroidManifest action name\n  * Should eventually be com.google.firebase.MESSAGING_EVENT but wa snot able ot ge this working correctly", "committedDate": "2020-04-30T15:38:56Z", "type": "forcePushed"}, {"oid": "c3842b95a0e73729314ef0faa808c0a5c3c72dda", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c3842b95a0e73729314ef0faa808c0a5c3c72dda", "message": "Unit Tests FCM intent action issue\n* Fixed this by using\n  * com.google.android.c2dm.intent.RECEIVE instead of com.google.firebase.MESSAGING_EVENT\n  * Should eventually be com.google.firebase.MESSAGING_EVENT but was not able ot ge this working correctly", "committedDate": "2020-04-30T16:51:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE2OTE0Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/990#discussion_r419169142", "bodyText": "This needs to say \"gcm\". This it the payload that the \"Google Play services\" app sends and it outside of the control of that app.", "author": "jkasten2", "createdAt": "2020-05-03T22:29:24Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/FCMBroadcastReceiver.java", "diffHunk": "@@ -35,24 +35,23 @@\n import android.os.Build;\n import android.os.Bundle;\n import android.os.Parcelable;\n-import android.os.PersistableBundle;\n-import android.support.annotation.Nullable;\n-import android.support.v4.content.WakefulBroadcastReceiver;\n+\n+import androidx.annotation.Nullable;\n+import androidx.legacy.content.WakefulBroadcastReceiver;\n \n import com.onesignal.NotificationBundleProcessor.ProcessedBundleResult;\n \n-// This is the entry point when a FCM / GCM payload is received from the Google Play services app\n-// TODO: 4.0.0 - Update to use <action android:name=\"com.google.firebase.MESSAGING_EVENT\"/>\n-public class GcmBroadcastReceiver extends WakefulBroadcastReceiver {\n+// This is the entry point when a FCM payload is received from the Google Play services app\n+public class FCMBroadcastReceiver extends WakefulBroadcastReceiver {\n \n-   private static final String GCM_RECEIVE_ACTION = \"com.google.android.c2dm.intent.RECEIVE\";\n-   private static final String GCM_TYPE = \"gcm\";\n+   private static final String FCM_RECEIVE_ACTION = \"com.google.android.c2dm.intent.RECEIVE\";\n+   private static final String FCM_TYPE = \"fcm\";", "originalCommit": "c3842b95a0e73729314ef0faa808c0a5c3c72dda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE2OTQ2OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/990#discussion_r419169468", "bodyText": "The original checked was processedResult.isOneSignalPayload && OneSignal.getFilterOtherGCMReceivers(context) so this means we should now remove rocessedResult.isOneSignalPayload.", "author": "jkasten2", "createdAt": "2020-05-03T22:32:49Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/FCMBroadcastReceiver.java", "diffHunk": "@@ -69,26 +68,20 @@ public void onReceive(Context context, Intent intent) {\n \n       ProcessedBundleResult processedResult = processOrderBroadcast(context, intent, bundle);\n \n-      // Null means this isn't a GCM / FCM message.\n+      // Null means this isn't a FCM message\n       if (processedResult == null) {\n          setSuccessfulResultCode();\n          return;\n       }\n \n-      // Prevent other GCM receivers from firing if;\n-      //   This is a duplicated GCM message\n-      //   OR app developer setup a extender service to handle the notification.\n-      if (processedResult.isDup || processedResult.hasExtenderService) {\n-         // Abort to prevent other GCM receivers from process this Intent.\n-         setAbort();\n-         return;\n-      }\n-\n-      // Prevent other GCM receivers from firing if;\n-      //   This is a OneSignal payload\n-      //   AND the setting is enabled to allow filtering in this case.\n-      if (processedResult.isOneSignalPayload &&\n-          OneSignal.getFilterOtherGCMReceivers(context)) {\n+      // Prevent other FCM receivers from firing if:\n+      //    1. This is a duplicated FCM message\n+      //    2. OR app developer setup a extender service to handle the notification\n+      //    3. OR this is a OneSignal payload\n+      if (processedResult.isDup\n+              || processedResult.hasExtenderService\n+              || processedResult.isOneSignalPayload) {", "originalCommit": "c3842b95a0e73729314ef0faa808c0a5c3c72dda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE2OTc1Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/990#discussion_r419169752", "bodyText": "yes, this FCMBroadcastReceiver class is really independent of FCM or GCM. Since this class directly handles the Intent fired from the \"Google Play services\" app. This receiver would still work if you completely removed both the FCM and GCM libraries from the app. (Today OneSignal uses the FCM / GCM library to register for a push token)", "author": "jkasten2", "createdAt": "2020-05-03T22:36:13Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/FCMBroadcastReceiver.java", "diffHunk": "@@ -106,50 +99,56 @@ private void setAbort() {\n          // Prevents other BroadcastReceivers from firing\n          abortBroadcast();\n \n+         // TODO: Is this an issue with FCM too?", "originalCommit": "c3842b95a0e73729314ef0faa808c0a5c3c72dda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE3MDI4NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/990#discussion_r419170284", "bodyText": "setAbort(); should be removed completely now that OneSignal.getFilterOtherGCMReceivers(context) is gone.", "author": "jkasten2", "createdAt": "2020-05-03T22:41:41Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/FCMBroadcastReceiver.java", "diffHunk": "@@ -69,26 +68,20 @@ public void onReceive(Context context, Intent intent) {\n \n       ProcessedBundleResult processedResult = processOrderBroadcast(context, intent, bundle);\n \n-      // Null means this isn't a GCM / FCM message.\n+      // Null means this isn't a FCM message\n       if (processedResult == null) {\n          setSuccessfulResultCode();\n          return;\n       }\n \n-      // Prevent other GCM receivers from firing if;\n-      //   This is a duplicated GCM message\n-      //   OR app developer setup a extender service to handle the notification.\n-      if (processedResult.isDup || processedResult.hasExtenderService) {\n-         // Abort to prevent other GCM receivers from process this Intent.\n-         setAbort();\n-         return;\n-      }\n-\n-      // Prevent other GCM receivers from firing if;\n-      //   This is a OneSignal payload\n-      //   AND the setting is enabled to allow filtering in this case.\n-      if (processedResult.isOneSignalPayload &&\n-          OneSignal.getFilterOtherGCMReceivers(context)) {\n+      // Prevent other FCM receivers from firing if:\n+      //    1. This is a duplicated FCM message\n+      //    2. OR app developer setup a extender service to handle the notification\n+      //    3. OR this is a OneSignal payload\n+      if (processedResult.isDup\n+              || processedResult.hasExtenderService\n+              || processedResult.isOneSignalPayload) {\n+         // Abort to prevent other FCM receivers from process this Intent.\n          setAbort();", "originalCommit": "c3842b95a0e73729314ef0faa808c0a5c3c72dda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE3MDM2NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/990#discussion_r419170365", "bodyText": "Remove this comment, per the logic change noted in the comment just below.", "author": "jkasten2", "createdAt": "2020-05-03T22:42:45Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/FCMBroadcastReceiver.java", "diffHunk": "@@ -69,26 +68,20 @@ public void onReceive(Context context, Intent intent) {\n \n       ProcessedBundleResult processedResult = processOrderBroadcast(context, intent, bundle);\n \n-      // Null means this isn't a GCM / FCM message.\n+      // Null means this isn't a FCM message\n       if (processedResult == null) {\n          setSuccessfulResultCode();\n          return;\n       }\n \n-      // Prevent other GCM receivers from firing if;\n-      //   This is a duplicated GCM message\n-      //   OR app developer setup a extender service to handle the notification.\n-      if (processedResult.isDup || processedResult.hasExtenderService) {\n-         // Abort to prevent other GCM receivers from process this Intent.\n-         setAbort();\n-         return;\n-      }\n-\n-      // Prevent other GCM receivers from firing if;\n-      //   This is a OneSignal payload\n-      //   AND the setting is enabled to allow filtering in this case.\n-      if (processedResult.isOneSignalPayload &&\n-          OneSignal.getFilterOtherGCMReceivers(context)) {\n+      // Prevent other FCM receivers from firing if:\n+      //    1. This is a duplicated FCM message\n+      //    2. OR app developer setup a extender service to handle the notification\n+      //    3. OR this is a OneSignal payload\n+      if (processedResult.isDup\n+              || processedResult.hasExtenderService\n+              || processedResult.isOneSignalPayload) {\n+         // Abort to prevent other FCM receivers from process this Intent.", "originalCommit": "c3842b95a0e73729314ef0faa808c0a5c3c72dda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE3MTUxNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/990#discussion_r419171516", "bodyText": "This was not done in this PR. Keep this comment. Also FCM migration is out of scope of an AndroidX migration so I would recommend a different PR.", "author": "jkasten2", "createdAt": "2020-05-03T22:54:30Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/FCMBroadcastReceiver.java", "diffHunk": "@@ -35,24 +35,23 @@\n import android.os.Build;\n import android.os.Bundle;\n import android.os.Parcelable;\n-import android.os.PersistableBundle;\n-import android.support.annotation.Nullable;\n-import android.support.v4.content.WakefulBroadcastReceiver;\n+\n+import androidx.annotation.Nullable;\n+import androidx.legacy.content.WakefulBroadcastReceiver;\n \n import com.onesignal.NotificationBundleProcessor.ProcessedBundleResult;\n \n-// This is the entry point when a FCM / GCM payload is received from the Google Play services app\n-// TODO: 4.0.0 - Update to use <action android:name=\"com.google.firebase.MESSAGING_EVENT\"/>", "originalCommit": "c3842b95a0e73729314ef0faa808c0a5c3c72dda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE3MjAzOA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/990#discussion_r419172038", "bodyText": "Put back to \"gcm\", see my comment in FCMBroadcastReceiver", "author": "jkasten2", "createdAt": "2020-05-03T23:00:28Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/GenerateNotificationRunner.java", "diffHunk": "@@ -1032,28 +1032,28 @@ public void shouldCorrectlyDisplaySummaryWithMixedInAppAlertsAndNotifications()\n       // Setup - Send 2 more notifications with the same group\n       bundle = getBaseNotifBundle(\"UUID2\");\n       bundle.putString(\"grp\", \"test1\");\n-      NotificationBundleProcessor_ProcessFromGCMIntentService(blankActivity, bundle, null);\n+      NotificationBundleProcessor_ProcessFromFCMIntentService(blankActivity, bundle, null);\n       bundle = getBaseNotifBundle(\"UUID3\");\n       bundle.putString(\"grp\", \"test1\");\n-      NotificationBundleProcessor_ProcessFromGCMIntentService(blankActivity, bundle, null);\n+      NotificationBundleProcessor_ProcessFromFCMIntentService(blankActivity, bundle, null);\n    \n       // Test - equals 3 - Should be 2 notifications + 1 summary.\n       //         Alert should stay as an in-app alert.\n       assertEquals(3, ShadowRoboNotificationManager.notifications.size());\n    }\n \n    @Test\n-   @Config(shadows = {ShadowGcmBroadcastReceiver.class})\n+   @Config(shadows = {ShadowFCMBroadcastReceiver.class})\n    public void shouldSetButtonsCorrectly() throws Exception {\n-      Intent intentGcm = new Intent();\n-      intentGcm.setAction(\"com.google.android.c2dm.intent.RECEIVE\");\n-      intentGcm.putExtra(\"message_type\", \"gcm\");\n+      Intent intent = new Intent();\n+      intent.setAction(\"com.google.android.c2dm.intent.RECEIVE\");\n+      intent.putExtra(\"message_type\", \"fcm\");", "originalCommit": "c3842b95a0e73729314ef0faa808c0a5c3c72dda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "646b213452ce1fd5ee2b95c5b3fe040457d5232e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/646b213452ce1fd5ee2b95c5b3fe040457d5232e", "message": "Reverted some partially FCM migrations\n* Now only naming has been changed to prepare for FCM migration\n  * Still using GCM, but FCM names everywhere until FIREBASE_MESSAGING action is added\n  * Changed back to \"gcm\" type for payload expectation", "committedDate": "2020-05-04T15:45:10Z", "type": "commit"}, {"oid": "8d3e2839298cca6c4c805e5ee4d62513db74f9d4", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8d3e2839298cca6c4c805e5ee4d62513db74f9d4", "message": "UnitTest no longer relevant because GCM filtering is removed\n* Refactored in previous commit(s) on accident to FCM but should have been GCM and the deleted", "committedDate": "2020-05-04T16:19:34Z", "type": "commit"}]}