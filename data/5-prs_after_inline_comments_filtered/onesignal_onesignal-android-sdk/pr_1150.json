{"pr_number": 1150, "pr_title": "Fix equal trigger when using number", "pr_createdAt": "2020-09-16T18:04:31Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1150", "timeline": [{"oid": "80821bbb4b554523c78de7ed586e779b33d5a067", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/80821bbb4b554523c78de7ed586e779b33d5a067", "message": "Fix equal trigger when using number\n\n* Trim ceros for string equal matching", "committedDate": "2020-09-18T17:16:25Z", "type": "commit"}, {"oid": "80821bbb4b554523c78de7ed586e779b33d5a067", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/80821bbb4b554523c78de7ed586e779b33d5a067", "message": "Fix equal trigger when using number\n\n* Trim ceros for string equal matching", "committedDate": "2020-09-18T17:16:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NTEwNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1150#discussion_r491195106", "bodyText": "It's not clear to me how this change makes the new testMessageDisplayedAfterAddTriggerEqualWithStringVsNumber test you added pass. Since triggerValue is \"5\" in your test and never get converted, as we are only formatting the device value.", "author": "jkasten2", "createdAt": "2020-09-18T21:17:52Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSTriggerController.java", "diffHunk": "@@ -116,8 +117,16 @@ private boolean triggerMatchesFlex(@Nullable Object triggerValue, @NonNull Objec\n             return false;\n \n         // If operator is equal or not equals ignore type by comparing on toString values\n-        if (operator.checksEquality())\n-            return triggerMatchesStringValue(triggerValue.toString(), deviceValue.toString(), operator);\n+        if (operator.checksEquality()) {\n+            String triggerValueString = triggerValue.toString();\n+            String deviceValueString = deviceValue.toString();\n+            if (deviceValue instanceof Number) {\n+                // User may have an input text that converts 5 to 5.0, we only care about the raw value on equals\n+                DecimalFormat format = new DecimalFormat(\"0.#\");\n+                deviceValueString = format.format(deviceValue);\n+            }\n+            return triggerMatchesStringValue(triggerValueString, deviceValueString, operator);", "originalCommit": "80821bbb4b554523c78de7ed586e779b33d5a067", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc2MDY2Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1150#discussion_r492760663", "bodyText": "This problem started happening because the demo app input box converts integer to doubles, so whener we put 5 it will put 5.0, 1 -> 1.0 and so on.\nServer numbers come always trimed or they came as strings. So we need to trim user input to match server value, that is why device value is the only one formatted.\nThe tests cover when the user adds 5.0 or 5.50 inputs and the server trigger value is a string \"5\" and \"5.5\". In order to match EQUALS, we need to trim ceros from the user input for the string equals to match.\nMake sense?", "author": "Jeasmine", "createdAt": "2020-09-22T14:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NTEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ5ODAyNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1150#discussion_r494498027", "bodyText": "got it, I think I flipped it around when reading this code", "author": "jkasten2", "createdAt": "2020-09-24T17:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NTEwNg=="}], "type": "inlineReview"}]}