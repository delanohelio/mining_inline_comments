{"pr_number": 1006, "pr_title": "Add location permissions not available alert dialog", "pr_createdAt": "2020-05-06T18:09:30Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006", "timeline": [{"oid": "c33c758becdc6e77b404d539db0c99e12c9c367c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c33c758becdc6e77b404d539db0c99e12c9c367c", "message": "Add location permissions not available alert dialog\n\n   * Inform the user when using preview mode that location permissions are not configured", "committedDate": "2020-05-06T18:30:56Z", "type": "forcePushed"}, {"oid": "9a73f4b38d898413cf5098caba5430cb9f2db512", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/9a73f4b38d898413cf5098caba5430cb9f2db512", "message": "Add location permissions not available alert dialog\n\n   * Inform the user when using preview mode that location permissions are not configured", "committedDate": "2020-05-06T18:32:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAxNDE1OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r421014158", "bodyText": "Lets rename this, we have the word Alert thrown all over our code and this is technically an AlertDialog\nI was thinking something along the lines of:\nshowInfoAlertDialog or\nshowAlertDialogMessage", "author": "mikechoch", "createdAt": "2020-05-06T18:46:46Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -323,18 +323,35 @@ private void showMultiplePrompts(final OSInAppMessage message, final List<OSInAp\n             currentPrompt.setPrompted(true);\n             currentPrompt.handlePrompt(new OneSignal.OSPromptActionCompletionCallback() {\n                 @Override\n-                public void completed(boolean accepted) {\n+                public void completed(@Nullable String messageTitle, @Nullable String message, boolean accepted) {\n                     currentPrompt = null;\n                     OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"IAM prompt to handle finished accepted: \" + accepted);\n-                    showMultiplePrompts(message, prompts);\n+\n+                    // On preview mode we show informative alert dialogs\n+                    if (inAppMessage.isPreview && messageTitle!= null && message != null)\n+                        showInformativeAlert(messageTitle, message, inAppMessage, prompts);\n+                    else\n+                        showMultiplePrompts(inAppMessage, prompts);\n                 }\n             });\n         } else {\n-            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"No IAM prompt to handle, dismiss message: \" + message.messageId);\n-            messageWasDismissed(message);\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"No IAM prompt to handle, dismiss message: \" + inAppMessage.messageId);\n+            messageWasDismissed(inAppMessage);\n         }\n     }\n \n+    private void showInformativeAlert(final String messageTitle, final String message, final OSInAppMessage inAppMessage, final List<OSInAppMessagePrompt> prompts) {", "originalCommit": "9a73f4b38d898413cf5098caba5430cb9f2db512", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyMDU4NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r421020584", "bodyText": "Add a space here messageTitle!= null\nmessageTitle != null", "author": "mikechoch", "createdAt": "2020-05-06T18:57:19Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -323,18 +323,35 @@ private void showMultiplePrompts(final OSInAppMessage message, final List<OSInAp\n             currentPrompt.setPrompted(true);\n             currentPrompt.handlePrompt(new OneSignal.OSPromptActionCompletionCallback() {\n                 @Override\n-                public void completed(boolean accepted) {\n+                public void completed(@Nullable String messageTitle, @Nullable String message, boolean accepted) {\n                     currentPrompt = null;\n                     OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"IAM prompt to handle finished accepted: \" + accepted);\n-                    showMultiplePrompts(message, prompts);\n+\n+                    // On preview mode we show informative alert dialogs\n+                    if (inAppMessage.isPreview && messageTitle!= null && message != null)", "originalCommit": "9a73f4b38d898413cf5098caba5430cb9f2db512", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyNzMxNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r421027315", "bodyText": "Add a space to this promptLocation,false,\npromptLocation, false,", "author": "mikechoch", "createdAt": "2020-05-06T19:08:45Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationGMS.java", "diffHunk": "@@ -189,7 +194,7 @@ static void getLocation(Context context, boolean promptLocation, LocationHandler\n \n       if (android.os.Build.VERSION.SDK_INT < Build.VERSION_CODES.M) {\n          if (locationFinePermission != PackageManager.PERMISSION_GRANTED && locationCoarsePermission != PackageManager.PERMISSION_GRANTED) {\n-            sendAndClearPromptHandlers(promptLocation,false);\n+            sendAndClearPromptHandlers(promptLocation,false, context.getString(R.string.location_not_available_title), context.getString(R.string.location_not_available_message));", "originalCommit": "9a73f4b38d898413cf5098caba5430cb9f2db512", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyOTAxNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r421029016", "bodyText": "String alertDialogTitle = context.getString(R.string.location_not_available_title);\nString alertDialogMessage = context.getString(R.string. location_not_available_message);\n\nPass these into both usages of\nsendAndClearPromptHandlers(promptLocation, false, alertDialogTitle, alertDialogMessage);", "author": "mikechoch", "createdAt": "2020-05-06T19:11:35Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationGMS.java", "diffHunk": "@@ -189,7 +194,7 @@ static void getLocation(Context context, boolean promptLocation, LocationHandler\n ", "originalCommit": "9a73f4b38d898413cf5098caba5430cb9f2db512", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8c245744613a4af21e3a2d77c060ee744463fd69", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8c245744613a4af21e3a2d77c060ee744463fd69", "message": "Add location permissions not available alert dialog\n\n   * Inform the user when using preview mode that location permissions are not configured", "committedDate": "2020-05-06T20:52:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgxMjgxNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r421812815", "bodyText": "You use these Strings in two places just move them up top outside of the first if statement", "author": "mikechoch", "createdAt": "2020-05-07T21:44:59Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationGMS.java", "diffHunk": "@@ -223,11 +231,13 @@ else if (permissionList.contains(\"android.permission.ACCESS_COARSE_LOCATION\")) {\n                   sendAndClearPromptHandlers(promptLocation, true);\n                   startGetLocation();\n                } else {\n-                  sendAndClearPromptHandlers(promptLocation, false);\n+                  String alertDialogTitle = context.getString(R.string.location_not_available_title);\n+                  String alertDialogMessage = context.getString(R.string. location_not_available_message);", "originalCommit": "8c245744613a4af21e3a2d77c060ee744463fd69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgxMzA1OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r421813058", "bodyText": "Remove space R.string. location_not_available_message);\nR.string.location_not_available_message);", "author": "mikechoch", "createdAt": "2020-05-07T21:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgxMjgxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwMTc5Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r423301792", "bodyText": "Instead of getting these string from the code get the location points I believe it should be put where the alert will be displayed. Since the string is more of a presentation layer.\nThis will also clean up a lot of unnecessary passing around of these values", "author": "jkasten2", "createdAt": "2020-05-11T20:32:22Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationGMS.java", "diffHunk": "@@ -187,9 +192,13 @@ static void getLocation(Context context, boolean promptLocation, LocationHandler\n          locationCoarse = true;\n       }\n \n+      String alertDialogTitle = context.getString(R.string.location_not_available_title);", "originalCommit": "53e0d92238ee55215e1871e9bd367b7f53701c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyNzQ2Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r423327466", "bodyText": "ok, agree with this!", "author": "Jeasmine", "createdAt": "2020-05-11T21:21:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwMTc5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwNjIzOQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r423306239", "bodyText": "Out of scope of this PR since it was here before this one, but I don't what onAnswered covers that isn't already by complete instead?\nMaybe the differences aren't clear to me based on the name alone.", "author": "jkasten2", "createdAt": "2020-05-11T20:40:58Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationGMS.java", "diffHunk": "@@ -87,7 +88,7 @@\n    }\n \n    abstract static class LocationPromptCompletionHandler implements LocationHandler {\n-      void onAnswered(boolean accepted) {}\n+      void onAnswered(@Nullable String messageTitle, @Nullable String message, boolean accepted) {}", "originalCommit": "53e0d92238ee55215e1871e9bd367b7f53701c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMzMzQ3NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r423333475", "bodyText": "onComplete handles to many flows, for prompting we only want to know what the user answered to the prompt, or if the permissions were already granted, we don't care about the location perse.", "author": "Jeasmine", "createdAt": "2020-05-11T21:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwNjIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxODcxMQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r423318711", "bodyText": "It isn't clear here by the code but it can only fall under this if block if permission were missing from the AndroidManifest.xml", "author": "jkasten2", "createdAt": "2020-05-11T21:04:20Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationGMS.java", "diffHunk": "@@ -187,9 +192,13 @@ static void getLocation(Context context, boolean promptLocation, LocationHandler\n          locationCoarse = true;\n       }\n \n+      String alertDialogTitle = context.getString(R.string.location_not_available_title);\n+      String alertDialogMessage = context.getString(R.string.location_not_available_message);\n+\n       if (android.os.Build.VERSION.SDK_INT < Build.VERSION_CODES.M) {\n          if (locationFinePermission != PackageManager.PERMISSION_GRANTED && locationCoarsePermission != PackageManager.PERMISSION_GRANTED) {", "originalCommit": "53e0d92238ee55215e1871e9bd367b7f53701c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyOTQ4Nw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r423329487", "bodyText": "This flow is added because the user might forget to add the permissions on Manifest, and location prompting will not work, because of that. So we are only showing this alert when the user is prompting from a preview.", "author": "Jeasmine", "createdAt": "2020-05-11T21:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxODcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMzNzg3Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r423337872", "bodyText": "Sorry didn't finish my thought here. That isn't clear so we should add a comment.\nThe code originally should have had a comment about that for now it seems it needs it even more.", "author": "jkasten2", "createdAt": "2020-05-11T21:44:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxODcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NTM3Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r423345373", "bodyText": "Let me know if the changes make sense, in order to make it on iOS", "author": "Jeasmine", "createdAt": "2020-05-11T22:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxODcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMDM2MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r423320361", "bodyText": "Careful, we don't want to display a message if the only issue was the user denied location permission.", "author": "jkasten2", "createdAt": "2020-05-11T21:07:39Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationGMS.java", "diffHunk": "@@ -223,11 +232,11 @@ else if (permissionList.contains(\"android.permission.ACCESS_COARSE_LOCATION\")) {\n                   sendAndClearPromptHandlers(promptLocation, true);\n                   startGetLocation();\n                } else {\n-                  sendAndClearPromptHandlers(promptLocation, false);\n+                  sendAndClearPromptHandlers(promptLocation, false, alertDialogTitle, alertDialogMessage);", "originalCommit": "53e0d92238ee55215e1871e9bd367b7f53701c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyOTU1Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1006#discussion_r423329552", "bodyText": "good catch!", "author": "Jeasmine", "createdAt": "2020-05-11T21:26:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMDM2MQ=="}], "type": "inlineReview"}, {"oid": "2654db0d75bab91e8005ddb466c7bd7062235661", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/2654db0d75bab91e8005ddb466c7bd7062235661", "message": "Refactor LocationGMS response for prompting", "committedDate": "2020-05-11T21:59:39Z", "type": "forcePushed"}, {"oid": "689c66d8c1753c36f0de1fe2cd7402f6b8466d89", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/689c66d8c1753c36f0de1fe2cd7402f6b8466d89", "message": "Add location permissions not available alert dialog\n\n   * Inform the user when using preview mode that location permissions are not configured", "committedDate": "2020-05-12T14:33:30Z", "type": "commit"}, {"oid": "41ba399dd4ac0871ea4775a32b022fb302a2ad22", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/41ba399dd4ac0871ea4775a32b022fb302a2ad22", "message": "Add Settings option to denied location prompt\n\n   * Whenever the user clicks on never ask again option and denies the permission,\n     we will show the reason why we need it and the option to open settings and change the location permission\n   * Don't show setting dialog after first never ask again option click", "committedDate": "2020-05-12T14:34:46Z", "type": "commit"}, {"oid": "41ba399dd4ac0871ea4775a32b022fb302a2ad22", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/41ba399dd4ac0871ea4775a32b022fb302a2ad22", "message": "Add Settings option to denied location prompt\n\n   * Whenever the user clicks on never ask again option and denies the permission,\n     we will show the reason why we need it and the option to open settings and change the location permission\n   * Don't show setting dialog after first never ask again option click", "committedDate": "2020-05-12T14:34:46Z", "type": "forcePushed"}]}