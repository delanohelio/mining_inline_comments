{"pr_number": 994, "pr_title": "Completely remove global static deviceType int", "pr_createdAt": "2020-04-21T03:25:21Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/994", "timeline": [{"oid": "6826de8ed806626bddcef6615b0e63ca55dcaf13", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/6826de8ed806626bddcef6615b0e63ca55dcaf13", "message": "Completely remove global static deviceType int\n* Better to use the OSUtils getDeviceType method since we wont know what part fo the SDK init we are in\n* The chance of a 0 deviceType is a race condition we do not want to fight with", "committedDate": "2020-04-21T03:24:31Z", "type": "commit"}, {"oid": "22147c1658d7f2c46f473896d9d00374d838a094", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/22147c1658d7f2c46f473896d9d00374d838a094", "message": "Remove space from param key name \"device_type\"", "committedDate": "2020-04-21T03:26:56Z", "type": "commit"}, {"oid": "e10a87b94ccea040f0f606290c3fc3919897bf71", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/e10a87b94ccea040f0f606290c3fc3919897bf71", "message": "Unit tests created for testing Android and Amazon device types\n* Make sure that the correct device_type appears in the player create network requests\n* Using ShadowOSUtils getDeviceType now relies on a availableClasses HashSet\n  * Created a method called mockAmazonDevice that will add the ADM class string and when this exists we can pretend this device is a Amazon FireOS device\n* Added a few new asserts to check against device type in player create payloads and generic on session requests", "committedDate": "2020-04-22T06:26:29Z", "type": "commit"}, {"oid": "315536f354eb0cd5e161df806c956ff5dbdb78b1", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/315536f354eb0cd5e161df806c956ff5dbdb78b1", "message": "Cleaned up device type unit tests\n* Checking against the deviceType in the player create right after OneSignal init", "committedDate": "2020-04-22T06:31:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIyMDI5Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/994#discussion_r413220296", "bodyText": "This looks good for now, as getDeviceType gets more complex with more platforms we will probably want to not mock this method. But that can be done in the task where we add the new platform.", "author": "jkasten2", "createdAt": "2020-04-22T18:30:06Z", "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java", "diffHunk": "@@ -1,23 +1,63 @@\n package com.onesignal;\n \n+import android.content.Context;\n+\n import org.robolectric.annotation.Implements;\n \n+import java.util.HashSet;\n+\n @Implements(OSUtils.class)\n public class ShadowOSUtils {\n-   static int deviceType = 1;\n-   public static String carrierName = \"test1\";\n \n-   public static int subscribableStatus = 1;\n+   private static String FIRE_OS_CLASS = \"com.amazon.device.messaging.ADM\";\n+\n+   static int deviceType;\n+   public static String carrierName;\n+   public static int subscribableStatus;\n+\n+   /**\n+    * Used to mock the existence of FireOS ADM class for Amazon devices\n+    * TODO: This could apply to other classes that might not be available in our UnitTests but\n+    *  we want to mock in a way that makes sense and tests our SDK the closest to production functionality\n+    */\n+   private static HashSet<String> availableClasses;\n+\n+   public static void mockAmazonDevice() {\n+      ShadowOSUtils.addClass(ShadowOSUtils.FIRE_OS_CLASS);\n+   }\n+\n+   private static void addClass(String className) {\n+      availableClasses.add(className);\n+   }\n+\n+   /**\n+    * Reset all static values (should be called before each test)\n+    */\n+   public static void resetStatics() {\n+      deviceType = 0;\n+      carrierName = \"test1\";\n+      subscribableStatus = 1;\n+\n+      availableClasses = new HashSet<>();\n+   }\n \n    public int getDeviceType() {\n+      // Class only available on the FireOS, if this class exists we want to mock Amazon deviceType", "originalCommit": "315536f354eb0cd5e161df806c956ff5dbdb78b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1NDA2MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/994#discussion_r413254061", "bodyText": "Yeah we would need a better way to mock a class existing within our unit tests and that way when the REAL getDeviceType method is called it just uses that functionality rather then my HashSet", "author": "mikechoch", "createdAt": "2020-04-22T19:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIyMDI5Ng=="}], "type": "inlineReview"}, {"oid": "b10c5dba4ce5c6f5ca50cb2d1daa0b061dd6bd66", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b10c5dba4ce5c6f5ca50cb2d1daa0b061dd6bd66", "message": "Added resetStatics to ADM shadow in unit tests\n* Without resetting the statics for ADM the on_session will not be called, need to find\nWIP need to fix the current test related to making sure previous usage deviceType fails and new usage passes", "committedDate": "2020-04-22T22:11:29Z", "type": "commit"}, {"oid": "bdcff872b903e92f465c917153566c3bdaa19fda", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bdcff872b903e92f465c917153566c3bdaa19fda", "message": "Finished unit test related to device type on Android and Amazon\n* Remove package private helper for setAppContext\n* Removed all refs to appId and now we try to use a cached appId in the network requests\n* Testing deviceType to reproduce the 0 deviceType and this is through two new tests, one for Android and one for Amazon", "committedDate": "2020-04-23T07:26:04Z", "type": "commit"}]}