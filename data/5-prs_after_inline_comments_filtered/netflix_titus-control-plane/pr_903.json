{"pr_number": 903, "pr_title": "RFC - Make the kubeapiserver connector understand pod ips from kubelet", "pr_createdAt": "2020-08-26T21:58:02Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/903", "timeline": [{"oid": "253b77b7946c0f02818e5fc713b24256a72b31a9", "url": "https://github.com/Netflix/titus-control-plane/commit/253b77b7946c0f02818e5fc713b24256a72b31a9", "message": "Make the KubeNotificationProcessor understand pod ips from kubelet", "committedDate": "2020-08-27T18:24:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyODEwNw==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r478628107", "bodyText": "You can use equivalent method from Evaluators class in titus-common.", "author": "tbak", "createdAt": "2020-08-27T18:54:05Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/JobManagerUtil.java", "diffHunk": "@@ -148,6 +149,15 @@ public static Task attachPlacementData(Task task, Optional<TitusExecutorDetails>\n         }).orElse(task);\n     }\n \n+    public static Task attachKubeletData(Task task, PodWrapper podWrapper) {\n+        String ipv4 = podWrapper.getV1Pod().getStatus().getPodIP();\n+        Map<String, String> newContext = new HashMap<>(task.getTaskContext());\n+        BiConsumer<String, String> contextSetter = (key, value) -> StringExt.applyIfNonEmpty(value, v -> newContext.put(key, v));", "originalCommit": "253b77b7946c0f02818e5fc713b24256a72b31a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQyODk3NQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479428975", "bodyText": "I see applyNotNull in Evaulators, but that won't help me against Empty strings though.", "author": "solarkennedy", "createdAt": "2020-08-28T17:03:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyODEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyODU0Mw==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r478628543", "bodyText": "You should check defensively that status is not null as well.", "author": "tbak", "createdAt": "2020-08-27T18:54:54Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/JobManagerUtil.java", "diffHunk": "@@ -148,6 +149,15 @@ public static Task attachPlacementData(Task task, Optional<TitusExecutorDetails>\n         }).orElse(task);\n     }\n \n+    public static Task attachKubeletData(Task task, PodWrapper podWrapper) {\n+        String ipv4 = podWrapper.getV1Pod().getStatus().getPodIP();", "originalCommit": "253b77b7946c0f02818e5fc713b24256a72b31a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQyOTA2Ng==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479429066", "bodyText": "Good idea", "author": "solarkennedy", "createdAt": "2020-08-28T17:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyODU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzNzEzNA==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479437134", "bodyText": "We should also add if(podWrapper.getV1Pod().getStatus() == null) { return task; }", "author": "tbak", "createdAt": "2020-08-28T17:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyODU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyOTE5NA==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r478629194", "bodyText": "executorDetailsOpt == null || executorDetailsOpt.isEmpty()", "author": "tbak", "createdAt": "2020-08-27T18:56:04Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java", "diffHunk": "@@ -290,8 +290,13 @@ static Task updateTaskStatus(PodWrapper podWrapper,\n                 .build();\n \n         Task fixedTask = fillInMissingStates(podWrapper, updatedTask);\n-        Task taskWithPlacementData = JobManagerUtil.attachPlacementData(fixedTask, executorDetailsOpt);\n-        Task taskWithNodeMetadata = node.map(n -> attachNodeMetadata(taskWithPlacementData, n)).orElse(taskWithPlacementData);\n+        Task taskWithExecutorData;\n+        if (executorDetailsOpt == null) {", "originalCommit": "253b77b7946c0f02818e5fc713b24256a72b31a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzMDI1NA==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479430254", "bodyText": "There is no method like that on this object (because it is optional?)\nThere is a isPresent, but it just checks for nullness too.", "author": "solarkennedy", "createdAt": "2020-08-28T17:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyOTE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyOTc1MQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r478629751", "bodyText": "That is not need needed?", "author": "tbak", "createdAt": "2020-08-27T18:57:04Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "diffHunk": "@@ -127,7 +127,21 @@ public static boolean isPodPhaseTerminal(String phase) {\n                     )\n             );\n             return Optional.of(titusExecutorDetails);\n+        } else if (!Strings.isNullOrEmpty(pod.getStatus().getPodIP())) {", "originalCommit": "253b77b7946c0f02818e5fc713b24256a72b31a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac07a43619689f39f9d26e84536ad39bccac89bb", "url": "https://github.com/Netflix/titus-control-plane/commit/ac07a43619689f39f9d26e84536ad39bccac89bb", "message": "Make the KubeNotificationProcessor understand pod ips from kubelet", "committedDate": "2020-08-28T17:09:27Z", "type": "forcePushed"}, {"oid": "3eb607a9a6dedf2edf30a39cb67329ed22fef603", "url": "https://github.com/Netflix/titus-control-plane/commit/3eb607a9a6dedf2edf30a39cb67329ed22fef603", "message": "Added test case for pod ips in kubelet", "committedDate": "2020-08-28T17:32:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwMTE5MQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479501191", "bodyText": "minor: formatting is odd here. There's code style config file for IntelliJ you can use in the codequality/ folder", "author": "fabiokung", "createdAt": "2020-08-28T19:42:35Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/JobManagerUtil.java", "diffHunk": "@@ -148,6 +149,20 @@ public static Task attachPlacementData(Task task, Optional<TitusExecutorDetails>\n         }).orElse(task);\n     }\n \n+    public static Task attachKubeletData(Task task, PodWrapper podWrapper) {\n+        if(podWrapper.getV1Pod().getStatus() == null) { return task; }", "originalCommit": "3eb607a9a6dedf2edf30a39cb67329ed22fef603", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwMTUzNQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479501535", "bodyText": "minor: remove the else (previous if clause already has an early return) and reduce indentation level", "author": "fabiokung", "createdAt": "2020-08-28T19:43:22Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/JobManagerUtil.java", "diffHunk": "@@ -148,6 +149,20 @@ public static Task attachPlacementData(Task task, Optional<TitusExecutorDetails>\n         }).orElse(task);\n     }\n \n+    public static Task attachKubeletData(Task task, PodWrapper podWrapper) {\n+        if(podWrapper.getV1Pod().getStatus() == null) { return task; }\n+        String ipv4 = podWrapper.getV1Pod().getStatus().getPodIP();\n+        if (ipv4 == null || ipv4.isEmpty()) {\n+            return task;\n+        } else {", "originalCommit": "3eb607a9a6dedf2edf30a39cb67329ed22fef603", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwMzM3MA==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479503370", "bodyText": "odd formatting, please use the code-style rules in codequality/", "author": "fabiokung", "createdAt": "2020-08-28T19:47:29Z", "path": "titus-server-master/src/test/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessorTest.java", "diffHunk": "@@ -45,16 +45,7 @@\n import com.netflix.titus.master.mesos.kubeapiserver.direct.model.PodPhase;\n import com.netflix.titus.master.mesos.kubeapiserver.direct.model.PodWrapper;\n import com.netflix.titus.testkit.model.job.JobGenerator;\n-import io.kubernetes.client.openapi.models.V1ContainerState;\n-import io.kubernetes.client.openapi.models.V1ContainerStateRunning;\n-import io.kubernetes.client.openapi.models.V1ContainerStateWaiting;\n-import io.kubernetes.client.openapi.models.V1ContainerStatus;\n-import io.kubernetes.client.openapi.models.V1Node;\n-import io.kubernetes.client.openapi.models.V1NodeAddress;\n-import io.kubernetes.client.openapi.models.V1NodeStatus;\n-import io.kubernetes.client.openapi.models.V1ObjectMeta;\n-import io.kubernetes.client.openapi.models.V1Pod;\n-import io.kubernetes.client.openapi.models.V1PodStatus;\n+import io.kubernetes.client.openapi.models.*;", "originalCommit": "3eb607a9a6dedf2edf30a39cb67329ed22fef603", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUxMTg1NQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479511855", "bodyText": "Ah! I should have read CONTRIBUTING!", "author": "solarkennedy", "createdAt": "2020-08-28T20:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwMzM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwMzkyMg==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479503922", "bodyText": "instead of doing this here, did you consider changing the logic in KubeUtil.getTitusExecutorDetails(pod), and checking whether pod.getStatus().getPodIP() should be used instead of annotations there? Centralizing this logic in that method looks cleaner to me. As more metadata is added to the kubelet path, I think it will be easier to keep both code paths more consistent in there.", "author": "fabiokung", "createdAt": "2020-08-28T19:48:44Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java", "diffHunk": "@@ -290,8 +290,13 @@ static Task updateTaskStatus(PodWrapper podWrapper,\n                 .build();\n \n         Task fixedTask = fillInMissingStates(podWrapper, updatedTask);\n-        Task taskWithPlacementData = JobManagerUtil.attachPlacementData(fixedTask, executorDetailsOpt);\n-        Task taskWithNodeMetadata = node.map(n -> attachNodeMetadata(taskWithPlacementData, n)).orElse(taskWithPlacementData);\n+        Task taskWithExecutorData;\n+        if (executorDetailsOpt.isPresent()) {", "originalCommit": "3eb607a9a6dedf2edf30a39cb67329ed22fef603", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUxMzk3NQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479513975", "bodyText": "I feel like I'm getting conflicting review here. I originally had this logic in getTitusExecutorDetails, but @tbak asked me to check if executorDetailsOpt was present first and do it this way (pretty sure if I'm interpreting his intent).", "author": "solarkennedy", "createdAt": "2020-08-28T20:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwMzkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUxODA1OQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479518059", "bodyText": "My point was that TitusExecutorDetails is a legacy data structure that we want to get rid off.\nI think it would be better to move the new function into KubeUtil, but keep it separate as it is now.", "author": "tbak", "createdAt": "2020-08-28T20:23:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwMzkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUyMjA5OA==", "url": "https://github.com/Netflix/titus-control-plane/pull/903#discussion_r479522098", "bodyText": "minor: missed formatting here", "author": "fabiokung", "createdAt": "2020-08-28T20:33:38Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "diffHunk": "@@ -132,6 +132,7 @@ public static boolean isPodPhaseTerminal(String phase) {\n     }\n \n     public static Optional<V1ContainerState> findContainerState(V1Pod pod) {\n+        if(pod.getStatus() == null) { return Optional.empty(); }", "originalCommit": "c9da78c2266510e1e1dcdeb9170af79fc292dee1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e4ce6b420c0f48f3659f1bbe3523b07e971c448f", "url": "https://github.com/Netflix/titus-control-plane/commit/e4ce6b420c0f48f3659f1bbe3523b07e971c448f", "message": "Make the KubeNotificationProcessor understand pod ips from kubelet", "committedDate": "2020-08-28T22:34:28Z", "type": "commit"}, {"oid": "e4ce6b420c0f48f3659f1bbe3523b07e971c448f", "url": "https://github.com/Netflix/titus-control-plane/commit/e4ce6b420c0f48f3659f1bbe3523b07e971c448f", "message": "Make the KubeNotificationProcessor understand pod ips from kubelet", "committedDate": "2020-08-28T22:34:28Z", "type": "forcePushed"}]}