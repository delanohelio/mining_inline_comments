{"pr_number": 858, "pr_title": "add scheduling constraint for kube nodes", "pr_createdAt": "2020-06-04T17:24:43Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/858", "timeline": [{"oid": "4b728837de9f9b1a4acbddf14e0fdd2c6f9fbf8e", "url": "https://github.com/Netflix/titus-control-plane/commit/4b728837de9f9b1a4acbddf14e0fdd2c6f9fbf8e", "message": "add scheduling constraint for kube nodes instead of trying to do lease management when conditions and taints change", "committedDate": "2020-06-04T17:23:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyNzkxMg==", "url": "https://github.com/Netflix/titus-control-plane/pull/858#discussion_r435427912", "bodyText": "Do we depend on GC process here to do the cleanup?", "author": "tbak", "createdAt": "2020-06-04T17:30:15Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java", "diffHunk": "@@ -329,18 +329,10 @@ public void onDelete(V1Node node, boolean deletedFinalStateUnknown) {\n \n     private void nodeUpdated(V1Node node) {\n         try {\n-            boolean removeStopped = node.getStatus().getConditions().stream()", "originalCommit": "4b728837de9f9b1a4acbddf14e0fdd2c6f9fbf8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzMzYyNA==", "url": "https://github.com/Netflix/titus-control-plane/pull/858#discussion_r435433624", "bodyText": "Yes.", "author": "corindwyer", "createdAt": "2020-06-04T17:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyNzkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzMDcwMg==", "url": "https://github.com/Netflix/titus-control-plane/pull/858#discussion_r435430702", "bodyText": "What if node is not there? We should check for null at least + double check that an exception is not thrown if a node is missing or due to other problems.", "author": "tbak", "createdAt": "2020-06-04T17:34:53Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/scheduler/constraint/KubeConstraint.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Copyright 2018 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.scheduler.constraint;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.fenzo.TaskRequest;\n+import com.netflix.fenzo.TaskTrackerState;\n+import com.netflix.fenzo.VirtualMachineCurrentState;\n+import com.netflix.titus.api.agent.model.AgentInstance;\n+import com.netflix.titus.api.agent.service.AgentManagementService;\n+import com.netflix.titus.master.mesos.MesosConfiguration;\n+import com.netflix.titus.master.mesos.kubeapiserver.client.KubeApiFacade;\n+import com.netflix.titus.master.scheduler.SchedulerConfiguration;\n+import com.netflix.titus.master.scheduler.SchedulerUtils;\n+import io.kubernetes.client.openapi.models.V1Node;\n+import io.kubernetes.client.openapi.models.V1NodeCondition;\n+import io.kubernetes.client.openapi.models.V1Taint;\n+\n+/**\n+ * A system constraint that prevents launching a task on Kubernetes nodes based on conditions and taints.\n+ */\n+@Singleton\n+public class KubeConstraint implements SystemConstraint {\n+\n+    public static final String NAME = \"KubeConstraint\";\n+    public static final String INSTANCE_NOT_FOUND_REASON = \"Instance for node not found\";\n+    public static final String NOT_NOT_READY_REASON = \"Node's ready node condition is not true\";\n+    public static final String TAINT_NOT_TOLERATED_IN_CONFIGURATION_REASON = \"Node has a taint that is not configured to be tolerated\";\n+    public static final String READY = \"Ready\";\n+\n+    private static final Result VALID = new Result(true, null);\n+\n+    private enum Failure {\n+        INSTANCE_NOT_FOUND(INSTANCE_NOT_FOUND_REASON),\n+        NODE_NOT_READY(NOT_NOT_READY_REASON),\n+        TAINT_NOT_TOLERATED_IN_CONFIGURATION(TAINT_NOT_TOLERATED_IN_CONFIGURATION_REASON);\n+\n+        private final Result result;\n+\n+        Failure(String reason) {\n+            this.result = new Result(false, reason);\n+        }\n+\n+        public Result toResult() {\n+            return result;\n+        }\n+    }\n+\n+    private static final Set<String> FAILURE_REASONS = Stream.of(KubeConstraint.Failure.values())\n+            .map(f -> f.toResult().getFailureReason())\n+            .collect(Collectors.toSet());\n+\n+    public static boolean isKubeConstraintReason(String reason) {\n+        return reason != null && FAILURE_REASONS.contains(reason);\n+    }\n+\n+    private final SchedulerConfiguration schedulerConfiguration;\n+    private final MesosConfiguration mesosConfiguration;\n+    private final AgentManagementService agentManagementService;\n+    private final KubeApiFacade kubeApiFacade;\n+\n+\n+    @Inject\n+    public KubeConstraint(SchedulerConfiguration schedulerConfiguration,\n+                          MesosConfiguration mesosConfiguration,\n+                          AgentManagementService agentManagementService,\n+                          KubeApiFacade kubeApiFacade) {\n+        this.schedulerConfiguration = schedulerConfiguration;\n+        this.mesosConfiguration = mesosConfiguration;\n+        this.agentManagementService = agentManagementService;\n+        this.kubeApiFacade = kubeApiFacade;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public void prepare() {\n+    }\n+\n+    @Override\n+    public Result evaluate(TaskRequest taskRequest, VirtualMachineCurrentState targetVM, TaskTrackerState taskTrackerState) {\n+        if (!mesosConfiguration.isKubeApiServerIntegrationEnabled()) {\n+            return VALID;\n+        }\n+\n+        Optional<AgentInstance> instanceOpt = SchedulerUtils.findInstance(agentManagementService, schedulerConfiguration.getInstanceAttributeName(), targetVM);\n+        if (!instanceOpt.isPresent()) {\n+            return Failure.INSTANCE_NOT_FOUND.toResult();\n+        }\n+\n+        String instanceId = instanceOpt.get().getId();\n+        V1Node node = kubeApiFacade.getNodeInformer().getIndexer().getByKey(instanceId);", "originalCommit": "4b728837de9f9b1a4acbddf14e0fdd2c6f9fbf8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzNzczMA==", "url": "https://github.com/Netflix/titus-control-plane/pull/858#discussion_r435437730", "bodyText": "good catch. updated", "author": "corindwyer", "createdAt": "2020-06-04T17:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzMDcwMg=="}], "type": "inlineReview"}, {"oid": "774c0d3e8ae9d7fb240f8e15fb52631e7b2520ae", "url": "https://github.com/Netflix/titus-control-plane/commit/774c0d3e8ae9d7fb240f8e15fb52631e7b2520ae", "message": "fix review comments", "committedDate": "2020-06-04T17:45:45Z", "type": "commit"}]}