{"pr_number": 849, "pr_title": "Job activity history plumb the data", "pr_createdAt": "2020-05-21T16:07:35Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/849", "timeline": [{"oid": "deae980b064ace33a9b9444a9dfc5304046a3583", "url": "https://github.com/Netflix/titus-control-plane/commit/deae980b064ace33a9b9444a9dfc5304046a3583", "message": "Move everything to jooqflyway", "committedDate": "2021-03-05T01:49:57Z", "type": "forcePushed"}, {"oid": "34b7a5b225d118596b0f31c9b1cbffd49f4663ff", "url": "https://github.com/Netflix/titus-control-plane/commit/34b7a5b225d118596b0f31c9b1cbffd49f4663ff", "message": "Using a different jooq plugin", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "6071a128184c65e3ca9a6fcf68c7e87b7bbbca1a", "url": "https://github.com/Netflix/titus-control-plane/commit/6071a128184c65e3ca9a6fcf68c7e87b7bbbca1a", "message": "trying to use revolt plugin", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "3d5e818be53b08801fa1e005882c45af36f3e209", "url": "https://github.com/Netflix/titus-control-plane/commit/3d5e818be53b08801fa1e005882c45af36f3e209", "message": "revolut plugin", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "b7fc69ed41cae6ea458aa40cb2c02f7eb949b53d", "url": "https://github.com/Netflix/titus-control-plane/commit/b7fc69ed41cae6ea458aa40cb2c02f7eb949b53d", "message": "update everything", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "a37ad4c517d4e326efa791028c646ddcfd3c6ca3", "url": "https://github.com/Netflix/titus-control-plane/commit/a37ad4c517d4e326efa791028c646ddcfd3c6ca3", "message": "more jooq upgrade", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "ebb2ec58de37a332d52dd23495891250d7409de5", "url": "https://github.com/Netflix/titus-control-plane/commit/ebb2ec58de37a332d52dd23495891250d7409de5", "message": "Add producer to jooq", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "e4a83d457475b8d7f2b6f5a68c922d0545fef3a5", "url": "https://github.com/Netflix/titus-control-plane/commit/e4a83d457475b8d7f2b6f5a68c922d0545fef3a5", "message": "Updating dependency lock", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "6ba62db6c4cd804eb3f342ed0e57f2c2bec25e5c", "url": "https://github.com/Netflix/titus-control-plane/commit/6ba62db6c4cd804eb3f342ed0e57f2c2bec25e5c", "message": "Update dependency lockfile", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "78271e512fd84690be1960d3145dfd6904106471", "url": "https://github.com/Netflix/titus-control-plane/commit/78271e512fd84690be1960d3145dfd6904106471", "message": "Err msgs", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "c006c983819b3b647a6b73f767a428d36ef0e658", "url": "https://github.com/Netflix/titus-control-plane/commit/c006c983819b3b647a6b73f767a428d36ef0e658", "message": "Add driver", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "d8333ff1dae0bf03315a7813cbc08cb2f9fb30f8", "url": "https://github.com/Netflix/titus-control-plane/commit/d8333ff1dae0bf03315a7813cbc08cb2f9fb30f8", "message": "driver", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "fcb805bab3db5f4454d99a1ebd90485d1622d26b", "url": "https://github.com/Netflix/titus-control-plane/commit/fcb805bab3db5f4454d99a1ebd90485d1622d26b", "message": "Adding data source url", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "d610d5aaebcbf3a791e1a7a7a8713d252fe34d64", "url": "https://github.com/Netflix/titus-control-plane/commit/d610d5aaebcbf3a791e1a7a7a8713d252fe34d64", "message": "Updating dependencies", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "235d6493a47b1a56bc438c8f7b3ee8f529ba0a84", "url": "https://github.com/Netflix/titus-control-plane/commit/235d6493a47b1a56bc438c8f7b3ee8f529ba0a84", "message": "Testing publisher in jooqflyway", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "c992404aeb82f5512833d58c153c0c0f37b71915", "url": "https://github.com/Netflix/titus-control-plane/commit/c992404aeb82f5512833d58c153c0c0f37b71915", "message": "Move publisher", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "ffab4ac6a2b678e3ea41cc08a0aa2bee36519626", "url": "https://github.com/Netflix/titus-control-plane/commit/ffab4ac6a2b678e3ea41cc08a0aa2bee36519626", "message": "Tests", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "a446f28e6c5bc2d146fe729a7ed7f50cf21988a3", "url": "https://github.com/Netflix/titus-control-plane/commit/a446f28e6c5bc2d146fe729a7ed7f50cf21988a3", "message": "test", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "3d26020a178a220f7d0589096088eeb05f596409", "url": "https://github.com/Netflix/titus-control-plane/commit/3d26020a178a220f7d0589096088eeb05f596409", "message": "Move everything to jooqflyway", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "2095b032ce6ea87cae63502ab10ba32aa4fd68f9", "url": "https://github.com/Netflix/titus-control-plane/commit/2095b032ce6ea87cae63502ab10ba32aa4fd68f9", "message": "Add scheduler", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "1ebc3271458d97891aa12d3e2fd94ec22f8c5af8", "url": "https://github.com/Netflix/titus-control-plane/commit/1ebc3271458d97891aa12d3e2fd94ec22f8c5af8", "message": "Add leader election", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "0f704380353eb981fc0ba7bd785b48d52ad7ca83", "url": "https://github.com/Netflix/titus-control-plane/commit/0f704380353eb981fc0ba7bd785b48d52ad7ca83", "message": "restoring publisher", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "ca0663d7830d352957b86393b9c8b9f92c34e7b8", "url": "https://github.com/Netflix/titus-control-plane/commit/ca0663d7830d352957b86393b9c8b9f92c34e7b8", "message": "clean up", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "4348f4fc3d7760d64f868671197eb3ae7b5ac0fd", "url": "https://github.com/Netflix/titus-control-plane/commit/4348f4fc3d7760d64f868671197eb3ae7b5ac0fd", "message": "Updating names", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "19997a3dc35d241d84b58e93295a04944e488754", "url": "https://github.com/Netflix/titus-control-plane/commit/19997a3dc35d241d84b58e93295a04944e488754", "message": "Move jooqflyway to jah", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "cdbc0c986c2b185a77411e24167e1b6dccb6fba5", "url": "https://github.com/Netflix/titus-control-plane/commit/cdbc0c986c2b185a77411e24167e1b6dccb6fba5", "message": "update dependency lock", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "584ed2dbc6a7908d25f7297be36b1d86e969857e", "url": "https://github.com/Netflix/titus-control-plane/commit/584ed2dbc6a7908d25f7297be36b1d86e969857e", "message": "Update springboot dependency locks", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "234846487d97631378a77d7a81931f1806b753d2", "url": "https://github.com/Netflix/titus-control-plane/commit/234846487d97631378a77d7a81931f1806b753d2", "message": "testing", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "ae8094b84cc55890a2023dbf4744bb1d720b1c92", "url": "https://github.com/Netflix/titus-control-plane/commit/ae8094b84cc55890a2023dbf4744bb1d720b1c92", "message": "Making changes", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "f761a9648136bd6fc02e3383f6a3f44ee870aa7d", "url": "https://github.com/Netflix/titus-control-plane/commit/f761a9648136bd6fc02e3383f6a3f44ee870aa7d", "message": "Code cleanup", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "1f226b244d7b77076215e281f5b75e89faea8b2f", "url": "https://github.com/Netflix/titus-control-plane/commit/1f226b244d7b77076215e281f5b75e89faea8b2f", "message": "Use flyway", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "dd82c8128fe0ed9ccd113a3e0df73717ea6b305d", "url": "https://github.com/Netflix/titus-control-plane/commit/dd82c8128fe0ed9ccd113a3e0df73717ea6b305d", "message": "more dependencies", "committedDate": "2021-03-15T22:19:49Z", "type": "commit"}, {"oid": "ea605fc3983bae23b200d072afadbbe79f0bd0ca", "url": "https://github.com/Netflix/titus-control-plane/commit/ea605fc3983bae23b200d072afadbbe79f0bd0ca", "message": "work", "committedDate": "2021-03-15T22:19:50Z", "type": "commit"}, {"oid": "3ea307373a4938d961a69e726da4b14b46163482", "url": "https://github.com/Netflix/titus-control-plane/commit/3ea307373a4938d961a69e726da4b14b46163482", "message": "Add logic", "committedDate": "2021-03-15T22:19:50Z", "type": "commit"}, {"oid": "267aeebcf8391f7f0754def056db2482243e81d3", "url": "https://github.com/Netflix/titus-control-plane/commit/267aeebcf8391f7f0754def056db2482243e81d3", "message": "Build", "committedDate": "2021-03-15T22:19:50Z", "type": "commit"}, {"oid": "d01cae6e6c5b667e3f67fa60161940bf0c27237a", "url": "https://github.com/Netflix/titus-control-plane/commit/d01cae6e6c5b667e3f67fa60161940bf0c27237a", "message": "Dont change dependencies for everything else", "committedDate": "2021-03-15T22:19:50Z", "type": "commit"}, {"oid": "50bde7447d28141c0fdf47ca2774e8d2e919b87d", "url": "https://github.com/Netflix/titus-control-plane/commit/50bde7447d28141c0fdf47ca2774e8d2e919b87d", "message": "Disable local", "committedDate": "2021-03-15T22:19:50Z", "type": "commit"}, {"oid": "50bde7447d28141c0fdf47ca2774e8d2e919b87d", "url": "https://github.com/Netflix/titus-control-plane/commit/50bde7447d28141c0fdf47ca2774e8d2e919b87d", "message": "Disable local", "committedDate": "2021-03-15T22:19:50Z", "type": "forcePushed"}, {"oid": "eece028fe554ca946012dc84647582e4b9ede049", "url": "https://github.com/Netflix/titus-control-plane/commit/eece028fe554ca946012dc84647582e4b9ede049", "message": "test", "committedDate": "2021-03-15T23:01:43Z", "type": "commit"}, {"oid": "badc7e27df670dcfb30345096aded40a7c0a41f2", "url": "https://github.com/Netflix/titus-control-plane/commit/badc7e27df670dcfb30345096aded40a7c0a41f2", "message": "trying localhost", "committedDate": "2021-03-16T05:14:07Z", "type": "commit"}, {"oid": "badc7e27df670dcfb30345096aded40a7c0a41f2", "url": "https://github.com/Netflix/titus-control-plane/commit/badc7e27df670dcfb30345096aded40a7c0a41f2", "message": "trying localhost", "committedDate": "2021-03-16T05:14:07Z", "type": "forcePushed"}, {"oid": "be33123e1d257227fbbec51bfe91ed9e107f9cca", "url": "https://github.com/Netflix/titus-control-plane/commit/be33123e1d257227fbbec51bfe91ed9e107f9cca", "message": "Upgrade plugin", "committedDate": "2021-03-16T21:02:58Z", "type": "commit"}, {"oid": "dfd6098625636272f42562d6cbfab6e0f9f06da7", "url": "https://github.com/Netflix/titus-control-plane/commit/dfd6098625636272f42562d6cbfab6e0f9f06da7", "message": "host override", "committedDate": "2021-03-16T21:17:29Z", "type": "commit"}, {"oid": "61969d7f6e51806cfe0cc1b3b01869d0dacdfcec", "url": "https://github.com/Netflix/titus-control-plane/commit/61969d7f6e51806cfe0cc1b3b01869d0dacdfcec", "message": "revolut 0.3.6", "committedDate": "2021-03-16T21:18:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjQ0MzY1MQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/849#discussion_r596443651", "bodyText": "There are more parameters to be configured, like interval, executor, etc.", "author": "tbak", "createdAt": "2021-03-17T23:09:54Z", "path": "titus-supplementary-component/job-activity-history/src/main/java/com/netflix/titus/supplementary/jobactivity/JobActivityWorker.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package com.netflix.titus.supplementary.jobactivity;\n+\n+import java.time.Duration;\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.titus.common.framework.scheduler.ScheduleReference;\n+import com.netflix.titus.common.framework.scheduler.model.ScheduleDescriptor;\n+import com.netflix.titus.common.runtime.TitusRuntime;\n+import com.netflix.titus.common.util.Evaluators;\n+import com.netflix.titus.common.util.ExecutorsExt;\n+import com.netflix.titus.common.util.guice.annotation.Activator;\n+import com.netflix.titus.common.util.guice.annotation.Deactivator;\n+import com.netflix.titus.common.util.time.Clock;\n+import com.netflix.titus.supplementary.jobactivity.store.JobActivityStore;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Singleton\n+public class JobActivityWorker {\n+    private ScheduleReference schedulerRef;\n+    private final Clock clock;\n+    private final TitusRuntime titusRuntime;\n+    private JobActivityStore jobActivityStore;\n+\n+    private static final Logger logger = LoggerFactory.getLogger(JobActivityWorker.class);\n+\n+    @Inject\n+    public JobActivityWorker(TitusRuntime titusRuntime,\n+                             JobActivityStore jobActivityStore) {\n+        this.clock = titusRuntime.getClock();\n+        this.titusRuntime = titusRuntime;\n+        this.jobActivityStore = jobActivityStore;\n+\n+        Registry registry = titusRuntime.getRegistry();\n+    }\n+\n+    @Activator\n+    public void enterActiveMode() {\n+        ScheduleDescriptor scheduleDescriptor = ScheduleDescriptor.newBuilder()", "originalCommit": "6d051e24784f43d547deca5ba01c87ed93f4c9d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjQ0NDI2Ng==", "url": "https://github.com/Netflix/titus-control-plane/pull/849#discussion_r596444266", "bodyText": "This is not needed anymore. You can use Archaius2Ext.newConfiguration to create Archaius style proxy to Spring config.", "author": "tbak", "createdAt": "2021-03-17T23:11:33Z", "path": "titus-supplementary-component/job-activity-history/src/main/java/com/netflix/titus/supplementary/jobactivity/store/JooqConfigurationBean.java", "diffHunk": "@@ -14,36 +14,34 @@\n  * limitations under the License.\n  */\n \n-package com.netflix.titus.ext.jooqflyway.jobactivity;\n-\n-import javax.inject.Inject;\n+package com.netflix.titus.supplementary.jobactivity.store;\n \n import com.netflix.archaius.api.annotations.Configuration;\n import com.netflix.titus.common.util.SpringConfigurationUtil;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.core.env.Environment;\n \n-@Configuration(prefix = \"titus.ext.jooqflyway\")\n-public class JooqConfiguration {\n+@Configuration(prefix = \"titus.ext.supplementary.jobactivity\")\n+public class JooqConfigurationBean implements JooqConfiguration {", "originalCommit": "6d051e24784f43d547deca5ba01c87ed93f4c9d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjQ0NDQ1OA==", "url": "https://github.com/Netflix/titus-control-plane/pull/849#discussion_r596444458", "bodyText": "logger?", "author": "tbak", "createdAt": "2021-03-17T23:12:05Z", "path": "titus-supplementary-component/job-activity-history/src/main/java/com/netflix/titus/supplementary/jobactivity/store/JooqJobActivityContextComponent.java", "diffHunk": "@@ -44,67 +41,73 @@ public SQLDialect dialect() {\n     }\n \n     @Bean\n-    public EmbeddedPostgresService getEmbeddedPostgresService(JooqConfiguration configuration) {\n-        return new EmbeddedPostgresService(configuration);\n+    public EmbeddedPostgresService getEmbeddedPostgresService(JooqConfigurationBean jooqConfiguration) {\n+        return new EmbeddedPostgresService(jooqConfiguration);\n     }\n \n     @Bean\n     @Primary\n-    public JooqContext getJooqContext(JooqConfiguration jooqConfiguration, EmbeddedPostgresService embeddedPostgresService) {\n+    @Qualifier(\"jobActivityJooqContext\")\n+    public JooqContext getJobActivityJooqContext(JooqConfigurationBean jooqConfiguration, EmbeddedPostgresService embeddedPostgresService) {\n         HikariConfig hikariConfig = new HikariConfig();\n+        System.out.println(\"CONSUMER\");\n \n         hikariConfig.setAutoCommit(true);\n \n         // Connection management\n         hikariConfig.setConnectionTimeout(10000);\n         hikariConfig.setMaximumPoolSize(10);\n         hikariConfig.setLeakDetectionThreshold(3000);\n-\n         if (jooqConfiguration.isInMemoryDb()) {\n             hikariConfig.setDataSource(embeddedPostgresService.getDataSource());\n+        } else if (jooqConfiguration.isLocalDb()) {\n+            hikariConfig.setJdbcUrl(\"jdbc:postgresql://localhost:5432/postgres\");\n         } else {\n             hikariConfig.addDataSourceProperty(PGProperty.SSL.getName(), \"true\");\n             hikariConfig.addDataSourceProperty(PGProperty.SSL_MODE.getName(), \"verify-ca\");\n             hikariConfig.addDataSourceProperty(PGProperty.SSL_FACTORY.getName(), RDSSSLSocketFactory.class.getName());\n             hikariConfig.setJdbcUrl(jooqConfiguration.getDatabaseUrl());\n         }\n-\n         return new JooqContext(jooqConfiguration, new HikariDataSource(hikariConfig), embeddedPostgresService);\n     }\n \n     @Bean\n-    public JooqContext getJooqProducerContext(JooqConfiguration jooqConfiguration, EmbeddedPostgresService embeddedPostgresService) {\n+    @Qualifier(\"producerJooqContext\")\n+    public JooqContext getJooqProducerContext(JooqConfigurationBean jooqConfiguration, EmbeddedPostgresService embeddedPostgresService) {\n         HikariConfig hikariConfig = new HikariConfig();\n-\n         hikariConfig.setAutoCommit(true);\n+        System.err.println(\"PRODUCER\");\n \n         // Connection management\n         hikariConfig.setConnectionTimeout(10000);\n         hikariConfig.setMaximumPoolSize(10);\n         hikariConfig.setLeakDetectionThreshold(3000);\n \n         if (jooqConfiguration.isInMemoryDb()) {\n+            System.out.println(\"IN memory\");", "originalCommit": "6d051e24784f43d547deca5ba01c87ed93f4c9d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjQ0NDc3NQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/849#discussion_r596444775", "bodyText": "logger?", "author": "tbak", "createdAt": "2021-03-17T23:12:56Z", "path": "titus-supplementary-component/job-activity-history/src/main/java/com/netflix/titus/supplementary/jobactivity/store/JooqJobActivityStore.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Copyright 2019 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.supplementary.jobactivity.store;\n+\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.util.List;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.netflix.titus.api.jobactivity.store.JobActivityPublisherRecord;\n+import com.netflix.titus.api.jobactivity.store.JobActivityStoreException;\n+import com.netflix.titus.api.jobmanager.model.job.Job;\n+import com.netflix.titus.api.jobmanager.model.job.Task;\n+import com.netflix.titus.common.framework.scheduler.ScheduleReference;\n+import com.netflix.titus.common.runtime.TitusRuntime;\n+import com.netflix.titus.common.util.spectator.DatabaseMetrics;\n+import com.netflix.titus.common.util.time.Clock;\n+import com.netflix.titus.runtime.jobactivity.JobActivityPublisherRecordUtils;\n+import org.flywaydb.core.Flyway;\n+import org.jooq.DSLContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import reactor.core.publisher.Mono;\n+\n+import static com.netflix.titus.supplementary.jobactivity.activity.tables.ActivityQueue.ACTIVITY_QUEUE;\n+import static com.netflix.titus.supplementary.jobactivity.jobactivity.Jobactivity.JOBACTIVITY;\n+\n+\n+@Singleton\n+public class JooqJobActivityStore implements JobActivityStore {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(JobActivityStore.class);\n+    private final JooqContext jobActivityJooqContext;\n+    private final JooqContext producerJooqContext;\n+    private final TitusRuntime titusRuntime;\n+    private ScheduleReference schedulerRef;\n+    private final Clock clock;\n+\n+    private final DSLContext jobActivityDSLContext;\n+    private final DSLContext producerDSLContext;\n+    private final DatabaseMetrics producerDatabaseMetrics;\n+    private final DatabaseMetrics jobActivityDatabaseMetrics;\n+\n+    @Inject\n+    public JooqJobActivityStore(TitusRuntime titusRuntime,\n+                                JooqContext jobActivityJooqContext,\n+                                JooqContext producerJooqContext) {\n+        this(titusRuntime, jobActivityJooqContext, producerJooqContext, true);\n+    }\n+\n+    @VisibleForTesting\n+    public JooqJobActivityStore(TitusRuntime titusRuntime,\n+                                JooqContext jobActivityJooqContext,\n+                                JooqContext producerJooqContext,\n+                                boolean createIfNotExists) {\n+        this.jobActivityJooqContext = jobActivityJooqContext;\n+        this.producerJooqContext = producerJooqContext;\n+        this.titusRuntime = titusRuntime;\n+        this.clock = titusRuntime.getClock();\n+        this.jobActivityDSLContext = jobActivityJooqContext.getDslContext();\n+        this.producerDSLContext = producerJooqContext.getDslContext();\n+        this.producerDatabaseMetrics = new DatabaseMetrics(titusRuntime.getRegistry(), \"titus\", \"JobActivityPublisher\");\n+        this.jobActivityDatabaseMetrics = new DatabaseMetrics(titusRuntime.getRegistry(), \"titus\", \"JobActivityHistory\");\n+\n+        initializeSchema(createIfNotExists);\n+    }\n+\n+    public void initializeSchema(boolean createIfNotExists) {\n+        if (createIfNotExists) {\n+            logger.info(\"Creating/migrating JooqJobStore DB schema...\");\n+            Flyway flyway = Flyway.configure().dataSource(jobActivityJooqContext.getDataSource()).load();\n+            flyway.migrate();\n+        }\n+    }\n+\n+    @Override\n+    public Mono<Void> processRecords() {\n+        return readRecordFromPublisherQueue()\n+                .flatMap(this::writeRecord)\n+                .flatMap(this::deleteRecordFromPublisher);\n+    }\n+\n+    public Mono<JobActivityPublisherRecord> readRecordFromPublisherQueue() {\n+        return JooqUtils.executeAsyncMono(() -> {\n+            long startTimeMs = System.currentTimeMillis();\n+            List<JobActivityPublisherRecord> records = producerDSLContext\n+                    .selectFrom(ACTIVITY_QUEUE)\n+                    .orderBy(ACTIVITY_QUEUE.QUEUE_INDEX.asc())\n+                    .limit(1)\n+                    .fetchInto(JobActivityPublisherRecord.class);\n+            if(records.size() != 0) {\n+                System.out.println(records.get(0).getRecordType());", "originalCommit": "6d051e24784f43d547deca5ba01c87ed93f4c9d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzA0NDQ1Mg==", "url": "https://github.com/Netflix/titus-control-plane/pull/849#discussion_r597044452", "bodyText": "oops looks like I missed these", "author": "amitaekbote", "createdAt": "2021-03-18T16:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjQ0NDc3NQ=="}], "type": "inlineReview"}, {"oid": "57e3956fc59b6c38c6bab84ffbd509fa15006520", "url": "https://github.com/Netflix/titus-control-plane/commit/57e3956fc59b6c38c6bab84ffbd509fa15006520", "message": "remove loggrs", "committedDate": "2021-03-18T17:24:40Z", "type": "commit"}, {"oid": "57e3956fc59b6c38c6bab84ffbd509fa15006520", "url": "https://github.com/Netflix/titus-control-plane/commit/57e3956fc59b6c38c6bab84ffbd509fa15006520", "message": "remove loggrs", "committedDate": "2021-03-18T17:24:40Z", "type": "forcePushed"}, {"oid": "985aa7a3275665b96c81807b3a09ab34ea2af31f", "url": "https://github.com/Netflix/titus-control-plane/commit/985aa7a3275665b96c81807b3a09ab34ea2af31f", "message": "use postgres image", "committedDate": "2021-03-25T04:28:19Z", "type": "commit"}, {"oid": "985aa7a3275665b96c81807b3a09ab34ea2af31f", "url": "https://github.com/Netflix/titus-control-plane/commit/985aa7a3275665b96c81807b3a09ab34ea2af31f", "message": "use postgres image", "committedDate": "2021-03-25T04:28:19Z", "type": "forcePushed"}, {"oid": "d7b3e36ff49d2d31250dbd7a817fe5b1052204bc", "url": "https://github.com/Netflix/titus-control-plane/commit/d7b3e36ff49d2d31250dbd7a817fe5b1052204bc", "message": "more options", "committedDate": "2021-03-25T04:40:37Z", "type": "commit"}, {"oid": "a06d9ea60ad42e7cf18e5606508bb9e47da0fd1a", "url": "https://github.com/Netflix/titus-control-plane/commit/a06d9ea60ad42e7cf18e5606508bb9e47da0fd1a", "message": "remote docker", "committedDate": "2021-03-25T04:46:10Z", "type": "commit"}, {"oid": "51d3bb514f6ca510cb8273df795d1c45e5a524d1", "url": "https://github.com/Netflix/titus-control-plane/commit/51d3bb514f6ca510cb8273df795d1c45e5a524d1", "message": "remote docker", "committedDate": "2021-03-25T04:52:06Z", "type": "commit"}, {"oid": "fd66e4de3930ae0c63bf7c4e251e930a5654da00", "url": "https://github.com/Netflix/titus-control-plane/commit/fd66e4de3930ae0c63bf7c4e251e930a5654da00", "message": "Remove auth", "committedDate": "2021-04-07T23:01:02Z", "type": "commit"}, {"oid": "b204df2ced7a845cd94cb2ae0a25fe2c011e0d47", "url": "https://github.com/Netflix/titus-control-plane/commit/b204df2ced7a845cd94cb2ae0a25fe2c011e0d47", "message": "Wrong environment variable", "committedDate": "2021-04-07T23:40:45Z", "type": "commit"}, {"oid": "d1f2a1b7fc95e462d833e8d40d0ffc5b7d86462c", "url": "https://github.com/Netflix/titus-control-plane/commit/d1f2a1b7fc95e462d833e8d40d0ffc5b7d86462c", "message": "Remove alpine", "committedDate": "2021-04-07T23:45:03Z", "type": "commit"}, {"oid": "849c23a95229907d745fadbcc7f2fad55cbbf420", "url": "https://github.com/Netflix/titus-control-plane/commit/849c23a95229907d745fadbcc7f2fad55cbbf420", "message": "remove local host override", "committedDate": "2021-04-07T23:52:49Z", "type": "commit"}, {"oid": "fb8efd6f829e0bcc99a9ea54490d9fbdf71b76da", "url": "https://github.com/Netflix/titus-control-plane/commit/fb8efd6f829e0bcc99a9ea54490d9fbdf71b76da", "message": "add port", "committedDate": "2021-04-07T23:55:21Z", "type": "commit"}, {"oid": "4475bea38333e9f49edafbb397f2ad94965f5e79", "url": "https://github.com/Netflix/titus-control-plane/commit/4475bea38333e9f49edafbb397f2ad94965f5e79", "message": "circleci", "committedDate": "2021-04-13T03:30:26Z", "type": "commit"}, {"oid": "b496ccc493213de3a26b8a7a9ab66b341cdc97a4", "url": "https://github.com/Netflix/titus-control-plane/commit/b496ccc493213de3a26b8a7a9ab66b341cdc97a4", "message": "using embedded", "committedDate": "2021-04-13T18:28:56Z", "type": "commit"}, {"oid": "212131481b59b179388a4456557ac7730a4d959d", "url": "https://github.com/Netflix/titus-control-plane/commit/212131481b59b179388a4456557ac7730a4d959d", "message": "Move everything to embedded", "committedDate": "2021-04-13T19:02:24Z", "type": "commit"}, {"oid": "b6437c4dba10ae6ecf5a8204fb226d0d7995ce64", "url": "https://github.com/Netflix/titus-control-plane/commit/b6437c4dba10ae6ecf5a8204fb226d0d7995ce64", "message": "Moving back to titus-ext", "committedDate": "2021-04-14T02:46:17Z", "type": "commit"}, {"oid": "5ea0c90ad1a9b23f28bf5bf3f9568f55b3038dca", "url": "https://github.com/Netflix/titus-control-plane/commit/5ea0c90ad1a9b23f28bf5bf3f9568f55b3038dca", "message": "Cleaning up", "committedDate": "2021-04-14T02:58:01Z", "type": "commit"}, {"oid": "5ea0c90ad1a9b23f28bf5bf3f9568f55b3038dca", "url": "https://github.com/Netflix/titus-control-plane/commit/5ea0c90ad1a9b23f28bf5bf3f9568f55b3038dca", "message": "Cleaning up", "committedDate": "2021-04-14T02:58:01Z", "type": "forcePushed"}, {"oid": "ab370d51492907250f6cb09ceb438d21699e40b6", "url": "https://github.com/Netflix/titus-control-plane/commit/ab370d51492907250f6cb09ceb438d21699e40b6", "message": "disable local by default", "committedDate": "2021-04-14T03:07:00Z", "type": "commit"}, {"oid": "66c26fbceb02bb48d1051992bfc85717e9c964d9", "url": "https://github.com/Netflix/titus-control-plane/commit/66c26fbceb02bb48d1051992bfc85717e9c964d9", "message": "Testing with inmemory set to true", "committedDate": "2021-04-14T03:17:42Z", "type": "commit"}]}