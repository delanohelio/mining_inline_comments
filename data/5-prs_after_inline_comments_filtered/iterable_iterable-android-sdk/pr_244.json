{"pr_number": 244, "pr_title": "[MOB-1788] Clear in-app messages on logout", "pr_createdAt": "2020-07-02T06:27:20Z", "pr_url": "https://github.com/Iterable/iterable-android-sdk/pull/244", "timeline": [{"oid": "d275915c51379fd0ee0e3d3c081f087cbb67d336", "url": "https://github.com/Iterable/iterable-android-sdk/commit/d275915c51379fd0ee0e3d3c081f087cbb67d336", "message": "Clear in-app messages on logout", "committedDate": "2020-07-02T06:30:57Z", "type": "forcePushed"}, {"oid": "fb02c1699670800de502e3eccdde6149be7ea840", "url": "https://github.com/Iterable/iterable-android-sdk/commit/fb02c1699670800de502e3eccdde6149be7ea840", "message": "Clear in-app messages on logout", "committedDate": "2020-07-02T06:40:20Z", "type": "commit"}, {"oid": "fb02c1699670800de502e3eccdde6149be7ea840", "url": "https://github.com/Iterable/iterable-android-sdk/commit/fb02c1699670800de502e3eccdde6149be7ea840", "message": "Clear in-app messages on logout", "committedDate": "2020-07-02T06:40:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI5NDk4Nw==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/244#discussion_r449294987", "bodyText": "Even after login if we haven't initialized, shouldn\u2019t we attempt to initialize??", "author": "Ayyanchira", "createdAt": "2020-07-02T22:35:45Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java", "diffHunk": "@@ -1328,13 +1328,22 @@ private void retrieveEmailAndUserId() {\n     }\n \n     private void onLogOut() {\n-        if (config.autoPushRegistration && isInitialized()) {\n+        if (!isInitialized()) {\n+            return;\n+        }\n+\n+        if (config.autoPushRegistration) {\n             disablePush();\n         }\n+        getInAppManager().reset();\n     }\n \n     private void onLogIn() {\n-        if (config.autoPushRegistration && isInitialized()) {\n+        if (!isInitialized()) {\n+            return;", "originalCommit": "fb02c1699670800de502e3eccdde6149be7ea840", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM1MjIzNQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/244#discussion_r450352235", "bodyText": "Here is the code for isInitialized():\n    private boolean isInitialized() {\n        return _apiKey != null && (_email != null || _userId != null);\n    }\n\nBasically, if there is no email or userId, there is no user to operate with.", "author": "vbabenkoru", "createdAt": "2020-07-06T16:48:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI5NDk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI5NTYxMQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/244#discussion_r449295611", "bodyText": "Feels like reset name should be for something which is resetting everything...\nMay be more specific name like clearAllMessagesFromLocalStorage()", "author": "Ayyanchira", "createdAt": "2020-07-02T22:37:41Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppManager.java", "diffHunk": "@@ -167,6 +167,20 @@ public void execute(String payload) {\n         });\n     }\n \n+    /**\n+     * Clear all in-app messages.\n+     * Should be called on user logout.\n+     */", "originalCommit": "fb02c1699670800de502e3eccdde6149be7ea840", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM2Mzg3NQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/244#discussion_r450363875", "bodyText": "I'm mirroring the name in iOS for consistency.. Technically it does reset everything in the in-app manager.", "author": "vbabenkoru", "createdAt": "2020-07-06T17:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI5NTYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI5NTkxNA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/244#discussion_r449295914", "bodyText": "\ud83d\udc4d", "author": "Ayyanchira", "createdAt": "2020-07-02T22:39:03Z", "path": "iterableapi/src/test/java/com/iterable/iterableapi/IterableInAppManagerTest.java", "diffHunk": "@@ -150,6 +150,20 @@ public void testSyncInApp() throws Exception {\n         assertEquals(\"Q19mD2NlQUnxnmSGuQu9ujzkKR6c12TogeaGA29\", inAppManager.getMessages().get(0).getMessageId());\n     }\n \n+    @Test\n+    public void testReset() throws Exception {\n+        dispatcher.enqueueResponse(\"/inApp/getMessages\", new MockResponse().setBody(IterableTestUtils.getResourceString(\"inapp_payload_single.json\")));\n+        IterableInAppManager inAppManager = IterableApi.getInstance().getInAppManager();\n+        assertEquals(0, inAppManager.getMessages().size());\n+\n+        inAppManager.syncInApp();\n+        Robolectric.flushBackgroundThreadScheduler();\n+        Robolectric.flushForegroundThreadScheduler();\n+        assertEquals(1, inAppManager.getMessages().size());\n+        inAppManager.reset();\n+        assertEquals(0, inAppManager.getMessages().size());", "originalCommit": "fb02c1699670800de502e3eccdde6149be7ea840", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d372a48bcfc75aea7420f4dee6a3c89fd2f2f7d5", "url": "https://github.com/Iterable/iterable-android-sdk/commit/d372a48bcfc75aea7420f4dee6a3c89fd2f2f7d5", "message": "Reset in-app messages even if there is no user", "committedDate": "2020-07-20T17:34:14Z", "type": "commit"}, {"oid": "d372a48bcfc75aea7420f4dee6a3c89fd2f2f7d5", "url": "https://github.com/Iterable/iterable-android-sdk/commit/d372a48bcfc75aea7420f4dee6a3c89fd2f2f7d5", "message": "Reset in-app messages even if there is no user", "committedDate": "2020-07-20T17:34:14Z", "type": "forcePushed"}]}