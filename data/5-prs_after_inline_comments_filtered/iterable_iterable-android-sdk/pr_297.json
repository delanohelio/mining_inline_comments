{"pr_number": 297, "pr_title": "[MOB-2373] Call request callbacks on task completion", "pr_createdAt": "2020-12-13T03:05:51Z", "pr_url": "https://github.com/Iterable/iterable-android-sdk/pull/297", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk3OTQ0MA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#discussion_r541979440", "bodyText": "Wow!!! I didn't know we have this feature in java!", "author": "Ayyanchira", "createdAt": "2020-12-13T18:35:17Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableTaskRunner.java", "diffHunk": "@@ -67,15 +90,33 @@ private boolean processNextTask() {\n         }\n \n         if (task.taskType == IterableTaskType.API) {\n+            IterableApiResponse response = null;\n+            TaskResult result = TaskResult.FAILURE;\n             try {\n                 IterableApiRequest request = IterableApiRequest.fromJSON(new JSONObject(task.data), null, null);\n-                IterableApiResponse response = IterableRequestTask.executeApiRequest(request);\n+                response = IterableRequestTask.executeApiRequest(request);\n             } catch (Exception e) {\n                 IterableLogger.e(TAG, \"Error while processing request task\", e);\n             }\n+            if (response != null) {\n+                result = response.success ? TaskResult.SUCCESS : TaskResult.FAILURE;", "originalCommit": "1ca497aeae0c6ace9220f66dc024a0250b3d2315", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk3OTU2Mw==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#discussion_r541979563", "bodyText": "reiterating form previous PR, if the delete task should happen here regardless of success or failure.", "author": "Ayyanchira", "createdAt": "2020-12-13T18:36:07Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableTaskRunner.java", "diffHunk": "@@ -67,15 +90,33 @@ private boolean processNextTask() {\n         }\n \n         if (task.taskType == IterableTaskType.API) {\n+            IterableApiResponse response = null;\n+            TaskResult result = TaskResult.FAILURE;\n             try {\n                 IterableApiRequest request = IterableApiRequest.fromJSON(new JSONObject(task.data), null, null);\n-                IterableApiResponse response = IterableRequestTask.executeApiRequest(request);\n+                response = IterableRequestTask.executeApiRequest(request);\n             } catch (Exception e) {\n                 IterableLogger.e(TAG, \"Error while processing request task\", e);\n             }\n+            if (response != null) {\n+                result = response.success ? TaskResult.SUCCESS : TaskResult.FAILURE;\n+            }\n+            callTaskCompletedListeners(task.id, result, response);\n             taskStorage.deleteTask(task.id);\n             return true;\n         }\n         return false;\n     }\n+\n+    @WorkerThread\n+    private void callTaskCompletedListeners(final String taskId, final TaskResult result, final IterableApiResponse response) {\n+        for (final TaskCompletedListener listener : taskCompletedListeners) {\n+            new Handler(Looper.getMainLooper()).post(new Runnable() {\n+                @Override\n+                public void run() {\n+                    listener.onTaskCompleted(taskId, result, response);", "originalCommit": "1ca497aeae0c6ace9220f66dc024a0250b3d2315", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA0NTA1Ng==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#discussion_r543045056", "bodyText": "Responded in the previous PR.", "author": "vbabenkoru", "createdAt": "2020-12-15T04:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk3OTU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk3OTczOA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#discussion_r541979738", "bodyText": "or should the delete task happen here? \ud83e\udd37\u200d\u2642\ufe0f", "author": "Ayyanchira", "createdAt": "2020-12-13T18:37:07Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/OfflineRequestProcessor.java", "diffHunk": "@@ -59,4 +63,18 @@ void scheduleTask(IterableApiRequest request, @Nullable IterableHelper.SuccessHa\n         successCallbackMap.put(taskId, onSuccess);\n         failureCallbackMap.put(taskId, onFailure);\n     }\n+\n+    @MainThread\n+    @Override\n+    public void onTaskCompleted(String taskId, IterableTaskRunner.TaskResult result, IterableApiResponse response) {\n+        IterableHelper.SuccessHandler onSuccess = successCallbackMap.get(taskId);\n+        IterableHelper.FailureHandler onFailure = failureCallbackMap.get(taskId);\n+        successCallbackMap.remove(taskId);\n+        failureCallbackMap.remove(taskId);", "originalCommit": "1ca497aeae0c6ace9220f66dc024a0250b3d2315", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c246feb17653ee82c0ecc2499b49086067637bbd", "url": "https://github.com/Iterable/iterable-android-sdk/commit/c246feb17653ee82c0ecc2499b49086067637bbd", "message": "Call request callbacks on task completion", "committedDate": "2020-12-15T04:51:41Z", "type": "forcePushed"}, {"oid": "e1430f8ecd19cba9f62491971e72f71917018721", "url": "https://github.com/Iterable/iterable-android-sdk/commit/e1430f8ecd19cba9f62491971e72f71917018721", "message": "Call request callbacks on task completion", "committedDate": "2020-12-15T04:55:33Z", "type": "forcePushed"}, {"oid": "3e61e7f50e3d671ade373a9cfc2dcb0e8227df48", "url": "https://github.com/Iterable/iterable-android-sdk/commit/3e61e7f50e3d671ade373a9cfc2dcb0e8227df48", "message": "Call request callbacks on task completion", "committedDate": "2020-12-15T05:48:32Z", "type": "forcePushed"}, {"oid": "28419e1a6bd4b2395e3bc5a52019e0324cf9229c", "url": "https://github.com/Iterable/iterable-android-sdk/commit/28419e1a6bd4b2395e3bc5a52019e0324cf9229c", "message": "Call request callbacks on task completion", "committedDate": "2020-12-15T06:30:14Z", "type": "commit"}, {"oid": "bd14af5103816e82b14063b1562a559e4bdd619b", "url": "https://github.com/Iterable/iterable-android-sdk/commit/bd14af5103816e82b14063b1562a559e4bdd619b", "message": "Add tests for callbacks", "committedDate": "2020-12-15T06:30:34Z", "type": "commit"}, {"oid": "bd14af5103816e82b14063b1562a559e4bdd619b", "url": "https://github.com/Iterable/iterable-android-sdk/commit/bd14af5103816e82b14063b1562a559e4bdd619b", "message": "Add tests for callbacks", "committedDate": "2020-12-15T06:30:34Z", "type": "forcePushed"}]}