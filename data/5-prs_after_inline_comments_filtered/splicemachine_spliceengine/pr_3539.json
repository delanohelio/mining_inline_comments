{"pr_number": 3539, "pr_title": "DB-9388 write complete update row when updating the sys.sysstatements\u2026", "pr_createdAt": "2020-05-05T21:19:29Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3539", "timeline": [{"oid": "d17e53e6571790f7317a99f687c5bd5a109ac94d", "url": "https://github.com/splicemachine/spliceengine/commit/d17e53e6571790f7317a99f687c5bd5a109ac94d", "message": "DB-9388 write complete update row when updating the sys.sysstatements table", "committedDate": "2020-05-05T21:10:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5MzMxOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3539#discussion_r420793319", "bodyText": "why is columnToUpdateSet.set(i); done in if and in else?\nshouldn't it rather be\n       for(int i=0;i<SYSSTATEMENTSRowFactory.SYSSTATEMENTS_COLUMN_COUNT;i++){\n            if (i+1 != SYSSTATEMENTSRowFactory.SYSSTATEMENTS_CONSTANTSTATE) {\n                columnToReadSet.set(i);\n            }\n            columnToUpdateSet.set(i);\n        }", "author": "martinrupp", "createdAt": "2020-05-06T13:33:36Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/catalog/DataDictionaryImpl.java", "diffHunk": "@@ -3471,20 +3471,21 @@ public void clearSPSPlans() throws StandardException{\n \n         FormatableBitSet columnToReadSet=new FormatableBitSet(SYSSTATEMENTSRowFactory.SYSSTATEMENTS_COLUMN_COUNT);\n         FormatableBitSet columnToUpdateSet=new FormatableBitSet(SYSSTATEMENTSRowFactory.SYSSTATEMENTS_COLUMN_COUNT);\n-        columnToUpdateSet.set(SYSSTATEMENTSRowFactory.SYSSTATEMENTS_VALID-1);\n-        columnToUpdateSet.set(SYSSTATEMENTSRowFactory.SYSSTATEMENTS_CONSTANTSTATE-1);\n-\n+        for(int i=0;i<SYSSTATEMENTSRowFactory.SYSSTATEMENTS_COLUMN_COUNT;i++){\n+            if (i+1==SYSSTATEMENTSRowFactory.SYSSTATEMENTS_CONSTANTSTATE) {\n+                columnToUpdateSet.set(i);", "originalCommit": "d17e53e6571790f7317a99f687c5bd5a109ac94d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkyMTIxOA==", "url": "https://github.com/splicemachine/spliceengine/pull/3539#discussion_r420921218", "bodyText": "Done!", "author": "yxia92", "createdAt": "2020-05-06T16:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5MzMxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5NDQzMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3539#discussion_r420794431", "bodyText": "rest of file uses style i+1 == SYSSTATEMENTSRowFactory.SYSSTATEMENTS_CONSTANTSTATE, i think we should stick to one style (same line 3507)", "author": "martinrupp", "createdAt": "2020-05-06T13:35:09Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/catalog/DataDictionaryImpl.java", "diffHunk": "@@ -3502,6 +3503,14 @@ public void clearSPSPlans() throws StandardException{\n \n         while(sc.fetchNext(rowTemplate)){\n             /* Replace the column in the table */\n+            for (int i=0; i<rowTemplate.length; i++) {\n+                if (i  == SYSSTATEMENTSRowFactory.SYSSTATEMENTS_VALID-1)\n+                    replaceRow[i] = new SQLBoolean(false);\n+                else if (i == SYSSTATEMENTSRowFactory.SYSSTATEMENTS_CONSTANTSTATE-1)", "originalCommit": "d17e53e6571790f7317a99f687c5bd5a109ac94d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkyMTExMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3539#discussion_r420921111", "bodyText": "I made the change to make the style consistent. Thanks!", "author": "yxia92", "createdAt": "2020-05-06T16:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5NDQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5NTUyOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3539#discussion_r420795529", "bodyText": "i'm new, how is this related to the change in sys.sysstatements ?", "author": "martinrupp", "createdAt": "2020-05-06T13:36:32Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -96,7 +96,7 @@ public void run() throws StandardException{\n         NavigableSet<Splice_DD_Version> keys=scripts.navigableKeySet();\n         for(Splice_DD_Version version : keys){\n             if(currentVersion!=null){\n-                if(ddComparator.compare(version,currentVersion)<0){\n+                if(ddComparator.compare(version,currentVersion)<=0){", "originalCommit": "d17e53e6571790f7317a99f687c5bd5a109ac94d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwNzczMA==", "url": "https://github.com/splicemachine/spliceengine/pull/3539#discussion_r420907730", "bodyText": "@martinrupp You are right, this change is not related to the update for the sys.sysstatements table. It is a fix for a minor issue with our upgrade process in general.\nEach upgrade script is associated with a version (let's call it S) which is usually the database version this script is introduced.\nIn principal, if the currently installed database version (let's call it C) is already equal or above the version S, we don't need to call this upgrade script as the change should have already been applied.\nBefore the fix, the upgrade script is still possible to be executed when C is the same as S.", "author": "yxia92", "createdAt": "2020-05-06T16:01:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5NTUyOQ=="}], "type": "inlineReview"}, {"oid": "319c1f82ca74ad123d88c970b27ae7ba87a85868", "url": "https://github.com/splicemachine/spliceengine/commit/319c1f82ca74ad123d88c970b27ae7ba87a85868", "message": "DB-9388 address review comments", "committedDate": "2020-05-06T16:15:05Z", "type": "commit"}]}