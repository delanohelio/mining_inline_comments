{"pr_number": 4410, "pr_title": "DB-10587 Resolve timed out transactions properly", "pr_createdAt": "2020-10-28T23:09:20Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4410", "timeline": [{"oid": "43b10e2b1d71e99cf81fb3bb3650bd818345a8f2", "url": "https://github.com/splicemachine/spliceengine/commit/43b10e2b1d71e99cf81fb3bb3650bd818345a8f2", "message": "DB-10587 Resolve timedout transactions properly", "committedDate": "2020-10-28T22:59:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1ODIxNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4410#discussion_r513858216", "bodyText": "This is labelled \"committedWithoutGlobalTS\", but we're not checking if the transaction state is COMMITTED.  Should we add this state check so we don't resolve active transactions?", "author": "msirek", "createdAt": "2020-10-29T01:25:59Z", "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/region/V2TxnDecoder.java", "diffHunk": "@@ -197,9 +200,15 @@ protected long toLong(Cell data){\n         if (taskKv != null) {\n             taskId = decodeTaskId(taskKv);\n         }\n-        return composeValue(destinationTables,level,txnId,beginTs,parentTxnId,hasAdditive,\n-                isAdditive,commitTs,globalTs,state,kaTime,rollbackSubIds,taskId);\n+        TxnMessage.Txn txn = composeValue(destinationTables, level, txnId, beginTs, parentTxnId, hasAdditive,\n+                isAdditive, commitTs, globalTs, state, kaTime, rollbackSubIds, taskId);\n+\n+        boolean committedWithoutGlobalTS = txn.getInfo().getParentTxnid() > 0 && txn.getGlobalCommitTs() < 0;", "originalCommit": "43b10e2b1d71e99cf81fb3bb3650bd818345a8f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEyNDkzMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4410#discussion_r514124931", "bodyText": "Good catch @msirek ! It's even worse than that, because we could resolve RolledBack subtransactions and end up in a similar situation to what this was trying to solve. I also added a test. Thanks!", "author": "dgomezferro", "createdAt": "2020-10-29T09:40:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1ODIxNg=="}], "type": "inlineReview"}, {"oid": "5886eccd3ad1a1073645c4ef4ed140d40cf91854", "url": "https://github.com/splicemachine/spliceengine/commit/5886eccd3ad1a1073645c4ef4ed140d40cf91854", "message": "DB-10587 Address review, add test", "committedDate": "2020-10-29T09:36:00Z", "type": "commit"}]}