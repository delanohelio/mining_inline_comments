{"pr_number": 3662, "pr_title": "DB-9552: fix JarLoader", "pr_createdAt": "2020-06-05T21:52:36Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3662", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5ODk1OA==", "url": "https://github.com/splicemachine/spliceengine/pull/3662#discussion_r443498958", "bodyText": "If running in a NLJ, union operation or other contexts they could be running in a different thread, we need a different way to identify RS vs Olap/Spark", "author": "dgomezferro", "createdAt": "2020-06-22T11:41:59Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/services/reflect/UpdateLoader.java", "diffHunk": "@@ -211,6 +205,7 @@ public Object run(){\n \tClass loadClass(String className, boolean resolve) \n \t\tthrows ClassNotFoundException {\n \n+\t\tboolean isRS = Thread.currentThread().getName().contains(\"DRDAConnThread\");", "originalCommit": "7cffa073fd8eeea47da5e1f0b49c987f7e945f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NDg2Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/3662#discussion_r443664867", "bodyText": "Is it possible nested loop join or union operation may try loading jars?", "author": "jyuanca", "createdAt": "2020-06-22T15:59:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5ODk1OA=="}], "type": "inlineReview"}, {"oid": "af36d34c1d168f668834b5018be4fab3b8b4b20e", "url": "https://github.com/splicemachine/spliceengine/commit/af36d34c1d168f668834b5018be4fab3b8b4b20e", "message": "whether jar loader is on spark or hbase", "committedDate": "2020-07-02T03:58:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ0NzYxNA==", "url": "https://github.com/splicemachine/spliceengine/pull/3662#discussion_r449447614", "bodyText": "I don't think this should be a ThreadLocal, are we setting this property for every Thread that could access this field? If  a NLJ runs in a different thread that might not have executed bootDatabase() it will think it's not in a regionServer. This should be either a static volatile boolean / static AtomicBoolean or we'd need a different mechanism.", "author": "dgomezferro", "createdAt": "2020-07-03T08:22:18Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/jdbc/EmbedConnection.java", "diffHunk": "@@ -112,7 +112,9 @@\n      */\n     public static final SQLException NO_MEM =\n         Util.generateCsSQLException(SQLState.LOGIN_FAILED, \"java.lang.OutOfMemoryError\");\n-    \n+\n+\tpublic static final ThreadLocal<Boolean> isHBaseJVM = new ThreadLocal<>();", "originalCommit": "af36d34c1d168f668834b5018be4fab3b8b4b20e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyOTcyMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3662#discussion_r449729721", "bodyText": "This field is only set and used during updateLoader initialization, and set a flag for the singleton UpdaterLoader whether it is running on a HBase. If any thread needs to load jar, it should use the shared singleton UpdateLoader instance, which always know where it is running. No thread needs to access the ThreadLocal variable and decide whether it is running on HBase", "author": "jyuanca", "createdAt": "2020-07-04T02:09:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ0NzYxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc4OTIwNg==", "url": "https://github.com/splicemachine/spliceengine/pull/3662#discussion_r452789206", "bodyText": "I see, thanks @jyuanca !", "author": "dgomezferro", "createdAt": "2020-07-10T11:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ0NzYxNA=="}], "type": "inlineReview"}, {"oid": "d5d3e7ed05e2017137b51b7944589eac24212c65", "url": "https://github.com/splicemachine/spliceengine/commit/d5d3e7ed05e2017137b51b7944589eac24212c65", "message": "address review comments", "committedDate": "2020-07-08T04:31:29Z", "type": "forcePushed"}, {"oid": "5ffa83febd8fadefab0aeb5fa97cfde84d8601ba", "url": "https://github.com/splicemachine/spliceengine/commit/5ffa83febd8fadefab0aeb5fa97cfde84d8601ba", "message": "DB-9552: fix JarLoader", "committedDate": "2020-07-14T18:08:13Z", "type": "forcePushed"}, {"oid": "414ef9324aed89e453c405542e29276ccd87d64a", "url": "https://github.com/splicemachine/spliceengine/commit/414ef9324aed89e453c405542e29276ccd87d64a", "message": "DB-9552: fix JarLoader", "committedDate": "2020-07-22T15:58:30Z", "type": "commit"}, {"oid": "414ef9324aed89e453c405542e29276ccd87d64a", "url": "https://github.com/splicemachine/spliceengine/commit/414ef9324aed89e453c405542e29276ccd87d64a", "message": "DB-9552: fix JarLoader", "committedDate": "2020-07-22T15:58:30Z", "type": "forcePushed"}]}