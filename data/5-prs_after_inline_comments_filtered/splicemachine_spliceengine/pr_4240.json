{"pr_number": 4240, "pr_title": "DB-10222 Support CREATE/DROP database", "pr_createdAt": "2020-10-07T14:56:28Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4240", "timeline": [{"oid": "abcedeadf685b103279d8825531f3755c88b1fed", "url": "https://github.com/splicemachine/spliceengine/commit/abcedeadf685b103279d8825531f3755c88b1fed", "message": "DB-10194 Multidatabase first commit", "committedDate": "2020-09-07T13:21:46Z", "type": "commit"}, {"oid": "12ec3394e5f2a9f304a861b887d80bbd8851c480", "url": "https://github.com/splicemachine/spliceengine/commit/12ec3394e5f2a9f304a861b887d80bbd8851c480", "message": "DB-10194 Support 'show databases' in sqlshell", "committedDate": "2020-09-07T13:21:58Z", "type": "commit"}, {"oid": "9501b63d987c662b8fa1183ae24f0e84bc8c4351", "url": "https://github.com/splicemachine/spliceengine/commit/9501b63d987c662b8fa1183ae24f0e84bc8c4351", "message": "DB-10194 Create new database with correct uuid. New schemas use that uuid", "committedDate": "2020-09-07T13:22:02Z", "type": "commit"}, {"oid": "9d6262470187844dbb180354b71a4e60b9bb64aa", "url": "https://github.com/splicemachine/spliceengine/commit/9d6262470187844dbb180354b71a4e60b9bb64aa", "message": "DB-10194 Use placeholders in database authorizationId", "committedDate": "2020-09-07T13:22:08Z", "type": "commit"}, {"oid": "2f2ccd4b963bd8c79109c5f524990a3a0119c478", "url": "https://github.com/splicemachine/spliceengine/commit/2f2ccd4b963bd8c79109c5f524990a3a0119c478", "message": "DB-10194 Fix spotbugs", "committedDate": "2020-09-07T17:26:57Z", "type": "commit"}, {"oid": "71fe88feb22ffbeb20c871532504e87e5a757229", "url": "https://github.com/splicemachine/spliceengine/commit/71fe88feb22ffbeb20c871532504e87e5a757229", "message": "DB-10194 Fix more spotbugs", "committedDate": "2020-09-08T08:24:51Z", "type": "commit"}, {"oid": "30aa48bc30f59b27c439b934bf1a377a4258e43c", "url": "https://github.com/splicemachine/spliceengine/commit/30aa48bc30f59b27c439b934bf1a377a4258e43c", "message": "DB-10194 Fix even more spotbugs", "committedDate": "2020-09-08T13:21:36Z", "type": "commit"}, {"oid": "81fd9a1d8ea4d7ee52ae284d5e4e0e4c5499b5e1", "url": "https://github.com/splicemachine/spliceengine/commit/81fd9a1d8ea4d7ee52ae284d5e4e0e4c5499b5e1", "message": "DB-10194 Fix even more spotbugs", "committedDate": "2020-09-08T13:21:36Z", "type": "commit"}, {"oid": "f0c0cfbec18be7569af9a4a4bca611e7679f83e0", "url": "https://github.com/splicemachine/spliceengine/commit/f0c0cfbec18be7569af9a4a4bca611e7679f83e0", "message": "DB-10194 Fix aggressive assert", "committedDate": "2020-09-09T09:40:56Z", "type": "commit"}, {"oid": "27f5ec0472c524f1a99f1f05cd26bbea1062cf92", "url": "https://github.com/splicemachine/spliceengine/commit/27f5ec0472c524f1a99f1f05cd26bbea1062cf92", "message": "DB-10195 Support 2 schemas with the same name in 2 different DBs", "committedDate": "2020-09-09T14:25:23Z", "type": "commit"}, {"oid": "4f985a8b11229fae95275b0e28d7b46b7fba6ce2", "url": "https://github.com/splicemachine/spliceengine/commit/4f985a8b11229fae95275b0e28d7b46b7fba6ce2", "message": "DB-10195 Fix spotbugs", "committedDate": "2020-09-09T15:48:31Z", "type": "commit"}, {"oid": "7d23dc335a08831df0321390090f76c856ad2051", "url": "https://github.com/splicemachine/spliceengine/commit/7d23dc335a08831df0321390090f76c856ad2051", "message": "DB-10195 Fix more spotbugs", "committedDate": "2020-09-09T16:55:58Z", "type": "commit"}, {"oid": "f08773ff21d2fbdf19b0d02f13386c096c2610de", "url": "https://github.com/splicemachine/spliceengine/commit/f08773ff21d2fbdf19b0d02f13386c096c2610de", "message": "DB-10195 Fix error", "committedDate": "2020-09-10T09:43:20Z", "type": "commit"}, {"oid": "f1af91d73a60ed8d90c450558c8914589c9f4dc6", "url": "https://github.com/splicemachine/spliceengine/commit/f1af91d73a60ed8d90c450558c8914589c9f4dc6", "message": "DB-10240 Rework test infra to accept DB parameter in connections", "committedDate": "2020-09-11T10:18:55Z", "type": "commit"}, {"oid": "be2db7f3bf7f57073dad0083151de70943b705be", "url": "https://github.com/splicemachine/spliceengine/commit/be2db7f3bf7f57073dad0083151de70943b705be", "message": "DB-10240 Fix CheckConstraintIT", "committedDate": "2020-09-11T11:52:03Z", "type": "commit"}, {"oid": "d7927e1a666d9a325dac7e27bf03a38953e54fe6", "url": "https://github.com/splicemachine/spliceengine/commit/d7927e1a666d9a325dac7e27bf03a38953e54fe6", "message": "DB-10240 Fix more tests", "committedDate": "2020-09-11T12:33:19Z", "type": "commit"}, {"oid": "5c80da9107e10a00e7b6bc770c6e0f3a2a9bdd41", "url": "https://github.com/splicemachine/spliceengine/commit/5c80da9107e10a00e7b6bc770c6e0f3a2a9bdd41", "message": "DB-10241 Remove old pass", "committedDate": "2020-09-11T12:49:21Z", "type": "commit"}, {"oid": "b49570e90b333971036983c16c737e2f51e7feff", "url": "https://github.com/splicemachine/spliceengine/commit/b49570e90b333971036983c16c737e2f51e7feff", "message": "DB-10240 Fix error with getDefaultLocalURL", "committedDate": "2020-09-14T09:45:52Z", "type": "commit"}, {"oid": "15d8ee8d674ac2e50abbcacf11d51e4f1429b676", "url": "https://github.com/splicemachine/spliceengine/commit/15d8ee8d674ac2e50abbcacf11d51e4f1429b676", "message": "DB-10196 Create new SPLICE schema for new database", "committedDate": "2020-09-14T15:07:02Z", "type": "commit"}, {"oid": "c971712a98b1b18024c6e7b39f28b5f2108d949c", "url": "https://github.com/splicemachine/spliceengine/commit/c971712a98b1b18024c6e7b39f28b5f2108d949c", "message": "Merge remote-tracking branch 'origin/DB-10193' into DB-10195", "committedDate": "2020-09-14T22:21:43Z", "type": "commit"}, {"oid": "ff2e8349e2c2da05b0aa2031fb117111bc3e2524", "url": "https://github.com/splicemachine/spliceengine/commit/ff2e8349e2c2da05b0aa2031fb117111bc3e2524", "message": "Merge remote-tracking branch 'origin/DB-10193' into DB-10195", "committedDate": "2020-09-16T16:26:27Z", "type": "commit"}, {"oid": "225699d860e0c11cd6098bd4974772520cec3796", "url": "https://github.com/splicemachine/spliceengine/commit/225699d860e0c11cd6098bd4974772520cec3796", "message": "Merge branch 'DB-10195' into DB-10196", "committedDate": "2020-09-16T16:33:03Z", "type": "commit"}, {"oid": "9883778ad9ef42aafa8952dcb69553e6194d7c99", "url": "https://github.com/splicemachine/spliceengine/commit/9883778ad9ef42aafa8952dcb69553e6194d7c99", "message": "IBEX-10195 Address review", "committedDate": "2020-09-21T11:36:03Z", "type": "commit"}, {"oid": "41a7505de642f4d559edbb67179ade5fc88d9a4a", "url": "https://github.com/splicemachine/spliceengine/commit/41a7505de642f4d559edbb67179ade5fc88d9a4a", "message": "Merge remote-tracking branch 'origin/DB-10195' into DB-10196", "committedDate": "2020-09-21T11:58:42Z", "type": "commit"}, {"oid": "52bcfd250583d165c5dea586b92acc35caa64b80", "url": "https://github.com/splicemachine/spliceengine/commit/52bcfd250583d165c5dea586b92acc35caa64b80", "message": "DB-10200 Filter SYS tables for each DB in SYSVW", "committedDate": "2020-09-22T11:40:06Z", "type": "commit"}, {"oid": "f7e29bb28b0a781b8b5dfae18c3032a333fd05f7", "url": "https://github.com/splicemachine/spliceengine/commit/f7e29bb28b0a781b8b5dfae18c3032a333fd05f7", "message": "DB-10327 Add dbId to SchemaWatcher", "committedDate": "2020-09-22T16:05:54Z", "type": "commit"}, {"oid": "280db413884381d9d1416764724991e27e047dd1", "url": "https://github.com/splicemachine/spliceengine/commit/280db413884381d9d1416764724991e27e047dd1", "message": "DB-10200 Add ITs for multidatabase", "committedDate": "2020-09-22T16:06:12Z", "type": "commit"}, {"oid": "1de8fa0b193a8d8d9650db8737e030f5cd294bd2", "url": "https://github.com/splicemachine/spliceengine/commit/1de8fa0b193a8d8d9650db8737e030f5cd294bd2", "message": "DB-10327 Fix more ITs", "committedDate": "2020-09-22T16:32:08Z", "type": "commit"}, {"oid": "ed1a629f35a3c79f96e9e95085130f9486eb710f", "url": "https://github.com/splicemachine/spliceengine/commit/ed1a629f35a3c79f96e9e95085130f9486eb710f", "message": "Revert \"DB-10327 Fix more ITs\"\n\nThis reverts commit 1de8fa0b193a8d8d9650db8737e030f5cd294bd2.", "committedDate": "2020-09-23T13:41:19Z", "type": "commit"}, {"oid": "f53b86856d51fa3ad56f2adf3465ad2b92f0b8ac", "url": "https://github.com/splicemachine/spliceengine/commit/f53b86856d51fa3ad56f2adf3465ad2b92f0b8ac", "message": "Revert \"DB-10327 Add dbId to SchemaWatcher\"\n\nThis reverts commit f7e29bb28b0a781b8b5dfae18c3032a333fd05f7.", "committedDate": "2020-09-23T13:41:27Z", "type": "commit"}, {"oid": "82629a4f01b357bf1d8a8da2057c26b4e020b6f3", "url": "https://github.com/splicemachine/spliceengine/commit/82629a4f01b357bf1d8a8da2057c26b4e020b6f3", "message": "DB-10327 Keep original one parameter constructor", "committedDate": "2020-09-23T13:41:41Z", "type": "commit"}, {"oid": "e46427e0356bac5b7067cb3915bc37ae8d4aedf9", "url": "https://github.com/splicemachine/spliceengine/commit/e46427e0356bac5b7067cb3915bc37ae8d4aedf9", "message": "DB-10222 Support CREATE DATABASE", "committedDate": "2020-09-28T16:49:23Z", "type": "commit"}, {"oid": "73533bd28d035d233a79c1e72aae9ff34b11054f", "url": "https://github.com/splicemachine/spliceengine/commit/73533bd28d035d233a79c1e72aae9ff34b11054f", "message": "Merge remote-tracking branch 'origin/DB-10193' into DB-10222", "committedDate": "2020-10-01T09:19:33Z", "type": "commit"}, {"oid": "bba84a9e4c7c6ce7c85bcb058181d91cc2fac7be", "url": "https://github.com/splicemachine/spliceengine/commit/bba84a9e4c7c6ce7c85bcb058181d91cc2fac7be", "message": "DB-10222 Support DROP DATABASE and rework DB creation", "committedDate": "2020-10-07T14:53:38Z", "type": "commit"}, {"oid": "a6574154ad597fd0b71485eb75b9fab15d0ceacd", "url": "https://github.com/splicemachine/spliceengine/commit/a6574154ad597fd0b71485eb75b9fab15d0ceacd", "message": "Merge remote-tracking branch 'origin/DB-10193' into DB-10222", "committedDate": "2020-10-07T14:55:42Z", "type": "commit"}, {"oid": "85790f6f63180f69ac0029e19b2e63af9c8aa2d5", "url": "https://github.com/splicemachine/spliceengine/commit/85790f6f63180f69ac0029e19b2e63af9c8aa2d5", "message": "DB-10222 Use dataDict.createNewDatabase instead of the system procedure", "committedDate": "2020-10-07T15:03:48Z", "type": "commit"}, {"oid": "5590a7c561423e1551c9e070ba6c08790ebb4078", "url": "https://github.com/splicemachine/spliceengine/commit/5590a7c561423e1551c9e070ba6c08790ebb4078", "message": "DB-10222 Cleanup", "committedDate": "2020-10-07T15:26:16Z", "type": "commit"}, {"oid": "26fc9d0c48b5d8778c66d700fb49fa2fe70aaa25", "url": "https://github.com/splicemachine/spliceengine/commit/26fc9d0c48b5d8778c66d700fb49fa2fe70aaa25", "message": "DB-10424 Fix spotbugs", "committedDate": "2020-10-08T12:07:07Z", "type": "commit"}, {"oid": "f7b23faccbcd56094d44ecd19b25d4e158c9836f", "url": "https://github.com/splicemachine/spliceengine/commit/f7b23faccbcd56094d44ecd19b25d4e158c9836f", "message": "DB-10424 Remove overzealous try-with-resources", "committedDate": "2020-10-08T15:06:37Z", "type": "commit"}, {"oid": "efa9fc9763b754a200b311bd445ee43a40bfe600", "url": "https://github.com/splicemachine/spliceengine/commit/efa9fc9763b754a200b311bd445ee43a40bfe600", "message": "Merge remote-tracking branch 'origin/DB-10193' into DB-10222", "committedDate": "2020-10-14T10:55:18Z", "type": "commit"}, {"oid": "df6c89dff2dde47311d9a641699ce4bbb8a18562", "url": "https://github.com/splicemachine/spliceengine/commit/df6c89dff2dde47311d9a641699ce4bbb8a18562", "message": "Merge remote-tracking branch 'origin/DB-10193' into DB-10222", "committedDate": "2020-10-20T13:33:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3OTA3OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r509179079", "bodyText": "What's the placeholder?", "author": "dgomezferro", "createdAt": "2020-10-21T10:49:38Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/catalog/DataDictionaryImpl.java", "diffHunk": "@@ -727,6 +713,21 @@ private void getBuiltinSpliceDb() throws StandardException {\n                 databaseID);\n     }\n \n+    public UUID createNewDatabase(String name) throws StandardException {\n+        ContextService.getFactory();\n+        TransactionController tc = af.getTransaction(ContextService.getCurrentContextManager());\n+        if (!tc.isElevated()) {\n+            StandardException.plainWrapException(new IOException(\"addStoreDependency: not writeable\"));\n+        }\n+\n+        UUID uuid = getUUIDFactory().createUUID();\n+        DatabaseDescriptor desc = new DatabaseDescriptor(\n+                this, name, \"PLACEHOLDER\", uuid); // XXX (arnaud multidb) replace placeholder", "originalCommit": "5590a7c561423e1551c9e070ba6c08790ebb4078", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk4MjM4OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r509982389", "bodyText": "It's meant to be replaced by the dbOwner.\nThis will be part of DB-10472 (PR coming soon)", "author": "arnaud-splice", "createdAt": "2020-10-22T08:39:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3OTA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4Mjk5Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r509182992", "bodyText": "This should also be called in other RSs through the DDL coordination mechanism, is that happening?", "author": "dgomezferro", "createdAt": "2020-10-21T10:56:24Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/dictionary/DatabaseDescriptor.java", "diffHunk": "@@ -265,4 +272,50 @@ public void writeExternal(ObjectOutput output) throws IOException {\n     public void setDataDictionary(DataDictionary dataDictionary) {\n         this.dataDictionary = dataDictionary;\n     }\n+\n+    /**\n+     * Drop this database.\n+     * Drops the database if it is empty.\n+     * @throws StandardException Schema could not be dropped.\n+     */\n+    public void drop(LanguageConnectionContext lcc,\n+                     Activation activation) throws StandardException\n+    {\n+        DataDictionary dd = getDataDictionary();\n+        DependencyManager dm = dd.getDependencyManager();\n+        TransactionController tc = lcc.getTransactionExecute();\n+\n+        // First drop restrict the default SPLICE schema:\n+        SchemaDescriptor spliceSchemaDesc = dd.getSchemaDescriptor(getUUID(), Property.DEFAULT_USER_NAME, tc, false);\n+        if (spliceSchemaDesc != null) {\n+            spliceSchemaDesc.drop(lcc, activation);\n+        }\n+\n+        /*\n+         ** Make sure the database is empty.\n+         ** In the future we want to drop everything\n+         ** in the database if it is CASCADE.\n+         */\n+        if (!dd.isDatabaseEmpty(this))\n+        {\n+            throw StandardException.newException(SQLState.LANG_DATABASE_NOT_EMPTY, getDatabaseName());\n+        }\n+\n+        /* Prepare all dependents to invalidate.  (This is there chance\n+         * to say that they can't be invalidated.  For example, an open\n+         * cursor referencing a table/view that the user is attempting to\n+         * drop.) If no one objects, then invalidate any dependent objects.\n+         */\n+        dm.invalidateFor(this, DependencyManager.DROP_DATABASE, lcc);", "originalCommit": "5590a7c561423e1551c9e070ba6c08790ebb4078", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAwNTM4OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r510005389", "bodyText": "I did the same thing as what was being done for SchemaDescriptor. Is that not enough?", "author": "arnaud-splice", "createdAt": "2020-10-22T09:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4Mjk5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE5MDU3OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r510190579", "bodyText": "After discussing this offline, I made SchemaDescritor and DatabaseDescriptor behave like TableDescriptor", "author": "arnaud-splice", "createdAt": "2020-10-22T14:06:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4Mjk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NDk0Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r509184947", "bodyText": "Would it be possible to cache the DatabaseDescriptor in the initialize() method similarly to what we do with the SchemaDescriptor, so that we don't have to throw StandardExceptions all over the place?", "author": "dgomezferro", "createdAt": "2020-10-21T11:00:03Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/conn/GenericLanguageConnectionContext.java", "diffHunk": "@@ -3660,23 +3673,19 @@ public void setupSubStatementSessionContext(Activation a) throws StandardExcepti\n     }\n \n     @Override\n-    public SQLSessionContext getTopLevelSQLSessionContext() {\n+    public SQLSessionContext getTopLevelSQLSessionContext() throws StandardException {\n         if(topLevelSSC==null){\n-            topLevelSSC=new SQLSessionContextImpl(\n-                    getInitialDefaultSchemaDescriptor(),\n-                    getSessionUserId(),\n-                    defaultRoles, groupuserlist);\n+            topLevelSSC = createSQLSessionContext();\n         }\n         return topLevelSSC;\n     }\n \n \n     @Override\n-    public SQLSessionContext createSQLSessionContext() {\n-        return new SQLSessionContextImpl(\n-                getInitialDefaultSchemaDescriptor(),\n-                getSessionUserId() /* a priori */,\n-                defaultRoles, groupuserlist);\n+    public SQLSessionContext createSQLSessionContext() throws StandardException {\n+        return new SQLSessionContextImpl(getDataDictionary().getDatabaseDescriptor(dbName, getTransactionCompile()),", "originalCommit": "5590a7c561423e1551c9e070ba6c08790ebb4078", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3NTgwNA==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r510275804", "bodyText": "Done! That's a lot simpler now, thanks!", "author": "arnaud-splice", "createdAt": "2020-10-22T15:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NDk0Nw=="}], "type": "inlineReview"}, {"oid": "562dc23702c29fb3d911f71029eaddab7059573a", "url": "https://github.com/splicemachine/spliceengine/commit/562dc23702c29fb3d911f71029eaddab7059573a", "message": "Merge remote-tracking branch 'origin/DB-10193' into DB-10222", "committedDate": "2020-10-21T15:35:31Z", "type": "commit"}, {"oid": "373b2d1720317aefb97bcba09e19243bfd7d8923", "url": "https://github.com/splicemachine/spliceengine/commit/373b2d1720317aefb97bcba09e19243bfd7d8923", "message": "DB-10424 Revert unwanted change in spotbugs", "committedDate": "2020-10-22T11:08:18Z", "type": "commit"}, {"oid": "d7f9ec52725178eff217b4299ef9edf7b63879b8", "url": "https://github.com/splicemachine/spliceengine/commit/d7f9ec52725178eff217b4299ef9edf7b63879b8", "message": "DB-10562 Refactor SpliceTransactionResourceImpl.getMarshallTransaction", "committedDate": "2020-10-22T14:37:25Z", "type": "commit"}, {"oid": "69cc550b391d91a15619ff701ceeeea004816a49", "url": "https://github.com/splicemachine/spliceengine/commit/69cc550b391d91a15619ff701ceeeea004816a49", "message": "DB-10222 Fix spanish error message", "committedDate": "2020-10-22T15:07:14Z", "type": "commit"}, {"oid": "116fd5d102f02900ed5b4181cdd9cf3587c45b70", "url": "https://github.com/splicemachine/spliceengine/commit/116fd5d102f02900ed5b4181cdd9cf3587c45b70", "message": "DB-10222 Simplify LanguageConnectionContext creation to avoid throwing StandardExceptions", "committedDate": "2020-10-22T15:53:15Z", "type": "commit"}, {"oid": "f4bce1729192e3e6018463a02d26e83052788b95", "url": "https://github.com/splicemachine/spliceengine/commit/f4bce1729192e3e6018463a02d26e83052788b95", "message": "DB-10222 Fix more spotbugs", "committedDate": "2020-10-23T09:05:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxMjgzOA==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r512412838", "bodyText": "It is not clear to me what behavior we should support when the default database in the connection is dropped. Right now, after dropping the default database in a connection, we still allow new schema to be created, but using the database id that has been dropped, thus creating dangling schemas:\nsplice> create database test_db;\n0 rows inserted/updated/deleted\nELAPSED TIME = 18 milliseconds\nsplice> connect 'jdbc:splice://localhost:1527/test_db;user=splice;password=admin' as testdb_con;\nELAPSED TIME = 18 milliseconds\nsplice> show schemas;\nTABLE_SCHEM                   \n------------------------------\nSPLICE                        \nSYS                           \nSYSFUN                        \nSYSIBM                        \nSYSIBMADM                     \nSYSVW                         \n\n6 rows selected\nELAPSED TIME = 19 milliseconds\nsplice> set connection splice;\nELAPSED TIME = 0 milliseconds\nsplice> select * from sys.sysdatabases;\nDATABASEID                          |DATABASENAME                                                                                                                    |AUTHORIZATIONID                                                                                                                 \n------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\necec0361-0175-66e7-a8b7-000001040c80|TEST_DB                                                                                                                         |PLACEHOLDER                                                                                                                     \na816c00e-0175-66e7-a8b7-000001040c80|SPLICEDB                                                                                                                        |PLACEHOLDER                                                                                                                     \n\n2 rows selected\nELAPSED TIME = 8 milliseconds\nsplice> drop database test_db restrict;\n0 rows inserted/updated/deleted\nELAPSED TIME = 46 milliseconds\nsplice> set connection testdb_con;\nELAPSED TIME = 0 milliseconds\nsplice> create schema test_sch;\n0 rows inserted/updated/deleted\nELAPSED TIME = 29 milliseconds\nsplice> show schemas;\nTABLE_SCHEM                   \n------------------------------\nSYS                           \nSYSFUN                        \nSYSIBM                        \nSYSIBMADM                     \nSYSVW                         \n\n5 rows selected\nELAPSED TIME = 15 milliseconds\nsplice> select * from sys.sysschemas;\nSCHEMAID                            |SCHEMANAME                                                                                                                      |AUTHORIZATIONID                                                                                                                 |DATABASEID                          \n-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n2a534337-0175-66e7-a8b7-000001040c80|TEMP                                                                                                                            |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\nbde2434f-0175-66e7-a8b7-000001040c80|TEMP2                                                                                                                           |SPLICE                                                                                                                          |2cd98344-0175-66e7-a8b7-000001040c80\nd8d6436f-0175-66e7-a8b7-000001040c80|TEST_SCH                                                                                                                        |SPLICE                                                                                                                          |ecec0361-0175-66e7-a8b7-000001040c80\nc013800d-00f8-5b53-28a9-00000019ed88|SYSIBM                                                                                                                          |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\n62bfdcdb-ea53-4339-bd1b-018e411b8852|SYSIBMADM                                                                                                                       |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\n8000000d-00d0-fd77-3ed8-000a0a0b1900|SYS                                                                                                                             |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\nc013800d-00fb-2641-07ec-000000134f30|SYSCAT                                                                                                                          |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\nc013800d-00fb-2642-07ec-000000134f30|SYSFUN                                                                                                                          |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\nc013800d-00fb-2643-07ec-000000134f30|SYSPROC                                                                                                                         |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\nc013800d-00fb-2644-07ec-000000134f30|SYSSTAT                                                                                                                         |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\nc013800d-00fb-2647-07ec-000000134f30|NULLID                                                                                                                          |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\nc013800d-00fb-2648-07ec-000000134f30|SQLJ                                                                                                                            |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\nc013800d-00fb-2646-07ec-000000134f30|SYSCS_DIAG                                                                                                                      |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\nc013800d-00fb-2649-07ec-000000134f30|SYSCS_UTIL                                                                                                                      |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\nc013800d-00fb-264d-07ec-000000134f30|SYSVW                                                                                                                           |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\n80000000-00d2-b38f-4cda-000a0a412c00|SPLICE                                                                                                                          |SPLICE                                                                                                                          |a816c00e-0175-66e7-a8b7-000001040c80\n\n16 rows selected\nELAPSED TIME = 28 milliseconds\n\nAs we can see, the schema test_sch 's database id is still pointing to ecec0361-0175-66e7-a8b7-000001040c80, which is the database id of test_db.", "author": "yxia92", "createdAt": "2020-10-27T04:41:11Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/dictionary/DatabaseDescriptor.java", "diffHunk": "@@ -265,4 +272,50 @@ public void writeExternal(ObjectOutput output) throws IOException {\n     public void setDataDictionary(DataDictionary dataDictionary) {\n         this.dataDictionary = dataDictionary;\n     }\n+\n+    /**\n+     * Drop this database.\n+     * Drops the database if it is empty.\n+     * @throws StandardException Schema could not be dropped.\n+     */\n+    public void drop(LanguageConnectionContext lcc,\n+                     Activation activation) throws StandardException\n+    {\n+        DataDictionary dd = getDataDictionary();\n+        DependencyManager dm = dd.getDependencyManager();\n+        TransactionController tc = lcc.getTransactionExecute();\n+\n+        // First drop restrict the default SPLICE schema:\n+        SchemaDescriptor spliceSchemaDesc = dd.getSchemaDescriptor(getUUID(), Property.DEFAULT_USER_NAME, tc, false);\n+        if (spliceSchemaDesc != null) {\n+            spliceSchemaDesc.drop(lcc, activation);\n+        }\n+\n+        /*\n+         ** Make sure the database is empty.\n+         ** In the future we want to drop everything\n+         ** in the database if it is CASCADE.\n+         */\n+        if (!dd.isDatabaseEmpty(this))\n+        {\n+            throw StandardException.newException(SQLState.LANG_DATABASE_NOT_EMPTY, getDatabaseName());\n+        }\n+\n+        /* Prepare all dependents to invalidate.  (This is there chance\n+         * to say that they can't be invalidated.  For example, an open\n+         * cursor referencing a table/view that the user is attempting to\n+         * drop.) If no one objects, then invalidate any dependent objects.\n+         */\n+        dm.invalidateFor(this, DependencyManager.DROP_DATABASE, lcc);\n+\n+        dd.dropDatabaseDescriptor(getDatabaseName(), tc);\n+\n+        /*\n+         ** If we have dropped the current default databae,\n+         ** then we will set the default to null.  The\n+         ** LCC is free to set the new default database to\n+         ** some system defined default.\n+         */\n+        // lcc.resetSchemaUsages(activation, getDatabaseName()); XXX (arnaud multidb) implement that?", "originalCommit": "f4bce1729192e3e6018463a02d26e83052788b95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxNTYxMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r512415611", "bodyText": "We should check the existence of the database before creating the schema, so that dangling schemas can be avoided.", "author": "yxia92", "createdAt": "2020-10-27T04:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxMjgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgzMDIxNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r512830216", "bodyText": "That's a very good point, thanks!\nIs it alright with you if I jira that for later?", "author": "arnaud-splice", "createdAt": "2020-10-27T16:13:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxMjgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0NjA5Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r513046097", "bodyText": "A JIRA to track is fine. Thanks!", "author": "yxia92", "createdAt": "2020-10-27T21:33:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxMjgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQwOTgwOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4240#discussion_r514409809", "bodyText": "Tracked by DB-10591", "author": "arnaud-splice", "createdAt": "2020-10-29T16:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxMjgzOA=="}], "type": "inlineReview"}, {"oid": "a9dca1aec8c3a200864bc38554f504f54a4850c8", "url": "https://github.com/splicemachine/spliceengine/commit/a9dca1aec8c3a200864bc38554f504f54a4850c8", "message": "Merge remote-tracking branch 'origin/DB-10193' into DB-10222", "committedDate": "2020-12-10T18:11:43Z", "type": "commit"}, {"oid": "15a590c8f6f138f1a84bab72a3f81785371d0d3b", "url": "https://github.com/splicemachine/spliceengine/commit/15a590c8f6f138f1a84bab72a3f81785371d0d3b", "message": "DB-10222 Fix compilation issues", "committedDate": "2020-12-10T18:45:42Z", "type": "commit"}, {"oid": "8e5d54e002b66f2027b3b5e43d9d94069acc0066", "url": "https://github.com/splicemachine/spliceengine/commit/8e5d54e002b66f2027b3b5e43d9d94069acc0066", "message": "DB-10562 Invalidate remote caches before dropping schema", "committedDate": "2020-12-10T18:53:17Z", "type": "commit"}, {"oid": "a16647bc612e46ca1020d43095e4b95e6da9117f", "url": "https://github.com/splicemachine/spliceengine/commit/a16647bc612e46ca1020d43095e4b95e6da9117f", "message": "DB-10222 Fix spotbugs", "committedDate": "2020-12-10T19:15:48Z", "type": "commit"}]}