{"pr_number": 4792, "pr_title": "DB-10967 added splice.function.timestampFormat", "pr_createdAt": "2020-12-06T22:02:02Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4792", "timeline": [{"oid": "7a25fbc5357297576da32f01ee607c2f2e6fbbe4", "url": "https://github.com/splicemachine/spliceengine/commit/7a25fbc5357297576da32f01ee607c2f2e6fbbe4", "message": "DB-10967 added splice.function.timestampFormat\n\ne.g.\ncall SYSCS_UTIL.SYSCS_SET_GLOBAL_DATABASE_PROPERTY( 'splice.function.timestampFormat', 'yyyy-MM-dd-HH.mm.ss.SSSSSSSS'); -- IBM style", "committedDate": "2020-12-06T22:01:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzMzUzNw==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537133537", "bodyText": "I think you can remove this method.", "author": "hatyo", "createdAt": "2020-12-06T22:02:58Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/compile/CompilerContext.java", "diffHunk": "@@ -730,6 +731,9 @@\n     int getCurrentTimestampPrecision();\n \n     int getTimestampPrecision();", "originalCommit": "7a25fbc5357297576da32f01ee607c2f2e6fbbe4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzMzc1MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537133750", "bodyText": "This can be removed.", "author": "hatyo", "createdAt": "2020-12-06T22:04:10Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -122,6 +127,10 @@ public void setStringFormat(int format) {\n         stringFormat = format;\n     }\n \n+    public void setTimestampFormat(String format) {\n+        timestampFormat = format;\n+    }\n+\n     public void setPrecision(int precision) {\n         this.precision = precision;\n     }", "originalCommit": "7a25fbc5357297576da32f01ee607c2f2e6fbbe4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzNDAzMg==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537134032", "bodyText": "timestampPrecisionString can be removed along with the related logic from GenericStatement.", "author": "hatyo", "createdAt": "2020-12-06T22:05:49Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java", "diffHunk": "@@ -620,6 +622,21 @@ else if (newMergeJoinString.equals(\"forced\"))\n                 }\n                 cc.setCurrentTimestampPrecision(currentTimestampPrecision);\n \n+                String timestampFormatString =\n+                        PropertyUtil.getCachedDatabaseProperty(lcc, Property.SPLICE_TIMESTAMP_FORMAT);\n+                if(timestampFormatString == null)\n+                    cc.setTimestampFormat(CompilerContext.DEFAULT_TIMESTAMP_FORMAT);\n+                else {\n+                    try {\n+                        // DB-10968 we shouldn't even allow setting this to the wrong value\n+                        DateTimeFormatter.ofPattern(timestampFormatString);\n+                    } catch(Exception e)\n+                    {\n+                        timestampFormatString = CompilerContext.DEFAULT_TIMESTAMP_FORMAT;\n+                    }\n+                    cc.setTimestampFormat(timestampFormatString);\n+                }\n+\n                 String timestampPrecisionString =", "originalCommit": "7a25fbc5357297576da32f01ee607c2f2e6fbbe4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzNDIyMA==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537134220", "bodyText": "this can be removed.", "author": "hatyo", "createdAt": "2020-12-06T22:06:40Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CompilerContextImpl.java", "diffHunk": "@@ -1184,6 +1192,8 @@ public int getNextOJLevel() {\n     private       boolean                             allowOverflowSensitiveNativeSparkExpressions = DEFAULT_SPLICE_ALLOW_OVERFLOW_SENSITIVE_NATIVE_SPARK_EXPRESSIONS;\n     private       int                                 currentTimestampPrecision                    = DEFAULT_SPLICE_CURRENT_TIMESTAMP_PRECISION;\n     private       int                                 timestampPrecision                           = DEFAULT_TIMESTAMP_PRECISION;", "originalCommit": "7a25fbc5357297576da32f01ee607c2f2e6fbbe4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3ef461c4af9b51af8df283ffa7430bbb6c06e3d2", "url": "https://github.com/splicemachine/spliceengine/commit/3ef461c4af9b51af8df283ffa7430bbb6c06e3d2", "message": "DB-10967 code review: remove timestampPrecision, some refactoring", "committedDate": "2020-12-07T10:35:36Z", "type": "commit"}, {"oid": "89b16bcb5e27e37045eee255f55a8f538ca34cd0", "url": "https://github.com/splicemachine/spliceengine/commit/89b16bcb5e27e37045eee255f55a8f538ca34cd0", "message": "DB-10967 disallow non-fixedsize timestampFormats", "committedDate": "2020-12-07T12:57:05Z", "type": "forcePushed"}, {"oid": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee", "url": "https://github.com/splicemachine/spliceengine/commit/e238fb626a6e9d5fb1b61090f86355ee3f6f2bee", "message": "DB-10967 disallow non-fixedsize timestampFormats", "committedDate": "2020-12-07T12:58:15Z", "type": "commit"}, {"oid": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee", "url": "https://github.com/splicemachine/spliceengine/commit/e238fb626a6e9d5fb1b61090f86355ee3f6f2bee", "message": "DB-10967 disallow non-fixedsize timestampFormats", "committedDate": "2020-12-07T12:58:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMTQ5Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537511492", "bodyText": "I would elevate it to a standard SQL exception with an error code. DB2 throws error with SQLState 22007 if one attempts e.g. the following:\nINSERT INTO t1 (c1) VALUES (TIMESTAMP_FORMAT('1999-12-31 23:59:59', 'YYYY-MM-sadsdDD HH24:MI:SXXXS'))\n\nSQL20447N  Format string \"YYYY-MM-sadsdDD HH24:MI:SXXXS\" is not valid for the \n\"SYSIBM.TIMESTAMP_FORMAT\" function.  SQLSTATE=22007\n\nI suggest to use the same here.", "author": "hatyo", "createdAt": "2020-12-07T13:37:40Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -169,12 +172,57 @@ public int estimateMemoryUsage()\n         return BASE_MEMORY_USAGE;\n     } // end of estimateMemoryUsage\n \n-    private static String format(Timestamp timestamp, String timeStampFormat) {\n+    /**\n+     * this also checks if the format is a valid fixed-size timestamp format\n+     * see also https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html\n+     * we support:\n+     * yyyy, yy, uuuu, uu, eee, EEE, MM, mm, dd, HH, hh, ss, a\n+     * an arbitrary number of S, and other characters \" ,.-/:\"\n+     * @param format\n+     * @throws IllegalArgumentException if format is not supported\n+     * @return length of format\n+     */\n+    public static int getFormatLength(String format) throws IllegalArgumentException\n+    {\n+        byte[] b = format.getBytes(Bytes.UTF8_CHARSET);\n+        int repeat = 0;\n+        char last = (char)b[0];\n+        int length = b.length;\n+        for(int i=0; i<b.length+1; i++) {\n+            if (i != b.length && (char) b[i] == last) {\n+                repeat++;\n+                continue;\n+            }\n+            int r = repeat;\n+            char l = last;\n+            repeat = 1;\n+            if( i != b.length)\n+                last = (char) b[i];\n+            if ((l == 'y' || l == 'u') && (r == 4 || r == 2)) continue;\n+            else if (r == 2 &&  \"MmdHhs\".indexOf(l) != -1 ) continue;\n+            else if (r == 3 && (l == 'e' || l == 'E')) continue;\n+            else if (l == 'S') continue;\n+            else if (r == 1) {\n+                if (l == 'a') {\n+                    length++;\n+                    continue;\n+                }\n+                if(\" ,.-/:\".indexOf(l) != -1) continue;\n+            }\n+            throw new IllegalArgumentException(\"not supported format \\\"\" + format + \"\\\": '\" + l + \"' can't be repeated \" + r + \" times\");\n+        }", "originalCommit": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU4NjE1NA==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537586154", "bodyText": "i agree, however customer doesn't see this message currently since we don't check this at call SYSCS_UTIL.SYSCS_SET_GLOBAL_DATABASE_PROPERTY( 'splice.function.timestampFormat', 'yyyy-MM-dd-HH.mm.ss.SSSSSSSS'); but only later where we can't throw . i created a task/bug for this: DB-10968", "author": "martinrupp", "createdAt": "2020-12-07T15:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMTQ5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxODI2OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537518268", "bodyText": "Can you iterate i only until b.length and not b.length+1? i.e. can we rewrite to:\n        for(int i=0; i<b.length; i++) {\n            if ((char) b[i] == last) {\n                repeat++;\n                continue;\n            }\n            int r = repeat;\n            char l = last;\n            repeat = 1;\n            last = (char) b[i];\n            if ((l == 'y' || l == 'u') && (r == 4 || r == 2)) continue;\n            else if (r == 2 &&  \"MmdHhs\".indexOf(l) != -1 ) continue;\n            else if (r == 3 && (l == 'e' || l == 'E')) continue;\n            else if (l == 'S') continue;\n            else if (r == 1) {\n                if (l == 'a') {\n                    length++;\n                    continue;\n                }\n                if(\" ,.-/:\".indexOf(l) != -1) continue;\n            }\n            throw new IllegalArgumentException(\"not supported format \\\"\" + format + \"\\\": '\" + l + \"' can't be repeated \" + r + \" times\");\n        }", "author": "hatyo", "createdAt": "2020-12-07T13:47:46Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -169,12 +172,57 @@ public int estimateMemoryUsage()\n         return BASE_MEMORY_USAGE;\n     } // end of estimateMemoryUsage\n \n-    private static String format(Timestamp timestamp, String timeStampFormat) {\n+    /**\n+     * this also checks if the format is a valid fixed-size timestamp format\n+     * see also https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html\n+     * we support:\n+     * yyyy, yy, uuuu, uu, eee, EEE, MM, mm, dd, HH, hh, ss, a\n+     * an arbitrary number of S, and other characters \" ,.-/:\"\n+     * @param format\n+     * @throws IllegalArgumentException if format is not supported\n+     * @return length of format\n+     */\n+    public static int getFormatLength(String format) throws IllegalArgumentException\n+    {\n+        byte[] b = format.getBytes(Bytes.UTF8_CHARSET);\n+        int repeat = 0;\n+        char last = (char)b[0];\n+        int length = b.length;\n+        for(int i=0; i<b.length+1; i++) {\n+            if (i != b.length && (char) b[i] == last) {\n+                repeat++;\n+                continue;\n+            }\n+            int r = repeat;\n+            char l = last;\n+            repeat = 1;\n+            if( i != b.length)\n+                last = (char) b[i];\n+            if ((l == 'y' || l == 'u') && (r == 4 || r == 2)) continue;\n+            else if (r == 2 &&  \"MmdHhs\".indexOf(l) != -1 ) continue;\n+            else if (r == 3 && (l == 'e' || l == 'E')) continue;\n+            else if (l == 'S') continue;\n+            else if (r == 1) {\n+                if (l == 'a') {\n+                    length++;\n+                    continue;\n+                }\n+                if(\" ,.-/:\".indexOf(l) != -1) continue;\n+            }\n+            throw new IllegalArgumentException(\"not supported format \\\"\" + format + \"\\\": '\" + l + \"' can't be repeated \" + r + \" times\");\n+        }", "originalCommit": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU4MTk0NA==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537581944", "bodyText": "iterating to b.length (inclusive) is weird i know but had to be done.\nthe solution you suggest is not checking the last part of the string. you would have to add the same if/else/else code again after the loop is done.\njust checked hh:mm:ss a, it would miss the 'a'.", "author": "martinrupp", "createdAt": "2020-12-07T15:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxODI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMTM3MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537521370", "bodyText": "I guess this would also throw if we have a pattern that looks like this: yyyy----MM-dd HH:mm:ss (notice the tripple-dash), do we want to allow such pattern?", "author": "hatyo", "createdAt": "2020-12-07T13:52:14Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -169,12 +172,57 @@ public int estimateMemoryUsage()\n         return BASE_MEMORY_USAGE;\n     } // end of estimateMemoryUsage\n \n-    private static String format(Timestamp timestamp, String timeStampFormat) {\n+    /**\n+     * this also checks if the format is a valid fixed-size timestamp format\n+     * see also https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html\n+     * we support:\n+     * yyyy, yy, uuuu, uu, eee, EEE, MM, mm, dd, HH, hh, ss, a\n+     * an arbitrary number of S, and other characters \" ,.-/:\"\n+     * @param format\n+     * @throws IllegalArgumentException if format is not supported\n+     * @return length of format\n+     */\n+    public static int getFormatLength(String format) throws IllegalArgumentException", "originalCommit": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU4NDQ1MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537584450", "bodyText": "you're right, we can allow such patterns", "author": "martinrupp", "createdAt": "2020-12-07T15:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMTM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMTgwMg==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537521802", "bodyText": "nice", "author": "hatyo", "createdAt": "2020-12-07T13:52:50Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -127,6 +129,7 @@ public void setStringFormat(int format) {\n \n     public void setTimestampFormat(String format) {\n         timestampFormat = format;\n+        formatter = null; // recreate on demand", "originalCommit": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8391ba0499afa525833be5ef55aeb33946dcaea1", "url": "https://github.com/splicemachine/spliceengine/commit/8391ba0499afa525833be5ef55aeb33946dcaea1", "message": "DB-10973 fixing cast result of timestamps / upper(timestamp(...))\n\n+ addressed code review", "committedDate": "2020-12-07T15:32:47Z", "type": "commit"}, {"oid": "e7727a9fe9bd6ea5423f2eeeaae6758ccaf57914", "url": "https://github.com/splicemachine/spliceengine/commit/e7727a9fe9bd6ea5423f2eeeaae6758ccaf57914", "message": "fix SQLTypesUnitTest.testTimestampExtractOperatorNode", "committedDate": "2020-12-07T16:39:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5Nzg1OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r538197858", "bodyText": "Not quite related to this PR, but that one seems to only be used in SpliceAdmin and should therefore probably be moved out of this class.", "author": "arnaud-splice", "createdAt": "2020-12-08T09:58:55Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -98,8 +102,7 @@\n     public static final String defaultTimestampFormatString = \"yyyy-MM-dd HH:mm:ss\";", "originalCommit": "e7727a9fe9bd6ea5423f2eeeaae6758ccaf57914", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxOTMyNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r538219326", "bodyText": "agreed", "author": "martinrupp", "createdAt": "2020-12-08T10:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5Nzg1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUzODc1OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r538538758", "bodyText": "The current maximum on-disk timestamp precision is 6 decimal places.  Maybe we should make the default timestamp format match this.  Having a default format with 9 decimal places might make users mistakenly think they can input such data into tables as well.", "author": "msirek", "createdAt": "2020-12-08T16:03:28Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/compile/CompilerContext.java", "diffHunk": "@@ -183,7 +183,7 @@\n     NativeSparkModeType DEFAULT_SPLICE_NATIVE_SPARK_AGGREGATION_MODE = NativeSparkModeType.SYSTEM;\n     boolean DEFAULT_SPLICE_ALLOW_OVERFLOW_SENSITIVE_NATIVE_SPARK_EXPRESSIONS = true;\n     int DEFAULT_SPLICE_CURRENT_TIMESTAMP_PRECISION = 6;\n-    int DEFAULT_TIMESTAMP_PRECISION = 9;\n+    String DEFAULT_TIMESTAMP_FORMAT = \"yyyy-MM-dd HH:mm:ss.SSSSSSSSS\";", "originalCommit": "e7727a9fe9bd6ea5423f2eeeaae6758ccaf57914", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI0NDgxNA==", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r553244814", "bodyText": "agreed", "author": "martinrupp", "createdAt": "2021-01-07T10:35:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUzODc1OA=="}], "type": "inlineReview"}]}