{"pr_number": 4776, "pr_title": "DB-10896 Keep track of compacted files in HFiles for crash recovery", "pr_createdAt": "2020-12-03T19:27:37Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4776", "timeline": [{"oid": "d62c2a85a4686454f9a0557a27aef7e7f850fb47", "url": "https://github.com/splicemachine/spliceengine/commit/d62c2a85a4686454f9a0557a27aef7e7f850fb47", "message": "DB-10896 Keep track of compacted files in HFiles for crash recovery", "committedDate": "2020-12-03T19:23:35Z", "type": "commit"}, {"oid": "151ba2079e408fdea0d34708d2132d157e8cb374", "url": "https://github.com/splicemachine/spliceengine/commit/151ba2079e408fdea0d34708d2132d157e8cb374", "message": "DB-10896 Add comment", "committedDate": "2020-12-03T19:32:23Z", "type": "commit"}, {"oid": "cdb5cf0a1647d232dca286be24c442030ef818a4", "url": "https://github.com/splicemachine/spliceengine/commit/cdb5cf0a1647d232dca286be24c442030ef818a4", "message": "DB-10896 Added test based on HBase fix", "committedDate": "2020-12-03T20:56:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyODcyNA==", "url": "https://github.com/splicemachine/spliceengine/pull/4776#discussion_r538228724", "bodyText": "Could you make this a construction parameter of SpliceDefaultCompactor instead?\nThis non final allowSpark only for the sake of tests is a bit scary in my opinion.", "author": "arnaud-splice", "createdAt": "2020-12-08T10:39:33Z", "path": "hbase_sql/src/main/java/com/splicemachine/compactions/SpliceDefaultCompactor.java", "diffHunk": "@@ -81,7 +83,8 @@\n  *\n  */\n public class SpliceDefaultCompactor extends DefaultCompactor {\n-    private static final boolean allowSpark = true;\n+    public static boolean allowSpark = true;", "originalCommit": "cdb5cf0a1647d232dca286be24c442030ef818a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEwNjA2OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4776#discussion_r540106068", "bodyText": "We can't make it a constructor parameter because the constructor is called directly by HBase, but I've made it a private non-static final field that gets initialized in the Constructor from the Configuration object.", "author": "dgomezferro", "createdAt": "2020-12-10T11:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyODcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEyMjkwNw==", "url": "https://github.com/splicemachine/spliceengine/pull/4776#discussion_r540122907", "bodyText": "Neat!", "author": "arnaud-splice", "createdAt": "2020-12-10T12:18:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyODcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIzMjQ3MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4776#discussion_r538232471", "bodyText": "Can you rename this to CleanupCompactedFileAfterFailoverTest instead to adhere to our naming conventions?", "author": "arnaud-splice", "createdAt": "2020-12-08T10:44:04Z", "path": "hbase_sql/src/test/java/org/apache/hadoop/hbase/regionserver/TestCleanupCompactedFileAfterFailover.java", "diffHunk": "@@ -0,0 +1,281 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ *  version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.apache.hadoop.hbase.regionserver;\n+\n+import com.splicemachine.compactions.SpliceDefaultCompactionPolicy;\n+import com.splicemachine.compactions.SpliceDefaultCompactor;\n+import com.splicemachine.si.data.hbase.coprocessor.SIObserver;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.HConstants;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.Admin;\n+import org.apache.hadoop.hbase.client.ColumnFamilyDescriptorBuilder;\n+import org.apache.hadoop.hbase.client.Delete;\n+import org.apache.hadoop.hbase.client.Get;\n+import org.apache.hadoop.hbase.client.Put;\n+import org.apache.hadoop.hbase.client.Result;\n+import org.apache.hadoop.hbase.client.Scan;\n+import org.apache.hadoop.hbase.client.Table;\n+import org.apache.hadoop.hbase.client.TableDescriptorBuilder;\n+import org.apache.hadoop.hbase.master.cleaner.TimeToLiveHFileCleaner;\n+import org.apache.hadoop.hbase.regionserver.compactions.CompactionConfiguration;\n+import org.apache.hadoop.hbase.regionserver.compactions.CompactionPolicy;\n+import org.apache.hadoop.hbase.regionserver.compactions.Compactor;\n+import org.apache.hadoop.hbase.util.Bytes;\n+import org.apache.hadoop.hbase.util.JVMClusterUtil;\n+import org.apache.log4j.Logger;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public class TestCleanupCompactedFileAfterFailover {", "originalCommit": "cdb5cf0a1647d232dca286be24c442030ef818a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEwNjI4Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4776#discussion_r540106287", "bodyText": "Good point, made the change.", "author": "dgomezferro", "createdAt": "2020-12-10T11:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIzMjQ3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1MjMxNA==", "url": "https://github.com/splicemachine/spliceengine/pull/4776#discussion_r538752314", "bodyText": "Awesome fix!   So glad this issue is finally understood.  Do you think we need to do something similar in paths that don't use snapshot isolation, for example, table and schema backup, so that the backup doesn't include the compacted store files?", "author": "msirek", "createdAt": "2020-12-08T19:37:59Z", "path": "hbase_storage/src/main/java/com/splicemachine/si/data/hbase/coprocessor/SIObserver.java", "diffHunk": "@@ -92,6 +97,45 @@\n     protected boolean authTokenEnabled;\n     protected Optional<RegionObserver> optionalRegionObserver = Optional.empty();\n \n+    /**\n+     * We need to keep track of compacted files in HFiles in order to avoid forgetting about any of them when\n+     * recovering from a crash, since the compaction marker might have been lost due to a WAL roll or another crash\n+     * See DB-10896 and HBASE-20724 for more details\n+     */\n+    @Override\n+    public void postOpen(ObserverContext<RegionCoprocessorEnvironment> c) {", "originalCommit": "cdb5cf0a1647d232dca286be24c442030ef818a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEwODgxMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4776#discussion_r540108811", "bodyText": "Good point @msirek , we are already doing it for Full backups (see https://github.com/splicemachine/spliceengine-ee/blob/master/splice_backup/src/main/java/com/splicemachine/backup/HBaseBackupUtils.java#L384 ) but maybe we are missing some cases.\n@jyuanca do we need the same thing for Incremental backups and maybe table/schema backups?", "author": "dgomezferro", "createdAt": "2020-12-10T11:55:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1MjMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM2NDg1OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4776#discussion_r540364859", "bodyText": "@dgomezferro Database/table/schema backup excludes all compacted HFiles. If we can make sure compacted HFiles do not come alive after an HBase restart and recover, backup would not copy these files.", "author": "jyuanca", "createdAt": "2020-12-10T17:37:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1MjMxNA=="}], "type": "inlineReview"}, {"oid": "02d28f6761781b075fea1ad455b0da6bdea78980", "url": "https://github.com/splicemachine/spliceengine/commit/02d28f6761781b075fea1ad455b0da6bdea78980", "message": "DB-10896 Address reviews", "committedDate": "2020-12-10T11:48:50Z", "type": "commit"}]}