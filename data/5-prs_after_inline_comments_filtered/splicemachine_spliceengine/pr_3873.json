{"pr_number": 3873, "pr_title": "DB-9579 Fix broadcast decision in cross joins", "pr_createdAt": "2020-07-22T16:11:26Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3873", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEzMzM1NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459133355", "bodyText": "This line is not needed.", "author": "yxia92", "createdAt": "2020-07-22T23:08:19Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/JoinNode.java", "diffHunk": "@@ -2005,6 +2005,15 @@ private int getJoinArguments(ActivationClassBuilder acb,\n         // Is the right from SSQ\n         mb.push(rightResultSet.getFromSSQ());\n \n+        if (isCrossJoin()) {\n+            assert rightResultSet instanceof Optimizable;\n+            Optimizable rightOpt = (Optimizable)rightResultSet;\n+            boolean broadcastRightSide = rightOpt.getTrulyTheBestAccessPath().getJoinStrategy().getBroadcastRight();\n+            acb.addItem(broadcastRightSide);", "originalCommit": "673b6d93b937410a958579dae5226e9775b5218f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMyMzA2OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459323069", "bodyText": "Done.", "author": "ascend1", "createdAt": "2020-07-23T09:26:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEzMzM1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE0Mzg4Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459143887", "bodyText": "Since the existing check in CrossJoinOperation does not check the heapsize, to minimize the impact on execution plans, I would leave out this check for now. We can put back in if we have the corresponding cross join hint enhanced.", "author": "yxia92", "createdAt": "2020-07-22T23:42:05Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/compile/CrossJoinStrategy.java", "diffHunk": "@@ -231,6 +232,13 @@ public void estimateCost(Optimizable innerTable,\n \n         // Only use cross join when it is inner join and run on Spark\n         innerCost.setBase(innerCost.cloneMe());\n+        double estimatedMemoryMB = innerCost.getEstimatedHeapSize()/1024d/1024d;", "originalCommit": "673b6d93b937410a958579dae5226e9775b5218f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMyNDQxOA==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459324418", "bodyText": "Done, I removed the estimatedMemoryMB < regionThreshold check in this change.", "author": "ascend1", "createdAt": "2020-07-23T09:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE0Mzg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1MzEzOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459153139", "bodyText": "Could you also add a check for static explain whether the table BIG is the picked as the left table of the cross join? Thanks!", "author": "yxia92", "createdAt": "2020-07-23T00:15:27Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/SparkExplainIT.java", "diffHunk": "@@ -805,11 +805,26 @@ public void testCrossJoinBroadcastRight() throws Exception {\n     }\n \n     @Test\n-    public void testCrossJoinBroadcastLeft() throws Exception {\n+    public void testCrossJoinNeverBroadcastLeft() throws Exception {\n+        /* DB-9579\n+         * In case of a cross join, we only check if the right side can be broadcast and never broadcast the left\n+         * side. Reason is that when the plan reaches Spark and it doesn't have a sort node, it might be the case\n+         * that there are sort keys but the sort node is optimized away because the left side row order satisfies\n+         * the sort keys. If we broadcast the left side, resulting row order might be different.\n+         */\n         if (useSpark.equalsIgnoreCase(\"false\")) return; // cross join only has Spark implementation\n         String sqlText = \"sparkexplain select count(*) from --splice-properties joinOrder=fixed\\n\" +\n                 \"        big --splice-properties useSpark=true, joinStrategy=cross\\n\" +\n                 \"        inner join t1 on 1=1\";\n-        testQueryContains(sqlText, \"BroadcastNestedLoopJoin BuildLeft, Cross\", methodWatcher, true);\n+        testQueryContains(sqlText, \"CartesianProduct\", methodWatcher, true);\n+    }\n+\n+    @Test\n+    public void testCrossJoinBroadcastRightNoHint() throws Exception {\n+        if (useSpark.equalsIgnoreCase(\"false\")) return; // cross join only has Spark implementation\n+        String sqlText = \"sparkexplain select count(*) from\\n\" +\n+                \"        t1 --splice-properties useSpark=true\\n\" +\n+                \"        inner join big on 1=1\";\n+        testQueryContains(sqlText, \"BroadcastNestedLoopJoin BuildRight, Cross\", methodWatcher, true);", "originalCommit": "673b6d93b937410a958579dae5226e9775b5218f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE2NTE5NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459165195", "bodyText": "Also, please add an IT with data to test the preservation of sortorder for eligible cross join cases. Thanks!", "author": "yxia92", "createdAt": "2020-07-23T01:04:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1MzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM0MDkyOA==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459340928", "bodyText": "Could you also add a check for static explain whether the table BIG is the picked as the left table of the cross join? Thanks!\n\nDone.", "author": "ascend1", "createdAt": "2020-07-23T10:00:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1MzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM5MDE3OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459390179", "bodyText": "Also, please add an IT with data to test the preservation of sortorder for eligible cross join cases. Thanks!\n\nDone. I add this one to CrossJoinIT.", "author": "ascend1", "createdAt": "2020-07-23T11:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1MzEzOQ=="}], "type": "inlineReview"}, {"oid": "2ce935b66293736b19d74c4ccf3415f7e64d016e", "url": "https://github.com/splicemachine/spliceengine/commit/2ce935b66293736b19d74c4ccf3415f7e64d016e", "message": "DB-9579 Fix broadcast decision in cross joins", "committedDate": "2020-07-23T12:01:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0NTIwNg==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459645206", "bodyText": "I just realize that we share the same CrossJoinStrategy for all cross joins in the same query, so set the braodcastInner flag in one cross join will be applied to all cross joins in the query, which is not right.", "author": "yxia92", "createdAt": "2020-07-23T18:27:01Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/compile/CrossJoinStrategy.java", "diffHunk": "@@ -231,6 +232,11 @@ public void estimateCost(Optimizable innerTable,\n \n         // Only use cross join when it is inner join and run on Spark\n         innerCost.setBase(innerCost.cloneMe());\n+        double estimatedRowCount = innerCost.getEstimatedRowCount();\n+        SConfiguration configuration=EngineDriver.driver().getConfiguration();\n+        long rowCountThreshold = configuration.getBroadcastRegionRowThreshold();\n+        broadcastInner = estimatedRowCount < rowCountThreshold;", "originalCommit": "2ce935b66293736b19d74c4ccf3415f7e64d016e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0NTEwOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459745109", "bodyText": "As we discussed on the call, I removed the field from CrossJoinStrategy class and went around other engineering restrictions. Tests are also improved according to previous comments.", "author": "ascend1", "createdAt": "2020-07-23T21:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0NTIwNg=="}], "type": "inlineReview"}, {"oid": "4b5ec0996be764ec88cafa8d97c6411b36008ab5", "url": "https://github.com/splicemachine/spliceengine/commit/4b5ec0996be764ec88cafa8d97c6411b36008ab5", "message": "DB-9579 Fix broadcast decision in cross joins", "committedDate": "2020-07-23T21:34:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDI0Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459860246", "bodyText": "@ascend1 Can you check further why we pick cross join over broadcast join? With equality join condition, we should pick pick broadcast join instead of cross join. Thanks!", "author": "yxia92", "createdAt": "2020-07-24T05:37:48Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/joins/CrossJoinIT.java", "diffHunk": "@@ -328,7 +328,8 @@ public void testPickBroadcastEquality() throws Exception {\n                 format(\"explain select count(*) from %s as a inner join %s as b \" +\n                         \"--SPLICE-PROPERTIES useSpark=%s \\n\" +\n                         \" on a.a1 = b.a1\" , s1, s1, useSpark);\n-        rowContainsQuery(6, sqlText,\"Broadcast\", classWatcher);\n+        String expected = useSpark ? \"CrossJoin\" : \"Broadcast\";", "originalCommit": "4b5ec0996be764ec88cafa8d97c6411b36008ab5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkzMjg0OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459932849", "bodyText": "Yes, I debugged into this test and its about the change on outerCost.RemoteCost. Not adding it to the local cost making the total cost of cross join lower.\nI read some articles about Spark broadcast join and cross join today and learned that the broadcast join is actually a hash join. That makes things clear. I was thinking if Spark can choose to broadcast left or right side of a cross join, what's the difference with a broadcast join then...\nI revert the change in crossJoinStrategyLocalCost and this test. Now the optimizer should make the same choice as before.", "author": "ascend1", "createdAt": "2020-07-24T08:58:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5MDk2MA==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r460190960", "bodyText": "Also, it seems after this change: https://github.com/splicemachine/spliceengine/pull/3826/files, UpgradeScriptToInvalidateStoredStatement becomes a default upgrade action.", "author": "ascend1", "createdAt": "2020-07-24T17:28:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwNzc2Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r461007766", "bodyText": "You are right, I forgot about the change of DB-9821 which removes the need to add the upgrade script. Thanks!", "author": "yxia92", "createdAt": "2020-07-27T16:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDI0Ng=="}], "type": "inlineReview"}, {"oid": "568528eadf071583552b76aa2426044ca9df9cb0", "url": "https://github.com/splicemachine/spliceengine/commit/568528eadf071583552b76aa2426044ca9df9cb0", "message": "DB-9579 Fix broadcast decision in cross joins", "committedDate": "2020-07-24T08:50:13Z", "type": "forcePushed"}, {"oid": "fc3e80a52d53224ee8be10e2d47c3afca30f52b7", "url": "https://github.com/splicemachine/spliceengine/commit/fc3e80a52d53224ee8be10e2d47c3afca30f52b7", "message": "DB-9579 Fix broadcast decision in cross joins", "committedDate": "2020-07-24T09:05:00Z", "type": "forcePushed"}, {"oid": "a014d560b86c1c329e24ce291a1ae6b1b65f636f", "url": "https://github.com/splicemachine/spliceengine/commit/a014d560b86c1c329e24ce291a1ae6b1b65f636f", "message": "DB-9579 Fix broadcast decision in cross joins", "committedDate": "2020-07-24T17:25:56Z", "type": "commit"}, {"oid": "a014d560b86c1c329e24ce291a1ae6b1b65f636f", "url": "https://github.com/splicemachine/spliceengine/commit/a014d560b86c1c329e24ce291a1ae6b1b65f636f", "message": "DB-9579 Fix broadcast decision in cross joins", "committedDate": "2020-07-24T17:25:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5NDk4OA==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r464994988", "bodyText": "use try-with-resources here to auto close the resultset", "author": "arnaud-splice", "createdAt": "2020-08-04T11:53:50Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/joins/CrossJoinIT.java", "diffHunk": "@@ -713,5 +713,42 @@ public void testCharTimestampColumnsCrossJoin() throws Exception {\n         rs.close();\n     }\n \n+    @Test\n+    public void testCrossJoinPreserveSortOrderNoJoinStrategyHint() throws Exception {\n+        String sqlText = format(\"select tt2.a from \\n\" +\n+                \"tab2 tt2 --splice-properties useSpark=%s\\n\" +\n+                \"inner join %s ttb\\n\" +\n+                \"on ttb.c2 < 5 and tt2.a < 4 order by tt2.a\", useSpark, bigTable);\n+\n+        if (useSpark) {\n+            ResultSet rs = classWatcher.executeQuery(\"explain \" + sqlText);", "originalCommit": "a014d560b86c1c329e24ce291a1ae6b1b65f636f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwMzU4OA==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r465003588", "bodyText": "Done.", "author": "ascend1", "createdAt": "2020-08-04T12:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5NDk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5NTE1Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r464995156", "bodyText": "same", "author": "arnaud-splice", "createdAt": "2020-08-04T11:54:07Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/joins/CrossJoinIT.java", "diffHunk": "@@ -713,5 +713,42 @@ public void testCharTimestampColumnsCrossJoin() throws Exception {\n         rs.close();\n     }\n \n+    @Test\n+    public void testCrossJoinPreserveSortOrderNoJoinStrategyHint() throws Exception {\n+        String sqlText = format(\"select tt2.a from \\n\" +\n+                \"tab2 tt2 --splice-properties useSpark=%s\\n\" +\n+                \"inner join %s ttb\\n\" +\n+                \"on ttb.c2 < 5 and tt2.a < 4 order by tt2.a\", useSpark, bigTable);\n+\n+        if (useSpark) {\n+            ResultSet rs = classWatcher.executeQuery(\"explain \" + sqlText);\n+            String matchString = TestUtils.FormattedResult.ResultFactory.toStringUnsorted(rs);\n+            assertTrue(\"Cross join is not selected for OLAP\", matchString.contains(\"CrossJoin\"));\n+        }\n \n+        /* DB-9579\n+         * The plan of the query above may or may not have an OrderBy. It depends on optimizer\n+         * implementation and that could change over time. However, correctness should always\n+         * be guaranteed and result must be the same for both OLTP and OLAP.\n+         */\n+        String expected = \"A |\\n\" +\n+                \"----\\n\" +\n+                \" 1 |\\n\" +\n+                \" 1 |\\n\" +\n+                \" 1 |\\n\" +\n+                \" 1 |\\n\" +\n+                \" 2 |\\n\" +\n+                \" 2 |\\n\" +\n+                \" 2 |\\n\" +\n+                \" 2 |\\n\" +\n+                \" 3 |\\n\" +\n+                \" 3 |\\n\" +\n+                \" 3 |\\n\" +\n+                \" 3 |\";\n+\n+        ResultSet rs = classWatcher.executeQuery(sqlText);", "originalCommit": "a014d560b86c1c329e24ce291a1ae6b1b65f636f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwMzY0OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r465003649", "bodyText": "Done.", "author": "ascend1", "createdAt": "2020-08-04T12:10:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5NTE1Ng=="}], "type": "inlineReview"}, {"oid": "2abae8b4b1435ed1b6cb7a2cfcaa311d0ba0fb31", "url": "https://github.com/splicemachine/spliceengine/commit/2abae8b4b1435ed1b6cb7a2cfcaa311d0ba0fb31", "message": "DB-9579 Auto close ResultSet in tests", "committedDate": "2020-08-04T11:59:40Z", "type": "commit"}]}