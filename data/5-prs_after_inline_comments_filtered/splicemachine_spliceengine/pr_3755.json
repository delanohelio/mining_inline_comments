{"pr_number": 3755, "pr_title": "DB-9756 reduce filesystem metadata calls for external tables", "pr_createdAt": "2020-07-02T10:56:14Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3755", "timeline": [{"oid": "d297e88b184c2be25aab618841cf53a48a62ebb8", "url": "https://github.com/splicemachine/spliceengine/commit/d297e88b184c2be25aab618841cf53a48a62ebb8", "message": "DB-9756 reduce filesystem metadata calls for external tables", "committedDate": "2020-07-02T12:31:15Z", "type": "commit"}, {"oid": "d297e88b184c2be25aab618841cf53a48a62ebb8", "url": "https://github.com/splicemachine/spliceengine/commit/d297e88b184c2be25aab618841cf53a48a62ebb8", "message": "DB-9756 reduce filesystem metadata calls for external tables", "committedDate": "2020-07-02T12:31:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4ODg4NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r448988885", "bodyText": "Method names should be lower case", "author": "dgomezferro", "createdAt": "2020-07-02T13:08:58Z", "path": "standalone/src/test/java/com/splicemachine/test/SpliceTestYarnPlatform.java", "diffHunk": "@@ -98,6 +102,35 @@ public void stop() {\n             yarnCluster.stop();\n         }\n     }\n+    // todo: this is the same as SpliceTestPlatform.ConfigureS3( config ),\n+    // but I didn't manage to get dependencies right\n+    private static void ConfigureS3(Configuration config)", "originalCommit": "d297e88b184c2be25aab618841cf53a48a62ebb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3Nzg4Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r449077883", "bodyText": "ok", "author": "martinrupp", "createdAt": "2020-07-02T15:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4ODg4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4OTAwNw==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r448989007", "bodyText": "Method names should be lower case", "author": "dgomezferro", "createdAt": "2020-07-02T13:09:10Z", "path": "platform_it/src/test/java/com/splicemachine/test/SpliceTestPlatformConfig.java", "diffHunk": "@@ -95,6 +100,33 @@\n             SpliceHFileCleaner.class,\n             TimeToLiveHFileCleaner.class);\n \n+    public static void ConfigureS3(Configuration config)", "originalCommit": "d297e88b184c2be25aab618841cf53a48a62ebb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3NzkzMw==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r449077933", "bodyText": "ok", "author": "martinrupp", "createdAt": "2020-07-02T15:19:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4OTAwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk5MDQ5Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r448990497", "bodyText": "Nitpick: explicit variables would be better IMHO (e.g. length / fileCount / dirCount)", "author": "dgomezferro", "createdAt": "2020-07-02T13:11:25Z", "path": "hbase_storage/src/main/java/com/splicemachine/storage/HNIOFileSystem.java", "diffHunk": "@@ -187,58 +172,62 @@ public void concat(Path target, Path... sources)  throws IOException {\n         return new org.apache.hadoop.fs.Path(path.toUri());\n     }\n \n-\n     private class HFileInfo implements FileInfo{\n-        private final boolean isDir;\n-        private final AclStatus aclStatus;\n-        private final boolean isReadable;\n-        private final boolean isWritable;\n         private org.apache.hadoop.fs.Path path;\n-        private ContentSummary contentSummary;\n+        FileStatus fileStatus;\n+        private ContentSummary contentSummary = null; // calculate on demand\n \n-        public HFileInfo(org.apache.hadoop.fs.Path path,ContentSummary contentSummary) throws IOException{\n+        public HFileInfo(org.apache.hadoop.fs.Path path) throws IOException{\n             this.path=path;\n-            this.contentSummary=contentSummary;\n-            this.isDir = fs.isDirectory(path);\n-            AclStatus aclS;\n-            try{\n-                aclS=fs.getAclStatus(path);\n-            } catch (UnsupportedOperationException | AclException e) { // Runtime Exception for RawFS\n-                aclS = new AclStatus.Builder().owner(\"unknown\").group(\"unknown\").build();\n-            } catch(Exception e){\n-                e = exceptionFactory.processRemoteException(e); //strip any multi-retry errors out\n-                //noinspection ConstantConditions\n-                if(e instanceof UnsupportedOperationException|| e instanceof AclException){\n-                    /*\n-                     * Some Filesystems don't support aclStatus. In that case,\n-                     * we replace it with our own ACL status object\n-                     */\n-                    aclS=new AclStatus.Builder().owner(\"unknown\").group(\"unknown\").build();\n-                }else{\n-                    /*\n-                     * the remaining errors are of the category of FileNotFound,UnresolvedPath,\n-                     * etc. These are environmental, so we should throw up here.\n-                     */\n-                    throw new IOException(e);\n-                }\n-            }\n-            this.aclStatus = aclS;\n-            boolean readable;\n-            try{\n-                fs.access(path,FsAction.READ);\n-                readable= true;\n-            }catch(IOException ioe){\n-               readable = false;\n+            try {\n+                this.fileStatus = fs.getFileStatus(path);\n+            } catch( FileNotFoundException e )\n+            {\n+                this.fileStatus = null;\n             }\n-            boolean writable;\n-            try{\n-                fs.access(path,FsAction.WRITE);\n-                writable = true;\n-            }catch(IOException ioe){\n-                writable = false;\n+        }\n+\n+        // these two methods are to avoid having to re-calculate the list of files in the directory\n+        // for isEmptyDirectory\n+        // todo(martinrupp): replace with recursive listdir\n+        private FileStatus rootFileStatusArr[];\n+        private FileStatus[] listRoot() throws IOException {\n+            if (rootFileStatusArr != null || !exists() || !fileStatus.isDirectory()) return rootFileStatusArr;\n+            rootFileStatusArr = fs.listStatus(path);\n+            return rootFileStatusArr;\n+        }\n+        // note this is expensive for deeply nested directories. avoid calling fileCount, spaceConsumed and size\n+        // partly copied FileSystem.getContentSummary , however with cached fileStatus and using (cached) listRoot for listing root.\n+        private ContentSummary getContentSummary() {\n+            if( contentSummary != null ) return contentSummary;\n+            try {\n+                if (fileStatus.isFile()) {\n+                    // f is a file\n+                    long length = fileStatus.getLen();\n+                    contentSummary = new ContentSummary.Builder().length(length).\n+                            fileCount(1).directoryCount(0).spaceConsumed(length).build();\n+                }\n+                else {\n+                    // f is a directory\n+                    long[] summary = {0, 0, 1};", "originalCommit": "d297e88b184c2be25aab618841cf53a48a62ebb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA2ODE5NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r449068195", "bodyText": "this is copied from FileSystem.java, will fix.", "author": "martinrupp", "createdAt": "2020-07-02T15:05:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk5MDQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk5MTY2OA==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r448991668", "bodyText": "If this shouldn't happen then it would make sense to bubble up the exception. We should log it at the very least", "author": "dgomezferro", "createdAt": "2020-07-02T13:13:18Z", "path": "hbase_storage/src/main/java/com/splicemachine/storage/HNIOFileSystem.java", "diffHunk": "@@ -253,64 +242,87 @@ public String fullPath(){\n \n         @Override\n         public boolean isDirectory(){\n-            return isDir;\n+            return fileStatus != null && fileStatus.isDirectory();\n         }\n \n         @Override\n         public long fileCount(){\n-            return contentSummary.getFileCount();\n+            if( !exists() ) return 0;\n+            return getContentSummary().getFileCount();\n+        }\n+\n+        @Override\n+        public boolean isEmptyDirectory() {\n+            if( !exists() ) return false;\n+            if( !isDirectory() ) return false;\n+            try {\n+                for (FileStatus s : listRoot() ) {\n+                    if (s.getPath().getName().equals(\"_SUCCESS\") || s.getPath().getName().equals(\"_SUCCESS.crc\") ) continue;\n+                    return false;\n+                }\n+                return true;\n+            } catch( Exception e ) {\n+                // this shouldn't happen, as we already check if it exists.", "originalCommit": "d297e88b184c2be25aab618841cf53a48a62ebb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA2ODk2MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r449068961", "bodyText": "done", "author": "martinrupp", "createdAt": "2020-07-02T15:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk5MTY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk5NDkxMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r448994911", "bodyText": "This should probably be a javadoc comment, you need /** */ for that", "author": "dgomezferro", "createdAt": "2020-07-02T13:18:10Z", "path": "splice_access_api/src/main/java/com/splicemachine/access/api/FileInfo.java", "diffHunk": "@@ -26,21 +26,33 @@\n \n     boolean isDirectory();\n \n+    /// returns true if isDirectory() and (directory is empty or only contains one file _SUCCESS)", "originalCommit": "d297e88b184c2be25aab618841cf53a48a62ebb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3NzI0OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r449077249", "bodyText": "ok", "author": "martinrupp", "createdAt": "2020-07-02T15:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk5NDkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk5NDk5NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r448994995", "bodyText": "Make it javadoc", "author": "dgomezferro", "createdAt": "2020-07-02T13:18:18Z", "path": "splice_access_api/src/main/java/com/splicemachine/access/api/FileInfo.java", "diffHunk": "@@ -26,21 +26,33 @@\n \n     boolean isDirectory();\n \n+    /// returns true if isDirectory() and (directory is empty or only contains one file _SUCCESS)\n+    boolean isEmptyDirectory();\n+\n     /**\n      * @return the number of files in the directory, or 1 if this is a file.\n+     * Note: this is SLOW on big directory trees when using remote filesystems like S3,\n+     * since requiring a full recursive listdir\n+     * If just need to check for empty directory, use {@link #isEmptyDirectory()}\n      */\n     long fileCount();\n \n+\n     /**\n      * Returns the overall space consumed for the file.\n      * Depends on the file system. For HDFS, this would return\n      * not the current size of the file but rather\n      * current size * replication factor. For a local system,\n      * it would return the same value as {@link #size()},\n      * the actual current size of the file.\n+     * Note: this is SLOW on big directory trees when using remote filesystems like S3,\n+     * since requiring a full recursive listdir\n      */\n     long spaceConsumed();\n \n+    /* Note: this is SLOW on big directory trees when using remote filesystems like S3,", "originalCommit": "d297e88b184c2be25aab618841cf53a48a62ebb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3NzMyOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r449077329", "bodyText": "ok", "author": "martinrupp", "createdAt": "2020-07-02T15:18:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk5NDk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk5NjgzMw==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r448996833", "bodyText": "This looks very broad to me. Is there an expected exception we want to catch here? I think in most cases we'd need to bubble up the exception or return a nicer error.", "author": "dgomezferro", "createdAt": "2020-07-02T13:21:18Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/stream/utils/ExternalTableUtils.java", "diffHunk": "@@ -261,16 +262,25 @@ public static void preSortColumns(StructField[] schema, int[] partitionColumnMap\n     }\n \n     public static boolean isEmptyDirectory(String location) throws Exception {\n-        String[] files = ImportUtils.getFileSystem(location).getExistingFiles(location, \"*\");\n-        return ((files.length == 0) || (files.length == 1 && \"_SUCCESS\".equals(truncateFileNameFromFullPath(files[0]))));\n-\n+        DistributedFileSystem dfs = ImportUtils.getFileSystem(location);\n+        return dfs.getInfo(location).isEmptyDirectory();\n     }\n \n     public static boolean isExisting(String location) throws Exception {\n         FileInfo fileInfo = ImportUtils.getFileSystem(location).getInfo(location);\n-        return  fileInfo.exists();\n+        return fileInfo.exists();\n \n     }\n+    public static FileInfo getFileInfoOrNull(String location)\n+    {\n+        try {\n+            return ImportUtils.getFileSystem(location).getInfo(location);\n+        }\n+        catch( StandardException | IOException e )\n+        {\n+            return null;", "originalCommit": "d297e88b184c2be25aab618841cf53a48a62ebb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3NjYwMg==", "url": "https://github.com/splicemachine/spliceengine/pull/3755#discussion_r449076602", "bodyText": "ok. i saw there's ImportUtils.getImportFileInfo , and we can use FileInfo.exist() to check for existance, so i removed this function", "author": "martinrupp", "createdAt": "2020-07-02T15:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk5NjgzMw=="}], "type": "inlineReview"}, {"oid": "3e16a5c7c152024a7c307296a52bc4dd1a12a1b9", "url": "https://github.com/splicemachine/spliceengine/commit/3e16a5c7c152024a7c307296a52bc4dd1a12a1b9", "message": "DB-9756 fix spotbugs: remove DistributedFileSystem.concat (not used)", "committedDate": "2020-07-02T14:53:42Z", "type": "commit"}, {"oid": "bf1de0630591f22f4186fdeea617b585876b418d", "url": "https://github.com/splicemachine/spliceengine/commit/bf1de0630591f22f4186fdeea617b585876b418d", "message": "DB-9756 address code review", "committedDate": "2020-07-02T16:32:20Z", "type": "commit"}]}