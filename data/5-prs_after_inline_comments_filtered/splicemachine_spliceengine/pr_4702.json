{"pr_number": 4702, "pr_title": "DB-10562 Refactor SpliceTransactionResourceImpl.marshallTransaction", "pr_createdAt": "2020-11-25T12:01:56Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4702", "timeline": [{"oid": "a4edcec903dff42c9ac08fb3b9888d1640bbeb30", "url": "https://github.com/splicemachine/spliceengine/commit/a4edcec903dff42c9ac08fb3b9888d1640bbeb30", "message": "Revert \"Revert \"DB-10562 Refactor SpliceTransactionResourceImpl.getMarshallTransaction  (#4350)\" (#4469)\"\n\nThis reverts commit 0d026d65796e756acb893c38275fce0872c70da5.", "committedDate": "2020-11-25T11:53:48Z", "type": "commit"}, {"oid": "b873f31f25131d1a185fc820af61b3d7363cdac6", "url": "https://github.com/splicemachine/spliceengine/commit/b873f31f25131d1a185fc820af61b3d7363cdac6", "message": "Merge remote-tracking branch 'origin/master' into DB-10562-2", "committedDate": "2020-11-26T10:15:39Z", "type": "commit"}, {"oid": "75f6739cbc5a764990f3e6d072e55a6e3d2ac1fe", "url": "https://github.com/splicemachine/spliceengine/commit/75f6739cbc5a764990f3e6d072e55a6e3d2ac1fe", "message": "Merge remote-tracking branch 'origin/master' into DB-10562-2", "committedDate": "2020-11-29T21:38:08Z", "type": "commit"}, {"oid": "b29fd85af800c51deb7ae18cc7535c5945ca52bc", "url": "https://github.com/splicemachine/spliceengine/commit/b29fd85af800c51deb7ae18cc7535c5945ca52bc", "message": "Merge remote-tracking branch 'origin/master' into DB-10562-2", "committedDate": "2020-12-04T18:18:55Z", "type": "commit"}, {"oid": "6395b93f964cb0836932c9646c2a83e83dffc462", "url": "https://github.com/splicemachine/spliceengine/commit/6395b93f964cb0836932c9646c2a83e83dffc462", "message": "Merge remote-tracking branch 'origin/master' into DB-10562-2", "committedDate": "2020-12-09T15:12:35Z", "type": "commit"}, {"oid": "3495bfe9982be6a67b6283990e5ab424fd4b782f", "url": "https://github.com/splicemachine/spliceengine/commit/3495bfe9982be6a67b6283990e5ab424fd4b782f", "message": "DB-10562 Invalidate remote caches before dropping schema", "committedDate": "2020-12-10T12:10:24Z", "type": "commit"}, {"oid": "3495bfe9982be6a67b6283990e5ab424fd4b782f", "url": "https://github.com/splicemachine/spliceengine/commit/3495bfe9982be6a67b6283990e5ab424fd4b782f", "message": "DB-10562 Invalidate remote caches before dropping schema", "committedDate": "2020-12-10T12:10:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY5NjMwNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4702#discussion_r543696306", "bodyText": "prepared is not the right condition here. Should be updated.\nIf close() is called from the catch block above (l.129) ContextManager is not reset/removed as prepared = false => memory leak.", "author": "OlegMazurov", "createdAt": "2020-12-15T21:24:05Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/jdbc/SpliceTransactionResourceImpl.java", "diffHunk": "@@ -124,8 +133,11 @@ public boolean marshallTransaction(TxnView txn, ManagedCache<String, Optional<St\n \n \n     public void close(){\n-        csf.resetCurrentContextManager(cm);\n-        csf.removeContextManager(cm);\n+        if (prepared) {", "originalCommit": "3495bfe9982be6a67b6283990e5ab424fd4b782f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM0NjQxMg==", "url": "https://github.com/splicemachine/spliceengine/pull/4702#discussion_r544346412", "bodyText": "Very good point, thanks!", "author": "arnaud-splice", "createdAt": "2020-12-16T14:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY5NjMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ2NDcyOA==", "url": "https://github.com/splicemachine/spliceengine/pull/4702#discussion_r544464728", "bodyText": "It's rather cosmetic now but instead of having prepared you could just check for cm == null (and enforce that in close()).", "author": "OlegMazurov", "createdAt": "2020-12-16T16:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY5NjMwNg=="}], "type": "inlineReview"}, {"oid": "26da54453ee9a0dff1e55b8ce52bcba49bbb05da", "url": "https://github.com/splicemachine/spliceengine/commit/26da54453ee9a0dff1e55b8ce52bcba49bbb05da", "message": "DB-10562 Address comment", "committedDate": "2020-12-16T14:35:05Z", "type": "commit"}]}