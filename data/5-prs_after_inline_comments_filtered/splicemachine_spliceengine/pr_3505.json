{"pr_number": 3505, "pr_title": "DB-9109 fix jenkins problem with testCollectStats", "pr_createdAt": "2020-04-30T15:01:09Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3505", "timeline": [{"oid": "45615da9db98f6271c81f5db21f3367f79feb52a", "url": "https://github.com/splicemachine/spliceengine/commit/45615da9db98f6271c81f5db21f3367f79feb52a", "message": "DB-9109 fix jenkins problem with testCollectStats\n\nin the previous version the temporary directory gets deleted after every test,\nhowever the table gets only deleted after the whole class shuts down,\nso e.g. analyze schema fails as it can't access those tables anymore\n\nwhat will happen now:\n- before instantiating a test class like, e.g. ExternalTableIT would go to /platform_it/target/external + /SCHEMA_NAME,\ne.g. /platform_it/target/external/EXTERNALTABLEIT, wipe that directory (with @BeforeClass)\n- we then run all tests, create external tables in that subdirectory (e.g. .../external/EXTNERALTABLEIT/avro_simple_file_test etc.)\n- at the end of the whole class @AfterClass, delete the temporary directory (target/external/EXTERNALTABLEIT), but not all of target/external\n\nwith this\n- allows parallel runs of ExternalTableIT while running ExternalTablePartitionIT\n- temporary files are delete when running normally\n- even if VM crashes or similar, the directory will be cleaned the next time, reducing trash on developers system", "committedDate": "2020-04-30T14:56:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4Njc2NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3505#discussion_r418086765", "bodyText": "Can you add these methods to SpliceUnitTest ?\nIf you don't want to create a temp directory for every class even if it doesn't use it we can create the directory on demand in getExternalResourceDirectory() (if not already created) and remove it if exists in deleteTempDirectory", "author": "dgomezferro", "createdAt": "2020-04-30T15:14:44Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/utils/ShowCreateTableIT.java", "diffHunk": "@@ -101,6 +102,26 @@ public static void cleanup()\n         classWatcher.closeAll();\n     }\n \n+    static File tempDir;\n+\n+    @BeforeClass\n+    public static void createTempDirectory() throws Exception", "originalCommit": "45615da9db98f6271c81f5db21f3367f79feb52a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzODEzNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3505#discussion_r418138135", "bodyText": "I know this looks like copied code but putting this in SpliceUnitTest would prevent ExternalTableIT, ExternalTablePartitionIT to run parallel:\nSince static File tempDir is static, it is shared by all instantiations of SpliceUnitTest, especially between ExternalTableIT, ExternalTablePartitionIT, etc. . However, @afterclass is called after ExternalTableIT is done, then would delete the (shared) tempDir, which might be still used by ExternalTablePartitionIT when running in parallel.\nSo static File tempDir can be static, but static in ExternalTableIT, so that it is not shared with the one in ExternalTablePartitionIT . Another solution would be to have a TestWatcher.", "author": "martinrupp", "createdAt": "2020-04-30T16:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4Njc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4NTg2Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/3505#discussion_r418185866", "bodyText": "Hadn't thought of that, makes sense. Thanks!", "author": "dgomezferro", "createdAt": "2020-04-30T17:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4Njc2NQ=="}], "type": "inlineReview"}]}