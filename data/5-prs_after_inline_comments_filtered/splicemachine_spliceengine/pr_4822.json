{"pr_number": 4822, "pr_title": "DB-10728 Fix maxExecutorCores calculation on clusters.", "pr_createdAt": "2020-12-10T07:40:31Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4822", "timeline": [{"oid": "61e1f19c1795edf66de01e5a7b4cd50b1a00a758", "url": "https://github.com/splicemachine/spliceengine/commit/61e1f19c1795edf66de01e5a7b4cd50b1a00a758", "message": "DB-10728 Fix maxExecutorCores calculation on clusters.", "committedDate": "2020-12-10T07:36:04Z", "type": "commit"}, {"oid": "f2d97817d4f512072883c924bcf9402baa303107", "url": "https://github.com/splicemachine/spliceengine/commit/f2d97817d4f512072883c924bcf9402baa303107", "message": "DB-10728 Remove dependency on cedarsoftware DeepEquals.", "committedDate": "2020-12-16T02:17:58Z", "type": "commit"}, {"oid": "3302cbdeffe8e07ad432887b51e7fecc1d78ff10", "url": "https://github.com/splicemachine/spliceengine/commit/3302cbdeffe8e07ad432887b51e7fecc1d78ff10", "message": "DB-10728 Fix Spotbugs", "committedDate": "2020-12-16T05:19:13Z", "type": "commit"}, {"oid": "94546d92d1d082d0b604bf430476c1f0955863db", "url": "https://github.com/splicemachine/spliceengine/commit/94546d92d1d082d0b604bf430476c1f0955863db", "message": "DB-10728 Fix Spotbugs, take 2.", "committedDate": "2020-12-16T05:24:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NDg4NA==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545844884", "bodyText": "I think this is not used, remove if so", "author": "dgomezferro", "createdAt": "2020-12-18T13:54:50Z", "path": "hbase_sql/src/main/java/com/splicemachine/derby/lifecycle/HEngineSqlEnv.java", "diffHunk": "@@ -68,6 +71,8 @@\n     // numNodes is written to zookeeper by OlapServerMaster, so we have\n     // to wait until the Olap Server comes up before getting numNodes from zookeeper.\n     private static int MAX_EXECUTOR_CORES = -1;\n+    // A value to use until the Olap Server comes up.\n+    private static int DEFAULT_MAX_EXECUTOR_CORES = 8;\n     private static int numSparkNodes = -1;", "originalCommit": "94546d92d1d082d0b604bf430476c1f0955863db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg5ODg5OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545898899", "bodyText": "This is needed.  I ran into problems if I made getMaxExecutorCores non-retryable.  If we call it now before ZK data is there we can use the default.", "author": "msirek", "createdAt": "2020-12-18T15:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NDg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkwNzcyNw==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545907727", "bodyText": "I meant the numSparkNodes field, I believe it's only written to but never used. Sorry for not being clear, I can see how my message was confusing!", "author": "dgomezferro", "createdAt": "2020-12-18T15:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NDg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkzMTQ5MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545931490", "bodyText": "I see.  It might actually help for debugging to have a static field that tells us how many spark nodes there are (or how many we think there are), so if you don't mind I'd like to leave it in for now.", "author": "msirek", "createdAt": "2020-12-18T16:05:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NDg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0OTgxMA==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545949810", "bodyText": "Ok", "author": "dgomezferro", "createdAt": "2020-12-18T16:35:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NDg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NTc3MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545845770", "bodyText": "I'd rather have this function in OlapServerMaster or a class logically close to the OlapServer, I think this class shouldn't have that much knowledge about YARN. Ideally we should just read the number of executor cores from Zookeeper.", "author": "dgomezferro", "createdAt": "2020-12-18T13:56:21Z", "path": "hbase_sql/src/main/java/com/splicemachine/derby/lifecycle/HEngineSqlEnv.java", "diffHunk": "@@ -265,21 +270,38 @@ public int getMaxExecutorCores() {\n         if (MAX_EXECUTOR_CORES != -1)\n             return MAX_EXECUTOR_CORES;\n         synchronized (HEngineSqlEnv.class) {\n-            int sparkNodes = getNumSparkNodes();\n+            byte [] sparkYarnConfigBytes = getSparkYarnConfigBytes();\n+            if (sparkYarnConfigBytes == null)\n+                return DEFAULT_MAX_EXECUTOR_CORES;\n+\n+            SparkYarnConfiguration conf = null;\n+            try {\n+                ByteArrayInputStream bis = new ByteArrayInputStream(sparkYarnConfigBytes);\n+                ObjectInput in = new ObjectInputStream(bis);\n+                conf = (SparkYarnConfiguration) in.readObject();\n+            }\n+            catch (Exception e) {\n+                return DEFAULT_MAX_EXECUTOR_CORES;\n+            }\n+            if (conf == null)\n+                return DEFAULT_MAX_EXECUTOR_CORES;\n+\n             int maxExecutorCores =\n-              calculateMaxExecutorCores(HConfiguration.unwrapDelegate().get(\"yarn.nodemanager.resource.memory-mb\"),\n-                                        getProperty(\"splice.spark.dynamicAllocation.enabled\"),\n-                                        getProperty(\"splice.spark.executor.instances\"),\n-                                        getProperty(\"splice.spark.executor.cores\"),\n-                                        getProperty(\"splice.spark.executor.memory\"),\n-                                        getProperty(\"splice.spark.dynamicAllocation.maxExecutors\"),\n-                                        getProperty(\"splice.spark.executor.memoryOverhead\"),\n-                                        getProperty(\"splice.spark.yarn.executor.memoryOverhead\"),\n-                                        sparkNodes > 0 ? sparkNodes : 1);\n-            if (sparkNodes > 0) {\n-                numSparkNodes = sparkNodes;\n+              calculateMaxExecutorCores(conf.getYarnNodemanagerResourceMemoryMB(),", "originalCommit": "94546d92d1d082d0b604bf430476c1f0955863db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg5OTIwOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545899209", "bodyText": "OK, I moved the calculation to OlapServerMaster.", "author": "msirek", "createdAt": "2020-12-18T15:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NTc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NjAxNw==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545846017", "bodyText": "If it's not a lot of work make this a Protobuf message for future extendability.", "author": "dgomezferro", "createdAt": "2020-12-18T13:56:50Z", "path": "hbase_sql/src/main/java/com/splicemachine/derby/lifecycle/HEngineSqlEnv.java", "diffHunk": "@@ -78,22 +83,22 @@\n     private OlapClient olapClient;\n     private OperationManager operationManager;\n     private ZkServiceDiscovery serviceDiscovery;\n-    private static final String sparkNumNodesZkPath =\n-            HConfiguration.getConfiguration().getSpliceRootPath() + SPARK_NUM_NODES_PATH;\n+    private static final String sparkYarnConfigZkPath =\n+            HConfiguration.getConfiguration().getSpliceRootPath() + SPARK_YARN_CONFIG_PATH;\n \n \n-    // Find the number of nodes on which Spark executors can be run.\n-    private static int getNumSparkNodes() {\n-        int numNodes = -1;\n+    // Find the Spark and YARN configuration from Zookeeper.\n+    private static byte [] getSparkYarnConfigBytes() {\n+        byte [] returnData = null;\n         try {\n-            byte [] data = ZkUtils.getData(sparkNumNodesZkPath);\n+            byte [] data = ZkUtils.getData(sparkYarnConfigZkPath);", "originalCommit": "94546d92d1d082d0b604bf430476c1f0955863db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkwMDcyNA==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545900724", "bodyText": "This is an ephemeral ZK field, so we don't need to be backwards compatible.  It goes away every time zookeeper reboots.  Would it matter to use protobuf?", "author": "msirek", "createdAt": "2020-12-18T15:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NjAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkxMDU1NA==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545910554", "bodyText": "I created https://splicemachine.atlassian.net/browse/DB-11068 to change all messages in OlapServerMaster. It could matter for online upgrade.", "author": "dgomezferro", "createdAt": "2020-12-18T15:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NjAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0NTg0NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r546145845", "bodyText": "OK, we can handle it through the Jira.", "author": "msirek", "createdAt": "2020-12-18T23:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NjAxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NjUxNA==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545846514", "bodyText": "If we compute the number of cores in OlapServerMaster (or close by) I don't think we need this class anymore", "author": "dgomezferro", "createdAt": "2020-12-18T13:57:42Z", "path": "hbase_storage/src/main/java/com/splicemachine/access/SparkYarnConfiguration.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.splicemachine.access;\n+\n+import java.io.*;\n+\n+/**\n+ * A serializable class for storing YARN and Spark properties in Zookeeper.\n+ *\n+ */\n+public class SparkYarnConfiguration implements Externalizable {", "originalCommit": "94546d92d1d082d0b604bf430476c1f0955863db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkwMDgzOA==", "url": "https://github.com/splicemachine/spliceengine/pull/4822#discussion_r545900838", "bodyText": "Yes, it is removed.", "author": "msirek", "createdAt": "2020-12-18T15:15:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0NjUxNA=="}], "type": "inlineReview"}, {"oid": "40e50e5b26610891d22c088f3114ef9233533034", "url": "https://github.com/splicemachine/spliceengine/commit/40e50e5b26610891d22c088f3114ef9233533034", "message": "DB-10728 Move maxExecutorCores calculation to OlapServerMaster.", "committedDate": "2020-12-18T15:05:48Z", "type": "commit"}, {"oid": "fbed83f6313b513ba011bff6db7430134e3fe574", "url": "https://github.com/splicemachine/spliceengine/commit/fbed83f6313b513ba011bff6db7430134e3fe574", "message": "Merge branch 'master' into DB-10728", "committedDate": "2020-12-18T16:29:07Z", "type": "commit"}]}