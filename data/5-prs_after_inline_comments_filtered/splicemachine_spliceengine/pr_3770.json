{"pr_number": 3770, "pr_title": "DB-9764 Add IF NOT EXISTS option to CREATE TABLE statement", "pr_createdAt": "2020-07-06T15:40:30Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3770", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyNDcwMw==", "url": "https://github.com/splicemachine/spliceengine/pull/3770#discussion_r450724703", "bodyText": "Why do we need this?", "author": "dgomezferro", "createdAt": "2020-07-07T09:17:17Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/conn/GenericLanguageConnectionContext.java", "diffHunk": "@@ -1333,6 +1333,10 @@ public void removeStatement(GenericStatement statement) throws StandardException\n     public PreparedStatement lookupStatement(GenericStatement statement) throws StandardException{\n         GenericStorablePreparedStatement ps = getDataDictionary().getDataDictionaryCache().statementCacheFind(statement);\n         if (ps==null) {\n+            String sqlText = statement.getSource().toUpperCase();\n+            if ((sqlText.startsWith(\"CREATE\") || sqlText.startsWith(\"DECLARE\")) && sqlText.contains(\"IF NOT EXISTS\")){\n+                return null;\n+            }", "originalCommit": "45b1f4143db7aec0d39eece647b9bafb7f77882c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk4NjA4Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/3770#discussion_r450986083", "bodyText": "CREATE TABLE statements are cached if they have run through once. So if we run CREATE TABLE IF NOT EXISTS T ... twice, the second execution will bypass all checks in bind phase, including the newly added \"if not exists\" check. As a result, the execution returns an error. That should not be the case when \"if not exists\" presents.\nIt seems that CREATE SCHEMA statement is never cached, that's why \"if not exists\" works just fine there.\nAn alternative would be to pass this createBehavior all the way down to the engine and check there. Not sure that's a better way, though.", "author": "ascend1", "createdAt": "2020-07-07T16:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyNDcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyNjMyOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3770#discussion_r452126329", "bodyText": "I just found that it's better to remove the hack in statement cache and add the check in its constant action. Will improve it with a new commit.", "author": "ascend1", "createdAt": "2020-07-09T10:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyNDcwMw=="}], "type": "inlineReview"}, {"oid": "79c1dab964d15564bf6d0e84b6e0e2e72d492ff1", "url": "https://github.com/splicemachine/spliceengine/commit/79c1dab964d15564bf6d0e84b6e0e2e72d492ff1", "message": "DB-9764 Add IF NOT EXISTS option to CREATE TABLE statement", "committedDate": "2020-07-16T17:05:26Z", "type": "commit"}, {"oid": "79c1dab964d15564bf6d0e84b6e0e2e72d492ff1", "url": "https://github.com/splicemachine/spliceengine/commit/79c1dab964d15564bf6d0e84b6e0e2e72d492ff1", "message": "DB-9764 Add IF NOT EXISTS option to CREATE TABLE statement", "committedDate": "2020-07-16T17:05:26Z", "type": "forcePushed"}]}