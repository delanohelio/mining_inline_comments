{"pr_number": 11362, "pr_title": "Make ROMClass walkers in DDR and VM consistent", "pr_createdAt": "2020-12-03T23:05:20Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11362", "timeline": [{"oid": "ff7e35533ffdd4b3a35ce62c04cb180e0d836231", "url": "https://github.com/eclipse-openj9/openj9/commit/ff7e35533ffdd4b3a35ce62c04cb180e0d836231", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>", "committedDate": "2020-12-03T23:26:10Z", "type": "forcePushed"}, {"oid": "23e2ca0c06221110f44edc2e772a7d3946e836b4", "url": "https://github.com/eclipse-openj9/openj9/commit/23e2ca0c06221110f44edc2e772a7d3946e836b4", "message": "Fix slot type for method parameter name in DDR ROMClass walker\n\nHandle method parameter names as UTF8 strings rather than raw SRPs.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>", "committedDate": "2021-01-20T21:47:45Z", "type": "commit"}, {"oid": "d474a449a6b198b782cb5d1ff1b3c42f661d1b2f", "url": "https://github.com/eclipse-openj9/openj9/commit/d474a449a6b198b782cb5d1ff1b3c42f661d1b2f", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>", "committedDate": "2021-01-20T21:47:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTk1NDA0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r561954042", "bodyText": "These address calculations are wrong for older core files (e.g. there's no nameSrp field to skip past).\nThis will require an update to VM_LOCAL_VARIABLE_TABLE_VERSION so we can interpret new and old core files correctly: #11330 should not have been merged without that.", "author": "keithc-ca", "createdAt": "2021-01-21T15:07:20Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/walkers/LocalVariableTableIterator.java", "diffHunk": "@@ -139,16 +142,21 @@ public LocalVariableTable next() {\n \t\t\t\t} else {\n \t\t\t\t\treturn null;\n \t\t\t\t}\n+\n+\t\t\t\tnameSrp = SelfRelativePointer.cast(localVariableTablePtr);\n \t\t\t\tname = J9UTF8Pointer.cast(SelfRelativePointer.cast(localVariableTablePtr).get());\n \t\t\t\tlocalVariableTablePtr = localVariableTablePtr.add(SelfRelativePointer.SIZEOF);\n-\t\t\t\t\n+\n+\t\t\t\tsignatureSrp = SelfRelativePointer.cast(localVariableTablePtr);\n \t\t\t\tsignature = J9UTF8Pointer.cast(SelfRelativePointer.cast(localVariableTablePtr).get());\n \t\t\t\tlocalVariableTablePtr = localVariableTablePtr.add(SelfRelativePointer.SIZEOF);", "originalCommit": "d474a449a6b198b782cb5d1ff1b3c42f661d1b2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjE0NzQ2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r562147462", "bodyText": "#11330 did not change the format of the local variable table. It only changed the J9VariableInfoValues struct that is used in the iterator API in the VM. As far as I can tell, DDR does not read this struct anywhere. This PR only changes the way the local variable table is iterated (mirroring the changes in #11330), but it assumes the same format of the underlying data.", "author": "AlexeyKhrabrov", "createdAt": "2021-01-21T19:37:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTk1NDA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgxMzEyOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r563813129", "bodyText": "Ok, I take back my comment about bad address calculations.\nWhat is the point of the extra interpretations of the existing fields?\nWhy does LocalVariableTable need two copies each of 'name', 'signature' and 'genericSignature'?\nIf the old behavior is still acceptable for J9BCUtil, why does RomClassWalker need the new interpretations?\nWhy the duplication in #11330?", "author": "keithc-ca", "createdAt": "2021-01-25T15:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTk1NDA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzg3MDcxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r563870713", "bodyText": "The reason for the change in #11330 was the need to visit the SRPs to strings in method debug info rather than the strings that they point to, in order to update these SRPs in the serialized ROMClass (serialization basically un-interns all the strings that a ROMClass refers to). The only purpose of this PR is to make the two implementations (in the VM and in DDR) consistent, as was suggested in #11330 reviews.", "author": "AlexeyKhrabrov", "createdAt": "2021-01-25T16:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTk1NDA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTk2MzgzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r561963838", "bodyText": "The string literals should correspond to the structure field names (i.e. \"name\" & \"signature\").", "author": "keithc-ca", "createdAt": "2021-01-21T15:19:30Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -1054,10 +1055,10 @@ long allSlotsInMethodDebugInfoDo(U32Pointer cursor) throws CorruptDataException\n \t\t\t\tLocalVariableTable values = variableInfoValuesIterator.next();\n \n \t\t\t\t// Need to walk the name and signature to add them to the UTF8 section\n-\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_UTF8, values.getName(), \"name\");\n-\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_UTF8, values.getSignature(), \"getSignature\");\n+\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, values.getNameSrp(), \"variableName\");\n+\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, values.getSignatureSrp(), \"variableSignature\");", "originalCommit": "d474a449a6b198b782cb5d1ff1b3c42f661d1b2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjE0ODAxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r562148016", "bodyText": "Done.", "author": "AlexeyKhrabrov", "createdAt": "2021-01-21T19:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTk2MzgzOA=="}], "type": "inlineReview"}, {"oid": "adbc5aa027ce6aebd657d7d488bad647b15b8119", "url": "https://github.com/eclipse-openj9/openj9/commit/adbc5aa027ce6aebd657d7d488bad647b15b8119", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>", "committedDate": "2021-01-21T19:35:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDYwNzY0Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r564607647", "bodyText": "This can now be simplified:\nname = J9UTF8Pointer.cast(nameSrp.get());\n\nLikewise, for signature and genericSignature.", "author": "keithc-ca", "createdAt": "2021-01-26T15:36:59Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/walkers/LocalVariableTableIterator.java", "diffHunk": "@@ -139,16 +142,21 @@ public LocalVariableTable next() {\n \t\t\t\t} else {\n \t\t\t\t\treturn null;\n \t\t\t\t}\n+\n+\t\t\t\tnameSrp = SelfRelativePointer.cast(localVariableTablePtr);\n \t\t\t\tname = J9UTF8Pointer.cast(SelfRelativePointer.cast(localVariableTablePtr).get());", "originalCommit": "adbc5aa027ce6aebd657d7d488bad647b15b8119", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjM5ODMyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r566398327", "bodyText": "Done.", "author": "AlexeyKhrabrov", "createdAt": "2021-01-28T20:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDYwNzY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDYxNjc2OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r564616768", "bodyText": "I think this should use J9_UTF8 to benefit from the extra sanity checking in LinearDumper.java.", "author": "keithc-ca", "createdAt": "2021-01-26T15:47:47Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -297,38 +297,38 @@ private J9ROMMethodPointer allSlotsInROMMethodDo(J9ROMMethodPointer method) thro\n \n \t\treturn J9ROMMethodPointer.cast(cursor);\n \t}\n-\t\n+\n \tprivate long allSlotsInMethodParametersDataDo(U32Pointer cursor) throws CorruptDataException\n \t{\n \t\tJ9MethodParametersDataPointer methodParametersData = J9MethodParametersDataPointer.cast(cursor);\n \t\tJ9MethodParameterPointer parameters = methodParametersData.parameters();\n \t\tlong methodParametersSize = ROMHelp.J9_METHOD_PARAMS_SIZE_FROM_NUMBER_OF_PARAMS(methodParametersData.parameterCount().longValue());\n \t\tlong padding = U32.SIZEOF - (methodParametersSize % U32.SIZEOF);\n \t\tlong size = 0;\n-\t\t\n+\n \t\tif (padding == U32.SIZEOF) {\n \t\t\tpadding = 0;\n \t\t}\n-\t\t\n+\n \t\tsize = methodParametersSize + padding;\n-\t\t\n+\n \t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_SRP, methodParametersData.parameterCountEA(), \"parameterCount\");\n-\t\t\n+\n \t\tfor (int i = 0; i < methodParametersData.parameterCount().longValue(); i++) {\n-\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_SRP, parameters.nameEA(), \"methodParameterName\");\n-\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_U16, parameters.flagsEA(), \"methodParameterFlag\");\t\t\t\n+\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, parameters.nameEA(), \"methodParameterName\");", "originalCommit": "adbc5aa027ce6aebd657d7d488bad647b15b8119", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDYxOTA5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r564619090", "bodyText": "I think these should continue to use J9_UTF8 to benefit from the extra sanity checking in LinearDumper.java.\nThe corresponding arguments (getNameSrp(), etc. are correct).", "author": "keithc-ca", "createdAt": "2021-01-26T15:50:23Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -1054,10 +1055,10 @@ long allSlotsInMethodDebugInfoDo(U32Pointer cursor) throws CorruptDataException\n \t\t\t\tLocalVariableTable values = variableInfoValuesIterator.next();\n \n \t\t\t\t// Need to walk the name and signature to add them to the UTF8 section\n-\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_UTF8, values.getName(), \"name\");\n-\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_UTF8, values.getSignature(), \"getSignature\");\n+\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, values.getNameSrp(), \"name\");\n+\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, values.getSignatureSrp(), \"signature\");\n \t\t\t\tif (values.getGenericSignature().notNull()) {\n-\t\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_UTF8, values.getGenericSignature(), \"getGenericSignature\");\n+\t\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, values.getGenericSignatureSrp(), \"genericSignature\");", "originalCommit": "adbc5aa027ce6aebd657d7d488bad647b15b8119", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjM5NzM1Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r566397357", "bodyText": "As far as I understand the code in LinearDumper.java, the strings pointed to by J9_ROM_UTF8 slots go through the same bound checking as with J9_UTF8. The difference between them is that J9_ROM_UTF8 also handles the SRP, not just the string it points to, so the resulting tree of regions will actually be more complete. The rest of the code uses J9_ROM_UTF8, and it would actually be possible to remove J9_UTF8 altogether after this change. I can only see J9_UTF8 being necessary when a J9UTF8 string is stored \"inline\" somewhere with no SRP pointing to it, but there are no such cases right now as far as I can tell.", "author": "AlexeyKhrabrov", "createdAt": "2021-01-28T20:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDYxOTA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQyNzI1Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r566427257", "bodyText": "I looked at the code I referenced in LinearDumper again: I think you're right.", "author": "keithc-ca", "createdAt": "2021-01-28T21:44:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDYxOTA5MA=="}], "type": "inlineReview"}, {"oid": "10c3df5b01e54058d3d87a24e6e72414cdff314f", "url": "https://github.com/eclipse-openj9/openj9/commit/10c3df5b01e54058d3d87a24e6e72414cdff314f", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>", "committedDate": "2021-01-28T19:54:57Z", "type": "commit"}, {"oid": "10c3df5b01e54058d3d87a24e6e72414cdff314f", "url": "https://github.com/eclipse-openj9/openj9/commit/10c3df5b01e54058d3d87a24e6e72414cdff314f", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>", "committedDate": "2021-01-28T19:54:57Z", "type": "forcePushed"}]}