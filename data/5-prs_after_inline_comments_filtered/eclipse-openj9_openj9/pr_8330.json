{"pr_number": 8330, "pr_title": "Support JEP-370 (Part 1)", "pr_createdAt": "2020-01-17T06:27:45Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8330", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk2MzEzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8330#discussion_r367963130", "bodyText": "space vs tab", "author": "DanHeidinga", "createdAt": "2020-01-17T14:30:40Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MemberName.java", "diffHunk": "@@ -46,6 +50,16 @@ public MemberName(MethodHandle methodHandle) {\n \t}\n \t/*[ENDIF] Java11 */\n \n+\t/*[IF Java14]*/\n+        public MemberName(Method m) {\n+\t\tthrow OpenJDKCompileStub.OpenJDKCompileStubThrowError();\n+        }", "originalCommit": "984a943b817a9b119dc2564fba93ad26485d2224", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk2MzU1MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8330#discussion_r367963550", "bodyText": "space vs tab", "author": "DanHeidinga", "createdAt": "2020-01-17T14:31:30Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/VarHandle.java", "diffHunk": "@@ -287,7 +300,20 @@ public static AccessMode valueFromMethodName(String methodName) {\n \t\tthis.handleTable = handleTable;\n \t\tthis.modifiers = modifiers;\n \t}\n-\t\n+\n+/*[IF Java14]*/\n+        /**\n+         * Constructs a generic VarHandle instance.\n+         *\n+         * @param varForm An instance of VarForm.\n+         */", "originalCommit": "984a943b817a9b119dc2564fba93ad26485d2224", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "14618b1f9a22f92d61068bb28d562832261786f0", "url": "https://github.com/eclipse-openj9/openj9/commit/14618b1f9a22f92d61068bb28d562832261786f0", "message": "Add VarHandle.AIOOBE_SUPPLIER to support X-VarHandle.java.template\n\nX-VarHandle.java.template exists in the java.lang.invoke package directory.\n\nVarHandle.AIOOBE_SUPPLIER is needed to build the Java classes generated by the\nabove template.\n\nOpenJ9 does not utilize the Java classes generated from the above template\nsince it has its own implementation.\n\nSo, VarHandle.AIOOBE_SUPPLIER is initialized to null.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-01-17T19:00:26Z", "type": "forcePushed"}, {"oid": "3657f3fa63b5b595f9a8cebc6e3efaf20819f442", "url": "https://github.com/eclipse-openj9/openj9/commit/3657f3fa63b5b595f9a8cebc6e3efaf20819f442", "message": "Add VarHandle.AIOOBE_SUPPLIER to support X-VarHandle.java.template\n\nX-VarHandle.java.template exists in the java.lang.invoke package directory.\n\nVarHandle.AIOOBE_SUPPLIER is needed to build the Java classes generated by the\nabove template.\n\nOpenJ9 does not utilize the Java classes generated from the above template\nsince it has its own implementation.\n\nSo, VarHandle.AIOOBE_SUPPLIER is initialized to null.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-01-17T19:04:45Z", "type": "forcePushed"}, {"oid": "c89c2ff6657202c0dc3a4073dccf8d6e5d3bbb40", "url": "https://github.com/eclipse-openj9/openj9/commit/c89c2ff6657202c0dc3a4073dccf8d6e5d3bbb40", "message": "Add VarHandle.AIOOBE_SUPPLIER to support X-VarHandle.java.template\n\nX-VarHandle.java.template exists in the java.lang.invoke package directory.\n\nVarHandle.AIOOBE_SUPPLIER is needed to build the Java classes generated by the\nabove template.\n\nOpenJ9 does not utilize the Java classes generated from the above template\nsince it has its own implementation.\n\nSo, VarHandle.AIOOBE_SUPPLIER is initialized to null.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-01-17T19:12:25Z", "type": "forcePushed"}, {"oid": "424c1bcd5dce705898bec8e0e569fcc07d3aaf29", "url": "https://github.com/eclipse-openj9/openj9/commit/424c1bcd5dce705898bec8e0e569fcc07d3aaf29", "message": "Add VarHandle.AIOOBE_SUPPLIER to support X-VarHandle.java.template\n\nX-VarHandle.java.template exists in the java.lang.invoke package directory.\n\nVarHandle.AIOOBE_SUPPLIER is needed to build the Java classes generated by the\nabove template.\n\nOpenJ9 does not utilize the Java classes generated from the above template\nsince it has its own implementation.\n\nSo, VarHandle.AIOOBE_SUPPLIER is initialized to null.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-01-30T19:48:39Z", "type": "forcePushed"}, {"oid": "30c3f1eab2f58bf9a3c3cd5d3d7cfe713136ea59", "url": "https://github.com/eclipse-openj9/openj9/commit/30c3f1eab2f58bf9a3c3cd5d3d7cfe713136ea59", "message": "JEP-370: Remove empty stubs and use OpenJDK classes\n\nVarHandles.makeMemoryAddressViewHandle is needed to support JEP-370.\n\nTo consume OpenJDK's VarHandles without any amends, we need to use the\nfollowing OpenJDK classes:\n1) AddressVarHandleGenerator\n2) VarHandleByteArrayBase\n3) VarHandleMemoryAddressBase\n\nJEP-370 is a Java 14 feature. So, the empty OpenJ9 stubs for the above\nclasses have been removed or disabled in Java 14.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-02-05T01:02:34Z", "type": "commit"}, {"oid": "1550d3fd3bd933b04ac5ab5185bd630053c5b5f6", "url": "https://github.com/eclipse-openj9/openj9/commit/1550d3fd3bd933b04ac5ab5185bd630053c5b5f6", "message": "Use OpenJDK's VarForm and support a new VarHandle constructor\n\nOpenJDK's VarForm is needed to support JEP-370. So, the empty OpenJ9\nstub for VarForm is disabled in Java 14.\n\nA new VarHandle constructor is also needed to support JEP-370.\n\nVarHandle(VarForm varForm) {\n\t/* TODO: Translate {VarForm varForm} -> {Class<?> fieldType,\n\t * Class<?>[] coordinateTypes, MethodHandle[] handleTable,\n\t * int modifiers}\n\t */\n}\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-02-05T01:02:34Z", "type": "commit"}, {"oid": "beda10f7110d82728a75dd778bbbcbb928f8274d", "url": "https://github.com/eclipse-openj9/openj9/commit/beda10f7110d82728a75dd778bbbcbb928f8274d", "message": "Support VarHandles.makeFieldHandle\n\nVarHandles.makeFieldHandle relies upon following methods:\n- MethodHandleNatives.objectFieldOffset\n- MethodHandleNatives.staticFieldBase\n- MethodHandleNatives.staticFieldOffset\n\nStubs for the above three methods are added in OpenJ9's\nMethodHandleNatives.\n\nOpenJ9's FieldVarHandle doesn't depend on VarHandles.makeFieldHandle.\nOpenJ9 has its own implementation to support FieldVarHandle. So, the\nabove methods do not need to be implemented.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-02-05T01:02:34Z", "type": "commit"}, {"oid": "128047c5ac7298253102db720a3c5ef47daf0efe", "url": "https://github.com/eclipse-openj9/openj9/commit/128047c5ac7298253102db720a3c5ef47daf0efe", "message": "Support abstract method accessModeTypeUncached in OpenJ9's VarHandle\n\nJava classes generated from X-VarHandle*.template implement the\nVarHandle.accessModeTypeUncached abstract method.\n\nThis method has been introduced in OpenJ9's VarHandle to support\nJEP-370.\n\nOpenJ9's implementation of ArrayVarHandle, FieldVarHandle and\nViewVarHandle do not utilize VarHandle.accessModeTypeUncached. So, they\nimplement this method as an empty stub.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-02-05T01:04:18Z", "type": "commit"}, {"oid": "fda267d11448b09c136ec86b2b487e6d7cb2e91b", "url": "https://github.com/eclipse-openj9/openj9/commit/fda267d11448b09c136ec86b2b487e6d7cb2e91b", "message": "Update MemberName to support JEP-370\n\nMemberName(Method method) constructor is needed to support OpenJ9.\n\nboolean isStatic() method is added to build VarHandles.makeFieldHandle.\nIt does not need an implementation since OpenJ9 implements its own\nFieldVarHandle and does not rely upon VarHandles.makeFieldHandle.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-02-05T01:04:25Z", "type": "commit"}, {"oid": "9b1a236ccc3b7727d203f76db9ceda02092b71cd", "url": "https://github.com/eclipse-openj9/openj9/commit/9b1a236ccc3b7727d203f76db9ceda02092b71cd", "message": "Extend LambdaForm.BasicType to support JEP-370\n\nIn OpenJDK's AddressVarHandleGenerator, returnInsn and loadInsn methods\nrely upon LambdaForm.BasicType.\n\nThe following values are added in LambdaForm.BasicType enum: I_TYPE,\nJ_TYPE, F_TYPE, D_TYPE and V_TYPE, in order to support the above\nfunctions.\n\nBasicType.basicType(Class<?> cls) will need to be implemented in order\nto support JEP-370.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-02-05T01:04:26Z", "type": "commit"}, {"oid": "1f5514dd310e96dc89c2faf672edd3b6e4928a91", "url": "https://github.com/eclipse-openj9/openj9/commit/1f5514dd310e96dc89c2faf672edd3b6e4928a91", "message": "Update AccessMode and SignatureType in VarHandle to support JEP-370\n\nAddressVarHandleGenerator.addAccessModeTypeMethod accesses a field named\n\"at\" in VarHandle.AccessMode enum. This field is currently named as\n\"signatureType\". It is renamed from \"signatureType\" to \"at\" in order to\nsupport JEP-370.\n\nSignatureType enum values are renamed to work with\nAddressVarHandleGenerator and VarForm:\n1) getter -> GET\n2) setter -> SET\n3) compareAndSet -> COMPARE_AND_SET\n4) compareAndExchange -> COMPARE_AND_EXCHANGE\n5) getAndSet -> GET_AND_UPDATE\n6) invalid removed since it is unused.\n\nAlso, enum SignatureType is renamed to AccessType in order to work with\nVarForm and AddressVarHandleGenerator.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-02-05T01:04:28Z", "type": "commit"}, {"oid": "30155003d2eae585af4b29abb187565b10e03bde", "url": "https://github.com/eclipse-openj9/openj9/commit/30155003d2eae585af4b29abb187565b10e03bde", "message": "Add AccessMode.methodNameToAccessMode to support VarForm\n\nAccessMode.methodNameToAccessMode is of type Map<String, AccessMode>.\n\nIt is introduced to support VarForm.linkFromStatic. It needs to be\ninitialized properly. Currently, it is initialized to null.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-02-05T01:04:29Z", "type": "commit"}, {"oid": "c547036ce3671a60a9e15ea11bdd013c15bbaa1a", "url": "https://github.com/eclipse-openj9/openj9/commit/c547036ce3671a60a9e15ea11bdd013c15bbaa1a", "message": "Add VarHandle.AIOOBE_SUPPLIER to support X-VarHandle.java.template\n\nX-VarHandle.java.template exists in the java.lang.invoke package directory.\n\nVarHandle.AIOOBE_SUPPLIER is needed to build the Java classes generated by the\nabove template.\n\nOpenJ9 does not utilize the Java classes generated from the above template\nsince it has its own implementation.\n\nSo, VarHandle.AIOOBE_SUPPLIER is initialized to null.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-02-05T01:04:30Z", "type": "commit"}, {"oid": "c547036ce3671a60a9e15ea11bdd013c15bbaa1a", "url": "https://github.com/eclipse-openj9/openj9/commit/c547036ce3671a60a9e15ea11bdd013c15bbaa1a", "message": "Add VarHandle.AIOOBE_SUPPLIER to support X-VarHandle.java.template\n\nX-VarHandle.java.template exists in the java.lang.invoke package directory.\n\nVarHandle.AIOOBE_SUPPLIER is needed to build the Java classes generated by the\nabove template.\n\nOpenJ9 does not utilize the Java classes generated from the above template\nsince it has its own implementation.\n\nSo, VarHandle.AIOOBE_SUPPLIER is initialized to null.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-02-05T01:04:30Z", "type": "forcePushed"}]}