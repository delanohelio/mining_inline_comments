{"pr_number": 873, "pr_title": "BXC-2469 - More external binaries", "pr_createdAt": "2020-01-02T20:12:09Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/873", "timeline": [{"oid": "5959148fb4c40c76e25631dbcae59e9ebafe5b1e", "url": "https://github.com/UNC-Libraries/box-c/commit/5959148fb4c40c76e25631dbcae59e9ebafe5b1e", "message": "Refactor multi-destination transfer sessions to produce single destination sessions", "committedDate": "2019-12-17T21:31:40Z", "type": "commit"}, {"oid": "cf825634fee4b45285ae1d7d2c13056d190f61fe", "url": "https://github.com/UNC-Libraries/box-c/commit/cf825634fee4b45285ae1d7d2c13056d190f61fe", "message": "Add support for transferring streams", "committedDate": "2019-12-18T13:52:03Z", "type": "commit"}, {"oid": "ec38c4bb3663be585e6abd744b3890f79c89024d", "url": "https://github.com/UNC-Libraries/box-c/commit/ec38c4bb3663be585e6abd744b3890f79c89024d", "message": "Merge branch 'fcrepo4' into bxc-2469-mods-ext", "committedDate": "2019-12-18T14:10:31Z", "type": "commit"}, {"oid": "8fc46cdca91b84b5daf2ba8319afd31cbb91fc35", "url": "https://github.com/UNC-Libraries/box-c/commit/8fc46cdca91b84b5daf2ba8319afd31cbb91fc35", "message": "Move UpdateDescriptionService to persistence, use it in EditTitleService", "committedDate": "2019-12-18T14:56:10Z", "type": "commit"}, {"oid": "0ad8dc0904fc22e657815134f4fa14729ca38603", "url": "https://github.com/UNC-Libraries/box-c/commit/0ad8dc0904fc22e657815134f4fa14729ca38603", "message": "Change contentObject.setDescription to take a URI instead of a stream", "committedDate": "2019-12-18T15:54:27Z", "type": "commit"}, {"oid": "b468c3ae9d1d47ae39dd2e735e9c61d38eb454ea", "url": "https://github.com/UNC-Libraries/box-c/commit/b468c3ae9d1d47ae39dd2e735e9c61d38eb454ea", "message": "Update ingest jobs to treat mods as external binaries", "committedDate": "2019-12-18T19:28:36Z", "type": "commit"}, {"oid": "129fbefbd234a9a19ec5f3fe735c017c21c65317", "url": "https://github.com/UNC-Libraries/box-c/commit/129fbefbd234a9a19ec5f3fe735c017c21c65317", "message": "XML import job using transfer session, refactor tests to generate metadata import files", "committedDate": "2019-12-19T15:51:49Z", "type": "commit"}, {"oid": "da2b4934f442e45560f7f9cca7c11b6e06abebf3", "url": "https://github.com/UNC-Libraries/box-c/commit/da2b4934f442e45560f7f9cca7c11b6e06abebf3", "message": "Merge branch 'fcrepo4' into bxc-2469-mods-ext", "committedDate": "2019-12-19T16:02:51Z", "type": "commit"}, {"oid": "00e6bca857e8b013a49c089fe3af532ed3b0b29e", "url": "https://github.com/UNC-Libraries/box-c/commit/00e6bca857e8b013a49c089fe3af532ed3b0b29e", "message": "Add binary transfer jobs to deposit pipeline", "committedDate": "2019-12-23T15:28:08Z", "type": "commit"}, {"oid": "be221e848a1222f5a873300218e38b195d69418e", "url": "https://github.com/UNC-Libraries/box-c/commit/be221e848a1222f5a873300218e38b195d69418e", "message": "Add method to check for object existense to obj factory", "committedDate": "2019-12-24T00:54:37Z", "type": "commit"}, {"oid": "34fb54be2160c4152d7bf8c205cb5953bd92605a", "url": "https://github.com/UNC-Libraries/box-c/commit/34fb54be2160c4152d7bf8c205cb5953bd92605a", "message": "Ingest deposit manifests as external binaries", "committedDate": "2019-12-24T00:56:01Z", "type": "commit"}, {"oid": "0c07a57d4a1b5d315739047bd2eb87d20eea875d", "url": "https://github.com/UNC-Libraries/box-c/commit/0c07a57d4a1b5d315739047bd2eb87d20eea875d", "message": "Import XML submits messages to jms and are processed by camel. Move most import xml code to persistence. Log access exceptions", "committedDate": "2020-01-02T17:13:42Z", "type": "commit"}, {"oid": "11e86d7b2b3c29ef93b246ce25d3c7899a7ee6d7", "url": "https://github.com/UNC-Libraries/box-c/commit/11e86d7b2b3c29ef93b246ce25d3c7899a7ee6d7", "message": "Add integration test for import of bulk descriptions in camel. Move import xml service to persistence", "committedDate": "2020-01-02T19:56:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjgyMzUyMQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/873#discussion_r362823521", "bodyText": "Does the timer get used?", "author": "lfarrell", "createdAt": "2020-01-03T14:19:03Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/UpdateDescriptionService.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import static edu.unc.lib.dl.model.DatastreamPids.getMdDescriptivePid;\n+import static java.util.Arrays.asList;\n+import static org.apache.commons.io.IOUtils.toByteArray;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URI;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.acl.service.AccessControlService;\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.Permission;\n+import edu.unc.lib.dl.fcrepo4.ContentObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.persist.services.storage.StorageLocation;\n+import edu.unc.lib.dl.persist.services.storage.StorageLocationManager;\n+import edu.unc.lib.dl.persist.services.transfer.BinaryTransferService;\n+import edu.unc.lib.dl.persist.services.transfer.BinaryTransferSession;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.validation.MODSValidator;\n+import edu.unc.lib.dl.validation.MetadataValidationException;\n+import io.dropwizard.metrics5.Timer;\n+\n+/**\n+ * Service that manages description, e.g., MODS, updates\n+ *\n+ * @author harring\n+ *\n+ */\n+public class UpdateDescriptionService {\n+    private static final Logger log = LoggerFactory.getLogger(UpdateDescriptionService.class);\n+\n+    private AccessControlService aclService;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private MODSValidator modsValidator;\n+    private BinaryTransferService transferService;\n+    private StorageLocationManager locationManager;\n+\n+    private boolean validate;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(UpdateDescriptionService.class);\n+\n+    public UpdateDescriptionService() {\n+        validate = true;\n+    }\n+\n+    /**\n+     * Updates the MODS description of a single object\n+     *\n+     * @param agent\n+     * @param pid\n+     * @param modsStream\n+     * @throws MetadataValidationException\n+     * @throws IOException\n+     */\n+    public void updateDescription(AgentPrincipals agent, PID pid, InputStream modsStream)\n+            throws MetadataValidationException, IOException {\n+\n+        ContentObject obj = (ContentObject) repoObjLoader.getRepositoryObject(pid);\n+        StorageLocation destLocation = locationManager.getStorageLocation(obj);\n+\n+        try (BinaryTransferSession transferSession = transferService.getSession(destLocation)) {\n+            updateDescription(transferSession, agent, obj, modsStream);\n+        }\n+    }\n+\n+    /**\n+     * Updates the MODS description of an object as part of the provided ongoing session.\n+     *\n+     * @param transferSession ongoing transfer session\n+     * @param agent\n+     * @param pid\n+     * @param modsStream\n+     * @throws MetadataValidationException\n+     * @throws IOException\n+     */\n+    public void updateDescription(BinaryTransferSession transferSession, AgentPrincipals agent,\n+            PID pid, InputStream modsStream) throws MetadataValidationException, IOException {\n+\n+        ContentObject obj = (ContentObject) repoObjLoader.getRepositoryObject(pid);\n+\n+        updateDescription(transferSession, agent, obj, modsStream);\n+    }\n+\n+    private void updateDescription(BinaryTransferSession transferSession, AgentPrincipals agent,\n+            ContentObject obj, InputStream modsStream) throws IOException {\n+\n+        log.debug(\"Updating description for {}\", obj.getPid().getId());\n+        try (Timer.Context context = timer.time()) {", "originalCommit": "11e86d7b2b3c29ef93b246ce25d3c7899a7ee6d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjgzMzY5MA==", "url": "https://github.com/UNC-Libraries/box-c/pull/873#discussion_r362833690", "bodyText": "If I remember correctly, when the try block ends the timer gets closed which writes the result to the metrics client, which gets dumped to a log periodically", "author": "bbpennel", "createdAt": "2020-01-03T14:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjgyMzUyMQ=="}], "type": "inlineReview"}, {"oid": "a1baeee0e737e75698ec8216acffd5f1412862b2", "url": "https://github.com/UNC-Libraries/box-c/commit/a1baeee0e737e75698ec8216acffd5f1412862b2", "message": "Trim whitespace off end of derivative path before adding extension, and reuse uuid generator", "committedDate": "2020-01-03T14:28:07Z", "type": "commit"}, {"oid": "187b5ef7fc29fbe9c3e51e5f6de689348d3e462a", "url": "https://github.com/UNC-Libraries/box-c/commit/187b5ef7fc29fbe9c3e51e5f6de689348d3e462a", "message": "Copy files to temp before supplying to fedora", "committedDate": "2020-01-03T14:44:18Z", "type": "commit"}, {"oid": "e659b634e6aa514bb489b0c12fe1c1476e8e7af2", "url": "https://github.com/UNC-Libraries/box-c/commit/e659b634e6aa514bb489b0c12fe1c1476e8e7af2", "message": "Copy more test files to temp before setting description", "committedDate": "2020-01-03T15:26:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1MjEyNA==", "url": "https://github.com/UNC-Libraries/box-c/pull/873#discussion_r362852124", "bodyText": "Can probably get rid of this blank line", "author": "lfarrell", "createdAt": "2020-01-03T15:34:50Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java", "diffHunk": "@@ -91,9 +100,17 @@ public void runJob() {\n     private void transferBinaries(Resource resc, BinaryTransferSession transferSession) {\n         PID objPid = PIDs.get(resc.toString());\n \n-        if (resc.hasProperty(RDF.type, Cdr.FileObject)) {\n+        Set<Resource> rescTypes = resc.listProperties(RDF.type).toList().stream()\n+                .map(Statement::getResource).collect(toSet());\n+\n+        if (TYPES_ALLOWING_DESC.stream().anyMatch(rescTypes::contains)) {\n+            transferModsFile(objPid, resc, transferSession);\n+        }\n+\n+        if (rescTypes.contains(Cdr.FileObject)) {\n             transferOriginalFile(objPid, resc, transferSession);\n             transferFitsExtract(objPid, resc, transferSession);\n+", "originalCommit": "e659b634e6aa514bb489b0c12fe1c1476e8e7af2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9612cc01b377638ea2122c45caf833825d9a6915", "url": "https://github.com/UNC-Libraries/box-c/commit/9612cc01b377638ea2122c45caf833825d9a6915", "message": "Delete blank line", "committedDate": "2020-01-03T16:52:06Z", "type": "commit"}]}