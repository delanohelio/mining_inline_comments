{"pr_number": 955, "pr_title": "Add collection thumbnails", "pr_createdAt": "2020-04-07T20:02:47Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/955", "timeline": [{"oid": "60f0422c7a68a3f39061bebe5ac30013b9f373d4", "url": "https://github.com/UNC-Libraries/box-c/commit/60f0422c7a68a3f39061bebe5ac30013b9f373d4", "message": "Add collection thumbnail form", "committedDate": "2020-04-02T16:08:39Z", "type": "commit"}, {"oid": "6ec112f433af492c10acff9f783a31baa8910039", "url": "https://github.com/UNC-Libraries/box-c/commit/6ec112f433af492c10acff9f783a31baa8910039", "message": "Upload file and send message to Apache Camel", "committedDate": "2020-04-03T19:35:40Z", "type": "commit"}, {"oid": "d522c02b655cc3ebf376b6d54518106740d3c118", "url": "https://github.com/UNC-Libraries/box-c/commit/d522c02b655cc3ebf376b6d54518106740d3c118", "message": "Add Tika as a dependency", "committedDate": "2020-04-03T19:40:24Z", "type": "commit"}, {"oid": "a2f420cf49fff022bf4d99687618a4cef7e18fd6", "url": "https://github.com/UNC-Libraries/box-c/commit/a2f420cf49fff022bf4d99687618a4cef7e18fd6", "message": "Add routing and processing for collection thumbnails", "committedDate": "2020-04-07T15:56:41Z", "type": "commit"}, {"oid": "46d686ba55f6c20bf70bd7f58e8a48335c15e104", "url": "https://github.com/UNC-Libraries/box-c/commit/46d686ba55f6c20bf70bd7f58e8a48335c15e104", "message": "Add IT test", "committedDate": "2020-04-07T20:00:51Z", "type": "commit"}, {"oid": "2f88dc96665837690625c43340e510f6013cc536", "url": "https://github.com/UNC-Libraries/box-c/commit/2f88dc96665837690625c43340e510f6013cc536", "message": "Merge branch 'fcrepo4' into coll-thumbs", "committedDate": "2020-04-07T20:08:15Z", "type": "commit"}, {"oid": "c0879122b3e6c44f726cd09361aa02c5bdb82662", "url": "https://github.com/UNC-Libraries/box-c/commit/c0879122b3e6c44f726cd09361aa02c5bdb82662", "message": "* Add thumnail placeholder\n* Fix style issue", "committedDate": "2020-04-07T20:18:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU0Mzg5NA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r405543894", "bodyText": "What you have with tika is probably more reliable, but wanted to mention that MultipartFile has a getContentType() which would give you the mimetype provided by the user's browser:\nhttps://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/multipart/MultipartFile.html\nI don't really have an opinion at the moment about which approach to go with", "author": "bbpennel", "createdAt": "2020-04-08T13:55:19Z", "path": "services/src/main/java/edu/unc/lib/dl/cdr/services/rest/CollectionThumbnailController.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.rest;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.web.bind.annotation.PathVariable;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+import org.springframework.web.multipart.MultipartFile;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.GroupsThreadStore;\n+import edu.unc.lib.dl.cdr.services.processing.ImportThumbnailService;\n+\n+/**\n+ * Controller for handling submission requests for collection display thumbnails\n+ *\n+ * @author lfarrell\n+ *\n+ */\n+@Controller\n+public class CollectionThumbnailController {\n+    private static final Logger log = LoggerFactory.getLogger(CollectionThumbnailController.class);\n+\n+    @Autowired\n+    private ImportThumbnailService service;\n+\n+    @PostMapping(value = \"edit/collectionThumbnail/{pid}\")\n+    public @ResponseBody\n+    ResponseEntity<Object> ImportCollectionThumbnail(@PathVariable(\"pid\") String pid,\n+                                                     @RequestParam(\"file\") MultipartFile thumbnailFile)", "originalCommit": "c0879122b3e6c44f726cd09361aa02c5bdb82662", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU0NDUwNw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r405544507", "bodyText": "we don't usually add the email to the response do we?", "author": "bbpennel", "createdAt": "2020-04-08T13:56:08Z", "path": "services/src/main/java/edu/unc/lib/dl/cdr/services/rest/CollectionThumbnailController.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.rest;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.web.bind.annotation.PathVariable;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+import org.springframework.web.multipart.MultipartFile;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.GroupsThreadStore;\n+import edu.unc.lib.dl.cdr.services.processing.ImportThumbnailService;\n+\n+/**\n+ * Controller for handling submission requests for collection display thumbnails\n+ *\n+ * @author lfarrell\n+ *\n+ */\n+@Controller\n+public class CollectionThumbnailController {\n+    private static final Logger log = LoggerFactory.getLogger(CollectionThumbnailController.class);\n+\n+    @Autowired\n+    private ImportThumbnailService service;\n+\n+    @PostMapping(value = \"edit/collectionThumbnail/{pid}\")\n+    public @ResponseBody\n+    ResponseEntity<Object> ImportCollectionThumbnail(@PathVariable(\"pid\") String pid,\n+                                                     @RequestParam(\"file\") MultipartFile thumbnailFile)\n+            throws Exception {\n+\n+        AgentPrincipals agent = AgentPrincipals.createFromThread();\n+        String userEmail = GroupsThreadStore.getEmail();\n+\n+        Map<String, Object> result = new HashMap<>();\n+        result.put(\"action\", \"edit collection thumbnail\");\n+        result.put(\"username\", agent.getUsername());\n+        result.put(\"user email\", userEmail);", "originalCommit": "c0879122b3e6c44f726cd09361aa02c5bdb82662", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU1NzU4Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r405557587", "bodyText": "One thing I'm not sure about with this approach, is the importStream getting consumed? When you write the importStream out to file, is it writing anything? Normally inputstreams can only be read once, but some types of input streams can be reset and read multiple times. I don't know if that is happening here or not.\nI guess if you used the user supplied mimetype from the upload request it might not be an issue. But if necessary you can also duplicate the inputstream, similiar to what is happening in the edit description service.", "author": "bbpennel", "createdAt": "2020-04-08T14:14:05Z", "path": "services/src/main/java/edu/unc/lib/dl/cdr/services/processing/ImportThumbnailService.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.processing;\n+\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_DEPTH;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_SIZE;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPaths.idToPath;\n+import static edu.unc.lib.dl.xml.JDOMNamespaceUtil.ATOM_NS;\n+import static org.apache.commons.io.FileUtils.copyInputStreamToFile;\n+import static org.apache.commons.lang3.StringUtils.containsIgnoreCase;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import org.apache.tika.Tika;\n+import org.jdom2.Document;\n+import org.jdom2.Element;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.acl.service.AccessControlService;\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.Permission;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.services.MessageSender;\n+\n+/**\n+ * Service to process requests to add/update display thumbnail for collection pages\n+ *\n+ * @author lfarrell\n+ */\n+public class ImportThumbnailService extends MessageSender {\n+    private static final Logger log = LoggerFactory.getLogger(ImportThumbnailService.class);\n+\n+    private String dataDir;\n+    private Path storagePath;\n+    private AccessControlService aclService;\n+    private MessageSender messageSender;\n+\n+    public void init() throws IOException {\n+        storagePath = Paths.get(dataDir);\n+\n+        // Create the directory if it doesn't already exist\n+        Files.createDirectories(storagePath);\n+    }\n+\n+    public void run(InputStream importStream, AgentPrincipals agent, String uuid) throws Exception {\n+        PID pid = PIDs.get(uuid);\n+\n+        aclService.assertHasAccess(\"User does not have permission to add/update collection thumbnails\",\n+                pid, agent.getPrincipals(), Permission.createCollection);\n+\n+        try {\n+            Tika tika = new Tika();\n+            String mimeType = tika.detect(importStream);", "originalCommit": "c0879122b3e6c44f726cd09361aa02c5bdb82662", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyOTI5Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r405729297", "bodyText": "This seems to have been the issue with the thumbnail generation. Switching to the uploaded mime-type seems to have resolved it.", "author": "lfarrell", "createdAt": "2020-04-08T18:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU1NzU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU2NjkyNQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r405566925", "bodyText": "I'd like to avoid locking this workflow down to collections, since I think we'll want to be able to use it for admin units too, and maybe even folders. EditDescription permission might be reasonable for this.\nMore generally, it'd be good to go with naming like \"EditThumbnail\" rather than including \"collection\" in the names of stuff.", "author": "bbpennel", "createdAt": "2020-04-08T14:26:52Z", "path": "services/src/main/java/edu/unc/lib/dl/cdr/services/processing/ImportThumbnailService.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.processing;\n+\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_DEPTH;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_SIZE;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPaths.idToPath;\n+import static edu.unc.lib.dl.xml.JDOMNamespaceUtil.ATOM_NS;\n+import static org.apache.commons.io.FileUtils.copyInputStreamToFile;\n+import static org.apache.commons.lang3.StringUtils.containsIgnoreCase;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import org.apache.tika.Tika;\n+import org.jdom2.Document;\n+import org.jdom2.Element;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.acl.service.AccessControlService;\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.Permission;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.services.MessageSender;\n+\n+/**\n+ * Service to process requests to add/update display thumbnail for collection pages\n+ *\n+ * @author lfarrell\n+ */\n+public class ImportThumbnailService extends MessageSender {\n+    private static final Logger log = LoggerFactory.getLogger(ImportThumbnailService.class);\n+\n+    private String dataDir;\n+    private Path storagePath;\n+    private AccessControlService aclService;\n+    private MessageSender messageSender;\n+\n+    public void init() throws IOException {\n+        storagePath = Paths.get(dataDir);\n+\n+        // Create the directory if it doesn't already exist\n+        Files.createDirectories(storagePath);\n+    }\n+\n+    public void run(InputStream importStream, AgentPrincipals agent, String uuid) throws Exception {\n+        PID pid = PIDs.get(uuid);\n+\n+        aclService.assertHasAccess(\"User does not have permission to add/update collection thumbnails\",\n+                pid, agent.getPrincipals(), Permission.createCollection);", "originalCommit": "c0879122b3e6c44f726cd09361aa02c5bdb82662", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU2ODYyNw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r405568627", "bodyText": "Another option is to do storagePath.resolve(thumbnailBasePath).resolve(uuid), might not make much difference but i guess if you'd rather not have to convert to a string", "author": "bbpennel", "createdAt": "2020-04-08T14:29:12Z", "path": "services/src/main/java/edu/unc/lib/dl/cdr/services/processing/ImportThumbnailService.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.processing;\n+\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_DEPTH;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_SIZE;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPaths.idToPath;\n+import static edu.unc.lib.dl.xml.JDOMNamespaceUtil.ATOM_NS;\n+import static org.apache.commons.io.FileUtils.copyInputStreamToFile;\n+import static org.apache.commons.lang3.StringUtils.containsIgnoreCase;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import org.apache.tika.Tika;\n+import org.jdom2.Document;\n+import org.jdom2.Element;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.acl.service.AccessControlService;\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.Permission;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.services.MessageSender;\n+\n+/**\n+ * Service to process requests to add/update display thumbnail for collection pages\n+ *\n+ * @author lfarrell\n+ */\n+public class ImportThumbnailService extends MessageSender {\n+    private static final Logger log = LoggerFactory.getLogger(ImportThumbnailService.class);\n+\n+    private String dataDir;\n+    private Path storagePath;\n+    private AccessControlService aclService;\n+    private MessageSender messageSender;\n+\n+    public void init() throws IOException {\n+        storagePath = Paths.get(dataDir);\n+\n+        // Create the directory if it doesn't already exist\n+        Files.createDirectories(storagePath);\n+    }\n+\n+    public void run(InputStream importStream, AgentPrincipals agent, String uuid) throws Exception {\n+        PID pid = PIDs.get(uuid);\n+\n+        aclService.assertHasAccess(\"User does not have permission to add/update collection thumbnails\",\n+                pid, agent.getPrincipals(), Permission.createCollection);\n+\n+        try {\n+            Tika tika = new Tika();\n+            String mimeType = tika.detect(importStream);\n+\n+            if (!containsIgnoreCase(mimeType, \"image\")) {\n+                throw new IllegalArgumentException(\"Uploaded file is not an image\");\n+            }\n+\n+            String thumbnailBasePath = idToPath(uuid, HASHED_PATH_DEPTH, HASHED_PATH_SIZE);\n+            String filePath = Paths.get(storagePath.toString(), thumbnailBasePath, uuid).toString();", "originalCommit": "c0879122b3e6c44f726cd09361aa02c5bdb82662", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU4NjA3NQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r405586075", "bodyText": "If we can get this to just be a regular RunEnhancements call, then you should be able to use the helper method for generating enhancement messages.", "author": "bbpennel", "createdAt": "2020-04-08T14:53:04Z", "path": "services/src/main/java/edu/unc/lib/dl/cdr/services/processing/ImportThumbnailService.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.processing;\n+\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_DEPTH;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_SIZE;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPaths.idToPath;\n+import static edu.unc.lib.dl.xml.JDOMNamespaceUtil.ATOM_NS;\n+import static org.apache.commons.io.FileUtils.copyInputStreamToFile;\n+import static org.apache.commons.lang3.StringUtils.containsIgnoreCase;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import org.apache.tika.Tika;\n+import org.jdom2.Document;\n+import org.jdom2.Element;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.acl.service.AccessControlService;\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.Permission;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.services.MessageSender;\n+\n+/**\n+ * Service to process requests to add/update display thumbnail for collection pages\n+ *\n+ * @author lfarrell\n+ */\n+public class ImportThumbnailService extends MessageSender {\n+    private static final Logger log = LoggerFactory.getLogger(ImportThumbnailService.class);\n+\n+    private String dataDir;\n+    private Path storagePath;\n+    private AccessControlService aclService;\n+    private MessageSender messageSender;\n+\n+    public void init() throws IOException {\n+        storagePath = Paths.get(dataDir);\n+\n+        // Create the directory if it doesn't already exist\n+        Files.createDirectories(storagePath);\n+    }\n+\n+    public void run(InputStream importStream, AgentPrincipals agent, String uuid) throws Exception {\n+        PID pid = PIDs.get(uuid);\n+\n+        aclService.assertHasAccess(\"User does not have permission to add/update collection thumbnails\",\n+                pid, agent.getPrincipals(), Permission.createCollection);\n+\n+        try {\n+            Tika tika = new Tika();\n+            String mimeType = tika.detect(importStream);\n+\n+            if (!containsIgnoreCase(mimeType, \"image\")) {\n+                throw new IllegalArgumentException(\"Uploaded file is not an image\");\n+            }\n+\n+            String thumbnailBasePath = idToPath(uuid, HASHED_PATH_DEPTH, HASHED_PATH_SIZE);\n+            String filePath = Paths.get(storagePath.toString(), thumbnailBasePath, uuid).toString();\n+            File finalLocation = new File(filePath);\n+            copyInputStreamToFile(importStream, finalLocation);\n+\n+            Document msg = createEnhancementMsg(agent.getUsername(), finalLocation.getAbsolutePath(), mimeType);\n+            messageSender.sendMessage(msg);\n+\n+            log.info(\"Job to to add thumbnail to collection {} has been queued by {}\",\n+                    uuid, agent.getUsername());\n+        } catch (IllegalArgumentException e) {\n+            log.error(\"Uploaded file for collection {} is not an image file\", uuid);\n+            throw e;\n+        }\n+    }\n+\n+    private Document createEnhancementMsg(String userid, String filePath, String mimeType) {", "originalCommit": "c0879122b3e6c44f726cd09361aa02c5bdb82662", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "865e39a48ebb22511099ef0fb46877f254c26853", "url": "https://github.com/UNC-Libraries/box-c/commit/865e39a48ebb22511099ef0fb46877f254c26853", "message": "* Update variable/filenames\n* Remove Tika check", "committedDate": "2020-04-08T18:29:00Z", "type": "commit"}, {"oid": "e468f71f8d44a1fc5188d118b668285346a99d14", "url": "https://github.com/UNC-Libraries/box-c/commit/e468f71f8d44a1fc5188d118b668285346a99d14", "message": "Update and rename IT test", "committedDate": "2020-04-08T18:58:36Z", "type": "commit"}, {"oid": "fc591f2c03a897a3b813afccea89bca3337e78fd", "url": "https://github.com/UNC-Libraries/box-c/commit/fc591f2c03a897a3b813afccea89bca3337e78fd", "message": "Run thumbnail generation through regular enhancement routing", "committedDate": "2020-04-09T15:02:28Z", "type": "commit"}, {"oid": "e585e57a3bfed8d0963553df92121bf1833f584e", "url": "https://github.com/UNC-Libraries/box-c/commit/e585e57a3bfed8d0963553df92121bf1833f584e", "message": "Update tests", "committedDate": "2020-04-09T20:07:54Z", "type": "commit"}, {"oid": "2119797972d193d97530e150cba8126d85a8502f", "url": "https://github.com/UNC-Libraries/box-c/commit/2119797972d193d97530e150cba8126d85a8502f", "message": "Let collectionObjs through Solr filter", "committedDate": "2020-04-13T15:56:46Z", "type": "commit"}, {"oid": "2c988522ad3b4e2c17af9cd80e7d6e48d185d152", "url": "https://github.com/UNC-Libraries/box-c/commit/2c988522ad3b4e2c17af9cd80e7d6e48d185d152", "message": "Update the way thumbnails show for collections, folders and admin units", "committedDate": "2020-04-13T18:51:51Z", "type": "commit"}, {"oid": "65d5e3c120736859fb9c397d6b9ad4151213232d", "url": "https://github.com/UNC-Libraries/box-c/commit/65d5e3c120736859fb9c397d6b9ad4151213232d", "message": "Switch the way messages are created", "committedDate": "2020-04-14T14:12:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4OTY1Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r408289657", "bodyText": "I think this will throw an error if the object pid isn't a collection. You would want to use getRepositoryObject and then check the type of the result. Also, if these methods don't find an object, they throw an exception rather than returning null.\nHowever, I don't think i'd recommend the line in.setHeader(FCREPO_RESOURCE_TYPE, Binary.getURI()); below since it's effectively declaring that a collection/folder/work/whatever is a binary for the sake of getting through the router.\nMy suggestion would be to populate FCREPO_RESOURCE_TYPE with the comma separated join of repoObj.getTypes(). Then add a new route here:\nhttps://github.com/UNC-Libraries/Carolina-Digital-Repository/blob/65d5e3c120736859fb9c397d6b9ad4151213232d/services-camel/src/main/java/edu/unc/lib/dl/services/camel/enhancements/EnhancementRouter.java#L71\nfor processing non-binaries. In that route, there can be a new processor that does most of what you have in this if statement. This way, we don't need to give an inaccurate resource type, and it clearly separates the behavior for binaries vs others where they diverge. We also shouldn't need the CdrEditThumbnail header in this case. I think all the changes to BinaryEnhancementProcessor could be backed out except for the new stuff to set the resource types header.\nThe non-binary route would be similar to the binary one. After it goes through the new processor (Maybe NonBinaryEnhancementProcessor), if enhancements are needed it should have CdrBinaryPath set, then you can set CdrEnhancementSet and call \"direct:process.enhancements\", \"direct-vm:solrIndexing\". Otherwise, you'd just want to call solrIndexing.\nA few other things:\n\nthe run enhancement message pid file should have a value you can just pass into PIDs.get without any extra splitting.\nthumbnailBasePath should actually be the path for where the source image is, not where thumbnails would be. This should be updated in the ImportThumbnailService as well, and we should double check that it is using the correct directory.\nOnly set CdrBinaryPath for non-binaries if a file exists at the generated source image path. That way the router can decide whether to perform binary specific enhancements on if there is a binary.", "author": "bbpennel", "createdAt": "2020-04-14T16:54:53Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/BinaryEnhancementProcessor.java", "diffHunk": "@@ -52,23 +60,35 @@ public void process(final Exchange exchange) throws Exception {\n             Element body = msgBody.getRootElement();\n \n             String pidValue = body.getChild(\"pid\", ATOM_NS).getTextTrim();\n-            Element isEditThumbnail = body.getChild(\"editThumbnail\", ATOM_NS);\n \n-            if (isEditThumbnail != null) {\n-                String mimeType = body.getChild(\"mimeType\", ATOM_NS).getTextTrim();\n+            String[] collThumbPath = pidValue.split(\"/\");\n+            String uuid = collThumbPath[collThumbPath.length - 1];\n+            PID objPid = PIDs.get(uuid);\n+\n+            if (repoObjLoader.getCollectionObject(objPid) != null) {", "originalCommit": "65d5e3c120736859fb9c397d6b9ad4151213232d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3b5f4dcd506886893fe51b679bc45b371b89266c", "url": "https://github.com/UNC-Libraries/box-c/commit/3b5f4dcd506886893fe51b679bc45b371b89266c", "message": "* Add non-binary processor\n* Update tests", "committedDate": "2020-04-15T14:39:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYwODgxNA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409608814", "bodyText": "It'd probably actually be okay to call getTypes() for all objects. I think for binaries it'd still work, and we want to be able to process AdminUnits and likely folders too.", "author": "bbpennel", "createdAt": "2020-04-16T14:37:37Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/BinaryEnhancementProcessor.java", "diffHunk": "@@ -48,10 +56,30 @@ public void process(final Exchange exchange) throws Exception {\n             Element body = msgBody.getRootElement();\n \n             String pidValue = body.getChild(\"pid\", ATOM_NS).getTextTrim();\n+            PID objPid = PIDs.get(pidValue);\n+\n+            try {\n+                RepositoryObject repoObj = repoObjLoader.getRepositoryObject(objPid);\n+\n+                log.info(\"Adding enhancement headers for \" + pidValue);\n+                in.setHeader(FCREPO_URI, pidValue);\n \n-            log.info(\"Adding enhancement headers for \" + pidValue);\n-            in.setHeader(FCREPO_URI, pidValue);\n-            in.setHeader(FCREPO_RESOURCE_TYPE, Binary.getURI());\n+                if (repoObj instanceof CollectionObject) {", "originalCommit": "3b5f4dcd506886893fe51b679bc45b371b89266c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYwOTYzMQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409609631", "bodyText": "I believe the resource type header expects a comma separated list of values. I'll admin i don't know how camel handles getting a header with a List as the value though. Does this work?", "author": "bbpennel", "createdAt": "2020-04-16T14:38:41Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/BinaryEnhancementProcessor.java", "diffHunk": "@@ -48,10 +56,30 @@ public void process(final Exchange exchange) throws Exception {\n             Element body = msgBody.getRootElement();\n \n             String pidValue = body.getChild(\"pid\", ATOM_NS).getTextTrim();\n+            PID objPid = PIDs.get(pidValue);\n+\n+            try {\n+                RepositoryObject repoObj = repoObjLoader.getRepositoryObject(objPid);\n+\n+                log.info(\"Adding enhancement headers for \" + pidValue);\n+                in.setHeader(FCREPO_URI, pidValue);\n \n-            log.info(\"Adding enhancement headers for \" + pidValue);\n-            in.setHeader(FCREPO_URI, pidValue);\n-            in.setHeader(FCREPO_RESOURCE_TYPE, Binary.getURI());\n+                if (repoObj instanceof CollectionObject) {\n+                    in.setHeader(FCREPO_RESOURCE_TYPE, repoObj.getTypes());", "originalCommit": "3b5f4dcd506886893fe51b679bc45b371b89266c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYxMTk1MA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409611950", "bodyText": "Spaces after commas", "author": "bbpennel", "createdAt": "2020-04-16T14:41:39Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/NonBinaryEnhancementProcessor.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.services.camel;\n+\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_DEPTH;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_SIZE;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPaths.idToPath;\n+import static edu.unc.lib.dl.services.camel.util.CdrFcrepoHeaders.CdrBinaryMimeType;\n+import static edu.unc.lib.dl.services.camel.util.CdrFcrepoHeaders.CdrBinaryPath;\n+import static edu.unc.lib.dl.services.camel.util.CdrFcrepoHeaders.CdrEditThumbnail;\n+import static org.fcrepo.camel.FcrepoHeaders.FCREPO_URI;\n+\n+import java.io.File;\n+import java.nio.file.Paths;\n+\n+import org.apache.camel.Exchange;\n+import org.apache.camel.Message;\n+import org.apache.camel.Processor;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+\n+/**\n+ * Processor to add headers to create display thumbnails for non-file objects\n+ *\n+ * @author lfarrell\n+ */\n+public class NonBinaryEnhancementProcessor implements Processor {\n+    private static final Logger log = LoggerFactory.getLogger(NonBinaryEnhancementProcessor.class);\n+\n+    private String dataDir;\n+\n+    @Override\n+    public void process(final Exchange exchange) throws Exception {\n+        final Message in = exchange.getIn();\n+\n+        String uri = (String) in.getHeader(FCREPO_URI);\n+        String uuid = PIDs.get(uri).getUUID();\n+        String objBasePath = idToPath(uuid, HASHED_PATH_DEPTH, HASHED_PATH_SIZE);\n+\n+        File imgFile = new File(Paths.get(dataDir,objBasePath, uuid).toString());", "originalCommit": "3b5f4dcd506886893fe51b679bc45b371b89266c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYxNTMxMQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409615311", "bodyText": "Also, you could save some steps and just keep imgFile as a Path. To check if the path is a file, there is Files.isRegularFile(path)", "author": "bbpennel", "createdAt": "2020-04-16T14:45:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYxMTk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYyNDc5NA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409624794", "bodyText": "You shouldn't need to double check the resource types here.\nI would really recommend not calling process.binary for non-binaries. It calls a couple extra things, and BinaryMetadataProcessor doesn't do anything for non-binary objects, so there's no need to call it.\nIf you split out a nonbinary route, you could call it immediately after nbProcessor and it could look like:\n        from(\"direct:process.nonbinary\")\n            .routeId(\"ProcessNonBinary\")\n            .choice()\n                .when(simple(\"<check that a binary path is set>\"))\n                    .setHeader(CdrEnhancementSet, constant(THUMBNAIL_ENHANCEMENTS))\n                    .log(INFO, \"Processing queued enhancements ${headers[CdrEnhancementSet]} for ${headers[CamelFcrepoUri]}\")\n                    .threads(enhancementThreads, enhancementThreads, \"CdrEnhancementThread\")\n                    .multicast()\n                    .to(\"direct:process.enhancements\", \"direct-vm:solrIndexing\");\n                .otherwise()\n                    .to(\"direct-vm:solrIndexing\")\n            .end();\n\nThen process.binary could have all the CdrEditThumbnail stuff trimmed out. I think you could actually remove the header entirely at that point", "author": "bbpennel", "createdAt": "2020-04-16T14:57:23Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/enhancements/EnhancementRouter.java", "diffHunk": "@@ -69,23 +72,42 @@ public void configure() throws Exception {\n                         + \" || ${headers[org.fcrepo.jms.resourceType]} contains '\" + Cdr.ContentRoot.getURI() + \"'\"\n                         ))\n                     .log(DEBUG, \"Processing enhancements for non-binary ${headers[CamelFcrepoUri]}\")\n-                    .to(\"direct-vm:solrIndexing\")\n+                    .process(nbProcessor)\n+                    .choice()", "originalCommit": "3b5f4dcd506886893fe51b679bc45b371b89266c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY0ODI0MQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409648241", "bodyText": "seems like we probably don't need to check the CdrEditThumbnail header, the resource type restriction should be enough to prevent bad indexing?", "author": "bbpennel", "createdAt": "2020-04-16T15:28:29Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/solr/SolrIngestProcessor.java", "diffHunk": "@@ -69,13 +70,15 @@ public SolrIngestProcessor(DocumentIndexingPackageFactory factory,\n     public void process(Exchange exchange) throws Exception {\n         final Message in = exchange.getIn();\n         String fcrepoUri = (String) in.getHeader(FCREPO_URI);\n+        String editThumbnail = (String) in.getHeader(CdrEditThumbnail);\n \n         List<PID> targetPids = new ArrayList<>();\n         PID targetPid = PIDs.get(fcrepoUri);\n         String resourceTypes = (String) in.getHeader(FCREPO_RESOURCE_TYPE);\n \n         // for binaries, need to index the file and work objects which contain it\n-        if (resourceTypes != null && resourceTypes.contains(Fcrepo4Repository.Binary.getURI())) {\n+        if (!Boolean.parseBoolean(editThumbnail) && resourceTypes != null &&", "originalCommit": "3b5f4dcd506886893fe51b679bc45b371b89266c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY0ODQ1NQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409648455", "bodyText": "Hopefully can remove this", "author": "bbpennel", "createdAt": "2020-04-16T15:28:42Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/util/CdrFcrepoHeaders.java", "diffHunk": "@@ -37,5 +37,7 @@\n \n     public static final String CdrEnhancementSet = \"CdrEnhancementSet\";\n \n+    public static final String CdrEditThumbnail = \"CdrEditThumbnail\";", "originalCommit": "3b5f4dcd506886893fe51b679bc45b371b89266c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMzAxOA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409723018", "bodyText": "What kind of operation would throw IllegalArgumentException? I'd usually expect a 4xx for bad input.", "author": "bbpennel", "createdAt": "2020-04-16T17:21:10Z", "path": "services/src/main/java/edu/unc/lib/dl/cdr/services/rest/EditThumbnailController.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.rest;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.web.bind.annotation.PathVariable;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+import org.springframework.web.multipart.MultipartFile;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.cdr.services.processing.ImportThumbnailService;\n+\n+/**\n+ * Controller for handling submission requests for collection display thumbnails\n+ *\n+ * @author lfarrell\n+ *\n+ */\n+@Controller\n+public class EditThumbnailController {\n+    private static final Logger log = LoggerFactory.getLogger(EditThumbnailController.class);\n+\n+    @Autowired\n+    private ImportThumbnailService service;\n+\n+    @PostMapping(value = \"edit/displayThumbnail/{pid}\")\n+    public @ResponseBody\n+    ResponseEntity<Object> ImportThumbnail(@PathVariable(\"pid\") String pid,\n+                                                     @RequestParam(\"file\") MultipartFile thumbnailFile)\n+            throws Exception {\n+\n+        AgentPrincipals agent = AgentPrincipals.createFromThread();\n+        String mimeType = thumbnailFile.getContentType();\n+\n+        Map<String, Object> result = new HashMap<>();\n+        result.put(\"action\", \"editThumbnail\");\n+        result.put(\"username\", agent.getUsername());\n+\n+        try (InputStream importStream = thumbnailFile.getInputStream()) {\n+            service.run(importStream, agent, pid, mimeType);\n+        } catch (IOException e) {\n+            log.error(\"Failed to get submitted file\", e);\n+            result.put(\"error\", e.getMessage());\n+            return new ResponseEntity<>(result, HttpStatus.INTERNAL_SERVER_ERROR);\n+        } catch (IllegalArgumentException e) {\n+            log.error(\"Error queueing the job\", e);\n+            result.put(\"error\", e.getMessage());\n+            return new ResponseEntity<>(result, HttpStatus.INTERNAL_SERVER_ERROR);", "originalCommit": "3b5f4dcd506886893fe51b679bc45b371b89266c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyOTIzNw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409729237", "bodyText": "indexing derivatives is sufficiently generic that i think you can remove the collection object restriction", "author": "bbpennel", "createdAt": "2020-04-16T17:30:53Z", "path": "solr-ingest/src/main/java/edu/unc/lib/dl/data/ingest/solr/filter/SetDatastreamFilter.java", "diffHunk": "@@ -60,22 +62,27 @@ public void filter(DocumentIndexingPackage dip) throws IndexingException {\n         ContentObject contentObj = dip.getContentObject();\n \n         FileObject fileObj = getFileObject(contentObj);\n-        if (fileObj == null) {\n-            return;\n+        if (fileObj != null) {\n+            boolean ownedByOtherObject = contentObj instanceof WorkObject;\n+            // Retrieve list of datastreams associated with this object\n+            List<Datastream> datastreams = getDatastreams(fileObj, ownedByOtherObject);\n+            // Retrieve list of derivatives associated with the object\n+            List<Datastream> derivatives = getDerivatives(fileObj.getPid(), ownedByOtherObject);\n+            datastreams.addAll(derivatives);\n+\n+            IndexDocumentBean doc = dip.getDocument();\n+\n+            doc.setDatastream(getDatastreamStrings(datastreams));\n+            doc.setFilesizeTotal(getFilesizeTotal(datastreams));\n+            doc.setFilesizeSort(getFilesize(datastreams));\n+        } else if (contentObj instanceof CollectionObject) {", "originalCommit": "3b5f4dcd506886893fe51b679bc45b371b89266c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ2NTcwNw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410465707", "bodyText": "I see that you have a commit about tests failing when you remove this. I think that means the tests need to be updated, since we now want to allow derivatives to be index for other types of objects", "author": "bbpennel", "createdAt": "2020-04-17T20:56:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyOTIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczMDI1NQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409730255", "bodyText": "Cant this be revived as a non-binary with source image test?", "author": "bbpennel", "createdAt": "2020-04-16T17:32:33Z", "path": "services-camel/src/test/java/edu/unc/lib/dl/services/camel/enhancements/EnhancementRouterIT.java", "diffHunk": "@@ -194,6 +212,26 @@ public void testImageFile() throws Exception {\n         verify(solrIngestProcessor).process(any(Exchange.class));\n     }\n \n+   /* @Test", "originalCommit": "3b5f4dcd506886893fe51b679bc45b371b89266c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczMzM1MQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r409733351", "bodyText": "I think this test is out of date? It should probably just be \"testNonBinary\". I'm not sure the setMessageBody(\"image/*\"); bit is doing anything either?", "author": "bbpennel", "createdAt": "2020-04-16T17:37:43Z", "path": "services-camel/src/test/java/edu/unc/lib/dl/services/camel/BinaryEnhancementProcessorTest.java", "diffHunk": "@@ -101,11 +116,23 @@ public void testExistingUriHeader() throws Exception {\n         verify(message, never()).setHeader(FCREPO_RESOURCE_TYPE, Binary.getURI());\n     }\n \n+    @Test\n+    public void testEditThumbnail() throws Exception {", "originalCommit": "3b5f4dcd506886893fe51b679bc45b371b89266c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3MzA2Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410273067", "bodyText": "Looks like it needs the message body, otherwise the processor will give a NPE", "author": "lfarrell", "createdAt": "2020-04-17T14:47:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczMzM1MQ=="}], "type": "inlineReview"}, {"oid": "cfde38928b1128ea9e737bd32a47fddf0171124f", "url": "https://github.com/UNC-Libraries/box-c/commit/cfde38928b1128ea9e737bd32a47fddf0171124f", "message": "Skip BinaryEnhancementProcessor for nonBinary objects with images", "committedDate": "2020-04-17T14:40:13Z", "type": "commit"}, {"oid": "54a4ba7cc5ff596211f0cd4368c8a713a69ee84c", "url": "https://github.com/UNC-Libraries/box-c/commit/54a4ba7cc5ff596211f0cd4368c8a713a69ee84c", "message": "Remove unused import", "committedDate": "2020-04-17T14:46:05Z", "type": "commit"}, {"oid": "aad5dce4af1cf8d1e825254d5b78162cd6371053", "url": "https://github.com/UNC-Libraries/box-c/commit/aad5dce4af1cf8d1e825254d5b78162cd6371053", "message": "Fix line lengths", "committedDate": "2020-04-17T14:59:17Z", "type": "commit"}, {"oid": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "url": "https://github.com/UNC-Libraries/box-c/commit/19693ce6c4725456f68eaeab5f5f00e97c32d93c", "message": "Tests fail without the collectionObject check", "committedDate": "2020-04-17T15:56:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzNDU4Ng==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410434586", "bodyText": "Does an unset header default to ''? I think we need to add a test for this router for non-binaries that don't have a source image.", "author": "bbpennel", "createdAt": "2020-04-17T19:45:20Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/enhancements/EnhancementRouter.java", "diffHunk": "@@ -68,24 +70,37 @@ public void configure() throws Exception {\n                         + \" || ${headers[org.fcrepo.jms.resourceType]} contains '\" + Cdr.AdminUnit.getURI() + \"'\"\n                         + \" || ${headers[org.fcrepo.jms.resourceType]} contains '\" + Cdr.ContentRoot.getURI() + \"'\"\n                         ))\n-                    .log(DEBUG, \"Processing enhancements for non-binary ${headers[CamelFcrepoUri]}\")\n-                    .to(\"direct-vm:solrIndexing\")\n+                .log(DEBUG, \"Processing enhancements for non-binary ${headers[CamelFcrepoUri]}\")\n+                .process(nbProcessor)\n+                .choice()\n+                    .when(simple(\"${headers[\" + CdrBinaryPath + \"]} == ''\"))", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzNTU2NQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410435565", "bodyText": "Could you either indent lines 73 through 85 to indicate they are part of their when clause, or move those same lines to a separate route? (process.nonbinary or some such)", "author": "bbpennel", "createdAt": "2020-04-17T19:47:24Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/enhancements/EnhancementRouter.java", "diffHunk": "@@ -68,24 +70,37 @@ public void configure() throws Exception {\n                         + \" || ${headers[org.fcrepo.jms.resourceType]} contains '\" + Cdr.AdminUnit.getURI() + \"'\"\n                         + \" || ${headers[org.fcrepo.jms.resourceType]} contains '\" + Cdr.ContentRoot.getURI() + \"'\"\n                         ))\n-                    .log(DEBUG, \"Processing enhancements for non-binary ${headers[CamelFcrepoUri]}\")\n-                    .to(\"direct-vm:solrIndexing\")\n+                .log(DEBUG, \"Processing enhancements for non-binary ${headers[CamelFcrepoUri]}\")", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzOTE0OA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410439148", "bodyText": "shortcut for writing to a file FileUtils.writeStringToFile(imgFile, \"image file\", StandardCharsets.UTF_8).\nYou also dont' need to delete files that are created inside of a TemporaryFolder, so that can be removed from these tests.", "author": "bbpennel", "createdAt": "2020-04-17T19:54:55Z", "path": "services-camel/src/test/java/edu/unc/lib/dl/services/camel/NonBinaryEnhancementProcessorTest.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.services.camel;\n+\n+import static edu.unc.lib.dl.services.camel.util.CdrFcrepoHeaders.CdrBinaryMimeType;\n+import static edu.unc.lib.dl.services.camel.util.CdrFcrepoHeaders.CdrBinaryPath;\n+import static org.fcrepo.camel.FcrepoHeaders.FCREPO_URI;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+\n+import org.apache.camel.Exchange;\n+import org.apache.camel.Message;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.mockito.Mock;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import edu.unc.lib.dl.test.TestHelper;\n+\n+/**\n+ * @author lfarrell\n+ */\n+public class NonBinaryEnhancementProcessorTest {\n+    private NonBinaryEnhancementProcessor processor;\n+\n+    @Rule\n+    public final TemporaryFolder tmpDir = new TemporaryFolder();\n+\n+    private static final String FEDORA_BASE = \"http://example.com/rest/\";\n+\n+    private static final String RESC_ID = \"de75d811-9e0f-4b1f-8631-2060ab3580cc\";\n+    private static final String RESC_URI = FEDORA_BASE + \"content/de/75/d8/11/\" + RESC_ID;\n+\n+    @Mock\n+    private Exchange exchange;\n+    @Mock\n+    private Message message;\n+    private File imgFile;\n+    private String dataDir;\n+\n+    @Before\n+    public void init() throws Exception {\n+        initMocks(this);\n+        dataDir = tmpDir.newFolder().getAbsolutePath();\n+\n+        TestHelper.setContentBase(FEDORA_BASE);\n+        processor = new NonBinaryEnhancementProcessor();\n+        processor.setSourceImagesDir(dataDir);\n+\n+        when(exchange.getIn()).thenReturn(message);\n+        when(message.getHeader(FCREPO_URI)).thenReturn(RESC_URI);\n+    }\n+\n+    @Test\n+    public void testCollectionWithImage() throws Exception {\n+        String derivativeFinalPath = \"de/75/d8/11/\" + RESC_ID;\n+        Path uploadedFilePath = Paths.get(dataDir, derivativeFinalPath);\n+        Files.createDirectories(uploadedFilePath.getParent());\n+\n+        imgFile = new File(uploadedFilePath.toString());", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzOTc4OQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410439789", "bodyText": "Should this test be removed since there is nonBinaryWithSourceImages already?\nAlso, I mentioned it elsewhere, but we should have a test for a nonbinary without a source image.", "author": "bbpennel", "createdAt": "2020-04-17T19:56:26Z", "path": "services-camel/src/test/java/edu/unc/lib/dl/services/camel/enhancements/EnhancementRouterIT.java", "diffHunk": "@@ -194,6 +210,26 @@ public void testImageFile() throws Exception {\n         verify(solrIngestProcessor).process(any(Exchange.class));\n     }\n \n+   /* @Test", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1ODAyMQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410458021", "bodyText": "Call .toFile() instead of toString()", "author": "bbpennel", "createdAt": "2020-04-17T20:38:21Z", "path": "services/src/main/java/edu/unc/lib/dl/cdr/services/processing/ImportThumbnailService.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.processing;\n+\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_DEPTH;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_SIZE;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPaths.idToPath;\n+import static edu.unc.lib.dl.services.RunEnhancementsMessageHelpers.makeEnhancementOperationBody;\n+import static org.apache.commons.io.FileUtils.copyInputStreamToFile;\n+import static org.apache.commons.lang3.StringUtils.containsIgnoreCase;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import org.jdom2.Document;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.acl.service.AccessControlService;\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.Permission;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.services.MessageSender;\n+\n+/**\n+ * Service to process requests to add/update display thumbnail for collection pages\n+ *\n+ * @author lfarrell\n+ */\n+public class ImportThumbnailService extends MessageSender {\n+    private static final Logger log = LoggerFactory.getLogger(ImportThumbnailService.class);\n+\n+    private String sourceImagesDir;\n+    private Path storagePath;\n+    private AccessControlService aclService;\n+    private MessageSender messageSender;\n+\n+    public void init() throws IOException {\n+        storagePath = Paths.get(sourceImagesDir);\n+\n+        // Create the directory if it doesn't already exist\n+        Files.createDirectories(storagePath);\n+    }\n+\n+    public void run(InputStream importStream, AgentPrincipals agent, String uuid, String mimeType) throws Exception {\n+        PID pid = PIDs.get(uuid);\n+\n+        aclService.assertHasAccess(\"User does not have permission to add/update collection thumbnails\",\n+                pid, agent.getPrincipals(), Permission.editDescription);\n+\n+        try {\n+            if (!containsIgnoreCase(mimeType, \"image\")) {\n+                throw new IllegalArgumentException(\"Uploaded file is not an image\");\n+            }\n+\n+            String thumbnailBasePath = idToPath(uuid, HASHED_PATH_DEPTH, HASHED_PATH_SIZE);\n+            String filePath = storagePath.resolve(thumbnailBasePath).resolve(uuid).toString();", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1OTAyOA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410459028", "bodyText": "Since its not restricted to collections anymore, change to \"add thumbnail to object\". Probably do the same for the access control message too, and I guess the javadoc for the class as well.", "author": "bbpennel", "createdAt": "2020-04-17T20:40:42Z", "path": "services/src/main/java/edu/unc/lib/dl/cdr/services/processing/ImportThumbnailService.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.processing;\n+\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_DEPTH;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_SIZE;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPaths.idToPath;\n+import static edu.unc.lib.dl.services.RunEnhancementsMessageHelpers.makeEnhancementOperationBody;\n+import static org.apache.commons.io.FileUtils.copyInputStreamToFile;\n+import static org.apache.commons.lang3.StringUtils.containsIgnoreCase;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import org.jdom2.Document;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.acl.service.AccessControlService;\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.Permission;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.services.MessageSender;\n+\n+/**\n+ * Service to process requests to add/update display thumbnail for collection pages\n+ *\n+ * @author lfarrell\n+ */\n+public class ImportThumbnailService extends MessageSender {\n+    private static final Logger log = LoggerFactory.getLogger(ImportThumbnailService.class);\n+\n+    private String sourceImagesDir;\n+    private Path storagePath;\n+    private AccessControlService aclService;\n+    private MessageSender messageSender;\n+\n+    public void init() throws IOException {\n+        storagePath = Paths.get(sourceImagesDir);\n+\n+        // Create the directory if it doesn't already exist\n+        Files.createDirectories(storagePath);\n+    }\n+\n+    public void run(InputStream importStream, AgentPrincipals agent, String uuid, String mimeType) throws Exception {\n+        PID pid = PIDs.get(uuid);\n+\n+        aclService.assertHasAccess(\"User does not have permission to add/update collection thumbnails\",\n+                pid, agent.getPrincipals(), Permission.editDescription);\n+\n+        try {\n+            if (!containsIgnoreCase(mimeType, \"image\")) {\n+                throw new IllegalArgumentException(\"Uploaded file is not an image\");\n+            }\n+\n+            String thumbnailBasePath = idToPath(uuid, HASHED_PATH_DEPTH, HASHED_PATH_SIZE);\n+            String filePath = storagePath.resolve(thumbnailBasePath).resolve(uuid).toString();\n+            File finalLocation = new File(filePath);\n+            copyInputStreamToFile(importStream, finalLocation);\n+\n+            Document msg = makeEnhancementOperationBody(agent.getUsername(), pid, false);\n+            messageSender.sendMessage(msg);\n+\n+            log.info(\"Job to to add thumbnail to collection {} has been queued by {}\",", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ2MDA4NQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410460085", "bodyText": "Realizing this is catching an exception that you're explicitly throwing above, and then rethrowing. You can probably remove this try block", "author": "bbpennel", "createdAt": "2020-04-17T20:43:14Z", "path": "services/src/main/java/edu/unc/lib/dl/cdr/services/processing/ImportThumbnailService.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.processing;\n+\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_DEPTH;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPathConstants.HASHED_PATH_SIZE;\n+import static edu.unc.lib.dl.fcrepo4.RepositoryPaths.idToPath;\n+import static edu.unc.lib.dl.services.RunEnhancementsMessageHelpers.makeEnhancementOperationBody;\n+import static org.apache.commons.io.FileUtils.copyInputStreamToFile;\n+import static org.apache.commons.lang3.StringUtils.containsIgnoreCase;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import org.jdom2.Document;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.acl.service.AccessControlService;\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.Permission;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.services.MessageSender;\n+\n+/**\n+ * Service to process requests to add/update display thumbnail for collection pages\n+ *\n+ * @author lfarrell\n+ */\n+public class ImportThumbnailService extends MessageSender {\n+    private static final Logger log = LoggerFactory.getLogger(ImportThumbnailService.class);\n+\n+    private String sourceImagesDir;\n+    private Path storagePath;\n+    private AccessControlService aclService;\n+    private MessageSender messageSender;\n+\n+    public void init() throws IOException {\n+        storagePath = Paths.get(sourceImagesDir);\n+\n+        // Create the directory if it doesn't already exist\n+        Files.createDirectories(storagePath);\n+    }\n+\n+    public void run(InputStream importStream, AgentPrincipals agent, String uuid, String mimeType) throws Exception {\n+        PID pid = PIDs.get(uuid);\n+\n+        aclService.assertHasAccess(\"User does not have permission to add/update collection thumbnails\",\n+                pid, agent.getPrincipals(), Permission.editDescription);\n+\n+        try {\n+            if (!containsIgnoreCase(mimeType, \"image\")) {\n+                throw new IllegalArgumentException(\"Uploaded file is not an image\");\n+            }\n+\n+            String thumbnailBasePath = idToPath(uuid, HASHED_PATH_DEPTH, HASHED_PATH_SIZE);\n+            String filePath = storagePath.resolve(thumbnailBasePath).resolve(uuid).toString();\n+            File finalLocation = new File(filePath);\n+            copyInputStreamToFile(importStream, finalLocation);\n+\n+            Document msg = makeEnhancementOperationBody(agent.getUsername(), pid, false);\n+            messageSender.sendMessage(msg);\n+\n+            log.info(\"Job to to add thumbnail to collection {} has been queued by {}\",\n+                    uuid, agent.getUsername());\n+        } catch (IllegalArgumentException e) {", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ2MTUxMw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410461513", "bodyText": "remove extra semi-colon", "author": "bbpennel", "createdAt": "2020-04-17T20:46:30Z", "path": "services/src/test/java/edu/unc/lib/dl/cdr/services/rest/EditThumbIT.java", "diffHunk": "@@ -0,0 +1,167 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.rest;\n+\n+import static edu.unc.lib.dl.acl.util.Permission.editDescription;\n+import static edu.unc.lib.dl.xml.JDOMNamespaceUtil.ATOM_NS;\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.anyString;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.reset;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.net.URI;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.jdom2.Document;\n+import org.jdom2.Element;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.mock.web.MockMultipartFile;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.ContextHierarchy;\n+import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;\n+\n+import edu.unc.lib.dl.acl.exception.AccessRestrictionException;\n+import edu.unc.lib.dl.acl.fcrepo4.AccessControlServiceImpl;\n+import edu.unc.lib.dl.acl.util.AccessGroupSet;\n+import edu.unc.lib.dl.acl.util.GroupsThreadStore;\n+import edu.unc.lib.dl.cdr.services.rest.modify.AbstractAPIIT;\n+import edu.unc.lib.dl.cdr.services.processing.ImportThumbnailService;\n+import edu.unc.lib.dl.fcrepo4.CollectionObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.services.MessageSender;\n+\n+/**\n+ * @author lfarrell\n+ */\n+@ContextHierarchy({\n+        @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n+        @ContextConfiguration(\"/spring-test/cdr-client-container.xml\"),\n+        @ContextConfiguration(\"/add-thumb-it-servlet.xml\")\n+})\n+public class EditThumbIT extends AbstractAPIIT {\n+    private static final String USER_NAME = \"user\";\n+    private static final String ADMIN_GROUP = \"adminGroup\";\n+    private CollectionObject collection;\n+\n+    @Rule\n+    public final TemporaryFolder tmpFolder = new TemporaryFolder();\n+\n+    @Captor\n+    private ArgumentCaptor<Document> docCaptor;\n+\n+    @Autowired\n+    private ImportThumbnailService service;\n+    @Autowired\n+    private AccessControlServiceImpl aclServices;\n+    @Autowired\n+    private MessageSender messageSender;\n+    @Autowired\n+    private RepositoryObjectFactory repositoryObjectFactory;\n+\n+    private File tempDir;\n+\n+    @Before\n+    public void init_() throws Exception {\n+        tempDir = tmpFolder.newFolder();\n+        service.setSourceImagesDir(tempDir.getAbsolutePath());\n+        service.init();\n+    }\n+\n+    @Before\n+    public void setup() {\n+        initMocks(this);\n+        reset(messageSender);\n+\n+        AccessGroupSet testPrincipals = new AccessGroupSet(ADMIN_GROUP);\n+\n+        GroupsThreadStore.storeUsername(USER_NAME);\n+        GroupsThreadStore.storeGroups(testPrincipals);\n+\n+        setupContentRoot();\n+        collection = repositoryObjectFactory.createCollectionObject(null);\n+    }\n+\n+    @Test\n+    public void addEditThumbnail() throws Exception {\n+        FileInputStream input = new FileInputStream(\"src/test/resources/upload-files/burndown.png\");\n+        MockMultipartFile thumbnailFile = new MockMultipartFile(\"file\", \"burndown.png\", \"image/png\", IOUtils.toByteArray(input));\n+\n+        mvc.perform(MockMvcRequestBuilders.multipart(URI.create(\"/edit/displayThumbnail/\" + collection.getPid().getUUID()))\n+                .file(thumbnailFile))\n+                .andExpect(status().is2xxSuccessful())\n+                .andReturn();\n+\n+        verify(messageSender).sendMessage(docCaptor.capture());\n+        Document msgDoc = docCaptor.getValue();\n+        assertMessageValues(msgDoc, collection.getPid());\n+    }\n+\n+    @Test\n+    public void addCollectionThumbWrongFileType() throws Exception {\n+        MockMultipartFile thumbnailFile = new MockMultipartFile(\"file\", \"file.txt\", \"plain/text\", textStream());\n+\n+        mvc.perform(MockMvcRequestBuilders.multipart(URI.create(\"/edit/displayThumbnail/\" + collection.getPid().getUUID()))\n+                .file(thumbnailFile))\n+                .andExpect(status().is4xxClientError())\n+                .andReturn();\n+\n+        verify(messageSender, never()).sendMessage(any(Document.class));\n+    }\n+\n+    @Test\n+    public void addCollectionThumbNoAccess() throws Exception {\n+        MockMultipartFile thumbnailFile = new MockMultipartFile(\"file\", \"file.txt\", \"plain/text\", textStream());\n+\n+        doThrow(new AccessRestrictionException()).when(aclServices)\n+                .assertHasAccess(anyString(), eq(collection.getPid()), any(AccessGroupSet.class), eq(editDescription));\n+\n+        mvc.perform(MockMvcRequestBuilders.multipart(URI.create(\"/edit/displayThumbnail/\" + collection.getPid().getUUID()))\n+                .file(thumbnailFile))\n+                .andExpect(status().isForbidden())\n+                .andReturn();\n+\n+        verify(messageSender, never()).sendMessage(any(Document.class));\n+    }\n+\n+    byte[] textStream() {\n+        return \"I am not an image\".getBytes();\n+    }\n+\n+    private void assertMessageValues(Document msgDoc, PID expectedPid) {\n+        Element entry = msgDoc.getRootElement();\n+        String pidString = entry.getChildText(\"pid\", ATOM_NS);;", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ2MTU2Mg==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410461562", "bodyText": "make method private", "author": "bbpennel", "createdAt": "2020-04-17T20:46:37Z", "path": "services/src/test/java/edu/unc/lib/dl/cdr/services/rest/EditThumbIT.java", "diffHunk": "@@ -0,0 +1,167 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.rest;\n+\n+import static edu.unc.lib.dl.acl.util.Permission.editDescription;\n+import static edu.unc.lib.dl.xml.JDOMNamespaceUtil.ATOM_NS;\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.anyString;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.reset;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.net.URI;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.jdom2.Document;\n+import org.jdom2.Element;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.mock.web.MockMultipartFile;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.ContextHierarchy;\n+import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;\n+\n+import edu.unc.lib.dl.acl.exception.AccessRestrictionException;\n+import edu.unc.lib.dl.acl.fcrepo4.AccessControlServiceImpl;\n+import edu.unc.lib.dl.acl.util.AccessGroupSet;\n+import edu.unc.lib.dl.acl.util.GroupsThreadStore;\n+import edu.unc.lib.dl.cdr.services.rest.modify.AbstractAPIIT;\n+import edu.unc.lib.dl.cdr.services.processing.ImportThumbnailService;\n+import edu.unc.lib.dl.fcrepo4.CollectionObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.services.MessageSender;\n+\n+/**\n+ * @author lfarrell\n+ */\n+@ContextHierarchy({\n+        @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n+        @ContextConfiguration(\"/spring-test/cdr-client-container.xml\"),\n+        @ContextConfiguration(\"/add-thumb-it-servlet.xml\")\n+})\n+public class EditThumbIT extends AbstractAPIIT {\n+    private static final String USER_NAME = \"user\";\n+    private static final String ADMIN_GROUP = \"adminGroup\";\n+    private CollectionObject collection;\n+\n+    @Rule\n+    public final TemporaryFolder tmpFolder = new TemporaryFolder();\n+\n+    @Captor\n+    private ArgumentCaptor<Document> docCaptor;\n+\n+    @Autowired\n+    private ImportThumbnailService service;\n+    @Autowired\n+    private AccessControlServiceImpl aclServices;\n+    @Autowired\n+    private MessageSender messageSender;\n+    @Autowired\n+    private RepositoryObjectFactory repositoryObjectFactory;\n+\n+    private File tempDir;\n+\n+    @Before\n+    public void init_() throws Exception {\n+        tempDir = tmpFolder.newFolder();\n+        service.setSourceImagesDir(tempDir.getAbsolutePath());\n+        service.init();\n+    }\n+\n+    @Before\n+    public void setup() {\n+        initMocks(this);\n+        reset(messageSender);\n+\n+        AccessGroupSet testPrincipals = new AccessGroupSet(ADMIN_GROUP);\n+\n+        GroupsThreadStore.storeUsername(USER_NAME);\n+        GroupsThreadStore.storeGroups(testPrincipals);\n+\n+        setupContentRoot();\n+        collection = repositoryObjectFactory.createCollectionObject(null);\n+    }\n+\n+    @Test\n+    public void addEditThumbnail() throws Exception {\n+        FileInputStream input = new FileInputStream(\"src/test/resources/upload-files/burndown.png\");\n+        MockMultipartFile thumbnailFile = new MockMultipartFile(\"file\", \"burndown.png\", \"image/png\", IOUtils.toByteArray(input));\n+\n+        mvc.perform(MockMvcRequestBuilders.multipart(URI.create(\"/edit/displayThumbnail/\" + collection.getPid().getUUID()))\n+                .file(thumbnailFile))\n+                .andExpect(status().is2xxSuccessful())\n+                .andReturn();\n+\n+        verify(messageSender).sendMessage(docCaptor.capture());\n+        Document msgDoc = docCaptor.getValue();\n+        assertMessageValues(msgDoc, collection.getPid());\n+    }\n+\n+    @Test\n+    public void addCollectionThumbWrongFileType() throws Exception {\n+        MockMultipartFile thumbnailFile = new MockMultipartFile(\"file\", \"file.txt\", \"plain/text\", textStream());\n+\n+        mvc.perform(MockMvcRequestBuilders.multipart(URI.create(\"/edit/displayThumbnail/\" + collection.getPid().getUUID()))\n+                .file(thumbnailFile))\n+                .andExpect(status().is4xxClientError())\n+                .andReturn();\n+\n+        verify(messageSender, never()).sendMessage(any(Document.class));\n+    }\n+\n+    @Test\n+    public void addCollectionThumbNoAccess() throws Exception {\n+        MockMultipartFile thumbnailFile = new MockMultipartFile(\"file\", \"file.txt\", \"plain/text\", textStream());\n+\n+        doThrow(new AccessRestrictionException()).when(aclServices)\n+                .assertHasAccess(anyString(), eq(collection.getPid()), any(AccessGroupSet.class), eq(editDescription));\n+\n+        mvc.perform(MockMvcRequestBuilders.multipart(URI.create(\"/edit/displayThumbnail/\" + collection.getPid().getUUID()))\n+                .file(thumbnailFile))\n+                .andExpect(status().isForbidden())\n+                .andReturn();\n+\n+        verify(messageSender, never()).sendMessage(any(Document.class));\n+    }\n+\n+    byte[] textStream() {", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ2NDI5OA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410464298", "bodyText": "I'm now realizing for the first time that the run enhancement messages don't say anything about run enhancement. We should add that in and filter for it (maybe in the BinaryEnhancementProcessor where it is currently checking for the fcrepo uri), otherwise if at some point in the future we have an error that sends messages to the wrong queue, it shouldn't trigger anything. Its also possible we might have more message types going through the router at some point.\nIt looks like the other operations in OperationsMessageSender create an element within the message with the name of the action, so it'd be \"\" in this case. \"pid\" and \"force\" should be inside of it. Also, the element and those two sub-elements should all be in the CDR_MESSAGE_NS.\nAnd the reason I realized that here, is that it would be good to test the sent message to see if it's marked as a runEnhancements message.", "author": "bbpennel", "createdAt": "2020-04-17T20:53:22Z", "path": "services/src/test/java/edu/unc/lib/dl/cdr/services/rest/EditThumbIT.java", "diffHunk": "@@ -0,0 +1,167 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.cdr.services.rest;\n+\n+import static edu.unc.lib.dl.acl.util.Permission.editDescription;\n+import static edu.unc.lib.dl.xml.JDOMNamespaceUtil.ATOM_NS;\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.anyString;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.reset;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.net.URI;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.jdom2.Document;\n+import org.jdom2.Element;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.mock.web.MockMultipartFile;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.ContextHierarchy;\n+import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;\n+\n+import edu.unc.lib.dl.acl.exception.AccessRestrictionException;\n+import edu.unc.lib.dl.acl.fcrepo4.AccessControlServiceImpl;\n+import edu.unc.lib.dl.acl.util.AccessGroupSet;\n+import edu.unc.lib.dl.acl.util.GroupsThreadStore;\n+import edu.unc.lib.dl.cdr.services.rest.modify.AbstractAPIIT;\n+import edu.unc.lib.dl.cdr.services.processing.ImportThumbnailService;\n+import edu.unc.lib.dl.fcrepo4.CollectionObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.services.MessageSender;\n+\n+/**\n+ * @author lfarrell\n+ */\n+@ContextHierarchy({\n+        @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n+        @ContextConfiguration(\"/spring-test/cdr-client-container.xml\"),\n+        @ContextConfiguration(\"/add-thumb-it-servlet.xml\")\n+})\n+public class EditThumbIT extends AbstractAPIIT {\n+    private static final String USER_NAME = \"user\";\n+    private static final String ADMIN_GROUP = \"adminGroup\";\n+    private CollectionObject collection;\n+\n+    @Rule\n+    public final TemporaryFolder tmpFolder = new TemporaryFolder();\n+\n+    @Captor\n+    private ArgumentCaptor<Document> docCaptor;\n+\n+    @Autowired\n+    private ImportThumbnailService service;\n+    @Autowired\n+    private AccessControlServiceImpl aclServices;\n+    @Autowired\n+    private MessageSender messageSender;\n+    @Autowired\n+    private RepositoryObjectFactory repositoryObjectFactory;\n+\n+    private File tempDir;\n+\n+    @Before\n+    public void init_() throws Exception {\n+        tempDir = tmpFolder.newFolder();\n+        service.setSourceImagesDir(tempDir.getAbsolutePath());\n+        service.init();\n+    }\n+\n+    @Before\n+    public void setup() {\n+        initMocks(this);\n+        reset(messageSender);\n+\n+        AccessGroupSet testPrincipals = new AccessGroupSet(ADMIN_GROUP);\n+\n+        GroupsThreadStore.storeUsername(USER_NAME);\n+        GroupsThreadStore.storeGroups(testPrincipals);\n+\n+        setupContentRoot();\n+        collection = repositoryObjectFactory.createCollectionObject(null);\n+    }\n+\n+    @Test\n+    public void addEditThumbnail() throws Exception {\n+        FileInputStream input = new FileInputStream(\"src/test/resources/upload-files/burndown.png\");\n+        MockMultipartFile thumbnailFile = new MockMultipartFile(\"file\", \"burndown.png\", \"image/png\", IOUtils.toByteArray(input));\n+\n+        mvc.perform(MockMvcRequestBuilders.multipart(URI.create(\"/edit/displayThumbnail/\" + collection.getPid().getUUID()))\n+                .file(thumbnailFile))\n+                .andExpect(status().is2xxSuccessful())\n+                .andReturn();\n+\n+        verify(messageSender).sendMessage(docCaptor.capture());\n+        Document msgDoc = docCaptor.getValue();\n+        assertMessageValues(msgDoc, collection.getPid());\n+    }\n+\n+    @Test\n+    public void addCollectionThumbWrongFileType() throws Exception {\n+        MockMultipartFile thumbnailFile = new MockMultipartFile(\"file\", \"file.txt\", \"plain/text\", textStream());\n+\n+        mvc.perform(MockMvcRequestBuilders.multipart(URI.create(\"/edit/displayThumbnail/\" + collection.getPid().getUUID()))\n+                .file(thumbnailFile))\n+                .andExpect(status().is4xxClientError())\n+                .andReturn();\n+\n+        verify(messageSender, never()).sendMessage(any(Document.class));\n+    }\n+\n+    @Test\n+    public void addCollectionThumbNoAccess() throws Exception {\n+        MockMultipartFile thumbnailFile = new MockMultipartFile(\"file\", \"file.txt\", \"plain/text\", textStream());\n+\n+        doThrow(new AccessRestrictionException()).when(aclServices)\n+                .assertHasAccess(anyString(), eq(collection.getPid()), any(AccessGroupSet.class), eq(editDescription));\n+\n+        mvc.perform(MockMvcRequestBuilders.multipart(URI.create(\"/edit/displayThumbnail/\" + collection.getPid().getUUID()))\n+                .file(thumbnailFile))\n+                .andExpect(status().isForbidden())\n+                .andReturn();\n+\n+        verify(messageSender, never()).sendMessage(any(Document.class));\n+    }\n+\n+    byte[] textStream() {\n+        return \"I am not an image\".getBytes();\n+    }\n+\n+    private void assertMessageValues(Document msgDoc, PID expectedPid) {", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ2NjYxMA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r410466610", "bodyText": "I think you can get rid of this list, its just a copy of the first one, and is the only thing the first one is used for.", "author": "bbpennel", "createdAt": "2020-04-17T20:58:41Z", "path": "solr-ingest/src/main/java/edu/unc/lib/dl/data/ingest/solr/filter/SetDatastreamFilter.java", "diffHunk": "@@ -60,22 +62,27 @@ public void filter(DocumentIndexingPackage dip) throws IndexingException {\n         ContentObject contentObj = dip.getContentObject();\n \n         FileObject fileObj = getFileObject(contentObj);\n-        if (fileObj == null) {\n-            return;\n+        if (fileObj != null) {\n+            boolean ownedByOtherObject = contentObj instanceof WorkObject;\n+            // Retrieve list of datastreams associated with this object\n+            List<Datastream> datastreams = getDatastreams(fileObj, ownedByOtherObject);\n+            // Retrieve list of derivatives associated with the object\n+            List<Datastream> derivatives = getDerivatives(fileObj.getPid(), ownedByOtherObject);\n+            datastreams.addAll(derivatives);\n+\n+            IndexDocumentBean doc = dip.getDocument();\n+\n+            doc.setDatastream(getDatastreamStrings(datastreams));\n+            doc.setFilesizeTotal(getFilesizeTotal(datastreams));\n+            doc.setFilesizeSort(getFilesize(datastreams));\n+        } else if (contentObj instanceof CollectionObject) {\n+            List<Datastream> derivatives = getDerivatives(contentObj.getPid(), false);\n+            List<Datastream> datastreams = new ArrayList<>(derivatives);", "originalCommit": "19693ce6c4725456f68eaeab5f5f00e97c32d93c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "49f6d8d94f38dd4466b4668b6f48a644ba89b34e", "url": "https://github.com/UNC-Libraries/box-c/commit/49f6d8d94f38dd4466b4668b6f48a644ba89b34e", "message": "* Add enhancement message\n* Cleanup routes and tests", "committedDate": "2020-04-20T13:42:20Z", "type": "commit"}, {"oid": "5fdd931f9e1575e024ef796dd95a4aaaec0df595", "url": "https://github.com/UNC-Libraries/box-c/commit/5fdd931f9e1575e024ef796dd95a4aaaec0df595", "message": "Nest enhancement msg", "committedDate": "2020-04-20T15:59:42Z", "type": "commit"}, {"oid": "bc4119d4ad93f2316df8da163ae0f4bb7caa5690", "url": "https://github.com/UNC-Libraries/box-c/commit/bc4119d4ad93f2316df8da163ae0f4bb7caa5690", "message": "Fix test errors", "committedDate": "2020-04-20T16:57:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MTU0MA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r411581540", "bodyText": "use the cdr message namespace for the enhancement element and the pid element", "author": "bbpennel", "createdAt": "2020-04-20T18:02:15Z", "path": "persistence/src/main/java/edu/unc/lib/dl/services/RunEnhancementsMessageHelpers.java", "diffHunk": "@@ -47,12 +47,20 @@ public static Document makeEnhancementOperationBody(String userid, PID pid, Bool\n         Element entry = new Element(\"entry\", ATOM_NS);\n         entry.addContent(new Element(\"author\", ATOM_NS)\n                 .addContent(new Element(\"name\", ATOM_NS).setText(userid)));\n-        entry.addContent(new Element(\"pid\", ATOM_NS).setText(pid.getRepositoryPath()));\n+\n+        Element paramForce = new Element(\"force\", CDR_MESSAGE_NS);\n \n         if (force) {\n-            Element paramForce = new Element(\"force\", CDR_MESSAGE_NS);\n             paramForce.setText(\"true\");\n+        } else {\n+            paramForce.setText(\"false\");\n         }\n+\n+        Element enhancements = new Element(ENHANCEMENTS.getName(), ATOM_NS);", "originalCommit": "bc4119d4ad93f2316df8da163ae0f4bb7caa5690", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MTk2OQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r411581969", "bodyText": "good idea to add a constant. My only suggestion is to make it a verb/action since all the other ones are", "author": "bbpennel", "createdAt": "2020-04-20T18:02:59Z", "path": "metadata/src/main/java/edu/unc/lib/dl/util/JMSMessageUtil.java", "diffHunk": "@@ -110,6 +110,7 @@ public static FedoraActions getAction(String value) {\n         ADD(\"add\"),\n         EDIT_ACCESS_CONTROL(\"editAccess\"),\n         EDIT_TYPE(\"editType\"),\n+        ENHANCEMENTS(\"enhancements\"),", "originalCommit": "bc4119d4ad93f2316df8da163ae0f4bb7caa5690", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MjgzMA==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r411582830", "bodyText": "has usually implies a boolean and isn't really what this is storing, maybe just enhancementEl or something like that?", "author": "bbpennel", "createdAt": "2020-04-20T18:04:19Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/BinaryEnhancementProcessor.java", "diffHunk": "@@ -47,11 +53,28 @@ public void process(final Exchange exchange) throws Exception {\n             Document msgBody = MessageUtil.getDocumentBody(in);\n             Element body = msgBody.getRootElement();\n \n-            String pidValue = body.getChild(\"pid\", ATOM_NS).getTextTrim();\n+            Element hasEnhancementPid = body.getChild(\"enhancements\", ATOM_NS);", "originalCommit": "bc4119d4ad93f2316df8da163ae0f4bb7caa5690", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MzkzMw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r411583933", "bodyText": "also, use the constant from JMSElementUtil for the name of this element", "author": "bbpennel", "createdAt": "2020-04-20T18:06:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MjgzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NzQ1OQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r411587459", "bodyText": "Should check verify(solrIngestProcessor).process(any(Exchange.class));  too", "author": "bbpennel", "createdAt": "2020-04-20T18:11:56Z", "path": "services-camel/src/test/java/edu/unc/lib/dl/services/camel/enhancements/EnhancementRouterIT.java", "diffHunk": "@@ -162,14 +179,32 @@ public void testFolderEnhancements() throws Exception {\n     }\n \n     @Test\n-    public void testImageFile() throws Exception {\n+    public void nonBinaryNoSourceImages() throws Exception {\n+        CollectionObject collObject = repoObjectFactory.createCollectionObject(null);\n+        final Map<String, Object> headers = createEvent(false, collObject.getPid(),\n+                Cdr.Collection.getURI(), Container.getURI());\n+        template.sendBodyAndHeaders(\"\", headers);\n+\n+        NotifyBuilder notify1 = new NotifyBuilder(cdrEnhancements)\n+                .whenCompleted(1)\n+                .create();\n+\n+        boolean result1 = notify1.matches(5l, TimeUnit.SECONDS);\n+        assertTrue(\"Enhancement route not satisfied\", result1);\n+\n+        verify(addSmallThumbnailProcessor, never()).process(any(Exchange.class));\n+        verify(addLargeThumbnailProcessor, never()).process(any(Exchange.class));", "originalCommit": "bc4119d4ad93f2316df8da163ae0f4bb7caa5690", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE2MTc4Mg==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r412161782", "bodyText": "The solr ingest processor should run in this case, if its not then that would be a bug", "author": "bbpennel", "createdAt": "2020-04-21T12:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NzQ1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5Mjc1Mg==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r411592752", "bodyText": "No datastreams are going to get indexed for objects other than works and files, i think? Did you need to get rid of the other side of this conditional? We still need to index other objects, we just don't need to restrict it to CollectionObjects, which is what you had before.", "author": "bbpennel", "createdAt": "2020-04-20T18:20:45Z", "path": "solr-ingest/src/main/java/edu/unc/lib/dl/data/ingest/solr/filter/SetDatastreamFilter.java", "diffHunk": "@@ -60,22 +60,20 @@ public void filter(DocumentIndexingPackage dip) throws IndexingException {\n         ContentObject contentObj = dip.getContentObject();\n \n         FileObject fileObj = getFileObject(contentObj);\n-        if (fileObj == null) {\n-            return;\n+        if (fileObj != null) {", "originalCommit": "bc4119d4ad93f2316df8da163ae0f4bb7caa5690", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY3MDQwNQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r411670405", "bodyText": "So are we back to this?\n  if (fileObj != null) {\n            boolean ownedByOtherObject = contentObj instanceof WorkObject;\n            // Retrieve list of datastreams associated with this object\n            List<Datastream> datastreams = getDatastreams(fileObj, ownedByOtherObject);\n            // Retrieve list of derivatives associated with the object\n            List<Datastream> derivatives = getDerivatives(fileObj.getPid(), ownedByOtherObject);\n            datastreams.addAll(derivatives);\n\n            IndexDocumentBean doc = dip.getDocument();\n\n            doc.setDatastream(getDatastreamStrings(datastreams));\n            doc.setFilesizeTotal(getFilesizeTotal(datastreams));\n            doc.setFilesizeSort(getFilesize(datastreams));\n        } else {\n            List<Datastream> derivatives = getDerivatives(contentObj.getPid(), false);\n            List<Datastream> datastreams = new ArrayList<>(derivatives);\n\n            IndexDocumentBean doc = dip.getDocument();\n\n            doc.setDatastream(getDatastreamStrings(datastreams));\n        }```", "author": "lfarrell", "createdAt": "2020-04-20T20:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5Mjc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE1OTY3Ng==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r412159676", "bodyText": "yes almost, my last comment was that in the second block, derivatives and datastreams have the exact same stuff in them, so there's no reason to make the second variable. We do need the else block which covers objects besides works and files.", "author": "bbpennel", "createdAt": "2020-04-21T12:55:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5Mjc1Mg=="}], "type": "inlineReview"}, {"oid": "012de7ff652a17aa2d93ec0dd0600bd1983431be", "url": "https://github.com/UNC-Libraries/box-c/commit/012de7ff652a17aa2d93ec0dd0600bd1983431be", "message": "* Switch message namespace\n* Let more messages through datastream filter", "committedDate": "2020-04-21T12:19:25Z", "type": "commit"}, {"oid": "4e98f275fa94db72228aa3839586d73711e76c18", "url": "https://github.com/UNC-Libraries/box-c/commit/4e98f275fa94db72228aa3839586d73711e76c18", "message": "Fix namespace", "committedDate": "2020-04-21T12:56:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE2MTA5MQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r412161091", "bodyText": "use the JMSMessageUtil.CDRActions.RUN_ENHANCEMENTS constant here", "author": "bbpennel", "createdAt": "2020-04-21T12:57:50Z", "path": "services-camel/src/main/java/edu/unc/lib/dl/services/camel/BinaryEnhancementProcessor.java", "diffHunk": "@@ -53,9 +53,9 @@ public void process(final Exchange exchange) throws Exception {\n             Document msgBody = MessageUtil.getDocumentBody(in);\n             Element body = msgBody.getRootElement();\n \n-            Element hasEnhancementPid = body.getChild(\"enhancements\", ATOM_NS);\n-            if (hasEnhancementPid != null) {\n-                String pidValue = hasEnhancementPid.getChild(\"pid\", ATOM_NS).getTextTrim();\n+            Element enhancementsEl = body.getChild(\"runEnhancements\", CDR_MESSAGE_NS);", "originalCommit": "012de7ff652a17aa2d93ec0dd0600bd1983431be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "82c96c8761a176d76fcacf5d6c2d167c531f31b2", "url": "https://github.com/UNC-Libraries/box-c/commit/82c96c8761a176d76fcacf5d6c2d167c531f31b2", "message": "* Update filter\n* Use run enhancement constant\n* Fix filtering of messages with no binary", "committedDate": "2020-04-21T13:19:11Z", "type": "commit"}, {"oid": "d44fbefd2b3c0cdf3d2672692fd5c39574ea74af", "url": "https://github.com/UNC-Libraries/box-c/commit/d44fbefd2b3c0cdf3d2672692fd5c39574ea74af", "message": "Remove unused import", "committedDate": "2020-04-21T13:39:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIwNDQ2Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r412204467", "bodyText": "This test should verify that thumbnail enhancements are being called. You could also check that the access copy is not called.", "author": "bbpennel", "createdAt": "2020-04-21T13:53:31Z", "path": "services-camel/src/test/java/edu/unc/lib/dl/services/camel/enhancements/EnhancementRouterIT.java", "diffHunk": "@@ -137,11 +154,11 @@ public void init() throws Exception {\n     }\n \n     @Test\n-    public void testFolderEnhancements() throws Exception {\n+    public void nonBinaryWithSourceImages() throws Exception {", "originalCommit": "d44fbefd2b3c0cdf3d2672692fd5c39574ea74af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIwNjkyNg==", "url": "https://github.com/UNC-Libraries/box-c/pull/955#discussion_r412206926", "bodyText": "I think this and the if (editThumb) should be removed, since the router and its processes should be setting these headers. You should also be able to remove the boolean editThumb parameter from this method", "author": "bbpennel", "createdAt": "2020-04-21T13:56:24Z", "path": "services-camel/src/test/java/edu/unc/lib/dl/services/camel/enhancements/EnhancementRouterIT.java", "diffHunk": "@@ -268,13 +304,20 @@ public void testProcessFilterOutDescriptiveMDSolr() throws Exception {\n         verify(solrIngestProcessor, never()).process(any(Exchange.class));\n     }\n \n-    private static Map<String, Object> createEvent(PID pid, String... type) {\n-\n+    private Map<String, Object> createEvent(boolean editThumb, PID pid, String... type) {\n         final Map<String, Object> headers = new HashMap<>();\n         headers.put(IDENTIFIER, pid.getRepositoryPath());\n         headers.put(EVENT_TYPE, \"ResourceCreation\");\n         headers.put(\"CamelFcrepoUri\", pid.getRepositoryPath());\n         headers.put(RESOURCE_TYPE, String.join(\",\", type));\n+        headers.put(CdrBinaryMimeType, \"text/plain\");", "originalCommit": "d44fbefd2b3c0cdf3d2672692fd5c39574ea74af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "63bd228a2e647726ab7239199bcf1b3574f6c944", "url": "https://github.com/UNC-Libraries/box-c/commit/63bd228a2e647726ab7239199bcf1b3574f6c944", "message": "Remove extra headers for thumbnails", "committedDate": "2020-04-21T17:43:16Z", "type": "commit"}, {"oid": "a931735a247f0e8decad80fb31f712675f903274", "url": "https://github.com/UNC-Libraries/box-c/commit/a931735a247f0e8decad80fb31f712675f903274", "message": "Fix test", "committedDate": "2020-04-21T17:59:09Z", "type": "commit"}]}