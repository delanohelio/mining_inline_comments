{"pr_number": 937, "pr_title": "Mark file server ingests private", "pr_createdAt": "2020-03-23T17:58:05Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/937", "timeline": [{"oid": "feec1596dfc44df2a08ac7008aebc08daba7e724", "url": "https://github.com/UNC-Libraries/box-c/commit/feec1596dfc44df2a08ac7008aebc08daba7e724", "message": "Update form and submission package to add staffOnly option for ingests", "committedDate": "2020-03-20T20:07:04Z", "type": "commit"}, {"oid": "9a6037b263e6392f7209907d8c2cb96d40df38a6", "url": "https://github.com/UNC-Libraries/box-c/commit/9a6037b263e6392f7209907d8c2cb96d40df38a6", "message": "Fix issue with users clicking row before clicking an action checkbox", "committedDate": "2020-03-23T14:09:37Z", "type": "commit"}, {"oid": "6053fd95b554bdc570401881c1a61556f97689cd", "url": "https://github.com/UNC-Libraries/box-c/commit/6053fd95b554bdc570401881c1a61556f97689cd", "message": "Add staffOnly to depositJob", "committedDate": "2020-03-23T17:06:44Z", "type": "commit"}, {"oid": "3a69ada4be6cd17f4968cd2a2f2ff3e245a1014a", "url": "https://github.com/UNC-Libraries/box-c/commit/3a69ada4be6cd17f4968cd2a2f2ff3e245a1014a", "message": "Move where access control is added", "committedDate": "2020-03-23T20:57:52Z", "type": "commit"}, {"oid": "da5186284f3bb3ce0c2211fce676b62a525d996c", "url": "https://github.com/UNC-Libraries/box-c/commit/da5186284f3bb3ce0c2211fce676b62a525d996c", "message": "Add permissions via the model instead of using a service", "committedDate": "2020-03-24T14:59:56Z", "type": "commit"}, {"oid": "6a261fa8b22ff400c6e94987468568ba012cc4e8", "url": "https://github.com/UNC-Libraries/box-c/commit/6a261fa8b22ff400c6e94987468568ba012cc4e8", "message": "Check that permissions are set", "committedDate": "2020-03-24T20:30:12Z", "type": "forcePushed"}, {"oid": "f51157a201beddc064820696b68528bc42b29a0d", "url": "https://github.com/UNC-Libraries/box-c/commit/f51157a201beddc064820696b68528bc42b29a0d", "message": "Check that permissions are set", "committedDate": "2020-03-25T17:15:44Z", "type": "forcePushed"}, {"oid": "c29119699cc71f564c3717efdd474aca10febe25", "url": "https://github.com/UNC-Libraries/box-c/commit/c29119699cc71f564c3717efdd474aca10febe25", "message": "Check that permissions are set", "committedDate": "2020-03-25T17:22:20Z", "type": "forcePushed"}, {"oid": "ce43526854563219f93e39893bb08cd70cc675c4", "url": "https://github.com/UNC-Libraries/box-c/commit/ce43526854563219f93e39893bb08cd70cc675c4", "message": "Check that permissions are set", "committedDate": "2020-03-25T17:24:35Z", "type": "forcePushed"}, {"oid": "e1e1c797156996711e57816dc52059ac54281ecf", "url": "https://github.com/UNC-Libraries/box-c/commit/e1e1c797156996711e57816dc52059ac54281ecf", "message": "Check that permissions are set", "committedDate": "2020-03-25T17:28:25Z", "type": "forcePushed"}, {"oid": "045dee7b26646c6ef4d4b8e39d784c0813a09d74", "url": "https://github.com/UNC-Libraries/box-c/commit/045dee7b26646c6ef4d4b8e39d784c0813a09d74", "message": "Check that permissions are set", "committedDate": "2020-03-25T17:29:20Z", "type": "forcePushed"}, {"oid": "45d34809a8fef6db614081269dad4c3d99b04682", "url": "https://github.com/UNC-Libraries/box-c/commit/45d34809a8fef6db614081269dad4c3d99b04682", "message": "Check that permissions are set", "committedDate": "2020-03-25T17:30:38Z", "type": "forcePushed"}, {"oid": "fd08db8a682fc43063d3057cdeb7e82aa0eec5b5", "url": "https://github.com/UNC-Libraries/box-c/commit/fd08db8a682fc43063d3057cdeb7e82aa0eec5b5", "message": "Check that permissions are set", "committedDate": "2020-03-25T17:37:34Z", "type": "commit"}, {"oid": "e20a2253a42c6bd09889964c05cd53759f6e36cc", "url": "https://github.com/UNC-Libraries/box-c/commit/e20a2253a42c6bd09889964c05cd53759f6e36cc", "message": "Add tests for marking ingests staff only", "committedDate": "2020-03-26T13:02:34Z", "type": "forcePushed"}, {"oid": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "url": "https://github.com/UNC-Libraries/box-c/commit/5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "message": "Add tests for marking ingests staff only", "committedDate": "2020-03-26T13:15:01Z", "type": "commit"}, {"oid": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "url": "https://github.com/UNC-Libraries/box-c/commit/5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "message": "Add tests for marking ingests staff only", "committedDate": "2020-03-26T13:15:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4NDk2Ng==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398584966", "bodyText": "Remove this, think its leftover", "author": "bbpennel", "createdAt": "2020-03-26T13:48:11Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestDepositRecordJob.java", "diffHunk": "@@ -145,6 +145,10 @@ private Resource makeDepositRecord(Resource deposit, Map<String, String> status)\n         if (onBehalfOf != null) {\n             aipObjResc.addProperty(Cdr.depositedOnBehalfOf, onBehalfOf);\n         }\n+        String staffOnly = status.get(DepositField.staffOnly.name());", "originalCommit": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc0MTUwOA==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398741508", "bodyText": "This should be used by the line right below it.", "author": "lfarrell", "createdAt": "2020-03-26T17:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4NDk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc0MTk0Mg==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398741942", "bodyText": "Never mind, I see what you mean.", "author": "lfarrell", "createdAt": "2020-03-26T17:08:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4NDk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4NTEyMw==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398585123", "bodyText": "Description", "author": "bbpennel", "createdAt": "2020-03-26T13:48:22Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/StaffOnlyPermissionJob.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.deposit.fcrepo4;\n+\n+import static edu.unc.lib.dl.acl.util.AccessPrincipalConstants.AUTHENTICATED_PRINC;\n+import static edu.unc.lib.dl.acl.util.AccessPrincipalConstants.PUBLIC_PRINC;\n+\n+import java.util.Map;\n+\n+import org.apache.jena.rdf.model.Bag;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.NodeIterator;\n+import org.apache.jena.rdf.model.Resource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.util.RedisWorkerConstants.DepositField;\n+import edu.unc.lib.deposit.work.AbstractDepositJob;\n+import edu.unc.lib.dl.rdf.CdrAcl;\n+\n+/**\n+ *", "originalCommit": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4Njg0MA==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398586840", "bodyText": "You only need to make the determination that the deposit is staff only once, i'd suggest checking this before line 54 Model model = getWritableModel(); and doing an early return if not staff only.\nAlternatively, you could remove the check since the check is (trying to) happen in the DepositSupervisor.", "author": "bbpennel", "createdAt": "2020-03-26T13:50:27Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/StaffOnlyPermissionJob.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.deposit.fcrepo4;\n+\n+import static edu.unc.lib.dl.acl.util.AccessPrincipalConstants.AUTHENTICATED_PRINC;\n+import static edu.unc.lib.dl.acl.util.AccessPrincipalConstants.PUBLIC_PRINC;\n+\n+import java.util.Map;\n+\n+import org.apache.jena.rdf.model.Bag;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.NodeIterator;\n+import org.apache.jena.rdf.model.Resource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.util.RedisWorkerConstants.DepositField;\n+import edu.unc.lib.deposit.work.AbstractDepositJob;\n+import edu.unc.lib.dl.rdf.CdrAcl;\n+\n+/**\n+ *\n+ * @author lfarrell\n+ *\n+ */\n+public class StaffOnlyPermissionJob extends AbstractDepositJob {\n+    private static final Logger log = LoggerFactory.getLogger(StaffOnlyPermissionJob.class);\n+\n+    public StaffOnlyPermissionJob() {\n+        super();\n+    }\n+\n+    public StaffOnlyPermissionJob(String uuid, String depositUUID) {\n+        super(uuid, depositUUID);\n+    }\n+\n+    @Override\n+    public void runJob() {\n+        log.debug(\"Setting staff only permissions for deposit {}\", getDepositPID());\n+\n+        Model model = getWritableModel();\n+        Bag depositBag = model.getBag(getDepositPID().getRepositoryPath());\n+        NodeIterator iterator = getChildIterator(depositBag);\n+\n+        if (iterator.hasNext()) {\n+            Resource childResc = (Resource) iterator.next();\n+            setStaffOnly(childResc, model);\n+        }\n+    }\n+\n+    private void setStaffOnly(Resource resc, Model model) {\n+        Map<String, String> depositStatus = getDepositStatus();\n+        String staffOnly = depositStatus.get(DepositField.staffOnly.name());\n+\n+        if (Boolean.parseBoolean(staffOnly)) {", "originalCommit": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4ODA1MQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398588051", "bodyText": "Remove this, you are already creating the job further down and this conditional will always be false", "author": "bbpennel", "createdAt": "2020-03-26T13:51:54Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/work/DepositSupervisor.java", "diffHunk": "@@ -586,7 +587,9 @@ private Job getNextJob(Job job, String depositUUID, Map<String, String> status,\n                 conversion = makeJob(BagIt2N3BagJob.class, depositUUID);\n             } else if (packagingType.equals(PackagingType.DIRECTORY.getUri())) {\n                 conversion = makeJob(DirectoryToBagJob.class, depositUUID);\n-             }\n+            } else if (DepositField.staffOnly.name().equals(\"true\")) {", "originalCommit": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU5MjE5Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398592197", "bodyText": "This job needs to happen before IngestContentObjectsJob, otherwise the patron roles won't be ingested into fedora. I'd prefer if it happened before IngestDepositRecordJob as well, so that all the modification jobs happen before the ingest jobs start", "author": "bbpennel", "createdAt": "2020-03-26T13:57:08Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/work/DepositSupervisor.java", "diffHunk": "@@ -661,6 +664,12 @@ private Job getNextJob(Job job, String depositUUID, Map<String, String> status,\n             return makeJob(IngestContentObjectsJob.class, depositUUID);\n         }\n \n+        // Mark objects staff only if flag is set", "originalCommit": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU5NDk5Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398594997", "bodyText": "you don't need any of the storage location related stuff in this test since the job doesn't interact with the binaries. So you can remove all the variables below this line, and the constants that go with them.", "author": "bbpennel", "createdAt": "2020-03-26T14:00:47Z", "path": "deposit/src/test/java/edu/unc/lib/deposit/fcrepo4/StaffOnlyPermissionJobTest.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.deposit.fcrepo4;\n+\n+import static edu.unc.lib.dl.acl.util.AccessPrincipalConstants.AUTHENTICATED_PRINC;\n+import static edu.unc.lib.dl.acl.util.AccessPrincipalConstants.PUBLIC_PRINC;\n+import static edu.unc.lib.dl.acl.util.UserRole.none;\n+import static edu.unc.lib.dl.test.TestHelpers.setField;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import edu.unc.lib.dl.persist.api.storage.StorageLocationManager;\n+import edu.unc.lib.dl.persist.services.storage.StorageLocationTestHelper;\n+import edu.unc.lib.dl.rdf.Cdr;\n+import edu.unc.lib.dl.rdf.CdrDeposit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.jena.rdf.model.Bag;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.vocabulary.RDF;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import edu.unc.lib.dl.util.RedisWorkerConstants.DepositField;\n+import edu.unc.lib.dl.fedora.PID;\n+\n+/**\n+ * @author lfarrell\n+ */\n+public class StaffOnlyPermissionJobTest extends AbstractDepositJobTest {\n+    private final static String LOC1_ID = \"loc1\";\n+    private final static String LOC2_ID = \"loc2\";\n+    private final static String FILE_CONTENT1 = \"Some content\";\n+    private final static String SOURCE_ID = \"source1\";\n+\n+    private StaffOnlyPermissionJob job;\n+    private Model model;\n+    private StorageLocationManager locationManager;\n+    private Bag depBag;\n+    private StorageLocationTestHelper locTestHelper;", "originalCommit": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYwMTU5MQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398601591", "bodyText": "i know this is test data, but a folder isn't allow to have a primaryObject. You could remove this property, or make objBag into a work. Also, the child could be any type, it being a file with a storage location isn't necessary for this test.", "author": "bbpennel", "createdAt": "2020-03-26T14:09:46Z", "path": "deposit/src/test/java/edu/unc/lib/deposit/fcrepo4/StaffOnlyPermissionJobTest.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.deposit.fcrepo4;\n+\n+import static edu.unc.lib.dl.acl.util.AccessPrincipalConstants.AUTHENTICATED_PRINC;\n+import static edu.unc.lib.dl.acl.util.AccessPrincipalConstants.PUBLIC_PRINC;\n+import static edu.unc.lib.dl.acl.util.UserRole.none;\n+import static edu.unc.lib.dl.test.TestHelpers.setField;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import edu.unc.lib.dl.persist.api.storage.StorageLocationManager;\n+import edu.unc.lib.dl.persist.services.storage.StorageLocationTestHelper;\n+import edu.unc.lib.dl.rdf.Cdr;\n+import edu.unc.lib.dl.rdf.CdrDeposit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.jena.rdf.model.Bag;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.vocabulary.RDF;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import edu.unc.lib.dl.util.RedisWorkerConstants.DepositField;\n+import edu.unc.lib.dl.fedora.PID;\n+\n+/**\n+ * @author lfarrell\n+ */\n+public class StaffOnlyPermissionJobTest extends AbstractDepositJobTest {\n+    private final static String LOC1_ID = \"loc1\";\n+    private final static String LOC2_ID = \"loc2\";\n+    private final static String FILE_CONTENT1 = \"Some content\";\n+    private final static String SOURCE_ID = \"source1\";\n+\n+    private StaffOnlyPermissionJob job;\n+    private Model model;\n+    private StorageLocationManager locationManager;\n+    private Bag depBag;\n+    private StorageLocationTestHelper locTestHelper;\n+    private Path loc1Path;\n+    private Path loc2Path;\n+    private Path candidatePath;\n+    private Path sourcePath;\n+\n+    @Before\n+    public void setup() throws Exception {\n+        loc1Path = tmpFolder.newFolder(\"loc1\").toPath();\n+        loc2Path = tmpFolder.newFolder(\"loc2\").toPath();\n+\n+        locTestHelper = new StorageLocationTestHelper();\n+        locTestHelper.addStorageLocation(LOC1_ID, \"Location 1\", loc1Path.toString());\n+        locTestHelper.addStorageLocation(LOC2_ID, \"Location 2\", loc2Path.toString());\n+\n+        sourcePath = tmpFolder.newFolder(SOURCE_ID).toPath();\n+        locationManager = locTestHelper.createLocationManager(null);\n+        candidatePath = Files.createDirectories(sourcePath.resolve(depositUUID));\n+\n+        job = new StaffOnlyPermissionJob();\n+\n+        job.setJobUUID(jobUUID);\n+        job.setDepositUUID(depositUUID);\n+        job.setDepositDirectory(depositDir);\n+        setField(job, \"locationManager\", locationManager);\n+        setField(job, \"dataset\", dataset);\n+        setField(job, \"depositsDirectory\", depositsDirectory);\n+        setField(job, \"depositStatusFactory\", depositStatusFactory);\n+        setField(job, \"jobStatusFactory\", jobStatusFactory);\n+        job.init();\n+\n+        model = job.getWritableModel();\n+        depBag = model.createBag(depositPid.getRepositoryPath());\n+        depBag.addProperty(Cdr.storageLocation, LOC1_ID);\n+    }\n+\n+    @Test\n+    public void testStaffOnly() throws Exception {\n+        Map<String, String> depositStatus = new HashMap<>();\n+        depositStatus.put(DepositField.staffOnly.name(), \"true\");\n+        when(depositStatusFactory.get(eq(depositUUID))).thenReturn(depositStatus);\n+\n+        PID objPid = makePid();\n+        Bag objBag = model.createBag(objPid.getRepositoryPath());\n+        objBag.addProperty(RDF.type, Cdr.Folder);\n+\n+        Resource fileResc = addFileObject(objBag, FILE_CONTENT1);\n+        objBag.addProperty(Cdr.primaryObject, fileResc);", "originalCommit": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYwNTI4OQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398605289", "bodyText": "Revert the changes in this file, this only needs to be a deposit status field", "author": "bbpennel", "createdAt": "2020-03-26T14:14:37Z", "path": "metadata/src/main/java/edu/unc/lib/dl/rdf/Cdr.java", "diffHunk": "@@ -140,6 +140,13 @@ public static String getURI() {\n      */\n     public static final Property replaceInvalidTerms = createProperty(\n             \"http://cdr.unc.edu/definitions/model#replaceInvalidTerms\" );\n+\n+    /**\n+     * Relation which denotes the permissions for the subject object\n+     */\n+    public static final Property staffOnly = createProperty(", "originalCommit": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYwNjAwNA==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398606004", "bodyText": "Revert the changes in this file, this only needs to be a deposit status field", "author": "bbpennel", "createdAt": "2020-03-26T14:15:31Z", "path": "metadata/src/main/java/edu/unc/lib/dl/rdf/CdrDeposit.java", "diffHunk": "@@ -110,4 +110,7 @@ public static String getURI() {\n \n     public static final Property hasSourceMetadata = createProperty(\n             \"http://cdr.unc.edu/definitions/deposit#hasSourceMetadata\");\n+\n+    public static final Property staffOnly = createProperty(", "originalCommit": "5122a7908ce444907cb0f857ed8f3d9c1de8d4ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0e4f1c90bbaed4073f222815f596c95788c4fe98", "url": "https://github.com/UNC-Libraries/box-c/commit/0e4f1c90bbaed4073f222815f596c95788c4fe98", "message": "Add checkbox back in and remove unchanged file", "committedDate": "2020-03-26T15:04:55Z", "type": "commit"}, {"oid": "822d5ad21cdf56547895bec4dce34e1ef12065fa", "url": "https://github.com/UNC-Libraries/box-c/commit/822d5ad21cdf56547895bec4dce34e1ef12065fa", "message": "Remove unneeded properties and test setup", "committedDate": "2020-03-26T18:43:19Z", "type": "commit"}, {"oid": "3161ff3ec09d572ed573ab38719bbb26bd09d191", "url": "https://github.com/UNC-Libraries/box-c/commit/3161ff3ec09d572ed573ab38719bbb26bd09d191", "message": "Move staff only checkbox", "committedDate": "2020-03-26T19:30:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODg5ODk0OA==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r398898948", "bodyText": "You can do this immediately after you create the follow rather than in each test. Although i'll mention that again that the job doesn't do anything with files, so you don't really need to have actual files and staging locations set up", "author": "bbpennel", "createdAt": "2020-03-26T21:18:37Z", "path": "deposit/src/test/java/edu/unc/lib/deposit/fcrepo4/StaffOnlyPermissionJobTest.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.deposit.fcrepo4;\n+\n+import static edu.unc.lib.dl.acl.util.AccessPrincipalConstants.AUTHENTICATED_PRINC;\n+import static edu.unc.lib.dl.acl.util.AccessPrincipalConstants.PUBLIC_PRINC;\n+import static edu.unc.lib.dl.acl.util.UserRole.none;\n+import static edu.unc.lib.dl.test.TestHelpers.setField;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import edu.unc.lib.dl.persist.api.storage.StorageLocationManager;\n+import edu.unc.lib.dl.persist.services.storage.StorageLocationTestHelper;\n+import edu.unc.lib.dl.rdf.Cdr;\n+import edu.unc.lib.dl.rdf.CdrDeposit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.jena.rdf.model.Bag;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.vocabulary.RDF;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import edu.unc.lib.dl.util.RedisWorkerConstants.DepositField;\n+import edu.unc.lib.dl.fedora.PID;\n+\n+/**\n+ * @author lfarrell\n+ */\n+public class StaffOnlyPermissionJobTest extends AbstractDepositJobTest {\n+    private final static String LOC1_ID = \"loc1\";\n+    private final static String FILE_CONTENT1 = \"Some content\";\n+\n+    private StaffOnlyPermissionJob job;\n+    private Model model;\n+    private StorageLocationManager locationManager;\n+    private Bag depBag;\n+    private StorageLocationTestHelper locTestHelper;\n+    private File originalFile;\n+\n+    @Before\n+    public void setup() throws Exception {\n+        locTestHelper = new StorageLocationTestHelper();\n+        locationManager = locTestHelper.createLocationManager(null);\n+\n+        job = new StaffOnlyPermissionJob();\n+\n+        job.setJobUUID(jobUUID);\n+        job.setDepositUUID(depositUUID);\n+        job.setDepositDirectory(depositDir);\n+        setField(job, \"locationManager\", locationManager);\n+        setField(job, \"dataset\", dataset);\n+        setField(job, \"depositsDirectory\", depositsDirectory);\n+        setField(job, \"depositStatusFactory\", depositStatusFactory);\n+        setField(job, \"jobStatusFactory\", jobStatusFactory);\n+        job.init();\n+\n+        model = job.getWritableModel();\n+        depBag = model.createBag(depositPid.getRepositoryPath());\n+        depBag.addProperty(Cdr.storageLocation, LOC1_ID);\n+\n+        originalFile = File.createTempFile(\"txt\", \"test\");\n+    }\n+\n+    @Test\n+    public void testStaffOnly() throws Exception {\n+        Map<String, String> depositStatus = new HashMap<>();\n+        depositStatus.put(DepositField.staffOnly.name(), \"true\");\n+        when(depositStatusFactory.get(eq(depositUUID))).thenReturn(depositStatus);\n+\n+        PID objPid = makePid();\n+        Bag objBag = model.createBag(objPid.getRepositoryPath());\n+        objBag.addProperty(RDF.type, Cdr.Work);\n+\n+        Resource fileResc = addFileObject(objBag, FILE_CONTENT1);\n+        objBag.addProperty(Cdr.primaryObject, fileResc);\n+        objBag.addProperty(RDF.type, Cdr.FileObject);\n+\n+        depBag.add(objBag);\n+        job.closeModel();\n+\n+        job.run();\n+\n+        model = job.getReadOnlyModel();\n+        Resource roles = model.getResource(objPid.getRepositoryPath());\n+\n+        assertTrue(roles.hasProperty(none.getProperty(), AUTHENTICATED_PRINC));\n+        assertTrue(roles.hasProperty(none.getProperty(), PUBLIC_PRINC));\n+\n+        assertFalse(fileResc.hasProperty(none.getProperty()));\n+\n+        originalFile.deleteOnExit();", "originalCommit": "3161ff3ec09d572ed573ab38719bbb26bd09d191", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyNzg3Ng==", "url": "https://github.com/UNC-Libraries/box-c/pull/937#discussion_r399227876", "bodyText": "No the badge branch isn't in here", "author": "lfarrell", "createdAt": "2020-03-27T12:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODg5ODk0OA=="}], "type": "inlineReview"}, {"oid": "c042e36c04f876303fa4364b50ac3ba1f9c1b372", "url": "https://github.com/UNC-Libraries/box-c/commit/c042e36c04f876303fa4364b50ac3ba1f9c1b372", "message": "Fix form label and test setup", "committedDate": "2020-03-27T12:40:59Z", "type": "commit"}, {"oid": "9a5e783b770f8dbbf1ba10ea9c6718b0844470af", "url": "https://github.com/UNC-Libraries/box-c/commit/9a5e783b770f8dbbf1ba10ea9c6718b0844470af", "message": "Remove unneeded setup", "committedDate": "2020-03-30T18:43:48Z", "type": "commit"}]}