{"pr_number": 797, "pr_title": "Make the rebalance listeners blocking ", "pr_createdAt": "2020-10-08T11:52:25Z", "pr_url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797", "timeline": [{"oid": "2103f9421752d23db3f9302e7ea058d4007dbeb1", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/2103f9421752d23db3f9302e7ea058d4007dbeb1", "message": "Make the rebalance listeners blocking and invoked from the Kafka polling thread.", "committedDate": "2020-10-08T13:50:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ0MzM0NQ==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502443345", "bodyText": "This could be a problem as OffsetStore is not thread safe and was designed to be called within the context thread.\nIn partitionsRevoked we call clearLesserSequentiallyProcessedOffsetsAndReturnLargestOffset which mutates the OffsetStore. Is it not possible to make a blocking call in the context thread from the poll thread?", "author": "pcasaes", "createdAt": "2020-10-09T13:54:16Z", "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/KafkaThrottledLatestProcessedCommit.java", "diffHunk": "@@ -38,7 +38,7 @@\n \n     private static final Map<String, Map<Integer, TopicPartition>> TOPIC_PARTITIONS_CACHE = new ConcurrentHashMap<>();\n \n-    private final Map<TopicPartition, OffsetStore> offsetStores = new HashMap<>();\n+    private final Map<TopicPartition, OffsetStore> offsetStores = new ConcurrentHashMap<>();", "originalCommit": "2103f9421752d23db3f9302e7ea058d4007dbeb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ2NzMzNg==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502467336", "bodyText": "I ran the tests locally and they passed. What I did was to revert the offsetStores map back to a HashMap and ran the relevant parts of partitionsRevoked within the context. I'll post my changes later.", "author": "pcasaes", "createdAt": "2020-10-09T14:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ0MzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ3ODA5NA==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502478094", "bodyText": "no partitionRevoked must run completely from the polling thread. It cannot run from the event loop. When the method returns, everything must have been completed or failed.\nOne thing I was thinking is to block the polling thread and use a countdown latch decreased from the event loop. However, it can introduce deadlocks.", "author": "cescoffier", "createdAt": "2020-10-09T14:44:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ0MzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUxOTAxNw==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502519017", "bodyText": "I just used a FutureTask to manipulate the OffsetStore and fed it into the context and waited for a response on the poll thread. Seemed to work. Going to do some more tests.", "author": "pcasaes", "createdAt": "2020-10-09T15:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ0MzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4MTk1Nw==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502581957", "bodyText": "Here's what I tested\npcasaes@3db0166\nNotice there are a couple of FIXMEs.\nI did the run the tests as well as manual testing. Worked well.\nI did pickup a small bug which I'll open a separate PR for. During revoke we should be committing the offsets of those revoked partitions. There's a not contains which should be contains.", "author": "pcasaes", "createdAt": "2020-10-09T17:42:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ0MzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc5Nzk4NA==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502797984", "bodyText": "I've rebased the branch and updated to fit the synchronization protocol.\nThe FutureTask is a great idea!", "author": "cescoffier", "createdAt": "2020-10-10T14:45:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ0MzM0NQ=="}], "type": "inlineReview"}, {"oid": "9b50352d30d0b824013ffa75b08ba858d216b0ab", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/9b50352d30d0b824013ffa75b08ba858d216b0ab", "message": "Make the rebalance listeners blocking and invoked from the Kafka polling thread.", "committedDate": "2020-10-10T11:57:17Z", "type": "commit"}, {"oid": "1d20fd1b45bf30228e91136f3185b4518bc2e1de", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/1d20fd1b45bf30228e91136f3185b4518bc2e1de", "message": "Fix synchronization protocol in the throttled commit strategy", "committedDate": "2020-10-10T14:44:42Z", "type": "forcePushed"}, {"oid": "a07a24729265e2a9ce30c097d8a95ecebbf19de5", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/a07a24729265e2a9ce30c097d8a95ecebbf19de5", "message": "Fix synchronization protocol in the throttled commit strategy", "committedDate": "2020-10-10T14:50:31Z", "type": "commit"}, {"oid": "d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683", "message": "Add default timeout support and fix type mismatch on sync commit", "committedDate": "2020-10-10T19:04:08Z", "type": "commit"}, {"oid": "d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683", "message": "Add default timeout support and fix type mismatch on sync commit", "committedDate": "2020-10-10T19:04:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg0OTEyOA==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502849128", "bodyText": "Are we sure about throwing a WakeupException? It will stop the poll thread dead cold. I used it without giving it much thought on my tests. The other option is to wrap it in a CompletionException along with the others (besides marking the current thread as interrupted).\nDealing with InterruptedException is always tricky because you never know where they can come from.", "author": "pcasaes", "createdAt": "2020-10-11T00:47:26Z", "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/ContextHolder.java", "diffHunk": "@@ -45,4 +50,18 @@ public void runOnContext(Runnable runnable) {\n         }\n     }\n \n+    public <T> T runOnContextAndAwait(Callable<T> action) {\n+        FutureTask<T> task = new FutureTask<>(action);\n+        runOnContext(task);\n+\n+        try {\n+            return task.get(timeout, TimeUnit.MILLISECONDS);\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new WakeupException();", "originalCommit": "d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg3OTgwNQ==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502879805", "bodyText": "So, I checked the Apache Kafka client, and it's how it's called:\n private Exception invokePartitionsAssigned(final Set<TopicPartition> assignedPartitions) {\n        log.info(\"Adding newly assigned partitions: {}\", Utils.join(assignedPartitions, \", \"));\n\n        ConsumerRebalanceListener listener = subscriptions.rebalanceListener();\n        try {\n            final long startMs = time.milliseconds();\n            listener.onPartitionsAssigned(assignedPartitions);\n            sensors.assignCallbackSensor.record(time.milliseconds() - startMs);\n        } catch (WakeupException | InterruptException e) {\n            throw e;\n        } catch (Exception e) {\n            log.error(\"User provided listener {} failed on invocation of onPartitionsAssigned for partitions {}\",\n                listener.getClass().getName(), assignedPartitions, e);\n            return e;\n        }\n\n        return null;\n    }\nThe CompletionException we are throwing would be handled by the second catch block and denotes a problem in the listener. The listener is the source of the issue. So, this case is fine.\nAs you mentioned, an interruption can come from anywhere, and it should not be handled by the second block, but by the first one. I believe we should throw an InterruptException (note that it's a Kafka-specific unchecked variant of InterruptedException) and let the polling thread handle the interruption.", "author": "cescoffier", "createdAt": "2020-10-11T07:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg0OTEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg4MDkyMA==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502880920", "bodyText": "Updated the code.", "author": "cescoffier", "createdAt": "2020-10-11T07:58:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg0OTEyOA=="}], "type": "inlineReview"}, {"oid": "9140dbcdcf9fc474da8339687d62004e417e0ac9", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/9140dbcdcf9fc474da8339687d62004e417e0ac9", "message": "Improve the handling interruptions while executing blocking task in the rebalance listeners.", "committedDate": "2020-10-11T07:58:31Z", "type": "commit"}, {"oid": "1cd23a44b2080d6f02b320e11c0b9e6e5346d3b3", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/1cd23a44b2080d6f02b320e11c0b9e6e5346d3b3", "message": "Update consumer rebalance listener documentation", "committedDate": "2020-10-11T08:27:24Z", "type": "commit"}]}