{"pr_number": 5790, "pr_title": "Clients show partition health", "pr_createdAt": "2020-11-08T18:37:05Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5790", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3ODc3MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r519878770", "bodyText": "@deepthidevaki how do you feel about moving this failure listener to the constructor? I think it makes sense, but perhaps I'm overlooking an actor scheduler issue.", "author": "korthout", "createdAt": "2020-11-09T15:01:21Z", "path": "broker/src/main/java/io/zeebe/broker/Broker.java", "diffHunk": "@@ -407,10 +407,14 @@ private AutoCloseable partitionsStep(\n                     buildExporterRepository(brokerCfg));\n             final PartitionTransitionImpl transitionBehavior =\n                 new PartitionTransitionImpl(context, LEADER_STEPS, FOLLOWER_STEPS);\n-            final ZeebePartition zeebePartition = new ZeebePartition(context, transitionBehavior);\n+            final ZeebePartition zeebePartition =\n+                new ZeebePartition(\n+                    context,\n+                    transitionBehavior,\n+                    List.of(\n+                        new PartitionHealthBroadcaster(\n+                            partitionId, topologyManager::onHealthChanged)));\n             scheduleActor(zeebePartition);\n-            zeebePartition.addFailureListener(\n-                new PartitionHealthBroadcaster(partitionId, topologyManager::onHealthChanged));", "originalCommit": "174161bd0ae95dd89de4c7471c2980e352f434f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM2OTY5Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520369692", "bodyText": "It should be safe to move it to the constructor. But what is the need for it?", "author": "deepthidevaki", "createdAt": "2020-11-10T08:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3ODc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwMTE5Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520401197", "bodyText": "I understood that it solved the second problem @aivinog1 mentioned here. I assumed there was a race condition between the partition becoming healthy/unhealthy and when the partition health broadcaster is added as failure listener.\n@aivinog1 have you tried without moving this to the constructor?", "author": "korthout", "createdAt": "2020-11-10T09:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3ODc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwMzE3Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520403173", "bodyText": "@korthout Yes, I tried but without success. Seems that the only way :(", "author": "aivinog1", "createdAt": "2020-11-10T09:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3ODc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ2MjA5MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520462090", "bodyText": "Ah yes, there is a timing issue. I dove into it a bit.\nWe register the broadcaster as a failure listener using the actor scheduler, but at the moment we call this, we have (in the line before) already activated the actor scheduler which is busy starting the partition. During this start, the health has already been determined (multiple times even) and each failure listener is notified when it changed. Directly after the start, the scheduler does the next task (adding the broadcaster) and after that the health doesn't change any more. So the broadcaster is never informed.\nSo, I see 2 solutions:\n\nwhen a new listener is added to the partition, check the health and update the listener accordingly.\npass the broadcaster to the partition in the constructor\n\nAfter discussing with @deepthidevaki solution 1 has our preference, since this pattern is already applied in other places as well.", "author": "korthout", "createdAt": "2020-11-10T10:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3ODc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ2NzUzMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520467532", "bodyText": "@korthout Many thanks for the analysis :) I'll apply the first solution soon", "author": "aivinog1", "createdAt": "2020-11-10T10:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3ODc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUxNDEzNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520514135", "bodyText": "@korthout Can you take a look, please? :) I've also add small unit tests that verify calling io.zeebe.util.health.FailureListener#onFailure or io.zeebe.util.health.FailureListener#onRecovered depends the partition health.", "author": "aivinog1", "createdAt": "2020-11-10T12:09:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3ODc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3OTIxOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r519879219", "bodyText": "\ud83d\ude06 Good find!", "author": "korthout", "createdAt": "2020-11-09T15:02:01Z", "path": "broker/src/main/java/io/zeebe/broker/clustering/topology/TopologyManagerImpl.java", "diffHunk": "@@ -257,9 +257,9 @@ public void onHealthChanged(final int partitionId, final HealthStatus status) {\n     actor.run(\n         () -> {\n           if (status == HealthStatus.HEALTHY) {\n-            localBroker.setPartitionUnhealthy(partitionId);\n-          } else if (status == HealthStatus.UNHEALTHY) {\n             localBroker.setPartitionHealthy(partitionId);\n+          } else if (status == HealthStatus.UNHEALTHY) {\n+            localBroker.setPartitionUnhealthy(partitionId);", "originalCommit": "174161bd0ae95dd89de4c7471c2980e352f434f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzNjk5MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520536991", "bodyText": "Please use ZeebePartition.getHealthStatus() to determine the current health.\nthis.zeebePartitionHealth only contains the health that the ZeebePartition can control (e.g. installation failure), while there are also other components that may fail, like the log stream and the stream processor. Each of these is a different component, and they are all registered in the CriticalComponentsHealthMonitor, which is used to determine the health status when you just call ZeebePartition.getHealthStatus().", "author": "korthout", "createdAt": "2020-11-10T12:50:15Z", "path": "broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java", "diffHunk": "@@ -294,7 +291,15 @@ public HealthStatus getHealthStatus() {\n \n   @Override\n   public void addFailureListener(final FailureListener failureListener) {\n-    actor.run(() -> this.failureListeners.add(failureListener));\n+    actor.run(\n+        () -> {\n+          this.failureListeners.add(failureListener);\n+          if (this.zeebePartitionHealth.getHealthStatus() == HealthStatus.HEALTHY) {", "originalCommit": "7e560372bcbeab0e21ab61b5ee39573a74e537a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0ODMxOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520548319", "bodyText": "Done", "author": "aivinog1", "createdAt": "2020-11-10T13:08:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzNjk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzNzk2Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520537962", "bodyText": "The test doesn't make it clear that the partition's health is really Unhealthy. Can you make that more explicit in the test?", "author": "korthout", "createdAt": "2020-11-10T12:51:53Z", "path": "broker/src/test/java/io/zeebe/broker/system/partitions/ZeebePartitionTest.java", "diffHunk": "@@ -61,6 +63,41 @@ public void shouldInstallLeaderPartition() {\n     verify(transition).toLeader();\n   }\n \n+  @Test\n+  public void shouldCallOnFailureOnAddFailureListenerAndUnhealthy() {", "originalCommit": "7e560372bcbeab0e21ab61b5ee39573a74e537a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0ODI3Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520548277", "bodyText": "Done", "author": "aivinog1", "createdAt": "2020-11-10T13:08:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzNzk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzOTQwNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520539404", "bodyText": "You can actually just use the healthMonitor (see L45), and stub the healthstatus. Something like:\nwhen(healthMonitor.getHealthStatus())\n  .thenReturn(HealthStatus.HEALTHY)", "author": "korthout", "createdAt": "2020-11-10T12:54:15Z", "path": "broker/src/test/java/io/zeebe/broker/system/partitions/ZeebePartitionTest.java", "diffHunk": "@@ -61,6 +63,41 @@ public void shouldInstallLeaderPartition() {\n     verify(transition).toLeader();\n   }\n \n+  @Test\n+  public void shouldCallOnFailureOnAddFailureListenerAndUnhealthy() {\n+    // given\n+    final ZeebePartition partition = new ZeebePartition(ctx, transition);\n+    schedulerRule.submitActor(partition);\n+    final FailureListener failureListener = mock(FailureListener.class);\n+    doNothing().when(failureListener).onFailure();\n+\n+    // when\n+    partition.addFailureListener(failureListener);\n+    schedulerRule.workUntilDone();\n+\n+    // then\n+    verify(failureListener, only()).onFailure();\n+  }\n+\n+  @Test\n+  public void shouldCallOnRecoveredOnAddFailureListenerAndHealthy() {\n+    // given\n+    final ZeebePartition partition = new ZeebePartition(ctx, transition);\n+    schedulerRule.submitActor(partition);\n+    final FailureListener failureListener = mock(FailureListener.class);\n+    doNothing().when(failureListener).onRecovered();\n+    // make partition healthy\n+    partition.onNewRole(Role.LEADER, 1);", "originalCommit": "7e560372bcbeab0e21ab61b5ee39573a74e537a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0ODIxMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5790#discussion_r520548213", "bodyText": "Done", "author": "aivinog1", "createdAt": "2020-11-10T13:08:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzOTQwNA=="}], "type": "inlineReview"}, {"oid": "f0ce836ad201c87006647fea051672d66e149e50", "url": "https://github.com/camunda-cloud/zeebe/commit/f0ce836ad201c87006647fea051672d66e149e50", "message": "feat(clients/go): a Go and Java client shows a partition health", "committedDate": "2020-11-10T15:39:22Z", "type": "forcePushed"}, {"oid": "2d86af8e14f24a4653bfd48dc23b257e72abf2a8", "url": "https://github.com/camunda-cloud/zeebe/commit/2d86af8e14f24a4653bfd48dc23b257e72abf2a8", "message": "feat(clients/go): a Go and Java client shows a partition health", "committedDate": "2020-11-10T17:56:50Z", "type": "commit"}, {"oid": "2d86af8e14f24a4653bfd48dc23b257e72abf2a8", "url": "https://github.com/camunda-cloud/zeebe/commit/2d86af8e14f24a4653bfd48dc23b257e72abf2a8", "message": "feat(clients/go): a Go and Java client shows a partition health", "committedDate": "2020-11-10T17:56:50Z", "type": "forcePushed"}]}