{"pr_number": 3999, "pr_title": "Allow to fail activatable jobs", "pr_createdAt": "2020-03-06T13:42:00Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/3999", "timeline": [{"oid": "0820967a7013a69e50cf8063c4b48e62d94c489d", "url": "https://github.com/camunda-cloud/zeebe/commit/0820967a7013a69e50cf8063c4b48e62d94c489d", "message": "feat(broker): allow to fail activatable jobs", "committedDate": "2020-03-06T13:43:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxNzk3OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#discussion_r388917978", "bodyText": "Would be nice if we could just remove this conditional statement.", "author": "Zelldon", "createdAt": "2020-03-06T14:01:31Z", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/job/FailProcessor.java", "diffHunk": "@@ -35,7 +35,7 @@ public boolean onCommand(\n     final long key = command.getKey();\n     final JobState.State jobState = state.getState(key);\n \n-    if (jobState == State.ACTIVATED) {\n+    if (jobState == State.ACTIVATED || jobState == State.ACTIVATABLE) {", "originalCommit": "0820967a7013a69e50cf8063c4b48e62d94c489d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4339fb1c31ae5a38f69b169e107d06659ccc8e70", "url": "https://github.com/camunda-cloud/zeebe/commit/4339fb1c31ae5a38f69b169e107d06659ccc8e70", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors.", "committedDate": "2020-03-06T15:27:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3NDg4NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#discussion_r389474885", "bodyText": "I think throw an error for job this part is also dynamic, like fail and complete", "author": "Zelldon", "createdAt": "2020-03-09T06:00:38Z", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/job/DefaultJobCommandProcessor.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.engine.processor.workflow.job;\n+\n+import io.zeebe.engine.processor.CommandProcessor;\n+import io.zeebe.engine.processor.TypedRecord;\n+import io.zeebe.engine.state.instance.JobState;\n+import io.zeebe.engine.state.instance.JobState.State;\n+import io.zeebe.protocol.impl.record.value.job.JobRecord;\n+import io.zeebe.protocol.record.RejectionType;\n+import java.util.function.BiConsumer;\n+\n+/**\n+ * Default implementation to process JobCommands to reduce duplication in CommandProcessor\n+ * implementations.\n+ */\n+final class DefaultJobCommandProcessor<J extends JobRecord> implements CommandProcessor<J> {\n+\n+  private static final String NO_JOB_FOUND_MESSAGE =\n+      \"Expected to throw an error for job with key '%d', but no such job was found\";", "originalCommit": "4339fb1c31ae5a38f69b169e107d06659ccc8e70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5c067bed513383ca15f0c682cbb8c42e48c0ea4b", "url": "https://github.com/camunda-cloud/zeebe/commit/5c067bed513383ca15f0c682cbb8c42e48c0ea4b", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors.", "committedDate": "2020-03-09T12:13:42Z", "type": "forcePushed"}, {"oid": "baff0c97fd24b9c666525fe611baf64870c32370", "url": "https://github.com/camunda-cloud/zeebe/commit/baff0c97fd24b9c666525fe611baf64870c32370", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors.", "committedDate": "2020-03-09T13:36:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMjc4Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#discussion_r390102787", "bodyText": "Can here the correct type be interfered?", "author": "Zelldon", "createdAt": "2020-03-10T05:31:40Z", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/job/JobEventProcessors.java", "diffHunk": "@@ -35,10 +35,10 @@ public static JobErrorThrownProcessor addJobProcessors(\n         .onEvent(ValueType.JOB, JobIntent.CREATED, new JobCreatedProcessor(workflowState))\n         .onEvent(ValueType.JOB, JobIntent.COMPLETED, new JobCompletedEventProcessor(workflowState))\n         .onCommand(ValueType.JOB, JobIntent.CREATE, new CreateProcessor(jobState))\n-        .onCommand(ValueType.JOB, JobIntent.COMPLETE, new CompleteProcessor(jobState))\n-        .onCommand(ValueType.JOB, JobIntent.FAIL, new FailProcessor(jobState))\n+        .onCommand(ValueType.JOB, JobIntent.COMPLETE, new CompleteProcessor<>(jobState))", "originalCommit": "baff0c97fd24b9c666525fe611baf64870c32370", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI3MTQ1NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#discussion_r390271455", "bodyText": "Yes it could, but it created a problem in calling commandControl.accept(JobIntent, JobRecord) because the JobRecord was bounded by J extends JobRecord and the value to place their was retrieved using JobRecord getJob(long) in JobState, which was not generified. So in the end it was not possible to use this.", "author": "korthout", "createdAt": "2020-03-10T12:14:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMjc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMzQ2NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#discussion_r390103464", "bodyText": "So we should now be able to fail a job without activating it. Could we re-add this one and assert that it is failed correctly.", "author": "Zelldon", "createdAt": "2020-03-10T05:34:45Z", "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/job/FailJobTest.java", "diffHunk": "@@ -193,20 +193,6 @@ public void shouldRejectFailIfJobAlreadyFailed() {\n     assertThat(jobRecord.getRejectionReason()).contains(\"it is in state 'FAILED'\");\n   }\n \n-  @Test\n-  public void shouldRejectFailIfJobCreated() {\n-    // given\n-    final Record<JobRecordValue> job = ENGINE.createJob(jobType, PROCESS_ID);\n-\n-    // when\n-    final Record<JobRecordValue> jobRecord =", "originalCommit": "baff0c97fd24b9c666525fe611baf64870c32370", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI5MzE1OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#discussion_r390293159", "bodyText": "I re-added it with some modifications and moved the test case up so its together with the other successful command cases.", "author": "korthout", "createdAt": "2020-03-10T12:57:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMzQ2NA=="}], "type": "inlineReview"}, {"oid": "99038429abeb13721bf53fac1052ddafd2ce300c", "url": "https://github.com/camunda-cloud/zeebe/commit/99038429abeb13721bf53fac1052ddafd2ce300c", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors.", "committedDate": "2020-03-10T12:37:02Z", "type": "commit"}, {"oid": "99038429abeb13721bf53fac1052ddafd2ce300c", "url": "https://github.com/camunda-cloud/zeebe/commit/99038429abeb13721bf53fac1052ddafd2ce300c", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors.", "committedDate": "2020-03-10T12:37:02Z", "type": "forcePushed"}]}