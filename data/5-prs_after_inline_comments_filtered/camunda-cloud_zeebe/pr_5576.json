{"pr_number": 5576, "pr_title": "Adds new experimental flag to disable explicit flush in the consensus module", "pr_createdAt": "2020-10-12T15:42:20Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5576", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2OTQ5Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503869493", "bodyText": "It is not safe to enable this without replication also. I would warn also for replicationFactor = 1.", "author": "deepthidevaki", "createdAt": "2020-10-13T11:20:10Z", "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -119,6 +122,10 @@ private void validateConfiguration() {\n               \"diskUsageCommandWatermark (%f) must be less than diskUsageReplicationWatermark (%f)\",\n               diskUsageCommandWatermark, diskUsageReplicationWatermark));\n     }\n+\n+    if (replicationFactor > 1 && experimental.isDisableExplicitRaftFlush()) {\n+      LOG.warn(REPLICATION_WITH_DISABLED_FLUSH_WARNING);", "originalCommit": "b75e37228f1c18966fd12a7d356e009741ff41e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk4MzMwMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503983301", "bodyText": "@deepthidevaki how come?", "author": "korthout", "createdAt": "2020-10-13T14:09:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2OTQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5MjQ0OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503992448", "bodyText": "@korthout When a write is not flushed to the disk, it is not guaranteed to be persisted over a failure. So it can happen that we write a command, raft commits it but not flush it, processor process it and send a response to the client, and then the node is crashed. After restart, that command does not exists in the log because it was not flushed. So we might have responded to the client that a workflow was created, but after a failure that workflow does not exists.", "author": "deepthidevaki", "createdAt": "2020-10-13T14:20:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2OTQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NTc5OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503995798", "bodyText": "@deepthidevaki thanks. That makes a lot of sense", "author": "korthout", "createdAt": "2020-10-13T14:24:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2OTQ5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MzY2NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503873665", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean flushExplicitly = DEFAULT_FLUSH_ON_COMMIT;\n          \n          \n            \n                private boolean flushExplicitly = DEFAULT_FLUSH_EXPLICITLY;", "author": "deepthidevaki", "createdAt": "2020-10-13T11:27:41Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/storage/RaftStorage.java", "diffHunk": "@@ -389,7 +389,7 @@ public boolean isRetainStaleSnapshots() {\n     private int maxEntrySize = DEFAULT_MAX_ENTRY_SIZE;\n     private int maxEntriesPerSegment = DEFAULT_MAX_ENTRIES_PER_SEGMENT;\n     private long freeDiskSpace = DEFAULT_FREE_DISK_SPACE;\n-    private boolean flushOnCommit = DEFAULT_FLUSH_ON_COMMIT;\n+    private boolean flushExplicitly = DEFAULT_FLUSH_ON_COMMIT;", "originalCommit": "b75e37228f1c18966fd12a7d356e009741ff41e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwMjQzMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503902431", "bodyText": "Will do, but I've already learned not to commit such fixes directly from Github since it'll break the build \ud83d\ude05", "author": "npepinpe", "createdAt": "2020-10-13T12:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MzY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NjE2OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503876169", "bodyText": "Documentation is not added yet. Would you do it in this PR or another?", "author": "deepthidevaki", "createdAt": "2020-10-13T11:31:58Z", "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -33,6 +33,9 @@\n       \"Snapshot period %s needs to be larger then or equals to one minute.\";\n   private static final String MAX_BATCH_SIZE_ERROR_MSG =\n       \"Expected to have an append batch size maximum which is non negative and smaller then '%d', but was '%s'.\";\n+  private static final String REPLICATION_WITH_DISABLED_FLUSH_WARNING =\n+      \"Disabling explicit flushing with replication enabled is an experimental feature and can lead to inconsistencies \"\n+          + \"in a lot of cases! Please refer to the documentation whether or not you should use this!\";", "originalCommit": "b75e37228f1c18966fd12a7d356e009741ff41e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwMTg1Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503901857", "bodyText": "I opened an issue on the new documentation repo, as we shouldn't add docs in this repo anymore. See camunda-cloud/camunda-cloud-documentation#38", "author": "npepinpe", "createdAt": "2020-10-13T12:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NjE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NDIwMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503994200", "bodyText": "Please update the message.", "author": "deepthidevaki", "createdAt": "2020-10-13T14:22:34Z", "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -33,6 +33,9 @@\n       \"Snapshot period %s needs to be larger then or equals to one minute.\";\n   private static final String MAX_BATCH_SIZE_ERROR_MSG =\n       \"Expected to have an append batch size maximum which is non negative and smaller then '%d', but was '%s'.\";\n+  private static final String REPLICATION_WITH_DISABLED_FLUSH_WARNING =\n+      \"Disabling explicit flushing with replication enabled is an experimental feature and can lead to inconsistencies \"", "originalCommit": "a0a83af11edc8a023d4d62095a63fd3bef722492", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAwMDgxMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r504000811", "bodyText": "Sorry, I meant\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  \"Disabling explicit flushing with replication enabled is an experimental feature and can lead to inconsistencies \"\n          \n          \n            \n                  \"Disabling explicit flushing is an experimental feature and can lead to inconsistencies \"", "author": "deepthidevaki", "createdAt": "2020-10-13T14:30:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NDIwMA=="}], "type": "inlineReview"}, {"oid": "6e5a8645054f822bef440f9c0223451de500bb69", "url": "https://github.com/camunda-cloud/zeebe/commit/6e5a8645054f822bef440f9c0223451de500bb69", "message": "chore(atomix): introduce flushExplicitly flag\n\n- new flag which controls if we flush explicitly on the leader commit\n  and follower appends; defaults to true\n- removes old flushOnCommit config flag", "committedDate": "2020-10-13T14:40:00Z", "type": "commit"}, {"oid": "8ecaa3ebbb3458519ddcffd244427fbf2237698f", "url": "https://github.com/camunda-cloud/zeebe/commit/8ecaa3ebbb3458519ddcffd244427fbf2237698f", "message": "chore(logstreams): fix to use correct flag", "committedDate": "2020-10-13T14:40:00Z", "type": "commit"}, {"oid": "c15dbe3ced8db12079ac5e391821e6e7e07741c8", "url": "https://github.com/camunda-cloud/zeebe/commit/c15dbe3ced8db12079ac5e391821e6e7e07741c8", "message": "chore(broker): add new experimental config to control Raft explicit flush", "committedDate": "2020-10-13T14:40:01Z", "type": "commit"}, {"oid": "c15dbe3ced8db12079ac5e391821e6e7e07741c8", "url": "https://github.com/camunda-cloud/zeebe/commit/c15dbe3ced8db12079ac5e391821e6e7e07741c8", "message": "chore(broker): add new experimental config to control Raft explicit flush", "committedDate": "2020-10-13T14:40:01Z", "type": "forcePushed"}]}