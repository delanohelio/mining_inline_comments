{"pr_number": 5529, "pr_title": "chore(broker): Add health info into BrokerInfo", "pr_createdAt": "2020-10-07T14:28:35Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5529", "timeline": [{"oid": "2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f", "url": "https://github.com/camunda-cloud/zeebe/commit/2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f", "message": "chore(broker): Add health info into BrokerInfo", "committedDate": "2020-10-08T05:36:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3OTM5Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r503179397", "bodyText": "Please also assert the partition health statuses at the end of this test.", "author": "korthout", "createdAt": "2020-10-12T09:55:26Z", "path": "protocol-impl/src/test/java/io/zeebe/protocol/impl/BrokerInfoTest.java", "diffHunk": "@@ -35,6 +36,10 @@ public void shouldEncodeDecodeBrokerInfo() {\n     partitionRoles.put(1, PartitionRole.FOLLOWER);\n     partitionRoles.put(2, PartitionRole.LEADER);\n     partitionRoles.put(231, PartitionRole.FOLLOWER);\n+    final Map<Integer, PartitionHealthStatus> partitionHealthStatuses = new HashMap<>();\n+    partitionHealthStatuses.put(1, PartitionHealthStatus.HEALTHY);\n+    partitionHealthStatuses.put(2, PartitionHealthStatus.UNHEALTHY);\n+    partitionHealthStatuses.put(123, PartitionHealthStatus.HEALTHY);", "originalCommit": "2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5MjIxNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r503292217", "bodyText": "Done :)", "author": "aivinog1", "createdAt": "2020-10-12T13:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3OTM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4NDIzMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r503184230", "bodyText": "I think that for this (and the other cases below), the changes to the localBroker data also need to be published. For example, this is also done by the TopologyManagerImpl when the partition role changes (i.e. becoming leader or follower). See TopologyManagerImpl#L218 to see how this is done.\n@deepthidevaki WDYT, is it necessary here to publish these changes explicitly?", "author": "korthout", "createdAt": "2020-10-12T10:03:21Z", "path": "broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java", "diffHunk": "@@ -737,6 +737,7 @@ public void onFailure() {\n           if (failureListener != null) {\n             failureListener.onFailure();\n           }\n+          localBroker.setPartitionUnhealthy(partitionId);", "originalCommit": "2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxNjYxNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r503316615", "bodyText": "You are right @korthout. It needs to be written into atomix.getMembershipService().getLocalMember().properties() for it to be picked up in the next gossip propagation.", "author": "deepthidevaki", "createdAt": "2020-10-12T14:00:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4NDIzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxOTY0OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r503319649", "bodyText": "Also note that localBroker is not a thread safe object. It can be concurrently updated by TopologyManagerImpl. So it is not safe to update it directly from here. May be you can delegate it to TopologyManagerImpl.", "author": "deepthidevaki", "createdAt": "2020-10-12T14:05:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4NDIzMA=="}], "type": "inlineReview"}, {"oid": "6439d43e795f9e754000d3036044792c64467bc2", "url": "https://github.com/camunda-cloud/zeebe/commit/6439d43e795f9e754000d3036044792c64467bc2", "message": "chore(broker): Add health info into BrokerInfo", "committedDate": "2020-10-12T13:20:38Z", "type": "forcePushed"}, {"oid": "3e05cfebbd58577c15b137ce9cc4426545438114", "url": "https://github.com/camunda-cloud/zeebe/commit/3e05cfebbd58577c15b137ce9cc4426545438114", "message": "chore(broker): Add health info into BrokerInfo", "committedDate": "2020-10-14T12:40:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MTkxOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r504791919", "bodyText": "I'm not entirely sure about this, but it might be necessary to put these 2 lines in a actor.run block (see L234). This would make sure that the work is never concurrently executed with one of the other updates to localbroker. @deepthidevaki WDYK? does that fully solve the issue?", "author": "korthout", "createdAt": "2020-10-14T15:56:15Z", "path": "broker/src/main/java/io/zeebe/broker/clustering/topology/TopologyManagerImpl.java", "diffHunk": "@@ -249,4 +253,16 @@ private void notifyPartitionLeaderUpdated(final int partitionId, final BrokerInf\n       LogUtil.catchAndLog(LOG, () -> listener.onPartitionLeaderUpdated(partitionId, member));\n     }\n   }\n+\n+  @Override\n+  public void onHealthUp(final int partitionId) {\n+    localBroker.setPartitionHealthy(partitionId);\n+    publishTopologyChanges();", "originalCommit": "3e05cfebbd58577c15b137ce9cc4426545438114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYzMDAzMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r505630032", "bodyText": "ping @deepthidevaki \ud83d\ude42", "author": "korthout", "createdAt": "2020-10-15T15:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MTkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEwMzQwMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r506103402", "bodyText": "Yes. It should be executed with actor.run.", "author": "deepthidevaki", "createdAt": "2020-10-16T07:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MTkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjExNDU4NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r506114585", "bodyText": "@deepthidevaki Thanks, I'll wrap it with an actor.run :)", "author": "aivinog1", "createdAt": "2020-10-16T07:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MTkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE1OTc1Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r506159757", "bodyText": "Done", "author": "aivinog1", "createdAt": "2020-10-16T08:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MTkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NTcyOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r504795729", "bodyText": "I wonder whether we could (or want to) re-use the failure listener for this. Perhaps ZeebePartition should know a collection of failure listeners that get notified onFailure and onRecovered. That requires some additional refactoring, but at least doesn't add stuff to partition context. I'm not sure it would work though, so please have a try at it, and if it doesn't work that's also fine.", "author": "korthout", "createdAt": "2020-10-14T16:01:26Z", "path": "broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java", "diffHunk": "@@ -231,6 +231,7 @@ public void onFailure() {\n           if (failureListener != null) {\n             failureListener.onFailure();\n           }\n+          context.getPartitionHealthListener().onHealthDown(getPartitionId());", "originalCommit": "3e05cfebbd58577c15b137ce9cc4426545438114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE2Nzg2NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r505167865", "bodyText": "Ok, I'll try it :)", "author": "aivinog1", "createdAt": "2020-10-15T05:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NTcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwMDczNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r505500736", "bodyText": "@korthout Well, I've tried but found that this is not so applicable. In my implementation, TopologyManagerImpl implements a FailureListener, but should somehow know the partitionId which is not passed in FailureListener methods. So, now I can't see how we could use this interface in this case :) If you have other ideas, please let me know :)", "author": "aivinog1", "createdAt": "2020-10-15T12:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NTcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYwOTcwMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r505609701", "bodyText": "@aivinog1 I was thinking about it and just had to try it out myself. I hope you don't mind. Please have a look at it, if you like it we can keep it, but I'm also fine with discarding it. It's just an alternative to consider. Which do you prefer?\nOne thing to note, that I ran into while trying this, was that ZeebePartition.onRecoveredInternal and ZeebePartition.onInstallFailure already inform the failure listeners indirectly. It tells the ZeebePartitionHealth to update, which afterwards informs its supervisor (which is ZeebePartition) of the change. Point being, that if we chose not to use my changes, please remove the lines context.getPartitionHealthListener().onHealthDown(getPartitionId()); from onRecoveredInternal and onInstallFailure.", "author": "korthout", "createdAt": "2020-10-15T14:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NTcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYxODc3NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r505618774", "bodyText": "@korthout Well, I like your solution more than my, good job \ud83d\udc4d", "author": "aivinog1", "createdAt": "2020-10-15T15:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NTcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYyOTQ1Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r505629452", "bodyText": "@aivinog1 thanks \ud83d\ude42", "author": "korthout", "createdAt": "2020-10-15T15:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NTcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEwNjAzOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r506106039", "bodyText": "This should be called after scheduleActor(zeebePartition). The reason is: it is executed with actor.run. If the actor is not started, it won't be executed.", "author": "deepthidevaki", "createdAt": "2020-10-16T07:05:13Z", "path": "broker/src/main/java/io/zeebe/broker/Broker.java", "diffHunk": "@@ -403,11 +404,12 @@ private AutoCloseable partitionsStep(\n                     partitionIndexes.get(partitionId),\n                     snapshotStoreSupplier,\n                     createFactory(topologyManager, clusterCfg, atomix, managementRequestHandler),\n-                    buildExporterRepository(brokerCfg),\n-                    topologyManager);\n+                    buildExporterRepository(brokerCfg));\n             final PartitionTransitionImpl transitionBehavior =\n                 new PartitionTransitionImpl(context, LEADER_STEPS, FOLLOWER_STEPS);\n             final ZeebePartition zeebePartition = new ZeebePartition(context, transitionBehavior);\n+            zeebePartition.addFailureListener(", "originalCommit": "b0055231d73899b28a1a90dc702ef972d0220925", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE1OTg3NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r506159874", "bodyText": "Done", "author": "aivinog1", "createdAt": "2020-10-16T08:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEwNjAzOQ=="}], "type": "inlineReview"}, {"oid": "1e81a01a62b327257db8db9badbc7ddcf63b7966", "url": "https://github.com/camunda-cloud/zeebe/commit/1e81a01a62b327257db8db9badbc7ddcf63b7966", "message": "chore(broker): Spread health info through BrokerInfo", "committedDate": "2020-10-20T13:35:50Z", "type": "commit"}, {"oid": "1e81a01a62b327257db8db9badbc7ddcf63b7966", "url": "https://github.com/camunda-cloud/zeebe/commit/1e81a01a62b327257db8db9badbc7ddcf63b7966", "message": "chore(broker): Spread health info through BrokerInfo", "committedDate": "2020-10-20T13:35:50Z", "type": "forcePushed"}]}