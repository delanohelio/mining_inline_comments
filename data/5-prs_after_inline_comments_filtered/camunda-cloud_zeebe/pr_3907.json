{"pr_number": 3907, "pr_title": "3869 spring boot config", "pr_createdAt": "2020-02-21T19:16:41Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/3907", "timeline": [{"oid": "4f910d0dbfda943af6c15b8ae680c5ab0e759f4d", "url": "https://github.com/camunda-cloud/zeebe/commit/4f910d0dbfda943af6c15b8ae680c5ab0e759f4d", "message": "feat(broker): Use map instead of list to configure exporters\n\nMaps have two advantages:\n- If several config files are used, each exporter will be added to the configuration (with lists they would be replaced)\n- Maps give each exporter an addressable key; this way it is possible to set environment variables that e.g. overwrite the password inside the elasticsearch exporter\n\nThis also means that the ID is no longer part of the ExporterCfg object. Instead the ID is given outside.\n\nThe ID is still part of the ExporterDescriptor, though, and corresponds to the key under wich the exporter was added to the BrokerCfg", "committedDate": "2020-02-24T09:59:09Z", "type": "forcePushed"}, {"oid": "700726102b03e50011dbddec27e6fbd04def7fd9", "url": "https://github.com/camunda-cloud/zeebe/commit/700726102b03e50011dbddec27e6fbd04def7fd9", "message": "feat(broker): Use map instead of list to configure exporters\n\nMaps have two advantages:\n- If several config files are used, each exporter will be added to the configuration (with lists they would be replaced)\n- Maps give each exporter an addressable key; this way it is possible to set environment variables that e.g. overwrite the password inside the elasticsearch exporter\n\nThis also means that the ID is no longer part of the ExporterCfg object. Instead the ID is given outside.\n\nThe ID is still part of the ExporterDescriptor, though, and corresponds to the key under wich the exporter was added to the BrokerCfg", "committedDate": "2020-02-24T10:37:47Z", "type": "forcePushed"}, {"oid": "2bb5471e96670dc98429c3ec28a71327307c6d88", "url": "https://github.com/camunda-cloud/zeebe/commit/2bb5471e96670dc98429c3ec28a71327307c6d88", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-02-24T22:03:07Z", "type": "forcePushed"}, {"oid": "2a964075389b13eb0e96959bd50145804462d8ad", "url": "https://github.com/camunda-cloud/zeebe/commit/2a964075389b13eb0e96959bd50145804462d8ad", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-02-24T22:11:45Z", "type": "forcePushed"}, {"oid": "bae1de251968c18843ac3bc987f2b386a0867f9a", "url": "https://github.com/camunda-cloud/zeebe/commit/bae1de251968c18843ac3bc987f2b386a0867f9a", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-02-26T13:44:25Z", "type": "forcePushed"}, {"oid": "1bdf430a1b97014a53384fcc67f0e2eddf276687", "url": "https://github.com/camunda-cloud/zeebe/commit/1bdf430a1b97014a53384fcc67f0e2eddf276687", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-02-26T14:51:13Z", "type": "forcePushed"}, {"oid": "5408a7cbdf8c3d14dba25caf5b56af3e9728503d", "url": "https://github.com/camunda-cloud/zeebe/commit/5408a7cbdf8c3d14dba25caf5b56af3e9728503d", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-02-26T15:17:39Z", "type": "forcePushed"}, {"oid": "ce62b162c5e15e8538358da4f1db0c6165f97159", "url": "https://github.com/camunda-cloud/zeebe/commit/ce62b162c5e15e8538358da4f1db0c6165f97159", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-02-26T16:54:14Z", "type": "forcePushed"}, {"oid": "4c15b1df8b8b11021d0c228f45e5fa6fc6b9ff08", "url": "https://github.com/camunda-cloud/zeebe/commit/4c15b1df8b8b11021d0c228f45e5fa6fc6b9ff08", "message": "fixup post rebase", "committedDate": "2020-02-26T17:29:06Z", "type": "forcePushed"}, {"oid": "f2129e626cca591544f1ffadd586dea7dcb110a6", "url": "https://github.com/camunda-cloud/zeebe/commit/f2129e626cca591544f1ffadd586dea7dcb110a6", "message": "fixup post rebase", "committedDate": "2020-02-26T17:35:51Z", "type": "forcePushed"}, {"oid": "be2c3c1b5475d3272100dddf6ebc72c19ba4492b", "url": "https://github.com/camunda-cloud/zeebe/commit/be2c3c1b5475d3272100dddf6ebc72c19ba4492b", "message": "fixup post rebase", "committedDate": "2020-02-27T14:00:37Z", "type": "forcePushed"}, {"oid": "c149018ef10934749d0739224aa45681505dff2c", "url": "https://github.com/camunda-cloud/zeebe/commit/c149018ef10934749d0739224aa45681505dff2c", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-02-27T14:01:40Z", "type": "forcePushed"}, {"oid": "cebf83aef164da275826ce152f16f1940f7ec176", "url": "https://github.com/camunda-cloud/zeebe/commit/cebf83aef164da275826ce152f16f1940f7ec176", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-02-27T14:11:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2MzI4Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385763286", "bodyText": "Can we also add this as the default ID as part of DebugLogExporter? Or perhaps have DebugLogExporter.createDefaultExporter(value) or DebugLogExporter.newDefaultExporter(value)?", "author": "npepinpe", "createdAt": "2020-02-28T15:35:49Z", "path": "broker/src/main/java/io/zeebe/broker/system/configuration/BrokerCfg.java", "diffHunk": "@@ -9,46 +9,50 @@\n \n import com.google.gson.GsonBuilder;\n import io.zeebe.broker.exporter.debug.DebugLogExporter;\n-import io.zeebe.util.DurationUtil;\n import io.zeebe.util.Environment;\n import java.time.Duration;\n-import java.util.ArrayList;\n-import java.util.List;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.stereotype.Component;\n \n+@Component\n+@ConfigurationProperties(prefix = \"zeebe-broker\")\n public final class BrokerCfg {\n \n   private NetworkCfg network = new NetworkCfg();\n   private ClusterCfg cluster = new ClusterCfg();\n   private ThreadsCfg threads = new ThreadsCfg();\n   private DataCfg data = new DataCfg();\n-  private List<ExporterCfg> exporters = new ArrayList<>();\n+  private Map<String, ExporterCfg> exporters = new HashMap<>();\n   private EmbeddedGatewayCfg gateway = new EmbeddedGatewayCfg();\n   private BackpressureCfg backpressure = new BackpressureCfg();\n \n-  private String stepTimeout = \"5m\";\n+  private Duration stepTimeout = Duration.ofMinutes(5);\n \n   public void init(final String brokerBase) {\n     init(brokerBase, new Environment());\n   }\n \n   public void init(final String brokerBase, final Environment environment) {\n     applyEnvironment(environment);\n-    network.init(this, brokerBase, environment);\n-    cluster.init(this, brokerBase, environment);\n-    threads.init(this, brokerBase, environment);\n-    data.init(this, brokerBase, environment);\n-    exporters.forEach(e -> e.init(this, brokerBase, environment));\n-    gateway.init(this, brokerBase, environment);\n-    backpressure.init(this, brokerBase, environment);\n+    network.init(this, brokerBase);\n+    cluster.init(this, brokerBase);\n+    threads.init(this, brokerBase);\n+    data.init(this, brokerBase);\n+    exporters.values().forEach(e -> e.init(this, brokerBase));\n+    gateway.init(this, brokerBase);\n+    backpressure.init(this, brokerBase);\n   }\n \n   private void applyEnvironment(final Environment environment) {\n     environment\n         .get(EnvironmentConstants.ENV_DEBUG_EXPORTER)\n         .ifPresent(\n             value ->\n-                exporters.add(DebugLogExporter.defaultConfig(\"pretty\".equalsIgnoreCase(value))));\n-    environment.get(EnvironmentConstants.ENV_STEP_TIMEOUT).ifPresent(this::setStepTimeout);\n+                exporters.put(\n+                    \"DebugLogExporter\",", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk0MTU1OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386941558", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:53:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2MzI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2NTY3Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385765676", "bodyText": "If this is only used in the BrokerCfg post process step, I would move that constant there, what do you think? In general I'm not a fan of constant-only classes/files, but open to discussion.", "author": "npepinpe", "createdAt": "2020-02-28T15:39:37Z", "path": "broker/src/main/java/io/zeebe/broker/system/configuration/EnvironmentConstants.java", "diffHunk": "@@ -9,17 +9,5 @@\n \n public final class EnvironmentConstants {\n \n-  public static final String ENV_NODE_ID = \"ZEEBE_NODE_ID\";\n-  public static final String ENV_HOST = \"ZEEBE_HOST\";\n-  public static final String ENV_ADVERTISED_HOST = \"ZEEBE_ADVERTISED_HOST\";\n-  public static final String ENV_PORT_OFFSET = \"ZEEBE_PORT_OFFSET\";\n-  public static final String ENV_INITIAL_CONTACT_POINTS = \"ZEEBE_CONTACT_POINTS\";\n-  public static final String ENV_DIRECTORIES = \"ZEEBE_DIRECTORIES\";\n-  public static final String ENV_PARTITIONS_COUNT = \"ZEEBE_PARTITIONS_COUNT\";\n-  public static final String ENV_REPLICATION_FACTOR = \"ZEEBE_REPLICATION_FACTOR\";\n-  public static final String ENV_CLUSTER_SIZE = \"ZEEBE_CLUSTER_SIZE\";\n-  public static final String ENV_CLUSTER_NAME = \"ZEEBE_CLUSTER_NAME\";\n-  public static final String ENV_EMBED_GATEWAY = \"ZEEBE_EMBED_GATEWAY\";\n   public static final String ENV_DEBUG_EXPORTER = \"ZEEBE_DEBUG\";", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMDcyOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386900729", "bodyText": "I now moved it into BrokerCfg\nI kept it there, initially,  mostly because I wanted to wait till I implement the \"strict mode\" (which I haven't implemented).\nI am not a fan of constant-only-classes. But I am a fan of having a class where I find several developer flags/feature toggles in one place. But this can wait to another day.", "author": "pihme", "createdAt": "2020-03-03T09:41:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2NTY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2OTY1OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385769659", "bodyText": "Nit: might as well keep using var here.", "author": "npepinpe", "createdAt": "2020-02-28T15:46:08Z", "path": "broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java", "diffHunk": "@@ -115,10 +115,13 @@ public ZeebePartition(\n     this.scheduler = actorScheduler;\n     this.maxFragmentSize = (int) brokerCfg.getNetwork().getMaxMessageSizeInBytes();\n \n+    final var exporterEntries = brokerCfg.getExporters().entrySet();\n     // load and validate exporters\n-    for (final ExporterCfg exporterCfg : brokerCfg.getExporters()) {\n+    for (final var exporterEntry : exporterEntries) {\n+      final String id = exporterEntry.getKey();", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMjU0OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386902548", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T09:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2OTY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MDM1OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385770359", "bodyText": "Hm, I guess this means the behavior is now different - though I would argue for the better \ud83d\udc4d\nNit: I guess the test name is invalid now since we're not ignoring it.", "author": "npepinpe", "createdAt": "2020-02-28T15:47:20Z", "path": "broker/src/test/java/io/zeebe/broker/system/configuration/BrokerCfgTest.java", "diffHunk": "@@ -120,20 +101,24 @@ public void shouldUseSpecifiedNodeId() {\n \n   @Test\n   public void shouldUseNodeIdFromEnvironment() {\n-    environment.put(ENV_NODE_ID, \"42\");\n+    environment.put(ZEEBE_BROKER_CLUSTER_NODE_ID, \"42\");\n     assertDefaultNodeId(42);\n   }\n \n   @Test\n   public void shouldUseNodeIdFromEnvironmentWithSpecifiedNodeId() {\n-    environment.put(ENV_NODE_ID, \"42\");\n+    environment.put(ZEEBE_BROKER_CLUSTER_NODE_ID, \"42\");\n     assertNodeId(\"specific-node-id\", 42);\n   }\n \n   @Test\n   public void shouldIgnoreInvalidNodeIdFromEnvironment() {\n-    environment.put(ENV_NODE_ID, \"a\");\n-    assertDefaultNodeId(DEFAULT_NODE_ID);\n+    // given\n+    environment.put(ZEEBE_BROKER_CLUSTER_NODE_ID, \"a\");\n+\n+    // when + then\n+    Assertions.assertThatThrownBy(() -> assertDefaultNodeId(DEFAULT_NODE_ID))", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMjY2Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386902663", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T09:45:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MDM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MDk2Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385770963", "bodyText": "Nit: same as above I guess", "author": "npepinpe", "createdAt": "2020-02-28T15:48:21Z", "path": "broker/src/test/java/io/zeebe/broker/system/configuration/BrokerCfgTest.java", "diffHunk": "@@ -175,21 +160,29 @@ public void shouldUsePortOffsetFromEnvironment() {\n \n   @Test\n   public void shouldUsePortOffsetFromEnvironmentWithSpecifiedPorts() {\n-    environment.put(ENV_PORT_OFFSET, \"3\");\n+    environment.put(ZEEBE_BROKER_NETWORK_PORT_OFFSET, \"3\");\n     final int offset = 30;\n     assertPorts(\"specific-ports\", 1 + offset, 5 + offset, 6 + offset);\n   }\n \n   @Test\n   public void shouldIgnoreInvalidPortOffsetFromEnvironment() {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMzMwNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386903305", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T09:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MDk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MjE3MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385772171", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class ClusterCfgTest {\n          \n          \n            \n            public final class ClusterCfgTest {\n          \n      \n    \n    \n  \n\nNit: kind of inconsequential here, but we usually make classes final unless otherwise needed.", "author": "npepinpe", "createdAt": "2020-02-28T15:50:30Z", "path": "broker/src/test/java/io/zeebe/broker/system/configuration/ClusterCfgTest.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.broker.system.configuration;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import org.junit.Test;\n+\n+public class ClusterCfgTest {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMzQ2OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386903468", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T09:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MjE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MjQyOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385772429", "bodyText": "I've seen you use this before, just out of curiosity, what does sut stand for?", "author": "npepinpe", "createdAt": "2020-02-28T15:50:56Z", "path": "broker/src/test/java/io/zeebe/broker/system/configuration/ClusterCfgTest.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.broker.system.configuration;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import org.junit.Test;\n+\n+public class ClusterCfgTest {\n+\n+  @Test\n+  public void shouldSanitizeContactPoints() {\n+    // given\n+    final ClusterCfg sutClusterConfig = new ClusterCfg();", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwNDAwMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386904002", "bodyText": "system under test\nI like to prefix variables in tests with: mock, spy, sut", "author": "pihme", "createdAt": "2020-03-03T09:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MjQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3NDk3Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386974972", "bodyText": "That's fine, I just had never come across sut \ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-03-03T12:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MjQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3NzA0OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385777048", "bodyText": "We typically mark everything final unless otherwise necessary.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class EnvironmentHelper {\n          \n          \n            \n            public final class EnvironmentHelper {\n          \n      \n    \n    \n  \n\nAs this class seems to be intended to not be instantiated, I would propose to also add a private constructor just to make that clear.", "author": "npepinpe", "createdAt": "2020-02-28T15:58:55Z", "path": "dist/src/main/java/io/zeebe/EnvironmentHelper.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import org.springframework.core.env.Environment;\n+\n+public class EnvironmentHelper {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwNDI1MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386904250", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T09:47:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3NzA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3NzI1Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385777253", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static boolean isProductionEnvironment(Environment springEnvironment) {\n          \n          \n            \n              public static boolean isProductionEnvironment(final Environment springEnvironment) {", "author": "npepinpe", "createdAt": "2020-02-28T15:59:15Z", "path": "dist/src/main/java/io/zeebe/EnvironmentHelper.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import org.springframework.core.env.Environment;\n+\n+public class EnvironmentHelper {\n+\n+  public static boolean isProductionEnvironment(Environment springEnvironment) {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwNDUyNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386904526", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T09:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3NzI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3Nzc5NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385777794", "bodyText": "Is it possible for this to be null? What does that imply, i.e. the auto-wiring failed?", "author": "npepinpe", "createdAt": "2020-02-28T16:00:15Z", "path": "dist/src/main/java/io/zeebe/EnvironmentHelper.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import org.springframework.core.env.Environment;\n+\n+public class EnvironmentHelper {\n+\n+  public static boolean isProductionEnvironment(Environment springEnvironment) {\n+    boolean result = true;\n+\n+    if (springEnvironment == null) {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwOTExMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386909113", "bodyText": "Yes it's possible for this to be null.\nThis happens when auto-wiring was never triggered. The most common situation is when you instantiate a class in a test. Then you could either mock the injected objects, trigger injection somehow, or simply live with them being null.", "author": "pihme", "createdAt": "2020-03-03T09:56:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3Nzc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3OTA5Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385779092", "bodyText": "I think it's not possible for activeProfiles to be null according to their source code - they return a static empty array instance. Although I guess since they don't annotate it as NonNull it could change? What do you think?", "author": "npepinpe", "createdAt": "2020-02-28T16:02:21Z", "path": "dist/src/main/java/io/zeebe/EnvironmentHelper.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import org.springframework.core.env.Environment;\n+\n+public class EnvironmentHelper {\n+\n+  public static boolean isProductionEnvironment(Environment springEnvironment) {\n+    boolean result = true;\n+\n+    if (springEnvironment == null) {\n+      result = false;\n+    } else {\n+      final String[] activeProfiles = springEnvironment.getActiveProfiles();\n+      if (activeProfiles != null && !(activeProfiles.length == 0)) {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxMTQ2Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386911467", "bodyText": "I think you are right. It's mostly an old habit of mine to use defensive programming.\nAlso, I wouldn't want to use many assumptions about the implementation of code I use. Plus it's an interface.\nAgain, in a test, if you pass in a mock for the springEnvironment which isn't set up completely, it will return null.\nAll in all, I think you are correct. However, I would like to keep it that way,", "author": "pihme", "createdAt": "2020-03-03T10:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3OTA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk4ODQ3NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386988475", "bodyText": "No, you're right, let's go with that.", "author": "npepinpe", "createdAt": "2020-03-03T12:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3OTA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3OTk1MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385779950", "bodyText": "What's the different between putting this here or in the launcher? Apart from showing it when not starting this from the distribution launcher?", "author": "npepinpe", "createdAt": "2020-02-28T16:03:53Z", "path": "dist/src/main/java/io/zeebe/broker/StandaloneBroker.java", "diffHunk": "@@ -9,24 +9,52 @@\n \n import static java.lang.Runtime.getRuntime;\n \n+import io.zeebe.EnvironmentHelper;\n import io.zeebe.broker.system.configuration.BrokerCfg;\n+import io.zeebe.legacy.tomlconfig.LegacyConfigurationSupport;\n+import io.zeebe.legacy.tomlconfig.LegacyConfigurationSupport.Scope;\n import io.zeebe.util.FileUtil;\n import java.io.IOException;\n import java.nio.file.Files;\n import java.nio.file.Paths;\n import java.util.concurrent.CountDownLatch;\n import org.apache.logging.log4j.LogManager;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.CommandLineRunner;\n+import org.springframework.boot.SpringApplication;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.core.env.Environment;\n \n-public class StandaloneBroker {\n-  private static final CountDownLatch WAITING_LATCH = new CountDownLatch(1);\n-  private static String tempFolder;\n+@SpringBootApplication\n+public class StandaloneBroker implements CommandLineRunner {\n+\n+  @Autowired BrokerCfg configuration;\n+  @Autowired Environment springEnvironment;\n+\n+  private final CountDownLatch waiting_latch = new CountDownLatch(1);\n+  private String tempFolder;\n \n   public static void main(final String[] args) throws Exception {\n+    System.setProperty(\"spring.banner.location\", \"classpath:/assets/zeebe_broker_banner.txt\");", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxMjg2Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386912863", "bodyText": "Not sure what you mean by launcher.\nThis has to be set before calling SpringApplication.run(...). So you can set it here or in startup.sh, which would be weird in my mind. Not sure which other place you have in mind.", "author": "pihme", "createdAt": "2020-03-03T10:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3OTk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3NjUyNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386976526", "bodyText": "I referred to the shell/batch scripts we generate in the packaging phase, e.g. bin/broker, in which we set some system properties when running the jar. These options are set in dist/pom.xml", "author": "npepinpe", "createdAt": "2020-03-03T12:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3OTk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3ODQyMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386978421", "bodyText": "Well, I wouldn't set it there. I think the banner should be internal to the application. What I could do is set it only if it is undefined.", "author": "pihme", "createdAt": "2020-03-03T12:11:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3OTk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk4OTIyNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386989227", "bodyText": "I have no strong preference, I suppose I'm just used to setting properties externally, but I also have no strong argument against it. Let's go with this until we have a reason not to \ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-03-03T12:33:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3OTk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MDgxMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385780812", "bodyText": "Do you feel the method names do not reflect properly what they do?", "author": "npepinpe", "createdAt": "2020-02-28T16:05:28Z", "path": "dist/src/main/java/io/zeebe/broker/StandaloneBroker.java", "diffHunk": "@@ -9,24 +9,52 @@\n \n import static java.lang.Runtime.getRuntime;\n \n+import io.zeebe.EnvironmentHelper;\n import io.zeebe.broker.system.configuration.BrokerCfg;\n+import io.zeebe.legacy.tomlconfig.LegacyConfigurationSupport;\n+import io.zeebe.legacy.tomlconfig.LegacyConfigurationSupport.Scope;\n import io.zeebe.util.FileUtil;\n import java.io.IOException;\n import java.nio.file.Files;\n import java.nio.file.Paths;\n import java.util.concurrent.CountDownLatch;\n import org.apache.logging.log4j.LogManager;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.CommandLineRunner;\n+import org.springframework.boot.SpringApplication;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.core.env.Environment;\n \n-public class StandaloneBroker {\n-  private static final CountDownLatch WAITING_LATCH = new CountDownLatch(1);\n-  private static String tempFolder;\n+@SpringBootApplication\n+public class StandaloneBroker implements CommandLineRunner {\n+\n+  @Autowired BrokerCfg configuration;\n+  @Autowired Environment springEnvironment;\n+\n+  private final CountDownLatch waiting_latch = new CountDownLatch(1);\n+  private String tempFolder;\n \n   public static void main(final String[] args) throws Exception {\n+    System.setProperty(\"spring.banner.location\", \"classpath:/assets/zeebe_broker_banner.txt\");\n+\n+    final LegacyConfigurationSupport legacyConfigSupport =\n+        new LegacyConfigurationSupport(Scope.BROKER);\n+    legacyConfigSupport.checkForLegacyTomlConfigurationArgument(args, \"broker.cfg.yaml\");\n+    legacyConfigSupport.checkForLegacyEnvironmentVariables();\n+\n+    SpringApplication.run(StandaloneBroker.class, args);\n+  }\n+\n+  @Override\n+  public void run(final String... args) throws Exception {\n     final Broker broker;\n \n-    if (args.length == 1) {\n-      broker = createBrokerFromConfiguration(args);\n+    if (EnvironmentHelper.isProductionEnvironment(springEnvironment)) {\n+      // creates a broker in the base directory that will run with the configuration provided by", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxNDU5NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386914594", "bodyText": "Yes. There are two aspects of the two methods:\n\nbase dir vs temp dir\ngiven config vs. default config\n\nI had several rounds of renaming the methods and still got confused. That is the best I could come up with.\nI am very open for naming suggestions.", "author": "pihme", "createdAt": "2020-03-03T10:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MDgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk5MDM1MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386990350", "bodyText": "Sorry, that was a misunderstanding completely on me \ud83d\ude05 I meant it as questioning if the comment , e.g. it is there because the name of the method does not properly reflect what the method does?\nI would personally remove it but wanted to hear what you thought", "author": "npepinpe", "createdAt": "2020-03-03T12:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MDgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAxODgzMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r387018833", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T13:30:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MDgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MTY4NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385781685", "bodyText": "So the previous behavior still allowed environment variables to override the configuration, as resolving was part of the post-processing step. Is there anything that speaks against using the spring provided configuration (which will be default if the user doesn't specify anything)?", "author": "npepinpe", "createdAt": "2020-02-28T16:07:11Z", "path": "dist/src/main/java/io/zeebe/broker/StandaloneBroker.java", "diffHunk": "@@ -44,32 +72,32 @@ public void run() {\n                 }\n               }\n             });\n-    WAITING_LATCH.await();\n+    waiting_latch.await();\n   }\n \n-  private static Broker createBrokerFromConfiguration(final String[] args) {\n+  private Broker createBrokerInBaseDirectory() {\n     String basePath = System.getProperty(\"basedir\");\n \n     if (basePath == null) {\n       basePath = Paths.get(\".\").toAbsolutePath().normalize().toString();\n     }\n \n-    return new Broker(args[0], basePath, null);\n+    return new Broker(configuration, basePath, null);\n   }\n \n-  private static Broker createDefaultBrokerInTempDirectory() {\n+  private Broker createDefaultBrokerInTempDirectory() {\n     Loggers.SYSTEM_LOGGER.info(\"No configuration file specified. Using default configuration.\");\n \n     try {\n       tempFolder = Files.createTempDirectory(\"zeebe\").toAbsolutePath().normalize().toString();\n-      final BrokerCfg cfg = new BrokerCfg();\n-      return new Broker(cfg, tempFolder, null);\n+      final BrokerCfg defaultConfiguration = new BrokerCfg();", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxODU2NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386918565", "bodyText": "hmm, very good point. You are correct in your assessment.\nI think it comes down to \"least astonishment principle\".\nMy goal here was to say: you either have everything in terms of configuration, or a clean slate with defaults.\nThis hybrid to ignore the configuration file, but respect the environment variables is a bit confusing to me. Plus, you would need to make sure that you don't accidentally have environment variables which do define configuration files.\nI would yield to your preference in this case, as I don't know how this mode was used in the past.", "author": "pihme", "createdAt": "2020-03-03T10:13:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MTY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3ODYxMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386978610", "bodyText": "As you noted with the profiles, this is used pretty much only for development. It is useful to be able to configure it if, for example, you want to run a cluster locally through the IDE, but still need to assign different ports.", "author": "npepinpe", "createdAt": "2020-03-03T12:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MTY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3OTA3NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386979074", "bodyText": "So I would say it should still be configurable through external means, e.g. env var, properties, args, etc", "author": "npepinpe", "createdAt": "2020-03-03T12:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MTY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk4MDM0Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386980342", "bodyText": "In this case I would use the full blown Spring config for both cases. And then these methods would only deal with what folder the broker runs in. Ditto for Gateway.\nPlease let me know whether this is acceptable for you.", "author": "pihme", "createdAt": "2020-03-03T12:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MTY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk5MTA4Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386991082", "bodyText": "Sounds good. The only thing we care about here is that it runs in a temporary directory, really.", "author": "npepinpe", "createdAt": "2020-03-03T12:37:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MTY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAxODk1MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r387018951", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T13:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MTY4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MTg4Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385781883", "bodyText": "Same question as in StandaloneBroker", "author": "npepinpe", "createdAt": "2020-02-28T16:07:35Z", "path": "dist/src/main/java/io/zeebe/gateway/StandaloneGateway.java", "diffHunk": "@@ -90,8 +100,7 @@ public void run() throws IOException, InterruptedException {\n   }\n \n   public static void main(final String[] args) throws Exception {\n-    final GatewayCfg gatewayCfg = initConfiguration(args);\n-    gatewayCfg.init();\n+    System.setProperty(\"spring.banner.location\", \"classpath:/assets/zeebe_gateway_banner.txt\");", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxODY3Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386918676", "bodyText": "same answer", "author": "pihme", "createdAt": "2020-03-03T10:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MTg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MjIzOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385782239", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class EnvironmentHelperTest {\n          \n          \n            \n            public final class EnvironmentHelperTest {", "author": "npepinpe", "createdAt": "2020-02-28T16:08:17Z", "path": "dist/src/test/java/io/zeebe/EnvironmentHelperTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.springframework.core.env.Environment;\n+\n+public class EnvironmentHelperTest {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxODg0Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386918847", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4MjIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NDM2Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385784366", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class LegacyConfigurationSupport {\n          \n          \n            \n            public final class LegacyConfigurationSupport {", "author": "npepinpe", "createdAt": "2020-02-28T16:12:12Z", "path": "legacy/toml-config/src/main/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupport.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.util.Loggers;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+public class LegacyConfigurationSupport {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxOTE0MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386919140", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:14:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NDM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NDcxMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385784711", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final Map<String, Function<String, String>> VALUE_CONVERTERS_GATEWAY =\n          \n          \n            \n              private static final Map<String, UnaryOperator<String>> VALUE_CONVERTERS_GATEWAY =\n          \n      \n    \n    \n  \n\nNote: I guess you can't directly commit this change as it will need to import UnaryOperator first.", "author": "npepinpe", "createdAt": "2020-02-28T16:12:43Z", "path": "legacy/toml-config/src/main/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupport.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.util.Loggers;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+public class LegacyConfigurationSupport {\n+  private static final Map<String, Replacement> MAPPING_GATEWAY = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_GATEWAY =", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxOTg2Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386919862", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:15:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NDcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NDgxOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385784819", "bodyText": "Same as above, but more importantly, is this used anywhere? It seems in checkForLegacyEnvironmentVariables we use an empty map as mapping?", "author": "npepinpe", "createdAt": "2020-02-28T16:12:55Z", "path": "legacy/toml-config/src/main/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupport.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.util.Loggers;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+public class LegacyConfigurationSupport {\n+  private static final Map<String, Replacement> MAPPING_GATEWAY = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_GATEWAY =\n+      new HashMap<>();\n+  private static final Map<String, Replacement> MAPPING_BROKER = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_BROKER =", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkyMDY2Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386920667", "bodyText": "Oops, done", "author": "pihme", "createdAt": "2020-03-03T10:17:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NDgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NTEzOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385785138", "bodyText": "That's a pretty big lambda, can we extract it to a method?", "author": "npepinpe", "createdAt": "2020-02-28T16:13:32Z", "path": "legacy/toml-config/src/main/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupport.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.util.Loggers;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+public class LegacyConfigurationSupport {\n+  private static final Map<String, Replacement> MAPPING_GATEWAY = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_GATEWAY =\n+      new HashMap<>();\n+  private static final Map<String, Replacement> MAPPING_BROKER = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_BROKER =\n+      new HashMap<>();\n+  private static final int DEFAULT_CONTACT_POINT_PORT = 26502;\n+\n+  static { // static initialization for mapping tables\n+\n+    // zeebe-gateway.network\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_HOST\", new Replacement(\"zeebe-gateway.network.host\"));\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_PORT\", new Replacement(\"zeebe-gateway.network.port\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_KEEP_ALIVE_INTERVAL\",\n+        new Replacement(\"zeebe-gateway.network.minKeepAliveInterval\"));\n+\n+    // zeebe-gateway.cluster\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_REQUEST_TIMEOUT\", new Replacement(\"zeebe-gateway.cluster.requestTimeout\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\", new Replacement(\"zeebe-gateway.cluster.contactPoint\"));\n+    VALUE_CONVERTERS_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\",\n+        value -> value.contains(\":\") ? value : value + \":\" + DEFAULT_CONTACT_POINT_PORT);\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_NAME\", new Replacement(\"zeebe-gateway.cluster.clusterName\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_MEMBER_ID\", new Replacement(\"zeebe-gateway.cluster.memberId\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_HOST\", new Replacement(\"zeebe-gateway.cluster.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_PORT\", new Replacement(\"zeebe-gateway.cluster.port\"));\n+\n+    // zeebe-gateway.monitoring\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_ENABLED\", new Replacement(\"zeebe-gateway.monitoring.enadbled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_HOST\", new Replacement(\"zeebe-gateway.monitoring.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_PORT\", new Replacement(\"zeebe-gateway.monitoring.port\"));\n+\n+    // zeebe-gateway.threads\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MANAGEMENT_THREADS\",\n+        new Replacement(\"zeebe-gateway.threads.managementThreads\"));\n+\n+    // zeebe-gateway.security\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_SECURITY_ENABLED\", new Replacement(\"zeebe-gateway.security.enabled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CERTIFICATE_PATH\",\n+        new Replacement(\"zeebe-gateway.security.certificateChainPath\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_PRIVATE_KEY_PATH\", new Replacement(\"zeebe-gateway.security.privateKeyPath\"));\n+\n+    // zeebe-broker ----------------------------------------\n+    MAPPING_BROKER.put(\"ZEEBE_STEP_TIMEOUT\", new Replacement(\"zeebe-broker.stepTimeout\"));\n+\n+    // zeebe-broker.cluster\n+    MAPPING_BROKER.put(\"ZEEBE_NODE_ID\", new Replacement(\"zeebe-broker.cluster.nodeId\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_CONTACT_POINTS\", new Replacement(\"zeebe-broker.cluster.initialContactPoints\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_PARTITIONS_COUNT\", new Replacement(\"zeebe-broker.cluster.partitionsCount\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_REPLICATION_FACTOR\", new Replacement(\"zeebe-broker.cluster.replicationFactor\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_SIZE\", new Replacement(\"zeebe-broker.cluster.clusterSize\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_NAME\", new Replacement(\"zeebe-broker.cluster.clusterName\"));\n+\n+    // zeebe-broker.data\n+    MAPPING_BROKER.put(\"ZEEBE_DIRECTORIES\", new Replacement(\"zeebe-broker.data.directories\"));\n+\n+    // zeebe-broker.gateway\n+    MAPPING_BROKER.put(\"ZEEBE_EMBED_GATEWAY\", new Replacement(\"zeebe-broker.gateway.enable\"));\n+\n+    /* this essentially copies all entries from the gateway mapping table, but modifies\n+     * the new environment variables from \"zeebe-gateway.*\" to \"zeebe-broker.gateway.*\"\n+     */\n+    MAPPING_GATEWAY\n+        .entrySet()\n+        .forEach(\n+            entry -> {\n+              final String oldEnvironmentVariable = entry.getKey();", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkyMzg5Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386923893", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NTEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NTMwNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385785306", "bodyText": "Was this completed?", "author": "npepinpe", "createdAt": "2020-02-28T16:13:49Z", "path": "legacy/toml-config/src/main/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupport.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.util.Loggers;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+public class LegacyConfigurationSupport {\n+  private static final Map<String, Replacement> MAPPING_GATEWAY = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_GATEWAY =\n+      new HashMap<>();\n+  private static final Map<String, Replacement> MAPPING_BROKER = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_BROKER =\n+      new HashMap<>();\n+  private static final int DEFAULT_CONTACT_POINT_PORT = 26502;\n+\n+  static { // static initialization for mapping tables\n+\n+    // zeebe-gateway.network\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_HOST\", new Replacement(\"zeebe-gateway.network.host\"));\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_PORT\", new Replacement(\"zeebe-gateway.network.port\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_KEEP_ALIVE_INTERVAL\",\n+        new Replacement(\"zeebe-gateway.network.minKeepAliveInterval\"));\n+\n+    // zeebe-gateway.cluster\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_REQUEST_TIMEOUT\", new Replacement(\"zeebe-gateway.cluster.requestTimeout\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\", new Replacement(\"zeebe-gateway.cluster.contactPoint\"));\n+    VALUE_CONVERTERS_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\",\n+        value -> value.contains(\":\") ? value : value + \":\" + DEFAULT_CONTACT_POINT_PORT);\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_NAME\", new Replacement(\"zeebe-gateway.cluster.clusterName\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_MEMBER_ID\", new Replacement(\"zeebe-gateway.cluster.memberId\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_HOST\", new Replacement(\"zeebe-gateway.cluster.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_PORT\", new Replacement(\"zeebe-gateway.cluster.port\"));\n+\n+    // zeebe-gateway.monitoring\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_ENABLED\", new Replacement(\"zeebe-gateway.monitoring.enadbled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_HOST\", new Replacement(\"zeebe-gateway.monitoring.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_PORT\", new Replacement(\"zeebe-gateway.monitoring.port\"));\n+\n+    // zeebe-gateway.threads\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MANAGEMENT_THREADS\",\n+        new Replacement(\"zeebe-gateway.threads.managementThreads\"));\n+\n+    // zeebe-gateway.security\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_SECURITY_ENABLED\", new Replacement(\"zeebe-gateway.security.enabled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CERTIFICATE_PATH\",\n+        new Replacement(\"zeebe-gateway.security.certificateChainPath\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_PRIVATE_KEY_PATH\", new Replacement(\"zeebe-gateway.security.privateKeyPath\"));\n+\n+    // zeebe-broker ----------------------------------------\n+    MAPPING_BROKER.put(\"ZEEBE_STEP_TIMEOUT\", new Replacement(\"zeebe-broker.stepTimeout\"));\n+\n+    // zeebe-broker.cluster\n+    MAPPING_BROKER.put(\"ZEEBE_NODE_ID\", new Replacement(\"zeebe-broker.cluster.nodeId\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_CONTACT_POINTS\", new Replacement(\"zeebe-broker.cluster.initialContactPoints\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_PARTITIONS_COUNT\", new Replacement(\"zeebe-broker.cluster.partitionsCount\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_REPLICATION_FACTOR\", new Replacement(\"zeebe-broker.cluster.replicationFactor\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_SIZE\", new Replacement(\"zeebe-broker.cluster.clusterSize\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_NAME\", new Replacement(\"zeebe-broker.cluster.clusterName\"));\n+\n+    // zeebe-broker.data\n+    MAPPING_BROKER.put(\"ZEEBE_DIRECTORIES\", new Replacement(\"zeebe-broker.data.directories\"));\n+\n+    // zeebe-broker.gateway\n+    MAPPING_BROKER.put(\"ZEEBE_EMBED_GATEWAY\", new Replacement(\"zeebe-broker.gateway.enable\"));\n+\n+    /* this essentially copies all entries from the gateway mapping table, but modifies\n+     * the new environment variables from \"zeebe-gateway.*\" to \"zeebe-broker.gateway.*\"\n+     */\n+    MAPPING_GATEWAY\n+        .entrySet()\n+        .forEach(\n+            entry -> {\n+              final String oldEnvironmentVariable = entry.getKey();\n+              final String newEnvironmentVariableInGatewayContext =\n+                  entry.getValue().getCanonicalRepresentation();\n+\n+              assert newEnvironmentVariableInGatewayContext.startsWith(\"zeebe-\");\n+              final int insertionPoint = \"zeebe-\".length();\n+\n+              final String newEnvironmentVariableInBrokerContext =\n+                  newEnvironmentVariableInGatewayContext.substring(0, insertionPoint) // \"zeebe-\"\n+                      + \"broker.\"\n+                      + newEnvironmentVariableInGatewayContext.substring(\n+                          insertionPoint); // \"gateway.*\"\n+\n+              MAPPING_BROKER.put(\n+                  oldEnvironmentVariable, new Replacement(newEnvironmentVariableInBrokerContext));\n+            });\n+    VALUE_CONVERTERS_BROKER.putAll(VALUE_CONVERTERS_GATEWAY);\n+\n+    // zeebe-broker.network\n+    MAPPING_BROKER.put(\"ZEEBE_HOST\", new Replacement(\"zeebe-broker.network.host\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_ADVERTISED_HOST\", new Replacement(\"zeebe-broker.network.advertisedHost\"));\n+    MAPPING_BROKER.put(\"ZEEBE_PORT_OFFSET\", new Replacement(\"zeebe-broker.network.portOffset\"));\n+\n+    // TODO check docker files and shell scripts and change those as well;", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3NDkzMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386974930", "bodyText": "Now it was ;-)", "author": "pihme", "createdAt": "2020-03-03T12:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NTMwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NTQwOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385785408", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public LegacyConfigurationSupport(Scope scope) {\n          \n          \n            \n              public LegacyConfigurationSupport(final Scope scope) {", "author": "npepinpe", "createdAt": "2020-02-28T16:14:00Z", "path": "legacy/toml-config/src/main/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupport.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.util.Loggers;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+public class LegacyConfigurationSupport {\n+  private static final Map<String, Replacement> MAPPING_GATEWAY = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_GATEWAY =\n+      new HashMap<>();\n+  private static final Map<String, Replacement> MAPPING_BROKER = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_BROKER =\n+      new HashMap<>();\n+  private static final int DEFAULT_CONTACT_POINT_PORT = 26502;\n+\n+  static { // static initialization for mapping tables\n+\n+    // zeebe-gateway.network\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_HOST\", new Replacement(\"zeebe-gateway.network.host\"));\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_PORT\", new Replacement(\"zeebe-gateway.network.port\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_KEEP_ALIVE_INTERVAL\",\n+        new Replacement(\"zeebe-gateway.network.minKeepAliveInterval\"));\n+\n+    // zeebe-gateway.cluster\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_REQUEST_TIMEOUT\", new Replacement(\"zeebe-gateway.cluster.requestTimeout\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\", new Replacement(\"zeebe-gateway.cluster.contactPoint\"));\n+    VALUE_CONVERTERS_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\",\n+        value -> value.contains(\":\") ? value : value + \":\" + DEFAULT_CONTACT_POINT_PORT);\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_NAME\", new Replacement(\"zeebe-gateway.cluster.clusterName\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_MEMBER_ID\", new Replacement(\"zeebe-gateway.cluster.memberId\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_HOST\", new Replacement(\"zeebe-gateway.cluster.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_PORT\", new Replacement(\"zeebe-gateway.cluster.port\"));\n+\n+    // zeebe-gateway.monitoring\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_ENABLED\", new Replacement(\"zeebe-gateway.monitoring.enadbled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_HOST\", new Replacement(\"zeebe-gateway.monitoring.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_PORT\", new Replacement(\"zeebe-gateway.monitoring.port\"));\n+\n+    // zeebe-gateway.threads\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MANAGEMENT_THREADS\",\n+        new Replacement(\"zeebe-gateway.threads.managementThreads\"));\n+\n+    // zeebe-gateway.security\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_SECURITY_ENABLED\", new Replacement(\"zeebe-gateway.security.enabled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CERTIFICATE_PATH\",\n+        new Replacement(\"zeebe-gateway.security.certificateChainPath\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_PRIVATE_KEY_PATH\", new Replacement(\"zeebe-gateway.security.privateKeyPath\"));\n+\n+    // zeebe-broker ----------------------------------------\n+    MAPPING_BROKER.put(\"ZEEBE_STEP_TIMEOUT\", new Replacement(\"zeebe-broker.stepTimeout\"));\n+\n+    // zeebe-broker.cluster\n+    MAPPING_BROKER.put(\"ZEEBE_NODE_ID\", new Replacement(\"zeebe-broker.cluster.nodeId\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_CONTACT_POINTS\", new Replacement(\"zeebe-broker.cluster.initialContactPoints\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_PARTITIONS_COUNT\", new Replacement(\"zeebe-broker.cluster.partitionsCount\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_REPLICATION_FACTOR\", new Replacement(\"zeebe-broker.cluster.replicationFactor\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_SIZE\", new Replacement(\"zeebe-broker.cluster.clusterSize\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_NAME\", new Replacement(\"zeebe-broker.cluster.clusterName\"));\n+\n+    // zeebe-broker.data\n+    MAPPING_BROKER.put(\"ZEEBE_DIRECTORIES\", new Replacement(\"zeebe-broker.data.directories\"));\n+\n+    // zeebe-broker.gateway\n+    MAPPING_BROKER.put(\"ZEEBE_EMBED_GATEWAY\", new Replacement(\"zeebe-broker.gateway.enable\"));\n+\n+    /* this essentially copies all entries from the gateway mapping table, but modifies\n+     * the new environment variables from \"zeebe-gateway.*\" to \"zeebe-broker.gateway.*\"\n+     */\n+    MAPPING_GATEWAY\n+        .entrySet()\n+        .forEach(\n+            entry -> {\n+              final String oldEnvironmentVariable = entry.getKey();\n+              final String newEnvironmentVariableInGatewayContext =\n+                  entry.getValue().getCanonicalRepresentation();\n+\n+              assert newEnvironmentVariableInGatewayContext.startsWith(\"zeebe-\");\n+              final int insertionPoint = \"zeebe-\".length();\n+\n+              final String newEnvironmentVariableInBrokerContext =\n+                  newEnvironmentVariableInGatewayContext.substring(0, insertionPoint) // \"zeebe-\"\n+                      + \"broker.\"\n+                      + newEnvironmentVariableInGatewayContext.substring(\n+                          insertionPoint); // \"gateway.*\"\n+\n+              MAPPING_BROKER.put(\n+                  oldEnvironmentVariable, new Replacement(newEnvironmentVariableInBrokerContext));\n+            });\n+    VALUE_CONVERTERS_BROKER.putAll(VALUE_CONVERTERS_GATEWAY);\n+\n+    // zeebe-broker.network\n+    MAPPING_BROKER.put(\"ZEEBE_HOST\", new Replacement(\"zeebe-broker.network.host\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_ADVERTISED_HOST\", new Replacement(\"zeebe-broker.network.advertisedHost\"));\n+    MAPPING_BROKER.put(\"ZEEBE_PORT_OFFSET\", new Replacement(\"zeebe-broker.network.portOffset\"));\n+\n+    // TODO check docker files and shell scripts and change those as well;\n+    //  if so remove hint in header of sample config files\n+    //  also test that it works when using the startup script\n+\n+  }\n+\n+  private final Scope scope;\n+\n+  public LegacyConfigurationSupport(Scope scope) {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkyNDc4Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386924783", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:24:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NTQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NTQ5MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385785490", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void checkForLegacyTomlConfigurationArgument(String[] args, String recommendedSetting) {\n          \n          \n            \n              public void checkForLegacyTomlConfigurationArgument(final String[] args, final String recommendedSetting) {", "author": "npepinpe", "createdAt": "2020-02-28T16:14:11Z", "path": "legacy/toml-config/src/main/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupport.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.util.Loggers;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+public class LegacyConfigurationSupport {\n+  private static final Map<String, Replacement> MAPPING_GATEWAY = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_GATEWAY =\n+      new HashMap<>();\n+  private static final Map<String, Replacement> MAPPING_BROKER = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_BROKER =\n+      new HashMap<>();\n+  private static final int DEFAULT_CONTACT_POINT_PORT = 26502;\n+\n+  static { // static initialization for mapping tables\n+\n+    // zeebe-gateway.network\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_HOST\", new Replacement(\"zeebe-gateway.network.host\"));\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_PORT\", new Replacement(\"zeebe-gateway.network.port\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_KEEP_ALIVE_INTERVAL\",\n+        new Replacement(\"zeebe-gateway.network.minKeepAliveInterval\"));\n+\n+    // zeebe-gateway.cluster\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_REQUEST_TIMEOUT\", new Replacement(\"zeebe-gateway.cluster.requestTimeout\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\", new Replacement(\"zeebe-gateway.cluster.contactPoint\"));\n+    VALUE_CONVERTERS_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\",\n+        value -> value.contains(\":\") ? value : value + \":\" + DEFAULT_CONTACT_POINT_PORT);\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_NAME\", new Replacement(\"zeebe-gateway.cluster.clusterName\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_MEMBER_ID\", new Replacement(\"zeebe-gateway.cluster.memberId\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_HOST\", new Replacement(\"zeebe-gateway.cluster.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_PORT\", new Replacement(\"zeebe-gateway.cluster.port\"));\n+\n+    // zeebe-gateway.monitoring\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_ENABLED\", new Replacement(\"zeebe-gateway.monitoring.enadbled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_HOST\", new Replacement(\"zeebe-gateway.monitoring.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_PORT\", new Replacement(\"zeebe-gateway.monitoring.port\"));\n+\n+    // zeebe-gateway.threads\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MANAGEMENT_THREADS\",\n+        new Replacement(\"zeebe-gateway.threads.managementThreads\"));\n+\n+    // zeebe-gateway.security\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_SECURITY_ENABLED\", new Replacement(\"zeebe-gateway.security.enabled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CERTIFICATE_PATH\",\n+        new Replacement(\"zeebe-gateway.security.certificateChainPath\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_PRIVATE_KEY_PATH\", new Replacement(\"zeebe-gateway.security.privateKeyPath\"));\n+\n+    // zeebe-broker ----------------------------------------\n+    MAPPING_BROKER.put(\"ZEEBE_STEP_TIMEOUT\", new Replacement(\"zeebe-broker.stepTimeout\"));\n+\n+    // zeebe-broker.cluster\n+    MAPPING_BROKER.put(\"ZEEBE_NODE_ID\", new Replacement(\"zeebe-broker.cluster.nodeId\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_CONTACT_POINTS\", new Replacement(\"zeebe-broker.cluster.initialContactPoints\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_PARTITIONS_COUNT\", new Replacement(\"zeebe-broker.cluster.partitionsCount\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_REPLICATION_FACTOR\", new Replacement(\"zeebe-broker.cluster.replicationFactor\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_SIZE\", new Replacement(\"zeebe-broker.cluster.clusterSize\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_NAME\", new Replacement(\"zeebe-broker.cluster.clusterName\"));\n+\n+    // zeebe-broker.data\n+    MAPPING_BROKER.put(\"ZEEBE_DIRECTORIES\", new Replacement(\"zeebe-broker.data.directories\"));\n+\n+    // zeebe-broker.gateway\n+    MAPPING_BROKER.put(\"ZEEBE_EMBED_GATEWAY\", new Replacement(\"zeebe-broker.gateway.enable\"));\n+\n+    /* this essentially copies all entries from the gateway mapping table, but modifies\n+     * the new environment variables from \"zeebe-gateway.*\" to \"zeebe-broker.gateway.*\"\n+     */\n+    MAPPING_GATEWAY\n+        .entrySet()\n+        .forEach(\n+            entry -> {\n+              final String oldEnvironmentVariable = entry.getKey();\n+              final String newEnvironmentVariableInGatewayContext =\n+                  entry.getValue().getCanonicalRepresentation();\n+\n+              assert newEnvironmentVariableInGatewayContext.startsWith(\"zeebe-\");\n+              final int insertionPoint = \"zeebe-\".length();\n+\n+              final String newEnvironmentVariableInBrokerContext =\n+                  newEnvironmentVariableInGatewayContext.substring(0, insertionPoint) // \"zeebe-\"\n+                      + \"broker.\"\n+                      + newEnvironmentVariableInGatewayContext.substring(\n+                          insertionPoint); // \"gateway.*\"\n+\n+              MAPPING_BROKER.put(\n+                  oldEnvironmentVariable, new Replacement(newEnvironmentVariableInBrokerContext));\n+            });\n+    VALUE_CONVERTERS_BROKER.putAll(VALUE_CONVERTERS_GATEWAY);\n+\n+    // zeebe-broker.network\n+    MAPPING_BROKER.put(\"ZEEBE_HOST\", new Replacement(\"zeebe-broker.network.host\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_ADVERTISED_HOST\", new Replacement(\"zeebe-broker.network.advertisedHost\"));\n+    MAPPING_BROKER.put(\"ZEEBE_PORT_OFFSET\", new Replacement(\"zeebe-broker.network.portOffset\"));\n+\n+    // TODO check docker files and shell scripts and change those as well;\n+    //  if so remove hint in header of sample config files\n+    //  also test that it works when using the startup script\n+\n+  }\n+\n+  private final Scope scope;\n+\n+  public LegacyConfigurationSupport(Scope scope) {\n+    this.scope = scope;\n+  }\n+\n+  /**\n+   * This method checks whether the program was called with a toml configuration file. If so, it\n+   * prints out a warning.\n+   */\n+  public void checkForLegacyTomlConfigurationArgument(String[] args, String recommendedSetting) {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkyNDk5Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386924997", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NTQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NjY2OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385786669", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final Map<String, Function<String, String>> valueConverters;\n          \n          \n            \n                final Map<String, UnaryOperator<String> valueConverters;", "author": "npepinpe", "createdAt": "2020-02-28T16:16:24Z", "path": "legacy/toml-config/src/main/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupport.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.util.Loggers;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+public class LegacyConfigurationSupport {\n+  private static final Map<String, Replacement> MAPPING_GATEWAY = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_GATEWAY =\n+      new HashMap<>();\n+  private static final Map<String, Replacement> MAPPING_BROKER = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_BROKER =\n+      new HashMap<>();\n+  private static final int DEFAULT_CONTACT_POINT_PORT = 26502;\n+\n+  static { // static initialization for mapping tables\n+\n+    // zeebe-gateway.network\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_HOST\", new Replacement(\"zeebe-gateway.network.host\"));\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_PORT\", new Replacement(\"zeebe-gateway.network.port\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_KEEP_ALIVE_INTERVAL\",\n+        new Replacement(\"zeebe-gateway.network.minKeepAliveInterval\"));\n+\n+    // zeebe-gateway.cluster\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_REQUEST_TIMEOUT\", new Replacement(\"zeebe-gateway.cluster.requestTimeout\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\", new Replacement(\"zeebe-gateway.cluster.contactPoint\"));\n+    VALUE_CONVERTERS_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\",\n+        value -> value.contains(\":\") ? value : value + \":\" + DEFAULT_CONTACT_POINT_PORT);\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_NAME\", new Replacement(\"zeebe-gateway.cluster.clusterName\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_MEMBER_ID\", new Replacement(\"zeebe-gateway.cluster.memberId\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_HOST\", new Replacement(\"zeebe-gateway.cluster.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_PORT\", new Replacement(\"zeebe-gateway.cluster.port\"));\n+\n+    // zeebe-gateway.monitoring\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_ENABLED\", new Replacement(\"zeebe-gateway.monitoring.enadbled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_HOST\", new Replacement(\"zeebe-gateway.monitoring.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_PORT\", new Replacement(\"zeebe-gateway.monitoring.port\"));\n+\n+    // zeebe-gateway.threads\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MANAGEMENT_THREADS\",\n+        new Replacement(\"zeebe-gateway.threads.managementThreads\"));\n+\n+    // zeebe-gateway.security\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_SECURITY_ENABLED\", new Replacement(\"zeebe-gateway.security.enabled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CERTIFICATE_PATH\",\n+        new Replacement(\"zeebe-gateway.security.certificateChainPath\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_PRIVATE_KEY_PATH\", new Replacement(\"zeebe-gateway.security.privateKeyPath\"));\n+\n+    // zeebe-broker ----------------------------------------\n+    MAPPING_BROKER.put(\"ZEEBE_STEP_TIMEOUT\", new Replacement(\"zeebe-broker.stepTimeout\"));\n+\n+    // zeebe-broker.cluster\n+    MAPPING_BROKER.put(\"ZEEBE_NODE_ID\", new Replacement(\"zeebe-broker.cluster.nodeId\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_CONTACT_POINTS\", new Replacement(\"zeebe-broker.cluster.initialContactPoints\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_PARTITIONS_COUNT\", new Replacement(\"zeebe-broker.cluster.partitionsCount\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_REPLICATION_FACTOR\", new Replacement(\"zeebe-broker.cluster.replicationFactor\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_SIZE\", new Replacement(\"zeebe-broker.cluster.clusterSize\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_NAME\", new Replacement(\"zeebe-broker.cluster.clusterName\"));\n+\n+    // zeebe-broker.data\n+    MAPPING_BROKER.put(\"ZEEBE_DIRECTORIES\", new Replacement(\"zeebe-broker.data.directories\"));\n+\n+    // zeebe-broker.gateway\n+    MAPPING_BROKER.put(\"ZEEBE_EMBED_GATEWAY\", new Replacement(\"zeebe-broker.gateway.enable\"));\n+\n+    /* this essentially copies all entries from the gateway mapping table, but modifies\n+     * the new environment variables from \"zeebe-gateway.*\" to \"zeebe-broker.gateway.*\"\n+     */\n+    MAPPING_GATEWAY\n+        .entrySet()\n+        .forEach(\n+            entry -> {\n+              final String oldEnvironmentVariable = entry.getKey();\n+              final String newEnvironmentVariableInGatewayContext =\n+                  entry.getValue().getCanonicalRepresentation();\n+\n+              assert newEnvironmentVariableInGatewayContext.startsWith(\"zeebe-\");\n+              final int insertionPoint = \"zeebe-\".length();\n+\n+              final String newEnvironmentVariableInBrokerContext =\n+                  newEnvironmentVariableInGatewayContext.substring(0, insertionPoint) // \"zeebe-\"\n+                      + \"broker.\"\n+                      + newEnvironmentVariableInGatewayContext.substring(\n+                          insertionPoint); // \"gateway.*\"\n+\n+              MAPPING_BROKER.put(\n+                  oldEnvironmentVariable, new Replacement(newEnvironmentVariableInBrokerContext));\n+            });\n+    VALUE_CONVERTERS_BROKER.putAll(VALUE_CONVERTERS_GATEWAY);\n+\n+    // zeebe-broker.network\n+    MAPPING_BROKER.put(\"ZEEBE_HOST\", new Replacement(\"zeebe-broker.network.host\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_ADVERTISED_HOST\", new Replacement(\"zeebe-broker.network.advertisedHost\"));\n+    MAPPING_BROKER.put(\"ZEEBE_PORT_OFFSET\", new Replacement(\"zeebe-broker.network.portOffset\"));\n+\n+    // TODO check docker files and shell scripts and change those as well;\n+    //  if so remove hint in header of sample config files\n+    //  also test that it works when using the startup script\n+\n+  }\n+\n+  private final Scope scope;\n+\n+  public LegacyConfigurationSupport(Scope scope) {\n+    this.scope = scope;\n+  }\n+\n+  /**\n+   * This method checks whether the program was called with a toml configuration file. If so, it\n+   * prints out a warning.\n+   */\n+  public void checkForLegacyTomlConfigurationArgument(String[] args, String recommendedSetting) {\n+    if (args.length == 1 && args[0].endsWith(\".toml\")) {\n+      final String configFileArgument = args[0];\n+      Loggers.LEGACY_LOGGER.warn(\n+          \"Found command line argument \"\n+              + configFileArgument\n+              + \" which might be a TOML configuration file.\");\n+      Loggers.LEGACY_LOGGER.info(\n+          \"TOML configuration files are no longer supported. Please specify a YAML configuration file\"\n+              + \"and set it via environment variable \\\"spring.config.additional-location\\\" (e.g. \"\n+              + \"\\\"export spring.config.additional-location='file:./config/\"\n+              + recommendedSetting\n+              + \"'\\\").\");\n+      Loggers.LEGACY_LOGGER.info(\n+          \"The ./config/ folder contains a configuration file template. Alternatively, you can also use environment variables.\");\n+    }\n+  }\n+\n+  /**\n+   * This method checks for legacy environment variables. If it finds an old environment variable\n+   * which is set, it looks whether the new counterpart is set. If the new counterpart is set, it\n+   * does nothing. If it is not set, it sets a system setting under the new key that has the same\n+   * value as is associated with the old environment variable. This effectively makes the old\n+   * environment variable value visible under the new environment variable. It also prints out a\n+   * warning to the log.\n+   */\n+  public void checkForLegacyEnvironmentVariables() {\n+\n+    final Map<String, Replacement> mappingTable;\n+    final Map<String, Function<String, String>> valueConverters;", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkyNTA5Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386925093", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:24:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NjY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NjgzNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385786837", "bodyText": "I guess we meant to use VALUE_CONVERTERS_BROKER here?", "author": "npepinpe", "createdAt": "2020-02-28T16:16:40Z", "path": "legacy/toml-config/src/main/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupport.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.util.Loggers;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+public class LegacyConfigurationSupport {\n+  private static final Map<String, Replacement> MAPPING_GATEWAY = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_GATEWAY =\n+      new HashMap<>();\n+  private static final Map<String, Replacement> MAPPING_BROKER = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_BROKER =\n+      new HashMap<>();\n+  private static final int DEFAULT_CONTACT_POINT_PORT = 26502;\n+\n+  static { // static initialization for mapping tables\n+\n+    // zeebe-gateway.network\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_HOST\", new Replacement(\"zeebe-gateway.network.host\"));\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_PORT\", new Replacement(\"zeebe-gateway.network.port\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_KEEP_ALIVE_INTERVAL\",\n+        new Replacement(\"zeebe-gateway.network.minKeepAliveInterval\"));\n+\n+    // zeebe-gateway.cluster\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_REQUEST_TIMEOUT\", new Replacement(\"zeebe-gateway.cluster.requestTimeout\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\", new Replacement(\"zeebe-gateway.cluster.contactPoint\"));\n+    VALUE_CONVERTERS_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\",\n+        value -> value.contains(\":\") ? value : value + \":\" + DEFAULT_CONTACT_POINT_PORT);\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_NAME\", new Replacement(\"zeebe-gateway.cluster.clusterName\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_MEMBER_ID\", new Replacement(\"zeebe-gateway.cluster.memberId\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_HOST\", new Replacement(\"zeebe-gateway.cluster.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_PORT\", new Replacement(\"zeebe-gateway.cluster.port\"));\n+\n+    // zeebe-gateway.monitoring\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_ENABLED\", new Replacement(\"zeebe-gateway.monitoring.enadbled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_HOST\", new Replacement(\"zeebe-gateway.monitoring.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_PORT\", new Replacement(\"zeebe-gateway.monitoring.port\"));\n+\n+    // zeebe-gateway.threads\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MANAGEMENT_THREADS\",\n+        new Replacement(\"zeebe-gateway.threads.managementThreads\"));\n+\n+    // zeebe-gateway.security\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_SECURITY_ENABLED\", new Replacement(\"zeebe-gateway.security.enabled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CERTIFICATE_PATH\",\n+        new Replacement(\"zeebe-gateway.security.certificateChainPath\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_PRIVATE_KEY_PATH\", new Replacement(\"zeebe-gateway.security.privateKeyPath\"));\n+\n+    // zeebe-broker ----------------------------------------\n+    MAPPING_BROKER.put(\"ZEEBE_STEP_TIMEOUT\", new Replacement(\"zeebe-broker.stepTimeout\"));\n+\n+    // zeebe-broker.cluster\n+    MAPPING_BROKER.put(\"ZEEBE_NODE_ID\", new Replacement(\"zeebe-broker.cluster.nodeId\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_CONTACT_POINTS\", new Replacement(\"zeebe-broker.cluster.initialContactPoints\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_PARTITIONS_COUNT\", new Replacement(\"zeebe-broker.cluster.partitionsCount\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_REPLICATION_FACTOR\", new Replacement(\"zeebe-broker.cluster.replicationFactor\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_SIZE\", new Replacement(\"zeebe-broker.cluster.clusterSize\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_NAME\", new Replacement(\"zeebe-broker.cluster.clusterName\"));\n+\n+    // zeebe-broker.data\n+    MAPPING_BROKER.put(\"ZEEBE_DIRECTORIES\", new Replacement(\"zeebe-broker.data.directories\"));\n+\n+    // zeebe-broker.gateway\n+    MAPPING_BROKER.put(\"ZEEBE_EMBED_GATEWAY\", new Replacement(\"zeebe-broker.gateway.enable\"));\n+\n+    /* this essentially copies all entries from the gateway mapping table, but modifies\n+     * the new environment variables from \"zeebe-gateway.*\" to \"zeebe-broker.gateway.*\"\n+     */\n+    MAPPING_GATEWAY\n+        .entrySet()\n+        .forEach(\n+            entry -> {\n+              final String oldEnvironmentVariable = entry.getKey();\n+              final String newEnvironmentVariableInGatewayContext =\n+                  entry.getValue().getCanonicalRepresentation();\n+\n+              assert newEnvironmentVariableInGatewayContext.startsWith(\"zeebe-\");\n+              final int insertionPoint = \"zeebe-\".length();\n+\n+              final String newEnvironmentVariableInBrokerContext =\n+                  newEnvironmentVariableInGatewayContext.substring(0, insertionPoint) // \"zeebe-\"\n+                      + \"broker.\"\n+                      + newEnvironmentVariableInGatewayContext.substring(\n+                          insertionPoint); // \"gateway.*\"\n+\n+              MAPPING_BROKER.put(\n+                  oldEnvironmentVariable, new Replacement(newEnvironmentVariableInBrokerContext));\n+            });\n+    VALUE_CONVERTERS_BROKER.putAll(VALUE_CONVERTERS_GATEWAY);\n+\n+    // zeebe-broker.network\n+    MAPPING_BROKER.put(\"ZEEBE_HOST\", new Replacement(\"zeebe-broker.network.host\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_ADVERTISED_HOST\", new Replacement(\"zeebe-broker.network.advertisedHost\"));\n+    MAPPING_BROKER.put(\"ZEEBE_PORT_OFFSET\", new Replacement(\"zeebe-broker.network.portOffset\"));\n+\n+    // TODO check docker files and shell scripts and change those as well;\n+    //  if so remove hint in header of sample config files\n+    //  also test that it works when using the startup script\n+\n+  }\n+\n+  private final Scope scope;\n+\n+  public LegacyConfigurationSupport(Scope scope) {\n+    this.scope = scope;\n+  }\n+\n+  /**\n+   * This method checks whether the program was called with a toml configuration file. If so, it\n+   * prints out a warning.\n+   */\n+  public void checkForLegacyTomlConfigurationArgument(String[] args, String recommendedSetting) {\n+    if (args.length == 1 && args[0].endsWith(\".toml\")) {\n+      final String configFileArgument = args[0];\n+      Loggers.LEGACY_LOGGER.warn(\n+          \"Found command line argument \"\n+              + configFileArgument\n+              + \" which might be a TOML configuration file.\");\n+      Loggers.LEGACY_LOGGER.info(\n+          \"TOML configuration files are no longer supported. Please specify a YAML configuration file\"\n+              + \"and set it via environment variable \\\"spring.config.additional-location\\\" (e.g. \"\n+              + \"\\\"export spring.config.additional-location='file:./config/\"\n+              + recommendedSetting\n+              + \"'\\\").\");\n+      Loggers.LEGACY_LOGGER.info(\n+          \"The ./config/ folder contains a configuration file template. Alternatively, you can also use environment variables.\");\n+    }\n+  }\n+\n+  /**\n+   * This method checks for legacy environment variables. If it finds an old environment variable\n+   * which is set, it looks whether the new counterpart is set. If the new counterpart is set, it\n+   * does nothing. If it is not set, it sets a system setting under the new key that has the same\n+   * value as is associated with the old environment variable. This effectively makes the old\n+   * environment variable value visible under the new environment variable. It also prints out a\n+   * warning to the log.\n+   */\n+  public void checkForLegacyEnvironmentVariables() {\n+\n+    final Map<String, Replacement> mappingTable;\n+    final Map<String, Function<String, String>> valueConverters;\n+\n+    switch (scope) {\n+      case GATEWAY:\n+        mappingTable = MAPPING_GATEWAY;\n+        valueConverters = VALUE_CONVERTERS_GATEWAY;\n+        break;\n+\n+      case BROKER:\n+        mappingTable = MAPPING_BROKER;\n+        valueConverters = Collections.emptyMap();", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkyNTIzMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386925231", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:25:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NjgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4ODcyMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385788721", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                MAPPING_GATEWAY\n          \n          \n            \n                    .entrySet()\n          \n          \n            \n                    .forEach(\n          \n          \n            \n                MAPPING_GATEWAY\n          \n          \n            \n                    .forEach(\n          \n      \n    \n    \n  \n\nI think it can be called directly now", "author": "npepinpe", "createdAt": "2020-02-28T16:20:10Z", "path": "legacy/toml-config/src/main/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupport.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.util.Loggers;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+public class LegacyConfigurationSupport {\n+  private static final Map<String, Replacement> MAPPING_GATEWAY = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_GATEWAY =\n+      new HashMap<>();\n+  private static final Map<String, Replacement> MAPPING_BROKER = new HashMap<>();\n+  private static final Map<String, Function<String, String>> VALUE_CONVERTERS_BROKER =\n+      new HashMap<>();\n+  private static final int DEFAULT_CONTACT_POINT_PORT = 26502;\n+\n+  static { // static initialization for mapping tables\n+\n+    // zeebe-gateway.network\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_HOST\", new Replacement(\"zeebe-gateway.network.host\"));\n+    MAPPING_GATEWAY.put(\"ZEEBE_GATEWAY_PORT\", new Replacement(\"zeebe-gateway.network.port\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_KEEP_ALIVE_INTERVAL\",\n+        new Replacement(\"zeebe-gateway.network.minKeepAliveInterval\"));\n+\n+    // zeebe-gateway.cluster\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_REQUEST_TIMEOUT\", new Replacement(\"zeebe-gateway.cluster.requestTimeout\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\", new Replacement(\"zeebe-gateway.cluster.contactPoint\"));\n+    VALUE_CONVERTERS_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CONTACT_POINT\",\n+        value -> value.contains(\":\") ? value : value + \":\" + DEFAULT_CONTACT_POINT_PORT);\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_NAME\", new Replacement(\"zeebe-gateway.cluster.clusterName\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_MEMBER_ID\", new Replacement(\"zeebe-gateway.cluster.memberId\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_HOST\", new Replacement(\"zeebe-gateway.cluster.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CLUSTER_PORT\", new Replacement(\"zeebe-gateway.cluster.port\"));\n+\n+    // zeebe-gateway.monitoring\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_ENABLED\", new Replacement(\"zeebe-gateway.monitoring.enadbled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_HOST\", new Replacement(\"zeebe-gateway.monitoring.host\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MONITORING_PORT\", new Replacement(\"zeebe-gateway.monitoring.port\"));\n+\n+    // zeebe-gateway.threads\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_MANAGEMENT_THREADS\",\n+        new Replacement(\"zeebe-gateway.threads.managementThreads\"));\n+\n+    // zeebe-gateway.security\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_SECURITY_ENABLED\", new Replacement(\"zeebe-gateway.security.enabled\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_CERTIFICATE_PATH\",\n+        new Replacement(\"zeebe-gateway.security.certificateChainPath\"));\n+    MAPPING_GATEWAY.put(\n+        \"ZEEBE_GATEWAY_PRIVATE_KEY_PATH\", new Replacement(\"zeebe-gateway.security.privateKeyPath\"));\n+\n+    // zeebe-broker ----------------------------------------\n+    MAPPING_BROKER.put(\"ZEEBE_STEP_TIMEOUT\", new Replacement(\"zeebe-broker.stepTimeout\"));\n+\n+    // zeebe-broker.cluster\n+    MAPPING_BROKER.put(\"ZEEBE_NODE_ID\", new Replacement(\"zeebe-broker.cluster.nodeId\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_CONTACT_POINTS\", new Replacement(\"zeebe-broker.cluster.initialContactPoints\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_PARTITIONS_COUNT\", new Replacement(\"zeebe-broker.cluster.partitionsCount\"));\n+    MAPPING_BROKER.put(\n+        \"ZEEBE_REPLICATION_FACTOR\", new Replacement(\"zeebe-broker.cluster.replicationFactor\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_SIZE\", new Replacement(\"zeebe-broker.cluster.clusterSize\"));\n+    MAPPING_BROKER.put(\"ZEEBE_CLUSTER_NAME\", new Replacement(\"zeebe-broker.cluster.clusterName\"));\n+\n+    // zeebe-broker.data\n+    MAPPING_BROKER.put(\"ZEEBE_DIRECTORIES\", new Replacement(\"zeebe-broker.data.directories\"));\n+\n+    // zeebe-broker.gateway\n+    MAPPING_BROKER.put(\"ZEEBE_EMBED_GATEWAY\", new Replacement(\"zeebe-broker.gateway.enable\"));\n+\n+    /* this essentially copies all entries from the gateway mapping table, but modifies\n+     * the new environment variables from \"zeebe-gateway.*\" to \"zeebe-broker.gateway.*\"\n+     */\n+    MAPPING_GATEWAY\n+        .entrySet()\n+        .forEach(", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkyNjcyOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386926729", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4ODcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4OTgzNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385789834", "bodyText": "Should we have a test that the environment variables are properly mapped?", "author": "npepinpe", "createdAt": "2020-02-28T16:22:13Z", "path": "legacy/toml-config/src/test/java/io/zeebe/legacy/tomlconfig/LegacyConfigurationSupportTest.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.legacy.tomlconfig;\n+\n+import io.zeebe.legacy.tomlconfig.LegacyConfigurationSupport.Replacement;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import org.assertj.core.api.Assertions;\n+import org.junit.Test;\n+\n+public class LegacyConfigurationSupportTest {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3MTU3Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386971573", "bodyText": "I would love to. I just don't know how.\nI could write a test that verifies the map entries. This would catch my own typos, but not whether I misunderstood something completely.\nI would love to write an end-to-end test, but I don't know how to manipulate environment variables in a test - other than using Docker or something like this. Even if I managed to manipulate the environment settings, I wouldn't know how to observe whether the right configuration was set.\nIf there is something obvious I missed, please let me know.\nOther then that I tested it manually - not it with all environment variables but with a few.", "author": "pihme", "createdAt": "2020-03-03T11:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4OTgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA3NjU1Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r387076553", "bodyText": "Hm, you're right, the only thing I can come up with is a TestContainers setup - with actuators enabled we could get the config out, but I guess this is not possible yet. Let's leave it as is then \ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-03-03T14:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4OTgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MDc0Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385790742", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class TestConfigurationFactory {\n          \n          \n            \n            public final class TestConfigurationFactory {", "author": "npepinpe", "createdAt": "2020-02-28T16:23:44Z", "path": "test-util/src/main/java/io/zeebe/test/util/TestConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.test.util;\n+\n+import io.zeebe.util.Environment;\n+import io.zeebe.util.Loggers;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.config.YamlPropertiesFactoryBean;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.bind.BindResult;\n+import org.springframework.boot.context.properties.bind.Binder;\n+import org.springframework.boot.context.properties.source.ConfigurationPropertySource;\n+import org.springframework.boot.context.properties.source.ConfigurationPropertySources;\n+import org.springframework.core.env.MapPropertySource;\n+import org.springframework.core.env.MutablePropertySources;\n+import org.springframework.core.env.PropertiesPropertySource;\n+import org.springframework.core.io.ClassPathResource;\n+import org.springframework.core.io.InputStreamResource;\n+import org.springframework.core.io.Resource;\n+\n+/**\n+ * This class mimics the Spring Boot configuration mechanism. It reads configuration from a YAML\n+ * file or input stream and then overlays a map of environment settings, that can be passed in as\n+ * argument. It does not consider the actual system environment settings. Instead, the test can\n+ * specify the environment settings it wants to test through an {@code Environment} object. <br>\n+ * There are several caveats though:\n+ *\n+ * <ul>\n+ *   <li>If using the file based interface, the file must be available on the classpath\n+ *   <li>It is assumed that the created types have public no arg constructors\n+ *   <li>This implementation does not support relaxed binding (it was tried during development, but\n+ *       in the end the rules for relaxed binding didn't match up with the ones used by Spring Boot\n+ *       proper. This lead to confusion and eventually the relaxed naming support was dropped)\n+ *   <li>This class does not support the full feature set of Spring Boot configuration. Among others\n+ *       it does not support profiles or overlaying configuration from multiple files\n+ * </ul>\n+ */\n+public class TestConfigurationFactory {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkyODIxNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386928216", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MDc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MDg2NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385790865", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  final Environment environment, String prefix, final String fileName, final Class<T> type) {\n          \n          \n            \n                  final Environment environment, final String prefix, final String fileName, final Class<T> type) {", "author": "npepinpe", "createdAt": "2020-02-28T16:23:58Z", "path": "test-util/src/main/java/io/zeebe/test/util/TestConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.test.util;\n+\n+import io.zeebe.util.Environment;\n+import io.zeebe.util.Loggers;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.config.YamlPropertiesFactoryBean;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.bind.BindResult;\n+import org.springframework.boot.context.properties.bind.Binder;\n+import org.springframework.boot.context.properties.source.ConfigurationPropertySource;\n+import org.springframework.boot.context.properties.source.ConfigurationPropertySources;\n+import org.springframework.core.env.MapPropertySource;\n+import org.springframework.core.env.MutablePropertySources;\n+import org.springframework.core.env.PropertiesPropertySource;\n+import org.springframework.core.io.ClassPathResource;\n+import org.springframework.core.io.InputStreamResource;\n+import org.springframework.core.io.Resource;\n+\n+/**\n+ * This class mimics the Spring Boot configuration mechanism. It reads configuration from a YAML\n+ * file or input stream and then overlays a map of environment settings, that can be passed in as\n+ * argument. It does not consider the actual system environment settings. Instead, the test can\n+ * specify the environment settings it wants to test through an {@code Environment} object. <br>\n+ * There are several caveats though:\n+ *\n+ * <ul>\n+ *   <li>If using the file based interface, the file must be available on the classpath\n+ *   <li>It is assumed that the created types have public no arg constructors\n+ *   <li>This implementation does not support relaxed binding (it was tried during development, but\n+ *       in the end the rules for relaxed binding didn't match up with the ones used by Spring Boot\n+ *       proper. This lead to confusion and eventually the relaxed naming support was dropped)\n+ *   <li>This class does not support the full feature set of Spring Boot configuration. Among others\n+ *       it does not support profiles or overlaying configuration from multiple files\n+ * </ul>\n+ */\n+public class TestConfigurationFactory {\n+\n+  public static final Logger LOG = Loggers.CONFIG_LOGGER;\n+\n+  /**\n+   * Reads the configuration from the input stream and binds it to an object\n+   *\n+   * @param configurationInputStream input stream of the configuration file; must not be {@code\n+   *     null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}; must have a {@link ConfigurationProperties}\n+   *     annotation with a {@code prefix} attribute\n+   */\n+  public <T> T create(final InputStream configurationInputStream, final Class<T> type) {\n+    final ConfigurationProperties annotation = type.getAnnotation(ConfigurationProperties.class);\n+    final String prefix;\n+    if (annotation != null && annotation.prefix() != null) {\n+      prefix = annotation.prefix();\n+    } else {\n+      throw new IllegalArgumentException(\n+          \"Unable to identify prefix for type\" + type.getSimpleName());\n+    }\n+    return create(null, prefix, configurationInputStream, type);\n+  }\n+\n+  /**\n+   * Reads the configuration file from the class path and binds it to an object\n+   *\n+   * @param environment environment to simulate environment variables that can be overlayed; may be\n+   *     {@code} null\n+   * @param prefix the top level element in the configuration that should be mapped to the object\n+   * @param fileName filename of the configuration file; must be available on the classpath; must\n+   *     not be {@code null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}\n+   */\n+  public <T> T create(\n+      final Environment environment, String prefix, final String fileName, final Class<T> type) {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkyODE0MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386928140", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MDg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MTQ1Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385791453", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  String prefix,\n          \n          \n            \n                  final String prefix,", "author": "npepinpe", "createdAt": "2020-02-28T16:25:05Z", "path": "test-util/src/main/java/io/zeebe/test/util/TestConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.test.util;\n+\n+import io.zeebe.util.Environment;\n+import io.zeebe.util.Loggers;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.config.YamlPropertiesFactoryBean;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.bind.BindResult;\n+import org.springframework.boot.context.properties.bind.Binder;\n+import org.springframework.boot.context.properties.source.ConfigurationPropertySource;\n+import org.springframework.boot.context.properties.source.ConfigurationPropertySources;\n+import org.springframework.core.env.MapPropertySource;\n+import org.springframework.core.env.MutablePropertySources;\n+import org.springframework.core.env.PropertiesPropertySource;\n+import org.springframework.core.io.ClassPathResource;\n+import org.springframework.core.io.InputStreamResource;\n+import org.springframework.core.io.Resource;\n+\n+/**\n+ * This class mimics the Spring Boot configuration mechanism. It reads configuration from a YAML\n+ * file or input stream and then overlays a map of environment settings, that can be passed in as\n+ * argument. It does not consider the actual system environment settings. Instead, the test can\n+ * specify the environment settings it wants to test through an {@code Environment} object. <br>\n+ * There are several caveats though:\n+ *\n+ * <ul>\n+ *   <li>If using the file based interface, the file must be available on the classpath\n+ *   <li>It is assumed that the created types have public no arg constructors\n+ *   <li>This implementation does not support relaxed binding (it was tried during development, but\n+ *       in the end the rules for relaxed binding didn't match up with the ones used by Spring Boot\n+ *       proper. This lead to confusion and eventually the relaxed naming support was dropped)\n+ *   <li>This class does not support the full feature set of Spring Boot configuration. Among others\n+ *       it does not support profiles or overlaying configuration from multiple files\n+ * </ul>\n+ */\n+public class TestConfigurationFactory {\n+\n+  public static final Logger LOG = Loggers.CONFIG_LOGGER;\n+\n+  /**\n+   * Reads the configuration from the input stream and binds it to an object\n+   *\n+   * @param configurationInputStream input stream of the configuration file; must not be {@code\n+   *     null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}; must have a {@link ConfigurationProperties}\n+   *     annotation with a {@code prefix} attribute\n+   */\n+  public <T> T create(final InputStream configurationInputStream, final Class<T> type) {\n+    final ConfigurationProperties annotation = type.getAnnotation(ConfigurationProperties.class);\n+    final String prefix;\n+    if (annotation != null && annotation.prefix() != null) {\n+      prefix = annotation.prefix();\n+    } else {\n+      throw new IllegalArgumentException(\n+          \"Unable to identify prefix for type\" + type.getSimpleName());\n+    }\n+    return create(null, prefix, configurationInputStream, type);\n+  }\n+\n+  /**\n+   * Reads the configuration file from the class path and binds it to an object\n+   *\n+   * @param environment environment to simulate environment variables that can be overlayed; may be\n+   *     {@code} null\n+   * @param prefix the top level element in the configuration that should be mapped to the object\n+   * @param fileName filename of the configuration file; must be available on the classpath; must\n+   *     not be {@code null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}\n+   */\n+  public <T> T create(\n+      final Environment environment, String prefix, final String fileName, final Class<T> type) {\n+    LOG.debug(\"Reading configuration for {} from file {}\", type, fileName);\n+\n+    try (InputStream inputStream = new ClassPathResource(fileName).getInputStream()) {\n+\n+      return create(environment, prefix, inputStream, type);\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(e);\n+    }\n+  }\n+\n+  /**\n+   * Reads the configuration from the input stream and binds it to an object\n+   *\n+   * @param environment environment to simulate environment variables that can be overlayed; may be\n+   *     {@code} null\n+   * @param prefix the top level element in the configuration that should be mapped to the object\n+   * @param inputStream input stream of the configuration file; must not be {@code null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}\n+   */\n+  public <T> T create(\n+      final Environment environment,\n+      String prefix,", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkyODQyNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386928424", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MTQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MTU1Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385791553", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Properties loadYamlProperties(InputStream inputStream) {\n          \n          \n            \n              private Properties loadYamlProperties(final InputStream inputStream) {", "author": "npepinpe", "createdAt": "2020-02-28T16:25:18Z", "path": "test-util/src/main/java/io/zeebe/test/util/TestConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.test.util;\n+\n+import io.zeebe.util.Environment;\n+import io.zeebe.util.Loggers;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.config.YamlPropertiesFactoryBean;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.bind.BindResult;\n+import org.springframework.boot.context.properties.bind.Binder;\n+import org.springframework.boot.context.properties.source.ConfigurationPropertySource;\n+import org.springframework.boot.context.properties.source.ConfigurationPropertySources;\n+import org.springframework.core.env.MapPropertySource;\n+import org.springframework.core.env.MutablePropertySources;\n+import org.springframework.core.env.PropertiesPropertySource;\n+import org.springframework.core.io.ClassPathResource;\n+import org.springframework.core.io.InputStreamResource;\n+import org.springframework.core.io.Resource;\n+\n+/**\n+ * This class mimics the Spring Boot configuration mechanism. It reads configuration from a YAML\n+ * file or input stream and then overlays a map of environment settings, that can be passed in as\n+ * argument. It does not consider the actual system environment settings. Instead, the test can\n+ * specify the environment settings it wants to test through an {@code Environment} object. <br>\n+ * There are several caveats though:\n+ *\n+ * <ul>\n+ *   <li>If using the file based interface, the file must be available on the classpath\n+ *   <li>It is assumed that the created types have public no arg constructors\n+ *   <li>This implementation does not support relaxed binding (it was tried during development, but\n+ *       in the end the rules for relaxed binding didn't match up with the ones used by Spring Boot\n+ *       proper. This lead to confusion and eventually the relaxed naming support was dropped)\n+ *   <li>This class does not support the full feature set of Spring Boot configuration. Among others\n+ *       it does not support profiles or overlaying configuration from multiple files\n+ * </ul>\n+ */\n+public class TestConfigurationFactory {\n+\n+  public static final Logger LOG = Loggers.CONFIG_LOGGER;\n+\n+  /**\n+   * Reads the configuration from the input stream and binds it to an object\n+   *\n+   * @param configurationInputStream input stream of the configuration file; must not be {@code\n+   *     null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}; must have a {@link ConfigurationProperties}\n+   *     annotation with a {@code prefix} attribute\n+   */\n+  public <T> T create(final InputStream configurationInputStream, final Class<T> type) {\n+    final ConfigurationProperties annotation = type.getAnnotation(ConfigurationProperties.class);\n+    final String prefix;\n+    if (annotation != null && annotation.prefix() != null) {\n+      prefix = annotation.prefix();\n+    } else {\n+      throw new IllegalArgumentException(\n+          \"Unable to identify prefix for type\" + type.getSimpleName());\n+    }\n+    return create(null, prefix, configurationInputStream, type);\n+  }\n+\n+  /**\n+   * Reads the configuration file from the class path and binds it to an object\n+   *\n+   * @param environment environment to simulate environment variables that can be overlayed; may be\n+   *     {@code} null\n+   * @param prefix the top level element in the configuration that should be mapped to the object\n+   * @param fileName filename of the configuration file; must be available on the classpath; must\n+   *     not be {@code null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}\n+   */\n+  public <T> T create(\n+      final Environment environment, String prefix, final String fileName, final Class<T> type) {\n+    LOG.debug(\"Reading configuration for {} from file {}\", type, fileName);\n+\n+    try (InputStream inputStream = new ClassPathResource(fileName).getInputStream()) {\n+\n+      return create(environment, prefix, inputStream, type);\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(e);\n+    }\n+  }\n+\n+  /**\n+   * Reads the configuration from the input stream and binds it to an object\n+   *\n+   * @param environment environment to simulate environment variables that can be overlayed; may be\n+   *     {@code} null\n+   * @param prefix the top level element in the configuration that should be mapped to the object\n+   * @param inputStream input stream of the configuration file; must not be {@code null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}\n+   */\n+  public <T> T create(\n+      final Environment environment,\n+      String prefix,\n+      final InputStream inputStream,\n+      final Class<T> type) {\n+    LOG.debug(\"Reading configuration for {} from input stream\", type);\n+\n+    final Map<String, Object> propertiesFromEnvironment = convertEnvironmentIntoMap(environment);\n+    final Properties propertiesFromFile = loadYamlProperties(inputStream);\n+\n+    final MutablePropertySources propertySources = new MutablePropertySources();\n+\n+    propertySources.addLast(\n+        new MapPropertySource(\"environment properties strict\", propertiesFromEnvironment));\n+    propertySources.addLast(\n+        new PropertiesPropertySource(\"properties from file\", propertiesFromFile));\n+\n+    final Constructor<T> constructor;\n+    final T target;\n+    try {\n+      constructor = type.getConstructor();\n+      target = constructor.newInstance();\n+    } catch (NoSuchMethodException\n+        | InstantiationException\n+        | IllegalAccessException\n+        | InvocationTargetException e) {\n+      throw new IllegalStateException(e);\n+    }\n+\n+    final Iterable<ConfigurationPropertySource> configPropertySource =\n+        ConfigurationPropertySources.from(propertySources);\n+\n+    final BindResult<T> bindResult = new Binder(configPropertySource).bind(prefix, type);\n+\n+    if (!bindResult.isBound()) {\n+      LOG.warn(\n+          \"No binding result parsing the configuration. This is normal if the configuration is empty.\"\n+              + \" Otherwise it is a configuration or programming error.\");\n+      return target;\n+    } else {\n+      return bindResult.get();\n+    }\n+  }\n+\n+  private Properties loadYamlProperties(InputStream inputStream) {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkzNjY2Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386936662", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:45:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MTU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MTY0OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385791648", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Map<String, Object> convertEnvironmentIntoMap(Environment environment) {\n          \n          \n            \n              private Map<String, Object> convertEnvironmentIntoMap(final Environment environment) {", "author": "npepinpe", "createdAt": "2020-02-28T16:25:28Z", "path": "test-util/src/main/java/io/zeebe/test/util/TestConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.test.util;\n+\n+import io.zeebe.util.Environment;\n+import io.zeebe.util.Loggers;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.config.YamlPropertiesFactoryBean;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.bind.BindResult;\n+import org.springframework.boot.context.properties.bind.Binder;\n+import org.springframework.boot.context.properties.source.ConfigurationPropertySource;\n+import org.springframework.boot.context.properties.source.ConfigurationPropertySources;\n+import org.springframework.core.env.MapPropertySource;\n+import org.springframework.core.env.MutablePropertySources;\n+import org.springframework.core.env.PropertiesPropertySource;\n+import org.springframework.core.io.ClassPathResource;\n+import org.springframework.core.io.InputStreamResource;\n+import org.springframework.core.io.Resource;\n+\n+/**\n+ * This class mimics the Spring Boot configuration mechanism. It reads configuration from a YAML\n+ * file or input stream and then overlays a map of environment settings, that can be passed in as\n+ * argument. It does not consider the actual system environment settings. Instead, the test can\n+ * specify the environment settings it wants to test through an {@code Environment} object. <br>\n+ * There are several caveats though:\n+ *\n+ * <ul>\n+ *   <li>If using the file based interface, the file must be available on the classpath\n+ *   <li>It is assumed that the created types have public no arg constructors\n+ *   <li>This implementation does not support relaxed binding (it was tried during development, but\n+ *       in the end the rules for relaxed binding didn't match up with the ones used by Spring Boot\n+ *       proper. This lead to confusion and eventually the relaxed naming support was dropped)\n+ *   <li>This class does not support the full feature set of Spring Boot configuration. Among others\n+ *       it does not support profiles or overlaying configuration from multiple files\n+ * </ul>\n+ */\n+public class TestConfigurationFactory {\n+\n+  public static final Logger LOG = Loggers.CONFIG_LOGGER;\n+\n+  /**\n+   * Reads the configuration from the input stream and binds it to an object\n+   *\n+   * @param configurationInputStream input stream of the configuration file; must not be {@code\n+   *     null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}; must have a {@link ConfigurationProperties}\n+   *     annotation with a {@code prefix} attribute\n+   */\n+  public <T> T create(final InputStream configurationInputStream, final Class<T> type) {\n+    final ConfigurationProperties annotation = type.getAnnotation(ConfigurationProperties.class);\n+    final String prefix;\n+    if (annotation != null && annotation.prefix() != null) {\n+      prefix = annotation.prefix();\n+    } else {\n+      throw new IllegalArgumentException(\n+          \"Unable to identify prefix for type\" + type.getSimpleName());\n+    }\n+    return create(null, prefix, configurationInputStream, type);\n+  }\n+\n+  /**\n+   * Reads the configuration file from the class path and binds it to an object\n+   *\n+   * @param environment environment to simulate environment variables that can be overlayed; may be\n+   *     {@code} null\n+   * @param prefix the top level element in the configuration that should be mapped to the object\n+   * @param fileName filename of the configuration file; must be available on the classpath; must\n+   *     not be {@code null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}\n+   */\n+  public <T> T create(\n+      final Environment environment, String prefix, final String fileName, final Class<T> type) {\n+    LOG.debug(\"Reading configuration for {} from file {}\", type, fileName);\n+\n+    try (InputStream inputStream = new ClassPathResource(fileName).getInputStream()) {\n+\n+      return create(environment, prefix, inputStream, type);\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(e);\n+    }\n+  }\n+\n+  /**\n+   * Reads the configuration from the input stream and binds it to an object\n+   *\n+   * @param environment environment to simulate environment variables that can be overlayed; may be\n+   *     {@code} null\n+   * @param prefix the top level element in the configuration that should be mapped to the object\n+   * @param inputStream input stream of the configuration file; must not be {@code null}\n+   * @param type type of object to be created; it is assumed that this object has a public no arg\n+   *     constructor; must not be {@code null}\n+   */\n+  public <T> T create(\n+      final Environment environment,\n+      String prefix,\n+      final InputStream inputStream,\n+      final Class<T> type) {\n+    LOG.debug(\"Reading configuration for {} from input stream\", type);\n+\n+    final Map<String, Object> propertiesFromEnvironment = convertEnvironmentIntoMap(environment);\n+    final Properties propertiesFromFile = loadYamlProperties(inputStream);\n+\n+    final MutablePropertySources propertySources = new MutablePropertySources();\n+\n+    propertySources.addLast(\n+        new MapPropertySource(\"environment properties strict\", propertiesFromEnvironment));\n+    propertySources.addLast(\n+        new PropertiesPropertySource(\"properties from file\", propertiesFromFile));\n+\n+    final Constructor<T> constructor;\n+    final T target;\n+    try {\n+      constructor = type.getConstructor();\n+      target = constructor.newInstance();\n+    } catch (NoSuchMethodException\n+        | InstantiationException\n+        | IllegalAccessException\n+        | InvocationTargetException e) {\n+      throw new IllegalStateException(e);\n+    }\n+\n+    final Iterable<ConfigurationPropertySource> configPropertySource =\n+        ConfigurationPropertySources.from(propertySources);\n+\n+    final BindResult<T> bindResult = new Binder(configPropertySource).bind(prefix, type);\n+\n+    if (!bindResult.isBound()) {\n+      LOG.warn(\n+          \"No binding result parsing the configuration. This is normal if the configuration is empty.\"\n+              + \" Otherwise it is a configuration or programming error.\");\n+      return target;\n+    } else {\n+      return bindResult.get();\n+    }\n+  }\n+\n+  private Properties loadYamlProperties(InputStream inputStream) {\n+    final Resource resource = new InputStreamResource(inputStream);\n+    final YamlPropertiesFactoryBean factoryBean = new YamlPropertiesFactoryBean();\n+    factoryBean.setResources(resource);\n+    return factoryBean.getObject();\n+  }\n+\n+  private Map<String, Object> convertEnvironmentIntoMap(Environment environment) {", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkzNjc5NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386936795", "bodyText": "done", "author": "pihme", "createdAt": "2020-03-03T10:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MTY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MjQ5OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r385792499", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static final Function<List<String>, List<String>> LIST_SANITIZER =\n          \n          \n            \n              public static final UnaryOperator<List<String>> LIST_SANITIZER =\n          \n      \n    \n    \n  \n\nThat said, what is the advantage of declaring it like this versus declaring it as a static method?", "author": "npepinpe", "createdAt": "2020-02-28T16:26:57Z", "path": "util/src/main/java/io/zeebe/util/StringUtil.java", "diffHunk": "@@ -7,11 +7,28 @@\n  */\n package io.zeebe.util;\n \n+import static java.util.function.Predicate.not;\n+import static java.util.stream.Collectors.toList;\n+\n import java.nio.charset.Charset;\n import java.nio.charset.StandardCharsets;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.function.Function;\n \n public final class StringUtil {\n \n+  /** Helper functions that removes nulls and empty strings and trims all remaining strings */\n+  public static final Function<List<String>, List<String>> LIST_SANITIZER =", "originalCommit": "cebf83aef164da275826ce152f16f1940f7ec176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkzODc0Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3907#discussion_r386938742", "bodyText": "probably none", "author": "pihme", "createdAt": "2020-03-03T10:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MjQ5OQ=="}], "type": "inlineReview"}, {"oid": "6b3ffe86e3904c157946ccf2f59b263fdc22708c", "url": "https://github.com/camunda-cloud/zeebe/commit/6b3ffe86e3904c157946ccf2f59b263fdc22708c", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-03-03T10:53:27Z", "type": "forcePushed"}, {"oid": "49146ab5e6c61e8a1c57cbc1cf2561bd9587fd3b", "url": "https://github.com/camunda-cloud/zeebe/commit/49146ab5e6c61e8a1c57cbc1cf2561bd9587fd3b", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-03-03T12:01:02Z", "type": "forcePushed"}, {"oid": "de3b18c66bda97d1ffe8370aecdab22a92e3ea2d", "url": "https://github.com/camunda-cloud/zeebe/commit/de3b18c66bda97d1ffe8370aecdab22a92e3ea2d", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-03-03T12:16:54Z", "type": "forcePushed"}, {"oid": "6d03e6fa83c0eb16016f78b215f7d9c1bd3687f9", "url": "https://github.com/camunda-cloud/zeebe/commit/6d03e6fa83c0eb16016f78b215f7d9c1bd3687f9", "message": "chore(broker): Copy configuration classes to legacy package\n\nThese classes were copied so that later they may be used to migrate from the old configuration to the new configuration.", "committedDate": "2020-03-03T13:14:55Z", "type": "commit"}, {"oid": "658fa4eb268be6807a05f5427a2f7f99601955d1", "url": "https://github.com/camunda-cloud/zeebe/commit/658fa4eb268be6807a05f5427a2f7f99601955d1", "message": "feat(broker): Use Spring Boot Configuration to configure zeebe", "committedDate": "2020-03-03T13:15:51Z", "type": "commit"}, {"oid": "1a037909e3b1a00f0d7690b903f766a4031a1e1b", "url": "https://github.com/camunda-cloud/zeebe/commit/1a037909e3b1a00f0d7690b903f766a4031a1e1b", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-03-03T13:20:24Z", "type": "forcePushed"}, {"oid": "613404c66529067383be0162fde0037e3625fa79", "url": "https://github.com/camunda-cloud/zeebe/commit/613404c66529067383be0162fde0037e3625fa79", "message": "feat(broker): Replace TOML with YAML in tests", "committedDate": "2020-03-03T13:48:19Z", "type": "commit"}, {"oid": "8a9515f856881669e116a45fe6d74cc58dfd8c82", "url": "https://github.com/camunda-cloud/zeebe/commit/8a9515f856881669e116a45fe6d74cc58dfd8c82", "message": "feat(broker): Use Duration and DataSize instead of Strings in config", "committedDate": "2020-03-03T13:48:19Z", "type": "commit"}, {"oid": "5893780cd7f423e70f3c54f1b28d42e5fcaf6fbd", "url": "https://github.com/camunda-cloud/zeebe/commit/5893780cd7f423e70f3c54f1b28d42e5fcaf6fbd", "message": "feat(broker): Use map instead of list to configure exporters\n\nMaps have two advantages:\n- If several config files are used, each exporter will be added to the configuration (with lists they would be replaced)\n- Maps give each exporter an addressable key; this way it is possible to set environment variables that e.g. overwrite the password inside the elasticsearch exporter\n\nThis also means that the ID is no longer part of the ExporterCfg object. Instead the ID is given outside.\n\nThe ID is still part of the ExporterDescriptor, though, and corresponds to the key under wich the exporter was added to the BrokerCfg", "committedDate": "2020-03-03T13:48:19Z", "type": "commit"}, {"oid": "5becb045a1214ce092d78b40c272b063f6cd92ef", "url": "https://github.com/camunda-cloud/zeebe/commit/5becb045a1214ce092d78b40c272b063f6cd92ef", "message": "chore(util): Move legacy classes into dedicated module\n\nThis module will live as long as we need to be backwards compatible with the old configuration mechanism and old environment variables. After that, the module can be removed.", "committedDate": "2020-03-03T13:48:20Z", "type": "commit"}, {"oid": "8a223c887c5a7516b070d00a8afcd81b55ee1e42", "url": "https://github.com/camunda-cloud/zeebe/commit/8a223c887c5a7516b070d00a8afcd81b55ee1e42", "message": "feat(broker): Map old env vars to new ones and warn user", "committedDate": "2020-03-03T13:48:21Z", "type": "commit"}, {"oid": "1eeef5f5153c718b16c2bfc7a197bd7e136f536c", "url": "https://github.com/camunda-cloud/zeebe/commit/1eeef5f5153c718b16c2bfc7a197bd7e136f536c", "message": "chore(broker): Use config in dev mode too", "committedDate": "2020-03-03T13:48:21Z", "type": "forcePushed"}, {"oid": "591a819230f3e6feb799cbc6fa1b120db4e3adac", "url": "https://github.com/camunda-cloud/zeebe/commit/591a819230f3e6feb799cbc6fa1b120db4e3adac", "message": "chore(broker): Use config in dev mode too", "committedDate": "2020-03-03T14:00:36Z", "type": "commit"}, {"oid": "d1a4e27113751ec0b4eb1b523a4c3cf40508ccea", "url": "https://github.com/camunda-cloud/zeebe/commit/d1a4e27113751ec0b4eb1b523a4c3cf40508ccea", "message": "chore(broker): Change top level config from zeebe-broker to zeebe.broker; ditto for gateway\n\nThis changes the top level configuration element for\n\n- the broker from \"zeebe-broker\" to \"zeebe.broker\"\n- the gateway from \"zeebe-gateway\" to \"zeebe.gateway\"\n\nCorrespondingly, environment variables change for\n- the broker from \"ZEEBEBROKER_*\" to \"ZEEBE_BROKER_*\"\n- the gateway from \"ZEEBEGATEWAY_*\" to \"ZEEBE_GATEWAY_*\"", "committedDate": "2020-03-03T14:00:36Z", "type": "commit"}, {"oid": "d1a4e27113751ec0b4eb1b523a4c3cf40508ccea", "url": "https://github.com/camunda-cloud/zeebe/commit/d1a4e27113751ec0b4eb1b523a4c3cf40508ccea", "message": "chore(broker): Change top level config from zeebe-broker to zeebe.broker; ditto for gateway\n\nThis changes the top level configuration element for\n\n- the broker from \"zeebe-broker\" to \"zeebe.broker\"\n- the gateway from \"zeebe-gateway\" to \"zeebe.gateway\"\n\nCorrespondingly, environment variables change for\n- the broker from \"ZEEBEBROKER_*\" to \"ZEEBE_BROKER_*\"\n- the gateway from \"ZEEBEGATEWAY_*\" to \"ZEEBE_GATEWAY_*\"", "committedDate": "2020-03-03T14:00:36Z", "type": "forcePushed"}]}