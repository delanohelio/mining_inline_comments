{"pr_number": 5269, "pr_title": "Fix disk monitor notification on startup and during failover", "pr_createdAt": "2020-09-01T07:20:05Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5269", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NjM1Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481886353", "bodyText": "Why this change? Why no longer do it immediately?", "author": "pihme", "createdAt": "2020-09-02T08:31:58Z", "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -56,11 +57,18 @@ private void checkDiskUsageAndNotifyListeners() {\n   }\n \n   public void addDiskUsageListener(final DiskSpaceUsageListener listener) {\n-    diskSpaceUsageListeners.add(listener);\n+    actor.call(\n+        () -> {\n+          diskSpaceUsageListeners.add(listener);\n+          // Listeners always assumes diskspace is available on start. So notify them if it is not.\n+          if (!currentDiskAvailableStatus) {\n+            listener.onDiskSpaceNotAvailable();\n+          }\n+        });\n   }\n \n   public void removeDiskUsageListener(final DiskSpaceUsageListener listener) {\n-    diskSpaceUsageListeners.remove(listener);\n+    actor.call(() -> diskSpaceUsageListeners.remove(listener));", "originalCommit": "a859c1d7b30ef680b7cfe897212611c4e0da533f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTAxNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481991017", "bodyText": "This will be invoked by other actors. So to prevent concurrent access to diskSpaceUsageListeners we submit the task to this actor so that only this actor can modify it.", "author": "deepthidevaki", "createdAt": "2020-09-02T11:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NjM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5NDUzNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481894536", "bodyText": "Please let us talk about this.\nThe SpringBrokerBridge is intended to be treated like a Singleton, and managed by Spring. So nobody should call its constructor.", "author": "pihme", "createdAt": "2020-09-02T08:40:57Z", "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/ClusteringRule.java", "diffHunk": "@@ -114,6 +114,7 @@\n   private Gateway gateway;\n   private CountDownLatch partitionLatch;\n   private final Map<Integer, Leader> partitionLeader;\n+  private final Map<Integer, SpringBrokerBridge> springBrokerBridge;", "originalCommit": "a859c1d7b30ef680b7cfe897212611c4e0da533f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAzNjIxMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r482036213", "bodyText": "Sorry, my bad. Didn't realize that we are in the test code.", "author": "pihme", "createdAt": "2020-09-02T12:41:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5NDUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481905242", "bodyText": "This comment is actually for line 30 this.minFreeDiskSpaceRequired = dataCfg.getFreeDiskSpaceCommandWatermark(); (I don't know hot to add comments for lines that have not changed)\nI am pretty (albeit not a 100%) sure that this can be wrong. During out game days one of the interventions that the cloud team was able to do was to increase the PVC of the running broker. That means in the cloud the disk can grow (or shrink) at runtime, so this should become a supplier instead of a cached vale.", "author": "pihme", "createdAt": "2020-09-02T08:52:37Z", "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -34,6 +34,7 @@ public DiskSpaceUsageMonitor(final DataCfg dataCfg) {\n \n   @Override\n   protected void onActorStarted() {\n+    checkDiskUsageAndNotifyListeners();", "originalCommit": "a859c1d7b30ef680b7cfe897212611c4e0da533f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNzEzMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481917130", "bodyText": "Addendum: alistair is 99% sure this is done at runtime", "author": "pihme", "createdAt": "2020-09-02T09:05:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MjE0OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481992148", "bodyText": "Oh is it? I thought we have to restart the pod for the change to be in effect.", "author": "deepthidevaki", "createdAt": "2020-09-02T11:18:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5ODI2NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481998264", "bodyText": "Here what the cloud guys had to say: https://camunda.slack.com/archives/CKZK2E7RP/p1599037325041500", "author": "pihme", "createdAt": "2020-09-02T11:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAwMjYzNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r482002635", "bodyText": "I will create a new issue for it because it is unrelated to this PR.", "author": "deepthidevaki", "createdAt": "2020-09-02T11:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA0ODUzNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r482048535", "bodyText": "#5280", "author": "deepthidevaki", "createdAt": "2020-09-02T12:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg=="}], "type": "inlineReview"}, {"oid": "e68747736bf8b75b281b1ebcd9caf35748a25bd9", "url": "https://github.com/camunda-cloud/zeebe/commit/e68747736bf8b75b281b1ebcd9caf35748a25bd9", "message": "chore(broker): notify diskspace listeners when added\nand pause streamprocessor after a failover if diskspace not available", "committedDate": "2020-09-02T14:10:16Z", "type": "forcePushed"}, {"oid": "1cdf4802bf657b4a75976e0e99e61c8c2dce8d1c", "url": "https://github.com/camunda-cloud/zeebe/commit/1cdf4802bf657b4a75976e0e99e61c8c2dce8d1c", "message": "chore(qa): add tests for diskspace monitor after a failover", "committedDate": "2020-09-02T15:28:56Z", "type": "commit"}, {"oid": "16fc7e7d3c7265bddc3549cc24f7d6ba9c5f9570", "url": "https://github.com/camunda-cloud/zeebe/commit/16fc7e7d3c7265bddc3549cc24f7d6ba9c5f9570", "message": "chore(broker): notify diskspace listeners when added\nand pause streamprocessor after a failover if diskspace not available", "committedDate": "2020-09-02T15:28:56Z", "type": "commit"}, {"oid": "16fc7e7d3c7265bddc3549cc24f7d6ba9c5f9570", "url": "https://github.com/camunda-cloud/zeebe/commit/16fc7e7d3c7265bddc3549cc24f7d6ba9c5f9570", "message": "chore(broker): notify diskspace listeners when added\nand pause streamprocessor after a failover if diskspace not available", "committedDate": "2020-09-02T15:28:56Z", "type": "forcePushed"}]}