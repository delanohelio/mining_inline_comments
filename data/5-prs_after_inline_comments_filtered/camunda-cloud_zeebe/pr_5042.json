{"pr_number": 5042, "pr_title": "chore(atomix): use compatible serializers", "pr_createdAt": "2020-07-23T15:25:06Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5042", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4OTUxMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5042#discussion_r459589513", "bodyText": "Please rename these variables to 'fallback' and 'default'.", "author": "pihme", "createdAt": "2020-07-23T16:50:32Z", "path": "atomix/utils/src/main/java/io/atomix/utils/serializer/FallbackNamespace.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright \u00a9 2020 camunda services GmbH (info@camunda.com)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.atomix.utils.serializer;\n+\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import java.nio.ByteBuffer;\n+import org.slf4j.Logger;\n+\n+public class FallbackNamespace implements Namespace {\n+\n+  private static final Logger LOG = getLogger(FallbackNamespace.class);\n+  private static final String DESERIALIZE_ERROR =\n+      \"Deserialization failed with both the versioned and legacy serializers. The legacy serializer failed with:\\n %s\";\n+  private final Namespace legacy;", "originalCommit": "4486824b44e518f9c058a3952a88cf1616d5c733", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3NjYzNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5042#discussion_r462076634", "bodyText": "default is a Java keyword. Maybe one can be just namespace and the other fallback/fallbackNamespace, does that work for you?", "author": "MiguelPires", "createdAt": "2020-07-29T06:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4OTUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4MzExMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5042#discussion_r462083112", "bodyText": "Sure", "author": "pihme", "createdAt": "2020-07-29T07:05:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4OTUxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5MzYyMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5042#discussion_r459593621", "bodyText": "Question regarding the rolling update:\nLet's say we back port this change to a patch release for 0.24.\nIf we then swap the parameters in the 0.24 release, would that give us a two step rolling upgrade?\n\nWe can upgrade from 0.24.1 to 0.24.2 because the legacy will be the default in the 0.24.2 branch and the new one will be the fallback\nWe can upgrade from 0.24.2 to 0.25 because we then switch default and fallback\n\nWould this work?\nFor cloud it should be ok to make the 0.24 patch release mandatory as they apply the patch releases anyway. Plus it would save them work on the 0.25 upgrade. For other users we would have to tell them about the two step process.", "author": "pihme", "createdAt": "2020-07-23T16:57:26Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/partition/impl/RaftNamespaces.java", "diffHunk": "@@ -127,31 +130,40 @@\n    * <p>*Be aware* we use the Void type for replaced/removed types to keep the id's of used types,\n    * otherwise we break compatibility.\n    */\n-  public static final Namespace RAFT_STORAGE =\n-      Namespace.builder()\n-          .register(Namespaces.BASIC)\n-          .nextId(Namespaces.BEGIN_USER_CUSTOM_ID + 100)\n-          .register(Void.class) // CloseSessionEntry\n-          .register(Void.class) // CommandEntry\n-          .register(ConfigurationEntry.class)\n-          .register(InitializeEntry.class)\n-          .register(Void.class) // KeepAliveEntry\n-          .register(Void.class) // MetadataEntry\n-          .register(Void.class) // OpenSessionEntry\n-          .register(Void.class) // QueryEntry\n-          .register(Void.class) // PrimitiveOperation\n-          .register(Void.class) // DefaultOperationId\n-          .register(Void.class) // OperationType\n-          .register(Void.class) // ReadConsistency\n-          .register(ArrayList.class)\n-          .register(HashSet.class)\n-          .register(DefaultRaftMember.class)\n-          .register(MemberId.class)\n-          .register(RaftMember.Type.class)\n-          .register(Instant.class)\n-          .register(Configuration.class)\n-          .register(ZeebeEntry.class)\n-          .build(\"RaftStorage\");\n+  public static final FallbackNamespace RAFT_STORAGE;\n \n   private RaftNamespaces() {}\n+\n+  static {\n+    final Namespace legacy = registerStorageClasses().build(\"RaftStorage\");\n+    final Namespace compatible =\n+        registerStorageClasses().setCompatible(true).build(\"RaftStorage-compatible\");\n+    RAFT_STORAGE = new FallbackNamespace(legacy, compatible);", "originalCommit": "4486824b44e518f9c058a3952a88cf1616d5c733", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MTE1NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5042#discussion_r462071155", "bodyText": "Simply backporting this wouldn't work but we can adjust it slightly to make a two-step upgrade work. Besides allowing brokers to deserialize both versions (which one is the fallback is irrelevant I think), they would still serialize in the \"old\" format (i.e., non-compatible). This way, when upgrading from 0.24.x to 0.24.x+1, the 0.24.x brokers could read 0.24.x+1 messages and the rolling upgrade would work. After that the 0.24.x+1 brokers would be able to accept 0.25 brokers into the cluster, even though these work serialize in the new compatible format.", "author": "MiguelPires", "createdAt": "2020-07-29T06:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5MzYyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4Mzc1MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5042#discussion_r462083751", "bodyText": "Sounds good", "author": "pihme", "createdAt": "2020-07-29T07:06:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5MzYyMQ=="}], "type": "inlineReview"}, {"oid": "2603538041d112d3c7e43308c3f4f596c1c80b51", "url": "https://github.com/camunda-cloud/zeebe/commit/2603538041d112d3c7e43308c3f4f596c1c80b51", "message": "chore(atomix): use compatible serializers", "committedDate": "2020-08-03T08:10:43Z", "type": "commit"}, {"oid": "2603538041d112d3c7e43308c3f4f596c1c80b51", "url": "https://github.com/camunda-cloud/zeebe/commit/2603538041d112d3c7e43308c3f4f596c1c80b51", "message": "chore(atomix): use compatible serializers", "committedDate": "2020-08-03T08:10:43Z", "type": "forcePushed"}]}