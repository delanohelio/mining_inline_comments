{"pr_number": 5157, "pr_title": "Reenable rolling upgrade test", "pr_createdAt": "2020-08-11T13:16:45Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5157", "timeline": [{"oid": "6c93afd2dcb9f763cade246f6067815ddf79aa99", "url": "https://github.com/camunda-cloud/zeebe/commit/6c93afd2dcb9f763cade246f6067815ddf79aa99", "message": "chore(upgrade-tests): add snapshot upgrade test\n\n- reenable rolling upgrade test\n- disable test for versions starting with 0.25 as they are not backwards\n  compatible with 0.24", "committedDate": "2020-08-11T13:12:12Z", "type": "commit"}, {"oid": "ee24f116171288e2622d5608541dabdd60494355", "url": "https://github.com/camunda-cloud/zeebe/commit/ee24f116171288e2622d5608541dabdd60494355", "message": "chore(atomix/cluster): handle SnapshotChunk deserialization failure", "committedDate": "2020-08-11T13:12:29Z", "type": "commit"}, {"oid": "464ea5670fe1e17c1fe6cce25bf7a5646a3a0c52", "url": "https://github.com/camunda-cloud/zeebe/commit/464ea5670fe1e17c1fe6cce25bf7a5646a3a0c52", "message": "chore(upgrade-tests): add missing dependency", "committedDate": "2020-08-11T13:56:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5MzE3MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r471293170", "bodyText": "Why do you need this \"ZEEBE_CI_SHARED_DATA\"?", "author": "deepthidevaki", "createdAt": "2020-08-17T07:31:07Z", "path": "upgrade-tests/src/test/java/io/zeebe/test/RollingUpdateTest.java", "diffHunk": "@@ -52,6 +58,19 @@\n           .endEvent()\n           .done();\n \n+  private static final File SHARED_DATA;\n+\n+  static {\n+    final var sharedDataPath =\n+        Optional.ofNullable(System.getenv(\"ZEEBE_CI_SHARED_DATA\"))", "originalCommit": "464ea5670fe1e17c1fe6cce25bf7a5646a3a0c52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxNDc0NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r471314744", "bodyText": "We've had issues with sharing data folders with the Docker sibling container before in CI. If you mounted it to /tmp it would fail to mount with read/write access so the test container and the docker container wouldn't be able to see the same files, which is important if you want to check for snapshots, for example.\nSo, when testing locally, you do want to use /tmp since it's the standard tmp folder where things are cleaned up after. But on CI, you want to use another well defined mount points (which may not exist on the local dev machine, or may not get automatically cleaned up after), so that's what we use. The env var is then set in the Jenkinsfile.", "author": "npepinpe", "createdAt": "2020-08-17T08:14:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5MzE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1NzcwNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r471357707", "bodyText": "\ud83d\udc4d", "author": "deepthidevaki", "createdAt": "2020-08-17T09:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5MzE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk0NzQzMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r471947430", "bodyText": "Might worth to add a comment", "author": "Zelldon", "createdAt": "2020-08-18T06:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5MzE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5Mzc2MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r471293760", "bodyText": "Would be good to check if it is the right type by \"tryWrap\".", "author": "deepthidevaki", "createdAt": "2020-08-17T07:32:26Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/roles/PassiveRole.java", "diffHunk": "@@ -186,7 +188,18 @@ private void addSnapshotListener() {\n     }\n \n     final var snapshotChunk = new SnapshotChunkImpl();\n-    snapshotChunk.wrap(new UnsafeBuffer(request.data()), 0, request.data().capacity());\n+    try {\n+      snapshotChunk.wrap(new UnsafeBuffer(request.data()), 0, request.data().capacity());", "originalCommit": "464ea5670fe1e17c1fe6cce25bf7a5646a3a0c52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxNTM0Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r471315347", "bodyText": "Try wrap checks that the version is also the same, but I'm thinking this is actually wrong behaviour, no? Handling the different versions should be done depending on the messages, so we could use tryWrap and simply remove the version check. wdyt?", "author": "npepinpe", "createdAt": "2020-08-17T08:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5Mzc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1NzU5NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r471357594", "bodyText": "tryWrap only checks schemaId and templateId, right? It doesn't check the version.", "author": "deepthidevaki", "createdAt": "2020-08-17T09:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5Mzc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEyMTIwMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r472121201", "bodyText": "Ah, correct, not sure why I was so sure it did \ud83d\ude05", "author": "npepinpe", "createdAt": "2020-08-18T11:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5Mzc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEzOTMyMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r472139322", "bodyText": "The one downside I see now is that using tryWrap, you don't know what the error that occurred was (without breaking the abstraction). But I also like that it doesn't throw an exception... \ud83e\udd14", "author": "npepinpe", "createdAt": "2020-08-18T12:28:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5Mzc2MA=="}], "type": "inlineReview"}, {"oid": "0618f9b02172a7e68d35c89a1ac747c97ac40bd2", "url": "https://github.com/camunda-cloud/zeebe/commit/0618f9b02172a7e68d35c89a1ac747c97ac40bd2", "message": "chore(atomix/cluster): use tryWrap instead of exceptions", "committedDate": "2020-08-18T11:59:06Z", "type": "commit"}, {"oid": "2223a6d902506030bacf0e8bf4577fc69374847d", "url": "https://github.com/camunda-cloud/zeebe/commit/2223a6d902506030bacf0e8bf4577fc69374847d", "message": "chore(upgrade-tests): explain CI shared mount point", "committedDate": "2020-08-18T11:59:17Z", "type": "commit"}, {"oid": "ae4c710cad37a9ce6133fd300ae1d087e811f8c8", "url": "https://github.com/camunda-cloud/zeebe/commit/ae4c710cad37a9ce6133fd300ae1d087e811f8c8", "message": "chore(atomix/cluster): fix error", "committedDate": "2020-08-18T12:27:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1ODU3MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r472758571", "bodyText": "The name tryWrap is a misnomer. It only checks the headers, but it doesn't wrap the content. So we have to call snapshotChunk.wrap() again.", "author": "deepthidevaki", "createdAt": "2020-08-19T06:32:14Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/roles/PassiveRole.java", "diffHunk": "@@ -186,7 +188,15 @@ private void addSnapshotListener() {\n     }\n \n     final var snapshotChunk = new SnapshotChunkImpl();\n-    snapshotChunk.wrap(new UnsafeBuffer(request.data()), 0, request.data().capacity());\n+    final var snapshotChunkBuffer = new UnsafeBuffer(request.data());\n+    if (!snapshotChunk.tryWrap(snapshotChunkBuffer)) {", "originalCommit": "ae4c710cad37a9ce6133fd300ae1d087e811f8c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc4NzM3MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r472787370", "bodyText": "I see two options: one is we wrap in tryWrap (assuming the header is correct), the other is we rename it to canParse or some such (though it's also a bit misleading since we do wrap the header decoder, which means we do mutate the state). So I'd lean towards the former. We could also use Either as a return type, e.g. public Either<SnapshotChunkImpl, Throwable> wrap(...) and use tryWrap entirely internally.", "author": "npepinpe", "createdAt": "2020-08-19T07:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1ODU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc4ODEyMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r472788122", "bodyText": "Isn't tryWrap from generated code?", "author": "Zelldon", "createdAt": "2020-08-19T07:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1ODU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc5MTIwNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5157#discussion_r472791205", "bodyText": "I think it is not generated.", "author": "deepthidevaki", "createdAt": "2020-08-19T07:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1ODU3MQ=="}], "type": "inlineReview"}, {"oid": "17a59e9f382db3104059b3ec3455fb2510c0a3d5", "url": "https://github.com/camunda-cloud/zeebe/commit/17a59e9f382db3104059b3ec3455fb2510c0a3d5", "message": "chore(atomix/cluster): wrap body in tryWrap if possible", "committedDate": "2020-08-19T07:30:58Z", "type": "commit"}, {"oid": "26b5cd74e0148543af9d5b6fd12a40ab4745ff6e", "url": "https://github.com/camunda-cloud/zeebe/commit/26b5cd74e0148543af9d5b6fd12a40ab4745ff6e", "message": "chore(protocol-impl): keep tryWrap behaviour consistent", "committedDate": "2020-08-19T07:32:01Z", "type": "commit"}]}