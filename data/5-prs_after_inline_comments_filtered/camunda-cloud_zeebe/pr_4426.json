{"pr_number": 4426, "pr_title": "feat(broker): add configuration option for mmap", "pr_createdAt": "2020-04-30T11:58:26Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/4426", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4ODEyOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419388129", "bodyText": "Not sure this change makes things better as you now have a dependency to Spring DataSize in this class", "author": "pihme", "createdAt": "2020-05-04T12:08:16Z", "path": "broker/src/main/java/io/zeebe/broker/clustering/atomix/AtomixFactory.java", "diffHunk": "@@ -97,13 +98,15 @@ private static RaftPartitionGroup createRaftPartitionGroup(\n                 (raftContext, threadContext, threadContextFactory) ->\n                     new ZeebeRaftStateMachine(raftContext))\n             .withSnapshotStoreFactory(new DbSnapshotStoreFactory())\n+            .withStorageLevel(dataCfg.getAtomixStorageLevel())\n             .withFlushOnCommit();\n \n     // by default, the Atomix max entry size is 1 MB\n     final int maxMessageSize = (int) networkCfg.getMaxMessageSizeInBytes();\n     partitionGroupBuilder.withMaxEntrySize(maxMessageSize);\n \n-    Optional.ofNullable(dataCfg.getLogSegmentSizeInBytes())\n+    Optional.ofNullable(dataCfg.getLogSegmentSize())", "originalCommit": "1f42cb3f97f2b115029e9a45dda619825c8cc73f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQwMDYyMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419400623", "bodyText": "Hadn't thought of that; I just corrected it as afaik Optional.ofNullable of a primitive is never null?", "author": "npepinpe", "createdAt": "2020-05-04T12:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4ODEyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQxNDQ5NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419414494", "bodyText": "true, this is somewhat misleading. getLogmentSize will never be null.", "author": "pihme", "createdAt": "2020-05-04T12:56:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4ODEyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQyMTg2Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419421862", "bodyText": "I moved the Optional.ofNullable to the configuration class, let me know what you think.", "author": "npepinpe", "createdAt": "2020-05-04T13:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4ODEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4OTYyMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419389620", "bodyText": "this behavior is different from what is specified in the issue\n\nIf the user sets this option to true but also uses replication we will log a warning and disable this option to not prevent the broker from starting.\n\nPlease align the two, either by adding a comment to the issue/changing the issue; or changing this here", "author": "pihme", "createdAt": "2020-05-04T12:10:59Z", "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -70,7 +75,13 @@ private void validateConfiguration() {\n       throw new IllegalArgumentException(String.format(NODE_ID_ERROR_MSG, nodeId, clusterSize));\n     }\n \n+    final StorageLevel storageLevel = data.getAtomixStorageLevel();\n     final int replicationFactor = cluster.getReplicationFactor();\n+\n+    if (storageLevel == StorageLevel.MAPPED && replicationFactor > 1) {\n+      throw new IllegalStateException(MMAP_REPLICATION_ERROR_MSG);", "originalCommit": "1f42cb3f97f2b115029e9a45dda619825c8cc73f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5MDQ5NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419390494", "bodyText": "Maxybe a little more context would be helpful in the how to fix part:\nE.g. set BrokertCfg->DataCfg-useMmap to false", "author": "pihme", "createdAt": "2020-05-04T12:12:34Z", "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -29,6 +31,8 @@\n       \"Replication factor %s needs to be larger then zero and not larger then cluster size %s.\";\n   private static final String SNAPSHOT_PERIOD_ERROR_MSG =\n       \"Snapshot period %s needs to be larger then or equals to one minute.\";\n+  private static final String MMAP_REPLICATION_ERROR_MSG =\n+      \"Using memory mapped storage level is currently unsafe with replication enabled; if you wish to use replication, set useMmap to false\";", "originalCommit": "1f42cb3f97f2b115029e9a45dda619825c8cc73f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQxMTU2NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419411564", "bodyText": "Will update with env var to look for/update \ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-05-04T12:51:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5MDQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5MTc3NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419391774", "bodyText": "Maybe find a more neutral name. Not sure if the name is universal or particular to Atomix. At the very least it could be more verbose like \"useMemoryMap()\" or something like that", "author": "pihme", "createdAt": "2020-05-04T12:15:10Z", "path": "broker/src/main/java/io/zeebe/broker/system/configuration/DataCfg.java", "diffHunk": "@@ -64,10 +67,22 @@ public int getLogIndexDensity() {\n     return logIndexDensity;\n   }\n \n-  public void setLogIndexDensity(int logIndexDensity) {\n+  public void setLogIndexDensity(final int logIndexDensity) {\n     this.logIndexDensity = logIndexDensity;\n   }\n \n+  public boolean useMmap() {", "originalCommit": "1f42cb3f97f2b115029e9a45dda619825c8cc73f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5MzMxOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419393319", "bodyText": "Personally, not a fan of the expectedException rule. I would rather use Assertions.assertThatThronwBy(..) as it makes clearer where the exception is expected.\nFee free to ignore this comment, because it fits to the other test methods in this class.", "author": "pihme", "createdAt": "2020-05-04T12:18:12Z", "path": "broker/src/test/java/io/zeebe/broker/system/SystemContextTest.java", "diffHunk": "@@ -131,6 +131,20 @@ public void shouldNotThrowExceptionIfSnapshotPeriodIsEqualToOneMinute() {\n         .isEqualTo(Duration.ofMinutes(1));\n   }\n \n+  @Test\n+  public void shouldInvalidateConfigIfUseMmapTrueWithReplication() {\n+    // given\n+    final BrokerCfg brokerCfg = new BrokerCfg();\n+    brokerCfg.getData().setUseMmap(true);\n+    brokerCfg.getCluster().setClusterSize(2);\n+    brokerCfg.getCluster().setReplicationFactor(2);\n+\n+    // then\n+    expectedException.expect(IllegalStateException.class);", "originalCommit": "1f42cb3f97f2b115029e9a45dda619825c8cc73f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQxMjM3MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419412370", "bodyText": "Hm, I also prefer assert but in this case I kept it as you said, since it was consistent with the rest of the tests \ud83d\ude05 I'd also lean towards keeping things consistent over my personal preference", "author": "npepinpe", "createdAt": "2020-05-04T12:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5MzMxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5NDAwNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4426#discussion_r419394007", "bodyText": "Please add a test for the default value, if setUseMmap was never called", "author": "pihme", "createdAt": "2020-05-04T12:19:37Z", "path": "broker/src/test/java/io/zeebe/broker/system/configuration/DataCfgTest.java", "diffHunk": "@@ -30,4 +31,30 @@ public void shouldSanitizeDirectories() {\n \n     assertThat(actual).isEqualTo(expected);\n   }\n+\n+  @Test\n+  public void shouldGetMappedAtomixStorageLevel() {", "originalCommit": "1f42cb3f97f2b115029e9a45dda619825c8cc73f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "93db79ba38a1db5abf6517914099ba5ba998307f", "url": "https://github.com/camunda-cloud/zeebe/commit/93db79ba38a1db5abf6517914099ba5ba998307f", "message": "feat(broker): add configuration option for mmap", "committedDate": "2020-05-04T13:47:01Z", "type": "commit"}, {"oid": "93db79ba38a1db5abf6517914099ba5ba998307f", "url": "https://github.com/camunda-cloud/zeebe/commit/93db79ba38a1db5abf6517914099ba5ba998307f", "message": "feat(broker): add configuration option for mmap", "committedDate": "2020-05-04T13:47:01Z", "type": "forcePushed"}]}