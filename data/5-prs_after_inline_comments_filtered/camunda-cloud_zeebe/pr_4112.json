{"pr_number": 4112, "pr_title": "chore(broker): avoid NPE by using Optional", "pr_createdAt": "2020-03-23T15:02:34Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/4112", "timeline": [{"oid": "8f51ec5a664a2a2a887cac4e705a5d63238b3fb8", "url": "https://github.com/camunda-cloud/zeebe/commit/8f51ec5a664a2a2a887cac4e705a5d63238b3fb8", "message": "chore(broker): avoid NPE by using Optional\n\n- migrates several SnapshotStorage APIs from returning nullable types to\n  return Optional values, handling potential empty values where it makes\n  sense", "committedDate": "2020-03-23T15:02:45Z", "type": "forcePushed"}, {"oid": "2d9f561ce89d820926183c70dfb5fd228f39ca48", "url": "https://github.com/camunda-cloud/zeebe/commit/2d9f561ce89d820926183c70dfb5fd228f39ca48", "message": "chore(broker): avoid NPE by using Optional\n\n- migrates several SnapshotStorage APIs from returning nullable types to\n  return Optional values, handling potential empty values where it makes\n  sense", "committedDate": "2020-03-23T16:17:47Z", "type": "forcePushed"}, {"oid": "2b1a3912222cd3bae71bde0327c3b8863e06d2a7", "url": "https://github.com/camunda-cloud/zeebe/commit/2b1a3912222cd3bae71bde0327c3b8863e06d2a7", "message": "chore(broker): avoid NPE by using Optional\n\n- migrates several SnapshotStorage APIs from returning nullable types to\n  return Optional values, handling potential empty values where it makes\n  sense", "committedDate": "2020-03-23T17:02:33Z", "type": "forcePushed"}, {"oid": "bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "url": "https://github.com/camunda-cloud/zeebe/commit/bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "message": "chore(broker): avoid NPE by using Optional\n\n- migrates several SnapshotStorage APIs from returning nullable types to\n  return Optional values, handling potential empty values where it makes\n  sense", "committedDate": "2020-03-23T17:25:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxMDIyOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396910228", "bodyText": "I think I have a wrong cfg", "author": "Zelldon", "createdAt": "2020-03-24T05:31:10Z", "path": "engine/src/main/java/io/zeebe/engine/processor/AsyncSnapshotDirector.java", "diffHunk": "@@ -141,6 +135,11 @@ protected void onActorCloseRequested() {\n     return future;\n   }\n \n+  private void scheduleSnapshotOnRate() {", "originalCommit": "bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxMjU2NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396912564", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          LOG.debug(\"Skip taking snapshot due to no even having ever been processed\");\n          \n          \n            \n                          LOG.debug(\"We will skip taking this snapshot, because we haven't processed something yet.\");", "author": "Zelldon", "createdAt": "2020-03-24T05:40:21Z", "path": "engine/src/main/java/io/zeebe/engine/processor/AsyncSnapshotDirector.java", "diffHunk": "@@ -156,6 +155,12 @@ private void prepareTakingSnapshot() {\n         futureLastProcessedPosition,\n         (lastProcessedPosition, error) -> {\n           if (error == null) {\n+            if (lastProcessedPosition == StreamProcessor.UNSET_POSITION) {\n+              LOG.debug(\"Skip taking snapshot due to no even having ever been processed\");", "originalCommit": "bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNTQ0Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396915443", "bodyText": "I'm wondering why was this a problem with the -1 ? We will just wait until commit pos is higher?", "author": "Zelldon", "createdAt": "2020-03-24T05:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxMjU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTE4OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396959189", "bodyText": "If we don't skip -1, then we will try to look up the entry at position -1, which doesn't exist, and before this was triggering an NPE (as it was returning a nullable type). Now it would be handled properly anyway, but it would write a weird warning that we couldn't find the position in the log. This seems nicer for the user.", "author": "npepinpe", "createdAt": "2020-03-24T07:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxMjU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDE3Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396960177", "bodyText": "Was not aware of the lookup actually, seems to be new ?", "author": "Zelldon", "createdAt": "2020-03-24T07:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxMjU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDg3MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396960871", "bodyText": "Since we migrated to use a single snapshot store - Atomix snapshot metadata needs the entry index, so we have to look that up when we take a snapshot.", "author": "npepinpe", "createdAt": "2020-03-24T08:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxMjU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MTM1Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396961352", "bodyText": "ok thanks", "author": "Zelldon", "createdAt": "2020-03-24T08:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxMjU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxMjg3Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396912872", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private long errorRecordPosition = -1;\n          \n          \n            \n              private long errorRecordPosition = StreamProcessor.UNSET_POSITION;", "author": "Zelldon", "createdAt": "2020-03-24T05:41:31Z", "path": "engine/src/main/java/io/zeebe/engine/processor/ProcessingStateMachine.java", "diffHunk": "@@ -126,9 +126,9 @@\n   private LoggedEvent currentEvent;\n   private TypedRecordProcessor<?> currentProcessor;\n   private ZeebeDbTransaction zeebeDbTransaction;\n-  private long writtenEventPosition = -1L;\n-  private long lastSuccessfulProcessedEventPosition = -1L;\n-  private long lastWrittenEventPosition = -1L;\n+  private long writtenEventPosition = StreamProcessor.UNSET_POSITION;\n+  private long lastSuccessfulProcessedEventPosition = StreamProcessor.UNSET_POSITION;\n+  private long lastWrittenEventPosition = StreamProcessor.UNSET_POSITION;\n   private boolean onErrorHandling;\n   private long errorRecordPosition = -1;", "originalCommit": "bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDI2NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396914265", "bodyText": "This is no longer true, then please remove this test \ud83d\ude05 or rename it but I think we already have a similar test.", "author": "Zelldon", "createdAt": "2020-03-24T05:46:51Z", "path": "engine/src/test/java/io/zeebe/engine/processor/StreamProcessorTest.java", "diffHunk": "@@ -544,7 +545,7 @@ public void processRecord(\n   }\n \n   @Test\n-  public void shouldCreateSnapshotEvenWhenNoEventProcessed() throws Exception {\n+  public void shouldCreateSnapshotOnCloseEvenWhenNoEventProcessed() throws Exception {", "originalCommit": "bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNDMzOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397024339", "bodyText": "This tests that, on close, we will create a snapshot even if we did not process anything. This is still true? What the test has updated is that we have to have processed something at some point in history (so position is not -1), but that if this time we didn't process anything between open/close, we'll still create the snapshot.\nOr did I misunderstand what you mean?", "author": "npepinpe", "createdAt": "2020-03-24T09:50:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyODE2NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397028164", "bodyText": "Isnt that a contradiction ? \ud83d\ude05 You saying we will create a snapshot even if we did not process anything. In the next sentence you say What the test has updated is that we have to have processed something at some point in history (so position is not -1) \ud83d\ude05\n\nbut that if this time we didn't process anything between open/close, we'll still create the snapshot.\n\nThis is not what the test verifies, then I would expect two open and close cycles at least.", "author": "Zelldon", "createdAt": "2020-03-24T09:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyOTU3Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397029572", "bodyText": "What does the second open/close verify that the first doesn't? Let's say we didn't take snapshots on close if we hadn't processed anything since the last snapshot.\n\nProcess one event\nTake snapshot\nClose - no snapshot taken\n\nNow we verify that:\n\nOpen\nProcess event\nTake snapshot\nClose\nTake snapshot again\n\nWould a second open/close verify something more?\nAs for the name, any ideas? I'm not sure how to best phrase it without it being extremely long then \ud83d\ude05 shouldTakeSnapshotOnCloseEvenIfNothingProcessedSinceLastSnapshot?", "author": "npepinpe", "createdAt": "2020-03-24T09:58:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzNDA3Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397034073", "bodyText": "Ok I think I misunderstood the test or what you want to verify.\nI think this what you added should be in the given section. This is your starting point. It is given that you did a snapshot, when you close the stream processor then you expect one more snapshot even if no processing was in between", "author": "Zelldon", "createdAt": "2020-03-24T10:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDI2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDQ3NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396914475", "bodyText": "never ever? \ud83d\ude05", "author": "Zelldon", "createdAt": "2020-03-24T05:47:44Z", "path": "engine/src/test/java/io/zeebe/engine/processor/StreamProcessorTest.java", "diffHunk": "@@ -590,6 +601,22 @@ public void shouldCreateSnapshotsEvenIfNoProcessorProcessEvent() {\n     assertThat(stateSnapshotController.getValidSnapshotsCount()).isEqualTo(1);\n   }\n \n+  @Test\n+  public void shouldNotCreateSnapshotIfNothingProcessedEver() {", "originalCommit": "bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNTA5Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396915097", "bodyText": "Would it be possible to verify that the stream processor is really closed? I think it make sense for this test to ensure that this haven't created a snapshot otherwise we have no guarantee.", "author": "Zelldon", "createdAt": "2020-03-24T05:50:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNTcyNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396915727", "bodyText": "I'm not a fan of link to impl in interfaces \ud83d\ude48", "author": "Zelldon", "createdAt": "2020-03-24T05:52:40Z", "path": "logstreams/src/main/java/io/zeebe/logstreams/spi/SnapshotController.java", "diffHunk": "@@ -11,23 +11,30 @@\n import io.zeebe.logstreams.state.Snapshot;\n import java.io.File;\n import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Optional;\n import java.util.function.Consumer;\n \n public interface SnapshotController extends AutoCloseable {\n   /**\n    * Takes a snapshot based on the given position and immediately commits it.\n    *\n    * @param lowerBoundSnapshotPosition the lower bound snapshot position\n+   * @return a committed snapshot, or nothing if the operation failed\n+   * @see io.zeebe.logstreams.state.SnapshotStorage#commitSnapshot(Path)", "originalCommit": "bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNjIwMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397026201", "bodyText": "Isn't SnapshotStorage also an interface?", "author": "npepinpe", "createdAt": "2020-03-24T09:53:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNTcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjIyMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396916220", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final var optionalPath = storage.getPendingDirectoryFor(snapshotId);\n          \n          \n            \n                optionalPath.ifPresent(this::deletePendingSnapshot);\n          \n          \n            \n                storage.getPendingDirectoryFor(snapshotId).ifPresent(this::deletePendingSnapshot);", "author": "Zelldon", "createdAt": "2020-03-24T05:54:29Z", "path": "logstreams/src/main/java/io/zeebe/logstreams/state/FileSnapshotConsumer.java", "diffHunk": "@@ -34,12 +34,16 @@ public boolean consumeSnapshotChunk(final SnapshotChunk chunk) {\n \n   @Override\n   public boolean completeSnapshot(final String snapshotId) {\n-    return storage.commitSnapshot(storage.getPendingDirectoryFor(snapshotId)).isPresent();\n+    return storage.getPendingDirectoryFor(snapshotId).flatMap(storage::commitSnapshot).isPresent();\n   }\n \n   @Override\n   public void invalidateSnapshot(final String snapshotId) {\n-    final var pendingDirectory = storage.getPendingDirectoryFor(snapshotId);\n+    final var optionalPath = storage.getPendingDirectoryFor(snapshotId);\n+    optionalPath.ifPresent(this::deletePendingSnapshot);", "originalCommit": "bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjg1NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396916855", "bodyText": "This storage does an lookup now? \ud83d\udc40 because of the index usage?", "author": "Zelldon", "createdAt": "2020-03-24T05:56:55Z", "path": "logstreams/src/main/java/io/zeebe/logstreams/state/SnapshotStorage.java", "diffHunk": "@@ -24,18 +24,18 @@\n    * and therefore should be cached if it needs to be reused.\n    *\n    * @param snapshotPosition the position to use\n-   * @return a pending snapshot\n+   * @return a pending snapshot, or nothing if no position less than or equal was found in the log", "originalCommit": "bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNzA2Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397027066", "bodyText": "Hehe, fair enough, that's implementation detail. I'll update it", "author": "npepinpe", "createdAt": "2020-03-24T09:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzNzMwNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397037304", "bodyText": "Actually not sure how to word this without implementation details - but yes that's what it does. It looks up the correct index for the position to provide Atomix with the right snapshot metadata.", "author": "npepinpe", "createdAt": "2020-03-24T10:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzOTQ4Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397039482", "bodyText": "Ok was not sure when I read that how it works. Maybe just remove the log from it ? but you can also leave it as it is", "author": "Zelldon", "createdAt": "2020-03-24T10:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MDU3OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397040578", "bodyText": "Maybe if no snapshot metadata could be created from the given position? The impl will do the look up, but really the end result is that if we can't create the metadata for Atomix then we can't create the snapshot", "author": "npepinpe", "createdAt": "2020-03-24T10:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjg1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzg4NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396917884", "bodyText": "lol \ud83d\ude48", "author": "Zelldon", "createdAt": "2020-03-24T06:00:37Z", "path": "logstreams/src/test/java/io/zeebe/logstreams/state/StateSnapshotControllerTest.java", "diffHunk": "@@ -46,13 +46,12 @@ public void setup() throws IOException {\n   }\n \n   @Test\n-  public void shouldThrowExceptionOnTakeSnapshotIfClosed() {\n+  public void shouldNotTakeSnapshotIfDbIsClosed() {\n     // given\n \n     // then\n     assertThat(snapshotController.isDbOpened()).isFalse();\n-    assertThatThrownBy(() -> snapshotController.takeSnapshot(1))\n-        .isInstanceOf(NullPointerException.class);", "originalCommit": "bd8e5aa41dd6f5a0e9131be288dd43227cce00df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzkyNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r396917926", "bodyText": "really?", "author": "Zelldon", "createdAt": "2020-03-24T06:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNzE5Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397027192", "bodyText": "\ud83e\udd37\u200d\u2642\ufe0f", "author": "npepinpe", "createdAt": "2020-03-24T09:54:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzMzUzMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397033531", "bodyText": "100% my fault \ud83d\ude48", "author": "npepinpe", "createdAt": "2020-03-24T10:04:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzg4NA=="}], "type": "inlineReview"}, {"oid": "5fd3b537b03c7da9821a414250a02a09b179cb40", "url": "https://github.com/camunda-cloud/zeebe/commit/5fd3b537b03c7da9821a414250a02a09b179cb40", "message": "chore(engine): ensure stream processor is closed", "committedDate": "2020-03-24T09:52:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0ODk1Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397048953", "bodyText": "Take snapshot is only called on enforcing right? to be more impl independent we also just could use the waituntil snapshot count is 2", "author": "Zelldon", "createdAt": "2020-03-24T10:30:14Z", "path": "engine/src/test/java/io/zeebe/engine/processor/StreamProcessorTest.java", "diffHunk": "@@ -545,32 +545,35 @@ public void processRecord(\n   }\n \n   @Test\n-  public void shouldCreateSnapshotOnCloseEvenWhenNoEventProcessed() throws Exception {\n+  public void shouldCreateSnapshotOnCloseEvenIfNothingProcessedSinceLastSnapshot()\n+      throws Exception {\n     // given\n-    final CountDownLatch recoveredLatch = new CountDownLatch(1);\n-    streamProcessorRule.startTypedStreamProcessor(\n-        (processors, context) ->\n-            processors.onEvent(\n-                ValueType.WORKFLOW_INSTANCE,\n-                WorkflowInstanceIntent.ELEMENT_ACTIVATING,\n-                new TypedRecordProcessor<UnifiedRecordValue>() {\n-                  @Override\n-                  public void onRecovered(final ReadonlyProcessingContext context) {\n-                    recoveredLatch.countDown();\n-                  }\n-                }));\n-\n-    // when\n+    final var recoveredLatch = new CountDownLatch(1);\n+    final var streamProcessor =\n+        streamProcessorRule.startTypedStreamProcessor(\n+            (processors, context) ->\n+                processors.onEvent(\n+                    ValueType.WORKFLOW_INSTANCE,\n+                    WorkflowInstanceIntent.ELEMENT_ACTIVATING,\n+                    new TypedRecordProcessor<UnifiedRecordValue>() {\n+                      @Override\n+                      public void onRecovered(final ReadonlyProcessingContext context) {\n+                        recoveredLatch.countDown();\n+                      }\n+                    }));\n     final var stateSnapshotController = streamProcessorRule.getStateSnapshotController();\n     recoveredLatch.await(5, TimeUnit.SECONDS);\n     final var position =\n         streamProcessorRule.writeWorkflowInstanceEvent(WorkflowInstanceIntent.ELEMENT_ACTIVATING);\n     TestUtil.waitUntil(() -> streamProcessorRule.events().count() >= 1);\n     streamProcessorRule.getClock().addTime(SNAPSHOT_INTERVAL);\n     TestUtil.waitUntil(() -> stateSnapshotController.getValidSnapshotsCount() == 1);\n+\n+    // when\n     streamProcessorRule.closeStreamProcessor();\n \n     // then\n+    assertThat(streamProcessor.isClosed()).isTrue();\n     final InOrder inOrder = Mockito.inOrder(stateSnapshotController);\n     inOrder.verify(stateSnapshotController, TIMEOUT.times(1)).openDb();\n     inOrder.verify(stateSnapshotController, TIMEOUT.times(1)).takeSnapshot(position);", "originalCommit": "e5a69b791e5fba3ecf7702a0e14a8292177857aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1MDY4Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397050682", "bodyText": "Good point - you're right, this relies on the implementation calling this particular method. And now we can get rid of the mock \ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-03-24T10:33:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0ODk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1MTUwMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4112#discussion_r397051503", "bodyText": "\ud83c\udf89", "author": "Zelldon", "createdAt": "2020-03-24T10:34:36Z", "path": "engine/src/test/java/io/zeebe/engine/processor/StreamProcessorTest.java", "diffHunk": "@@ -574,9 +574,7 @@ public void onRecovered(final ReadonlyProcessingContext context) {\n \n     // then\n     assertThat(streamProcessor.isClosed()).isTrue();\n-    final InOrder inOrder = Mockito.inOrder(stateSnapshotController);\n-    inOrder.verify(stateSnapshotController, TIMEOUT.times(1)).openDb();\n-    inOrder.verify(stateSnapshotController, TIMEOUT.times(1)).takeSnapshot(position);\n+    TestUtil.waitUntil(() -> stateSnapshotController.getValidSnapshotsCount() == 2);", "originalCommit": "2518c3f191c95f2c03d41f73ab5a943e90559160", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "caeb4706c75356f029cf60869c3dda3368e56df7", "url": "https://github.com/camunda-cloud/zeebe/commit/caeb4706c75356f029cf60869c3dda3368e56df7", "message": "chore(broker): avoid NPE by using Optional\n\n- migrates several SnapshotStorage APIs from returning nullable types to\n  return Optional values, handling potential empty values where it makes\n  sense", "committedDate": "2020-03-24T10:36:12Z", "type": "commit"}, {"oid": "caeb4706c75356f029cf60869c3dda3368e56df7", "url": "https://github.com/camunda-cloud/zeebe/commit/caeb4706c75356f029cf60869c3dda3368e56df7", "message": "chore(broker): avoid NPE by using Optional\n\n- migrates several SnapshotStorage APIs from returning nullable types to\n  return Optional values, handling potential empty values where it makes\n  sense", "committedDate": "2020-03-24T10:36:12Z", "type": "forcePushed"}]}