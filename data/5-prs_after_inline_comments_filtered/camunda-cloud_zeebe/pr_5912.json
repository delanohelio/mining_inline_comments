{"pr_number": 5912, "pr_title": "Parallelize update tests", "pr_createdAt": "2020-11-24T20:29:06Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5912", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg2Mjk5Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r529862992", "bodyText": "In junit5, CloseableResource objects which are put in a store are automatically closed when the test lifecycle ends (so if it's on a parameter or field, when the test ends; if it's on a static field, when the class/suite ends).", "author": "npepinpe", "createdAt": "2020-11-24T20:37:55Z", "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -18,13 +18,14 @@\n import java.util.regex.Pattern;\n import net.jodah.failsafe.Failsafe;\n import net.jodah.failsafe.RetryPolicy;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store.CloseableResource;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.testcontainers.containers.ContainerFetchException;\n import org.testcontainers.containers.ContainerLaunchException;\n import org.testcontainers.containers.Network;\n \n-public class ContainerState {\n+public class ContainerState implements CloseableResource {", "originalCommit": "96f6d41a782003b0d0dfd40356c63dc0c306ec50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg2MzMzNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r529863336", "bodyText": "Easily extended if we need more by storing a collection. Note that we'd need to make the collection itself a CloseableResource to ensure everything is cleaned up.", "author": "npepinpe", "createdAt": "2020-11-24T20:38:41Z", "path": "update-tests/src/test/java/io/zeebe/test/ContainerStateExtension.java", "diffHunk": "@@ -8,39 +8,52 @@\n package io.zeebe.test;\n \n import io.zeebe.test.util.testcontainers.ManagedVolume;\n+import java.util.Optional;\n import org.junit.jupiter.api.extension.AfterTestExecutionCallback;\n-import org.junit.jupiter.api.extension.BeforeTestExecutionCallback;\n import org.junit.jupiter.api.extension.ExtensionContext;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import org.junit.jupiter.api.extension.ExtensionContext.Namespace;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store.CloseableResource;\n+import org.junit.jupiter.api.extension.ParameterContext;\n+import org.junit.jupiter.api.extension.ParameterResolutionException;\n+import org.junit.jupiter.api.extension.ParameterResolver;\n \n-public class ContainerStateExtension\n-    implements BeforeTestExecutionCallback, AfterTestExecutionCallback {\n-  private static final Logger LOG = LoggerFactory.getLogger(ContainerStateExtension.class);\n-\n-  private final ContainerState state;\n-\n-  public ContainerStateExtension(final ContainerState state) {\n-    this.state = state;\n-  }\n+/**\n+ * This extension injects a new {@link ContainerState} at runtime into any test which adds a {@link\n+ * ContainerState} parameter, and stores it in a {@link Store}. This ensures that the resource is\n+ * properly closed (since {@link ContainerState} implements {@link CloseableResource}).\n+ *\n+ * <p>Note however that it currently only supports injecting a single state, since the stored state", "originalCommit": "96f6d41a782003b0d0dfd40356c63dc0c306ec50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f8e4d4f4f65a559a56d73ce9e33ea946bba0290a", "url": "https://github.com/camunda-cloud/zeebe/commit/f8e4d4f4f65a559a56d73ce9e33ea946bba0290a", "message": "chore(update-tests): remove dead code", "committedDate": "2020-11-25T13:02:43Z", "type": "forcePushed"}, {"oid": "8460069cd19a6055479ad40fe8ddac5a4705e6fa", "url": "https://github.com/camunda-cloud/zeebe/commit/8460069cd19a6055479ad40fe8ddac5a4705e6fa", "message": "chore(update-tests): remove dead code", "committedDate": "2020-11-25T14:56:30Z", "type": "forcePushed"}, {"oid": "5117e5c480d8e917f8d7431307a409db83dce4d6", "url": "https://github.com/camunda-cloud/zeebe/commit/5117e5c480d8e917f8d7431307a409db83dce4d6", "message": "chore(update-tests): split off UpdateTest monster\n\n- split off UpdateTest class into multiple test suites to further\n  parallelize", "committedDate": "2020-11-27T13:51:34Z", "type": "forcePushed"}, {"oid": "86dc7818dda9dc823d0874e71ba3b94e48fbba16", "url": "https://github.com/camunda-cloud/zeebe/commit/86dc7818dda9dc823d0874e71ba3b94e48fbba16", "message": "chore(parent): enable junit parallel tests for fun", "committedDate": "2020-11-27T14:12:14Z", "type": "forcePushed"}, {"oid": "87938a6e7170a2bb252d5fda50080db6f182078c", "url": "https://github.com/camunda-cloud/zeebe/commit/87938a6e7170a2bb252d5fda50080db6f182078c", "message": "chore(update-tests): split off UpdateTest monster\n\n- split off UpdateTest class into multiple test suites to further\n  parallelize", "committedDate": "2020-11-28T08:55:51Z", "type": "forcePushed"}, {"oid": "b3485b305af19ead6dac96c4734ea02b2913db9d", "url": "https://github.com/camunda-cloud/zeebe/commit/b3485b305af19ead6dac96c4734ea02b2913db9d", "message": "chore(update-tests): run parameterized tests in parallel", "committedDate": "2020-11-28T09:11:20Z", "type": "forcePushed"}, {"oid": "cce83f1f13ce8182bbe54c515f761f90f6444484", "url": "https://github.com/camunda-cloud/zeebe/commit/cce83f1f13ce8182bbe54c515f761f90f6444484", "message": "chore(update-tests): run parameterized tests in parallel", "committedDate": "2020-11-28T09:36:34Z", "type": "forcePushed"}, {"oid": "c6cb4cb719aedc8ec06e45defe8ca07ab9a64ea0", "url": "https://github.com/camunda-cloud/zeebe/commit/c6cb4cb719aedc8ec06e45defe8ca07ab9a64ea0", "message": "chore(update-tests): simplify eventually API", "committedDate": "2020-12-02T16:56:59Z", "type": "forcePushed"}, {"oid": "2d6e499901584072ba2fbbe196e4373f531b2036", "url": "https://github.com/camunda-cloud/zeebe/commit/2d6e499901584072ba2fbbe196e4373f531b2036", "message": "chore(update-tests): run parameterized tests in parallel", "committedDate": "2020-12-02T17:10:07Z", "type": "forcePushed"}, {"oid": "376304685afd4dad0405e39305298c408fb06701", "url": "https://github.com/camunda-cloud/zeebe/commit/376304685afd4dad0405e39305298c408fb06701", "message": "chore(test-util): lower base port to avoid collisions with docker for ports above 32655", "committedDate": "2020-12-02T18:19:26Z", "type": "forcePushed"}, {"oid": "123b0d66baee3bc141a81adb3d093da8fcdeef42", "url": "https://github.com/camunda-cloud/zeebe/commit/123b0d66baee3bc141a81adb3d093da8fcdeef42", "message": "chore(update-tests): do not use junit5 parallel tests", "committedDate": "2020-12-02T20:50:22Z", "type": "forcePushed"}, {"oid": "2605b55a593f19359c83563397fa79ad78f3ff67", "url": "https://github.com/camunda-cloud/zeebe/commit/2605b55a593f19359c83563397fa79ad78f3ff67", "message": "chore(test-util): lower base port to avoid collisions with docker for ports above 32655", "committedDate": "2020-12-03T08:20:20Z", "type": "forcePushed"}, {"oid": "fd39466b36b10f2aade8aa57abf9644ea7e09fbc", "url": "https://github.com/camunda-cloud/zeebe/commit/fd39466b36b10f2aade8aa57abf9644ea7e09fbc", "message": "chore(update-tests): split off UpdateTest monster\n\n- split off UpdateTest class into multiple test suites to allow\n  parallelizing via surefire/failsafe forks", "committedDate": "2020-12-03T08:20:20Z", "type": "forcePushed"}, {"oid": "c4b33a49fd38c61865fdb66ab97a3e9347642af4", "url": "https://github.com/camunda-cloud/zeebe/commit/c4b33a49fd38c61865fdb66ab97a3e9347642af4", "message": "chore(update-tests): split off UpdateTest monster\n\n- split off UpdateTest class into multiple test suites to allow\n  parallelizing via surefire/failsafe forks", "committedDate": "2020-12-04T14:48:35Z", "type": "forcePushed"}, {"oid": "b029dea5bc9753fda05dc00c9bf604035c887ac8", "url": "https://github.com/camunda-cloud/zeebe/commit/b029dea5bc9753fda05dc00c9bf604035c887ac8", "message": "chore(update-tests): parallelize UpdateTest\n\n- splits UpdateTest class into multiple classes, which allows\n  surefire/failsafe to parallelize the tests using forks\n- extracts shared assertion logic into ContainerStateAssert\n- fixes some warnings\n\nchore(update-tests): minor touch up", "committedDate": "2020-12-04T14:52:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE1NjUwNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r536156504", "bodyText": "Fixes a warning about type erasure", "author": "npepinpe", "createdAt": "2020-12-04T14:54:43Z", "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -18,15 +18,16 @@\n import java.util.regex.Pattern;\n import net.jodah.failsafe.Failsafe;\n import net.jodah.failsafe.RetryPolicy;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store.CloseableResource;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.testcontainers.containers.ContainerFetchException;\n import org.testcontainers.containers.ContainerLaunchException;\n import org.testcontainers.containers.Network;\n \n-public class ContainerState {\n+final class ContainerState implements CloseableResource {\n   private static final RetryPolicy<Void> CONTAINER_START_RETRY_POLICY =\n-      new RetryPolicy().withMaxRetries(5).withBackoff(3, 30, ChronoUnit.SECONDS);\n+      new RetryPolicy<Void>().withMaxRetries(5).withBackoff(3, 30, ChronoUnit.SECONDS);", "originalCommit": "b029dea5bc9753fda05dc00c9bf604035c887ac8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE1NzE3Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r536157177", "bodyText": "In junit5, CloseableResource instances which are stored in an extension store will be automatically close at the end of the extension's lifecycle - in our case, with ContainerStateExtension, this means at the end of the test where the parameter is injected.\nSee https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/extension/ExtensionContext.Store.CloseableResource.html", "author": "npepinpe", "createdAt": "2020-12-04T14:55:46Z", "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -18,15 +18,16 @@\n import java.util.regex.Pattern;\n import net.jodah.failsafe.Failsafe;\n import net.jodah.failsafe.RetryPolicy;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store.CloseableResource;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.testcontainers.containers.ContainerFetchException;\n import org.testcontainers.containers.ContainerLaunchException;\n import org.testcontainers.containers.Network;\n \n-public class ContainerState {\n+final class ContainerState implements CloseableResource {", "originalCommit": "b029dea5bc9753fda05dc00c9bf604035c887ac8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE1ODM0Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r536158346", "bodyText": "These settings are known to improve performance - however they're not defaults as changing them would be non-backwards compatible. We can remove them here once that's the case.", "author": "npepinpe", "createdAt": "2020-12-04T14:57:23Z", "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -92,6 +97,9 @@ public void start(final boolean enableDebug) {\n     broker =\n         new ZeebeContainer(\"camunda/zeebe:\" + brokerVersion)\n             .withEnv(\"ZEEBE_LOG_LEVEL\", \"DEBUG\")\n+            .withEnv(\"ZEEBE_BROKER_NETWORK_MAXMESSAGESIZE\", \"128KB\")\n+            .withEnv(\"ZEEBE_BROKER_DATA_USEMMAP\", \"true\")\n+            .withEnv(\"ZEEBE_BROKER_DATA_LOGSEGMENTSIZE\", \"64MB\")", "originalCommit": "b029dea5bc9753fda05dc00c9bf604035c887ac8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a551c1a2e13458c17f528d5d93bafcd1227902dc", "url": "https://github.com/camunda-cloud/zeebe/commit/a551c1a2e13458c17f528d5d93bafcd1227902dc", "message": "chore(update-tests): parallelize UpdateTest\n\n- splits UpdateTest class into multiple classes, which allows\n  surefire/failsafe to parallelize the tests using forks\n- extracts shared assertion logic into ContainerStateAssert\n- fixes some warnings\n\nchore(update-tests): minor touch up", "committedDate": "2020-12-04T15:31:33Z", "type": "forcePushed"}, {"oid": "32a30de35418f3691cad262078dd86c5e4833ee6", "url": "https://github.com/camunda-cloud/zeebe/commit/32a30de35418f3691cad262078dd86c5e4833ee6", "message": "chore(update-tests): parallelize UpdateTest\n\n- splits UpdateTest class into multiple classes, which allows\n  surefire/failsafe to parallelize the tests using forks\n- extracts shared assertion logic into ContainerStateAssert\n- fixes some warnings", "committedDate": "2020-12-04T16:31:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyNTgzMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r538225832", "bodyText": "Why not move the assignment to the declaration and remove the constructor altogether?", "author": "MiguelPires", "createdAt": "2020-12-08T10:36:29Z", "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -45,19 +46,18 @@\n             });\n   }\n \n-  private final Network network;\n-\n   private ZeebeContainer broker;\n   private ZeebeGatewayContainer gateway;\n   private ZeebeClient client;\n   private PartitionsActuatorClient partitionsActuatorClient;\n   private ManagedVolume volume;\n+  private Network network;\n \n   private String brokerVersion;\n   private String gatewayVersion;\n \n-  public ContainerState(final Network network) {\n-    this.network = network;\n+  public ContainerState() {\n+    network = Network.SHARED;", "originalCommit": "32a30de35418f3691cad262078dd86c5e4833ee6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0MjA1Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r538242052", "bodyText": "Ah, I think I had it final for a bit, and just didn't change it after.", "author": "npepinpe", "createdAt": "2020-12-08T10:57:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyNTgzMg=="}], "type": "inlineReview"}, {"oid": "29bb8974dcd75727653516aea0d8e387ac2e864b", "url": "https://github.com/camunda-cloud/zeebe/commit/29bb8974dcd75727653516aea0d8e387ac2e864b", "message": "chore(update-tests): parallelize UpdateTest\n\n- splits UpdateTest class into multiple classes, which allows\n  surefire/failsafe to parallelize the tests using forks\n- extracts shared assertion logic into ContainerStateAssert\n- fixes some warnings", "committedDate": "2020-12-08T11:16:13Z", "type": "commit"}, {"oid": "29bb8974dcd75727653516aea0d8e387ac2e864b", "url": "https://github.com/camunda-cloud/zeebe/commit/29bb8974dcd75727653516aea0d8e387ac2e864b", "message": "chore(update-tests): parallelize UpdateTest\n\n- splits UpdateTest class into multiple classes, which allows\n  surefire/failsafe to parallelize the tests using forks\n- extracts shared assertion logic into ContainerStateAssert\n- fixes some warnings", "committedDate": "2020-12-08T11:16:13Z", "type": "forcePushed"}]}