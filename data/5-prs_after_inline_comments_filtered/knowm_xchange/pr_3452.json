{"pr_number": 3452, "pr_title": "[Bithumb] API Changes Fixes", "pr_createdAt": "2020-03-14T16:22:52Z", "pr_url": "https://github.com/knowm/XChange/pull/3452", "timeline": [{"oid": "e230572c0af81908333f03fc008f6a15cd6d2aca", "url": "https://github.com/knowm/XChange/commit/e230572c0af81908333f03fc008f6a15cd6d2aca", "message": "Bithumb API Changes Fixes", "committedDate": "2020-03-14T16:20:16Z", "type": "commit"}, {"oid": "d0d50028eada3d88931be632b2c719338d520847", "url": "https://github.com/knowm/XChange/commit/d0d50028eada3d88931be632b2c719338d520847", "message": "Bithumb API Changes Fixes #2", "committedDate": "2020-03-14T19:09:42Z", "type": "commit"}, {"oid": "fca5775e4faedecaf33eac07b0a3a7659b4bff43", "url": "https://github.com/knowm/XChange/commit/fca5775e4faedecaf33eac07b0a3a7659b4bff43", "message": "Bithumb API Changes Fixes #2 - cleanup", "committedDate": "2020-03-14T19:12:40Z", "type": "commit"}, {"oid": "38f8277cdf738f8c580be222bba70fb605c2b14b", "url": "https://github.com/knowm/XChange/commit/38f8277cdf738f8c580be222bba70fb605c2b14b", "message": "Bithumb API Changes Fixes #2 - cleanup\n\nBithumb API Changes Fixes #2\n\nBithumb API Changes Fixes", "committedDate": "2020-03-14T19:13:44Z", "type": "commit"}, {"oid": "2ff58f094b15b3aab7ad7d159fe357c628644e48", "url": "https://github.com/knowm/XChange/commit/2ff58f094b15b3aab7ad7d159fe357c628644e48", "message": "Merge branch 'develop' of https://github.com/mainbloq/XChange into develop", "committedDate": "2020-03-14T19:14:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYxNTgxOA==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r392615818", "bodyText": "use brackets", "author": "walec51", "createdAt": "2020-03-14T20:11:04Z", "path": "xchange-bithumb/src/main/java/org/knowm/xchange/bithumb/BithumbAdapters.java", "diffHunk": "@@ -134,15 +141,18 @@ public static LimitOrder adaptOrder(BithumbOrder order) {\n         new CurrencyPair(order.getOrderCurrency(), order.getPaymentCurrency());\n     final Order.OrderType orderType = adaptOrderType(order.getType());\n \n+    Order.OrderStatus status = Order.OrderStatus.UNKNOWN;\n+    if (order.getUnitsRemaining().compareTo(order.getUnits()) == 0) status = Order.OrderStatus.NEW;", "originalCommit": "2ff58f094b15b3aab7ad7d159fe357c628644e48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d3a0f73b68ff96448dbc8327d7db4f386dc3a258", "url": "https://github.com/knowm/XChange/commit/d3a0f73b68ff96448dbc8327d7db4f386dc3a258", "message": "Bithumb API Changes Fixes #2 - cleanup 2", "committedDate": "2020-03-14T20:23:02Z", "type": "commit"}, {"oid": "454fad8cf3a694c4f3dc08b2d1cb3a5661d2e4f1", "url": "https://github.com/knowm/XChange/commit/454fad8cf3a694c4f3dc08b2d1cb3a5661d2e4f1", "message": "Bithumb API Changes Fixes #2 - Unit Test fixed", "committedDate": "2020-03-14T20:34:06Z", "type": "commit"}, {"oid": "833198e2f6df7f86667065580e538edcabdd9f6e", "url": "https://github.com/knowm/XChange/commit/833198e2f6df7f86667065580e538edcabdd9f6e", "message": "Bithumb API Changes Fixes #2 - Unit Test 2 fixed", "committedDate": "2020-03-14T20:42:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwMzg0Mw==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r393303843", "bodyText": "this is not an id at will not be unique if many orders get filled at the same time - its better to leave id as null then to have a not unique id", "author": "walec51", "createdAt": "2020-03-16T20:52:53Z", "path": "xchange-bithumb/src/main/java/org/knowm/xchange/bithumb/BithumbAdapters.java", "diffHunk": "@@ -162,13 +177,14 @@ private static UserTrade adaptUserTrade(\n \n     final String units = StringUtils.remove(bithumbTransaction.getUnits(), ' ');\n     return new UserTrade.Builder()\n+        .id(Long.toString(bithumbTransaction.getTransferDate()))", "originalCommit": "833198e2f6df7f86667065580e538edcabdd9f6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1NjE5NA==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r393356194", "bodyText": "ok", "author": "mdvx", "createdAt": "2020-03-16T23:00:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwMzg0Mw=="}], "type": "inlineReview"}, {"oid": "488c90deb9e4b10b6a5991dd40dce670283d62f8", "url": "https://github.com/knowm/XChange/commit/488c90deb9e4b10b6a5991dd40dce670283d62f8", "message": "Bithumb API Changes Fixes #3 - Transactions vs UserTransactions - OrderDetails - updated UnitTests", "committedDate": "2020-03-16T22:59:15Z", "type": "commit"}, {"oid": "950b4793976fc7fc304a9d3df9fa961122566099", "url": "https://github.com/knowm/XChange/commit/950b4793976fc7fc304a9d3df9fa961122566099", "message": "Missed unit test change", "committedDate": "2020-03-16T23:11:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3MTc1Nw==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r393371757", "bodyText": "are you sure that old transactions don't have spaces and minus sign?", "author": "walec51", "createdAt": "2020-03-16T23:47:50Z", "path": "xchange-bithumb/src/main/java/org/knowm/xchange/bithumb/BithumbAdapters.java", "diffHunk": "@@ -123,60 +130,112 @@ public static Trade adaptTrade(BithumbTransactionHistory trade, CurrencyPair cur\n     return orderType == OrderType.bid ? Order.OrderType.BID : Order.OrderType.ASK;\n   }\n \n-  public static OpenOrders adaptOrders(List<BithumbOrder> bithumbOrders) {\n+  public static OpenOrders adaptOrders(List<BithumbOrderResponse.BithumbOrder> bithumbOrders) {\n     final List<LimitOrder> orders =\n         bithumbOrders.stream().map(BithumbAdapters::adaptOrder).collect(Collectors.toList());\n     return new OpenOrders(orders);\n   }\n \n-  public static LimitOrder adaptOrder(BithumbOrder order) {\n+  public static LimitOrder adaptOrder(BithumbOrderResponse.BithumbOrder order) {\n     final CurrencyPair currencyPair =\n-        new CurrencyPair(order.getOrderCurrency(), order.getPaymentCurrency());\n+        adaptCurrencyPair(order.getOrderCurrency(), order.getPaymentCurrency());\n     final Order.OrderType orderType = adaptOrderType(order.getType());\n \n+    Order.OrderStatus status = Order.OrderStatus.UNKNOWN;\n+    if (order.getUnitsRemaining().compareTo(order.getUnits()) == 0) {\n+      status = Order.OrderStatus.NEW;\n+    } else if (order.getUnitsRemaining().compareTo(BigDecimal.ZERO) == 0) {\n+      status = Order.OrderStatus.FILLED;\n+    } else {\n+      status = Order.OrderStatus.PARTIALLY_FILLED;\n+    }\n+\n     return new LimitOrder.Builder(orderType, currencyPair)\n         .id(String.valueOf(order.getOrderId()))\n         .limitPrice(order.getPrice())\n         .originalAmount(order.getUnits())\n         .remainingAmount(order.getUnitsRemaining())\n-        .orderStatus(\n-            StringUtils.equals(order.getStatus(), \"placed\")\n-                ? Order.OrderStatus.NEW\n-                : Order.OrderStatus.UNKNOWN)\n+        .orderStatus(status)\n         .timestamp(new Date(order.getOrderDate() / 1000L))\n         .build();\n   }\n \n   public static UserTrades adaptUserTrades(\n-      List<BithumbTransaction> transactions, CurrencyPair currencyPair) {\n+      List<BithumbUserTransactionResponse.BithumbUserTransaction> transactions,\n+      CurrencyPair currencyPair) {\n     final List<UserTrade> userTrades =\n         transactions.stream()\n-            .filter(BithumbTransaction::isBuyOrSell)\n+            .filter(BithumbUserTransactionResponse.BithumbUserTransaction::isBuyOrSell)\n             .map(transaction -> adaptUserTrade(transaction, currencyPair))\n             .collect(Collectors.toList());\n     return new UserTrades(userTrades, Trades.TradeSortType.SortByTimestamp);\n   }\n \n   private static UserTrade adaptUserTrade(\n-      BithumbTransaction bithumbTransaction, CurrencyPair currencyPair) {\n+      BithumbUserTransactionResponse.BithumbUserTransaction bithumbTransaction,\n+      CurrencyPair currencyPair) {\n \n-    final String units = StringUtils.remove(bithumbTransaction.getUnits(), ' ');", "originalCommit": "950b4793976fc7fc304a9d3df9fa961122566099", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY2MTMyNA==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r393661324", "bodyText": "good point, check moved to BithumbUserTransaction()", "author": "mdvx", "createdAt": "2020-03-17T13:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3MTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3NDMxNg==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r393374316", "bodyText": "to me this looks worse then the previous code\nif BithumbResponse changes then a lot of classes will get affected because they now must override its constructor\nthen name of the class  its self suggests that details for one order will be returned", "author": "walec51", "createdAt": "2020-03-16T23:56:39Z", "path": "xchange-bithumb/src/main/java/org/knowm/xchange/bithumb/dto/account/BithumbOrderDetailResponse.java", "diffHunk": "@@ -0,0 +1,208 @@\n+package org.knowm.xchange.bithumb.dto.account;\n+\n+import com.fasterxml.jackson.annotation.JsonAnySetter;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import org.knowm.xchange.bithumb.BithumbAdapters;\n+import org.knowm.xchange.bithumb.dto.BithumbResponse;\n+\n+import java.math.BigDecimal;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class BithumbOrderDetailResponse\n+    extends BithumbResponse<List<BithumbOrderDetailResponse.BithumbOrderDetail>> {\n+\n+  public BithumbOrderDetailResponse(\n+      @JsonProperty(\"status\") String status,\n+      @JsonProperty(\"message\") String message,\n+      @JsonProperty(\"data\") List<BithumbOrderDetailResponse.BithumbOrderDetail> data) {\n+    super(status, message, data);\n+  }", "originalCommit": "950b4793976fc7fc304a9d3df9fa961122566099", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3NTUxMA==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r393375510", "bodyText": "if this does not have the data field then it should not extend from BithumbResponse\nbesides it this now does not return a list of trades then there is no sense in calling it a Trade response", "author": "walec51", "createdAt": "2020-03-17T00:01:16Z", "path": "xchange-bithumb/src/main/java/org/knowm/xchange/bithumb/dto/trade/BithumbTradeResponse.java", "diffHunk": "@@ -1,82 +1,21 @@\n package org.knowm.xchange.bithumb.dto.trade;\n \n import com.fasterxml.jackson.annotation.JsonProperty;\n-import java.math.BigDecimal;\n-import java.util.List;\n import org.knowm.xchange.bithumb.dto.BithumbResponse;\n \n-public class BithumbTradeResponse extends BithumbResponse<List<BithumbTradeResponse.BithumbTrade>> {\n+public class BithumbTradeResponse extends BithumbResponse {", "originalCommit": "950b4793976fc7fc304a9d3df9fa961122566099", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY2NzQ2OQ==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r393667469", "bodyText": "This is only used to return the orderId of newly placed orders, so it is the REST response to place, marketBuy, marketsell.\nI have removed dependency on BithumbResponse", "author": "mdvx", "createdAt": "2020-03-17T13:12:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3NTUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3NjQ4Mg==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r393376482", "bodyText": "silent errors are pure evil\nuse Jackson annotations to parse make it parse the date in the desired format", "author": "walec51", "createdAt": "2020-03-17T00:05:12Z", "path": "xchange-bithumb/src/main/java/org/knowm/xchange/bithumb/dto/marketdata/BithumbTransactionHistoryResponse.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package org.knowm.xchange.bithumb.dto.marketdata;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import org.apache.commons.lang3.time.FastDateFormat;\n+import org.knowm.xchange.bithumb.BithumbAdapters;\n+import org.knowm.xchange.bithumb.dto.BithumbResponse;\n+\n+import java.math.BigDecimal;\n+import java.text.ParseException;\n+import java.util.Date;\n+import java.util.List;\n+\n+public class BithumbTransactionHistoryResponse\n+    extends BithumbResponse<List<BithumbTransactionHistoryResponse.BithumbTransactionHistory>> {\n+  public static final FastDateFormat TRANSACTION_DATE_FORMAT =\n+      FastDateFormat.getInstance(\"yyyy-MM-dd HH:mm:ss\");\n+\n+  public BithumbTransactionHistoryResponse(\n+      @JsonProperty(\"status\") String status,\n+      @JsonProperty(\"message\") String message,\n+      @JsonProperty(\"data\") List<BithumbTransactionHistory> data) {\n+    super(status, message, data);\n+  }\n+\n+  public static class BithumbTransactionHistory {\n+    private final String transactionDate;\n+    private final BithumbAdapters.OrderType type;\n+    private final BigDecimal unitsTraded;\n+    private final BigDecimal price;\n+    private final BigDecimal total;\n+\n+    public BithumbTransactionHistory(\n+        @JsonProperty(\"transaction_date\") String transactionDate,\n+        @JsonProperty(\"type\") BithumbAdapters.OrderType type,\n+        @JsonProperty(\"units_traded\") BigDecimal unitsTraded,\n+        @JsonProperty(\"price\") BigDecimal price,\n+        @JsonProperty(\"total\") BigDecimal total) {\n+      this.transactionDate = transactionDate;\n+      this.type = type;\n+      this.unitsTraded = unitsTraded;\n+      this.price = price;\n+      this.total = total;\n+    }\n+\n+    public String getTransactionDate() {\n+      return transactionDate;\n+    }\n+\n+    public BithumbAdapters.OrderType getType() {\n+      return type;\n+    }\n+\n+    public BigDecimal getUnitsTraded() {\n+      return unitsTraded;\n+    }\n+\n+    public BigDecimal getPrice() {\n+      return price;\n+    }\n+\n+    public BigDecimal getTotal() {\n+      return total;\n+    }\n+\n+    public Date getTimestamp() {\n+      try {\n+        return TRANSACTION_DATE_FORMAT.parse(transactionDate);\n+      } catch (ParseException e) {\n+        return null;", "originalCommit": "950b4793976fc7fc304a9d3df9fa961122566099", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3Njk3Mg==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r393376972", "bodyText": "those inner classes make reading all of this much worse", "author": "walec51", "createdAt": "2020-03-17T00:06:50Z", "path": "xchange-bithumb/src/main/java/org/knowm/xchange/bithumb/service/BithumbMarketDataServiceRaw.java", "diffHunk": "@@ -34,10 +35,10 @@ public BithumbOrderbook getBithumbOrderBook(CurrencyPair currencyPair) throws IO\n     return orderbook.getData();\n   }\n \n-  public List<BithumbTransactionHistory> getBithumbTrades(CurrencyPair currencyPair)\n-      throws IOException {\n-    final BithumbResponse<List<BithumbTransactionHistory>> transactionHistory =\n-        bithumb.transactionHistory(BithumbUtils.getBaseCurrency(currencyPair));\n+  public List<BithumbTransactionHistoryResponse.BithumbTransactionHistory> getBithumbTrades(\n+      CurrencyPair currencyPair) throws IOException {\n+    final BithumbResponse<List<BithumbTransactionHistoryResponse.BithumbTransactionHistory>>", "originalCommit": "950b4793976fc7fc304a9d3df9fa961122566099", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3ODk4MQ==", "url": "https://github.com/knowm/XChange/pull/3452#discussion_r393378981", "bodyText": "silent errors are pure evil\nIOException  should be thrown out", "author": "walec51", "createdAt": "2020-03-17T00:15:22Z", "path": "xchange-bithumb/src/main/java/org/knowm/xchange/bithumb/service/BithumbTradeService.java", "diffHunk": "@@ -89,12 +100,36 @@ public UserTrades getTradeHistory(TradeHistoryParams params) throws IOException\n             .map(p -> ((TradeHistoryParamCurrencyPair) p).getCurrencyPair())\n             .orElse(null);\n     try {\n-      return BithumbAdapters.adaptUserTrades(bithumbTransactions(currencyPair), currencyPair);\n+      return BithumbAdapters.adaptUserTrades(\n+          getBithumbUserTransactions(currencyPair).getData(), currencyPair);\n     } catch (BithumbException e) {\n       throw BithumbErrorAdapter.adapt(e);\n     }\n   }\n \n+  @Override\n+  public Collection<Order> getOrder(OrderQueryParams... orderQueryParams) throws IOException {\n+    /* This only works for executed orders */\n+    return Arrays.stream(orderQueryParams)\n+        .filter(oq -> oq instanceof OrderQueryParamCurrencyPair)\n+        .map(oq -> (OrderQueryParamCurrencyPair) oq)\n+        .flatMap(\n+            oq -> {\n+              try {\n+                return getBithumbOrderDetail(oq.getOrderId(), oq.getCurrencyPair()).getData()\n+                    .stream()\n+                    .map(detail -> BithumbAdapters.adaptOrderDetail(detail, oq.getOrderId()));\n+\n+              } catch (IOException e) {\n+                return null;", "originalCommit": "950b4793976fc7fc304a9d3df9fa961122566099", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b9cfa727ebabddbdf249d49a5ce19a700608d42f", "url": "https://github.com/knowm/XChange/commit/b9cfa727ebabddbdf249d49a5ce19a700608d42f", "message": "Bithumb API Changes Fixes #4 - Response classes where really for unit tests - removed", "committedDate": "2020-03-17T14:22:24Z", "type": "commit"}, {"oid": "088757cb3441b613f7fd548b89f9f8709a889155", "url": "https://github.com/knowm/XChange/commit/088757cb3441b613f7fd548b89f9f8709a889155", "message": "Bithumb API Changes Fixes #4 - Wrap IOException", "committedDate": "2020-03-17T14:24:52Z", "type": "commit"}, {"oid": "09f8d2e7be243b028f13d4952912abc4688a23a8", "url": "https://github.com/knowm/XChange/commit/09f8d2e7be243b028f13d4952912abc4688a23a8", "message": "Bithumb API Changes Fixes #2 - Unit Test 2 fixed\n\nBithumb API Changes Fixes #2 - Unit Test fixed\n\nBithumb API Changes Fixes #2 - cleanup 2", "committedDate": "2020-03-17T14:30:23Z", "type": "commit"}, {"oid": "250aa5006af6ac48004139f34c65ee98350c0442", "url": "https://github.com/knowm/XChange/commit/250aa5006af6ac48004139f34c65ee98350c0442", "message": "Missed unit test change\n\nBithumb API Changes Fixes #3 - Transactions vs UserTransactions - OrderDetails - updated UnitTests", "committedDate": "2020-03-17T14:30:24Z", "type": "commit"}, {"oid": "a3e413b112ec00174cde711fde78377beea61776", "url": "https://github.com/knowm/XChange/commit/a3e413b112ec00174cde711fde78377beea61776", "message": "Bithumb API Changes Fixes #4 - Wrap IOException\n\nBithumb API Changes Fixes #4 - Response classes where really for unit tests - removed", "committedDate": "2020-03-17T14:30:25Z", "type": "commit"}, {"oid": "b6dcc4c922f3851889f75b90da03ee85c95ed40b", "url": "https://github.com/knowm/XChange/commit/b6dcc4c922f3851889f75b90da03ee85c95ed40b", "message": "Merge remote-tracking branch 'origin/develop' into develop", "committedDate": "2020-03-17T14:31:12Z", "type": "commit"}, {"oid": "88ef976b13e135351ee2204653634cf2bf515b8c", "url": "https://github.com/knowm/XChange/commit/88ef976b13e135351ee2204653634cf2bf515b8c", "message": "Bithumb API Changes Fixes #5 - OrderDetail doc is wrong", "committedDate": "2020-03-17T16:14:25Z", "type": "commit"}, {"oid": "7c8be0933bfe7c36bceb3754c0aae997e7855636", "url": "https://github.com/knowm/XChange/commit/7c8be0933bfe7c36bceb3754c0aae997e7855636", "message": "Bithumb API Changes Fixes #5 - OrderDetail doc is wrong #2\nadaptOrderDetail averagePrice div/0 fix\n\nBithumb API Changes Fixes #5 - OrderDetail doc is wrong", "committedDate": "2020-03-17T16:46:24Z", "type": "commit"}, {"oid": "e04f9a6b3121250295b189fed2ba2edc492c16f4", "url": "https://github.com/knowm/XChange/commit/e04f9a6b3121250295b189fed2ba2edc492c16f4", "message": "Merge branch 'develop' of https://github.com/mainbloq/XChange into develop", "committedDate": "2020-03-17T16:46:50Z", "type": "commit"}, {"oid": "b463c4ac51eb162f5787766e26f158440a972522", "url": "https://github.com/knowm/XChange/commit/b463c4ac51eb162f5787766e26f158440a972522", "message": "extra support for cancelOrder\n\norderParams instanceof CancelOrderByIdParams && orderParams instanceof CancelOrderByCurrencyPair\n\none more order_status", "committedDate": "2020-03-17T17:49:17Z", "type": "commit"}]}