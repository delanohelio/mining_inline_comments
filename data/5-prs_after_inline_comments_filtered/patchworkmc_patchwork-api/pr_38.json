{"pr_number": 38, "pr_title": "Implement WorldEvent", "pr_createdAt": "2020-01-26T06:18:07Z", "pr_url": "https://github.com/PatchworkMC/patchwork-api/pull/38", "timeline": [{"oid": "b23d090c78d333245747845f61b18e2fd5d5ea9a", "url": "https://github.com/PatchworkMC/patchwork-api/commit/b23d090c78d333245747845f61b18e2fd5d5ea9a", "message": "Implement WorldEvent.\n\nThis also includes the following nested derived events:\n - WorldEvent.Load\n - WorldEvent.Unload\n - WorldEvent.Save\n - WorldEvent.PotentialSpawns\n - WorldEvent.CreateSpawnPosition", "committedDate": "2020-01-26T06:16:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjQ5MA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r370976490", "bodyText": "Perhaps instead of a seperate interface, this should be an interface mixin + @Accessor? probably definately. (i'm still learning new things about mixins)", "author": "kitlith", "createdAt": "2020-01-26T06:23:37Z", "path": "patchwork-events-world/src/main/java/com/patchworkmc/impl/event/world/IGetWorldFromChunkGenerator.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2019, 2019\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package com.patchworkmc.impl.event.world;\n+\n+import net.minecraft.world.IWorld;\n+\n+public interface IGetWorldFromChunkGenerator {\n+\tIWorld getWorld();", "originalCommit": "b23d090c78d333245747845f61b18e2fd5d5ea9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjU2Nw==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r370976567", "bodyText": "is this <clinit> instead of <init>? probably needs fixing.", "author": "kitlith", "createdAt": "2020-01-26T06:26:13Z", "path": "patchwork-events-world/src/main/java/com/patchworkmc/mixin/event/world/MixinClientWorld.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2019, 2019\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package com.patchworkmc.mixin.event.world;\n+\n+import java.util.function.BiFunction;\n+\n+import net.minecraftforge.common.MinecraftForge;\n+import net.minecraftforge.event.world.WorldEvent;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n+\n+import net.minecraft.util.profiler.Profiler;\n+import net.minecraft.world.chunk.ChunkManager;\n+import net.minecraft.world.dimension.Dimension;\n+import net.minecraft.world.dimension.DimensionType;\n+import net.minecraft.world.level.LevelProperties;\n+import net.minecraft.world.World;\n+import net.minecraft.client.world.ClientWorld;\n+\n+@Mixin(ClientWorld.class)\n+public abstract class MixinClientWorld extends World {\n+\tprotected MixinClientWorld(LevelProperties levelProperties, DimensionType dimensionType, BiFunction<World, Dimension, ChunkManager> chunkManagerProvider, Profiler profiler, boolean isClient) {\n+\t\tsuper(levelProperties, dimensionType, chunkManagerProvider, profiler, isClient);\n+\t}\n+\n+\t@Inject(method = \"<init>\", at = @At(value = \"TAIL\"))", "originalCommit": "b23d090c78d333245747845f61b18e2fd5d5ea9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NzE5OQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r370977199", "bodyText": "nope,  is for static members and such, i want the instance constructor.", "author": "kitlith", "createdAt": "2020-01-26T06:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjcwNA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r370976704", "bodyText": "There are two implementations here. I like the latter better since I don't need to specify the types of a lot of stuff, but i'll leave the final decision up to you guys. will remove whichever isn't used before merging.", "author": "kitlith", "createdAt": "2020-01-26T06:30:12Z", "path": "patchwork-events-world/src/main/java/com/patchworkmc/mixin/event/world/MixinMinecraftServer.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2019, 2019\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package com.patchworkmc.mixin.event.world;\n+\n+import java.io.IOException;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import net.minecraftforge.common.MinecraftForge;\n+import net.minecraftforge.event.world.WorldEvent;\n+import org.spongepowered.asm.mixin.Final;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import net.minecraft.server.MinecraftServer;\n+import net.minecraft.server.ServerTask;\n+import net.minecraft.server.world.ServerWorld;\n+import net.minecraft.util.NonBlockingThreadExecutor;\n+import net.minecraft.world.dimension.DimensionType;\n+\n+@Mixin(MinecraftServer.class)\n+public abstract class MixinMinecraftServer extends NonBlockingThreadExecutor<ServerTask> {\n+\tpublic MixinMinecraftServer(String name) {\n+\t\tsuper(name);\n+\t}\n+\n+\t@Shadow\n+\t@Final\n+\tprivate Map<DimensionType, ServerWorld> worlds;\n+\n+\t// Should get called once per loop, regardless of which if branch it takes.\n+\t//\t@Inject(\n+\t//\t\tmethod = \"createWorlds\",\n+\t//\t\tslice = @Slice(\n+\t//\t\t\tfrom = @At(value = \"INVOKE\", target = \"java/util/Iterator.hasNext ()Z\")\n+\t//\t\t),\n+\t//\t\tat = @At(value = \"JUMP\", opcode = Opcodes.GOTO),\n+\t//\t\tlocals = LocalCapture.CAPTURE_FAILHARD\n+\t//\t)\n+\t//\tprivate void hookCreateWorlds(WorldSaveHandler worldSaveHandler, LevelProperties properties, LevelInfo levelInfo, WorldGenerationProgressListener worldGenerationProgressListener, CallbackInfo ci, ServerWorld serverWorld, ServerWorld serverWorld2, Iterator var7, DimensionType dimensionType) {\n+\t//\t\tMinecraftForge.EVENT_BUS.post(new WorldEvent.Load(this.worlds.get(dimensionType)));\n+\t//\t}\n+\n+\t// Alternatively, mixin to the put call, and special case overworld.\n+\t// Perhaps move the special case outside of the loop?", "originalCommit": "b23d090c78d333245747845f61b18e2fd5d5ea9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxNTYyOQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373315629", "bodyText": "I trust the Redirects more as far as not breaking with updates, but I trust the Inject more with not breaking with mods. I think we can keep the Inject version commented out with an appropriate comment, and of course using /* instead of a // on each line.", "author": "coderbot16", "createdAt": "2020-01-31T04:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjcwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM0NDk4Ng==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373344986", "bodyText": "if it weren't for having to grab every single local in there, i still think the inject variant is not bad. Ah well...", "author": "kitlith", "createdAt": "2020-01-31T07:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3Njc3MQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r370976771", "bodyText": "lmk if these mixins should be removed, i figured they'd be useful in the future and i ended up implementing them anyway.", "author": "kitlith", "createdAt": "2020-01-26T06:31:37Z", "path": "patchwork-events-world/src/main/java/com/patchworkmc/mixin/event/world/MixinMinecraftServer.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2019, 2019\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package com.patchworkmc.mixin.event.world;\n+\n+import java.io.IOException;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import net.minecraftforge.common.MinecraftForge;\n+import net.minecraftforge.event.world.WorldEvent;\n+import org.spongepowered.asm.mixin.Final;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import net.minecraft.server.MinecraftServer;\n+import net.minecraft.server.ServerTask;\n+import net.minecraft.server.world.ServerWorld;\n+import net.minecraft.util.NonBlockingThreadExecutor;\n+import net.minecraft.world.dimension.DimensionType;\n+\n+@Mixin(MinecraftServer.class)\n+public abstract class MixinMinecraftServer extends NonBlockingThreadExecutor<ServerTask> {\n+\tpublic MixinMinecraftServer(String name) {\n+\t\tsuper(name);\n+\t}\n+\n+\t@Shadow\n+\t@Final\n+\tprivate Map<DimensionType, ServerWorld> worlds;\n+\n+\t// Should get called once per loop, regardless of which if branch it takes.\n+\t//\t@Inject(\n+\t//\t\tmethod = \"createWorlds\",\n+\t//\t\tslice = @Slice(\n+\t//\t\t\tfrom = @At(value = \"INVOKE\", target = \"java/util/Iterator.hasNext ()Z\")\n+\t//\t\t),\n+\t//\t\tat = @At(value = \"JUMP\", opcode = Opcodes.GOTO),\n+\t//\t\tlocals = LocalCapture.CAPTURE_FAILHARD\n+\t//\t)\n+\t//\tprivate void hookCreateWorlds(WorldSaveHandler worldSaveHandler, LevelProperties properties, LevelInfo levelInfo, WorldGenerationProgressListener worldGenerationProgressListener, CallbackInfo ci, ServerWorld serverWorld, ServerWorld serverWorld2, Iterator var7, DimensionType dimensionType) {\n+\t//\t\tMinecraftForge.EVENT_BUS.post(new WorldEvent.Load(this.worlds.get(dimensionType)));\n+\t//\t}\n+\n+\t// Alternatively, mixin to the put call, and special case overworld.\n+\t// Perhaps move the special case outside of the loop?\n+\t@Redirect(method = \"createWorlds\", at = @At(value = \"INVOKE\", target = \"java/util/Iterator.next ()Ljava/lang/Object;\"))\n+\tprivate Object proxyNextWorldToSpecialCaseOverworld(Iterator iterator) {\n+\t\tDimensionType type = (DimensionType) iterator.next();\n+\n+\t\tif (type == DimensionType.OVERWORLD) {\n+\t\t\tMinecraftForge.EVENT_BUS.post(new WorldEvent.Load(this.worlds.get(type)));\n+\t\t}\n+\n+\t\treturn type;\n+\t}\n+\n+\t@Redirect(method = \"createWorlds\", at = @At(value = \"INVOKE\", target = \"java/util/Map.put (Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;\", ordinal = 1))\n+\tprivate Object proxyPutWorld(Map worlds, Object type, Object world) {\n+\t\tworlds.put(type, world);\n+\t\tMinecraftForge.EVENT_BUS.post(new WorldEvent.Load((ServerWorld) world));\n+\t\treturn world;\n+\t}\n+\n+\t// TODO: Should we Inject into ServerWorld.close instead? Currently, this follows Forge's patch location.\n+\t@Redirect(method = \"shutdown\", at = @At(value = \"INVOKE\", target = \"net/minecraft/server/world/ServerWorld.close ()V\"))\n+\tprivate void proxyClose(ServerWorld world) throws IOException {\n+\t\tMinecraftForge.EVENT_BUS.post(new WorldEvent.Unload(world));\n+\t\tworld.close();\n+\t}\n+\n+\t@Shadow\n+\tprivate int ticks;\n+\n+\t// TODO: DimensionManager, and move this into a seperate module", "originalCommit": "b23d090c78d333245747845f61b18e2fd5d5ea9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxNDMwOA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373314308", "bodyText": "I think these should be wrapped with /* instead of // comments, otherwise I guess they can stay for now.", "author": "coderbot16", "createdAt": "2020-01-31T04:44:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3Njc3MQ=="}], "type": "inlineReview"}, {"oid": "75a81950af2ae8e372d3457653d719b4cf46ea44", "url": "https://github.com/PatchworkMC/patchwork-api/commit/75a81950af2ae8e372d3457653d719b4cf46ea44", "message": "Fix license headers.", "committedDate": "2020-01-26T06:37:21Z", "type": "commit"}, {"oid": "c2a5e23f5583be9417d47ab40a6cc792b70b6613", "url": "https://github.com/PatchworkMC/patchwork-api/commit/c2a5e23f5583be9417d47ab40a6cc792b70b6613", "message": "Use an accessor mixin instead of a seperate interface.", "committedDate": "2020-01-26T06:57:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxMzA0NA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373313044", "bodyText": "This may be more descriptive.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tprivate void hookConstructor(CallbackInfo info) {\n          \n          \n            \n            \tprivate void postConstruct(CallbackInfo info) {", "author": "coderbot16", "createdAt": "2020-01-31T04:37:49Z", "path": "patchwork-events-world/src/main/java/com/patchworkmc/mixin/event/world/MixinClientWorld.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package com.patchworkmc.mixin.event.world;\n+\n+import java.util.function.BiFunction;\n+\n+import net.minecraftforge.common.MinecraftForge;\n+import net.minecraftforge.event.world.WorldEvent;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n+\n+import net.minecraft.util.profiler.Profiler;\n+import net.minecraft.world.chunk.ChunkManager;\n+import net.minecraft.world.dimension.Dimension;\n+import net.minecraft.world.dimension.DimensionType;\n+import net.minecraft.world.level.LevelProperties;\n+import net.minecraft.world.World;\n+import net.minecraft.client.world.ClientWorld;\n+\n+@Mixin(ClientWorld.class)\n+public abstract class MixinClientWorld extends World {\n+\tprotected MixinClientWorld(LevelProperties levelProperties, DimensionType dimensionType, BiFunction<World, Dimension, ChunkManager> chunkManagerProvider, Profiler profiler, boolean isClient) {\n+\t\tsuper(levelProperties, dimensionType, chunkManagerProvider, profiler, isClient);\n+\t}\n+\n+\t@Inject(method = \"<init>\", at = @At(value = \"TAIL\"))\n+\tprivate void hookConstructor(CallbackInfo info) {", "originalCommit": "c2a5e23f5583be9417d47ab40a6cc792b70b6613", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxMzEyNQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373313125", "bodyText": "Perhaps we should dispatch all of these events within WorldEvents?", "author": "coderbot16", "createdAt": "2020-01-31T04:38:14Z", "path": "patchwork-events-world/src/main/java/com/patchworkmc/mixin/event/world/MixinClientWorld.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package com.patchworkmc.mixin.event.world;\n+\n+import java.util.function.BiFunction;\n+\n+import net.minecraftforge.common.MinecraftForge;\n+import net.minecraftforge.event.world.WorldEvent;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n+\n+import net.minecraft.util.profiler.Profiler;\n+import net.minecraft.world.chunk.ChunkManager;\n+import net.minecraft.world.dimension.Dimension;\n+import net.minecraft.world.dimension.DimensionType;\n+import net.minecraft.world.level.LevelProperties;\n+import net.minecraft.world.World;\n+import net.minecraft.client.world.ClientWorld;\n+\n+@Mixin(ClientWorld.class)\n+public abstract class MixinClientWorld extends World {\n+\tprotected MixinClientWorld(LevelProperties levelProperties, DimensionType dimensionType, BiFunction<World, Dimension, ChunkManager> chunkManagerProvider, Profiler profiler, boolean isClient) {\n+\t\tsuper(levelProperties, dimensionType, chunkManagerProvider, profiler, isClient);\n+\t}\n+\n+\t@Inject(method = \"<init>\", at = @At(value = \"TAIL\"))\n+\tprivate void hookConstructor(CallbackInfo info) {\n+\t\tClientWorld world = (ClientWorld) (Object) this;\n+\t\tMinecraftForge.EVENT_BUS.post(new WorldEvent.Load(world));", "originalCommit": "c2a5e23f5583be9417d47ab40a6cc792b70b6613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM0MDQ3NQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373340475", "bodyText": "IIRC I mirrored what forge did here. Can totally do that.", "author": "kitlith", "createdAt": "2020-01-31T07:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxMzEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxMzM0MA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373313340", "bodyText": "No separation between doc comments and the class.\n\n  \n    \n      \n        Suggested change", "author": "coderbot16", "createdAt": "2020-01-31T04:39:35Z", "path": "patchwork-events-world/src/main/java/net/minecraftforge/event/world/WorldEvent.java", "diffHunk": "@@ -0,0 +1,198 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.event.world;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Random;\n+\n+import net.minecraftforge.eventbus.api.Event;\n+import net.minecraftforge.common.MinecraftForge;\n+\n+import net.minecraft.client.MinecraftClient;\n+import net.minecraft.client.network.ClientPlayNetworkHandler;\n+import net.minecraft.client.render.WorldRenderer;\n+import net.minecraft.client.world.ClientWorld;\n+import net.minecraft.entity.EntityCategory;\n+import net.minecraft.server.WorldGenerationProgressListener;\n+import net.minecraft.server.world.ServerWorld;\n+import net.minecraft.util.ProgressListener;\n+import net.minecraft.util.profiler.Profiler;\n+import net.minecraft.server.MinecraftServer;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.world.IWorld;\n+import net.minecraft.world.SpawnHelper;\n+import net.minecraft.world.WorldSaveHandler;\n+import net.minecraft.world.gen.chunk.ChunkGenerator;\n+import net.minecraft.world.level.LevelInfo;\n+import net.minecraft.world.biome.Biome.SpawnEntry;\n+import net.minecraft.world.dimension.DimensionType;\n+import net.minecraft.world.level.LevelProperties;\n+\n+/**\n+ * WorldEvent is fired when an event involving the world occurs.\n+ *\n+ * <p>If a method utilizes this {@link Event} as its parameter, the method will\n+ * receive every child event of this class.</p>\n+ *\n+ * <p>{@link #world} contains the World this event is occurring in.</p>\n+ *\n+ * <p>All children of this event are fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+ */\n+public class WorldEvent extends Event {\n+\tprivate final IWorld world;\n+\n+\t// For EventBus\n+\tpublic WorldEvent() {\n+\t\tthis.world = null;\n+\t}\n+\n+\tpublic WorldEvent(IWorld world) {\n+\t\tthis.world = world;\n+\t}\n+\n+\tpublic IWorld getWorld() {\n+\t\treturn world;\n+\t}\n+\n+\t/**\n+\t * WorldEvent.Load is fired when Minecraft loads a world.\n+\t *\n+\t * <p>This event is fired when a world is loaded in\n+\t * {@link ClientWorld#ClientWorld(ClientPlayNetworkHandler, LevelInfo, DimensionType, int, Profiler, WorldRenderer)},\n+\t * {@link MinecraftServer#createWorlds(WorldSaveHandler, LevelProperties, LevelInfo, WorldGenerationProgressListener)},\n+\t * TODO: {@link DimensionManager#initDimension(int)}</p>\n+\t *\n+\t * <p>This event is not Cancelable.</p>\n+\t *\n+\t * <p>This event does not have a result.</p>\n+\t *\n+\t * <p>This event is fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+\t */\n+\tpublic static class Load extends WorldEvent {\n+\t\tpublic Load(IWorld world) {\n+\t\t\tsuper(world);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * WorldEvent.Unload is fired when Minecraft unloads a world.\n+\t *\n+\t * <p>This event is fired when a world is unloaded in\n+\t * {@link MinecraftClient#joinWorld(ClientWorld)},\n+\t * {@link MinecraftClient#disconnect()},\n+\t * {@link MinecraftServer#shutdown()},\n+\t * TODO: {@link DimensionManager#unloadWorlds()}</p>\n+\t *\n+\t * <p>This event is not Cancelable.</p>\n+\t *\n+\t * <p>This event does not have a result.</p>\n+\t *\n+\t * <p>This event is fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+\t */\n+\tpublic static class Unload extends WorldEvent {\n+\t\tpublic Unload(IWorld world) {\n+\t\t\tsuper(world);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * WorldEvent.Save is fired when Minecraft saves a world.\n+\t *\n+\t * <p>This event is fired when a world is saved in\n+\t * {@link ServerWorld#save(ProgressListener, boolean, boolean)}.</p>\n+\t *\n+\t * <p>This event is not Cancelable.</p>\n+\t *\n+\t * <p>This event does not have a result.</p>\n+\t *\n+\t * <p>This event is fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+\t */\n+\tpublic static class Save extends WorldEvent {\n+\t\tpublic Save(IWorld world) {\n+\t\t\tsuper(world);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Called by ServerWorld to gather a list of all possible entities that can spawn at the specified location.\n+\t * If an entry is added to the list, it needs to be a globally unique instance.\n+\t * The event is called in {@link SpawnHelper#method_8664(ChunkGenerator, EntityCategory, Random, BlockPos)} as well as\n+\t * {@link SpawnHelper#method_8659(ChunkGenerator, EntityCategory, SpawnEntry, BlockPos)}\n+\t * where the latter checks for identity, meaning both events must add the same instance.\n+\t * Canceling the event will result in a empty list, meaning no entity will be spawned.\n+\t */\n+\tpublic static class PotentialSpawns extends WorldEvent {\n+\t\tprivate final EntityCategory type;\n+\t\tprivate final BlockPos pos;\n+\t\tprivate final List<SpawnEntry> list;\n+\n+\t\tpublic PotentialSpawns(IWorld world, EntityCategory type, BlockPos pos, List<SpawnEntry> oldList) {\n+\t\t\tsuper(world);\n+\t\t\tthis.pos = pos;\n+\t\t\tthis.type = type;\n+\n+\t\t\tif (oldList != null) {\n+\t\t\t\tthis.list = new ArrayList<SpawnEntry>(oldList);\n+\t\t\t} else {\n+\t\t\t\tthis.list = new ArrayList<SpawnEntry>();\n+\t\t\t}\n+\t\t}\n+\n+\t\tpublic EntityCategory getType() {\n+\t\t\treturn type;\n+\t\t}\n+\n+\t\tpublic BlockPos getPos() {\n+\t\t\treturn pos;\n+\t\t}\n+\n+\t\tpublic List<SpawnEntry> getList() {\n+\t\t\treturn list;\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic boolean isCancelable() {\n+\t\t\treturn true;\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Called by ServerWorld when it attempts to create a spawnpoint for a dimension.\n+\t * Canceling the event will prevent the vanilla code from running.\n+\t */\n+", "originalCommit": "c2a5e23f5583be9417d47ab40a6cc792b70b6613", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxMzQ1MA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373313450", "bodyText": "Same for the other lines\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * <p>This event is not Cancelable.</p>\n          \n          \n            \n            \t * <p>This event is not cancellable.</p>", "author": "coderbot16", "createdAt": "2020-01-31T04:40:27Z", "path": "patchwork-events-world/src/main/java/net/minecraftforge/event/world/WorldEvent.java", "diffHunk": "@@ -0,0 +1,198 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.event.world;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Random;\n+\n+import net.minecraftforge.eventbus.api.Event;\n+import net.minecraftforge.common.MinecraftForge;\n+\n+import net.minecraft.client.MinecraftClient;\n+import net.minecraft.client.network.ClientPlayNetworkHandler;\n+import net.minecraft.client.render.WorldRenderer;\n+import net.minecraft.client.world.ClientWorld;\n+import net.minecraft.entity.EntityCategory;\n+import net.minecraft.server.WorldGenerationProgressListener;\n+import net.minecraft.server.world.ServerWorld;\n+import net.minecraft.util.ProgressListener;\n+import net.minecraft.util.profiler.Profiler;\n+import net.minecraft.server.MinecraftServer;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.world.IWorld;\n+import net.minecraft.world.SpawnHelper;\n+import net.minecraft.world.WorldSaveHandler;\n+import net.minecraft.world.gen.chunk.ChunkGenerator;\n+import net.minecraft.world.level.LevelInfo;\n+import net.minecraft.world.biome.Biome.SpawnEntry;\n+import net.minecraft.world.dimension.DimensionType;\n+import net.minecraft.world.level.LevelProperties;\n+\n+/**\n+ * WorldEvent is fired when an event involving the world occurs.\n+ *\n+ * <p>If a method utilizes this {@link Event} as its parameter, the method will\n+ * receive every child event of this class.</p>\n+ *\n+ * <p>{@link #world} contains the World this event is occurring in.</p>\n+ *\n+ * <p>All children of this event are fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+ */\n+public class WorldEvent extends Event {\n+\tprivate final IWorld world;\n+\n+\t// For EventBus\n+\tpublic WorldEvent() {\n+\t\tthis.world = null;\n+\t}\n+\n+\tpublic WorldEvent(IWorld world) {\n+\t\tthis.world = world;\n+\t}\n+\n+\tpublic IWorld getWorld() {\n+\t\treturn world;\n+\t}\n+\n+\t/**\n+\t * WorldEvent.Load is fired when Minecraft loads a world.\n+\t *\n+\t * <p>This event is fired when a world is loaded in\n+\t * {@link ClientWorld#ClientWorld(ClientPlayNetworkHandler, LevelInfo, DimensionType, int, Profiler, WorldRenderer)},\n+\t * {@link MinecraftServer#createWorlds(WorldSaveHandler, LevelProperties, LevelInfo, WorldGenerationProgressListener)},\n+\t * TODO: {@link DimensionManager#initDimension(int)}</p>\n+\t *\n+\t * <p>This event is not Cancelable.</p>", "originalCommit": "c2a5e23f5583be9417d47ab40a6cc792b70b6613", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxMzY0OA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373313648", "bodyText": "Should probably have a {@link ServerWorld}", "author": "coderbot16", "createdAt": "2020-01-31T04:40:57Z", "path": "patchwork-events-world/src/main/java/net/minecraftforge/event/world/WorldEvent.java", "diffHunk": "@@ -0,0 +1,198 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.event.world;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Random;\n+\n+import net.minecraftforge.eventbus.api.Event;\n+import net.minecraftforge.common.MinecraftForge;\n+\n+import net.minecraft.client.MinecraftClient;\n+import net.minecraft.client.network.ClientPlayNetworkHandler;\n+import net.minecraft.client.render.WorldRenderer;\n+import net.minecraft.client.world.ClientWorld;\n+import net.minecraft.entity.EntityCategory;\n+import net.minecraft.server.WorldGenerationProgressListener;\n+import net.minecraft.server.world.ServerWorld;\n+import net.minecraft.util.ProgressListener;\n+import net.minecraft.util.profiler.Profiler;\n+import net.minecraft.server.MinecraftServer;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.world.IWorld;\n+import net.minecraft.world.SpawnHelper;\n+import net.minecraft.world.WorldSaveHandler;\n+import net.minecraft.world.gen.chunk.ChunkGenerator;\n+import net.minecraft.world.level.LevelInfo;\n+import net.minecraft.world.biome.Biome.SpawnEntry;\n+import net.minecraft.world.dimension.DimensionType;\n+import net.minecraft.world.level.LevelProperties;\n+\n+/**\n+ * WorldEvent is fired when an event involving the world occurs.\n+ *\n+ * <p>If a method utilizes this {@link Event} as its parameter, the method will\n+ * receive every child event of this class.</p>\n+ *\n+ * <p>{@link #world} contains the World this event is occurring in.</p>\n+ *\n+ * <p>All children of this event are fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+ */\n+public class WorldEvent extends Event {\n+\tprivate final IWorld world;\n+\n+\t// For EventBus\n+\tpublic WorldEvent() {\n+\t\tthis.world = null;\n+\t}\n+\n+\tpublic WorldEvent(IWorld world) {\n+\t\tthis.world = world;\n+\t}\n+\n+\tpublic IWorld getWorld() {\n+\t\treturn world;\n+\t}\n+\n+\t/**\n+\t * WorldEvent.Load is fired when Minecraft loads a world.\n+\t *\n+\t * <p>This event is fired when a world is loaded in\n+\t * {@link ClientWorld#ClientWorld(ClientPlayNetworkHandler, LevelInfo, DimensionType, int, Profiler, WorldRenderer)},\n+\t * {@link MinecraftServer#createWorlds(WorldSaveHandler, LevelProperties, LevelInfo, WorldGenerationProgressListener)},\n+\t * TODO: {@link DimensionManager#initDimension(int)}</p>\n+\t *\n+\t * <p>This event is not Cancelable.</p>\n+\t *\n+\t * <p>This event does not have a result.</p>\n+\t *\n+\t * <p>This event is fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+\t */\n+\tpublic static class Load extends WorldEvent {\n+\t\tpublic Load(IWorld world) {\n+\t\t\tsuper(world);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * WorldEvent.Unload is fired when Minecraft unloads a world.\n+\t *\n+\t * <p>This event is fired when a world is unloaded in\n+\t * {@link MinecraftClient#joinWorld(ClientWorld)},\n+\t * {@link MinecraftClient#disconnect()},\n+\t * {@link MinecraftServer#shutdown()},\n+\t * TODO: {@link DimensionManager#unloadWorlds()}</p>\n+\t *\n+\t * <p>This event is not Cancelable.</p>\n+\t *\n+\t * <p>This event does not have a result.</p>\n+\t *\n+\t * <p>This event is fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+\t */\n+\tpublic static class Unload extends WorldEvent {\n+\t\tpublic Unload(IWorld world) {\n+\t\t\tsuper(world);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * WorldEvent.Save is fired when Minecraft saves a world.\n+\t *\n+\t * <p>This event is fired when a world is saved in\n+\t * {@link ServerWorld#save(ProgressListener, boolean, boolean)}.</p>\n+\t *\n+\t * <p>This event is not Cancelable.</p>\n+\t *\n+\t * <p>This event does not have a result.</p>\n+\t *\n+\t * <p>This event is fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+\t */\n+\tpublic static class Save extends WorldEvent {\n+\t\tpublic Save(IWorld world) {\n+\t\t\tsuper(world);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Called by ServerWorld to gather a list of all possible entities that can spawn at the specified location.", "originalCommit": "c2a5e23f5583be9417d47ab40a6cc792b70b6613", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxMzkwNw==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373313907", "bodyText": "All of these subclasses need a // For EventBus constructor, or else there will be a crash when trying to add listeners.", "author": "coderbot16", "createdAt": "2020-01-31T04:41:54Z", "path": "patchwork-events-world/src/main/java/net/minecraftforge/event/world/WorldEvent.java", "diffHunk": "@@ -0,0 +1,198 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.event.world;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Random;\n+\n+import net.minecraftforge.eventbus.api.Event;\n+import net.minecraftforge.common.MinecraftForge;\n+\n+import net.minecraft.client.MinecraftClient;\n+import net.minecraft.client.network.ClientPlayNetworkHandler;\n+import net.minecraft.client.render.WorldRenderer;\n+import net.minecraft.client.world.ClientWorld;\n+import net.minecraft.entity.EntityCategory;\n+import net.minecraft.server.WorldGenerationProgressListener;\n+import net.minecraft.server.world.ServerWorld;\n+import net.minecraft.util.ProgressListener;\n+import net.minecraft.util.profiler.Profiler;\n+import net.minecraft.server.MinecraftServer;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.world.IWorld;\n+import net.minecraft.world.SpawnHelper;\n+import net.minecraft.world.WorldSaveHandler;\n+import net.minecraft.world.gen.chunk.ChunkGenerator;\n+import net.minecraft.world.level.LevelInfo;\n+import net.minecraft.world.biome.Biome.SpawnEntry;\n+import net.minecraft.world.dimension.DimensionType;\n+import net.minecraft.world.level.LevelProperties;\n+\n+/**\n+ * WorldEvent is fired when an event involving the world occurs.\n+ *\n+ * <p>If a method utilizes this {@link Event} as its parameter, the method will\n+ * receive every child event of this class.</p>\n+ *\n+ * <p>{@link #world} contains the World this event is occurring in.</p>\n+ *\n+ * <p>All children of this event are fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+ */\n+public class WorldEvent extends Event {\n+\tprivate final IWorld world;\n+\n+\t// For EventBus\n+\tpublic WorldEvent() {\n+\t\tthis.world = null;\n+\t}\n+\n+\tpublic WorldEvent(IWorld world) {\n+\t\tthis.world = world;\n+\t}\n+\n+\tpublic IWorld getWorld() {\n+\t\treturn world;\n+\t}\n+\n+\t/**\n+\t * WorldEvent.Load is fired when Minecraft loads a world.\n+\t *\n+\t * <p>This event is fired when a world is loaded in\n+\t * {@link ClientWorld#ClientWorld(ClientPlayNetworkHandler, LevelInfo, DimensionType, int, Profiler, WorldRenderer)},\n+\t * {@link MinecraftServer#createWorlds(WorldSaveHandler, LevelProperties, LevelInfo, WorldGenerationProgressListener)},\n+\t * TODO: {@link DimensionManager#initDimension(int)}</p>\n+\t *\n+\t * <p>This event is not Cancelable.</p>\n+\t *\n+\t * <p>This event does not have a result.</p>\n+\t *\n+\t * <p>This event is fired on the {@link MinecraftForge#EVENT_BUS}.</p>\n+\t */\n+\tpublic static class Load extends WorldEvent {\n+\t\tpublic Load(IWorld world) {", "originalCommit": "c2a5e23f5583be9417d47ab40a6cc792b70b6613", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxNDQwOQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373314409", "bodyText": "I think it is good to just keep Forge's behavior here.", "author": "coderbot16", "createdAt": "2020-01-31T04:45:32Z", "path": "patchwork-events-world/src/main/java/com/patchworkmc/mixin/event/world/MixinMinecraftServer.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package com.patchworkmc.mixin.event.world;\n+\n+import java.io.IOException;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import net.minecraftforge.common.MinecraftForge;\n+import net.minecraftforge.event.world.WorldEvent;\n+import org.spongepowered.asm.mixin.Final;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import net.minecraft.server.MinecraftServer;\n+import net.minecraft.server.ServerTask;\n+import net.minecraft.server.world.ServerWorld;\n+import net.minecraft.util.NonBlockingThreadExecutor;\n+import net.minecraft.world.dimension.DimensionType;\n+\n+@Mixin(MinecraftServer.class)\n+public abstract class MixinMinecraftServer extends NonBlockingThreadExecutor<ServerTask> {\n+\tpublic MixinMinecraftServer(String name) {\n+\t\tsuper(name);\n+\t}\n+\n+\t@Shadow\n+\t@Final\n+\tprivate Map<DimensionType, ServerWorld> worlds;\n+\n+\t// Should get called once per loop, regardless of which if branch it takes.\n+\t//\t@Inject(\n+\t//\t\tmethod = \"createWorlds\",\n+\t//\t\tslice = @Slice(\n+\t//\t\t\tfrom = @At(value = \"INVOKE\", target = \"java/util/Iterator.hasNext ()Z\")\n+\t//\t\t),\n+\t//\t\tat = @At(value = \"JUMP\", opcode = Opcodes.GOTO),\n+\t//\t\tlocals = LocalCapture.CAPTURE_FAILHARD\n+\t//\t)\n+\t//\tprivate void hookCreateWorlds(WorldSaveHandler worldSaveHandler, LevelProperties properties, LevelInfo levelInfo, WorldGenerationProgressListener worldGenerationProgressListener, CallbackInfo ci, ServerWorld serverWorld, ServerWorld serverWorld2, Iterator var7, DimensionType dimensionType) {\n+\t//\t\tMinecraftForge.EVENT_BUS.post(new WorldEvent.Load(this.worlds.get(dimensionType)));\n+\t//\t}\n+\n+\t// Alternatively, mixin to the put call, and special case overworld.\n+\t// Perhaps move the special case outside of the loop?\n+\t@Redirect(method = \"createWorlds\", at = @At(value = \"INVOKE\", target = \"java/util/Iterator.next ()Ljava/lang/Object;\"))\n+\tprivate Object proxyNextWorldToSpecialCaseOverworld(Iterator iterator) {\n+\t\tDimensionType type = (DimensionType) iterator.next();\n+\n+\t\tif (type == DimensionType.OVERWORLD) {\n+\t\t\tMinecraftForge.EVENT_BUS.post(new WorldEvent.Load(this.worlds.get(type)));\n+\t\t}\n+\n+\t\treturn type;\n+\t}\n+\n+\t@Redirect(method = \"createWorlds\", at = @At(value = \"INVOKE\", target = \"java/util/Map.put (Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;\", ordinal = 1))\n+\tprivate Object proxyPutWorld(Map worlds, Object type, Object world) {\n+\t\tworlds.put(type, world);\n+\t\tMinecraftForge.EVENT_BUS.post(new WorldEvent.Load((ServerWorld) world));\n+\t\treturn world;\n+\t}\n+\n+\t// TODO: Should we Inject into ServerWorld.close instead? Currently, this follows Forge's patch location.", "originalCommit": "c2a5e23f5583be9417d47ab40a6cc792b70b6613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM0MDYyNA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373340624", "bodyText": "K, will remove the TODO", "author": "kitlith", "createdAt": "2020-01-31T07:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxNDQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxNjA4Nw==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373316087", "bodyText": "Technically this should be a FIELD injection before the GETFIELD instruction.", "author": "coderbot16", "createdAt": "2020-01-31T04:56:29Z", "path": "patchwork-events-world/src/main/java/com/patchworkmc/mixin/event/world/MixinServerWorld.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package com.patchworkmc.mixin.event.world;\n+\n+import java.util.function.BiFunction;\n+\n+import net.minecraftforge.common.MinecraftForge;\n+import net.minecraftforge.event.world.WorldEvent;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n+\n+import net.minecraft.util.profiler.Profiler;\n+import net.minecraft.world.chunk.ChunkManager;\n+import net.minecraft.world.dimension.Dimension;\n+import net.minecraft.world.dimension.DimensionType;\n+import net.minecraft.world.level.LevelInfo;\n+import net.minecraft.world.level.LevelProperties;\n+import net.minecraft.world.World;\n+import net.minecraft.server.world.ServerWorld;\n+\n+import com.patchworkmc.impl.event.world.WorldEvents;\n+\n+@Mixin(ServerWorld.class)\n+public abstract class MixinServerWorld extends World {\n+\tprotected MixinServerWorld(LevelProperties levelProperties, DimensionType dimensionType, BiFunction<World, Dimension, ChunkManager> chunkManagerProvider, Profiler profiler, boolean isClient) {\n+\t\tsuper(levelProperties, dimensionType, chunkManagerProvider, profiler, isClient);\n+\t}\n+\n+\t@Inject(method = \"save\", at = @At(value = \"INVOKE\", target = \"net/minecraft/server/world/ServerChunkManager.save (Z)V\"))\n+\tprivate void hookSave(CallbackInfo info) {\n+\t\tServerWorld world = (ServerWorld) (Object) this;\n+\t\tMinecraftForge.EVENT_BUS.post(new WorldEvent.Save(world));\n+\t}\n+\n+\t// TODO: consider adding a shift to before obtaining the ChunkManager to match forge more closely\n+\t// I don't think it'll make much of a difference.", "originalCommit": "c2a5e23f5583be9417d47ab40a6cc792b70b6613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM1NDkyOA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373354928", "bodyText": "Right, really the only reason I didn't do that is because chunkManager is accessed 3 times in the function, while getBiomeSource is only called once. We could setup a slice or an ordinal for that, but if this does the job...", "author": "kitlith", "createdAt": "2020-01-31T08:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMxNjA4Nw=="}], "type": "inlineReview"}, {"oid": "4a5eeb7ff8cbb32fe40392d038b19617591839e5", "url": "https://github.com/PatchworkMC/patchwork-api/commit/4a5eeb7ff8cbb32fe40392d038b19617591839e5", "message": "Make changes according to the PR comments.", "committedDate": "2020-01-31T08:52:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1Njg0MA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/38#discussion_r373756840", "bodyText": "Extra blank line\n\n  \n    \n      \n        Suggested change", "author": "coderbot16", "createdAt": "2020-02-01T04:23:17Z", "path": "patchwork-events-world/src/main/java/com/patchworkmc/mixin/event/world/MixinMinecraftServer.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package com.patchworkmc.mixin.event.world;\n+\n+import java.io.IOException;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import org.spongepowered.asm.mixin.Final;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import net.minecraft.server.MinecraftServer;\n+import net.minecraft.server.ServerTask;\n+import net.minecraft.server.world.ServerWorld;\n+import net.minecraft.util.NonBlockingThreadExecutor;\n+import net.minecraft.world.dimension.DimensionType;\n+\n+import com.patchworkmc.impl.event.world.WorldEvents;\n+\n+@Mixin(MinecraftServer.class)\n+public abstract class MixinMinecraftServer extends NonBlockingThreadExecutor<ServerTask> {\n+\tpublic MixinMinecraftServer(String name) {\n+\t\tsuper(name);\n+\t}\n+\n+\t@Shadow\n+\t@Final\n+\tprivate Map<DimensionType, ServerWorld> worlds;\n+\n+\t/*\n+\t// This is a varient of the world load hook that is less likely to break mods and more likely to break on updates.\n+\t// Should get called once per loop, regardless of which if branch it takes.\n+\t@Inject(\n+\t\tmethod = \"createWorlds\",\n+\t\tslice = @Slice(\n+\t\t\tfrom = @At(value = \"INVOKE\", target = \"java/util/Iterator.hasNext ()Z\")\n+\t\t),\n+\t\tat = @At(value = \"JUMP\", opcode = Opcodes.GOTO),\n+\t\tlocals = LocalCapture.CAPTURE_FAILHARD\n+\t)\n+\tprivate void hookCreateWorlds(WorldSaveHandler worldSaveHandler, LevelProperties properties, LevelInfo levelInfo, WorldGenerationProgressListener worldGenerationProgressListener, CallbackInfo ci, ServerWorld serverWorld, ServerWorld serverWorld2, Iterator var7, DimensionType dimensionType) {\n+\t\tWorldEvents.onWorldLoad(this.worlds.get(dimensionType));\n+\t}\n+", "originalCommit": "4a5eeb7ff8cbb32fe40392d038b19617591839e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}