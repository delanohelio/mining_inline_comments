{"pr_number": 2156, "pr_title": "Fix Google transcription service indefinite errors generation #1664 #2146", "pr_createdAt": "2020-12-15T14:40:17Z", "pr_url": "https://github.com/opencast/opencast/pull/2156", "timeline": [{"oid": "5e480b3038a799595255f252d604b7094d1c44a3", "url": "https://github.com/opencast/opencast/commit/5e480b3038a799595255f252d604b7094d1c44a3", "message": "#1664 Stopped Google transcription service generating error indefinitely when mediapackage deleted.", "committedDate": "2020-12-15T10:08:41Z", "type": "commit"}, {"oid": "33d0902ae73b4ac4c3e4d3453a08c04edbb075be", "url": "https://github.com/opencast/opencast/commit/33d0902ae73b4ac4c3e4d3453a08c04edbb075be", "message": "#2146 Dead Google transcription jobs are canceled after a time limit", "committedDate": "2020-12-15T10:31:42Z", "type": "commit"}, {"oid": "c346f9f8795bc58c5fabc0c80b0ed76fe8f52bb7", "url": "https://github.com/opencast/opencast/commit/c346f9f8795bc58c5fabc0c80b0ed76fe8f52bb7", "message": "Fixed typo", "committedDate": "2020-12-15T10:48:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQyMTY2OA==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r565421668", "bodyText": "Would it make sense to return true when there is an ERROR level error? Or is it useful to allow manual intervention to troubleshot the issue before cancelling the transcript? I'm wonder why it is better to leave the job in perpetual non-expired state during an exception. For example, maybe an issue with the database connection at that point or the transcription job has not been fully at this point.", "author": "karendolan", "createdAt": "2021-01-27T15:51:47Z", "path": "modules/transcription-service-google-speech-impl/src/main/java/org/opencastproject/transcription/googlespeech/GoogleSpeechTranscriptionService.java", "diffHunk": "@@ -866,6 +870,37 @@ private String buildResultsFileName(String jobId) {\n     return PathSupport.toSafeName(jobId + \".json\");\n   }\n \n+  private void cancelTranscription(String jobId, String message) {\n+    try {\n+      database.updateJobControl(jobId, TranscriptionJobControl.Status.Canceled.name());\n+      String mpId = database.findByJob(jobId).getMediaPackageId();\n+      try {\n+        // Delete file stored on Google storage\n+        String token = getRefreshAccessToken();\n+        deleteStorageFile(mpId, token);\n+      } catch (Exception ex) {\n+        logger.warn(String.format(\"could not delete file %s.%s from Google cloud storage\", mpId, defaultEncoding), ex);\n+      }\n+      // Send notification email\n+      sendEmail(\"Transcription ERROR\", String.format(\"%s(media package %s, job id %s).\", message, mpId, jobId));\n+    } catch (Exception e) {\n+      logger.error(String.format(\"ERROR while deleting transcription job: %s\", jobId), e);\n+    }\n+  }\n+\n+  private boolean hasTranscriptionRequestExpired(String jobId) {\n+    try {\n+      // set a time limit based on video duration and maximum processing time\n+      if (database.findByJob(jobId).getDateCreated().getTime() + database.findByJob(jobId).getTrackDuration()\n+              + (completionCheckBuffer + maxProcessingSeconds) * 1000 < System.currentTimeMillis()) {\n+        return true;\n+      }\n+    } catch (Exception e) {\n+      logger.error(String.format(\"ERROR while calculating transcription request expiration for job: %s\", jobId), e);\n+    }\n+    return false;\n+  }", "originalCommit": "c346f9f8795bc58c5fabc0c80b0ed76fe8f52bb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg0ODQ5OA==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r566848498", "bodyText": "yes, returning true will avoid perpetual non-expired state.", "author": "tyfranck", "createdAt": "2021-01-29T14:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQyMTY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQyMzM3OA==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r565423378", "bodyText": "\"Jobs that get here have state TranscriptionCompleted [... or had an IOException]\"", "author": "karendolan", "createdAt": "2021-01-27T15:53:48Z", "path": "modules/transcription-service-google-speech-impl/src/main/java/org/opencastproject/transcription/googlespeech/GoogleSpeechTranscriptionService.java", "diffHunk": "@@ -1014,7 +1048,7 @@ public void run() {\n             // Apply workflow to attach transcripts", "originalCommit": "c346f9f8795bc58c5fabc0c80b0ed76fe8f52bb7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQyOTAxMQ==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r565429011", "bodyText": "It might be helpful to put the sendMail in a finally block to include the general Exception, or, condense into one try-catch block.", "author": "karendolan", "createdAt": "2021-01-27T16:00:42Z", "path": "modules/transcription-service-google-speech-impl/src/main/java/org/opencastproject/transcription/googlespeech/GoogleSpeechTranscriptionService.java", "diffHunk": "@@ -866,6 +870,37 @@ private String buildResultsFileName(String jobId) {\n     return PathSupport.toSafeName(jobId + \".json\");\n   }\n \n+  private void cancelTranscription(String jobId, String message) {\n+    try {\n+      database.updateJobControl(jobId, TranscriptionJobControl.Status.Canceled.name());\n+      String mpId = database.findByJob(jobId).getMediaPackageId();\n+      try {\n+        // Delete file stored on Google storage\n+        String token = getRefreshAccessToken();\n+        deleteStorageFile(mpId, token);\n+      } catch (Exception ex) {\n+        logger.warn(String.format(\"could not delete file %s.%s from Google cloud storage\", mpId, defaultEncoding), ex);\n+      }\n+      // Send notification email\n+      sendEmail(\"Transcription ERROR\", String.format(\"%s(media package %s, job id %s).\", message, mpId, jobId));\n+    } catch (Exception e) {\n+      logger.error(String.format(\"ERROR while deleting transcription job: %s\", jobId), e);\n+    }", "originalCommit": "c346f9f8795bc58c5fabc0c80b0ed76fe8f52bb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY0MzI2Ng==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r568643266", "bodyText": "fixed", "author": "tyfranck", "createdAt": "2021-02-02T14:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQyOTAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2NjM1MA==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r565466350", "bodyText": "It's too bad that the workflow service is not (or cannot be?) queried here to verify that the mpId still exists when the asset manager has no knowledge of the mpId.  For example, when the event is deleted before Google transcript is attached, a 5 hour timeout plus length of video plus buffer has to be waited through before cancelling the transcript job. .... it might be useful to include the countdown in that Skipped log line. For example\nlogger.warn(\"Media package {} has not been archived yet or has been deleted. Will keep trying for {} more minutes before cancelling transcript job {}.\", mpId, getRemainingTranscriptionExpireTimeInMin(jobId), jobId);", "author": "karendolan", "createdAt": "2021-01-27T16:47:52Z", "path": "modules/transcription-service-google-speech-impl/src/main/java/org/opencastproject/transcription/googlespeech/GoogleSpeechTranscriptionService.java", "diffHunk": "@@ -1043,8 +1077,13 @@ private String startWorkflow(String mpId, String wfDefId, Map<String, String> pa\n     final AQueryBuilder q = assetManager.createQuery();\n     final AResult r = q.select(q.snapshot()).where(q.mediaPackageId(mpId).and(q.version().isLatest())).run();\n     if (r.getSize() == 0) {\n-      // Media package not archived yet.\n-      logger.warn(\"Media package {} has not been archived yet.\", mpId);\n+      if (!hasTranscriptionRequestExpired(jobId)) {\n+        // Media package not archived but still within completion time? Skip until next time.\n+        logger.warn(\"Media package {} has not been archived yet. Skipped.\", mpId);\n+      } else {\n+        // Close transcription job and email admin\n+        cancelTranscription(jobId, \"Transcription job canceled, archived media package not found\");\n+      }\n       return null;\n     }", "originalCommit": "c346f9f8795bc58c5fabc0c80b0ed76fe8f52bb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2ODgxOQ==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r565468819", "bodyText": "As a future feature, it might be worth adding a listener for deleted events to the transcript service so it can cancel out jobs when the event is deleted before the transcript is attached.\nFor example, here the event delete is sent to ActiveMQ but transcription service doesn't listen to that event.\n2021-01-27T10:18:19,425 | INFO  | (AssetManagerWithMessaging:221) - Send delete message for episode 45b480a8-ace5-47b8-abee-33744cacb5fe to ActiveMQ\n2021-01-27T10:31:35,944 | INFO  | (GoogleSpeechTranscriptionService:591) - Recognitions job 4747558756009661662 has been found, completed status true", "author": "karendolan", "createdAt": "2021-01-27T16:51:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2NjM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjkwMjMzOA==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r566902338", "bodyText": "I like the idea of count down, I'll try to add it.\nI'll add the second part of your comment in future improvements.", "author": "tyfranck", "createdAt": "2021-01-29T15:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2NjM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY0Nzk2OQ==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r568647969", "bodyText": "Count down now added", "author": "tyfranck", "createdAt": "2021-02-02T14:33:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2NjM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY3Njk4MA==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r565676980", "bodyText": "It would help to log an INFO that the job is being cancelled, in addition to the email. Since there are 5 hours of retry logs, this would be the one log bringing the logs to closure for this transcription job.\nAlso, IMHO, it would help to add \"Google Transcription\" to the cancelTranscription email text, since the email message is coming from the Google Transcription service (vs IBM Watson Transcription service)", "author": "karendolan", "createdAt": "2021-01-27T22:18:54Z", "path": "modules/transcription-service-google-speech-impl/src/main/java/org/opencastproject/transcription/googlespeech/GoogleSpeechTranscriptionService.java", "diffHunk": "@@ -604,6 +604,10 @@ boolean getAndSaveJobResults(String jobId) throws TranscriptionServiceException,\n     } catch (TranscriptionServiceException e) {\n       throw e;\n     } catch (Exception e) {\n+      if (hasTranscriptionRequestExpired(jobId)) {\n+        // Cancel the job and inform admin\n+        cancelTranscription(jobId, \"Transcription job canceled due to errors\");\n+      }", "originalCommit": "c346f9f8795bc58c5fabc0c80b0ed76fe8f52bb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjkwMjc0Nw==", "url": "https://github.com/opencast/opencast/pull/2156#discussion_r566902747", "bodyText": "Agree", "author": "tyfranck", "createdAt": "2021-01-29T15:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY3Njk4MA=="}], "type": "inlineReview"}, {"oid": "f92811903f87515743cd6c76f4f3bdb61dea8591", "url": "https://github.com/opencast/opencast/commit/f92811903f87515743cd6c76f4f3bdb61dea8591", "message": "fix transcription cancellation delay and log messages following review", "committedDate": "2021-02-02T14:25:29Z", "type": "commit"}]}