{"pr_number": 1633, "pr_title": "Using ConcurrentHashMap for synchronizing LTI user login", "pr_createdAt": "2020-06-08T18:13:27Z", "pr_url": "https://github.com/opencast/opencast/pull/1633", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1OTQxOA==", "url": "https://github.com/opencast/opencast/pull/1633#discussion_r437059418", "bodyText": "This now becomes expected behavior and is not something we need to warn users about, is it?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.warn(\"Concurrent access of user {}. Igoring.\", username);\n          \n          \n            \n                    logger.debug(\"Concurrent access of user {}. Igoring.\", username);", "author": "lkiesow", "createdAt": "2020-06-08T23:42:07Z", "path": "modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java", "diffHunk": "@@ -315,37 +317,36 @@ public Authentication createAuthentication(HttpServletRequest request, ConsumerA\n     userAuthorities.add(new SimpleGrantedAuthority(\"ROLE_USER\"));\n     userAuthorities.add(new SimpleGrantedAuthority(\"ROLE_ANONYMOUS\"));\n \n-\n     // Create/Update the user reference\n     if (createJpaUserReference) {\n-      JpaOrganization organization = fromOrganization(securityService.getOrganization());\n-\n-      JpaUserReference jpaUserReference = userReferenceProvider.findUserReference(username, organization.getId());\n-\n-      Set<JpaRole> jpaRoles = new HashSet<>();\n-      for (GrantedAuthority authority : userAuthorities) {\n-        jpaRoles.add(new JpaRole(authority.getAuthority(), organization));\n-      }\n-\n-      Date loginDate = new Date();\n+      if (attempts.putIfAbsent(username, Boolean.TRUE) != null) {\n+        logger.warn(\"Concurrent access of user {}. Igoring.\", username);", "originalCommit": "dd4fdb536875c867eb24f932c0194da07cfb464c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MDA4MA==", "url": "https://github.com/opencast/opencast/pull/1633#discussion_r437060080", "bodyText": "Purely nitpicking but it's not that we count attempts so the choice for the name seems a bit odd.\n;aybe:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Map<String, Boolean> attempts = new ConcurrentHashMap<>(128);\n          \n          \n            \n              private Map<String, Boolean> activePersistence = new ConcurrentHashMap<>(128);", "author": "lkiesow", "createdAt": "2020-06-08T23:44:13Z", "path": "modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java", "diffHunk": "@@ -137,6 +137,9 @@\n   /** Set of usernames that should not authenticated as themselves even if the OAuth consumer keys is trusted */\n   private Set<String> usernameBlacklist = new HashSet<>();\n \n+  /** concurrent attemtps */\n+  private Map<String, Boolean> attempts = new ConcurrentHashMap<>(128);", "originalCommit": "dd4fdb536875c867eb24f932c0194da07cfb464c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df29ed6f7c55df3cb996ccae3c4db6afb82ac71f", "url": "https://github.com/opencast/opencast/commit/df29ed6f7c55df3cb996ccae3c4db6afb82ac71f", "message": "refs #4904 FIX using ConcurrentHashMap for LTI login User", "committedDate": "2020-06-09T18:16:40Z", "type": "commit"}, {"oid": "59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "url": "https://github.com/opencast/opencast/commit/59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "message": "Fix LTI build and naming\n\n- Fix build\n- warn to debug logging\n- Fix typo\n- Improve name of HashMap", "committedDate": "2020-06-09T18:23:45Z", "type": "commit"}, {"oid": "59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "url": "https://github.com/opencast/opencast/commit/59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "message": "Fix LTI build and naming\n\n- Fix build\n- warn to debug logging\n- Fix typo\n- Improve name of HashMap", "committedDate": "2020-06-09T18:23:45Z", "type": "forcePushed"}, {"oid": "8d53f7bb63e8155cc04be041e31514fbb5130bbb", "url": "https://github.com/opencast/opencast/commit/8d53f7bb63e8155cc04be041e31514fbb5130bbb", "message": "Concurrent LTI Requests\n\nThis patch adds an additional safeguard for handling concurrent\nauthentication requests executed on multiple server.", "committedDate": "2020-06-09T20:24:19Z", "type": "commit"}]}