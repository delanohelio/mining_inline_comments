{"pr_number": 1607, "pr_title": "Shibboleth dynamic login handler", "pr_createdAt": "2020-05-27T13:39:41Z", "pr_url": "https://github.com/opencast/opencast/pull/1607", "timeline": [{"oid": "7e70ca4bd81d64629d984bfda9cad03cb5235287", "url": "https://github.com/opencast/opencast/commit/7e70ca4bd81d64629d984bfda9cad03cb5235287", "message": "  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #501517 FIX Update group memberships in Shibboleth LoginHandler\n\nrefs #501517 ADD Dynamic login handler based on spring expressions\n\n  refs #501517 ADD Tests for dynamic login handler based on spring expressions\n\n  refs #501517 FIX Interfaces and maven-dependency-plugin\n\nrefs #4870 FIX map email and name\n\nrefs #4943 FIX Fallback to user create when there is no user reference for existing users\n\n  - FIXME Check for existence of non-ref user first\n\n  FIX securitty.aai Checkstyle\n\n  FIX userdirectory Checkstyle\n\n  FIX all\n\n  refs #502450 FIX Shibboleth Dynamic Loginhandler\n\nrefs #2965 FIX Example configuration for Dynamic loginhandler\n\nrefs #2965 FIX Use spring util 3.1 xsd - not tested\n\n  - FIXME We may need to update pom.xml\n\nrefs #2965 FIX Mockdata", "committedDate": "2020-05-29T16:19:37Z", "type": "forcePushed"}, {"oid": "823b691836e7d2eb8357c850a39def0234ec3725", "url": "https://github.com/opencast/opencast/commit/823b691836e7d2eb8357c850a39def0234ec3725", "message": "  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #501517 FIX Update group memberships in Shibboleth LoginHandler\n\nrefs #501517 ADD Dynamic login handler based on spring expressions\n\n  refs #501517 ADD Tests for dynamic login handler based on spring expressions\n\n  refs #501517 FIX Interfaces and maven-dependency-plugin\n\nrefs #4870 FIX map email and name\n\nrefs #4943 FIX Fallback to user create when there is no user reference for existing users\n\n  - FIXME Check for existence of non-ref user first\n\n  FIX securitty.aai Checkstyle\n\n  FIX userdirectory Checkstyle\n\n  FIX all\n\n  refs #502450 FIX Shibboleth Dynamic Loginhandler\n\nrefs #2965 FIX Example configuration for Dynamic loginhandler\n\nrefs #2965 FIX Use spring util 3.1 xsd - not tested\n\n  - FIXME We may need to update pom.xml\n\nrefs #2965 FIX Mockdata", "committedDate": "2020-06-02T16:37:46Z", "type": "forcePushed"}, {"oid": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "url": "https://github.com/opencast/opencast/commit/c66e404f99afa38ee81c79ffbb23169d8dff5c69", "message": "  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #501517 FIX Update group memberships in Shibboleth LoginHandler\n\nrefs #501517 ADD Dynamic login handler based on spring expressions\n\n  refs #501517 ADD Tests for dynamic login handler based on spring expressions\n\n  refs #501517 FIX Interfaces and maven-dependency-plugin\n\nrefs #4870 FIX map email and name\n\nrefs #4943 FIX Fallback to user create when there is no user reference for existing users\n\n  - FIXME Check for existence of non-ref user first\n\n  FIX securitty.aai Checkstyle\n\n  FIX userdirectory Checkstyle\n\n  FIX all\n\n  refs #502450 FIX Shibboleth Dynamic Loginhandler\n\nrefs #2965 FIX Example configuration for Dynamic loginhandler\n\nrefs #2965 FIX Use spring util 3.1 xsd - not tested\n\n  - FIXME We may need to update pom.xml\n\nrefs #2965 FIX Mockdata", "committedDate": "2020-06-03T10:45:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MjcxOA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436292718", "bodyText": "Wouldn't the exception end up in the log anyway and make the complete error message unnecessary?", "author": "lkiesow", "createdAt": "2020-06-06T19:06:53Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/api/AttributeMapper.java", "diffHunk": "@@ -0,0 +1,186 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai.api;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.expression.Expression;\n+import org.springframework.expression.ExpressionParser;\n+import org.springframework.expression.spel.standard.SpelExpressionParser;\n+import org.springframework.util.Assert;\n+import org.springframework.util.CollectionUtils;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.servlet.http.HttpServletRequest;\n+/**\n+ * Generic AAI Attribute mapper using Spring Expression language mappings.\n+ *\n+ */\n+public class AttributeMapper implements InitializingBean {\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory\n+      .getLogger(AttributeMapper.class);\n+\n+  /** List of all attributes that should be fetched */\n+  private List<String> aaiAttributes;\n+\n+  /**\n+   * Map of List of expressions. Key is a mapping name, value a list of\n+   * expressions\n+   */\n+  private Map<String, List<String>> attributeMap;\n+\n+  /** Use HTTP Header or environment attributes */\n+  private boolean useHeader = true;\n+\n+  /** The delimiter for multivalue attributes */\n+  private String multiValueDelimiter = \";\";\n+\n+  public void afterPropertiesSet() throws Exception {\n+    Assert.notNull(attributeMap, \"attributeMap must be set\");\n+  }\n+\n+  /**\n+   * Apply all expressions on the sourceAttributes\n+   *\n+   * @param sourceAttributes\n+   *    Key is attribute name, value a list of split AAI attribute values\n+   * @param mappingId\n+   *    The mapping list to use\n+   * @return\n+   */\n+  public List<String> getMappedAttributes(\n+      Map<String, List<String>> sourceAttributes, String mappingId) {\n+    Set<String> mappedAttributes = new LinkedHashSet<String>();\n+    ExpressionParser parser = new SpelExpressionParser();\n+\n+    List<String> expressions = attributeMap.get(mappingId);\n+\n+    if (expressions == null) {\n+      logger.error(\"No mapping for \\\"\" + mappingId\n+          + \"\\\" specified. Did you forget to configure a <util:map id=\\\"\"\n+          + mappingId + \"\\\" ...?\");\n+      throw new IllegalArgumentException(\"No mapping for \\\"\" + mappingId\n+          + \"\\\" specified. Did you forget to configure a <util:map id=\\\"\"\n+          + mappingId + \"\\\" ...?\");", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc3ODQ1NA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r440778454", "bodyText": "Fix", "author": "jchssystems", "createdAt": "2020-06-16T11:26:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MjcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Mjg1Mg==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436292852", "bodyText": "This kind of change applies to a number of log messages in this patch:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.debug(\"Mapping \" + exp.getExpressionString() + \" -> \" + res);\n          \n          \n            \n                    logger.debug(\"Mapping {} to {}\", exp.getExpressionString(), res);", "author": "lkiesow", "createdAt": "2020-06-06T19:09:10Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/api/AttributeMapper.java", "diffHunk": "@@ -0,0 +1,186 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai.api;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.expression.Expression;\n+import org.springframework.expression.ExpressionParser;\n+import org.springframework.expression.spel.standard.SpelExpressionParser;\n+import org.springframework.util.Assert;\n+import org.springframework.util.CollectionUtils;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.servlet.http.HttpServletRequest;\n+/**\n+ * Generic AAI Attribute mapper using Spring Expression language mappings.\n+ *\n+ */\n+public class AttributeMapper implements InitializingBean {\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory\n+      .getLogger(AttributeMapper.class);\n+\n+  /** List of all attributes that should be fetched */\n+  private List<String> aaiAttributes;\n+\n+  /**\n+   * Map of List of expressions. Key is a mapping name, value a list of\n+   * expressions\n+   */\n+  private Map<String, List<String>> attributeMap;\n+\n+  /** Use HTTP Header or environment attributes */\n+  private boolean useHeader = true;\n+\n+  /** The delimiter for multivalue attributes */\n+  private String multiValueDelimiter = \";\";\n+\n+  public void afterPropertiesSet() throws Exception {\n+    Assert.notNull(attributeMap, \"attributeMap must be set\");\n+  }\n+\n+  /**\n+   * Apply all expressions on the sourceAttributes\n+   *\n+   * @param sourceAttributes\n+   *    Key is attribute name, value a list of split AAI attribute values\n+   * @param mappingId\n+   *    The mapping list to use\n+   * @return\n+   */\n+  public List<String> getMappedAttributes(\n+      Map<String, List<String>> sourceAttributes, String mappingId) {\n+    Set<String> mappedAttributes = new LinkedHashSet<String>();\n+    ExpressionParser parser = new SpelExpressionParser();\n+\n+    List<String> expressions = attributeMap.get(mappingId);\n+\n+    if (expressions == null) {\n+      logger.error(\"No mapping for \\\"\" + mappingId\n+          + \"\\\" specified. Did you forget to configure a <util:map id=\\\"\"\n+          + mappingId + \"\\\" ...?\");\n+      throw new IllegalArgumentException(\"No mapping for \\\"\" + mappingId\n+          + \"\\\" specified. Did you forget to configure a <util:map id=\\\"\"\n+          + mappingId + \"\\\" ...?\");\n+    }\n+\n+    for (String expression : expressions) {\n+      Expression exp = null;\n+      try {\n+        exp = parser.parseExpression(expression);\n+        String res = (String) exp.getValue(sourceAttributes);\n+        logger.debug(\"Mapping \" + exp.getExpressionString() + \" -> \" + res);", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NDA3Ng==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436294076", "bodyText": "Maybe something like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (prefix != null && !\"\".equals(prefix) && !group.getRole().startsWith(prefix)) {\n          \n          \n            \n                  if (StringUtils.isNotBlank(prefix) && !group.getRole().startsWith(prefix)) {", "author": "lkiesow", "createdAt": "2020-06-06T19:24:10Z", "path": "modules/userdirectory/src/main/java/org/opencastproject/userdirectory/JpaGroupRoleProvider.java", "diffHunk": "@@ -275,6 +303,10 @@ public void updateGroupMembershipFromRoles(String userName, String orgId, List<S\n     // List of the user's groups\n     List<JpaGroup> membership = UserDirectoryPersistenceUtil.findGroupsByUser(userName, orgId, emf);\n     for (JpaGroup group : membership) {\n+      if (prefix != null && !\"\".equals(prefix) && !group.getRole().startsWith(prefix)) {", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NDE3NQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436294175", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.warn(\"Unable to add user {} to group {} - unauthorized: {}\", userName, group.getRole(),e.getMessage(),e);\n          \n          \n            \n                        e.printStackTrace();\n          \n          \n            \n                        logger.warn(\"Unauthorized to add user {} to group {}\", userName, group.getRole(), e);", "author": "lkiesow", "createdAt": "2020-06-06T19:25:38Z", "path": "modules/userdirectory/src/main/java/org/opencastproject/userdirectory/JpaGroupRoleProvider.java", "diffHunk": "@@ -303,7 +335,8 @@ public void updateGroupMembershipFromRoles(String userName, String orgId, List<S\n             logger.warn(\"Cannot add user {} to group {} - no group found with that role\", userName, rolename);\n           }\n         } catch (UnauthorizedException e) {\n-          logger.warn(\"Unable to add user {} to group {} - unauthorized\", userName, group.getRole());\n+            logger.warn(\"Unable to add user {} to group {} - unauthorized: {}\", userName, group.getRole(),e.getMessage(),e);\n+            e.printStackTrace();", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NDM1OQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436294359", "bodyText": "Easier to swap this (less nesting):\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (roleProvider == null) {\n          \n          \n            \n                if (roleProvider != null) {\n          \n          \n            \n                  return roleProvider.getRolesForUser(userName);\n          \n          \n            \n                }", "author": "lkiesow", "createdAt": "2020-06-06T19:28:27Z", "path": "modules/userdirectory/src/main/java/org/opencastproject/userdirectory/JpaUserReferenceProvider.java", "diffHunk": "@@ -159,11 +177,14 @@ public String toString() {\n    */\n   @Override\n   public List<Role> getRolesForUser(String userName) {\n-    ArrayList<Role> roles = new ArrayList<Role>();\n-    User user = loadUser(userName);\n-    if (user != null)\n-      roles.addAll(user.getRoles());\n-    return roles;\n+    if (roleProvider == null) {", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NDU5MQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436294591", "bodyText": "Comment to myself: Not entirely sure what the GroupRoleProvider is for. Need to investigate\u2026", "author": "lkiesow", "createdAt": "2020-06-06T19:31:47Z", "path": "modules/userdirectory/src/main/java/org/opencastproject/userdirectory/api/GroupRoleProvider.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+\n+package org.opencastproject.userdirectory.api;\n+\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.GroupProvider;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.RoleProvider;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.util.NotFoundException;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+\n+public interface GroupRoleProvider extends GroupProvider, RoleProvider {", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcxOTEzNw==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r438719137", "bodyText": "With the interface we avoid cglib proxies.. that can cause weired problems with spring..", "author": "hsssystems", "createdAt": "2020-06-11T11:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NDU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTQ4OQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436295489", "bodyText": "Just wondering what the expected behavior is when an attribute appears twice?", "author": "lkiesow", "createdAt": "2020-06-06T19:43:56Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/api/AttributeMapper.java", "diffHunk": "@@ -0,0 +1,186 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai.api;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.expression.Expression;\n+import org.springframework.expression.ExpressionParser;\n+import org.springframework.expression.spel.standard.SpelExpressionParser;\n+import org.springframework.util.Assert;\n+import org.springframework.util.CollectionUtils;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.servlet.http.HttpServletRequest;\n+/**\n+ * Generic AAI Attribute mapper using Spring Expression language mappings.\n+ *\n+ */\n+public class AttributeMapper implements InitializingBean {\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory\n+      .getLogger(AttributeMapper.class);\n+\n+  /** List of all attributes that should be fetched */\n+  private List<String> aaiAttributes;\n+\n+  /**\n+   * Map of List of expressions. Key is a mapping name, value a list of\n+   * expressions\n+   */\n+  private Map<String, List<String>> attributeMap;\n+\n+  /** Use HTTP Header or environment attributes */\n+  private boolean useHeader = true;\n+\n+  /** The delimiter for multivalue attributes */\n+  private String multiValueDelimiter = \";\";\n+\n+  public void afterPropertiesSet() throws Exception {\n+    Assert.notNull(attributeMap, \"attributeMap must be set\");\n+  }\n+\n+  /**\n+   * Apply all expressions on the sourceAttributes\n+   *\n+   * @param sourceAttributes\n+   *    Key is attribute name, value a list of split AAI attribute values\n+   * @param mappingId\n+   *    The mapping list to use\n+   * @return\n+   */\n+  public List<String> getMappedAttributes(\n+      Map<String, List<String>> sourceAttributes, String mappingId) {\n+    Set<String> mappedAttributes = new LinkedHashSet<String>();", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcxMzg4OA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r438713888", "bodyText": "The First one will be taken. We could add a test...", "author": "hsssystems", "createdAt": "2020-06-11T11:19:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1MTMzOA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r443751338", "bodyText": "We have a Test for a duplicate attribute", "author": "jchssystems", "createdAt": "2020-06-22T18:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTY0MA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436295640", "bodyText": "Should this be deleted?", "author": "lkiesow", "createdAt": "2020-06-06T19:46:24Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTgxMg==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436295812", "bodyText": "Why register a managed service if you don't handle any configuration?", "author": "lkiesow", "createdAt": "2020-06-06T19:49:36Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;\n+\n+  /** Role assigned to all Shibboleth authenticated users */\n+  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;\n+\n+  /*\n+   * It is the bundle matterhorn-kernel what will need to instantiate the ConfigurableLoginHandler\n+   * since it is wired using Spring Security.\n+   * Since Shibboleth support is supposed to be an optional extension of the bundle matterhorn-kernel,\n+   * we implement this as fragment bundle.\n+   * The use of the Service Component Runtime (SCR) would require us to declare this bundle as service\n+   * component in matterhorn-kernel which we don't want since it is optional.\n+   * To make us visible to the config admin and take advantage of the ManagedService mechanism, we\n+   * register us as ManagedService in the constructor.\n+   * An alternative solution would be to include the manifest of all fragments in matterhorn-kernel, i.e.\n+   * by specifying OSGI-INF/*.xml as service component in matterhorn-kernel.\n+   */\n+  public DynamicLoginHandler() {\n+    BundleContext bundleContext = FrameworkUtil.getBundle(this.getClass()).getBundleContext();\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  protected DynamicLoginHandler(BundleContext bundleContext) {\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  private void registerAsManagedService(BundleContext bundleContext) {\n+    Dictionary<String, String> properties = new Hashtable<String, String>();\n+    properties.put(\"service.pid\", this.getClass().getName());\n+    bundleContext.registerService(ManagedService.class.getName(), this, properties);\n+  }\n+\n+  @Override\n+  public void updated(Dictionary<String, ?> properties) throws ConfigurationException {\n+    // TODO Auto-generated method stub", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NjIyNg==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436296226", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (displayName != null && !\"\".equals(displayName)) {\n          \n          \n            \n                if (StringUtils.isNotBlank(displayName)) {", "author": "lkiesow", "createdAt": "2020-06-06T19:55:33Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;\n+\n+  /** Role assigned to all Shibboleth authenticated users */\n+  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;\n+\n+  /*\n+   * It is the bundle matterhorn-kernel what will need to instantiate the ConfigurableLoginHandler\n+   * since it is wired using Spring Security.\n+   * Since Shibboleth support is supposed to be an optional extension of the bundle matterhorn-kernel,\n+   * we implement this as fragment bundle.\n+   * The use of the Service Component Runtime (SCR) would require us to declare this bundle as service\n+   * component in matterhorn-kernel which we don't want since it is optional.\n+   * To make us visible to the config admin and take advantage of the ManagedService mechanism, we\n+   * register us as ManagedService in the constructor.\n+   * An alternative solution would be to include the manifest of all fragments in matterhorn-kernel, i.e.\n+   * by specifying OSGI-INF/*.xml as service component in matterhorn-kernel.\n+   */\n+  public DynamicLoginHandler() {\n+    BundleContext bundleContext = FrameworkUtil.getBundle(this.getClass()).getBundleContext();\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  protected DynamicLoginHandler(BundleContext bundleContext) {\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  private void registerAsManagedService(BundleContext bundleContext) {\n+    Dictionary<String, String> properties = new Hashtable<String, String>();\n+    properties.put(\"service.pid\", this.getClass().getName());\n+    bundleContext.registerService(ManagedService.class.getName(), this, properties);\n+  }\n+\n+  @Override\n+  public void updated(Dictionary<String, ?> properties) throws ConfigurationException {\n+    // TODO Auto-generated method stub\n+  }\n+\n+  /**\n+   * Handle a new user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void newUserLogin(String id, HttpServletRequest request) {\n+    String name = extractName(request);\n+    String email = extractEmail(request);\n+    Date loginDate = new Date();\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+\n+    // Compile the list of roles\n+    Set<JpaRole> roles = extractRoles(id, request);\n+\n+    // Create the user reference\n+    JpaUserReference userReference = new JpaUserReference(id, name, email, MECH_SHIBBOLETH, loginDate, organization,\n+            roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in for the first time\", id);\n+    userReferenceProvider.addUserReference(userReference, MECH_SHIBBOLETH);\n+  }\n+\n+  /**\n+   * Handle an existing user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void existingUserLogin(String id, HttpServletRequest request) {\n+    Organization organization = securityService.getOrganization();\n+\n+    // Load the user reference\n+    JpaUserReference userReference = userReferenceProvider.findUserReference(id, organization.getId());\n+    if (userReference == null) {\n+      //Triggers creation of user reference\n+      //Possible problem: if there is user (not reference) with that id, we will get conflicts\n+      throw new UsernameNotFoundException(\"User reference '\" + id + \"' was not found\");\n+    }\n+\n+    // Update the reference\n+    userReference.setName(extractName(request));\n+    userReference.setEmail(extractEmail(request));\n+    userReference.setLastLogin(new Date());\n+    Set<JpaRole> roles = extractRoles(id, request);\n+    userReference.setRoles(roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in\", id);\n+    userReferenceProvider.updateUserReference(userReference);\n+  }\n+\n+  /**\n+   * Sets the security service.\n+   *\n+   * @param securityService\n+   *          the security service\n+   */\n+  public void setSecurityService(SecurityService securityService) {\n+    this.securityService = securityService;\n+  }\n+\n+  /**\n+   * Sets the user reference provider.\n+   *\n+   * @param userReferenceProvider\n+   *          the user reference provider\n+   */\n+  public void setUserReferenceProvider(UserReferenceProvider userReferenceProvider) {\n+    this.userReferenceProvider = userReferenceProvider;\n+  }\n+\n+  /**\n+   * Extracts the name from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the name\n+   */\n+  private String extractName(HttpServletRequest request) {\n+    String displayName = extractDisplayName(request);\n+    if (displayName != null && !\"\".equals(displayName)) {", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NjQzOQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436296439", "bodyText": "Is the input guaranteed to be ISO_8859_1?", "author": "lkiesow", "createdAt": "2020-06-06T19:58:47Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;\n+\n+  /** Role assigned to all Shibboleth authenticated users */\n+  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;\n+\n+  /*\n+   * It is the bundle matterhorn-kernel what will need to instantiate the ConfigurableLoginHandler\n+   * since it is wired using Spring Security.\n+   * Since Shibboleth support is supposed to be an optional extension of the bundle matterhorn-kernel,\n+   * we implement this as fragment bundle.\n+   * The use of the Service Component Runtime (SCR) would require us to declare this bundle as service\n+   * component in matterhorn-kernel which we don't want since it is optional.\n+   * To make us visible to the config admin and take advantage of the ManagedService mechanism, we\n+   * register us as ManagedService in the constructor.\n+   * An alternative solution would be to include the manifest of all fragments in matterhorn-kernel, i.e.\n+   * by specifying OSGI-INF/*.xml as service component in matterhorn-kernel.\n+   */\n+  public DynamicLoginHandler() {\n+    BundleContext bundleContext = FrameworkUtil.getBundle(this.getClass()).getBundleContext();\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  protected DynamicLoginHandler(BundleContext bundleContext) {\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  private void registerAsManagedService(BundleContext bundleContext) {\n+    Dictionary<String, String> properties = new Hashtable<String, String>();\n+    properties.put(\"service.pid\", this.getClass().getName());\n+    bundleContext.registerService(ManagedService.class.getName(), this, properties);\n+  }\n+\n+  @Override\n+  public void updated(Dictionary<String, ?> properties) throws ConfigurationException {\n+    // TODO Auto-generated method stub\n+  }\n+\n+  /**\n+   * Handle a new user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void newUserLogin(String id, HttpServletRequest request) {\n+    String name = extractName(request);\n+    String email = extractEmail(request);\n+    Date loginDate = new Date();\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+\n+    // Compile the list of roles\n+    Set<JpaRole> roles = extractRoles(id, request);\n+\n+    // Create the user reference\n+    JpaUserReference userReference = new JpaUserReference(id, name, email, MECH_SHIBBOLETH, loginDate, organization,\n+            roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in for the first time\", id);\n+    userReferenceProvider.addUserReference(userReference, MECH_SHIBBOLETH);\n+  }\n+\n+  /**\n+   * Handle an existing user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void existingUserLogin(String id, HttpServletRequest request) {\n+    Organization organization = securityService.getOrganization();\n+\n+    // Load the user reference\n+    JpaUserReference userReference = userReferenceProvider.findUserReference(id, organization.getId());\n+    if (userReference == null) {\n+      //Triggers creation of user reference\n+      //Possible problem: if there is user (not reference) with that id, we will get conflicts\n+      throw new UsernameNotFoundException(\"User reference '\" + id + \"' was not found\");\n+    }\n+\n+    // Update the reference\n+    userReference.setName(extractName(request));\n+    userReference.setEmail(extractEmail(request));\n+    userReference.setLastLogin(new Date());\n+    Set<JpaRole> roles = extractRoles(id, request);\n+    userReference.setRoles(roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in\", id);\n+    userReferenceProvider.updateUserReference(userReference);\n+  }\n+\n+  /**\n+   * Sets the security service.\n+   *\n+   * @param securityService\n+   *          the security service\n+   */\n+  public void setSecurityService(SecurityService securityService) {\n+    this.securityService = securityService;\n+  }\n+\n+  /**\n+   * Sets the user reference provider.\n+   *\n+   * @param userReferenceProvider\n+   *          the user reference provider\n+   */\n+  public void setUserReferenceProvider(UserReferenceProvider userReferenceProvider) {\n+    this.userReferenceProvider = userReferenceProvider;\n+  }\n+\n+  /**\n+   * Extracts the name from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the name\n+   */\n+  private String extractName(HttpServletRequest request) {\n+    String displayName = extractDisplayName(request);\n+    if (displayName != null && !\"\".equals(displayName)) {\n+      return displayName;\n+    }\n+    List<String> givenNames = attributeMapper.getMappedAttributes(request, \"givenName\");\n+    String givenName = \"\";\n+    if (givenNames.size() > 0) {\n+      String givenNameValue = givenNames.get(0);\n+      givenName = StringUtils.isBlank(givenNameValue) ? \"\"\n+              : new String(givenNameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NjcyMQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436296721", "bodyText": "And if givenNameValue is blank wouldn't new String(givenNameValue.getBytes(StandardCharsets.ISO_8859_1),                      StandardCharsets.UTF_8); still be a blank string?", "author": "lkiesow", "createdAt": "2020-06-06T20:03:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NjQzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcwOTI4Mg==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r438709282", "bodyText": "Wenn givenNameValue is blank, givenName is Blank (\"\"), otherwise not. Same code in ConfigurableLoginHandler and for the other attributes. Should be OK.\nThe whole building of the displayName is only a fallback since it's also possible to configure the building of the displayName in SPeL configuration...", "author": "hsssystems", "createdAt": "2020-06-11T11:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NjQzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc0MTU5NA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r443741594", "bodyText": "It seems that ISO_8859_1 is guaranteed:\nhttps://issues.shibboleth.net/jira/projects/SSPCPP/issues/SSPCPP-2?filter=allopenissues\nbut the code here is unnecesary", "author": "jchssystems", "createdAt": "2020-06-22T18:14:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NjQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NjU5Mg==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436296592", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } else {\n          \n          \n            \n                  return null;\n          \n          \n            \n                }\n          \n          \n            \n                }\n          \n          \n            \n                return null;", "author": "lkiesow", "createdAt": "2020-06-06T20:01:10Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;\n+\n+  /** Role assigned to all Shibboleth authenticated users */\n+  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;\n+\n+  /*\n+   * It is the bundle matterhorn-kernel what will need to instantiate the ConfigurableLoginHandler\n+   * since it is wired using Spring Security.\n+   * Since Shibboleth support is supposed to be an optional extension of the bundle matterhorn-kernel,\n+   * we implement this as fragment bundle.\n+   * The use of the Service Component Runtime (SCR) would require us to declare this bundle as service\n+   * component in matterhorn-kernel which we don't want since it is optional.\n+   * To make us visible to the config admin and take advantage of the ManagedService mechanism, we\n+   * register us as ManagedService in the constructor.\n+   * An alternative solution would be to include the manifest of all fragments in matterhorn-kernel, i.e.\n+   * by specifying OSGI-INF/*.xml as service component in matterhorn-kernel.\n+   */\n+  public DynamicLoginHandler() {\n+    BundleContext bundleContext = FrameworkUtil.getBundle(this.getClass()).getBundleContext();\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  protected DynamicLoginHandler(BundleContext bundleContext) {\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  private void registerAsManagedService(BundleContext bundleContext) {\n+    Dictionary<String, String> properties = new Hashtable<String, String>();\n+    properties.put(\"service.pid\", this.getClass().getName());\n+    bundleContext.registerService(ManagedService.class.getName(), this, properties);\n+  }\n+\n+  @Override\n+  public void updated(Dictionary<String, ?> properties) throws ConfigurationException {\n+    // TODO Auto-generated method stub\n+  }\n+\n+  /**\n+   * Handle a new user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void newUserLogin(String id, HttpServletRequest request) {\n+    String name = extractName(request);\n+    String email = extractEmail(request);\n+    Date loginDate = new Date();\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+\n+    // Compile the list of roles\n+    Set<JpaRole> roles = extractRoles(id, request);\n+\n+    // Create the user reference\n+    JpaUserReference userReference = new JpaUserReference(id, name, email, MECH_SHIBBOLETH, loginDate, organization,\n+            roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in for the first time\", id);\n+    userReferenceProvider.addUserReference(userReference, MECH_SHIBBOLETH);\n+  }\n+\n+  /**\n+   * Handle an existing user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void existingUserLogin(String id, HttpServletRequest request) {\n+    Organization organization = securityService.getOrganization();\n+\n+    // Load the user reference\n+    JpaUserReference userReference = userReferenceProvider.findUserReference(id, organization.getId());\n+    if (userReference == null) {\n+      //Triggers creation of user reference\n+      //Possible problem: if there is user (not reference) with that id, we will get conflicts\n+      throw new UsernameNotFoundException(\"User reference '\" + id + \"' was not found\");\n+    }\n+\n+    // Update the reference\n+    userReference.setName(extractName(request));\n+    userReference.setEmail(extractEmail(request));\n+    userReference.setLastLogin(new Date());\n+    Set<JpaRole> roles = extractRoles(id, request);\n+    userReference.setRoles(roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in\", id);\n+    userReferenceProvider.updateUserReference(userReference);\n+  }\n+\n+  /**\n+   * Sets the security service.\n+   *\n+   * @param securityService\n+   *          the security service\n+   */\n+  public void setSecurityService(SecurityService securityService) {\n+    this.securityService = securityService;\n+  }\n+\n+  /**\n+   * Sets the user reference provider.\n+   *\n+   * @param userReferenceProvider\n+   *          the user reference provider\n+   */\n+  public void setUserReferenceProvider(UserReferenceProvider userReferenceProvider) {\n+    this.userReferenceProvider = userReferenceProvider;\n+  }\n+\n+  /**\n+   * Extracts the name from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the name\n+   */\n+  private String extractName(HttpServletRequest request) {\n+    String displayName = extractDisplayName(request);\n+    if (displayName != null && !\"\".equals(displayName)) {\n+      return displayName;\n+    }\n+    List<String> givenNames = attributeMapper.getMappedAttributes(request, \"givenName\");\n+    String givenName = \"\";\n+    if (givenNames.size() > 0) {\n+      String givenNameValue = givenNames.get(0);\n+      givenName = StringUtils.isBlank(givenNameValue) ? \"\"\n+              : new String(givenNameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+    }\n+    List<String> surnames = attributeMapper.getMappedAttributes(request, \"sn\");\n+    String sn = \"\";\n+    if (surnames.size() > 0) {\n+      String surnameValue = surnames.get(0);\n+      sn = StringUtils.isBlank(surnameValue) ? \"\"\n+              : new String(surnameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+    }\n+    return StringUtils.join(new String[] { givenName, sn }, \" \");\n+  }\n+\n+  /**\n+   * Extracts the e-mail from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the e-mail address\n+   */\n+  private String extractEmail(HttpServletRequest request) {\n+    List<String> mailAdresses = attributeMapper.getMappedAttributes(request, \"mail\");\n+    if (mailAdresses.size() > 0) {\n+      String mailValue = mailAdresses.get(0);\n+      String mail = StringUtils.isBlank(mailValue) ? \"\"\n+              : new String(mailValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+      return mail;\n+    } else {\n+      return null;\n+    }", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk0OQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436296949", "bodyText": "What's the rule for assigning the global admin role here?", "author": "lkiesow", "createdAt": "2020-06-06T20:06:40Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;\n+\n+  /** Role assigned to all Shibboleth authenticated users */\n+  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;\n+\n+  /*\n+   * It is the bundle matterhorn-kernel what will need to instantiate the ConfigurableLoginHandler\n+   * since it is wired using Spring Security.\n+   * Since Shibboleth support is supposed to be an optional extension of the bundle matterhorn-kernel,\n+   * we implement this as fragment bundle.\n+   * The use of the Service Component Runtime (SCR) would require us to declare this bundle as service\n+   * component in matterhorn-kernel which we don't want since it is optional.\n+   * To make us visible to the config admin and take advantage of the ManagedService mechanism, we\n+   * register us as ManagedService in the constructor.\n+   * An alternative solution would be to include the manifest of all fragments in matterhorn-kernel, i.e.\n+   * by specifying OSGI-INF/*.xml as service component in matterhorn-kernel.\n+   */\n+  public DynamicLoginHandler() {\n+    BundleContext bundleContext = FrameworkUtil.getBundle(this.getClass()).getBundleContext();\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  protected DynamicLoginHandler(BundleContext bundleContext) {\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  private void registerAsManagedService(BundleContext bundleContext) {\n+    Dictionary<String, String> properties = new Hashtable<String, String>();\n+    properties.put(\"service.pid\", this.getClass().getName());\n+    bundleContext.registerService(ManagedService.class.getName(), this, properties);\n+  }\n+\n+  @Override\n+  public void updated(Dictionary<String, ?> properties) throws ConfigurationException {\n+    // TODO Auto-generated method stub\n+  }\n+\n+  /**\n+   * Handle a new user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void newUserLogin(String id, HttpServletRequest request) {\n+    String name = extractName(request);\n+    String email = extractEmail(request);\n+    Date loginDate = new Date();\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+\n+    // Compile the list of roles\n+    Set<JpaRole> roles = extractRoles(id, request);\n+\n+    // Create the user reference\n+    JpaUserReference userReference = new JpaUserReference(id, name, email, MECH_SHIBBOLETH, loginDate, organization,\n+            roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in for the first time\", id);\n+    userReferenceProvider.addUserReference(userReference, MECH_SHIBBOLETH);\n+  }\n+\n+  /**\n+   * Handle an existing user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void existingUserLogin(String id, HttpServletRequest request) {\n+    Organization organization = securityService.getOrganization();\n+\n+    // Load the user reference\n+    JpaUserReference userReference = userReferenceProvider.findUserReference(id, organization.getId());\n+    if (userReference == null) {\n+      //Triggers creation of user reference\n+      //Possible problem: if there is user (not reference) with that id, we will get conflicts\n+      throw new UsernameNotFoundException(\"User reference '\" + id + \"' was not found\");\n+    }\n+\n+    // Update the reference\n+    userReference.setName(extractName(request));\n+    userReference.setEmail(extractEmail(request));\n+    userReference.setLastLogin(new Date());\n+    Set<JpaRole> roles = extractRoles(id, request);\n+    userReference.setRoles(roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in\", id);\n+    userReferenceProvider.updateUserReference(userReference);\n+  }\n+\n+  /**\n+   * Sets the security service.\n+   *\n+   * @param securityService\n+   *          the security service\n+   */\n+  public void setSecurityService(SecurityService securityService) {\n+    this.securityService = securityService;\n+  }\n+\n+  /**\n+   * Sets the user reference provider.\n+   *\n+   * @param userReferenceProvider\n+   *          the user reference provider\n+   */\n+  public void setUserReferenceProvider(UserReferenceProvider userReferenceProvider) {\n+    this.userReferenceProvider = userReferenceProvider;\n+  }\n+\n+  /**\n+   * Extracts the name from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the name\n+   */\n+  private String extractName(HttpServletRequest request) {\n+    String displayName = extractDisplayName(request);\n+    if (displayName != null && !\"\".equals(displayName)) {\n+      return displayName;\n+    }\n+    List<String> givenNames = attributeMapper.getMappedAttributes(request, \"givenName\");\n+    String givenName = \"\";\n+    if (givenNames.size() > 0) {\n+      String givenNameValue = givenNames.get(0);\n+      givenName = StringUtils.isBlank(givenNameValue) ? \"\"\n+              : new String(givenNameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+    }\n+    List<String> surnames = attributeMapper.getMappedAttributes(request, \"sn\");\n+    String sn = \"\";\n+    if (surnames.size() > 0) {\n+      String surnameValue = surnames.get(0);\n+      sn = StringUtils.isBlank(surnameValue) ? \"\"\n+              : new String(surnameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+    }\n+    return StringUtils.join(new String[] { givenName, sn }, \" \");\n+  }\n+\n+  /**\n+   * Extracts the e-mail from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the e-mail address\n+   */\n+  private String extractEmail(HttpServletRequest request) {\n+    List<String> mailAdresses = attributeMapper.getMappedAttributes(request, \"mail\");\n+    if (mailAdresses.size() > 0) {\n+      String mailValue = mailAdresses.get(0);\n+      String mail = StringUtils.isBlank(mailValue) ? \"\"\n+              : new String(mailValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+      return mail;\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  /**\n+   * Extracts the e-mail from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the e-mail address\n+   */\n+  private String extractDisplayName(HttpServletRequest request) {\n+    List<String> displayNames = attributeMapper.getMappedAttributes(request, \"displayName\");\n+    if (displayNames.size() > 0) {\n+      String displayNameValue = displayNames.get(0);\n+      String displayName = StringUtils.isBlank(displayNameValue) ? \"\"\n+              : new String(displayNameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+      return displayName;\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  /**\n+   * Extracts the roles from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the roles\n+   */\n+  private Set<JpaRole> extractRoles(String id, HttpServletRequest request) {\n+    List<String> aaiRoles = attributeMapper.getMappedAttributes(request, \"roles\");\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+    Set<JpaRole> roles = new HashSet<JpaRole>();\n+    if (aaiRoles != null) {\n+      for (String aaiRole : aaiRoles) {\n+        roles.add(new JpaRole(aaiRole, organization));\n+      }\n+    }\n+    roles.add(new JpaRole(organization.getAnonymousRole(), organization));\n+    if (StringUtils.equals(id, bootstrapUserId)) {\n+      roles.add(new JpaRole(GLOBAL_ADMIN_ROLE, organization));\n+    }", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkzMzIxMg==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436933212", "bodyText": "Hi @lkiesow, long time no see... As I originally wrote this code, I can give some comments here.\nTo answer your question: https://github.com/opencast/opencast/blob/develop/etc/org.opencastproject.security.aai.ConfigurableLoginHandler.cfg#L12\n@jchssystems Assuming that the DynamicLoginHanlder replaces the ConfigurableLoginHandler, the bootstrap user logic is obsolete as you can configure a bootstrap user directly in the security configuration.\nBut the following changes seem missing to me:\n\nDelete ConfigurableLoginHandler.java\nDelete the configuration file of the ConfigurableLoginHandler (https://github.com/opencast/opencast/blob/develop/etc/org.opencastproject.security.aai.ConfigurableLoginHandler.cfg)\n\nAlso, please properly adjust the documentation (https://github.com/opencast/opencast/blob/develop/docs/guides/admin/docs/configuration/security.aai.md).\n\nStep 1 and 2 need to be revised quite a bit\nDon't forget to mention which are the mandatory headers that need to be configured in the \"new way\" in the security configuration to make Opencast work at all and which ones are optional\nPlease explain how bootstrapping works (even if the example in the security configuration makes this obvious to me)\n\n@JulianKniephoff This change should be mentioned in https://docs.opencast.org/develop/admin/#upgrade/#_top (Upgrading 8.x to 9.x) as it is not obvious that adaptors which use Shibboleth need to adapt their configuration quite a bit.", "author": "staubesv", "createdAt": "2020-06-08T19:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3NDYzNA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r437174634", "bodyText": "@staubesv good to hear from you again, and thanks for the heads up. \ud83d\ude04 Will do when/if this is merged.", "author": "JulianKniephoff", "createdAt": "2020-06-09T06:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcxMDczNw==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r438710737", "bodyText": "What's the rule for assigning the global admin role here?\n\nBackward compatibility. However it is also possible to assign this ROLE in the SpEL configuration, so we will remove bootstrapUserId", "author": "hsssystems", "createdAt": "2020-06-11T11:12:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcxMTg1Ng==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r438711856", "bodyText": "Delete ConfigurableLoginHandler.java\n\n\nDelete the configuration file of the ConfigurableLoginHandler (https://github.com/opencast/opencast/blob/develop/etc/org.opencastproject.security.aai.ConfigurableLoginHandler.cfg)\n\n\n\nIt is still possible to use the old ConfigurableLoginHandler. Our intention was a new / additional LoginHandler, not to replace the old one.", "author": "hsssystems", "createdAt": "2020-06-11T11:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg0ODYwMw==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r438848603", "bodyText": "@jchssystems As far as I understand, the DynamicLoginHandler offers a superset of the functionality of the ConfigureableLoginHandler. Why should Opencast include both the ConfigurableLoginHandler and the DynamicLoginHandler? That is just more code with no added value...", "author": "staubesv", "createdAt": "2020-06-11T14:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4MDAwMg==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r438880002", "bodyText": "@staubesv we did not want to break existing configurations for backward compatibility, not every adopter needs this functionality. My proposal: we continue with both handlers, first writing a dedicated documentation for the DynamicLoginHandler, fixing all issues and finally make a new PR to remove the ConfigurableLoginHandler", "author": "hsssystems", "createdAt": "2020-06-11T15:37:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxNDMzNw==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r439014337", "bodyText": "@jchssystems No strong opinion, but you could expect adopters to change the configuration. Note, however, that \"fixing all issues\" should be done before merging ;-)", "author": "staubesv", "createdAt": "2020-06-11T19:18:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczOTIxNA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r443739214", "bodyText": "bootstrapUserId was removed.\nA new independent documentation will be made when all the code be fixed.", "author": "jchssystems", "createdAt": "2020-06-22T18:10:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc0NDc5OQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r443744799", "bodyText": "In my opinion you should not force to use one or another login handler (or a third in the future).", "author": "jchssystems", "createdAt": "2020-06-22T18:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Njk3NQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436296975", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } else {\n          \n          \n            \n                  return new JpaOrganization(org.getId(), org.getName(), org.getServers(), org.getAdminRole(),\n          \n          \n            \n                       org.getAnonymousRole(), org.getProperties());\n          \n          \n            \n                }\n          \n          \n            \n                }\n          \n          \n            \n                return new JpaOrganization(org.getId(), org.getName(), org.getServers(), org.getAdminRole(),\n          \n          \n            \n                     org.getAnonymousRole(), org.getProperties());", "author": "lkiesow", "createdAt": "2020-06-06T20:07:15Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;\n+\n+  /** Role assigned to all Shibboleth authenticated users */\n+  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;\n+\n+  /*\n+   * It is the bundle matterhorn-kernel what will need to instantiate the ConfigurableLoginHandler\n+   * since it is wired using Spring Security.\n+   * Since Shibboleth support is supposed to be an optional extension of the bundle matterhorn-kernel,\n+   * we implement this as fragment bundle.\n+   * The use of the Service Component Runtime (SCR) would require us to declare this bundle as service\n+   * component in matterhorn-kernel which we don't want since it is optional.\n+   * To make us visible to the config admin and take advantage of the ManagedService mechanism, we\n+   * register us as ManagedService in the constructor.\n+   * An alternative solution would be to include the manifest of all fragments in matterhorn-kernel, i.e.\n+   * by specifying OSGI-INF/*.xml as service component in matterhorn-kernel.\n+   */\n+  public DynamicLoginHandler() {\n+    BundleContext bundleContext = FrameworkUtil.getBundle(this.getClass()).getBundleContext();\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  protected DynamicLoginHandler(BundleContext bundleContext) {\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  private void registerAsManagedService(BundleContext bundleContext) {\n+    Dictionary<String, String> properties = new Hashtable<String, String>();\n+    properties.put(\"service.pid\", this.getClass().getName());\n+    bundleContext.registerService(ManagedService.class.getName(), this, properties);\n+  }\n+\n+  @Override\n+  public void updated(Dictionary<String, ?> properties) throws ConfigurationException {\n+    // TODO Auto-generated method stub\n+  }\n+\n+  /**\n+   * Handle a new user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void newUserLogin(String id, HttpServletRequest request) {\n+    String name = extractName(request);\n+    String email = extractEmail(request);\n+    Date loginDate = new Date();\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+\n+    // Compile the list of roles\n+    Set<JpaRole> roles = extractRoles(id, request);\n+\n+    // Create the user reference\n+    JpaUserReference userReference = new JpaUserReference(id, name, email, MECH_SHIBBOLETH, loginDate, organization,\n+            roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in for the first time\", id);\n+    userReferenceProvider.addUserReference(userReference, MECH_SHIBBOLETH);\n+  }\n+\n+  /**\n+   * Handle an existing user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void existingUserLogin(String id, HttpServletRequest request) {\n+    Organization organization = securityService.getOrganization();\n+\n+    // Load the user reference\n+    JpaUserReference userReference = userReferenceProvider.findUserReference(id, organization.getId());\n+    if (userReference == null) {\n+      //Triggers creation of user reference\n+      //Possible problem: if there is user (not reference) with that id, we will get conflicts\n+      throw new UsernameNotFoundException(\"User reference '\" + id + \"' was not found\");\n+    }\n+\n+    // Update the reference\n+    userReference.setName(extractName(request));\n+    userReference.setEmail(extractEmail(request));\n+    userReference.setLastLogin(new Date());\n+    Set<JpaRole> roles = extractRoles(id, request);\n+    userReference.setRoles(roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in\", id);\n+    userReferenceProvider.updateUserReference(userReference);\n+  }\n+\n+  /**\n+   * Sets the security service.\n+   *\n+   * @param securityService\n+   *          the security service\n+   */\n+  public void setSecurityService(SecurityService securityService) {\n+    this.securityService = securityService;\n+  }\n+\n+  /**\n+   * Sets the user reference provider.\n+   *\n+   * @param userReferenceProvider\n+   *          the user reference provider\n+   */\n+  public void setUserReferenceProvider(UserReferenceProvider userReferenceProvider) {\n+    this.userReferenceProvider = userReferenceProvider;\n+  }\n+\n+  /**\n+   * Extracts the name from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the name\n+   */\n+  private String extractName(HttpServletRequest request) {\n+    String displayName = extractDisplayName(request);\n+    if (displayName != null && !\"\".equals(displayName)) {\n+      return displayName;\n+    }\n+    List<String> givenNames = attributeMapper.getMappedAttributes(request, \"givenName\");\n+    String givenName = \"\";\n+    if (givenNames.size() > 0) {\n+      String givenNameValue = givenNames.get(0);\n+      givenName = StringUtils.isBlank(givenNameValue) ? \"\"\n+              : new String(givenNameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+    }\n+    List<String> surnames = attributeMapper.getMappedAttributes(request, \"sn\");\n+    String sn = \"\";\n+    if (surnames.size() > 0) {\n+      String surnameValue = surnames.get(0);\n+      sn = StringUtils.isBlank(surnameValue) ? \"\"\n+              : new String(surnameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+    }\n+    return StringUtils.join(new String[] { givenName, sn }, \" \");\n+  }\n+\n+  /**\n+   * Extracts the e-mail from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the e-mail address\n+   */\n+  private String extractEmail(HttpServletRequest request) {\n+    List<String> mailAdresses = attributeMapper.getMappedAttributes(request, \"mail\");\n+    if (mailAdresses.size() > 0) {\n+      String mailValue = mailAdresses.get(0);\n+      String mail = StringUtils.isBlank(mailValue) ? \"\"\n+              : new String(mailValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+      return mail;\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  /**\n+   * Extracts the e-mail from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the e-mail address\n+   */\n+  private String extractDisplayName(HttpServletRequest request) {\n+    List<String> displayNames = attributeMapper.getMappedAttributes(request, \"displayName\");\n+    if (displayNames.size() > 0) {\n+      String displayNameValue = displayNames.get(0);\n+      String displayName = StringUtils.isBlank(displayNameValue) ? \"\"\n+              : new String(displayNameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+      return displayName;\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  /**\n+   * Extracts the roles from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the roles\n+   */\n+  private Set<JpaRole> extractRoles(String id, HttpServletRequest request) {\n+    List<String> aaiRoles = attributeMapper.getMappedAttributes(request, \"roles\");\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+    Set<JpaRole> roles = new HashSet<JpaRole>();\n+    if (aaiRoles != null) {\n+      for (String aaiRole : aaiRoles) {\n+        roles.add(new JpaRole(aaiRole, organization));\n+      }\n+    }\n+    roles.add(new JpaRole(organization.getAnonymousRole(), organization));\n+    if (StringUtils.equals(id, bootstrapUserId)) {\n+      roles.add(new JpaRole(GLOBAL_ADMIN_ROLE, organization));\n+    }\n+    return roles;\n+  }\n+\n+  /**\n+   * Creates a JpaOrganization from an organization\n+   *\n+   * @param org\n+   *          the organization\n+   */\n+  private JpaOrganization fromOrganization(Organization org) {\n+    if (org instanceof JpaOrganization) {\n+      return (JpaOrganization) org;\n+    } else {\n+      return new JpaOrganization(org.getId(), org.getName(), org.getServers(), org.getAdminRole(),\n+           org.getAnonymousRole(), org.getProperties());\n+    }", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NzIzOA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436297238", "bodyText": "There are a lot of to-dos", "author": "lkiesow", "createdAt": "2020-06-06T20:11:13Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;\n+\n+  /** Role assigned to all Shibboleth authenticated users */\n+  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;\n+\n+  /*\n+   * It is the bundle matterhorn-kernel what will need to instantiate the ConfigurableLoginHandler\n+   * since it is wired using Spring Security.\n+   * Since Shibboleth support is supposed to be an optional extension of the bundle matterhorn-kernel,\n+   * we implement this as fragment bundle.\n+   * The use of the Service Component Runtime (SCR) would require us to declare this bundle as service\n+   * component in matterhorn-kernel which we don't want since it is optional.\n+   * To make us visible to the config admin and take advantage of the ManagedService mechanism, we\n+   * register us as ManagedService in the constructor.\n+   * An alternative solution would be to include the manifest of all fragments in matterhorn-kernel, i.e.\n+   * by specifying OSGI-INF/*.xml as service component in matterhorn-kernel.\n+   */\n+  public DynamicLoginHandler() {\n+    BundleContext bundleContext = FrameworkUtil.getBundle(this.getClass()).getBundleContext();\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  protected DynamicLoginHandler(BundleContext bundleContext) {\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  private void registerAsManagedService(BundleContext bundleContext) {\n+    Dictionary<String, String> properties = new Hashtable<String, String>();\n+    properties.put(\"service.pid\", this.getClass().getName());\n+    bundleContext.registerService(ManagedService.class.getName(), this, properties);\n+  }\n+\n+  @Override\n+  public void updated(Dictionary<String, ?> properties) throws ConfigurationException {\n+    // TODO Auto-generated method stub\n+  }\n+\n+  /**\n+   * Handle a new user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void newUserLogin(String id, HttpServletRequest request) {\n+    String name = extractName(request);\n+    String email = extractEmail(request);\n+    Date loginDate = new Date();\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+\n+    // Compile the list of roles\n+    Set<JpaRole> roles = extractRoles(id, request);\n+\n+    // Create the user reference\n+    JpaUserReference userReference = new JpaUserReference(id, name, email, MECH_SHIBBOLETH, loginDate, organization,\n+            roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in for the first time\", id);\n+    userReferenceProvider.addUserReference(userReference, MECH_SHIBBOLETH);\n+  }\n+\n+  /**\n+   * Handle an existing user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void existingUserLogin(String id, HttpServletRequest request) {\n+    Organization organization = securityService.getOrganization();\n+\n+    // Load the user reference\n+    JpaUserReference userReference = userReferenceProvider.findUserReference(id, organization.getId());\n+    if (userReference == null) {\n+      //Triggers creation of user reference\n+      //Possible problem: if there is user (not reference) with that id, we will get conflicts\n+      throw new UsernameNotFoundException(\"User reference '\" + id + \"' was not found\");\n+    }\n+\n+    // Update the reference\n+    userReference.setName(extractName(request));\n+    userReference.setEmail(extractEmail(request));\n+    userReference.setLastLogin(new Date());\n+    Set<JpaRole> roles = extractRoles(id, request);\n+    userReference.setRoles(roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in\", id);\n+    userReferenceProvider.updateUserReference(userReference);\n+  }\n+\n+  /**\n+   * Sets the security service.\n+   *\n+   * @param securityService\n+   *          the security service\n+   */\n+  public void setSecurityService(SecurityService securityService) {\n+    this.securityService = securityService;\n+  }\n+\n+  /**\n+   * Sets the user reference provider.\n+   *\n+   * @param userReferenceProvider\n+   *          the user reference provider\n+   */\n+  public void setUserReferenceProvider(UserReferenceProvider userReferenceProvider) {\n+    this.userReferenceProvider = userReferenceProvider;\n+  }\n+\n+  /**\n+   * Extracts the name from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the name\n+   */\n+  private String extractName(HttpServletRequest request) {\n+    String displayName = extractDisplayName(request);\n+    if (displayName != null && !\"\".equals(displayName)) {\n+      return displayName;\n+    }\n+    List<String> givenNames = attributeMapper.getMappedAttributes(request, \"givenName\");\n+    String givenName = \"\";\n+    if (givenNames.size() > 0) {\n+      String givenNameValue = givenNames.get(0);\n+      givenName = StringUtils.isBlank(givenNameValue) ? \"\"\n+              : new String(givenNameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+    }\n+    List<String> surnames = attributeMapper.getMappedAttributes(request, \"sn\");\n+    String sn = \"\";\n+    if (surnames.size() > 0) {\n+      String surnameValue = surnames.get(0);\n+      sn = StringUtils.isBlank(surnameValue) ? \"\"\n+              : new String(surnameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+    }\n+    return StringUtils.join(new String[] { givenName, sn }, \" \");\n+  }\n+\n+  /**\n+   * Extracts the e-mail from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the e-mail address\n+   */\n+  private String extractEmail(HttpServletRequest request) {\n+    List<String> mailAdresses = attributeMapper.getMappedAttributes(request, \"mail\");\n+    if (mailAdresses.size() > 0) {\n+      String mailValue = mailAdresses.get(0);\n+      String mail = StringUtils.isBlank(mailValue) ? \"\"\n+              : new String(mailValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+      return mail;\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  /**\n+   * Extracts the e-mail from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the e-mail address\n+   */\n+  private String extractDisplayName(HttpServletRequest request) {\n+    List<String> displayNames = attributeMapper.getMappedAttributes(request, \"displayName\");\n+    if (displayNames.size() > 0) {\n+      String displayNameValue = displayNames.get(0);\n+      String displayName = StringUtils.isBlank(displayNameValue) ? \"\"\n+              : new String(displayNameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+      return displayName;\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  /**\n+   * Extracts the roles from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the roles\n+   */\n+  private Set<JpaRole> extractRoles(String id, HttpServletRequest request) {\n+    List<String> aaiRoles = attributeMapper.getMappedAttributes(request, \"roles\");\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+    Set<JpaRole> roles = new HashSet<JpaRole>();\n+    if (aaiRoles != null) {\n+      for (String aaiRole : aaiRoles) {\n+        roles.add(new JpaRole(aaiRole, organization));\n+      }\n+    }\n+    roles.add(new JpaRole(organization.getAnonymousRole(), organization));\n+    if (StringUtils.equals(id, bootstrapUserId)) {\n+      roles.add(new JpaRole(GLOBAL_ADMIN_ROLE, organization));\n+    }\n+    return roles;\n+  }\n+\n+  /**\n+   * Creates a JpaOrganization from an organization\n+   *\n+   * @param org\n+   *          the organization\n+   */\n+  private JpaOrganization fromOrganization(Organization org) {\n+    if (org instanceof JpaOrganization) {\n+      return (JpaOrganization) org;\n+    } else {\n+      return new JpaOrganization(org.getId(), org.getName(), org.getServers(), org.getAdminRole(),\n+           org.getAnonymousRole(), org.getProperties());\n+    }\n+  }\n+\n+  /**\n+   * {@inheritDoc}\n+   *\n+   * @see org.opencastproject.userdirectory.api.GroupRoleProvider#getRoles()\n+   */\n+  @Override\n+  public Iterator<Role> getRoles() {\n+    JaxbOrganization organization = JaxbOrganization.fromOrganization(securityService.getOrganization());\n+    HashSet<Role> roles = new HashSet<Role>();\n+    roles.add(new JaxbRole(roleFederationMember, organization));\n+    roles.add(new JaxbRole(organization.getAnonymousRole(), organization));\n+    roles.addAll(securityService.getUser().getRoles());\n+    return roles.iterator();\n+  }\n+\n+  /**\n+   * @see org.opencastproject.security.api.RoleProvider#getRolesForUser(String)\n+   */\n+  @Override\n+  public List<Role> getRolesForUser(String userName) {\n+      ArrayList<Role> roles = new ArrayList<Role>();\n+      User user = userReferenceProvider.loadUser(userName);\n+      if (user != null)\n+        roles.addAll(user.getRoles());\n+      return roles;\n+  }\n+\n+  /**\n+   * @see org.opencastproject.security.api.RoleProvider#getOrganization()\n+   */\n+  @Override\n+  public String getOrganization() {\n+    return UserProvider.ALL_ORGANIZATIONS;\n+  }\n+\n+  /**\n+   * @see org.opencastproject.security.api.RoleProvider#findRoles(String, Role.Target, int, int)\n+   */\n+  @Override\n+  public Iterator<Role> findRoles(String query, Role.Target target, int offset, int limit) {\n+    if (query == null)\n+      throw new IllegalArgumentException(\"Query must be set\");\n+    HashSet<Role> foundRoles = new HashSet<Role>();\n+    for (Iterator<Role> it = getRoles(); it.hasNext();) {\n+      Role role = it.next();\n+      if (like(role.getName(), query) || like(role.getDescription(), query))\n+        foundRoles.add(role);\n+    }\n+    return offsetLimitCollection(offset, limit, foundRoles).iterator();\n+  }\n+\n+  private <T> HashSet<T> offsetLimitCollection(int offset, int limit, HashSet<T> entries) {\n+    HashSet<T> result = new HashSet<T>();\n+    int i = 0;\n+    for (T entry : entries) {\n+      if (limit != 0 && result.size() >= limit)\n+        break;\n+      if (i >= offset)\n+        result.add(entry);\n+      i++;\n+    }\n+    return result;\n+  }\n+\n+  private boolean like(String string, final String query) {\n+    String regex = query.replace(\"_\", \".\").replace(\"%\", \".*?\");\n+    Pattern p = Pattern.compile(regex, Pattern.CASE_INSENSITIVE | Pattern.DOTALL);\n+    return p.matcher(string).matches();\n+  }\n+\n+  @Override\n+  public void afterPropertiesSet() throws Exception {\n+    this.userReferenceProvider.setRoleProvider(this);\n+  }\n+\n+  public AttributeMapper getAttributeMapper() {\n+    return attributeMapper;\n+  }\n+\n+  public void setAttributeMapper(AttributeMapper attributeMapper) {\n+    this.attributeMapper = attributeMapper;\n+  }\n+\n+  @Override\n+  public List<Role> getRolesForGroup(String groupName) {\n+    // TODO Auto-generated method stub\n+    return null;\n+  }\n+\n+  @Override\n+  public void updateGroupMembershipFromRoles(String userName, String orgId, List<String> roleList) {\n+    // TODO Auto-generated method stub\n+  }\n+\n+  @Override\n+  public void addGroup(JpaGroup group) throws UnauthorizedException {\n+    // TODO Auto-generated method stub\n+  }\n+\n+  @Override\n+  public Iterator<Group> getGroups() {\n+    // TODO Auto-generated method stub\n+    return null;\n+  }\n+\n+  @Override\n+  public void createGroup(String name, String description, String roles, String users)\n+         throws IllegalArgumentException, UnauthorizedException, ConflictException {\n+    // TODO Auto-generated method stub\n+  }\n+\n+  @Override\n+  public void updateGroup(String groupId, String name, String description, String roles, String users)\n+         throws NotFoundException, UnauthorizedException {\n+    // TODO Auto-generated method stub\n+  }", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NTIwNw==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r443755207", "bodyText": "Fix", "author": "jchssystems", "createdAt": "2020-06-22T18:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NzIzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MTkzMA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436941930", "bodyText": "Obsolete if removing bootstrap user", "author": "staubesv", "createdAt": "2020-06-08T19:16:21Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NTUwNg==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r443755506", "bodyText": "Removed", "author": "jchssystems", "createdAt": "2020-06-22T18:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MTkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MjM3Mg==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436942372", "bodyText": "Leftover from old code", "author": "staubesv", "createdAt": "2020-06-08T19:16:42Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc0NTA2MA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r443745060", "bodyText": "CFG_ROLE_FEDERATION_DEFAULT was removed", "author": "jchssystems", "createdAt": "2020-06-22T18:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MjM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MjczOQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436942739", "bodyText": "Obsolete when removing boot strap user", "author": "staubesv", "createdAt": "2020-06-08T19:17:01Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczOTQxMw==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r443739413", "bodyText": "bootstrapUserId was removed.", "author": "jchssystems", "createdAt": "2020-06-22T18:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MjczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc0NTIzOQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r443745239", "bodyText": "bootstrapUserId was also removed", "author": "jchssystems", "createdAt": "2020-06-22T18:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MjczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MjkxNQ==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436942915", "bodyText": "Leftover from old version", "author": "staubesv", "createdAt": "2020-06-08T19:17:12Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;\n+\n+  /** Role assigned to all Shibboleth authenticated users */\n+  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczOTY5Ng==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r443739696", "bodyText": "CFG_ROLE_FEDERATION_DEFAULT was also removed", "author": "jchssystems", "createdAt": "2020-06-22T18:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MjkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MzUwOA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r436943508", "bodyText": "DynamicLoginHandler", "author": "staubesv", "createdAt": "2020-06-08T19:17:43Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;\n+\n+  /** Role assigned to all Shibboleth authenticated users */\n+  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;\n+\n+  /*\n+   * It is the bundle matterhorn-kernel what will need to instantiate the ConfigurableLoginHandler", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcxODI4MA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r438718280", "bodyText": "Isn't it sufficient to implement only GroupRoleProvider?", "author": "hsssystems", "createdAt": "2020-06-11T11:29:29Z", "path": "modules/userdirectory/src/main/java/org/opencastproject/userdirectory/JpaGroupRoleProvider.java", "diffHunk": "@@ -81,7 +82,7 @@\n   immediate = true,\n   service = { RoleProvider.class, JpaGroupRoleProvider.class }\n )\n-public class JpaGroupRoleProvider extends AbstractIndexProducer implements RoleProvider, GroupProvider {\n+public class JpaGroupRoleProvider extends AbstractIndexProducer implements RoleProvider, GroupProvider, GroupRoleProvider {", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxMzY5NA==", "url": "https://github.com/opencast/opencast/pull/1607#discussion_r439013694", "bodyText": "\u00a0@jchssystems bootstrapUserId is loaded from the configuration file in the original ConfigurableLoginHandler. As you don't it in DynamicLoginHandler, bootstrapUserId will always be null. But since you can configure a bootstrap user in the security configuration, it is safe to just omit those lines here.", "author": "staubesv", "createdAt": "2020-06-11T19:17:14Z", "path": "modules/security-aai/src/main/java/org/opencastproject/security/aai/DynamicLoginHandler.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.opencastproject.security.aai;\n+\n+import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;\n+\n+import org.opencastproject.security.aai.api.AttributeMapper;\n+import org.opencastproject.security.api.Group;\n+import org.opencastproject.security.api.JaxbOrganization;\n+import org.opencastproject.security.api.JaxbRole;\n+import org.opencastproject.security.api.Organization;\n+import org.opencastproject.security.api.Role;\n+import org.opencastproject.security.api.SecurityService;\n+import org.opencastproject.security.api.UnauthorizedException;\n+import org.opencastproject.security.api.User;\n+import org.opencastproject.security.api.UserProvider;\n+import org.opencastproject.security.impl.jpa.JpaGroup;\n+import org.opencastproject.security.impl.jpa.JpaOrganization;\n+import org.opencastproject.security.impl.jpa.JpaRole;\n+import org.opencastproject.security.impl.jpa.JpaUserReference;\n+import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;\n+import org.opencastproject.userdirectory.ConflictException;\n+import org.opencastproject.userdirectory.api.GroupRoleProvider;\n+import org.opencastproject.userdirectory.api.UserReferenceProvider;\n+import org.opencastproject.util.NotFoundException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.service.cm.ConfigurationException;\n+import org.osgi.service.cm.ManagedService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Dictionary;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+/**\n+ * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create\n+ * and update Opencast reference users provided and authenticated by an external identity provider.\n+ * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes\n+ * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).\n+ */\n+//public class DynamicLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService, InitializingBean {\n+public class DynamicLoginHandler implements ShibbolethLoginHandler, GroupRoleProvider, ManagedService, InitializingBean {\n+\n+  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */\n+  private static final String CFG_ROLE_FEDERATION_DEFAULT = \"ROLE_AAI_USER\";\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(DynamicLoginHandler.class);\n+\n+  /** The user reference provider */\n+  private UserReferenceProvider userReferenceProvider = null;\n+\n+  /** The security service */\n+  private SecurityService securityService = null;\n+\n+  /** The security service */\n+  private AttributeMapper attributeMapper = null;\n+\n+  /** The ID of the bootstrap user if configured */\n+  private String bootstrapUserId = null;\n+\n+  /** Role assigned to all Shibboleth authenticated users */\n+  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;\n+\n+  /*\n+   * It is the bundle matterhorn-kernel what will need to instantiate the ConfigurableLoginHandler\n+   * since it is wired using Spring Security.\n+   * Since Shibboleth support is supposed to be an optional extension of the bundle matterhorn-kernel,\n+   * we implement this as fragment bundle.\n+   * The use of the Service Component Runtime (SCR) would require us to declare this bundle as service\n+   * component in matterhorn-kernel which we don't want since it is optional.\n+   * To make us visible to the config admin and take advantage of the ManagedService mechanism, we\n+   * register us as ManagedService in the constructor.\n+   * An alternative solution would be to include the manifest of all fragments in matterhorn-kernel, i.e.\n+   * by specifying OSGI-INF/*.xml as service component in matterhorn-kernel.\n+   */\n+  public DynamicLoginHandler() {\n+    BundleContext bundleContext = FrameworkUtil.getBundle(this.getClass()).getBundleContext();\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  protected DynamicLoginHandler(BundleContext bundleContext) {\n+    registerAsManagedService(bundleContext);\n+  }\n+\n+  private void registerAsManagedService(BundleContext bundleContext) {\n+    Dictionary<String, String> properties = new Hashtable<String, String>();\n+    properties.put(\"service.pid\", this.getClass().getName());\n+    bundleContext.registerService(ManagedService.class.getName(), this, properties);\n+  }\n+\n+  @Override\n+  public void updated(Dictionary<String, ?> properties) throws ConfigurationException {\n+    // TODO Auto-generated method stub\n+  }\n+\n+  /**\n+   * Handle a new user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void newUserLogin(String id, HttpServletRequest request) {\n+    String name = extractName(request);\n+    String email = extractEmail(request);\n+    Date loginDate = new Date();\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+\n+    // Compile the list of roles\n+    Set<JpaRole> roles = extractRoles(id, request);\n+\n+    // Create the user reference\n+    JpaUserReference userReference = new JpaUserReference(id, name, email, MECH_SHIBBOLETH, loginDate, organization,\n+            roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in for the first time\", id);\n+    userReferenceProvider.addUserReference(userReference, MECH_SHIBBOLETH);\n+  }\n+\n+  /**\n+   * Handle an existing user login.\n+   *\n+   * @param id\n+   *          The identity of the user, ideally the Shibboleth persistent unique identifier\n+   * @param request\n+   *          The request, for accessing any other Shibboleth variables\n+   */\n+  @Override\n+  public void existingUserLogin(String id, HttpServletRequest request) {\n+    Organization organization = securityService.getOrganization();\n+\n+    // Load the user reference\n+    JpaUserReference userReference = userReferenceProvider.findUserReference(id, organization.getId());\n+    if (userReference == null) {\n+      //Triggers creation of user reference\n+      //Possible problem: if there is user (not reference) with that id, we will get conflicts\n+      throw new UsernameNotFoundException(\"User reference '\" + id + \"' was not found\");\n+    }\n+\n+    // Update the reference\n+    userReference.setName(extractName(request));\n+    userReference.setEmail(extractEmail(request));\n+    userReference.setLastLogin(new Date());\n+    Set<JpaRole> roles = extractRoles(id, request);\n+    userReference.setRoles(roles);\n+\n+    logger.debug(\"Shibboleth user '{}' logged in\", id);\n+    userReferenceProvider.updateUserReference(userReference);\n+  }\n+\n+  /**\n+   * Sets the security service.\n+   *\n+   * @param securityService\n+   *          the security service\n+   */\n+  public void setSecurityService(SecurityService securityService) {\n+    this.securityService = securityService;\n+  }\n+\n+  /**\n+   * Sets the user reference provider.\n+   *\n+   * @param userReferenceProvider\n+   *          the user reference provider\n+   */\n+  public void setUserReferenceProvider(UserReferenceProvider userReferenceProvider) {\n+    this.userReferenceProvider = userReferenceProvider;\n+  }\n+\n+  /**\n+   * Extracts the name from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the name\n+   */\n+  private String extractName(HttpServletRequest request) {\n+    String displayName = extractDisplayName(request);\n+    if (displayName != null && !\"\".equals(displayName)) {\n+      return displayName;\n+    }\n+    List<String> givenNames = attributeMapper.getMappedAttributes(request, \"givenName\");\n+    String givenName = \"\";\n+    if (givenNames.size() > 0) {\n+      String givenNameValue = givenNames.get(0);\n+      givenName = StringUtils.isBlank(givenNameValue) ? \"\"\n+              : new String(givenNameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+    }\n+    List<String> surnames = attributeMapper.getMappedAttributes(request, \"sn\");\n+    String sn = \"\";\n+    if (surnames.size() > 0) {\n+      String surnameValue = surnames.get(0);\n+      sn = StringUtils.isBlank(surnameValue) ? \"\"\n+              : new String(surnameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+    }\n+    return StringUtils.join(new String[] { givenName, sn }, \" \");\n+  }\n+\n+  /**\n+   * Extracts the e-mail from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the e-mail address\n+   */\n+  private String extractEmail(HttpServletRequest request) {\n+    List<String> mailAdresses = attributeMapper.getMappedAttributes(request, \"mail\");\n+    if (mailAdresses.size() > 0) {\n+      String mailValue = mailAdresses.get(0);\n+      String mail = StringUtils.isBlank(mailValue) ? \"\"\n+              : new String(mailValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+      return mail;\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  /**\n+   * Extracts the e-mail from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the e-mail address\n+   */\n+  private String extractDisplayName(HttpServletRequest request) {\n+    List<String> displayNames = attributeMapper.getMappedAttributes(request, \"displayName\");\n+    if (displayNames.size() > 0) {\n+      String displayNameValue = displayNames.get(0);\n+      String displayName = StringUtils.isBlank(displayNameValue) ? \"\"\n+              : new String(displayNameValue.getBytes(StandardCharsets.ISO_8859_1),\n+                      StandardCharsets.UTF_8);\n+      return displayName;\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  /**\n+   * Extracts the roles from the request.\n+   *\n+   * @param request\n+   *          the request\n+   * @return the roles\n+   */\n+  private Set<JpaRole> extractRoles(String id, HttpServletRequest request) {\n+    List<String> aaiRoles = attributeMapper.getMappedAttributes(request, \"roles\");\n+    JpaOrganization organization = fromOrganization(securityService.getOrganization());\n+    Set<JpaRole> roles = new HashSet<JpaRole>();\n+    if (aaiRoles != null) {\n+      for (String aaiRole : aaiRoles) {\n+        roles.add(new JpaRole(aaiRole, organization));\n+      }\n+    }\n+    roles.add(new JpaRole(organization.getAnonymousRole(), organization));\n+    if (StringUtils.equals(id, bootstrapUserId)) {", "originalCommit": "c66e404f99afa38ee81c79ffbb23169d8dff5c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8eafa18644ef117826e929c1631353662fab0e8c", "url": "https://github.com/opencast/opencast/commit/8eafa18644ef117826e929c1631353662fab0e8c", "message": "  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #501517 FIX Update group memberships in Shibboleth LoginHandler\n\nrefs #501517 ADD Dynamic login handler based on spring expressions\n\n  refs #501517 ADD Tests for dynamic login handler based on spring expressions\n\n  refs #501517 FIX Interfaces and maven-dependency-plugin\n\nrefs #4870 FIX map email and name\n\nrefs #4943 FIX Fallback to user create when there is no user reference for existing users\n\n  - FIXME Check for existence of non-ref user first\n\n  FIX securitty.aai Checkstyle\n\n  FIX userdirectory Checkstyle\n\n  FIX all\n\n  refs #502450 FIX Shibboleth Dynamic Loginhandler\n\nrefs #2965 FIX Example configuration for Dynamic loginhandler\n\nrefs #2965 FIX Use spring util 3.1 xsd - not tested\n\n  - FIXME We may need to update pom.xml\n\nrefs #2965 FIX Mockdata", "committedDate": "2020-06-22T17:51:33Z", "type": "forcePushed"}, {"oid": "d50d7b2c996de45e2868814414458b56610fd41b", "url": "https://github.com/opencast/opencast/commit/d50d7b2c996de45e2868814414458b56610fd41b", "message": "  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #501517 FIX Update group memberships in Shibboleth LoginHandler\n\nrefs #501517 ADD Dynamic login handler based on spring expressions\n\n  refs #501517 ADD Tests for dynamic login handler based on spring expressions\n\n  refs #501517 FIX Interfaces and maven-dependency-plugin\n\nrefs #4870 FIX map email and name\n\nrefs #4943 FIX Fallback to user create when there is no user reference for existing users\n\n  - FIXME Check for existence of non-ref user first\n\n  FIX securitty.aai Checkstyle\n\n  FIX userdirectory Checkstyle\n\n  FIX all\n\n  refs #502450 FIX Shibboleth Dynamic Loginhandler\n\nrefs #2965 FIX Example configuration for Dynamic loginhandler\n\nrefs #2965 FIX Use spring util 3.1 xsd - not tested\n\n  - FIXME We may need to update pom.xml\n\nrefs #2965 FIX Mockdata", "committedDate": "2020-06-22T19:15:06Z", "type": "forcePushed"}, {"oid": "e7d19b6ae7273bc5a1719dd653574e87e34e2f6d", "url": "https://github.com/opencast/opencast/commit/e7d19b6ae7273bc5a1719dd653574e87e34e2f6d", "message": "  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #502450 ADD Shibboleth Dynamic Loginhandler\n\n  refs #501517 FIX Update group memberships in Shibboleth LoginHandler\n\nrefs #501517 ADD Dynamic login handler based on spring expressions\n\n  refs #501517 ADD Tests for dynamic login handler based on spring expressions\n\n  refs #501517 FIX Interfaces and maven-dependency-plugin\n\nrefs #4870 FIX map email and name\n\nrefs #4943 FIX Fallback to user create when there is no user reference for existing users\n\n  - FIXME Check for existence of non-ref user first\n\n  FIX securitty.aai Checkstyle\n\n  FIX userdirectory Checkstyle\n\n  FIX all\n\n  refs #502450 FIX Shibboleth Dynamic Loginhandler\n\nrefs #2965 FIX Example configuration for Dynamic loginhandler\n\nrefs #2965 FIX Use spring util 3.1 xsd - not tested\n\n  - FIXME We may need to update pom.xml\n\nrefs #2965 FIX Mockdata", "committedDate": "2020-08-03T12:22:13Z", "type": "commit"}, {"oid": "e7ae2664061c1eb5b03006eb5942d18cbd691f69", "url": "https://github.com/opencast/opencast/commit/e7ae2664061c1eb5b03006eb5942d18cbd691f69", "message": "refs #5049 FIX Do not use sn or givenName since we have only displayName in OC", "committedDate": "2020-08-03T12:23:10Z", "type": "commit"}, {"oid": "423fa4a3aec51f2121fe2d81d2abe8ddb4a899c5", "url": "https://github.com/opencast/opencast/commit/423fa4a3aec51f2121fe2d81d2abe8ddb4a899c5", "message": "refs #2965 REFACTOR structure of interfaces", "committedDate": "2020-08-03T12:23:34Z", "type": "commit"}, {"oid": "774194dbea5b3c2dbdf8d891a93ece62eb292590", "url": "https://github.com/opencast/opencast/commit/774194dbea5b3c2dbdf8d891a93ece62eb292590", "message": "refs #2965 REFACTOR deleting unnecessary variables", "committedDate": "2020-08-03T12:24:50Z", "type": "commit"}, {"oid": "c37b22a0df471185ef6a30a2927445f6801f99ae", "url": "https://github.com/opencast/opencast/commit/c37b22a0df471185ef6a30a2927445f6801f99ae", "message": "refs #2965 REFACTOR Interfaces and config for the Dynamic Login Handler", "committedDate": "2020-08-03T12:25:54Z", "type": "commit"}, {"oid": "c37b22a0df471185ef6a30a2927445f6801f99ae", "url": "https://github.com/opencast/opencast/commit/c37b22a0df471185ef6a30a2927445f6801f99ae", "message": "refs #2965 REFACTOR Interfaces and config for the Dynamic Login Handler", "committedDate": "2020-08-03T12:25:54Z", "type": "forcePushed"}, {"oid": "daab1df751dfdbe0a3726cace432845ae9586a39", "url": "https://github.com/opencast/opencast/commit/daab1df751dfdbe0a3726cace432845ae9586a39", "message": "  refs #2965 FIX Set html Entities in java documentation", "committedDate": "2020-08-03T14:50:18Z", "type": "commit"}]}