{"pr_number": 2044, "pr_title": "Add S3 presigned URL support", "pr_createdAt": "2020-11-04T02:26:38Z", "pr_url": "https://github.com/opencast/opencast/pull/2044", "timeline": [{"oid": "e7849673cd436f8d506840014407c9bf920f33f6", "url": "https://github.com/opencast/opencast/commit/e7849673cd436f8d506840014407c9bf920f33f6", "message": "Add S3 presigned URL support", "committedDate": "2020-11-04T06:24:04Z", "type": "forcePushed"}, {"oid": "bc0b8b2129c7c1a0b036fc432def78f622949b55", "url": "https://github.com/opencast/opencast/commit/bc0b8b2129c7c1a0b036fc432def78f622949b55", "message": "Add S3 presigned URL support", "committedDate": "2020-11-04T07:01:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0NTAxNg==", "url": "https://github.com/opencast/opencast/pull/2044#discussion_r520845016", "bodyText": "We should be enforcing a maximum here.  Looking at the AWS docs, a simple max of 6 hours ought to do it - then we don't have to figure out what kind of credentials we are working with.", "author": "gregorydlogan", "createdAt": "2020-11-10T20:11:21Z", "path": "modules/distribution-service-aws-s3/src/main/java/org/opencastproject/distribution/aws/s3/AwsS3DistributionServiceImpl.java", "diffHunk": "@@ -227,6 +241,16 @@ public void activate(ComponentContext cc) {\n       pathStyle = Boolean.valueOf(getAWSConfigKey(cc, AWS_S3_PATH_STYLE_CONFIG));\n       logger.info(\"AWS path style is {}\", pathStyle);\n \n+      // AWS presigned URL\n+      String presignedUrlConfigValue = OsgiUtil.getComponentContextProperty(cc, AWS_S3_PRESIGNED_URL_CONFIG, \"false\");\n+      presignedUrl = StringUtils.equalsIgnoreCase(\"true\", presignedUrlConfigValue);\n+      logger.info(\"AWS use presigned URL: {}\", presignedUrl);\n+\n+      // AWS presigned URL expiration time in millis\n+      String presignedUrlExpTimeMillisConfigValue = OsgiUtil.getComponentContextProperty(cc,\n+              AWS_S3_PRESIGNED_URL_VALID_DURATION_CONFIG, null);\n+      presignedUrlValidDuration = NumberUtils.toInt(presignedUrlExpTimeMillisConfigValue, DEFAULT_PRESIGNED_URL_EXPIRE_MILLIS);", "originalCommit": "bc0b8b2129c7c1a0b036fc432def78f622949b55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkyNjEyNA==", "url": "https://github.com/opencast/opencast/pull/2044#discussion_r523926124", "bodyText": "You mean, set the valid duration to 6 hours and remove the AWS_S3_PRESIGNED_URL_VALID_DURATION_CONFIG ?\nWhat about set the default value to 6 hours, and still give users the ability to change it?", "author": "Gao-Jun", "createdAt": "2020-11-16T06:47:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0NTAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyMDQ5MA==", "url": "https://github.com/opencast/opencast/pull/2044#discussion_r524220490", "bodyText": "I'm fine setting the default to 6 hours, and leaving the ability to change it, but reading the presigned url docs there is an absolute max duration we can create a valid URL for.  We should be trying to make sure we can't let the Opencast adopter set up requests which are invalid for their account type.\nMy initial read was incorrect in thinking 6 hours was the value, in actuality 7 days is the max with the right mix of credentials and signing version.  I would set the default to 6 hours, and have it check to make sure the user has not specified a duration longer than 7 days.  Ideally we could check the credential type, but I'm not entirely sure how to do that.  If you know how then adding some logic to automatically select the correct AWS-defined maximum duration would be awesome too.", "author": "gregorydlogan", "createdAt": "2020-11-16T12:30:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0NTAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1ODU5Ng==", "url": "https://github.com/opencast/opencast/pull/2044#discussion_r520858596", "bodyText": "I see a total of four MediaPackageSerializer implementations in the codebase, two of which would always be present.  At runtime you're going to get one of them, but perhaps not the right one.  I can see this especially being true if the adopter is distributing via both S3 and Opencast URL signing since these are both implemented with a serializer.", "author": "gregorydlogan", "createdAt": "2020-11-10T20:37:38Z", "path": "modules/authorization-xacml/src/main/java/org/opencastproject/authorization/xacml/XACMLAuthorizationService.java", "diffHunk": "@@ -110,6 +116,11 @@ public void modified(Map<String, Object> config) {\n     // updated() will handle the configuration update.\n   }\n \n+  @Reference(cardinality = ReferenceCardinality.OPTIONAL)\n+  public void setMediaPackageSerializer(MediaPackageSerializer serializer) {", "originalCommit": "bc0b8b2129c7c1a0b036fc432def78f622949b55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkyNzA1MA==", "url": "https://github.com/opencast/opencast/pull/2044#discussion_r523927050", "bodyText": "Yes, there are several MediaPackageSerializer. Yet, all of these are managed by ChainingMediaPackageSerializer, and the encodeURI, decodeURI method will processed by all serializer one by one.\nSerializers will check if the input URI should be processed by them. And PresignedUrlMediaPackageSerializer will only handle URI match S3 config.", "author": "Gao-Jun", "createdAt": "2020-11-16T06:50:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1ODU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDMyOTQ0MQ==", "url": "https://github.com/opencast/opencast/pull/2044#discussion_r664329441", "bodyText": "I think this can currently break in two ways, the first of which we are experiencing right now at SWITCH:\n\nThis will cause workspace ACL URLs to be signed with a Stream Security policy since the signing provider only has a base URL to go on (in this case the admin URL) and that matches here, but the signing provider wasn't previously invoked in this context. This will later cause workspace and WFR URLs not to match, which will cause unnecessary reloading of files.\nAs Greg said, there are multiple services providing the MediaPackageSerializer interface available via OSGI, so I don't see how you can guarantee to get the right one (or the one chaining up the rest). But then, we seem to do just that in other classes as well, and I don't understand how that works? Luck??", "author": "KatrinIhler", "createdAt": "2021-07-06T08:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1ODU5Ng=="}], "type": "inlineReview"}, {"oid": "2fb4b812ef3d2772672e69d586bcf8ac506f23c0", "url": "https://github.com/opencast/opencast/commit/2fb4b812ef3d2772672e69d586bcf8ac506f23c0", "message": "Add S3 presigned URL support", "committedDate": "2020-11-17T06:56:38Z", "type": "commit"}, {"oid": "2fb4b812ef3d2772672e69d586bcf8ac506f23c0", "url": "https://github.com/opencast/opencast/commit/2fb4b812ef3d2772672e69d586bcf8ac506f23c0", "message": "Add S3 presigned URL support", "committedDate": "2020-11-17T06:56:38Z", "type": "forcePushed"}]}