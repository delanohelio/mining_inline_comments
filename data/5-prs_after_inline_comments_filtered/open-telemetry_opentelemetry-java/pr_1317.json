{"pr_number": 1317, "pr_title": "Allow setting semantic attributes on Span.Builder", "pr_createdAt": "2020-06-08T08:17:28Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317", "timeline": [{"oid": "a8b1e7525a50d84c8760ff020c0ac23926847cd5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a8b1e7525a50d84c8760ff020c0ac23926847cd5", "message": "Allow setting semantic attributes on Span.Builder", "committedDate": "2020-06-08T08:16:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MDUxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436790510", "bodyText": "would it make sense to return this, or the builder from this call? Or does that not help make a more fluent API?", "author": "jkwatson", "createdAt": "2020-06-08T15:20:59Z", "path": "api/src/main/java/io/opentelemetry/trace/attributes/StringAttributeSetter.java", "diffHunk": "@@ -61,4 +61,14 @@ public String key() {\n   public void set(Span span, @Nullable String value) {\n     span.setAttribute(key(), value);\n   }\n+\n+  /**\n+   * Sets the attribute on the provided span builder.\n+   *\n+   * @param spanBuilder the span builder to add the attribute to\n+   * @param value the value for this attribute\n+   */\n+  public void set(Span.Builder spanBuilder, @Nullable String value) {\n+    spanBuilder.setAttribute(key(), value);", "originalCommit": "a8b1e7525a50d84c8760ff020c0ac23926847cd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MTk2MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436791960", "bodyText": "I guess it doesn't make any sense to return this, but would returning the Builder be at all useful?", "author": "jkwatson", "createdAt": "2020-06-08T15:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MDUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5Mjk0MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436792941", "bodyText": "And, I see that @Oberon00 already made this comment above. sorry for the extra noise.", "author": "jkwatson", "createdAt": "2020-06-08T15:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MDUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MzUyNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436793524", "bodyText": "SemanticAttributes are now used like this: SemanticAttribute.HTTP_URL.set(span, value). No quick way to have fluent interface out of this.", "author": "iNikem", "createdAt": "2020-06-08T15:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MDUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5NTQ0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436795448", "bodyText": "This test doesn't actually test anything except that you can loop over the fields of the class. Can we add some actual assertions about the functionality, rather than just making calls that don't test anything?", "author": "jkwatson", "createdAt": "2020-06-08T15:28:04Z", "path": "api/src/test/java/io/opentelemetry/trace/attributes/SemanticAttributesTest.java", "diffHunk": "@@ -51,15 +53,20 @@ public void shouldEnableSetAttributeOnSpan() throws IllegalAccessException {\n         keys.add(((StringAttributeSetter) attribute).key());\n         ((StringAttributeSetter) attribute).set(span, \"TestValue\");\n         ((StringAttributeSetter) attribute).set(span, null);\n+        ((StringAttributeSetter) attribute).set(builder, \"TestValue\");\n+        ((StringAttributeSetter) attribute).set(builder, null);\n       } else if (attribute instanceof LongAttributeSetter) {\n         keys.add(((LongAttributeSetter) attribute).key());\n         ((LongAttributeSetter) attribute).set(span, 42L);\n+        ((LongAttributeSetter) attribute).set(builder, 42L);\n       } else if (attribute instanceof DoubleAttributeSetter) {\n         keys.add(((DoubleAttributeSetter) attribute).key());\n         ((DoubleAttributeSetter) attribute).set(span, 3.14);\n+        ((DoubleAttributeSetter) attribute).set(builder, 3.14);\n       } else if (attribute instanceof BooleanAttributeSetter) {\n         keys.add(((BooleanAttributeSetter) attribute).key());\n         ((BooleanAttributeSetter) attribute).set(span, true);\n+        ((BooleanAttributeSetter) attribute).set(builder, true);", "originalCommit": "a8b1e7525a50d84c8760ff020c0ac23926847cd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwNzgzOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436807838", "bodyText": "Current test indeed only tested that you can call set method on every semantic attribute without any errors. But neither Span nor Span.Builder provides any API for reading attribute values. What else can you test here?", "author": "iNikem", "createdAt": "2020-06-08T15:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5NTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwOTk4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436809986", "bodyText": "You would usually mock the builder using Mockito and verify that builder.setAttribute was called once with key() and the provided value.", "author": "arminru", "createdAt": "2020-06-08T15:48:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5NTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxMTU5Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436811596", "bodyText": "You can additionally mock the Span instance and do the same.", "author": "jkwatson", "createdAt": "2020-06-08T15:51:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5NTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxOTE5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436819193", "bodyText": "To tell you the truth, we don't do this at all for existing classes (in SemanticAttributeTest that is) and thus I feel we should do it in a follow-up PR where we apply the mocking for all of them.", "author": "carlosalberto", "createdAt": "2020-06-08T16:01:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5NTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1MDc3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436850776", "bodyText": "Please create an issue for it, then. We need to make sure our tests are really useful. This isn't going to be available to the instrumentation project until the next release, anyway, so I'm not sure why we're in such a hurry to get this merged.", "author": "jkwatson", "createdAt": "2020-06-08T16:51:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5NTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1MjMwMg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436852302", "bodyText": "We have a branch against otel-java snapshots :)", "author": "iNikem", "createdAt": "2020-06-08T16:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5NTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NjAwMg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436856002", "bodyText": "I can do verification of mock calls, no problem.", "author": "iNikem", "createdAt": "2020-06-08T17:00:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5NTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MjU1Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1317#discussion_r436892556", "bodyText": "@jkwatson take a look now, please", "author": "iNikem", "createdAt": "2020-06-08T17:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5NTQ0OA=="}], "type": "inlineReview"}, {"oid": "b8ebf6e1cb6a12b5cc4dee9baabb561ef0f21b49", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/b8ebf6e1cb6a12b5cc4dee9baabb561ef0f21b49", "message": "Make test actually verify something", "committedDate": "2020-06-08T17:58:27Z", "type": "commit"}]}