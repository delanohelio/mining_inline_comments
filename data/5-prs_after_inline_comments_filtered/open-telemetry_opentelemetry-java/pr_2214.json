{"pr_number": 2214, "pr_title": "Span benchmark with OTLP exporter and collector", "pr_createdAt": "2020-12-07T21:39:18Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/2214", "timeline": [{"oid": "fc157c9fcc543b0b7c4ba7843ef7c28c894bdd13", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/fc157c9fcc543b0b7c4ba7843ef7c28c894bdd13", "message": "Refactored benchmark to use OTLP exporter and collector", "committedDate": "2020-12-07T21:01:00Z", "type": "commit"}, {"oid": "58aa94e7c63d7676e86cfa255e741f935598f0dc", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/58aa94e7c63d7676e86cfa255e741f935598f0dc", "message": "Refactoring to add  benchmarks with Simple and Batch span processors", "committedDate": "2020-12-08T06:35:23Z", "type": "commit"}, {"oid": "be9cc1bb1b2d2db3eb4ac7e2705c9251add792a8", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/be9cc1bb1b2d2db3eb4ac7e2705c9251add792a8", "message": "Removing otlp exporter from the collector config", "committedDate": "2020-12-08T06:44:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA3Njc5NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2214#discussion_r538076794", "bodyText": "While ryuk cleans things up usually, let's go ahead and add collector.stop() in a teardown", "author": "anuraaga", "createdAt": "2020-12-08T06:49:50Z", "path": "sdk/all/src/jmh/java/io/opentelemetry/sdk/trace/SpanPipelineBenchmark.java", "diffHunk": "@@ -5,96 +5,123 @@\n \n package io.opentelemetry.sdk.trace;\n \n-import static io.opentelemetry.api.common.AttributeKey.booleanKey;\n-import static io.opentelemetry.api.common.AttributeKey.doubleKey;\n-import static io.opentelemetry.api.common.AttributeKey.longKey;\n-import static io.opentelemetry.api.common.AttributeKey.stringKey;\n-\n-import io.opentelemetry.api.OpenTelemetry;\n-import io.opentelemetry.api.common.AttributeKey;\n-import io.opentelemetry.api.common.Attributes;\n import io.opentelemetry.api.trace.Span;\n-import io.opentelemetry.api.trace.Span.Kind;\n-import io.opentelemetry.api.trace.StatusCode;\n import io.opentelemetry.api.trace.Tracer;\n-import io.opentelemetry.sdk.OpenTelemetrySdk;\n-import io.opentelemetry.sdk.common.CompletableResultCode;\n-import io.opentelemetry.sdk.trace.data.SpanData;\n+import io.opentelemetry.exporter.otlp.OtlpGrpcSpanExporter;\n+import io.opentelemetry.sdk.trace.config.TraceConfig;\n+import io.opentelemetry.sdk.trace.export.BatchSpanProcessor;\n import io.opentelemetry.sdk.trace.export.SimpleSpanProcessor;\n-import io.opentelemetry.sdk.trace.export.SpanExporter;\n-import java.util.Collection;\n+import io.opentelemetry.sdk.trace.samplers.Sampler;\n import java.util.concurrent.TimeUnit;\n import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n import org.openjdk.jmh.annotations.Fork;\n import org.openjdk.jmh.annotations.Level;\n import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n import org.openjdk.jmh.annotations.OutputTimeUnit;\n import org.openjdk.jmh.annotations.Scope;\n import org.openjdk.jmh.annotations.Setup;\n import org.openjdk.jmh.annotations.State;\n import org.openjdk.jmh.annotations.Threads;\n import org.openjdk.jmh.annotations.Warmup;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.utility.DockerImageName;\n+import org.testcontainers.utility.MountableFile;\n \n-@State(Scope.Benchmark)\n public class SpanPipelineBenchmark {\n+  private SpanPipelineBenchmark() {}\n \n-  private static final AttributeKey<String> OPERATION_KEY = stringKey(\"operation\");\n-  private static final AttributeKey<Long> LONG_ATTRIBUTE_KEY = longKey(\"longAttribute\");\n-  private static final AttributeKey<String> STRING_ATTRIBUTE_KEY = stringKey(\"stringAttribute\");\n-  private static final AttributeKey<Double> DOUBLE_ATTRIBUTE_KEY = doubleKey(\"doubleAttribute\");\n-  private static final AttributeKey<Boolean> BOOLEAN_ATTRIBUTE_KEY = booleanKey(\"booleanAttribute\");\n-  private final Tracer tracer = OpenTelemetry.getGlobalTracerProvider().get(\"benchmarkTracer\");\n-\n-  @Setup(Level.Trial)\n-  public final void setup() {\n-    SpanExporter exporter = new NoOpSpanExporter();\n-    OpenTelemetrySdk.getGlobalTracerManagement()\n-        .addSpanProcessor(SimpleSpanProcessor.builder(exporter).build());\n-  }\n+  @State(Scope.Benchmark)\n+  public abstract static class AbstractProcessorBenchmark {\n+    private static final DockerImageName OTLP_COLLECTOR_IMAGE =\n+        DockerImageName.parse(\"otel/opentelemetry-collector-dev:latest\");\n+    private static final int EXPOSED_PORT = 5678;\n+    private static final int HEALTH_CHECK_PORT = 13133;\n+    private SpanBuilderSdk spanBuilderSdk;\n+    protected abstract SpanProcessor getSpanProcessor(String collectorAddress);\n+    protected abstract void runThePipeline();\n \n-  @Benchmark\n-  @Threads(value = 5)\n-  @Fork(1)\n-  @Warmup(iterations = 5, time = 1)\n-  @Measurement(iterations = 5, time = 1)\n-  @OutputTimeUnit(TimeUnit.MILLISECONDS)\n-  public void runThePipeline_05Threads() {\n-    doWork();\n-  }\n+    protected void doWork() {\n+      Span span = spanBuilderSdk.startSpan();\n+      for (int i = 0; i < 10; i++) {\n+        span.setAttribute(\"benchmarkAttribute_\" + i, \"benchmarkAttrValue_\" + i);\n+      }\n+      span.end();\n+    }\n+\n+    @Setup(Level.Trial)\n+    public void setup() {\n+      // Configuring the collector test-container\n+      GenericContainer<?> collector =\n+          new GenericContainer<>(OTLP_COLLECTOR_IMAGE)\n+              .withExposedPorts(EXPOSED_PORT, HEALTH_CHECK_PORT)\n+              .waitingFor(Wait.forHttp(\"/\").forPort(HEALTH_CHECK_PORT))\n+              .withCopyFileToContainer(\n+                  MountableFile.forClasspathResource(\"/otel.yaml\"), \"/etc/otel.yaml\")\n+              .withCommand(\"--config /etc/otel.yaml\");\n+\n+      collector.start();", "originalCommit": "be9cc1bb1b2d2db3eb4ac7e2705c9251add792a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAwNTIyOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2214#discussion_r539005228", "bodyText": "An issue with doing collector.stop() in the teardown method is that the collector is shutdown before the span processor is able to export all the spans from the last benchmark iteration. For BSP, the spans can be flushed out before stopping the collector container but SSP doesn't offer any such functionality.\nLetting ryuk take care of the collector testContainer for us is probably the best way right now.", "author": "srprash", "createdAt": "2020-12-09T04:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA3Njc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA3NzUwMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2214#discussion_r538077501", "bodyText": "In #2223 I'm trying to add this to the builder to be able to configure the tracer provider in one go.\nIn the meantime, builder already has setTraceConfig so how about using that instead of the update?", "author": "anuraaga", "createdAt": "2020-12-08T06:51:40Z", "path": "sdk/all/src/jmh/java/io/opentelemetry/sdk/trace/SpanPipelineBenchmark.java", "diffHunk": "@@ -5,96 +5,123 @@\n \n package io.opentelemetry.sdk.trace;\n \n-import static io.opentelemetry.api.common.AttributeKey.booleanKey;\n-import static io.opentelemetry.api.common.AttributeKey.doubleKey;\n-import static io.opentelemetry.api.common.AttributeKey.longKey;\n-import static io.opentelemetry.api.common.AttributeKey.stringKey;\n-\n-import io.opentelemetry.api.OpenTelemetry;\n-import io.opentelemetry.api.common.AttributeKey;\n-import io.opentelemetry.api.common.Attributes;\n import io.opentelemetry.api.trace.Span;\n-import io.opentelemetry.api.trace.Span.Kind;\n-import io.opentelemetry.api.trace.StatusCode;\n import io.opentelemetry.api.trace.Tracer;\n-import io.opentelemetry.sdk.OpenTelemetrySdk;\n-import io.opentelemetry.sdk.common.CompletableResultCode;\n-import io.opentelemetry.sdk.trace.data.SpanData;\n+import io.opentelemetry.exporter.otlp.OtlpGrpcSpanExporter;\n+import io.opentelemetry.sdk.trace.config.TraceConfig;\n+import io.opentelemetry.sdk.trace.export.BatchSpanProcessor;\n import io.opentelemetry.sdk.trace.export.SimpleSpanProcessor;\n-import io.opentelemetry.sdk.trace.export.SpanExporter;\n-import java.util.Collection;\n+import io.opentelemetry.sdk.trace.samplers.Sampler;\n import java.util.concurrent.TimeUnit;\n import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n import org.openjdk.jmh.annotations.Fork;\n import org.openjdk.jmh.annotations.Level;\n import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n import org.openjdk.jmh.annotations.OutputTimeUnit;\n import org.openjdk.jmh.annotations.Scope;\n import org.openjdk.jmh.annotations.Setup;\n import org.openjdk.jmh.annotations.State;\n import org.openjdk.jmh.annotations.Threads;\n import org.openjdk.jmh.annotations.Warmup;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.utility.DockerImageName;\n+import org.testcontainers.utility.MountableFile;\n \n-@State(Scope.Benchmark)\n public class SpanPipelineBenchmark {\n+  private SpanPipelineBenchmark() {}\n \n-  private static final AttributeKey<String> OPERATION_KEY = stringKey(\"operation\");\n-  private static final AttributeKey<Long> LONG_ATTRIBUTE_KEY = longKey(\"longAttribute\");\n-  private static final AttributeKey<String> STRING_ATTRIBUTE_KEY = stringKey(\"stringAttribute\");\n-  private static final AttributeKey<Double> DOUBLE_ATTRIBUTE_KEY = doubleKey(\"doubleAttribute\");\n-  private static final AttributeKey<Boolean> BOOLEAN_ATTRIBUTE_KEY = booleanKey(\"booleanAttribute\");\n-  private final Tracer tracer = OpenTelemetry.getGlobalTracerProvider().get(\"benchmarkTracer\");\n-\n-  @Setup(Level.Trial)\n-  public final void setup() {\n-    SpanExporter exporter = new NoOpSpanExporter();\n-    OpenTelemetrySdk.getGlobalTracerManagement()\n-        .addSpanProcessor(SimpleSpanProcessor.builder(exporter).build());\n-  }\n+  @State(Scope.Benchmark)\n+  public abstract static class AbstractProcessorBenchmark {\n+    private static final DockerImageName OTLP_COLLECTOR_IMAGE =\n+        DockerImageName.parse(\"otel/opentelemetry-collector-dev:latest\");\n+    private static final int EXPOSED_PORT = 5678;\n+    private static final int HEALTH_CHECK_PORT = 13133;\n+    private SpanBuilderSdk spanBuilderSdk;\n+    protected abstract SpanProcessor getSpanProcessor(String collectorAddress);\n+    protected abstract void runThePipeline();\n \n-  @Benchmark\n-  @Threads(value = 5)\n-  @Fork(1)\n-  @Warmup(iterations = 5, time = 1)\n-  @Measurement(iterations = 5, time = 1)\n-  @OutputTimeUnit(TimeUnit.MILLISECONDS)\n-  public void runThePipeline_05Threads() {\n-    doWork();\n-  }\n+    protected void doWork() {\n+      Span span = spanBuilderSdk.startSpan();\n+      for (int i = 0; i < 10; i++) {\n+        span.setAttribute(\"benchmarkAttribute_\" + i, \"benchmarkAttrValue_\" + i);\n+      }\n+      span.end();\n+    }\n+\n+    @Setup(Level.Trial)\n+    public void setup() {\n+      // Configuring the collector test-container\n+      GenericContainer<?> collector =\n+          new GenericContainer<>(OTLP_COLLECTOR_IMAGE)\n+              .withExposedPorts(EXPOSED_PORT, HEALTH_CHECK_PORT)\n+              .waitingFor(Wait.forHttp(\"/\").forPort(HEALTH_CHECK_PORT))\n+              .withCopyFileToContainer(\n+                  MountableFile.forClasspathResource(\"/otel.yaml\"), \"/etc/otel.yaml\")\n+              .withCommand(\"--config /etc/otel.yaml\");\n+\n+      collector.start();\n+\n+      String address = collector.getHost() + \":\" + collector.getMappedPort(EXPOSED_PORT);\n+\n+      TracerSdkProvider tracerProvider = TracerSdkProvider.builder().build();\n+\n+      tracerProvider.addSpanProcessor(getSpanProcessor(address));", "originalCommit": "be9cc1bb1b2d2db3eb4ac7e2705c9251add792a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d0fb080dbe78696c8c9fbe3a291060ead2b7f6b4", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d0fb080dbe78696c8c9fbe3a291060ead2b7f6b4", "message": "Using setTraceConfig to set the initial config rather than update it", "committedDate": "2020-12-09T04:49:49Z", "type": "commit"}, {"oid": "32dd997e0232c2dbec6b9e02231b93e243461576", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/32dd997e0232c2dbec6b9e02231b93e243461576", "message": "Spotlessapply", "committedDate": "2020-12-09T19:53:37Z", "type": "commit"}]}