{"pr_number": 1193, "pr_title": "Fix getTracerLower behavior", "pr_createdAt": "2020-05-10T06:45:27Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193", "timeline": [{"oid": "e292c6779a0d56ab1e698f024f547fc3df9a3d50", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e292c6779a0d56ab1e698f024f547fc3df9a3d50", "message": "Fix getTracerLower behavior", "committedDate": "2020-05-10T06:43:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1NDMxNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r422654315", "bodyText": "Update comment?", "author": "bogdandrutu", "createdAt": "2020-05-10T14:39:27Z", "path": "api/src/main/java/io/opentelemetry/trace/TraceId.java", "diffHunk": "@@ -210,8 +210,8 @@ public boolean equals(@Nullable Object obj) {\n    *\n    * @return the lower 8 bytes of the trace-id as a long value, assuming little-endian order.", "originalCommit": "e292c6779a0d56ab1e698f024f547fc3df9a3d50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1NDQ4OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r422654489", "bodyText": "Not sure I understand this logic? Do we have a test for this?", "author": "bogdandrutu", "createdAt": "2020-05-10T14:40:47Z", "path": "api/src/main/java/io/opentelemetry/trace/TraceId.java", "diffHunk": "@@ -210,8 +210,8 @@ public boolean equals(@Nullable Object obj) {\n    *\n    * @return the lower 8 bytes of the trace-id as a long value, assuming little-endian order.\n    */\n-  public long getLowerLong() {\n-    return (idHi < 0) ? -idHi : idHi;\n+  public long getTraceRandomPart() {\n+    return (idLo < 0) ? -idLo : idLo;", "originalCommit": "e292c6779a0d56ab1e698f024f547fc3df9a3d50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc4OTY2NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r422789664", "bodyText": "I keep it as it was previously. This basically guarantees the first bit of idLo to be zero. However, I don't think this is the intended behavior.", "author": "thisthat", "createdAt": "2020-05-11T05:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1NDQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwMzU0NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r422803544", "bodyText": "I saw the problem in the probability sampler we compare this with a positive number so any negative number will pass that condition, so we don't have the guarantees of the rate. Essentially we need to change a bit the probability sampler if we return negative values as well", "author": "bogdandrutu", "createdAt": "2020-05-11T06:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1NDQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwODI0Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r422808243", "bodyText": "You're right! I'll take a look at it!", "author": "thisthat", "createdAt": "2020-05-11T06:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1NDQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkxMjk5OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r422912998", "bodyText": "The Probability sampler already takes the abs value of the result of getTraceRandomPart(). Therefore, we don't need to change its logic", "author": "thisthat", "createdAt": "2020-05-11T09:37:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1NDQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1NDU1Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r422654556", "bodyText": "s/testCorrectGetRandomTracePart/getRandomTracePart\nWe usually should test the \"correct\" thing :)", "author": "bogdandrutu", "createdAt": "2020-05-10T14:41:24Z", "path": "api/src/test/java/io/opentelemetry/trace/TraceIdTest.java", "diffHunk": "@@ -50,9 +50,13 @@ public void isValid() {\n   }\n \n   @Test\n-  public void getLowerLong() {\n-    assertThat(first.getLowerLong()).isEqualTo(0);\n-    assertThat(second.getLowerLong()).isEqualTo(-0xFF00000000000000L);\n+  public void testCorrectGetRandomTracePart() {", "originalCommit": "e292c6779a0d56ab1e698f024f547fc3df9a3d50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1NzQzNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r422657435", "bodyText": "We need to make sure every library applies the same logic and extract correctly the random part. This is important because if 2 libraries are configured with the same probability we need both to sample or not sample a given trace id.", "author": "bogdandrutu", "createdAt": "2020-05-10T15:05:07Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -210,7 +210,7 @@ public final Decision shouldSample(\n       // while allowing for a (very) small chance of *not* sampling if the id == Long.MAX_VALUE.\n       // This is considered a reasonable tradeoff for the simplicity/performance requirements (this\n       // code is executed in-line for every Span creation).\n-      return Math.abs(traceId.getLowerLong()) < getIdUpperBound()\n+      return Math.abs(traceId.getTraceRandomPart()) < getIdUpperBound()", "originalCommit": "e292c6779a0d56ab1e698f024f547fc3df9a3d50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc4ODg4Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r422788883", "bodyText": "I was looking at other languages how they implemented this, and it's all over the place. Looking at the spec, the only indication is to use part of the trace for the decision.", "author": "thisthat", "createdAt": "2020-05-11T05:28:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1NzQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1ODQxNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r422658415", "bodyText": "It took me few minutes to check that this is the correct expectation, I would suggest to put a 0 in front of the 9 so having something like 0x090A0B0C0D0E0F00L so I have 16 hex characters and also a easier way to map every 2 hex characters from here to the bytes.", "author": "bogdandrutu", "createdAt": "2020-05-10T15:13:10Z", "path": "api/src/test/java/io/opentelemetry/trace/TraceIdTest.java", "diffHunk": "@@ -50,9 +50,13 @@ public void isValid() {\n   }\n \n   @Test\n-  public void getLowerLong() {\n-    assertThat(first.getLowerLong()).isEqualTo(0);\n-    assertThat(second.getLowerLong()).isEqualTo(-0xFF00000000000000L);\n+  public void testCorrectGetRandomTracePart() {\n+    byte[] id = {\n+      0x1, 0x2, 0x3, 0x4, 0x5, 0x6, 0x7, 0x8,\n+      0x9, 0xA, 0xB, 0xC, 0xD, 0xE, 0xF, 0x0\n+    };\n+    TraceId traceid = TraceId.fromBytes(id, 0);\n+    assertThat(traceid.getTraceRandomPart()).isEqualTo(0x90A0B0C0D0E0F00L);", "originalCommit": "e292c6779a0d56ab1e698f024f547fc3df9a3d50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a6123205b71ddace2f1a46af4231c6305f180284", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a6123205b71ddace2f1a46af4231c6305f180284", "message": "Add test for negative trace representation", "committedDate": "2020-05-11T06:00:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwNTA0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r423105045", "bodyText": "We also have the TraceId ctor taking two longs. Could we add a test for that one as well?", "author": "carlosalberto", "createdAt": "2020-05-11T15:01:44Z", "path": "api/src/test/java/io/opentelemetry/trace/TraceIdTest.java", "diffHunk": "@@ -50,9 +50,36 @@ public void isValid() {\n   }\n \n   @Test\n-  public void getLowerLong() {\n-    assertThat(first.getLowerLong()).isEqualTo(0);\n-    assertThat(second.getLowerLong()).isEqualTo(-0xFF00000000000000L);\n+  public void testGetRandomTracePart() {\n+    byte[] id = {\n+      0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x00\n+    };\n+    TraceId traceid = TraceId.fromBytes(id, 0);", "originalCommit": "a6123205b71ddace2f1a46af4231c6305f180284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwOTE0Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1193#discussion_r423109146", "bodyText": "Never mind, saw that Bogdan doesn't want us to use that ctor. Resolving.", "author": "carlosalberto", "createdAt": "2020-05-11T15:07:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwNTA0NQ=="}], "type": "inlineReview"}]}