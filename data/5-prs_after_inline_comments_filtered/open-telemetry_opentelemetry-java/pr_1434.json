{"pr_number": 1434, "pr_title": "Implement Span.recordException", "pr_createdAt": "2020-07-20T02:53:18Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434", "timeline": [{"oid": "b8ab3fcf002690fd948cd8d8a9070ed005b1ace4", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/b8ab3fcf002690fd948cd8d8a9070ed005b1ace4", "message": "Implement Span.recordException", "committedDate": "2020-07-20T02:47:36Z", "type": "commit"}, {"oid": "77a16328d119304fe4d3223e7b58ec62715a5d3a", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/77a16328d119304fe4d3223e7b58ec62715a5d3a", "message": "License", "committedDate": "2020-07-20T03:01:29Z", "type": "commit"}, {"oid": "84abdf2f6bee13a9525adf424424c268539c244e", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/84abdf2f6bee13a9525adf424424c268539c244e", "message": "javadoc", "committedDate": "2020-07-20T03:21:53Z", "type": "commit"}, {"oid": "a4f1b5a8faeed9485bba0ba57a38e9cebe2fd815", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a4f1b5a8faeed9485bba0ba57a38e9cebe2fd815", "message": "Fix javadoc", "committedDate": "2020-07-20T03:37:36Z", "type": "commit"}, {"oid": "0f65572004c8c2729abb1f7856924f99b685ef10", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/0f65572004c8c2729abb1f7856924f99b685ef10", "message": "Tests for DefaultSpan", "committedDate": "2020-07-20T03:49:55Z", "type": "commit"}, {"oid": "7eed72efe82256c4df2efdb67fbac34d229c9186", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/7eed72efe82256c4df2efdb67fbac34d229c9186", "message": "PrintStream benchmark", "committedDate": "2020-07-20T08:15:24Z", "type": "commit"}, {"oid": "7e3c4ab4af525ffed5f202ecbf8e19c6586779ad", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/7e3c4ab4af525ffed5f202ecbf8e19c6586779ad", "message": "Check arguments", "committedDate": "2020-07-20T14:06:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1OTg4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r457559881", "bodyText": "Should we have a semantic \"attribute\" constant for this event name, as well? Seems like this event name is special, and canonical, so we should probably put it in the API somewhere.", "author": "jkwatson", "createdAt": "2020-07-20T17:02:03Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -395,6 +396,29 @@ public void setStatus(Status status) {\n     }\n   }\n \n+  @Override\n+  public void recordException(Throwable exception) {\n+    Preconditions.checkNotNull(exception, \"exception\");\n+    recordException(exception, clock.now());\n+  }\n+\n+  @Override\n+  public void recordException(Throwable exception, long timestamp) {\n+    Preconditions.checkNotNull(exception, \"exception\");\n+    Preconditions.checkArgument(timestamp >= 0, \"Negative timestamp\");\n+    Attributes.Builder attributes = Attributes.newBuilder();\n+    SemanticAttributes.EXCEPTION_TYPE.set(attributes, exception.getClass().getCanonicalName());\n+    if (exception.getMessage() != null) {\n+      SemanticAttributes.EXCEPTION_MESSAGE.set(attributes, exception.getMessage());\n+    }\n+    StringBuilder buffer = new StringBuilder();\n+    StringBuilderPrintWriter writer = new StringBuilderPrintWriter(buffer);\n+    exception.printStackTrace(writer);\n+    SemanticAttributes.EXCEPTION_STACKTRACE.set(attributes, buffer.toString());\n+\n+    addEvent(\"exception\", attributes.build(), timestamp);", "originalCommit": "7e3c4ab4af525ffed5f202ecbf8e19c6586779ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5NTEyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r457795122", "bodyText": "Added a constant", "author": "anuraaga", "createdAt": "2020-07-21T02:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1OTg4MQ=="}], "type": "inlineReview"}, {"oid": "666fd5696732d5f278f7edb12cd77bf5f30ff724", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/666fd5696732d5f278f7edb12cd77bf5f30ff724", "message": "Use StringWriter", "committedDate": "2020-07-21T01:53:16Z", "type": "commit"}, {"oid": "bfd3ebdd3f341b16688a5a24006da0d62d333163", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/bfd3ebdd3f341b16688a5a24006da0d62d333163", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-java into record-exception", "committedDate": "2020-07-21T02:10:50Z", "type": "commit"}, {"oid": "0b16b9b4dbc56121dc483b276c1190f4cd44d53e", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/0b16b9b4dbc56121dc483b276c1190f4cd44d53e", "message": "more merge and event name", "committedDate": "2020-07-21T02:14:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwMjkzMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r457802931", "bodyText": "\ud83d\udc4d", "author": "jkwatson", "createdAt": "2020-07-21T02:43:42Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -416,6 +419,31 @@ public void setStatus(Status status) {\n     }\n   }\n \n+  @Override\n+  public void recordException(Throwable exception) {\n+    if (exception == null) {\n+      return;\n+    }\n+    recordException(exception, clock.now());\n+  }\n+\n+  @Override\n+  public void recordException(Throwable exception, long timestamp) {\n+    if (exception == null) {\n+      return;\n+    }\n+    Attributes.Builder attributes = Attributes.newBuilder();\n+    SemanticAttributes.EXCEPTION_TYPE.set(attributes, exception.getClass().getCanonicalName());\n+    if (exception.getMessage() != null) {\n+      SemanticAttributes.EXCEPTION_MESSAGE.set(attributes, exception.getMessage());\n+    }\n+    StringWriter writer = new StringWriter();\n+    exception.printStackTrace(new PrintWriter(writer));\n+    SemanticAttributes.EXCEPTION_STACKTRACE.set(attributes, writer.toString());\n+\n+    addEvent(SemanticAttributes.EXCEPTION_EVENT_NAME, attributes.build(), timestamp);", "originalCommit": "0b16b9b4dbc56121dc483b276c1190f4cd44d53e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzQyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r458497420", "bodyText": "Would not add this method unless is necessary. Removing methods is harder than adding. I don't see a scenario when an exception happens and somehow later want to record it.", "author": "bogdandrutu", "createdAt": "2020-07-22T02:30:36Z", "path": "api/src/main/java/io/opentelemetry/trace/Span.java", "diffHunk": "@@ -217,6 +217,29 @@\n    */\n   void setStatus(Status status);\n \n+  /**\n+   * Records information about the {@link Throwable} to the {@link Span} as an {@link Event} at the\n+   * current time.\n+   *\n+   * @param exception the {@link Throwable} to record.\n+   * @since 0.7.0\n+   */\n+  void recordException(Throwable exception);\n+\n+  /**\n+   * Records information about the {@link Throwable} to the {@link Span} as an {@link Event}.\n+   *\n+   * <p>Use this method to specify an explicit event timestamp. If not called, the implementation\n+   * will use the current timestamp value, which should be the default case.\n+   *\n+   * <p>Important: this is NOT equivalent with System.nanoTime().\n+   *\n+   * @param exception the {@link Throwable} to record.\n+   * @param timestamp the explicit event timestamp in nanos since epoch.\n+   * @since 0.7.0\n+   */\n+  void recordException(Throwable exception, long timestamp);", "originalCommit": "0b16b9b4dbc56121dc483b276c1190f4cd44d53e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5OTk3Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r458499972", "bodyText": "I would argue anything with a timestamp needs to have a way to manually set it, because users may have their own clocks, or some similar reason where timing is kept track in their framework and they want to use it. I can remove this method but then I'd argue it's a pre-GA task to reconsider modeling exceptions as events since it means we don't consider the timestamp to be meaningful. @iNikem any thoughts?", "author": "anuraaga", "createdAt": "2020-07-22T02:40:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUwNTgwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r458505809", "bodyText": "Actually user using their own clock is the main reason I am against this :). Reason is we do a good job using nanoTime to ensure ordering of the events, but user does not have access to our internal clock so any time recorded by external user will not be order with the other events.", "author": "bogdandrutu", "createdAt": "2020-07-22T03:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUwNzUyNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r458507524", "bodyText": "I don't think this is correct in a general sense, many frameworks record timings at a level too deep for us to capture as accurately, at least without bytecode instrumentation. For example a \"wire send\" event, if it's recorded just before passing a buffer to netty will probably be many nanoseconds (even probably many microseconds) more accurate than what our instrumentation could pull off. Note that in this case, user is interchangable with instrumentation, the latter also needs to be able to pass on the accurate timings from the framework being instrumented. There is some concern about ordering issues with non-framework generated events, but I'd take the more accurate timings for things like DNS resolution, etc any day.\nBut I agree this seems far less useful for exceptions. So it makes me wonder whether we really need a timestamp for exceptions in the first place if, similar to a DNS query, we may miss out on a better timing provided by the framework if we choose not to allow that here.\nIn the meantime, I've removed the method though as it seems like a bigger discussion about why exception is modeled as Event instead of something without a timestamp.", "author": "anuraaga", "createdAt": "2020-07-22T03:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyOTA4Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r458529083", "bodyText": "I took a look at API defined by spec.\nAn Event is defined by the following properties:\n\n(Required) Name of the event.\n(Optional) One or more Attributes with the same restrictions as defined for Span Attributes.\n(Optional) Timestamp for the event.\n\nSeveral other API methods accept timestamp as well. Thus this method is totally within spec. Although I too have doubts if anyone will use it.", "author": "iNikem", "createdAt": "2020-07-22T04:36:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMDAyOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r458530028", "bodyText": "Thanks for the link to the spec! I didn't check it, just looked at our Java API. I feel our current API doesn't reflect the optional aspect of the Timestamp (at least the javadoc needs to be more explicit about using current time when not provided and pointing at a way to create an event without timestamps). In that case, I'm good with this API I'll investigate this optional-timestamp event case more generally in a separate PR.", "author": "anuraaga", "createdAt": "2020-07-22T04:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMTEwMg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r458531102", "bodyText": "Filed #1447 to track that", "author": "anuraaga", "createdAt": "2020-07-22T04:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMjc4Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r458532783", "bodyText": "Ah realized my comment was ambiguous - I meant I'm good with not including the method version that includes a timestamp. As part of #1447 I'll probably switch this to add an event without any timestamp.", "author": "anuraaga", "createdAt": "2020-07-22T04:51:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzU2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r458497566", "bodyText": "Is this change unrelated?", "author": "bogdandrutu", "createdAt": "2020-07-22T02:31:09Z", "path": "api/src/main/java/io/opentelemetry/trace/attributes/BooleanAttributeSetter.java", "diffHunk": "@@ -70,4 +71,14 @@ public void set(Span span, boolean value) {\n   public void set(Span.Builder spanBuilder, boolean value) {\n     spanBuilder.setAttribute(key(), value);\n   }\n+\n+  /**\n+   * Sets the attribute on the provided {@link Attributes.Builder}.\n+   *\n+   * @param attributesBuilder the attributes builder to add the attribute to\n+   * @param value the value for this attribute\n+   */\n+  public void set(Attributes.Builder attributesBuilder, boolean value) {", "originalCommit": "0b16b9b4dbc56121dc483b276c1190f4cd44d53e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzYwMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1434#discussion_r458497601", "bodyText": "Unrelated change?", "author": "bogdandrutu", "createdAt": "2020-07-22T02:31:23Z", "path": "api/src/main/java/io/opentelemetry/trace/attributes/DoubleAttributeSetter.java", "diffHunk": "@@ -70,4 +71,14 @@ public void set(Span span, double value) {\n   public void set(Span.Builder spanBuilder, double value) {\n     spanBuilder.setAttribute(key(), value);\n   }\n+\n+  /**\n+   * Sets the attribute on the provided {@link Attributes.Builder}.\n+   *\n+   * @param attributesBuilder the attributes builder to add the attribute to\n+   * @param value the value for this attribute\n+   */\n+  public void set(Attributes.Builder attributesBuilder, double value) {", "originalCommit": "0b16b9b4dbc56121dc483b276c1190f4cd44d53e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "97ac3f4f24e423a3fd8610c4327ba13553b3bac5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/97ac3f4f24e423a3fd8610c4327ba13553b3bac5", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-java into record-exception", "committedDate": "2020-07-22T03:01:39Z", "type": "commit"}, {"oid": "99e65408e303a83e9eaaee85935161ae5df87e90", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/99e65408e303a83e9eaaee85935161ae5df87e90", "message": "Remove timestamp recordException", "committedDate": "2020-07-22T03:08:21Z", "type": "commit"}]}