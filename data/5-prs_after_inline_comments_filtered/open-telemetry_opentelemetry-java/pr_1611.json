{"pr_number": 1611, "pr_title": "Implement spec change to only accept Context as span parent.", "pr_createdAt": "2020-09-01T15:00:17Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611", "timeline": [{"oid": "8154b328cd463c45b21c3613b466bf308c15d388", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8154b328cd463c45b21c3613b466bf308c15d388", "message": "Prototype for Context as span parent.", "committedDate": "2020-09-01T14:55:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI1NzI0MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481257241", "bodyText": "This is only used in the OpenTracingShim so far and the usage there is questionable (but might actually be helpful for baggage propagation @carlosalberto?), so we could remove this change if we want to minimize the PR. This in turn would remove the changes to DefaultSpan which in turn would remove many usage changes that create a DefaultSpan.\nI initially introduced this getter because I thought it was logical that this should be propagated even for the default span, but now I'm not so sure anymore -- the instrumentation should be responsible for propagating the context, not the span, right?", "author": "Oberon00", "createdAt": "2020-09-01T16:03:35Z", "path": "api/src/main/java/io/opentelemetry/trace/Span.java", "diffHunk": "@@ -283,6 +283,14 @@\n    */\n   SpanContext getContext();\n \n+  /**\n+   * Returns the parent {@code Context} associated with this {@code Span}.\n+   *\n+   * @return the parent {@code Context} associated with this {@code Span}.\n+   * @since 0.8.0\n+   */\n+  Context getParent();", "originalCommit": "8154b328cd463c45b21c3613b466bf308c15d388", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5NTE5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481295193", "bodyText": "I simplified the PR in e102def, but the state at a7fccf4 is also still interesting, as it provides additional features (and DefaultSpan.createInContext might be an useful addition for unit tests).", "author": "Oberon00", "createdAt": "2020-09-01T16:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI1NzI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4Mjc0Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481282746", "bodyText": "This is a bug I found when writing this. setNoParent and then calling setParent(Context) will ignore the context.", "author": "Oberon00", "createdAt": "2020-09-01T16:37:08Z", "path": "api/src/main/java/io/opentelemetry/trace/DefaultTracer.java", "diffHunk": "@@ -67,43 +67,32 @@ static NoopSpanBuilder create(String spanName) {\n     }\n \n     private boolean isRootSpan;\n-    @Nullable private SpanContext spanContext;\n+    @Nullable private Context parent;\n \n     @Override\n     public Span startSpan() {\n-      if (spanContext == null && !isRootSpan) {\n-        spanContext = TracingContextUtils.getCurrentSpan().getContext();\n+      if (parent == null) {\n+        parent = Context.current();\n+      }\n+      if (isRootSpan) {\n+        parent = TracingContextUtils.withSpan(DefaultSpan.getInvalid(), parent);\n       }\n \n-      return spanContext != null && !SpanContext.getInvalid().equals(spanContext)\n-          ? new DefaultSpan(spanContext)\n-          : DefaultSpan.getInvalid();\n-    }\n-\n-    @Override\n-    public NoopSpanBuilder setParent(Span parent) {\n-      Utils.checkNotNull(parent, \"parent\");\n-      spanContext = parent.getContext();\n-      return this;\n-    }\n-\n-    @Override\n-    public NoopSpanBuilder setParent(SpanContext remoteParent) {\n-      Utils.checkNotNull(remoteParent, \"remoteParent\");\n-      spanContext = remoteParent;\n-      return this;\n+      return new DefaultSpan(TracingContextUtils.getSpan(parent).getContext(), parent);\n     }\n \n     @Override\n     public NoopSpanBuilder setParent(Context context) {\n       Utils.checkNotNull(context, \"context\");\n-      spanContext = TracingContextUtils.getSpan(context).getContext();\n+      isRootSpan = false; // TODO port this fix to mainline", "originalCommit": "8154b328cd463c45b21c3613b466bf308c15d388", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU5MzQxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481593417", "bodyText": "worth fixing in a separate PR?", "author": "jkwatson", "createdAt": "2020-09-02T03:12:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4Mjc0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NDI0Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481874242", "bodyText": "I created #1617", "author": "Oberon00", "createdAt": "2020-09-02T08:18:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4Mjc0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1MDk3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r482250970", "bodyText": "thanks!", "author": "jkwatson", "createdAt": "2020-09-02T17:40:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4Mjc0Ng=="}], "type": "inlineReview"}, {"oid": "a7fccf470dd250441820c43ae00bca840a1fdd48", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a7fccf470dd250441820c43ae00bca840a1fdd48", "message": "Simplify ZipkinSpanExporterEndToEndHttpTest.", "committedDate": "2020-09-01T16:55:01Z", "type": "commit"}, {"oid": "e102deff195ea8f8088f59e28de9edbdadbfa079", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e102deff195ea8f8088f59e28de9edbdadbfa079", "message": "Minimize PR diff.", "committedDate": "2020-09-01T16:55:52Z", "type": "commit"}, {"oid": "5500b81d50b13fe508c6c3ac5489410aa21004eb", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/5500b81d50b13fe508c6c3ac5489410aa21004eb", "message": "Make Codecov happy.", "committedDate": "2020-09-01T17:26:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgxMzYwMg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481813602", "bodyText": "I don't quite understand what we're getting from the change in this PR. It seems we round-trip through Context API instead of much more efficiently accessing fields directly?", "author": "anuraaga", "createdAt": "2020-09-02T07:07:55Z", "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -508,7 +501,7 @@ private Status getStatusWithDefault() {\n   }\n \n   SpanId getParentSpanId() {\n-    return parentSpanId;\n+    return TracingContextUtils.getSpan(parent).getContext().getSpanId();", "originalCommit": "5500b81d50b13fe508c6c3ac5489410aa21004eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg0NjQyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481846420", "bodyText": "This spec change (this PR is an implementation of) has two purposes:\n\nEnable passing arbitrary information between propagators inject, extract and exporters (and in the future, after #856 and #881 the samplers). One may argue that the SpanContext would be better for this, but it's TraceState is very constrained and inefficient to use for this, and it is (per spec!) a final class fully defined in the API (see open-telemetry/opentelemetry-specification#905 (comment)).\nEncourage users to properly propagate the context (it's easier to use Tracer.withSpan than doing the whole dance of TracingContextUtils.contextWithSpan(parentSpan, Context.current() which is intentionally made more cumbersome. For example, see the Actor propagation change which previously contained what I would call a bug, as it lost all information in the Context except for the span.", "author": "Oberon00", "createdAt": "2020-09-02T07:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgxMzYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxMDk3NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r489310975", "bodyText": "This no longer applies.", "author": "Oberon00", "createdAt": "2020-09-16T09:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgxMzYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgxOTA1MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481819050", "bodyText": "For example, for a root span this looks almost like this series of expensive no-ops\nTracingContextUtils.getSpan(TracingContextUtils.withSpan(DefaultSpan.getInvalid(), Context.current())).getContext()\nvs\nDefaultSpan.getInvalid()", "author": "anuraaga", "createdAt": "2020-09-02T07:14:37Z", "path": "api/src/main/java/io/opentelemetry/trace/DefaultTracer.java", "diffHunk": "@@ -67,43 +67,32 @@ static NoopSpanBuilder create(String spanName) {\n     }\n \n     private boolean isRootSpan;\n-    @Nullable private SpanContext spanContext;\n+    @Nullable private Context parent;\n \n     @Override\n     public Span startSpan() {\n-      if (spanContext == null && !isRootSpan) {\n-        spanContext = TracingContextUtils.getCurrentSpan().getContext();\n+      if (parent == null) {\n+        parent = Context.current();\n+      }\n+      if (isRootSpan) {\n+        parent = TracingContextUtils.withSpan(DefaultSpan.getInvalid(), parent);\n       }\n \n-      return spanContext != null && !SpanContext.getInvalid().equals(spanContext)\n-          ? new DefaultSpan(spanContext)\n-          : DefaultSpan.getInvalid();\n-    }\n-\n-    @Override\n-    public NoopSpanBuilder setParent(Span parent) {\n-      Utils.checkNotNull(parent, \"parent\");\n-      spanContext = parent.getContext();\n-      return this;\n-    }\n-\n-    @Override\n-    public NoopSpanBuilder setParent(SpanContext remoteParent) {\n-      Utils.checkNotNull(remoteParent, \"remoteParent\");\n-      spanContext = remoteParent;\n-      return this;\n+      return new DefaultSpan(TracingContextUtils.getSpan(parent).getContext());", "originalCommit": "5500b81d50b13fe508c6c3ac5489410aa21004eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1NTkxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481855910", "bodyText": "Fixed in 0eb9829.", "author": "Oberon00", "createdAt": "2020-09-02T07:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgxOTA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyMDUxOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481820519", "bodyText": "Context isn't data, it's a way to move data around in-process, not out-of-process", "author": "anuraaga", "createdAt": "2020-09-02T07:16:21Z", "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/data/SpanData.java", "diffHunk": "@@ -77,6 +78,15 @@\n    */\n   SpanId getParentSpanId();\n \n+  /**\n+   * Returns the parent {@code Context}. If the {@code Span} is a root {@code Span}, the Context\n+   * will contain no Span or an invalid span.\n+   *\n+   * @return the parent {@code SpanId} or an invalid SpanId if this is a root {@code Span}.\n+   * @since 0.8.0\n+   */\n+  Context getParent();", "originalCommit": "5500b81d50b13fe508c6c3ac5489410aa21004eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1MTY3OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481851678", "bodyText": "I disagree. The inflexibility of SpanContext/TraceState leaves no other choice to transmit nonstandard information from propagators to exporters. See #1611 (comment)", "author": "Oberon00", "createdAt": "2020-09-02T07:53:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyMDUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1OTEwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481859105", "bodyText": "I guess they are data, but not span data which may be what's confusing me. The context could have who knows what, maybe from the user, or some other library, and much of it wouldn't even be related to the span. I don't think it's a good idea to send everything in the Context to the exporter, Context is a bag for known values. If SpanContext had List<Object> that would make much more sense since it's know to be span data for sure.", "author": "anuraaga", "createdAt": "2020-09-02T08:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyMDUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NjU3MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481876571", "bodyText": "If SpanContext had List<Object> that would make much more sense since it's know to be span data for sure.\n\nI actually do like that idea. Or probably a io.grpc.Context on the SpanContext instead since it has a nice API for retrieving keys in a type-safe manner / is basically a Map<Identifier, Object> on steroids.", "author": "Oberon00", "createdAt": "2020-09-02T08:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyMDUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3ODM5MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r481878391", "bodyText": "The context could have who knows what, maybe from the user, or some other library, and much of it wouldn't even be related to the span. I don't think it's a good idea to send everything in the Context to the exporter\n\nI don't see a problem with that though. The exporter would just retrieve any values it knows (often only the parent span context) and ignore the rest.", "author": "Oberon00", "createdAt": "2020-09-02T08:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyMDUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxMDU3OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r489310579", "bodyText": "Context is no longer considered storeable data now.", "author": "Oberon00", "createdAt": "2020-09-16T09:49:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyMDUxOQ=="}], "type": "inlineReview"}, {"oid": "0eb98299bacafc3a226a944e99be0245b3968d92", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/0eb98299bacafc3a226a944e99be0245b3968d92", "message": "Fix overcomplicated DefaultTracer.", "committedDate": "2020-09-02T07:57:34Z", "type": "commit"}, {"oid": "e152a50fd261702df19ff5cc0cf532ce80369c1c", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e152a50fd261702df19ff5cc0cf532ce80369c1c", "message": "Merge remote-tracking branch 'upstream/master' into feature/contextparent\n\nConflicts:\n\tapi/src/main/java/io/opentelemetry/trace/DefaultTracer.java", "committedDate": "2020-09-02T17:34:53Z", "type": "commit"}, {"oid": "a6308f5e153095ec33c801d198d0b531de6692d6", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a6308f5e153095ec33c801d198d0b531de6692d6", "message": "Merge remote-tracking branch 'upstream/master' into feature/contextparent\n\nConflicts:\n\texporters/jaeger/src/test/java/io/opentelemetry/exporters/jaeger/AdapterTest.java\n\texporters/zipkin/src/test/java/io/opentelemetry/exporters/zipkin/ZipkinSpanExporterEndToEndHttpTest.java\n\texporters/zipkin/src/test/java/io/opentelemetry/exporters/zipkin/ZipkinSpanExporterTest.java\n\tsdk/tracing/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java\n\tsdk/tracing/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n\tsdk/tracing/src/test/java/io/opentelemetry/sdk/trace/SpanBuilderSdkTest.java\n\ttesting_internal/src/main/java/io/opentelemetry/sdk/trace/TestSpanData.java", "committedDate": "2020-09-04T16:21:37Z", "type": "commit"}, {"oid": "66b6130c30fe65210a97919adffadb39223567aa", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/66b6130c30fe65210a97919adffadb39223567aa", "message": "Fix build after merge.", "committedDate": "2020-09-04T16:22:07Z", "type": "commit"}, {"oid": "2221c2af98fc5fda452ef437333874871c5991f8", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/2221c2af98fc5fda452ef437333874871c5991f8", "message": "Merge branch 'master' into feature/contextparent", "committedDate": "2020-09-11T08:13:31Z", "type": "commit"}, {"oid": "c24deafc238ba8e7d386491a9202039f4a4b31c5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/c24deafc238ba8e7d386491a9202039f4a4b31c5", "message": "Merge branch 'master' into feature/contextparent", "committedDate": "2020-09-15T14:05:56Z", "type": "commit"}, {"oid": "30fbaf74c9fa6e1f20346b91a762fe6d3932214a", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/30fbaf74c9fa6e1f20346b91a762fe6d3932214a", "message": "Fix build after merge.", "committedDate": "2020-09-15T14:24:02Z", "type": "commit"}, {"oid": "255cd9cf70f218fdbbccb9fe93b1b4e09509d997", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/255cd9cf70f218fdbbccb9fe93b1b4e09509d997", "message": "Merge remote-tracking branch 'upstream/master' into feature/contextparent", "committedDate": "2020-09-16T09:21:46Z", "type": "commit"}, {"oid": "2253f8dbade0c7c6591b1f07a2da4ed2bba31349", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/2253f8dbade0c7c6591b1f07a2da4ed2bba31349", "message": "Revert storage of full Context.", "committedDate": "2020-09-16T09:44:55Z", "type": "commit"}, {"oid": "2e275b267a0e8f23cf8bbeab4e97e41af5f107de", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/2e275b267a0e8f23cf8bbeab4e97e41af5f107de", "message": "Merge branch 'master' into feature/contextparent", "committedDate": "2020-09-23T14:20:18Z", "type": "commit"}, {"oid": "e8dc898e21cbc1c7428ee0383824e19fba3be9ba", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e8dc898e21cbc1c7428ee0383824e19fba3be9ba", "message": "Lint.", "committedDate": "2020-09-23T14:29:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r493747379", "bodyText": "youch. this API sure is ugly! Remind me again how this is going to make things easier/better for our users?", "author": "jkwatson", "createdAt": "2020-09-23T16:58:09Z", "path": "api/src/test/java/io/opentelemetry/trace/SpanBuilderTest.java", "diffHunk": "@@ -32,8 +33,8 @@\n   void doNotCrash_NoopImplementation() {\n     Span.Builder spanBuilder = tracer.spanBuilder(\"MySpanName\");\n     spanBuilder.setSpanKind(Kind.SERVER);\n-    spanBuilder.setParent(DefaultSpan.getInvalid());\n-    spanBuilder.setParent(DefaultSpan.getInvalid().getContext());\n+    spanBuilder.setParent(TracingContextUtils.withSpan(DefaultSpan.create(null), Context.ROOT));", "originalCommit": "e8dc898e21cbc1c7428ee0383824e19fba3be9ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc3NTY5Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r493775696", "bodyText": "This is a unit test. Normally you would just call setNoParent.", "author": "Oberon00", "createdAt": "2020-09-23T17:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5MjM5NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r493792395", "bodyText": "fair enough, but I think having to do parenting via the TCU is going to be pretty counter-intuitive to most users. :(", "author": "jkwatson", "createdAt": "2020-09-23T18:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5NzI4NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r493797284", "bodyText": "I fully agree, but at the same time, I don't think users should normally do that. Usually you would just use the implicit current parent, or sometimes you need to capture a context with Context.current() and forward that to somewhere else. If you start a span at one thread and need to continue it at another thread while not setting it as active in the current thread is the only place you would need TracingContextUtils. I also think there should be some may to make that more easy. I could imagine span.inCurrentContext() (Java 8 default methods?), or TracingContextUtils.spanInCurrent(span) to make this easier.\n\nRemind me again how this is going to make things easier/better for our users?\n\nAs you said, using TracingContextUtils is rather unintuitive, and thus I think most users did not do it, they just passed around spans without the remaining context. However, a custom propagator should be able to set a value in the context in extract and rely on it still being available in inject.\nBTW, using inject is a place where you already have to often muck around with TracingContextUtils currently.", "author": "Oberon00", "createdAt": "2020-09-23T18:21:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUwMjkyNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494502927", "bodyText": "Is it safe to assume the implicit current parent is accurate?\nFor instance, when dealing with asynchronous methods the thread being executed on is usually not the same thread that might have initiated/received the original request. In that situation, the implicit current parent from ThreadLocal is more than likely not the parent you want", "author": "kenfinnigan", "createdAt": "2020-09-24T17:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxMDA1OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494510059", "bodyText": "No, in that case you need to capture a Context (ideally you can use Context.current()) at he parent side. There is no fundamental change here with this PR.", "author": "Oberon00", "createdAt": "2020-09-24T18:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxNzYwMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494517600", "bodyText": "If the APIs are geared towards users utilizing \"implicit\" parents, is it defined anywhere in what situations it results in problems and alternatives should be implemented, such as you describe?", "author": "kenfinnigan", "createdAt": "2020-09-24T18:16:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU4NTc5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494585793", "bodyText": "If the APIs are geared towards users utilizing \"implicit\" parents\n\nHmm, I'm not sure yet why you think the API is more geared towards implicit parent's than before? I mean, I agree that it is a bit more cumbersome to have a span that was not active be the parent span at another thread, but the difference is only this:\nSpan capturedParent = span;\nvs.\nContext capturedParent = TracingContextUtils.withSpan(span, Context.current());\n\nIn case the parent is active on the original thread, you can even do\nContext capturedParent = Context.current();\n\n\nis it defined anywhere in what situations it results in problems\n\nIt currently uses grpc Context, so unless some other component does some automatic in-process context propagation, it is just a thread local. I guess you should only use an explicit parent if (a) you extract one from a remote process or (b) your parent comes from a remote thread, i.e. this is the first span that continues some asynchronous operation in another \"execution context\" (think thread) than the logical parent span.", "author": "Oberon00", "createdAt": "2020-09-24T20:17:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU4NjUwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494586506", "bodyText": "Maybe we can provide some convenience function (default interface implementation?), so one can do  Context capturedParent = span.withCurrentContext(). But it would be interesting how common the cases where you would need this even are.", "author": "Oberon00", "createdAt": "2020-09-24T20:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY2ODcwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494668707", "bodyText": "Personally, it's a lot messier, but more importantly way less obvious that that's what is needed to achieve the desired result.\nWith respect to a default interface implementation, that wouldn't be possible with the JDK 7 requirement, correct?", "author": "kenfinnigan", "createdAt": "2020-09-24T23:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4MzUzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494683536", "bodyText": "(FWIW, we need more convenience functions in TracingContextUtils, or in whatever new name it ends up having ;) )", "author": "carlosalberto", "createdAt": "2020-09-25T00:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc3NjA3OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494776078", "bodyText": "@kenfinnigan Java 7 was dropped recently, Java 8 is now required.", "author": "Oberon00", "createdAt": "2020-09-25T06:34:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk5NDQ1Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494994452", "bodyText": "Thanks @Oberon00, don't follow things for a few weeks, and everything changes!", "author": "kenfinnigan", "createdAt": "2020-09-25T13:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0NzM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc1MTA2Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r493751067", "bodyText": "I wonder if it might be better to rename the Context class in this package to TestContext or something, so we don't have the name collision in here.", "author": "jkwatson", "createdAt": "2020-09-23T17:04:02Z", "path": "sdk_extensions/testbed/src/test/java/io/opentelemetry/sdk/extensions/trace/testbed/concurrentcommonrequesthandler/RequestHandler.java", "diffHunk": "@@ -30,13 +29,13 @@\n \n   private final Tracer tracer;\n \n-  private final SpanContext parentContext;\n+  private final io.grpc.Context parentContext;", "originalCommit": "e8dc898e21cbc1c7428ee0383824e19fba3be9ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQzMzk0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494433948", "bodyText": "I renamed it to RequestHandlerContext in 6eea962. Is that name OK?", "author": "Oberon00", "createdAt": "2020-09-24T15:59:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc1MTA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5NTY0Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r493795647", "bodyText": "can you explain the TODO here? Do we need an issue to track a change? I'd prefer not to leave a cryptic TODO in the code like this, since it's not clear what the issue is.", "author": "jkwatson", "createdAt": "2020-09-23T18:18:06Z", "path": "opentracing_shim/src/main/java/io/opentelemetry/opentracingshim/SpanBuilderShim.java", "diffHunk": "@@ -192,11 +195,15 @@ public Span start() {\n     if (ignoreActiveSpan && parentSpan == null && parentSpanContext == null) {\n       builder.setNoParent();\n     } else if (parentSpan != null) {\n-      builder.setParent(parentSpan.getSpan());\n+      // Note: We ignore the (potentially stored) parentSpan's (grand)parent context here.\n+      builder.setParent(TracingContextUtils.withSpan(parentSpan.getSpan(), Context.current()));\n       SpanContextShim contextShim = spanContextTable().get(parentSpan);\n       distContext = contextShim == null ? null : contextShim.getCorrelationContext();\n     } else if (parentSpanContext != null) {\n-      builder.setParent(parentSpanContext.getSpanContext());\n+      // TODO: This might be wonky", "originalCommit": "e8dc898e21cbc1c7428ee0383824e19fba3be9ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5Nzc4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r493797780", "bodyText": "I would need @carlosalberto to check this. It just felt a bit strange, but I don't have enough knowledge of the OpenTracing shim to verify if there is a problem.", "author": "Oberon00", "createdAt": "2020-09-23T18:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5NTY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5ODYwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r493798609", "bodyText": "Maybe SpanContextShim should store a Context.", "author": "Oberon00", "createdAt": "2020-09-23T18:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5NTY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQyMTY5NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494421694", "bodyText": "I created #1699 and will change this to use ROOT instead of current (that way later changes are less likely to be breaking).", "author": "Oberon00", "createdAt": "2020-09-24T15:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5NTY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQzMzU1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1611#discussion_r494433557", "bodyText": "Done in 9f618e0", "author": "Oberon00", "createdAt": "2020-09-24T15:58:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5NTY0Nw=="}], "type": "inlineReview"}, {"oid": "9f618e0c3e526d39a86bacba672fdac48a65ee67", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/9f618e0c3e526d39a86bacba672fdac48a65ee67", "message": "Clean up OpenTracing SpanBuilderShim.", "committedDate": "2020-09-24T15:46:53Z", "type": "commit"}, {"oid": "6eea962875d0971421d557d067d17018a34832c4", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/6eea962875d0971421d557d067d17018a34832c4", "message": "Rename Context -> RequestHandlerContext in testbed.", "committedDate": "2020-09-24T15:55:41Z", "type": "commit"}, {"oid": "332ce258ac6c63830c3ae8a779a940116204b7a1", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/332ce258ac6c63830c3ae8a779a940116204b7a1", "message": "Merge remote-tracking branch 'upstream/master' into feature/contextparent\n\n Conflicts:\n\tsdk/tracing/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "committedDate": "2020-09-24T16:01:37Z", "type": "commit"}]}