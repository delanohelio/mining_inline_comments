{"pr_number": 1330, "pr_title": "Convert SpanData to use immutable Attributes", "pr_createdAt": "2020-06-10T21:31:20Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330", "timeline": [{"oid": "3c6bf1177c84fa5eec6a832c53601e018498b1df", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/3c6bf1177c84fa5eec6a832c53601e018498b1df", "message": "Convert SpanData to use immutable Attributes", "committedDate": "2020-06-10T21:30:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyMTc4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438421781", "bodyText": "What do y'all think about adding this method to Attributes itself? It's not ultra efficient, but that could be documented as such.", "author": "jkwatson", "createdAt": "2020-06-10T21:36:00Z", "path": "sdk/src/test/java/io/opentelemetry/sdk/trace/TestUtils.java", "diffHunk": "@@ -124,4 +125,32 @@ public static SpanData makeBasicSpan() {\n       tracerSdkFactory.updateActiveTraceConfig(originalConfig);\n     }\n   }\n+\n+  /** Find an AttributeValue by the key. */\n+  public static AttributeValue findByKey(Attributes attributes, String key) {", "originalCommit": "3c6bf1177c84fa5eec6a832c53601e018498b1df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyNDQyOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438424429", "bodyText": "I guess we can do it with a binary search, since the keys are currently sorted, and that should be pretty good.", "author": "jkwatson", "createdAt": "2020-06-10T21:41:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyMTc4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1ODg4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438458886", "bodyText": "I decided to add it, and keep it a simple linear search for now. We can revert if everyone hates it.", "author": "jkwatson", "createdAt": "2020-06-10T23:20:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyMTc4MQ=="}], "type": "inlineReview"}, {"oid": "26b6eacb0a2728199d93576d4f3766d0860f2dc0", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/26b6eacb0a2728199d93576d4f3766d0860f2dc0", "message": "Add a get(key) method to the ImmutableKeyValuePairs and get rid of the extra test cruft", "committedDate": "2020-06-10T23:19:44Z", "type": "commit"}, {"oid": "d7497b48e6474cef560d7a4ed84d6bee7149cc8b", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d7497b48e6474cef560d7a4ed84d6bee7149cc8b", "message": "revert an unneeded change", "committedDate": "2020-06-10T23:24:41Z", "type": "commit"}, {"oid": "471cd7086f3ad5a38545cf68a20faa8a3dddb172", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/471cd7086f3ad5a38545cf68a20faa8a3dddb172", "message": "another simple revert", "committedDate": "2020-06-10T23:27:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjQzNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438476435", "bodyText": "+1 to linear search, these should always be small enough where it's faster and opens up optimizations like deferring / not sorting.", "author": "anuraaga", "createdAt": "2020-06-11T00:21:30Z", "path": "api/src/main/java/io/opentelemetry/common/ImmutableKeyValuePairs.java", "diffHunk": "@@ -56,6 +57,22 @@ public void forEach(KeyValueConsumer<V> consumer) {\n     }\n   }\n \n+  /**\n+   * Returns the value of the given key, or null if the key does not exist.\n+   *\n+   * <p>Warning: currently implemented via a linear search, so O(n) performance.", "originalCommit": "471cd7086f3ad5a38545cf68a20faa8a3dddb172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUwODY2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438508662", "bodyText": "I actually implemented a binary search, then backed it out because it seemed like total overkill since we're not expecting many attributes. Good exercise to remind myself of some undergrad CS stuff, though (which I never took, since I don't have a CS degree!).", "author": "jkwatson", "createdAt": "2020-06-11T02:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjcxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438476716", "bodyText": "For Attributes, having getString etc would make these sort of unit tests (thinking user code unit tests less worried about these speifically) nicer.", "author": "anuraaga", "createdAt": "2020-06-11T00:22:31Z", "path": "api/src/test/java/io/opentelemetry/common/AttributesTest.java", "diffHunk": "@@ -149,4 +149,41 @@ public void builder_arrayTypes() {\n                 \"double\", arrayAttributeValue(33.44, -44.33),\n                 \"boolean\", arrayAttributeValue(false, true)));\n   }\n+\n+  @Test\n+  public void get_Null() {\n+    assertThat(Attributes.empty().get(\"foo\")).isNull();\n+    assertThat(Attributes.of(\"key\", stringAttributeValue(\"value\")).get(\"foo\")).isNull();\n+  }\n+\n+  @Test\n+  public void get() {\n+    assertThat(Attributes.of(\"key\", stringAttributeValue(\"value\")).get(\"key\"))", "originalCommit": "471cd7086f3ad5a38545cf68a20faa8a3dddb172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUwNjYyNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438506624", "bodyText": "Not a bad idea. What behavior would you expect if you were asking for a non-string attribute value?", "author": "jkwatson", "createdAt": "2020-06-11T02:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUwODA2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438508062", "bodyText": "I've seen similar APIs return null when it's a different type, it seems fine to me.", "author": "anuraaga", "createdAt": "2020-06-11T02:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkzMTgxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438931817", "bodyText": "Right now, the corresponding methods on AttributeValue throw an UnsupportedOperationException. I honestly don't know what's the better approach.", "author": "jkwatson", "createdAt": "2020-06-11T16:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQyMDM5NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r439420395", "bodyText": "Observe this is not an API intended to be used by end users, but by 'us', so I'm not so sure the sugar is truly needed.\nIn any case, if this is something still required, I'd suggest filling an issue and discuss the change there, so we can go ahead and merge this PR soon ;)", "author": "carlosalberto", "createdAt": "2020-06-12T13:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyNTA4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r439625081", "bodyText": "fair enough, @carlosalberto . I don't think it's needed right now, although it could make exporters easier to write, possibly.", "author": "jkwatson", "createdAt": "2020-06-12T20:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1MTE3OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r439651179", "bodyText": "Yeah, we shouldn't do this now; and only add it if it is really needed. Resolving this conversation for now.", "author": "jkwatson", "createdAt": "2020-06-12T21:33:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcwNTg3NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r439705875", "bodyText": "Ok with addressing later. Don't quite understand this being not an end-user API since it would be used to create Resource too?", "author": "anuraaga", "createdAt": "2020-06-13T03:48:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODQ4OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438818488", "bodyText": "Looking at this I see a lot of allocations happening here. Do you have a plan to change AttributeMap to implement the Attributes so we don't reconstruct the entire map when converting to SpanData?", "author": "bogdandrutu", "createdAt": "2020-06-11T14:14:12Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -516,13 +515,15 @@ int getTotalRecordedLinks() {\n   }\n \n   @GuardedBy(\"lock\")\n-  private Map<String, AttributeValue> getImmutableAttributes() {\n+  private Attributes getImmutableAttributes() {", "originalCommit": "471cd7086f3ad5a38545cf68a20faa8a3dddb172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1NzgwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438857809", "bodyText": "I would definitely like to tackle this next. So far, I'm a bit stumped on how to approach it, since the AttributeMap is extremely mutable, and Attributes are inherently immutable. Do you have any ideas of how to tackle this one?", "author": "jkwatson", "createdAt": "2020-06-11T15:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MjE3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438972173", "bodyText": "AttributeMap becomes immutable after end event so we can reuse that object", "author": "bogdandrutu", "createdAt": "2020-06-11T17:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk5MDQ5NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r438990494", "bodyText": "ok, I've been noodling on this a bit.\nIf we made an exportable-attributes interface (no idea what the name of this could be), then both our existing Attributes abstract class and the AttributesMap class could both implement that interface. Then, SpanData would expose this interface, rather than the concrete Attributes API class. Is this the sort of thing you're also thinking?", "author": "jkwatson", "createdAt": "2020-06-11T18:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAzMjAyOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r439032028", "bodyText": "Naming wise, here is my suggestion:\n\nRename the current Attributes class to ImmutableAttributes, keeping the implementation and the static creation methods there.\nCreate a new interface called Attributes which will be used as the API interface and for export as well.\nMake the AttributesMap implement the Attributes interface\nDo as you suggest and pass in the AttributeMap directly to the SpanWrapper after the span has ended.\n\nDoes this sound right?", "author": "jkwatson", "createdAt": "2020-06-11T19:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNDk0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r439104945", "bodyText": "Note, I tried this out in a branch, and for the API it ends up feeling parallel to the Map/ImmutableMap APIs :  Attributes/ImmutableAttributes.", "author": "jkwatson", "createdAt": "2020-06-11T22:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQyMjIyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r439422220", "bodyText": "A small question: will ImmutableAttributes implement Attributes as well?", "author": "carlosalberto", "createdAt": "2020-06-12T13:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4MDcwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1330#discussion_r439480705", "bodyText": "yes, ImmutableAttributes and AttributesMap will both implement the Attributes interface.", "author": "jkwatson", "createdAt": "2020-06-12T15:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODQ4OA=="}], "type": "inlineReview"}]}