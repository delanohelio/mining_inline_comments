{"pr_number": 1235, "pr_title": "Separating the B3 logic for Single and Multiple headers", "pr_createdAt": "2020-05-17T11:57:57Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235", "timeline": [{"oid": "63ed38771ea352a0cfa58d70c9d0acddbaf56ed6", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/63ed38771ea352a0cfa58d70c9d0acddbaf56ed6", "message": "Separating the B3 logic for Single and Multiple headers", "committedDate": "2020-05-17T11:50:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r426722979", "bodyText": "use a create factory method instead of a public ctor.", "author": "bogdandrutu", "createdAt": "2020-05-18T15:46:16Z", "path": "contrib/trace_propagators/src/main/java/io/opentelemetry/contrib/trace/propagation/B3Propagator.java", "diffHunk": "@@ -62,8 +62,13 @@ public B3Propagator() {\n    * @param singleHeader whether to use single or multiple headers.\n    */\n   public B3Propagator(boolean singleHeader) {", "originalCommit": "63ed38771ea352a0cfa58d70c9d0acddbaf56ed6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc0OTc4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r426749780", "bodyText": "Talking of, since the Propagators do not keep state, I'm wondering on why we don't expose them as static instances, i.e. getSingleHeaderPropagator() and getMultipleHeaderPropagator().", "author": "carlosalberto", "createdAt": "2020-05-18T16:26:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1NjcxMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r426756713", "bodyText": "@bogdandrutu  I can make this change. But not sure why we would need a factor when we just have one argument.\n@carlosalberto  Now I think about this, making static methods make sense. But, again I don't know what the implication will be. I think this will cause a breaking change for the clients while upgrading to the next version.", "author": "ksameersrk", "createdAt": "2020-05-18T16:37:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0NDQ0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r426844445", "bodyText": "Breaking changes are ok at the moment, since we haven't hit version 1.0 yet.", "author": "jkwatson", "createdAt": "2020-05-18T19:23:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0OTAwMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r426849000", "bodyText": "Yeah, it seems like a B3Propagators.SINGLE_HEADER and B3Propagators.MULTI_HEADER would be a great way to get access to them.", "author": "jkwatson", "createdAt": "2020-05-18T19:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0ODc1NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r427648755", "bodyText": "Factory methods are better than constructors because they can be change to return different instances for example.", "author": "bogdandrutu", "createdAt": "2020-05-19T23:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0ODg4NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r427648885", "bodyText": "Happy with @jkwatson solution fyi", "author": "bogdandrutu", "createdAt": "2020-05-19T23:04:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE1OTE5Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428159196", "bodyText": "I have made changes based on the feedback.\nI have made the current constructor as private. I have exposed a public static variable for B3Propagators.SINGLE_HEADER and B3Propagators.MULTIPLE_HEADER.", "author": "ksameersrk", "createdAt": "2020-05-20T16:45:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2MjcxOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428262718", "bodyText": "One last thing: do we want to expose these singletons directly, or should we instead expose them through a static methods? We have historically chosen the second option, which I think it's the slightly better approach ;)", "author": "carlosalberto", "createdAt": "2020-05-20T19:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2MzkxNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428263914", "bodyText": "no strong opinion from me. For consistency, it's probably better to hide the instances behind static accessors.", "author": "jkwatson", "createdAt": "2020-05-20T19:41:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5MTQyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428391420", "bodyText": "Made change to expose the singletons via static getters.", "author": "ksameersrk", "createdAt": "2020-05-21T01:07:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyMjk3OQ=="}], "type": "inlineReview"}, {"oid": "f59c3278a5002eaa29778286ddd8ef694a0e5352", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/f59c3278a5002eaa29778286ddd8ef694a0e5352", "message": "Refactored to static variables for Single/Multi Headers", "committedDate": "2020-05-20T16:30:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyNjQxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428226416", "bodyText": "This field won't create a new instance. The javadoc should say that it will return an instance and describe it's functionality, rather than the internal implementation.  (same comment goes for the multi-header field)", "author": "jkwatson", "createdAt": "2020-05-20T18:35:42Z", "path": "contrib/trace_propagators/src/main/java/io/opentelemetry/contrib/trace/propagation/B3Propagator.java", "diffHunk": "@@ -51,19 +51,31 @@\n   private final B3PropagatorInjector b3PropagatorInjector;\n   private final B3PropagatorExtractor b3PropagatorExtractor;\n \n-  /** Creates a new instance of {@link B3Propagator}. Defaults to use multiple headers. */\n-  public B3Propagator() {\n-    this(false);\n-  }\n+  /**\n+   * Creates a new instance of {@link B3Propagator}. This instance contains the reference to {@link", "originalCommit": "f59c3278a5002eaa29778286ddd8ef694a0e5352", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI0Mzg2OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428243869", "bodyText": "Fixed the incorrect JavaDoc.", "author": "ksameersrk", "createdAt": "2020-05-20T19:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyNjQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyODA5Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428228092", "bodyText": "since this constructor is private, and only called from the field declarations, you could just inline the boolean logic into the call sites (i.e. get rid of the boolean and just pass in the two implementations that you want in the right constructor calls)", "author": "jkwatson", "createdAt": "2020-05-20T18:37:37Z", "path": "contrib/trace_propagators/src/main/java/io/opentelemetry/contrib/trace/propagation/B3Propagator.java", "diffHunk": "@@ -51,19 +51,31 @@\n   private final B3PropagatorInjector b3PropagatorInjector;\n   private final B3PropagatorExtractor b3PropagatorExtractor;\n \n-  /** Creates a new instance of {@link B3Propagator}. Defaults to use multiple headers. */\n-  public B3Propagator() {\n-    this(false);\n-  }\n+  /**\n+   * Creates a new instance of {@link B3Propagator}. This instance contains the reference to {@link\n+   * B3PropagatorInjectorSingleHeader} and {@link B3PropagatorExtractorSingleHeader}.\n+   */\n+  public static final B3Propagator SINGLE_HEADER = new B3Propagator(/* singleHeader= */ true);\n+\n+  /**\n+   * Creates a new instance of {@link B3Propagator}. This instance contains the reference to {@link\n+   * B3PropagatorInjectorMultipleHeaders} and {@link B3PropagatorExtractorMultipleHeaders}.\n+   */\n+  public static final B3Propagator MULTI_HEADER = new B3Propagator(/* singleHeader= */ false);\n \n   /**\n    * Creates a new instance of {@link B3Propagator}.\n    *\n    * @param singleHeader whether to use single or multiple headers.\n    */\n-  public B3Propagator(boolean singleHeader) {\n-    b3PropagatorInjector = new B3PropagatorInjector(singleHeader);\n-    b3PropagatorExtractor = new B3PropagatorExtractor(singleHeader);\n+  private B3Propagator(boolean singleHeader) {", "originalCommit": "f59c3278a5002eaa29778286ddd8ef694a0e5352", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI0NDAzMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428244031", "bodyText": "Took care of it.", "author": "ksameersrk", "createdAt": "2020-05-20T19:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyODA5Mg=="}], "type": "inlineReview"}, {"oid": "e1cc7bb27d197e48cfa5df4446536b9b441eb3fa", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e1cc7bb27d197e48cfa5df4446536b9b441eb3fa", "message": "Fixes review comments - javadoc and ctor changes", "committedDate": "2020-05-20T19:01:40Z", "type": "commit"}, {"oid": "256e82fd7f64f03eb3057509e1841f40898c2580", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/256e82fd7f64f03eb3057509e1841f40898c2580", "message": "exposing B3Propagator via static getters", "committedDate": "2020-05-21T01:06:19Z", "type": "commit"}, {"oid": "a01594f2f435445b3bc2387401fb40c126bde439", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a01594f2f435445b3bc2387401fb40c126bde439", "message": "Dummy commit to test the build", "committedDate": "2020-05-21T13:59:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwNDk1MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428804951", "bodyText": "What do you think of making this an interface, rather than an abstract class?", "author": "jkwatson", "createdAt": "2020-05-21T17:34:04Z", "path": "contrib/trace_propagators/src/main/java/io/opentelemetry/contrib/trace/propagation/B3PropagatorInjector.java", "diffHunk": "@@ -18,59 +18,9 @@\n \n import io.grpc.Context;\n import io.opentelemetry.context.propagation.HttpTextFormat;\n-import io.opentelemetry.trace.Span;\n-import io.opentelemetry.trace.SpanContext;\n-import io.opentelemetry.trace.SpanId;\n-import io.opentelemetry.trace.TraceId;\n-import io.opentelemetry.trace.TracingContextUtils;\n-import java.util.Objects;\n import javax.annotation.concurrent.Immutable;\n \n @Immutable\n-final class B3PropagatorInjector {\n-  private static final int SAMPLED_FLAG_SIZE = 1;\n-  private static final int TRACE_ID_HEX_SIZE = 2 * TraceId.getSize();\n-  private static final int SPAN_ID_HEX_SIZE = 2 * SpanId.getSize();\n-  private static final int COMBINED_HEADER_DELIMITER_SIZE = 1;\n-  private static final int SPAN_ID_OFFSET = TRACE_ID_HEX_SIZE + COMBINED_HEADER_DELIMITER_SIZE;\n-  private static final int SAMPLED_FLAG_OFFSET =\n-      SPAN_ID_OFFSET + SPAN_ID_HEX_SIZE + COMBINED_HEADER_DELIMITER_SIZE;\n-  private static final int COMBINED_HEADER_SIZE = SAMPLED_FLAG_OFFSET + SAMPLED_FLAG_SIZE;\n-\n-  private final boolean singleHeader;\n-\n-  B3PropagatorInjector(boolean singleHeader) {\n-    this.singleHeader = singleHeader;\n-  }\n-\n-  <C> void inject(Context context, C carrier, HttpTextFormat.Setter<C> setter) {\n-    Objects.requireNonNull(context, \"context\");\n-    Objects.requireNonNull(setter, \"setter\");\n-\n-    Span span = TracingContextUtils.getSpanWithoutDefault(context);\n-    if (span == null) {\n-      return;\n-    }\n-\n-    SpanContext spanContext = span.getContext();\n-    String sampled =\n-        spanContext.getTraceFlags().isSampled() ? B3Propagator.TRUE_INT : B3Propagator.FALSE_INT;\n-\n-    if (singleHeader) {\n-      char[] chars = new char[COMBINED_HEADER_SIZE];\n-      spanContext.getTraceId().copyLowerBase16To(chars, 0);\n-      chars[SPAN_ID_OFFSET - 1] = B3Propagator.COMBINED_HEADER_DELIMITER_CHAR;\n-      spanContext.getSpanId().copyLowerBase16To(chars, SPAN_ID_OFFSET);\n-      chars[SAMPLED_FLAG_OFFSET - 1] = B3Propagator.COMBINED_HEADER_DELIMITER_CHAR;\n-      chars[SAMPLED_FLAG_OFFSET] =\n-          spanContext.getTraceFlags().isSampled()\n-              ? B3Propagator.IS_SAMPLED\n-              : B3Propagator.NOT_SAMPLED;\n-      setter.set(carrier, B3Propagator.COMBINED_HEADER, new String(chars));\n-    } else {\n-      setter.set(carrier, B3Propagator.TRACE_ID_HEADER, spanContext.getTraceId().toLowerBase16());\n-      setter.set(carrier, B3Propagator.SPAN_ID_HEADER, spanContext.getSpanId().toLowerBase16());\n-      setter.set(carrier, B3Propagator.SAMPLED_HEADER, sampled);\n-    }\n-  }\n+abstract class B3PropagatorInjector {", "originalCommit": "a01594f2f435445b3bc2387401fb40c126bde439", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwNTE4NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428805184", "bodyText": "What do think about making this an interface, rather than an abstract class?", "author": "jkwatson", "createdAt": "2020-05-21T17:34:30Z", "path": "contrib/trace_propagators/src/main/java/io/opentelemetry/contrib/trace/propagation/B3PropagatorExtractor.java", "diffHunk": "@@ -16,122 +16,32 @@\n \n package io.opentelemetry.contrib.trace.propagation;\n \n-import static io.opentelemetry.contrib.trace.propagation.B3Propagator.COMBINED_HEADER;\n-import static io.opentelemetry.contrib.trace.propagation.B3Propagator.COMBINED_HEADER_DELIMITER;\n import static io.opentelemetry.contrib.trace.propagation.B3Propagator.MAX_SPAN_ID_LENGTH;\n import static io.opentelemetry.contrib.trace.propagation.B3Propagator.MAX_TRACE_ID_LENGTH;\n-import static io.opentelemetry.contrib.trace.propagation.B3Propagator.SAMPLED_HEADER;\n-import static io.opentelemetry.contrib.trace.propagation.B3Propagator.SPAN_ID_HEADER;\n-import static io.opentelemetry.contrib.trace.propagation.B3Propagator.TRACE_ID_HEADER;\n import static io.opentelemetry.contrib.trace.propagation.B3Propagator.TRUE_INT;\n \n import io.grpc.Context;\n import io.opentelemetry.context.propagation.HttpTextFormat;\n import io.opentelemetry.internal.StringUtils;\n-import io.opentelemetry.trace.DefaultSpan;\n import io.opentelemetry.trace.SpanContext;\n import io.opentelemetry.trace.SpanId;\n import io.opentelemetry.trace.TraceFlags;\n import io.opentelemetry.trace.TraceId;\n import io.opentelemetry.trace.TraceState;\n-import io.opentelemetry.trace.TracingContextUtils;\n-import java.util.Objects;\n import java.util.logging.Level;\n import java.util.logging.Logger;\n import javax.annotation.concurrent.Immutable;\n \n @Immutable\n-final class B3PropagatorExtractor {\n+abstract class B3PropagatorExtractor {", "originalCommit": "a01594f2f435445b3bc2387401fb40c126bde439", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxMjc2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428812766", "bodyText": "Okay. If we make them interface then, will we be moving buildSpanContext, isTraceIdValid and isSpanIdValid  to Util class I guess. Not sure if we want to make them default method of the interface.", "author": "ksameersrk", "createdAt": "2020-05-21T17:48:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwNTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxMzQyNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428813424", "bodyText": "You can still have static methods on your interface.", "author": "jkwatson", "createdAt": "2020-05-21T17:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwNTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxODMyOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428818328", "bodyText": "I believe it is Java 8 and above right? I don't think we have static and default in Java 7.", "author": "ksameersrk", "createdAt": "2020-05-21T17:58:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwNTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyMDM0OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428820349", "bodyText": "oh shoot, you're right. Since they are only used in one place, you can have an inner util class in the interface, like we do in the SpanData right now, rather than pulling it out of the interface entirely.", "author": "jkwatson", "createdAt": "2020-05-21T18:01:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwNTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyMjg0MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1235#discussion_r428822840", "bodyText": "sounds good", "author": "ksameersrk", "createdAt": "2020-05-21T18:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwNTE4NA=="}], "type": "inlineReview"}, {"oid": "deb2414351f915ad020f3e2c61ad3f6e1bcaff02", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/deb2414351f915ad020f3e2c61ad3f6e1bcaff02", "message": "Converted the abstract class into interface for injector/extractor", "committedDate": "2020-05-21T18:23:21Z", "type": "commit"}, {"oid": "044777758637f8b23e767428a181f11124c2dfaa", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/044777758637f8b23e767428a181f11124c2dfaa", "message": "Merge branch 'master' into separate_b3_logic", "committedDate": "2020-05-26T14:04:27Z", "type": "commit"}]}