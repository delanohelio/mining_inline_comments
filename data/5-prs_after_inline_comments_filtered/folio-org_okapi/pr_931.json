{"pr_number": 931, "pr_title": "Allow delegate CORS to module", "pr_createdAt": "2020-05-31T17:52:12Z", "pr_url": "https://github.com/folio-org/okapi/pull/931", "timeline": [{"oid": "66afdd13d8ff1fccaac05932e3907d582ade6785", "url": "https://github.com/folio-org/okapi/commit/66afdd13d8ff1fccaac05932e3907d582ade6785", "message": "Allow delegate CORS to module", "committedDate": "2020-05-31T17:42:31Z", "type": "commit"}, {"oid": "2a1b3a11b009b6ba189f01e375cee02ba98ad551", "url": "https://github.com/folio-org/okapi/commit/2a1b3a11b009b6ba189f01e375cee02ba98ad551", "message": "Typo in comment", "committedDate": "2020-05-31T17:57:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI0NzI4Mg==", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433247282", "bodyText": "Please don't import MainVerticle which also includes ProxyService. Can you move all CORS logic to a CorsHandler class? Which is this is then imported/used by ProxyService and MainVerticle.", "author": "adamdickmeiss", "createdAt": "2020-06-01T13:53:56Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -538,6 +539,18 @@ public void proxy(RoutingContext ctx) {\n           stream.resume();\n           return; // ctx already set up\n         }\n+\n+        // handle delegate CORS\n+        if (ctx.data().containsKey(MainVerticle.CHECK_DELEGATE_CORS)) {\n+          ctx.data().remove(MainVerticle.CHECK_DELEGATE_CORS);\n+          if (l.stream().anyMatch(mi -> mi.isHandler() && mi.getRoutingEntry().isDelegateCors())) {\n+            ctx.data().put(MainVerticle.DELEGATE_CORS, true);\n+            stream.resume();\n+            ctx.reroute(ctx.request().path());\n+            return;\n+          }\n+        }\n+\n         pc.setModList(l);\n \n         pc.logRequest(ctx, tenantId);", "originalCommit": "66afdd13d8ff1fccaac05932e3907d582ade6785", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2NTg3Ng==", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433365876", "bodyText": "Done.", "author": "hjiebsco", "createdAt": "2020-06-01T17:01:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI0NzI4Mg=="}], "type": "inlineReview"}, {"oid": "062b78bb1a14051e9beaed262443f7858b96fae3", "url": "https://github.com/folio-org/okapi/commit/062b78bb1a14051e9beaed262443f7858b96fae3", "message": "Move changes to a new class", "committedDate": "2020-06-01T15:50:47Z", "type": "commit"}, {"oid": "6abc470d4e7d2797bde2483ed0932fb53a5625e0", "url": "https://github.com/folio-org/okapi/commit/6abc470d4e7d2797bde2483ed0932fb53a5625e0", "message": "Tweak method", "committedDate": "2020-06-01T16:13:12Z", "type": "commit"}, {"oid": "add1a2af02024965b0dd8421a290859defa5df3d", "url": "https://github.com/folio-org/okapi/commit/add1a2af02024965b0dd8421a290859defa5df3d", "message": "check style change", "committedDate": "2020-06-01T16:51:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDU3NQ==", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433594575", "bodyText": "Typo \"Hanlder\"", "author": "craigmcnally", "createdAt": "2020-06-02T03:01:09Z", "path": "okapi-core/src/main/java/org/folio/okapi/MainVerticle.java", "diffHunk": "@@ -352,26 +350,9 @@ private void checkSuperTenant(String okapiModule, Promise<Void> promise) {\n   private Future<Void> startListening() {\n     Router router = Router.router(vertx);\n     logger.debug(\"Setting up routes\");\n+\n     //handle CORS\n-    router.route().handler(CorsHandler.create(\"*\")\n-        .allowedMethod(HttpMethod.PUT)\n-        .allowedMethod(HttpMethod.DELETE)\n-        .allowedMethod(HttpMethod.GET)\n-        .allowedMethod(HttpMethod.POST)\n-        //allow request headers\n-        .allowedHeader(HttpHeaders.CONTENT_TYPE.toString())\n-        .allowedHeader(XOkapiHeaders.TENANT)\n-        .allowedHeader(XOkapiHeaders.TOKEN)\n-        .allowedHeader(XOkapiHeaders.AUTHORIZATION)\n-        .allowedHeader(XOkapiHeaders.REQUEST_ID) //expose response headers\n-        .allowedHeader(XOkapiHeaders.MODULE_ID)\n-        .exposedHeader(HttpHeaders.LOCATION.toString())\n-        .exposedHeader(XOkapiHeaders.TRACE)\n-        .exposedHeader(XOkapiHeaders.TOKEN)\n-        .exposedHeader(XOkapiHeaders.AUTHORIZATION)\n-        .exposedHeader(XOkapiHeaders.REQUEST_ID)\n-        .exposedHeader(XOkapiHeaders.MODULE_ID)\n-    );\n+    CorsHelper.addCorsHanlder(router);", "originalCommit": "add1a2af02024965b0dd8421a290859defa5df3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYwMDMzNw==", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433600337", "bodyText": "Fixed.", "author": "hjiebsco", "createdAt": "2020-06-02T03:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDg2OA==", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433594868", "bodyText": "See above comment about typo", "author": "craigmcnally", "createdAt": "2020-06-02T03:02:37Z", "path": "okapi-core/src/main/java/org/folio/okapi/util/CorsHelper.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.folio.okapi.util;\n+\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.CorsHandler;\n+import java.util.List;\n+import org.folio.okapi.bean.ModuleInstance;\n+import org.folio.okapi.common.XOkapiHeaders;\n+\n+/**\n+ * Customized CORS handling.\n+ *\n+ * <p>If a module API specifies <b>delegateCORS</b> to true in RAML, Okapi will\n+ * delegate CORS handling to the module if and only if the API is invoked\n+ * through {@code /_/invoke/tenant/<tenantId>/moduleAPI}\n+ */\n+public class CorsHelper {\n+\n+  private static final String CHECK_DELEGATE_CORS = \"check-delegate-CORS\";\n+  private static final String DELEGATE_CORS = \"delegate-CORS\";\n+\n+  private CorsHelper() {\n+  }\n+\n+  /**\n+   * Add CORS handler to {@link Router}.\n+   *\n+   * @param router - {@link Router}\n+   */\n+  public static void addCorsHanlder(Router router) {", "originalCommit": "add1a2af02024965b0dd8421a290859defa5df3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYwMDM3Mw==", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433600373", "bodyText": "Fixed.", "author": "hjiebsco", "createdAt": "2020-06-02T03:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDg2OA=="}], "type": "inlineReview"}, {"oid": "a088ae9e5f104464288576ac38b25353d8229c0c", "url": "https://github.com/folio-org/okapi/commit/a088ae9e5f104464288576ac38b25353d8229c0c", "message": "Fix typo and update json schema description", "committedDate": "2020-06-02T03:26:14Z", "type": "commit"}]}