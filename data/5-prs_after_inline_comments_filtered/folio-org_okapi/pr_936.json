{"pr_number": 936, "pr_title": "OKAPI-787: Support SSL connections to Postgres", "pr_createdAt": "2020-06-10T17:41:55Z", "pr_url": "https://github.com/folio-org/okapi/pull/936", "timeline": [{"oid": "f95f1db9300fa241aa6a45d6339a5474d80c8619", "url": "https://github.com/folio-org/okapi/commit/f95f1db9300fa241aa6a45d6339a5474d80c8619", "message": "OKAPI-787: Support SSL connections to Postgres\n\nAdd new configuration option postgres_server_pem.\n\nAdd netty-tcnative-boringssl-static because OpenJDK 8\ndoesn't support TLSv1.3.\n\nFor testing a postgres:12-alpine testingcontainers.org\ncontainer is startet. PostgreSQL 10 does not support\nssl_min_protocol_version that we need for the TLSv1.3\ntest. The Alpine version is sufficient, we don't need\nthe large Debian container.\n\nThis also introduces JUnit 5 (Jupiter).", "committedDate": "2020-06-10T17:10:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM5ODIzNA==", "url": "https://github.com/folio-org/okapi/pull/936#discussion_r438398234", "bodyText": "What happens if an invalid cert is provided?  Does this call do validation, causing a failure here, or would SSL requests just be rejected later on, or...?", "author": "craigmcnally", "createdAt": "2020-06-10T20:46:01Z", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/PostgresHandle.java", "diffHunk": "@@ -63,6 +68,15 @@\n         Config.getSysConf(\"postgres_user\", \"okapi\", new JsonObject()), conf));\n     connectOptions.setPassword(Config.getSysConf(\"postgres_password\", \"okapi25\", conf));\n     connectOptions.setDatabase(Config.getSysConf(\"postgres_database\", \"okapi\", conf));\n+    String serverPem = Config.getSysConf(\"postgres_server_pem\", null, conf);\n+    if (serverPem != null) {\n+      connectOptions.setSslMode(SslMode.VERIFY_FULL);\n+      connectOptions.setHostnameVerificationAlgorithm(\"HTTPS\");\n+      connectOptions.setPemTrustOptions(\n+          new PemTrustOptions().addCertValue(Buffer.buffer(serverPem)));", "originalCommit": "f95f1db9300fa241aa6a45d6339a5474d80c8619", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyMjIzNw==", "url": "https://github.com/folio-org/okapi/pull/936#discussion_r438422237", "bodyText": "The serverPem string is passed to PgPool that passes it to Vert.x that passes it to Netty that passes it to OpenSSL. OpenSSL does the validation.\nIf the cert is invalid there will be a connection failure. The failure will be similar to the failure for an invalid postgres password. I don't see the need for advanced error handling because the connection parameters are a one time task for the SysOp.", "author": "julianladisch", "createdAt": "2020-06-10T21:37:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM5ODIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyOTM2OQ==", "url": "https://github.com/folio-org/okapi/pull/936#discussion_r438729369", "bodyText": "Okapi exits with this error message if the provided certificate is invalid:\nFATAL PostgresQuery        getCon failed Postgres Server does not handle SSL connection\nThis is similar to the message when when Okapi exits because of wrong password:\nFATAL PostgresQuery        getCon failed password authentication failed for user \"okapi\"", "author": "julianladisch", "createdAt": "2020-06-11T11:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM5ODIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQwMTMyMg==", "url": "https://github.com/folio-org/okapi/pull/936#discussion_r438401322", "bodyText": "consider adding a debug/info level log message indicating that SSL is being used.", "author": "craigmcnally", "createdAt": "2020-06-10T20:52:17Z", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/PostgresHandle.java", "diffHunk": "@@ -63,6 +68,15 @@\n         Config.getSysConf(\"postgres_user\", \"okapi\", new JsonObject()), conf));\n     connectOptions.setPassword(Config.getSysConf(\"postgres_password\", \"okapi25\", conf));\n     connectOptions.setDatabase(Config.getSysConf(\"postgres_database\", \"okapi\", conf));\n+    String serverPem = Config.getSysConf(\"postgres_server_pem\", null, conf);\n+    if (serverPem != null) {", "originalCommit": "f95f1db9300fa241aa6a45d6339a5474d80c8619", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b7356239d377d72db3577704bc167285f8f78de9", "url": "https://github.com/folio-org/okapi/commit/b7356239d377d72db3577704bc167285f8f78de9", "message": "Remove unused empty file foobar", "committedDate": "2020-06-10T21:38:20Z", "type": "commit"}, {"oid": "6bb582565cf37bf4aa74176031912e492095c2d6", "url": "https://github.com/folio-org/okapi/commit/6bb582565cf37bf4aa74176031912e492095c2d6", "message": "logger.debug about enabling SSL", "committedDate": "2020-06-10T22:02:06Z", "type": "commit"}]}