{"pr_number": 974, "pr_title": "Redirect stdout/stderr to log for process deployment OKAPI-892", "pr_createdAt": "2020-09-17T10:38:41Z", "pr_url": "https://github.com/folio-org/okapi/pull/974", "timeline": [{"oid": "45a1a347042ad1181669d74502ccf5e9460ad996", "url": "https://github.com/folio-org/okapi/commit/45a1a347042ad1181669d74502ccf5e9460ad996", "message": "Redirect stdout/stderr to log for process deployment OKAPI-892", "committedDate": "2020-09-17T10:38:22Z", "type": "commit"}, {"oid": "b5fac4836d287f0e1e02414673faa2c10885b19b", "url": "https://github.com/folio-org/okapi/commit/b5fac4836d287f0e1e02414673faa2c10885b19b", "message": "Use context.asyncAssert stuff rather than async", "committedDate": "2020-09-17T11:48:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxNjEwMw==", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r490416103", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param id if of process (possibly module ID)\n          \n          \n            \n               * @param id process identifier used for logging (possibly module ID)", "author": "julianladisch", "createdAt": "2020-09-17T16:56:57Z", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -41,13 +45,14 @@\n    * Construct process module handler.\n    * @param vertx Vert.x handle\n    * @param desc launch descriptor\n+   * @param id if of process (possibly module ID)", "originalCommit": "b5fac4836d287f0e1e02414673faa2c10885b19b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4MTA0MA==", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r490981040", "bodyText": "Agreed. better. if of :-)", "author": "adamdickmeiss", "createdAt": "2020-09-18T14:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxNjEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQzOTEzNw==", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r490439137", "bodyText": "The default worker pool size is 20. If I start 11 processes and each runs 2 captureStream there is some blocking. If the first runs 60 seconds and all other run 1 second then the logging of the 11th is blocked until the first has finished.\nhttps://vertx.io/docs/vertx-core/java/#blocking_code says about executeBlocking:\n\nBlocking code should block for a reasonable amount of time (i.e no more than a few seconds). Long blocking operations or polling operations (i.e a thread that spin in a loop polling events in a blocking fashion) are precluded. When the blocking operation lasts more than the 10 seconds, a message will be printed on the console by the blocked thread checker. Long blocking operations should use a dedicated thread managed by the application, which can interact with verticles using the event-bus or runOnContext\n\nSee also https://github.com/vietj/childprocess-vertx-ext based on https://github.com/brettwooldridge/NuProcess :\n\nA low-overhead, non-blocking I/O, external Process execution implementation for Java. It is a replacement for java.lang.ProcessBuilder and java.lang.Process.\nHave you ever been annoyed by the fact that whenever you spawn a process in Java you have to create two or three \"pumper\" threads (for every process) to pull data out of the stdout and stderr pipes and pump data into stdin? If your code starts a lot of processes you can have dozens or hundreds of threads doing nothing but pumping data.", "author": "julianladisch", "createdAt": "2020-09-17T17:35:17Z", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -98,6 +92,36 @@ public void start(Handler<AsyncResult<Void>> startFuture) {\n     }\n   }\n \n+  private static Process launch(Vertx vertx, String id, EnvEntry[] env,\n+                                String [] command) throws IOException {\n+\n+    ProcessBuilder pb = new ProcessBuilder(command);\n+    if (env != null) {\n+      Map<String, String> penv = pb.environment();\n+      for (EnvEntry nv : env) {\n+        penv.put(nv.getName(), nv.getValue());\n+      }\n+    }\n+    Process process = pb.start();\n+    captureStream(vertx, id, process.getInputStream());\n+    captureStream(vertx, id, process.getErrorStream());\n+    return process;\n+  }\n+\n+  private static void captureStream(Vertx vertx, String id, InputStream input) {\n+    vertx.executeBlocking(res -> {", "originalCommit": "b5fac4836d287f0e1e02414673faa2c10885b19b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MDcxNw==", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r490840717", "bodyText": "Thx. I'll look for another capture approach.", "author": "adamdickmeiss", "createdAt": "2020-09-18T10:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQzOTEzNw=="}], "type": "inlineReview"}, {"oid": "598523bd923592c81a1c778042a0c2f0ccbc5f9e", "url": "https://github.com/folio-org/okapi/commit/598523bd923592c81a1c778042a0c2f0ccbc5f9e", "message": "Fix doc for id param", "committedDate": "2020-09-18T12:37:28Z", "type": "commit"}, {"oid": "80fe101d01299951c14e720fc9c06f800ed9bd6e", "url": "https://github.com/folio-org/okapi/commit/80fe101d01299951c14e720fc9c06f800ed9bd6e", "message": "Use https://github.com/brettwooldridge/NuProcess", "committedDate": "2020-09-18T15:54:18Z", "type": "commit"}, {"oid": "24245443d70446515ac6003edbccfd0bc10cbc78", "url": "https://github.com/folio-org/okapi/commit/24245443d70446515ac6003edbccfd0bc10cbc78", "message": "Merge remote-tracking branch 'origin/master' into OKAPI-892-redirect-process-output-to-log", "committedDate": "2020-09-18T15:55:01Z", "type": "commit"}, {"oid": "9ec170b4ffae473d0fef3bc8cbe60ff10c2e6d1f", "url": "https://github.com/folio-org/okapi/commit/9ec170b4ffae473d0fef3bc8cbe60ff10c2e6d1f", "message": "A few comments about logging process output", "committedDate": "2020-09-21T11:16:49Z", "type": "commit"}, {"oid": "89aa25c4feee13b904e78e02ce7d19cb2712a4cf", "url": "https://github.com/folio-org/okapi/commit/89aa25c4feee13b904e78e02ce7d19cb2712a4cf", "message": "Indicate some tests ignored on Windows", "committedDate": "2020-09-21T11:17:16Z", "type": "commit"}, {"oid": "cc934b4311ca5de3aaa39616adb6365290ce34a1", "url": "https://github.com/folio-org/okapi/commit/cc934b4311ca5de3aaa39616adb6365290ce34a1", "message": "Sort imports for ProcessModuleHandleTest", "committedDate": "2020-09-21T11:19:41Z", "type": "commit"}, {"oid": "72ce2443dc5eae93f31a6efce0972dcbe15901e1", "url": "https://github.com/folio-org/okapi/commit/72ce2443dc5eae93f31a6efce0972dcbe15901e1", "message": "Merge remote-tracking branch 'origin/master' into OKAPI-892-redirect-process-output-to-log", "committedDate": "2020-09-21T11:19:48Z", "type": "commit"}, {"oid": "7934d664c56b13307e632c32a3e784fd9cf60da6", "url": "https://github.com/folio-org/okapi/commit/7934d664c56b13307e632c32a3e784fd9cf60da6", "message": "Rename test", "committedDate": "2020-09-21T11:30:44Z", "type": "commit"}, {"oid": "c69fedc573a747007a605852928149a029e90b61", "url": "https://github.com/folio-org/okapi/commit/c69fedc573a747007a605852928149a029e90b61", "message": "NuProcess catches IOException on its own\n\nAnd uses Integer.MIN_VALUE as exit code for this situation, such\nas when execution fails (no such file, permission problem etc).", "committedDate": "2020-09-21T12:56:21Z", "type": "commit"}, {"oid": "41f3304ef2edf946f7b1b94864e4b648792b2349", "url": "https://github.com/folio-org/okapi/commit/41f3304ef2edf946f7b1b94864e4b648792b2349", "message": "Unused import", "committedDate": "2020-09-21T12:58:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY0Njc3MA==", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r492646770", "bodyText": "This should not use the Charset of the server where Okapi runs but StandardCharsets.UTF_8.", "author": "julianladisch", "createdAt": "2020-09-22T11:01:07Z", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -98,6 +92,47 @@ public void start(Handler<AsyncResult<Void>> startFuture) {\n     }\n   }\n \n+  @Override\n+  public void onStdout(ByteBuffer buffer, boolean closed) {\n+    byte[] bytes = new byte[buffer.remaining()];\n+    buffer.get(bytes);\n+    String s = new String(bytes);", "originalCommit": "41f3304ef2edf946f7b1b94864e4b648792b2349", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY1MTYxMg==", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r492651612", "bodyText": "ok. done", "author": "adamdickmeiss", "createdAt": "2020-09-22T11:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY0Njc3MA=="}], "type": "inlineReview"}, {"oid": "d0dfe4d6a4b1bf2a11dcd797574e35b66687e4df", "url": "https://github.com/folio-org/okapi/commit/d0dfe4d6a4b1bf2a11dcd797574e35b66687e4df", "message": "Construct string with UTF-8 encoding", "committedDate": "2020-09-22T11:10:16Z", "type": "commit"}, {"oid": "dba18c320b8db53d59137de701ea3c24a5e840e7", "url": "https://github.com/folio-org/okapi/commit/dba18c320b8db53d59137de701ea3c24a5e840e7", "message": "Move PostgresModuleHandleTest to same package as PostgresModuleHandle", "committedDate": "2020-09-22T11:16:08Z", "type": "commit"}, {"oid": "70d7d56ef38c93830b8de5bf3a48f5ca93da7fed", "url": "https://github.com/folio-org/okapi/commit/70d7d56ef38c93830b8de5bf3a48f5ca93da7fed", "message": "Unused import", "committedDate": "2020-09-22T11:16:50Z", "type": "commit"}]}