{"pr_number": 1057, "pr_title": "OKAPI-947 - Updates for static permissions migration", "pr_createdAt": "2020-12-11T13:33:10Z", "pr_url": "https://github.com/folio-org/okapi/pull/1057", "timeline": [{"oid": "c8237c613f14101544630b1b3767731ef4f0a5d4", "url": "https://github.com/folio-org/okapi/commit/c8237c613f14101544630b1b3767731ef4f0a5d4", "message": "OKAPI-947 Adjust payload for _tenantPermissions, add renamedFrom field to MD, and refresh perms on all mod-permissions install/upgrades", "committedDate": "2020-12-11T13:24:05Z", "type": "commit"}, {"oid": "668ba3eb3d9674606b1f11fb70e422ae5ac07261", "url": "https://github.com/folio-org/okapi/commit/668ba3eb3d9674606b1f11fb70e422ae5ac07261", "message": "Merge branch 'master' into OKAPI-947", "committedDate": "2020-12-11T15:22:56Z", "type": "commit"}, {"oid": "6ae21881e1a9e82a6d038d1b37cdd3ab994cc4d9", "url": "https://github.com/folio-org/okapi/commit/6ae21881e1a9e82a6d038d1b37cdd3ab994cc4d9", "message": "Merge branch 'master' into OKAPI-947", "committedDate": "2020-12-14T13:25:37Z", "type": "commit"}, {"oid": "3a34a40dcbe4e020dbf60ed245be66c8fbd77de3", "url": "https://github.com/folio-org/okapi/commit/3a34a40dcbe4e020dbf60ed245be66c8fbd77de3", "message": "support _tenantPermissions 1.0, 1.1, 2.0", "committedDate": "2020-12-14T17:45:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MzY1MA==", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542593650", "bodyText": "Please add check for \"2.0\". And report failure if no match (return failed future).", "author": "adamdickmeiss", "createdAt": "2020-12-14T18:04:15Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -651,16 +648,24 @@ private void fireTimer(Tenant tenant, ModuleDescriptor md, RoutingEntry re, Stri\n   }\n \n   private Future<Void> invokePermissionsForModule(Tenant tenant, ModuleDescriptor mdTo,\n-                                                  ModuleDescriptor permsModule, ProxyContext pc) {\n+      ModuleDescriptor mdFrom, ModuleDescriptor permsModule, ProxyContext pc) {\n \n     logger.debug(\"Loading permissions for {} (using {})\", mdTo.getName(), permsModule.getName());\n     String moduleTo = mdTo.getId();\n     PermissionList pl = null;\n     InterfaceDescriptor permInt = permsModule.getSystemInterface(\"_tenantPermissions\");\n-    if (permInt.getVersion().equals(\"1.0\")) {\n-      pl = new PermissionList(moduleTo, mdTo.getPermissionSets());\n+    String permIntVer = permInt.getVersion();\n+    if (permIntVer.equals(\"1.0\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getPermissionSets());\n+    } else if (permIntVer.equals(\"1.1\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getExpandedPermissionSets());\n     } else {\n-      pl = new PermissionList(moduleTo, mdTo.getExpandedPermissionSets());\n+      if (mdFrom != null) {\n+        pl = new PermissionListV2(moduleTo, mdFrom.getId(), mdTo.getExpandedPermissionSets(),\n+            mdFrom.getExpandedPermissionSets());\n+      } else {\n+        pl = new PermissionListV2(moduleTo, mdTo.getExpandedPermissionSets());\n+      }", "originalCommit": "3a34a40dcbe4e020dbf60ed245be66c8fbd77de3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxMDI1MA==", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542610250", "bodyText": "And in the case where we get something other than 1.0, 1.1, or 2.0, also return a failure?  I guess the assumption there is that when/if 2.1 comes along we'll need to make changes here anyway?", "author": "craigmcnally", "createdAt": "2020-12-14T18:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MzY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxMTIwNg==", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542611206", "bodyText": "NM I need to read more closely.", "author": "craigmcnally", "createdAt": "2020-12-14T18:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MzY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxNTMwNQ==", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542615305", "bodyText": "Yes. Okapi should report a failure for an unknown interface version.", "author": "adamdickmeiss", "createdAt": "2020-12-14T18:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MzY1MA=="}], "type": "inlineReview"}, {"oid": "fd54e81400e43f05c3f45a14f7fbc8adc508cabd", "url": "https://github.com/folio-org/okapi/commit/fd54e81400e43f05c3f45a14f7fbc8adc508cabd", "message": "OKAPI-947 explicit check for known _tenantPermissions version", "committedDate": "2020-12-14T19:15:16Z", "type": "commit"}, {"oid": "5f7af520866a184a18ef1f53e34af6055806f0ea", "url": "https://github.com/folio-org/okapi/commit/5f7af520866a184a18ef1f53e34af6055806f0ea", "message": "Merge branch 'master' into OKAPI-947", "committedDate": "2020-12-14T19:16:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4ODM5Ng==", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542688396", "bodyText": "I prefer you use ErrorType.USER here so that it returns 400, not 500. I think we should only return 500 when Okapi makes unexpected failures that are \"not meant to happen\".", "author": "adamdickmeiss", "createdAt": "2020-12-14T19:33:55Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -659,13 +659,16 @@ private void fireTimer(Tenant tenant, ModuleDescriptor md, RoutingEntry re, Stri\n       pl = new PermissionListV1(moduleTo, mdTo.getPermissionSets());\n     } else if (permIntVer.equals(\"1.1\")) {\n       pl = new PermissionListV1(moduleTo, mdTo.getExpandedPermissionSets());\n-    } else {\n+    } else if (permIntVer.equals(\"2.0\")) {\n       if (mdFrom != null) {\n         pl = new PermissionListV2(moduleTo, mdFrom.getId(), mdTo.getExpandedPermissionSets(),\n             mdFrom.getExpandedPermissionSets());\n       } else {\n         pl = new PermissionListV2(moduleTo, mdTo.getExpandedPermissionSets());\n       }\n+    } else {\n+      return Future.failedFuture(new OkapiError(ErrorType.ANY,\n+          \"Unknown version of _tenantPermissions interface in use \" + permIntVer + \".\"));\n     }", "originalCommit": "fd54e81400e43f05c3f45a14f7fbc8adc508cabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MTU1Mw==", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542691553", "bodyText": "fair enough", "author": "craigmcnally", "createdAt": "2020-12-14T19:36:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4ODM5Ng=="}], "type": "inlineReview"}, {"oid": "427db73115b9d51881068d0be1463fcfb4fdab18", "url": "https://github.com/folio-org/okapi/commit/427db73115b9d51881068d0be1463fcfb4fdab18", "message": "OKAPI-947 User error not server error", "committedDate": "2020-12-14T19:38:45Z", "type": "commit"}, {"oid": "3f7260e1598a40c3d54979d7a170acf1fc71a13e", "url": "https://github.com/folio-org/okapi/commit/3f7260e1598a40c3d54979d7a170acf1fc71a13e", "message": "Merge branch 'master' into OKAPI-947", "committedDate": "2020-12-14T19:39:42Z", "type": "commit"}, {"oid": "ad60808b5a130a7467e27c8012cf9e3c2b8195f3", "url": "https://github.com/folio-org/okapi/commit/ad60808b5a130a7467e27c8012cf9e3c2b8195f3", "message": "Merge branch 'master' into OKAPI-947", "committedDate": "2020-12-14T20:18:02Z", "type": "commit"}]}