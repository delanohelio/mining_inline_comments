{"pr_number": 1007, "pr_title": "Docker pull with authenticated user OKAPI-912", "pr_createdAt": "2020-10-20T11:00:54Z", "pr_url": "https://github.com/folio-org/okapi/pull/1007", "timeline": [{"oid": "2ab5335d0f7018b59f5dc78dd4b1221bcc803005", "url": "https://github.com/folio-org/okapi/commit/2ab5335d0f7018b59f5dc78dd4b1221bcc803005", "message": "Docker pull with authenticated user OKAPI-912\n\nConfiguration property `dockerRegistries` includes list of registries\nwith authenticaition at the moment. Expected to be extended with\na specifier for other registry.", "committedDate": "2020-10-20T10:58:19Z", "type": "commit"}, {"oid": "b555d00a24ebdcca5500ee4d2fdef9f21a28f3bb", "url": "https://github.com/folio-org/okapi/commit/b555d00a24ebdcca5500ee4d2fdef9f21a28f3bb", "message": "Registry can be specified as part of dockerRegistries", "committedDate": "2020-10-20T11:36:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYxMjIyOA==", "url": "https://github.com/folio-org/okapi/pull/1007#discussion_r508612228", "bodyText": "You can replace the Boolean by future.recover:\nFuture<Void> future = Future.failedFuture(\"\");\nfor (int i = 0; i < dockerRegistries.size(); i++) {\n  ...\n  future = future.recover(failure -> {\n    ...\n    return postUrlJson(\"/images/create?fromImage=\" + prefix + image, authObject, \"pullImage\", \"\");\n  });\n}\nreturn future;\n\nThis has the additional benefit of returning the failure details of the last registry entry.", "author": "julianladisch", "createdAt": "2020-10-20T15:30:04Z", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/DockerModuleHandle.java", "diffHunk": "@@ -237,15 +242,51 @@ private void logHandler(Buffer b) {\n     return getUrl(\"/images/\" + image + \"/json\");\n   }\n \n-  private Future<Void> pullImage() {\n-    logger.info(\"pull image {}\", image);\n-    return postUrlJson(\"/images/create?fromImage=\" + image, \"pullImage\", \"\")\n-        .mapEmpty();\n+  Future<Void> pullImage() {\n+    if (dockerRegistries == null) {\n+      logger.info(\"pull image {}\", image);\n+      return postUrlJson(\"/images/create?fromImage=\" + image, null, \"pullImage\", \"\")\n+          .mapEmpty();\n+    }\n+    logger.info(\"pull Image using dockerRegistries\");\n+    Future<Boolean> future = Future.succeededFuture(Boolean.FALSE);", "originalCommit": "b555d00a24ebdcca5500ee4d2fdef9f21a28f3bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYyNTk0NQ==", "url": "https://github.com/folio-org/okapi/pull/1007#discussion_r508625945", "bodyText": "Much better. Thx", "author": "adamdickmeiss", "createdAt": "2020-10-20T15:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYxMjIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYyNDQ1Nw==", "url": "https://github.com/folio-org/okapi/pull/1007#discussion_r508624457", "bodyText": "Can you also add a test with an empty JsonObject for unauthenticated pull?\nconf.put(\"dockerRegistries\", new JsonArray()\n        .add(new JsonObject())\n        .add(new JsonObject().put(\"username\", \"x\").put(\"password\", \"y\")));", "author": "julianladisch", "createdAt": "2020-10-20T15:40:23Z", "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -136,6 +150,110 @@ private void dockerMockHandle(RoutingContext ctx) {\n     }\n   }\n \n+  @Test\n+  public void testDockerPull(TestContext context) {\n+    Vertx vertx = Vertx.vertx();\n+    int dockerPort = 9231;\n+\n+    Router router = Router.router(vertx);\n+    router.routeWithRegex(\"/.*\").handler(this::dockerMockHandle);\n+\n+    HttpServerOptions so = new HttpServerOptions().setHandle100ContinueAutomatically(true);\n+    HttpServer listen = vertx.createHttpServer(so)\n+        .requestHandler(router)\n+        .listen(dockerPort, context.asyncAssertSuccess());\n+    LaunchDescriptor ld = new LaunchDescriptor();\n+    ld.setWaitIterations(2);\n+    ld.setDockerImage(\"folioci/mod-x\");\n+    ld.setDockerPull(true);\n+\n+    Ports ports = new Ports(9232, 9233);\n+    JsonObject conf = new JsonObject().put(\"dockerUrl\", \"tcp://localhost:\" + dockerPort);\n+\n+    dockerPullJson = new JsonObject().put(\"message\", \"some message\");\n+    dockerPullStatus = 200;\n+\n+    {\n+      DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n+          \"mod-users-5.0.0-SNAPSHOT\", ports, \"localhost\",\n+          9231, conf);\n+      Async async = context.async();\n+      dh.pullImage().onComplete(context.asyncAssertSuccess(x -> {\n+        async.complete();\n+      }));\n+      async.await();\n+    }\n+\n+    conf.put(\"dockerRegistries\", new JsonArray());\n+    {\n+      DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n+          \"mod-users-5.0.0-SNAPSHOT\", ports, \"localhost\",\n+          9231, conf);\n+      Async async = context.async();\n+      dh.pullImage().onComplete(context.asyncAssertFailure(x -> {\n+        async.complete();\n+      }));\n+      async.await();\n+    }\n+\n+    conf.put(\"dockerRegistries\", new JsonArray()\n+        .addNull()\n+        .add(new JsonObject().put(\"username\", \"x\").put(\"password\", \"y\")));", "originalCommit": "b555d00a24ebdcca5500ee4d2fdef9f21a28f3bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYyNzU5Mg==", "url": "https://github.com/folio-org/okapi/pull/1007#discussion_r508627592", "bodyText": "sure", "author": "adamdickmeiss", "createdAt": "2020-10-20T15:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYyNDQ1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5NzkyNQ==", "url": "https://github.com/folio-org/okapi/pull/1007#discussion_r508697925", "bodyText": "I still cannot find such a test that should succeed.", "author": "julianladisch", "createdAt": "2020-10-20T17:08:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYyNDQ1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcwMzE5Mw==", "url": "https://github.com/folio-org/okapi/pull/1007#discussion_r508703193", "bodyText": "I still don't see it, can you point me to the line?", "author": "julianladisch", "createdAt": "2020-10-20T17:17:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYyNDQ1Nw=="}], "type": "inlineReview"}, {"oid": "c16a790cb343aefef38d6e48e23646d076c214eb", "url": "https://github.com/folio-org/okapi/commit/c16a790cb343aefef38d6e48e23646d076c214eb", "message": "Merge branch 'master' of github.com:folio-org/okapi into OKAPI-912-docker-pull-with-auth", "committedDate": "2020-10-20T15:47:10Z", "type": "commit"}, {"oid": "c31943da72b52fbff12b2bef1837dfa912423cc1", "url": "https://github.com/folio-org/okapi/commit/c31943da72b52fbff12b2bef1837dfa912423cc1", "message": "Doc updates", "committedDate": "2020-10-20T15:47:53Z", "type": "commit"}, {"oid": "c1458fc08d146dc8b6db082f5884bc80f3ea6ef3", "url": "https://github.com/folio-org/okapi/commit/c1458fc08d146dc8b6db082f5884bc80f3ea6ef3", "message": "Simplify with recover (and no compose)", "committedDate": "2020-10-20T15:48:24Z", "type": "commit"}, {"oid": "eca09b869fe2645c09b7e3babe100f1f408a334b", "url": "https://github.com/folio-org/okapi/commit/eca09b869fe2645c09b7e3babe100f1f408a334b", "message": "Case with empty object", "committedDate": "2020-10-20T15:48:35Z", "type": "commit"}, {"oid": "74f949e1e2b0fd32afa0bfebabac6cee891cd0bd", "url": "https://github.com/folio-org/okapi/commit/74f949e1e2b0fd32afa0bfebabac6cee891cd0bd", "message": "identitytoken also passed if given", "committedDate": "2020-10-20T15:51:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0OTY4MQ==", "url": "https://github.com/folio-org/okapi/pull/1007#discussion_r508649681", "bodyText": "All these code blocks are almost the same and might be extracted into a method, for example\nboolean pullImage(TestContext context, Vertx vertx, String host, JsonObject conf) {\n  LaunchDescriptor ld = new LaunchDescriptor();\n  ld.setWaitIterations(2);\n  ld.setDockerImage(\"folioci/mod-x\");\n  ld.setDockerPull(true);\n  Ports ports = new Ports(9232, 9233);\n  DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n          \"mod-users-5.0.0-SNAPSHOT\", ports, host,\n          9231, conf);\n  Async async = context.async();\n  AtomicBoolean succeeded = new AtomicBoolean();\n  dh.pullImage().onComplete(done -> {\n    succeeded.set(done.succeeded()));\n    async.complete();\n  });\n  async.await();\n  return succeeded.get();\n}\n\nassertThat(pullImage(context, vertx, \"localhost\", conf), is(true));", "author": "julianladisch", "createdAt": "2020-10-20T16:02:34Z", "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -136,6 +150,124 @@ private void dockerMockHandle(RoutingContext ctx) {\n     }\n   }\n \n+  @Test\n+  public void testDockerPull(TestContext context) {\n+    Vertx vertx = Vertx.vertx();\n+    int dockerPort = 9231;\n+\n+    Router router = Router.router(vertx);\n+    router.routeWithRegex(\"/.*\").handler(this::dockerMockHandle);\n+\n+    HttpServerOptions so = new HttpServerOptions().setHandle100ContinueAutomatically(true);\n+    HttpServer listen = vertx.createHttpServer(so)\n+        .requestHandler(router)\n+        .listen(dockerPort, context.asyncAssertSuccess());\n+    LaunchDescriptor ld = new LaunchDescriptor();\n+    ld.setWaitIterations(2);\n+    ld.setDockerImage(\"folioci/mod-x\");\n+    ld.setDockerPull(true);\n+\n+    Ports ports = new Ports(9232, 9233);\n+    JsonObject conf = new JsonObject().put(\"dockerUrl\", \"tcp://localhost:\" + dockerPort);\n+\n+    dockerPullJson = new JsonObject().put(\"message\", \"some message\");\n+    dockerPullStatus = 200;\n+\n+    {\n+      DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n+          \"mod-users-5.0.0-SNAPSHOT\", ports, \"localhost\",\n+          9231, conf);\n+      Async async = context.async();\n+      dh.pullImage().onComplete(context.asyncAssertSuccess(x -> {\n+        async.complete();\n+      }));\n+      async.await();\n+    }", "originalCommit": "74f949e1e2b0fd32afa0bfebabac6cee891cd0bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c6c04206e278c0a9ca50cc6dd85d8d220e230454", "url": "https://github.com/folio-org/okapi/commit/c6c04206e278c0a9ca50cc6dd85d8d220e230454", "message": "pullImage helper for testing", "committedDate": "2020-10-20T16:42:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5Njc4MA==", "url": "https://github.com/folio-org/okapi/pull/1007#discussion_r508696780", "bodyText": "The host value was \"localhost:5000\" before the last commit.\nIf we always use \"localhost\" this parameter can be removed and it can be hardcoded in pullImage.\nHow can we unit test that the \"registry\" parameter is handled correctly?", "author": "julianladisch", "createdAt": "2020-10-20T17:06:45Z", "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -136,6 +151,68 @@ private void dockerMockHandle(RoutingContext ctx) {\n     }\n   }\n \n+  boolean pullImage(TestContext context, Vertx vertx, String host, JsonObject conf) {\n+    LaunchDescriptor ld = new LaunchDescriptor();\n+    ld.setWaitIterations(2);\n+    ld.setDockerImage(\"folioci/mod-x\");\n+    ld.setDockerPull(true);\n+    Ports ports = new Ports(9232, 9233);\n+    DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n+        \"mod-users-5.0.0-SNAPSHOT\", ports, host,\n+        9231, conf);\n+    Async async = context.async();\n+    AtomicBoolean succeeded = new AtomicBoolean();\n+    dh.pullImage().onComplete(done -> {\n+      succeeded.set(done.succeeded());\n+      async.complete();\n+    });\n+    async.await();\n+    return succeeded.get();\n+  }\n+\n+  @Test\n+  public void testDockerPull(TestContext context) {\n+    Vertx vertx = Vertx.vertx();\n+    int dockerPort = 9231;\n+\n+    Router router = Router.router(vertx);\n+    router.routeWithRegex(\"/.*\").handler(this::dockerMockHandle);\n+\n+    HttpServerOptions so = new HttpServerOptions().setHandle100ContinueAutomatically(true);\n+    HttpServer listen = vertx.createHttpServer(so)\n+        .requestHandler(router)\n+        .listen(dockerPort, context.asyncAssertSuccess());\n+    dockerPullJson = new JsonObject().put(\"message\", \"some message\");\n+    dockerPullStatus = 200;\n+\n+    JsonObject conf = new JsonObject().put(\"dockerUrl\", \"tcp://localhost:\" + dockerPort);\n+    context.assertTrue(pullImage(context, vertx, \"localhost\", conf));\n+\n+    conf.put(\"dockerRegistries\", new JsonArray());\n+    context.assertFalse(pullImage(context, vertx, \"localhost\", conf));\n+\n+    conf.put(\"dockerRegistries\", new JsonArray()\n+        .addNull()\n+        .add(new JsonObject().put(\"username\", \"x\").put(\"password\", \"y\")));\n+    context.assertFalse(pullImage(context, vertx, \"localhost\", conf));\n+\n+    conf.put(\"dockerRegistries\", new JsonArray()\n+        .add(new JsonObject().put(\"username\", \"x\").put(\"password\", \"y\"))\n+        .add(new JsonObject().put(\"username\", \"x\").put(\"password\", \"x\"))\n+        .add(new JsonObject().put(\"username\", \"x\").put(\"password\", \"z\")));\n+    context.assertTrue(pullImage(context, vertx, \"localhost\", conf));\n+\n+    conf.put(\"dockerRegistries\", new JsonArray()\n+        .add(new JsonObject().put(\"registry\", \"localhost:5000\")));\n+    context.assertTrue(pullImage(context, vertx, \"localhost\", conf));\n+\n+    conf.put(\"dockerRegistries\", new JsonArray()\n+        .add(new JsonObject().put(\"registry\", \"localhost:5000/\")));\n+    context.assertTrue(pullImage(context, vertx, \"localhost\", conf));", "originalCommit": "c6c04206e278c0a9ca50cc6dd85d8d220e230454", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAwOTE4OA==", "url": "https://github.com/folio-org/okapi/pull/1007#discussion_r510009188", "bodyText": "There's one localhost:5000 and localhost:5000/ now.", "author": "adamdickmeiss", "createdAt": "2020-10-22T09:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5Njc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAyOTEyNg==", "url": "https://github.com/folio-org/okapi/pull/1007#discussion_r510029126", "bodyText": "Yes. That \"localhost\" is the containerHost.. something completely different. And that can be hard-coded.", "author": "adamdickmeiss", "createdAt": "2020-10-22T09:48:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5Njc4MA=="}], "type": "inlineReview"}, {"oid": "d36021d2c3bc25967b2b03f397824ab39f53b260", "url": "https://github.com/folio-org/okapi/commit/d36021d2c3bc25967b2b03f397824ab39f53b260", "message": "Empty object for dockerRegistry", "committedDate": "2020-10-22T09:16:38Z", "type": "commit"}, {"oid": "f93c1a6e432bd9b565d3cad255bcb63285d7b72e", "url": "https://github.com/folio-org/okapi/commit/f93c1a6e432bd9b565d3cad255bcb63285d7b72e", "message": "Registry testing and containerHost is always \"localhost\"\n\nRegistry tested in two ways.. Against local mock to see we see the correct\nhost+port. Also testing against real Docker instance (if available) and\nsee that it indeed uses the registry we provide.", "committedDate": "2020-10-22T09:43:29Z", "type": "commit"}]}