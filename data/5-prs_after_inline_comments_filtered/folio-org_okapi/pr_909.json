{"pr_number": 909, "pr_title": "Facility: disable all modules for tenant OKAPI-596", "pr_createdAt": "2020-04-15T13:23:56Z", "pr_url": "https://github.com/folio-org/okapi/pull/909", "timeline": [{"oid": "b429fa4e66cfddec84a5836d34b9d97bb3aeeb51", "url": "https://github.com/folio-org/okapi/commit/b429fa4e66cfddec84a5836d34b9d97bb3aeeb51", "message": "Facility: disable all modules for tenant OKAPI-596", "committedDate": "2020-04-15T13:20:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1ODQ2NA==", "url": "https://github.com/folio-org/okapi/pull/909#discussion_r409158464", "bodyText": "This line can probably be replaced by Line 356 if we remove the else statement.", "author": "hjiebsco", "createdAt": "2020-04-15T21:58:00Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -269,80 +270,113 @@ public void updateModuleCommit(Tenant t,\n     });\n   }\n \n-  void enableAndDisableModule(String tenantId,\n+  void enableAndDisableModule(String tenantId, TenantInstallOptions options,\n                               String moduleFrom, TenantModuleDescriptor td, ProxyContext pc,\n                               Handler<ExtendedAsyncResult<String>> fut) {\n-\n     tenants.get(tenantId, tres -> {\n       if (tres.failed()) {\n         fut.handle(new Failure<>(tres.getType(), tres.cause()));\n-      } else {\n-        Tenant tenant = tres.result();\n-        enableAndDisableModule(tenant, moduleFrom, td, pc, fut);\n+        return;\n       }\n+      Tenant tenant = tres.result();\n+      enableAndDisableModule(tenant, options, moduleFrom, td, pc, fut);\n     });\n   }\n \n-  private void enableAndDisableModule(Tenant tenant,\n+  private void enableAndDisableModule(Tenant tenant, TenantInstallOptions options,\n                                       String moduleFrom, TenantModuleDescriptor td, ProxyContext pc,\n                                       Handler<ExtendedAsyncResult<String>> fut) {\n \n     if (td == null) {\n-      moduleManager.get(moduleFrom, resFrom -> {\n-        if (resFrom.failed()) {\n-          fut.handle(new Failure<>(resFrom.getType(), resFrom.cause()));\n-        } else {\n-          ModuleDescriptor mdFrom = resFrom.result();\n-          enableAndDisableModule2(tenant, null, mdFrom, null, pc, fut);\n-        }\n-      });\n+      enableAndDisableModule2(tenant, options, moduleFrom, null, pc, fut);\n     } else {\n       moduleManager.getLatest(td.getId(), resTo -> {\n         if (resTo.failed()) {\n           fut.handle(new Failure<>(resTo.getType(), resTo.cause()));\n-        } else {\n-          ModuleDescriptor mdTo = resTo.result();\n-          moduleManager.get(moduleFrom, resFrom -> {\n-            if (resFrom.failed()) {\n-              fut.handle(new Failure<>(resFrom.getType(), resFrom.cause()));\n-            } else {\n-              ModuleDescriptor mdFrom = resFrom.result();\n-              enableAndDisableModule2(tenant, null, mdFrom, mdTo, pc, fut);\n-            }\n-          });\n+          return;\n         }\n+        ModuleDescriptor mdTo = resTo.result();\n+        enableAndDisableModule2(tenant, options, moduleFrom, mdTo, pc, fut);\n       });\n     }\n   }\n \n-  private void enableAndDisableModule2(\n-      Tenant tenant, String tenantParameters,\n-      ModuleDescriptor mdFrom, ModuleDescriptor mdTo, ProxyContext pc,\n-      Handler<ExtendedAsyncResult<String>> fut) {\n-\n-    moduleManager.enableAndDisableCheck(tenant, mdFrom, mdTo, cres -> {\n-      if (cres.failed()) {\n-        pc.debug(\"enableAndDisableModule: depcheck fail: \" + cres.cause().getMessage());\n-        fut.handle(new Failure<>(cres.getType(), cres.cause()));\n+  private Future<Void> enableAndDisableModuleFut(String tenantId, TenantInstallOptions options,\n+                                                 String moduleFrom, TenantModuleDescriptor td,\n+                                                 ProxyContext pc) {\n+    Promise<Void> promise = Promise.promise();\n+    enableAndDisableModule(tenantId, options, moduleFrom, td, pc, res -> {\n+      if (res.failed()) {\n+        promise.fail(res.cause());\n       } else {\n-        pc.debug(\"enableAndDisableModule: depcheck ok\");\n-        ead1TenantInterface(tenant, tenantParameters, mdFrom, mdTo, false, pc, res -> {\n-          if (res.failed()) {\n-            fut.handle(new Failure<>(res.getType(), res.cause()));\n+        promise.complete();\n+      }\n+    });\n+    return promise.future();\n+  }\n+\n+  Future<Void> disableModules(String tenantId, TenantInstallOptions options, ProxyContext pc) {\n+    Promise<Void> promise = Promise.promise();\n+    options.setDepCheck(false);\n+    listModules(tenantId, res -> {\n+      if (res.failed()) {\n+        promise.fail(res.cause());\n+        return;\n+      }\n+      Future<Void> future = Future.succeededFuture();\n+      for (ModuleDescriptor md : res.result()) {\n+        future = future.compose(x -> enableAndDisableModuleFut(tenantId, options,\n+          md.getId(), null, pc));\n+      }\n+      future.setHandler(promise::handle);\n+    });\n+    return promise.future();\n+  }\n+\n+  private void enableAndDisableModule2(Tenant tenant, TenantInstallOptions options,\n+                                      String moduleFrom, ModuleDescriptor mdTo, ProxyContext pc,\n+                                      Handler<ExtendedAsyncResult<String>> fut) {\n+\n+    moduleManager.get(moduleFrom, resFrom -> {\n+      if (resFrom.failed()) {\n+        fut.handle(new Failure<>(resFrom.getType(), resFrom.cause()));\n+        return;\n+      }\n+      ModuleDescriptor mdFrom = resFrom.result();\n+      if (options.getDepCheck()) {\n+        moduleManager.enableAndDisableCheck(tenant, mdFrom, mdTo, cres -> {\n+          if (cres.failed()) {\n+            pc.debug(\"enableAndDisableModule: depcheck fail: \" + cres.cause().getMessage());\n+            fut.handle(new Failure<>(cres.getType(), cres.cause()));\n             return;\n           }\n-          ead5commit(tenant, mdFrom, mdTo, pc, res1 -> {\n-            if (res1.failed()) {\n-              fut.handle(new Failure<>(ErrorType.USER, res.cause()));\n-              return;\n-            }\n-            fut.handle(new Success<>(mdTo != null ? mdTo.getId() : \"\"));\n-          });\n+          enableAndDisableModule2(tenant, options, mdFrom, mdTo, pc, fut);", "originalCommit": "b429fa4e66cfddec84a5836d34b9d97bb3aeeb51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU2MjY0MA==", "url": "https://github.com/folio-org/okapi/pull/909#discussion_r409562640", "bodyText": "I don't follow where that is.. The 353 lines .. have else but a lambda.. So I can't fold things together there..", "author": "adamdickmeiss", "createdAt": "2020-04-16T13:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1ODQ2NA=="}], "type": "inlineReview"}, {"oid": "ec08c7eabab41e38d7f1ac2da29d0b859a40b3fb", "url": "https://github.com/folio-org/okapi/commit/ec08c7eabab41e38d7f1ac2da29d0b859a40b3fb", "message": "Merge branch 'master' into okapi-596-disable-all-modules-for-tenant", "committedDate": "2020-04-16T12:24:08Z", "type": "commit"}]}