{"pr_number": 2292, "pr_title": "[core] Simplify metrics framework (for PMD 7)", "pr_createdAt": "2020-02-16T20:06:56Z", "pr_url": "https://github.com/pmd/pmd/pull/2292", "timeline": [{"oid": "4e2ae0d4b2785b89dedaaf9160562d2e68dd5122", "url": "https://github.com/pmd/pmd/commit/4e2ae0d4b2785b89dedaaf9160562d2e68dd5122", "message": "Simplify apex metrics framework further", "committedDate": "2020-02-16T18:36:09Z", "type": "commit"}, {"oid": "43f5252d7eae40a3f3609b9cdcf8eb939bfc770b", "url": "https://github.com/pmd/pmd/commit/43f5252d7eae40a3f3609b9cdcf8eb939bfc770b", "message": "Expose statistics instead of result option", "committedDate": "2020-02-16T18:41:21Z", "type": "commit"}, {"oid": "9c770ac6bb7962a46e5f79617a820435767cc378", "url": "https://github.com/pmd/pmd/commit/9c770ac6bb7962a46e5f79617a820435767cc378", "message": "Simplify Java metrics framework further", "committedDate": "2020-02-16T18:52:15Z", "type": "commit"}, {"oid": "bb3368f3aea14dabd8c757a20dd745b8bdc9298d", "url": "https://github.com/pmd/pmd/commit/bb3368f3aea14dabd8c757a20dd745b8bdc9298d", "message": "Cleanup PMD core metrics", "committedDate": "2020-02-16T19:08:31Z", "type": "commit"}, {"oid": "4fa3a05ebb12255b4bc53b6ed8de0ed21562edfb", "url": "https://github.com/pmd/pmd/commit/4fa3a05ebb12255b4bc53b6ed8de0ed21562edfb", "message": "Move some tests to core", "committedDate": "2020-02-16T19:17:29Z", "type": "commit"}, {"oid": "96097a80e879226281fcbad6c22c5b88ba8e2740", "url": "https://github.com/pmd/pmd/commit/96097a80e879226281fcbad6c22c5b88ba8e2740", "message": "Move metric key static creator to interface", "committedDate": "2020-02-16T19:40:42Z", "type": "commit"}, {"oid": "d40fdc0e4da657bc6beb29e5001eccd31792e56a", "url": "https://github.com/pmd/pmd/commit/d40fdc0e4da657bc6beb29e5001eccd31792e56a", "message": "Remove deprecated stuff", "committedDate": "2020-02-16T20:05:15Z", "type": "commit"}, {"oid": "fd87420953254df442a5cac0e0f82e26f59df74b", "url": "https://github.com/pmd/pmd/commit/fd87420953254df442a5cac0e0f82e26f59df74b", "message": "Merge branch '7.0.x' into simplify-metrics-framework-on-7", "committedDate": "2020-03-17T23:34:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY2NzY5Mw==", "url": "https://github.com/pmd/pmd/pull/2292#discussion_r396667693", "bodyText": "Should we mark this as deprecated on master? It seems, it is only used by tests right now...", "author": "adangel", "createdAt": "2020-03-23T18:27:43Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/lang/metrics/MetricKeyUtil.java", "diffHunk": "@@ -1,68 +0,0 @@\n-/**\n- * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n- */\n-\n-package net.sourceforge.pmd.lang.metrics;\n-\n-import java.util.Objects;\n-\n-import net.sourceforge.pmd.lang.ast.Node;\n-\n-/**\n- * Holds the key creation method until we move it to the MetricKey interface.\n- *\n- * @author Cl\u00e9ment Fournier\n- * @since 6.0.0\n- */\n-public final class MetricKeyUtil {", "originalCommit": "fd87420953254df442a5cac0e0f82e26f59df74b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3MTI0Mg==", "url": "https://github.com/pmd/pmd/pull/2292#discussion_r396671242", "bodyText": "Actually, do we still need this factory method? On master, I don't see any usage of MetricKeyUtil.of(...) other than in tests... Didn't look into the 7.0.0 branch yet", "author": "adangel", "createdAt": "2020-03-23T18:33:36Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/lang/metrics/MetricKey.java", "diffHunk": "@@ -44,4 +51,53 @@\n \n     // TODO the metric key should know about supported options\n \n+\n+    /**\n+     * Creates a new metric key from its metric and name.\n+     *\n+     * @param name   The name of the metric\n+     * @param metric The metric to use\n+     * @param <T>    Type of node the metric can be computed on\n+     *\n+     * @return The metric key\n+     *\n+     * @throws NullPointerException If either parameter is null\n+     */\n+    static <T extends Node> MetricKey<T> of(@NonNull String name, @NonNull Metric<T> metric) {", "originalCommit": "fd87420953254df442a5cac0e0f82e26f59df74b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5MzQ3Mg==", "url": "https://github.com/pmd/pmd/pull/2292#discussion_r396693472", "bodyText": "It's true that it's only used in tests for now, but the doc on the website mentions that this is meant to be a simple extension hook for users defining their own metrics. I think it comes down to the question: is this a use case we really want to support? I would think yes, because it's easy to support. OTOH I think the framework is likely to change more for 7.0 (because eg, it's weird to restrict metrics to two types of nodes per language), and maybe this extension mechanism will be broken.\nI think the safest thing for now is to keep it until we know more about what the framework looks like. I'll mention this on the wiki", "author": "oowekyala", "createdAt": "2020-03-23T19:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3MTI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM5OTcyMg==", "url": "https://github.com/pmd/pmd/pull/2292#discussion_r397399722", "bodyText": "\ud83d\udc4d", "author": "adangel", "createdAt": "2020-03-24T19:14:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3MTI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NDE4NA==", "url": "https://github.com/pmd/pmd/pull/2292#discussion_r396674184", "bodyText": "Seems like, we also need to update the doc for PMD 7: https://github.com/pmd/pmd/blob/pmd/7.0.x/docs/pages/pmd/userdocs/extending/metrics_howto.md\nThe examples need to be updated to use MetricsUtil instead of JavaMetrics", "author": "adangel", "createdAt": "2020-03-23T18:38:15Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/design/CyclomaticComplexityRule.java", "diffHunk": "@@ -128,7 +126,7 @@ public Object visit(ASTAnyTypeDeclaration node, Object data) {\n             int classWmc = (int) MetricsUtil.computeMetric(JavaClassMetricKey.WMC, node, cycloOptions);\n \n             if (classWmc >= classReportLevel) {\n-                int classHighest = (int) JavaMetrics.get(JavaOperationMetricKey.CYCLO, node, cycloOptions, ResultOption.HIGHEST);\n+                int classHighest = (int) MetricsUtil.computeStatistics(JavaOperationMetricKey.CYCLO, node.getOperations(), cycloOptions).getMax();", "originalCommit": "fd87420953254df442a5cac0e0f82e26f59df74b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4OTg5Ng==", "url": "https://github.com/pmd/pmd/pull/2292#discussion_r396689896", "bodyText": "Will do\nActually part of this could be updated on master.", "author": "oowekyala", "createdAt": "2020-03-23T19:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NDE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM5OTQ3Ng==", "url": "https://github.com/pmd/pmd/pull/2292#discussion_r397399476", "bodyText": "Cool, thanks!", "author": "adangel", "createdAt": "2020-03-24T19:13:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NDE4NA=="}], "type": "inlineReview"}]}