{"pr_number": 2589, "pr_title": "[core] Add generic visitor interface in pmd-core", "pr_createdAt": "2020-06-14T09:52:24Z", "pr_url": "https://github.com/pmd/pmd/pull/2589", "timeline": [{"oid": "b88ddf41c03ca009dea879bdaafd6ddcb6085fcc", "url": "https://github.com/pmd/pmd/commit/b88ddf41c03ca009dea879bdaafd6ddcb6085fcc", "message": "Add generic visitor interface in pmd-core\n\nReplace SideEffectingVisitor with JavaVisitor\n\nThe new visitor is generic. We don't actually need the\nold Object->Object visitor, this could just be the new\ngeneric visitor but erased\n\nPort language level checker\n\nMove delegators\n\nRemove old accept methods\n\nRemove reduced adapter\n\nCleanup some visitor\n\nMake ant wrapper replace old visitor completely\n\nDoc\n\nAdd DeprecatedUntil700 annotation\n\nAdd top interface for visitors\n\nConvert JSP visitors\n\nCheckstyle\n\nFix java module", "committedDate": "2020-06-14T09:43:24Z", "type": "commit"}, {"oid": "f7b1c375c1b354a6bee46022229963410aff24bd", "url": "https://github.com/pmd/pmd/commit/f7b1c375c1b354a6bee46022229963410aff24bd", "message": "Fix scala compilation", "committedDate": "2020-06-14T11:02:30Z", "type": "commit"}, {"oid": "ee1afed8c55d92b3e11b754030b8a2d2a79bc8fd", "url": "https://github.com/pmd/pmd/commit/ee1afed8c55d92b3e11b754030b8a2d2a79bc8fd", "message": "Fix scala stackoverflow", "committedDate": "2020-06-15T15:10:28Z", "type": "commit"}, {"oid": "432711260966276e438195e29bfef639897827ad", "url": "https://github.com/pmd/pmd/commit/432711260966276e438195e29bfef639897827ad", "message": "Merge branch '7.0.x' into generic-visitor2", "committedDate": "2020-06-15T15:14:00Z", "type": "commit"}, {"oid": "88b34feb22f2843ee83736881424f5e95c247c25", "url": "https://github.com/pmd/pmd/commit/88b34feb22f2843ee83736881424f5e95c247c25", "message": "Use wildcards for acceptVisitor", "committedDate": "2020-06-17T19:21:00Z", "type": "commit"}, {"oid": "847c4de68b4ce56cefee212a93066cd204ef6897", "url": "https://github.com/pmd/pmd/commit/847c4de68b4ce56cefee212a93066cd204ef6897", "message": "Merge branch '7.0.x' into generic-visitor2", "committedDate": "2020-06-25T12:30:46Z", "type": "commit"}, {"oid": "c6457ab9fc6e564c534aa556d7755a31c04593eb", "url": "https://github.com/pmd/pmd/commit/c6457ab9fc6e564c534aa556d7755a31c04593eb", "message": "Merge branch '7.0.x' into generic-visitor2", "committedDate": "2020-06-26T21:10:19Z", "type": "commit"}, {"oid": "623adce024b16d2426b6b52cb15ae5c95969ea54", "url": "https://github.com/pmd/pmd/commit/623adce024b16d2426b6b52cb15ae5c95969ea54", "message": "Checkstyle", "committedDate": "2020-06-27T11:24:09Z", "type": "commit"}, {"oid": "4bb98df37b947f301ad3b7baaf375e3e2cd87ac8", "url": "https://github.com/pmd/pmd/commit/4bb98df37b947f301ad3b7baaf375e3e2cd87ac8", "message": "Fix compil", "committedDate": "2020-06-27T12:22:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3MTY0Mw==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r447871643", "bodyText": "I'm not sure, I'm following you - the point of a major release is, that we can break compatibility, isn't it?\nIt would be nice, if we could backport the one or the other thing, but keeping deprecated stuff around in pmd7 for noone, that we should avoid IMHO.\nLet me think: so, the plan is, that if someone uses now PMD 6.x, when we release PMD 7.0.0, they can just switch to the new version and can compile, but with deprecation warnings, and with PMD 7.1.0, we'll remove the deprecated stuff? I don't see this happen....\nI could imagine, that we - after releasing 7.0.0 and getting feedback about compatibility problems - create a 7.0.1 and maybe also another 6.x release for easier migration (preparations/backports where possible).\nAlternatively, we could also document, what needs to be done, in the migration guide. I've seen now the place, where you used the new annotation. So we could use the new annotation as a marker/reminder for us, that this needs to be part of the migration guide.\nOne other possibility: If this works with the default impl in interfaces, then we could decide to release (after 7.0.0) a last PMD 6.x.x-for-7 version which updated requirements (e.g. minimum java8, allows us to backport some stuff). However, this doesn't avoid the fact, that - if users want to migrate to PMD 7, they need to touch their code...", "author": "adangel", "createdAt": "2020-06-30T17:50:25Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/annotation/DeprecatedUntil700.java", "diffHunk": "@@ -0,0 +1,14 @@\n+/*\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+package net.sourceforge.pmd.annotation;\n+\n+/**\n+ * Tags a deprecated member that should not be removed before PMD 7.0.0.\n+ * Such members were made deprecated on the PMD 7 development branch and\n+ * may be kept for backwards compatibility on the day of the PMD 7 release,\n+ * because the replacement API cannot be backported to PMD 6.\n+ */\n+public @interface DeprecatedUntil700 {", "originalCommit": "4bb98df37b947f301ad3b7baaf375e3e2cd87ac8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNjI1NA==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r448216254", "bodyText": "I was thinking, maybe we could ease the transition to PMD 7 by not removing everything right away. Eg maybe we could have a 7.0.0 \"pre-release\" with some deprecated API (and already a lot of removed/changed APIs), then the real release without those deprecated members. In my mind, keeping around a deprecated member is only appropriate when it's extremely easy (like not more than have a deprecated method that delegates to the new impl).\nSo we'd effectively need a distinction between\n\n\"deprecated since 6.0\": can be removed before releasing 7.0 without thinking twice about it\n\"deprecated since 7.0\": the replacement API doesn't exist in 6.x versions, and it's easy to keep around for compatibility\n\nThose visitors are not the best examples for the value-added of this distinction. Let's look for example, at the traversal methods on the Node interface. Since we have node streams, methods like Node::findChildrenOfType or Node::findDescendantsOfType should be removed I think. Node streams are better in that they're lazy and can be chained better.\nBut we can't deprecate those methods in a 6.x release, because there's no replacement API available yet. Most of them are very dependent on too. For the 7.0.0 release we have several options:\n\nRemove them before 7.0.0\nKeep them in 7.0.0 and deprecate them for removal in 8.0.0. This will make the transition simpler for users, but will give them a very long lifetime (which to us, translates to technical debt)\nKeep them in a 7.0.0 \"pre-release\" and remove them on 7.0.0. This makes the transition simpler for users, at minimal cost to us.\n\nKeeping them on the 7.0.x branch until the release comes at nearly zero cost, for now they're even necessary, since a lot of our codebase still uses them. So I don't really see why we shouldn't extend this \"grace period\" to other clients. Removing them in 7.0 without transition would make an upgrade to 7.0 harder than it needs to be, given that it's probably already going to be challenging.\nAm I making sense? What do you think of the idea of such a \"pre-release\"?\n\nAlternatively, we could also document, what needs to be done, in the migration guide. I've seen now the place, where you used the new annotation. So we could use the new annotation as a marker/reminder for us, that this needs to be part of the migration guide.\n\nIf we don't do a 7.0.0 \"pre-release\" like that, then yes, I think a migration guide, and using this annotation to help, would be a good compromise too. The point of the annotation to give us time, we don't have to commit to one outcome or another just yet.\n\nDeprecatedUntil700 hints at doing a pre-release. Regardless of whether we go that way or not, maybe DeprecatedSince700 would be a better name. It doesn't tell us to keep them until 7.0.0, just reminds us that they're deprecated, but that there's no transitional API on master. So it would remind us to\n\nif possible, add such a transitional API before wrapping up the 6.x release cycle, and remove them before 7.0.0\notherwise, mention it in a migration guide/ release notes of 7.0.x", "author": "oowekyala", "createdAt": "2020-07-01T08:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3MTY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0NDYzMw==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r453844633", "bodyText": "Thanks for the explanations, I think, I understand now the background. For now, we can of course leave these annotations in and decide later, what we really do.\nI'm not sure yet, whether the pre-release will really help the users... e.g. I could imagine, they update to 7.0.0-pre and they see: \"ok, it works, lot's of deprecations, but still compiles\", then they try out 7.0.0 and see \"hm... compiler errors - I don't have time to look at them, let's stay at 7.0.0-pre, since this still works\"... ok, it would be the problem of the users, if they don't do the full migration. Or in other words: compile errors can't be ignored, deprecations can't.\nIn general, I would keep the deprecations only in the pre-release and try to avoid to extend the lifespan of these deprecations - so that we really delete the old stuff with the final version of 7.0.0.", "author": "adangel", "createdAt": "2020-07-13T18:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3MTY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkyNjM4Ng==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r456926386", "bodyText": "As we discussed, we keep the new annotation @DeprecatedUntil700 and decide later, whether migration doc is enough or whether we can easily create a compatibility-helping pre-release. There are also other candidates, where this could be useful, e.g. in the Node / AST API (Node vs. NodeStream).", "author": "adangel", "createdAt": "2020-07-19T16:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3MTY0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3NjYyOQ==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r447876629", "bodyText": "Does this dispatch work as a default implementation? If not, we shouldn't provide a default impl, but just document, how the implementation in the specific node classes must look like", "author": "adangel", "createdAt": "2020-06-30T17:58:36Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/lang/ast/Node.java", "diffHunk": "@@ -289,6 +283,27 @@ default boolean hasDescendantMatchingXPath(String xpathString) {\n      */\n     int getIndexInParent();\n \n+\n+    /**\n+     * Calls back the visitor's visit method corresponding to the runtime\n+     * type of this Node. This should usually be preferred to calling\n+     * a {@code visit} method directly (usually the only calls to those\n+     * are in the implementations of this {@code acceptVisitor} method).\n+     *\n+     * @param <R>     Return type of the visitor\n+     * @param <P>     Parameter type of the visitor\n+     * @param visitor Visitor to dispatch\n+     * @param data    Parameter to the visit\n+     *\n+     * @return What the visitor returned\n+     */\n+    // TODO remove the default implementation, convert all visitors to be generic\n+    default <R, P> R acceptVisitor(AstVisitor<? super P, ? extends R> visitor, P data) {\n+        // override me\n+        return visitor.visitNode(this, data);", "originalCommit": "4bb98df37b947f301ad3b7baaf375e3e2cd87ac8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNzQxNw==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r448217417", "bodyText": "No, it should be abstract, but other modules need to be ported before. Documentation is already present on AstVisitor, but maybe it should be present here too", "author": "oowekyala", "createdAt": "2020-07-01T08:53:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3NjYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4Mjk4Mw==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r447882983", "bodyText": "Should we allow this or rather prevent this? trying to visit an AST with an incompatible visitor... I would argue to restrict the feature set at the beginning rather than allowing too much....", "author": "adangel", "createdAt": "2020-06-30T18:09:36Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/ast/AbstractJavaNode.java", "diffHunk": "@@ -32,6 +33,18 @@ public Scope getScope() {\n         return scope;\n     }\n \n+    @Override\n+    public final <R, P> R acceptVisitor(AstVisitor<? super P, ? extends R> visitor, P data) {\n+        if (visitor instanceof JavaVisitor) {\n+            return this.acceptVisitor((JavaVisitor<? super P, ? extends R>) visitor, data);\n+        }\n+        return visitor.visitNode(this, data);", "originalCommit": "4bb98df37b947f301ad3b7baaf375e3e2cd87ac8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxOTQ2NA==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r448219464", "bodyText": "I think yes, we can restrict it for the time being. Maybe in the future it will be clearer what to do in this case", "author": "oowekyala", "createdAt": "2020-07-01T08:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4Mjk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4OTE4MQ==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r447889181", "bodyText": "Is that IDEA specific?", "author": "adangel", "createdAt": "2020-06-30T18:19:54Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/ast/JavaVisitorBase.java", "diffHunk": "@@ -0,0 +1,375 @@\n+/**\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+package net.sourceforge.pmd.lang.java.ast;\n+\n+import net.sourceforge.pmd.lang.ast.AstVisitorBase;\n+\n+/**\n+ * Base implementation of {@link JavaVisitor}. This adds delegation logic\n+ * which the interface doesn't have.\n+ *\n+ * <p>Contrary to the old visitor, which used Object as both parameter and\n+ * return type, this visitor uses separate type parameters for those. This\n+ * means you can't just return the parameter, unless your visitor has equal\n+ * parameter and return type. This type signature subsumes many possible\n+ * signatures. The old one is {@code <Object, Object>}, still implemented\n+ * by {@link JavaParserVisitor} for backwards compatibility. If you don't\n+ * want to return a value, or don't want a parameter, use {@link Void}.\n+ *\n+ * <p>Since 7.0.0 we use default methods on the interface, which removes\n+ * code duplication. However it's still recommended to extend a base class,\n+ * for forward compatibility.\n+ */\n+public class JavaVisitorBase<P, R> extends AstVisitorBase<P, R> implements JavaVisitor<P, R> {\n+\n+    // todo on java-grammar: uncomment\n+\n+\n+    // <editor-fold defaultstate=\"collapsed\" desc=\"Methods/constructors\">", "originalCommit": "4bb98df37b947f301ad3b7baaf375e3e2cd87ac8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIyMTUwMA==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r448221500", "bodyText": "This works in Netbeans and IntelliJ", "author": "oowekyala", "createdAt": "2020-07-01T09:00:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4OTE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIyMTc4NQ==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r448221785", "bodyText": "Would you rather I remove it?", "author": "oowekyala", "createdAt": "2020-07-01T09:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4OTE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkyNjUxOQ==", "url": "https://github.com/pmd/pmd/pull/2589#discussion_r456926519", "bodyText": "Needing to fold could be a sign of the file being too big and indicate that we maybe should split it. But that's just to keep in mind and we'll need to revisit this later.", "author": "adangel", "createdAt": "2020-07-19T16:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4OTE4MQ=="}], "type": "inlineReview"}, {"oid": "94595fe185e4a8a36ec616cc5f0f40d4a69b9ee1", "url": "https://github.com/pmd/pmd/commit/94595fe185e4a8a36ec616cc5f0f40d4a69b9ee1", "message": "Merge branch '7.0.x' into generic-visitor2", "committedDate": "2020-07-01T08:09:26Z", "type": "commit"}, {"oid": "27ea6a92e538c44c2e8a6231fe5b1277d0217df5", "url": "https://github.com/pmd/pmd/commit/27ea6a92e538c44c2e8a6231fe5b1277d0217df5", "message": "Rename ant property", "committedDate": "2020-07-01T09:06:48Z", "type": "commit"}, {"oid": "feeb1f0a878f39253d0c02e0043e235c310ce1a9", "url": "https://github.com/pmd/pmd/commit/feeb1f0a878f39253d0c02e0043e235c310ce1a9", "message": "Fix swift module", "committedDate": "2020-07-01T09:09:12Z", "type": "commit"}, {"oid": "25beb215fcf4b7af81ea4508e4d932796f1ae4ce", "url": "https://github.com/pmd/pmd/commit/25beb215fcf4b7af81ea4508e4d932796f1ae4ce", "message": "Throw on incompatible visitor type", "committedDate": "2020-07-01T09:16:03Z", "type": "commit"}, {"oid": "a7d6e52c540710c30674de668f26d9542c59b061", "url": "https://github.com/pmd/pmd/commit/a7d6e52c540710c30674de668f26d9542c59b061", "message": "Fix javadoc warning", "committedDate": "2020-07-01T09:18:17Z", "type": "commit"}]}