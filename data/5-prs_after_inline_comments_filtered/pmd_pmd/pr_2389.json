{"pr_number": 2389, "pr_title": "[java] Implement AST disambiguation", "pr_createdAt": "2020-03-29T12:37:35Z", "pr_url": "https://github.com/pmd/pmd/pull/2389", "timeline": [{"oid": "490f57ce62363dbdf9a2ac58f920ff36ae249056", "url": "https://github.com/pmd/pmd/commit/490f57ce62363dbdf9a2ac58f920ff36ae249056", "message": "Revert \"REVERT ME Remove disambig stuff\"\n\nThis reverts commit bda0f886144d4c12d41d55fbf8b114523874e4a8.", "committedDate": "2020-03-29T11:31:38Z", "type": "commit"}, {"oid": "653efd09bf7ef421ca1b9290800215dd3703f835", "url": "https://github.com/pmd/pmd/commit/653efd09bf7ef421ca1b9290800215dd3703f835", "message": "Fix tests", "committedDate": "2020-03-29T11:31:38Z", "type": "commit"}, {"oid": "ff03e3e565915c54cd1cff7020bcb3aff6d23983", "url": "https://github.com/pmd/pmd/commit/ff03e3e565915c54cd1cff7020bcb3aff6d23983", "message": "Checkout updated version with early disambig, etc", "committedDate": "2020-03-29T11:31:38Z", "type": "commit"}, {"oid": "fae6a68664d71970395c8f010c70f1918a4bff13", "url": "https://github.com/pmd/pmd/commit/fae6a68664d71970395c8f010c70f1918a4bff13", "message": "Test superclass", "committedDate": "2020-03-29T11:31:38Z", "type": "commit"}, {"oid": "618f51c9a48bb6073b398c2623f2e2f10088a82c", "url": "https://github.com/pmd/pmd/commit/618f51c9a48bb6073b398c2623f2e2f10088a82c", "message": "Cleanup", "committedDate": "2020-03-29T12:06:03Z", "type": "commit"}, {"oid": "18af64a5c34b1c2bdfce0b40d68b14258320ab37", "url": "https://github.com/pmd/pmd/commit/18af64a5c34b1c2bdfce0b40d68b14258320ab37", "message": "Merge branch 'java-grammar' into sym-disambig2", "committedDate": "2020-04-02T18:12:43Z", "type": "commit"}, {"oid": "4d1e8d06713a196f85fbeb8654a690e59d83c312", "url": "https://github.com/pmd/pmd/commit/4d1e8d06713a196f85fbeb8654a690e59d83c312", "message": "Fix class cast with records", "committedDate": "2020-04-02T18:25:47Z", "type": "commit"}, {"oid": "cd5798650ac0dc5219a9bee5f805e48d2145805b", "url": "https://github.com/pmd/pmd/commit/cd5798650ac0dc5219a9bee5f805e48d2145805b", "message": "Merge branch 'java-grammar' into sym-disambig2", "committedDate": "2020-04-02T18:59:52Z", "type": "commit"}, {"oid": "179fddc5027dd1f57648bbc665a76b0378a9fbbd", "url": "https://github.com/pmd/pmd/commit/179fddc5027dd1f57648bbc665a76b0378a9fbbd", "message": "Merge branch 'java-grammar' into sym-disambig2", "committedDate": "2020-04-02T21:49:05Z", "type": "commit"}, {"oid": "eca2ee54fe999ff54527499265a6ea389a365936", "url": "https://github.com/pmd/pmd/commit/eca2ee54fe999ff54527499265a6ea389a365936", "message": "Merge branch 'java-grammar' into sym-disambig2", "committedDate": "2020-04-02T22:00:43Z", "type": "commit"}, {"oid": "e92093e1fbe9154a96246247fe9b598f4126ba32", "url": "https://github.com/pmd/pmd/commit/e92093e1fbe9154a96246247fe9b598f4126ba32", "message": "Merge branch 'java-grammar' into sym-disambig2", "committedDate": "2020-04-02T22:21:16Z", "type": "commit"}, {"oid": "a41283b7cd2d69872d9d41ffed188bb58e057245", "url": "https://github.com/pmd/pmd/commit/a41283b7cd2d69872d9d41ffed188bb58e057245", "message": "Fix compil", "committedDate": "2020-04-04T23:09:26Z", "type": "commit"}, {"oid": "403b1ab7c0d3b7916052c393372937bfa7698a30", "url": "https://github.com/pmd/pmd/commit/403b1ab7c0d3b7916052c393372937bfa7698a30", "message": "Merge branch 'java-grammar' into sym-disambig2", "committedDate": "2020-04-04T23:12:30Z", "type": "commit"}, {"oid": "643555bb1d91b99554f84923e41f008bd164621a", "url": "https://github.com/pmd/pmd/commit/643555bb1d91b99554f84923e41f008bd164621a", "message": "Checkout normal collectionUtil", "committedDate": "2020-04-04T23:19:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwMDA4OQ==", "url": "https://github.com/pmd/pmd/pull/2389#discussion_r404300089", "bodyText": "That's in the public package lang.java.ast, but this is a implementation, isn't it? Should it be rather in a internal package?", "author": "adangel", "createdAt": "2020-04-06T18:27:25Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/ast/AstDisambiguationPass.java", "diffHunk": "@@ -0,0 +1,469 @@\n+/*\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+\n+package net.sourceforge.pmd.lang.java.ast;\n+\n+import static net.sourceforge.pmd.lang.java.symbols.table.internal.SemanticChecksLogger.CANNOT_RESOLVE_AMBIGUOUS_NAME;\n+import static net.sourceforge.pmd.lang.java.symbols.table.internal.SemanticChecksLogger.CANNOT_RESOLVE_MEMBER;\n+\n+import java.util.Iterator;\n+\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+import net.sourceforge.pmd.lang.ast.NodeStream;\n+import net.sourceforge.pmd.lang.ast.impl.javacc.JavaccToken;\n+import net.sourceforge.pmd.lang.java.internal.JavaAstProcessor;\n+import net.sourceforge.pmd.lang.java.symbols.JClassSymbol;\n+import net.sourceforge.pmd.lang.java.symbols.JFieldSymbol;\n+import net.sourceforge.pmd.lang.java.symbols.JTypeDeclSymbol;\n+import net.sourceforge.pmd.lang.java.symbols.JVariableSymbol;\n+import net.sourceforge.pmd.lang.java.symbols.table.JSymbolTable;\n+import net.sourceforge.pmd.lang.java.symbols.table.ResolveResult;\n+import net.sourceforge.pmd.lang.java.symbols.table.internal.SemanticChecksLogger;\n+\n+/**\n+ * This implements name disambiguation following <a href=\"https://docs.oracle.com/javase/specs/jls/se8/html/jls-6.html#jls-6.5.2\">JLS\u00a76.5.2</a>.\n+ * (see also <a href=\"https://docs.oracle.com/javase/specs/jls/se13/html/jls-6.html#jls-6.4.2\">JLS\u00a76.4.2 - Obscuring</a>)\n+ *\n+ * <p>Currently disambiguation of package vs type name is fully implemented,\n+ * with the following limitations: TODO\n+ * - field accesses are not checked to be legal (and their symbol is not\n+ * resolved).\n+ * - inherited members are not considered. Same thing happens in the current\n+ * symbol table. Since that is so, visibility/accessibility is not handled either.\n+ * See bottom of file for some test cases.\n+ *\n+ * This is because we don't have full access to types yet. This is the next\n+ * step.\n+ */\n+public final class AstDisambiguationPass {", "originalCommit": "643555bb1d91b99554f84923e41f008bd164621a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5Mzc1Mw==", "url": "https://github.com/pmd/pmd/pull/2389#discussion_r404793753", "bodyText": "Hmm that's right. Well it uses a lot of package-private API so probably the best way is to make it package-private and add a hook to it in InternalApiBridge", "author": "oowekyala", "createdAt": "2020-04-07T13:07:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwMDA4OQ=="}], "type": "inlineReview"}, {"oid": "396567636fa1dbef2f7766f8c9ef57b4c095773e", "url": "https://github.com/pmd/pmd/commit/396567636fa1dbef2f7766f8c9ef57b4c095773e", "message": "Hide disambiguation fa\u00e7ade", "committedDate": "2020-04-07T13:30:30Z", "type": "commit"}, {"oid": "eb4cdea126d9d8f3374c656c8cf44ec3f9bba38c", "url": "https://github.com/pmd/pmd/commit/eb4cdea126d9d8f3374c656c8cf44ec3f9bba38c", "message": "Merge branch 'java-grammar' into sym-disambig2", "committedDate": "2020-04-11T13:18:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM5MjQ2NQ==", "url": "https://github.com/pmd/pmd/pull/2389#discussion_r407392465", "bodyText": "Maybe these two methods (bench(...)) can stay private again?\nUpdate: turns out, no: It is called via SymbolTableHelper::earlyDisambig -> InternalApiBridge::disambig -> AstDisambiguationPass::disambig\nMaybe something to improve later...", "author": "adangel", "createdAt": "2020-04-13T09:14:03Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/internal/JavaAstProcessor.java", "diffHunk": "@@ -162,13 +165,13 @@ public static JavaAstProcessor create(ClassLoader classLoader,\n         );\n     }\n \n-    private static void bench(String label, Runnable runnable) {\n+    public static void bench(String label, Runnable runnable) {", "originalCommit": "eb4cdea126d9d8f3374c656c8cf44ec3f9bba38c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM5MzQyMw==", "url": "https://github.com/pmd/pmd/pull/2389#discussion_r407393423", "bodyText": "Mabye name this getToplevel()? nest root somehow sounds a bit strange (probably because nesting is the directing down and root is the direction up the tree...)", "author": "adangel", "createdAt": "2020-04-13T09:16:21Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/symbols/JClassSymbol.java", "diffHunk": "@@ -221,6 +181,20 @@ default boolean isClass() {\n     }\n \n \n+    /**\n+     * Returns the toplevel class containing this class. If this is a\n+     * toplevel class, returns this.\n+     */\n+    @NonNull\n+    default JClassSymbol getNestRoot() {", "originalCommit": "eb4cdea126d9d8f3374c656c8cf44ec3f9bba38c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}