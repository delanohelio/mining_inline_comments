{"pr_number": 2635, "pr_title": "[core] New RuleSet API and deprecations for PMD's entry point APIs", "pr_createdAt": "2020-07-07T14:45:45Z", "pr_url": "https://github.com/pmd/pmd/pull/2635", "timeline": [{"oid": "412d39f51384468810e08ffe11ac218138fb2395", "url": "https://github.com/pmd/pmd/commit/412d39f51384468810e08ffe11ac218138fb2395", "message": "Replace createFactory methods with a builder\n\nDeprecate compatibility filter\n\nDeprecate methods in RulesetsFactUtils", "committedDate": "2020-10-26T18:26:47Z", "type": "commit"}, {"oid": "ac864aa5294a9caa72827fd8400c8db1337c3897", "url": "https://github.com/pmd/pmd/commit/ac864aa5294a9caa72827fd8400c8db1337c3897", "message": "Rename", "committedDate": "2020-10-26T18:29:19Z", "type": "commit"}, {"oid": "6642f5d0381b596b63290d22b458608b5a6a8921", "url": "https://github.com/pmd/pmd/commit/6642f5d0381b596b63290d22b458608b5a6a8921", "message": "Isolate single rule pattern", "committedDate": "2020-10-26T18:31:48Z", "type": "commit"}, {"oid": "89586096292a162fa426d473ebc121ffe64fef9d", "url": "https://github.com/pmd/pmd/commit/89586096292a162fa426d473ebc121ffe64fef9d", "message": "Deprecate other APIs", "committedDate": "2020-10-26T19:00:19Z", "type": "commit"}, {"oid": "efb133c74e9d3c60ed4ff012da0000c8d43aa152", "url": "https://github.com/pmd/pmd/commit/efb133c74e9d3c60ed4ff012da0000c8d43aa152", "message": "Cleanup API around processors", "committedDate": "2020-10-26T19:24:02Z", "type": "commit"}, {"oid": "8295dad86caa23a7718a8ee863c8cfd8f9e8247e", "url": "https://github.com/pmd/pmd/commit/8295dad86caa23a7718a8ee863c8cfd8f9e8247e", "message": "Deprecate some methods of PMD", "committedDate": "2020-10-26T19:27:38Z", "type": "commit"}, {"oid": "125b0200ed189d8ef8f74e33e45b2ff65e69884d", "url": "https://github.com/pmd/pmd/commit/125b0200ed189d8ef8f74e33e45b2ff65e69884d", "message": "Deprecate configuration objects", "committedDate": "2020-10-26T19:35:02Z", "type": "commit"}, {"oid": "125b0200ed189d8ef8f74e33e45b2ff65e69884d", "url": "https://github.com/pmd/pmd/commit/125b0200ed189d8ef8f74e33e45b2ff65e69884d", "message": "Deprecate configuration objects", "committedDate": "2020-10-26T19:35:02Z", "type": "forcePushed"}, {"oid": "7d66d7cbca6f88f80d4468f412f93950ca121014", "url": "https://github.com/pmd/pmd/commit/7d66d7cbca6f88f80d4468f412f93950ca121014", "message": "Doc", "committedDate": "2020-10-26T20:00:39Z", "type": "commit"}, {"oid": "8f8af7780e092f3eb371e9bf34e15168bc139d4a", "url": "https://github.com/pmd/pmd/commit/8f8af7780e092f3eb371e9bf34e15168bc139d4a", "message": "Rename stuff", "committedDate": "2020-10-26T20:10:58Z", "type": "commit"}, {"oid": "9c56fb629a5330858c36c561bf9b6bd1553db051", "url": "https://github.com/pmd/pmd/commit/9c56fb629a5330858c36c561bf9b6bd1553db051", "message": "Fix bug", "committedDate": "2020-10-26T20:21:29Z", "type": "commit"}, {"oid": "38a0934feef8900fafe04c19ef7437ed4106832b", "url": "https://github.com/pmd/pmd/commit/38a0934feef8900fafe04c19ef7437ed4106832b", "message": "PMD warnings", "committedDate": "2020-10-26T20:33:33Z", "type": "commit"}, {"oid": "050ec4464e56405946674dad2f979cb6eeb21f0a", "url": "https://github.com/pmd/pmd/commit/050ec4464e56405946674dad2f979cb6eeb21f0a", "message": "Stop parsing comma-separated paths by default", "committedDate": "2020-10-26T22:42:37Z", "type": "commit"}, {"oid": "cc7bb35e72ed6fa016e49dd663b0170ba5951537", "url": "https://github.com/pmd/pmd/commit/cc7bb35e72ed6fa016e49dd663b0170ba5951537", "message": "Checkstyle", "committedDate": "2020-10-26T23:30:31Z", "type": "commit"}, {"oid": "36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "url": "https://github.com/pmd/pmd/commit/36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "message": "Fix broken rule reporting", "committedDate": "2020-10-27T08:15:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIwODg1Nw==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515208857", "bodyText": "Should we mark this as experimental? Or would we just deprecate this as well, if we have a better PMD programmatic API?", "author": "adangel", "createdAt": "2020-10-30T16:05:24Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/PMD.java", "diffHunk": "@@ -297,19 +319,58 @@ public static RuleContext newRuleContext(String sourceCodeFilename, File sourceC\n      *            RuleContext\n      * @param renderers\n      *            List of {@link Renderer}s\n+     *\n+     * @deprecated Use {@link #processFiles(PMDConfiguration, List, Collection, Report, List)}\n+     * so as not to depend on {@link RuleSetFactory}. Note that this sorts the list of data sources in-place,\n+     * which won't be fixed\n      */\n+    @Deprecated\n     public static void processFiles(final PMDConfiguration configuration, final RuleSetFactory ruleSetFactory,\n-            final List<DataSource> files, final RuleContext ctx, final List<Renderer> renderers) {\n+                                    final List<DataSource> files, final RuleContext ctx, final List<Renderer> renderers) {\n+        // Note that this duplicates the other routine, because the old behavior was\n+        // that we parsed rulesets (a second time) inside the processor execution.\n+        // To not mess up error handling, we keep this behavior.\n+\n         encourageToUseIncrementalAnalysis(configuration);\n         sortFiles(configuration, files);\n         // Make sure the cache is listening for analysis results\n         ctx.getReport().addListener(configuration.getAnalysisCache());\n \n-        final RuleSetFactory silentFactory = new RuleSetFactory(ruleSetFactory, false);\n+        final RuleSetFactory silentFactory = ruleSetFactory.toParser().warnDeprecated(false).toFactory();\n         newFileProcessor(configuration).processFiles(silentFactory, files, ctx, renderers);\n         configuration.getAnalysisCache().persist();\n     }\n \n+    /**\n+     * Run PMD using the given configuration. This replaces the other overload.\n+     *\n+     * @param configuration Configuration for the run. Note that the files,\n+     *                      and rulesets, are ignored, as they are supplied\n+     *                      as parameters\n+     * @param rulesets      Parsed rulesets\n+     * @param files         Files to process\n+     * @param report        Report in which violations are accumulated\n+     * @param renderers     Renderers that render the report\n+     *\n+     * @throws RuntimeException If processing fails\n+     */\n+    public static void processFiles(final PMDConfiguration configuration,", "originalCommit": "36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI4NTgxNA==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515285814", "bodyText": "It may be possible to preserve compatibility with this signature in PMD 7. But also I think we should ideally keep a published entry point, that remains non-deprecated in the 6.x release cycle", "author": "oowekyala", "createdAt": "2020-10-30T18:00:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIwODg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIxMjU0Mw==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515212543", "bodyText": "I'm not sure we should deprecate this.\nI kinda like the idea, that we would provide all exceptions (if we throw any) with a common super type.\nOf course, the exception should be not a checked exception like this one, but rather a runtime exception.\nWe maybe need additionally an internal exception that we would convert into such a public API exception.\nBut that's out of scope of this PR - that's the question of exception handling.", "author": "adangel", "createdAt": "2020-10-30T16:11:10Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/PMDException.java", "diffHunk": "@@ -13,6 +13,7 @@\n  * @version $Revision$, $Date$\n  * @since August 30, 2002\n  */\n+@Deprecated", "originalCommit": "36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI4NDMwMg==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515284302", "bodyText": "I think in this PR all APIs that throw PMDException are being deprecated (I did not check thoroughly), which is why I went ahead. I think we can do better with exceptions, but I'm not sure PMDException as it stands does anything useful.\nBut yes it would be nice to have a common supertype in pmd 7.", "author": "oowekyala", "createdAt": "2020-10-30T17:57:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIxMjU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIxODY3Mw==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515218673", "bodyText": "Isn't that used by pmd-doc? And I think, it's used by eclipse-pmd-plugin as well. We probably need to think, whether we can really remove it or whether we need to provide an alternative.\nThe method sounds more like some utility/helper method, to get all rules of all languages on the classpath.", "author": "adangel", "createdAt": "2020-10-30T16:21:32Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/RuleSetFactory.java", "diffHunk": "@@ -138,7 +144,10 @@ public RuleSetFactory(final RuleSetFactory factory, final boolean warnDeprecated\n      * @return An Iterator of RuleSet objects.\n      *\n      * @throws RuleSetNotFoundException if the ruleset file could not be found\n+     *\n+     * @deprecated This is apparently only used in code deprecated for removal", "originalCommit": "36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI4NjcwMg==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515286702", "bodyText": "No you're right, this is a mistake. I think this may be useful, but it should not be in RulesetFactory. Maybe we should have a static method in RulesetLoader?", "author": "oowekyala", "createdAt": "2020-10-30T18:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIxODY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyMDk4MQ==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515220981", "bodyText": "Should we collect ruleset related APIs in a subpackage net.sourceforge.pmd.ruleset?", "author": "adangel", "createdAt": "2020-10-30T16:25:25Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/RuleSetParser.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+package net.sourceforge.pmd;", "originalCommit": "36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3OTMzNQ==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515279335", "bodyText": "I wonder if nspmd.lang.rule is more appropriate. There wouldn't be much public api in a separate ruleset package, I think, basically RuleSet and RuleSetLoader. Maybe a Category enum too.", "author": "oowekyala", "createdAt": "2020-10-30T17:52:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyMDk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyMzM0OA==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515223348", "bodyText": "private?", "author": "adangel", "createdAt": "2020-10-30T16:29:15Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/RuleSetParser.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+package net.sourceforge.pmd;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+import net.sourceforge.pmd.util.ResourceLoader;\n+\n+/**\n+ * Configurable ruleset parser. Note that this replaces the API of {@link RulesetsFactoryUtils}\n+ * and {@link RuleSetFactory}. This can be configured using a fluent\n+ * API, see eg {@link #warnDeprecated(boolean)}. To create a list of\n+ * rulesets, use {@link #parseFromResource(String)}.\n+ */\n+public final class RuleSetParser {\n+\n+    ResourceLoader resourceLoader = new ResourceLoader(RuleSetParser.class.getClassLoader());", "originalCommit": "36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNTc0NQ==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515225745", "bodyText": "Hm... part of this class is a builder not a parser....\nMaybe we can start with phrasing what this class does: Loads rulesets from files (or other resources). The way, the rulesets are loaded, can be configured - hence configurable.\nNot sure, if this is more a RuleSetBuilder, RuleSetLoader or RuleSetParser (well in PMD6 the impl of the parser is actually in RuleSetFactory, but that's only for now).\nSince I came across RuleSetWriter... maybe this is a RuleSetReader? (Although this would make one think as a java.io.Reader, which works a bit different)", "author": "adangel", "createdAt": "2020-10-30T16:33:13Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/RuleSetParser.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+package net.sourceforge.pmd;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+import net.sourceforge.pmd.util.ResourceLoader;\n+\n+/**\n+ * Configurable ruleset parser. Note that this replaces the API of {@link RulesetsFactoryUtils}\n+ * and {@link RuleSetFactory}. This can be configured using a fluent\n+ * API, see eg {@link #warnDeprecated(boolean)}. To create a list of\n+ * rulesets, use {@link #parseFromResource(String)}.\n+ */\n+public final class RuleSetParser {", "originalCommit": "36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI4ODU4OA==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515288588", "bodyText": "RulesetLoader sounds good! I would avoid RulesetReader, sounds like something that uses a ruleset, not something that creates it. I think we could rename RulesetFactory to RulesetParser eventually", "author": "oowekyala", "createdAt": "2020-10-30T18:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNTc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNjA1OA==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515226058", "bodyText": "maybe \"loadFromResource(...)\"?", "author": "adangel", "createdAt": "2020-10-30T16:33:45Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/RuleSetParser.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+package net.sourceforge.pmd;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+import net.sourceforge.pmd.util.ResourceLoader;\n+\n+/**\n+ * Configurable ruleset parser. Note that this replaces the API of {@link RulesetsFactoryUtils}\n+ * and {@link RuleSetFactory}. This can be configured using a fluent\n+ * API, see eg {@link #warnDeprecated(boolean)}. To create a list of\n+ * rulesets, use {@link #parseFromResource(String)}.\n+ */\n+public final class RuleSetParser {\n+\n+    ResourceLoader resourceLoader = new ResourceLoader(RuleSetParser.class.getClassLoader());\n+    RulePriority minimumPriority = RulePriority.LOW;\n+    boolean warnDeprecated = true;\n+    boolean enableCompatibility = true;\n+    boolean includeDeprecatedRuleReferences = false;\n+\n+    /**\n+     * Specify that the given classloader should be used to resolve\n+     * paths to external ruleset references. The default uses PMD's\n+     * own classpath.\n+     */\n+    public RuleSetParser loadResourcesWith(ClassLoader classLoader) {\n+        this.resourceLoader = new ResourceLoader(classLoader);\n+        return this;\n+    }\n+\n+    // internal\n+    RuleSetParser loadResourcesWith(ResourceLoader loader) {\n+        this.resourceLoader = loader;\n+        return this;\n+    }\n+\n+    /**\n+     * Filter loaded rules to only those that match or are above\n+     * the given priority. The default is {@link RulePriority#LOW},\n+     * ie, no filtering occurs.\n+     * @return This instance, modified\n+     */\n+    public RuleSetParser filterAbovePriority(RulePriority minimumPriority) {\n+        this.minimumPriority = minimumPriority;\n+        return this;\n+    }\n+\n+    /**\n+     * Log a warning when referencing a deprecated rule.\n+     * This is enabled by default.\n+     * @return This instance, modified\n+     */\n+    public RuleSetParser warnDeprecated(boolean warn) {\n+        this.warnDeprecated = warn;\n+        return this;\n+    }\n+\n+    /**\n+     * Enable translating old rule references to newer ones, if they have\n+     * been moved or renamed. This is enabled by default, if disabled,\n+     * unresolved references will not be translated and will produce an\n+     * error.\n+     * @return This instance, modified\n+     */\n+    public RuleSetParser enableCompatibility(boolean enable) {\n+        this.enableCompatibility = enable;\n+        return this;\n+    }\n+\n+    /**\n+     * Follow deprecated rule references. By default this is off,\n+     * and those references will be ignored (with a warning depending\n+     * on {@link #enableCompatibility(boolean)}).\n+     *\n+     * @return This instance, modified\n+     */\n+    public RuleSetParser includeDeprecatedRuleReferences(boolean enable) {\n+        this.includeDeprecatedRuleReferences = enable;\n+        return this;\n+    }\n+\n+    /**\n+     * Create a new rule set factory, if you have to (that class is deprecated).\n+     * That factory will use the configuration that was set using the setters of this.\n+     */\n+    @Deprecated\n+    public RuleSetFactory toFactory() {\n+        return new RuleSetFactory(this);\n+    }\n+\n+\n+    /**\n+     * Parses and returns a ruleset from its location. The location may\n+     * be a file system path, or a resource path (see {@link #loadResourcesWith(ClassLoader)}).\n+     *\n+     * <p>This replaces {@link RuleSetFactory#createRuleSet(String)},\n+     * but does not split commas.\n+     *\n+     * @param rulesetPath A reference to a single ruleset\n+     *\n+     * @throws RuleSetNotFoundException If the path does not correspond to a resource\n+     */\n+    public RuleSet parseFromResource(String rulesetPath) throws RuleSetNotFoundException {", "originalCommit": "36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzMzg5MA==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515233890", "bodyText": "I think, we don't need the try-finally here - the files are opened/closed in the other processFiles method", "author": "adangel", "createdAt": "2020-10-30T16:46:33Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/processor/AbstractPMDProcessor.java", "diffHunk": "@@ -108,25 +115,44 @@ protected RuleSets createRuleSets(RuleSetFactory factory, Report report) {\n     @SuppressWarnings(\"PMD.CloseResource\")\n     // the data sources must only be closed after the threads are finished\n     // this is done manually without a try-with-resources\n+    @Deprecated\n     public void processFiles(RuleSetFactory ruleSetFactory, List<DataSource> files, RuleContext ctx,\n-            List<Renderer> renderers) {\n+                             List<Renderer> renderers) {\n         try {\n             final RuleSets rs = createRuleSets(ruleSetFactory, ctx.getReport());\n-            configuration.getAnalysisCache().checkValidity(rs, configuration.getClassLoader());\n+            processFiles(rs, files, ctx, renderers);\n+        } finally {", "originalCommit": "36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNTc0NA==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515235744", "bodyText": "That's an interesting information. At some point, we should define that with a specific exception.\nBut: do we at this position actually know, what file we were analyzing? This is the outer catch, so ctx is maybe the last one. And in case of multi threading, the ctx here is not used at all.... or do I miss something here?\nRuntime Exception are already handled in PmdRunnable and added there as errors to the report... So, I'm not sure, which RuntimeExceptions we would get here...", "author": "adangel", "createdAt": "2020-10-30T16:49:24Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/processor/AbstractPMDProcessor.java", "diffHunk": "@@ -108,25 +115,44 @@ protected RuleSets createRuleSets(RuleSetFactory factory, Report report) {\n     @SuppressWarnings(\"PMD.CloseResource\")\n     // the data sources must only be closed after the threads are finished\n     // this is done manually without a try-with-resources\n+    @Deprecated\n     public void processFiles(RuleSetFactory ruleSetFactory, List<DataSource> files, RuleContext ctx,\n-            List<Renderer> renderers) {\n+                             List<Renderer> renderers) {\n         try {\n             final RuleSets rs = createRuleSets(ruleSetFactory, ctx.getReport());\n-            configuration.getAnalysisCache().checkValidity(rs, configuration.getClassLoader());\n+            processFiles(rs, files, ctx, renderers);\n+        } finally {\n+            // in case we analyzed files within Zip Files/Jars, we need to close them after\n+            // the analysis is finished\n+            for (DataSource dataSource : files) {\n+                IOUtils.closeQuietly(dataSource);\n+            }\n+        }\n+    }\n+\n+    @SuppressWarnings(\"PMD.CloseResource\")\n+    // the data sources must only be closed after the threads are finished\n+    // this is done manually without a try-with-resources\n+    public void processFiles(RuleSets rulesets, List<DataSource> files, RuleContext ctx, List<Renderer> renderers) {\n+        try {\n+            reportBrokenRules(ctx.getReport(), rulesets);\n+            configuration.getAnalysisCache().checkValidity(rulesets, configuration.getClassLoader());\n             final SourceCodeProcessor processor = new SourceCodeProcessor(configuration);\n \n             for (final DataSource dataSource : files) {\n                 // this is the real, canonical and absolute filename (not shortened)\n                 String realFileName = dataSource.getNiceFileName(false, null);\n \n-                runAnalysis(new PmdRunnable(dataSource, realFileName, renderers, ctx, rs, processor));\n+                runAnalysis(new PmdRunnable(dataSource, realFileName, renderers, ctx, rulesets, processor));\n             }\n \n             // render base report first - general errors\n             renderReports(renderers, ctx.getReport());\n \n             // then add analysis results per file\n             collectReports(renderers);\n+        } catch (RuntimeException e) {\n+            throw new ContextedRuntimeException(e).addContextValue(\"filename\", String.valueOf(ctx.getSourceCodeFile()));", "originalCommit": "36e55bc2c1d4ea0a41d39fed0b9178d876b3447f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI4OTk1Mg==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515289952", "bodyText": "I introduced that as a workaround for PMDTask, because the new entry point hides its RuleContext. Before, PMDTask was querying the RuleContext when there was an exception. So, I don't know if this makes sense, but it should match the current behavior. We can do better in PMD7. I'd like to introduce FileAnalysisException, which is a supertype for eg TokenMgrError and ParseException, and has a file name.", "author": "oowekyala", "createdAt": "2020-10-30T18:08:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNTc0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNDU3MQ==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r515514571", "bodyText": "Hm... Maybe PMDTask was/is already wrong?\nFileAnalysisException sounds good.", "author": "adangel", "createdAt": "2020-10-31T16:39:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNTc0NA=="}], "type": "inlineReview"}, {"oid": "1ff1e07c4dd10d61141a54138f932ab129b495f7", "url": "https://github.com/pmd/pmd/commit/1ff1e07c4dd10d61141a54138f932ab129b495f7", "message": "Return a report instead of side-effecting on it\n\nI think this will be more compatible with pmd 7.", "committedDate": "2020-11-03T13:43:38Z", "type": "commit"}, {"oid": "08fca9367e3722fc65b7c7911fe4ade978158c5a", "url": "https://github.com/pmd/pmd/commit/08fca9367e3722fc65b7c7911fe4ade978158c5a", "message": "Rename RuleSetParser to RuleSetLoader", "committedDate": "2020-11-03T13:44:54Z", "type": "commit"}, {"oid": "4f175a1c4fca8a88d9a688f68b149ec2fbcb6142", "url": "https://github.com/pmd/pmd/commit/4f175a1c4fca8a88d9a688f68b149ec2fbcb6142", "message": "Hide RuleSetLoader fields", "committedDate": "2020-11-03T13:48:29Z", "type": "commit"}, {"oid": "8f7801c2e71b62e9520f097aec7ed69648cda64a", "url": "https://github.com/pmd/pmd/commit/8f7801c2e71b62e9520f097aec7ed69648cda64a", "message": "Remove try with resources", "committedDate": "2020-11-03T13:51:23Z", "type": "commit"}, {"oid": "e30fcaf31dffa9fa3c2e15df4f901bce1e212460", "url": "https://github.com/pmd/pmd/commit/e30fcaf31dffa9fa3c2e15df4f901bce1e212460", "message": "Rename to loadFromResources", "committedDate": "2020-11-03T13:52:45Z", "type": "commit"}, {"oid": "ccaf57e8d650f4564ff65f9f4ec55ee800a1b273", "url": "https://github.com/pmd/pmd/commit/ccaf57e8d650f4564ff65f9f4ec55ee800a1b273", "message": "Update release notes", "committedDate": "2020-11-03T13:56:08Z", "type": "commit"}, {"oid": "6eee3d037f4af2b6c591f361d0e91e337fcd7742", "url": "https://github.com/pmd/pmd/commit/6eee3d037f4af2b6c591f361d0e91e337fcd7742", "message": "Provide replacement api for getRegisteredRuleSets", "committedDate": "2020-11-03T14:05:58Z", "type": "commit"}, {"oid": "93c5ef33cf2c20485d979a84782fe2f437b36f8d", "url": "https://github.com/pmd/pmd/commit/93c5ef33cf2c20485d979a84782fe2f437b36f8d", "message": "Merge branch 'master' into ruleset-factory-builder", "committedDate": "2020-11-13T16:12:27Z", "type": "commit"}, {"oid": "87892adefe4b6dfe9055ea9f04a5ef98ff6b30d2", "url": "https://github.com/pmd/pmd/commit/87892adefe4b6dfe9055ea9f04a5ef98ff6b30d2", "message": "Fix unnecessary throws clause", "committedDate": "2020-11-13T16:23:43Z", "type": "commit"}, {"oid": "37c2c505f3792aa0eacaf8f124b1f565544393b5", "url": "https://github.com/pmd/pmd/commit/37c2c505f3792aa0eacaf8f124b1f565544393b5", "message": "Merge branch 'master' into ruleset-factory-builder", "committedDate": "2020-11-24T11:49:18Z", "type": "commit"}, {"oid": "87e2a9c99b2b546c99ad776ddf3754053adb3be9", "url": "https://github.com/pmd/pmd/commit/87e2a9c99b2b546c99ad776ddf3754053adb3be9", "message": "Replace checked exception with wrapper", "committedDate": "2020-11-24T12:07:43Z", "type": "commit"}, {"oid": "b0df6a82480a91c28902420befed86d9db237b42", "url": "https://github.com/pmd/pmd/commit/b0df6a82480a91c28902420befed86d9db237b42", "message": "Update pmd-doc module to use newer apis", "committedDate": "2020-11-24T12:18:30Z", "type": "commit"}, {"oid": "1a2a897b3f37f2263fd44acaea52d8990560bd82", "url": "https://github.com/pmd/pmd/commit/1a2a897b3f37f2263fd44acaea52d8990560bd82", "message": "Fix bug with sub-report not being merged into global report", "committedDate": "2020-11-24T12:55:26Z", "type": "commit"}, {"oid": "141c51b0ab903fe079a21a76ac193c8b0f8ebd84", "url": "https://github.com/pmd/pmd/commit/141c51b0ab903fe079a21a76ac193c8b0f8ebd84", "message": "Fix ant tests\n\nReport was being rendered mutliple times", "committedDate": "2020-11-24T13:43:27Z", "type": "commit"}, {"oid": "0244ebf6e39a35ae9ede97feee0ad7acf7374109", "url": "https://github.com/pmd/pmd/commit/0244ebf6e39a35ae9ede97feee0ad7acf7374109", "message": "Fix javadoc", "committedDate": "2020-11-25T10:51:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEwOTcxOQ==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r541109719", "bodyText": "That should be RuleSetLoadException (capital Set), to be consistent with all the other usages of RuleSet. I'll change that, when merging.", "author": "adangel", "createdAt": "2020-12-11T17:30:10Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/RulesetLoadException.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+package net.sourceforge.pmd;\n+\n+import net.sourceforge.pmd.annotation.InternalApi;\n+\n+/**\n+ * An exception that is thrown when something wrong occurs while\n+ * {@linkplain RuleSetLoader loading rulesets}. This may be because the\n+ * XML is not well-formed, does not respect the ruleset schema, is\n+ * not a valid ruleset or is otherwise unparsable.\n+ *\n+ * <p>In the new {@link RuleSetLoader} API, this is thrown instead of\n+ * {@link RuleSetNotFoundException}.\n+ */\n+public final class RulesetLoadException extends RuntimeException {", "originalCommit": "0244ebf6e39a35ae9ede97feee0ad7acf7374109", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExOTEwMA==", "url": "https://github.com/pmd/pmd/pull/2635#discussion_r541119100", "bodyText": "I guess, this suppression and the following comments can be removed, as it is moved down to the new method. I'll test and remove it then.", "author": "adangel", "createdAt": "2020-12-11T17:45:49Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/processor/AbstractPMDProcessor.java", "diffHunk": "@@ -108,25 +115,37 @@ protected RuleSets createRuleSets(RuleSetFactory factory, Report report) {\n     @SuppressWarnings(\"PMD.CloseResource\")", "originalCommit": "0244ebf6e39a35ae9ede97feee0ad7acf7374109", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}