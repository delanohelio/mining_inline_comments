{"pr_number": 2407, "pr_title": "[core] Deprecate Jaxen and XPath internal API ", "pr_createdAt": "2020-04-08T20:08:34Z", "pr_url": "https://github.com/pmd/pmd/pull/2407", "timeline": [{"oid": "fc304bf70cce24359b8fc58f1ca757ccff2e3927", "url": "https://github.com/pmd/pmd/commit/fc304bf70cce24359b8fc58f1ca757ccff2e3927", "message": "Add XPath version maker", "committedDate": "2020-04-08T19:35:34Z", "type": "commit"}, {"oid": "bcf90ceb8ad1ef37af3c0a5c8d10ea4b26392bf5", "url": "https://github.com/pmd/pmd/commit/bcf90ceb8ad1ef37af3c0a5c8d10ea4b26392bf5", "message": "Externalize creator for XPath rule", "committedDate": "2020-04-08T19:35:34Z", "type": "commit"}, {"oid": "8284fc8e816055a9231e32b57e1786124ffcbec3", "url": "https://github.com/pmd/pmd/commit/8284fc8e816055a9231e32b57e1786124ffcbec3", "message": "Deprecate two other things", "committedDate": "2020-04-08T19:35:34Z", "type": "commit"}, {"oid": "961e78954aac16fc78dd9d16cd0754b0e98eff3d", "url": "https://github.com/pmd/pmd/commit/961e78954aac16fc78dd9d16cd0754b0e98eff3d", "message": "Update some tests", "committedDate": "2020-04-08T19:35:34Z", "type": "commit"}, {"oid": "5067c79eb28c74691cacee0124468a740505919f", "url": "https://github.com/pmd/pmd/commit/5067c79eb28c74691cacee0124468a740505919f", "message": "Cleanup a test", "committedDate": "2020-04-08T19:38:10Z", "type": "commit"}, {"oid": "1de1d1c66daf9e34947ad7f494a0f50c800d03c4", "url": "https://github.com/pmd/pmd/commit/1de1d1c66daf9e34947ad7f494a0f50c800d03c4", "message": "Update some usages early", "committedDate": "2020-04-08T20:00:36Z", "type": "commit"}, {"oid": "60087590e65d4ec1859a7ea7f940f7d4fb94b29c", "url": "https://github.com/pmd/pmd/commit/60087590e65d4ec1859a7ea7f940f7d4fb94b29c", "message": "Remove changes to XPathHandler", "committedDate": "2020-04-08T20:07:26Z", "type": "commit"}, {"oid": "60d443963c82d360d5a6169bba02bc0938ee1d7d", "url": "https://github.com/pmd/pmd/commit/60d443963c82d360d5a6169bba02bc0938ee1d7d", "message": "Call default ctor\n\nDefines properties", "committedDate": "2020-04-09T13:28:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQwMTEzNg==", "url": "https://github.com/pmd/pmd/pull/2407#discussion_r407401136", "bodyText": "Btw. this API must definitely change with PMD 7 - we are exposing here a implementation detail (that we use Saxon). And it happens, that the way, how custom functions are registered, changed with Saxon 9.5... which makes the need for a implementation agnostic API relevant...", "author": "adangel", "createdAt": "2020-04-13T09:37:22Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/lang/ast/xpath/AbstractASTXPathHandler.java", "diffHunk": "@@ -25,4 +25,14 @@ public Navigator getNavigator() {\n     public void initialize(IndependentContext context, Language language, Class<?> functionsClass) {\n         context.declareNamespace(\"pmd-\" + language.getTerseName(), \"java:\" + functionsClass.getName());\n     }\n+\n+    @Override\n+    public void initialize() {\n+        // override if needed\n+    }\n+\n+    @Override\n+    public void initialize(IndependentContext context) {", "originalCommit": "60d443963c82d360d5a6169bba02bc0938ee1d7d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQwMjk2Mw==", "url": "https://github.com/pmd/pmd/pull/2407#discussion_r407402963", "bodyText": "Since this is an enum, we can use version == XPathVersion.XPATH_1_0 here\nUpdate: I've changed this while merging", "author": "adangel", "createdAt": "2020-04-13T09:42:38Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/lang/rule/XPathRule.java", "diffHunk": "@@ -124,13 +171,21 @@ public void evaluate(final Node node, final RuleContext data) {\n      * engine in which the query will be run it looks at the XPath version.\n      */\n     private void initXPathRuleQuery() {\n-        String xpath = getProperty(XPATH_DESCRIPTOR);\n-        String version = getProperty(VERSION_DESCRIPTOR);\n+        String xpath = getXPathExpression();\n+        XPathVersion version = getVersion();\n \n-        initRuleQueryBasedOnVersion(version);\n+        if (version == null) {\n+            throw new IllegalStateException(\"Invalid XPath version, should have been caught by Rule::dysfunctionReason\");\n+        }\n+\n+        if (version.equals(XPathVersion.XPATH_1_0)) {", "originalCommit": "60d443963c82d360d5a6169bba02bc0938ee1d7d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}