{"pr_number": 2791, "pr_title": "[apex] Analyze inner classes for sharing violations", "pr_createdAt": "2020-09-17T17:01:30Z", "pr_url": "https://github.com/pmd/pmd/pull/2791", "timeline": [{"oid": "c6b7a723be52a77b6e4ebd6fa15f0511782b8bcc", "url": "https://github.com/pmd/pmd/commit/c6b7a723be52a77b6e4ebd6fa15f0511782b8bcc", "message": "Analyze inner classes for sharing violations\n\nFixes https://github.com/pmd/pmd/issues/2774, false positives and false\nnegatives for ApexSharingViolationsRule.\n\nSharing settings are not inherited by inner classes. Sharing settings\nneed to be declared on the class that contains the Database method, DML,\nSOQL, or SOSL.\n\nThe change inverts the direction from which nodes are found and\nanalyzed. The previous code visited the ASTUserClass and then searched\nfor descendant nodes that met a certain criteria. It did not visit inner\nASTUserClass nodes because it didn't use rule chains or call the super's\nvisit moethod for ASTUserClassi.\n\nThe new implementation visits all nodes that correspond to Database\nmethod, DML, SOQL, or SOSL nodes and then finds the nearest ASTUserClass\nparent node. This ASTUserClass is examined to determine if it has\ndeclared a sharing setting as required.", "committedDate": "2020-09-17T15:36:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyODI5MA==", "url": "https://github.com/pmd/pmd/pull/2791#discussion_r490428290", "bodyText": "The previous implementation used the outer classes sharing declaration and never visited the inner ASTUserClass, because it didn't use RuleChains or call super.visit(node, data);,\nAdding rule chains or calling super.visit was not enough because the logic for finding the child nodes doesn't distinguish between statements in the Outer or Inner class.\nI tried an implementation that kept top down approach by filtering out child nodes based on the parent, but it was messy. Changing the logic to visit the Database/DML/SOQL/SOSL nodes, then look up the tree for the closest parent class makes the logic cleaner.", "author": "jbartolotta-sfdc", "createdAt": "2020-09-17T17:17:44Z", "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexSharingViolationsRule.java", "diffHunk": "@@ -21,45 +30,103 @@\n  */\n public class ApexSharingViolationsRule extends AbstractApexRule {\n \n+    /**\n+     * Keep track of previously reported violations to avoid duplicates.\n+     */\n     private WeakHashMap<ApexNode<?>, Object> localCacheOfReportedNodes = new WeakHashMap<>();\n \n     public ApexSharingViolationsRule() {\n         setProperty(CODECLIMATE_CATEGORIES, \"Security\");\n         setProperty(CODECLIMATE_REMEDIATION_MULTIPLIER, 100);\n         setProperty(CODECLIMATE_BLOCK_HIGHLIGHTING, false);\n+        addRuleChainVisit(ASTDmlDeleteStatement.class);\n+        addRuleChainVisit(ASTDmlInsertStatement.class);\n+        addRuleChainVisit(ASTDmlMergeStatement.class);\n+        addRuleChainVisit(ASTDmlUndeleteStatement.class);\n+        addRuleChainVisit(ASTDmlUpdateStatement.class);\n+        addRuleChainVisit(ASTDmlUpsertStatement.class);\n+        addRuleChainVisit(ASTMethodCallExpression.class);\n+        addRuleChainVisit(ASTSoqlExpression.class);\n+        addRuleChainVisit(ASTSoslExpression.class);\n     }\n \n     @Override\n-    public Object visit(ASTUserClass node, Object data) {", "originalCommit": "c6b7a723be52a77b6e4ebd6fa15f0511782b8bcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk0NjU4Ng==", "url": "https://github.com/pmd/pmd/pull/2791#discussion_r490946586", "bodyText": "This makes sense. Using node.getFirstParent() is simpler.", "author": "adangel", "createdAt": "2020-09-18T13:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyODI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyOTYxOQ==", "url": "https://github.com/pmd/pmd/pull/2791#discussion_r490429619", "bodyText": "The number of permutations that can occur lends itself to a parameterized test instead hand crafting them in XML.", "author": "jbartolotta-sfdc", "createdAt": "2020-09-17T17:20:03Z", "path": "pmd-apex/src/test/java/net/sourceforge/pmd/lang/apex/rule/security/ApexSharingViolationsNestedClassTest.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/**\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+package net.sourceforge.pmd.lang.apex.rule.security;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+\n+import net.sourceforge.pmd.Report;\n+import net.sourceforge.pmd.Rule;\n+import net.sourceforge.pmd.RuleViolation;\n+import net.sourceforge.pmd.lang.LanguageRegistry;\n+import net.sourceforge.pmd.lang.apex.ApexLanguageModule;\n+import net.sourceforge.pmd.testframework.RuleTst;\n+\n+/**\n+ * <p>Sharing settings are not inherited by inner classes. Sharing settings need to be declared on the class that\n+ * contains the Database method, DML, SOQL, or SOSL.</p>\n+ *\n+ * <p>This test runs against Apex code that has an Outer class and and Inner class. Different Apex code is generated\n+ * based on the boolean permutations. Any classes that includes data access cod, but doesn't declare a sharing setting\n+ * should trigger a violation.</p>\n+ */\n+@RunWith(Parameterized.class)", "originalCommit": "c6b7a723be52a77b6e4ebd6fa15f0511782b8bcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk0ODg5Mg==", "url": "https://github.com/pmd/pmd/pull/2791#discussion_r490948892", "bodyText": "The downside is, that it's now not obvious anymore, what is being tested. You can't copy the sample code snippet into some other tool (like designer, or another parser/compiler, or easily create a separate source file).\nSince we still have the \"standard\" rule tests, I'm ok with adding this test class.", "author": "adangel", "createdAt": "2020-09-18T13:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyOTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzOTc0Mw==", "url": "https://github.com/pmd/pmd/pull/2791#discussion_r491139743", "bodyText": "@adangel thanks for the review. Would you like to me to programatically generate the xml tests and only check in the xml. That would remove the need for this java class, and fix some of the concerns that you raised.", "author": "jbartolotta-sfdc", "createdAt": "2020-09-18T19:07:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyOTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNjA4MA==", "url": "https://github.com/pmd/pmd/pull/2791#discussion_r492226080", "bodyText": "@jbartolotta-sfdc I'd keep this class as it is for now. We can migrate that later to xml once we actually need it.", "author": "adangel", "createdAt": "2020-09-21T17:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyOTYxOQ=="}], "type": "inlineReview"}, {"oid": "5429cebf380233f7569a41feb968ba7fcd30108c", "url": "https://github.com/pmd/pmd/commit/5429cebf380233f7569a41feb968ba7fcd30108c", "message": "Add issue reproducers as standard rule tests\n\nAdded false negative and false positive test cases that were logged with\nthe original issue.", "committedDate": "2020-09-22T03:11:07Z", "type": "commit"}]}