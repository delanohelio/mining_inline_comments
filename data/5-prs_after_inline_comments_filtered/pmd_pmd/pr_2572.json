{"pr_number": 2572, "pr_title": "[cpd] Allow CPD tests based on a text dump", "pr_createdAt": "2020-06-12T14:58:27Z", "pr_url": "https://github.com/pmd/pmd/pull/2572", "timeline": [{"oid": "b47001c90db85eeda1b67fc4777faabc1b8ec3bc", "url": "https://github.com/pmd/pmd/commit/b47001c90db85eeda1b67fc4777faabc1b8ec3bc", "message": "Add text comparison tests for CPD", "committedDate": "2020-06-12T14:01:00Z", "type": "commit"}, {"oid": "ecc869926972f5437d20a72dce261497cbd2c44a", "url": "https://github.com/pmd/pmd/commit/ecc869926972f5437d20a72dce261497cbd2c44a", "message": "Add doc", "committedDate": "2020-06-12T14:27:40Z", "type": "commit"}, {"oid": "1540ec6d9148fc14fc1673f4df1d33030d2ffcf7", "url": "https://github.com/pmd/pmd/commit/1540ec6d9148fc14fc1673f4df1d33030d2ffcf7", "message": "Port remaining dart tests", "committedDate": "2020-06-12T14:56:43Z", "type": "commit"}, {"oid": "826bc36331600de1c8f8e83d971e68994edfd52b", "url": "https://github.com/pmd/pmd/commit/826bc36331600de1c8f8e83d971e68994edfd52b", "message": "Normalize text before tokenizing\n\nOtherwise column numbers are messed up on windows", "committedDate": "2020-06-12T15:27:11Z", "type": "commit"}, {"oid": "43412b532bf92e5a1c3cb825cdd6d8a5a5ecf1a8", "url": "https://github.com/pmd/pmd/commit/43412b532bf92e5a1c3cb825cdd6d8a5a5ecf1a8", "message": "Fix column problem with Antlr multiline tokens", "committedDate": "2020-06-12T16:15:33Z", "type": "commit"}, {"oid": "d405eab97f7ede6ea6a8f59f3f435ed391704529", "url": "https://github.com/pmd/pmd/commit/d405eab97f7ede6ea6a8f59f3f435ed391704529", "message": "Fix java 7 incompatibility", "committedDate": "2020-06-12T16:22:21Z", "type": "commit"}, {"oid": "6ebe4c8775b92c3bbc8fb7c6c85d17f80a27cd74", "url": "https://github.com/pmd/pmd/commit/6ebe4c8775b92c3bbc8fb7c6c85d17f80a27cd74", "message": "Port xml tests", "committedDate": "2020-06-13T00:29:50Z", "type": "commit"}, {"oid": "6ebe4c8775b92c3bbc8fb7c6c85d17f80a27cd74", "url": "https://github.com/pmd/pmd/commit/6ebe4c8775b92c3bbc8fb7c6c85d17f80a27cd74", "message": "Port xml tests", "committedDate": "2020-06-13T00:29:50Z", "type": "forcePushed"}, {"oid": "ceda6bb96534a0004fdd00bd9e436069e264405a", "url": "https://github.com/pmd/pmd/commit/ceda6bb96534a0004fdd00bd9e436069e264405a", "message": "Fix newline-only tokens\n\nThis happens eg in XML. Previously the end column would have been zero. We can't blindly make it 1 because the end column is inclusive. So we instead use the last column of the previous line.", "committedDate": "2020-06-13T11:46:55Z", "type": "commit"}, {"oid": "1ee33c7c20d61f2f66fcc7e5ed5471242a9ba5a7", "url": "https://github.com/pmd/pmd/commit/1ee33c7c20d61f2f66fcc7e5ed5471242a9ba5a7", "message": "Normalize CPD newlines\n\nOtherwise tests are not platform-independent.\nDenormalizing to a platform-specific delimiter\nshould be done in the renderers", "committedDate": "2020-06-13T14:57:57Z", "type": "commit"}, {"oid": "a976e9af475fbd805a7a846d0f6e3618e0df8dba", "url": "https://github.com/pmd/pmd/commit/a976e9af475fbd805a7a846d0f6e3618e0df8dba", "message": "Fix sourceCode test", "committedDate": "2020-06-13T15:11:47Z", "type": "commit"}, {"oid": "30f3d11795969938fd7bcda047691bdaba561796", "url": "https://github.com/pmd/pmd/commit/30f3d11795969938fd7bcda047691bdaba561796", "message": "Fix java test", "committedDate": "2020-06-13T16:00:57Z", "type": "commit"}, {"oid": "4e21c1a94776002778b88985529a009b0a9e56f3", "url": "https://github.com/pmd/pmd/commit/4e21c1a94776002778b88985529a009b0a9e56f3", "message": "Fix js tests", "committedDate": "2020-06-13T17:02:35Z", "type": "commit"}, {"oid": "e48fc7cca259f0efcae7135ae27e5143b3e092af", "url": "https://github.com/pmd/pmd/commit/e48fc7cca259f0efcae7135ae27e5143b3e092af", "message": "Convert JS tests", "committedDate": "2020-06-13T17:16:22Z", "type": "commit"}, {"oid": "0a1e82efad8a838da894ba8cbdbfa8d60a5fe005", "url": "https://github.com/pmd/pmd/commit/0a1e82efad8a838da894ba8cbdbfa8d60a5fe005", "message": "Rename dir", "committedDate": "2020-06-13T17:21:27Z", "type": "commit"}, {"oid": "551ab453fdf7a96f91f45cb71a209e98c26691fb", "url": "https://github.com/pmd/pmd/commit/551ab453fdf7a96f91f45cb71a209e98c26691fb", "message": "Convert CPP tests", "committedDate": "2020-06-13T18:14:08Z", "type": "commit"}, {"oid": "78cadd9ef31b6b51b169ba2f7702101798005d4b", "url": "https://github.com/pmd/pmd/commit/78cadd9ef31b6b51b169ba2f7702101798005d4b", "message": "Finish cpp module", "committedDate": "2020-06-13T18:32:14Z", "type": "forcePushed"}, {"oid": "709996fddc68c5c2ef791eb4cc9d4a18dfd9213b", "url": "https://github.com/pmd/pmd/commit/709996fddc68c5c2ef791eb4cc9d4a18dfd9213b", "message": "Finish cpp module", "committedDate": "2020-06-13T18:34:30Z", "type": "commit"}, {"oid": "709996fddc68c5c2ef791eb4cc9d4a18dfd9213b", "url": "https://github.com/pmd/pmd/commit/709996fddc68c5c2ef791eb4cc9d4a18dfd9213b", "message": "Finish cpp module", "committedDate": "2020-06-13T18:34:30Z", "type": "forcePushed"}, {"oid": "344d02600c4e8551ec9b07c88eef10946aa9d07d", "url": "https://github.com/pmd/pmd/commit/344d02600c4e8551ec9b07c88eef10946aa9d07d", "message": "Convert java tests", "committedDate": "2020-06-13T19:09:31Z", "type": "commit"}, {"oid": "d8c3831db8a6cf03d903fe9bce56d5c967b42b49", "url": "https://github.com/pmd/pmd/commit/d8c3831db8a6cf03d903fe9bce56d5c967b42b49", "message": "Fix getSlice\n\nThe method path for when the\ncode is not loaded yet was incorrect.\n\nThis was hidden by the fact that tests\nuse a dummy tokenizer *before* cutting\nout a slice, so that the code is in the\nsoft reference, and that code path is\nnever taken in the relevant tests.", "committedDate": "2020-06-13T19:24:36Z", "type": "commit"}, {"oid": "6ff4a1c4d44589faf435af56500727bacea7f182", "url": "https://github.com/pmd/pmd/commit/6ff4a1c4d44589faf435af56500727bacea7f182", "message": "Rename test file", "committedDate": "2020-06-13T19:37:47Z", "type": "commit"}, {"oid": "0d23c04c1b193e8d027fb5c8d73407a1138788da", "url": "https://github.com/pmd/pmd/commit/0d23c04c1b193e8d027fb5c8d73407a1138788da", "message": "Check-in reference files", "committedDate": "2020-06-13T19:47:49Z", "type": "commit"}, {"oid": "4b3d58d4c98e78ab61b9b0d5c31ede6c32707715", "url": "https://github.com/pmd/pmd/commit/4b3d58d4c98e78ab61b9b0d5c31ede6c32707715", "message": "Normalize path to avoid surprises", "committedDate": "2020-06-13T19:52:45Z", "type": "commit"}, {"oid": "da371182aadaec625274f651e2a28ee6a71ff161", "url": "https://github.com/pmd/pmd/commit/da371182aadaec625274f651e2a28ee6a71ff161", "message": "Convert Go tests", "committedDate": "2020-06-13T20:00:58Z", "type": "commit"}, {"oid": "da764abb1ee6019ba4aef1572ef4bdd8022de3b0", "url": "https://github.com/pmd/pmd/commit/da764abb1ee6019ba4aef1572ef4bdd8022de3b0", "message": "Convert kotlin tests", "committedDate": "2020-06-13T20:04:33Z", "type": "commit"}, {"oid": "50725a95fc222723cc4efa89c19cbe4b574a9f52", "url": "https://github.com/pmd/pmd/commit/50725a95fc222723cc4efa89c19cbe4b574a9f52", "message": "Port ruby tests\n\nTODO there's a bug", "committedDate": "2020-06-13T20:08:58Z", "type": "commit"}, {"oid": "6eba9a827fac10720d8ca9f35412c5988e4c9256", "url": "https://github.com/pmd/pmd/commit/6eba9a827fac10720d8ca9f35412c5988e4c9256", "message": "Fix ruby lexer", "committedDate": "2020-06-13T20:51:00Z", "type": "commit"}, {"oid": "7e594e390a05230e91d063eea7edf5d48f0da608", "url": "https://github.com/pmd/pmd/commit/7e594e390a05230e91d063eea7edf5d48f0da608", "message": "Convert fortran tests", "committedDate": "2020-06-13T20:57:18Z", "type": "commit"}, {"oid": "ff2aa9c038f519f0fcd49112167def7e56fad610", "url": "https://github.com/pmd/pmd/commit/ff2aa9c038f519f0fcd49112167def7e56fad610", "message": "Convert lua tests", "committedDate": "2020-06-13T21:01:14Z", "type": "commit"}, {"oid": "3df4506365c0bce73d45bc426e3d8c75f3590aa4", "url": "https://github.com/pmd/pmd/commit/3df4506365c0bce73d45bc426e3d8c75f3590aa4", "message": "Convert scala tests", "committedDate": "2020-06-13T21:25:24Z", "type": "commit"}, {"oid": "9fc15f0b915267404df6a8e25d0977f96130d9e3", "url": "https://github.com/pmd/pmd/commit/9fc15f0b915267404df6a8e25d0977f96130d9e3", "message": "Remove test\n\nThis is already tested in SourceCodeTest in pmd-core", "committedDate": "2020-06-13T21:34:00Z", "type": "commit"}, {"oid": "60d028a28212be292d670253b5027824a197805b", "url": "https://github.com/pmd/pmd/commit/60d028a28212be292d670253b5027824a197805b", "message": "Convert matlab tests", "committedDate": "2020-06-13T21:39:35Z", "type": "commit"}, {"oid": "15d6515278453aafe3d59b8b0124c2ab8a611c55", "url": "https://github.com/pmd/pmd/commit/15d6515278453aafe3d59b8b0124c2ab8a611c55", "message": "Convert ObjC tests", "committedDate": "2020-06-13T21:44:34Z", "type": "commit"}, {"oid": "2c563436e41067fa253f824ca0e768500dc29d34", "url": "https://github.com/pmd/pmd/commit/2c563436e41067fa253f824ca0e768500dc29d34", "message": "Convert plsql tests", "committedDate": "2020-06-13T21:48:21Z", "type": "commit"}, {"oid": "aedd2ce49376042e3dbdcb1d9147754214ff4697", "url": "https://github.com/pmd/pmd/commit/aedd2ce49376042e3dbdcb1d9147754214ff4697", "message": "Convert python tests", "committedDate": "2020-06-13T21:56:55Z", "type": "commit"}, {"oid": "394b8665249d7c2f7f372ec754e97483d3860199", "url": "https://github.com/pmd/pmd/commit/394b8665249d7c2f7f372ec754e97483d3860199", "message": "Convert swift tests", "committedDate": "2020-06-13T21:58:17Z", "type": "commit"}, {"oid": "4c378b56318541c126451db8d6ae9188c0d8cfb5", "url": "https://github.com/pmd/pmd/commit/4c378b56318541c126451db8d6ae9188c0d8cfb5", "message": "Convert C# module", "committedDate": "2020-06-13T22:20:14Z", "type": "commit"}, {"oid": "4c378b56318541c126451db8d6ae9188c0d8cfb5", "url": "https://github.com/pmd/pmd/commit/4c378b56318541c126451db8d6ae9188c0d8cfb5", "message": "Convert C# module", "committedDate": "2020-06-13T22:20:14Z", "type": "forcePushed"}, {"oid": "fb0819f31906b0727414d8cf76bb2e9a56855b24", "url": "https://github.com/pmd/pmd/commit/fb0819f31906b0727414d8cf76bb2e9a56855b24", "message": "Convert Apex tests", "committedDate": "2020-06-13T22:29:58Z", "type": "commit"}, {"oid": "b976d6550dfeaf66f32a7efcca2c27beb8610f15", "url": "https://github.com/pmd/pmd/commit/b976d6550dfeaf66f32a7efcca2c27beb8610f15", "message": "Preserve column numbers in AnyTokenizer", "committedDate": "2020-06-13T22:42:15Z", "type": "commit"}, {"oid": "59dfa15269710bc7aeeb81b00c6e1fe63512fe4e", "url": "https://github.com/pmd/pmd/commit/59dfa15269710bc7aeeb81b00c6e1fe63512fe4e", "message": "Fix groovy columns", "committedDate": "2020-06-13T23:04:32Z", "type": "commit"}, {"oid": "1bdbd4883c2751a3f4900ade0fc958d626e6e0c4", "url": "https://github.com/pmd/pmd/commit/1bdbd4883c2751a3f4900ade0fc958d626e6e0c4", "message": "Convert groovy tests", "committedDate": "2020-06-13T23:09:49Z", "type": "commit"}, {"oid": "332e2369f5b7b6b8e63e449883c07ba05d2fb75a", "url": "https://github.com/pmd/pmd/commit/332e2369f5b7b6b8e63e449883c07ba05d2fb75a", "message": "Fix pmd warning", "committedDate": "2020-06-13T23:22:17Z", "type": "commit"}, {"oid": "05f3740832f17225b58c48399845a887b57dafa7", "url": "https://github.com/pmd/pmd/commit/05f3740832f17225b58c48399845a887b57dafa7", "message": "Make method private", "committedDate": "2020-06-14T00:31:28Z", "type": "commit"}, {"oid": "87797f76215e5a7222d68a545c2bfccd6e4b9d92", "url": "https://github.com/pmd/pmd/commit/87797f76215e5a7222d68a545c2bfccd6e4b9d92", "message": "Port JSP tests", "committedDate": "2020-06-14T03:27:46Z", "type": "commit"}, {"oid": "8e47ed3188039163d82903b9f3c43221d111141d", "url": "https://github.com/pmd/pmd/commit/8e47ed3188039163d82903b9f3c43221d111141d", "message": "Merge branch 'master' into cpd-text-comp", "committedDate": "2020-06-17T18:00:50Z", "type": "commit"}, {"oid": "2592c56229a5030d380b37ecfc7afefa08cafc2c", "url": "https://github.com/pmd/pmd/commit/2592c56229a5030d380b37ecfc7afefa08cafc2c", "message": "Make apex end column inclusive", "committedDate": "2020-06-17T18:03:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzNjkyNA==", "url": "https://github.com/pmd/pmd/pull/2572#discussion_r442236924", "bodyText": "Note that the override is necessary because test classes are in the same package as the tested tokenizer (n.s.pmd.cpd), while test files are in this new package. For 7.0 it would be best to move all tokenizers into the language-specific package:\n#2457 (comment)\nAnd these resource prefixes could be removed", "author": "oowekyala", "createdAt": "2020-06-18T13:45:01Z", "path": "pmd-apex/src/test/java/net/sourceforge/pmd/cpd/ApexTokenizerTest.java", "diffHunk": "@@ -4,89 +4,57 @@\n \n package net.sourceforge.pmd.cpd;\n \n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.fail;\n-\n-import java.io.IOException;\n-import java.nio.charset.StandardCharsets;\n-import java.util.ArrayList;\n-import java.util.List;\n import java.util.Properties;\n \n-import org.apache.commons.io.IOUtils;\n import org.junit.Test;\n \n-import net.sourceforge.pmd.PMD;\n-import net.sourceforge.pmd.cpd.SourceCode.StringCodeLoader;\n+import net.sourceforge.pmd.cpd.test.CpdTextComparisonTest;\n+\n+public class ApexTokenizerTest extends CpdTextComparisonTest {\n+\n+    public ApexTokenizerTest() {\n+        super(\".cls\");\n+    }\n+\n+    @Override\n+    protected String getResourcePrefix() {\n+        return \"../lang/apex/cpd/testdata\";", "originalCommit": "2592c56229a5030d380b37ecfc7afefa08cafc2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM1MzgwOQ==", "url": "https://github.com/pmd/pmd/pull/2572#discussion_r442353809", "bodyText": "\ud83d\ude04", "author": "adangel", "createdAt": "2020-06-18T16:29:26Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/cpd/TokenEntry.java", "diffHunk": "@@ -48,7 +48,10 @@ private TokenEntry() {\n      * @param image\n      * @param tokenSrcID\n      * @param beginLine the linenumber, 1-based.\n+     *\n+     * @deprecated Use {@link #TokenEntry(String, String, int, int, int)}, don't be lazy", "originalCommit": "2592c56229a5030d380b37ecfc7afefa08cafc2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3ODMxMg==", "url": "https://github.com/pmd/pmd/pull/2572#discussion_r442378312", "bodyText": "really? wow...", "author": "adangel", "createdAt": "2020-06-18T17:10:28Z", "path": "pmd-scala-modules/pmd-scala-common/src/main/java/net/sourceforge/pmd/cpd/ScalaTokenizer.java", "diffHunk": "@@ -74,12 +76,26 @@ public void tokenize(SourceCode sourceCode, Tokens tokenEntries) throws IOExcept\n \n             Token token;\n             while ((token = filter.getNextToken()) != null) {\n-                String tokenText = token.text() != null ? token.text() : token.name();\n-                Position tokenPosition = token.pos();\n-                TokenEntry cpdToken = new TokenEntry(tokenText, filename, tokenPosition.startLine(),\n-                        tokenPosition.startColumn(), tokenPosition.endColumn());\n+                if (StringUtils.isEmpty(token.text())) {\n+                    continue;\n+                }\n+                Position pos = token.pos();\n+                TokenEntry cpdToken = new TokenEntry(token.text(),\n+                                                     filename,\n+                                                     pos.startLine() + 1,\n+                                                     pos.startColumn() + 1,\n+                                                     pos.endColumn() + 1);\n                 tokenEntries.add(cpdToken);\n             }\n+        } catch (Exception e) {\n+            if (e instanceof TokenizeException) { // NOPMD\n+                // cannot catch it as it's a checked exception and Scala sneaky throws", "originalCommit": "2592c56229a5030d380b37ecfc7afefa08cafc2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}