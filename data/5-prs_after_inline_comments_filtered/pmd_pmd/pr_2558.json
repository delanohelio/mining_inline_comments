{"pr_number": 2558, "pr_title": "[java] Fix issue #1736 and issue #2207", "pr_createdAt": "2020-05-31T02:46:47Z", "pr_url": "https://github.com/pmd/pmd/pull/2558", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3ODQwNQ==", "url": "https://github.com/pmd/pmd/pull/2558#discussion_r436378405", "bodyText": "Please don't use the toString() method for any logic. The toString() method is there for debugging purposes and in most cases the format is not an API and can change without any notice. Relying on the format of toString() makes java programs brittle. Also, in that case, if we decided to refactor the classes and rename/move ASTPrimaryPrefix, then we won't get here a compile time error but only a runtime error during execution - which is too late.\nWhat you want to achieve here is, to test, whether the parent (or grandparent or greatgrandparent) node is a instance of a specific type:\nif (node.getParent() instanceof ASTPrimaryPrefix\n    && node.getNthParent(2) instanceof ASTPrimaryExpression) {\n    return !(node.getNthParent(3) instanceof ASTExpression);\n}\nreturn false;", "author": "adangel", "createdAt": "2020-06-07T16:13:01Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/performance/AvoidInstantiatingObjectsInLoopsRule.java", "diffHunk": "@@ -14,24 +14,77 @@\n import net.sourceforge.pmd.lang.java.ast.ASTWhileStatement;\n \n public class AvoidInstantiatingObjectsInLoopsRule extends AbstractOptimizationRule {\n-\n+    /**\n+     * This method is used to check whether user instantiates variables\n+     * which are not assigned in loops.\n+     * @param node This is the expression of part of java code to be checked.\n+     * @param data This is the data to return.\n+     * @return Object This returns the data passed in. If violation happens, violation is added to data.\n+     */\n     @Override\n     public Object visit(ASTAllocationExpression node, Object data) {\n+        //CS304 Issue link: https://github.com/pmd/pmd/issues/2207\n         if (insideLoop(node) && fourthParentNotThrow(node) && fourthParentNotReturn(node)) {\n-            addViolation(data, node);\n+            if (thirdParentNotASTExpression(node) && fourthParentNotASTStatementExpression(node)) {\n+                addViolation(data, node);\n+            }\n         }\n         return data;\n     }\n \n-    private boolean fourthParentNotThrow(ASTAllocationExpression node) {\n+    /**\n+     * This method is used to check whether the instantiated variable is assigned or not.\n+     * @param node This is the expression of part of java code to be checked.\n+     * @return boolean This returns Whether the third parent of node is an ASTExpression.\n+     */\n+    public boolean thirdParentNotASTExpression(ASTAllocationExpression node) {\n+        //CS304 Issue link: https://github.com/pmd/pmd/issues/2207\n+        if (node.getParent().getClass().toString().equals(\n+                \"class net.sourceforge.pmd.lang.java.ast.ASTPrimaryPrefix\")", "originalCommit": "69db5f72c9019e2ce2b186428ebfdb51d01bd0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3ODQ2Mw==", "url": "https://github.com/pmd/pmd/pull/2558#discussion_r436378463", "bodyText": "There is no class ASTStateExpression - so this equals always return \"true\"...\nDid you mean \"ASTStatementExpression\"?\nThat's by the way one example, why using toString is bad: It didn't show you this error during compile time...", "author": "adangel", "createdAt": "2020-06-07T16:13:50Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/performance/AvoidInstantiatingObjectsInLoopsRule.java", "diffHunk": "@@ -14,24 +14,77 @@\n import net.sourceforge.pmd.lang.java.ast.ASTWhileStatement;\n \n public class AvoidInstantiatingObjectsInLoopsRule extends AbstractOptimizationRule {\n-\n+    /**\n+     * This method is used to check whether user instantiates variables\n+     * which are not assigned in loops.\n+     * @param node This is the expression of part of java code to be checked.\n+     * @param data This is the data to return.\n+     * @return Object This returns the data passed in. If violation happens, violation is added to data.\n+     */\n     @Override\n     public Object visit(ASTAllocationExpression node, Object data) {\n+        //CS304 Issue link: https://github.com/pmd/pmd/issues/2207\n         if (insideLoop(node) && fourthParentNotThrow(node) && fourthParentNotReturn(node)) {\n-            addViolation(data, node);\n+            if (thirdParentNotASTExpression(node) && fourthParentNotASTStatementExpression(node)) {\n+                addViolation(data, node);\n+            }\n         }\n         return data;\n     }\n \n-    private boolean fourthParentNotThrow(ASTAllocationExpression node) {\n+    /**\n+     * This method is used to check whether the instantiated variable is assigned or not.\n+     * @param node This is the expression of part of java code to be checked.\n+     * @return boolean This returns Whether the third parent of node is an ASTExpression.\n+     */\n+    public boolean thirdParentNotASTExpression(ASTAllocationExpression node) {\n+        //CS304 Issue link: https://github.com/pmd/pmd/issues/2207\n+        if (node.getParent().getClass().toString().equals(\n+                \"class net.sourceforge.pmd.lang.java.ast.ASTPrimaryPrefix\")\n+                && node.getParent().getParent().getClass().toString().equals(\n+                    \"class net.sourceforge.pmd.lang.java.ast.ASTPrimaryExpression\")) {\n+            return !node.getParent().getParent().getParent().getClass().toString().equals(\n+                    \"class net.sourceforge.pmd.lang.java.ast.ASTExpression\");\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * This method is used to check whether the instantiated variable is assigned or not.\n+     * @param node This is the expression of part of java code to be checked.\n+     * @return boolean This returns Whether the fourth parent of node is an ASTStatementExpression.\n+     */\n+    public boolean fourthParentNotASTStatementExpression(ASTAllocationExpression node) {\n+        //CS304 Issue link: https://github.com/pmd/pmd/issues/2207\n+        return !node.getParent().getParent().getParent().getClass().toString().equals(\n+                \"class net.sourceforge.pmd.lang.java.ast.ASTStateExpression\");", "originalCommit": "69db5f72c9019e2ce2b186428ebfdb51d01bd0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3ODcxMg==", "url": "https://github.com/pmd/pmd/pull/2558#discussion_r436378712", "bodyText": "You have to keep the base class PmdRuleTsts - this provides all the magic to execute the rule test cases. Now you disabled a bunch of tests...\nMore background info: https://pmd.github.io/latest/pmd_userdocs_extending_testing.html", "author": "adangel", "createdAt": "2020-06-07T16:16:54Z", "path": "pmd-java/src/test/java/net/sourceforge/pmd/lang/java/rule/performance/AvoidInstantiatingObjectsInLoopsTest.java", "diffHunk": "@@ -4,8 +4,98 @@\n \n package net.sourceforge.pmd.lang.java.rule.performance;\n \n-import net.sourceforge.pmd.testframework.PmdRuleTst;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n \n-public class AvoidInstantiatingObjectsInLoopsTest extends PmdRuleTst {", "originalCommit": "69db5f72c9019e2ce2b186428ebfdb51d01bd0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3ODg5NQ==", "url": "https://github.com/pmd/pmd/pull/2558#discussion_r436378895", "bodyText": "I'd say, these tests are too fine granular. They do basically a white box testing - they verify that java works as it should, but don't verify, that the rule does what it should...\nPlease remove your test cases here and create a real test case: https://pmd.github.io/latest/pmd_userdocs_extending_testing.html\nThe test cases for AvoidInstantiatingObjectsInLoops can be found here:\nhttps://github.com/pmd/pmd/blob/master/pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/performance/xml/AvoidInstantiatingObjectsInLoops.xml", "author": "adangel", "createdAt": "2020-06-07T16:19:20Z", "path": "pmd-java/src/test/java/net/sourceforge/pmd/lang/java/rule/performance/AvoidInstantiatingObjectsInLoopsTest.java", "diffHunk": "@@ -4,8 +4,98 @@\n \n package net.sourceforge.pmd.lang.java.rule.performance;\n \n-import net.sourceforge.pmd.testframework.PmdRuleTst;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n \n-public class AvoidInstantiatingObjectsInLoopsTest extends PmdRuleTst {\n-    // no additional unit tests\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import net.sourceforge.pmd.lang.java.ast.ASTAllocationExpression;\n+\n+public class AvoidInstantiatingObjectsInLoopsTest {\n+    AvoidInstantiatingObjectsInLoopsRule rule;\n+\n+    //CS304 (manually written) Issue link: https://github.com/pmd/pmd/issues/2207\n+    @Before\n+    public void init() {\n+        rule = new AvoidInstantiatingObjectsInLoopsRule();\n+    }\n+\n+    //CS304 (manually written) Issue link: https://github.com/pmd/pmd/issues/2207\n+    @Test\n+    public void visit() {\n+        assertEquals(\"yes\", rule.visit(new ASTAllocationExpression(1), \"yes\"));", "originalCommit": "69db5f72c9019e2ce2b186428ebfdb51d01bd0e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwMTg0MA==", "url": "https://github.com/pmd/pmd/pull/2558#discussion_r438901840", "bodyText": "Those tests also use a deprecated constructor and are not compatible with the 7.0 branch. Those constructors should never be called manually.", "author": "oowekyala", "createdAt": "2020-06-11T16:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3ODg5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3OTczMw==", "url": "https://github.com/pmd/pmd/pull/2558#discussion_r436379733", "bodyText": "Please extract astName.getNameDeclaration().getName() into a local variable. You use it 8 times. If I read the code correctly, that's actually the variable's name.", "author": "adangel", "createdAt": "2020-06-07T16:29:46Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/performance/UseStringBufferForStringAppendsRule.java", "diffHunk": "@@ -66,13 +77,29 @@ public Object visit(ASTVariableDeclaratorId node, Object data) {\n                         ASTAssignmentOperator assignmentOperator = statement\n                                 .getFirstDescendantOfType(ASTAssignmentOperator.class);\n                         if (assignmentOperator != null && assignmentOperator.isCompound()) {\n-                            addViolation(data, assignmentOperator);\n+                            //CS304 Issue link: https://github.com/pmd/pmd/issues/1736\n+                            // check whether is first time to break the rule\n+                            if (!map.containsKey(astName.getNameDeclaration().getName())) {", "originalCommit": "69db5f72c9019e2ce2b186428ebfdb51d01bd0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3OTg3NA==", "url": "https://github.com/pmd/pmd/pull/2558#discussion_r436379874", "bodyText": "The same comment applies here as well: Please re-enable the rule tests and add additional test cases to https://github.com/pmd/pmd/blob/master/pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/performance/xml/UseStringBufferForStringAppends.xml", "author": "adangel", "createdAt": "2020-06-07T16:31:03Z", "path": "pmd-java/src/test/java/net/sourceforge/pmd/lang/java/rule/performance/UseStringBufferForStringAppendsTest.java", "diffHunk": "@@ -4,8 +4,33 @@\n \n package net.sourceforge.pmd.lang.java.rule.performance;\n \n-import net.sourceforge.pmd.testframework.PmdRuleTst;\n+import static org.junit.Assert.assertEquals;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import net.sourceforge.pmd.lang.java.ast.ASTAllocationExpression;\n+\n+public class UseStringBufferForStringAppendsTest {\n+    UseStringBufferForStringAppendsRule rule;\n+\n+    //CS304 (manually written) Issue link: https://github.com/pmd/pmd/issues/1736\n+    @Before\n+    public void init() {\n+        rule = new UseStringBufferForStringAppendsRule();\n+    }\n+\n+    //CS304 (manually written) Issue link: https://github.com/pmd/pmd/issues/1736\n+    @Test\n+    public void visit() {\n+        assertEquals(null, rule.visit(new ASTAllocationExpression(1), \"yes\"));\n+    }\n+\n+    //CS304 (manually written) Issue link: https://github.com/pmd/pmd/issues/1736\n+    @Test(expected = NullPointerException.class)\n+    public void visit2() {\n+        ASTAllocationExpression e = null;\n+        assertEquals(\"yes\", rule.visit(e, \"yes\"));\n+    }\n \n-public class UseStringBufferForStringAppendsTest extends PmdRuleTst {", "originalCommit": "69db5f72c9019e2ce2b186428ebfdb51d01bd0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "11a0ec51fdb557c59a86f002e05af7bfff66177a", "url": "https://github.com/pmd/pmd/commit/11a0ec51fdb557c59a86f002e05af7bfff66177a", "message": "fix issue 1736", "committedDate": "2020-07-09T13:10:40Z", "type": "commit"}, {"oid": "f5ccc94130d234e9e7f922ea74bb1afd2cff18dd", "url": "https://github.com/pmd/pmd/commit/f5ccc94130d234e9e7f922ea74bb1afd2cff18dd", "message": "fix issue #1736", "committedDate": "2020-07-09T13:11:00Z", "type": "commit"}, {"oid": "6cff647681f27780e6246e94c47362bd14d6fe4b", "url": "https://github.com/pmd/pmd/commit/6cff647681f27780e6246e94c47362bd14d6fe4b", "message": "fix issue #2207", "committedDate": "2020-07-09T13:11:03Z", "type": "commit"}, {"oid": "b782575951fb0b9f45c42120242c9952d1f53fd2", "url": "https://github.com/pmd/pmd/commit/b782575951fb0b9f45c42120242c9952d1f53fd2", "message": "Update AvoidInstantiatingObjectsInLoopsRule.java", "committedDate": "2020-07-09T13:12:32Z", "type": "commit"}, {"oid": "e6c32ecbaa7ec16f6b9ceaed5c7f640dbf67cc57", "url": "https://github.com/pmd/pmd/commit/e6c32ecbaa7ec16f6b9ceaed5c7f640dbf67cc57", "message": "Update UseStringBufferForStringAppendsRule.java", "committedDate": "2020-07-09T13:12:32Z", "type": "commit"}, {"oid": "6f6f87c7dcf98ebd3f7a78b4999609413c4cab99", "url": "https://github.com/pmd/pmd/commit/6f6f87c7dcf98ebd3f7a78b4999609413c4cab99", "message": "[java] Add test for #1736: UseStringBufferForStringAppends false positive", "committedDate": "2020-07-09T13:21:36Z", "type": "commit"}, {"oid": "8766d54a07440a04e79c0063be65e69c55219a66", "url": "https://github.com/pmd/pmd/commit/8766d54a07440a04e79c0063be65e69c55219a66", "message": "[java] Fix and simplify UseStringBufferForStringAppendsRule", "committedDate": "2020-07-09T14:08:30Z", "type": "commit"}, {"oid": "e48489450f7cf8ee81f90f06195a28055c7838b0", "url": "https://github.com/pmd/pmd/commit/e48489450f7cf8ee81f90f06195a28055c7838b0", "message": "[java] Add test for #2207: AvoidInstantiatingObjectsInLoops false positives", "committedDate": "2020-07-09T16:54:53Z", "type": "commit"}, {"oid": "c5364a81f8eb0c703eaeec0d366db1329d1529eb", "url": "https://github.com/pmd/pmd/commit/c5364a81f8eb0c703eaeec0d366db1329d1529eb", "message": "[java] Fix and simplify AvoidInstantiatingObjectsInLoopsRule", "committedDate": "2020-07-09T16:55:10Z", "type": "commit"}, {"oid": "cc495f180cc5170d3b370ed76f4b2fe6b92564ab", "url": "https://github.com/pmd/pmd/commit/cc495f180cc5170d3b370ed76f4b2fe6b92564ab", "message": "[doc] Update release notes, refs #2558\n\nFixes #1736\nFixes #2207", "committedDate": "2020-07-09T17:00:59Z", "type": "commit"}, {"oid": "cc495f180cc5170d3b370ed76f4b2fe6b92564ab", "url": "https://github.com/pmd/pmd/commit/cc495f180cc5170d3b370ed76f4b2fe6b92564ab", "message": "[doc] Update release notes, refs #2558\n\nFixes #1736\nFixes #2207", "committedDate": "2020-07-09T17:00:59Z", "type": "forcePushed"}, {"oid": "cc408d2876b6fc7e0b080f00d215aa4a2e8ef239", "url": "https://github.com/pmd/pmd/commit/cc408d2876b6fc7e0b080f00d215aa4a2e8ef239", "message": "[java] AvoidInstantiatingObjectsInLoopsRule - fix false negative", "committedDate": "2020-07-13T18:00:46Z", "type": "commit"}]}