{"pr_number": 2685, "pr_title": "[java] Fix NoClassDefFoundErrors", "pr_createdAt": "2020-07-31T10:33:45Z", "pr_url": "https://github.com/pmd/pmd/pull/2685", "timeline": [{"oid": "4ce394eca3ca47294c844fbb4e404116fd035700", "url": "https://github.com/pmd/pmd/commit/4ce394eca3ca47294c844fbb4e404116fd035700", "message": "[java] ImportWrapper - only consider static fields/methods\n\nFixes #2663", "committedDate": "2020-07-31T09:45:17Z", "type": "commit"}, {"oid": "693613a6a8df96e0040673d62378a11e9c41f560", "url": "https://github.com/pmd/pmd/commit/693613a6a8df96e0040673d62378a11e9c41f560", "message": "[java] ImportWrapper - catch and report LinkageErrors", "committedDate": "2020-07-31T10:13:24Z", "type": "commit"}, {"oid": "08b922429ca944cf4d469837ffaa43f309d57766", "url": "https://github.com/pmd/pmd/commit/08b922429ca944cf4d469837ffaa43f309d57766", "message": "[java] Catch possible LinkageErrors for other rules", "committedDate": "2020-07-31T10:23:59Z", "type": "commit"}, {"oid": "22c3ce92ce53c9fa80c334f4c40aa79b7dd7351f", "url": "https://github.com/pmd/pmd/commit/22c3ce92ce53c9fa80c334f4c40aa79b7dd7351f", "message": "[doc] Update release notes, fixes #2663", "committedDate": "2020-07-31T10:28:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1NTI0NA==", "url": "https://github.com/pmd/pmd/pull/2685#discussion_r468555244", "bodyText": "I'm not sure adding a processing error is appropriate here. I don't think we currently log missing classes to the report right? And for now, processing errors indicate errors in PMD code, the kind of errors people should report as bugs. Currently, a processing error may very well mean that the file was not processed by rules at all, and so, violations may be missing from the report. Whereas missing dependencies is more akin to a warning, ie, we can continue analysis (and we do), but results of some rules may be somewhat inaccurate. And users shouldn't think this is a bug on our side.\nI would say a log call would be more appropriate, as it's possible to disable it, and it makes it clearer that this is just a warning. In PMD 7 this will be handled by the semantic checker, which is also akin to a logger, and won't touch the report.", "author": "oowekyala", "createdAt": "2020-08-11T12:52:05Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/ast/internal/ImportWrapper.java", "diffHunk": "@@ -8,57 +8,78 @@\n import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.Modifier;\n+import java.util.Collections;\n import java.util.HashSet;\n import java.util.Objects;\n import java.util.Set;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n \n+import net.sourceforge.pmd.Report.ProcessingError;\n+import net.sourceforge.pmd.RuleContext;\n import net.sourceforge.pmd.lang.ast.Node;\n import net.sourceforge.pmd.lang.java.ast.ASTImportDeclaration;\n \n /**\n  * Helper class to analyze {@link ASTImportDeclaration}s.\n  */\n public class ImportWrapper {\n-    private ASTImportDeclaration node;\n-    private String name;\n-    private String fullname;\n-    private boolean isStaticDemand;\n-    private Set<String> allDemands = new HashSet<>();\n+    private static final Logger LOG = Logger.getLogger(ImportWrapper.class.getName());\n+\n+    private final ASTImportDeclaration node;\n+    private final String name;\n+    private final String fullname;\n+    private final boolean isStaticDemand;\n+    private final Set<String> allStaticDemands;\n \n     public ImportWrapper(String fullname, String name) {\n         this(fullname, name, null);\n     }\n \n     public ImportWrapper(String fullname, String name, ASTImportDeclaration node) {\n-        this(fullname, name, node, false);\n+        this(fullname, name, node, false, null);\n     }\n \n-    public ImportWrapper(String fullname, String name, ASTImportDeclaration node, boolean isStaticDemand) {\n+    public ImportWrapper(String fullname, String name, ASTImportDeclaration node, boolean isStaticDemand, RuleContext ctx) {\n         this.fullname = fullname;\n         this.name = name;\n         this.node = node;\n         this.isStaticDemand = isStaticDemand;\n+        this.allStaticDemands = collectStaticFieldsAndMethods(node, ctx);\n+\n+    }\n+\n+    /**\n+     * @param node\n+     */\n+    private Set<String> collectStaticFieldsAndMethods(ASTImportDeclaration node, RuleContext ctx) {\n+        if (!this.isStaticDemand || node == null || node.getType() == null) {\n+            return Collections.emptySet();\n+        }\n \n-        if (node != null && node.getType() != null) {\n+        try {\n+            Set<String> names = new HashSet<>();\n             Class<?> type = node.getType();\n-            for (Method m : type.getMethods()) {\n-                allDemands.add(m.getName());\n-            }\n-            for (Field f : type.getFields()) {\n-                allDemands.add(f.getName());\n-            }\n-            // also consider static fields, that are not public\n+            // consider static fields, public and non-public\n             for (Field f : type.getDeclaredFields()) {\n                 if (Modifier.isStatic(f.getModifiers())) {\n-                    allDemands.add(f.getName());\n+                    names.add(f.getName());\n                 }\n             }\n             // and methods, too\n             for (Method m : type.getDeclaredMethods()) {\n                 if (Modifier.isStatic(m.getModifiers())) {\n-                    allDemands.add(m.getName());\n+                    names.add(m.getName());\n                 }\n             }\n+            return names;\n+        } catch (LinkageError e) {\n+            if (ctx != null) {\n+                ctx.getReport().addError(new ProcessingError(e, String.valueOf(ctx.getSourceCodeFile())));", "originalCommit": "22c3ce92ce53c9fa80c334f4c40aa79b7dd7351f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTEwNzkxOQ==", "url": "https://github.com/pmd/pmd/pull/2685#discussion_r471107919", "bodyText": "Yes, you're right. This logging is something different than a processing error (and in other places, we silently ignore linkagerrors).\nHowever, I still think, that such issues/warnings/problems should be part of the report, as it might indicate a incorrect/incomplete configuration when executing PMD. But that's for PMD 7 then.\nI'll change that to a LOG.debug call. I'm not sure, how much duplicates we would log otherwise as warnings, and that could be annoying as well. See also #1371.", "author": "adangel", "createdAt": "2020-08-16T12:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1NTI0NA=="}], "type": "inlineReview"}, {"oid": "839941d4ebad1350377330e7cb658e0ebee85121", "url": "https://github.com/pmd/pmd/commit/839941d4ebad1350377330e7cb658e0ebee85121", "message": "[java] Don't add linkage errors as processing errors, just log", "committedDate": "2020-08-16T13:02:21Z", "type": "commit"}]}