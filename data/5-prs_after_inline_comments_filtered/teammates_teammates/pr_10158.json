{"pr_number": 10158, "pr_title": "[#10146] Result Page: Add indicates missing response features", "pr_createdAt": "2020-06-03T04:01:56Z", "pr_url": "https://github.com/TEAMMATES/teammates/pull/10158", "timeline": [{"oid": "0796adefa39468c16f1039cdb19ad29911ca64d6", "url": "https://github.com/TEAMMATES/teammates/commit/0796adefa39468c16f1039cdb19ad29911ca64d6", "message": "display missing responses in the frontend", "committedDate": "2020-06-03T04:22:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwNTk5Ng==", "url": "https://github.com/TEAMMATES/teammates/pull/10158#discussion_r434505996", "bodyText": "MapMap -> Map", "author": "wkurniawan07", "createdAt": "2020-06-03T11:45:57Z", "path": "src/test/java/teammates/test/cases/datatransfer/SessionResultsBundleTest.java", "diffHunk": "@@ -23,7 +23,7 @@\n public class SessionResultsBundleTest extends BaseTestCase {\n \n     @Test\n-    public void testGetResponseCommentsMap() {\n+    public void testGetQuestionResponseMapMap() {", "originalCommit": "0796adefa39468c16f1039cdb19ad29911ca64d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwNjY0MQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10158#discussion_r434506641", "bodyText": "58 = 10 (total response) + 48 (total missing). It's not easy to justify where 10 and 48 come from, but 58 should not be left as a magic number.", "author": "wkurniawan07", "createdAt": "2020-06-03T11:47:20Z", "path": "src/test/java/teammates/test/cases/logic/FeedbackSessionsLogicTest.java", "diffHunk": "@@ -2019,7 +2037,7 @@ public void testGetSessionResultsForUser_instructorAllQuestions_shouldGenerateCo\n                 getResponseId(\"qn5.resp1\", responseBundle) + \"={false,true}\",\n                 getResponseId(\"qn6.resp1\", responseBundle) + \"={true,true}\");\n         AssertHelper.assertContains(expectedStrings, mapString);\n-        assertEquals(10, bundle.getResponseVisibilityTable().size());\n+        assertEquals(58, bundle.getResponseVisibilityTable().size());", "originalCommit": "0796adefa39468c16f1039cdb19ad29911ca64d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwNjcyNg==", "url": "https://github.com/TEAMMATES/teammates/pull/10158#discussion_r434506726", "bodyText": "Similarly here for 43 = 7 + 36.", "author": "wkurniawan07", "createdAt": "2020-06-03T11:47:29Z", "path": "src/test/java/teammates/test/cases/logic/FeedbackSessionsLogicTest.java", "diffHunk": "@@ -2061,7 +2086,7 @@ public void testGetSessionResultsForUser_instructorAllQuestionsSpecificSection_s\n                 getResponseId(\"qn2.resp3\", responseBundle) + \"={false,false}\",\n                 getResponseId(\"qn2.resp1\", responseBundle) + \"={false,false}\");\n         AssertHelper.assertContains(expectedStrings, mapString);\n-        assertEquals(7, bundle.getResponseVisibilityTable().size());\n+        assertEquals(43, bundle.getResponseVisibilityTable().size());", "originalCommit": "0796adefa39468c16f1039cdb19ad29911ca64d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwNzQ5NQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10158#discussion_r434507495", "bodyText": "Is it possible/not too troublesome to generate the response details object based on the question type?", "author": "wkurniawan07", "createdAt": "2020-06-03T11:48:57Z", "path": "src/main/java/teammates/logic/core/FeedbackSessionsLogic.java", "diffHunk": "@@ -1623,6 +1632,92 @@ private void addCommentVisibilityToTable(\n         commentVisibilityTable.put(frc.getId(), commentVisibility);\n     }\n \n+    /**\n+     * Builds viewable missing responses for the session for instructor.\n+     *\n+     * @param instructor the instructor\n+     * @param responseVisibilityTable the visibility table which will be updated with the visibility of missing responses\n+     * @param feedbackSession the feedback sessions\n+     * @param relatedQuestionsMap the relevant questions\n+     * @param existingResponses existing responses\n+     * @param courseRoster the course roster\n+     * @param section if not null, will only build missing responses for the section\n+     * @return a list of missing responses for the session.\n+     */\n+    private List<FeedbackResponseAttributes> buildMissingResponses(\n+            InstructorAttributes instructor,\n+            Map<String, boolean[]> responseVisibilityTable,\n+            FeedbackSessionAttributes feedbackSession, Map<String, FeedbackQuestionAttributes> relatedQuestionsMap,\n+            List<FeedbackResponseAttributes> existingResponses, CourseRoster courseRoster, @Nullable String section) {\n+\n+        // first get all possible giver recipient pairs\n+        Map<String, Map<String, Set<String>>> completeGiverRecipientMap =\n+                fqLogic.buildCompleteGiverRecipientMap(feedbackSession, relatedQuestionsMap.values(), courseRoster);\n+\n+        // remove the existing responses in those pairs\n+        for (FeedbackResponseAttributes existingResponse : existingResponses) {\n+            Map<String, Set<String>> currGiverRecipientMap =\n+                    completeGiverRecipientMap.get(existingResponse.getFeedbackQuestionId());\n+            if (!currGiverRecipientMap.containsKey(existingResponse.getGiver())) {\n+                continue;\n+            }\n+            currGiverRecipientMap.get(existingResponse.getGiver()).remove(existingResponse.getRecipient());\n+        }\n+\n+        List<FeedbackResponseAttributes> missingResponses = new ArrayList<>();\n+        // build dummy responses\n+        for (Map.Entry<String, Map<String, Set<String>>> currGiverRecipientMapEntry\n+                : completeGiverRecipientMap.entrySet()) {\n+            FeedbackQuestionAttributes correspondingQuestion =\n+                    relatedQuestionsMap.get(currGiverRecipientMapEntry.getKey());\n+            String questionId = correspondingQuestion.getId();\n+\n+            for (Map.Entry<String, Set<String>> giverRecipientEntry\n+                    : currGiverRecipientMapEntry.getValue().entrySet()) {\n+                // giver\n+                String giverIdentifier = giverRecipientEntry.getKey();\n+                CourseRoster.ParticipantInfo giverInfo = courseRoster.getInfoForIdentifier(giverIdentifier);\n+\n+                for (String recipientIdentifier : giverRecipientEntry.getValue()) {\n+                    // recipient\n+                    CourseRoster.ParticipantInfo recipientInfo = courseRoster.getInfoForIdentifier(recipientIdentifier);\n+\n+                    // skip responses not in current section\n+                    if (section != null\n+                            && !giverInfo.getSectionName().equals(section)\n+                                    && !recipientInfo.getSectionName().equals(section)) {\n+                        continue;\n+                    }\n+\n+                    FeedbackResponseAttributes missingResponse =\n+                            FeedbackResponseAttributes.builder(questionId, giverIdentifier, recipientIdentifier)\n+                                    .withCourseId(feedbackSession.getCourseId())\n+                                    .withFeedbackSessionName(feedbackSession.getFeedbackSessionName())\n+                                    .withGiverSection(giverInfo.getSectionName())\n+                                    .withRecipientSection(recipientInfo.getSectionName())\n+                                    .withResponseDetails(new FeedbackTextResponseDetails(\n+                                                    Const.INSTRUCTOR_FEEDBACK_RESULTS_MISSING_RESPONSE))", "originalCommit": "0796adefa39468c16f1039cdb19ad29911ca64d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg2OTU0OQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10158#discussion_r434869549", "bodyText": "Actually it is hard. There is no \"default value factory\" in the backend (but there is one in the frontend)", "author": "xpdavid", "createdAt": "2020-06-03T21:31:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwNzQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTIyMzg2MA==", "url": "https://github.com/TEAMMATES/teammates/pull/10158#discussion_r435223860", "bodyText": "Then it's ok to let it be like this", "author": "wkurniawan07", "createdAt": "2020-06-04T12:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwNzQ5NQ=="}], "type": "inlineReview"}, {"oid": "1bbe8440ad5cb58892e2c52fe9a3fc5091b4e7cc", "url": "https://github.com/TEAMMATES/teammates/commit/1bbe8440ad5cb58892e2c52fe9a3fc5091b4e7cc", "message": "optimize get recipient logic to utilize course roster", "committedDate": "2020-06-04T20:49:32Z", "type": "commit"}, {"oid": "07125804cfc5493f777d8a3fb412b8d4560fa609", "url": "https://github.com/TEAMMATES/teammates/commit/07125804cfc5493f777d8a3fb412b8d4560fa609", "message": "rename base component for instructor related page", "committedDate": "2020-06-04T20:49:32Z", "type": "commit"}, {"oid": "92fbc678cd3c1959c93ef9ee3fc24811b0570e89", "url": "https://github.com/TEAMMATES/teammates/commit/92fbc678cd3c1959c93ef9ee3fc24811b0570e89", "message": "generate missing responses in the backend", "committedDate": "2020-06-04T20:49:32Z", "type": "commit"}, {"oid": "79bb1d3c60b2bfc93f66f3e8fb34f9b9cc658bdf", "url": "https://github.com/TEAMMATES/teammates/commit/79bb1d3c60b2bfc93f66f3e8fb34f9b9cc658bdf", "message": "display missing responses in the frontend", "committedDate": "2020-06-04T21:08:19Z", "type": "commit"}, {"oid": "79bb1d3c60b2bfc93f66f3e8fb34f9b9cc658bdf", "url": "https://github.com/TEAMMATES/teammates/commit/79bb1d3c60b2bfc93f66f3e8fb34f9b9cc658bdf", "message": "display missing responses in the frontend", "committedDate": "2020-06-04T21:08:19Z", "type": "forcePushed"}]}