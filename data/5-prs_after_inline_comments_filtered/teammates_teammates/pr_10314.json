{"pr_number": 10314, "pr_title": "[#9823] Fix feedback made on behalf of team showing as anonymous ", "pr_createdAt": "2020-07-14T15:12:07Z", "pr_url": "https://github.com/TEAMMATES/teammates/pull/10314", "timeline": [{"oid": "6c6745037823547311bd351bd73631c0a0a16773", "url": "https://github.com/TEAMMATES/teammates/commit/6c6745037823547311bd351bd73631c0a0a16773", "message": "Fix isNameVisibleToUser()", "committedDate": "2019-07-17T04:02:31Z", "type": "commit"}, {"oid": "4cae1f41365f89e24a74c6b19a4f1ab6401d0f51", "url": "https://github.com/TEAMMATES/teammates/commit/4cae1f41365f89e24a74c6b19a4f1ab6401d0f51", "message": "Update test cases", "committedDate": "2019-07-17T09:03:40Z", "type": "commit"}, {"oid": "6a3b2ee79522ce16665876f7d78b907473bd32dd", "url": "https://github.com/TEAMMATES/teammates/commit/6a3b2ee79522ce16665876f7d78b907473bd32dd", "message": "Merge branch 'master' into 9823-9826-anon\n\n# Conflicts:\n#\tsrc/test/java/teammates/test/cases/logic/FeedbackSessionsLogicTest.java", "committedDate": "2020-07-14T15:09:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MjM4Ng==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r454762386", "bodyText": "Some context here:\n\nSadly, we do not manage to migrate the database for team response. There are still entries in the database where giver is one of the team member's email.", "author": "xpdavid", "createdAt": "2020-07-15T03:04:24Z", "path": "src/main/java/teammates/logic/core/FeedbackResponsesLogic.java", "diffHunk": "@@ -201,7 +201,7 @@ public boolean isNameVisibleToUser(\n         // Early return if user is giver\n         if (question.giverType == FeedbackParticipantType.TEAMS) {\n             // if response is given by team, then anyone in the team can see the response\n-            if (roster.isStudentsInSameTeam(response.giver, userEmail)) {\n+            if (roster.isStudentInTeam(userEmail, response.giver)) {", "originalCommit": "6a3b2ee79522ce16665876f7d78b907473bd32dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NTkyNg==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r455185926", "bodyText": "Don't close too soon. I think the fix is necessary? In addition, have you tried the legacy case where the response.giver is student's email?", "author": "xpdavid", "createdAt": "2020-07-15T16:41:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ0NjY1OA==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r455446658", "bodyText": "I don't know how to try the legacy case. I verified using the sequence described in the original issue with the uat server, and team responses did not show as anonymous.", "author": "madanalogy", "createdAt": "2020-07-16T00:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ0OTE3Mg==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r455449172", "bodyText": "You can:\n\nModify the current submission logic temporally to achieve that.\nModify the instructor demo data and create a new account", "author": "xpdavid", "createdAt": "2020-07-16T01:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0NTE1OA==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r455745158", "bodyText": "@xpdavid if we run the migration script now, would V6 still function correctly?", "author": "wkurniawan07", "createdAt": "2020-07-16T12:22:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkzNDQ3MA==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r455934470", "bodyText": "Yes. Both V6 and V7 has the ability to handle the scenarios.", "author": "xpdavid", "createdAt": "2020-07-16T16:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0OTc2MQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r456649761", "bodyText": "I am trying to understand in the legacy case where response.giver is an email. There will be a bug here?", "author": "xpdavid", "createdAt": "2020-07-17T20:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczMzUzOQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r456733539", "bodyText": "It depends on how the legacy team name was formulated. If it's just the email of the giver then this line might return false for everyone else in the team (other than the original giver).\n\n  \n    \n      teammates/src/main/java/teammates/common/datatransfer/CourseRoster.java\n    \n    \n        Lines 62 to 72\n      in\n      faf15f9\n    \n    \n    \n    \n\n        \n          \n           public boolean isStudentInTeam(String studentEmail, String targetTeamName) { \n        \n\n        \n          \n               StudentAttributes student = studentListByEmail.get(studentEmail); \n        \n\n        \n          \n               return student != null && student.team.equals(targetTeamName); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           public boolean isStudentsInSameTeam(String studentEmail1, String studentEmail2) { \n        \n\n        \n          \n               StudentAttributes student1 = studentListByEmail.get(studentEmail1); \n        \n\n        \n          \n               StudentAttributes student2 = studentListByEmail.get(studentEmail2); \n        \n\n        \n          \n               return student1 != null && student2 != null \n        \n\n        \n          \n                       && student1.team != null && student1.team.equals(student2.team); \n        \n\n        \n          \n           }", "author": "madanalogy", "createdAt": "2020-07-18T01:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczNDg4Mw==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r456734883", "bodyText": "It depends on how the legacy team name was formulated.\n\nThere is only one way if I am not wrong (The giver will be the email).\n\nIf it's just the email of the giver then this line might return false\n\nWhich is not correct? Should return true?", "author": "xpdavid", "createdAt": "2020-07-18T01:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczNTE4OQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r456735189", "bodyText": "Which is not correct? Should return true?\n\nYeap that sounds about right.\nGiven that this issue is no longer relevant (even with legacy data), any issues if I close it?", "author": "madanalogy", "createdAt": "2020-07-18T01:58:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MjM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczNTUxNQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r456735515", "bodyText": "The old code works for legacy data for team response.\nDoes it work for the new data (where giver is the team name)? It looks like a no to me.", "author": "xpdavid", "createdAt": "2020-07-18T02:01:46Z", "path": "src/main/java/teammates/logic/core/FeedbackResponsesLogic.java", "diffHunk": "@@ -201,7 +201,7 @@ public boolean isNameVisibleToUser(\n         // Early return if user is giver\n         if (question.giverType == FeedbackParticipantType.TEAMS) {\n             // if response is given by team, then anyone in the team can see the response\n-            if (roster.isStudentsInSameTeam(response.giver, userEmail)) {", "originalCommit": "2c805e88a6cf160e15348bc7e413ee948318cb3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczODM3Nw==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r456738377", "bodyText": "Okay I think I get it now haha, have pushed new code to check for both current and legacy cases", "author": "madanalogy", "createdAt": "2020-07-18T02:34:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczNTUxNQ=="}], "type": "inlineReview"}, {"oid": "2314eee14a93154245b73915619b6e438d577b1f", "url": "https://github.com/TEAMMATES/teammates/commit/2314eee14a93154245b73915619b6e438d577b1f", "message": "Add legacy logic management and test case", "committedDate": "2020-07-18T02:34:08Z", "type": "commit"}, {"oid": "2314eee14a93154245b73915619b6e438d577b1f", "url": "https://github.com/TEAMMATES/teammates/commit/2314eee14a93154245b73915619b6e438d577b1f", "message": "Add legacy logic management and test case", "committedDate": "2020-07-18T02:34:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc0OTYwNQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r456749605", "bodyText": "Remember to add comment explain the legacy case", "author": "xpdavid", "createdAt": "2020-07-18T04:56:00Z", "path": "src/main/java/teammates/logic/core/FeedbackResponsesLogic.java", "diffHunk": "@@ -201,7 +201,8 @@ public boolean isNameVisibleToUser(\n         // Early return if user is giver\n         if (question.giverType == FeedbackParticipantType.TEAMS) {\n             // if response is given by team, then anyone in the team can see the response\n-            if (roster.isStudentsInSameTeam(response.giver, userEmail)) {\n+            if (roster.isStudentInTeam(userEmail, response.giver)\n+                    || roster.isStudentsInSameTeam(userEmail, response.giver)) {", "originalCommit": "2314eee14a93154245b73915619b6e438d577b1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzMzEwMA==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r456833100", "bodyText": "If it is not too difficult, we can have a test for this", "author": "xpdavid", "createdAt": "2020-07-18T22:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc0OTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0NjMzNA==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r456846334", "bodyText": "How would I go about writing tests for this exactly? I had thought it was not necessary since the current tests already check for visibility.", "author": "madanalogy", "createdAt": "2020-07-19T01:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc0OTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0Njc0Ng==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r456846746", "bodyText": "The newly added condition is not covered right?", "author": "xpdavid", "createdAt": "2020-07-19T01:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc0OTYwNQ=="}], "type": "inlineReview"}, {"oid": "a324bea8f215be2894bc93952cadcc11900c8ae8", "url": "https://github.com/TEAMMATES/teammates/commit/a324bea8f215be2894bc93952cadcc11900c8ae8", "message": "Revert FeedbackSessionResultsTest.json", "committedDate": "2020-07-18T08:51:48Z", "type": "forcePushed"}, {"oid": "f5a84ba03e355551ec984fb04365730f50f1547a", "url": "https://github.com/TEAMMATES/teammates/commit/f5a84ba03e355551ec984fb04365730f50f1547a", "message": "Revert FeedbackSessionResultsTest.json and FeedbackSessionsLogicTest.java", "committedDate": "2020-07-18T08:55:00Z", "type": "commit"}, {"oid": "f5a84ba03e355551ec984fb04365730f50f1547a", "url": "https://github.com/TEAMMATES/teammates/commit/f5a84ba03e355551ec984fb04365730f50f1547a", "message": "Revert FeedbackSessionResultsTest.json and FeedbackSessionsLogicTest.java", "committedDate": "2020-07-18T08:55:00Z", "type": "forcePushed"}, {"oid": "c985c97e86bc052f3e7423d7f049360d13e29305", "url": "https://github.com/TEAMMATES/teammates/commit/c985c97e86bc052f3e7423d7f049360d13e29305", "message": "Add comment", "committedDate": "2020-07-18T08:59:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA2ODE0OA==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r457068148", "bodyText": "This test case is ineffective because the question's giver type here is SELF.", "author": "wkurniawan07", "createdAt": "2020-07-20T05:36:58Z", "path": "src/test/java/teammates/test/cases/logic/FeedbackResponsesLogicTest.java", "diffHunk": "@@ -423,6 +423,8 @@ public void testIsNameVisibleTo() {\n \n         fr.giver = student.email;\n         assertTrue(frLogic.isNameVisibleToUser(fq, fr, student.email, UserRole.STUDENT, false, roster));\n+        fr.giver = student.team;\n+        assertTrue(frLogic.isNameVisibleToUser(fq, fr, student.email, UserRole.STUDENT, false, roster));", "originalCommit": "eafdb6a2c9871d72093599b34e1c00ec9c8e6a60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e8a88131d7dc84630272a2cd93a91c23582d909c", "url": "https://github.com/TEAMMATES/teammates/commit/e8a88131d7dc84630272a2cd93a91c23582d909c", "message": "Add response logic test", "committedDate": "2020-07-20T16:15:07Z", "type": "commit"}, {"oid": "e8a88131d7dc84630272a2cd93a91c23582d909c", "url": "https://github.com/TEAMMATES/teammates/commit/e8a88131d7dc84630272a2cd93a91c23582d909c", "message": "Add response logic test", "committedDate": "2020-07-20T16:15:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMTgwNw==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r458531807", "bodyText": "Need a new ______TS header here", "author": "wkurniawan07", "createdAt": "2020-07-22T04:47:42Z", "path": "src/test/java/teammates/test/cases/logic/FeedbackResponsesLogicTest.java", "diffHunk": "@@ -451,6 +451,24 @@ public void testIsNameVisibleTo() {\n         assertTrue(frLogic.isNameVisibleToUser(fq, fr, student3.email, UserRole.STUDENT, false, roster));\n         assertFalse(frLogic.isNameVisibleToUser(fq, fr, student5.email, UserRole.STUDENT, false, roster));\n \n+        fq.recipientType = FeedbackParticipantType.TEAMS;", "originalCommit": "e8a88131d7dc84630272a2cd93a91c23582d909c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMTk5MA==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r458531990", "bodyText": "You meant the first check? The second check is the pre-existing one", "author": "wkurniawan07", "createdAt": "2020-07-22T04:48:21Z", "path": "src/main/java/teammates/logic/core/FeedbackResponsesLogic.java", "diffHunk": "@@ -201,7 +201,9 @@ public boolean isNameVisibleToUser(\n         // Early return if user is giver\n         if (question.giverType == FeedbackParticipantType.TEAMS) {\n             // if response is given by team, then anyone in the team can see the response\n-            if (roster.isStudentsInSameTeam(response.giver, userEmail)) {\n+            // The second check is used to accommodate legacy data where team giver is a student email", "originalCommit": "e8a88131d7dc84630272a2cd93a91c23582d909c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMjk2Nw==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r458532967", "bodyText": "Yea, the pre-existing one is the one that's catering to legacy data I think. That's why @xpdavid suggested going ahead with this PR even though the session logic refactor meant that the original issue is no longer relevant", "author": "madanalogy", "createdAt": "2020-07-22T04:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMTk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMzU0NQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10314#discussion_r458533545", "bodyText": "I see, got it", "author": "wkurniawan07", "createdAt": "2020-07-22T04:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMTk5MA=="}], "type": "inlineReview"}, {"oid": "2a6ae0bd963cd61ad09b6724ece2172e178b1af8", "url": "https://github.com/TEAMMATES/teammates/commit/2a6ae0bd963cd61ad09b6724ece2172e178b1af8", "message": "Add test case description", "committedDate": "2020-07-22T11:52:39Z", "type": "commit"}, {"oid": "ec4de3d3625ae83c1389b20e3c43a7d87a44b935", "url": "https://github.com/TEAMMATES/teammates/commit/ec4de3d3625ae83c1389b20e3c43a7d87a44b935", "message": "Merge branch 'master' into 9823-9826-anon", "committedDate": "2020-07-22T13:05:54Z", "type": "commit"}]}