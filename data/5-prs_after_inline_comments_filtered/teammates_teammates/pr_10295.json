{"pr_number": 10295, "pr_title": "[#10264] Remove Instructor Google ID from Output", "pr_createdAt": "2020-07-10T09:06:42Z", "pr_url": "https://github.com/TEAMMATES/teammates/pull/10295", "timeline": [{"oid": "11c01a963e339de47bb195bfceedef71681f4f00", "url": "https://github.com/TEAMMATES/teammates/commit/11c01a963e339de47bb195bfceedef71681f4f00", "message": "Add frontend accommodation and tests for null googleId", "committedDate": "2020-07-13T02:39:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQxODI0Nw==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453418247", "bodyText": "After much debugging I've isolated the problem with the e2e tests to the addition of this line. Whenever verifyPresentInDatastore is called in a test case for instructors, the BackDoor will attempt to execute a GET request on the /instructors endpoint. This will now however always throw a NPE because userInfo.getId() is null. Any advice to help resolve this would be appreciated @wkurniawan07 @xpdavid @jtankw3", "author": "madanalogy", "createdAt": "2020-07-13T03:39:53Z", "path": "src/main/java/teammates/ui/webapi/action/GetInstructorsAction.java", "diffHunk": "@@ -76,7 +77,18 @@ public ActionResult execute() {\n             });\n         } else if (intentStr.equals(Intent.FULL_DETAIL.toString())) {\n             // get all instructors of a course without information hiding\n-            data = new InstructorsData(instructorsOfCourse);\n+            // adds googleId if caller is course co-owner or admin\n+            if (userInfo.isAdmin || logic.getInstructorForGoogleId(courseId, userInfo.getId()).getRole().equals(\n+                    Const.InstructorPermissionRoleNames.INSTRUCTOR_PERMISSION_ROLE_COOWNER)) {", "originalCommit": "11c01a963e339de47bb195bfceedef71681f4f00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQyMDI4MQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453420281", "bodyText": "We can add userInfo != null first?", "author": "xpdavid", "createdAt": "2020-07-13T03:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQxODI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQyMzI5MQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453423291", "bodyText": "I was hoping against that because the getMinAuthLevel is already defined as LOGGED_IN. There appears to be another issue as well with UpdateInstructorAction. I'm working with @jtankw3 to help resolve it", "author": "madanalogy", "createdAt": "2020-07-13T04:04:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQxODI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQyMzgwMA==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453423800", "bodyText": "By design, the execute() method should not care about access control (this is the complete seperation of access control we want to achieve in V7) so we are not breaking any promise.", "author": "xpdavid", "createdAt": "2020-07-13T04:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQxODI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1NTgzNQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453655835", "bodyText": "The previous implementation is DRY, this one is not. Should only add some line of code to populate Google ID when necessary, e.g.\nif (instructorAttributes == null) {\n    return new JsonResult(\"Instructor could not be found for this course\", HttpStatus.SC_NOT_FOUND);\n}\n\nInstructorData instructorData = new InstructorData(instructorAttributes);\nif (intent == Intent.FULL_DETAIL) {\n    instructorData.setGoogleId(instructorAttributes.googleId);\n}\n\nreturn new JsonResult(instructorData);", "author": "wkurniawan07", "createdAt": "2020-07-13T13:38:48Z", "path": "src/main/java/teammates/ui/webapi/action/GetInstructorAction.java", "diffHunk": "@@ -51,24 +51,32 @@ public ActionResult execute() {\n         Intent intent = Intent.valueOf(getNonNullRequestParamValue(Const.ParamsNames.INTENT));\n \n         InstructorAttributes instructorAttributes;\n+        InstructorData instructorData;\n         String courseId = getNonNullRequestParamValue(Const.ParamsNames.COURSE_ID);\n \n         switch (intent) {\n         case INSTRUCTOR_SUBMISSION:\n             instructorAttributes = getInstructorOfCourseFromRequest(courseId);\n+            if (instructorAttributes == null) {\n+                return new JsonResult(\"Instructor could not be found for this course\",\n+                        HttpStatus.SC_NOT_FOUND);\n+            }\n+            instructorData = new InstructorData(instructorAttributes);\n             break;\n         case FULL_DETAIL:\n             instructorAttributes = logic.getInstructorForGoogleId(courseId, userInfo.getId());\n+            if (instructorAttributes == null) {\n+                return new JsonResult(\"Instructor could not be found for this course\",\n+                        HttpStatus.SC_NOT_FOUND);\n+            }\n+            instructorData = new InstructorData(instructorAttributes);\n+            instructorData.setGoogleId(instructorAttributes.googleId);\n             break;\n         default:\n             throw new InvalidHttpParameterException(\"Unknown intent \" + intent);\n         }\n \n-        if (instructorAttributes == null) {\n-            return new JsonResult(\"Instructor could not be found for this course\", HttpStatus.SC_NOT_FOUND);\n-        }\n-\n-        return new JsonResult(new InstructorData(instructorAttributes));", "originalCommit": "57e98290d4447d22918c757ec5a92bef786eca26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1NzQ4MA==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453657480", "bodyText": "This might actually count as Google ID leaking, but I guess someone who has the privilege of updating instructor has no harm of knowing the Google ID.", "author": "wkurniawan07", "createdAt": "2020-07-13T13:41:08Z", "path": "src/main/java/teammates/ui/webapi/action/UpdateInstructorAction.java", "diffHunk": "@@ -69,7 +69,9 @@ public ActionResult execute() {\n                                 .withRole(instructorToEdit.role)\n                                 .build());\n             }\n-            return new JsonResult(new InstructorData(updatedInstructor));\n+            InstructorData newInstructorData = new InstructorData(updatedInstructor);\n+            newInstructorData.setGoogleId(updatedInstructor.getGoogleId());\n+            return new JsonResult(newInstructorData);", "originalCommit": "57e98290d4447d22918c757ec5a92bef786eca26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1NzY3NA==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453657674", "bodyText": "All the changes in this file are unrelated", "author": "wkurniawan07", "createdAt": "2020-07-13T13:41:26Z", "path": "src/test/java/teammates/test/cases/webapi/SearchInstructorsActionTest.java", "diffHunk": "@@ -52,9 +52,7 @@ protected void testExecute_searchCourseId_shouldSucceed() {\n         JsonResult result = getJsonResult(action);\n         InstructorsData response = (InstructorsData) result.getOutput();\n         assertTrue(response.getInstructors().stream()\n-                .filter(i -> i.getName().equals(acc.getName()))\n-                .findAny()\n-                .isPresent());\n+                .anyMatch(i -> i.getName().equals(acc.getName())));", "originalCommit": "57e98290d4447d22918c757ec5a92bef786eca26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1ODc1Mg==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453658752", "bodyText": "Do we still need this USER_ID parameter, now that you are guaranteed to be admin if using the backdoor method?", "author": "wkurniawan07", "createdAt": "2020-07-13T13:42:59Z", "path": "src/e2e/java/teammates/e2e/util/BackDoor.java", "diffHunk": "@@ -333,9 +333,10 @@ public static CourseAttributes getArchivedCourse(String instructorId, String cou\n     /**\n      * Gets instructor data from the datastore.\n      */\n-    public static InstructorData getInstructorData(String courseId, String email) {\n+    public static InstructorData getInstructorData(String courseId, String instructorId, String email) {\n         Map<String, String[]> params = new HashMap<>();\n         params.put(Const.ParamsNames.COURSE_ID, new String[] { courseId });\n+        params.put(Const.ParamsNames.USER_ID, new String[] { instructorId });", "originalCommit": "57e98290d4447d22918c757ec5a92bef786eca26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1OTExNQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453659115", "bodyText": "We might need to be able to customize this, but it is for another time.", "author": "wkurniawan07", "createdAt": "2020-07-13T13:43:30Z", "path": "src/main/java/teammates/ui/webapi/action/Action.java", "diffHunk": "@@ -98,6 +98,9 @@ private void initAuthInfo() {\n         if (Config.BACKDOOR_KEY.equals(req.getHeader(\"Backdoor-Key\"))) {\n             authType = AuthType.ALL_ACCESS;\n             userInfo = new UserInfo(getRequestParamValue(Const.ParamsNames.USER_ID));\n+            userInfo.isAdmin = true;\n+            userInfo.isStudent = true;\n+            userInfo.isInstructor = true;", "originalCommit": "57e98290d4447d22918c757ec5a92bef786eca26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2MDE5OA==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453660198", "bodyText": "Registration key should be asserted as null also", "author": "wkurniawan07", "createdAt": "2020-07-13T13:44:58Z", "path": "src/test/java/teammates/test/cases/webapi/GetInstructorActionTest.java", "diffHunk": "@@ -59,6 +59,7 @@ protected void testExecute() throws Exception {\n         assertEquals(HttpStatus.SC_OK, actionOutput.getStatusCode());\n         InstructorData response = (InstructorData) actionOutput.getOutput();\n         assertEquals(instructor1OfCourse1.name, response.getName());\n+        assertNull(response.getGoogleId());", "originalCommit": "57e98290d4447d22918c757ec5a92bef786eca26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2MDcxMA==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r453660710", "bodyText": "Only admins can search instructors, and we have no reason to hide anything from admin. This line can be removed.", "author": "wkurniawan07", "createdAt": "2020-07-13T13:45:41Z", "path": "src/main/java/teammates/ui/webapi/action/SearchInstructorsAction.java", "diffHunk": "@@ -49,7 +49,8 @@ public ActionResult execute() {\n             InstructorData instructorData = new InstructorData(instructor);\n             instructorData.addAdditionalInformationForAdminSearch(\n                     StringHelper.encrypt(instructor.getKey()),\n-                    getInstituteFromGoogleId(instructor.getGoogleId()));\n+                    getInstituteFromGoogleId(instructor.getGoogleId()),\n+                    instructor.getGoogleId());\n             instructorData.hideInformationForSearch();", "originalCommit": "57e98290d4447d22918c757ec5a92bef786eca26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b256b7618c1270985701a75eeeadf00ae15a2df0", "url": "https://github.com/TEAMMATES/teammates/commit/b256b7618c1270985701a75eeeadf00ae15a2df0", "message": "Remove Instructor Google ID from Output", "committedDate": "2020-07-14T15:45:41Z", "type": "forcePushed"}, {"oid": "5d37b62c4f67d6a9f2b6f2307ad8691a90961861", "url": "https://github.com/TEAMMATES/teammates/commit/5d37b62c4f67d6a9f2b6f2307ad8691a90961861", "message": "Remove instructor googleId from output", "committedDate": "2020-07-14T15:49:08Z", "type": "commit"}, {"oid": "5d37b62c4f67d6a9f2b6f2307ad8691a90961861", "url": "https://github.com/TEAMMATES/teammates/commit/5d37b62c4f67d6a9f2b6f2307ad8691a90961861", "message": "Remove instructor googleId from output", "committedDate": "2020-07-14T15:49:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgwMjkzNQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10295#discussion_r454802935", "bodyText": "I have checked the access control logic again. It is not necessarily only co-owner can see the Google ID, but rather anyone who has canmodifyinstructor permission.", "author": "wkurniawan07", "createdAt": "2020-07-15T05:36:15Z", "path": "src/main/java/teammates/ui/webapi/action/GetInstructorsAction.java", "diffHunk": "@@ -76,7 +77,18 @@ public ActionResult execute() {\n             });\n         } else if (intentStr.equals(Intent.FULL_DETAIL.toString())) {\n             // get all instructors of a course without information hiding\n-            data = new InstructorsData(instructorsOfCourse);\n+            // adds googleId if caller is course co-owner or admin\n+            if (userInfo.isAdmin || logic.getInstructorForGoogleId(courseId, userInfo.getId()).getRole().equals(\n+                    Const.InstructorPermissionRoleNames.INSTRUCTOR_PERMISSION_ROLE_COOWNER)) {", "originalCommit": "5d37b62c4f67d6a9f2b6f2307ad8691a90961861", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e16a8a573dc384296b94b7afe4dadc6d046c4520", "url": "https://github.com/TEAMMATES/teammates/commit/e16a8a573dc384296b94b7afe4dadc6d046c4520", "message": "Change access control to appropriate permission", "committedDate": "2020-07-15T12:58:42Z", "type": "commit"}, {"oid": "2b242609db12eb357301193c5ac721332a1289ea", "url": "https://github.com/TEAMMATES/teammates/commit/2b242609db12eb357301193c5ac721332a1289ea", "message": "Merge branch 'master' into 10264-instructor", "committedDate": "2020-07-15T13:10:04Z", "type": "commit"}]}