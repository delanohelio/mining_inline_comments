{"pr_number": 7568, "pr_title": "Feature/virtual scroller", "pr_createdAt": "2020-08-11T19:57:49Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7568", "timeline": [{"oid": "621aa43a469c0ef27d4f2ff4136fa156b969e0a6", "url": "https://github.com/rstudio/rstudio/commit/621aa43a469c0ef27d4f2ff4136fa156b969e0a6", "message": "stash commit", "committedDate": "2020-07-17T18:29:08Z", "type": "commit"}, {"oid": "5cdf7a15d67ef52e7c88c71ecc165960a8f91797", "url": "https://github.com/rstudio/rstudio/commit/5cdf7a15d67ef52e7c88c71ecc165960a8f91797", "message": "virtualized scroller for ace_scroller elements", "committedDate": "2020-08-11T00:05:46Z", "type": "commit"}, {"oid": "b64dbee9c634d84b15c48fb3a0daa62e73f3c023", "url": "https://github.com/rstudio/rstudio/commit/b64dbee9c634d84b15c48fb3a0daa62e73f3c023", "message": "merge", "committedDate": "2020-08-11T17:18:10Z", "type": "commit"}, {"oid": "e6fd0a234e26e9870148e5e7d27cdd6399505da5", "url": "https://github.com/rstudio/rstudio/commit/e6fd0a234e26e9870148e5e7d27cdd6399505da5", "message": "clear console fix", "committedDate": "2020-08-11T19:02:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NTU2NQ==", "url": "https://github.com/rstudio/rstudio/pull/7568#discussion_r468875565", "bodyText": "Nit: VirtualConsole. prefix is unnecessary (here and elsewhere)", "author": "jmcphers", "createdAt": "2020-08-11T21:29:12Z", "path": "src/gwt/src/org/rstudio/core/client/VirtualConsole.java", "diffHunk": "@@ -75,18 +82,63 @@ public boolean screenReaderEnabled()\n       {\n          return getUserPrefs().enableScreenReader().getValue();\n       }\n+\n+      @Override\n+      public boolean limitConsoleVisible()\n+      {\n+         return getUserPrefs().limitVisibleConsole().getValue();\n+      }\n    }\n \n    @Inject\n    public VirtualConsole(@Assisted Element parent, final Preferences prefs)\n    {\n       prefs_ = prefs;\n       parent_ = parent;\n+\n+      // only load the virtual scroller if enabled in prefs\n+      if (prefs_.limitConsoleVisible() &&\n+          parent_ != null &&\n+          !VirtualConsole.virtualScrollerInitialized_ &&", "originalCommit": "e6fd0a234e26e9870148e5e7d27cdd6399505da5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxNzcxNw==", "url": "https://github.com/rstudio/rstudio/pull/7568#discussion_r469617717", "bodyText": "I really like prefixing it to make it explicit that we're referencing something static but if it's not how we do it in our style guide that's fine.", "author": "adamconroy", "createdAt": "2020-08-13T00:17:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NTU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NzIzMQ==", "url": "https://github.com/rstudio/rstudio/pull/7568#discussion_r468877231", "bodyText": "Maybe I'm misreading this, but wouldn't we need one instance of VirtualScrollerNative per VirtualConsole?", "author": "jmcphers", "createdAt": "2020-08-11T21:32:34Z", "path": "src/gwt/src/org/rstudio/core/client/VirtualConsole.java", "diffHunk": "@@ -698,6 +761,20 @@ public String debugDump()\n       public final SpanElement element;\n    }\n \n+   interface Resources extends ClientBundle\n+   {\n+      @Source(\"./virtualscroller/virtualscroller.js\")\n+      TextResource virtualScrollerCode();\n+   }\n+\n+   private static final Resources RES = GWT.create(Resources.class);\n+\n+   private static final ExternalJavaScriptLoader virtualScrollerLoader_ =\n+      new ExternalJavaScriptLoader(VirtualScrollerResources.INSTANCE.virtualscrollerjs().getSafeUri().asString());\n+   private static VirtualScrollerNative virtualScrollerNative_;", "originalCommit": "e6fd0a234e26e9870148e5e7d27cdd6399505da5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxOTQwNA==", "url": "https://github.com/rstudio/rstudio/pull/7568#discussion_r469619404", "bodyText": "Addressed in the commit I just pushed. Unfortunately just making it an instance variable wasn't an option as the way that VirtualConsole works is frankly kind of broken. A new instance is created pretty much any time you hit enter and there's a lot of cases where it's created with a null parent. I tried to decouple it from Gin but I wasn't able to make a clean break there so I wholly detached VirtualScroller from the VirtualConsole, which I prefer anyway.", "author": "adamconroy", "createdAt": "2020-08-13T00:19:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NzIzMQ=="}], "type": "inlineReview"}, {"oid": "9935ac4445b47ebbbbc8c72fa1bcf4ae87e24bac", "url": "https://github.com/rstudio/rstudio/commit/9935ac4445b47ebbbbc8c72fa1bcf4ae87e24bac", "message": "PR feedback for virtual scroller. refactor to use the VirtualScrollerManager", "committedDate": "2020-08-13T00:14:29Z", "type": "commit"}, {"oid": "aa0953ac7466cb4e31d63edaea30913ebcc3134f", "url": "https://github.com/rstudio/rstudio/commit/aa0953ac7466cb4e31d63edaea30913ebcc3134f", "message": "add overrides for FakePrefs to tests compile", "committedDate": "2020-08-13T21:18:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI3NzI4NA==", "url": "https://github.com/rstudio/rstudio/pull/7568#discussion_r470277284", "bodyText": "You can replace this if/else with a single call to restartRequirement.setRestartRequired() (added fairly recently).", "author": "gtritchie", "createdAt": "2020-08-13T22:11:32Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/ConsolePreferencesPane.java", "diffHunk": "@@ -103,6 +106,17 @@ public RestartRequirement onApply(UserPrefs prefs)\n          initialHighlightConsoleErrors_ = prefs_.highlightConsoleErrors().getValue();\n          restartRequirement.setRestartRequired();\n       }\n+      if (!restartRequirement.getDesktopRestartRequired() && !restartRequirement.getUiReloadRequired())\n+      {\n+         if (prefs_.limitVisibleConsole().getValue() != initialLimitVisibleConsole_)\n+         {\n+            initialLimitVisibleConsole_ = prefs_.limitVisibleConsole().getValue();\n+            if (Desktop.isDesktop())", "originalCommit": "aa0953ac7466cb4e31d63edaea30913ebcc3134f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI3ODUzNg==", "url": "https://github.com/rstudio/rstudio/pull/7568#discussion_r470278536", "bodyText": "nit, we usually put else on a separate line", "author": "gtritchie", "createdAt": "2020-08-13T22:14:42Z", "path": "src/gwt/src/org/rstudio/core/client/VirtualConsole.java", "diffHunk": "@@ -203,18 +230,17 @@ public Element getParent()\n     */\n    private void appendText(String text, String clazz, boolean forceNewRange)\n    {\n-      Entry <Integer, ClassRange> last = class_.lastEntry();\n+      Entry<Integer, ClassRange> last = class_.lastEntry();\n       ClassRange range = last.getValue();\n       if (!forceNewRange && StringUtil.equals(range.clazz, clazz))\n       {\n          // just append to the existing output stream\n          range.appendRight(text, 0);\n-      }\n-      else\n+      } else", "originalCommit": "aa0953ac7466cb4e31d63edaea30913ebcc3134f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI4MTUxOQ==", "url": "https://github.com/rstudio/rstudio/pull/7568#discussion_r470281519", "bodyText": "As discussed elsewhere, be great to have some unit-tests for the virtual scrolling mechanism here and/or in the ConsoleOutputWriteTests.", "author": "gtritchie", "createdAt": "2020-08-13T22:22:43Z", "path": "src/gwt/test/org/rstudio/core/client/VirtualConsoleTests.java", "diffHunk": "@@ -55,7 +55,14 @@ public boolean screenReaderEnabled()\n       {\n          return screenReaderEnabled_;\n       }\n-      \n+\n+      @Override\n+      public boolean limitConsoleVisible()\n+      {\n+         return limitConsoleVisible_;", "originalCommit": "aa0953ac7466cb4e31d63edaea30913ebcc3134f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyMDEwMA==", "url": "https://github.com/rstudio/rstudio/pull/7568#discussion_r471620100", "bodyText": "nit: missing comment header", "author": "kevinushey", "createdAt": "2020-08-17T17:06:28Z", "path": "src/gwt/src/org/rstudio/core/client/virtualscroller/VirtualScrollerManager.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package org.rstudio.core.client.virtualscroller;", "originalCommit": "aa0953ac7466cb4e31d63edaea30913ebcc3134f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzMjg4OA==", "url": "https://github.com/rstudio/rstudio/pull/7568#discussion_r471632888", "bodyText": "Should we clear the loading_ flag here? (doesn't look like it effects correctness but would be consistent?)", "author": "kevinushey", "createdAt": "2020-08-17T17:17:07Z", "path": "src/gwt/src/org/rstudio/core/client/virtualscroller/VirtualScrollerManager.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package org.rstudio.core.client.virtualscroller;\n+\n+import com.google.gwt.core.client.JavaScriptException;\n+\n+import java.util.Date;\n+import java.util.HashMap;\n+import com.google.gwt.dom.client.Element;\n+import org.rstudio.core.client.Debug;\n+import org.rstudio.core.client.ExternalJavaScriptLoader;\n+import org.rstudio.core.client.theme.res.ThemeStyles;\n+\n+public class VirtualScrollerManager\n+{\n+   public static void init()\n+   {\n+      if (!initialized_ && !loading_)\n+      {\n+         scrollers_ = new HashMap<>();\n+         loading_ = true;\n+         virtualScrollerLoader_.addCallback(() -> {\n+            try\n+            {\n+               initialized_ = true;\n+               loading_ = false;\n+            }\n+            catch (JavaScriptException e)\n+            {\n+               // If we get an error initializing the virtualScroller, log\n+               // and no-op the error to continue non-virtualized\n+               Debug.log(e.getMessage());", "originalCommit": "aa0953ac7466cb4e31d63edaea30913ebcc3134f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aa04328a68aac1368ce899bc7627fa28413b7c7c", "url": "https://github.com/rstudio/rstudio/commit/aa04328a68aac1368ce899bc7627fa28413b7c7c", "message": "Nit PR feedback", "committedDate": "2020-08-20T20:25:07Z", "type": "commit"}, {"oid": "aacc3fba71bd0146a5cdcb33ed4cf3f8e5e919fe", "url": "https://github.com/rstudio/rstudio/commit/aacc3fba71bd0146a5cdcb33ed4cf3f8e5e919fe", "message": "Nit PR feedback", "committedDate": "2020-08-20T20:26:16Z", "type": "commit"}, {"oid": "3c00cf6bd0780e1c9244946d45f5b27faf9025cc", "url": "https://github.com/rstudio/rstudio/commit/3c00cf6bd0780e1c9244946d45f5b27faf9025cc", "message": "merge", "committedDate": "2020-08-20T20:28:13Z", "type": "commit"}, {"oid": "73e25089ad40c6fdf7bdba7db22a792924d2cb91", "url": "https://github.com/rstudio/rstudio/commit/73e25089ad40c6fdf7bdba7db22a792924d2cb91", "message": "VirtualScroller PR feedback", "committedDate": "2020-08-28T21:09:23Z", "type": "commit"}]}