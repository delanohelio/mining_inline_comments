{"pr_number": 6848, "pr_title": "Add RStudio Command Palette", "pr_createdAt": "2020-05-11T16:34:33Z", "pr_url": "https://github.com/rstudio/rstudio/pull/6848", "timeline": [{"oid": "2836e8fbbb68206bdcbf31a2bcb4a68c22db9a49", "url": "https://github.com/rstudio/rstudio/commit/2836e8fbbb68206bdcbf31a2bcb4a68c22db9a49", "message": "basic command filtering and execution", "committedDate": "2020-05-05T18:42:20Z", "type": "commit"}, {"oid": "1dcf4a75c33a7c6917b465444da7c1038c70a80a", "url": "https://github.com/rstudio/rstudio/commit/1dcf4a75c33a7c6917b465444da7c1038c70a80a", "message": "add commands from addins", "committedDate": "2020-05-05T23:28:52Z", "type": "commit"}, {"oid": "acb0096c9fae5e7bd0acdc9281f51bd71e3cfb9d", "url": "https://github.com/rstudio/rstudio/commit/acb0096c9fae5e7bd0acdc9281f51bd71e3cfb9d", "message": "show package for addin commands; start dark mode", "committedDate": "2020-05-06T01:45:02Z", "type": "commit"}, {"oid": "ca2bdff07b0efd0a519c45159efa03057ee5eeb4", "url": "https://github.com/rstudio/rstudio/commit/ca2bdff07b0efd0a519c45159efa03057ee5eeb4", "message": "ensure selected command is visible", "committedDate": "2020-05-06T04:46:10Z", "type": "commit"}, {"oid": "c6d17c08dd3c182e79085f9930c27e56ea605d15", "url": "https://github.com/rstudio/rstudio/commit/c6d17c08dd3c182e79085f9930c27e56ea605d15", "message": "click to invoke commands", "committedDate": "2020-05-07T16:15:21Z", "type": "commit"}, {"oid": "bc004c138d0d00782ed9617db1b0ee62a59c566b", "url": "https://github.com/rstudio/rstudio/commit/bc004c138d0d00782ed9617db1b0ee62a59c566b", "message": "show context for all commands; deferred init", "committedDate": "2020-05-07T17:39:23Z", "type": "commit"}, {"oid": "1b725a7a5aac57eb909083e72cd19424ab9942eb", "url": "https://github.com/rstudio/rstudio/commit/1b725a7a5aac57eb909083e72cd19424ab9942eb", "message": "ensure styles are injected before palette is loaded", "committedDate": "2020-05-07T18:08:25Z", "type": "commit"}, {"oid": "f33da07cddefd5e14db1a6b82896ff39ad3d07ba", "url": "https://github.com/rstudio/rstudio/commit/f33da07cddefd5e14db1a6b82896ff39ad3d07ba", "message": "allow repeating arrow keys", "committedDate": "2020-05-07T20:35:23Z", "type": "commit"}, {"oid": "6c7331c774cb7f7f334798a29c325a520ec553af", "url": "https://github.com/rstudio/rstudio/commit/6c7331c774cb7f7f334798a29c325a520ec553af", "message": "so stylish", "committedDate": "2020-05-07T21:21:46Z", "type": "commit"}, {"oid": "6d97055fe458c24ae5622656aea3dcabb075816a", "url": "https://github.com/rstudio/rstudio/commit/6d97055fe458c24ae5622656aea3dcabb075816a", "message": "flex layout to the rescue", "committedDate": "2020-05-07T21:55:09Z", "type": "commit"}, {"oid": "a3484e118fc0f5c66b53f4f58b8ea7e43b105c67", "url": "https://github.com/rstudio/rstudio/commit/a3484e118fc0f5c66b53f4f58b8ea7e43b105c67", "message": "implement accessibility roles", "committedDate": "2020-05-07T23:16:05Z", "type": "commit"}, {"oid": "96a3fceca495b2e8d05eb0ff68c0c98d2c13db9f", "url": "https://github.com/rstudio/rstudio/commit/96a3fceca495b2e8d05eb0ff68c0c98d2c13db9f", "message": "override default up/down behavior in textbox", "committedDate": "2020-05-07T23:59:47Z", "type": "commit"}, {"oid": "b15f32c25c95b7b1688f1cfc64917b449f09996e", "url": "https://github.com/rstudio/rstudio/commit/b15f32c25c95b7b1688f1cfc64917b449f09996e", "message": "Merge remote-tracking branch 'origin/master' into feature/command-palette", "committedDate": "2020-05-08T16:05:39Z", "type": "commit"}, {"oid": "4229f700445769243cff8ab5212627598ee00174", "url": "https://github.com/rstudio/rstudio/commit/4229f700445769243cff8ab5212627598ee00174", "message": "partial fuzzy matching; hide unavailable commands", "committedDate": "2020-05-08T18:18:17Z", "type": "commit"}, {"oid": "0eef649af7d6220550074d4e64fd161f965f0e19", "url": "https://github.com/rstudio/rstudio/commit/0eef649af7d6220550074d4e64fd161f965f0e19", "message": "reentrancy guards; shuffle keyboard shortcuts", "committedDate": "2020-05-08T23:45:30Z", "type": "commit"}, {"oid": "66ccb43191ed4e70ceabcc8ca7b1d409627503c4", "url": "https://github.com/rstudio/rstudio/commit/66ccb43191ed4e70ceabcc8ca7b1d409627503c4", "message": "show something reasonable when no matches are found", "committedDate": "2020-05-09T00:06:40Z", "type": "commit"}, {"oid": "e5f004557dced59d233323b955617eb0137e05a8", "url": "https://github.com/rstudio/rstudio/commit/e5f004557dced59d233323b955617eb0137e05a8", "message": "Merge remote-tracking branch 'origin/master' into feature/command-palette", "committedDate": "2020-05-11T16:05:51Z", "type": "commit"}, {"oid": "f1c5290effbb3657e9c5c4f83dde309d9db74f29", "url": "https://github.com/rstudio/rstudio/commit/f1c5290effbb3657e9c5c4f83dde309d9db74f29", "message": "fix display when there are overlapping matches", "committedDate": "2020-05-11T17:29:14Z", "type": "commit"}, {"oid": "3cdfa547177fa5d2f19085cd13994b4b3d44c6ac", "url": "https://github.com/rstudio/rstudio/commit/3cdfa547177fa5d2f19085cd13994b4b3d44c6ac", "message": "improve focus semantics with ModalPopupPanel", "committedDate": "2020-05-11T23:59:44Z", "type": "commit"}, {"oid": "81b6592da9bba2b3e77a0cbf965e3fd3d3226306", "url": "https://github.com/rstudio/rstudio/commit/81b6592da9bba2b3e77a0cbf965e3fd3d3226306", "message": "add more ARIA roles to appropriate elements", "committedDate": "2020-05-12T00:10:49Z", "type": "commit"}, {"oid": "94806c66908573644384e7082e71036c6c49f936", "url": "https://github.com/rstudio/rstudio/commit/94806c66908573644384e7082e71036c6c49f936", "message": "Merge remote-tracking branch 'origin/master' into feature/command-palette", "committedDate": "2020-05-12T22:27:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MjE1Ng==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424072156", "bodyText": "Putting the highlights into a separate span (for visual highlighting) can cause a slight pause in awkward locations during screen-reader output, e.g. type \"Mar\" then when reading \"markdown\" it will say \"mar...kdown\". To fix we could consider constructing a separate aria-label of the raw text, perhaps only if screen reader support is enabled. That is probably overkill probably best to wait until we've got actual feedback saying it's a real issue.", "author": "gtritchie", "createdAt": "2020-05-12T22:34:24Z", "path": "src/gwt/src/org/rstudio/core/client/SafeHtmlUtil.java", "diffHunk": "@@ -165,5 +168,120 @@ public static void highlightSearchMatch(SafeHtmlBuilder sb, String haystack,\n       if (!hasMatch)\n          sb.appendEscaped(haystack);\n    }\n+\n+   /**\n+    * Appends text to a SafeHtmlBuilder with multiple search matches highlighted.\n+    * \n+    * @param sb The SafeHtmlBuilder to append the search match to\n+    * @param haystack The text to append. \n+    * @param needles The strings to search for and highlight.\n+    * @param matchClass The CSS class to assign to matches.\n+    */\n+   public static void highlightSearchMatch(SafeHtmlBuilder sb, String haystack, \n+                                           String[] needles, String matchClass)\n+   {\n+      // Do nothing if we weren't given a string\n+      if (StringUtil.isNullOrEmpty(haystack))\n+         return;\n+      \n+      // Inner class representing a search match found in the haystack\n+      class SearchMatch\n+      {\n+         public SearchMatch(int indexIn, int lengthIn)\n+         {\n+            index = indexIn;\n+            length = lengthIn;\n+         }\n+         public Integer index;\n+         public Integer length;\n+      };\n+      \n+      // Store matches in a tree set ordered by the index at which the match was\n+      // found.\n+      Set<SearchMatch> matches = new TreeSet<SearchMatch>(\n+            (SearchMatch o1, SearchMatch o2) -> {\n+                  return o1.index.compareTo(o2.index);\n+            });\n+\n+      // Find all the matches and add them to the result set.\n+      for (int i = 0; i < needles.length; i++)\n+      {\n+         int idx = haystack.toLowerCase().indexOf(needles[i]);\n+         if (idx >= 0)\n+         {\n+            int endIdx = idx + needles[i].length();\n+\n+            // Check the existing set of matches; if this overlaps with an\n+            // existing match we don't want to create overlapping match results.\n+            boolean overlaps = false;\n+            for (SearchMatch match: matches)\n+            {\n+               if (match.index >= endIdx)\n+               {\n+                  // Performance optimization: neither this match nor any\n+                  // following can overlap since it starts after this match ends\n+                  // (and matches are sorted by start index.)\n+                  break;\n+               }\n+\n+               // If this match overlaps an existing match, merge it into that\n+               // match instead of creating a new match.\n+               int overlap = Math.min(endIdx, match.index + match.length) -\n+                             Math.max(idx, match.index);\n+               if (overlap > 0)\n+               {\n+                  // The match starts at the earlier of the indices\n+                  match.index = Math.min(match.index, idx);\n+                  \n+                  // The match's new length is the distance to its new endpoint\n+                  // (the greater of the two matches we're merging)\n+                  match.length = Math.max(endIdx,  match.index + match.length) - \n+                        match.index;\n+                        \n+                  overlaps = true;\n+                  break;\n+               }\n+            }\n+\n+            // If this match does not overlap any existing matches, add it as a\n+            // new match.\n+            if (!overlaps)\n+            {\n+               matches.add(new SearchMatch(idx, needles[i].length()));\n+            }\n+         }\n+      }\n+      \n+      // Build the HTML from the input string and the found matches.\n+      if (matches.size() > 0)\n+      {\n+         int idx = 0;\n+         for (SearchMatch match: matches)\n+         {\n+            // Emit all the text from the last index to the beginning of this\n+            // match. \n+            sb.appendEscaped(haystack.substring(idx, match.index));\n+            \n+            // Emit the match itself.\n+            idx = match.index;\n+            sb.appendHtmlConstant(\n+                  \"<span class=\\\"\" + matchClass + \"\\\">\");", "originalCommit": "94806c66908573644384e7082e71036c6c49f936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5NTA3Mg==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424095072", "bodyText": "How would you feel about just skipping the highlighting if we have screen reader support on? (Feels like that'd be a 1 line change)", "author": "jmcphers", "createdAt": "2020-05-12T23:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MjE1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDExNTM0Mw==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424115343", "bodyText": "I think we could keep that in our back pocket and would be a good solution if it turns out to be an actual issue.", "author": "gtritchie", "createdAt": "2020-05-13T00:58:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MjE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NjkyMA==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424076920", "bodyText": "I don't think you are using setARIALabel that you added?", "author": "gtritchie", "createdAt": "2020-05-12T22:47:42Z", "path": "src/gwt/src/org/rstudio/core/client/a11y/A11y.java", "diffHunk": "@@ -146,4 +146,24 @@ public static void setInert(Element el, boolean inert)\n          el.removeAttribute(\"inert\");\n       }\n    }\n+   \n+   public static void setARIALabel(Element el, String text)\n+   {\n+      el.setAttribute(\"aria-label\", text);\n+   }\n+   \n+   public static void setARIALabel(Widget widget, String text)\n+   {\n+      setARIALabel(widget.getElement(), text);\n+   }\n+", "originalCommit": "94806c66908573644384e7082e71036c6c49f936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5OTQxMQ==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424099411", "bodyText": "You're right, of course. I'll remove it.", "author": "jmcphers", "createdAt": "2020-05-12T23:57:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NjkyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3OTAzNw==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424079037", "bodyText": "I'm not convinced that showing the context (Workbench, etc.) is particularly meaningful to most end-users and adds a lot of visual \"stuff\" that in most cases you'll train your brain to ignore?\nPlus when using a screen reader it causes that context to be read at the start of every command as you scroll through the list, significantly slowing down the time and cognitive load.\nAt the very least, maybe an option to turn it off both visually and audibly?\nOr maybe it has more value than I realize.", "author": "gtritchie", "createdAt": "2020-05-12T22:53:30Z", "path": "src/gwt/src/org/rstudio/studio/client/application/ui/AppCommandPaletteEntry.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * AppCommandPaletteEntry.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+package org.rstudio.studio.client.application.ui;\n+\n+import java.util.List;\n+\n+import org.rstudio.core.client.StringUtil;\n+import org.rstudio.core.client.command.AppCommand;\n+import org.rstudio.core.client.command.KeySequence;\n+\n+/**\n+ * AppCommandPaletteEntry is a widget that represents an AppCommand in RStudio's\n+ * command palette.\n+ */\n+public class AppCommandPaletteEntry extends CommandPaletteEntry\n+{\n+   public AppCommandPaletteEntry(AppCommand command, List<KeySequence> keys)\n+   {\n+      super(keys);\n+      label_ = command.getLabel();\n+      if (StringUtil.isNullOrEmpty(label_))\n+         label_ = command.getButtonLabel();\n+      if (StringUtil.isNullOrEmpty(label_))\n+         label_ = command.getDesc();\n+      if (StringUtil.isNullOrEmpty(label_))\n+         label_ = command.getMenuLabel(false);\n+      if (StringUtil.isNullOrEmpty(label_))\n+         label_ = \"\";\n+      command_ = command;\n+      initialize();\n+   }\n+   \n+   public String getLabel()\n+   {\n+      return label_;\n+   }\n+   \n+   public void invoke()\n+   {\n+      command_.execute();\n+   }\n+   \n+   public String getId()\n+   {\n+      return command_.getId();\n+   }\n+\n+   @Override\n+   public String getContext()", "originalCommit": "94806c66908573644384e7082e71036c6c49f936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5NjczNg==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424096736", "bodyText": "It is pretty much essential. For example, would you know what this command does without context?\n\nOr could you pick between these two without context?\n\nI can add an option to turn it off but I think it needs to be on by default.", "author": "jmcphers", "createdAt": "2020-05-12T23:48:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3OTAzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDExNTEzOA==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424115138", "bodyText": "No, point made, I think it's fine as-is.", "author": "gtritchie", "createdAt": "2020-05-13T00:57:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3OTAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4NjY5Nw==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424086697", "bodyText": "Be nice if you can use AriaLiveStatusWidget here instead of rolling your own; not essential (and might be more trouble than it's worth) but makes these easier to track down later if I try to do a desktop workaround for Qt's lack of live region support.", "author": "gtritchie", "createdAt": "2020-05-12T23:16:13Z", "path": "src/gwt/src/org/rstudio/studio/client/application/ui/CommandPalette.java", "diffHunk": "@@ -0,0 +1,442 @@\n+/*\n+ * CommandPalette.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+package org.rstudio.studio.client.application.ui;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.rstudio.core.client.DebouncedCommand;\n+import org.rstudio.core.client.ElementIds;\n+import org.rstudio.core.client.StringUtil;\n+import org.rstudio.core.client.a11y.A11y;\n+import org.rstudio.core.client.command.AppCommand;\n+import org.rstudio.core.client.command.KeyMap;\n+import org.rstudio.core.client.command.KeySequence;\n+import org.rstudio.core.client.command.ShortcutManager;\n+import org.rstudio.core.client.command.KeyMap.KeyMapType;\n+import org.rstudio.core.client.js.JsUtil;\n+import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddin;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddins;\n+import org.rstudio.studio.client.workbench.commands.Commands;\n+\n+import com.google.gwt.aria.client.ExpandedValue;\n+import com.google.gwt.aria.client.Id;\n+import com.google.gwt.aria.client.LiveValue;\n+import com.google.gwt.aria.client.Roles;\n+import com.google.gwt.core.client.GWT;\n+import com.google.gwt.core.client.Scheduler;\n+import com.google.gwt.dom.client.Element;\n+import com.google.gwt.event.dom.client.ClickEvent;\n+import com.google.gwt.resources.client.CssResource;\n+import com.google.gwt.uibinder.client.UiBinder;\n+import com.google.gwt.uibinder.client.UiField;\n+import com.google.gwt.user.client.Event;\n+import com.google.gwt.user.client.ui.Composite;\n+import com.google.gwt.user.client.ui.FlowPanel;\n+import com.google.gwt.user.client.ui.HTMLPanel;\n+import com.google.gwt.user.client.ui.ScrollPanel;\n+import com.google.gwt.user.client.ui.TextBox;\n+import com.google.gwt.user.client.ui.Widget;\n+\n+import elemental.events.KeyboardEvent.KeyCode;\n+\n+/**\n+ * CommandPalette is a widget that displays all available RStudio commands in a\n+ * searchable list.\n+ */\n+public class CommandPalette extends Composite\n+{\n+   private static CommandPaletteUiBinder uiBinder = GWT.create(CommandPaletteUiBinder.class);\n+\n+   interface CommandPaletteUiBinder extends UiBinder<Widget, CommandPalette>\n+   {\n+   }\n+   \n+   /**\n+    * The host interface represents the class hosting the widget (not a widget\n+    * itself), which is currently the CommandPaletteLauncher.\n+    */\n+   public interface Host\n+   {\n+      public void dismiss();\n+   }\n+   \n+   public interface Styles extends CssResource\n+   {\n+      String popup();\n+      String searchBox();\n+      String commandList();\n+      String commandPanel();\n+   }\n+\n+   public CommandPalette(Commands commands, RAddins addins, ShortcutManager shortcuts, Host host)\n+   {\n+      initWidget(uiBinder.createAndBindUi(this));\n+\n+      entries_ = new ArrayList<CommandPaletteEntry>();\n+      host_ = host;\n+      shortcuts_ = shortcuts;\n+      selected_ = -1;\n+      addins_ = addins;\n+      commands_ = commands;\n+      styles_.ensureInjected();\n+      \n+      Element searchBox = searchBox_.getElement();\n+      searchBox.setAttribute(\"placeholder\", \"Search and run commands\");\n+      searchBox.setAttribute(\"spellcheck\", \"false\");\n+\n+      // Accessibility attributes: list box\n+      Element commandList = commandList_.getElement();\n+      ElementIds.assignElementId(commandList, ElementIds.COMMAND_PALETTE_LIST);\n+      Roles.getListboxRole().set(commandList);\n+      Roles.getListboxRole().setAriaLabelProperty(commandList, \"Matching commands\");\n+\n+      // Accessibility attributes: search box\n+      ElementIds.assignElementId(searchBox_, ElementIds.COMMAND_PALETTE_SEARCH);\n+      Roles.getComboboxRole().setAriaOwnsProperty(searchBox, Id.of(commandList_.getElement()));\n+      Roles.getComboboxRole().set(searchBox);\n+      Roles.getComboboxRole().setAriaLabelProperty(searchBox, \"Search for and run a command\");\n+      Roles.getComboboxRole().setAriaExpandedState(searchBox, ExpandedValue.TRUE);\n+      A11y.setARIAAutocomplete(searchBox_, \"list\");\n+      \n+      // Accessibility attributes: announcement region; we want this to be read\n+      // when filter updates are complete\n+      A11y.setVisuallyHidden(resultsCount_);", "originalCommit": "94806c66908573644384e7082e71036c6c49f936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNTY3Ng==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424105676", "bodyText": "Didn't realize that existed! Just switched to it, big fan of reusing this kind of code since we can update later if e.g. we discover new best practices around live regions.", "author": "jmcphers", "createdAt": "2020-05-13T00:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4NjY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4Njc4Ng==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424086786", "bodyText": "We have a user pref for this value: typingStatusDelayMs()", "author": "gtritchie", "createdAt": "2020-05-12T23:16:31Z", "path": "src/gwt/src/org/rstudio/studio/client/application/ui/CommandPalette.java", "diffHunk": "@@ -0,0 +1,442 @@\n+/*\n+ * CommandPalette.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+package org.rstudio.studio.client.application.ui;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.rstudio.core.client.DebouncedCommand;\n+import org.rstudio.core.client.ElementIds;\n+import org.rstudio.core.client.StringUtil;\n+import org.rstudio.core.client.a11y.A11y;\n+import org.rstudio.core.client.command.AppCommand;\n+import org.rstudio.core.client.command.KeyMap;\n+import org.rstudio.core.client.command.KeySequence;\n+import org.rstudio.core.client.command.ShortcutManager;\n+import org.rstudio.core.client.command.KeyMap.KeyMapType;\n+import org.rstudio.core.client.js.JsUtil;\n+import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddin;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddins;\n+import org.rstudio.studio.client.workbench.commands.Commands;\n+\n+import com.google.gwt.aria.client.ExpandedValue;\n+import com.google.gwt.aria.client.Id;\n+import com.google.gwt.aria.client.LiveValue;\n+import com.google.gwt.aria.client.Roles;\n+import com.google.gwt.core.client.GWT;\n+import com.google.gwt.core.client.Scheduler;\n+import com.google.gwt.dom.client.Element;\n+import com.google.gwt.event.dom.client.ClickEvent;\n+import com.google.gwt.resources.client.CssResource;\n+import com.google.gwt.uibinder.client.UiBinder;\n+import com.google.gwt.uibinder.client.UiField;\n+import com.google.gwt.user.client.Event;\n+import com.google.gwt.user.client.ui.Composite;\n+import com.google.gwt.user.client.ui.FlowPanel;\n+import com.google.gwt.user.client.ui.HTMLPanel;\n+import com.google.gwt.user.client.ui.ScrollPanel;\n+import com.google.gwt.user.client.ui.TextBox;\n+import com.google.gwt.user.client.ui.Widget;\n+\n+import elemental.events.KeyboardEvent.KeyCode;\n+\n+/**\n+ * CommandPalette is a widget that displays all available RStudio commands in a\n+ * searchable list.\n+ */\n+public class CommandPalette extends Composite\n+{\n+   private static CommandPaletteUiBinder uiBinder = GWT.create(CommandPaletteUiBinder.class);\n+\n+   interface CommandPaletteUiBinder extends UiBinder<Widget, CommandPalette>\n+   {\n+   }\n+   \n+   /**\n+    * The host interface represents the class hosting the widget (not a widget\n+    * itself), which is currently the CommandPaletteLauncher.\n+    */\n+   public interface Host\n+   {\n+      public void dismiss();\n+   }\n+   \n+   public interface Styles extends CssResource\n+   {\n+      String popup();\n+      String searchBox();\n+      String commandList();\n+      String commandPanel();\n+   }\n+\n+   public CommandPalette(Commands commands, RAddins addins, ShortcutManager shortcuts, Host host)\n+   {\n+      initWidget(uiBinder.createAndBindUi(this));\n+\n+      entries_ = new ArrayList<CommandPaletteEntry>();\n+      host_ = host;\n+      shortcuts_ = shortcuts;\n+      selected_ = -1;\n+      addins_ = addins;\n+      commands_ = commands;\n+      styles_.ensureInjected();\n+      \n+      Element searchBox = searchBox_.getElement();\n+      searchBox.setAttribute(\"placeholder\", \"Search and run commands\");\n+      searchBox.setAttribute(\"spellcheck\", \"false\");\n+\n+      // Accessibility attributes: list box\n+      Element commandList = commandList_.getElement();\n+      ElementIds.assignElementId(commandList, ElementIds.COMMAND_PALETTE_LIST);\n+      Roles.getListboxRole().set(commandList);\n+      Roles.getListboxRole().setAriaLabelProperty(commandList, \"Matching commands\");\n+\n+      // Accessibility attributes: search box\n+      ElementIds.assignElementId(searchBox_, ElementIds.COMMAND_PALETTE_SEARCH);\n+      Roles.getComboboxRole().setAriaOwnsProperty(searchBox, Id.of(commandList_.getElement()));\n+      Roles.getComboboxRole().set(searchBox);\n+      Roles.getComboboxRole().setAriaLabelProperty(searchBox, \"Search for and run a command\");\n+      Roles.getComboboxRole().setAriaExpandedState(searchBox, ExpandedValue.TRUE);\n+      A11y.setARIAAutocomplete(searchBox_, \"list\");\n+      \n+      // Accessibility attributes: announcement region; we want this to be read\n+      // when filter updates are complete\n+      A11y.setVisuallyHidden(resultsCount_);\n+      Roles.getAlertRole().setAriaLiveProperty(resultsCount_.getElement(), LiveValue.ASSERTIVE);\n+\n+      // Populate the palette on a deferred callback so that it appears immediately\n+      Scheduler.get().scheduleDeferred(() ->\n+      {\n+         populate();\n+      });\n+      \n+      // Debounced update of the result count for screen readers; we debounce\n+      // this so that every keystroke doesn't trigger an announcement.\n+      updateResultsCount_ = new DebouncedCommand(1000)", "originalCommit": "94806c66908573644384e7082e71036c6c49f936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNTg3OQ==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424105879", "bodyText": "Thanks, this is now respected!", "author": "jmcphers", "createdAt": "2020-05-13T00:22:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4Njc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4NzQxNg==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424087416", "bodyText": "IntelliJ nit: \"public\" is redundant on interface methods", "author": "gtritchie", "createdAt": "2020-05-12T23:18:39Z", "path": "src/gwt/src/org/rstudio/studio/client/application/ui/CommandPalette.java", "diffHunk": "@@ -0,0 +1,442 @@\n+/*\n+ * CommandPalette.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+package org.rstudio.studio.client.application.ui;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.rstudio.core.client.DebouncedCommand;\n+import org.rstudio.core.client.ElementIds;\n+import org.rstudio.core.client.StringUtil;\n+import org.rstudio.core.client.a11y.A11y;\n+import org.rstudio.core.client.command.AppCommand;\n+import org.rstudio.core.client.command.KeyMap;\n+import org.rstudio.core.client.command.KeySequence;\n+import org.rstudio.core.client.command.ShortcutManager;\n+import org.rstudio.core.client.command.KeyMap.KeyMapType;\n+import org.rstudio.core.client.js.JsUtil;\n+import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddin;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddins;\n+import org.rstudio.studio.client.workbench.commands.Commands;\n+\n+import com.google.gwt.aria.client.ExpandedValue;\n+import com.google.gwt.aria.client.Id;\n+import com.google.gwt.aria.client.LiveValue;\n+import com.google.gwt.aria.client.Roles;\n+import com.google.gwt.core.client.GWT;\n+import com.google.gwt.core.client.Scheduler;\n+import com.google.gwt.dom.client.Element;\n+import com.google.gwt.event.dom.client.ClickEvent;\n+import com.google.gwt.resources.client.CssResource;\n+import com.google.gwt.uibinder.client.UiBinder;\n+import com.google.gwt.uibinder.client.UiField;\n+import com.google.gwt.user.client.Event;\n+import com.google.gwt.user.client.ui.Composite;\n+import com.google.gwt.user.client.ui.FlowPanel;\n+import com.google.gwt.user.client.ui.HTMLPanel;\n+import com.google.gwt.user.client.ui.ScrollPanel;\n+import com.google.gwt.user.client.ui.TextBox;\n+import com.google.gwt.user.client.ui.Widget;\n+\n+import elemental.events.KeyboardEvent.KeyCode;\n+\n+/**\n+ * CommandPalette is a widget that displays all available RStudio commands in a\n+ * searchable list.\n+ */\n+public class CommandPalette extends Composite\n+{\n+   private static CommandPaletteUiBinder uiBinder = GWT.create(CommandPaletteUiBinder.class);\n+\n+   interface CommandPaletteUiBinder extends UiBinder<Widget, CommandPalette>\n+   {\n+   }\n+   \n+   /**\n+    * The host interface represents the class hosting the widget (not a widget\n+    * itself), which is currently the CommandPaletteLauncher.\n+    */\n+   public interface Host\n+   {\n+      public void dismiss();", "originalCommit": "94806c66908573644384e7082e71036c6c49f936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNjc3OQ==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424106779", "bodyText": "Updated.", "author": "jmcphers", "createdAt": "2020-05-13T00:25:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4NzQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4Nzc2Mw==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424087763", "bodyText": "IntelliJ nit: could use for (String needle : needles)", "author": "gtritchie", "createdAt": "2020-05-12T23:19:48Z", "path": "src/gwt/src/org/rstudio/studio/client/application/ui/CommandPalette.java", "diffHunk": "@@ -0,0 +1,442 @@\n+/*\n+ * CommandPalette.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+package org.rstudio.studio.client.application.ui;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.rstudio.core.client.DebouncedCommand;\n+import org.rstudio.core.client.ElementIds;\n+import org.rstudio.core.client.StringUtil;\n+import org.rstudio.core.client.a11y.A11y;\n+import org.rstudio.core.client.command.AppCommand;\n+import org.rstudio.core.client.command.KeyMap;\n+import org.rstudio.core.client.command.KeySequence;\n+import org.rstudio.core.client.command.ShortcutManager;\n+import org.rstudio.core.client.command.KeyMap.KeyMapType;\n+import org.rstudio.core.client.js.JsUtil;\n+import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddin;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddins;\n+import org.rstudio.studio.client.workbench.commands.Commands;\n+\n+import com.google.gwt.aria.client.ExpandedValue;\n+import com.google.gwt.aria.client.Id;\n+import com.google.gwt.aria.client.LiveValue;\n+import com.google.gwt.aria.client.Roles;\n+import com.google.gwt.core.client.GWT;\n+import com.google.gwt.core.client.Scheduler;\n+import com.google.gwt.dom.client.Element;\n+import com.google.gwt.event.dom.client.ClickEvent;\n+import com.google.gwt.resources.client.CssResource;\n+import com.google.gwt.uibinder.client.UiBinder;\n+import com.google.gwt.uibinder.client.UiField;\n+import com.google.gwt.user.client.Event;\n+import com.google.gwt.user.client.ui.Composite;\n+import com.google.gwt.user.client.ui.FlowPanel;\n+import com.google.gwt.user.client.ui.HTMLPanel;\n+import com.google.gwt.user.client.ui.ScrollPanel;\n+import com.google.gwt.user.client.ui.TextBox;\n+import com.google.gwt.user.client.ui.Widget;\n+\n+import elemental.events.KeyboardEvent.KeyCode;\n+\n+/**\n+ * CommandPalette is a widget that displays all available RStudio commands in a\n+ * searchable list.\n+ */\n+public class CommandPalette extends Composite\n+{\n+   private static CommandPaletteUiBinder uiBinder = GWT.create(CommandPaletteUiBinder.class);\n+\n+   interface CommandPaletteUiBinder extends UiBinder<Widget, CommandPalette>\n+   {\n+   }\n+   \n+   /**\n+    * The host interface represents the class hosting the widget (not a widget\n+    * itself), which is currently the CommandPaletteLauncher.\n+    */\n+   public interface Host\n+   {\n+      public void dismiss();\n+   }\n+   \n+   public interface Styles extends CssResource\n+   {\n+      String popup();\n+      String searchBox();\n+      String commandList();\n+      String commandPanel();\n+   }\n+\n+   public CommandPalette(Commands commands, RAddins addins, ShortcutManager shortcuts, Host host)\n+   {\n+      initWidget(uiBinder.createAndBindUi(this));\n+\n+      entries_ = new ArrayList<CommandPaletteEntry>();\n+      host_ = host;\n+      shortcuts_ = shortcuts;\n+      selected_ = -1;\n+      addins_ = addins;\n+      commands_ = commands;\n+      styles_.ensureInjected();\n+      \n+      Element searchBox = searchBox_.getElement();\n+      searchBox.setAttribute(\"placeholder\", \"Search and run commands\");\n+      searchBox.setAttribute(\"spellcheck\", \"false\");\n+\n+      // Accessibility attributes: list box\n+      Element commandList = commandList_.getElement();\n+      ElementIds.assignElementId(commandList, ElementIds.COMMAND_PALETTE_LIST);\n+      Roles.getListboxRole().set(commandList);\n+      Roles.getListboxRole().setAriaLabelProperty(commandList, \"Matching commands\");\n+\n+      // Accessibility attributes: search box\n+      ElementIds.assignElementId(searchBox_, ElementIds.COMMAND_PALETTE_SEARCH);\n+      Roles.getComboboxRole().setAriaOwnsProperty(searchBox, Id.of(commandList_.getElement()));\n+      Roles.getComboboxRole().set(searchBox);\n+      Roles.getComboboxRole().setAriaLabelProperty(searchBox, \"Search for and run a command\");\n+      Roles.getComboboxRole().setAriaExpandedState(searchBox, ExpandedValue.TRUE);\n+      A11y.setARIAAutocomplete(searchBox_, \"list\");\n+      \n+      // Accessibility attributes: announcement region; we want this to be read\n+      // when filter updates are complete\n+      A11y.setVisuallyHidden(resultsCount_);\n+      Roles.getAlertRole().setAriaLiveProperty(resultsCount_.getElement(), LiveValue.ASSERTIVE);\n+\n+      // Populate the palette on a deferred callback so that it appears immediately\n+      Scheduler.get().scheduleDeferred(() ->\n+      {\n+         populate();\n+      });\n+      \n+      // Debounced update of the result count for screen readers; we debounce\n+      // this so that every keystroke doesn't trigger an announcement.\n+      updateResultsCount_ = new DebouncedCommand(1000)\n+      {\n+         @Override\n+         protected void execute()\n+         {\n+            int count = 0;\n+            for (CommandPaletteEntry entry: entries_)\n+            {\n+               if (entry.isVisible())\n+                  count++;\n+            }\n+            resultsCount_.getElement().setInnerText(count + \" \" +\n+                  \"commands found, press up and down to navigate\");\n+         }\n+      };\n+   }\n+   \n+   /**\n+    * Performs a one-time population of the palette with all available commands.\n+    */\n+   private void populate()\n+   {\n+      // Add all of the application commands\n+      KeyMap map = shortcuts_.getKeyMap(KeyMapType.APPLICATION);\n+      Map<String, AppCommand> allCommands = commands_.getCommands();\n+      for (String command: allCommands.keySet())\n+      {\n+         if (command.contains(\"Mru\") || command.startsWith(\"mru\") || \n+               command.contains(\"Dummy\"))\n+         {\n+            // MRU entries and dummy commands should not appear in the palette\n+            continue;\n+         }\n+         \n+         // Ensure the command can be used. It'd be nice to show all commands in\n+         // the palette for the purposes of examining key bindings, discovery,\n+         // etc., but there's no good user experience if a user attempts to\n+         // invoke one of those commands.\n+         AppCommand appCommand = allCommands.get(command);\n+         if (!appCommand.isEnabled() || !appCommand.isVisible())\n+         {\n+            continue;\n+         }\n+\n+         // Look up the key binding for this command\n+         List<KeySequence> keys = map.getBindings(command);\n+         \n+         // Create an application command entry\n+         CommandPaletteEntry entry = new AppCommandPaletteEntry(appCommand, keys);\n+         if (StringUtil.isNullOrEmpty(entry.getLabel()))\n+         {\n+            // Ignore app commands which have no label\n+            continue;\n+         }\n+         entries_.add(entry);\n+      }\n+      \n+      // Add all of the R addin commands\n+      map = shortcuts_.getKeyMap(KeyMapType.ADDIN);\n+      AddinExecutor executor = new AddinExecutor();\n+      for (String addin: JsUtil.asIterable(addins_.keys()))\n+      {\n+         RAddin rAddin = addins_.get(addin);\n+         \n+         // Look up the key binding for this addin\n+         List<KeySequence> keys = map.getBindings(rAddin.getId());\n+         CommandPaletteEntry entry = new RAddinCommandPaletteEntry(rAddin, executor, keys);\n+         if (StringUtil.isNullOrEmpty(entry.getLabel()))\n+         {\n+            // Ignore addin commands which have no label\n+            continue;\n+         }\n+         entries_.add(entry);\n+      }\n+      \n+      // Invoke commands when they're clicked on\n+      for (CommandPaletteEntry entry: entries_)\n+      {\n+         entry.sinkEvents(Event.ONCLICK);\n+         entry.addHandler((evt) -> {\n+            host_.dismiss();\n+            entry.invoke();\n+         }, ClickEvent.getType());\n+         commandList_.add(entry);\n+      }\n+\n+      \n+      // Handle most keystrokes on KeyUp so that the contents of the text box\n+      // have already been changed\n+      searchBox_.addKeyUpHandler((evt) ->\n+      {\n+         if (evt.getNativeKeyCode() == KeyCode.ESC)\n+         {\n+            // Pressing ESC dismisses the host (removing the palette popup)\n+            host_.dismiss();\n+         }\n+         else if (evt.getNativeKeyCode() == KeyCode.ENTER)\n+         {\n+            // Enter runs the selected command\n+            invokeSelection();\n+         }\n+         else\n+         {\n+            // Just update the filter if the text has changed\n+            String searchText = searchBox_.getText();\n+            if (!StringUtil.equals(searchText_, searchText))\n+            {\n+               searchText_ = searchText;\n+               applyFilter();\n+            }\n+         }\n+      });\n+\n+      // Up and Down arrows need to be handled on KeyDown to account for\n+      // repetition (a held arrow key will generate multiple KeyDown events and\n+      // then a single KeyUp when released)\n+      searchBox_.addKeyDownHandler((evt) -> \n+      {\n+         // Ignore the Tab key so we don't lose focus accidentally (there is\n+         // only one focusable element in the palette and we don't want Tab to\n+         // dismiss it)\n+         if (evt.getNativeKeyCode() == KeyCode.TAB)\n+         {\n+            evt.stopPropagation();\n+            evt.preventDefault();\n+            return;\n+         }\n+\n+         // Ignore modified arrows so that e.g. Shift Up/Down to select the\n+         // contents of the textbox work as expected\n+         if (evt.isAnyModifierKeyDown())\n+            return;\n+         \n+         if (evt.getNativeKeyCode() == KeyCode.UP)\n+         {\n+            // Directional keys often trigger behavior in textboxes (e.g. moving\n+            // the cursor to the beginning/end of text) but we're hijacking them\n+            // to do navigation in the results list, so disable that.\n+            evt.stopPropagation();\n+            evt.preventDefault();\n+            moveSelection(-1);\n+         }\n+         else if (evt.getNativeKeyCode() == KeyCode.DOWN)\n+         {\n+            evt.stopPropagation();\n+            evt.preventDefault();\n+            moveSelection(1);\n+         }\n+      });\n+   }\n+   \n+   /**\n+    * Filter the commands by the current contents of the search box\n+    */\n+   private void applyFilter()\n+   {\n+      int matches = 0;\n+\n+      // Split the search text into a series of lowercase words. This provides a\n+      // kind of partial fuzzy matching, so that e.g., \"new py\" matches the command\n+      // \"Create a new Python script\".\n+      String[] needles = searchBox_.getText().toLowerCase().split(\"\\\\s+\");\n+      \n+      for (CommandPaletteEntry entry: entries_)\n+      {\n+         String hay = entry.getLabel().toLowerCase();\n+         boolean matched = true;\n+         for (int i = 0; i < needles.length; i++)", "originalCommit": "94806c66908573644384e7082e71036c6c49f936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNjgyMA==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424106820", "bodyText": "Updated.", "author": "jmcphers", "createdAt": "2020-05-13T00:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4Nzc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4ODE0Nw==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424088147", "bodyText": "IntelliJ nit: could just have new ArrayList<>();", "author": "gtritchie", "createdAt": "2020-05-12T23:20:54Z", "path": "src/gwt/src/org/rstudio/studio/client/application/ui/CommandPalette.java", "diffHunk": "@@ -0,0 +1,442 @@\n+/*\n+ * CommandPalette.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+package org.rstudio.studio.client.application.ui;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.rstudio.core.client.DebouncedCommand;\n+import org.rstudio.core.client.ElementIds;\n+import org.rstudio.core.client.StringUtil;\n+import org.rstudio.core.client.a11y.A11y;\n+import org.rstudio.core.client.command.AppCommand;\n+import org.rstudio.core.client.command.KeyMap;\n+import org.rstudio.core.client.command.KeySequence;\n+import org.rstudio.core.client.command.ShortcutManager;\n+import org.rstudio.core.client.command.KeyMap.KeyMapType;\n+import org.rstudio.core.client.js.JsUtil;\n+import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddin;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddins;\n+import org.rstudio.studio.client.workbench.commands.Commands;\n+\n+import com.google.gwt.aria.client.ExpandedValue;\n+import com.google.gwt.aria.client.Id;\n+import com.google.gwt.aria.client.LiveValue;\n+import com.google.gwt.aria.client.Roles;\n+import com.google.gwt.core.client.GWT;\n+import com.google.gwt.core.client.Scheduler;\n+import com.google.gwt.dom.client.Element;\n+import com.google.gwt.event.dom.client.ClickEvent;\n+import com.google.gwt.resources.client.CssResource;\n+import com.google.gwt.uibinder.client.UiBinder;\n+import com.google.gwt.uibinder.client.UiField;\n+import com.google.gwt.user.client.Event;\n+import com.google.gwt.user.client.ui.Composite;\n+import com.google.gwt.user.client.ui.FlowPanel;\n+import com.google.gwt.user.client.ui.HTMLPanel;\n+import com.google.gwt.user.client.ui.ScrollPanel;\n+import com.google.gwt.user.client.ui.TextBox;\n+import com.google.gwt.user.client.ui.Widget;\n+\n+import elemental.events.KeyboardEvent.KeyCode;\n+\n+/**\n+ * CommandPalette is a widget that displays all available RStudio commands in a\n+ * searchable list.\n+ */\n+public class CommandPalette extends Composite\n+{\n+   private static CommandPaletteUiBinder uiBinder = GWT.create(CommandPaletteUiBinder.class);\n+\n+   interface CommandPaletteUiBinder extends UiBinder<Widget, CommandPalette>\n+   {\n+   }\n+   \n+   /**\n+    * The host interface represents the class hosting the widget (not a widget\n+    * itself), which is currently the CommandPaletteLauncher.\n+    */\n+   public interface Host\n+   {\n+      public void dismiss();\n+   }\n+   \n+   public interface Styles extends CssResource\n+   {\n+      String popup();\n+      String searchBox();\n+      String commandList();\n+      String commandPanel();\n+   }\n+\n+   public CommandPalette(Commands commands, RAddins addins, ShortcutManager shortcuts, Host host)\n+   {\n+      initWidget(uiBinder.createAndBindUi(this));\n+\n+      entries_ = new ArrayList<CommandPaletteEntry>();", "originalCommit": "94806c66908573644384e7082e71036c6c49f936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNjg0OA==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424106848", "bodyText": "Updated.", "author": "jmcphers", "createdAt": "2020-05-13T00:26:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4ODE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4OTg2Nw==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424089867", "bodyText": "I can where \"add-in\" context is important (contradicting my general uncertainty about context).", "author": "gtritchie", "createdAt": "2020-05-12T23:26:24Z", "path": "src/gwt/src/org/rstudio/studio/client/application/ui/RAddinCommandPaletteEntry.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * RAddinCommandPaletteEntry.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+package org.rstudio.studio.client.application.ui;\n+\n+import java.util.List;\n+\n+import org.rstudio.core.client.StringUtil;\n+import org.rstudio.core.client.command.KeySequence;\n+import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddin;\n+\n+/**\n+ * RAddinCommandPaletteEntry is a widget that represents a command furnished by\n+ * an RStudio Addin in RStudio's command palette.\n+ */\n+public class RAddinCommandPaletteEntry extends CommandPaletteEntry\n+{\n+   public RAddinCommandPaletteEntry(RAddin addin, AddinExecutor executor, \n+                                    List<KeySequence> keys)\n+   {\n+      super(keys);\n+      addin_ = addin;\n+      executor_ = executor;\n+      label_ = addin_.getName();\n+      if (StringUtil.isNullOrEmpty(label_))\n+         label_ = addin_.getTitle();\n+      if (StringUtil.isNullOrEmpty(label_))\n+         label_ = addin_.getDescription();\n+      if (StringUtil.isNullOrEmpty(label_))\n+         label_ = \"\";\n+\n+      initialize();\n+   }\n+   \n+   @Override\n+   public String getLabel()\n+   {\n+      return label_;\n+   }\n+\n+   @Override\n+   public void invoke()\n+   {\n+      executor_.execute(addin_);\n+   }\n+\n+   @Override\n+   public String getId()\n+   {\n+      return addin_.getId();\n+   }\n+\n+   @Override\n+   public String getContext()", "originalCommit": "94806c66908573644384e7082e71036c6c49f936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNjkzNA==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424106934", "bodyText": "Yes, this one is really vital!", "author": "jmcphers", "createdAt": "2020-05-13T00:26:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4OTg2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5MDg5OA==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424090898", "bodyText": "As mentioned elsewhere, support for PgUp and PgDown keys would be really nice here, too.", "author": "gtritchie", "createdAt": "2020-05-12T23:29:47Z", "path": "src/gwt/src/org/rstudio/studio/client/application/ui/CommandPalette.java", "diffHunk": "@@ -0,0 +1,442 @@\n+/*\n+ * CommandPalette.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+package org.rstudio.studio.client.application.ui;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.rstudio.core.client.DebouncedCommand;\n+import org.rstudio.core.client.ElementIds;\n+import org.rstudio.core.client.StringUtil;\n+import org.rstudio.core.client.a11y.A11y;\n+import org.rstudio.core.client.command.AppCommand;\n+import org.rstudio.core.client.command.KeyMap;\n+import org.rstudio.core.client.command.KeySequence;\n+import org.rstudio.core.client.command.ShortcutManager;\n+import org.rstudio.core.client.command.KeyMap.KeyMapType;\n+import org.rstudio.core.client.js.JsUtil;\n+import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddin;\n+import org.rstudio.studio.client.workbench.addins.Addins.RAddins;\n+import org.rstudio.studio.client.workbench.commands.Commands;\n+\n+import com.google.gwt.aria.client.ExpandedValue;\n+import com.google.gwt.aria.client.Id;\n+import com.google.gwt.aria.client.LiveValue;\n+import com.google.gwt.aria.client.Roles;\n+import com.google.gwt.core.client.GWT;\n+import com.google.gwt.core.client.Scheduler;\n+import com.google.gwt.dom.client.Element;\n+import com.google.gwt.event.dom.client.ClickEvent;\n+import com.google.gwt.resources.client.CssResource;\n+import com.google.gwt.uibinder.client.UiBinder;\n+import com.google.gwt.uibinder.client.UiField;\n+import com.google.gwt.user.client.Event;\n+import com.google.gwt.user.client.ui.Composite;\n+import com.google.gwt.user.client.ui.FlowPanel;\n+import com.google.gwt.user.client.ui.HTMLPanel;\n+import com.google.gwt.user.client.ui.ScrollPanel;\n+import com.google.gwt.user.client.ui.TextBox;\n+import com.google.gwt.user.client.ui.Widget;\n+\n+import elemental.events.KeyboardEvent.KeyCode;\n+\n+/**\n+ * CommandPalette is a widget that displays all available RStudio commands in a\n+ * searchable list.\n+ */\n+public class CommandPalette extends Composite\n+{\n+   private static CommandPaletteUiBinder uiBinder = GWT.create(CommandPaletteUiBinder.class);\n+\n+   interface CommandPaletteUiBinder extends UiBinder<Widget, CommandPalette>\n+   {\n+   }\n+   \n+   /**\n+    * The host interface represents the class hosting the widget (not a widget\n+    * itself), which is currently the CommandPaletteLauncher.\n+    */\n+   public interface Host\n+   {\n+      public void dismiss();\n+   }\n+   \n+   public interface Styles extends CssResource\n+   {\n+      String popup();\n+      String searchBox();\n+      String commandList();\n+      String commandPanel();\n+   }\n+\n+   public CommandPalette(Commands commands, RAddins addins, ShortcutManager shortcuts, Host host)\n+   {\n+      initWidget(uiBinder.createAndBindUi(this));\n+\n+      entries_ = new ArrayList<CommandPaletteEntry>();\n+      host_ = host;\n+      shortcuts_ = shortcuts;\n+      selected_ = -1;\n+      addins_ = addins;\n+      commands_ = commands;\n+      styles_.ensureInjected();\n+      \n+      Element searchBox = searchBox_.getElement();\n+      searchBox.setAttribute(\"placeholder\", \"Search and run commands\");\n+      searchBox.setAttribute(\"spellcheck\", \"false\");\n+\n+      // Accessibility attributes: list box\n+      Element commandList = commandList_.getElement();\n+      ElementIds.assignElementId(commandList, ElementIds.COMMAND_PALETTE_LIST);\n+      Roles.getListboxRole().set(commandList);\n+      Roles.getListboxRole().setAriaLabelProperty(commandList, \"Matching commands\");\n+\n+      // Accessibility attributes: search box\n+      ElementIds.assignElementId(searchBox_, ElementIds.COMMAND_PALETTE_SEARCH);\n+      Roles.getComboboxRole().setAriaOwnsProperty(searchBox, Id.of(commandList_.getElement()));\n+      Roles.getComboboxRole().set(searchBox);\n+      Roles.getComboboxRole().setAriaLabelProperty(searchBox, \"Search for and run a command\");\n+      Roles.getComboboxRole().setAriaExpandedState(searchBox, ExpandedValue.TRUE);\n+      A11y.setARIAAutocomplete(searchBox_, \"list\");\n+      \n+      // Accessibility attributes: announcement region; we want this to be read\n+      // when filter updates are complete\n+      A11y.setVisuallyHidden(resultsCount_);\n+      Roles.getAlertRole().setAriaLiveProperty(resultsCount_.getElement(), LiveValue.ASSERTIVE);\n+\n+      // Populate the palette on a deferred callback so that it appears immediately\n+      Scheduler.get().scheduleDeferred(() ->\n+      {\n+         populate();\n+      });\n+      \n+      // Debounced update of the result count for screen readers; we debounce\n+      // this so that every keystroke doesn't trigger an announcement.\n+      updateResultsCount_ = new DebouncedCommand(1000)\n+      {\n+         @Override\n+         protected void execute()\n+         {\n+            int count = 0;\n+            for (CommandPaletteEntry entry: entries_)\n+            {\n+               if (entry.isVisible())\n+                  count++;\n+            }\n+            resultsCount_.getElement().setInnerText(count + \" \" +\n+                  \"commands found, press up and down to navigate\");\n+         }\n+      };\n+   }\n+   \n+   /**\n+    * Performs a one-time population of the palette with all available commands.\n+    */\n+   private void populate()\n+   {\n+      // Add all of the application commands\n+      KeyMap map = shortcuts_.getKeyMap(KeyMapType.APPLICATION);\n+      Map<String, AppCommand> allCommands = commands_.getCommands();\n+      for (String command: allCommands.keySet())\n+      {\n+         if (command.contains(\"Mru\") || command.startsWith(\"mru\") || \n+               command.contains(\"Dummy\"))\n+         {\n+            // MRU entries and dummy commands should not appear in the palette\n+            continue;\n+         }\n+         \n+         // Ensure the command can be used. It'd be nice to show all commands in\n+         // the palette for the purposes of examining key bindings, discovery,\n+         // etc., but there's no good user experience if a user attempts to\n+         // invoke one of those commands.\n+         AppCommand appCommand = allCommands.get(command);\n+         if (!appCommand.isEnabled() || !appCommand.isVisible())\n+         {\n+            continue;\n+         }\n+\n+         // Look up the key binding for this command\n+         List<KeySequence> keys = map.getBindings(command);\n+         \n+         // Create an application command entry\n+         CommandPaletteEntry entry = new AppCommandPaletteEntry(appCommand, keys);\n+         if (StringUtil.isNullOrEmpty(entry.getLabel()))\n+         {\n+            // Ignore app commands which have no label\n+            continue;\n+         }\n+         entries_.add(entry);\n+      }\n+      \n+      // Add all of the R addin commands\n+      map = shortcuts_.getKeyMap(KeyMapType.ADDIN);\n+      AddinExecutor executor = new AddinExecutor();\n+      for (String addin: JsUtil.asIterable(addins_.keys()))\n+      {\n+         RAddin rAddin = addins_.get(addin);\n+         \n+         // Look up the key binding for this addin\n+         List<KeySequence> keys = map.getBindings(rAddin.getId());\n+         CommandPaletteEntry entry = new RAddinCommandPaletteEntry(rAddin, executor, keys);\n+         if (StringUtil.isNullOrEmpty(entry.getLabel()))\n+         {\n+            // Ignore addin commands which have no label\n+            continue;\n+         }\n+         entries_.add(entry);\n+      }\n+      \n+      // Invoke commands when they're clicked on\n+      for (CommandPaletteEntry entry: entries_)\n+      {\n+         entry.sinkEvents(Event.ONCLICK);\n+         entry.addHandler((evt) -> {\n+            host_.dismiss();\n+            entry.invoke();\n+         }, ClickEvent.getType());\n+         commandList_.add(entry);\n+      }\n+\n+      \n+      // Handle most keystrokes on KeyUp so that the contents of the text box\n+      // have already been changed\n+      searchBox_.addKeyUpHandler((evt) ->\n+      {\n+         if (evt.getNativeKeyCode() == KeyCode.ESC)\n+         {\n+            // Pressing ESC dismisses the host (removing the palette popup)\n+            host_.dismiss();\n+         }\n+         else if (evt.getNativeKeyCode() == KeyCode.ENTER)\n+         {\n+            // Enter runs the selected command\n+            invokeSelection();\n+         }\n+         else\n+         {\n+            // Just update the filter if the text has changed\n+            String searchText = searchBox_.getText();\n+            if (!StringUtil.equals(searchText_, searchText))\n+            {\n+               searchText_ = searchText;\n+               applyFilter();\n+            }\n+         }\n+      });\n+\n+      // Up and Down arrows need to be handled on KeyDown to account for", "originalCommit": "94806c66908573644384e7082e71036c6c49f936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5ODQ5NA==", "url": "https://github.com/rstudio/rstudio/pull/6848#discussion_r424098494", "bodyText": "Wish granted! \ud83e\uddde", "author": "jmcphers", "createdAt": "2020-05-12T23:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5MDg5OA=="}], "type": "inlineReview"}, {"oid": "b43a9f656c1595e23e9f6b74d638e087d32bfb6f", "url": "https://github.com/rstudio/rstudio/commit/b43a9f656c1595e23e9f6b74d638e087d32bfb6f", "message": "implement page up / page down", "committedDate": "2020-05-12T23:41:12Z", "type": "commit"}, {"oid": "be1218e126044cc12c39b1eee2290e548cb7250d", "url": "https://github.com/rstudio/rstudio/commit/be1218e126044cc12c39b1eee2290e548cb7250d", "message": "code review feedback; use AriaLiveStatusWidget", "committedDate": "2020-05-13T00:18:33Z", "type": "commit"}, {"oid": "c4982d0995015641fcc6e60a6168c17da81ee355", "url": "https://github.com/rstudio/rstudio/commit/c4982d0995015641fcc6e60a6168c17da81ee355", "message": "adjust page size; hide tautological \"workbench\" context", "committedDate": "2020-05-13T19:50:34Z", "type": "commit"}, {"oid": "33185c7fa729c56dc0787e523ad55fe506dd41f8", "url": "https://github.com/rstudio/rstudio/commit/33185c7fa729c56dc0787e523ad55fe506dd41f8", "message": "disambiguate and clarify lots of commands", "committedDate": "2020-05-13T22:46:41Z", "type": "commit"}, {"oid": "b0336f16ac23d2e7e473b9bad4023bedb12825f8", "url": "https://github.com/rstudio/rstudio/commit/b0336f16ac23d2e7e473b9bad4023bedb12825f8", "message": "use alternate binding for command palette on Firefox/Windows", "committedDate": "2020-05-13T23:01:02Z", "type": "commit"}, {"oid": "14a894f1e23fd5f5acff7653573f3573bbdbdfeb", "url": "https://github.com/rstudio/rstudio/commit/14a894f1e23fd5f5acff7653573f3573bbdbdfeb", "message": "update NEWS re: Command Palette", "committedDate": "2020-05-13T23:04:11Z", "type": "commit"}, {"oid": "e4f8e5472aa81fe34e836e67d037565c90fd2bca", "url": "https://github.com/rstudio/rstudio/commit/e4f8e5472aa81fe34e836e67d037565c90fd2bca", "message": "Merge remote-tracking branch 'origin/master' into feature/command-palette", "committedDate": "2020-05-13T23:04:58Z", "type": "commit"}]}