{"pr_number": 7994, "pr_title": "Open source doc in new column", "pr_createdAt": "2020-10-07T16:25:11Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7994", "timeline": [{"oid": "0ae5221b6f882fe5e5c6d8ce6623841b5b3a1fa0", "url": "https://github.com/rstudio/rstudio/commit/0ae5221b6f882fe5e5c6d8ce6623841b5b3a1fa0", "message": "add command to open source doc in new column", "committedDate": "2020-10-06T15:01:37Z", "type": "commit"}, {"oid": "43c8648eb37828cb697b6e24c8221f67cb773348", "url": "https://github.com/rstudio/rstudio/commit/43c8648eb37828cb697b6e24c8221f67cb773348", "message": "code clean up", "committedDate": "2020-10-06T15:14:14Z", "type": "commit"}, {"oid": "9da39447e9fede110542bf7d838e66d181d67415", "url": "https://github.com/rstudio/rstudio/commit/9da39447e9fede110542bf7d838e66d181d67415", "message": "fix exceptions", "committedDate": "2020-10-06T16:04:09Z", "type": "commit"}, {"oid": "dc805bee952488dac9dfd5573086e7780f094295", "url": "https://github.com/rstudio/rstudio/commit/dc805bee952488dac9dfd5573086e7780f094295", "message": "change keyboard command to fix conflict", "committedDate": "2020-10-07T21:59:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NDY4NQ==", "url": "https://github.com/rstudio/rstudio/pull/7994#discussion_r501374685", "bodyText": "This command needs to be disabled, and probably hidden, when the allowSourceColumns preference prevents it from working. I'd suggest handling that in the source column manager (i.e. bind a preference listener that sets the command to be enabled/visible based on the value of the pref).", "author": "jmcphers", "createdAt": "2020-10-07T23:54:54Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java", "diffHunk": "@@ -674,18 +675,51 @@ public void onFocusPreviousPane()\n    }\n \n    @Handler\n-    public void onNewSourceColumn()\n-    {\n-       if (!userPrefs_.allowSourceColumns().getValue())\n-          pGlobalDisplay_.get().showMessage(GlobalDisplay.MSG_INFO, \"Cannot Add Column\",\n-             \"Allow Source Columns preference is disabled.\");\n-       else if (additionalSourceCount_ >= MAX_COLUMN_COUNT)\n-          pGlobalDisplay_.get().showMessage(GlobalDisplay.MSG_INFO, \"Cannot Add Column\",\n-             \"You can't add more than \" + MAX_COLUMN_COUNT + \" columns.\");\n-       else\n-          createSourceColumn();\n-    }\n+   public void onNewSourceColumn()\n+   {\n+      if (validateNewColumnRequest())\n+         createAndDisplaySourceColumn();\n+   }\n+   \n+   @Handler\n+   public void onOpenSourceDocNewColumn()\n+   {\n+      if (validateNewColumnRequest())\n+      {\n+         ColumnName name = createSourceColumn();\n+         SourceColumn column = sourceColumnManager_.getByName(name.getName());\n+         column.incrementNewTabPending();\n+         panel_.addLeftWidget(\n+            createSourceColumnWindow(name.getName(),\n+               name.getAccessibleName()));\n+         sourceColumnManager_.setActive(column);\n+         Command onCancelled = () ->\n+         {\n+            column.decrementNewTabPending();\n+            closeSourceWindow(name.getName());\n+         };\n+         Command onCompleted = () -> column.decrementNewTabPending();\n+         source_.openSourceDoc(onCancelled, onCompleted);\n+      }\n+   }\n \n+   private boolean validateNewColumnRequest()\n+   {\n+      if (!userPrefs_.allowSourceColumns().getValue())\n+      {\n+         pGlobalDisplay_.get().showMessage(GlobalDisplay.MSG_INFO, \"Cannot Add Column\",\n+            \"Allow Source Columns preference is disabled.\");", "originalCommit": "dc805bee952488dac9dfd5573086e7780f094295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgxMjQ3NQ==", "url": "https://github.com/rstudio/rstudio/pull/7994#discussion_r501812475", "bodyText": "Good point, I've added a listener to SourceColumnManager to handle this as well as updated PaneManager to hide the commands when the max column count is reached.", "author": "melissa-barca", "createdAt": "2020-10-08T15:28:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NDY4NQ=="}], "type": "inlineReview"}, {"oid": "e29ad4f3d7d2288b26436236916793dabf021af5", "url": "https://github.com/rstudio/rstudio/commit/e29ad4f3d7d2288b26436236916793dabf021af5", "message": "disable and hide multiple source column commands when `Allow Source Columns` is off.", "committedDate": "2020-10-08T15:26:26Z", "type": "commit"}, {"oid": "9ca69c40b31564e15f89b44bb6b0352e92d30bed", "url": "https://github.com/rstudio/rstudio/commit/9ca69c40b31564e15f89b44bb6b0352e92d30bed", "message": "add image for Open In New Column command", "committedDate": "2020-10-08T15:27:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg0NjQwOQ==", "url": "https://github.com/rstudio/rstudio/pull/7994#discussion_r501846409", "bodyText": "Here and below: it makes sense to disable the first two commands if we're already maxed out for columns (since they create columns), but it seems to me like the third shouldn't be affected. What do you think?", "author": "jmcphers", "createdAt": "2020-10-08T16:17:03Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java", "diffHunk": "@@ -382,6 +382,14 @@ else if (numDocs > 0 && window.getState() == WindowState.HIDE)\n          hiddenTabs_ = tabNamesToTabs(evt.getValue().getHiddenTabSet());\n          populateTabPanel(hiddenTabs_, hiddenTabSetTabPanel_, hiddenTabSetMinPanel_);\n \n+         // manage source column commands\n+         boolean visible = userPrefs.allowSourceColumns().getValue() &&\n+            (userPrefs.panes().getValue().getAdditionalSourceColumns() < MAX_COLUMN_COUNT);\n+         \n+         commands_.newSourceColumn().setVisible(visible);\n+         commands_.openSourceDocNewColumn().setVisible(visible);\n+         commands_.focusSourceColumnSeparator().setVisible(visible);", "originalCommit": "e29ad4f3d7d2288b26436236916793dabf021af5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg2MDEzMQ==", "url": "https://github.com/rstudio/rstudio/pull/7994#discussion_r501860131", "bodyText": "You're right, fixed it.", "author": "melissa-barca", "createdAt": "2020-10-08T16:38:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg0NjQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg0NzM3Ng==", "url": "https://github.com/rstudio/rstudio/pull/7994#discussion_r501847376", "bodyText": "It's not totally clear to me why we need this code in both places ... doesn't this handler run at startup? (if not, maybe make a function that's called both at startup and in the value change handler?)", "author": "jmcphers", "createdAt": "2020-10-08T16:18:37Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java", "diffHunk": "@@ -242,6 +243,23 @@ public void onSwitchToDoc(SwitchToDocEvent event)\n          }\n       });\n \n+      userPrefs.allowSourceColumns().addValueChangeHandler(event ->\n+      {\n+         // PaneManager helps manage these commands so when modifying this code, update ", "originalCommit": "e29ad4f3d7d2288b26436236916793dabf021af5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg1NjE4NA==", "url": "https://github.com/rstudio/rstudio/pull/7994#discussion_r501856184", "bodyText": "PaneManager just needs to help with commands that need to be adjusted based on the max column count. It tracks this because it's actually responsible for adding and removing the windows that contain the columns. I'll update the comment to be more specific. I was grouping all the commands into that category when I shouldn't have been.", "author": "melissa-barca", "createdAt": "2020-10-08T16:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg0NzM3Ng=="}], "type": "inlineReview"}, {"oid": "15d03041a4b6c9fb89057886b90e434abd44ac06", "url": "https://github.com/rstudio/rstudio/commit/15d03041a4b6c9fb89057886b90e434abd44ac06", "message": "don't adjust command when source column max is reached", "committedDate": "2020-10-08T16:37:55Z", "type": "commit"}, {"oid": "082296521091a285251da6839e8f5847ffaed372", "url": "https://github.com/rstudio/rstudio/commit/082296521091a285251da6839e8f5847ffaed372", "message": "remove keyboard shortcut", "committedDate": "2020-10-12T17:33:16Z", "type": "commit"}]}