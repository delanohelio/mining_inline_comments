{"pr_number": 7522, "pr_title": "priority task queue for initializing visual editor contents", "pr_createdAt": "2020-08-04T13:12:08Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7522", "timeline": [{"oid": "945b9aaa833ff1074435a4b993a4d58bbbb1a0d6", "url": "https://github.com/rstudio/rstudio/commit/945b9aaa833ff1074435a4b993a4d58bbbb1a0d6", "message": "priority task queue for initializing visual editor contents", "committedDate": "2020-08-04T12:40:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1NTY3Ng==", "url": "https://github.com/rstudio/rstudio/pull/7522#discussion_r466055676", "bodyText": "For nomenclature I'd suggest a different name for this class since a \"priority queue\" is a well known data structure but doesn't have much in common with what's done here. Maybe PreemptiveTaskQueue since the active document can preempt the other queued tasks?", "author": "jmcphers", "createdAt": "2020-08-05T23:17:28Z", "path": "src/gwt/src/org/rstudio/core/client/PriorityTaskQueue.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * PriorityTaskQueue.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+\n+package org.rstudio.core.client;\n+\n+import java.util.LinkedList;\n+import java.util.Queue;\n+\n+import com.google.gwt.user.client.Command;\n+\n+// Task queue that allows tasks to bump themselves up in priority (even after\n+// they have been added to the queue).\n+\n+public class PriorityTaskQueue", "originalCommit": "945b9aaa833ff1074435a4b993a4d58bbbb1a0d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3NDEwNQ==", "url": "https://github.com/rstudio/rstudio/pull/7522#discussion_r466074105", "bodyText": "Good point! Renamed to PreemptiveTaskQueue", "author": "jjallaire", "createdAt": "2020-08-06T00:19:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1NTY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1NjcxOQ==", "url": "https://github.com/rstudio/rstudio/pull/7522#discussion_r466056719", "bodyText": "If the intent here (and elsewhere) is to handle a lot of expensive work, should we defer the processing of the next task so that the browser event loop has a chance to run between tasks?", "author": "jmcphers", "createdAt": "2020-08-05T23:20:51Z", "path": "src/gwt/src/org/rstudio/core/client/PriorityTaskQueue.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * PriorityTaskQueue.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+\n+package org.rstudio.core.client;\n+\n+import java.util.LinkedList;\n+import java.util.Queue;\n+\n+import com.google.gwt.user.client.Command;\n+\n+// Task queue that allows tasks to bump themselves up in priority (even after\n+// they have been added to the queue).\n+\n+public class PriorityTaskQueue\n+{\n+   public interface Task\n+   {\n+      String getLabel(); // used for debug/log output \n+      boolean hasPriority();\n+      void execute(Command done);\n+   }\n+   \n+   public PriorityTaskQueue()\n+   {\n+      this(true, false);\n+   }\n+   \n+   public PriorityTaskQueue(boolean safe)\n+   {\n+      this(safe, false);\n+   }\n+   \n+   public PriorityTaskQueue(boolean safe, boolean log)\n+   {\n+      log_ = log;\n+      safe_ = safe;\n+   }\n+   \n+   public void addTask(Task task)\n+   {\n+      log(\"adding \" + task.getLabel());\n+      taskQueue_.add(task);\n+      processQueue();\n+   }\n+   \n+   private void processQueue()\n+   {\n+      if (processing_)\n+      {\n+         log(\"already running\");\n+         return;\n+      }\n+      \n+      processing_ = true;\n+      processNextTask();\n+   }\n+   \n+   private void processNextTask()\n+   {\n+      log(\"process next task\");\n+      \n+      if (taskQueue_.isEmpty())\n+      {\n+         log(\"done\");\n+         processing_ = false;\n+         return;\n+      }\n+      \n+      // see if any of the tasks have priority\n+      Task nextTask = null;\n+      for (Task task : taskQueue_)\n+      {\n+         if (task.hasPriority())\n+         {\n+            nextTask = task;\n+            log(\"executing \" + nextTask.getLabel() + \" [Priority]\");\n+            break;\n+         }\n+      }\n+      \n+      // if there is no priority task then just remove from the queue\n+      if (nextTask == null)\n+      {\n+         nextTask = taskQueue_.peek();\n+         log(\"executing \" + nextTask.getLabel());  \n+      }\n+      \n+      // remove the task\n+      taskQueue_.remove(nextTask);\n+      \n+      // run the next task and then continue processing. catch any exceptions\n+      // so that we can continue processing if 'safe' was requested\n+      try\n+      {\n+         nextTask.execute(() -> {\n+            log(\"continuation\");\n+            processNextTask(); ", "originalCommit": "945b9aaa833ff1074435a4b993a4d58bbbb1a0d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3NDM2Mg==", "url": "https://github.com/rstudio/rstudio/pull/7522#discussion_r466074362", "bodyText": "In this case I happened to \"know\" that the task would be making an RPC call (so we would be pumping events) but in general this of course won't necessarily be the case. Added a call to scheduledDeferred().", "author": "jjallaire", "createdAt": "2020-08-06T00:20:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1NjcxOQ=="}], "type": "inlineReview"}, {"oid": "077a67e5b98d67a0c4d5737c776baf9c19d238be", "url": "https://github.com/rstudio/rstudio/commit/077a67e5b98d67a0c4d5737c776baf9c19d238be", "message": "Merge branch 'feature/panmirror-dev' into feature/panmirror-load-queue", "committedDate": "2020-08-05T23:58:49Z", "type": "commit"}, {"oid": "a9c080813c30109ea172e645a5d890a8b6c119e8", "url": "https://github.com/rstudio/rstudio/commit/a9c080813c30109ea172e645a5d890a8b6c119e8", "message": "address pr feedback", "committedDate": "2020-08-06T00:19:05Z", "type": "commit"}]}