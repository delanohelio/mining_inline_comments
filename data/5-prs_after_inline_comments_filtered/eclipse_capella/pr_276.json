{"pr_number": 276, "pr_title": "[558032] Fix dangling Title Blocks management", "pr_createdAt": "2020-06-23T14:36:43Z", "pr_url": "https://github.com/eclipse/capella/pull/276", "timeline": [{"oid": "f3a0cf3b729ed03435d2869c116b6905feedbdbf", "url": "https://github.com/eclipse/capella/commit/f3a0cf3b729ed03435d2869c116b6905feedbdbf", "message": "[558032] Fix dangling Title Blocks management\n\n- Remove the use of DialectManager.INSTANCE.refresh from the Title Block\nrefresh Extension\n-- The views are now removed in the extension\n\n- Fix Diagram Title Block hide issue\n-- Diagram Title Blocks were hidden whenever a Element Title Block was\nhidden\n\nBug: 558032\nChange-Id: Ia599fbdc630363c42c86444754ad153a4cb31303\nSigned-off-by: Sandu Postaru <sandu.postaru@thalesgroup.com>", "committedDate": "2020-06-23T14:35:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI4MTY2Mg==", "url": "https://github.com/eclipse/capella/pull/276#discussion_r444281662", "bodyText": "This method was called with all the visible Element Title Blocks as parameter (without the Diagram Title Block if one existed).\nLater in the algorithm, the show hide was then called with a parameter containing the { Element Title Blocks } minus { The Element Title Blocks to remove } and since the Diagram Title Block was not present in the list (but present in the diagram), he was hidden as well.", "author": "sandupostaru", "createdAt": "2020-06-23T14:45:47Z", "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -358,13 +356,12 @@ public void clearCellContent(EObject object) {\n    * @return list of Title Blocks (both Diagram or Element TB) that will be displayed in diagram\r\n    */\r\n   public void refreshTitleBlocksInDiagram(DDiagram diagram) {\r\n-    if (diagram.getOwnedDiagramElements().isEmpty() && TitleBlockPreferencesInitializer.isCreateDiagramTitleBlockByDefault()) {\r\n-        createDiagramTitleBlock(diagram, false);\r\n+    if (diagram.getOwnedDiagramElements().isEmpty()\r\n+        && TitleBlockPreferencesInitializer.isCreateDiagramTitleBlockByDefault()) {\r\n+      createDiagramTitleBlock(diagram, false);\r\n     }\r\n-    \r\n-    // delete the dangling element title blocks\r\n-    List<DAnnotation> listElementTitleBlocks = getElementTitleBlocks(diagram);\r\n-    handleDanglingElementTitleBlocks(listElementTitleBlocks, diagram);\r", "originalCommit": "f3a0cf3b729ed03435d2869c116b6905feedbdbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI4MzcwOQ==", "url": "https://github.com/eclipse/capella/pull/276#discussion_r444283709", "bodyText": "This line was puzzling for me, since we delete the Title Blocks at line 552 so this call makes no sense to me (so I removed it).", "author": "sandupostaru", "createdAt": "2020-06-23T14:48:24Z", "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -519,48 +517,53 @@ public boolean isFilterElementTitleBlocksEnabled(DDiagramElement element) {\n   }\r\n \r\n   /**\r\n-   * this function handles the dangling Element Title Blocks in two situations: if the element associated to an element\r\n-   * TB was deleted from model -> delete the TB; if the element associate to an element TB was removed from diagram ->\r\n-   * hide the TB\r\n+   * Handles the dangling Element Title Blocks in two situations: if the element associated to an element TB was deleted\r\n+   * from model -> delete the TB; if the element associate to an element TB was removed from diagram -> hide the TB\r\n    * \r\n-   * @param list:\r\n-   *          the list of element TB to check\r\n    * @param diagram\r\n-   * @return list of Title Blocks (both Diagram or Element TB) that will be displayed in diagram\r\n+   *          the diagram.\r\n    */\r\n-  private void handleDanglingElementTitleBlocks(List<DAnnotation> list, DDiagram diagram) {\r\n-    List<DAnnotation> deleteList = new ArrayList<>();\r\n-    List<EObject> hideList = new ArrayList<>();\r\n-    for (DAnnotation annotation : list) {\r\n-      EObject element = TitleBlockHelper.getSemanticElementReference(annotation);\r\n-      if(element != null) {\r\n-        DDiagramElement diagElement = DiagramServices.getDiagramServices().getDiagramElement(diagram, element);\r\n-        // case to hide the TB\r\n-        if (diagElement == null) {\r\n-          hideList.add(annotation);\r\n+  private void handleDanglingElementTitleBlocks(DDiagram diagram) {\r\n+    Set<DAnnotation> titleBlocks = getVisibleTitleBlocks(diagram);\r\n+\r\n+    List<DAnnotation> titleBlocksToDelete = new ArrayList<>();\r\n+    List<DAnnotation> titleBlocksToHide = new ArrayList<>();\r\n+\r\n+    for (DAnnotation titleBlock : titleBlocks) {\r\n+      if (TitleBlockHelper.isElementTitleBlock(titleBlock)) {\r\n+        EObject semanticReference = TitleBlockHelper.getSemanticElementReference(titleBlock);\r\n+\r\n+        if (semanticReference != null) {\r\n+          DDiagramElement semanticElementView = DiagramServices.getDiagramServices().getDiagramElement(diagram,\r\n+              semanticReference);\r\n+          if (semanticElementView == null) {\r\n+            titleBlocksToHide.add(titleBlock);\r\n+          }\r\n+\r\n+        } else {\r\n+          titleBlocksToDelete.add(titleBlock);\r\n         }\r\n       }\r\n-      else {\r\n-        // case to delete the TB because it has no reference to a semantic element\r\n-        deleteList.add(annotation);\r\n-      }\r\n     }\r\n \r\n-    if (!deleteList.isEmpty()) {\r\n-      CapellaServices.getService().removeElements(deleteList);\r", "originalCommit": "f3a0cf3b729ed03435d2869c116b6905feedbdbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI4NDU5MA==", "url": "https://github.com/eclipse/capella/pull/276#discussion_r444284590", "bodyText": "We dont use the refresh command anymore, instead we remove the Element Title Block views manually.", "author": "sandupostaru", "createdAt": "2020-06-23T14:49:32Z", "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -519,48 +517,53 @@ public boolean isFilterElementTitleBlocksEnabled(DDiagramElement element) {\n   }\r\n \r\n   /**\r\n-   * this function handles the dangling Element Title Blocks in two situations: if the element associated to an element\r\n-   * TB was deleted from model -> delete the TB; if the element associate to an element TB was removed from diagram ->\r\n-   * hide the TB\r\n+   * Handles the dangling Element Title Blocks in two situations: if the element associated to an element TB was deleted\r\n+   * from model -> delete the TB; if the element associate to an element TB was removed from diagram -> hide the TB\r\n    * \r\n-   * @param list:\r\n-   *          the list of element TB to check\r\n    * @param diagram\r\n-   * @return list of Title Blocks (both Diagram or Element TB) that will be displayed in diagram\r\n+   *          the diagram.\r\n    */\r\n-  private void handleDanglingElementTitleBlocks(List<DAnnotation> list, DDiagram diagram) {\r\n-    List<DAnnotation> deleteList = new ArrayList<>();\r\n-    List<EObject> hideList = new ArrayList<>();\r\n-    for (DAnnotation annotation : list) {\r\n-      EObject element = TitleBlockHelper.getSemanticElementReference(annotation);\r\n-      if(element != null) {\r\n-        DDiagramElement diagElement = DiagramServices.getDiagramServices().getDiagramElement(diagram, element);\r\n-        // case to hide the TB\r\n-        if (diagElement == null) {\r\n-          hideList.add(annotation);\r\n+  private void handleDanglingElementTitleBlocks(DDiagram diagram) {\r\n+    Set<DAnnotation> titleBlocks = getVisibleTitleBlocks(diagram);\r\n+\r\n+    List<DAnnotation> titleBlocksToDelete = new ArrayList<>();\r\n+    List<DAnnotation> titleBlocksToHide = new ArrayList<>();\r\n+\r\n+    for (DAnnotation titleBlock : titleBlocks) {\r\n+      if (TitleBlockHelper.isElementTitleBlock(titleBlock)) {\r\n+        EObject semanticReference = TitleBlockHelper.getSemanticElementReference(titleBlock);\r\n+\r\n+        if (semanticReference != null) {\r\n+          DDiagramElement semanticElementView = DiagramServices.getDiagramServices().getDiagramElement(diagram,\r\n+              semanticReference);\r\n+          if (semanticElementView == null) {\r\n+            titleBlocksToHide.add(titleBlock);\r\n+          }\r\n+\r\n+        } else {\r\n+          titleBlocksToDelete.add(titleBlock);\r\n         }\r\n       }\r\n-      else {\r\n-        // case to delete the TB because it has no reference to a semantic element\r\n-        deleteList.add(annotation);\r\n-      }\r\n     }\r\n \r\n-    if (!deleteList.isEmpty()) {\r\n-      CapellaServices.getService().removeElements(deleteList);\r\n-      for (DAnnotation annotation : deleteList) {\r\n-        deleteTitleBlock(diagram, annotation);\r\n+    if (!titleBlocksToDelete.isEmpty()) {\r\n+      for (DAnnotation titleBlock : titleBlocksToDelete) {\r\n+        DDiagramElement titleBlockView = DiagramServices.getDiagramServices().getDiagramElement(diagram, titleBlock);\r", "originalCommit": "f3a0cf3b729ed03435d2869c116b6905feedbdbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}