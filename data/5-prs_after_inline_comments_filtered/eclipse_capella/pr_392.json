{"pr_number": 392, "pr_title": "[567469] Fix invalid references when scenarios are transitioned", "pr_createdAt": "2020-10-08T13:57:55Z", "pr_url": "https://github.com/eclipse/capella/pull/392", "timeline": [{"oid": "c7714d0f9e934c26e418f12be24f3b2feb6866ad", "url": "https://github.com/eclipse/capella/commit/c7714d0f9e934c26e418f12be24f3b2feb6866ad", "message": "[567469] Fix invalid references when scenarios are transitioned\n\n- added QF to delete invalid reference\n- if a scenario reference an invalid scenario, clear the reference after\ntransition\n\n\nChange-Id: Ida38588115ae7695d108430a05c53171cc37637a\nSigned-off-by: Georgiana Ecobici <georgiana-elena.ecobici@thalesgroup.com>", "committedDate": "2020-10-08T13:56:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzMjk0Nw==", "url": "https://github.com/eclipse/capella/pull/392#discussion_r502232947", "bodyText": "analizedScenarios is always empty no ? it doesnt seems to me modified.\noh, can you rename it as \"result\"", "author": "pdulth", "createdAt": "2020-10-09T07:16:29Z", "path": "core/plugins/org.polarsys.capella.core.projection.scenario/src/org/polarsys/capella/core/projection/scenario/commands/ESToISCommand.java", "diffHunk": "@@ -83,34 +81,45 @@ protected AbstractTransform getTransformation(EObject element_p) {\n       EObject eObject = it.next();\n \n       if (eObject instanceof Scenario) {\n-        Scenario scenario = (Scenario) eObject;\n-        if (postRun || isScenarioValid(scenario)) {\n-          // add also the scenario referenced by this scenario\n-          Set<EObject> referencesScenarios = new HashSet<EObject>();\n-          searchReferencedScenarios(scenario, referencesScenarios, result);\n-          result.addAll(referencesScenarios);\n-          result.add(scenario);\n-        }\n+        addAllScenarios((Scenario) eObject, result, postRun);\n         it.prune();\n       }\n       // TODO we can prune many objects to limit lookup\n     }\n     return result;\n   }\n   \n-/*\n- * recursively, search for all referenced scenarios\n- */\n-  protected void searchReferencedScenarios(Scenario scenario, Set<EObject> references, Collection<EObject> analizedScenarios) {\n-    if(analizedScenarios.contains(scenario))\n-       return;\n+  private void addAllScenarios(Scenario scenario, Collection<EObject> result, boolean postRun) {\n+    if (postRun || isScenarioValid(scenario)) {\n+      // add also the scenario referenced by this scenario\n+      Set<EObject> referencesScenarios = new HashSet<EObject>();\n+      searchReferencedScenarios(scenario, referencesScenarios, result, postRun);\n+      result.addAll(referencesScenarios);\n+      result.add(scenario);\n+    }\n+  }\n+  \n+  /*\n+   * recursively, search for all referenced scenarios\n+   */\n+  protected void searchReferencedScenarios(Scenario scenario, Set<EObject> references,\n+      Collection<EObject> analizedScenarios, boolean postRun) {", "originalCommit": "c7714d0f9e934c26e418f12be24f3b2feb6866ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzMzg3Mg==", "url": "https://github.com/eclipse/capella/pull/392#discussion_r502233872", "bodyText": "is not empty always, in the case we select multiple scenarios  (when in search scenarios goes trough the scenarios).", "author": "georgiana-ecobici", "createdAt": "2020-10-09T07:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzMjk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzODk1OQ==", "url": "https://github.com/eclipse/capella/pull/392#discussion_r502238959", "bodyText": "Its hard to understand the code and what is difference between references, analizedScenarios.\ncan you simplify a bit.\nThanks", "author": "pdulth", "createdAt": "2020-10-09T07:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzMjk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzOTc4NQ==", "url": "https://github.com/eclipse/capella/pull/392#discussion_r502239785", "bodyText": "ok", "author": "georgiana-ecobici", "createdAt": "2020-10-09T07:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzMjk0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzODI1MQ==", "url": "https://github.com/eclipse/capella/pull/392#discussion_r502238251", "bodyText": "The test failed because there was the checking valid scenario condition for selecting only one test.\nif (postRun || isScenarioValid(scenario))", "author": "georgiana-ecobici", "createdAt": "2020-10-09T07:27:59Z", "path": "core/plugins/org.polarsys.capella.core.projection.scenario/src/org/polarsys/capella/core/projection/scenario/commands/ESToISCommand.java", "diffHunk": "@@ -86,10 +84,7 @@ protected AbstractTransform getTransformation(EObject element_p) {\n         Scenario scenario = (Scenario) eObject;\n         if (postRun || isScenarioValid(scenario)) {\n           // add also the scenario referenced by this scenario\n-          Set<EObject> referencesScenarios = new HashSet<EObject>();\n-          searchReferencedScenarios(scenario, referencesScenarios, result);\n-          result.addAll(referencesScenarios);\n-          result.add(scenario);\n+          addAllScenarios(scenario, result, postRun);\n         }", "originalCommit": "1bf2fc575c515e55366950c6a53b0c62d711fc91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzNzQ2Nw==", "url": "https://github.com/eclipse/capella/pull/392#discussion_r502237467", "bodyText": "can you create one instance outside the loop", "author": "pdulth", "createdAt": "2020-10-09T07:26:21Z", "path": "core/plugins/org.polarsys.capella.core.projection.scenario/src/org/polarsys/capella/core/projection/scenario/commands/ESToISCommand.java", "diffHunk": "@@ -83,34 +81,45 @@ protected AbstractTransform getTransformation(EObject element_p) {\n       EObject eObject = it.next();\n \n       if (eObject instanceof Scenario) {\n-        Scenario scenario = (Scenario) eObject;\n-        if (postRun || isScenarioValid(scenario)) {\n-          // add also the scenario referenced by this scenario\n-          Set<EObject> referencesScenarios = new HashSet<EObject>();\n-          searchReferencedScenarios(scenario, referencesScenarios, result);\n-          result.addAll(referencesScenarios);\n-          result.add(scenario);\n-        }\n+        addAllScenarios((Scenario) eObject, result, postRun);\n         it.prune();\n       }\n       // TODO we can prune many objects to limit lookup\n     }\n     return result;\n   }\n   \n-/*\n- * recursively, search for all referenced scenarios\n- */\n-  protected void searchReferencedScenarios(Scenario scenario, Set<EObject> references, Collection<EObject> analizedScenarios) {\n-    if(analizedScenarios.contains(scenario))\n-       return;\n+  private void addAllScenarios(Scenario scenario, Collection<EObject> result, boolean postRun) {\n+    if (postRun || isScenarioValid(scenario)) {\n+      // add also the scenario referenced by this scenario\n+      Set<EObject> referencesScenarios = new HashSet<EObject>();\n+      searchReferencedScenarios(scenario, referencesScenarios, result, postRun);\n+      result.addAll(referencesScenarios);\n+      result.add(scenario);\n+    }\n+  }\n+  \n+  /*\n+   * recursively, search for all referenced scenarios\n+   */\n+  protected void searchReferencedScenarios(Scenario scenario, Set<EObject> references,\n+      Collection<EObject> analizedScenarios, boolean postRun) {\n+    if (analizedScenarios.contains(scenario))\n+      return;\n     for (TimeLapse timelapse : scenario.getOwnedTimeLapses()) {\n       if (timelapse instanceof InteractionUse) {\n         InteractionUse interaction = (InteractionUse) timelapse;\n         Scenario refScenario = interaction.getReferencedScenario();\n-        if(refScenario != null && !references.contains(refScenario)) {\n-          references.add(refScenario);\n-          searchReferencedScenarios(refScenario, references, analizedScenarios);\n+\n+        // check if is a valid reference and the reference was not already processed\n+        if (refScenario != null\n+            && new MDCHK_InteractionUse_ReferencedScenario().isValidReference(interaction, scenario, refScenario)", "originalCommit": "c7714d0f9e934c26e418f12be24f3b2feb6866ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzOTQ1MA==", "url": "https://github.com/eclipse/capella/pull/392#discussion_r502239450", "bodyText": "can you create one instance of MDCHK_InteractionUse_ReferencedScenario outside the loop.", "author": "pdulth", "createdAt": "2020-10-09T07:30:21Z", "path": "core/plugins/org.polarsys.capella.core.projection.scenario/src/org/polarsys/capella/core/projection/scenario/commands/ESToISCommand.java", "diffHunk": "@@ -147,8 +165,15 @@ public void run() {\n                       .filter(sc -> sc.getName().equals(refScenario.getName())).findFirst();\n                   if (match.isPresent()) {\n                     interaction.setReferencedScenario(match.get());\n+                  } else {\n+                    interaction.setReferencedScenario(null);\n                   }\n                 }\n+                if (!new MDCHK_InteractionUse_ReferencedScenario().isValidReference(interaction, scenario,", "originalCommit": "1bf2fc575c515e55366950c6a53b0c62d711fc91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0MDA1Mg==", "url": "https://github.com/eclipse/capella/pull/392#discussion_r502240052", "bodyText": "ok", "author": "georgiana-ecobici", "createdAt": "2020-10-09T07:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzOTQ1MA=="}], "type": "inlineReview"}, {"oid": "da287d9ef87863897e8759d967ada9e5255411fe", "url": "https://github.com/eclipse/capella/commit/da287d9ef87863897e8759d967ada9e5255411fe", "message": "[567469] Fix invalid references when scenarios are transitioned\n\n- fix build\n\n\nChange-Id: Ib5079a1cb6f1e62a815ebee726df4bd1d09e2f7d\nSigned-off-by: Georgiana Ecobici <georgiana-elena.ecobici@thalesgroup.com>", "committedDate": "2020-10-09T10:07:50Z", "type": "commit"}, {"oid": "da287d9ef87863897e8759d967ada9e5255411fe", "url": "https://github.com/eclipse/capella/commit/da287d9ef87863897e8759d967ada9e5255411fe", "message": "[567469] Fix invalid references when scenarios are transitioned\n\n- fix build\n\n\nChange-Id: Ib5079a1cb6f1e62a815ebee726df4bd1d09e2f7d\nSigned-off-by: Georgiana Ecobici <georgiana-elena.ecobici@thalesgroup.com>", "committedDate": "2020-10-09T10:07:50Z", "type": "forcePushed"}, {"oid": "74ff0ac1bbf752ddcc833f816d29ba5f22177d3a", "url": "https://github.com/eclipse/capella/commit/74ff0ac1bbf752ddcc833f816d29ba5f22177d3a", "message": "[567469] Fix invalid references when scenarios are transitioned\n\n- fix OES, OAS to ES, FS (System) isValidTransition\n\n\nChange-Id: I3d94fe9e4ec78095ca715defb5609d4fc80aa517\nSigned-off-by: Georgiana Ecobici <georgiana-elena.ecobici@thalesgroup.com>", "committedDate": "2020-10-09T12:24:44Z", "type": "commit"}]}