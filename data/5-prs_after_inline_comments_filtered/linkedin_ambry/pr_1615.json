{"pr_number": 1615, "pr_title": "[LeaderBasedReplication] Notify response handler on connection check out failure in all places.", "pr_createdAt": "2020-09-03T00:39:44Z", "pr_url": "https://github.com/linkedin/ambry/pull/1615", "timeline": [{"oid": "604c5d4351a88bfad814fb927ce2d3320cd9c916", "url": "https://github.com/linkedin/ambry/commit/604c5d4351a88bfad814fb927ce2d3320cd9c916", "message": "Issue: In replication code, we are continuously attempting to replicate with remote hosts that are down instead of following retry backoff procedures. Due to that, socket connection checkout fails repeatedly.\nThis happens during fetching of missing keys for timed out standby replicas due to two reasons:\n1. Failing to notify response handler on connection checkout failure. Due to that node might not be marked as down.\n2. Iterating over all replicas (which includes replicas whose nodes are down) instead of \u2018Active replicas\u2019 while fetching the missing keys.\n\nThis PR addresses above two issues.", "committedDate": "2020-09-02T23:59:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA2MzExMQ==", "url": "https://github.com/linkedin/ambry/pull/1615#discussion_r486063111", "bodyText": "minor: line 458 startTimeInMs is not updated before checking out the channel", "author": "jsjtzyy", "createdAt": "2020-09-10T04:56:18Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -452,11 +446,12 @@ public void replicate() {\n           // TODO: If the result to fetch a blob from local dc is Blob_Not_Found, then we can fetch it from replicas in remote datacenter.\n           // This will involve co-ordination between replica threads containing replicas of same partition.\n           List<RemoteReplicaInfo> standbyReplicasTimedOutOnNoProgress =\n-              getRemoteStandbyReplicasTimedOutOnNoProgress(replicasToReplicatePerNode);\n+              getRemoteStandbyReplicasTimedOutOnNoProgress(standbyReplicasWithNoProgress);\n           if (standbyReplicasTimedOutOnNoProgress.size() > 0) {\n             allCaughtUp = false;\n             currentReplicaList = standbyReplicasTimedOutOnNoProgress;\n             if (connectedChannel == null) {\n+              checkoutConnectionTimeInMs = -1;", "originalCommit": "604c5d4351a88bfad814fb927ce2d3320cd9c916", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f153a907fbf4734fc74d6b00961a5d59c7b7b2d8", "url": "https://github.com/linkedin/ambry/commit/f153a907fbf4734fc74d6b00961a5d59c7b7b2d8", "message": "Update startTimeInMs before checking out connection channel", "committedDate": "2020-09-11T17:10:42Z", "type": "commit"}]}