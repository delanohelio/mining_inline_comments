{"pr_number": 1516, "pr_title": "Support monitoring inconsistency between participants on same node", "pr_createdAt": "2020-05-11T15:58:14Z", "pr_url": "https://github.com/linkedin/ambry/pull/1516", "timeline": [{"oid": "0e30c452361bebd7590be22896855db32f3464aa", "url": "https://github.com/linkedin/ambry/commit/0e30c452361bebd7590be22896855db32f3464aa", "message": "address comments", "committedDate": "2020-05-13T18:02:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk5OTMyMA==", "url": "https://github.com/linkedin/ambry/pull/1516#discussion_r426999320", "bodyText": "Please add a comment explaining this section of code.", "author": "lightningrob", "createdAt": "2020-05-19T02:48:20Z", "path": "ambry-server/src/main/java/com/github/ambry/server/AmbryServer.java", "diffHunk": "@@ -158,7 +160,16 @@ public void startup() throws InstantiationException {\n       properties.verify();\n \n       scheduler = Utils.newScheduler(serverConfig.serverSchedulerNumOfthreads, false);\n-      logger.info(\"check if node exist in clustermap host {} port {}\", networkConfig.hostName, networkConfig.port);\n+      if (clusterParticipants != null && clusterParticipants.size() > 1", "originalCommit": "0e30c452361bebd7590be22896855db32f3464aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwMDk2Nw==", "url": "https://github.com/linkedin/ambry/pull/1516#discussion_r427000967", "bodyText": "Nit: the test class name is misleading since you don't directly create any instances of ParticipantsConsistencyChecker and run their methods.", "author": "lightningrob", "createdAt": "2020-05-19T02:54:55Z", "path": "ambry-server/src/test/java/com/github/ambry/server/ParticipantsConsistencyCheckerTest.java", "diffHunk": "@@ -0,0 +1,238 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.server;\n+\n+import com.github.ambry.clustermap.ClusterParticipant;\n+import com.github.ambry.clustermap.MockClusterAgentsFactory;\n+import com.github.ambry.clustermap.MockClusterMap;\n+import com.github.ambry.clustermap.PartitionStateChangeListener;\n+import com.github.ambry.clustermap.ReplicaId;\n+import com.github.ambry.clustermap.ReplicaSyncUpManager;\n+import com.github.ambry.clustermap.StateModelListenerType;\n+import com.github.ambry.commons.LoggingNotificationSystem;\n+import com.github.ambry.config.VerifiableProperties;\n+import com.github.ambry.notification.NotificationSystem;\n+import com.github.ambry.utils.SystemTime;\n+import com.github.ambry.utils.Time;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+import static org.junit.Assert.*;\n+import static org.mockito.Mockito.*;\n+\n+\n+/**\n+ * Test class to verify participant consistency checker.\n+ */\n+public class ParticipantsConsistencyCheckerTest {", "originalCommit": "0e30c452361bebd7590be22896855db32f3464aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyMzYzOA==", "url": "https://github.com/linkedin/ambry/pull/1516#discussion_r427023638", "bodyText": "Fair point. I will probably just call it ParticipantsConsistencyTest and rename several test method as well.", "author": "jsjtzyy", "createdAt": "2020-05-19T04:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwMDk2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwMjIyNQ==", "url": "https://github.com/linkedin/ambry/pull/1516#discussion_r427002225", "bodyText": "If this task is going to run every X seconds, do we want to increment the counter each time?  Once we have a mismatch, the metric count will increase proportionally to how often the schedule is run, which doesn't seem very meaningful.  Wondering if it should be a Guage instead.\nBtw, what action can be taken if an alert on this metric is seen?", "author": "lightningrob", "createdAt": "2020-05-19T03:00:10Z", "path": "ambry-server/src/main/java/com/github/ambry/server/ParticipantsConsistencyChecker.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.server;\n+\n+import com.github.ambry.clustermap.ClusterParticipant;\n+import com.github.ambry.commons.ServerMetrics;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * A thread that helps periodically check consistency of participants. Specifically, it checks if there is a mismatch\n+ * in sealed and stopped replicas from each participant.\n+ */\n+public class ParticipantsConsistencyChecker implements Runnable {\n+  private final List<ClusterParticipant> participants;\n+  private final ServerMetrics metrics;\n+  private static final Logger logger = LoggerFactory.getLogger(ParticipantsConsistencyChecker.class);\n+\n+  public ParticipantsConsistencyChecker(List<ClusterParticipant> participants, ServerMetrics metrics) {\n+    this.participants = participants;\n+    this.metrics = metrics;\n+    metrics.registerParticipantsMismatchMetrics();\n+  }\n+\n+  @Override\n+  public void run() {\n+    // when code reaches here, it means there are at least two participants.\n+    ClusterParticipant clusterParticipant = participants.get(0);\n+    Set<String> sealedReplicas1 = new HashSet<>(clusterParticipant.getSealedReplicas());\n+    Set<String> stoppedReplicas1 = new HashSet<>(clusterParticipant.getStoppedReplicas());\n+    for (int i = 1; i < participants.size(); ++i) {\n+      Set<String> sealedReplicas2 = new HashSet<>(participants.get(i).getSealedReplicas());\n+      if (!sealedReplicas1.equals(sealedReplicas2)) {\n+        logger.warn(\"Mismatch in sealed replicas. Set {} is different from set {}\", sealedReplicas1, sealedReplicas2);\n+        metrics.sealedReplicasMismatchCount.inc();", "originalCommit": "0e30c452361bebd7590be22896855db32f3464aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyMTA5OQ==", "url": "https://github.com/linkedin/ambry/pull/1516#discussion_r427021099", "bodyText": "Using counter seems inappropriate but is actually ok because Ingraph converts it to per second rate when it is read. (Reference: https://iwww.corp.linkedin.com/wiki/cf/display/SOP/inGraphs+FAQ#inGraphsFAQ). An example is instanceConfigChangeTriggerCount, if we look at the dashboard, it actually records number of events per second.", "author": "jsjtzyy", "createdAt": "2020-05-19T04:19:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwMjIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyMTc2MA==", "url": "https://github.com/linkedin/ambry/pull/1516#discussion_r427021760", "bodyText": "If alert is fired, we can try to restart the server and attempt to correct the number. Sometimes the inconsistency comes from intermittent failure due to connection issue.\nIf it doesn't work, we can use \"partition override\" feature to override certain partition to the correct state.", "author": "jsjtzyy", "createdAt": "2020-05-19T04:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwMjIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyMjIwMA==", "url": "https://github.com/linkedin/ambry/pull/1516#discussion_r428222200", "bodyText": "I understand that counter is converted to rate.  My point was that the reported rate would be governed by how often the checker task kicks off, rather than how frequently an error happened or how many discrepancies there are, which might be confusing.  It's not a deal breaker, just wanted to point that out.", "author": "lightningrob", "createdAt": "2020-05-20T18:31:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwMjIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwMjk3Nw==", "url": "https://github.com/linkedin/ambry/pull/1516#discussion_r427002977", "bodyText": "Minor: in seconds.", "author": "lightningrob", "createdAt": "2020-05-19T03:03:24Z", "path": "ambry-api/src/main/java/com/github/ambry/config/RouterConfig.java", "diffHunk": "@@ -422,7 +422,7 @@\n   public final boolean routerOperationTrackerHistogramDumpEnabled;\n \n   /**\n-   * The period of dumping resource-level histogram (if enabled).\n+   * The period of dumping resource-level histogram in second(if enabled).", "originalCommit": "0e30c452361bebd7590be22896855db32f3464aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13cfbe33892056a9c57c17cc7e9960bb08171ce2", "url": "https://github.com/linkedin/ambry/commit/13cfbe33892056a9c57c17cc7e9960bb08171ce2", "message": "Support monitoring inconsistency between participants on same node\n\nAs required by ZK cluster migration, ambry-server has to host two participants\nthat update sealed/stopped replicas at same time. In case any participant fails\nto update corresponding ZK cluster(i.e. connection lost), ambry-server needs to\nmonitor and alert inconsistency of sealed/stopped replicas from two participants.\nThis PR introduces a consistency checker that periodically checks sealed/stopped\nreplica lists from two participants and emits metric if there is mismatch.", "committedDate": "2020-05-19T03:41:25Z", "type": "commit"}, {"oid": "8586a9b8dd80d0ad06f891222e2cc7c41a01f6f7", "url": "https://github.com/linkedin/ambry/commit/8586a9b8dd80d0ad06f891222e2cc7c41a01f6f7", "message": "address comments", "committedDate": "2020-05-19T03:41:25Z", "type": "commit"}, {"oid": "83c3c4f9ebdea5cc6f2fb25f33652ea450cae27b", "url": "https://github.com/linkedin/ambry/commit/83c3c4f9ebdea5cc6f2fb25f33652ea450cae27b", "message": "address Rob's comments", "committedDate": "2020-05-19T04:47:44Z", "type": "commit"}, {"oid": "83c3c4f9ebdea5cc6f2fb25f33652ea450cae27b", "url": "https://github.com/linkedin/ambry/commit/83c3c4f9ebdea5cc6f2fb25f33652ea450cae27b", "message": "address Rob's comments", "committedDate": "2020-05-19T04:47:44Z", "type": "forcePushed"}]}