{"pr_number": 1586, "pr_title": "Optimize number of calls to CloudBlobStore::findKey()", "pr_createdAt": "2020-07-13T04:28:40Z", "pr_url": "https://github.com/linkedin/ambry/pull/1586", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQyOTA1Mw==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453429053", "bodyText": "If this method and approach is acceptable, we no longer need findKey() to be a public method, and hence it can be removed from the interface.", "author": "ankagrawal", "createdAt": "2020-07-13T04:31:50Z", "path": "ambry-api/src/main/java/com/github/ambry/store/Store.java", "diffHunk": "@@ -102,6 +103,16 @@\n    */\n   MessageInfo findKey(StoreKey key) throws StoreException;\n \n+  /**\n+   * Return a {@link Map} of {@code storeKeys} to {@link MessageInfo} of the keys.\n+   * This method will only be used in replication thread, and the map returned will contain message infos for only those\n+   * keys that are found in the local store.\n+   * @param storeKeys The list of keys for which to return {@link MessageInfo}s.\n+   * @return The {@link Map} of key to {@link MessageInfo}.\n+   * @throws StoreException\n+   */\n+  Map<StoreKey, MessageInfo> findKeys(List<? extends StoreKey> storeKeys) throws StoreException;", "originalCommit": "b15229e1412ca8598adf0b0b0faba3faa9dc2ad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzNTQ5Mw==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453835493", "bodyText": "Yes, I would remove it.", "author": "lightningrob", "createdAt": "2020-07-13T18:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQyOTA1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg2NzQ0OA==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453867448", "bodyText": "done.", "author": "ankagrawal", "createdAt": "2020-07-13T19:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQyOTA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzMDc2Nw==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453430767", "bodyText": "TODO: Need to look into the possibility if its more efficient to not call findKey() multiple times in a loop, and instead search the index once for all the blobs in the list. Will do so in a separate ticket. For now,  calling findKey() multiple times in a loop is no worse than what was happening before for the case of BlobStore.", "author": "ankagrawal", "createdAt": "2020-07-13T04:40:03Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStore.java", "diffHunk": "@@ -934,6 +934,19 @@ public MessageInfo findKey(StoreKey key) throws StoreException {\n     }\n   }\n \n+  @Override\n+  public Map<StoreKey, MessageInfo> findKeys(List<? extends StoreKey> storeKeys) {\n+    Map<StoreKey, MessageInfo> messageInfoMap = new HashMap<>();", "originalCommit": "b15229e1412ca8598adf0b0b0faba3faa9dc2ad2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyOTgyNQ==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453829825", "bodyText": "Formatting: space after if.", "author": "lightningrob", "createdAt": "2020-07-13T17:58:40Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -880,10 +881,20 @@ void processReplicaMetadataResponse(Set<MessageInfo> missingRemoteStoreMessages,\n         // it is deleted in the remote store and not deleted yet locally.\n \n         // if the blob is from deprecated container, then nothing needs to be done.\n-        if (replicationConfig.replicationContainerDeletionEnabled && skipPredicate != null && skipPredicate.test(messageInfo)) {\n+        if (replicationConfig.replicationContainerDeletionEnabled && skipPredicate != null && skipPredicate.test(\n+            messageInfo)) {\n           continue;\n         }\n-        applyUpdatesToBlobInLocalStore(messageInfo, remoteReplicaInfo, localKey);\n+        if(localMessageInfoMap == null) {", "originalCommit": "b15229e1412ca8598adf0b0b0faba3faa9dc2ad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzNDY0MA==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453834640", "bodyText": "Also, is there a reason to call this inside the for loop rather than up front?", "author": "lightningrob", "createdAt": "2020-07-13T18:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyOTgyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0NDQ3NA==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453844474", "bodyText": "Yes.. as mentioned in the comments, for those replication loops, where all the remote messages are missing from local store, we don't really need the overhead to try to find all the keys. Hence I am doing this only when we run into a case that necessitates a findKey call.", "author": "ankagrawal", "createdAt": "2020-07-13T18:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyOTgyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzMTM3Ng==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453831376", "bodyText": "Formatting looks off.", "author": "lightningrob", "createdAt": "2020-07-13T18:01:26Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -880,10 +881,20 @@ void processReplicaMetadataResponse(Set<MessageInfo> missingRemoteStoreMessages,\n         // it is deleted in the remote store and not deleted yet locally.\n \n         // if the blob is from deprecated container, then nothing needs to be done.\n-        if (replicationConfig.replicationContainerDeletionEnabled && skipPredicate != null && skipPredicate.test(messageInfo)) {\n+        if (replicationConfig.replicationContainerDeletionEnabled && skipPredicate != null && skipPredicate.test(\n+            messageInfo)) {\n           continue;\n         }\n-        applyUpdatesToBlobInLocalStore(messageInfo, remoteReplicaInfo, localKey);\n+        if(localMessageInfoMap == null) {\n+          // This makes sure that the potentially expensive findKeys() method isn't called for a replication loop, if\n+          // all the keys being processed are missing in local store.\n+          localMessageInfoMap = remoteReplicaInfo.getLocalStore()\n+              .findKeys(messageInfoList.stream()\n+                  .map(msgInfo -> (BlobId) remoteKeyToLocalKeyMap.get(msgInfo.getStoreKey()))", "originalCommit": "b15229e1412ca8598adf0b0b0faba3faa9dc2ad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1MDA0NQ==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453850045", "bodyText": "fixed.", "author": "ankagrawal", "createdAt": "2020-07-13T18:33:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzMTM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzMjM4OA==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453832388", "bodyText": "I would move this check to the calling method, and just do Objects.assertNonNull() here.", "author": "lightningrob", "createdAt": "2020-07-13T18:03:04Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -900,11 +911,14 @@ void processReplicaMetadataResponse(Set<MessageInfo> missingRemoteStoreMessages,\n    * @param messageInfo message information of the blob from remote replica\n    * @param remoteReplicaInfo remote replica information\n    * @param localKey local blob information\n+   * @param localMessageInfo message information of the blob from the local replica\n    * @throws StoreException\n    */\n   public void applyUpdatesToBlobInLocalStore(MessageInfo messageInfo, RemoteReplicaInfo remoteReplicaInfo,\n-      BlobId localKey) throws StoreException {\n-    MessageInfo localMessageInfo = remoteReplicaInfo.getLocalStore().findKey(localKey);\n+      BlobId localKey, MessageInfo localMessageInfo) throws StoreException {\n+    if (localMessageInfo == null) {", "originalCommit": "b15229e1412ca8598adf0b0b0faba3faa9dc2ad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0NjUyMQ==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r453846521", "bodyText": "I moved it inside the method so that I don't have to do this check at multiple places where this method is called. Let me know if you think its ok to have this check in each caller.", "author": "ankagrawal", "createdAt": "2020-07-13T18:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzMjM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxMzYzMw==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r454013633", "bodyText": "not all exception means not_found from findKey, please print out the exception as well.\nAlso, we should use error here.", "author": "justinlin-linkedin", "createdAt": "2020-07-13T23:49:37Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStore.java", "diffHunk": "@@ -934,6 +939,21 @@ public MessageInfo findKey(StoreKey key) throws StoreException {\n     }\n   }\n \n+  @Override\n+  public Map<StoreKey, MessageInfo> findKeys(List<? extends StoreKey> storeKeys) {\n+    Map<StoreKey, MessageInfo> messageInfoMap = new HashMap<>();\n+    for (StoreKey storeKey : storeKeys) {\n+      try {\n+        // TODO: Need to look into the possibility if its more efficient to not call findKey() multiple times in a loop,\n+        // and instead search the index once for all the blobs in the list.\n+        messageInfoMap.put(storeKey, findKey(storeKey));\n+      } catch (StoreException stEx) {\n+        logger.info(\"Key %s not found in findKey\", storeKey.getID());", "originalCommit": "a53f2eeae5fc602fb1d12bed4a7c742b6f89bc67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1NzA1OQ==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r454657059", "bodyText": "True. I have changed the code to throw the errors from findKey() as is, after logging.", "author": "ankagrawal", "createdAt": "2020-07-14T21:30:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxMzYzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxNDk2MQ==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r454014961", "bodyText": "we can filter out those keys we already know that are now now in local store.\nmessageInfoList.stream().filter(messageInfo -> !missingRemoteStoreMessage.contains(messageInfo)).", "author": "justinlin-linkedin", "createdAt": "2020-07-13T23:54:16Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -880,10 +881,20 @@ void processReplicaMetadataResponse(Set<MessageInfo> missingRemoteStoreMessages,\n         // it is deleted in the remote store and not deleted yet locally.\n \n         // if the blob is from deprecated container, then nothing needs to be done.\n-        if (replicationConfig.replicationContainerDeletionEnabled && skipPredicate != null && skipPredicate.test(messageInfo)) {\n+        if (replicationConfig.replicationContainerDeletionEnabled && skipPredicate != null && skipPredicate.test(\n+            messageInfo)) {\n           continue;\n         }\n-        applyUpdatesToBlobInLocalStore(messageInfo, remoteReplicaInfo, localKey);\n+        if (localMessageInfoMap == null) {\n+          // This makes sure that the potentially expensive findKeys() method isn't called for a replication loop, if\n+          // all the keys being processed are missing in local store.\n+          localMessageInfoMap = remoteReplicaInfo.getLocalStore()\n+              .findKeys(messageInfoList.stream()\n+                  .map(msgInfo -> (BlobId) remoteKeyToLocalKeyMap.get(msgInfo.getStoreKey()))", "originalCommit": "a53f2eeae5fc602fb1d12bed4a7c742b6f89bc67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1NjM2Ng==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r454656366", "bodyText": "done.", "author": "ankagrawal", "createdAt": "2020-07-14T21:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxNDk2MQ=="}], "type": "inlineReview"}, {"oid": "d7e631a31046f7e2d41d2a7b1bab586afa876608", "url": "https://github.com/linkedin/ambry/commit/d7e631a31046f7e2d41d2a7b1bab586afa876608", "message": "CloudBlobStore::findKey() is called multiple times in ReplicaThread::processReplicaMetadataResponse inside the ReplicaThread::replicate() loop. Since CloudBlobStore::findKey() internally calls cosmos db, which is an expensive call, this change batches all the calls to findKey() at one place. This will minimize the calls to cosmos db, while keeping the number of findKey() calls in case of BlobStore same as before.", "committedDate": "2020-07-14T05:25:28Z", "type": "commit"}, {"oid": "5e8440929d20537e8fa28e255461a340235d049e", "url": "https://github.com/linkedin/ambry/commit/5e8440929d20537e8fa28e255461a340235d049e", "message": "Remove findKey() method from Store interface.\nAddress review comments.", "committedDate": "2020-07-14T05:25:28Z", "type": "commit"}, {"oid": "2b9e55e1b47ac0af058f0b0f416d766e060ad5ac", "url": "https://github.com/linkedin/ambry/commit/2b9e55e1b47ac0af058f0b0f416d766e060ad5ac", "message": "Address review comments", "committedDate": "2020-07-14T21:15:05Z", "type": "commit"}, {"oid": "2b9e55e1b47ac0af058f0b0f416d766e060ad5ac", "url": "https://github.com/linkedin/ambry/commit/2b9e55e1b47ac0af058f0b0f416d766e060ad5ac", "message": "Address review comments", "committedDate": "2020-07-14T21:15:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY2NjkxMQ==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r454666911", "bodyText": "This method doesn't throw out StoreException.", "author": "justinlin-linkedin", "createdAt": "2020-07-14T21:51:35Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStore.java", "diffHunk": "@@ -940,15 +940,15 @@ public MessageInfo findKey(StoreKey key) throws StoreException {\n   }\n \n   @Override\n-  public Map<StoreKey, MessageInfo> findKeys(List<? extends StoreKey> storeKeys) {\n+  public Map<StoreKey, MessageInfo> findKeys(List<? extends StoreKey> storeKeys) throws StoreException {", "originalCommit": "2b9e55e1b47ac0af058f0b0f416d766e060ad5ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc3NjI3NA==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r454776274", "bodyText": "fixed.", "author": "ankagrawal", "createdAt": "2020-07-15T03:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY2NjkxMQ=="}], "type": "inlineReview"}, {"oid": "a9cc6e0a07af504f6f923941166f87711a6e5e77", "url": "https://github.com/linkedin/ambry/commit/a9cc6e0a07af504f6f923941166f87711a6e5e77", "message": "Add the missing exception.", "committedDate": "2020-07-15T00:22:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyMTM1NA==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r454721354", "bodyText": "if we are throwing exception here, then we don't need the try-catch statement.", "author": "justinlin-linkedin", "createdAt": "2020-07-15T00:32:48Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStore.java", "diffHunk": "@@ -949,6 +949,7 @@ public MessageInfo findKey(StoreKey key) throws StoreException {\n         messageInfoMap.put(storeKey, findKey(storeKey));\n       } catch (StoreException e) {\n         logger.error(\"findKey failed for key {} with reason {}\", storeKey.getID(), e.getErrorCode().toString());\n+        throw e;", "originalCommit": "a9cc6e0a07af504f6f923941166f87711a6e5e77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc3Njk5Mw==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r454776993", "bodyText": "The reason for try-catch here is because I want to log a meaningful message with the key that resulted in exception. The exception shouldn't be thrown often here, hence I thought it might be a good idea to log it here to help with quick debugging, and it will not result in any performance issues.", "author": "ankagrawal", "createdAt": "2020-07-15T04:01:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyMTM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE5ODMxMQ==", "url": "https://github.com/linkedin/ambry/pull/1586#discussion_r455198311", "bodyText": "I am good with that.", "author": "justinlin-linkedin", "createdAt": "2020-07-15T17:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyMTM1NA=="}], "type": "inlineReview"}]}