{"pr_number": 1566, "pr_title": "Add more undelete unit test for compaction", "pr_createdAt": "2020-06-16T06:34:53Z", "pr_url": "https://github.com/linkedin/ambry/pull/1566", "timeline": [{"oid": "f7bf3c67aaa22fb449317b93d86a71ffc8838f8c", "url": "https://github.com/linkedin/ambry/commit/f7bf3c67aaa22fb449317b93d86a71ffc8838f8c", "message": "More tests", "committedDate": "2020-06-17T20:11:10Z", "type": "forcePushed"}, {"oid": "2a037e1408a2d727eeca2472aba2cf1063c1465a", "url": "https://github.com/linkedin/ambry/commit/2a037e1408a2d727eeca2472aba2cf1063c1465a", "message": "Add more undelete unit test for compaction", "committedDate": "2020-06-19T00:05:38Z", "type": "commit"}, {"oid": "e3d0fd8d7e984af3371aa55ed7785e120773c7d7", "url": "https://github.com/linkedin/ambry/commit/e3d0fd8d7e984af3371aa55ed7785e120773c7d7", "message": "More tests", "committedDate": "2020-06-19T00:05:38Z", "type": "commit"}, {"oid": "52297ca3f93d6398702aebe08c8868feeba161da", "url": "https://github.com/linkedin/ambry/commit/52297ca3f93d6398702aebe08c8868feeba161da", "message": "Add more tests", "committedDate": "2020-06-19T20:32:19Z", "type": "commit"}, {"oid": "52297ca3f93d6398702aebe08c8868feeba161da", "url": "https://github.com/linkedin/ambry/commit/52297ca3f93d6398702aebe08c8868feeba161da", "message": "Add more tests", "committedDate": "2020-06-19T20:32:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwMjAwNQ==", "url": "https://github.com/linkedin/ambry/pull/1566#discussion_r443102005", "bodyText": "indexSegmentCountBeforeCompaction is never accessed, did you want to verify this count originally?", "author": "jsjtzyy", "createdAt": "2020-06-20T05:03:15Z", "path": "ambry-store/src/test/java/com/github/ambry/store/BlobStoreCompactorTest.java", "diffHunk": "@@ -1235,13 +1234,27 @@ public void undeleteSameIndexSegmentTest() throws Exception {\n     state.addUndeleteEntry((MockId) p9.getKey());\n     state.addUndeleteEntry((MockId) p9.getKey(), (short) 2);\n     state.addPutEntries(1, CuratedLogIndexState.PUT_RECORD_SIZE, Utils.Infinite_Time);\n-    // Make sure we have two log segments\n-    writeDataToMeetRequiredSegmentCount(2, null);\n+\n+    writeDataToMeetRequiredSegmentCount(1, null);\n+    // This is the end of the first log segment\n+\n+    // log segment 1\n+    // Index Segment 1.1 P(expired) D U T -> P(expire) U T\n+    long p10Expiration = state.time.milliseconds() + 10000;\n+    IndexEntry p10 = state.addPutEntries(1, CuratedLogIndexState.PUT_RECORD_SIZE, p10Expiration).get(0);\n+    state.addDeleteEntry((MockId) p10.getKey());\n+    state.addUndeleteEntry((MockId) p10.getKey());\n+    state.makePermanent((MockId) p10.getKey(), false);\n+    state.addPutEntries(1, CuratedLogIndexState.PUT_RECORD_SIZE, Utils.Infinite_Time);\n+\n+    // Make sure we have 3 log segments\n+    writeDataToMeetRequiredSegmentCount(3, null);\n     state.reloadIndex(true, false);\n \n     String logSegmentName = p1.getValue().getOffset().getName();\n-    List<String> segmentsUnderCompaction = Collections.singletonList(logSegmentName);\n-    long deleteReferenceTimeMs = state.time.milliseconds() + 10000;\n+    List<String> segmentsUnderCompaction = getLogSegments(0, 1);\n+    state.advanceTime(p10Expiration - state.time.milliseconds() + 1000);\n+    long deleteReferenceTimeMs = state.time.milliseconds();\n     long endOffsetOfSegmentBeforeCompaction = state.log.getSegment(logSegmentName).getEndOffset();\n     int indexSegmentCountBeforeCompaction = state.index.getIndexSegments().size();", "originalCommit": "52297ca3f93d6398702aebe08c8868feeba161da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwMjA1OA==", "url": "https://github.com/linkedin/ambry/pull/1566#discussion_r443102058", "bodyText": "oh I see you removed an assert and make this assigned but never accessed.", "author": "jsjtzyy", "createdAt": "2020-06-20T05:04:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwMjAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwMjA3NA==", "url": "https://github.com/linkedin/ambry/pull/1566#discussion_r443102074", "bodyText": "same here", "author": "jsjtzyy", "createdAt": "2020-06-20T05:04:34Z", "path": "ambry-store/src/test/java/com/github/ambry/store/BlobStoreCompactorTest.java", "diffHunk": "@@ -1368,14 +1378,69 @@ public void undeleteSameIndexSegmentTest() throws Exception {\n     // there should be no temp files\n     assertEquals(\"There are some temp log segments\", 0,\n         tempDir.listFiles(BlobStoreCompactor.TEMP_LOG_SEGMENTS_FILTER).length);\n+\n+    state.reloadIndex(true, false);\n+    logSegmentName = p10.getValue().getOffset().getName();\n+    segmentsUnderCompaction = Collections.singletonList(logSegmentName);\n+    deleteReferenceTimeMs = state.time.milliseconds();\n+    endOffsetOfSegmentBeforeCompaction = state.log.getSegment(logSegmentName).getEndOffset();\n+    indexSegmentCountBeforeCompaction = state.index.getIndexSegments().size();", "originalCommit": "52297ca3f93d6398702aebe08c8868feeba161da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dec8105c7799ef215b7bd38f8e7a2b4a5ce9985b", "url": "https://github.com/linkedin/ambry/commit/dec8105c7799ef215b7bd38f8e7a2b4a5ce9985b", "message": "Comments", "committedDate": "2020-06-20T05:09:42Z", "type": "commit"}]}