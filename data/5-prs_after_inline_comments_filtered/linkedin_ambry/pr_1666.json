{"pr_number": 1666, "pr_title": "[named_blobs] Add NamedBlobDB interface/MySQL impl", "pr_createdAt": "2020-10-19T18:57:43Z", "pr_url": "https://github.com/linkedin/ambry/pull/1666", "timeline": [{"oid": "3520f3e95c68efc4ba78bde1e8959481be78dadc", "url": "https://github.com/linkedin/ambry/commit/3520f3e95c68efc4ba78bde1e8959481be78dadc", "message": "[named_blobs] Add NamedBlobDB interface\n\nAdd an interface and a skeleton implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.", "committedDate": "2020-10-22T22:52:17Z", "type": "forcePushed"}, {"oid": "aa8b338c3a293cb4347e0ae5e0dbee698797c3fc", "url": "https://github.com/linkedin/ambry/commit/aa8b338c3a293cb4347e0ae5e0dbee698797c3fc", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nFor the first iteration, this does not include retry and failover to\nother active databases.", "committedDate": "2020-11-12T17:29:07Z", "type": "forcePushed"}, {"oid": "6cdfdcf03b5554f008b9c0fd7382c9030fbff426", "url": "https://github.com/linkedin/ambry/commit/6cdfdcf03b5554f008b9c0fd7382c9030fbff426", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nFor the first iteration, this does not include retry and failover to\nother active databases.", "committedDate": "2020-11-16T21:59:40Z", "type": "forcePushed"}, {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25", "url": "https://github.com/linkedin/ambry/commit/0f2712caca6250a2c756fe33aa7a8374182efa25", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching.", "committedDate": "2020-11-16T23:50:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMDk5Nw==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525530997", "bodyText": "Javadocs", "author": "lightningrob", "createdAt": "2020-11-17T21:19:07Z", "path": "ambry-api/src/main/java/com/github/ambry/named/NamedBlobDb.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Container;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+\n+public interface NamedBlobDb {", "originalCommit": "0f2712caca6250a2c756fe33aa7a8374182efa25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMTY3Ng==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525531676", "bodyText": "Are the methods going to throw only unchecked exceptions on errors?", "author": "lightningrob", "createdAt": "2020-11-17T21:20:16Z", "path": "ambry-api/src/main/java/com/github/ambry/named/NamedBlobDb.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Container;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+\n+public interface NamedBlobDb {\n+  CompletableFuture<NamedBlobRecord> get(String accountName, String containerName, String blobName);", "originalCommit": "0f2712caca6250a2c756fe33aa7a8374182efa25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA0MzMwNg==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r527043306", "bodyText": "Checked exceptions will be communicated asynchronously using the CompletableFuture to simplify the error handling path. So, the synchronous part of this will only throw unchecked exceptions (on coding bugs), or complete the future with a checked exception (on system/user errors).", "author": "cgtz", "createdAt": "2020-11-19T16:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMTY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMjIwNQ==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525532205", "bodyText": "Optional: might be useful to return the NamedBlobRecord with blobId filled in.", "author": "lightningrob", "createdAt": "2020-11-17T21:21:19Z", "path": "ambry-api/src/main/java/com/github/ambry/named/NamedBlobDb.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Container;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+\n+public interface NamedBlobDb {\n+  CompletableFuture<NamedBlobRecord> get(String accountName, String containerName, String blobName);\n+\n+  CompletableFuture<Page<NamedBlobRecord>> list(String accountName, String containerName, String blobNamePrefix, String continuationToken);\n+\n+  CompletableFuture<Void> put(NamedBlobRecord record);", "originalCommit": "0f2712caca6250a2c756fe33aa7a8374182efa25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA0MzkyNg==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r527043926", "bodyText": "The NamedBlobRecord provided already contains the blob ID (since this method is called after Router.putBlob). I do agree that it may be a good practice to have some sort of response object where we can put extra metadata if needed on put/delete requests (may be useful when we support updates).", "author": "cgtz", "createdAt": "2020-11-19T16:55:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMjIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMjgyOA==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525532828", "bodyText": "Will the caller ever need to know if the deletion happened?  Or will this throw an exception on blob not found?", "author": "lightningrob", "createdAt": "2020-11-17T21:22:29Z", "path": "ambry-api/src/main/java/com/github/ambry/named/NamedBlobDb.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Container;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+\n+public interface NamedBlobDb {\n+  CompletableFuture<NamedBlobRecord> get(String accountName, String containerName, String blobName);\n+\n+  CompletableFuture<Page<NamedBlobRecord>> list(String accountName, String containerName, String blobNamePrefix, String continuationToken);\n+\n+  CompletableFuture<Void> put(NamedBlobRecord record);\n+\n+  CompletableFuture<Void> delete(String accountName, String containerName, String blobName);", "originalCommit": "0f2712caca6250a2c756fe33aa7a8374182efa25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA2ODI2Mw==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r527068263", "bodyText": "After, my most recent update, If this returns a success, the deletion will have taken place, or we found that the blob does not exist or was already deleted. I used to have it throw an exception on not found, but i don't think that is really needed since the deletion of the ambry blob would already tell us that. If there is a reason to know that info in the future, I can look at ways of changing this query. i.e. saving info to a variable and then selecting the variable afterwards.", "author": "cgtz", "createdAt": "2020-11-19T17:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMjgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMzMyOA==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525533328", "bodyText": "Minor: javadocs", "author": "lightningrob", "createdAt": "2020-11-17T21:23:24Z", "path": "ambry-api/src/main/java/com/github/ambry/named/NamedBlobRecord.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import java.util.Objects;\n+\n+\n+/**\n+ * Represents a metadata record in a {@link NamedBlobDb} implementation.\n+ */\n+public class NamedBlobRecord {\n+  private final String accountName;\n+  private final String containerName;\n+  private final String blobName;\n+  private final String blobId;\n+  private final long expirationTimeMs;\n+\n+  public NamedBlobRecord(String accountName, String containerName, String blobName, String blobId,\n+      long expirationTimeMs) {\n+    this.accountName = accountName;\n+    this.containerName = containerName;\n+    this.blobName = blobName;\n+    this.blobId = blobId;\n+    this.expirationTimeMs = expirationTimeMs;\n+  }\n+\n+  public String getAccountName() {", "originalCommit": "0f2712caca6250a2c756fe33aa7a8374182efa25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzNTM2Nw==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525535367", "bodyText": "Can you use string constants for table and column names?", "author": "lightningrob", "createdAt": "2020-11-17T21:27:01Z", "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -0,0 +1,290 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Account;\n+import com.github.ambry.account.AccountService;\n+import com.github.ambry.account.Container;\n+import com.github.ambry.mysql.MySqlUtils;\n+import com.github.ambry.mysql.MySqlUtils.DbEndpoint;\n+import com.github.ambry.config.MySqlNamedBlobDbConfig;\n+import com.github.ambry.rest.RestServiceErrorCode;\n+import com.github.ambry.rest.RestServiceException;\n+import com.github.ambry.utils.Utils;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.Statement;\n+import java.sql.Timestamp;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.stream.Collectors;\n+import javax.sql.DataSource;\n+import org.apache.commons.codec.binary.Base64;\n+\n+\n+/**\n+ * An implementation of {@link NamedBlobDb} that uses an active-active MySQL deployment as the source of truth for\n+ * named blob mappings.\n+ *\n+ * It uses the Hikari library for connection pooling, which is a widely used and performant JDBC connection pool\n+ * implementation.\n+ */\n+public class MySqlNamedBlobDb implements NamedBlobDb {\n+  // query building blocks\n+  private static final String IS_DELETED = \"(deleted_ts IS NOT NULL AND deleted_ts <= CURRENT_TIMESTAMP(6))\";", "originalCommit": "0f2712caca6250a2c756fe33aa7a8374182efa25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgzMDQ4MQ==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525830481", "bodyText": "A quick question, if the blob has been deleted or expired, do we need to throw the exception similar like the get method or simply excluding it from the element is good enough? I just feel it might be better if we can tell why some expired blob are not listed.", "author": "SophieGuo410", "createdAt": "2020-11-18T05:51:56Z", "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -0,0 +1,290 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Account;\n+import com.github.ambry.account.AccountService;\n+import com.github.ambry.account.Container;\n+import com.github.ambry.mysql.MySqlUtils;\n+import com.github.ambry.mysql.MySqlUtils.DbEndpoint;\n+import com.github.ambry.config.MySqlNamedBlobDbConfig;\n+import com.github.ambry.rest.RestServiceErrorCode;\n+import com.github.ambry.rest.RestServiceException;\n+import com.github.ambry.utils.Utils;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.Statement;\n+import java.sql.Timestamp;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.stream.Collectors;\n+import javax.sql.DataSource;\n+import org.apache.commons.codec.binary.Base64;\n+\n+\n+/**\n+ * An implementation of {@link NamedBlobDb} that uses an active-active MySQL deployment as the source of truth for\n+ * named blob mappings.\n+ *\n+ * It uses the Hikari library for connection pooling, which is a widely used and performant JDBC connection pool\n+ * implementation.\n+ */\n+public class MySqlNamedBlobDb implements NamedBlobDb {\n+  // query building blocks\n+  private static final String IS_DELETED = \"(deleted_ts IS NOT NULL AND deleted_ts <= CURRENT_TIMESTAMP(6))\";\n+  private static final String IS_EXPIRED = \"(expires_ts IS NOT NULL AND expires_ts <= CURRENT_TIMESTAMP(6))\";\n+  private static final String IS_DELETED_OR_EXPIRED = IS_DELETED + \" OR \" + IS_EXPIRED;\n+  private static final String WHERE_PK_MATCH = \"WHERE (account_id, container_id, blob_name) = (?, ?, ?)\";\n+\n+  /**\n+   * Select a record that matches a blob name (lookup by primary key).\n+   */\n+  private static final String GET_QUERY = \"SELECT blob_id, expires_ts, deleted_ts FROM named_blobs \" + WHERE_PK_MATCH;\n+\n+  /**\n+   * Select records up to a specific limit where the blob name starts with a string prefix. The fourth parameter can\n+   * be used for pagination.\n+   */\n+  private static final String LIST_QUERY = \"SELECT blob_name, blob_id, expires_ts, deleted_ts FROM named_blobs \"\n+      + \"WHERE (account_id, container_id) = (?, ?) AND blob_name LIKE ? AND blob_name >= ? LIMIT ?\";\n+\n+  /**\n+   * Create a blob name to blob ID mapping if a record for that blob name does not exist.\n+   * If there is an existing record but the existing blob was soft deleted or expired, allow it to be overwritten.\n+   * If there is an existing record and the existing blob is still valid (not expired or soft deleted), do not\n+   * overwrite it.\n+   * <p>\n+   * Eventually the put operation will support updates to the mapping in the third case above, but that requires other\n+   * work around concurrency control.\n+   */\n+  private static final String PUT_QUERY = String.format(\n+      \"INSERT INTO named_blobs (account_id, container_id, blob_name, blob_id, expires_ts)\\n\"\n+          + \"VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE\\n\" + \"  blob_id = IF(%1$s, VALUES(blob_id), blob_id),\\n\"\n+          + \"  expires_ts = IF(%1$s, VALUES(expires_ts), expires_ts),\\n\" + \"  deleted_ts = IF(%1$s, null, deleted_ts)\",\n+      IS_DELETED_OR_EXPIRED);\n+\n+  /**\n+   * Soft delete a blob by setting the delete timestamp to the current time if the blob is not already deleted.\n+   */\n+  private static final String DELETE_QUERY =\n+      \"UPDATE named_blobs SET deleted_ts = IF(\" + IS_DELETED + \", deleted_ts, CURRENT_TIMESTAMP(6)) \" + WHERE_PK_MATCH;\n+\n+  private final AccountService accountService;\n+  private final Map<String, DataSource> dcToDataSource;\n+  private final String localDatacenter;\n+  private final ExecutorService executorService;\n+  private final MySqlNamedBlobDbConfig config;\n+\n+  MySqlNamedBlobDb(AccountService accountService, MySqlNamedBlobDbConfig config, DataSourceFactory dataSourceFactory,\n+      String localDatacenter) {\n+    this.accountService = accountService;\n+    this.config = config;\n+    this.localDatacenter = localDatacenter;\n+    this.dcToDataSource = MySqlUtils.getDbEndpointsPerDC(config.dbInfo)\n+        .values()\n+        .stream()\n+        .flatMap(List::stream)\n+        .filter(DbEndpoint::isWriteable)\n+        .collect(Collectors.toMap(DbEndpoint::getDatacenter, dataSourceFactory::getDataSource));\n+    // size this to match the connection pool\n+    executorService = Executors.newFixedThreadPool(config.poolSize);\n+  }\n+\n+  @Override\n+  public CompletableFuture<NamedBlobRecord> get(String accountName, String containerName, String blobName) {\n+    return executeTransactionAsync(accountName, containerName, (accountId, containerId, connection) -> {\n+      try (PreparedStatement statement = connection.prepareStatement(GET_QUERY)) {\n+        statement.setInt(1, accountId);\n+        statement.setInt(2, containerId);\n+        statement.setString(3, blobName);\n+        try (ResultSet resultSet = statement.executeQuery()) {\n+          if (!resultSet.next()) {\n+            throw new RestServiceException(\"Named blob not found\", RestServiceErrorCode.NotFound);\n+          }\n+          String blobId = Base64.encodeBase64URLSafeString(resultSet.getBytes(1));\n+          Timestamp expirationTime = resultSet.getTimestamp(2);\n+          if (expirationTime != null && expirationTime.getTime() < System.currentTimeMillis()) {\n+            throw new RestServiceException(\"Named blob deleted or expired\", RestServiceErrorCode.Deleted);\n+          }\n+          return new NamedBlobRecord(accountName, containerName, blobName, blobId,\n+              expirationTime != null ? expirationTime.getTime() : Utils.Infinite_Time);\n+        }\n+      }\n+    });\n+  }\n+\n+  @Override\n+  public CompletableFuture<Page<NamedBlobRecord>> list(String accountName, String containerName, String blobNamePrefix,\n+      String continuationToken) {\n+    return executeTransactionAsync(accountName, containerName, (accountId, containerId, connection) -> {\n+      try (PreparedStatement statement = connection.prepareStatement(LIST_QUERY)) {\n+        statement.setInt(1, accountId);\n+        statement.setInt(2, containerId);\n+        statement.setString(3, blobNamePrefix + \"%\");\n+        statement.setString(4, continuationToken != null ? continuationToken : blobNamePrefix);\n+        statement.setInt(5, config.listMaxResults + 1);\n+        try (ResultSet resultSet = statement.executeQuery()) {\n+          String nextContinuationToken = null;\n+          List<NamedBlobRecord> elements = new ArrayList<>();\n+          int resultIndex = 0;\n+          while (resultSet.next()) {\n+            if (resultIndex++ == config.listMaxResults) {\n+              nextContinuationToken = resultSet.getString(1);\n+              break;\n+            }\n+            String blobName = resultSet.getString(1);\n+            String blobId = Base64.encodeBase64URLSafeString(resultSet.getBytes(2));\n+            Timestamp expirationTime = resultSet.getTimestamp(3);\n+            Timestamp deletionTime = resultSet.getTimestamp(4);\n+            long currentTime = System.currentTimeMillis();\n+            if (compareTimestamp(expirationTime, currentTime) > 0 && compareTimestamp(deletionTime, currentTime) > 0) {", "originalCommit": "0f2712caca6250a2c756fe33aa7a8374182efa25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3MTM3NA==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r527071374", "bodyText": "I think for now, it is good to exclude them (although I added some trace logging for this case). If there is a use case for knowing which records are expired but still have some elements stored (i.e. include_all flag), we can add support for that in the future.", "author": "cgtz", "createdAt": "2020-11-19T17:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgzMDQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgzNTY3Mw==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525835673", "bodyText": "May I know which module will call this factory to get the db? Are you planning to call it in IdConverter?", "author": "SophieGuo410", "createdAt": "2020-11-18T06:08:48Z", "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDbFactory.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.codahale.metrics.MetricRegistry;\n+import com.github.ambry.account.AccountService;\n+import com.github.ambry.mysql.MySqlUtils.DbEndpoint;\n+import com.github.ambry.config.ClusterMapConfig;\n+import com.github.ambry.config.MySqlNamedBlobDbConfig;\n+import com.github.ambry.config.VerifiableProperties;\n+import com.zaxxer.hikari.HikariConfig;\n+import com.zaxxer.hikari.HikariDataSource;\n+\n+\n+public class MySqlNamedBlobDbFactory implements NamedBlobDbFactory {\n+  private final MySqlNamedBlobDbConfig config;\n+  private final String localDatacenter;\n+  private final MetricRegistry metricRegistry;\n+  private final AccountService accountService;\n+\n+  public MySqlNamedBlobDbFactory(VerifiableProperties verifiableProperties, MetricRegistry metricRegistry,", "originalCommit": "0f2712caca6250a2c756fe33aa7a8374182efa25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3MTgzOQ==", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r527071839", "bodyText": "Yep, let me add the code to add this into IdConverterFactory.", "author": "cgtz", "createdAt": "2020-11-19T17:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgzNTY3Mw=="}], "type": "inlineReview"}, {"oid": "e5782e2d97832af229ff62470449310b1dea62b9", "url": "https://github.com/linkedin/ambry/commit/e5782e2d97832af229ff62470449310b1dea62b9", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching.", "committedDate": "2020-11-19T17:29:59Z", "type": "forcePushed"}, {"oid": "dfae35afadfcab4bba028c6c709eeaf5e056d07d", "url": "https://github.com/linkedin/ambry/commit/dfae35afadfcab4bba028c6c709eeaf5e056d07d", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching.", "committedDate": "2020-11-20T17:29:23Z", "type": "forcePushed"}, {"oid": "64376ca74a96a14c60b9b2b9364e316abb5e9e30", "url": "https://github.com/linkedin/ambry/commit/64376ca74a96a14c60b9b2b9364e316abb5e9e30", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching.", "committedDate": "2020-11-20T17:33:42Z", "type": "forcePushed"}, {"oid": "02ad8538350427e9d89fc9526759e3e3fcdbaf35", "url": "https://github.com/linkedin/ambry/commit/02ad8538350427e9d89fc9526759e3e3fcdbaf35", "message": "Minor fixes", "committedDate": "2020-11-20T23:58:52Z", "type": "forcePushed"}, {"oid": "880076267ad41878cbf5bcd7f0cb46c4ccf8fcfd", "url": "https://github.com/linkedin/ambry/commit/880076267ad41878cbf5bcd7f0cb46c4ccf8fcfd", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching.", "committedDate": "2020-11-21T00:29:06Z", "type": "commit"}, {"oid": "6bdf16484b23beebd37d4e77cd7fd9039bbbacfb", "url": "https://github.com/linkedin/ambry/commit/6bdf16484b23beebd37d4e77cd7fd9039bbbacfb", "message": "Add config for NamedBlobDbFactory", "committedDate": "2020-11-21T00:29:06Z", "type": "commit"}, {"oid": "a0ef486eb65341d1894a43c512a488c2871a9276", "url": "https://github.com/linkedin/ambry/commit/a0ef486eb65341d1894a43c512a488c2871a9276", "message": "Minor fixes", "committedDate": "2020-11-21T00:29:06Z", "type": "commit"}, {"oid": "a0ef486eb65341d1894a43c512a488c2871a9276", "url": "https://github.com/linkedin/ambry/commit/a0ef486eb65341d1894a43c512a488c2871a9276", "message": "Minor fixes", "committedDate": "2020-11-21T00:29:06Z", "type": "forcePushed"}, {"oid": "c2d914421db62029a7a9f8ab046cdc71563f771c", "url": "https://github.com/linkedin/ambry/commit/c2d914421db62029a7a9f8ab046cdc71563f771c", "message": "fix rebase issue", "committedDate": "2020-11-21T01:00:03Z", "type": "commit"}]}