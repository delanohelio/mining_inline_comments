{"pr_number": 1475, "pr_title": "Create config for datacenter from which cloud replication is allowed.", "pr_createdAt": "2020-04-15T22:53:08Z", "pr_url": "https://github.com/linkedin/ambry/pull/1475", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NDUzOQ==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409784539", "bodyText": "I don't have much context of cloud but I am trying to understand the config cloudIsVcr, so there are two types of nodes related to Cloud. One is VCR, in my impression, it is supposed to replicate blobs from regular ambry server to Azure (correct me if I am wrong). What is the other type of cloud node?", "author": "jsjtzyy", "createdAt": "2020-04-16T19:04:51Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/VcrReplicationManager.java", "diffHunk": "@@ -79,6 +77,12 @@ public VcrReplicationManager(VerifiableProperties properties, CloudConfig cloudC\n     this.cloudStorageCompactor =\n         cloudConfig.cloudBlobCompactionEnabled ? new CloudStorageCompactor(cloudDestination, cloudConfig,\n             partitionToPartitionInfo.keySet(), vcrMetrics) : null;\n+    // We need a datacenter to replicate from. For DR, we currently deploy VCR nodes on same datacenter as ambry-server.\n+    // For serving data from cloud, we must specify the ambry-server datacenter(s) from which to replicate.\n+    if (!cloudConfig.cloudIsVcr && cloudConfig.vcrCrossColoReplicationPeerDatacenters.isEmpty()) {", "originalCommit": "b0274726e91b61ac65bdcbc2e806f73e37d1ad83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4OTQ5MA==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409789490", "bodyText": "cloudIsVcr is used to tell the CloudBlobStore if it is being used by the VCR (true) or by the frontend (live serving).  VcrReplicationManager should never be created when isVcr = false", "author": "lightningrob", "createdAt": "2020-04-16T19:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NDUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MjM4Ng==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409792386", "bodyText": "I see. Then, I have some difficulties understanding the cloudIsVcr being checked in VcrReplicationManager. I suppose it should be VCR already before instantiating the VcrReplicationManager.", "author": "jsjtzyy", "createdAt": "2020-04-16T19:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NDUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyOTAwNg==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409829006", "bodyText": "I was under the wrong impression that cloudIsVcr would be true for all cases related to DR, and false otherwise (even though I now realize that comments in CloudBlobStore say so).\nSince thats not the case, I guess the suggestion to always use vcrSourceDatacenters (vcrCrossColoReplicationPeerDatacenters) to get the list of DCs to replicate from makes sense.\nI will make the required changes.", "author": "ankagrawal", "createdAt": "2020-04-16T20:29:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NDUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MDc4NA==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409790784", "bodyText": "This is very long.  How about VCR_SOURCE_DATACENTERS and a comment explaining it?", "author": "lightningrob", "createdAt": "2020-04-16T19:16:24Z", "path": "ambry-api/src/main/java/com/github/ambry/config/CloudConfig.java", "diffHunk": "@@ -45,6 +50,7 @@\n   public static final String VCR_PROXY_HOST = \"vcr.proxy.host\";\n   public static final String VCR_PROXY_PORT = \"vcr.proxy.port\";\n   public static final String VCR_CLUSTER_SPECTATOR_FACTORY_CLASS = \"vcr.cluster.spectator.factory.class\";\n+  public static final String VCR_CROSS_COLO_REPLICATION_PEER_DATACENTERS = \"vcr.cross.colo.replication.peer.datacenter\";", "originalCommit": "b0274726e91b61ac65bdcbc2e806f73e37d1ad83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyOTE2NQ==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409829165", "bodyText": "sure.", "author": "ankagrawal", "createdAt": "2020-04-16T20:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MDc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MTgwNA==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409791804", "bodyText": "vcrSourceDataCenters", "author": "lightningrob", "createdAt": "2020-04-16T19:18:14Z", "path": "ambry-api/src/main/java/com/github/ambry/config/CloudConfig.java", "diffHunk": "@@ -262,6 +268,13 @@\n   @Default(DEFAULT_VCR_CLUSTER_SPECTATOR_FACTORY_CLASS)\n   public final String vcrClusterSpectatorFactoryClass;\n \n+  /**\n+   * Comma separated set of datacenters which can act as peer for cross colo replication.\n+   */\n+  @Config(VCR_CROSS_COLO_REPLICATION_PEER_DATACENTERS)\n+  @Default(\"\")\n+  public final Set<String> vcrCrossColoReplicationPeerDatacenters;", "originalCommit": "b0274726e91b61ac65bdcbc2e806f73e37d1ad83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyOTIwMw==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409829203", "bodyText": "ok", "author": "ankagrawal", "createdAt": "2020-04-16T20:29:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MTgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5Mjg3NQ==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409792875", "bodyText": "If cloudIsVcr is false here, that alone would be an illegal state.", "author": "lightningrob", "createdAt": "2020-04-16T19:20:04Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/VcrReplicationManager.java", "diffHunk": "@@ -79,6 +77,12 @@ public VcrReplicationManager(VerifiableProperties properties, CloudConfig cloudC\n     this.cloudStorageCompactor =\n         cloudConfig.cloudBlobCompactionEnabled ? new CloudStorageCompactor(cloudDestination, cloudConfig,\n             partitionToPartitionInfo.keySet(), vcrMetrics) : null;\n+    // We need a datacenter to replicate from. For DR, we currently deploy VCR nodes on same datacenter as ambry-server.\n+    // For serving data from cloud, we must specify the ambry-server datacenter(s) from which to replicate.\n+    if (!cloudConfig.cloudIsVcr && cloudConfig.vcrCrossColoReplicationPeerDatacenters.isEmpty()) {", "originalCommit": "b0274726e91b61ac65bdcbc2e806f73e37d1ad83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyOTI5MA==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409829290", "bodyText": "true", "author": "ankagrawal", "createdAt": "2020-04-16T20:29:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5Mjg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5Mzg2Mg==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409793862", "bodyText": "Simplify to \"One or more VCR cross colo replication peer datacenter should be specified\"", "author": "lightningrob", "createdAt": "2020-04-16T19:21:52Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/VcrReplicationManager.java", "diffHunk": "@@ -79,6 +77,12 @@ public VcrReplicationManager(VerifiableProperties properties, CloudConfig cloudC\n     this.cloudStorageCompactor =\n         cloudConfig.cloudBlobCompactionEnabled ? new CloudStorageCompactor(cloudDestination, cloudConfig,\n             partitionToPartitionInfo.keySet(), vcrMetrics) : null;\n+    // We need a datacenter to replicate from. For DR, we currently deploy VCR nodes on same datacenter as ambry-server.\n+    // For serving data from cloud, we must specify the ambry-server datacenter(s) from which to replicate.\n+    if (!cloudConfig.cloudIsVcr && cloudConfig.vcrCrossColoReplicationPeerDatacenters.isEmpty()) {\n+      throw new IllegalStateException(\n+          \"Either this should be a vcr replicator OR one or more vcr cross colo replication peer datacenter should be specified\");", "originalCommit": "b0274726e91b61ac65bdcbc2e806f73e37d1ad83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyOTM1NA==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409829354", "bodyText": "ok", "author": "ankagrawal", "createdAt": "2020-04-16T20:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5Mzg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NjEwNA==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409796104", "bodyText": "cloudIsVcr will be true in both cases.  Perhaps it's time to add another config property like isBackup?\nBut I think we can use the new logic for both scenarios, and update the DR config to tell it which DC to use.", "author": "lightningrob", "createdAt": "2020-04-16T19:25:58Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/VcrReplicationManager.java", "diffHunk": "@@ -236,4 +240,18 @@ public long getRemoteReplicaLagFromLocalInBytes(PartitionId partitionId, String\n     // TODO get replica lag from cosmos?\n     return -1;\n   }\n+\n+  /**\n+   * Check if replication is allowed from given datacenter.\n+   * @param datacenterName datacenter name to check.\n+   * @return true if replication is allowed. false otherwise.\n+   */\n+  private boolean shouldReplicateFromDc(String datacenterName) {\n+    if (cloudConfig.cloudIsVcr) {", "originalCommit": "b0274726e91b61ac65bdcbc2e806f73e37d1ad83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgzMDUxMg==", "url": "https://github.com/linkedin/ambry/pull/1475#discussion_r409830512", "bodyText": "sure.. as of now I don't see any other explicit need for a separate config for backup, so I will use the same config for all cases. We can revisit if we need a separate config for backup if an explicit need arises.", "author": "ankagrawal", "createdAt": "2020-04-16T20:31:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NjEwNA=="}], "type": "inlineReview"}, {"oid": "f3a40e462e88b700ce17261e82e906eabf932de4", "url": "https://github.com/linkedin/ambry/commit/f3a40e462e88b700ce17261e82e906eabf932de4", "message": "Address review comments", "committedDate": "2020-04-16T20:46:13Z", "type": "forcePushed"}, {"oid": "df751e884c19a0a221a691fb7796e7330353de46", "url": "https://github.com/linkedin/ambry/commit/df751e884c19a0a221a691fb7796e7330353de46", "message": "Create config for datacenter from which cloud replication is allowed.", "committedDate": "2020-04-20T19:58:19Z", "type": "commit"}, {"oid": "d87aa9425cfe4a07c3d1e7b39d656fdce6203077", "url": "https://github.com/linkedin/ambry/commit/d87aa9425cfe4a07c3d1e7b39d656fdce6203077", "message": "Address review comments", "committedDate": "2020-04-20T19:58:19Z", "type": "commit"}, {"oid": "a68862fccf2f33f0d054ea3cab06ffd547a4a7e6", "url": "https://github.com/linkedin/ambry/commit/a68862fccf2f33f0d054ea3cab06ffd547a4a7e6", "message": "Add missing newline", "committedDate": "2020-04-20T19:58:19Z", "type": "commit"}, {"oid": "3c0a1af095a28139a21216770346fdb0ee6d8ba1", "url": "https://github.com/linkedin/ambry/commit/3c0a1af095a28139a21216770346fdb0ee6d8ba1", "message": "Fix test", "committedDate": "2020-04-20T20:30:02Z", "type": "commit"}, {"oid": "3c0a1af095a28139a21216770346fdb0ee6d8ba1", "url": "https://github.com/linkedin/ambry/commit/3c0a1af095a28139a21216770346fdb0ee6d8ba1", "message": "Fix test", "committedDate": "2020-04-20T20:30:02Z", "type": "forcePushed"}]}