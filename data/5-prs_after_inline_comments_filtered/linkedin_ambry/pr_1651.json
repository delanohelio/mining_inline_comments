{"pr_number": 1651, "pr_title": "[Container scalability] Support for taking multiple MySql end points", "pr_createdAt": "2020-10-08T00:50:42Z", "pr_url": "https://github.com/linkedin/ambry/pull/1651", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwNjY0NQ==", "url": "https://github.com/linkedin/ambry/pull/1651#discussion_r502206645", "bodyText": "Any reason this class and the store class can't live in account/mysql package?", "author": "lightningrob", "createdAt": "2020-10-09T06:05:02Z", "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountStoreFactory.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.account;", "originalCommit": "4308e556b66e5cbfae4f46277e471c60a73b3ac6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwNzAyNw==", "url": "https://github.com/linkedin/ambry/pull/1651#discussion_r502207027", "bodyText": "Minor: can simply return the new store here.", "author": "lightningrob", "createdAt": "2020-10-09T06:06:14Z", "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountStoreFactory.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.account;\n+\n+import com.github.ambry.config.MySqlAccountServiceConfig;\n+import com.github.ambry.config.VerifiableProperties;\n+import java.sql.SQLException;\n+import java.util.List;\n+import java.util.Map;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import static com.github.ambry.account.MySqlUtils.*;\n+\n+\n+/**\n+ * Factory class to return an instance of {@link MySqlAccountStore} on {@link #getMySqlAccountStore(boolean)} call\n+ */\n+public class MySqlAccountStoreFactory {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(MySqlAccountStoreFactory.class);\n+  protected final MySqlAccountServiceConfig accountServiceConfig;\n+\n+  /**\n+   * Constructor.\n+   * @param  verifiableProperties The properties to get a {@link MySqlAccountStore} instance. Cannot be {@code null}.\n+   */\n+  public MySqlAccountStoreFactory(VerifiableProperties verifiableProperties) {\n+    this.accountServiceConfig = new MySqlAccountServiceConfig(verifiableProperties);\n+  }\n+\n+  /**\n+   * Returns an instance of the {@link MySqlAccountStore} that the factory generates.\n+   * @param writeable needs to be set to true if requesting a store that accepts writes.\n+   * @return an instance of {@link MySqlAccountStore} generated by this factory.\n+   * @throws SQLException\n+   */\n+  public MySqlAccountStore getMySqlAccountStore(boolean writeable) throws SQLException {\n+    Map<String, List<MySqlUtils.DBEndPoint>> dcToMySqlDBEndPoints = getDBEndPointsPerDC(accountServiceConfig.dbInfo);\n+    MySqlAccountStore mySqlAccountStore = null;\n+    for (List<MySqlUtils.DBEndPoint> dbEndPoints : dcToMySqlDBEndPoints.values()) {\n+      // TODO: Can have logic to try mysql end point on local DC first\n+      for (MySqlUtils.DBEndPoint dbEndPoint : dbEndPoints) {\n+        if ((dbEndPoint.isWriteable() && writeable) || (!dbEndPoint.isWriteable() && !writeable)) {\n+          try {\n+            mySqlAccountStore = new MySqlAccountStore(dbEndPoint);", "originalCommit": "4308e556b66e5cbfae4f46277e471c60a73b3ac6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwNzE0MA==", "url": "https://github.com/linkedin/ambry/pull/1651#discussion_r502207140", "bodyText": "Please move to account/mysql package.", "author": "lightningrob", "createdAt": "2020-10-09T06:06:39Z", "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlUtils.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.account;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+\n+/**\n+ * Contains utils methods for MySqlAccountService\n+ */\n+public class MySqlUtils {", "originalCommit": "4308e556b66e5cbfae4f46277e471c60a73b3ac6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwNzMyNQ==", "url": "https://github.com/linkedin/ambry/pull/1651#discussion_r502207325", "bodyText": "getDbEndpointsPerDc", "author": "lightningrob", "createdAt": "2020-10-09T06:07:17Z", "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlUtils.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.account;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+\n+/**\n+ * Contains utils methods for MySqlAccountService\n+ */\n+public class MySqlUtils {\n+\n+  static final String DBINFO_STR = \"dbInfo\";\n+  static final String URL_STR = \"url\";\n+  static final String DATACENTER_STR = \"datacenter\";\n+  static final String ISWRITEABLE_STR = \"isWriteable\";\n+  static final String USERNAME_STR = \"username\";\n+  static final String PASSWORD_STR = \"password\";\n+\n+  /**\n+   * Parses DB information JSON string and returns a map of datacenter name to list of {@link DBEndPoint}s.\n+   * @param dbInfoJsonString the string containing the MySql DB info.\n+   * @return a map of dcName -> list of {@link DBEndPoint}s.\n+   * @throws JSONException if there is an error parsing the JSON.\n+   */\n+  public static Map<String, List<DBEndPoint>> getDBEndPointsPerDC(String dbInfoJsonString) throws JSONException {", "originalCommit": "4308e556b66e5cbfae4f46277e471c60a73b3ac6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwNzU0MA==", "url": "https://github.com/linkedin/ambry/pull/1651#discussion_r502207540", "bodyText": "DbEndPoint.  Or even DbEndpoint since endpoint is one word.", "author": "lightningrob", "createdAt": "2020-10-09T06:08:05Z", "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlUtils.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.account;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+\n+/**\n+ * Contains utils methods for MySqlAccountService\n+ */\n+public class MySqlUtils {\n+\n+  static final String DBINFO_STR = \"dbInfo\";\n+  static final String URL_STR = \"url\";\n+  static final String DATACENTER_STR = \"datacenter\";\n+  static final String ISWRITEABLE_STR = \"isWriteable\";\n+  static final String USERNAME_STR = \"username\";\n+  static final String PASSWORD_STR = \"password\";\n+\n+  /**\n+   * Parses DB information JSON string and returns a map of datacenter name to list of {@link DBEndPoint}s.\n+   * @param dbInfoJsonString the string containing the MySql DB info.\n+   * @return a map of dcName -> list of {@link DBEndPoint}s.\n+   * @throws JSONException if there is an error parsing the JSON.\n+   */\n+  public static Map<String, List<DBEndPoint>> getDBEndPointsPerDC(String dbInfoJsonString) throws JSONException {\n+    Map<String, List<DBEndPoint>> dcToDbEndPoints = new HashMap<>();\n+\n+    JSONObject jsonObject = new JSONObject(dbInfoJsonString);\n+    JSONArray dbInfo = jsonObject.getJSONArray(DBINFO_STR);\n+    for (int i = 0; i < dbInfo.length(); i++) {\n+      JSONObject entry = dbInfo.getJSONObject(i);\n+      String url = entry.getString(URL_STR);\n+      String datacenter = entry.getString(DATACENTER_STR);\n+      boolean isWriteable = entry.getBoolean(ISWRITEABLE_STR);\n+      String username = entry.getString(USERNAME_STR);\n+      String password = entry.getString(PASSWORD_STR);\n+      dcToDbEndPoints.computeIfAbsent(datacenter, key -> new ArrayList<>())\n+          .add(new DBEndPoint(url, datacenter, isWriteable, username, password));\n+    }\n+    return dcToDbEndPoints;\n+  }\n+\n+  /**\n+   * Stores information of a mysql db endpoint\n+   */\n+  public static class DBEndPoint {", "originalCommit": "4308e556b66e5cbfae4f46277e471c60a73b3ac6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwNzc1Ng==", "url": "https://github.com/linkedin/ambry/pull/1651#discussion_r502207756", "bodyText": "Nit: for getter methods, only need the @return line.", "author": "lightningrob", "createdAt": "2020-10-09T06:08:50Z", "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlUtils.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.account;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+\n+/**\n+ * Contains utils methods for MySqlAccountService\n+ */\n+public class MySqlUtils {\n+\n+  static final String DBINFO_STR = \"dbInfo\";\n+  static final String URL_STR = \"url\";\n+  static final String DATACENTER_STR = \"datacenter\";\n+  static final String ISWRITEABLE_STR = \"isWriteable\";\n+  static final String USERNAME_STR = \"username\";\n+  static final String PASSWORD_STR = \"password\";\n+\n+  /**\n+   * Parses DB information JSON string and returns a map of datacenter name to list of {@link DBEndPoint}s.\n+   * @param dbInfoJsonString the string containing the MySql DB info.\n+   * @return a map of dcName -> list of {@link DBEndPoint}s.\n+   * @throws JSONException if there is an error parsing the JSON.\n+   */\n+  public static Map<String, List<DBEndPoint>> getDBEndPointsPerDC(String dbInfoJsonString) throws JSONException {\n+    Map<String, List<DBEndPoint>> dcToDbEndPoints = new HashMap<>();\n+\n+    JSONObject jsonObject = new JSONObject(dbInfoJsonString);\n+    JSONArray dbInfo = jsonObject.getJSONArray(DBINFO_STR);\n+    for (int i = 0; i < dbInfo.length(); i++) {\n+      JSONObject entry = dbInfo.getJSONObject(i);\n+      String url = entry.getString(URL_STR);\n+      String datacenter = entry.getString(DATACENTER_STR);\n+      boolean isWriteable = entry.getBoolean(ISWRITEABLE_STR);\n+      String username = entry.getString(USERNAME_STR);\n+      String password = entry.getString(PASSWORD_STR);\n+      dcToDbEndPoints.computeIfAbsent(datacenter, key -> new ArrayList<>())\n+          .add(new DBEndPoint(url, datacenter, isWriteable, username, password));\n+    }\n+    return dcToDbEndPoints;\n+  }\n+\n+  /**\n+   * Stores information of a mysql db endpoint\n+   */\n+  public static class DBEndPoint {\n+    private final String url;\n+    private final String datacenter;\n+    private final boolean isWriteable;\n+    private final String username;\n+    private final String password;\n+\n+    public DBEndPoint(String url, String datacenter, boolean isWriteable, String username, String password) {\n+      this.url = url;\n+      this.datacenter = datacenter;\n+      this.isWriteable = isWriteable;\n+      this.username = username;\n+      this.password = password;\n+    }\n+\n+    /**\n+     * Gets db url\n+     * @return url of the db", "originalCommit": "4308e556b66e5cbfae4f46277e471c60a73b3ac6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwODgwNg==", "url": "https://github.com/linkedin/ambry/pull/1651#discussion_r502208806", "bodyText": "Minor: wondering if we need the top level field or just use a simple array.  If zkInfo does the same thing we can keep it consistent.", "author": "lightningrob", "createdAt": "2020-10-09T06:12:13Z", "path": "ambry-api/src/main/java/com/github/ambry/config/MySqlAccountServiceConfig.java", "diffHunk": "@@ -29,27 +27,39 @@\n   public static final String UPDATE_DISABLED = MYSQL_ACCOUNT_SERVICE_PREFIX + \"update.disabled\";\n   private static final String MAX_BACKUP_FILE_COUNT = MYSQL_ACCOUNT_SERVICE_PREFIX + \"max.backup.file.count\";\n \n-  // TODO: Might need to take an array of URLs which would have one write (master) and multiple read urls (backup)\n   /**\n-   * URL of the mysql database.\n+   * Serialized json containing the information about all mysql end points. This information should be of the following form:\n+   * <pre>\n+   * {\n+   *   \"dbInfo\" : [", "originalCommit": "4308e556b66e5cbfae4f46277e471c60a73b3ac6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "94838471ed4a22aa1ce0406785f6e124ff987961", "url": "https://github.com/linkedin/ambry/commit/94838471ed4a22aa1ce0406785f6e124ff987961", "message": "1. Support for taking multiple MySql end points\n2. Move MySqlUtils and MySqlAccountStore/factory to account/mysql package", "committedDate": "2020-10-10T00:52:19Z", "type": "commit"}, {"oid": "165c2902612ad316cc54f487c8cb6695ccc780c4", "url": "https://github.com/linkedin/ambry/commit/165c2902612ad316cc54f487c8cb6695ccc780c4", "message": "Update MySqlAccountService tests to use modified config and store factory class", "committedDate": "2020-10-12T02:30:00Z", "type": "commit"}, {"oid": "165c2902612ad316cc54f487c8cb6695ccc780c4", "url": "https://github.com/linkedin/ambry/commit/165c2902612ad316cc54f487c8cb6695ccc780c4", "message": "Update MySqlAccountService tests to use modified config and store factory class", "committedDate": "2020-10-12T02:30:00Z", "type": "forcePushed"}, {"oid": "122f86497f4ad7d0dd1d6946305558ae2c5f7327", "url": "https://github.com/linkedin/ambry/commit/122f86497f4ad7d0dd1d6946305558ae2c5f7327", "message": "Fix compilation error", "committedDate": "2020-10-12T04:26:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxNzkzNw==", "url": "https://github.com/linkedin/ambry/pull/1651#discussion_r503417937", "bodyText": "Optional: This probably justifies a metric (and we can set up alert on it).", "author": "jsjtzyy", "createdAt": "2020-10-12T16:50:37Z", "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "diffHunk": "@@ -51,13 +53,24 @@\n   private final ReadWriteLock infoMapLock = new ReentrantReadWriteLock();\n   private final ScheduledExecutorService scheduler;\n   private final BackupFileManager backupFileManager;\n+  // TODO: we could have two stores (master for writes/reads and replica for reads during failover)\n   private volatile MySqlAccountStore mySqlAccountStore;\n+  private final MySqlAccountStoreFactory mySqlAccountStoreFactory;\n \n   public MySqlAccountService(AccountServiceMetrics accountServiceMetrics, MySqlAccountServiceConfig config,\n-      MySqlAccountStore mySqlAccountStore) throws IOException {\n+      MySqlAccountStoreFactory mySqlAccountStoreFactory) throws IOException {\n     super(config, Objects.requireNonNull(accountServiceMetrics, \"accountServiceMetrics cannot be null\"));\n     this.config = config;\n-    this.mySqlAccountStore = mySqlAccountStore;\n+    this.mySqlAccountStoreFactory = mySqlAccountStoreFactory;\n+    try {\n+      this.mySqlAccountStore = mySqlAccountStoreFactory.getMySqlAccountStore(true);\n+    } catch (SQLException e) {\n+      logger.error(\"MySQL account store creation failed\", e);\n+      //TODO: If it is a non-transient error like credential issue, we should fail creation of MySqlAccountService and\n+      // return error. Else, continue account service creation and initialize cache with metadata from local file copy\n+      // to serve read requests. Connection to MySql DB will be retried during periodic sync. Until then, write\n+      // requests will be blocked.", "originalCommit": "122f86497f4ad7d0dd1d6946305558ae2c5f7327", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMDg3Mw==", "url": "https://github.com/linkedin/ambry/pull/1651#discussion_r503420873", "bodyText": "Btw, error type triage will be in future PR, correct?  I suppose the logic to fail account service creation due to non-transient error will be added later.", "author": "jsjtzyy", "createdAt": "2020-10-12T16:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxNzkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ4OTI3MA==", "url": "https://github.com/linkedin/ambry/pull/1651#discussion_r503489270", "bodyText": "Yes.  I am working on that in a separate PR related to error handling.", "author": "lightningrob", "createdAt": "2020-10-12T19:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxNzkzNw=="}], "type": "inlineReview"}]}