{"pr_number": 1453, "pr_title": "Log the peer leader replica info in onPartitionBecomeLeaderFromStandBy", "pr_createdAt": "2020-04-03T00:08:58Z", "pr_url": "https://github.com/linkedin/ambry/pull/1453", "timeline": [{"oid": "21046b2bab764cbe04e631889f819d9843657e81", "url": "https://github.com/linkedin/ambry/commit/21046b2bab764cbe04e631889f819d9843657e81", "message": "Add tests for logging of peer leader replicas on partition state changes", "committedDate": "2020-04-06T23:39:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk0NzQwMw==", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404947403", "bodyText": "After PR #1452 is merged, please rebase and fix conflict if needed", "author": "jsjtzyy", "createdAt": "2020-04-07T16:30:05Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixParticipant.java", "diffHunk": "@@ -510,6 +516,12 @@ public void onPartitionBecomeStandbyFromLeader(String partitionName) {\n     if (cloudToStoreReplicationListener != null) {\n       cloudToStoreReplicationListener.onPartitionBecomeStandbyFromLeader(partitionName);\n     }\n+\n+    PartitionStateChangeListener replicationManagerListener =\n+        partitionStateChangeListeners.get(StateModelListenerType.ReplicationManagerListener);\n+    if (replicationManagerListener != null) {\n+      replicationManagerListener.onPartitionBecomeStandbyFromLeader(partitionName);\n+    }", "originalCommit": "21046b2bab764cbe04e631889f819d9843657e81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1MTA2Mw==", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404951063", "bodyText": "not used, can be removed", "author": "jsjtzyy", "createdAt": "2020-04-07T16:35:27Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicationManager.java", "diffHunk": "@@ -47,6 +49,7 @@\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.stream.Collectors;\n \n+import static com.github.ambry.clustermap.ClusterMapUtils.*;", "originalCommit": "21046b2bab764cbe04e631889f819d9843657e81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1MTgxNw==", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404951817", "bodyText": "This can be package private. Also add java doc to this method please.", "author": "jsjtzyy", "createdAt": "2020-04-07T16:36:36Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicationManager.java", "diffHunk": "@@ -241,6 +244,10 @@ private void updatePartitionInfoMaps(List<RemoteReplicaInfo> remoteReplicaInfos,\n         .add(partitionInfo);\n   }\n \n+  public Map<String, List<ReplicaId>> getPeerLeaderReplicasByPartition() {", "originalCommit": "21046b2bab764cbe04e631889f819d9843657e81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2NzIwNQ==", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404967205", "bodyText": "minor: I noticed AmbryDataNode.toString() will print out DataNode, so you can remove Node in your log message.", "author": "jsjtzyy", "createdAt": "2020-04-07T16:59:15Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicationManager.java", "diffHunk": "@@ -373,12 +380,34 @@ public void onPartitionBecomeStandbyFromBootstrap(String partitionName) {\n     public void onPartitionBecomeLeaderFromStandby(String partitionName) {\n       logger.info(\"Partition state change notification from Standby to Leader received for partition {}\",\n           partitionName);\n+      //Changes for leader based replication - for now, we just log the list of peer leader replicas\n+      // 1. get replica ID of current node from store manager\n+      ReplicaId localReplica = storeManager.getReplica(partitionName);\n+\n+      // 2. Get the peer leader replicas from all data centers for this partition\n+      List<? extends ReplicaId> leaderReplicas =\n+          localReplica.getPartitionId().getReplicaIdsByState(ReplicaState.LEADER, null);\n+\n+      // 3. Log the list of leader replicas associated with this partition (will be used later for leadership based replication)\n+      List<ReplicaId> peerLeaderReplicas = new ArrayList<>();\n+      for (ReplicaId leaderReplica : leaderReplicas) {\n+        if (leaderReplica.getDataNodeId() != localReplica.getDataNodeId()) {\n+          peerLeaderReplicas.add(leaderReplica);\n+          logger.info(\"Partition {} on Node {} is leader in remote dc {}\", partitionName,", "originalCommit": "21046b2bab764cbe04e631889f819d9843657e81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MDQzOQ==", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404970439", "bodyText": "nit: CamelCase currentDataCenter", "author": "jsjtzyy", "createdAt": "2020-04-07T17:04:00Z", "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "diffHunk": "@@ -601,7 +602,18 @@ public void replicaFromStandbyToLeaderTest() throws Exception {\n     StorageManager storageManager = managers.getFirst();\n     MockReplicationManager replicationManager = (MockReplicationManager) managers.getSecond();\n     PartitionId existingPartition = replicationManager.partitionToPartitionInfo.keySet().iterator().next();\n+    String currentdatacenter =", "originalCommit": "21046b2bab764cbe04e631889f819d9843657e81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MDkwMA==", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404970900", "bodyText": "Also, update the comment of this method please.", "author": "jsjtzyy", "createdAt": "2020-04-07T17:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MDQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MjI4Nw==", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404972287", "bodyText": "minor: can remove this cast (List<ReplicaId>)", "author": "jsjtzyy", "createdAt": "2020-04-07T17:06:37Z", "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "diffHunk": "@@ -601,7 +602,18 @@ public void replicaFromStandbyToLeaderTest() throws Exception {\n     StorageManager storageManager = managers.getFirst();\n     MockReplicationManager replicationManager = (MockReplicationManager) managers.getSecond();\n     PartitionId existingPartition = replicationManager.partitionToPartitionInfo.keySet().iterator().next();\n+    String currentdatacenter =\n+        storageManager.getReplica(existingPartition.toString()).getDataNodeId().getDatacenterName();\n     mockHelixParticipant.onPartitionBecomeLeaderFromStandby(existingPartition.toPathString());\n+    List<ReplicaId> peerLeaderReplicasInReplicationManager =\n+        replicationManager.getPeerLeaderReplicasByPartition().get(existingPartition.toString());\n+    List<ReplicaId> peerLeaderReplicasInClusterMap =\n+        (List<ReplicaId>) existingPartition.getReplicaIdsByState(ReplicaState.LEADER, null)", "originalCommit": "21046b2bab764cbe04e631889f819d9843657e81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3Mjk0Nw==", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404972947", "bodyText": "Since you also made changes in LEADER -> STANDBY transition in replication manager, could you also add a test for this case?  (in replicaFromLeaderToStandbyTest)", "author": "jsjtzyy", "createdAt": "2020-04-07T17:07:41Z", "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "diffHunk": "@@ -601,7 +602,18 @@ public void replicaFromStandbyToLeaderTest() throws Exception {\n     StorageManager storageManager = managers.getFirst();\n     MockReplicationManager replicationManager = (MockReplicationManager) managers.getSecond();\n     PartitionId existingPartition = replicationManager.partitionToPartitionInfo.keySet().iterator().next();\n+    String currentdatacenter =\n+        storageManager.getReplica(existingPartition.toString()).getDataNodeId().getDatacenterName();\n     mockHelixParticipant.onPartitionBecomeLeaderFromStandby(existingPartition.toPathString());\n+    List<ReplicaId> peerLeaderReplicasInReplicationManager =\n+        replicationManager.getPeerLeaderReplicasByPartition().get(existingPartition.toString());\n+    List<ReplicaId> peerLeaderReplicasInClusterMap =\n+        (List<ReplicaId>) existingPartition.getReplicaIdsByState(ReplicaState.LEADER, null)\n+            .stream()\n+            .filter(r -> !r.getDataNodeId().getDatacenterName().equals(currentdatacenter))\n+            .collect(Collectors.toList());\n+    assertThat(\"mismatch in leader peer replicas\", peerLeaderReplicasInReplicationManager,\n+        is(peerLeaderReplicasInClusterMap));\n     storageManager.shutdown();\n   }", "originalCommit": "21046b2bab764cbe04e631889f819d9843657e81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MzY5NQ==", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404973695", "bodyText": "nit: dataCenters", "author": "jsjtzyy", "createdAt": "2020-04-07T17:08:50Z", "path": "ambry-test-utils/src/main/java/com/github/ambry/clustermap/MockPartitionId.java", "diffHunk": "@@ -53,10 +55,16 @@ public MockPartitionId(long partition, String partitionClass, List<MockDataNodeI\n     this.partitionClass = partitionClass;\n     this.replicaIds = new ArrayList<>(dataNodes.size());\n     replicaAndState = new HashMap<>();\n+    Set<String> datacenters = new HashSet<>();", "originalCommit": "21046b2bab764cbe04e631889f819d9843657e81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8724549b5ebe9517ecf2bdfd8e6053d212f93c0d", "url": "https://github.com/linkedin/ambry/commit/8724549b5ebe9517ecf2bdfd8e6053d212f93c0d", "message": "Changes to resolve conflicts and address comments", "committedDate": "2020-04-08T18:58:10Z", "type": "commit"}, {"oid": "2f8b80c632dc916aaf85e48ca845049982a8e226", "url": "https://github.com/linkedin/ambry/commit/2f8b80c632dc916aaf85e48ca845049982a8e226", "message": "Merging changes added to address comments on pr 1453\nMerge branch 'pull-1453'", "committedDate": "2020-04-08T19:04:24Z", "type": "commit"}, {"oid": "a0964a07491ac5c0f9f0a69105f6b7598978faa7", "url": "https://github.com/linkedin/ambry/commit/a0964a07491ac5c0f9f0a69105f6b7598978faa7", "message": "Log the peer leader replica info in onPartitionBecomeLeaderFromStandBy", "committedDate": "2020-04-08T19:47:31Z", "type": "commit"}, {"oid": "2bfc5fb4400b7d71c2b7a81b51ea4f2cb0213630", "url": "https://github.com/linkedin/ambry/commit/2bfc5fb4400b7d71c2b7a81b51ea4f2cb0213630", "message": "Add tests for logging of peer leader replicas on partition state changes", "committedDate": "2020-04-08T19:50:20Z", "type": "commit"}, {"oid": "2bfc5fb4400b7d71c2b7a81b51ea4f2cb0213630", "url": "https://github.com/linkedin/ambry/commit/2bfc5fb4400b7d71c2b7a81b51ea4f2cb0213630", "message": "Add tests for logging of peer leader replicas on partition state changes", "committedDate": "2020-04-08T19:50:20Z", "type": "forcePushed"}]}