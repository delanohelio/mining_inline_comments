{"pr_number": 1819, "pr_title": "GH-1809: Added collector for Model + test", "pr_createdAt": "2020-01-09T12:52:31Z", "pr_url": "https://github.com/eclipse/rdf4j/pull/1819", "timeline": [{"oid": "33fcd272f72162d817ef8bdf578e64d112555cfb", "url": "https://github.com/eclipse/rdf4j/commit/33fcd272f72162d817ef8bdf578e64d112555cfb", "message": "GH-1809: added model collector + test\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>", "committedDate": "2020-01-09T13:44:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE1MzQyOQ==", "url": "https://github.com/eclipse/rdf4j/pull/1819#discussion_r365153429", "bodyText": "does this also need to be synchronized?", "author": "hmottestad", "createdAt": "2020-01-10T09:54:22Z", "path": "core/model/src/main/java/org/eclipse/rdf4j/model/util/ModelCollector.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Eclipse RDF4J contributors.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Distribution License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/org/documents/edl-v10.php.\n+ *******************************************************************************/\n+package org.eclipse.rdf4j.model.util;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.function.BiConsumer;\n+import java.util.function.BinaryOperator;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collector;\n+\n+import org.eclipse.rdf4j.model.Model;\n+import org.eclipse.rdf4j.model.Statement;\n+import org.eclipse.rdf4j.model.impl.LinkedHashModel;\n+\n+/**\n+ * Collects a stream of Statements into a Model.\n+ * \n+ * @author Bart Hanssens\n+ */\n+public class ModelCollector implements Collector<Statement, Model, Model> {\n+\tprivate final Object lock = new Object();\n+\n+\t/**\n+\t * Convenience method to obtain a ModelCollector.\n+\t * \n+\t * @return a ModelCollector\n+\t */\n+\tpublic static ModelCollector toModel() {\n+\t\treturn new ModelCollector();\n+\t}\n+\n+\t@Override\n+\tpublic Supplier<Model> supplier() {\n+\t\treturn LinkedHashModel::new;\n+\t}\n+\n+\t@Override\n+\tpublic BiConsumer<Model, Statement> accumulator() {\n+\t\treturn (m, s) -> {\n+\t\t\tsynchronized (lock) {\n+\t\t\t\tm.add(s);\n+\t\t\t}\n+\t\t};\n+\t}\n+\n+\t@Override\n+\tpublic BinaryOperator<Model> combiner() {\n+\t\treturn (m1, m2) -> {\n+\t\t\tm1.addAll(m2);", "originalCommit": "33fcd272f72162d817ef8bdf578e64d112555cfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzNDEwOA==", "url": "https://github.com/eclipse/rdf4j/pull/1819#discussion_r365334108", "bodyText": "Actually, if I understand the Collector correctly, this method could be implemented returning just null....\nBecause the combiner does not get called in parallelStream() with the concurrent and unordered characteristics set.\nInterestingly enough, with OpenJDK11 on my machine, the combiner does get called in sequential stream(), but the result seems to be ignored anyway (just returning null does not break the test code)", "author": "barthanssens", "createdAt": "2020-01-10T16:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE1MzQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE1Mzc2MA==", "url": "https://github.com/eclipse/rdf4j/pull/1819#discussion_r365153760", "bodyText": "could this be synchronized on m instead of on lock?", "author": "hmottestad", "createdAt": "2020-01-10T09:55:02Z", "path": "core/model/src/main/java/org/eclipse/rdf4j/model/util/ModelCollector.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Eclipse RDF4J contributors.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Distribution License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/org/documents/edl-v10.php.\n+ *******************************************************************************/\n+package org.eclipse.rdf4j.model.util;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.function.BiConsumer;\n+import java.util.function.BinaryOperator;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collector;\n+\n+import org.eclipse.rdf4j.model.Model;\n+import org.eclipse.rdf4j.model.Statement;\n+import org.eclipse.rdf4j.model.impl.LinkedHashModel;\n+\n+/**\n+ * Collects a stream of Statements into a Model.\n+ * \n+ * @author Bart Hanssens\n+ */\n+public class ModelCollector implements Collector<Statement, Model, Model> {\n+\tprivate final Object lock = new Object();\n+\n+\t/**\n+\t * Convenience method to obtain a ModelCollector.\n+\t * \n+\t * @return a ModelCollector\n+\t */\n+\tpublic static ModelCollector toModel() {\n+\t\treturn new ModelCollector();\n+\t}\n+\n+\t@Override\n+\tpublic Supplier<Model> supplier() {\n+\t\treturn LinkedHashModel::new;\n+\t}\n+\n+\t@Override\n+\tpublic BiConsumer<Model, Statement> accumulator() {\n+\t\treturn (m, s) -> {\n+\t\t\tsynchronized (lock) {", "originalCommit": "33fcd272f72162d817ef8bdf578e64d112555cfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1NTU4MQ==", "url": "https://github.com/eclipse/rdf4j/pull/1819#discussion_r365355581", "bodyText": "thanks, seems to work", "author": "barthanssens", "createdAt": "2020-01-10T17:52:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE1Mzc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE1NDk2Mg==", "url": "https://github.com/eclipse/rdf4j/pull/1819#discussion_r365154962", "bodyText": "Could this use ModelFactory, so that we can add a toLinkedHashModel() and toTreeModel() method? I would like the default toModel() method to use the LinkedHashModel as this is typically the fastest.", "author": "hmottestad", "createdAt": "2020-01-10T09:57:49Z", "path": "core/model/src/main/java/org/eclipse/rdf4j/model/util/ModelCollector.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Eclipse RDF4J contributors.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Distribution License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/org/documents/edl-v10.php.\n+ *******************************************************************************/\n+package org.eclipse.rdf4j.model.util;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.function.BiConsumer;\n+import java.util.function.BinaryOperator;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collector;\n+\n+import org.eclipse.rdf4j.model.Model;\n+import org.eclipse.rdf4j.model.Statement;\n+import org.eclipse.rdf4j.model.impl.LinkedHashModel;\n+\n+/**\n+ * Collects a stream of Statements into a Model.\n+ * \n+ * @author Bart Hanssens\n+ */\n+public class ModelCollector implements Collector<Statement, Model, Model> {\n+\tprivate final Object lock = new Object();\n+\n+\t/**\n+\t * Convenience method to obtain a ModelCollector.\n+\t * \n+\t * @return a ModelCollector\n+\t */\n+\tpublic static ModelCollector toModel() {\n+\t\treturn new ModelCollector();\n+\t}\n+\n+\t@Override\n+\tpublic Supplier<Model> supplier() {\n+\t\treturn LinkedHashModel::new;", "originalCommit": "33fcd272f72162d817ef8bdf578e64d112555cfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MDM0OQ==", "url": "https://github.com/eclipse/rdf4j/pull/1819#discussion_r365480349", "bodyText": "I've slightly modified the code to use ModelFactory, so a toTreeModel() could indeed be added", "author": "barthanssens", "createdAt": "2020-01-11T00:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE1NDk2Mg=="}], "type": "inlineReview"}, {"oid": "6afcaaffbb25e99ef3f539fdefc3b87a512995ed", "url": "https://github.com/eclipse/rdf4j/commit/6afcaaffbb25e99ef3f539fdefc3b87a512995ed", "message": "GH-1809: added model collector + test\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>", "committedDate": "2020-01-10T21:09:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUxNDE2NQ==", "url": "https://github.com/eclipse/rdf4j/pull/1819#discussion_r365514165", "bodyText": "I took a look at some examples online and found a cool class called EnumSet:\nreturn EnumSet.of(Characteristics.CONCURRENT, Characteristics.IDENTITY_FINISH, Characteristics.UNORDERED);", "author": "hmottestad", "createdAt": "2020-01-11T10:51:35Z", "path": "core/model/src/main/java/org/eclipse/rdf4j/model/util/ModelCollector.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Eclipse RDF4J contributors.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Distribution License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/org/documents/edl-v10.php.\n+ *******************************************************************************/\n+package org.eclipse.rdf4j.model.util;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.function.BiConsumer;\n+import java.util.function.BinaryOperator;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collector;\n+\n+import org.eclipse.rdf4j.model.Model;\n+import org.eclipse.rdf4j.model.ModelFactory;\n+import org.eclipse.rdf4j.model.Statement;\n+import org.eclipse.rdf4j.model.impl.LinkedHashModel;\n+import org.eclipse.rdf4j.model.impl.LinkedHashModelFactory;\n+\n+/**\n+ * Collects a stream of Statements into a Model.\n+ * \n+ * @author Bart Hanssens\n+ */\n+public class ModelCollector implements Collector<Statement, Model, Model> {\n+\tprivate ModelFactory factory;\n+\n+\t/**\n+\t * Constructor\n+\t */\n+\tpublic ModelCollector() {\n+\t\tthis.factory = new LinkedHashModelFactory();\n+\t}\n+\n+\t/**\n+\t * Constructor\n+\t * \n+\t * @param factory\n+\t */\n+\tpublic ModelCollector(ModelFactory factory) {\n+\t\tthis.factory = factory;\n+\t}\n+\n+\t/**\n+\t * Convenience method to obtain a ModelCollector.\n+\t * \n+\t * @return a ModelCollector\n+\t */\n+\tpublic static ModelCollector toModel() {\n+\t\treturn new ModelCollector();\n+\t}\n+\n+\t@Override\n+\tpublic Supplier<Model> supplier() {\n+\t\treturn () -> factory.createEmptyModel();\n+\t}\n+\n+\t@Override\n+\tpublic BiConsumer<Model, Statement> accumulator() {\n+\t\treturn (m, s) -> {\n+\t\t\tsynchronized (m) {\n+\t\t\t\tm.add(s);\n+\t\t\t}\n+\t\t};\n+\t}\n+\n+\t@Override\n+\tpublic BinaryOperator<Model> combiner() {\n+\t\treturn (m1, m2) -> {\n+\t\t\tm1.addAll(m2);\n+\t\t\treturn m1;\n+\t\t};\n+\t}\n+\n+\t@Override\n+\tpublic Function<Model, Model> finisher() {\n+\t\treturn Function.identity();\n+\t}\n+\n+\t@Override\n+\tpublic Set<Characteristics> characteristics() {\n+\t\tSet<Characteristics> characteristics = new HashSet<>();\n+\t\tcharacteristics.add(Characteristics.CONCURRENT);\n+\t\tcharacteristics.add(Characteristics.IDENTITY_FINISH);\n+\t\tcharacteristics.add(Characteristics.UNORDERED);\n+\t\treturn characteristics;", "originalCommit": "6afcaaffbb25e99ef3f539fdefc3b87a512995ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUxNzU5OA==", "url": "https://github.com/eclipse/rdf4j/pull/1819#discussion_r365517598", "bodyText": "Aha, just what we need. Didn't know that one.", "author": "barthanssens", "createdAt": "2020-01-11T12:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUxNDE2NQ=="}], "type": "inlineReview"}, {"oid": "2c5e94ec1168c46faa9c1a38caba4dcd2e4d52d5", "url": "https://github.com/eclipse/rdf4j/commit/2c5e94ec1168c46faa9c1a38caba4dcd2e4d52d5", "message": "GH-1809: added model collector + test\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>", "committedDate": "2020-01-12T11:52:56Z", "type": "commit"}, {"oid": "2c5e94ec1168c46faa9c1a38caba4dcd2e4d52d5", "url": "https://github.com/eclipse/rdf4j/commit/2c5e94ec1168c46faa9c1a38caba4dcd2e4d52d5", "message": "GH-1809: added model collector + test\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>", "committedDate": "2020-01-12T11:52:56Z", "type": "forcePushed"}]}