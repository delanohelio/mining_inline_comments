{"pr_number": 2625, "pr_title": "GH-2624: support pass through of single source federated queries", "pr_createdAt": "2020-11-02T14:03:40Z", "pr_url": "https://github.com/eclipse/rdf4j/pull/2625", "timeline": [{"oid": "cb2b63822e64f7013dcd8708415074bdfdf2f866", "url": "https://github.com/eclipse/rdf4j/commit/cb2b63822e64f7013dcd8708415074bdfdf2f866", "message": "GH-2624: support pass through of single source federated queries\n\nThis change provides an optimization to the FedX federation engine to\nallow pass-through of query results for single source queries, if a\nTupleQueryResultHandler was supplied (i.e. if the query was executed\nthrough TupleQuery#evaluate(handler).\n\nThe implementation is done through a helper tuple expression (to\npropagate information into the federation evaluation strategy. Also we\nuse a number of marker interfaces.\n\nThe implementation is covered by unit tests whose assertions are very\nstrict and will ensure to find errors if other parts of the framework\nchange.\n\nNote that if no pass-through is possible, the same logic as before is\napplied.\n\nSigned-off-by: Andreas Schwarte <aschwarte10@gmail.com>", "committedDate": "2020-11-02T14:01:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyODI2NQ==", "url": "https://github.com/eclipse/rdf4j/pull/2625#discussion_r517028265", "bodyText": "Should this be in a try-with-resources block rather than this if-else? There's a possibility here that the resource is left dangling (e.g. if the isPassedThrough method craps out with an exception).", "author": "jeenbroekstra", "createdAt": "2020-11-04T00:13:06Z", "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/structures/FedXTupleQuery.java", "diffHunk": "@@ -48,8 +51,26 @@ public TupleQueryResult evaluate() throws QueryEvaluationException {\n \t@Override\n \tpublic void evaluate(TupleQueryResultHandler handler)\n \t\t\tthrows QueryEvaluationException, TupleQueryResultHandlerException {\n+\n+\t\t// attach the handler to the query to allow pass through of results\n+\t\t// for single source queries\n+\t\tTupleExpr tupleExpr = getParsedQuery().getTupleExpr();\n+\t\tPassThroughTupleExpr passThroughTupleExpr = new PassThroughTupleExpr(tupleExpr,\n+\t\t\t\thandler);\n+\t\tdelegate.getParsedQuery().setTupleExpr(passThroughTupleExpr);\n+\n \t\tFedXUtil.applyQueryBindings(this);\n-\t\tdelegate.evaluate(handler);\n+\t\tTupleQueryResult tqr = delegate.evaluate();\n+\n+\t\tif (!passThroughTupleExpr.isPassedThrough()) {\n+\t\t\t// if the result is not passed through to the handler directly,\n+\t\t\t// we need to make sure to report the result. Note that only\n+\t\t\t// SingleSourceQuery instances can be passed through\n+\t\t\tQueryResults.report(tqr, handler);\n+\t\t} else {\n+\t\t\t// to be absolutely sure that everything is closed\n+\t\t\ttqr.close();\n+\t\t}", "originalCommit": "cb2b63822e64f7013dcd8708415074bdfdf2f866", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEwODAxNQ==", "url": "https://github.com/eclipse/rdf4j/pull/2625#discussion_r517108015", "bodyText": "I think this is not absolutely require, but it doesn't harm either.\nIn SailTupleQuery it is also\nTupleQueryResult queryResult = evaluate();\nQueryResults.report(queryResult, handler);\n\nThe only minimal difference here is the call to isPssedThrough which cannot throw an exception.\nDo you still think we should have the close in a try with resources block?", "author": "aschwarte10", "createdAt": "2020-11-04T05:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyODI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEzMDEzNA==", "url": "https://github.com/eclipse/rdf4j/pull/2625#discussion_r517130134", "bodyText": "Nah, fair enough.", "author": "jeenbroekstra", "createdAt": "2020-11-04T06:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyODI2NQ=="}], "type": "inlineReview"}]}