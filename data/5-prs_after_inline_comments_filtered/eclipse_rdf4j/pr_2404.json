{"pr_number": 2404, "pr_title": "GH-2324 inlining blank nodes", "pr_createdAt": "2020-07-29T19:29:43Z", "pr_url": "https://github.com/eclipse/rdf4j/pull/2404", "timeline": [{"oid": "9c8780f3bffe1e627625f1ed99456bf9cb7d7441", "url": "https://github.com/eclipse/rdf4j/commit/9c8780f3bffe1e627625f1ed99456bf9cb7d7441", "message": "GH-2324 handle inlining issue\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>", "committedDate": "2020-07-29T19:42:08Z", "type": "commit"}, {"oid": "9c8780f3bffe1e627625f1ed99456bf9cb7d7441", "url": "https://github.com/eclipse/rdf4j/commit/9c8780f3bffe1e627625f1ed99456bf9cb7d7441", "message": "GH-2324 handle inlining issue\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>", "committedDate": "2020-07-29T19:42:08Z", "type": "forcePushed"}, {"oid": "c48787f21aa64041cd04d4a9c7b95ff8860c57b5", "url": "https://github.com/eclipse/rdf4j/commit/c48787f21aa64041cd04d4a9c7b95ff8860c57b5", "message": "cleaned up the code a bit and optimized the process for deciding if a node should be inlined or not\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>", "committedDate": "2020-07-29T23:35:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3NDA4OA==", "url": "https://github.com/eclipse/rdf4j/pull/2404#discussion_r462674088", "bodyText": "Shouldn't you check if the subject is a blank node before adding it?", "author": "jeenbroekstra", "createdAt": "2020-07-30T01:03:57Z", "path": "core/rio/turtle/src/main/java/org/eclipse/rdf4j/rio/turtle/ArrangedWriter.java", "diffHunk": "@@ -293,58 +299,74 @@ private boolean isStillReferenced(SubjectInContext key) {\n \n \tprivate synchronized void queueStatement(Statement st) {\n \t\tSubjectInContext key = new SubjectInContext(st);\n-\t\tSet<Statement> stmts = stmtBySubject.get(key);\n+\t\tSet<Statement> stmts = statementBySubject.get(key);\n \t\tif (stmts == null && st.getSubject() instanceof BNode && !stack.contains(key)) {\n \t\t\tblanks.add(st);\n \t\t} else {\n \t\t\tif (stmts == null) {\n-\t\t\t\tstmtBySubject.put(key, stmts = new TreeSet<>(comparator));\n+\t\t\t\tstatementBySubject.put(key, stmts = new TreeSet<>(comparator));\n \t\t\t}\n \t\t\tstmts.add(st);\n \t\t}\n \t\tqueueSize++;\n \t}\n \n \tprivate synchronized void flushStatements() throws RDFHandlerException {\n-\t\tif (!stmtBySubject.isEmpty() || !blanks.isEmpty()) {\n+\t\tif (!statementBySubject.isEmpty() || !blanks.isEmpty()) {\n \t\t\tflushNamespaces();\n-\t\t\tStatement st;\n \n \t\t\t// used to store all the statements\n-\t\t\tArrayList<Statement> statements = new ArrayList<Statement>();\n+\t\t\tArrayList<Statement> statements = new ArrayList<>();\n \n \t\t\t// used to store blank nodes along with the number of times they are used as an object in a statement.\n-\t\t\tMap<BNode, Integer> bNodeOccurence = new HashMap<BNode, Integer>();\n+\t\t\tMap<BNode, Integer> bNodeOccurrences = new HashMap<>();\n \n+\t\t\tStatement st;\n \t\t\twhile ((st = nextStatement()) != null) {\n \t\t\t\tstatements.add(st);\n+\n \t\t\t\tValue obj = st.getObject();\n \n-\t\t\t\t// if the object in the statement is a blank node, we will update its number of occurence\n+\t\t\t\t// if the object in the statement is a blank node, we will update its number of occurrences\n \t\t\t\tif (obj instanceof BNode) {\n-\t\t\t\t\tBNode bNode = (BNode) obj;\n-\t\t\t\t\tif (!bNodeOccurence.containsKey(bNode)) {\n-\t\t\t\t\t\tbNodeOccurence.put(bNode, 0);\n+\t\t\t\t\tbNodeOccurrences.compute(\n+\t\t\t\t\t\t\t(BNode) obj,\n+\t\t\t\t\t\t\t(key, i) -> i == null ? 1 : i + 1\n+\t\t\t\t\t);\n+\n+\t\t\t\t\tif (bNodeOccurrences.get(obj) > 1) {\n+\t\t\t\t\t\tnoneInlinedNodes.add(st.getSubject());", "originalCommit": "c48787f21aa64041cd04d4a9c7b95ff8860c57b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjczMTM1MA==", "url": "https://github.com/eclipse/rdf4j/pull/2404#discussion_r462731350", "bodyText": "I've tweaked this locally and it seems to solve the inlining issue where you had to adjust the test case, without compromising on your own new test case. I'll push a change.", "author": "jeenbroekstra", "createdAt": "2020-07-30T04:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3NDA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg3MzQwNQ==", "url": "https://github.com/eclipse/rdf4j/pull/2404#discussion_r462873405", "bodyText": "Not sure actually. But if it works better now than I'm fine with it.", "author": "hmottestad", "createdAt": "2020-07-30T09:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3NDA4OA=="}], "type": "inlineReview"}, {"oid": "4491450df5f0311b0e6b80f8239a8059fca99d46", "url": "https://github.com/eclipse/rdf4j/commit/4491450df5f0311b0e6b80f8239a8059fca99d46", "message": "GH-2324 only register nodes if they are blank nodes\n\n- fixes corner case in ArrangedWriterTest", "committedDate": "2020-07-30T04:54:53Z", "type": "commit"}]}