{"pr_number": 2893, "pr_title": "Implement the deletion of Identity Providers when a Tenant gets deleted", "pr_createdAt": "2020-04-23T09:37:43Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/2893", "timeline": [{"oid": "30ba551303b56e0f156141fadd1aa645d1ccf358", "url": "https://github.com/wso2/carbon-identity-framework/commit/30ba551303b56e0f156141fadd1aa645d1ccf358", "message": "Implement deletion of Identity Providers on Tenant Deletion", "committedDate": "2020-04-23T10:15:11Z", "type": "commit"}, {"oid": "30ba551303b56e0f156141fadd1aa645d1ccf358", "url": "https://github.com/wso2/carbon-identity-framework/commit/30ba551303b56e0f156141fadd1aa645d1ccf358", "message": "Implement deletion of Identity Providers on Tenant Deletion", "committedDate": "2020-04-23T10:15:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0NjExMA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r418146110", "bodyText": "Add new line", "author": "omindu", "createdAt": "2020-04-30T16:43:45Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/dao/IdPManagementDAO.java", "diffHunk": "@@ -2834,6 +2834,31 @@ public void deleteIdP(String idPName, int tenantId, String tenantDomain)\n         }\n     }\n \n+    /**\n+     * Delete all IDPs of a given tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityProviderManagementException\n+     */\n+    public void deleteIdPs(int tenantId) throws IdentityProviderManagementException {\n+        PreparedStatement prepStmt = null;", "originalCommit": "30ba551303b56e0f156141fadd1aa645d1ccf358", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0NjY5Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r418146693", "bodyText": "Add new line", "author": "omindu", "createdAt": "2020-04-30T16:44:37Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/listener/AbstractIdentityProviderMgtListener.java", "diffHunk": "@@ -61,6 +61,17 @@ public boolean doPreDeleteIdP(String idPName, String tenantDomain) throws Identi\n         return true;\n     }\n \n+    /**\n+     * Additional actions before deleting all IdPs of a given tenant id.\n+     *\n+     * @param tenantDomain Tenant domain to delete IdPs.\n+     * @return\n+     * @throws IdentityProviderManagementException\n+     */\n+    public boolean doPreDeleteIdPsByTenantDomain(String tenantDomain) throws IdentityProviderManagementException {\n+        return true;", "originalCommit": "30ba551303b56e0f156141fadd1aa645d1ccf358", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0NjgyOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r418146828", "bodyText": "Add new line", "author": "omindu", "createdAt": "2020-04-30T16:44:50Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/listener/AbstractIdentityProviderMgtListener.java", "diffHunk": "@@ -71,6 +82,17 @@ public boolean doPostDeleteIdP(String idPName, String tenantDomain) throws Ident\n         return true;\n     }\n \n+    /**\n+     * Additional actions after deleting IdPs of a given tenant id.\n+     *\n+     * @param tenantDomain Tenant domain to delete IdPs.\n+     * @return\n+     * @throws IdentityProviderManagementException\n+     */\n+    public boolean doPostDeleteIdPsByTenantDomain(String tenantDomain) throws IdentityProviderManagementException {\n+        return true;", "originalCommit": "30ba551303b56e0f156141fadd1aa645d1ccf358", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "27e337b9863d94668661d648c9b1c01e429a61f8", "url": "https://github.com/wso2/carbon-identity-framework/commit/27e337b9863d94668661d648c9b1c01e429a61f8", "message": "Fix minor issues", "committedDate": "2020-04-30T18:16:52Z", "type": "forcePushed"}, {"oid": "6ff9031b2ba25b6506ee510a01920716798f6513", "url": "https://github.com/wso2/carbon-identity-framework/commit/6ff9031b2ba25b6506ee510a01920716798f6513", "message": "Fix minor issues", "committedDate": "2020-05-01T04:50:25Z", "type": "commit"}, {"oid": "6ff9031b2ba25b6506ee510a01920716798f6513", "url": "https://github.com/wso2/carbon-identity-framework/commit/6ff9031b2ba25b6506ee510a01920716798f6513", "message": "Fix minor issues", "committedDate": "2020-05-01T04:50:25Z", "type": "forcePushed"}, {"oid": "759585d8fd0fb8933be8d51a69d02ea34c9e3a96", "url": "https://github.com/wso2/carbon-identity-framework/commit/759585d8fd0fb8933be8d51a69d02ea34c9e3a96", "message": "Remove cache clearing", "committedDate": "2020-05-15T11:11:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE0NjQxOQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r427146419", "bodyText": "rename to doPostDeleteIdPs(String tenantDomain)", "author": "IsuraD", "createdAt": "2020-05-19T09:05:02Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/listener/ApplicationIdentityProviderMgtListener.java", "diffHunk": "@@ -172,6 +172,25 @@ public boolean doPostDeleteIdP(String idPName, String tenantDomain) throws Ident\n         return super.doPostDeleteIdP(idPName, tenantDomain);\n     }\n \n+    /**\n+     * Clear SP cache after deleting IDPs.\n+     *\n+     * @param tenantDomain Tenant domain to delete IdPs.\n+     * @return\n+     * @throws IdentityProviderManagementException\n+     */\n+    @Override\n+    public boolean doPostDeleteIdPsByTenantDomain(String tenantDomain) throws IdentityProviderManagementException {", "originalCommit": "759585d8fd0fb8933be8d51a69d02ea34c9e3a96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE0NjcxNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r427146714", "bodyText": "shall we load the SPs of this tenant clear cache separately?", "author": "IsuraD", "createdAt": "2020-05-19T09:05:28Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/listener/ApplicationIdentityProviderMgtListener.java", "diffHunk": "@@ -172,6 +172,25 @@ public boolean doPostDeleteIdP(String idPName, String tenantDomain) throws Ident\n         return super.doPostDeleteIdP(idPName, tenantDomain);\n     }\n \n+    /**\n+     * Clear SP cache after deleting IDPs.\n+     *\n+     * @param tenantDomain Tenant domain to delete IdPs.\n+     * @return\n+     * @throws IdentityProviderManagementException\n+     */\n+    @Override\n+    public boolean doPostDeleteIdPsByTenantDomain(String tenantDomain) throws IdentityProviderManagementException {\n+\n+        // Clear the SP cache since deleted IDP might have contained association with SPs.\n+        IdentityServiceProviderCache.getInstance().clear();", "originalCommit": "759585d8fd0fb8933be8d51a69d02ea34c9e3a96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE3NTE4OA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r433175188", "bodyText": "Caches will be cleared in the SP deletion", "author": "sumedhe", "createdAt": "2020-06-01T11:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE0NjcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE3NjIzMA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r433176230", "bodyText": "Lets remove this", "author": "IsuraD", "createdAt": "2020-06-01T11:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE0NjcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE0Nzc4MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r427147781", "bodyText": "deleteIdPs(String tenantDomain)", "author": "IsuraD", "createdAt": "2020-05-19T09:07:07Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/IdentityProviderManager.java", "diffHunk": "@@ -2096,6 +2096,40 @@ public void deleteIdP(String idPName, String tenantDomain) throws IdentityProvid\n         }\n     }\n \n+    /**\n+     * Delete all Identity Providers from a given tenant\n+     *\n+     * @param tenantDomain Domain of the tenant\n+     * @throws IdentityProviderManagementException\n+     */\n+    @Override\n+    public void deleteIdPsByTenantDomain(String tenantDomain) throws IdentityProviderManagementException {", "originalCommit": "759585d8fd0fb8933be8d51a69d02ea34c9e3a96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "38c05cd320e5e9275ec04663511be653023d2305", "url": "https://github.com/wso2/carbon-identity-framework/commit/38c05cd320e5e9275ec04663511be653023d2305", "message": "Update method names", "committedDate": "2020-05-25T11:39:43Z", "type": "commit"}, {"oid": "4f40ddc83bc5bb13879e6fb7395991d054584938", "url": "https://github.com/wso2/carbon-identity-framework/commit/4f40ddc83bc5bb13879e6fb7395991d054584938", "message": "Merge branch 'master' into delete-idps-on-tenant-deletion", "committedDate": "2020-05-25T11:42:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE3Njc1MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r433176751", "bodyText": "rename to doPreDeleteIdPs", "author": "IsuraD", "createdAt": "2020-06-01T11:16:12Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/IdentityProviderManager.java", "diffHunk": "@@ -2094,6 +2094,40 @@ public void deleteIdP(String idPName, String tenantDomain) throws IdentityProvid\n         }\n     }\n \n+    /**\n+     * Delete all Identity Providers from a given tenant\n+     *\n+     * @param tenantDomain Domain of the tenant\n+     * @throws IdentityProviderManagementException\n+     */\n+    @Override\n+    public void deleteIdPs(String tenantDomain) throws IdentityProviderManagementException {\n+\n+        // Invoking the pre listeners.\n+        Collection<IdentityProviderMgtListener> listeners = IdPManagementServiceComponent.getIdpMgtListeners();\n+        for (IdentityProviderMgtListener listener : listeners) {\n+            if (listener.isEnable() && !listener.doPreDeleteIdPsByTenantDomain(tenantDomain)) {", "originalCommit": "4f40ddc83bc5bb13879e6fb7395991d054584938", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "445d96defb10208fd2a2c61d4b2d5e4705e5ffbc", "url": "https://github.com/wso2/carbon-identity-framework/commit/445d96defb10208fd2a2c61d4b2d5e4705e5ffbc", "message": "Remove SP cache deletion and fix minor issues", "committedDate": "2020-06-01T18:14:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc1OTE0Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r440759142", "bodyText": "Missing full stop. Shall we keep the format of the comments? WDYT?", "author": "ShanChathusanda93", "createdAt": "2020-06-16T10:48:14Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/IdentityProviderManager.java", "diffHunk": "@@ -2094,6 +2094,40 @@ public void deleteIdP(String idPName, String tenantDomain) throws IdentityProvid\n         }\n     }\n \n+    /**\n+     * Delete all Identity Providers from a given tenant", "originalCommit": "445d96defb10208fd2a2c61d4b2d5e4705e5ffbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2MTc0Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r440761743", "bodyText": "In other places for params full stop is not used. It is better if we can maintain single format for comments. WDYT?", "author": "ShanChathusanda93", "createdAt": "2020-06-16T10:52:43Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/listener/AbstractIdentityProviderMgtListener.java", "diffHunk": "@@ -61,6 +61,18 @@ public boolean doPreDeleteIdP(String idPName, String tenantDomain) throws Identi\n         return true;\n     }\n \n+    /**\n+     * Additional actions before deleting all IdPs of a given tenant id.\n+     *\n+     * @param tenantDomain Tenant domain to delete IdPs.", "originalCommit": "445d96defb10208fd2a2c61d4b2d5e4705e5ffbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2MjE5MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r440762190", "bodyText": "Shall we add the method comment here? If so please check the other places as well.", "author": "ShanChathusanda93", "createdAt": "2020-06-16T10:53:35Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/listener/IDPMgtAuditLogger.java", "diffHunk": "@@ -69,14 +69,20 @@ public boolean doPostUpdateIdP(String oldIdPName, IdentityProvider identityProvi\n \n     @Override\n     public boolean doPostDeleteIdP(String idPName, String tenantDomain) throws IdentityProviderManagementException {\n-        if(StringUtils.isEmpty(idPName)){\n+        if (StringUtils.isEmpty(idPName)) {\n             idPName = \"Undefined\";\n         }\n         audit.info(String.format(AUDIT_MESSAGE, getUser(), \"delete\", UserCoreUtil.addTenantDomainToEntry\n                 (idPName, tenantDomain), null, SUCCESS));\n         return true;\n     }\n \n+    @Override\n+    public boolean doPostDeleteIdPs(String tenantDomain) throws IdentityProviderManagementException {", "originalCommit": "445d96defb10208fd2a2c61d4b2d5e4705e5ffbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c3a5c7c8ff7a1069206e085cbe1a2a30aae0f4bc", "url": "https://github.com/wso2/carbon-identity-framework/commit/c3a5c7c8ff7a1069206e085cbe1a2a30aae0f4bc", "message": "Remove SP cache deletion and fix minor issues", "committedDate": "2020-06-16T19:37:11Z", "type": "forcePushed"}, {"oid": "2ef513cc78433d9c50b07947719cd7fbff6f5d8a", "url": "https://github.com/wso2/carbon-identity-framework/commit/2ef513cc78433d9c50b07947719cd7fbff6f5d8a", "message": "Remove SP cache deletion and fix minor issues", "committedDate": "2020-06-16T19:43:29Z", "type": "forcePushed"}, {"oid": "706fc27a5b1fa81ed95f33ad708af20a93b95244", "url": "https://github.com/wso2/carbon-identity-framework/commit/706fc27a5b1fa81ed95f33ad708af20a93b95244", "message": "Remove SP cache deletion and fix minor issues", "committedDate": "2020-06-16T19:57:36Z", "type": "commit"}, {"oid": "706fc27a5b1fa81ed95f33ad708af20a93b95244", "url": "https://github.com/wso2/carbon-identity-framework/commit/706fc27a5b1fa81ed95f33ad708af20a93b95244", "message": "Remove SP cache deletion and fix minor issues", "committedDate": "2020-06-16T19:57:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAwOTM5MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442009390", "bodyText": "shall we use try with resource so that the connection and prepared statements are automatically closed?", "author": "madurangasiriwardena", "createdAt": "2020-06-18T07:01:19Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/dao/IdPManagementDAO.java", "diffHunk": "@@ -2858,6 +2858,32 @@ public void deleteIdP(String idPName, int tenantId, String tenantDomain)\n         }\n     }\n \n+    /**\n+     * Delete all IDPs of a given tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityProviderManagementException\n+     */\n+    public void deleteIdPs(int tenantId) throws IdentityProviderManagementException {\n+\n+        PreparedStatement prepStmt = null;\n+        String query = IdPManagementConstants.SQLQueries.DELETE_ALL_IDP_BY_TENANT_ID_SQL;\n+        Connection conn = IdentityDatabaseUtil.getDBConnection(true);\n+        try {", "originalCommit": "706fc27a5b1fa81ed95f33ad708af20a93b95244", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAwOTg5MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442009890", "bodyText": "formatting issue.", "author": "madurangasiriwardena", "createdAt": "2020-06-18T07:02:30Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/dao/CacheBackedIdPMgtDAO.java", "diffHunk": "@@ -464,14 +461,27 @@ public void deleteIdP(String idPName, int tenantId, String tenantDomain)\n             clearIdpCache(idPName, tenantId, tenantDomain);\n         } else {\n             if (log.isDebugEnabled()) {\n-                log.debug(String.format(\"IDP:%s of tenantDomain:%s is not found is cache or DB\", idPName, tenantDomain));\n+                log.debug(String.format(\"IDP:%s of tenantDomain:%s is not found is cache or DB\",\n+                        idPName, tenantDomain));\n             }\n         }\n+    }\n \n+    /**\n+     * Delete all IDPs of given tenant Id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityProviderManagementException\n+     */\n+    public void deleteIdPsByTenantID(int tenantId)  throws IdentityProviderManagementException {", "originalCommit": "706fc27a5b1fa81ed95f33ad708af20a93b95244", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAxMDI2OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442010269", "bodyText": "do we need to clear the cache as well?", "author": "madurangasiriwardena", "createdAt": "2020-06-18T07:03:20Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/dao/CacheBackedIdPMgtDAO.java", "diffHunk": "@@ -464,14 +461,27 @@ public void deleteIdP(String idPName, int tenantId, String tenantDomain)\n             clearIdpCache(idPName, tenantId, tenantDomain);\n         } else {\n             if (log.isDebugEnabled()) {\n-                log.debug(String.format(\"IDP:%s of tenantDomain:%s is not found is cache or DB\", idPName, tenantDomain));\n+                log.debug(String.format(\"IDP:%s of tenantDomain:%s is not found is cache or DB\",\n+                        idPName, tenantDomain));\n             }\n         }\n+    }\n \n+    /**\n+     * Delete all IDPs of given tenant Id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityProviderManagementException\n+     */\n+    public void deleteIdPsByTenantID(int tenantId)  throws IdentityProviderManagementException {\n \n-\n+        idPMgtDAO.deleteIdPs(tenantId);", "originalCommit": "706fc27a5b1fa81ed95f33ad708af20a93b95244", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3MDIwMw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442470203", "bodyText": "It was decided not to delete the caches here, because of the overhead coming after clearing all IDP caches.", "author": "sumedhe", "createdAt": "2020-06-18T19:59:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAxMDI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAxMjg0MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442012840", "bodyText": "Shall we rename this method as deleteIdPsByTenantID to make this consistent with CacheBackedIdPMgtDAO", "author": "madurangasiriwardena", "createdAt": "2020-06-18T07:09:02Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/dao/IdPManagementDAO.java", "diffHunk": "@@ -2858,6 +2858,32 @@ public void deleteIdP(String idPName, int tenantId, String tenantDomain)\n         }\n     }\n \n+    /**\n+     * Delete all IDPs of a given tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityProviderManagementException\n+     */\n+    public void deleteIdPs(int tenantId) throws IdentityProviderManagementException {", "originalCommit": "706fc27a5b1fa81ed95f33ad708af20a93b95244", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA0MDA5MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442040090", "bodyText": "Do we need to log anything related to this operation?", "author": "madurangasiriwardena", "createdAt": "2020-06-18T08:00:01Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/listener/IDPMgtAuditLogger.java", "diffHunk": "@@ -67,16 +67,37 @@ public boolean doPostUpdateIdP(String oldIdPName, IdentityProvider identityProvi\n         return true;\n     }\n \n+    /**\n+     * Post delete of IDP.\n+     *\n+     * @param idPName Name of the IDP\n+     * @param tenantDomain Tenant Domain\n+     * @return\n+     * @throws IdentityProviderManagementException\n+     */\n     @Override\n     public boolean doPostDeleteIdP(String idPName, String tenantDomain) throws IdentityProviderManagementException {\n-        if(StringUtils.isEmpty(idPName)){\n+        if (StringUtils.isEmpty(idPName)) {\n             idPName = \"Undefined\";\n         }\n         audit.info(String.format(AUDIT_MESSAGE, getUser(), \"delete\", UserCoreUtil.addTenantDomainToEntry\n                 (idPName, tenantDomain), null, SUCCESS));\n         return true;\n     }\n \n+    /**\n+     * Additional actions after deleting IdPs of a given tenant id.\n+     *\n+     * @param tenantDomain Tenant domain to delete IdPs\n+     * @return\n+     * @throws IdentityProviderManagementException\n+     */\n+    @Override\n+    public boolean doPostDeleteIdPs(String tenantDomain) throws IdentityProviderManagementException {\n+\n+        return super.doPostDeleteIdPs(tenantDomain);", "originalCommit": "706fc27a5b1fa81ed95f33ad708af20a93b95244", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4NzkyNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442487924", "bodyText": "I will add an audit log here", "author": "sumedhe", "createdAt": "2020-06-18T20:36:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA0MDA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA0MjA2Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442042066", "bodyText": "Will all the resources related to IDP cleared from this?", "author": "madurangasiriwardena", "createdAt": "2020-06-18T08:03:32Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/util/IdPManagementConstants.java", "diffHunk": "@@ -286,6 +286,8 @@\n \n         public static final String DELETE_IDP_SQL = \"DELETE FROM IDP WHERE (TENANT_ID=? AND NAME=?)\";\n \n+        public static final String DELETE_ALL_IDP_BY_TENANT_ID_SQL = \"DELETE FROM IDP WHERE TENANT_ID = ?\";", "originalCommit": "706fc27a5b1fa81ed95f33ad708af20a93b95244", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4ODE3Nw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442488177", "bodyText": "Yes. Other relevant resources also get deleted with ON CASCADE. The same method was followed in deleting a single IDP also.", "author": "sumedhe", "createdAt": "2020-06-18T20:36:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA0MjA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc2MzUwNQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442763505", "bodyText": "This affects to all the tenants. Lets skip removing from  ProvisioningConnectorCache", "author": "IsuraD", "createdAt": "2020-06-19T10:32:20Z", "path": "components/provisioning/org.wso2.carbon.identity.provisioning/src/main/java/org/wso2/carbon/identity/provisioning/listener/ProvisioningIdentityProviderMgtListener.java", "diffHunk": "@@ -56,6 +56,23 @@ public boolean doPreDeleteIdP(String idPName, String tenantDomain) throws Identi\n         return true;\n     }\n \n+    /**\n+     * Clear Provisioning Connector Cache before deleting IDPs.\n+     *\n+     * @param tenantDomain Tenant domain to delete IdPs.\n+     * @return\n+     * @throws IdentityProviderManagementException\n+     */\n+    @Override\n+    public boolean doPreDeleteIdPs(String tenantDomain) throws IdentityProviderManagementException {\n+\n+        ProvisioningConnectorCache.getInstance().clear();", "originalCommit": "9eccfb54b5b48293ff9e46bcdc5b6cd00818683a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc2MzgxNg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2893#discussion_r442763816", "bodyText": "rename to public void deleteIdPs(int tenantId)", "author": "IsuraD", "createdAt": "2020-06-19T10:33:02Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/dao/IdPManagementDAO.java", "diffHunk": "@@ -2858,6 +2859,25 @@ public void deleteIdP(String idPName, int tenantId, String tenantDomain)\n         }\n     }\n \n+    /**\n+     * Delete all IDPs of a given tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityProviderManagementException\n+     */\n+    public void deleteIdPsByTenantId(int tenantId) throws IdentityProviderManagementException {", "originalCommit": "9eccfb54b5b48293ff9e46bcdc5b6cd00818683a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "20e573189a5373113a73028539086b122cc142fa", "url": "https://github.com/wso2/carbon-identity-framework/commit/20e573189a5373113a73028539086b122cc142fa", "message": "Modify IdPManagementDAO and add audit log", "committedDate": "2020-06-20T16:06:32Z", "type": "commit"}, {"oid": "20e573189a5373113a73028539086b122cc142fa", "url": "https://github.com/wso2/carbon-identity-framework/commit/20e573189a5373113a73028539086b122cc142fa", "message": "Modify IdPManagementDAO and add audit log", "committedDate": "2020-06-20T16:06:32Z", "type": "forcePushed"}]}