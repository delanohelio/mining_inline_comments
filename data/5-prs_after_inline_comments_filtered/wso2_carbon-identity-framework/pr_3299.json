{"pr_number": 3299, "pr_title": "Add service and DB support to add/replace a resource with a file", "pr_createdAt": "2020-12-21T12:00:08Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/3299", "timeline": [{"oid": "eb5cc32aae1effe46aaf3decb22a5f973bc4d96c", "url": "https://github.com/wso2/carbon-identity-framework/commit/eb5cc32aae1effe46aaf3decb22a5f973bc4d96c", "message": "add service and DB support to add/replace a resource with a file", "committedDate": "2020-12-21T12:04:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3MjgwNw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r546772807", "bodyText": "Do we need to add default implementation for the newly introduced methods to this interface.", "author": "ayshsandu", "createdAt": "2020-12-21T15:35:00Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java", "diffHunk": "@@ -119,6 +119,20 @@ Resources getTenantResources(String tenantDomain, Condition searchCondition) thr\n      */\n     Resource addResource(String resourceTypeName, ResourceAdd resourceAdd) throws ConfigurationManagementException;\n \n+    /**\n+     * This API is used to create the given resource including a file.\n+     *\n+     * @param resourceTypeName Name of the {@link ResourceType}.\n+     * @param resourceAdd      Request to create the {@link Resource}.\n+     * @param resourceAdd      Name of the {@link ResourceFile}\n+     * @param fileName         {@link InputStream} representing the file.\n+     * @return 201 created. Returns {@link Resource} created.\n+     * @throws ConfigurationManagementException Resource management exception.\n+     */\n+    Resource addResourceWithFile(String resourceTypeName, ResourceAdd resourceAdd, String fileName,", "originalCommit": "eb5cc32aae1effe46aaf3decb22a5f973bc4d96c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA2NzI2MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547067261", "bodyText": "Addressed in 3d05632 and 7d912de", "author": "AnuradhaSK", "createdAt": "2020-12-22T04:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3MjgwNw=="}], "type": "inlineReview"}, {"oid": "bf04dd3cbd325b6d606d9821a67a1278ba9e9cda", "url": "https://github.com/wso2/carbon-identity-framework/commit/bf04dd3cbd325b6d606d9821a67a1278ba9e9cda", "message": "add service and DB support to add/replace a resource with a file", "committedDate": "2020-12-22T06:14:26Z", "type": "commit"}, {"oid": "b5d503afd4850d7534a2ae4ba3af7bcb36fce2b2", "url": "https://github.com/wso2/carbon-identity-framework/commit/b5d503afd4850d7534a2ae4ba3af7bcb36fce2b2", "message": "add default implementations to newly added Java APIs", "committedDate": "2020-12-22T06:14:27Z", "type": "commit"}, {"oid": "d85f5a3ff6b61326ec4f6fee706d155e776308a0", "url": "https://github.com/wso2/carbon-identity-framework/commit/d85f5a3ff6b61326ec4f6fee706d155e776308a0", "message": "fix formatting issues", "committedDate": "2020-12-22T06:14:27Z", "type": "commit"}, {"oid": "d85f5a3ff6b61326ec4f6fee706d155e776308a0", "url": "https://github.com/wso2/carbon-identity-framework/commit/d85f5a3ff6b61326ec4f6fee706d155e776308a0", "message": "fix formatting issues", "committedDate": "2020-12-22T06:14:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5Mjg4Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547192886", "bodyText": "Formatting check all method comments", "author": "Buddhimah", "createdAt": "2020-12-22T10:21:14Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/ConfigurationDAO.java", "diffHunk": "@@ -115,6 +115,17 @@ Resource getResourceByName(int tenantId, String resourceTypeId, String name)\n      */\n     void addResource(Resource resource) throws ConfigurationManagementException;\n \n+    /**", "originalCommit": "d85f5a3ff6b61326ec4f6fee706d155e776308a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIyODQ3NA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547228474", "bodyText": "Checked all places. There is no formatting issue.", "author": "AnuradhaSK", "createdAt": "2020-12-22T11:36:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5Mjg4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4MjE0Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547182142", "bodyText": "Pass a resource with file details", "author": "AnuradhaSK", "createdAt": "2020-12-22T09:59:46Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java", "diffHunk": "@@ -119,6 +120,22 @@ Resources getTenantResources(String tenantDomain, Condition searchCondition) thr\n      */\n     Resource addResource(String resourceTypeName, ResourceAdd resourceAdd) throws ConfigurationManagementException;\n \n+    /**\n+     * This API is used to create the given resource including a file.\n+     *\n+     * @param resourceTypeName Name of the {@link ResourceType}.\n+     * @param resourceAdd      Request to create the {@link Resource}.\n+     * @param resourceAdd      Name of the {@link ResourceFile}\n+     * @param fileName         {@link InputStream} representing the file.\n+     * @return 201 created. Returns {@link Resource} created.\n+     * @throws ConfigurationManagementException Resource management exception.\n+     */\n+    default Resource addResourceWithFile(String resourceTypeName, ResourceAdd resourceAdd, String fileName,", "originalCommit": "d85f5a3ff6b61326ec4f6fee706d155e776308a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUwMjMwMg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547502302", "bodyText": "fix in 1741f1f", "author": "AnuradhaSK", "createdAt": "2020-12-22T20:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4MjE0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4NzY1MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547187650", "bodyText": "remove this check", "author": "AnuradhaSK", "createdAt": "2020-12-22T10:11:06Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "diffHunk": "@@ -244,6 +244,26 @@ public Resource addResource(String resourceTypeName, ResourceAdd resourceAdd)\n         return resource;\n     }\n \n+    @Override\n+    public Resource addResourceWithFile(String resourceTypeName, ResourceAdd resourceAdd, String fileName,\n+                                        InputStream fileStream) throws ConfigurationManagementException {\n+\n+        checkFeatureStatus();", "originalCommit": "d85f5a3ff6b61326ec4f6fee706d155e776308a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUwMjIzOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547502238", "bodyText": "fix in 1741f1f", "author": "AnuradhaSK", "createdAt": "2020-12-22T20:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4NzY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4ODA5Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547188093", "bodyText": "add info log", "author": "AnuradhaSK", "createdAt": "2020-12-22T10:11:58Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "diffHunk": "@@ -244,6 +244,26 @@ public Resource addResource(String resourceTypeName, ResourceAdd resourceAdd)\n         return resource;\n     }\n \n+    @Override\n+    public Resource addResourceWithFile(String resourceTypeName, ResourceAdd resourceAdd, String fileName,\n+                                        InputStream fileStream) throws ConfigurationManagementException {\n+\n+        checkFeatureStatus();\n+        validateResourceCreateWithFileRequest(resourceTypeName, resourceAdd, fileName, fileStream);\n+        Resource resource = generateResourceFromRequest(resourceTypeName, resourceAdd);\n+        resource.setHasFile(true);\n+        String resourceId = generateUniqueID();\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Resource id generated: \" + resourceId);\n+        }\n+        resource.setResourceId(resourceId);\n+        this.getConfigurationDAO().addResourceWithFile(resource, fileName, fileStream);\n+        if (log.isDebugEnabled()) {\n+            log.debug(resourceAdd.getName() + \" resource created successfully.\");\n+        }", "originalCommit": "d85f5a3ff6b61326ec4f6fee706d155e776308a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4ODU3Nw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547188577", "bodyText": "Improvement:  audit logs", "author": "AnuradhaSK", "createdAt": "2020-12-22T10:12:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4ODA5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUwMjE0Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547502146", "bodyText": "Add info log in 1741f1f", "author": "AnuradhaSK", "createdAt": "2020-12-22T20:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4ODA5Mw=="}], "type": "inlineReview"}, {"oid": "1741f1feb8e720cb738e8a96ad964174020220a1", "url": "https://github.com/wso2/carbon-identity-framework/commit/1741f1feb8e720cb738e8a96ad964174020220a1", "message": "support java api and DAO layer to add/replace resource objects with/without files. Remove config-mgt feature enable check", "committedDate": "2020-12-22T20:49:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY0OTA5OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547649099", "bodyText": "Do you need to add both debug and info logs here. Isn't info log enough?", "author": "ayshsandu", "createdAt": "2020-12-23T05:12:47Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "diffHunk": "@@ -244,14 +232,29 @@ public Resource addResource(String resourceTypeName, ResourceAdd resourceAdd)\n         return resource;\n     }\n \n+    @Override\n+    public Resource addResource(String resourceTypeName, Resource resource) throws ConfigurationManagementException {\n+\n+        validateResourceCreateRequest(resourceTypeName, resource);\n+        String resourceId = generateUniqueID();\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Resource id generated: \" + resourceId);\n+        }\n+        resource.setResourceId(resourceId);\n+        this.getConfigurationDAO().addResource(resource);\n+        if (log.isDebugEnabled()) {\n+            log.debug(resource.getResourceName() + \" resource created successfully.\");\n+        }\n+        log.info(\"Resource: \" + resource.getResourceName() + \" added successfully\");", "originalCommit": "1741f1feb8e720cb738e8a96ad964174020220a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc2MjUwMg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547762502", "bodyText": "Fixed in d8a058a", "author": "AnuradhaSK", "createdAt": "2020-12-23T07:42:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY0OTA5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY1MDY4MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547650680", "bodyText": "Info log is enough, no need both info and debug logs.", "author": "ayshsandu", "createdAt": "2020-12-23T05:14:47Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "diffHunk": "@@ -263,13 +266,26 @@ public Resource replaceResource(String resourceTypeName, ResourceAdd resourceAdd\n         return resource;\n     }\n \n+    @Override\n+    public Resource replaceResource(String resourceTypeName, Resource resource)\n+            throws ConfigurationManagementException {\n+\n+        validateResourceReplaceRequest(resourceTypeName, resource);\n+        String resourceId = generateResourceId(resourceTypeName, resource.getResourceName());\n+        resource.setResourceId(resourceId);\n+        this.getConfigurationDAO().replaceResourceWithFiles(resource);\n+        if (log.isDebugEnabled()) {\n+            log.debug(resource.getResourceName() + \" resource created successfully.\");\n+        }\n+        log.info(resource.getResourceName() + \" resource created successfully.\");", "originalCommit": "1741f1feb8e720cb738e8a96ad964174020220a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc2MjQ1MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547762450", "bodyText": "Fixed in d8a058a", "author": "AnuradhaSK", "createdAt": "2020-12-23T07:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY1MDY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY1MTMwOQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547651309", "bodyText": "Add a method description on what validations are done inside the method.", "author": "ayshsandu", "createdAt": "2020-12-23T05:15:41Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "diffHunk": "@@ -531,6 +531,39 @@ private void validateResourceCreateRequest(String resourceTypeName, ResourceAdd\n         }\n     }\n \n+    private void validateResourceCreateRequest(String resourceTypeName, Resource resource)", "originalCommit": "1741f1feb8e720cb738e8a96ad964174020220a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc2MjM3Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547762376", "bodyText": "Fixed in d8a058a", "author": "AnuradhaSK", "createdAt": "2020-12-23T07:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY1MTMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY1NjUzNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547656534", "bodyText": "\"fileStream is invalid.\" -> \"Filestream is invalid or empty.\"", "author": "ayshsandu", "createdAt": "2020-12-23T05:23:15Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "diffHunk": "@@ -531,6 +531,39 @@ private void validateResourceCreateRequest(String resourceTypeName, ResourceAdd\n         }\n     }\n \n+    private void validateResourceCreateRequest(String resourceTypeName, Resource resource)\n+            throws ConfigurationManagementException {\n+\n+        if (StringUtils.isEmpty(resourceTypeName) || StringUtils.isEmpty(resource.getResourceName())) {\n+            throw handleClientException(ERROR_CODE_RESOURCE_ADD_REQUEST_INVALID, null);\n+        }\n+        if (isResourceExists(resourceTypeName, resource.getResourceName())) {\n+            throw handleClientException(ERROR_CODE_RESOURCE_ALREADY_EXISTS, resource.getResourceName());\n+        }\n+        if (CollectionUtils.isNotEmpty(resource.getFiles())) {\n+            List<ResourceFile> files = resource.getFiles();\n+            for (ResourceFile file : files) {\n+                if (StringUtils.isEmpty(file.getId())) {\n+                    file.setId(generateUniqueID());\n+                }\n+                if (StringUtils.isEmpty(file.getName())) {\n+                    String fileIdentifiers = String.format(\"Resource type: %s, resourceName: %s\", resourceTypeName,\n+                            resource.getResourceName());\n+                    throw handleClientException(ERROR_CODE_FILE_IDENTIFIERS_REQUIRED, fileIdentifiers);\n+                }\n+                if (file.getInputStream() == null) {\n+                    throw handleClientException(ERROR_CODE_FILE_IDENTIFIERS_REQUIRED, \"fileStream is invalid.\");", "originalCommit": "1741f1feb8e720cb738e8a96ad964174020220a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc2MjI2Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547762262", "bodyText": "Fixed in d8a058a", "author": "AnuradhaSK", "createdAt": "2020-12-23T07:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY1NjUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY1NzI0Nw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547657247", "bodyText": "\"fileStream is invalid.\" -> \"Filestream is invalid or empty.\"", "author": "ayshsandu", "createdAt": "2020-12-23T05:24:19Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "diffHunk": "@@ -594,6 +625,39 @@ private void validateResourceReplaceRequest(String resourceTypeName, ResourceAdd\n         }\n     }\n \n+    private void validateResourceReplaceRequest(String resourceTypeName, Resource resource)\n+            throws ConfigurationManagementException {\n+\n+        if (StringUtils.isEmpty(resourceTypeName)) {\n+            throw handleClientException(ERROR_CODE_RESOURCE_ADD_REQUEST_INVALID, null);\n+        }\n+        if (!isResourceExists(resourceTypeName, resource.getResourceName())) {\n+            throw handleClientException(ERROR_CODE_RESOURCE_DOES_NOT_EXISTS, resource.getResourceName());\n+        }\n+        if (CollectionUtils.isNotEmpty(resource.getFiles())) {\n+            List<ResourceFile> files = resource.getFiles();\n+            for (ResourceFile file : files) {\n+                if (StringUtils.isEmpty(file.getId())) {\n+                    file.setId(generateUniqueID());\n+                }\n+                if (StringUtils.isEmpty(file.getName())) {\n+                    String fileIdentifiers = String.format(\"Resource type: %s, resourceName: %s\", resourceTypeName,\n+                            resource.getResourceName());\n+                    throw handleClientException(ERROR_CODE_FILE_IDENTIFIERS_REQUIRED, fileIdentifiers);\n+                }\n+                if (file.getInputStream() == null) {\n+                    throw handleClientException(ERROR_CODE_FILE_IDENTIFIERS_REQUIRED, \"fileStream is invalid.\");", "originalCommit": "1741f1feb8e720cb738e8a96ad964174020220a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc2MjA4Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3299#discussion_r547762086", "bodyText": "Fixed in d8a058a", "author": "AnuradhaSK", "createdAt": "2020-12-23T07:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY1NzI0Nw=="}], "type": "inlineReview"}, {"oid": "d8a058aafc752688f344f981f63374479a6afa18", "url": "https://github.com/wso2/carbon-identity-framework/commit/d8a058aafc752688f344f981f63374479a6afa18", "message": "address review comments", "committedDate": "2020-12-23T07:41:41Z", "type": "commit"}]}