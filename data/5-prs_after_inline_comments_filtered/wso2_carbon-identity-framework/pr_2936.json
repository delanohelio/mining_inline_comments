{"pr_number": 2936, "pr_title": "Implement SP App deletion on Tenant Deletion", "pr_createdAt": "2020-05-15T10:23:57Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/2936", "timeline": [{"oid": "4843821f680d349686111c760cc96650d098a818", "url": "https://github.com/wso2/carbon-identity-framework/commit/4843821f680d349686111c760cc96650d098a818", "message": "Implement SP App deletion on Tenant Deletion", "committedDate": "2020-05-15T10:15:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExOTYwOQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r426119609", "bodyText": "rename to deleteApplications(int tenantId)", "author": "IsuraD", "createdAt": "2020-05-16T05:11:21Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/ApplicationManagementService.java", "diffHunk": "@@ -131,6 +131,14 @@ public abstract void updateApplication(ServiceProvider serviceProvider, String t\n     public abstract void deleteApplication(String applicationName, String tenantDomain, String username)\n             throws IdentityApplicationManagementException;\n \n+    /**\n+     * Delete Applications by tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityApplicationManagementException\n+     */\n+    public abstract void deleteApplicationsByTenantId(int tenantId) throws IdentityApplicationManagementException;", "originalCommit": "4843821f680d349686111c760cc96650d098a818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExOTg1NQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r426119855", "bodyText": "\ud83d\udc4d", "author": "sumedhe", "createdAt": "2020-05-16T05:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExOTYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExOTczNw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r426119737", "bodyText": "remove line", "author": "IsuraD", "createdAt": "2020-05-16T05:13:08Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/ApplicationManagementServiceImpl.java", "diffHunk": "@@ -714,6 +714,20 @@ public void deleteApplication(String applicationName, String tenantDomain, Strin\n         }\n     }\n \n+    /**\n+     * Delete Applications by tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityApplicationManagementException\n+     */\n+    @Override\n+    public void deleteApplicationsByTenantId(int tenantId) throws IdentityApplicationManagementException {\n+\n+        ApplicationDAO appDAO = ApplicationMgtSystemConfig.getInstance().getApplicationDAO();\n+        appDAO.deleteApplicationsByTenantId(tenantId);\n+    }\n+\n+", "originalCommit": "4843821f680d349686111c760cc96650d098a818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExOTg2NQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r426119865", "bodyText": "\ud83d\udc4d", "author": "sumedhe", "createdAt": "2020-05-16T05:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExOTczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExOTc2Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r426119763", "bodyText": "Lets put an audit log here...", "author": "IsuraD", "createdAt": "2020-05-16T05:13:52Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/dao/impl/ApplicationDAOImpl.java", "diffHunk": "@@ -3538,6 +3540,41 @@ public void deleteApplication(int applicationID, Connection connection)\n \n     }\n \n+    /**\n+     * Delete all applications of a given tenant id.\n+     *\n+     * @param\n+     * @throws IdentityApplicationManagementException\n+     */\n+    @Override\n+    public void deleteApplicationsByTenantId(int tenantId) throws IdentityApplicationManagementException {\n+\n+        if (log.isDebugEnabled()) {", "originalCommit": "4843821f680d349686111c760cc96650d098a818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExOTg3Nw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r426119877", "bodyText": "\ud83d\udc4d", "author": "sumedhe", "createdAt": "2020-05-16T05:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExOTc2Mw=="}], "type": "inlineReview"}, {"oid": "4630f53f1e5b8e7a49e607681b2ed12a39c5bc16", "url": "https://github.com/wso2/carbon-identity-framework/commit/4630f53f1e5b8e7a49e607681b2ed12a39c5bc16", "message": "Add audit logging and fix minor issues", "committedDate": "2020-05-19T08:41:15Z", "type": "commit"}, {"oid": "88800c6dd0f30fbfc3c606117f394bf390e7b527", "url": "https://github.com/wso2/carbon-identity-framework/commit/88800c6dd0f30fbfc3c606117f394bf390e7b527", "message": "Merge remote-tracking branch 'wso2/master' into delete-sp-apps-on-tenant-deletion", "committedDate": "2020-06-14T16:56:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2NDAyMQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r440764021", "bodyText": "Add the params of the method.", "author": "ShanChathusanda93", "createdAt": "2020-06-16T10:57:16Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/dao/impl/ApplicationDAOImpl.java", "diffHunk": "@@ -3538,6 +3545,45 @@ public void deleteApplication(int applicationID, Connection connection)\n \n     }\n \n+    /**\n+     * Delete all applications of a given tenant id.\n+     *\n+     * @param", "originalCommit": "c159bf2a8d905d2c763bd4368c46dcb51081c71b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4f9c57f8b47155708dbd961bb95ad2300e52e84", "url": "https://github.com/wso2/carbon-identity-framework/commit/c4f9c57f8b47155708dbd961bb95ad2300e52e84", "message": "Add cache cleaning after deletion", "committedDate": "2020-06-16T20:06:45Z", "type": "forcePushed"}, {"oid": "5a9ebd30e2972ba85399e560f38f4455d384c8cc", "url": "https://github.com/wso2/carbon-identity-framework/commit/5a9ebd30e2972ba85399e560f38f4455d384c8cc", "message": "Add cache cleaning after deletion", "committedDate": "2020-06-16T20:08:45Z", "type": "commit"}, {"oid": "5a9ebd30e2972ba85399e560f38f4455d384c8cc", "url": "https://github.com/wso2/carbon-identity-framework/commit/5a9ebd30e2972ba85399e560f38f4455d384c8cc", "message": "Add cache cleaning after deletion", "committedDate": "2020-06-16T20:08:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc2MTQxMA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r442761410", "bodyText": "rename to  public void deleteApplications(int tenantId)", "author": "IsuraD", "createdAt": "2020-06-19T10:27:29Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/dao/impl/ApplicationDAOImpl.java", "diffHunk": "@@ -3538,6 +3545,45 @@ public void deleteApplication(int applicationID, Connection connection)\n \n     }\n \n+    /**\n+     * Delete all applications of a given tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityApplicationManagementException\n+     */\n+    @Override\n+    public void deleteApplicationsByTenantId(int tenantId) throws IdentityApplicationManagementException {", "originalCommit": "5a9ebd30e2972ba85399e560f38f4455d384c8cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc2MTUyOQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r442761529", "bodyText": "Use org.wso2.carbon.identity.oauth2.listener.TenantCreationEventListener", "author": "IsuraD", "createdAt": "2020-06-19T10:27:46Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/listener/ApplicationTenantMgtListener.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.wso2.carbon.identity.application.mgt.listener;\n+\n+import org.wso2.carbon.identity.application.common.IdentityApplicationManagementException;\n+import org.wso2.carbon.identity.application.mgt.ApplicationManagementService;\n+import org.wso2.carbon.stratos.common.beans.TenantInfoBean;\n+import org.wso2.carbon.stratos.common.exception.StratosException;\n+import org.wso2.carbon.stratos.common.listeners.TenantMgtListener;\n+\n+/**\n+ * Application Tenant Management Listener\n+ */\n+public class ApplicationTenantMgtListener implements TenantMgtListener {", "originalCommit": "5a9ebd30e2972ba85399e560f38f4455d384c8cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1Njk1MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r443156951", "bodyText": "Removed ApplicationTenantMgtListener and will use org.wso2.carbon.identity.oauth2.listener.TenantCreationEventListener instead.", "author": "sumedhe", "createdAt": "2020-06-20T20:15:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc2MTUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc2MTc1Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r442761752", "bodyText": "better use try with resource", "author": "IsuraD", "createdAt": "2020-06-19T10:28:16Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/dao/impl/ApplicationDAOImpl.java", "diffHunk": "@@ -3538,6 +3545,45 @@ public void deleteApplication(int applicationID, Connection connection)\n \n     }\n \n+    /**\n+     * Delete all applications of a given tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityApplicationManagementException\n+     */\n+    @Override\n+    public void deleteApplicationsByTenantId(int tenantId) throws IdentityApplicationManagementException {\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Deleting all applications of the tenant: \" + tenantId);\n+        }\n+\n+        String auditData = \"\\\"\" + \"Tenant Id\" + \"\\\" : \\\"\" + tenantId + \"\\\"\";\n+\n+        Connection connection = IdentityDatabaseUtil.getDBConnection(false);\n+        PreparedStatement deleteClientPrepStmt = null;\n+\n+        try {", "originalCommit": "5a9ebd30e2972ba85399e560f38f4455d384c8cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29bee8e9207af422f4ab3e61aaf38f0566359877", "url": "https://github.com/wso2/carbon-identity-framework/commit/29bee8e9207af422f4ab3e61aaf38f0566359877", "message": "Remove ApplicationTenantMgtListener and fix minor issues", "committedDate": "2020-06-20T20:11:44Z", "type": "forcePushed"}, {"oid": "63d253dd3f414c122fad68907a164d830bf19406", "url": "https://github.com/wso2/carbon-identity-framework/commit/63d253dd3f414c122fad68907a164d830bf19406", "message": "Remove ApplicationTenantMgtListener and fix minor issues", "committedDate": "2020-06-23T07:11:31Z", "type": "commit"}, {"oid": "63d253dd3f414c122fad68907a164d830bf19406", "url": "https://github.com/wso2/carbon-identity-framework/commit/63d253dd3f414c122fad68907a164d830bf19406", "message": "Remove ApplicationTenantMgtListener and fix minor issues", "committedDate": "2020-06-23T07:11:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcwODM5Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r551708393", "bodyText": "Complete the Javadoc comment by adding the specific Exception type. The param descriptions should start with a capital letter and end with a full stop.", "author": "sachiniWettasinghe", "createdAt": "2021-01-05T04:19:33Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/ApplicationManagementService.java", "diffHunk": "@@ -131,6 +131,14 @@ public abstract void updateApplication(ServiceProvider serviceProvider, String t\n     public abstract void deleteApplication(String applicationName, String tenantDomain, String username)\n             throws IdentityApplicationManagementException;\n \n+    /**\n+     * Delete Applications by tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityApplicationManagementException", "originalCommit": "63d253dd3f414c122fad68907a164d830bf19406", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcwODUwMQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r551708501", "bodyText": "Check every other instance and fix this", "author": "sachiniWettasinghe", "createdAt": "2021-01-05T04:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcwODM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5NTQwMA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r552995400", "bodyText": "Fixed in #3312", "author": "sumedhe", "createdAt": "2021-01-06T22:25:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcwODM5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcwODYwNg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r551708606", "bodyText": "Comment should end with a full stop.", "author": "sachiniWettasinghe", "createdAt": "2021-01-05T04:20:54Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/ApplicationManagementServiceImpl.java", "diffHunk": "@@ -714,6 +718,38 @@ public void deleteApplication(String applicationName, String tenantDomain, Strin\n         }\n     }\n \n+    /**\n+     * Delete Applications by tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityApplicationManagementException\n+     */\n+    @Override\n+    public void deleteApplications(int tenantId) throws IdentityApplicationManagementException {\n+\n+        String tenantDomain = IdentityTenantUtil.getTenantDomain(tenantId);\n+        ApplicationBasicInfo[] applicationBasicInfos = getAllApplicationBasicInfo(\n+                tenantDomain, CarbonContext.getThreadLocalCarbonContext().getUsername());\n+\n+        ApplicationDAO appDAO = ApplicationMgtSystemConfig.getInstance().getApplicationDAO();\n+        appDAO.deleteApplications(tenantId);\n+\n+        // Clear cache entries of each deleted SP", "originalCommit": "63d253dd3f414c122fad68907a164d830bf19406", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5NTQ2Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r552995466", "bodyText": "Fixed in #3312", "author": "sumedhe", "createdAt": "2021-01-06T22:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcwODYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcxNTEwNg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r551715106", "bodyText": "end the comment with a full stop", "author": "sachiniWettasinghe", "createdAt": "2021-01-05T04:49:45Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/dao/impl/ApplicationDAOImpl.java", "diffHunk": "@@ -3538,6 +3545,41 @@ public void deleteApplication(int applicationID, Connection connection)\n \n     }\n \n+    /**\n+     * Delete all applications of a given tenant id.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityApplicationManagementException\n+     */\n+    @Override\n+    public void deleteApplications(int tenantId) throws IdentityApplicationManagementException {\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Deleting all applications of the tenant: \" + tenantId);\n+        }\n+\n+        String auditData = \"\\\"\" + \"Tenant Id\" + \"\\\" : \\\"\" + tenantId + \"\\\"\";\n+\n+        try (Connection connection = IdentityDatabaseUtil.getDBConnection(true)) {\n+\n+            // Delete the application certificates of the tenant", "originalCommit": "63d253dd3f414c122fad68907a164d830bf19406", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5NTU2Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r552995563", "bodyText": "Fixed in #3312", "author": "sumedhe", "createdAt": "2021-01-06T22:25:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcxNTEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcxNTQwNw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r551715407", "bodyText": "Format the Javadoc descriptions. Also, the descriptions should end with a full stop.", "author": "sachiniWettasinghe", "createdAt": "2021-01-05T04:51:11Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/dao/impl/ApplicationDAOImpl.java", "diffHunk": "@@ -5060,4 +5125,24 @@ private int createServiceProvider(String tenantDomain, ServiceProvider servicePr\n         }\n         return applicationId;\n     }\n+\n+    /**\n+     * Add audit log entry.\n+     *\n+     * @param action Action\n+     * @param data Audit data\n+     * @param result Result", "originalCommit": "63d253dd3f414c122fad68907a164d830bf19406", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5NTYwMA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r552995600", "bodyText": "Fixed in #3312", "author": "sumedhe", "createdAt": "2021-01-06T22:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcxNTQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcxNTcwNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r551715704", "bodyText": "Remove redundant line", "author": "sachiniWettasinghe", "createdAt": "2021-01-05T04:52:33Z", "path": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/dao/impl/ApplicationDAOImpl.java", "diffHunk": "@@ -5060,4 +5125,24 @@ private int createServiceProvider(String tenantDomain, ServiceProvider servicePr\n         }\n         return applicationId;\n     }\n+\n+    /**\n+     * Add audit log entry.\n+     *\n+     * @param action Action\n+     * @param data Audit data\n+     * @param result Result\n+     */\n+    private void audit(String action, String data, String result) {\n+\n+        String loggedInUser = PrivilegedCarbonContext.getThreadLocalCarbonContext().getUsername();\n+        if (StringUtils.isBlank(loggedInUser)) {\n+            loggedInUser = CarbonConstants.REGISTRY_SYSTEM_USERNAME;\n+        }\n+", "originalCommit": "63d253dd3f414c122fad68907a164d830bf19406", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5NTY1NA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2936#discussion_r552995654", "bodyText": "Fixed in #3312", "author": "sumedhe", "createdAt": "2021-01-06T22:26:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcxNTcwNA=="}], "type": "inlineReview"}]}