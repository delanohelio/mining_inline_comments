{"pr_number": 2978, "pr_title": "optimize: opt globalCommit for mixed use of AT and TCC", "pr_createdAt": "2020-08-05T10:18:29Z", "pr_url": "https://github.com/seata/seata/pull/2978", "timeline": [{"oid": "d648192e586320ad7de6f713bfeeb95b25dc1b96", "url": "https://github.com/seata/seata/commit/d648192e586320ad7de6f713bfeeb95b25dc1b96", "message": "optimize: opt globalCommit for mixed use of AT and TCC", "committedDate": "2020-08-05T10:14:28Z", "type": "commit"}, {"oid": "aeabbfce88166e2be35b2719ee65ef9a87ccf155", "url": "https://github.com/seata/seata/commit/aeabbfce88166e2be35b2719ee65ef9a87ccf155", "message": "Merge branch 'develop' into optimize-at-tcc-globalCommit", "committedDate": "2020-08-05T10:23:19Z", "type": "commit"}, {"oid": "eef3a70bc92aed76ef0997604c233cf360f6d4b7", "url": "https://github.com/seata/seata/commit/eef3a70bc92aed76ef0997604c233cf360f6d4b7", "message": "\u6dfb\u52a0\u53ef\u5f02\u6b65\u63d0\u4ea4\u7684\u63a5\u53e3\u3002", "committedDate": "2020-08-06T01:40:17Z", "type": "commit"}, {"oid": "d08053aba7bed0e156f6a950006252a356b809a1", "url": "https://github.com/seata/seata/commit/d08053aba7bed0e156f6a950006252a356b809a1", "message": "Merge remote-tracking branch 'remotes/upstream/develop' into optimize-at-tcc-globalCommit", "committedDate": "2020-08-06T01:41:11Z", "type": "commit"}, {"oid": "5345d36752cdc54de3a20bdd55c13533446a92b4", "url": "https://github.com/seata/seata/commit/5345d36752cdc54de3a20bdd55c13533446a92b4", "message": "Merge branch 'develop' into optimize-at-tcc-globalCommit", "committedDate": "2020-08-06T11:05:42Z", "type": "commit"}, {"oid": "316322ca7899ed798c89fc9abfa38cde4a820ecf", "url": "https://github.com/seata/seata/commit/316322ca7899ed798c89fc9abfa38cde4a820ecf", "message": "Merge branch 'develop' into optimize-at-tcc-globalCommit", "committedDate": "2020-08-07T02:32:06Z", "type": "commit"}, {"oid": "4921b3db32c9a7f2bcbedc3b73b1be15b690539b", "url": "https://github.com/seata/seata/commit/4921b3db32c9a7f2bcbedc3b73b1be15b690539b", "message": "\u5c0f\u8c03\u6574\u3002", "committedDate": "2020-08-07T03:48:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgzNDY1Mw==", "url": "https://github.com/seata/seata/pull/2978#discussion_r466834653", "bodyText": "there will be a ConcurrentModificationException\uff0cIterators should be used", "author": "a364176773", "createdAt": "2020-08-07T05:50:22Z", "path": "server/src/main/java/io/seata/server/session/GlobalSession.java", "diffHunk": "@@ -106,15 +109,54 @@ public boolean remove(BranchSession branchSession) {\n      *\n      * @return the boolean\n      */\n+    @Override\n     public boolean canBeCommittedAsync() {\n         for (BranchSession branchSession : branchSessions) {\n-            if (branchSession.getBranchType() == BranchType.TCC || branchSession.getBranchType() == BranchType.XA) {\n+            if (!branchSession.canBeCommittedAsync()) {\n                 return false;\n             }\n         }\n         return true;\n     }\n \n+    /**\n+     * Take out branch sessions that can be committed async.\n+     *\n+     * @return the branch sessions that can be committed async\n+     */\n+    public ArrayList<BranchSession> takeOutBranchSessionsCanBeCommittedAsync() {\n+        ArrayList<BranchSession> branchSessionsCanBeCommittedAsync = new ArrayList<>();\n+\n+        BranchSession branchSession;\n+        for (int i = 0; i < branchSessions.size(); i++) {\n+            branchSession = branchSessions.get(i);\n+            if (branchSession.getBranchType() == BranchType.AT) {\n+                branchSessions.remove(i);", "originalCommit": "4921b3db32c9a7f2bcbedc3b73b1be15b690539b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "238fa7516b6045285838d7faf07eb918a4ea437b", "url": "https://github.com/seata/seata/commit/238fa7516b6045285838d7faf07eb918a4ea437b", "message": "for+remove\uff0c\u6539\u4e3aiter+remove", "committedDate": "2020-08-07T06:03:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg2Nzg2MQ==", "url": "https://github.com/seata/seata/pull/2978#discussion_r466867861", "bodyText": "branchSessionsCanBeCommittedAsync   -> branchSessions \uff1f", "author": "slievrly", "createdAt": "2020-08-07T07:23:58Z", "path": "server/src/main/java/io/seata/server/session/GlobalSession.java", "diffHunk": "@@ -106,15 +110,54 @@ public boolean remove(BranchSession branchSession) {\n      *\n      * @return the boolean\n      */\n+    @Override\n     public boolean canBeCommittedAsync() {\n         for (BranchSession branchSession : branchSessions) {\n-            if (branchSession.getBranchType() == BranchType.TCC || branchSession.getBranchType() == BranchType.XA) {\n+            if (!branchSession.canBeCommittedAsync()) {\n                 return false;\n             }\n         }\n         return true;\n     }\n \n+    /**\n+     * Take out branch sessions that can be committed async.\n+     *\n+     * @return the branch sessions that can be committed async\n+     */\n+    public ArrayList<BranchSession> takeOutBranchSessionsCanBeCommittedAsync() {\n+        ArrayList<BranchSession> branchSessionsCanBeCommittedAsync = new ArrayList<>();\n+\n+        BranchSession branchSession;\n+        Iterator<BranchSession> iter = branchSessions.iterator();\n+        while (iter.hasNext()) {\n+            branchSession = iter.next();\n+            if (branchSession.getBranchType() == BranchType.AT) {\n+                iter.remove();\n+                branchSessionsCanBeCommittedAsync.add(branchSession);\n+            }\n+        }\n+\n+        if (branchSessionsCanBeCommittedAsync.size() > 0) {", "originalCommit": "238fa7516b6045285838d7faf07eb918a4ea437b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7f8057f7eeefe5d33967e2213a948b967540f6c7", "url": "https://github.com/seata/seata/commit/7f8057f7eeefe5d33967e2213a948b967540f6c7", "message": "\u4ee3\u7801\u91cd\u6784\u3002", "committedDate": "2020-08-07T08:17:45Z", "type": "commit"}, {"oid": "8f71ed68e3a692219d6abe70b08b603d137509c1", "url": "https://github.com/seata/seata/commit/8f71ed68e3a692219d6abe70b08b603d137509c1", "message": "fix style", "committedDate": "2020-08-07T11:18:32Z", "type": "commit"}, {"oid": "38b1019e714ddac8b5f7d23294b12fc54f92a434", "url": "https://github.com/seata/seata/commit/38b1019e714ddac8b5f7d23294b12fc54f92a434", "message": "bug\u4fee\u590d\u3002", "committedDate": "2020-08-07T11:38:41Z", "type": "commit"}, {"oid": "75c47c589ac04bd4471648f7df46963855315b23", "url": "https://github.com/seata/seata/commit/75c47c589ac04bd4471648f7df46963855315b23", "message": "bug\u4fee\u590d\u3002", "committedDate": "2020-08-07T11:41:05Z", "type": "commit"}, {"oid": "dc4a4994d4bed6b989b046eddde3c59f68e8b77e", "url": "https://github.com/seata/seata/commit/dc4a4994d4bed6b989b046eddde3c59f68e8b77e", "message": "\u4f18\u5316\u5f02\u6b65\u63d0\u4ea4\u7684\u903b\u8f91\u3002", "committedDate": "2020-08-10T03:24:47Z", "type": "commit"}, {"oid": "5a9cd1f2e5483e514727e56a397176bf61c1bd2f", "url": "https://github.com/seata/seata/commit/5a9cd1f2e5483e514727e56a397176bf61c1bd2f", "message": "\u5c0f\u8c03\u6574\u3002", "committedDate": "2020-08-10T03:30:00Z", "type": "commit"}, {"oid": "95f3b7b89b6f6ad416706dc7080271ae85d1e078", "url": "https://github.com/seata/seata/commit/95f3b7b89b6f6ad416706dc7080271ae85d1e078", "message": "\u6d4b\u8bd5\u7528\u4f8b\u8c03\u6574\u3002", "committedDate": "2020-08-10T03:48:37Z", "type": "commit"}, {"oid": "de337ecd7530569200d694f0fb8c958e8a591a03", "url": "https://github.com/seata/seata/commit/de337ecd7530569200d694f0fb8c958e8a591a03", "message": "\u6d4b\u8bd5\u7528\u4f8b\u8c03\u6574\u3002", "committedDate": "2020-08-10T04:56:59Z", "type": "commit"}, {"oid": "3e2166261d1c02cedd06efb295777627d1656b74", "url": "https://github.com/seata/seata/commit/3e2166261d1c02cedd06efb295777627d1656b74", "message": "\u6d4b\u8bd5\u7528\u4f8b\u8c03\u6574\u3002", "committedDate": "2020-08-10T05:42:01Z", "type": "commit"}, {"oid": "a461a1687df6de9b82193ad0cee9fd5097ce5f5a", "url": "https://github.com/seata/seata/commit/a461a1687df6de9b82193ad0cee9fd5097ce5f5a", "message": "\u6821\u9a8c\u662f\u5426\u5141\u8bb8\u5f02\u6b65\u63d0\u4ea4\u7684\u65b9\u6cd5\u8c03\u6574\uff0c\u6dfb\u52a0\u4e00\u9636\u6bb5\u5931\u8d25\u7684\u5206\u652f\u3002", "committedDate": "2020-08-11T05:21:38Z", "type": "commit"}, {"oid": "7ea57ad1a7b2f9a23fa14dacc4d11694f4d0539b", "url": "https://github.com/seata/seata/commit/7ea57ad1a7b2f9a23fa14dacc4d11694f4d0539b", "message": "\u79fb\u9664\u63a5\u53e3AsyncableCommitted", "committedDate": "2020-08-12T00:39:22Z", "type": "commit"}, {"oid": "dcbc0f1e1a7923b7e984cafca3a5002366c04b3a", "url": "https://github.com/seata/seata/commit/dcbc0f1e1a7923b7e984cafca3a5002366c04b3a", "message": "Merge branch 'develop' into optimize-at-tcc-globalCommit", "committedDate": "2020-08-13T01:32:08Z", "type": "commit"}, {"oid": "2037be1a9174f69a15cf34a599084cf41f03f2da", "url": "https://github.com/seata/seata/commit/2037be1a9174f69a15cf34a599084cf41f03f2da", "message": "Merge branch 'develop' into optimize-at-tcc-globalCommit", "committedDate": "2020-08-18T04:00:16Z", "type": "commit"}]}