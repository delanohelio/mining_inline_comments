{"pr_number": 2409, "pr_title": "optimize: reduce the db and network request when undoLog  or lockKey is empty", "pr_createdAt": "2020-03-16T06:40:06Z", "pr_url": "https://github.com/seata/seata/pull/2409", "timeline": [{"oid": "c90abc0e585962b8438ab978d8237c81ee9c6ef3", "url": "https://github.com/seata/seata/commit/c90abc0e585962b8438ab978d8237c81ee9c6ef3", "message": "optimize:optimize useless branch register", "committedDate": "2020-03-16T06:34:42Z", "type": "commit"}, {"oid": "46481ce2c55ef569b6f1f284c8c44ec455952913", "url": "https://github.com/seata/seata/commit/46481ce2c55ef569b6f1f284c8c44ec455952913", "message": "add:add the report for not registered branch", "committedDate": "2020-03-18T02:10:02Z", "type": "commit"}, {"oid": "1f8d2c64c80a3875796b1b54170f039c9c42d93f", "url": "https://github.com/seata/seata/commit/1f8d2c64c80a3875796b1b54170f039c9c42d93f", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register", "committedDate": "2020-03-20T01:21:16Z", "type": "commit"}, {"oid": "1e141cf9a00fc4b21f41e8f95f8e11fac85a53db", "url": "https://github.com/seata/seata/commit/1e141cf9a00fc4b21f41e8f95f8e11fac85a53db", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register", "committedDate": "2020-03-21T06:55:22Z", "type": "commit"}, {"oid": "6d1245301380cbc1f6ec80e2c38803f35a5469f9", "url": "https://github.com/seata/seata/commit/6d1245301380cbc1f6ec80e2c38803f35a5469f9", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register", "committedDate": "2020-03-24T10:51:54Z", "type": "commit"}, {"oid": "483664c2f5fa55d5e85f83922589e1283603080f", "url": "https://github.com/seata/seata/commit/483664c2f5fa55d5e85f83922589e1283603080f", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register", "committedDate": "2020-03-26T09:25:07Z", "type": "commit"}, {"oid": "8119c88dec0f5f8925a0e7028b2221bece896529", "url": "https://github.com/seata/seata/commit/8119c88dec0f5f8925a0e7028b2221bece896529", "message": "fix:fix mock error", "committedDate": "2020-03-26T09:26:10Z", "type": "commit"}, {"oid": "e4df3f9af7369bedafbb4e90eec8b2e6226a02d8", "url": "https://github.com/seata/seata/commit/e4df3f9af7369bedafbb4e90eec8b2e6226a02d8", "message": "optimize:optimize the code", "committedDate": "2020-03-30T09:13:12Z", "type": "commit"}, {"oid": "9823bde9019e2afdc21695964ad002093efb30ce", "url": "https://github.com/seata/seata/commit/9823bde9019e2afdc21695964ad002093efb30ce", "message": "Merge branch 'develop' into optimize_useless_register", "committedDate": "2020-03-31T07:58:51Z", "type": "commit"}, {"oid": "a6f8c600ddaceb1d19643a3a8781f7eeaaf6c8c0", "url": "https://github.com/seata/seata/commit/a6f8c600ddaceb1d19643a3a8781f7eeaaf6c8c0", "message": "Merge branch 'develop' into optimize_useless_register", "committedDate": "2020-03-31T09:24:11Z", "type": "commit"}, {"oid": "9ca866b352301294b0603d37e694d34848c8867d", "url": "https://github.com/seata/seata/commit/9ca866b352301294b0603d37e694d34848c8867d", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register", "committedDate": "2020-04-01T01:55:21Z", "type": "commit"}, {"oid": "53dcc5aeea159472915f9cdf1a87c2d1e9d5fe4e", "url": "https://github.com/seata/seata/commit/53dcc5aeea159472915f9cdf1a87c2d1e9d5fe4e", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register", "committedDate": "2020-04-01T09:07:59Z", "type": "commit"}, {"oid": "85db4e8615c081dca2860dcf62866434ee9c7890", "url": "https://github.com/seata/seata/commit/85db4e8615c081dca2860dcf62866434ee9c7890", "message": "Merge branch 'optimize_useless_register' of github.com:lightClouds917/seata into optimize_useless_register", "committedDate": "2020-04-01T09:21:43Z", "type": "commit"}, {"oid": "9b0707a490c7cf0a8f68efaf40dea1900967ce30", "url": "https://github.com/seata/seata/commit/9b0707a490c7cf0a8f68efaf40dea1900967ce30", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register", "committedDate": "2020-04-06T01:33:57Z", "type": "commit"}, {"oid": "12fa50b85fb064c31ae312ceddb5e4f615cb4d8c", "url": "https://github.com/seata/seata/commit/12fa50b85fb064c31ae312ceddb5e4f615cb4d8c", "message": "optimize:remove the unuse code", "committedDate": "2020-04-06T13:01:56Z", "type": "commit"}, {"oid": "7eb4daaf621daf7dcc32610d9c8cbe2b17fcf2ef", "url": "https://github.com/seata/seata/commit/7eb4daaf621daf7dcc32610d9c8cbe2b17fcf2ef", "message": "optimize:optimize the log", "committedDate": "2020-04-06T13:11:56Z", "type": "commit"}, {"oid": "13ac802cf582a202dca63ebe63d64fefc263a5bd", "url": "https://github.com/seata/seata/commit/13ac802cf582a202dca63ebe63d64fefc263a5bd", "message": "Merge branch 'develop' into optimize_useless_register", "committedDate": "2020-04-10T03:40:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE5MTY5MQ==", "url": "https://github.com/seata/seata/pull/2409#discussion_r407191691", "bodyText": "lack throw new SQLException(ex);", "author": "zjinlei", "createdAt": "2020-04-12T12:31:45Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -211,23 +211,32 @@ private void processLocalCommitWithGlobalLocks() throws SQLException {\n     }\n \n     private void processGlobalTransactionCommit() throws SQLException {\n-        try {\n-            register();\n-        } catch (TransactionException e) {\n-            recognizeLockKeyConflictException(e, context.buildLockKeys());\n-        }\n-\n-        try {\n-            if (context.hasUndoLog()) {\n+        boolean hasUndoLog = context.hasUndoLog();\n+        if (hasUndoLog) {\n+            try {\n+                register();\n+            } catch (TransactionException e) {\n+                recognizeLockKeyConflictException(e, context.buildLockKeys());\n+            }\n+            try {\n                 UndoLogManagerFactory.getUndoLogManager(this.getDbType()).flushUndoLogs(this);\n+            } catch (SQLException sqlEx) {\n+                LOGGER.error(\"add undoLog error:{}\", sqlEx.getMessage(), sqlEx);\n+                throw new SQLException(sqlEx);\n             }\n+        }\n+        try {\n             targetConnection.commit();\n         } catch (Throwable ex) {\n-            LOGGER.error(\"process connectionProxy commit error: {}\", ex.getMessage(), ex);\n-            report(false);\n-            throw new SQLException(ex);\n+            if (hasUndoLog) {\n+                LOGGER.error(\"process connectionProxy commit error: {}\", ex.getMessage(), ex);\n+                report(false);\n+                throw new SQLException(ex);\n+            } else {\n+                LOGGER.error(\"process connectionProxy commit error: {},and the undolog is null\", ex.getMessage(), ex);", "originalCommit": "13ac802cf582a202dca63ebe63d64fefc263a5bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI3NTM0Nw==", "url": "https://github.com/seata/seata/pull/2409#discussion_r407275347", "bodyText": "ok,i will fix", "author": "lightClouds917", "createdAt": "2020-04-13T00:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE5MTY5MQ=="}], "type": "inlineReview"}, {"oid": "b113b7151040190b8213d44d2bd0fd8bdf451e57", "url": "https://github.com/seata/seata/commit/b113b7151040190b8213d44d2bd0fd8bdf451e57", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register", "committedDate": "2020-04-13T00:56:38Z", "type": "commit"}, {"oid": "29da872e0ca4ff49b4f2f3130af222d75c712baa", "url": "https://github.com/seata/seata/commit/29da872e0ca4ff49b4f2f3130af222d75c712baa", "message": "Merge branch 'optimize_useless_register' of github.com:lightClouds917/seata into optimize_useless_register", "committedDate": "2020-04-13T01:10:06Z", "type": "commit"}, {"oid": "65cddffb9bab2bc3bac3ed093f72731b0f57ca0d", "url": "https://github.com/seata/seata/commit/65cddffb9bab2bc3bac3ed093f72731b0f57ca0d", "message": "optimize:optimize the code", "committedDate": "2020-04-13T01:44:54Z", "type": "commit"}, {"oid": "393b8f10be4486777bea452b3b9ab38373a18552", "url": "https://github.com/seata/seata/commit/393b8f10be4486777bea452b3b9ab38373a18552", "message": "optimize:optimize the code", "committedDate": "2020-04-13T02:13:25Z", "type": "commit"}, {"oid": "0f8b6c1d6ebdb4d0b05d5f17c384ac31f7c824c0", "url": "https://github.com/seata/seata/commit/0f8b6c1d6ebdb4d0b05d5f17c384ac31f7c824c0", "message": "indentation 4", "committedDate": "2020-04-13T07:19:51Z", "type": "commit"}, {"oid": "758e046fef9bbeff878f692beecc9144e2299992", "url": "https://github.com/seata/seata/commit/758e046fef9bbeff878f692beecc9144e2299992", "message": "Merge branch 'develop' into optimize_useless_register", "committedDate": "2020-04-13T09:51:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ0NDE1Mw==", "url": "https://github.com/seata/seata/pull/2409#discussion_r407444153", "bodyText": "I think it's better to put it in registers and flushUndoLogs.\nif there is no undolog why flushUndoLogs method execution without judgment", "author": "slievrly", "createdAt": "2020-04-13T11:54:53Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -211,24 +211,30 @@ private void processLocalCommitWithGlobalLocks() throws SQLException {\n     }\n \n     private void processGlobalTransactionCommit() throws SQLException {\n-        try {\n-            register();\n-        } catch (TransactionException e) {\n-            recognizeLockKeyConflictException(e, context.buildLockKeys());\n-        }\n-\n-        try {\n-            if (context.hasUndoLog()) {\n+        if (context.hasUndoLog()) {\n+            try {\n+                register();", "originalCommit": "758e046fef9bbeff878f692beecc9144e2299992", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzOTY4NA==", "url": "https://github.com/seata/seata/pull/2409#discussion_r407839684", "bodyText": "I have finish it.PTAL", "author": "lightClouds917", "createdAt": "2020-04-14T03:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ0NDE1Mw=="}], "type": "inlineReview"}, {"oid": "f21ec2f719b37bdeaaa611fa3d4c8a33df34e412", "url": "https://github.com/seata/seata/commit/f21ec2f719b37bdeaaa611fa3d4c8a33df34e412", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register", "committedDate": "2020-04-13T14:10:12Z", "type": "commit"}, {"oid": "b7ed0b75ab062e22fac2a5e0159d923992aeaafc", "url": "https://github.com/seata/seata/commit/b7ed0b75ab062e22fac2a5e0159d923992aeaafc", "message": "optimize:optimize the code", "committedDate": "2020-04-13T14:29:12Z", "type": "commit"}, {"oid": "6bd65bfb5ca5b4e8c88fa1802c5e9772db1f377d", "url": "https://github.com/seata/seata/commit/6bd65bfb5ca5b4e8c88fa1802c5e9772db1f377d", "message": "Merge branch 'optimize_useless_register' of github.com:lightClouds917/seata into optimize_useless_register", "committedDate": "2020-04-13T14:32:32Z", "type": "commit"}, {"oid": "8368360be0a07c529cf3fd70b88280984ff13a94", "url": "https://github.com/seata/seata/commit/8368360be0a07c529cf3fd70b88280984ff13a94", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register", "committedDate": "2020-04-14T02:55:22Z", "type": "commit"}, {"oid": "c3315bcb0bb2d33c948b396679b08ba45a613a1a", "url": "https://github.com/seata/seata/commit/c3315bcb0bb2d33c948b396679b08ba45a613a1a", "message": "bugfix:fix the unit test", "committedDate": "2020-04-14T02:56:01Z", "type": "commit"}]}