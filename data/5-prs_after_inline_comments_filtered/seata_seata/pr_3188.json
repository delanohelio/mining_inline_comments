{"pr_number": 3188, "pr_title": "optimize: Local variable 'map' is redundant and check queue offer return value", "pr_createdAt": "2020-10-13T13:18:40Z", "pr_url": "https://github.com/seata/seata/pull/3188", "timeline": [{"oid": "8c7e5b6250dda5be67fa93d9985ac9edd5b37916", "url": "https://github.com/seata/seata/commit/8c7e5b6250dda5be67fa93d9985ac9edd5b37916", "message": "optimize: remove repeated conditional tests (#3161)", "committedDate": "2020-09-29T07:21:07Z", "type": "commit"}, {"oid": "bc11ac673fba43260a58a394bff7b512bb590145", "url": "https://github.com/seata/seata/commit/bc11ac673fba43260a58a394bff7b512bb590145", "message": "optimize: remove repeated conditional tests (#3161)", "committedDate": "2020-09-29T07:45:05Z", "type": "commit"}, {"oid": "c2d1d5cc140341ab2b30ecb41ac26b645258873f", "url": "https://github.com/seata/seata/commit/c2d1d5cc140341ab2b30ecb41ac26b645258873f", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-01T13:09:15Z", "type": "commit"}, {"oid": "340ffbb9e47c8b133dacb300eeced9171549e4ab", "url": "https://github.com/seata/seata/commit/340ffbb9e47c8b133dacb300eeced9171549e4ab", "message": "Merge branch 'develop' of https://github.com/seata/seata into develop", "committedDate": "2020-10-13T12:52:56Z", "type": "commit"}, {"oid": "e45c5f81328160fdd2ac74625d037b5290807809", "url": "https://github.com/seata/seata/commit/e45c5f81328160fdd2ac74625d037b5290807809", "message": "optimize: Local variable 'map' is redundant and check queue offer return value #3187", "committedDate": "2020-10-13T13:12:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NTIxMw==", "url": "https://github.com/seata/seata/pull/3188#discussion_r503995213", "bodyText": "if(LOGGER.isErrorEnabled()){\nLOGGER.error(\"put message into basketMap offer failed, serverAddress:{},rpcMessage:{}\", serverAddress,\nrpcMessage);\n}", "author": "a364176773", "createdAt": "2020-10-13T14:23:48Z", "path": "core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java", "diffHunk": "@@ -152,13 +152,12 @@ public Object sendSyncRequest(Object msg) throws TimeoutException {\n             futures.put(rpcMessage.getId(), messageFuture);\n \n             // put message into basketMap\n-            ConcurrentHashMap<String, BlockingQueue<RpcMessage>> map = basketMap;\n-            BlockingQueue<RpcMessage> basket = map.get(serverAddress);\n-            if (basket == null) {\n-                map.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n-                basket = map.get(serverAddress);\n+            basketMap.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n+            if (!basketMap.get(serverAddress).offer(rpcMessage)) {\n+                LOGGER.error(\"put message into basketMap offer failed, serverAddress:{},rpcMessage:{}\",", "originalCommit": "e45c5f81328160fdd2ac74625d037b5290807809", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzNjg4OQ==", "url": "https://github.com/seata/seata/pull/3188#discussion_r504436889", "bodyText": "\u53ef\u4ee5\u4e0d\u7528if\u5224\u65ad\u7684\u3002error\u65e5\u5fd7\u57fa\u672c\u4e0a\u9700\u8981\u8bb0\u5f55\uff0c\u53e6\u4e00\u4e2a\uff0c\u65e5\u5fd7\u4e5f\u4f7f\u7528\u4e86\u5360\u4f4d\u7b26\uff0c\u6ca1\u4ec0\u4e48\u95ee\u9898\u3002", "author": "wangliang181230", "createdAt": "2020-10-14T06:42:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NTIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAwMDQ5OA==", "url": "https://github.com/seata/seata/pull/3188#discussion_r504000498", "bodyText": "basketMap.computeIfAbsent(serverAddress, k -> new LinkedBlockingQueue<>());\nI think it's better that way. what do you think?", "author": "a364176773", "createdAt": "2020-10-13T14:30:17Z", "path": "core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java", "diffHunk": "@@ -152,13 +152,12 @@ public Object sendSyncRequest(Object msg) throws TimeoutException {\n             futures.put(rpcMessage.getId(), messageFuture);\n \n             // put message into basketMap\n-            ConcurrentHashMap<String, BlockingQueue<RpcMessage>> map = basketMap;\n-            BlockingQueue<RpcMessage> basket = map.get(serverAddress);\n-            if (basket == null) {\n-                map.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n-                basket = map.get(serverAddress);\n+            basketMap.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());", "originalCommit": "e45c5f81328160fdd2ac74625d037b5290807809", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5fd12fe577b248b1cd9ac05eff9161358fc94eff", "url": "https://github.com/seata/seata/commit/5fd12fe577b248b1cd9ac05eff9161358fc94eff", "message": "optimize: Local variable 'map' is redundant and check queue offer return value #3187", "committedDate": "2020-10-14T02:32:07Z", "type": "commit"}, {"oid": "8256383b6bca79c024b723a4ea52735cb6430c46", "url": "https://github.com/seata/seata/commit/8256383b6bca79c024b723a4ea52735cb6430c46", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:\n  optimize: Local variable 'map' is redundant and check queue offer return value #3187", "committedDate": "2020-10-14T02:33:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM2NDk4Mw==", "url": "https://github.com/seata/seata/pull/3188#discussion_r504364983", "bodyText": "do not need to get again\nBlockingQueue<RpcMessage> basket = basketMap.computeIfAbsent(serverAddress, k -> new LinkedBlockingQueue<>());\nif (!basket .offer(rpcMessage)) {\n    ......\n}", "author": "wangliang181230", "createdAt": "2020-10-14T02:35:52Z", "path": "core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java", "diffHunk": "@@ -152,13 +152,14 @@ public Object sendSyncRequest(Object msg) throws TimeoutException {\n             futures.put(rpcMessage.getId(), messageFuture);\n \n             // put message into basketMap\n-            ConcurrentHashMap<String, BlockingQueue<RpcMessage>> map = basketMap;\n-            BlockingQueue<RpcMessage> basket = map.get(serverAddress);\n-            if (basket == null) {\n-                map.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n-                basket = map.get(serverAddress);\n+            basketMap.computeIfAbsent(serverAddress, k -> new LinkedBlockingQueue<>());\n+            if (!basketMap.get(serverAddress).offer(rpcMessage)) {", "originalCommit": "8256383b6bca79c024b723a4ea52735cb6430c46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM2NTYzNQ==", "url": "https://github.com/seata/seata/pull/3188#discussion_r504365635", "bodyText": "not need check if is error log.", "author": "wangliang181230", "createdAt": "2020-10-14T02:38:25Z", "path": "core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java", "diffHunk": "@@ -152,13 +152,14 @@ public Object sendSyncRequest(Object msg) throws TimeoutException {\n             futures.put(rpcMessage.getId(), messageFuture);\n \n             // put message into basketMap\n-            ConcurrentHashMap<String, BlockingQueue<RpcMessage>> map = basketMap;\n-            BlockingQueue<RpcMessage> basket = map.get(serverAddress);\n-            if (basket == null) {\n-                map.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n-                basket = map.get(serverAddress);\n+            basketMap.computeIfAbsent(serverAddress, k -> new LinkedBlockingQueue<>());\n+            if (!basketMap.get(serverAddress).offer(rpcMessage)) {\n+                if(LOGGER.isErrorEnabled()) {", "originalCommit": "8256383b6bca79c024b723a4ea52735cb6430c46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3NTEzMg==", "url": "https://github.com/seata/seata/pull/3188#discussion_r504375132", "bodyText": "I mean, if is not required, but log is still required.", "author": "wangliang181230", "createdAt": "2020-10-14T03:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM2NTYzNQ=="}], "type": "inlineReview"}, {"oid": "17aa810cf4b463bf906ffa9496c1d22d378e7601", "url": "https://github.com/seata/seata/commit/17aa810cf4b463bf906ffa9496c1d22d378e7601", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:\n  optimize: Local variable 'map' is redundant and check queue offer return value #3187", "committedDate": "2020-10-14T03:02:40Z", "type": "commit"}, {"oid": "a90a013757ca31098d3e6a6e0ada727deb707fb3", "url": "https://github.com/seata/seata/commit/a90a013757ca31098d3e6a6e0ada727deb707fb3", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:", "committedDate": "2020-10-14T03:08:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3NDExOQ==", "url": "https://github.com/seata/seata/pull/3188#discussion_r504374119", "bodyText": "lost the !, and error log", "author": "wangliang181230", "createdAt": "2020-10-14T03:10:52Z", "path": "core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java", "diffHunk": "@@ -152,13 +152,10 @@ public Object sendSyncRequest(Object msg) throws TimeoutException {\n             futures.put(rpcMessage.getId(), messageFuture);\n \n             // put message into basketMap\n-            ConcurrentHashMap<String, BlockingQueue<RpcMessage>> map = basketMap;\n-            BlockingQueue<RpcMessage> basket = map.get(serverAddress);\n-            if (basket == null) {\n-                map.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n-                basket = map.get(serverAddress);\n+            BlockingQueue<RpcMessage> basket = basketMap.computeIfAbsent(serverAddress, k -> new LinkedBlockingQueue<>());\n+            if (basket.offer(rpcMessage)) {", "originalCommit": "a90a013757ca31098d3e6a6e0ada727deb707fb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8c8e4ede67b65db6bd60e99f1a09be5068608ca7", "url": "https://github.com/seata/seata/commit/8c8e4ede67b65db6bd60e99f1a09be5068608ca7", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:", "committedDate": "2020-10-14T03:23:51Z", "type": "commit"}, {"oid": "b0da324ca26f501999cfc202fc27c6eb82adf844", "url": "https://github.com/seata/seata/commit/b0da324ca26f501999cfc202fc27c6eb82adf844", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:", "committedDate": "2020-10-14T03:24:31Z", "type": "commit"}, {"oid": "70902c7ea5ef4568c7b20b8fd58d7b83c6e39c86", "url": "https://github.com/seata/seata/commit/70902c7ea5ef4568c7b20b8fd58d7b83c6e39c86", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:", "committedDate": "2020-10-14T05:29:12Z", "type": "commit"}, {"oid": "4528430fadacd781a3b19ebf50df4432912619d1", "url": "https://github.com/seata/seata/commit/4528430fadacd781a3b19ebf50df4432912619d1", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:", "committedDate": "2020-10-14T05:29:52Z", "type": "commit"}, {"oid": "bee315735d7bf80a6cd3b037b411502b7ce83090", "url": "https://github.com/seata/seata/commit/bee315735d7bf80a6cd3b037b411502b7ce83090", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-14T08:10:19Z", "type": "commit"}, {"oid": "c59eb9b39db254b5e490e1402b26ada0d35bf41b", "url": "https://github.com/seata/seata/commit/c59eb9b39db254b5e490e1402b26ada0d35bf41b", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-15T02:25:47Z", "type": "commit"}, {"oid": "d6308ca4a1a11599fa5789e4f45e1d67ee808f93", "url": "https://github.com/seata/seata/commit/d6308ca4a1a11599fa5789e4f45e1d67ee808f93", "message": "Merge remote-tracking branch 'origin/develop' into develop", "committedDate": "2020-10-15T02:27:07Z", "type": "commit"}, {"oid": "4220600437d629ae82c457e415916e6614a534b4", "url": "https://github.com/seata/seata/commit/4220600437d629ae82c457e415916e6614a534b4", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-20T06:07:55Z", "type": "commit"}, {"oid": "373c47d74457bb533c4c97913e6d151a5e00365e", "url": "https://github.com/seata/seata/commit/373c47d74457bb533c4c97913e6d151a5e00365e", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-20T15:56:50Z", "type": "commit"}, {"oid": "2e57d05a44fc11b8c6d60279994d01e00c73cac3", "url": "https://github.com/seata/seata/commit/2e57d05a44fc11b8c6d60279994d01e00c73cac3", "message": "Merge branch 'develop' of https://github.com/seata/seata into develop", "committedDate": "2020-10-21T11:28:28Z", "type": "commit"}, {"oid": "6006a9c8055e6c4356eb75ad3dc2724e6ef0043f", "url": "https://github.com/seata/seata/commit/6006a9c8055e6c4356eb75ad3dc2724e6ef0043f", "message": "Merge branch 'develop' into develop", "committedDate": "2020-11-11T01:50:24Z", "type": "commit"}]}