{"pr_number": 2412, "pr_title": "optimize: changed xid generation strategy to snowflake ", "pr_createdAt": "2020-03-17T04:00:25Z", "pr_url": "https://github.com/seata/seata/pull/2412", "timeline": [{"oid": "fb4cade587166b504372a01ded45c899b75471ae", "url": "https://github.com/seata/seata/commit/fb4cade587166b504372a01ded45c899b75471ae", "message": "optimize xid generation strategy", "committedDate": "2020-03-17T03:56:10Z", "type": "commit"}, {"oid": "136c91c75db6152edaeb336e8ceaf9de74f25099", "url": "https://github.com/seata/seata/commit/136c91c75db6152edaeb336e8ceaf9de74f25099", "message": "change field length", "committedDate": "2020-03-17T04:58:15Z", "type": "commit"}, {"oid": "d206807c668461e2fc93f078c05198a238f31111", "url": "https://github.com/seata/seata/commit/d206807c668461e2fc93f078c05198a238f31111", "message": "IdWorker Instantiate by service node", "committedDate": "2020-03-17T06:21:33Z", "type": "commit"}, {"oid": "7571e3e8bd5307a1b077214bb5130f7493898ed4", "url": "https://github.com/seata/seata/commit/7571e3e8bd5307a1b077214bb5130f7493898ed4", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-03-17T06:26:13Z", "type": "commit"}, {"oid": "5d0d1d87fdfc0ce61074eb775c38905a1b07a2ab", "url": "https://github.com/seata/seata/commit/5d0d1d87fdfc0ce61074eb775c38905a1b07a2ab", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-03-18T01:21:52Z", "type": "commit"}, {"oid": "5758878b5ba4bc1752a8ab31b7283f2136aa9b5b", "url": "https://github.com/seata/seata/commit/5758878b5ba4bc1752a8ab31b7283f2136aa9b5b", "message": "fix code style", "committedDate": "2020-03-18T05:52:40Z", "type": "commit"}, {"oid": "3498c04fd4c2c0f7c9d6d1f3e899528c783838ec", "url": "https://github.com/seata/seata/commit/3498c04fd4c2c0f7c9d6d1f3e899528c783838ec", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-03-19T03:19:34Z", "type": "commit"}, {"oid": "ab899eef196954b98e16f34a1e51a34e5f987a07", "url": "https://github.com/seata/seata/commit/ab899eef196954b98e16f34a1e51a34e5f987a07", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-03-20T01:26:04Z", "type": "commit"}, {"oid": "685efcfdf1e6c263ccfb17f9cbf24fc829cdb829", "url": "https://github.com/seata/seata/commit/685efcfdf1e6c263ccfb17f9cbf24fc829cdb829", "message": "resolve conflict", "committedDate": "2020-03-23T02:12:01Z", "type": "commit"}, {"oid": "b8b8861c9bf2837fdaa981f5c1763338e41fcd0a", "url": "https://github.com/seata/seata/commit/b8b8861c9bf2837fdaa981f5c1763338e41fcd0a", "message": "delete dead imports", "committedDate": "2020-03-23T03:39:37Z", "type": "commit"}, {"oid": "a2ec57b3a5c40124cb61542732e461595deaaf8f", "url": "https://github.com/seata/seata/commit/a2ec57b3a5c40124cb61542732e461595deaaf8f", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-03-24T02:16:11Z", "type": "commit"}, {"oid": "6683cb74e5a463e659d87c83b8f7245cfcc093c5", "url": "https://github.com/seata/seata/commit/6683cb74e5a463e659d87c83b8f7245cfcc093c5", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-03-24T14:32:30Z", "type": "commit"}, {"oid": "1f10a57cdca83a94b249dd5f124d169437f6def5", "url": "https://github.com/seata/seata/commit/1f10a57cdca83a94b249dd5f124d169437f6def5", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-03-28T13:07:39Z", "type": "commit"}, {"oid": "faa30f8c418b1778b2f7ca6541b3d55f89da695a", "url": "https://github.com/seata/seata/commit/faa30f8c418b1778b2f7ca6541b3d55f89da695a", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-03-31T09:35:51Z", "type": "commit"}, {"oid": "208ff66fb68bc889a1ccffa6f24df345d6b277ae", "url": "https://github.com/seata/seata/commit/208ff66fb68bc889a1ccffa6f24df345d6b277ae", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-01T01:36:04Z", "type": "commit"}, {"oid": "2dfaaf39e6131099350dc0a513b87e73e0d121df", "url": "https://github.com/seata/seata/commit/2dfaaf39e6131099350dc0a513b87e73e0d121df", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-01T05:50:14Z", "type": "commit"}, {"oid": "cd44dd3f55ae3edb435b9652d1be2463358429ef", "url": "https://github.com/seata/seata/commit/cd44dd3f55ae3edb435b9652d1be2463358429ef", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-02T05:28:03Z", "type": "commit"}, {"oid": "1b351f22a1689a20402aab21e9a2b2daeda43595", "url": "https://github.com/seata/seata/commit/1b351f22a1689a20402aab21e9a2b2daeda43595", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-07T02:56:23Z", "type": "commit"}, {"oid": "4a30d3482d8107c107b381c60108ec609eae9ee2", "url": "https://github.com/seata/seata/commit/4a30d3482d8107c107b381c60108ec609eae9ee2", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-08T05:21:15Z", "type": "commit"}, {"oid": "f4e7b159b47820fa0874c2495d1c1af0455c74f1", "url": "https://github.com/seata/seata/commit/f4e7b159b47820fa0874c2495d1c1af0455c74f1", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-10T03:19:29Z", "type": "commit"}, {"oid": "e77c3185070f27bcec1ddbddb63cdf82aad3f58e", "url": "https://github.com/seata/seata/commit/e77c3185070f27bcec1ddbddb63cdf82aad3f58e", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-10T09:15:39Z", "type": "commit"}, {"oid": "ba931f6d2ddfb84953b6434db0ac93c27ce8db4c", "url": "https://github.com/seata/seata/commit/ba931f6d2ddfb84953b6434db0ac93c27ce8db4c", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-15T07:49:41Z", "type": "commit"}, {"oid": "f1c74b30d7f3fab79c3cb6489d36a9a46a012f71", "url": "https://github.com/seata/seata/commit/f1c74b30d7f3fab79c3cb6489d36a9a46a012f71", "message": "optimize", "committedDate": "2020-04-15T08:02:29Z", "type": "commit"}, {"oid": "392ea5cf24fb17e92d76fe0de0b81f44c9bb1a74", "url": "https://github.com/seata/seata/commit/392ea5cf24fb17e92d76fe0de0b81f44c9bb1a74", "message": "resolve conflict", "committedDate": "2020-04-24T03:25:48Z", "type": "commit"}, {"oid": "7408eeea12802066f591e73aa0f67134baf8e960", "url": "https://github.com/seata/seata/commit/7408eeea12802066f591e73aa0f67134baf8e960", "message": "standard code", "committedDate": "2020-04-24T03:27:42Z", "type": "commit"}, {"oid": "485d57b22501465779003afbae2f8e5b8d89b54b", "url": "https://github.com/seata/seata/commit/485d57b22501465779003afbae2f8e5b8d89b54b", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-24T03:38:08Z", "type": "commit"}, {"oid": "f4d8b9c9a0369d6fbd81a9d967aade7e445a9da3", "url": "https://github.com/seata/seata/commit/f4d8b9c9a0369d6fbd81a9d967aade7e445a9da3", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-26T07:51:47Z", "type": "commit"}, {"oid": "537ac8df7e629e4645341bd148da16a0debe4a95", "url": "https://github.com/seata/seata/commit/537ac8df7e629e4645341bd148da16a0debe4a95", "message": "optimize code", "committedDate": "2020-04-29T08:13:32Z", "type": "commit"}, {"oid": "af150516446ed2bc6e888162864595bb70e3cd54", "url": "https://github.com/seata/seata/commit/af150516446ed2bc6e888162864595bb70e3cd54", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-04-29T08:20:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcyMDI3Nw==", "url": "https://github.com/seata/seata/pull/2412#discussion_r417720277", "bodyText": "Why remove the override?", "author": "l81893521", "createdAt": "2020-04-30T02:30:17Z", "path": "server/src/main/java/io/seata/server/storage/db/session/DataBaseSessionManager.java", "diffHunk": "@@ -192,17 +191,12 @@ public GlobalSession findGlobalSession(String xid, boolean withBranchSessions) {\n         return transactionStoreManager.readSession(condition);\n     }\n \n-    @Override", "originalCommit": "af150516446ed2bc6e888162864595bb70e3cd54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzczMzU0Mw==", "url": "https://github.com/seata/seata/pull/2412#discussion_r417733543", "bodyText": "thx", "author": "a364176773", "createdAt": "2020-04-30T03:29:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcyMDI3Nw=="}], "type": "inlineReview"}, {"oid": "430cf5817fa3c98dda131045b71728bcbc99cb8b", "url": "https://github.com/seata/seata/commit/430cf5817fa3c98dda131045b71728bcbc99cb8b", "message": "optimize code", "committedDate": "2020-04-30T03:53:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwOTczOA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r418409738", "bodyText": "Why let the user config data center id?", "author": "l81893521", "createdAt": "2020-05-01T04:18:01Z", "path": "server/src/main/java/io/seata/server/ParameterParser.java", "diffHunk": "@@ -47,11 +49,13 @@\n \n     private static final int SERVER_DEFAULT_PORT = 8091;\n     private static final String SERVER_DEFAULT_STORE_MODE = \"file\";\n-    private static final int SERVER_DEFAULT_NODE = 1;\n+    private static final Long SERVER_DEFAULT_NODE = ThreadLocalRandom.current().nextLong(32);\n+    private static final Long DATA_CENTER_DEFAULT_ID = ThreadLocalRandom.current().nextLong(32);", "originalCommit": "430cf5817fa3c98dda131045b71728bcbc99cb8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQxMDY1OA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r418410658", "bodyText": "Why let the user config data center id?\n\nclusters can be larger", "author": "a364176773", "createdAt": "2020-05-01T04:23:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwOTczOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQxNzM0MA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r418417340", "bodyText": "You can consider merge workderIdBits and datacenterIdBits. Actually they are same one.", "author": "l81893521", "createdAt": "2020-05-01T04:59:27Z", "path": "core/src/main/java/io/seata/core/util/IdWorker.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.util;\n+\n+/**\n+ * @author funkye\n+ */\n+public class IdWorker {\n+\n+    private volatile static IdWorker idWorker = null;\n+\n+    /**\n+     * Start time cut (2015-01-01)\n+     */\n+    private final long twepoch = 1546272000000L;\n+\n+    /**\n+     * The number of bits occupied by the machine id\n+     */\n+    private final long workerIdBits = 5L;", "originalCommit": "430cf5817fa3c98dda131045b71728bcbc99cb8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQxNzU4MA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r418417580", "bodyText": "ok", "author": "a364176773", "createdAt": "2020-05-01T05:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQxNzM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQxNzU2MA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r418417560", "bodyText": "And You can consider adjust the bit of each part, let it more compatible with our project.", "author": "l81893521", "createdAt": "2020-05-01T05:00:42Z", "path": "core/src/main/java/io/seata/core/util/IdWorker.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.util;\n+\n+/**\n+ * @author funkye\n+ */\n+public class IdWorker {", "originalCommit": "430cf5817fa3c98dda131045b71728bcbc99cb8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQxNzcxMQ==", "url": "https://github.com/seata/seata/pull/2412#discussion_r418417711", "bodyText": "ok", "author": "a364176773", "createdAt": "2020-05-01T05:01:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQxNzU2MA=="}], "type": "inlineReview"}, {"oid": "48a580d3d8dcc6c576c0c1781197f68ad232dbef", "url": "https://github.com/seata/seata/commit/48a580d3d8dcc6c576c0c1781197f68ad232dbef", "message": "optimize code,merge workerId and data center id", "committedDate": "2020-05-01T05:52:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA0MTY5OQ==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419041699", "bodyText": "I think here can use single param instand of arrays.", "author": "l81893521", "createdAt": "2020-05-03T03:41:32Z", "path": "core/src/main/java/io/seata/core/util/IdWorker.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.util;\n+\n+/**\n+ * @author funkye\n+ */\n+public class IdWorker {\n+\n+    private volatile static IdWorker idWorker = null;\n+\n+    /**\n+     * Start time cut (2015-01-01)\n+     */\n+    private final long twepoch = 1546272000000L;\n+\n+    /**\n+     * The number of bits occupied by the machine id\n+     */\n+    private final long workerIdBits = 10L;\n+\n+    /**\n+     * Maximum supported machine id, the result is 1023 (this shift algorithm can quickly calculate the largest decimal\n+     * number that can be represented by a few binary numbers)\n+     */\n+    private final long maxWorkerId = -1L ^ (-1L << workerIdBits);\n+\n+    /**\n+     * The number of bits the sequence occupies in id\n+     */\n+    private final long sequenceBits = 12L;\n+\n+    /**\n+     * Machine ID left 12 digits\n+     */\n+    private final long workerIdShift = sequenceBits;\n+\n+    /**\n+     * Time truncated to the left by 22 bits (10 + 12)\n+     */\n+    private final long timestampLeftShift = sequenceBits + workerIdBits;\n+\n+    /**\n+     * Generate sequence mask\n+     */\n+    private final long sequenceMask = -1L ^ (-1L << sequenceBits);\n+\n+    /**\n+     * Machine ID (0 ~ 1023)\n+     */\n+    private long workerId;\n+\n+    /**\n+     * Sequence in milliseconds (0 ~ 4095)\n+     */\n+    private long sequence = 0L;\n+\n+    /**\n+     * Time of last ID generation\n+     */\n+    private long lastTimestamp = -1L;\n+\n+    /**\n+     * Constructor\n+     *\n+     * @param workerId\n+     *            Job ID (0 ~ 1023)\n+     */\n+    public IdWorker(long workerId) {\n+        if (workerId > maxWorkerId || workerId < 0) {\n+            throw new IllegalArgumentException(\n+                String.format(\"worker Id can't be greater than %d or less than 0\", maxWorkerId));\n+        }\n+        this.workerId = workerId;\n+    }\n+\n+    /**\n+     * Get the next ID (the method is thread-safe)\n+     *\n+     * @return SnowflakeId\n+     */\n+    public synchronized long nextId() {\n+        long timestamp = timeGen();\n+\n+        if (timestamp < lastTimestamp) {\n+            throw new RuntimeException(String.format(\n+                \"Clock moved backwards.  Refusing to generate id for %d milliseconds\", lastTimestamp - timestamp));\n+        }\n+\n+        if (lastTimestamp == timestamp) {\n+            sequence = (sequence + 1) & sequenceMask;\n+            if (sequence == 0) {\n+                timestamp = tilNextMillis(lastTimestamp);\n+            }\n+        } else {\n+            sequence = 0L;\n+        }\n+\n+        lastTimestamp = timestamp;\n+        return ((timestamp - twepoch) << timestampLeftShift) | (workerId << workerIdShift) | sequence;\n+    }\n+\n+    /**\n+     * Block until the next millisecond until a new timestamp is obtained\n+     *\n+     * @param lastTimestamp\n+     *            Time of last ID generation\n+     * @return Current timestamp\n+     */\n+    protected long tilNextMillis(long lastTimestamp) {\n+        long timestamp = timeGen();\n+        while (timestamp <= lastTimestamp) {\n+            timestamp = timeGen();\n+        }\n+        return timestamp;\n+    }\n+\n+    /**\n+     * Returns the current time in milliseconds\n+     *\n+     * @return Current time (ms)\n+     */\n+    protected long timeGen() {\n+        return System.currentTimeMillis();\n+    }\n+\n+    public static IdWorker getInstance(Long... ids) {", "originalCommit": "48a580d3d8dcc6c576c0c1781197f68ad232dbef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA0NzQxOA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419047418", "bodyText": "ok", "author": "a364176773", "createdAt": "2020-05-03T04:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA0MTY5OQ=="}], "type": "inlineReview"}, {"oid": "0283ebff48fa3f0a0e358e896d7cf63a30a24d5f", "url": "https://github.com/seata/seata/commit/0283ebff48fa3f0a0e358e896d7cf63a30a24d5f", "message": "optimize code", "committedDate": "2020-05-03T04:32:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA0NjAyMw==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419046023", "bodyText": "How about change to Idworker.init(parameterParser.getServerNode())", "author": "l81893521", "createdAt": "2020-05-03T04:37:57Z", "path": "server/src/main/java/io/seata/server/Server.java", "diffHunk": "@@ -80,7 +80,8 @@ public static void main(String[] args) throws IOException {\n         // register ShutdownHook\n         ShutdownHook.getInstance().addDisposable(coordinator);\n         ShutdownHook.getInstance().addDisposable(rpcServer);\n-\n+        //IdWorker Instantiate by service node\n+        IdWorker.getInstance(parameterParser.getServerNode());", "originalCommit": "0283ebff48fa3f0a0e358e896d7cf63a30a24d5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA0NzY5NA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419047694", "bodyText": "PTAL @l81893521", "author": "a364176773", "createdAt": "2020-05-03T04:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA0NjAyMw=="}], "type": "inlineReview"}, {"oid": "59a0492466704fcc0cf22d8bb93989d985028da6", "url": "https://github.com/seata/seata/commit/59a0492466704fcc0cf22d8bb93989d985028da6", "message": "optimize code", "committedDate": "2020-05-03T04:55:02Z", "type": "commit"}, {"oid": "b52a5401d6f2f5dba950c5fe02a0945a94855da1", "url": "https://github.com/seata/seata/commit/b52a5401d6f2f5dba950c5fe02a0945a94855da1", "message": "optimize code", "committedDate": "2020-05-03T04:56:45Z", "type": "commit"}, {"oid": "3004fa4ca16747950b708be5ffe6ab795deff54b", "url": "https://github.com/seata/seata/commit/3004fa4ca16747950b708be5ffe6ab795deff54b", "message": "Merge branch 'develop' into xid_optimize", "committedDate": "2020-05-03T05:07:57Z", "type": "commit"}, {"oid": "b0bca9b80ccf00183482b53a9683392872d50eb0", "url": "https://github.com/seata/seata/commit/b0bca9b80ccf00183482b53a9683392872d50eb0", "message": "optimize code", "committedDate": "2020-05-03T06:03:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEwMTM4OQ==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419101389", "bodyText": "reduce lock area", "author": "zjinlei", "createdAt": "2020-05-03T13:09:09Z", "path": "core/src/main/java/io/seata/core/util/IdWorker.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.util;\n+\n+/**\n+ * @author funkye\n+ */\n+public class IdWorker {\n+\n+    private volatile static IdWorker idWorker = null;\n+\n+    /**\n+     * Start time cut (2020-05-03)\n+     */\n+    private final long twepoch = 1588435200000L;\n+\n+    /**\n+     * The number of bits occupied by the machine id\n+     */\n+    private final long workerIdBits = 10L;\n+\n+    /**\n+     * Maximum supported machine id, the result is 1023 (this shift algorithm can quickly calculate the largest decimal\n+     * number that can be represented by a few binary numbers)\n+     */\n+    private final long maxWorkerId = -1L ^ (-1L << workerIdBits);\n+\n+    /**\n+     * The number of bits the sequence occupies in id\n+     */\n+    private final long sequenceBits = 12L;\n+\n+    /**\n+     * Machine ID left 12 digits\n+     */\n+    private final long workerIdShift = sequenceBits;\n+\n+    /**\n+     * Time truncated to the left by 22 bits (10 + 12)\n+     */\n+    private final long timestampLeftShift = sequenceBits + workerIdBits;\n+\n+    /**\n+     * Generate sequence mask\n+     */\n+    private final long sequenceMask = -1L ^ (-1L << sequenceBits);\n+\n+    /**\n+     * Machine ID (0 ~ 1023)\n+     */\n+    private long workerId;\n+\n+    /**\n+     * Sequence in milliseconds (0 ~ 4095)\n+     */\n+    private long sequence = 0L;\n+\n+    /**\n+     * Time of last ID generation\n+     */\n+    private long lastTimestamp = -1L;\n+\n+    /**\n+     * Constructor\n+     *\n+     * @param workerId\n+     *            Job ID (0 ~ 1023)\n+     */\n+    public IdWorker(long workerId) {\n+        if (workerId > maxWorkerId || workerId < 0) {\n+            throw new IllegalArgumentException(\n+                String.format(\"worker Id can't be greater than %d or less than 0\", maxWorkerId));\n+        }\n+        this.workerId = workerId;\n+    }\n+\n+    /**\n+     * Get the next ID (the method is thread-safe)\n+     *\n+     * @return SnowflakeId\n+     */\n+    public synchronized long nextId() {", "originalCommit": "b0bca9b80ccf00183482b53a9683392872d50eb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTExMzQ1OA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419113458", "bodyText": "ok", "author": "a364176773", "createdAt": "2020-05-03T14:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEwMTM4OQ=="}], "type": "inlineReview"}, {"oid": "38de75d30e2df607781ec7bda7cebd5e64223fe1", "url": "https://github.com/seata/seata/commit/38de75d30e2df607781ec7bda7cebd5e64223fe1", "message": "optimize code", "committedDate": "2020-05-03T14:48:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTExNjA2Mg==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419116062", "bodyText": "There is no thread safety problem in the return line", "author": "zjinlei", "createdAt": "2020-05-03T15:04:32Z", "path": "core/src/main/java/io/seata/core/util/IdWorker.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.util;\n+\n+/**\n+ * @author funkye\n+ */\n+public class IdWorker {\n+\n+    private volatile static IdWorker idWorker = null;\n+\n+    /**\n+     * Start time cut (2020-05-03)\n+     */\n+    private final long twepoch = 1588435200000L;\n+\n+    /**\n+     * The number of bits occupied by the machine id\n+     */\n+    private final long workerIdBits = 10L;\n+\n+    /**\n+     * Maximum supported machine id, the result is 1023 (this shift algorithm can quickly calculate the largest decimal\n+     * number that can be represented by a few binary numbers)\n+     */\n+    private final long maxWorkerId = -1L ^ (-1L << workerIdBits);\n+\n+    /**\n+     * The number of bits the sequence occupies in id\n+     */\n+    private final long sequenceBits = 12L;\n+\n+    /**\n+     * Machine ID left 12 digits\n+     */\n+    private final long workerIdShift = sequenceBits;\n+\n+    /**\n+     * Time truncated to the left by 22 bits (10 + 12)\n+     */\n+    private final long timestampLeftShift = sequenceBits + workerIdBits;\n+\n+    /**\n+     * Generate sequence mask\n+     */\n+    private final long sequenceMask = -1L ^ (-1L << sequenceBits);\n+\n+    /**\n+     * Machine ID (0 ~ 1023)\n+     */\n+    private long workerId;\n+\n+    /**\n+     * Sequence in milliseconds (0 ~ 4095)\n+     */\n+    private long sequence = 0L;\n+\n+    /**\n+     * Time of last ID generation\n+     */\n+    private long lastTimestamp = -1L;\n+\n+    /**\n+     * Constructor\n+     *\n+     * @param workerId\n+     *            Job ID (0 ~ 1023)\n+     */\n+    public IdWorker(long workerId) {\n+        if (workerId > maxWorkerId || workerId < 0) {\n+            throw new IllegalArgumentException(\n+                String.format(\"worker Id can't be greater than %d or less than 0\", maxWorkerId));\n+        }\n+        this.workerId = workerId;\n+    }\n+\n+    /**\n+     * Get the next ID (the method is thread-safe)\n+     *\n+     * @return SnowflakeId\n+     */\n+    public long nextId() {\n+        long timestamp = timeGen();\n+\n+        if (timestamp < lastTimestamp) {\n+            throw new RuntimeException(String.format(\n+                \"clock moved backwards.  Refusing to generate id for %d milliseconds\", lastTimestamp - timestamp));\n+        }\n+\n+        synchronized (this) {\n+            if (lastTimestamp == timestamp) {\n+                sequence = (sequence + 1) & sequenceMask;\n+                if (sequence == 0) {\n+                    timestamp = tilNextMillis(lastTimestamp);\n+                }\n+            } else {\n+                sequence = 0L;\n+            }\n+\n+            lastTimestamp = timestamp;\n+            return ((timestamp - twepoch) << timestampLeftShift) | (workerId << workerIdShift) | sequence;", "originalCommit": "38de75d30e2df607781ec7bda7cebd5e64223fe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTExNjIwNA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419116204", "bodyText": "ok", "author": "a364176773", "createdAt": "2020-05-03T15:05:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTExNjA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTExODA2Mg==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419118062", "bodyText": "use UUIDGenerator init, shield specific implementation.", "author": "zjinlei", "createdAt": "2020-05-03T15:19:40Z", "path": "server/src/main/java/io/seata/server/Server.java", "diffHunk": "@@ -80,7 +80,8 @@ public static void main(String[] args) throws IOException {\n         // register ShutdownHook\n         ShutdownHook.getInstance().addDisposable(coordinator);\n         ShutdownHook.getInstance().addDisposable(rpcServer);\n-\n+        //IdWorker Instantiate by service node\n+        IdWorker.init(parameterParser.getServerNode());", "originalCommit": "38de75d30e2df607781ec7bda7cebd5e64223fe1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTExODE1OA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419118158", "bodyText": "remove final", "author": "zjinlei", "createdAt": "2020-05-03T15:20:29Z", "path": "common/src/main/java/io/seata/common/util/NumberUtils.java", "diffHunk": "@@ -42,4 +42,15 @@ public static int toInt(final String str, final int defaultValue) {\n             return defaultValue;\n         }\n     }\n+\n+    public static Long toLong(String str, final Long defaultValue) {\n+        if (str == null) {\n+            return defaultValue;\n+        }\n+        try {\n+            return Long.valueOf(str);\n+        } catch (final NumberFormatException nfe) {", "originalCommit": "38de75d30e2df607781ec7bda7cebd5e64223fe1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "24b50718319badbe05ee36339266794a9b4f25ef", "url": "https://github.com/seata/seata/commit/24b50718319badbe05ee36339266794a9b4f25ef", "message": "optimize code", "committedDate": "2020-05-03T15:32:28Z", "type": "commit"}, {"oid": "c1c4ae390bbff57cdd25e985cd372d68f8296f88", "url": "https://github.com/seata/seata/commit/c1c4ae390bbff57cdd25e985cd372d68f8296f88", "message": "rollback code", "committedDate": "2020-05-03T15:42:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyMTY2Mg==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419121662", "bodyText": "unnecessary", "author": "zjinlei", "createdAt": "2020-05-03T15:49:04Z", "path": "server/src/main/java/io/seata/server/UUIDGenerator.java", "diffHunk": "@@ -32,89 +24,23 @@\n  */\n public class UUIDGenerator {\n \n-    private static final AtomicLong UUID = new AtomicLong(1000);\n-    private static int serverNodeId = 1;\n-    private static final long UUID_INTERNAL = 2000000000;\n-    private static long initUUID = 0;\n+    private static IdWorker idWorker;\n \n     /**\n      * Generate uuid long.\n      *\n      * @return the long\n      */\n     public static long generateUUID() {\n-        long id = UUID.incrementAndGet();\n-        if (id >= getMaxUUID()) {\n-            synchronized (UUID) {\n-                if (UUID.get() >= id) {\n-                    id -= UUID_INTERNAL;\n-                    UUID.set(id);\n-                }\n-            }\n-        }\n-        return id;\n-    }\n-\n-    /**\n-     * Gets current uuid.\n-     *\n-     * @return the current uuid\n-     */\n-    public static long getCurrentUUID() {\n-        return UUID.get();\n-    }\n-\n-    /**\n-     * Sets uuid.\n-     *\n-     * @param expect the expect\n-     * @param update the update\n-     * @return the uuid\n-     */\n-    public static boolean setUUID(long expect, long update) {\n-        return UUID.compareAndSet(expect, update);\n-\n+        return idWorker.nextId();\n     }\n-\n     /**\n-     * Gets max uuid.\n+     * IdWorker Instantiate by service node\n      *\n-     * @return the max uuid\n      */\n-    public static long getMaxUUID() {\n-        return UUID_INTERNAL * (serverNodeId + 1);\n+    public static void init(Long serverNode) {\n+        IdWorker.init(serverNode);\n+        idWorker = IdWorker.getInstance();", "originalCommit": "c1c4ae390bbff57cdd25e985cd372d68f8296f88", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyMjAxOQ==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419122019", "bodyText": "my mistake", "author": "zjinlei", "createdAt": "2020-05-03T15:51:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyMTY2Mg=="}], "type": "inlineReview"}, {"oid": "fa14f59cb769e5579c775655270fd4d651b2806b", "url": "https://github.com/seata/seata/commit/fa14f59cb769e5579c775655270fd4d651b2806b", "message": "optimize code", "committedDate": "2020-05-03T15:50:38Z", "type": "commit"}, {"oid": "712adcd4a212e301be9a405b7558ed0c8bdb3705", "url": "https://github.com/seata/seata/commit/712adcd4a212e301be9a405b7558ed0c8bdb3705", "message": "rollback code", "committedDate": "2020-05-03T15:55:01Z", "type": "commit"}, {"oid": "32751a1fbf4dec3a1937efe01d4633140504c27f", "url": "https://github.com/seata/seata/commit/32751a1fbf4dec3a1937efe01d4633140504c27f", "message": "rollback code", "committedDate": "2020-05-03T15:57:23Z", "type": "commit"}, {"oid": "8a68bf0cf61104e0629dec00d8f1ecc51a7af368", "url": "https://github.com/seata/seata/commit/8a68bf0cf61104e0629dec00d8f1ecc51a7af368", "message": "optimize code", "committedDate": "2020-05-03T16:12:27Z", "type": "commit"}, {"oid": "2ab22642d4094605fe7b8583ceaaf212cf34eec3", "url": "https://github.com/seata/seata/commit/2ab22642d4094605fe7b8583ceaaf212cf34eec3", "message": "optimize code", "committedDate": "2020-05-03T16:36:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MDIwOA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419190208", "bodyText": "Why 1L instead of random\uff1f", "author": "slievrly", "createdAt": "2020-05-04T02:04:19Z", "path": "core/src/main/java/io/seata/core/util/IdWorker.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.util;\n+\n+/**\n+ * @author funkye\n+ */\n+public class IdWorker {\n+\n+    private volatile static IdWorker idWorker = null;\n+\n+    /**\n+     * Start time cut (2020-05-03)\n+     */\n+    private final long twepoch = 1588435200000L;\n+\n+    /**\n+     * The number of bits occupied by the machine id\n+     */\n+    private final long workerIdBits = 10L;\n+\n+    /**\n+     * Maximum supported machine id, the result is 1023 (this shift algorithm can quickly calculate the largest decimal\n+     * number that can be represented by a few binary numbers)\n+     */\n+    private final long maxWorkerId = -1L ^ (-1L << workerIdBits);\n+\n+    /**\n+     * The number of bits the sequence occupies in id\n+     */\n+    private final long sequenceBits = 12L;\n+\n+    /**\n+     * Machine ID left 12 digits\n+     */\n+    private final long workerIdShift = sequenceBits;\n+\n+    /**\n+     * Time truncated to the left by 22 bits (10 + 12)\n+     */\n+    private final long timestampLeftShift = sequenceBits + workerIdBits;\n+\n+    /**\n+     * Generate sequence mask\n+     */\n+    private final long sequenceMask = -1L ^ (-1L << sequenceBits);\n+\n+    /**\n+     * Machine ID (0 ~ 1023)\n+     */\n+    private long workerId;\n+\n+    /**\n+     * Sequence in milliseconds (0 ~ 4095)\n+     */\n+    private long sequence = 0L;\n+\n+    /**\n+     * Time of last ID generation\n+     */\n+    private long lastTimestamp = -1L;\n+\n+    /**\n+     * Constructor\n+     *\n+     * @param workerId\n+     *            Job ID (0 ~ 1023)\n+     */\n+    public IdWorker(long workerId) {\n+        if (workerId > maxWorkerId || workerId < 0) {\n+            throw new IllegalArgumentException(\n+                String.format(\"worker Id can't be greater than %d or less than 0\", maxWorkerId));\n+        }\n+        this.workerId = workerId;\n+    }\n+\n+    /**\n+     * Get the next ID (the method is thread-safe)\n+     *\n+     * @return SnowflakeId\n+     */\n+    public long nextId() {\n+        long timestamp = timeGen();\n+\n+        if (timestamp < lastTimestamp) {\n+            throw new RuntimeException(String.format(\n+                \"clock moved backwards.  Refusing to generate id for %d milliseconds\", lastTimestamp - timestamp));\n+        }\n+\n+        synchronized (this) {\n+            if (lastTimestamp == timestamp) {\n+                sequence = (sequence + 1) & sequenceMask;\n+                if (sequence == 0) {\n+                    timestamp = tilNextMillis(lastTimestamp);\n+                }\n+            } else {\n+                sequence = 0L;\n+            }\n+            lastTimestamp = timestamp;\n+        }\n+        return ((timestamp - twepoch) << timestampLeftShift) | (workerId << workerIdShift) | sequence;\n+    }\n+\n+    /**\n+     * Block until the next millisecond until a new timestamp is obtained\n+     *\n+     * @param lastTimestamp\n+     *            Time of last ID generation\n+     * @return Current timestamp\n+     */\n+    protected long tilNextMillis(long lastTimestamp) {\n+        long timestamp = timeGen();\n+        while (timestamp <= lastTimestamp) {\n+            timestamp = timeGen();\n+        }\n+        return timestamp;\n+    }\n+\n+    /**\n+     * Returns the current time in milliseconds\n+     *\n+     * @return Current time (ms)\n+     */\n+    protected long timeGen() {\n+        return System.currentTimeMillis();\n+    }\n+\n+    public static IdWorker getInstance() {\n+        if (idWorker == null) {\n+            synchronized (IdWorker.class) {\n+                if (idWorker == null) {\n+                    init(1L);", "originalCommit": "2ab22642d4094605fe7b8583ceaaf212cf34eec3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NDM4NQ==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419194385", "bodyText": "ok", "author": "a364176773", "createdAt": "2020-05-04T02:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MDIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MjE2OQ==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419192169", "bodyText": "need some output shows that the sequence is not enough to use?", "author": "slievrly", "createdAt": "2020-05-04T02:21:17Z", "path": "core/src/main/java/io/seata/core/util/IdWorker.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.util;\n+\n+/**\n+ * @author funkye\n+ */\n+public class IdWorker {\n+\n+    private volatile static IdWorker idWorker = null;\n+\n+    /**\n+     * Start time cut (2020-05-03)\n+     */\n+    private final long twepoch = 1588435200000L;\n+\n+    /**\n+     * The number of bits occupied by the machine id\n+     */\n+    private final long workerIdBits = 10L;\n+\n+    /**\n+     * Maximum supported machine id, the result is 1023 (this shift algorithm can quickly calculate the largest decimal\n+     * number that can be represented by a few binary numbers)\n+     */\n+    private final long maxWorkerId = -1L ^ (-1L << workerIdBits);\n+\n+    /**\n+     * The number of bits the sequence occupies in id\n+     */\n+    private final long sequenceBits = 12L;\n+\n+    /**\n+     * Machine ID left 12 digits\n+     */\n+    private final long workerIdShift = sequenceBits;\n+\n+    /**\n+     * Time truncated to the left by 22 bits (10 + 12)\n+     */\n+    private final long timestampLeftShift = sequenceBits + workerIdBits;\n+\n+    /**\n+     * Generate sequence mask\n+     */\n+    private final long sequenceMask = -1L ^ (-1L << sequenceBits);\n+\n+    /**\n+     * Machine ID (0 ~ 1023)\n+     */\n+    private long workerId;\n+\n+    /**\n+     * Sequence in milliseconds (0 ~ 4095)\n+     */\n+    private long sequence = 0L;\n+\n+    /**\n+     * Time of last ID generation\n+     */\n+    private long lastTimestamp = -1L;\n+\n+    /**\n+     * Constructor\n+     *\n+     * @param workerId\n+     *            Job ID (0 ~ 1023)\n+     */\n+    public IdWorker(long workerId) {\n+        if (workerId > maxWorkerId || workerId < 0) {\n+            throw new IllegalArgumentException(\n+                String.format(\"worker Id can't be greater than %d or less than 0\", maxWorkerId));\n+        }\n+        this.workerId = workerId;\n+    }\n+\n+    /**\n+     * Get the next ID (the method is thread-safe)\n+     *\n+     * @return SnowflakeId\n+     */\n+    public long nextId() {\n+        long timestamp = timeGen();\n+\n+        if (timestamp < lastTimestamp) {\n+            throw new RuntimeException(String.format(\n+                \"clock moved backwards.  Refusing to generate id for %d milliseconds\", lastTimestamp - timestamp));\n+        }\n+\n+        synchronized (this) {\n+            if (lastTimestamp == timestamp) {\n+                sequence = (sequence + 1) & sequenceMask;\n+                if (sequence == 0) {\n+                    timestamp = tilNextMillis(lastTimestamp);", "originalCommit": "2ab22642d4094605fe7b8583ceaaf212cf34eec3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NDA5OA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419194098", "bodyText": "How do you ensure order when timestamp-twepoch is greater than 2^22?", "author": "slievrly", "createdAt": "2020-05-04T02:35:18Z", "path": "core/src/main/java/io/seata/core/util/IdWorker.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.util;\n+\n+/**\n+ * @author funkye\n+ */\n+public class IdWorker {\n+\n+    private volatile static IdWorker idWorker = null;\n+\n+    /**\n+     * Start time cut (2020-05-03)\n+     */\n+    private final long twepoch = 1588435200000L;\n+\n+    /**\n+     * The number of bits occupied by the machine id\n+     */\n+    private final long workerIdBits = 10L;\n+\n+    /**\n+     * Maximum supported machine id, the result is 1023 (this shift algorithm can quickly calculate the largest decimal\n+     * number that can be represented by a few binary numbers)\n+     */\n+    private final long maxWorkerId = -1L ^ (-1L << workerIdBits);\n+\n+    /**\n+     * The number of bits the sequence occupies in id\n+     */\n+    private final long sequenceBits = 12L;\n+\n+    /**\n+     * Machine ID left 12 digits\n+     */\n+    private final long workerIdShift = sequenceBits;\n+\n+    /**\n+     * Time truncated to the left by 22 bits (10 + 12)\n+     */\n+    private final long timestampLeftShift = sequenceBits + workerIdBits;\n+\n+    /**\n+     * Generate sequence mask\n+     */\n+    private final long sequenceMask = -1L ^ (-1L << sequenceBits);\n+\n+    /**\n+     * Machine ID (0 ~ 1023)\n+     */\n+    private long workerId;\n+\n+    /**\n+     * Sequence in milliseconds (0 ~ 4095)\n+     */\n+    private long sequence = 0L;\n+\n+    /**\n+     * Time of last ID generation\n+     */\n+    private long lastTimestamp = -1L;\n+\n+    /**\n+     * Constructor\n+     *\n+     * @param workerId\n+     *            Job ID (0 ~ 1023)\n+     */\n+    public IdWorker(long workerId) {\n+        if (workerId > maxWorkerId || workerId < 0) {\n+            throw new IllegalArgumentException(\n+                String.format(\"worker Id can't be greater than %d or less than 0\", maxWorkerId));\n+        }\n+        this.workerId = workerId;\n+    }\n+\n+    /**\n+     * Get the next ID (the method is thread-safe)\n+     *\n+     * @return SnowflakeId\n+     */\n+    public long nextId() {\n+        long timestamp = timeGen();\n+\n+        if (timestamp < lastTimestamp) {\n+            throw new RuntimeException(String.format(\n+                \"clock moved backwards.  Refusing to generate id for %d milliseconds\", lastTimestamp - timestamp));\n+        }\n+\n+        synchronized (this) {\n+            if (lastTimestamp == timestamp) {\n+                sequence = (sequence + 1) & sequenceMask;\n+                if (sequence == 0) {\n+                    timestamp = tilNextMillis(lastTimestamp);\n+                }\n+            } else {\n+                sequence = 0L;\n+            }\n+            lastTimestamp = timestamp;\n+        }\n+        return ((timestamp - twepoch) << timestampLeftShift) | (workerId << workerIdShift) | sequence;", "originalCommit": "2ab22642d4094605fe7b8583ceaaf212cf34eec3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NDI4NA==", "url": "https://github.com/seata/seata/pull/2412#discussion_r419194284", "bodyText": "2^42", "author": "slievrly", "createdAt": "2020-05-04T02:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NDA5OA=="}], "type": "inlineReview"}, {"oid": "b84650c5b52de604033465d5fc683bc154396c79", "url": "https://github.com/seata/seata/commit/b84650c5b52de604033465d5fc683bc154396c79", "message": "optimize code", "committedDate": "2020-05-04T03:08:22Z", "type": "commit"}]}