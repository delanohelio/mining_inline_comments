{"pr_number": 2670, "pr_title": "bugfix: fix data source initialize more times", "pr_createdAt": "2020-05-09T06:32:16Z", "pr_url": "https://github.com/seata/seata/pull/2670", "timeline": [{"oid": "3f40bb3fb005ab9e1b6668a1f1e448e3fa8ac0d1", "url": "https://github.com/seata/seata/commit/3f40bb3fb005ab9e1b6668a1f1e448e3fa8ac0d1", "message": "fix single datasource instance", "committedDate": "2020-05-09T06:29:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2MDYzOQ==", "url": "https://github.com/seata/seata/pull/2670#discussion_r422460639", "bodyText": "retain generateDataSource() ?", "author": "jsbxyyx", "createdAt": "2020-05-09T06:49:20Z", "path": "core/src/main/java/io/seata/core/store/db/DataSourceGenerator.java", "diffHunk": "@@ -25,10 +25,9 @@\n public interface DataSourceGenerator {\n \n     /**\n-     * create DataSource from config\n-     *\n+     * get the data source\n      * @return data source\n      */\n-    DataSource generateDataSource();\n+    DataSource get();", "originalCommit": "3f40bb3fb005ab9e1b6668a1f1e448e3fa8ac0d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2MTgyNw==", "url": "https://github.com/seata/seata/pull/2670#discussion_r422461827", "bodyText": "+1", "author": "zjinlei", "createdAt": "2020-05-09T07:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2MDYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2MjA2Nw==", "url": "https://github.com/seata/seata/pull/2670#discussion_r422462067", "bodyText": "but generate() already in the AbstractDataSourceGenerator.generate(), this method just only get the data source.", "author": "l81893521", "createdAt": "2020-05-09T07:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2MDYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2Mjg2MQ==", "url": "https://github.com/seata/seata/pull/2670#discussion_r422462861", "bodyText": "recommended to implement io.seata.common.executor.Initialize", "author": "zjinlei", "createdAt": "2020-05-09T07:16:15Z", "path": "core/src/main/java/io/seata/core/store/db/AbstractDataSourceGenerator.java", "diffHunk": "@@ -60,6 +65,24 @@\n \n     private static final long DEFAULT_DB_MAX_WAIT = 5000;\n \n+    /**\n+     * generate the data source\n+     */\n+    public AbstractDataSourceGenerator() {\n+        this.dataSource = this.generate();", "originalCommit": "3f40bb3fb005ab9e1b6668a1f1e448e3fa8ac0d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2Mzg3MA==", "url": "https://github.com/seata/seata/pull/2670#discussion_r422463870", "bodyText": "ok", "author": "l81893521", "createdAt": "2020-05-09T07:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2Mjg2MQ=="}], "type": "inlineReview"}, {"oid": "4844e45afa168c0c7886881f3f76339c04c008f0", "url": "https://github.com/seata/seata/commit/4844e45afa168c0c7886881f3f76339c04c008f0", "message": "implement initialize", "committedDate": "2020-05-09T07:27:48Z", "type": "commit"}, {"oid": "bfc482712f977a4092a116a0e55467d08695b9a4", "url": "https://github.com/seata/seata/commit/bfc482712f977a4092a116a0e55467d08695b9a4", "message": "Merge branch 'develop' into fix_single_datasource_instance", "committedDate": "2020-05-10T02:39:25Z", "type": "commit"}, {"oid": "faa201f8eed6923917ea60fa0e110deb232b76be", "url": "https://github.com/seata/seata/commit/faa201f8eed6923917ea60fa0e110deb232b76be", "message": "remove generator and add provider", "committedDate": "2020-05-10T06:56:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYyNDA3MQ==", "url": "https://github.com/seata/seata/pull/2670#discussion_r422624071", "bodyText": "common method, move to abstract class.", "author": "zjinlei", "createdAt": "2020-05-10T10:28:40Z", "path": "server/src/main/java/io/seata/server/store/DbcpDataSourceProvider.java", "diffHunk": "@@ -49,6 +49,11 @@ public DataSource generateDataSource() {\n         ds.setTestWhileIdle(true);\n         ds.setValidationQuery(getValidationQuery(getDBType()));\n         ds.setConnectionProperties(\"useUnicode=yes;characterEncoding=utf8;socketTimeout=5000;connectTimeout=500\");\n-        return ds;\n+        setDataSource(ds);\n+    }\n+\n+    @Override\n+    public DataSource provide() {\n+        return getDataSource();", "originalCommit": "faa201f8eed6923917ea60fa0e110deb232b76be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQyMDE1Mg==", "url": "https://github.com/seata/seata/pull/2670#discussion_r423420152", "bodyText": "fixed.", "author": "l81893521", "createdAt": "2020-05-12T02:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYyNDA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1Njk4Ng==", "url": "https://github.com/seata/seata/pull/2670#discussion_r423056986", "bodyText": "You can put the test case in the abstract class", "author": "slievrly", "createdAt": "2020-05-11T13:55:00Z", "path": "server/src/test/java/io/seata/server/store/db/DbcpDataSourceProviderTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.server.store.db;\n+\n+import io.seata.common.loader.EnhancedServiceLoader;\n+import io.seata.core.store.db.DataSourceProvider;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+import javax.sql.DataSource;\n+\n+/**\n+ * @author will\n+ */\n+public class DbcpDataSourceProviderTest {\n+\n+    private final String datasourceType = \"dbcp\";\n+\n+    @Test\n+    public void testDbcpDataSourceProvider() {", "originalCommit": "faa201f8eed6923917ea60fa0e110deb232b76be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQyMDE4MA==", "url": "https://github.com/seata/seata/pull/2670#discussion_r423420180", "bodyText": "fixed.", "author": "l81893521", "createdAt": "2020-05-12T02:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1Njk4Ng=="}], "type": "inlineReview"}, {"oid": "3bc76da9fac5d21328b228b75b610c8f0ea3fa0f", "url": "https://github.com/seata/seata/commit/3bc76da9fac5d21328b228b75b610c8f0ea3fa0f", "message": "Merge branch 'develop' into fix_single_datasource_instance", "committedDate": "2020-05-12T01:37:38Z", "type": "commit"}, {"oid": "ac9789b148595e06ffc083b4721b08294c7dafd5", "url": "https://github.com/seata/seata/commit/ac9789b148595e06ffc083b4721b08294c7dafd5", "message": "move provide() to abstractDatasourceProvider", "committedDate": "2020-05-12T01:59:20Z", "type": "commit"}, {"oid": "727cef9d293dbf5ef3b53464afac678bdb702cfe", "url": "https://github.com/seata/seata/commit/727cef9d293dbf5ef3b53464afac678bdb702cfe", "message": "add abstract data source provider and remove dbcp, druid, hikari test", "committedDate": "2020-05-12T02:03:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NDI0NQ==", "url": "https://github.com/seata/seata/pull/2670#discussion_r423474245", "bodyText": "merge dataSourceType to array. for each test dataSource not null? simplify test case?", "author": "jsbxyyx", "createdAt": "2020-05-12T05:42:55Z", "path": "server/src/test/java/io/seata/server/store/db/AbstractDataSourceProviderTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.server.store.db;\n+\n+import io.seata.common.loader.EnhancedServiceLoader;\n+import io.seata.core.store.db.DataSourceProvider;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+import javax.sql.DataSource;\n+\n+/**\n+ * @author: will\n+ */\n+public class AbstractDataSourceProviderTest {\n+\n+    private final String dbcpDatasourceType = \"dbcp\";", "originalCommit": "727cef9d293dbf5ef3b53464afac678bdb702cfe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3fb19a6cee70feee2dcd40880f72a302a103df6d", "url": "https://github.com/seata/seata/commit/3fb19a6cee70feee2dcd40880f72a302a103df6d", "message": "add author name and remove unused import", "committedDate": "2020-05-12T06:09:22Z", "type": "commit"}, {"oid": "c4a35567692e041851bdd91ce236e741f17beb0f", "url": "https://github.com/seata/seata/commit/c4a35567692e041851bdd91ce236e741f17beb0f", "message": "change init to generate.", "committedDate": "2020-05-12T06:20:41Z", "type": "commit"}, {"oid": "92e8fbecd30c1e08a50419e621171cbd8f004938", "url": "https://github.com/seata/seata/commit/92e8fbecd30c1e08a50419e621171cbd8f004938", "message": "indentation 4", "committedDate": "2020-05-12T06:38:29Z", "type": "commit"}, {"oid": "5fb9d641b95995766679daa1a2620c705a4317b3", "url": "https://github.com/seata/seata/commit/5fb9d641b95995766679daa1a2620c705a4317b3", "message": "Merge branch 'develop' into fix_single_datasource_instance", "committedDate": "2020-05-12T06:39:45Z", "type": "commit"}]}