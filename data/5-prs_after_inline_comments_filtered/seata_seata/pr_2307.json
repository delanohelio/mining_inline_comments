{"pr_number": 2307, "pr_title": "optimize: optimize transaction context switch logic when transaction mode switching", "pr_createdAt": "2020-02-26T15:27:20Z", "pr_url": "https://github.com/seata/seata/pull/2307", "timeline": [{"oid": "92a1e4b400b4e5a52530e8965599f7928c8e32d3", "url": "https://github.com/seata/seata/commit/92a1e4b400b4e5a52530e8965599f7928c8e32d3", "message": "optimize: optimize transaction context behavior when transaction mode is switched", "committedDate": "2020-02-26T15:23:14Z", "type": "commit"}, {"oid": "7829ce7022660f47357d2e10aab4b80b2c1a9fff", "url": "https://github.com/seata/seata/commit/7829ce7022660f47357d2e10aab4b80b2c1a9fff", "message": "adjust BranchType switching with Propagation feature", "committedDate": "2020-02-29T03:38:54Z", "type": "commit"}, {"oid": "f4e407885ef5496cc26bca0a3a2df083efc37c12", "url": "https://github.com/seata/seata/commit/f4e407885ef5496cc26bca0a3a2df083efc37c12", "message": "Merge remote-tracking branch 'upstream/develop' into f_tcc", "committedDate": "2020-03-02T02:17:52Z", "type": "commit"}, {"oid": "ef1ea3cb4db95c87aa787f48720bb8cc1c12f5ae", "url": "https://github.com/seata/seata/commit/ef1ea3cb4db95c87aa787f48720bb8cc1c12f5ae", "message": "format code style", "committedDate": "2020-03-02T03:18:06Z", "type": "commit"}, {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509", "url": "https://github.com/seata/seata/commit/65312ddb69e103cea2552d6ea6ee3893bf31e509", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-05T01:46:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTczMA==", "url": "https://github.com/seata/seata/pull/2307#discussion_r388909730", "bodyText": "Thoughtful point", "author": "zjinlei", "createdAt": "2020-03-06T13:45:07Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -108,4 +109,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresUndoFunction() {\n+\n+        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+            return false;\n+        }\n+\n+        if (RootContext.inGlobalTransaction() && !RootContext.getBranchType().equals(String.valueOf(BranchType.AT.ordinal()))) {", "originalCommit": "65312ddb69e103cea2552d6ea6ee3893bf31e509", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTc3Mw==", "url": "https://github.com/seata/seata/pull/2307#discussion_r388909773", "bodyText": "SAGA", "author": "zjinlei", "createdAt": "2020-03-06T13:45:14Z", "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "diffHunk": "@@ -116,6 +117,7 @@ protected void beginTransaction(StateMachineInstance machineInstance, ProcessCon\n             TransactionInfo transactionInfo = new TransactionInfo();\n             transactionInfo.setTimeOut(stateMachineConfig.getTransOperationTimeout());\n             transactionInfo.setName(machineInstance.getStateMachine().getName());\n+            transactionInfo.setDefaultBranchType(BranchType.AT);", "originalCommit": "65312ddb69e103cea2552d6ea6ee3893bf31e509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1MDQzMg==", "url": "https://github.com/seata/seata/pull/2307#discussion_r388950432", "bodyText": "Sega default branch type is at ?", "author": "q294881866", "createdAt": "2020-03-06T14:57:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMzkwNg==", "url": "https://github.com/seata/seata/pull/2307#discussion_r389203906", "bodyText": "Sega default branch type is at ?\n\nMy fault", "author": "booogu", "createdAt": "2020-03-07T00:25:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNzA1OA==", "url": "https://github.com/seata/seata/pull/2307#discussion_r389207058", "bodyText": "SAGA\n\nchanged", "author": "booogu", "createdAt": "2020-03-07T00:43:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxMDE2Mw==", "url": "https://github.com/seata/seata/pull/2307#discussion_r388910163", "bodyText": "defaultBranchType->branchType", "author": "zjinlei", "createdAt": "2020-03-06T13:45:59Z", "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactional.java", "diffHunk": "@@ -75,4 +76,10 @@\n      * @return\n      */\n     Propagation propagation() default Propagation.REQUIRED;\n-}\n+\n+    /**\n+     * default branch type\n+     * @return\n+     */\n+    BranchType defaultBranchType() default BranchType.AT;", "originalCommit": "65312ddb69e103cea2552d6ea6ee3893bf31e509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNzAyOA==", "url": "https://github.com/seata/seata/pull/2307#discussion_r389207028", "bodyText": "changed", "author": "booogu", "createdAt": "2020-03-07T00:43:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxMDE2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxMTEyMg==", "url": "https://github.com/seata/seata/pull/2307#discussion_r388911122", "bodyText": "defaultBranchType-> branchType", "author": "zjinlei", "createdAt": "2020-03-06T13:47:56Z", "path": "tm/src/main/java/io/seata/tm/api/transaction/TransactionInfo.java", "diffHunk": "@@ -35,6 +36,8 @@\n \n     private Propagation propagation;\n \n+    private BranchType defaultBranchType;", "originalCommit": "65312ddb69e103cea2552d6ea6ee3893bf31e509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNzAwNQ==", "url": "https://github.com/seata/seata/pull/2307#discussion_r389207005", "bodyText": "changed", "author": "booogu", "createdAt": "2020-03-07T00:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxMTEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyMDIwMQ==", "url": "https://github.com/seata/seata/pull/2307#discussion_r388920201", "bodyText": "if xid not empty, need to deal with previousBranchType", "author": "zjinlei", "createdAt": "2020-03-06T14:05:55Z", "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -53,20 +54,24 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n         }\n         Propagation propagation = txInfo.getPropagation();\n         String previousXid = null;\n+        String previousBranchType = null;\n         try {\n             switch (propagation) {\n                 case NOT_SUPPORTED:\n                     previousXid = RootContext.unbind();\n                     return business.execute();\n                 case REQUIRES_NEW:\n                     previousXid = RootContext.unbind();\n+                    previousBranchType = RootContext.unbindBranchType();\n                     break;\n                 case SUPPORTS:\n                     if (StringUtils.isEmpty(RootContext.getXID())) {\n                         return business.execute();\n                     }\n                     break;", "originalCommit": "65312ddb69e103cea2552d6ea6ee3893bf31e509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNjYxMw==", "url": "https://github.com/seata/seata/pull/2307#discussion_r389206613", "bodyText": "I aggree with you and now my strategy is: If propagation is RequiresNew, then suspend the  previousXid and branchtype  (whether previousXid is null or not), and desides whether to recover them or not in the  finally{} call  by judging whether the previous value is empty.", "author": "booogu", "createdAt": "2020-03-07T00:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyMDIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMTIxNw==", "url": "https://github.com/seata/seata/pull/2307#discussion_r389231217", "bodyText": "My mistake, I mean SUPPORTS.", "author": "zjinlei", "createdAt": "2020-03-07T05:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyMDIwMQ=="}], "type": "inlineReview"}, {"oid": "d3f14830d070fe5232213ac533e2867fe10f610b", "url": "https://github.com/seata/seata/commit/d3f14830d070fe5232213ac533e2867fe10f610b", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-06T14:06:47Z", "type": "commit"}, {"oid": "9bbdd1fc0acf440c167338afa4689b27e35df6d0", "url": "https://github.com/seata/seata/commit/9bbdd1fc0acf440c167338afa4689b27e35df6d0", "message": "fix the mistake in sagaBranch and rename defaultBranchType", "committedDate": "2020-03-07T00:42:34Z", "type": "commit"}, {"oid": "8fb6dc213670d1615639c6b3eb4dc41f7e0c62ce", "url": "https://github.com/seata/seata/commit/8fb6dc213670d1615639c6b3eb4dc41f7e0c62ce", "message": "handle required branchType", "committedDate": "2020-03-07T06:02:04Z", "type": "commit"}, {"oid": "059610878760c39482ebd63d6642f34b8d681bff", "url": "https://github.com/seata/seata/commit/059610878760c39482ebd63d6642f34b8d681bff", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-07T11:02:37Z", "type": "commit"}, {"oid": "52335c8448fcad3e091dcde510731c13e59b30c6", "url": "https://github.com/seata/seata/commit/52335c8448fcad3e091dcde510731c13e59b30c6", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-10T08:22:06Z", "type": "commit"}, {"oid": "57e7dfd979b2730809421c4f8ce5a629aead0083", "url": "https://github.com/seata/seata/commit/57e7dfd979b2730809421c4f8ce5a629aead0083", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-11T12:36:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MDMyNA==", "url": "https://github.com/seata/seata/pull/2307#discussion_r391390324", "bodyText": "StringUtils.equals", "author": "jsbxyyx", "createdAt": "2020-03-12T04:01:23Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -108,4 +109,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresUndoFunction() {\n+\n+        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+            return false;\n+        }\n+\n+        if (RootContext.inGlobalTransaction() && !RootContext.getBranchType().equals(String.valueOf(BranchType.AT.ordinal()))) {", "originalCommit": "57e7dfd979b2730809421c4f8ce5a629aead0083", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMjQyMg==", "url": "https://github.com/seata/seata/pull/2307#discussion_r391412422", "bodyText": "Changed", "author": "booogu", "createdAt": "2020-03-12T05:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MDMyNA=="}], "type": "inlineReview"}, {"oid": "06e79eaff0997739b87f45d2763e16f064bb2a2e", "url": "https://github.com/seata/seata/commit/06e79eaff0997739b87f45d2763e16f064bb2a2e", "message": "use StringUtils", "committedDate": "2020-03-12T05:41:42Z", "type": "commit"}]}