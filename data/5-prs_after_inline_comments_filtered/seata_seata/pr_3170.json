{"pr_number": 3170, "pr_title": "bugfix: the disposables tree set won't accept another Disposable with the same priority.", "pr_createdAt": "2020-10-06T12:54:43Z", "pr_url": "https://github.com/seata/seata/pull/3170", "timeline": [{"oid": "94adf249abeffb1afcb5013513ce8c0fbab30f2b", "url": "https://github.com/seata/seata/commit/94adf249abeffb1afcb5013513ce8c0fbab30f2b", "message": "bugfix: the disposables tree set won't accept another Disposable with\nthe same priority.\n\nDisposable TmNettyRemotingClient and RmNettyRemotingClient added by\nGlobalTransactionScanner have the same priority by default, so the\nRmNettyRemotingClient won't be closed gracefully during shutdown.", "committedDate": "2020-10-06T12:50:33Z", "type": "commit"}, {"oid": "4cf144310f9c12920514b05ec439fc2e51806152", "url": "https://github.com/seata/seata/commit/4cf144310f9c12920514b05ec439fc2e51806152", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-10T06:08:26Z", "type": "commit"}, {"oid": "81c1c2a4021e754328e0f6f6f1c878099631448f", "url": "https://github.com/seata/seata/commit/81c1c2a4021e754328e0f6f6f1c878099631448f", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-10T07:27:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc1OTE1Ng==", "url": "https://github.com/seata/seata/pull/3170#discussion_r502759156", "bodyText": "use PriorityQueue to replace TreeSet will solve this problem once and forever. No need to add a \"seqId\" to fix the probem which is actually caused by TreeSet.", "author": "selfishlover", "createdAt": "2020-10-10T07:31:42Z", "path": "core/src/main/java/io/seata/core/rpc/ShutdownHook.java", "diffHunk": "@@ -91,35 +91,63 @@ public static void removeRuntimeShutdownHook() {\n \n     private static class DisposablePriorityWrapper implements Comparable<DisposablePriorityWrapper>, Disposable {\n \n+        private static AtomicLong seq = new AtomicLong();\n+\n         private Disposable disposable;\n \n         private int priority;\n \n+        private long seqId;\n+\n         public DisposablePriorityWrapper(Disposable disposable, int priority) {\n             this.disposable = disposable;\n             this.priority = priority;\n+            this.seqId = seq.incrementAndGet();\n         }\n \n         @Override\n         public int compareTo(DisposablePriorityWrapper disposablePriorityWrapper) {\n-            return priority - disposablePriorityWrapper.priority;", "originalCommit": "81c1c2a4021e754328e0f6f6f1c878099631448f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1659f28c66124af2a6ce7590b944bdc5484c09d1", "url": "https://github.com/seata/seata/commit/1659f28c66124af2a6ce7590b944bdc5484c09d1", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-12T03:21:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAxOTYwNQ==", "url": "https://github.com/seata/seata/pull/3170#discussion_r503019605", "bodyText": "Long.compare(x, y) ?", "author": "jsbxyyx", "createdAt": "2020-10-12T03:24:28Z", "path": "core/src/main/java/io/seata/core/rpc/ShutdownHook.java", "diffHunk": "@@ -91,35 +91,63 @@ public static void removeRuntimeShutdownHook() {\n \n     private static class DisposablePriorityWrapper implements Comparable<DisposablePriorityWrapper>, Disposable {\n \n+        private static AtomicLong seq = new AtomicLong();\n+\n         private Disposable disposable;\n \n         private int priority;\n \n+        private long seqId;\n+\n         public DisposablePriorityWrapper(Disposable disposable, int priority) {\n             this.disposable = disposable;\n             this.priority = priority;\n+            this.seqId = seq.incrementAndGet();\n         }\n \n         @Override\n         public int compareTo(DisposablePriorityWrapper disposablePriorityWrapper) {\n-            return priority - disposablePriorityWrapper.priority;\n+            int cmp = priority - disposablePriorityWrapper.priority;\n+            if (cmp == 0) {\n+                if (seqId > disposablePriorityWrapper.seqId) {\n+                    cmp = 1;\n+                } else if (seqId < disposablePriorityWrapper.seqId) {\n+                    cmp = -1;\n+                } else {\n+                    cmp = 0;\n+                }\n+            }", "originalCommit": "1659f28c66124af2a6ce7590b944bdc5484c09d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMyMzA5NA==", "url": "https://github.com/seata/seata/pull/3170#discussion_r503323094", "bodyText": "+1", "author": "a364176773", "createdAt": "2020-10-12T14:10:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAxOTYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAyMDAwNw==", "url": "https://github.com/seata/seata/pull/3170#discussion_r503020007", "bodyText": "Objects.hash(...values)?", "author": "jsbxyyx", "createdAt": "2020-10-12T03:26:35Z", "path": "core/src/main/java/io/seata/core/rpc/ShutdownHook.java", "diffHunk": "@@ -91,35 +91,63 @@ public static void removeRuntimeShutdownHook() {\n \n     private static class DisposablePriorityWrapper implements Comparable<DisposablePriorityWrapper>, Disposable {\n \n+        private static AtomicLong seq = new AtomicLong();\n+\n         private Disposable disposable;\n \n         private int priority;\n \n+        private long seqId;\n+\n         public DisposablePriorityWrapper(Disposable disposable, int priority) {\n             this.disposable = disposable;\n             this.priority = priority;\n+            this.seqId = seq.incrementAndGet();\n         }\n \n         @Override\n         public int compareTo(DisposablePriorityWrapper disposablePriorityWrapper) {\n-            return priority - disposablePriorityWrapper.priority;\n+            int cmp = priority - disposablePriorityWrapper.priority;\n+            if (cmp == 0) {\n+                if (seqId > disposablePriorityWrapper.seqId) {\n+                    cmp = 1;\n+                } else if (seqId < disposablePriorityWrapper.seqId) {\n+                    cmp = -1;\n+                } else {\n+                    cmp = 0;\n+                }\n+            }\n+            return cmp;\n         }\n \n         @Override\n         public int hashCode() {\n-            return Objects.hashCode(this.priority);\n+            final int prime = 31;\n+            int result = 1;\n+            result = prime * result + priority;\n+            result = prime * result + (int) (seqId ^ (seqId >>> 32));\n+            return result;", "originalCommit": "1659f28c66124af2a6ce7590b944bdc5484c09d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMyMzA3MQ==", "url": "https://github.com/seata/seata/pull/3170#discussion_r503323071", "bodyText": "+1", "author": "a364176773", "createdAt": "2020-10-12T14:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAyMDAwNw=="}], "type": "inlineReview"}, {"oid": "7a4175529032be9bed3dc351ff4cf8ac2b429a35", "url": "https://github.com/seata/seata/commit/7a4175529032be9bed3dc351ff4cf8ac2b429a35", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-12T14:08:20Z", "type": "commit"}, {"oid": "bee2d313d147d207543777e59da4b244851be3a1", "url": "https://github.com/seata/seata/commit/bee2d313d147d207543777e59da4b244851be3a1", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-19T02:05:55Z", "type": "commit"}, {"oid": "b36a85bfca048535e8bbfe1a768323a1f066c15f", "url": "https://github.com/seata/seata/commit/b36a85bfca048535e8bbfe1a768323a1f066c15f", "message": "Merge branch 'develop' into develop", "committedDate": "2020-10-20T03:20:15Z", "type": "commit"}]}