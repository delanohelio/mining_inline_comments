{"pr_number": 3050, "pr_title": "bugfix: fix fetch before images when delete and update statements", "pr_createdAt": "2020-08-21T04:03:54Z", "pr_url": "https://github.com/seata/seata/pull/3050", "timeline": [{"oid": "318861554951c424999976f39295fdd06223f888", "url": "https://github.com/seata/seata/commit/318861554951c424999976f39295fdd06223f888", "message": "Fixed incorrect fetching of pre-images when deleting statements", "committedDate": "2020-08-21T04:00:31Z", "type": "commit"}, {"oid": "decfe1094cfe267fb46fa071561790c9ed101de4", "url": "https://github.com/seata/seata/commit/decfe1094cfe267fb46fa071561790c9ed101de4", "message": "optimize code", "committedDate": "2020-08-21T04:03:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQwNzI4OQ==", "url": "https://github.com/seata/seata/pull/3050#discussion_r474407289", "bodyText": "What is the purpose of this line\uff1f", "author": "slievrly", "createdAt": "2020-08-21T04:52:06Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/DeleteExecutor.java", "diffHunk": "@@ -61,10 +60,12 @@ protected TableRecords beforeImage() throws SQLException {\n     }\n \n     private String buildBeforeImageSQL(SQLDeleteRecognizer visitor, TableMeta tableMeta, ArrayList<List<Object>> paramAppenderList) {\n-        String whereCondition = buildWhereCondition(visitor, paramAppenderList);\n+        String orgSql = visitor.getOriginalSQL();\n         StringBuilder suffix = new StringBuilder(\" FROM \").append(getFromTableInSQL());\n-        if (StringUtils.isNotBlank(whereCondition)) {\n-            suffix.append(\" WHERE \").append(whereCondition);\n+        this.buildWhereCondition(visitor, paramAppenderList);", "originalCommit": "decfe1094cfe267fb46fa071561790c9ed101de4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQxOTIyNw==", "url": "https://github.com/seata/seata/pull/3050#discussion_r474419227", "bodyText": "What is the purpose of this line\uff1f\n\nneed to add param value", "author": "a364176773", "createdAt": "2020-08-21T05:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQwNzI4OQ=="}], "type": "inlineReview"}, {"oid": "204c5e2baaaf3e47d81b9e3394547637b6b74eb5", "url": "https://github.com/seata/seata/commit/204c5e2baaaf3e47d81b9e3394547637b6b74eb5", "message": "optimize code", "committedDate": "2020-08-21T07:31:24Z", "type": "commit"}, {"oid": "6c81846287b229a7bbd7b24be1c18ae4565adfe8", "url": "https://github.com/seata/seata/commit/6c81846287b229a7bbd7b24be1c18ae4565adfe8", "message": "optimize code", "committedDate": "2020-08-21T07:37:38Z", "type": "commit"}, {"oid": "b8a4a6162356b9ab340db86dfb65737ed9b71412", "url": "https://github.com/seata/seata/commit/b8a4a6162356b9ab340db86dfb65737ed9b71412", "message": "optimize code", "committedDate": "2020-08-21T07:50:23Z", "type": "commit"}, {"oid": "01b56531b9a094669078d8fb3d03f75f50770135", "url": "https://github.com/seata/seata/commit/01b56531b9a094669078d8fb3d03f75f50770135", "message": "optimize code", "committedDate": "2020-08-21T07:57:28Z", "type": "commit"}, {"oid": "475e046f6a3fa50a1f6ae8204c381386b02c94d9", "url": "https://github.com/seata/seata/commit/475e046f6a3fa50a1f6ae8204c381386b02c94d9", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-08-28T03:22:05Z", "type": "commit"}, {"oid": "8c0c3b5f4185fe4ec80978b1dd48935d534df1f8", "url": "https://github.com/seata/seata/commit/8c0c3b5f4185fe4ec80978b1dd48935d534df1f8", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-08-28T14:47:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQxMzc5Mg==", "url": "https://github.com/seata/seata/pull/3050#discussion_r483413792", "bodyText": "if where, how to process?", "author": "slievrly", "createdAt": "2020-09-04T06:29:09Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/DeleteExecutor.java", "diffHunk": "@@ -61,10 +60,12 @@ protected TableRecords beforeImage() throws SQLException {\n     }\n \n     private String buildBeforeImageSQL(SQLDeleteRecognizer visitor, TableMeta tableMeta, ArrayList<List<Object>> paramAppenderList) {\n-        String whereCondition = buildWhereCondition(visitor, paramAppenderList);\n+        String orgSql = visitor.getOriginalSQL();\n         StringBuilder suffix = new StringBuilder(\" FROM \").append(getFromTableInSQL());\n-        if (StringUtils.isNotBlank(whereCondition)) {\n-            suffix.append(\" WHERE \").append(whereCondition);\n+        this.getParamAppenderList(paramAppenderList);\n+        String where = \" WHERE \";", "originalCommit": "8c0c3b5f4185fe4ec80978b1dd48935d534df1f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ0NTg1Mg==", "url": "https://github.com/seata/seata/pull/3050#discussion_r483445852", "bodyText": "PTAL", "author": "a364176773", "createdAt": "2020-09-04T07:44:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQxMzc5Mg=="}], "type": "inlineReview"}, {"oid": "6316e226c8e3312f4af072ce45b19283944d5350", "url": "https://github.com/seata/seata/commit/6316e226c8e3312f4af072ce45b19283944d5350", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-09-04T06:30:01Z", "type": "commit"}, {"oid": "e3d5fece0616ba1dd1445169bf5a744af6717231", "url": "https://github.com/seata/seata/commit/e3d5fece0616ba1dd1445169bf5a744af6717231", "message": "optimize code", "committedDate": "2020-09-04T07:37:26Z", "type": "commit"}, {"oid": "eb0a857d83466d793ed0345fb8278a8beb97279e", "url": "https://github.com/seata/seata/commit/eb0a857d83466d793ed0345fb8278a8beb97279e", "message": "optimize code", "committedDate": "2020-09-04T07:43:15Z", "type": "commit"}, {"oid": "80b08251ea6830bc9432e415fa2f9bafe0823eb7", "url": "https://github.com/seata/seata/commit/80b08251ea6830bc9432e415fa2f9bafe0823eb7", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-09-14T15:17:45Z", "type": "commit"}, {"oid": "4abcff2e3bf96129c362b3a0f763663811478658", "url": "https://github.com/seata/seata/commit/4abcff2e3bf96129c362b3a0f763663811478658", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-09-16T01:33:40Z", "type": "commit"}, {"oid": "677efdf4b1cf51ee9d6f72c86a9fb16866de0d84", "url": "https://github.com/seata/seata/commit/677efdf4b1cf51ee9d6f72c86a9fb16866de0d84", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-09-18T15:03:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU4NDY0MA==", "url": "https://github.com/seata/seata/pull/3050#discussion_r478584640", "bodyText": "\"delete from user WHERE 1=1 limit 1\"\n\"delete from user where 1=1 limit 1\"\n\"delete from user \\nwhere 1=1 limit 1\"\nThe above three SQL statements are all correct, but only the first one constructs the normal where condition", "author": "caohdgege", "createdAt": "2020-08-27T17:34:25Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/DeleteExecutor.java", "diffHunk": "@@ -61,10 +60,12 @@ protected TableRecords beforeImage() throws SQLException {\n     }\n \n     private String buildBeforeImageSQL(SQLDeleteRecognizer visitor, TableMeta tableMeta, ArrayList<List<Object>> paramAppenderList) {\n-        String whereCondition = buildWhereCondition(visitor, paramAppenderList);\n+        String orgSql = visitor.getOriginalSQL();\n         StringBuilder suffix = new StringBuilder(\" FROM \").append(getFromTableInSQL());\n-        if (StringUtils.isNotBlank(whereCondition)) {\n-            suffix.append(\" WHERE \").append(whereCondition);\n+        this.getParamAppenderList(paramAppenderList);\n+        String where = \" WHERE \";\n+        if (orgSql.contains(where)) {", "originalCommit": "01b56531b9a094669078d8fb3d03f75f50770135", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "68780b0f97b23651ee60c899e64c5c208c5d8222", "url": "https://github.com/seata/seata/commit/68780b0f97b23651ee60c899e64c5c208c5d8222", "message": "optimize code", "committedDate": "2020-09-22T13:08:40Z", "type": "commit"}, {"oid": "50c6d319b1e6bfad320cbc9d0436402582f4d18b", "url": "https://github.com/seata/seata/commit/50c6d319b1e6bfad320cbc9d0436402582f4d18b", "message": "optimize code", "committedDate": "2020-09-22T13:21:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0Njg0NA==", "url": "https://github.com/seata/seata/pull/3050#discussion_r492746844", "bodyText": "I think we don't need to check sql grammer.", "author": "l81893521", "createdAt": "2020-09-22T13:46:27Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/DeleteExecutor.java", "diffHunk": "@@ -61,10 +60,13 @@ protected TableRecords beforeImage() throws SQLException {\n     }\n \n     private String buildBeforeImageSQL(SQLDeleteRecognizer visitor, TableMeta tableMeta, ArrayList<List<Object>> paramAppenderList) {\n-        String whereCondition = buildWhereCondition(visitor, paramAppenderList);\n+        String orgSql = visitor.getOriginalSQL().replaceAll(\"(\\\\\\r\\\\\\n|\\\\\\r|\\\\\\n|\\\\\\n\\\\\\r)\", \" \");", "originalCommit": "50c6d319b1e6bfad320cbc9d0436402582f4d18b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI5Njg1Nw==", "url": "https://github.com/seata/seata/pull/3050#discussion_r493296857", "bodyText": "done", "author": "a364176773", "createdAt": "2020-09-23T08:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0Njg0NA=="}], "type": "inlineReview"}, {"oid": "404ba6d4fc92636662a15267dd1c4ee4f861f762", "url": "https://github.com/seata/seata/commit/404ba6d4fc92636662a15267dd1c4ee4f861f762", "message": "optimize code", "committedDate": "2020-09-22T14:00:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc1ODYzNA==", "url": "https://github.com/seata/seata/pull/3050#discussion_r492758634", "bodyText": "I think the here should not use \"substring\" take care of the sql parser.", "author": "l81893521", "createdAt": "2020-09-22T14:01:06Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/DeleteExecutor.java", "diffHunk": "@@ -61,10 +60,13 @@ protected TableRecords beforeImage() throws SQLException {\n     }\n \n     private String buildBeforeImageSQL(SQLDeleteRecognizer visitor, TableMeta tableMeta, ArrayList<List<Object>> paramAppenderList) {\n-        String whereCondition = buildWhereCondition(visitor, paramAppenderList);\n+        String orgSql = visitor.getOriginalSQL().replaceAll(\"(\\\\\\r\\\\\\n|\\\\\\r|\\\\\\n|\\\\\\n\\\\\\r)\", \" \");\n         StringBuilder suffix = new StringBuilder(\" FROM \").append(getFromTableInSQL());\n-        if (StringUtils.isNotBlank(whereCondition)) {\n-            suffix.append(\" WHERE \").append(whereCondition);\n+        this.getParamAppenderList(paramAppenderList);\n+        String where = \" where \";", "originalCommit": "50c6d319b1e6bfad320cbc9d0436402582f4d18b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI5NzAwNQ==", "url": "https://github.com/seata/seata/pull/3050#discussion_r493297005", "bodyText": "done", "author": "a364176773", "createdAt": "2020-09-23T08:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc1ODYzNA=="}], "type": "inlineReview"}, {"oid": "a0f5f277b535c83eb4d8ca9d63fdc89640932f1b", "url": "https://github.com/seata/seata/commit/a0f5f277b535c83eb4d8ca9d63fdc89640932f1b", "message": "optimize code", "committedDate": "2020-09-22T14:41:05Z", "type": "commit"}, {"oid": "b437ca9d1463a3effc5f8508ef833a17e4812d2f", "url": "https://github.com/seata/seata/commit/b437ca9d1463a3effc5f8508ef833a17e4812d2f", "message": "optimize code", "committedDate": "2020-09-23T06:19:51Z", "type": "commit"}, {"oid": "6524ded655236987ff430860b975baf0caf23cbb", "url": "https://github.com/seata/seata/commit/6524ded655236987ff430860b975baf0caf23cbb", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-09-23T06:21:38Z", "type": "commit"}, {"oid": "239575ec9f1ff41ee5038bbc1230de40d3121f03", "url": "https://github.com/seata/seata/commit/239575ec9f1ff41ee5038bbc1230de40d3121f03", "message": "merge", "committedDate": "2020-09-23T06:25:51Z", "type": "commit"}, {"oid": "84d7837a0dcd96a528f30ed6a26c67c2ab3c8f1c", "url": "https://github.com/seata/seata/commit/84d7837a0dcd96a528f30ed6a26c67c2ab3c8f1c", "message": "optimize code", "committedDate": "2020-09-23T06:28:46Z", "type": "commit"}, {"oid": "72de1244717e7a7b5b0796e1cc5ef8205368d2ee", "url": "https://github.com/seata/seata/commit/72de1244717e7a7b5b0796e1cc5ef8205368d2ee", "message": "bugfix", "committedDate": "2020-09-23T06:31:52Z", "type": "commit"}, {"oid": "3b1b94f7088b6ab7f76e1febb71431448f390497", "url": "https://github.com/seata/seata/commit/3b1b94f7088b6ab7f76e1febb71431448f390497", "message": "bugfix", "committedDate": "2020-09-23T06:32:39Z", "type": "commit"}, {"oid": "988334bb74dd3b80c64e2d272f56cd6bc0e63d4e", "url": "https://github.com/seata/seata/commit/988334bb74dd3b80c64e2d272f56cd6bc0e63d4e", "message": "formatting code", "committedDate": "2020-09-23T06:45:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzNDUyMw==", "url": "https://github.com/seata/seata/pull/3050#discussion_r493234523", "bodyText": "order \u53c2\u6570\u5e94\u8be5\u4e5f\u8981\u52a0\u4e0a", "author": "caohdgege", "createdAt": "2020-09-23T06:45:34Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/UpdateExecutor.java", "diffHunk": "@@ -77,7 +77,11 @@ private String buildBeforeImageSQL(TableMeta tableMeta, ArrayList<List<Object>>\n         StringBuilder suffix = new StringBuilder(\" FROM \").append(getFromTableInSQL());\n         String whereCondition = buildWhereCondition(recognizer, paramAppenderList);\n         if (StringUtils.isNotBlank(whereCondition)) {\n-            suffix.append(\" WHERE \").append(whereCondition);\n+            suffix.append(WHERE).append(whereCondition);\n+        }\n+        String limit = recognizer.getLimit();\n+        if (StringUtils.isNotBlank(limit)) {\n+            suffix.append(limit);", "originalCommit": "3b1b94f7088b6ab7f76e1febb71431448f390497", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI5NzA3Ng==", "url": "https://github.com/seata/seata/pull/3050#discussion_r493297076", "bodyText": "done", "author": "a364176773", "createdAt": "2020-09-23T08:17:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzNDUyMw=="}], "type": "inlineReview"}, {"oid": "3114b55bead85f2861fa9108675ca242ab2796c7", "url": "https://github.com/seata/seata/commit/3114b55bead85f2861fa9108675ca242ab2796c7", "message": "optimize code", "committedDate": "2020-09-23T08:14:06Z", "type": "commit"}, {"oid": "ca81bfb6d3915175937e5ead84dea7cf5c4984ec", "url": "https://github.com/seata/seata/commit/ca81bfb6d3915175937e5ead84dea7cf5c4984ec", "message": "optimize code", "committedDate": "2020-09-23T08:34:02Z", "type": "commit"}, {"oid": "c06de689cb5d3479769aa3e7e47fcca56d00f604", "url": "https://github.com/seata/seata/commit/c06de689cb5d3479769aa3e7e47fcca56d00f604", "message": "optimize code", "committedDate": "2020-09-23T10:11:54Z", "type": "commit"}, {"oid": "66e0e62d011aa73333edea287eb45047c6d902b4", "url": "https://github.com/seata/seata/commit/66e0e62d011aa73333edea287eb45047c6d902b4", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-09-23T14:05:33Z", "type": "commit"}, {"oid": "83980949315456dcd37f2b539a2fc0aeb3eac8a8", "url": "https://github.com/seata/seata/commit/83980949315456dcd37f2b539a2fc0aeb3eac8a8", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-09-29T03:49:37Z", "type": "commit"}, {"oid": "5b04e0eb010b66f69660177cd5a3ce350be86b6f", "url": "https://github.com/seata/seata/commit/5b04e0eb010b66f69660177cd5a3ce350be86b6f", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-10-02T17:28:02Z", "type": "commit"}, {"oid": "daa59fff01f024ab15da45c6b9092d3679901bb2", "url": "https://github.com/seata/seata/commit/daa59fff01f024ab15da45c6b9092d3679901bb2", "message": "Merge branch 'develop' into 0821", "committedDate": "2020-10-10T08:35:33Z", "type": "commit"}]}