{"pr_number": 2843, "pr_title": "optimize: Removed Reloadable from the redis/db SessionManager.", "pr_createdAt": "2020-06-29T03:54:26Z", "pr_url": "https://github.com/seata/seata/pull/2843", "timeline": [{"oid": "db578ef732973863b7bfb22786c215f55804b5c4", "url": "https://github.com/seata/seata/commit/db578ef732973863b7bfb22786c215f55804b5c4", "message": "optimize: Removed Reloadable from the redis/db SessionManager.", "committedDate": "2020-06-29T03:52:02Z", "type": "commit"}, {"oid": "9483e9dcb398e17376292c2aaaf1fdb369a3fd15", "url": "https://github.com/seata/seata/commit/9483e9dcb398e17376292c2aaaf1fdb369a3fd15", "message": "\u4f18\u5316reload\u65b9\u6cd5\u3002", "committedDate": "2020-06-29T05:02:15Z", "type": "commit"}, {"oid": "af8b273cac2566fc7016979d91a58ac46e48bde6", "url": "https://github.com/seata/seata/commit/af8b273cac2566fc7016979d91a58ac46e48bde6", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-06-30T04:50:20Z", "type": "commit"}, {"oid": "4cc56f0f6a6f4460ca3e930e232f440422988ade", "url": "https://github.com/seata/seata/commit/4cc56f0f6a6f4460ca3e930e232f440422988ade", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-07-09T08:01:52Z", "type": "commit"}, {"oid": "d3bde051924c3e20a7ae8578b2eaff0c2295099e", "url": "https://github.com/seata/seata/commit/d3bde051924c3e20a7ae8578b2eaff0c2295099e", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-07-13T05:01:35Z", "type": "commit"}, {"oid": "31fd6f5fd3352baf990e79ce70829ffd3181bc38", "url": "https://github.com/seata/seata/commit/31fd6f5fd3352baf990e79ce70829ffd3181bc38", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-07-13T09:56:59Z", "type": "commit"}, {"oid": "6357d90017cedf460a55c637d97ba1b7e18bf11e", "url": "https://github.com/seata/seata/commit/6357d90017cedf460a55c637d97ba1b7e18bf11e", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-07-16T01:35:14Z", "type": "commit"}, {"oid": "482cb4c26b439a411a82cc58f25df7c2d67ebd32", "url": "https://github.com/seata/seata/commit/482cb4c26b439a411a82cc58f25df7c2d67ebd32", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-07-16T09:59:14Z", "type": "commit"}, {"oid": "1424c391a0f3356980b78102e55ed106e1f7b4d0", "url": "https://github.com/seata/seata/commit/1424c391a0f3356980b78102e55ed106e1f7b4d0", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-07-23T01:02:24Z", "type": "commit"}, {"oid": "1e7c903d4a8d102e029e41ebd94086e0268a95ab", "url": "https://github.com/seata/seata/commit/1e7c903d4a8d102e029e41ebd94086e0268a95ab", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-07-30T09:53:15Z", "type": "commit"}, {"oid": "ce4b39f688a24157271275a5c130f7f23525aa5e", "url": "https://github.com/seata/seata/commit/ce4b39f688a24157271275a5c130f7f23525aa5e", "message": "\u4f18\u5316reload\u65b9\u6cd5\u3002", "committedDate": "2020-07-30T10:34:48Z", "type": "commit"}, {"oid": "b834e59bd07194090e903a475a3d499e19ed046e", "url": "https://github.com/seata/seata/commit/b834e59bd07194090e903a475a3d499e19ed046e", "message": "\u91cd\u6784reload\u65b9\u6cd5\u3002", "committedDate": "2020-07-30T11:00:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyNDQxOQ==", "url": "https://github.com/seata/seata/pull/2843#discussion_r462924419", "bodyText": "Why only file mode can reload this status of global session?\nAsyncCommitting\nCommitRetrying\nTimeoutRollbackRetrying\nBegin", "author": "l81893521", "createdAt": "2020-07-30T11:13:50Z", "path": "server/src/main/java/io/seata/server/session/SessionHolder.java", "diffHunk": "@@ -117,39 +117,52 @@ public static void init(String mode) throws IOException {\n             // unknown store\n             throw new IllegalArgumentException(\"unknown store mode:\" + mode);\n         }\n-        reload();\n+        reloadAndRevise(storeMode);\n     }\n \n     /**\n-     * Reload.\n+     * Reload and revise.\n      */\n-    protected static void reload() {\n+    protected static void reloadAndRevise(StoreMode storeMode) {\n         if (ROOT_SESSION_MANAGER instanceof Reloadable) {\n-            ((Reloadable)ROOT_SESSION_MANAGER).reload();\n+            ((Reloadable) ROOT_SESSION_MANAGER).reload();\n+        }\n \n-            Collection<GlobalSession> reloadedSessions = ROOT_SESSION_MANAGER.allSessions();\n-            if (reloadedSessions != null && !reloadedSessions.isEmpty()) {\n-                reloadedSessions.forEach(globalSession -> {\n-                    GlobalStatus globalStatus = globalSession.getStatus();\n-                    switch (globalStatus) {\n-                        case UnKnown:\n-                        case Committed:\n-                        case CommitFailed:\n-                        case Rollbacked:\n-                        case RollbackFailed:\n-                        case TimeoutRollbacked:\n-                        case TimeoutRollbackFailed:\n-                        case Finished:\n-                            throw new ShouldNeverHappenException(\"Reloaded Session should NOT be \" + globalStatus);\n-                        case AsyncCommitting:\n+        Collection<GlobalSession> allSessions = ROOT_SESSION_MANAGER.allSessions();\n+        if (allSessions != null && !allSessions.isEmpty()) {\n+            allSessions.forEach(globalSession -> {\n+                GlobalStatus globalStatus = globalSession.getStatus();\n+                switch (globalStatus) {\n+                    case UnKnown:\n+                    case Committed:\n+                    case CommitFailed:\n+                    case Rollbacked:\n+                    case RollbackFailed:\n+                    case TimeoutRollbacked:\n+                    case TimeoutRollbackFailed:\n+                    case Finished:\n+                        try {\n+                            LOGGER.warn(\"The global session should NOT be {}, remove it. xid = {}\", globalStatus, globalSession.getXid());\n+                            ROOT_SESSION_MANAGER.removeGlobalSession(globalSession);\n+                            if (LOGGER.isInfoEnabled()) {\n+                                LOGGER.info(\"Remove global session succeeded, xid = {}, status = {}\", globalSession.getXid(), globalSession.getStatus());\n+                            }\n+                        } catch (Exception e) {\n+                            LOGGER.error(\"Remove global session failed, xid = {}, status = {}\", globalSession.getXid(), globalSession.getStatus(), e);\n+                        }\n+                        break;\n+                    case AsyncCommitting:\n+                        if (storeMode == StoreMode.FILE) {", "originalCommit": "ce4b39f688a24157271275a5c130f7f23525aa5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyNTA1OA==", "url": "https://github.com/seata/seata/pull/2843#discussion_r462925058", "bodyText": "If say so, this hold method just use for file mode?", "author": "l81893521", "createdAt": "2020-07-30T11:15:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyNDQxOQ=="}], "type": "inlineReview"}, {"oid": "46e1e28698d28403199d1b81eb08d00a8cf2a2ee", "url": "https://github.com/seata/seata/commit/46e1e28698d28403199d1b81eb08d00a8cf2a2ee", "message": "\u79fb\u52a8\u4e00\u4e0b\u65b9\u6cd5\u4f4d\u7f6e\u3002\u79fb\u9664init\u65b9\u6cd5\u7684throws", "committedDate": "2020-07-31T01:25:31Z", "type": "commit"}, {"oid": "b08b074c96092e8fdb85ebd956b53587687e082b", "url": "https://github.com/seata/seata/commit/b08b074c96092e8fdb85ebd956b53587687e082b", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-07-31T07:13:44Z", "type": "commit"}, {"oid": "ebd317345855e403f7e3541f7c5da2331970bcfa", "url": "https://github.com/seata/seata/commit/ebd317345855e403f7e3541f7c5da2331970bcfa", "message": "Merge remote-tracking branch 'remotes/upstream/develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-08-03T01:35:15Z", "type": "commit"}, {"oid": "32f2b2eb20aa7715ed1dff6a4e2ce241544e19fb", "url": "https://github.com/seata/seata/commit/32f2b2eb20aa7715ed1dff6a4e2ce241544e19fb", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-08-05T10:35:56Z", "type": "commit"}, {"oid": "ced39c10bfd4f977768c8d6b8769b212128edfb6", "url": "https://github.com/seata/seata/commit/ced39c10bfd4f977768c8d6b8769b212128edfb6", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-08-10T02:14:13Z", "type": "commit"}, {"oid": "98ae9af2ab8f019388a70e85f0453c2428de4987", "url": "https://github.com/seata/seata/commit/98ae9af2ab8f019388a70e85f0453c2428de4987", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-08-13T01:33:28Z", "type": "commit"}, {"oid": "52b8d222167b2524ef8a499fd886467048d06c17", "url": "https://github.com/seata/seata/commit/52b8d222167b2524ef8a499fd886467048d06c17", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-08-22T01:44:42Z", "type": "commit"}, {"oid": "aa870059d3f9154798c2ff1cf581023b21894a1b", "url": "https://github.com/seata/seata/commit/aa870059d3f9154798c2ff1cf581023b21894a1b", "message": "\u91cd\u6784", "committedDate": "2020-08-22T02:46:54Z", "type": "commit"}, {"oid": "2c5f53989e6a7c8ee03bc3766ea130528e9b29c8", "url": "https://github.com/seata/seata/commit/2c5f53989e6a7c8ee03bc3766ea130528e9b29c8", "message": "\u89e3\u51b3forEach\u4e2d\u542b\u6709remove\u64cd\u4f5c\u7684BUG\u3002", "committedDate": "2020-08-22T02:51:34Z", "type": "commit"}, {"oid": "9dffc6a8b3a42c66b42a133f7936535b93457cce", "url": "https://github.com/seata/seata/commit/9dffc6a8b3a42c66b42a133f7936535b93457cce", "message": "\u89e3\u51b3forEach\u4e2d\u542b\u6709remove\u64cd\u4f5c\u7684BUG\u3002", "committedDate": "2020-08-22T02:52:39Z", "type": "commit"}, {"oid": "46a75e98915975760d1958f986f8a8f95a39783b", "url": "https://github.com/seata/seata/commit/46a75e98915975760d1958f986f8a8f95a39783b", "message": "fix style", "committedDate": "2020-08-22T02:54:47Z", "type": "commit"}, {"oid": "840aa6cf4dd28fa60102909830f5cad7371615fd", "url": "https://github.com/seata/seata/commit/840aa6cf4dd28fa60102909830f5cad7371615fd", "message": "fix style", "committedDate": "2020-08-22T03:00:13Z", "type": "commit"}, {"oid": "96701c8e66cc6296e45157ebbb4549b888c167ef", "url": "https://github.com/seata/seata/commit/96701c8e66cc6296e45157ebbb4549b888c167ef", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-09-15T02:51:01Z", "type": "commit"}, {"oid": "addcf7c0989b4e7c6e8e716c2c773118fe5159bc", "url": "https://github.com/seata/seata/commit/addcf7c0989b4e7c6e8e716c2c773118fe5159bc", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-09-15T10:47:24Z", "type": "commit"}, {"oid": "21deaad5a4f7b926a23f491afa0aff6a2f043f5c", "url": "https://github.com/seata/seata/commit/21deaad5a4f7b926a23f491afa0aff6a2f043f5c", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-12T10:58:40Z", "type": "commit"}, {"oid": "0ca55e42dcbe932d48d4996f12b3eaf60f6c64bf", "url": "https://github.com/seata/seata/commit/0ca55e42dcbe932d48d4996f12b3eaf60f6c64bf", "message": "Merge remote-tracking branch 'remotes/upstream/develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-15T05:06:29Z", "type": "commit"}, {"oid": "7db0ab3db7687136556b0653d9fc6afff26a1e31", "url": "https://github.com/seata/seata/commit/7db0ab3db7687136556b0653d9fc6afff26a1e31", "message": "optimize code", "committedDate": "2020-10-15T05:08:35Z", "type": "commit"}, {"oid": "26dc624e1c9da388a552ba8858a61d3cf4bc39d2", "url": "https://github.com/seata/seata/commit/26dc624e1c9da388a552ba8858a61d3cf4bc39d2", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-17T16:12:58Z", "type": "commit"}, {"oid": "ef73c5511c8a6f8063fc977a6d043959a74c6738", "url": "https://github.com/seata/seata/commit/ef73c5511c8a6f8063fc977a6d043959a74c6738", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-19T09:50:05Z", "type": "commit"}, {"oid": "91ea2f4aeb29da574f5ecb1159310df71bcd31b9", "url": "https://github.com/seata/seata/commit/91ea2f4aeb29da574f5ecb1159310df71bcd31b9", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-21T13:12:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk4NzA0NQ==", "url": "https://github.com/seata/seata/pull/2843#discussion_r509987045", "bodyText": "So only in file mode do we need to reload, right?", "author": "slievrly", "createdAt": "2020-10-22T08:46:24Z", "path": "server/src/main/java/io/seata/server/session/SessionHolder.java", "diffHunk": "@@ -117,83 +118,122 @@ public static void init(String mode) throws IOException {\n             // unknown store\n             throw new IllegalArgumentException(\"unknown store mode:\" + mode);\n         }\n-        reload();\n+        reload(storeMode);\n     }\n \n+    //region reload\n+\n     /**\n      * Reload.\n      */\n-    protected static void reload() {\n+    protected static void reload(StoreMode storeMode) {\n         if (ROOT_SESSION_MANAGER instanceof Reloadable) {\n-            ((Reloadable)ROOT_SESSION_MANAGER).reload();\n+            ((Reloadable) ROOT_SESSION_MANAGER).reload();\n+        }", "originalCommit": "91ea2f4aeb29da574f5ecb1159310df71bcd31b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAxOTYxMg==", "url": "https://github.com/seata/seata/pull/2843#discussion_r510019612", "bodyText": "yes", "author": "wangliang181230", "createdAt": "2020-10-22T09:34:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk4NzA0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAyMTM3Mg==", "url": "https://github.com/seata/seata/pull/2843#discussion_r510021372", "bodyText": "redis and db mode, only need to remove the global sessions in error status.", "author": "wangliang181230", "createdAt": "2020-10-22T09:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk4NzA0NQ=="}], "type": "inlineReview"}, {"oid": "36fee7c1ac3fc6d890cc17304a8e680705dbd608", "url": "https://github.com/seata/seata/commit/36fee7c1ac3fc6d890cc17304a8e680705dbd608", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-22T09:21:36Z", "type": "commit"}, {"oid": "05b56faf0ed35a77e5438bf0c84a7328e2debcc5", "url": "https://github.com/seata/seata/commit/05b56faf0ed35a77e5438bf0c84a7328e2debcc5", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-22T11:39:34Z", "type": "commit"}, {"oid": "ae227d888a8da7a7d549fdd0ed18f24e8bc7cfb9", "url": "https://github.com/seata/seata/commit/ae227d888a8da7a7d549fdd0ed18f24e8bc7cfb9", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-23T09:09:09Z", "type": "commit"}, {"oid": "aee621815863a3bde1203b78a2e17d087fe1a6d7", "url": "https://github.com/seata/seata/commit/aee621815863a3bde1203b78a2e17d087fe1a6d7", "message": "Merge remote-tracking branch 'remotes/upstream/develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-26T09:31:06Z", "type": "commit"}, {"oid": "3bab6a164a73d9081d46179e44f5877e378c3fa9", "url": "https://github.com/seata/seata/commit/3bab6a164a73d9081d46179e44f5877e378c3fa9", "message": "\u987a\u4fbf\u79fb\u9664\u4e00\u4e9b\u591a\u4f59\u7684\u5173\u952e\u5b57", "committedDate": "2020-10-26T09:32:00Z", "type": "commit"}, {"oid": "ce9c6e4d047581bab4fd8cd19e633ddde167c31e", "url": "https://github.com/seata/seata/commit/ce9c6e4d047581bab4fd8cd19e633ddde167c31e", "message": "Merge remote-tracking branch 'origin/optimize-redis-db-session-manager-2' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-26T09:32:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5NDI3MQ==", "url": "https://github.com/seata/seata/pull/2843#discussion_r512494271", "bodyText": "\u591a\u4f59\u7684\u5173\u952e\u5b57\u3002", "author": "wangliang181230", "createdAt": "2020-10-27T08:24:47Z", "path": "core/src/main/java/io/seata/core/constants/ConfigurationKeys.java", "diffHunk": "@@ -25,7 +25,7 @@\n     /**\n      * The constant SEATA_PREFIX.\n      */\n-    public static final String SEATA_PREFIX = \"seata.\";", "originalCommit": "ce9c6e4d047581bab4fd8cd19e633ddde167c31e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "283dd8c0d95358962c84a8d9e16e0609439af01b", "url": "https://github.com/seata/seata/commit/283dd8c0d95358962c84a8d9e16e0609439af01b", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-28T02:47:04Z", "type": "commit"}, {"oid": "1373347b55419da7a51fb9df9dd6c3fc241bddd6", "url": "https://github.com/seata/seata/commit/1373347b55419da7a51fb9df9dd6c3fc241bddd6", "message": "Merge branch 'develop' into optimize-redis-db-session-manager-2", "committedDate": "2020-10-28T03:59:54Z", "type": "commit"}]}