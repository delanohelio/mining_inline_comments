{"pr_number": 2140, "pr_title": "optimize: GzipUtil code style", "pr_createdAt": "2020-01-06T01:13:21Z", "pr_url": "https://github.com/seata/seata/pull/2140", "timeline": [{"oid": "70b25ba18bfd905cda6baea910a734d9c36a84c4", "url": "https://github.com/seata/seata/commit/70b25ba18bfd905cda6baea910a734d9c36a84c4", "message": "optimize: GzipUtil code style", "committedDate": "2020-01-06T01:11:50Z", "type": "commit"}, {"oid": "5b36dff704ef585b5ae0bfac55ba55db93dd33a9", "url": "https://github.com/seata/seata/commit/5b36dff704ef585b5ae0bfac55ba55db93dd33a9", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-06T01:14:21Z", "type": "commit"}, {"oid": "fbfc69f5e0fa99cc7d5a99e6634b77eacc1ee419", "url": "https://github.com/seata/seata/commit/fbfc69f5e0fa99cc7d5a99e6634b77eacc1ee419", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-06T10:28:29Z", "type": "commit"}, {"oid": "88960dfd5ef4230c005f68ea814212ccaa3b275d", "url": "https://github.com/seata/seata/commit/88960dfd5ef4230c005f68ea814212ccaa3b275d", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-06T13:27:30Z", "type": "commit"}, {"oid": "f4ce446a5182ad07d82e433d9672d70bcf089829", "url": "https://github.com/seata/seata/commit/f4ce446a5182ad07d82e433d9672d70bcf089829", "message": "fix: unit test GzipCompressorTest#testCompressAndDecompress gzip decompress error", "committedDate": "2020-01-06T14:52:00Z", "type": "commit"}, {"oid": "496dc747ca5201e886650bab7a1ceff37e27e146", "url": "https://github.com/seata/seata/commit/496dc747ca5201e886650bab7a1ceff37e27e146", "message": "Merge remote-tracking branch 'origin/patch-11' into patch-11", "committedDate": "2020-01-06T14:52:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMzUwMA==", "url": "https://github.com/seata/seata/pull/2140#discussion_r363613500", "bodyText": "The close method of GZIPOutputStream should be called.And the close method of ByteArrayOutputStream actually does nothing.", "author": "xingfudeshi", "createdAt": "2020-01-07T07:00:04Z", "path": "compressor/seata-compressor-gzip/src/main/java/io/seata/compressor/gzip/GzipUtil.java", "diffHunk": "@@ -28,48 +26,43 @@\n  */\n public class GzipUtil {\n \n+    private GzipUtil() {\n+\n+    }\n+\n     private static final int BUFFER_SIZE = 8192;\n \n     public static byte[] compress(byte[] bytes) {\n         if (bytes == null) {\n             throw new NullPointerException(\"bytes is null\");\n         }\n-        ByteArrayOutputStream out = null;\n-        GZIPOutputStream gzip = null;\n-        try {\n-            out = new ByteArrayOutputStream();\n-            gzip = new GZIPOutputStream(out);\n+\n+        try (ByteArrayOutputStream out = new ByteArrayOutputStream();\n+             GZIPOutputStream gzip = new GZIPOutputStream(out)) {", "originalCommit": "496dc747ca5201e886650bab7a1ceff37e27e146", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMzc5OQ==", "url": "https://github.com/seata/seata/pull/2140#discussion_r363613799", "bodyText": "The close method of GZIPInputStream should be called.", "author": "xingfudeshi", "createdAt": "2020-01-07T07:01:16Z", "path": "compressor/seata-compressor-gzip/src/main/java/io/seata/compressor/gzip/GzipUtil.java", "diffHunk": "@@ -28,48 +26,43 @@\n  */\n public class GzipUtil {\n \n+    private GzipUtil() {\n+\n+    }\n+\n     private static final int BUFFER_SIZE = 8192;\n \n     public static byte[] compress(byte[] bytes) {\n         if (bytes == null) {\n             throw new NullPointerException(\"bytes is null\");\n         }\n-        ByteArrayOutputStream out = null;\n-        GZIPOutputStream gzip = null;\n-        try {\n-            out = new ByteArrayOutputStream();\n-            gzip = new GZIPOutputStream(out);\n+\n+        try (ByteArrayOutputStream out = new ByteArrayOutputStream();\n+             GZIPOutputStream gzip = new GZIPOutputStream(out)) {\n             gzip.write(bytes);\n-            gzip.close();\n+            gzip.flush();\n+            gzip.finish();\n             return out.toByteArray();\n         } catch (IOException e) {\n             throw new RuntimeException(\"gzip compress error\", e);\n-        } finally {\n-            IOUtil.close(out);\n         }\n-\n     }\n \n     public static byte[] decompress(byte[] bytes) {\n         if (bytes == null) {\n             throw new NullPointerException(\"bytes is null\");\n         }\n-        ByteArrayOutputStream out = null;\n-        GZIPInputStream gunzip = null;\n-        try {\n-            out = new ByteArrayOutputStream();\n-            gunzip = new GZIPInputStream(new ByteArrayInputStream(bytes));\n+\n+        try (ByteArrayOutputStream out = new ByteArrayOutputStream();\n+             GZIPInputStream gunzip = new GZIPInputStream(new ByteArrayInputStream(bytes))) {", "originalCommit": "496dc747ca5201e886650bab7a1ceff37e27e146", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "90debd1d03c0d1d3f5840b149def9edc34f901aa", "url": "https://github.com/seata/seata/commit/90debd1d03c0d1d3f5840b149def9edc34f901aa", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-10T06:34:19Z", "type": "commit"}, {"oid": "3f9085b826fb5d14dc870e6b67e052002ed375ce", "url": "https://github.com/seata/seata/commit/3f9085b826fb5d14dc870e6b67e052002ed375ce", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-11T03:41:14Z", "type": "commit"}, {"oid": "53f24c3ed79dafcb8cba5272a431af2118deeee0", "url": "https://github.com/seata/seata/commit/53f24c3ed79dafcb8cba5272a431af2118deeee0", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-11T13:55:25Z", "type": "commit"}, {"oid": "3e69714212fb3f3de70f019fea26900598f34354", "url": "https://github.com/seata/seata/commit/3e69714212fb3f3de70f019fea26900598f34354", "message": "optimize resource", "committedDate": "2020-01-11T13:57:45Z", "type": "commit"}, {"oid": "f02dc10e16b11839d6c7fda93ac0c2f3f341d6a8", "url": "https://github.com/seata/seata/commit/f02dc10e16b11839d6c7fda93ac0c2f3f341d6a8", "message": "Merge remote-tracking branch 'origin/patch-11' into patch-11", "committedDate": "2020-01-11T13:58:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIyOTYyMg==", "url": "https://github.com/seata/seata/pull/2140#discussion_r366229622", "bodyText": "Is it necessary here? close will call the finish method.", "author": "slievrly", "createdAt": "2020-01-14T09:28:05Z", "path": "compressor/seata-compressor-gzip/src/main/java/io/seata/compressor/gzip/GzipUtil.java", "diffHunk": "@@ -28,48 +26,42 @@\n  */\n public class GzipUtil {\n \n+    private GzipUtil() {\n+\n+    }\n+\n     private static final int BUFFER_SIZE = 8192;\n \n     public static byte[] compress(byte[] bytes) {\n         if (bytes == null) {\n             throw new NullPointerException(\"bytes is null\");\n         }\n-        ByteArrayOutputStream out = null;\n-        GZIPOutputStream gzip = null;\n-        try {\n-            out = new ByteArrayOutputStream();\n-            gzip = new GZIPOutputStream(out);\n+        ByteArrayOutputStream out = new ByteArrayOutputStream();\n+        try (GZIPOutputStream gzip = new GZIPOutputStream(out)) {\n             gzip.write(bytes);\n-            gzip.close();\n+            gzip.flush();\n+            gzip.finish();", "originalCommit": "f02dc10e16b11839d6c7fda93ac0c2f3f341d6a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI3MDYxNA==", "url": "https://github.com/seata/seata/pull/2140#discussion_r366270614", "bodyText": "Is it necessary here? close will call the finish method.\n\nOf course not. If you do not call the flush method and the finish method before the close method, you will not be able to write data into the stream. Since the return statement will return before the finally block, the data was not written into the stream at that time, which caused compression failure. Further decompression failed, and I wrote a new unit test method for compression and decompression testing.", "author": "InstallingB", "createdAt": "2020-01-14T10:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIyOTYyMg=="}], "type": "inlineReview"}, {"oid": "641671c2430834bf7a917bb9b657c0882b5a83da", "url": "https://github.com/seata/seata/commit/641671c2430834bf7a917bb9b657c0882b5a83da", "message": "add test_compressEqualDecompress unit test", "committedDate": "2020-01-14T10:50:29Z", "type": "commit"}, {"oid": "5898f54bd6022e88fd6c1fd722d736dd46a22b7c", "url": "https://github.com/seata/seata/commit/5898f54bd6022e88fd6c1fd722d736dd46a22b7c", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-14T10:51:46Z", "type": "commit"}, {"oid": "a04c9374028ffdb393085c9a484c9b5314b167f1", "url": "https://github.com/seata/seata/commit/a04c9374028ffdb393085c9a484c9b5314b167f1", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-15T03:17:30Z", "type": "commit"}, {"oid": "3bdeb65589c8724895ce2c3783de5939febb3b12", "url": "https://github.com/seata/seata/commit/3bdeb65589c8724895ce2c3783de5939febb3b12", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-16T01:50:49Z", "type": "commit"}, {"oid": "7b7b992ac1204863f59943e87672d085dce3b614", "url": "https://github.com/seata/seata/commit/7b7b992ac1204863f59943e87672d085dce3b614", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-16T11:50:37Z", "type": "commit"}, {"oid": "bb252da68b293e0f30f44d212b98fa6d2388fc96", "url": "https://github.com/seata/seata/commit/bb252da68b293e0f30f44d212b98fa6d2388fc96", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-17T06:18:17Z", "type": "commit"}, {"oid": "68e4438006c8557f00dbc97156d8670e4b978af1", "url": "https://github.com/seata/seata/commit/68e4438006c8557f00dbc97156d8670e4b978af1", "message": "Merge branch 'develop' into patch-11", "committedDate": "2020-01-20T06:10:49Z", "type": "commit"}]}