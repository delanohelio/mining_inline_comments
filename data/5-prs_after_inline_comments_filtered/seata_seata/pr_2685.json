{"pr_number": 2685, "pr_title": "bugfix: oracle insert sql use sysdate error.", "pr_createdAt": "2020-05-13T14:55:05Z", "pr_url": "https://github.com/seata/seata/pull/2685", "timeline": [{"oid": "f7ce922fb179cd5ce5cf0e9e8c39e289a54ffcc6", "url": "https://github.com/seata/seata/commit/f7ce922fb179cd5ce5cf0e9e8c39e289a54ffcc6", "message": "fix: oracle insert sql use sysdate error.", "committedDate": "2020-05-13T13:56:15Z", "type": "commit"}, {"oid": "d2b21f9b2e80f2b05ff978240e33f6867c4ce7a7", "url": "https://github.com/seata/seata/commit/d2b21f9b2e80f2b05ff978240e33f6867c4ce7a7", "message": "fix ci", "committedDate": "2020-05-14T02:12:17Z", "type": "commit"}, {"oid": "6a895eca698b2fd5cb96217a668af836e4a2d524", "url": "https://github.com/seata/seata/commit/6a895eca698b2fd5cb96217a668af836e4a2d524", "message": "fix reviews.", "committedDate": "2020-05-14T03:09:43Z", "type": "commit"}, {"oid": "efcd2f996eb8455eb29a17d0cc27d0634adf65ad", "url": "https://github.com/seata/seata/commit/efcd2f996eb8455eb29a17d0cc27d0634adf65ad", "message": "fix test.", "committedDate": "2020-05-14T04:33:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE4MjI2Ng==", "url": "https://github.com/seata/seata/pull/2685#discussion_r425182266", "bodyText": "use Singleton to reuse new SqlMethodExpr()\u3001NotPlaceholderExpr\u3001SQLSequenceExpr", "author": "zjinlei", "createdAt": "2020-05-14T14:30:04Z", "path": "sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/mysql/MySQLInsertRecognizer.java", "diffHunk": "@@ -100,24 +101,28 @@ public boolean visit(SQLExprTableSource x) {\n     }\n \n     @Override\n-    public List<List<Object>> getInsertRows() {\n+    public List<List<Object>> getInsertRows(int primaryKeyIndex) {\n         List<SQLInsertStatement.ValuesClause> valuesClauses = ast.getValuesList();\n         List<List<Object>> rows = new ArrayList<>(valuesClauses.size());\n         for (SQLInsertStatement.ValuesClause valuesClause : valuesClauses) {\n             List<SQLExpr> exprs = valuesClause.getValues();\n             List<Object> row = new ArrayList<>(exprs.size());\n             rows.add(row);\n-            for (SQLExpr expr : valuesClause.getValues()) {\n+            for (int i = 0, len = exprs.size(); i < len; i++) {\n+                SQLExpr expr = exprs.get(i);\n                 if (expr instanceof SQLNullExpr) {\n                     row.add(Null.get());\n                 } else if (expr instanceof SQLValuableExpr) {\n-                    row.add(((SQLValuableExpr)expr).getValue());\n+                    row.add(((SQLValuableExpr) expr).getValue());\n                 } else if (expr instanceof SQLVariantRefExpr) {\n-                    row.add(((SQLVariantRefExpr)expr).getName());\n+                    row.add(((SQLVariantRefExpr) expr).getName());\n                 } else if (expr instanceof SQLMethodInvokeExpr) {\n                     row.add(new SqlMethodExpr());\n                 } else {\n-                    throw new SQLParsingException(\"Unknown SQLExpr: \" + expr.getClass() + \" \" + expr);\n+                    if (i == primaryKeyIndex) {\n+                        throw new SQLParsingException(\"Unknown SQLExpr: \" + expr.getClass() + \" \" + expr);\n+                    }\n+                    row.add(new NotPlaceholderExpr());", "originalCommit": "efcd2f996eb8455eb29a17d0cc27d0634adf65ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7db5d595e4ed0c9d1ddff8c2571c4c68304096e1", "url": "https://github.com/seata/seata/commit/7db5d595e4ed0c9d1ddff8c2571c4c68304096e1", "message": "fix review.", "committedDate": "2020-05-15T10:42:44Z", "type": "commit"}, {"oid": "43501955fd85f3754e7333ffe8588b8a64641961", "url": "https://github.com/seata/seata/commit/43501955fd85f3754e7333ffe8588b8a64641961", "message": "Merge branch 'develop' of https://github.com/seata/seata into fix_sysdate\n\n# Conflicts:\n#\trm-datasource/src/main/java/io/seata/rm/datasource/exec/InsertExecutor.java", "committedDate": "2020-05-21T03:30:56Z", "type": "commit"}, {"oid": "b424c4ee0d18888cf4b5129ec7382d94585abfc9", "url": "https://github.com/seata/seata/commit/b424c4ee0d18888cf4b5129ec7382d94585abfc9", "message": "fix tests.", "committedDate": "2020-05-22T07:46:18Z", "type": "commit"}, {"oid": "8745a49c23441bbbca16a1254b7aaac035f92b33", "url": "https://github.com/seata/seata/commit/8745a49c23441bbbca16a1254b7aaac035f92b33", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-05-26T08:12:38Z", "type": "commit"}, {"oid": "1d085beb05c4618a0ac816224bba9f8a033a8e41", "url": "https://github.com/seata/seata/commit/1d085beb05c4618a0ac816224bba9f8a033a8e41", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-05-30T05:47:01Z", "type": "commit"}, {"oid": "d20fd22dbbaa17281599f0357c7963713fda750f", "url": "https://github.com/seata/seata/commit/d20fd22dbbaa17281599f0357c7963713fda750f", "message": "fix conflict", "committedDate": "2020-06-05T09:24:01Z", "type": "commit"}, {"oid": "2f5c34b05b51b64e13cedf0dc61c9e6248068b79", "url": "https://github.com/seata/seata/commit/2f5c34b05b51b64e13cedf0dc61c9e6248068b79", "message": "Merge branch 'fix_sysdate' of https://github.com/jsbxyyx/seata into fix_sysdate", "committedDate": "2020-06-05T09:24:30Z", "type": "commit"}, {"oid": "1fa488a4c4046bf70fb05ad1fd38e2512b02a92d", "url": "https://github.com/seata/seata/commit/1fa488a4c4046bf70fb05ad1fd38e2512b02a92d", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-06-09T02:44:54Z", "type": "commit"}, {"oid": "25b56f6ff0218ef8b2e920e743b15e1687db89e0", "url": "https://github.com/seata/seata/commit/25b56f6ff0218ef8b2e920e743b15e1687db89e0", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-06-19T07:20:48Z", "type": "commit"}, {"oid": "deffbc602151754a1f26e5cd23fa51a9aa2fc31a", "url": "https://github.com/seata/seata/commit/deffbc602151754a1f26e5cd23fa51a9aa2fc31a", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-06-27T12:22:26Z", "type": "commit"}, {"oid": "bc952992e21067fa18c5c0ca2fac92d75b93ba24", "url": "https://github.com/seata/seata/commit/bc952992e21067fa18c5c0ca2fac92d75b93ba24", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-06-29T04:15:01Z", "type": "commit"}, {"oid": "5f5abcd7d54480e30b7ac7847d1875c1a98aba7c", "url": "https://github.com/seata/seata/commit/5f5abcd7d54480e30b7ac7847d1875c1a98aba7c", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-06-30T01:27:51Z", "type": "commit"}, {"oid": "1028c0978bfc0cc2edac2150b9fe6b4257447c08", "url": "https://github.com/seata/seata/commit/1028c0978bfc0cc2edac2150b9fe6b4257447c08", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-06-30T07:57:11Z", "type": "commit"}, {"oid": "1eb8a06f2b31e4f7c596bfdb5988e6cafa478e30", "url": "https://github.com/seata/seata/commit/1eb8a06f2b31e4f7c596bfdb5988e6cafa478e30", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-06-30T10:16:26Z", "type": "commit"}, {"oid": "01d0270a06e448587b640502e0fe700ef86d8e84", "url": "https://github.com/seata/seata/commit/01d0270a06e448587b640502e0fe700ef86d8e84", "message": "Merge branch 'develop' of https://github.com/seata/seata into fix_sysdate\n\n# Conflicts:\n#\trm-datasource/src/main/java/io/seata/rm/datasource/exec/BaseInsertExecutor.java\n#\trm-datasource/src/test/java/io/seata/rm/datasource/exec/BatchInsertExecutorTest.java\n#\trm-datasource/src/test/java/io/seata/rm/datasource/exec/MySQLInsertExecutorTest.java\n#\trm-datasource/src/test/java/io/seata/rm/datasource/exec/OracleInsertExecutorTest.java", "committedDate": "2020-07-03T10:52:47Z", "type": "commit"}, {"oid": "6d2b2a38c06623249c758b94a761cfe3a2863340", "url": "https://github.com/seata/seata/commit/6d2b2a38c06623249c758b94a761cfe3a2863340", "message": "Merge branch 'develop' of https://github.com/seata/seata into fix_sysdate\n\n# Conflicts:\n#\trm-datasource/src/main/java/io/seata/rm/datasource/exec/BaseInsertExecutor.java\n#\trm-datasource/src/test/java/io/seata/rm/datasource/exec/BatchInsertExecutorTest.java\n#\trm-datasource/src/test/java/io/seata/rm/datasource/exec/MySQLInsertExecutorTest.java\n#\trm-datasource/src/test/java/io/seata/rm/datasource/exec/OracleInsertExecutorTest.java", "committedDate": "2020-07-03T10:54:15Z", "type": "commit"}, {"oid": "3cd2c1ea7bd6755c3311e0303bbd34fe8935e166", "url": "https://github.com/seata/seata/commit/3cd2c1ea7bd6755c3311e0303bbd34fe8935e166", "message": "fix test case", "committedDate": "2020-07-07T04:56:51Z", "type": "commit"}, {"oid": "79fda430c59eb193c789b5bb1312f068010df03e", "url": "https://github.com/seata/seata/commit/79fda430c59eb193c789b5bb1312f068010df03e", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-07-08T09:31:20Z", "type": "commit"}, {"oid": "1a1d3cd315474d30a6561c839fbeb3c6a66eab89", "url": "https://github.com/seata/seata/commit/1a1d3cd315474d30a6561c839fbeb3c6a66eab89", "message": "Merge branch 'develop' into fix_sysdate", "committedDate": "2020-07-08T10:13:53Z", "type": "commit"}]}