{"pr_number": 8644, "pr_title": "Delete plugin settings on a successful migration of the plugin settings to cluster profile. (#8643)", "pr_createdAt": "2020-10-12T06:42:51Z", "pr_url": "https://github.com/gocd/gocd/pull/8644", "timeline": [{"oid": "f6ec004661c929c6646ed671083a18699a501431", "url": "https://github.com/gocd/gocd/commit/f6ec004661c929c6646ed671083a18699a501431", "message": "Delete plugin settings on a successful migration of the plugin settings to cluster profile. (#8643)\n\n* Do not delete the plugin settings when the migrate-config call fails.\n* Do not delete the plugin settings when the elastic agent plugin implements\n  elastic agent extension v4, which relies on plugin settings.\n* Delete the plugin settings when the plugin successfully migrates the\n  plugin settings to cluster profile and the plugin implements elastic\n  agent extension v5 or above, which does not rely on plugin settings.", "committedDate": "2020-10-12T06:41:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzExOTY0MQ==", "url": "https://github.com/gocd/gocd/pull/8644#discussion_r503119641", "bodyText": "Done migrating elastic agent configurations for plugin with id: '{}'", "author": "maheshp", "createdAt": "2020-10-12T08:21:22Z", "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentInformationMigratorImpl.java", "diffHunk": "@@ -68,12 +73,29 @@ private boolean migrate(GoPluginDescriptor pluginDescriptor) {\n             return true;\n         }\n \n+        LOG.debug(\"Migrating elastic agent information for {} plugin\", pluginId);\n         Plugin plugin = pluginSqlMapDao.findPlugin(pluginId);\n         String pluginConfiguration = plugin.getConfiguration();\n         HashMap<String, String> pluginSettings = (pluginConfiguration == null) ? new HashMap<>() : JsonHelper.fromJson(pluginConfiguration, HashMap.class);\n         ReplaceElasticAgentInformationCommand command = new ReplaceElasticAgentInformationCommand(clusterProfilesService, elasticProfileService, elasticAgentExtension, pluginDescriptor, pluginSettings);\n \n-        return update(command, pluginDescriptor);\n+        boolean updated = update(command, pluginDescriptor);\n+\n+        if (updated) {\n+            LOG.debug(\"Done Migrating elastic agent information for {} plugin\", pluginId);", "originalCommit": "f6ec004661c929c6646ed671083a18699a501431", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEyMzY3MQ==", "url": "https://github.com/gocd/gocd/pull/8644#discussion_r503123671", "bodyText": "Probably this should be logged as error in the update  method catch block.", "author": "maheshp", "createdAt": "2020-10-12T08:27:42Z", "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentInformationMigratorImpl.java", "diffHunk": "@@ -68,12 +73,29 @@ private boolean migrate(GoPluginDescriptor pluginDescriptor) {\n             return true;\n         }\n \n+        LOG.debug(\"Migrating elastic agent information for {} plugin\", pluginId);\n         Plugin plugin = pluginSqlMapDao.findPlugin(pluginId);\n         String pluginConfiguration = plugin.getConfiguration();\n         HashMap<String, String> pluginSettings = (pluginConfiguration == null) ? new HashMap<>() : JsonHelper.fromJson(pluginConfiguration, HashMap.class);\n         ReplaceElasticAgentInformationCommand command = new ReplaceElasticAgentInformationCommand(clusterProfilesService, elasticProfileService, elasticAgentExtension, pluginDescriptor, pluginSettings);\n \n-        return update(command, pluginDescriptor);\n+        boolean updated = update(command, pluginDescriptor);\n+\n+        if (updated) {\n+            LOG.debug(\"Done Migrating elastic agent information for {} plugin\", pluginId);\n+\n+            // all the plugins implementing elastic agent extension v5, does not use plugin settings and hence delete them after successful migration\n+            if (!pluginManager.resolveExtensionVersion(pluginId, ELASTIC_AGENT_EXTENSION, ElasticAgentExtension.SUPPORTED_VERSIONS).equals(ElasticAgentExtensionV4.VERSION)) {\n+                LOG.debug(\"Deleting stale plugin settings for {} plugin, after successful plugin config migration\", pluginId);\n+                pluginSqlMapDao.deletePluginIfExists(pluginId);\n+            } else {\n+                LOG.debug(\"Skip deleting plugin settings for {} plugin, as the plugin implements elastic agent v4 extension which uses plugin settings\", pluginId);\n+            }\n+        } else {\n+            LOG.debug(\"Failed migrating elastic agent information for {} plugin\", pluginId);", "originalCommit": "f6ec004661c929c6646ed671083a18699a501431", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEyNjM1Nw==", "url": "https://github.com/gocd/gocd/pull/8644#discussion_r503126357", "bodyText": "Couldn't we just do sessionFactory.getCurrentSession().delete(plugin);", "author": "maheshp", "createdAt": "2020-10-12T08:31:51Z", "path": "server/src/main/java/com/thoughtworks/go/server/dao/PluginSqlMapDao.java", "diffHunk": "@@ -113,4 +113,23 @@ protected void doInTransactionWithoutResult(TransactionStatus status) {\n             }\n         });\n     }\n+\n+    @Override\n+    public void deletePluginIfExists(String pluginId) {\n+        String cacheKey = cacheKeyForPluginSettings(pluginId);\n+        Plugin plugin = this.findPlugin(pluginId);\n+\n+        if (plugin instanceof NullPlugin) {\n+            return;\n+        }\n+\n+        synchronized (cacheKey) {\n+            transactionTemplate.execute((TransactionCallback) transactionStatus -> sessionFactory.getCurrentSession()\n+                    .createQuery(String.format(\"delete from %s where pluginId=:pluginId\", Plugin.class.getSimpleName()))", "originalCommit": "f6ec004661c929c6646ed671083a18699a501431", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4ODI5OA==", "url": "https://github.com/gocd/gocd/pull/8644#discussion_r503188298", "bodyText": "transactionTemplate.execute method expects a return value and sessionFactory.getCurrentSession().delete returns a void. This requires adding a new execute method which supports void return type.", "author": "GaneshSPatil", "createdAt": "2020-10-12T10:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEyNjM1Nw=="}], "type": "inlineReview"}, {"oid": "4cb4f9e8725c1cca250516e87ce86b23b766d466", "url": "https://github.com/gocd/gocd/commit/4cb4f9e8725c1cca250516e87ce86b23b766d466", "message": "Fix comments\n\n* Improve debug logs.\n* Print error log under catch block, when the migrate config plugin call fails.\n* Use 'sessionFactory.getCurrentSession().delete' instead of hbl query.\n* Implement double check for the synchronized block.", "committedDate": "2020-10-12T10:20:48Z", "type": "commit"}, {"oid": "4cb4f9e8725c1cca250516e87ce86b23b766d466", "url": "https://github.com/gocd/gocd/commit/4cb4f9e8725c1cca250516e87ce86b23b766d466", "message": "Fix comments\n\n* Improve debug logs.\n* Print error log under catch block, when the migrate config plugin call fails.\n* Use 'sessionFactory.getCurrentSession().delete' instead of hbl query.\n* Implement double check for the synchronized block.", "committedDate": "2020-10-12T10:20:48Z", "type": "forcePushed"}]}