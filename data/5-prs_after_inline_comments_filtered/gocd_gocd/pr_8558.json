{"pr_number": 8558, "pr_title": "Add support for secrets in package configurations", "pr_createdAt": "2020-09-15T10:26:34Z", "pr_url": "https://github.com/gocd/gocd/pull/8558", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MTk0Mg==", "url": "https://github.com/gocd/gocd/pull/8558#discussion_r489281942", "bodyText": "The logic for hasSecretParams and getSecretParams is repeated across classes. Is it ok to move it to Configuration class?", "author": "maheshp", "createdAt": "2020-09-16T09:05:01Z", "path": "config/config-api/src/main/java/com/thoughtworks/go/domain/packagerepository/PackageDefinition.java", "diffHunk": "@@ -326,4 +322,22 @@ public void ensureIdExists() {\n             setId(UUID.randomUUID().toString());\n         }\n     }\n+\n+    @Override\n+    public boolean hasSecretParams() {\n+        return this.getRepository().hasSecretParams()\n+                || this.getConfiguration()\n+                .stream()\n+                .anyMatch(ConfigurationProperty::hasSecretParams);", "originalCommit": "39539749221bad60568e7934783d5c565b2b7108", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwMDE5NA==", "url": "https://github.com/gocd/gocd/pull/8558#discussion_r489300194", "bodyText": "Map<CaseInsensitiveString, StringBuilder> errors = new HashMap<>();", "author": "maheshp", "createdAt": "2020-09-16T09:33:11Z", "path": "server/src/main/java/com/thoughtworks/go/server/service/RulesService.java", "diffHunk": "@@ -136,24 +143,22 @@ private void addError(Map<CaseInsensitiveString, StringBuilder> pipelinesWithErr\n         pipelinesWithErrors.put(pipelineName, stringBuilder);\n     }\n \n-    @NotNull\n-    private HashMap<CaseInsensitiveString, StringBuilder> validate(SCM scmConfig) {\n-        String scmConfigName = scmConfig.getName();\n+    private String errorString(Map<CaseInsensitiveString, StringBuilder> errors) {\n+        return join(errors.values(), '\\n').trim();\n+    }\n+\n+    protected Map<CaseInsensitiveString, StringBuilder> validate(SecretParams secretParams, Class<? extends Validatable> entityClass, String entityName, String entityNameOrErrorMessagePrefix) {\n         HashMap<CaseInsensitiveString, StringBuilder> pipelinesWithErrors = new HashMap<>();", "originalCommit": "b6f7e94fa8d5f121155f183ac4e50e56d11b1dd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "60ef3c990a9d57ecfb04ca20a27afa5f8924e25f", "url": "https://github.com/gocd/gocd/commit/60ef3c990a9d57ecfb04ca20a27afa5f8924e25f", "message": "Update secrets management spa to support package repository as entity type for rules", "committedDate": "2020-09-16T09:59:55Z", "type": "forcePushed"}, {"oid": "8690aee2a3138e0305ffb9b4f9bba8d8603f4477", "url": "https://github.com/gocd/gocd/commit/8690aee2a3138e0305ffb9b4f9bba8d8603f4477", "message": "Update secrets management spa to support package repository as entity type for rules", "committedDate": "2020-09-18T04:55:07Z", "type": "forcePushed"}, {"oid": "9594f440bde7f593432844b23d053c822c801284", "url": "https://github.com/gocd/gocd/commit/9594f440bde7f593432844b23d053c822c801284", "message": "Don't send secrets in package material as part of build assignment\nResolve secrets for package material as part of build work\nFor Package Repo And Def operations, check if RulesViolationException is raised while saving. If yes, then return 422 else 500\nSet error message on the modal itself for package operations", "committedDate": "2020-09-18T08:55:58Z", "type": "forcePushed"}, {"oid": "aa82e7d41e2b12e633d24e6e7b84f9c64828ebf9", "url": "https://github.com/gocd/gocd/commit/aa82e7d41e2b12e633d24e6e7b84f9c64828ebf9", "message": "Make PackageRepository, PackageDefinition and PackageMaterial SecretAware", "committedDate": "2020-09-18T09:42:32Z", "type": "commit"}, {"oid": "7887f858d2a78ac1f5bb5ca097f237024e9709af", "url": "https://github.com/gocd/gocd/commit/7887f858d2a78ac1f5bb5ca097f237024e9709af", "message": "Support secrets for package materials\n - Validate secrets in package materials wrt to rules for `package_repository`\n - resolve rules for mdu and before sending the values to the plugin", "committedDate": "2020-09-18T09:42:32Z", "type": "commit"}, {"oid": "07512a307cfe96078978f8028e7ad2ccf3dbd3fc", "url": "https://github.com/gocd/gocd/commit/07512a307cfe96078978f8028e7ad2ccf3dbd3fc", "message": "Validate and resolve secrets for\n - check connection of package repo and package def\n - isValid call for package repo and package def", "committedDate": "2020-09-18T09:42:32Z", "type": "commit"}, {"oid": "7185cd1f9c0071079bea82949b203202911404e7", "url": "https://github.com/gocd/gocd/commit/7185cd1f9c0071079bea82949b203202911404e7", "message": "Update secrets management spa to support package repository as entity type for rules", "committedDate": "2020-09-18T09:42:32Z", "type": "commit"}, {"oid": "7d81c34207343b8e7d68a98633f4c54ac42d5f44", "url": "https://github.com/gocd/gocd/commit/7d81c34207343b8e7d68a98633f4c54ac42d5f44", "message": "Don't send secrets in package material as part of build assignment\nResolve secrets for package material as part of build work\nFor Package Repo And Def operations, check if RulesViolationException or Secret resolution fails is raised while saving. If yes, then return 422 else 500\n - Same for check connection call as well\nSet error message on the modal itself for package operations", "committedDate": "2020-09-18T09:42:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1NDE3NQ==", "url": "https://github.com/gocd/gocd/pull/8558#discussion_r490854175", "bodyText": "Don't log this error.", "author": "maheshp", "createdAt": "2020-09-18T10:29:42Z", "path": "server/src/main/java/com/thoughtworks/go/server/service/materials/PackageDefinitionService.java", "diffHunk": "@@ -138,6 +145,9 @@ private void update(Username username, PackageDefinition packageDeinition, HttpL\n         } catch (Exception e) {\n             if (e instanceof GoConfigInvalidException && !result.hasMessage()) {\n                 result.unprocessableEntity(entityConfigValidationFailed(packageDeinition.getClass().getAnnotation(ConfigTag.class).value(), packageDeinition.getId(), e.getMessage()));\n+            } else if (e instanceof RulesViolationException || e instanceof SecretResolutionFailureException) {\n+                LOGGER.error(e.getMessage(), e);", "originalCommit": "7d81c34207343b8e7d68a98633f4c54ac42d5f44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1NDYyOA==", "url": "https://github.com/gocd/gocd/pull/8558#discussion_r490854628", "bodyText": "Don't log this error.", "author": "maheshp", "createdAt": "2020-09-18T10:30:39Z", "path": "server/src/main/java/com/thoughtworks/go/server/service/materials/PackageRepositoryService.java", "diffHunk": "@@ -173,6 +176,9 @@ private void update(Username username, HttpLocalizedOperationResult result, Enti\n         } catch (Exception e) {\n             if (e instanceof GoConfigInvalidException && !result.hasMessage()) {\n                 result.unprocessableEntity(entityConfigValidationFailed(repository.getClass().getAnnotation(ConfigTag.class).value(), repository.getId(), e.getMessage()));\n+            } else if (e instanceof RulesViolationException || e instanceof SecretResolutionFailureException) {\n+                LOGGER.error(e.getMessage(), e);", "originalCommit": "7d81c34207343b8e7d68a98633f4c54ac42d5f44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c7651f88fd8c76b9b34faf08e730bcae42ea811d", "url": "https://github.com/gocd/gocd/commit/c7651f88fd8c76b9b34faf08e730bcae42ea811d", "message": "Don't send secrets in package material as part of build assignment\nResolve secrets for package material as part of build work\nFor Package Repo And Def operations, check if RulesViolationException or Secret resolution fails is raised while saving. If yes, then return 422 else 500\n - Same for check connection call as well\nSet error message on the modal itself for package operations", "committedDate": "2020-09-18T10:34:29Z", "type": "commit"}, {"oid": "c7651f88fd8c76b9b34faf08e730bcae42ea811d", "url": "https://github.com/gocd/gocd/commit/c7651f88fd8c76b9b34faf08e730bcae42ea811d", "message": "Don't send secrets in package material as part of build assignment\nResolve secrets for package material as part of build work\nFor Package Repo And Def operations, check if RulesViolationException or Secret resolution fails is raised while saving. If yes, then return 422 else 500\n - Same for check connection call as well\nSet error message on the modal itself for package operations", "committedDate": "2020-09-18T10:34:29Z", "type": "forcePushed"}]}