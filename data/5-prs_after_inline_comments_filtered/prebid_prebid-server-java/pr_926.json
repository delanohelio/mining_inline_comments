{"pr_number": 926, "pr_title": "Strip eids of certain type", "pr_createdAt": "2020-09-24T10:18:40Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/926", "timeline": [{"oid": "30ccf9e53305b7cb3429ed742bea1b49c496e552", "url": "https://github.com/prebid/prebid-server-java/commit/30ccf9e53305b7cb3429ed742bea1b49c496e552", "message": "Strip eids of certain type", "committedDate": "2020-09-24T10:17:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIwOTA1MA==", "url": "https://github.com/prebid/prebid-server-java/pull/926#discussion_r494209050", "bodyText": "Minor. Pls fix typo-case for ppuid.", "author": "rpanchyk", "createdAt": "2020-09-24T10:32:39Z", "path": "src/test/java/org/prebid/server/bidder/rubicon/RubiconBidderTest.java", "diffHunk": "@@ -774,14 +774,99 @@ public void makeHttpRequestsShouldCreateUserExtTpIdWithAdServerEidSource() {\n                                         \"adserver.org\",\n                                         null,\n                                         singletonList(ExtUserEidUid.of(\"adServerUid\", null,\n-                                                ExtUserEidUidExt.of(\"TDID\"))),\n+                                                ExtUserEidUidExt.of(\"TDID\", null))),\n                                         null)))\n                                 .build(),\n                         RubiconUserExt.builder()\n                                 .tpid(singletonList(ExtUserTpIdRubicon.of(\"tdid\", \"adServerUid\")))\n                                 .build()));\n     }\n \n+    @Test\n+    public void makeHttpRequestsShouldCreateUseIdIfMissingFromFirstUidStypePpuid() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(builder -> builder.user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .eids(singletonList(ExtUserEid.of(null, null,\n+                                        asList(\n+                                                ExtUserEidUid.of(\"id1\", null, ExtUserEidUidExt.of(null, \"other\")),\n+                                                ExtUserEidUid.of(\"id2\", null, ExtUserEidUidExt.of(null, \"ppuid\")),\n+                                                ExtUserEidUid.of(\"id3\", null, ExtUserEidUidExt.of(null, \"ppuid\"))),\n+                                        null)))\n+                                .build())\n+                        .build()),\n+                builder -> builder.video(Video.builder().build()), identity());\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = rubiconBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1).doesNotContainNull()\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .extracting(request -> request.getUser().getId())\n+                .containsOnly(\"id2\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotCreateUseIdIfMissingWhenNoUidWithppiudType() {", "originalCommit": "30ccf9e53305b7cb3429ed742bea1b49c496e552", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIxMDI4Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/926#discussion_r494210283", "bodyText": "Pls rename to hasStypeToRemove(..)", "author": "rpanchyk", "createdAt": "2020-09-24T10:34:58Z", "path": "src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java", "diffHunk": "@@ -709,13 +722,74 @@ private User makeUser(User user, ExtImpRubicon rubiconImpExt) {\n         final User.UserBuilder userBuilder = user != null ? user.toBuilder() : User.builder();\n \n         return userBuilder\n+                .id(resolvedId)\n                 .gender(null)\n                 .yob(null)\n                 .geo(null)\n                 .ext(mapper.fillExtension(userExt, rubiconUserExt))\n                 .build();\n     }\n \n+    private String resolveUserId(User user) {\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final List<ExtUserEid> extUserEids = extUser != null ? extUser.getEids() : null;\n+        return CollectionUtils.emptyIfNull(extUserEids)\n+                .stream()\n+                .map(extUserEid -> getIdFromFirstUuidWithStypePpuid(extUserEid.getUids()))\n+                .filter(Objects::nonNull)\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    private String getIdFromFirstUuidWithStypePpuid(List<ExtUserEidUid> extUserEidUids) {\n+        return CollectionUtils.emptyIfNull(extUserEidUids).stream()\n+                .filter(Objects::nonNull)\n+                .filter(extUserEidUid -> Objects.equals(PPUID_STYPE, getUserEidUidStype(extUserEidUid)))\n+                .map(ExtUserEidUid::getId)\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    private String getUserEidUidStype(ExtUserEidUid extUserEidUid) {\n+        final ExtUserEidUidExt extUserEidUidExt = extUserEidUid.getExt();\n+        return extUserEidUidExt != null ? extUserEidUidExt.getStype() : null;\n+    }\n+\n+    private boolean isHasStypeToRemove(List<ExtUserEid> extUserEids) {", "originalCommit": "30ccf9e53305b7cb3429ed742bea1b49c496e552", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIxMTI0Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/926#discussion_r494211242", "bodyText": "May we pass ExtUser as an argument here instead of whole User object?", "author": "rpanchyk", "createdAt": "2020-09-24T10:36:39Z", "path": "src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java", "diffHunk": "@@ -709,13 +722,74 @@ private User makeUser(User user, ExtImpRubicon rubiconImpExt) {\n         final User.UserBuilder userBuilder = user != null ? user.toBuilder() : User.builder();\n \n         return userBuilder\n+                .id(resolvedId)\n                 .gender(null)\n                 .yob(null)\n                 .geo(null)\n                 .ext(mapper.fillExtension(userExt, rubiconUserExt))\n                 .build();\n     }\n \n+    private String resolveUserId(User user) {", "originalCommit": "30ccf9e53305b7cb3429ed742bea1b49c496e552", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6def448393a0d037cd8bf740817c9e5caab8277b", "url": "https://github.com/prebid/prebid-server-java/commit/6def448393a0d037cd8bf740817c9e5caab8277b", "message": "Fix typos and other pull request comments", "committedDate": "2020-09-24T10:46:53Z", "type": "commit"}]}