{"pr_number": 711, "pr_title": "Conversant adapter bug for apps", "pr_createdAt": "2020-05-07T14:17:27Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/711", "timeline": [{"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c", "url": "https://github.com/prebid/prebid-server-java/commit/ce3d0d0128ca8aa311833ac08a83552095bddb3c", "message": "sync from go version", "committedDate": "2020-05-07T14:14:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2MjEwMQ==", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r421662101", "bodyText": "app id", "author": "DGarbar", "createdAt": "2020-05-07T17:11:43Z", "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -119,38 +118,49 @@ private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> err\n         if (modifiedImps.isEmpty()) {\n             throw new PreBidException(\"No valid impressions\");\n         }\n+        validateSiteAppId(extSiteId, bidRequest.getSite(), bidRequest.getApp());\n \n         final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder()\n                 .imp(modifiedImps);\n \n         if (site != null) {\n-            requestBuilder.site(site.toBuilder().id(extSiteId).mobile(extMobile).build());\n+            if (StringUtils.isEmpty(site.getId()) || extMobile != null) {\n+                final String siteId = ObjectUtils.defaultIfNull(site.getId(), extSiteId);\n+                requestBuilder.site(site.toBuilder().id(siteId).mobile(extMobile).build());\n+            }\n         } else if (app != null) {\n-            requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            if (StringUtils.isEmpty(app.getId())) {\n+                requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            }\n         }\n \n         return requestBuilder.build();\n     }\n \n+    private void validateSiteAppId(String extSiteId, Site site, App app) {\n+        if (site != null && StringUtils.isEmpty(site.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");\n+        }\n+\n+        if (app != null && StringUtils.isEmpty(app.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");", "originalCommit": "ce3d0d0128ca8aa311833ac08a83552095bddb3c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxNzM4NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r422017385", "bodyText": "We can use declared site & app vars.", "author": "rpanchyk", "createdAt": "2020-05-08T08:30:24Z", "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -119,38 +118,49 @@ private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> err\n         if (modifiedImps.isEmpty()) {\n             throw new PreBidException(\"No valid impressions\");\n         }\n+        validateSiteAppId(extSiteId, bidRequest.getSite(), bidRequest.getApp());", "originalCommit": "ce3d0d0128ca8aa311833ac08a83552095bddb3c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxNzkxOA==", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r422017918", "bodyText": "No need for separate variable here.", "author": "rpanchyk", "createdAt": "2020-05-08T08:31:35Z", "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -119,38 +118,49 @@ private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> err\n         if (modifiedImps.isEmpty()) {\n             throw new PreBidException(\"No valid impressions\");\n         }\n+        validateSiteAppId(extSiteId, bidRequest.getSite(), bidRequest.getApp());\n \n         final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder()\n                 .imp(modifiedImps);\n \n         if (site != null) {\n-            requestBuilder.site(site.toBuilder().id(extSiteId).mobile(extMobile).build());\n+            if (StringUtils.isEmpty(site.getId()) || extMobile != null) {\n+                final String siteId = ObjectUtils.defaultIfNull(site.getId(), extSiteId);\n+                requestBuilder.site(site.toBuilder().id(siteId).mobile(extMobile).build());\n+            }\n         } else if (app != null) {\n-            requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            if (StringUtils.isEmpty(app.getId())) {\n+                requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            }\n         }\n \n         return requestBuilder.build();\n     }\n \n+    private void validateSiteAppId(String extSiteId, Site site, App app) {\n+        if (site != null && StringUtils.isEmpty(site.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");\n+        }\n+\n+        if (app != null && StringUtils.isEmpty(app.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");\n+        }\n+    }\n+\n     private static void validateImp(Imp imp) {\n         if (imp.getBanner() == null && imp.getVideo() == null) {\n             throw new PreBidException(String.format(\"Invalid MediaType. Conversant supports only Banner and Video. \"\n                     + \"Ignoring ImpID=%s\", imp.getId()));\n         }\n     }\n \n-    private ExtImpConversant parseAndValidateImpExt(Imp imp, boolean hasSite) {\n+    private ExtImpConversant parseImpExt(Imp imp) {\n         final ExtImpConversant extImpConversant;", "originalCommit": "ce3d0d0128ca8aa311833ac08a83552095bddb3c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyMDg2MA==", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r422020860", "bodyText": "This and app variable can be declared right before validateSiteAppId(...) method, since they are used further.", "author": "rpanchyk", "createdAt": "2020-05-08T08:38:06Z", "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -93,22 +94,20 @@ public ConversantBidder(String endpointUrl, JacksonMapper mapper) {\n     }\n \n     private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> errors) {\n-        final App app = bidRequest.getApp();\n-        if (app != null && StringUtils.isBlank(app.getId())) {\n-            throw new PreBidException(\"Missing app id\");\n-        }\n-\n         final List<Imp> modifiedImps = new ArrayList<>();\n         Integer extMobile = null;\n         String extSiteId = null;\n         final Site site = bidRequest.getSite();", "originalCommit": "ce3d0d0128ca8aa311833ac08a83552095bddb3c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9cc2802dd4eb13568d2a2476925715ebd67d2174", "url": "https://github.com/prebid/prebid-server-java/commit/9cc2802dd4eb13568d2a2476925715ebd67d2174", "message": "PR fix", "committedDate": "2020-05-12T08:27:30Z", "type": "commit"}, {"oid": "09815bb2aa92b9a1795f572cd5ae6a8e91849ade", "url": "https://github.com/prebid/prebid-server-java/commit/09815bb2aa92b9a1795f572cd5ae6a8e91849ade", "message": "Merge branch 'master' into conversant-app-bug-fix", "committedDate": "2020-07-16T14:28:58Z", "type": "commit"}, {"oid": "240e251dc8d23f2328c32000edd00707f78ef825", "url": "https://github.com/prebid/prebid-server-java/commit/240e251dc8d23f2328c32000edd00707f78ef825", "message": "Merge branch 'master' into conversant-app-bug-fix", "committedDate": "2020-07-16T14:39:19Z", "type": "commit"}]}