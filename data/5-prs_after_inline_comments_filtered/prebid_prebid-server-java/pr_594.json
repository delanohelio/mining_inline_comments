{"pr_number": 594, "pr_title": "Add CPMStar bidder", "pr_createdAt": "2020-01-20T14:39:32Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/594", "timeline": [{"oid": "0a3727ecf224f6d40282c4cd14b7086f9aec6a8e", "url": "https://github.com/prebid/prebid-server-java/commit/0a3727ecf224f6d40282c4cd14b7086f9aec6a8e", "message": "CPMStar Bidder\n-basic files added", "committedDate": "2020-01-17T15:25:26Z", "type": "commit"}, {"oid": "16ba5932083dbd6447b3aff544b33a0fdf5312d6", "url": "https://github.com/prebid/prebid-server-java/commit/16ba5932083dbd6447b3aff544b33a0fdf5312d6", "message": "Fixed minor code style issues", "committedDate": "2020-01-20T12:23:14Z", "type": "commit"}, {"oid": "fa28d2ec973b807be4c20be09060db49551a3a59", "url": "https://github.com/prebid/prebid-server-java/commit/fa28d2ec973b807be4c20be09060db49551a3a59", "message": "CPMStar Bidder\n-bidder logic added\n-Tests added", "committedDate": "2020-01-20T14:33:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA3ODQ5OA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369078498", "bodyText": "Change to CpmStarBidder", "author": "DGarbar", "createdAt": "2020-01-21T15:44:03Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA4MTUyNw==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369081527", "bodyText": "Please, change all *CPM* to *Cpm*", "author": "DGarbar", "createdAt": "2020-01-21T15:48:44Z", "path": "src/main/java/org/prebid/server/proto/openrtb/ext/request/cpmstar/ExtImpCPMStar.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package org.prebid.server.proto.openrtb.ext.request.cpmstar;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+@AllArgsConstructor(staticName = \"of\")\n+@Value\n+public class ExtImpCPMStar {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA4MzY5OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369083699", "bodyText": "Check RequestValidator#validate method. Unlike Go, we have some validation for all openrtb2 requests.\nThis check is redundant.", "author": "DGarbar", "createdAt": "2020-01-21T15:52:09Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA4NjI2Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369086263", "bodyText": "We don't have any obligation for usage of final keyword in for. (But I prefer keep it clean)", "author": "DGarbar", "createdAt": "2020-01-21T15:55:57Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            throw new IllegalArgumentException(\"No Imps in Bid Request\");\n+        }\n+\n+        final List<Imp> validImpList = new ArrayList<>();\n+        for (final Imp imp : bidRequest.getImp()) {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEwNDI4Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369104282", "bodyText": "See Result.emptyWithError", "author": "DGarbar", "createdAt": "2020-01-21T16:25:21Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTExMDEyNA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369110124", "bodyText": "Json.mapper.convertValue can produce IllegalArgumentException.\nCatch it and throw PrebidException (see RhythmoneBidder#parseAndValidateImpExt) for example.", "author": "DGarbar", "createdAt": "2020-01-21T16:34:44Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            throw new IllegalArgumentException(\"No Imps in Bid Request\");\n+        }\n+\n+        final List<Imp> validImpList = new ArrayList<>();\n+        for (final Imp imp : bidRequest.getImp()) {\n+            try {\n+                validImpList.add(parseAndValidateImp(imp));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return bidRequest.toBuilder().imp(validImpList).build();\n+    }\n+\n+    private Imp parseAndValidateImp(Imp imp) {\n+        if (imp.getBanner() == null && imp.getVideo() == null) {\n+            throw new PreBidException(\"Only Banner and Video bid-types are supported at this time\");\n+        }\n+\n+        final ExtPrebid<?, ExtImpCPMStar> ext =\n+                Json.mapper.convertValue(imp.getExt(), CPM_STAR_EXT_TYPE_REFERENCE);", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTExMTE2MA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369111160", "bodyText": "Please, change variable name to 'impExt'.\nNow this is not a problem, but then, a new field may be added with ext (extension)", "author": "DGarbar", "createdAt": "2020-01-21T16:36:27Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            throw new IllegalArgumentException(\"No Imps in Bid Request\");\n+        }\n+\n+        final List<Imp> validImpList = new ArrayList<>();\n+        for (final Imp imp : bidRequest.getImp()) {\n+            try {\n+                validImpList.add(parseAndValidateImp(imp));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return bidRequest.toBuilder().imp(validImpList).build();\n+    }\n+\n+    private Imp parseAndValidateImp(Imp imp) {\n+        if (imp.getBanner() == null && imp.getVideo() == null) {\n+            throw new PreBidException(\"Only Banner and Video bid-types are supported at this time\");\n+        }\n+\n+        final ExtPrebid<?, ExtImpCPMStar> ext =", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTExNzMzNw==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369117337", "bodyText": "They insert ext.bidder to ext. You just check for null and rewrite same data.", "author": "DGarbar", "createdAt": "2020-01-21T16:46:44Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            throw new IllegalArgumentException(\"No Imps in Bid Request\");\n+        }\n+\n+        final List<Imp> validImpList = new ArrayList<>();\n+        for (final Imp imp : bidRequest.getImp()) {\n+            try {\n+                validImpList.add(parseAndValidateImp(imp));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return bidRequest.toBuilder().imp(validImpList).build();\n+    }\n+\n+    private Imp parseAndValidateImp(Imp imp) {\n+        if (imp.getBanner() == null && imp.getVideo() == null) {\n+            throw new PreBidException(\"Only Banner and Video bid-types are supported at this time\");\n+        }\n+\n+        final ExtPrebid<?, ExtImpCPMStar> ext =\n+                Json.mapper.convertValue(imp.getExt(), CPM_STAR_EXT_TYPE_REFERENCE);\n+\n+        final ExtImpCPMStar bidder = ext.getBidder();\n+        if (bidder == null) {\n+            throw new PreBidException(String.format(\"imp id=%s: bidder.ext is null\", imp.getId()));\n+        }\n+        return imp.toBuilder().ext(Json.mapper.valueToTree(ext)).build();", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTExODkyNA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369118924", "bodyText": "This method do too much.\nParse + Validate + CreateImp.\nI suggesting just returning ExtImpCPMStar and perform validation.", "author": "DGarbar", "createdAt": "2020-01-21T16:49:27Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            throw new IllegalArgumentException(\"No Imps in Bid Request\");\n+        }\n+\n+        final List<Imp> validImpList = new ArrayList<>();\n+        for (final Imp imp : bidRequest.getImp()) {\n+            try {\n+                validImpList.add(parseAndValidateImp(imp));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return bidRequest.toBuilder().imp(validImpList).build();\n+    }\n+\n+    private Imp parseAndValidateImp(Imp imp) {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEyMDE2OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369120169", "bodyText": "This can be inlined in makeHttpRequests", "author": "DGarbar", "createdAt": "2020-01-21T16:51:33Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            throw new IllegalArgumentException(\"No Imps in Bid Request\");\n+        }\n+\n+        final List<Imp> validImpList = new ArrayList<>();\n+        for (final Imp imp : bidRequest.getImp()) {\n+            try {\n+                validImpList.add(parseAndValidateImp(imp));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return bidRequest.toBuilder().imp(validImpList).build();\n+    }\n+\n+    private Imp parseAndValidateImp(Imp imp) {\n+        if (imp.getBanner() == null && imp.getVideo() == null) {\n+            throw new PreBidException(\"Only Banner and Video bid-types are supported at this time\");\n+        }\n+\n+        final ExtPrebid<?, ExtImpCPMStar> ext =\n+                Json.mapper.convertValue(imp.getExt(), CPM_STAR_EXT_TYPE_REFERENCE);\n+\n+        final ExtImpCPMStar bidder = ext.getBidder();\n+        if (bidder == null) {\n+            throw new PreBidException(String.format(\"imp id=%s: bidder.ext is null\", imp.getId()));\n+        }\n+        return imp.toBuilder().ext(Json.mapper.valueToTree(ext)).build();\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(BidRequest request) {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEyNDYwNw==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369124607", "bodyText": "Usually, they gather all exception, and pass mutable list through methods; this is the only way to preserve this logic.\nBut keep in mind, that it is bad approach.", "author": "DGarbar", "createdAt": "2020-01-21T16:58:54Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEyNTU0OA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369125548", "bodyText": "In go, they do not collect all exception (but some bidder does). They return the first comer, so you can simply throw Excpetion and catch it above.", "author": "DGarbar", "createdAt": "2020-01-21T17:00:26Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            throw new IllegalArgumentException(\"No Imps in Bid Request\");\n+        }\n+\n+        final List<Imp> validImpList = new ArrayList<>();\n+        for (final Imp imp : bidRequest.getImp()) {\n+            try {\n+                validImpList.add(parseAndValidateImp(imp));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEyOTkxMg==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369129912", "bodyText": "Be consistent with Go messages and Exception Type.\nerrortypes.BadServerResponse{\n\t\t\t\t\tMessage: fmt.Sprintf(\"bid id='%s' could not find valid impid='%s'\", bid.ID, bid.ImpID),", "author": "DGarbar", "createdAt": "2020-01-21T17:08:28Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            throw new IllegalArgumentException(\"No Imps in Bid Request\");\n+        }\n+\n+        final List<Imp> validImpList = new ArrayList<>();\n+        for (final Imp imp : bidRequest.getImp()) {\n+            try {\n+                validImpList.add(parseAndValidateImp(imp));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return bidRequest.toBuilder().imp(validImpList).build();\n+    }\n+\n+    private Imp parseAndValidateImp(Imp imp) {\n+        if (imp.getBanner() == null && imp.getVideo() == null) {\n+            throw new PreBidException(\"Only Banner and Video bid-types are supported at this time\");\n+        }\n+\n+        final ExtPrebid<?, ExtImpCPMStar> ext =\n+                Json.mapper.convertValue(imp.getExt(), CPM_STAR_EXT_TYPE_REFERENCE);\n+\n+        final ExtImpCPMStar bidder = ext.getBidder();\n+        if (bidder == null) {\n+            throw new PreBidException(String.format(\"imp id=%s: bidder.ext is null\", imp.getId()));\n+        }\n+        return imp.toBuilder().ext(Json.mapper.valueToTree(ext)).build();\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(BidRequest request) {\n+\n+        final String body = Json.encode(request);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(endpointUrl)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(request)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        if (httpCall.getResponse().getStatusCode() == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        }\n+\n+        try {\n+            final BidResponse bidResponse = Json.decodeValue(httpCall.getResponse().getBody(), BidResponse.class);\n+            return extractBids(httpCall.getRequest().getPayload(), bidResponse);\n+        } catch (DecodeException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+    }\n+\n+    private Result<List<BidderBid>> extractBids(BidRequest request, BidResponse bidResponse) {\n+        if (bidResponse == null || bidResponse.getSeatbid() == null) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        }\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<BidderBid> bidderBids = bidResponse.getSeatbid().stream()\n+                .filter(Objects::nonNull)\n+                .map(SeatBid::getBid)\n+                .filter(Objects::nonNull)\n+                .flatMap(Collection::stream)\n+                .map(bid -> bidFromResponse(request.getImp(), bid, errors))\n+                .filter(Objects::nonNull)\n+                .collect(Collectors.toList());\n+        return Result.of(bidderBids, errors);\n+    }\n+\n+    private static BidderBid bidFromResponse(List<Imp> imps, Bid bid, List<BidderError> errors) {\n+        try {\n+            final BidType bidType = getBidType(bid.getImpid(), imps);\n+            return BidderBid.of(bid, bidType, DEFAULT_BID_CURRENCY);\n+        } catch (PreBidException e) {\n+            errors.add(BidderError.badInput(e.getMessage()));", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEzNDkxNQ==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369134915", "bodyText": "Rename to resolveBidType\nWe don't use get*", "author": "DGarbar", "createdAt": "2020-01-21T17:18:24Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            throw new IllegalArgumentException(\"No Imps in Bid Request\");\n+        }\n+\n+        final List<Imp> validImpList = new ArrayList<>();\n+        for (final Imp imp : bidRequest.getImp()) {\n+            try {\n+                validImpList.add(parseAndValidateImp(imp));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return bidRequest.toBuilder().imp(validImpList).build();\n+    }\n+\n+    private Imp parseAndValidateImp(Imp imp) {\n+        if (imp.getBanner() == null && imp.getVideo() == null) {\n+            throw new PreBidException(\"Only Banner and Video bid-types are supported at this time\");\n+        }\n+\n+        final ExtPrebid<?, ExtImpCPMStar> ext =\n+                Json.mapper.convertValue(imp.getExt(), CPM_STAR_EXT_TYPE_REFERENCE);\n+\n+        final ExtImpCPMStar bidder = ext.getBidder();\n+        if (bidder == null) {\n+            throw new PreBidException(String.format(\"imp id=%s: bidder.ext is null\", imp.getId()));\n+        }\n+        return imp.toBuilder().ext(Json.mapper.valueToTree(ext)).build();\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(BidRequest request) {\n+\n+        final String body = Json.encode(request);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(endpointUrl)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(request)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        if (httpCall.getResponse().getStatusCode() == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        }\n+\n+        try {\n+            final BidResponse bidResponse = Json.decodeValue(httpCall.getResponse().getBody(), BidResponse.class);\n+            return extractBids(httpCall.getRequest().getPayload(), bidResponse);\n+        } catch (DecodeException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+    }\n+\n+    private Result<List<BidderBid>> extractBids(BidRequest request, BidResponse bidResponse) {\n+        if (bidResponse == null || bidResponse.getSeatbid() == null) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        }\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<BidderBid> bidderBids = bidResponse.getSeatbid().stream()\n+                .filter(Objects::nonNull)\n+                .map(SeatBid::getBid)\n+                .filter(Objects::nonNull)\n+                .flatMap(Collection::stream)\n+                .map(bid -> bidFromResponse(request.getImp(), bid, errors))\n+                .filter(Objects::nonNull)\n+                .collect(Collectors.toList());\n+        return Result.of(bidderBids, errors);\n+    }\n+\n+    private static BidderBid bidFromResponse(List<Imp> imps, Bid bid, List<BidderError> errors) {\n+        try {\n+            final BidType bidType = getBidType(bid.getImpid(), imps);\n+            return BidderBid.of(bid, bidType, DEFAULT_BID_CURRENCY);\n+        } catch (PreBidException e) {\n+            errors.add(BidderError.badInput(e.getMessage()));\n+            return null;\n+        }\n+    }\n+\n+    private static BidType getBidType(String impId, List<Imp> imps) {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEzODU1MA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369138550", "bodyText": "I know that we have similar logic in another bidders, but I would rewrite something like that\n    private Result<List<BidderBid>> extractBids(BidRequest request, BidResponse bidResponse) {\n        if (bidResponse == null || bidResponse.getSeatbid() == null) {\n            return Result.of(Collections.emptyList(), Collections.emptyList());\n        }\n        final List<Bid> responseBids = bidResponse.getSeatbid().stream()\n                .filter(Objects::nonNull)\n                .map(SeatBid::getBid)\n                .filter(Objects::nonNull)\n                .flatMap(Collection::stream)\n                .collect(Collectors.toList());\n\n        final List<BidderError> errors = new ArrayList<>();\n        return Result.of(bidsFromResponse(request.getImp(), responseBids, errors), errors);\n    }\n\n    private static List<BidderBid> bidsFromResponse(List<Imp> imps, List<Bid> responseBids, List<BidderError> errors) {\n        final List<BidderBid> bidderBids = new ArrayList<>();\n        for (Bid responseBid : responseBids) {\n            try {\n                final BidType bidType = resolveBidType(responseBid.getImpid(), imps);\n                bidderBids.add(BidderBid.of(responseBid, bidType, DEFAULT_BID_CURRENCY));\n            } catch (PreBidException e) {\n                errors.add(BidderError.badInput(e.getMessage()));\n            }\n        }\n        return bidderBids;\n    }\n\nJust to get rid of return null (looks to me like GO \ud83d\udca9)", "author": "DGarbar", "createdAt": "2020-01-21T17:25:28Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CPMStarBidder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.DecodeException;\n+import io.vertx.core.json.Json;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class CPMStarBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+\n+    public CPMStarBidder(String endpointUrl) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        try {\n+            final BidRequest bidRequest = processRequest(request, errors);\n+\n+            return Result.of(Collections.singletonList(createSingleRequest(bidRequest)), errors);\n+        } catch (IllegalArgumentException e) {\n+            return Result.of(Collections.emptyList(),\n+                    Collections.singletonList(BidderError.badInput(e.getMessage()))\n+            );\n+        }\n+    }\n+\n+    private BidRequest processRequest(BidRequest bidRequest, List<BidderError> errors) {\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            throw new IllegalArgumentException(\"No Imps in Bid Request\");\n+        }\n+\n+        final List<Imp> validImpList = new ArrayList<>();\n+        for (final Imp imp : bidRequest.getImp()) {\n+            try {\n+                validImpList.add(parseAndValidateImp(imp));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return bidRequest.toBuilder().imp(validImpList).build();\n+    }\n+\n+    private Imp parseAndValidateImp(Imp imp) {\n+        if (imp.getBanner() == null && imp.getVideo() == null) {\n+            throw new PreBidException(\"Only Banner and Video bid-types are supported at this time\");\n+        }\n+\n+        final ExtPrebid<?, ExtImpCPMStar> ext =\n+                Json.mapper.convertValue(imp.getExt(), CPM_STAR_EXT_TYPE_REFERENCE);\n+\n+        final ExtImpCPMStar bidder = ext.getBidder();\n+        if (bidder == null) {\n+            throw new PreBidException(String.format(\"imp id=%s: bidder.ext is null\", imp.getId()));\n+        }\n+        return imp.toBuilder().ext(Json.mapper.valueToTree(ext)).build();\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(BidRequest request) {\n+\n+        final String body = Json.encode(request);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(endpointUrl)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(request)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        if (httpCall.getResponse().getStatusCode() == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        }\n+\n+        try {\n+            final BidResponse bidResponse = Json.decodeValue(httpCall.getResponse().getBody(), BidResponse.class);\n+            return extractBids(httpCall.getRequest().getPayload(), bidResponse);\n+        } catch (DecodeException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+    }\n+\n+    private Result<List<BidderBid>> extractBids(BidRequest request, BidResponse bidResponse) {\n+        if (bidResponse == null || bidResponse.getSeatbid() == null) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        }\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<BidderBid> bidderBids = bidResponse.getSeatbid().stream()\n+                .filter(Objects::nonNull)\n+                .map(SeatBid::getBid)\n+                .filter(Objects::nonNull)\n+                .flatMap(Collection::stream)\n+                .map(bid -> bidFromResponse(request.getImp(), bid, errors))\n+                .filter(Objects::nonNull)\n+                .collect(Collectors.toList());\n+        return Result.of(bidderBids, errors);\n+    }\n+\n+    private static BidderBid bidFromResponse(List<Imp> imps, Bid bid, List<BidderError> errors) {\n+        try {\n+            final BidType bidType = getBidType(bid.getImpid(), imps);\n+            return BidderBid.of(bid, bidType, DEFAULT_BID_CURRENCY);\n+        } catch (PreBidException e) {\n+            errors.add(BidderError.badInput(e.getMessage()));\n+            return null;", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0MTYwMA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369141600", "bodyText": "probably subPoolId is more clearer", "author": "DGarbar", "createdAt": "2020-01-21T17:31:42Z", "path": "src/main/java/org/prebid/server/proto/openrtb/ext/request/cpmstar/ExtImpCPMStar.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package org.prebid.server.proto.openrtb.ext.request.cpmstar;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+@AllArgsConstructor(staticName = \"of\")\n+@Value\n+public class ExtImpCPMStar {\n+\n+    @JsonProperty(\"placementId\")\n+    Integer placementId;\n+\n+    @JsonProperty(\"subpoolId\")\n+    Integer subpoolId;", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0MzA2Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369143067", "bodyText": "final", "author": "DGarbar", "createdAt": "2020-01-21T17:35:00Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0MzUzMA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369143530", "bodyText": "take out and name it appropriate to make more cleaner", "author": "DGarbar", "createdAt": "2020-01-21T17:35:54Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(\n+                impBuilder -> impBuilder\n+                        .banner(null)\n+                        .id(\"2\")\n+                        .ext(mapper.valueToTree(ext))\n+                        .banner(Banner.builder().w(300).h(400).build())\n+        );\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(asList(\n+                        imp,\n+                        givenImp(impBuilder -> impBuilder", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0Mzk2Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369143967", "bodyText": "You write two times to .banner", "author": "DGarbar", "createdAt": "2020-01-21T17:36:53Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(\n+                impBuilder -> impBuilder\n+                        .banner(null)", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0NDU3OA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369144578", "bodyText": "pull .ext on second line", "author": "DGarbar", "createdAt": "2020-01-21T17:38:12Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(\n+                impBuilder -> impBuilder\n+                        .banner(null)\n+                        .id(\"2\")\n+                        .ext(mapper.valueToTree(ext))\n+                        .banner(Banner.builder().w(300).h(400).build())\n+        );\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(asList(\n+                        imp,\n+                        givenImp(impBuilder -> impBuilder\n+                                .banner(null)\n+                                .id(\"2\")\n+                                .ext(mapper.valueToTree(ext))\n+                                .audio(Audio.builder().build()))))\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\n+                        \"Only Banner and Video bid-types are supported at this time\"));\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .containsOnly(imp);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotChangeBannerWidthAndHeightIfPresent() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .w(200)\n+                                .h(150)\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .extracting(Imp::getBanner)\n+                .extracting(Banner::getW, Banner::getH)\n+                .containsOnly(tuple(200, 150));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Failed to decode: Unrecognized token\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyListIfBidResponseIsNull() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null,\n+                mapper.writeValueAsString(null));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfNotSupportedBidType() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"123\").audio(Audio.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfDiffId() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"12\").video(Video.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnVideoBidIfVideoIsPresentInRequestImp() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"12\").video(Video.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyListIfBidResponseSeatBidIsNull() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null,\n+                mapper.writeValueAsString(BidResponse.builder().build()));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnBannerBidIfBannerIsPresentInRequestImp() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(\n+                BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"123\").banner(Banner.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue())\n+                .containsOnly(BidderBid.of(Bid.builder().impid(\"123\").build(), banner, \"USD\"));\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnNativeBidIfNativeIsPresentInRequestImp() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(\n+                BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"123\").banner(Banner.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue())\n+                .containsOnly(BidderBid.of(Bid.builder().impid(\"123\").build(), banner, \"USD\"));\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyResultWhenResponseWithNoContent() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = HttpCall\n+                .success(null, HttpResponse.of(204, null, null), null);\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void extractTargetingShouldReturnEmptyMap() {\n+        assertThat(cpmStarBidder.extractTargeting(mapper.createObjectNode())).isEqualTo(emptyMap());\n+    }\n+\n+    private static BidRequest givenBidRequest(\n+            Function<BidRequest.BidRequestBuilder, BidRequest.BidRequestBuilder> bidRequestCustomizer,\n+            Function<Imp.ImpBuilder, Imp.ImpBuilder> impCustomizer) {\n+\n+        return bidRequestCustomizer.apply(BidRequest.builder()\n+                .imp(singletonList(givenImp(impCustomizer))))\n+                .build();\n+    }\n+\n+    private static BidRequest givenBidRequest(Function<Imp.ImpBuilder, Imp.ImpBuilder> impCustomizer) {\n+        return givenBidRequest(identity(), impCustomizer);\n+    }\n+\n+    private static Imp givenImp(Function<Imp.ImpBuilder, Imp.ImpBuilder> impCustomizer) {\n+        return impCustomizer.apply(Imp.builder()\n+                .id(\"123\")\n+                .banner(Banner.builder().id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0NTM3MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369145371", "bodyText": "take out  bidCustomizer.apply(Bid.builder()).build() to make it more readable", "author": "DGarbar", "createdAt": "2020-01-21T17:39:57Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(\n+                impBuilder -> impBuilder\n+                        .banner(null)\n+                        .id(\"2\")\n+                        .ext(mapper.valueToTree(ext))\n+                        .banner(Banner.builder().w(300).h(400).build())\n+        );\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(asList(\n+                        imp,\n+                        givenImp(impBuilder -> impBuilder\n+                                .banner(null)\n+                                .id(\"2\")\n+                                .ext(mapper.valueToTree(ext))\n+                                .audio(Audio.builder().build()))))\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\n+                        \"Only Banner and Video bid-types are supported at this time\"));\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .containsOnly(imp);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotChangeBannerWidthAndHeightIfPresent() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .w(200)\n+                                .h(150)\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .extracting(Imp::getBanner)\n+                .extracting(Banner::getW, Banner::getH)\n+                .containsOnly(tuple(200, 150));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Failed to decode: Unrecognized token\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyListIfBidResponseIsNull() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null,\n+                mapper.writeValueAsString(null));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfNotSupportedBidType() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"123\").audio(Audio.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfDiffId() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"12\").video(Video.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnVideoBidIfVideoIsPresentInRequestImp() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"12\").video(Video.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyListIfBidResponseSeatBidIsNull() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null,\n+                mapper.writeValueAsString(BidResponse.builder().build()));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnBannerBidIfBannerIsPresentInRequestImp() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(\n+                BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"123\").banner(Banner.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue())\n+                .containsOnly(BidderBid.of(Bid.builder().impid(\"123\").build(), banner, \"USD\"));\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnNativeBidIfNativeIsPresentInRequestImp() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(\n+                BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"123\").banner(Banner.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue())\n+                .containsOnly(BidderBid.of(Bid.builder().impid(\"123\").build(), banner, \"USD\"));\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyResultWhenResponseWithNoContent() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = HttpCall\n+                .success(null, HttpResponse.of(204, null, null), null);\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void extractTargetingShouldReturnEmptyMap() {\n+        assertThat(cpmStarBidder.extractTargeting(mapper.createObjectNode())).isEqualTo(emptyMap());\n+    }\n+\n+    private static BidRequest givenBidRequest(\n+            Function<BidRequest.BidRequestBuilder, BidRequest.BidRequestBuilder> bidRequestCustomizer,\n+            Function<Imp.ImpBuilder, Imp.ImpBuilder> impCustomizer) {\n+\n+        return bidRequestCustomizer.apply(BidRequest.builder()\n+                .imp(singletonList(givenImp(impCustomizer))))\n+                .build();\n+    }\n+\n+    private static BidRequest givenBidRequest(Function<Imp.ImpBuilder, Imp.ImpBuilder> impCustomizer) {\n+        return givenBidRequest(identity(), impCustomizer);\n+    }\n+\n+    private static Imp givenImp(Function<Imp.ImpBuilder, Imp.ImpBuilder> impCustomizer) {\n+        return impCustomizer.apply(Imp.builder()\n+                .id(\"123\")\n+                .banner(Banner.builder().id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                        ExtImpCPMStar.of(12, 123)))))\n+                .build();\n+    }\n+\n+    private static BidResponse givenBidResponse(Function<Bid.BidBuilder, Bid.BidBuilder> bidCustomizer) {\n+        return BidResponse.builder()\n+                .seatbid(singletonList(SeatBid.builder().bid(singletonList(bidCustomizer.apply(Bid.builder()).build()))", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0NjQxMQ==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369146411", "bodyText": "In go, this test will fail.\nwe receive only first exception message", "author": "DGarbar", "createdAt": "2020-01-21T17:42:08Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0NzYwOQ==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369147609", "bodyText": "This test is redundant. (We don't have any logic which concerns width and height in bidder)", "author": "DGarbar", "createdAt": "2020-01-21T17:44:36Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(\n+                impBuilder -> impBuilder\n+                        .banner(null)\n+                        .id(\"2\")\n+                        .ext(mapper.valueToTree(ext))\n+                        .banner(Banner.builder().w(300).h(400).build())\n+        );\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(asList(\n+                        imp,\n+                        givenImp(impBuilder -> impBuilder\n+                                .banner(null)\n+                                .id(\"2\")\n+                                .ext(mapper.valueToTree(ext))\n+                                .audio(Audio.builder().build()))))\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\n+                        \"Only Banner and Video bid-types are supported at this time\"));\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .containsOnly(imp);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotChangeBannerWidthAndHeightIfPresent() {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0Nzk2Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369147966", "bodyText": "This test is redundant. (We don't have any logic which concerns this)", "author": "DGarbar", "createdAt": "2020-01-21T17:45:20Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(\n+                impBuilder -> impBuilder\n+                        .banner(null)\n+                        .id(\"2\")\n+                        .ext(mapper.valueToTree(ext))\n+                        .banner(Banner.builder().w(300).h(400).build())\n+        );\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(asList(\n+                        imp,\n+                        givenImp(impBuilder -> impBuilder\n+                                .banner(null)\n+                                .id(\"2\")\n+                                .ext(mapper.valueToTree(ext))\n+                                .audio(Audio.builder().build()))))\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\n+                        \"Only Banner and Video bid-types are supported at this time\"));\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .containsOnly(imp);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotChangeBannerWidthAndHeightIfPresent() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .w(200)\n+                                .h(150)\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .extracting(Imp::getBanner)\n+                .extracting(Banner::getW, Banner::getH)\n+                .containsOnly(tuple(200, 150));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE1MDA1Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369150056", "bodyText": "makeBidsShouldReturnErrorWhenBidHaveNotSupportedBidType", "author": "DGarbar", "createdAt": "2020-01-21T17:49:51Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(\n+                impBuilder -> impBuilder\n+                        .banner(null)\n+                        .id(\"2\")\n+                        .ext(mapper.valueToTree(ext))\n+                        .banner(Banner.builder().w(300).h(400).build())\n+        );\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(asList(\n+                        imp,\n+                        givenImp(impBuilder -> impBuilder\n+                                .banner(null)\n+                                .id(\"2\")\n+                                .ext(mapper.valueToTree(ext))\n+                                .audio(Audio.builder().build()))))\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\n+                        \"Only Banner and Video bid-types are supported at this time\"));\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .containsOnly(imp);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotChangeBannerWidthAndHeightIfPresent() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .w(200)\n+                                .h(150)\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .extracting(Imp::getBanner)\n+                .extracting(Banner::getW, Banner::getH)\n+                .containsOnly(tuple(200, 150));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Failed to decode: Unrecognized token\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyListIfBidResponseIsNull() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null,\n+                mapper.writeValueAsString(null));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfNotSupportedBidType() throws JsonProcessingException {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE1MDY1OA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369150658", "bodyText": "makeBidsShouldReturnErrorWhenNoCorrespondingId", "author": "DGarbar", "createdAt": "2020-01-21T17:51:05Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(\n+                impBuilder -> impBuilder\n+                        .banner(null)\n+                        .id(\"2\")\n+                        .ext(mapper.valueToTree(ext))\n+                        .banner(Banner.builder().w(300).h(400).build())\n+        );\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(asList(\n+                        imp,\n+                        givenImp(impBuilder -> impBuilder\n+                                .banner(null)\n+                                .id(\"2\")\n+                                .ext(mapper.valueToTree(ext))\n+                                .audio(Audio.builder().build()))))\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\n+                        \"Only Banner and Video bid-types are supported at this time\"));\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .containsOnly(imp);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotChangeBannerWidthAndHeightIfPresent() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .w(200)\n+                                .h(150)\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .extracting(Imp::getBanner)\n+                .extracting(Banner::getW, Banner::getH)\n+                .containsOnly(tuple(200, 150));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Failed to decode: Unrecognized token\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyListIfBidResponseIsNull() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null,\n+                mapper.writeValueAsString(null));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfNotSupportedBidType() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"123\").audio(Audio.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfDiffId() throws JsonProcessingException {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE1MTM0OA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369151348", "bodyText": "absolutely identical to makeBidsShouldReturnErrorWithUnknownBidTypeIfDiffId", "author": "DGarbar", "createdAt": "2020-01-21T17:52:30Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(\n+                impBuilder -> impBuilder\n+                        .banner(null)\n+                        .id(\"2\")\n+                        .ext(mapper.valueToTree(ext))\n+                        .banner(Banner.builder().w(300).h(400).build())\n+        );\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(asList(\n+                        imp,\n+                        givenImp(impBuilder -> impBuilder\n+                                .banner(null)\n+                                .id(\"2\")\n+                                .ext(mapper.valueToTree(ext))\n+                                .audio(Audio.builder().build()))))\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\n+                        \"Only Banner and Video bid-types are supported at this time\"));\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .containsOnly(imp);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotChangeBannerWidthAndHeightIfPresent() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .w(200)\n+                                .h(150)\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .extracting(Imp::getBanner)\n+                .extracting(Banner::getW, Banner::getH)\n+                .containsOnly(tuple(200, 150));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Failed to decode: Unrecognized token\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyListIfBidResponseIsNull() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null,\n+                mapper.writeValueAsString(null));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfNotSupportedBidType() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"123\").audio(Audio.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfDiffId() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"12\").video(Video.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnVideoBidIfVideoIsPresentInRequestImp() throws JsonProcessingException {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE1MjA1NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369152055", "bodyText": "absolutely identical tomakeBidsShouldReturnNativeBidIfNativeIsPresentInRequestImp\nChange one to test for Video, or multiple mismatch ids", "author": "DGarbar", "createdAt": "2020-01-21T17:54:03Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CPMStarBidderTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package org.prebid.server.bidder.cpmstar;\n+\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Audio;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.cpmstar.ExtImpCPMStar;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+\n+public class CPMStarBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private CPMStarBidder cpmStarBidder;\n+\n+    @Before\n+    public void setUp() {\n+        cpmStarBidder = new CPMStarBidder(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new CPMStarBidder(\"invalid_url\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n+        // given\n+        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n+        Imp imp = givenImp(\n+                impBuilder -> impBuilder\n+                        .banner(null)\n+                        .id(\"2\")\n+                        .ext(mapper.valueToTree(ext))\n+                        .banner(Banner.builder().w(300).h(400).build())\n+        );\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(asList(\n+                        imp,\n+                        givenImp(impBuilder -> impBuilder\n+                                .banner(null)\n+                                .id(\"2\")\n+                                .ext(mapper.valueToTree(ext))\n+                                .audio(Audio.builder().build()))))\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\n+                        \"Only Banner and Video bid-types are supported at this time\"));\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .containsOnly(imp);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotChangeBannerWidthAndHeightIfPresent() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .w(200)\n+                                .h(150)\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .extracting(Imp::getBanner)\n+                .extracting(Banner::getW, Banner::getH)\n+                .containsOnly(tuple(200, 150));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = cpmStarBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Failed to decode: Unrecognized token\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyListIfBidResponseIsNull() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null,\n+                mapper.writeValueAsString(null));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfNotSupportedBidType() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"123\").audio(Audio.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfDiffId() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"12\").video(Video.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnVideoBidIfVideoIsPresentInRequestImp() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(BidRequest.builder()\n+                        .imp(singletonList(Imp.builder().id(\"12\").video(Video.builder().build()).build()))\n+                        .build(),\n+                mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyListIfBidResponseSeatBidIsNull() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null,\n+                mapper.writeValueAsString(BidResponse.builder().build()));\n+\n+        // when\n+        final Result<List<BidderBid>> result = cpmStarBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnBannerBidIfBannerIsPresentInRequestImp() throws JsonProcessingException {", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE1Mzc5OA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369153798", "bodyText": "Encode in Base64 corresponding bidder", "author": "DGarbar", "createdAt": "2020-01-21T17:57:18Z", "path": "src/test/java/org/prebid/server/it/CPMStarTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package org.prebid.server.it;\n+\n+import io.restassured.response.Response;\n+import org.json.JSONException;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+import org.skyscreamer.jsonassert.JSONCompareMode;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import java.io.IOException;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalTo;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToJson;\n+import static com.github.tomakehurst.wiremock.client.WireMock.post;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlPathEqualTo;\n+import static io.restassured.RestAssured.given;\n+import static java.util.Collections.singletonList;\n+\n+@RunWith(SpringRunner.class)\n+public class CPMStarTest extends IntegrationTest {\n+\n+    @Test\n+    public void openrtb2AuctionShouldRespondWithBidsFromCPMStar() throws IOException, JSONException {\n+        // given\n+        // Cpmstar bid response\n+        wireMockRule.stubFor(post(urlPathEqualTo(\"/cpmstar-exchange\"))\n+                .withHeader(\"Accept\", equalTo(\"application/json\"))\n+                .withHeader(\"Content-Type\", equalTo(\"application/json;charset=UTF-8\"))\n+                .withRequestBody(equalToJson(jsonFrom(\"openrtb2/cpmstar/test-cpmstar-bid-request-1.json\")))\n+                .willReturn(aResponse().withBody(jsonFrom(\"openrtb2/cpmstar/test-cpmstar-bid-response-1.json\"))));\n+\n+        // pre-bid cache\n+        wireMockRule.stubFor(post(urlPathEqualTo(\"/cache\"))\n+                .withRequestBody(equalToJson(jsonFrom(\"openrtb2/cpmstar/test-cache-cpmstar-request.json\")))\n+                .willReturn(aResponse().withBody(jsonFrom(\"openrtb2/cpmstar/test-cache-cpmstar-response.json\"))));\n+\n+        // when\n+        final Response response = given(spec)\n+                .header(\"Referer\", \"http://www.example.com\")\n+                .header(\"X-Forwarded-For\", \"193.168.244.1\")\n+                .header(\"User-Agent\", \"userAgent\")\n+                .header(\"Origin\", \"http://www.example.com\")\n+                .cookie(\"uids\", \"eyJ1aWRzIjp7ImdhbW9zaGkiOiJHTS1VSUQifX0=\")", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE1NDE3NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369154175", "bodyText": "remove", "author": "DGarbar", "createdAt": "2020-01-21T17:58:02Z", "path": "src/test/java/org/prebid/server/it/CPMStarTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package org.prebid.server.it;\n+\n+import io.restassured.response.Response;\n+import org.json.JSONException;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+import org.skyscreamer.jsonassert.JSONCompareMode;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import java.io.IOException;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalTo;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToJson;\n+import static com.github.tomakehurst.wiremock.client.WireMock.post;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlPathEqualTo;\n+import static io.restassured.RestAssured.given;\n+import static java.util.Collections.singletonList;\n+\n+@RunWith(SpringRunner.class)\n+public class CPMStarTest extends IntegrationTest {\n+\n+    @Test\n+    public void openrtb2AuctionShouldRespondWithBidsFromCPMStar() throws IOException, JSONException {\n+        // given\n+        // Cpmstar bid response\n+        wireMockRule.stubFor(post(urlPathEqualTo(\"/cpmstar-exchange\"))\n+                .withHeader(\"Accept\", equalTo(\"application/json\"))\n+                .withHeader(\"Content-Type\", equalTo(\"application/json;charset=UTF-8\"))\n+                .withRequestBody(equalToJson(jsonFrom(\"openrtb2/cpmstar/test-cpmstar-bid-request-1.json\")))\n+                .willReturn(aResponse().withBody(jsonFrom(\"openrtb2/cpmstar/test-cpmstar-bid-response-1.json\"))));\n+\n+        // pre-bid cache\n+        wireMockRule.stubFor(post(urlPathEqualTo(\"/cache\"))\n+                .withRequestBody(equalToJson(jsonFrom(\"openrtb2/cpmstar/test-cache-cpmstar-request.json\")))\n+                .willReturn(aResponse().withBody(jsonFrom(\"openrtb2/cpmstar/test-cache-cpmstar-response.json\"))));\n+\n+        // when\n+        final Response response = given(spec)\n+                .header(\"Referer\", \"http://www.example.com\")\n+                .header(\"X-Forwarded-For\", \"193.168.244.1\")\n+                .header(\"User-Agent\", \"userAgent\")\n+                .header(\"Origin\", \"http://www.example.com\")\n+                .cookie(\"uids\", \"eyJ1aWRzIjp7ImdhbW9zaGkiOiJHTS1VSUQifX0=\")\n+                .body(jsonFrom(\"openrtb2/cpmstar/test-auction-cpmstar-request.json\"))\n+                .post(\"/openrtb2/auction\");\n+\n+        // then\n+        final String expectedAuctionResponse = openrtbAuctionResponseFrom(\n+                \"openrtb2/cpmstar/test-auction-cpmstar-response.json\",\n+                response, singletonList(\"cpmstar\"));\n+\n+", "originalCommit": "fa28d2ec973b807be4c20be09060db49551a3a59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "96eb5e59675241e42389a574d83f4e16c5ae6357", "url": "https://github.com/prebid/prebid-server-java/commit/96eb5e59675241e42389a574d83f4e16c5ae6357", "message": "CpmStar Bidder, functional issues fixed, code cleanup, tests fix", "committedDate": "2020-01-22T10:11:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ4NzM0NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369487345", "bodyText": "You don't need that variable now", "author": "DGarbar", "createdAt": "2020-01-22T10:44:12Z", "path": "src/main/java/org/prebid/server/bidder/cpmstar/CpmStarBidder.java", "diffHunk": "@@ -32,76 +31,66 @@\n import java.util.Objects;\n import java.util.stream.Collectors;\n \n-public class CPMStarBidder implements Bidder<BidRequest> {\n+public class CpmStarBidder implements Bidder<BidRequest> {\n \n-    private static final TypeReference<ExtPrebid<?, ExtImpCPMStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n-            new TypeReference<ExtPrebid<?, ExtImpCPMStar>>() {\n+    private static final TypeReference<ExtPrebid<?, ExtImpCpmStar>> CPM_STAR_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpCpmStar>>() {\n             };\n \n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n \n     private final String endpointUrl;\n \n-    public CPMStarBidder(String endpointUrl) {\n+    public CpmStarBidder(String endpointUrl) {\n         this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n     }\n \n     @Override\n     public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n         final List<BidderError> errors = new ArrayList<>();", "originalCommit": "96eb5e59675241e42389a574d83f4e16c5ae6357", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ5MDY2Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369490666", "bodyText": "make givenImp(impBuilder -> impBuilder to have style consistency", "author": "DGarbar", "createdAt": "2020-01-22T10:51:18Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CpmStarBidderTest.java", "diffHunk": "@@ -70,22 +70,22 @@ public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n     @Test\n     public void makeHttpRequestsShouldSkipInvalidImpressionAndAddError() {\n         // given\n-        ExtPrebid<?, ExtImpCPMStar> ext = ExtPrebid.of(null, ExtImpCPMStar.of(12, 132));\n-        Imp imp = givenImp(\n+        final ExtPrebid<?, ExtImpCpmStar> ext = ExtPrebid.of(null, ExtImpCpmStar.of(12, 132));\n+        final Imp bannerImp = givenImp(\n                 impBuilder -> impBuilder", "originalCommit": "96eb5e59675241e42389a574d83f4e16c5ae6357", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ5MTg4MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369491881", "bodyText": "Identical to makeBidsShouldReturnErrorWhenNoCorrespondingId", "author": "DGarbar", "createdAt": "2020-01-22T10:54:00Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CpmStarBidderTest.java", "diffHunk": "@@ -204,12 +159,12 @@ public void makeBidsShouldReturnErrorWithUnknownBidTypeIfDiffId() throws JsonPro\n \n         // then\n         assertThat(result.getErrors()).hasSize(1)\n-                .containsOnly(BidderError.badInput(\"Failed to find impression 123\"));\n+                .containsOnly(BidderError.badInput(\"bid id=null could not find valid impid=123\"));\n         assertThat(result.getValue()).isEmpty();\n     }\n \n     @Test\n-    public void makeBidsShouldReturnVideoBidIfVideoIsPresentInRequestImp() throws JsonProcessingException {\n+    public void makeBidsShouldReturnErrorWithUnknownBidTypeIfDiffId() throws JsonProcessingException {", "originalCommit": "96eb5e59675241e42389a574d83f4e16c5ae6357", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ5MjU0OA==", "url": "https://github.com/prebid/prebid-server-java/pull/594#discussion_r369492548", "bodyText": "Name method appropriately", "author": "DGarbar", "createdAt": "2020-01-22T10:55:32Z", "path": "src/test/java/org/prebid/server/bidder/cpmstar/CpmStarBidderTest.java", "diffHunk": "@@ -245,7 +200,7 @@ public void makeBidsShouldReturnBannerBidIfBannerIsPresentInRequestImp() throws\n         // given\n         final HttpCall<BidRequest> httpCall = givenHttpCall(\n                 BidRequest.builder()\n-                        .imp(singletonList(Imp.builder().id(\"123\").banner(Banner.builder().build()).build()))\n+                        .imp(singletonList(Imp.builder().id(\"123\").video(Video.builder().build()).build()))", "originalCommit": "96eb5e59675241e42389a574d83f4e16c5ae6357", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d431c099beb84f6051a96f927fe71aaa2a353be", "url": "https://github.com/prebid/prebid-server-java/commit/9d431c099beb84f6051a96f927fe71aaa2a353be", "message": "CpmStar Bidder code cleanup", "committedDate": "2020-01-22T11:07:07Z", "type": "commit"}, {"oid": "586d502140243b4a8cbd95595cba75750445137d", "url": "https://github.com/prebid/prebid-server-java/commit/586d502140243b4a8cbd95595cba75750445137d", "message": "Merge branch 'master' into CPMStar-bidder", "committedDate": "2020-01-24T14:33:12Z", "type": "commit"}, {"oid": "76d9bbdaf2717b18bdfa3a47c15bcadbbe20db13", "url": "https://github.com/prebid/prebid-server-java/commit/76d9bbdaf2717b18bdfa3a47c15bcadbbe20db13", "message": "Fix usersync url to use https", "committedDate": "2020-01-24T14:36:57Z", "type": "commit"}]}