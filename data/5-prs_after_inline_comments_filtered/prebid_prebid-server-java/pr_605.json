{"pr_number": 605, "pr_title": "Add Time condition to Conditional Logger", "pr_createdAt": "2020-02-04T08:02:17Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/605", "timeline": [{"oid": "1860af74825fbc2f22798e26780096f88c41ad97", "url": "https://github.com/prebid/prebid-server-java/commit/1860af74825fbc2f22798e26780096f88c41ad97", "message": "Remove Rewarded Video from Adapter", "committedDate": "2020-01-31T13:50:45Z", "type": "commit"}, {"oid": "aa744ba705f2517c5529a410602c2b12cefec108", "url": "https://github.com/prebid/prebid-server-java/commit/aa744ba705f2517c5529a410602c2b12cefec108", "message": "Metric increment test added", "committedDate": "2020-01-31T14:11:55Z", "type": "commit"}, {"oid": "5c2532fd2d747e7fcb0e75f7db262e73d1726e3c", "url": "https://github.com/prebid/prebid-server-java/commit/5c2532fd2d747e7fcb0e75f7db262e73d1726e3c", "message": "Logger Test added", "committedDate": "2020-02-03T07:29:11Z", "type": "commit"}, {"oid": "cf3658730df89528e608193fbc14b2f09c57f345", "url": "https://github.com/prebid/prebid-server-java/commit/cf3658730df89528e608193fbc14b2f09c57f345", "message": "Timeout logger added", "committedDate": "2020-02-03T15:03:53Z", "type": "commit"}, {"oid": "843b9b99bc062b8c7261e3317b43e636521faef9", "url": "https://github.com/prebid/prebid-server-java/commit/843b9b99bc062b8c7261e3317b43e636521faef9", "message": "ConditionalLogger added to CB", "committedDate": "2020-02-04T07:59:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM2NTIxNg==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r376365216", "bodyText": "final", "author": "DGarbar", "createdAt": "2020-02-07T12:27:00Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package org.prebid.server.log;\n+\n+import io.vertx.core.logging.Logger;\n+\n+import java.util.Date;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.function.Consumer;\n+\n+public class ConditionalLogger {\n+    private ConcurrentHashMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentHashMap<String, AtomicLong> messageToWait;\n+    private final Logger logger;\n+\n+    public ConditionalLogger(Logger logger) {\n+        this.logger = logger;\n+        this.messageToCount = new ConcurrentHashMap<>();\n+        this.messageToWait = new ConcurrentHashMap<>();\n+    }\n+\n+    public void info(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.info(message));\n+    }\n+\n+    public void info(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.info(message));\n+    }\n+\n+    public void error(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.error(message));\n+    }\n+\n+    public void error(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.error(message));\n+    }\n+\n+    public void debug(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.debug(message));\n+    }\n+\n+    public void debug(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.debug(message));\n+    }\n+\n+    public void warn(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.warn(message));\n+    }\n+\n+    public void warn(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.warn(message));\n+    }\n+\n+    public void log(String key, Integer maxValue, Consumer<Logger> onLog) {\n+        AtomicInteger currentValue = messageToCount.compute(", "originalCommit": "843b9b99bc062b8c7261e3317b43e636521faef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM2NTc5MA==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r376365790", "bodyText": "final", "author": "DGarbar", "createdAt": "2020-02-07T12:28:34Z", "path": "src/main/java/org/prebid/server/handler/openrtb2/AuctionHandler.java", "diffHunk": "@@ -154,12 +156,13 @@ private void handleResult(AsyncResult<Tuple2<BidResponse, AuctionContext>> respo\n             } else if (exception instanceof UnauthorizedAccountException) {\n                 metricRequestStatus = MetricName.badinput;\n                 final String errorMessage = exception.getMessage();\n-                logger.info(\"Unauthorized: {0}\", errorMessage);\n-\n+                CONDITIONAL_LOGGER.info(String.format(\"Unauthorized: %s\", errorMessage), 100);\n                 errorMessages = Collections.singletonList(errorMessage);\n \n                 status = HttpResponseStatus.UNAUTHORIZED.code();\n                 body = String.format(\"Unauthorised: %s\", errorMessage);\n+                String userId = ((UnauthorizedAccountException) exception).getUserId();", "originalCommit": "843b9b99bc062b8c7261e3317b43e636521faef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3MDY4Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r376370682", "bodyText": "What is the difference between RequestMetrics", "author": "DGarbar", "createdAt": "2020-02-07T12:41:48Z", "path": "src/main/java/org/prebid/server/metric/RequestsMetrics.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package org.prebid.server.metric;\n+\n+import com.codahale.metrics.MetricRegistry;\n+\n+import java.util.Objects;\n+import java.util.function.Function;\n+\n+public class RequestsMetrics extends UpdatableMetrics {", "originalCommit": "843b9b99bc062b8c7261e3317b43e636521faef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3NzE1Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r376377156", "bodyText": "I am not sure, if it is good idea, store all messages (strings) and AtomicInteger.\nI have concerns regarding of memory usage of this class, bc of all logs which will be never deleted.", "author": "DGarbar", "createdAt": "2020-02-07T12:59:22Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package org.prebid.server.log;\n+\n+import io.vertx.core.logging.Logger;\n+\n+import java.util.Date;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.function.Consumer;\n+\n+public class ConditionalLogger {\n+    private ConcurrentHashMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentHashMap<String, AtomicLong> messageToWait;", "originalCommit": "843b9b99bc062b8c7261e3317b43e636521faef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3ODkyNg==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r376378926", "bodyText": "Try to use Instant.ofEpochMilli() probably", "author": "DGarbar", "createdAt": "2020-02-07T13:04:03Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package org.prebid.server.log;\n+\n+import io.vertx.core.logging.Logger;\n+\n+import java.util.Date;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.function.Consumer;\n+\n+public class ConditionalLogger {\n+    private ConcurrentHashMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentHashMap<String, AtomicLong> messageToWait;\n+    private final Logger logger;\n+\n+    public ConditionalLogger(Logger logger) {\n+        this.logger = logger;\n+        this.messageToCount = new ConcurrentHashMap<>();\n+        this.messageToWait = new ConcurrentHashMap<>();\n+    }\n+\n+    public void info(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.info(message));\n+    }\n+\n+    public void info(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.info(message));\n+    }\n+\n+    public void error(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.error(message));\n+    }\n+\n+    public void error(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.error(message));\n+    }\n+\n+    public void debug(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.debug(message));\n+    }\n+\n+    public void debug(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.debug(message));\n+    }\n+\n+    public void warn(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.warn(message));\n+    }\n+\n+    public void warn(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.warn(message));\n+    }\n+\n+    public void log(String key, Integer maxValue, Consumer<Logger> onLog) {\n+        AtomicInteger currentValue = messageToCount.compute(\n+                key, (k, currentCounter) -> currentCounter != null ? currentCounter : new AtomicInteger(0)\n+        );\n+        if (currentValue.incrementAndGet() >= maxValue) {\n+            currentValue.set(0);\n+            onLog.accept(logger);\n+        }\n+    }\n+\n+    public void log(String key, long amount, TimeUnit unit, Consumer<Logger> onLog) {\n+        messageToWait.compute(key, (k, result) -> {\n+            if (result == null || currentTimeMillis() >= result.get()) {\n+                result = recalculateDate(amount, unit);\n+                onLog.accept(logger);\n+            }\n+            return result;\n+        });\n+    }\n+\n+    private AtomicLong recalculateDate(long amount, TimeUnit unit) {\n+        final long amountInMillis = unit.toMillis(amount);\n+        final Date result = new Date(currentTimeMillis() + amountInMillis);\n+        return new AtomicLong(result.getTime());", "originalCommit": "843b9b99bc062b8c7261e3317b43e636521faef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM4MDUzNA==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r376380534", "bodyText": "Not sure about AtomicLong usage here.\nYou don't change variable inside it, you recreating and replacing value in ConcurrentHashMap each time", "author": "DGarbar", "createdAt": "2020-02-07T13:08:35Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package org.prebid.server.log;\n+\n+import io.vertx.core.logging.Logger;\n+\n+import java.util.Date;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.function.Consumer;\n+\n+public class ConditionalLogger {\n+    private ConcurrentHashMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentHashMap<String, AtomicLong> messageToWait;\n+    private final Logger logger;\n+\n+    public ConditionalLogger(Logger logger) {\n+        this.logger = logger;\n+        this.messageToCount = new ConcurrentHashMap<>();\n+        this.messageToWait = new ConcurrentHashMap<>();\n+    }\n+\n+    public void info(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.info(message));\n+    }\n+\n+    public void info(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.info(message));\n+    }\n+\n+    public void error(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.error(message));\n+    }\n+\n+    public void error(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.error(message));\n+    }\n+\n+    public void debug(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.debug(message));\n+    }\n+\n+    public void debug(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.debug(message));\n+    }\n+\n+    public void warn(String message, Integer maxValue) {\n+        log(message, maxValue, logger -> logger.warn(message));\n+    }\n+\n+    public void warn(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.warn(message));\n+    }\n+\n+    public void log(String key, Integer maxValue, Consumer<Logger> onLog) {\n+        AtomicInteger currentValue = messageToCount.compute(\n+                key, (k, currentCounter) -> currentCounter != null ? currentCounter : new AtomicInteger(0)\n+        );\n+        if (currentValue.incrementAndGet() >= maxValue) {\n+            currentValue.set(0);\n+            onLog.accept(logger);\n+        }\n+    }\n+\n+    public void log(String key, long amount, TimeUnit unit, Consumer<Logger> onLog) {\n+        messageToWait.compute(key, (k, result) -> {\n+            if (result == null || currentTimeMillis() >= result.get()) {\n+                result = recalculateDate(amount, unit);\n+                onLog.accept(logger);\n+            }\n+            return result;\n+        });\n+    }\n+\n+    private AtomicLong recalculateDate(long amount, TimeUnit unit) {\n+        final long amountInMillis = unit.toMillis(amount);\n+        final Date result = new Date(currentTimeMillis() + amountInMillis);\n+        return new AtomicLong(result.getTime());", "originalCommit": "843b9b99bc062b8c7261e3317b43e636521faef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM4NDAwMA==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r376384000", "bodyText": "Is throws Exception necessary ?", "author": "DGarbar", "createdAt": "2020-02-07T13:17:30Z", "path": "src/test/java/org/prebid/server/log/ConditionalLoggerTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package org.prebid.server.log;\n+\n+import io.vertx.core.logging.Logger;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class ConditionalLoggerTest {\n+\n+    @Mock\n+    private Logger logger;\n+\n+    private ConditionalLogger conditionalLogger;\n+\n+    @Before\n+    public void setUp() throws Exception {", "originalCommit": "843b9b99bc062b8c7261e3317b43e636521faef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM4NDIzMg==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r376384232", "bodyText": "Change any() to \"Hello\"", "author": "DGarbar", "createdAt": "2020-02-07T13:18:04Z", "path": "src/test/java/org/prebid/server/log/ConditionalLoggerTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package org.prebid.server.log;\n+\n+import io.vertx.core.logging.Logger;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class ConditionalLoggerTest {\n+\n+    @Mock\n+    private Logger logger;\n+\n+    private ConditionalLogger conditionalLogger;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        conditionalLogger = new ConditionalLogger(logger);\n+    }\n+\n+    @Test\n+    public void log() {\n+        //when\n+        for (int i = 0; i < 100; i++) {\n+            conditionalLogger.info(\"Hello\", 20);\n+        }\n+        //then\n+        verify(logger, times(5)).info(any());", "originalCommit": "843b9b99bc062b8c7261e3317b43e636521faef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM4NDc4Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r376384786", "bodyText": "Update metrics.md", "author": "DGarbar", "createdAt": "2020-02-07T13:19:24Z", "path": "src/main/java/org/prebid/server/metric/MetricName.java", "diffHunk": "@@ -75,7 +75,10 @@\n \n     // cache\n     prebid_cache_request_success_time,\n-    prebid_cache_request_error_time;\n+    prebid_cache_request_error_time,\n+\n+    //account.*.requests.\n+    rejected;", "originalCommit": "843b9b99bc062b8c7261e3317b43e636521faef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4f93d91f152ce701e4dcd58ff25a7e8efa29e92d", "url": "https://github.com/prebid/prebid-server-java/commit/4f93d91f152ce701e4dcd58ff25a7e8efa29e92d", "message": "Merge branch 'master' into timeout-logger\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/AuctionRequestFactory.java\n#\tsrc/main/java/org/prebid/server/exception/UnauthorizedAccountException.java\n#\tsrc/main/java/org/prebid/server/handler/openrtb2/AmpHandler.java\n#\tsrc/main/java/org/prebid/server/handler/openrtb2/AuctionHandler.java\n#\tsrc/main/java/org/prebid/server/log/ConditionalLogger.java\n#\tsrc/main/java/org/prebid/server/metric/AccountMetrics.java\n#\tsrc/main/java/org/prebid/server/metric/Metrics.java\n#\tsrc/test/java/org/prebid/server/handler/openrtb2/AmpHandlerTest.java\n#\tsrc/test/java/org/prebid/server/handler/openrtb2/AuctionHandlerTest.java\n#\tsrc/test/java/org/prebid/server/log/ConditionalLoggerTest.java", "committedDate": "2020-02-07T16:04:24Z", "type": "commit"}, {"oid": "acc6559b666970a6c442cd76b2e7ecf3f888183b", "url": "https://github.com/prebid/prebid-server-java/commit/acc6559b666970a6c442cd76b2e7ecf3f888183b", "message": "CONDITIONAL_LOGGER -> conditionalLogger", "committedDate": "2020-02-07T16:20:21Z", "type": "commit"}, {"oid": "2c15cdef6a0bc65a89887ddc67ad187fce8c7839", "url": "https://github.com/prebid/prebid-server-java/commit/2c15cdef6a0bc65a89887ddc67ad187fce8c7839", "message": "minor fixes", "committedDate": "2020-02-07T18:58:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5NzE0Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r376697142", "bodyText": "Try to migrate from old Data to newer .time. library please", "author": "DGarbar", "createdAt": "2020-02-08T08:39:39Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -40,4 +62,25 @@ private void log(String key, Integer maxValue, Consumer<Logger> consumer) {\n             consumer.accept(logger);\n         }\n     }\n+\n+    public void log(String key, long amount, TimeUnit unit, Consumer<Logger> consumer) {\n+        messageToWait.compute(key, (currentKey, lastTimeMillis) -> {\n+            if (lastTimeMillis == null || currentTimeMillis() >= lastTimeMillis) {\n+                lastTimeMillis = recalculateDate(amount, unit);\n+                consumer.accept(logger);\n+            }\n+            return lastTimeMillis;\n+        });\n+    }\n+\n+    private long recalculateDate(long amount, TimeUnit unit) {\n+        final long amountInMillis = unit.toMillis(amount);\n+        Instant resultInstant = Instant.now().plusMillis(amountInMillis);\n+        return resultInstant.toEpochMilli();\n+    }\n+\n+    private long currentTimeMillis() {\n+        return new Date().getTime();", "originalCommit": "2c15cdef6a0bc65a89887ddc67ad187fce8c7839", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a4a88f9532a8e9d41925870ed7b429d26700605c", "url": "https://github.com/prebid/prebid-server-java/commit/a4a88f9532a8e9d41925870ed7b429d26700605c", "message": "Date -> Instant", "committedDate": "2020-02-08T10:08:23Z", "type": "commit"}, {"oid": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "url": "https://github.com/prebid/prebid-server-java/commit/ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "message": "Migrated Form ConcurrentMap to Caffeine", "committedDate": "2020-02-11T11:39:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxMTAxNg==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378811016", "bodyText": "Pls add null check for logger argument.", "author": "rpanchyk", "createdAt": "2020-02-13T11:44:48Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -1,37 +1,67 @@\n package org.prebid.server.log;\n \n+import com.github.benmanes.caffeine.cache.Caffeine;\n import io.vertx.core.logging.Logger;\n \n-import java.util.concurrent.ConcurrentHashMap;\n+import java.time.Instant;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.function.Consumer;\n \n public class ConditionalLogger {\n-    private ConcurrentHashMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentMap<String, Long> messageToWait;\n+\n     private final Logger logger;\n \n     public ConditionalLogger(Logger logger) {\n         this.logger = logger;", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxMTMyMA==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378811320", "bodyText": "this ref is not required.", "author": "rpanchyk", "createdAt": "2020-02-13T11:45:29Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -1,37 +1,67 @@\n package org.prebid.server.log;\n \n+import com.github.benmanes.caffeine.cache.Caffeine;\n import io.vertx.core.logging.Logger;\n \n-import java.util.concurrent.ConcurrentHashMap;\n+import java.time.Instant;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.function.Consumer;\n \n public class ConditionalLogger {\n-    private ConcurrentHashMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentMap<String, Long> messageToWait;\n+\n     private final Logger logger;\n \n     public ConditionalLogger(Logger logger) {\n         this.logger = logger;\n-        this.messageToCount = new ConcurrentHashMap<>();\n+        this.messageToWait = Caffeine.newBuilder()", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxMTk2Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378811962", "bodyText": "Make this method private.", "author": "rpanchyk", "createdAt": "2020-02-13T11:46:53Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -1,37 +1,67 @@\n package org.prebid.server.log;\n \n+import com.github.benmanes.caffeine.cache.Caffeine;\n import io.vertx.core.logging.Logger;\n \n-import java.util.concurrent.ConcurrentHashMap;\n+import java.time.Instant;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.function.Consumer;\n \n public class ConditionalLogger {\n-    private ConcurrentHashMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentMap<String, Long> messageToWait;\n+\n     private final Logger logger;\n \n     public ConditionalLogger(Logger logger) {\n         this.logger = logger;\n-        this.messageToCount = new ConcurrentHashMap<>();\n+        this.messageToWait = Caffeine.newBuilder()\n+                .maximumSize(10_000)\n+                .expireAfterWrite(1, TimeUnit.HOURS)\n+                .<String, Long>build()\n+                .asMap();\n+        messageToCount = Caffeine.newBuilder()\n+                .maximumSize(10_000)\n+                .expireAfterWrite(1, TimeUnit.HOURS)\n+                .<String, AtomicInteger>build()\n+                .asMap();\n     }\n \n     public void info(String message, Integer maxValue) {\n         log(message, maxValue, logger -> logger.info(message));\n     }\n \n+    public void info(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.info(message));\n+    }\n+\n     public void error(String message, Integer maxValue) {\n         log(message, maxValue, logger -> logger.error(message));\n     }\n \n+    public void error(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.error(message));\n+    }\n+\n     public void debug(String message, Integer maxValue) {\n         log(message, maxValue, logger -> logger.debug(message));\n     }\n \n+    public void debug(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.debug(message));\n+    }\n+\n     public void warn(String message, Integer maxValue) {\n         log(message, maxValue, logger -> logger.warn(message));\n     }\n \n-    private void log(String key, Integer maxValue, Consumer<Logger> consumer) {\n+    public void warn(String message, long amount, TimeUnit unit) {\n+        log(message, amount, unit, logger -> logger.warn(message));\n+    }\n+\n+    public void log(String key, Integer maxValue, Consumer<Logger> consumer) {", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxMjAwOQ==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378812009", "bodyText": "Make this method private.\nAdd unit test for it.", "author": "rpanchyk", "createdAt": "2020-02-13T11:47:00Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -40,4 +70,25 @@ private void log(String key, Integer maxValue, Consumer<Logger> consumer) {\n             consumer.accept(logger);\n         }\n     }\n+\n+    public void log(String key, long amount, TimeUnit unit, Consumer<Logger> consumer) {", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxMjQ4NA==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378812484", "bodyText": "Can be final.", "author": "rpanchyk", "createdAt": "2020-02-13T11:48:07Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -40,4 +70,25 @@ private void log(String key, Integer maxValue, Consumer<Logger> consumer) {\n             consumer.accept(logger);\n         }\n     }\n+\n+    public void log(String key, long amount, TimeUnit unit, Consumer<Logger> consumer) {\n+        messageToWait.compute(key, (currentKey, lastTimeMillis) -> {\n+            if (lastTimeMillis == null || currentTimeMillis() >= lastTimeMillis) {\n+                lastTimeMillis = recalculateDate(amount, unit);\n+                consumer.accept(logger);\n+            }\n+            return lastTimeMillis;\n+        });\n+    }\n+\n+    private long recalculateDate(long amount, TimeUnit unit) {\n+        final long amountInMillis = unit.toMillis(amount);\n+        Instant resultInstant = Instant.now().plusMillis(amountInMillis);", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxNDE5Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378814196", "bodyText": "Can be static.", "author": "rpanchyk", "createdAt": "2020-02-13T11:51:55Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -40,4 +70,25 @@ private void log(String key, Integer maxValue, Consumer<Logger> consumer) {\n             consumer.accept(logger);\n         }\n     }\n+\n+    public void log(String key, long amount, TimeUnit unit, Consumer<Logger> consumer) {\n+        messageToWait.compute(key, (currentKey, lastTimeMillis) -> {\n+            if (lastTimeMillis == null || currentTimeMillis() >= lastTimeMillis) {\n+                lastTimeMillis = recalculateDate(amount, unit);\n+                consumer.accept(logger);\n+            }\n+            return lastTimeMillis;\n+        });\n+    }\n+\n+    private long recalculateDate(long amount, TimeUnit unit) {", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxNDM2NA==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378814364", "bodyText": "Can be static.", "author": "rpanchyk", "createdAt": "2020-02-13T11:52:20Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -40,4 +70,25 @@ private void log(String key, Integer maxValue, Consumer<Logger> consumer) {\n             consumer.accept(logger);\n         }\n     }\n+\n+    public void log(String key, long amount, TimeUnit unit, Consumer<Logger> consumer) {\n+        messageToWait.compute(key, (currentKey, lastTimeMillis) -> {\n+            if (lastTimeMillis == null || currentTimeMillis() >= lastTimeMillis) {\n+                lastTimeMillis = recalculateDate(amount, unit);\n+                consumer.accept(logger);\n+            }\n+            return lastTimeMillis;\n+        });\n+    }\n+\n+    private long recalculateDate(long amount, TimeUnit unit) {\n+        final long amountInMillis = unit.toMillis(amount);\n+        Instant resultInstant = Instant.now().plusMillis(amountInMillis);\n+        return resultInstant.toEpochMilli();\n+    }\n+\n+    private long currentTimeMillis() {", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxNDk5Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378814992", "bodyText": "Pls extract 5 to class constant, like LOG_PERIOD_SECONDS.", "author": "rpanchyk", "createdAt": "2020-02-13T11:53:53Z", "path": "src/main/java/org/prebid/server/vertx/http/CircuitBreakerSecuredHttpClient.java", "diffHunk": "@@ -49,7 +52,8 @@ public CircuitBreakerSecuredHttpClient(Vertx vertx, HttpClient httpClient, Metri\n     }\n \n     private void circuitOpened(String name) {\n-        logger.warn(\"Http client request to {0} is failed, circuit opened.\", name);\n+        conditionalLogger.warn(String.format(\"Http client request to %s is failed, circuit opened.\", name),\n+                5, TimeUnit.SECONDS);", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxNTUzMw==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378815533", "bodyText": "Pls extract 5 to class constant, like LOG_PERIOD_SECONDS.", "author": "rpanchyk", "createdAt": "2020-02-13T11:55:03Z", "path": "src/main/java/org/prebid/server/vertx/jdbc/CircuitBreakerSecuredJdbcClient.java", "diffHunk": "@@ -42,7 +45,7 @@ public CircuitBreakerSecuredJdbcClient(Vertx vertx, JdbcClient jdbcClient, Metri\n     }\n \n     private void circuitOpened() {\n-        logger.warn(\"Database is unavailable, circuit opened.\");\n+        conditionalLogger.warn(\"Database is unavailable, circuit opened.\", 5, TimeUnit.SECONDS);", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxNjY0NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378816645", "bodyText": "Pls set reasonable name test, like infoShouldCallLoggerWithExpectedCount.", "author": "rpanchyk", "createdAt": "2020-02-13T11:57:42Z", "path": "src/test/java/org/prebid/server/log/ConditionalLoggerTest.java", "diffHunk": "@@ -23,17 +22,17 @@\n     private ConditionalLogger conditionalLogger;\n \n     @Before\n-    public void setUp() throws Exception {\n+    public void setUp() {\n         conditionalLogger = new ConditionalLogger(logger);\n     }\n \n     @Test\n-    public void log() {\n-        // when\n+    public void counterLog() {", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxNzQyNQ==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378817425", "bodyText": "Pls use reasonable test data, like log message.", "author": "rpanchyk", "createdAt": "2020-02-13T11:59:26Z", "path": "src/test/java/org/prebid/server/log/ConditionalLoggerTest.java", "diffHunk": "@@ -23,17 +22,17 @@\n     private ConditionalLogger conditionalLogger;\n \n     @Before\n-    public void setUp() throws Exception {\n+    public void setUp() {\n         conditionalLogger = new ConditionalLogger(logger);\n     }\n \n     @Test\n-    public void log() {\n-        // when\n+    public void counterLog() {\n+        //when\n         for (int i = 0; i < 100; i++) {\n             conditionalLogger.info(\"Hello\", 20);", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxNzc2Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378817767", "bodyText": "Minor. Why to skip space? :)", "author": "rpanchyk", "createdAt": "2020-02-13T12:00:08Z", "path": "src/test/java/org/prebid/server/log/ConditionalLoggerTest.java", "diffHunk": "@@ -23,17 +22,17 @@\n     private ConditionalLogger conditionalLogger;\n \n     @Before\n-    public void setUp() throws Exception {\n+    public void setUp() {\n         conditionalLogger = new ConditionalLogger(logger);\n     }\n \n     @Test\n-    public void log() {\n-        // when\n+    public void counterLog() {\n+        //when", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxODMxNQ==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378818315", "bodyText": "Pls extract 10_000 to class constant.", "author": "rpanchyk", "createdAt": "2020-02-13T12:01:11Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -1,37 +1,67 @@\n package org.prebid.server.log;\n \n+import com.github.benmanes.caffeine.cache.Caffeine;\n import io.vertx.core.logging.Logger;\n \n-import java.util.concurrent.ConcurrentHashMap;\n+import java.time.Instant;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.function.Consumer;\n \n public class ConditionalLogger {\n-    private ConcurrentHashMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentMap<String, Long> messageToWait;\n+\n     private final Logger logger;\n \n     public ConditionalLogger(Logger logger) {\n         this.logger = logger;\n-        this.messageToCount = new ConcurrentHashMap<>();\n+        this.messageToWait = Caffeine.newBuilder()\n+                .maximumSize(10_000)", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxODQyMg==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378818422", "bodyText": "Pls extract 1 to class constant.", "author": "rpanchyk", "createdAt": "2020-02-13T12:01:28Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -1,37 +1,67 @@\n package org.prebid.server.log;\n \n+import com.github.benmanes.caffeine.cache.Caffeine;\n import io.vertx.core.logging.Logger;\n \n-import java.util.concurrent.ConcurrentHashMap;\n+import java.time.Instant;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.function.Consumer;\n \n public class ConditionalLogger {\n-    private ConcurrentHashMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentMap<String, AtomicInteger> messageToCount;\n+    private ConcurrentMap<String, Long> messageToWait;\n+\n     private final Logger logger;\n \n     public ConditionalLogger(Logger logger) {\n         this.logger = logger;\n-        this.messageToCount = new ConcurrentHashMap<>();\n+        this.messageToWait = Caffeine.newBuilder()\n+                .maximumSize(10_000)\n+                .expireAfterWrite(1, TimeUnit.HOURS)", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxODY1NA==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378818654", "bodyText": "Pls rename to accountId.", "author": "rpanchyk", "createdAt": "2020-02-13T12:01:59Z", "path": "src/main/java/org/prebid/server/handler/openrtb2/AuctionHandler.java", "diffHunk": "@@ -160,7 +160,7 @@ private void handleResult(AsyncResult<Tuple2<BidResponse, AuctionContext>> respo\n \n                 status = HttpResponseStatus.UNAUTHORIZED.code();\n                 body = message;\n-                String userId = ((UnauthorizedAccountException) exception).getAccountId();\n+                final String userId = ((UnauthorizedAccountException) exception).getAccountId();", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxODkxNA==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378818914", "bodyText": "Pls extract 5 to class constant, like LOG_PERIOD_SECONDS.", "author": "rpanchyk", "createdAt": "2020-02-13T12:02:36Z", "path": "src/main/java/org/prebid/server/geolocation/CircuitBreakerSecuredGeoLocationService.java", "diffHunk": "@@ -40,7 +43,7 @@ public CircuitBreakerSecuredGeoLocationService(Vertx vertx, GeoLocationService g\n     }\n \n     private void circuitOpened() {\n-        logger.warn(\"GeoLocation service is unavailable, circuit opened.\");\n+        conditionalLogger.warn(\"GeoLocation service is unavailable, circuit opened.\", 5, TimeUnit.SECONDS);", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgyMDk1MA==", "url": "https://github.com/prebid/prebid-server-java/pull/605#discussion_r378820950", "bodyText": "Do we really need to compute value at each execution?", "author": "rpanchyk", "createdAt": "2020-02-13T12:07:26Z", "path": "src/main/java/org/prebid/server/log/ConditionalLogger.java", "diffHunk": "@@ -40,4 +70,25 @@ private void log(String key, Integer maxValue, Consumer<Logger> consumer) {\n             consumer.accept(logger);\n         }\n     }\n+\n+    public void log(String key, long amount, TimeUnit unit, Consumer<Logger> consumer) {\n+        messageToWait.compute(key, (currentKey, lastTimeMillis) -> {", "originalCommit": "ea2deb7dbc9f0d3524b7def2e0c30dac44a7a5a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "86748e3196c6582d00b0c05a2a9e584916cb0a2d", "url": "https://github.com/prebid/prebid-server-java/commit/86748e3196c6582d00b0c05a2a9e584916cb0a2d", "message": "Minor changes", "committedDate": "2020-02-13T13:16:04Z", "type": "commit"}, {"oid": "678904ea9035a7843b430c8817b4c3a9119c3f0a", "url": "https://github.com/prebid/prebid-server-java/commit/678904ea9035a7843b430c8817b4c3a9119c3f0a", "message": "Minor changes", "committedDate": "2020-02-13T13:46:54Z", "type": "commit"}, {"oid": "4073e90b73edf01e11e6a8d5ce852657a42746b8", "url": "https://github.com/prebid/prebid-server-java/commit/4073e90b73edf01e11e6a8d5ce852657a42746b8", "message": "Minor changes", "committedDate": "2020-02-14T11:34:17Z", "type": "commit"}, {"oid": "4b440575c9e99fc05f8e7dafc7e2886c29375e02", "url": "https://github.com/prebid/prebid-server-java/commit/4b440575c9e99fc05f8e7dafc7e2886c29375e02", "message": "Minor changes", "committedDate": "2020-02-14T11:48:00Z", "type": "commit"}, {"oid": "e425d7f400b539f84fbfee275aa22ec974cdf8c3", "url": "https://github.com/prebid/prebid-server-java/commit/e425d7f400b539f84fbfee275aa22ec974cdf8c3", "message": "Test changed", "committedDate": "2020-02-14T12:06:13Z", "type": "commit"}, {"oid": "d9344e50d4e61a4c524120033cc8d07ffa8a6eed", "url": "https://github.com/prebid/prebid-server-java/commit/d9344e50d4e61a4c524120033cc8d07ffa8a6eed", "message": "Test changed", "committedDate": "2020-02-14T12:08:57Z", "type": "commit"}]}